|FICHEROS;
     nomcalat #00;      || pantalla calculo     (atrasos !!!)
     labempre #01;      || empresas
     labtraba #02;      || trabajadores
     nomcatac #03;      || aux. categorias cabeceras (atrasos !!!)
     nomcatal #04;      || aux. categorias lineas (atrasos !!!)
     nomtraac #05;      || aux. trabajadores cabeceras (atrasos !!!)
     nomtraal #06;      || aux. trabajadores lineas (atrasos !!!)
     nomconca #09;      || convenios cabeceras
     nomconli #10;      || convenios lineas
     nomcalac #11;      || atrasos calculos cabs.
     nomcalal #12;      || atrasos calculos lins.
     nomantca #13;      || antiguedades/categorias
     nomconax #14;      || auxiliar convenios
     nomconst #15;      || constantes
     nombonif #16;      || bonificaciones
     nomepigr #17;      || epigrafes
     nomepitr #18;      || epigrafes/trabajador
     nomtrcal #20;      || calendario laboral
     nomhicca #21;      || hist. calculos cabs.
     nomhicli #22;      || hist. calculos lins.
     nomantpl #30;      || ptas. baseantiguedad lineas
     nomcontr #32;      || control aplicacion
     nomvarli #33;      || variaciones lins. (para el plus <103>)
     nomtrali #34;      || trabajador lins. (para el plus <103>)
     nomcatli #35;      || categoria lins. (para el plus <103>)
     nomcones #36;      || cotizacion especial R.D.-Ley 18/93
     nomaumli #37;      || porcentajes de aumento desde historico
     nomvart3 #38;      || conceptos variables para irregulares
     nomconat #39;      || definic.ctos.autom.
     nomvart3 #40;      || variaciones t.parcial (ctos.irregulares)
     labtrtra #50;      || tmp. trabajadores
     nomtmp01 #51;      || tmp. refundir
     nomnotay #52;      || centros notarias/ayuntamientos
     nomtraca #101;     || trabajadores cabs.

     nomatcon #41;      || historico de constantes
     nomgruec;          || grupos de empresas Cabs.
     nomgruel;          || grupos de empresas Lins.
     nomabsca;
     nomabsli;
     nomcaldl;
     nomatant;
     gomdetjr;
     nomcalcc;
     nomhisit;
     nompluri;
|FIN;

|VARIABLES;
    i=0;
    FEstado = 0;
    Fhistorico = 0;
    Fhistorlinea = 0;
    act = 0;
    actc = 0;
    acu_auto = 0;
    acum1_200 = 0;
    acum2_200 = 0;
    &acum_10 = 0;
    acum_11 = 0;
    acum_12 = 0;
    acum_13 = 0;
    &acum_30 = 0;
    acum_301 = 0;
    acum_302 = 0;
    acum_303 = 0;
    &acum_31 = 0;
    acum_311 = 0;
    acum_312 = 0;
    acum_313 = 0;
    acum_40 = 0;
    acum_401 = 0;
    acum_402 = 0;
    acum_403 = 0;
    acum_41 = 0;
    acum_50 = 0;
    acum_51 = 0;
    acum_52 = 0;
    &acum_53 = 0;
    &acum_54 = 0;
    acum_60 = 0;
    acum_90 = 0;
    acum_99 = 0;
    acum_991 = 0;
    acum_992 = 0;
    acum_993 = 0;
    acum_xx = 0;
    ajus_p = 0;
    aAlfa = "";
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    alfa5 = "";
    alfa6 = "";
    alfa7 = "";
    alfa8 = "";
    ant_pro_enf = 0;
    ant_pro_acc = 0;
    antici1 = 0;
    antici2 = 0;
    any = "";          || calculo 'desglosa'
    anyact = 0;
    anyalt = 0;
    anynum = 0;
    anyo1 = 0;
    anyo2 = 0;
    anyos = 0;
    anyven = 0;
    auto1 = 0;
    auto2 = 0;
    auto3 = 0;
    base_1 = 0;
    base_2 = 0;
    base_3 = 0;
    base_4 = 0;
    &base_5 = 0;
    &base_6 = 0;
    &base_7 = 0;
    &base_77 = 0;
    &base_8 = 0;
    &base_9 = 0;
    &zbase_9 = 0;
    baset_6 = 0;
    baset_7 = 0;
    base_10 = 0;
    base_11 = 0;
    swITEmp = 0;
    &base_A = 0;
    &zbase_A = 0;
    &base_B = 0;
    &zbase_B = 0;
    &base_C = 0;
    &zbase_C = 0;
    &base_D = 0;
    &base_E = 0;
    &base_F = 0;
    &zbase_F = 0;
    &base_G = 0;
    &base_M = 0;
    &zbase_M = 0;
    &base_N = 0;
    &zbase_N = 0;
    basepro = 0;
    bisiesto = 0;
    &bon_0 = 0;
    &zbon_0 = 0;
    &bon_1 = 0;
    &bon_2 = 0;
    &bon_3 = 0;
    &zbon_3 = 0;
    &bon_5 = 0;
    &zbon_5 = 0;
    &bon_60 = 0;
    bruto_pag = 0;
    bruto_rec = 0;
    cabecera = 0;      || switch para grabar o no cabeceras de calculos
    camdes = 0;
    camhas = 0;
    campo = 0;
    campomin = 0;
    campos = 0;
    ||citri_c = 1.33;    || coef. citricos tipo C
    ||citri_f = 1.61;    || coef. citricos tipo F
    citri_c = 1;       || coef. citricos tipo C
    citri_f = 1;       || coef. citricos tipo F
    &coba_1 = 0;
    &coba_2 = 0;
    &coba_3 = 0;
    &coba_4 = 0;
    &cobb_1 = 0;
    &cobb_2 = 0;
    &cobb_3 = 0;
    &cobb_4 = 0;
    concep0 = 0;
    concep1 = 0;
    concep2 = 0;
    concepto = 0;      || variable de trabajo del campo 'concepto'
    con_irr = 0;
    conser1 = 0;
    conser2 = 0;
    convenio = 0;      || switch de error de existencia o no de linea convenio
    coti_0 = 0;
    coti_2 = 0;
    dabse_k = 0;
    dabse_1 = 0;
    dabse_2 = 0;
    dabse_3 = 0;
    dacci_k = 0;
    dacci_0 = 0;
    dacci_1 = 0;
    &dacci_2 = 0;
    &dacum_30 = 0;
    &dacum_31 = 0;
    dalta_k = 0;
    dalta_1 = 0;
    dalta_2 = 0;
    &dalta_3 = 0;
    danti_0 = 0;
    danti_1 = 0;
    dbaja_k = 0;
    dbaja_1 = 0;
    dbaja_2 = 0;
    &dbaja_3 = 0;
    &dboni_1 = 0;
    &dboni_2 = 0;
    &dcobr_0 = 0;
    dcofi_1 = 0;
    dcofi_2 = 0;
    dcofi_3 = 0;
    dcofi_4 = 0;
    dcofi_5 = 0;
    dcofi_6 = 0;
    dcofi_7 = 0;
    dcofi_201 = 0;
    dcofi_202 = 0;
    dcofi_203 = 0;
    dcofi_204 = 0;
    dcofi_205 = 0;
    dcofi_206 = 0;
    dcofi_207 = 0;
    dcofi_208 = 0;
    dcofi_209 = 0;
    dcofi_999 = 0;
    &dcoti_0 = 0;
    ddese_k = 0;
    ddese_1 = 0;
    &ddese_2 = 0;
    de1 = 0;
    de2 = 0;
    dedia = 0;
    deducss = 0;
    denfe_k = 0;
    denfe_0 = 0;
    denfe_1 = 0;
    dreca_1 = 0; dreca_2 = 0; dreca_3 = 0; dreca_4 = 0;
    &denfe_2 = 0;
    denfe_4 = 0;
    denfe_20 = 0;
    denfe_21 = 0;
    denfe_22 = 0;
    denfe_23 = 0;
    denfe_24 = 0;
    &denfe_A = 0;
    &denfe_B = 0;
    &denfe_C = 0;
    &denfe_D = 0;
    denfe_A0 = 0;
    denfe_B0 = 0;
    denfe_C0 = 0;
    denfe_D0 = 0;
    des = 0;
    des1 = 0;
    des2 = 0;
    desc = 0;
    desde = 0;
    dhuel_k = 0;
    dhuel_1 = 0;
    dhuel_2 = 0;
    dhuel_3 = 0;
    dia = 0;
    dia_k = 0;
    dia_1 = 0;
    &dia_2 = 0;
    dia_3 = 0;
    dia_4 = 0;
    diaalt = 0;
    diafest = 0;
    dialabo = 0;
    dias_dto = 0;
    diasp = 0;
    &diastc2 = 0;
    diaven = 0;
    difer_a = 0;
    difer_m = 0;
    diff = 0;
    &dilt = 0;
    divide = 0;
    dlabo_k = 0;
    dlabi_k = 0;
    dlabo_0 = 0;
    dlabi_0 = 0;
    dmate_k = 0;
    dmate_0 = 0;
    dmate_1 = 0;
    &dmate_2 = 0;
    &dpate_2 = 0;
    &dries_2 = 0;
    &dcont_2 = 0;
    doce = 0;
    &dto_con = 0;
    &dto_dfp = 0;
    &dto_ho1 = 0;
    &dto_ho2 = 0;
    &dto_tot = 0;
    &dtot = 0;
    duni1_101 = 0;
    duni1_102 = 0;
    duni1_103 = 0;
    duni1_200 = 0;
    duni1_999 = 0;
    duni2_101 = 0;
    duni2_102 = 0;
    duni2_103 = 0;
    duni2_200 = 0;
    duni2_998 = 0;
    duni2_999 = 0;
    duni3_200 = 0;
    dtodo_3 = 0;
    dvaca_1 = 0;
    dvaca_2 = 0;
    dvaca_k = 0;
    dvalo_101 = 0;
    dvalo_102 = 0;
    dvalo_103 = 0;
    dvalo_200 = 0;
    dvalo_201 = 0;
    dvalo_202 = 0;
    dvalo_203 = 0;
    dvalo_204 = 0;
    dvalo_205 = 0;
    dvalo_206 = 0;
    dvalo_207 = 0;
    dvalo_208 = 0;
    dvalo_209 = 0;
    dvalo_999 = 0;
    dvalo_pag = 0;
    &dvalo_pro = 0;
    elotro = 0;
    emp_desde = 0;
    emp_hasta = 0;
    es_aprendi = 0;
    &es_parcial = 0;
    &es_irregul = 0;
    especie = 0;
    &epig_ilt = 0;
    &epig_ims = 0;
    estevale = 0;
    fanti_a = 0;
    fanti_m = 0;
    fecalf = "";       || calculo 'desglosa'
    fecbaj = "";       || calculo 'baja'
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fecsys = @;        || variable de trabajo para fecha sistema
    &fijo_1 = 0;
    &fijo_1_red = 0;
    &jornadasIT = 0;
    &nReduccion = 0;
    fvenci = "";       || fecha vencimiento antiguedad
    ganti_a = 0;
    ganti_m = 0;
    gbase6 = 0;
    gbase7 = 0;
    graba04 = 0;
    graba05 = "";
    graba06 = 0;
    graba07 = 0;
    graba08 = "";
    graba09 = 0;
    graba10 = 0;
    graba11 = 0;
    gua_i = 0;
    &guarda = 0;
    guarda_dia_4;
    ha1 = 0;
    ha2 = 0;
    hadia = 0;
    has = 0;
    has1 = 0;
    has2 = 0;
    hasc = 0;
    hasta = 0;
    hcobr_0 = 0;
    hcofi_1 = 0;
    hcofi_2 = 0;
    hcofi_3 = 0;
    hcofi_4 = 0;
    &hcoti_0 = 0;      || exportable al 'nomcalfi'
    hdias_0 = 0;
    &histori = "";      || variable tabla indicando variaciones/trabajador
    &horasex = 0;
    horatc2 = 0;
    hbaja_2 = 0;
    hdese_2 = 0;
    hhuel_3 = 0;
    habse_3 = 0;
    hacci_2 = 0;
    henfe_2 = 0;
    hmate_2 = 0;
    &lin_1 = 0;
    &lin_2 = 0;
    liquido = 0;
    m_dias = 0;
    mas = 0;
    maximo = 0;
    mensaje1 = "ATENCION, PROCESO DETENIDO !!! Convenio ";
    mensaje2 = ", INEXISTENTE en fichero ";
    mensaje3 = "    ATENCION !!! Error de Entrada ...";
    mes = 0;
    mes_d = 0;
    mes_h = 0;
    mes_refun = 0;
    &mes_x = 0;
    mesact = 0;
    mesalt = 0;
    mesco = 0;
    meslabo = "";      || mes del calendario laboral
    mesnum = 0;
    mespinta = "";     || variable de trabajo para pintar el mes
    mesven = 0;
    mex_x = 0;
    mid = 0;
    nume0 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    nume7 = 0;
    nume8 = 0;
    numer = 0;
    p_mes = "";        || variable de trabajo para pintar mes literal
    pagaf_1 = 0;
    pagaf_2 = 0;
    pagaf_3 = 0;
    pagaf_4 = 0;
    pagaf_5 = 0;
    pagaf_6 = 0;
    pagaf_7 = 0;
    pagaf_8 = 0;
    pagaf_9 = 0;
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    paga = 0;
    pcofi_1 = 0;
    pcofi_2 = 0;
    pcofi_3 = 0;
    pcofi_4 = 0;
    pdia_0 = 0;
    pdia_1 = 0;
    pdia_2 = 0;
    pdia_3 = 0;
    pdia_4 = 0;
    pdia_5 = 0;
    pdia_6 = 0;
    pdia_a = 0;
    pdia_b = 0;
    pdia_c = 0;
    pdia_d = 0;
    pdia_e = 0;
    pdia_f = 0;
    pepulti = 0;
    perio = 0;
    perio1 = 0;
    perio2 = 0;
    perio3 = 0;
    perio4 = 0;
    perio5 = 0;
    perio6 = 0;
    perio7 = 0;
    perio8 = 0;
    por_103 = 0;
    &por1_cont = 0;
    &por1_dfpg = 0;
    &por1_des = 0; &por1_fp = 0;
    &por2_des = 0; &por2_fp = 0; &por2_fog = 0;
    &por1_hor1 = 0;
    &por1_hor2 = 0;
    &por2_cont = 0;
    &por2_dfpg = 0;
    &por2_hor1 = 0;
    &por2_hor2 = 0;
    porcp = 0;
    pp = 0;
    primera = 0;
    product = 0;
    &prom_acc = 0;
    &prom_enf = 0;
    puntero = 0;
    puntero1 = 0;
    puntero2 = 0;
    reten_1 = 0;
    reten_11 = 0;
    reten_12 = 0;
    reten_13 = 0;
    reten_2 = 0;
    rompe = 0;
    salte_1 = 0;
    salte_2 = 0;
    s_reajus = 0;
    seleccio = 0;      || switch para mensaje 'Seleccion vacia' o no
    signo = 0;
    sigui = 0;
    sw_mater = 0;
    sw_promedio = 0;
    swaju_abs = 0;
    swaju_acc = 0;
    swaju_des = 0;
    swaju_enf = 0;
    swaju_hue = 0;
    swaju_mat = 0;
    swaju_vac = 0;
    swalta = 0;
    swbaja = 0;
    swcongra = 0;
    swconst = 0;
    swempre = 0;
    swfuera = 0;
    swgracon = 0;
    swlbonif = 0;
    swlepigr = 0;
    swmarca = "";      || indicador de variaciones/trabajador
    swpaga = 0;
    swpro = 0;
    tempo1 = 0;
    tempo2 = 0;
    tempo3 = 0;
    tempo4 = 0;
    tempo5 = 0;
    tempor = 0;
    tipo1 = "";        || mes que cumple a¤o (actual)
    tipo2 = "";        || mes que cumple a¤o (siguiente)
    tipo3 = "";        || trimestre que cumple a¤o (actual)
    tipo4 = "";        || trimestre que cumple a¤o (siguiente)
    tipo5 = "";        || semestre que cumple a¤o (actual)
    tipo6 = "";        || semestre que cumple a¤o (siguiente)
    tipo7 = "";        || a¤o que cumple a¤o (actual)
    tipo8 = "";        || a¤o que cumple a¤o (siguiente)
    tipo_p = 0;
    tipos = 0;
    tipox = 0;
    &topemes = 0;
    topemes1 = 0;
    topemes2 = 0;
    totact = 0;
    totalt = 0;
    totven = 0;
    tp = 0;
    tp1 = 0;
    tp2 = 0;
    tp3 = 0;
    tpx = 0;
    tpz = 0;
    tra_desde = 0;
    tra_hasta = 0;
    trabamen = "";     || variable de trabajo para construir mensaje
    traza = 0;
    unidades = 0;
    vacacio = 0;
    val_auto = 0;
    vcobr_0 = 0;
    vcoti_0 = 0;
    vlabo_0 = 0;
    vlabo_k = 0;
    valorito = 0;
    yaesta = 0;

    pro_201 = 0;    || acum.unidades prorrata normales
    pro_202 = 0;
    pro_203 = 0;
    pro_204 = 0;
    pro_205 = 0;
    pro_206 = 0;
    pro_207 = 0;
    pro_208 = 0;
    pro_299 = 0;

    pra_201 = 0;    || acum.unidades prorrata diferidas
    pra_202 = 0;
    pra_203 = 0;
    pra_204 = 0;
    pra_205 = 0;
    pra_206 = 0;
    pra_207 = 0;
    pra_208 = 0;
    pra_299 = 0;

    pag_201 = 0;
    pag_202 = 0;
    pag_203 = 0;
    pag_204 = 0;
    pag_205 = 0;
    pag_206 = 0;
    pag_207 = 0;
    pag_208 = 0;
    pag_299 = 0;

    no_201 = 0;
    no_202 = 0;
    no_203 = 0;
    no_204 = 0;
    no_205 = 0;
    no_206 = 0;
    no_207 = 0;
    no_208 = 0;
    no_299 = 0;

    &nom_paga = "";
    &el_mes = 0;
    &el_any = 0;
    g_con = 0;
    &g_emp = 0;
    &g_tra = 0;
    anyo_actual = "";

    dias_cot = 0;
    remunera = 0;
    prorrata = 0;
    horasex1 = 0;
    horasex2 = 0;
    base_ilt = 0;
    maternba = 0;
    maternbb = 0;
    rdboni_1 = 0;
    rdboni_2 = 0;
    rdmate_2 = 0;
    rhorasex = 0;
    CodigoCons = 0;

     nHastaBonif = 0;
     nVtoBonif = 0;
     nNume1 = 0;
     nNume2 = 0;
     nPara1 = 0;
     nPara2 = 0;
     &nPorBon1 = 0;
     &nPorBon2 = 0;
     notaria = 0;
     nRecAy = 0;
     nPor1 = 0;
     nPor2 = 0;
     nPor3 = 0;
     nEl36 = 0;
     &EURODB = 0;
     swCalcula = 0;
     fFecha_Baja = @;
     swActiva = 0;

     nDiasBonBaja = 0;
     nAltaBonif = 0;
     nBajaBonif = 0;
     nDia = 0;
     nBaja = 0;
     nInicioBaja = 0;
     nFinBaja = 0;
     nDiasBaja = 0;
     aFecBajaBon = "";
     &runnom = "";
     swPorGrupos = 0;
     nGrupo = 0;
     nCampoG = 0;
     pror_p = 0;
     &nCConst = 0;
     &fCFecha = @;
     &aCError = "";

     nMesesBon16 = 0;
     nAnyosBon16 = 0;
     nPB16Calc = 0;
     nume9 = 0;
     nPB16CalcA = 0;
     por_bon_16A = 0;
     bon_60A = 0;
     &fecha_bon_16 = "";
     por_bon_16 = 0;
     por_bon_60 = 0;
     aFechaRef = "";
     &nUnid990 = 0;
     &nImp989 = 0;
     aFecha1 = "";
     aFecha2 = "";
     fFecha1 = @;
     fFecha2 = @;
     prom_enf_gua = 0;
     prom_acc_gua = 0;
     &swAjuste3 = 0;
     &swAjuste3_C = 0;
     aAlfa1 = "";
     aAlfa2 = "";

     produc1 = 0;
     produc2 = 0;
     produc3 = 0;
     anti_41 = 0;
     anticom = 0;

     &swModulo = 0;
     &nEnEmpresa = 0;

     nPropPrac = 1;
     nCotAlta = 0;
     swTransRaro = 0;
     &nIncid = 0;
     &nNroErrores = 0;
     fech4 = @;
     aNif = "";
     swNoAjuste3 = 0;
     danti_0_his = 0;
     &nMes = 0;
     &nAny = 0;
     &nTopemes = 0;
     &nCodigoBon = 0;
     &nTip = 0;
     &nEpigConv = 0;
     dias_v = 0;
     fFechaDesde = @;
     fFechaHasta = @;
     aFechaDesde = "";
     aFechaHasta = "";
     swNoEntra = 0;
     &nElAny = 0;
     &nElMes = 0;
     &nDiasDescEnf = 0;
     nDescEnf_A = 0;
     &nDescEnf_B = 0;
     &nDescEnf_C = 0;
     nDescEnf_D = 0;
     &nDiasDescAcc = 0;
     &nDiasDescMat = 0;
     nDiasAcumIT = 0;
     swSigue = 0;
     aFechaIni = "";
     fFechaIni = @;
     nFecha = 0;
     fFecha = @;
     aFecha = "";
        denfe_A1 = 0; denfe_B1 = 0; denfe_C1 = 0; denfe_D1 = 0;
        denfe_A2 = 0; denfe_B2 = 0; denfe_C2 = 0; denfe_D2 = 0;
        denfe_A3 = 0; denfe_B3 = 0; denfe_C3 = 0; denfe_D3 = 0;
        denfe_A4 = 0; denfe_B4 = 0; denfe_C4 = 0; denfe_D4 = 0;
     aSwDD = "";
     swMensa = 0;

     || estas a ver que hago con ellas
     &nPropDesTP = 0;
     &ddese_3 = 0;
     &nDiaCumple2 = 0;
     &swMater = 0;
     &swPater = 0;
     &swRiesgo = 0;
     &enMes = 0;
     &enAny = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nMesBusca = 0;
     nAnyPaga = 0;
     nUnidPaga = 0;
     nBaseMater = 0;
     swgrabacero = 0;
     nQueBusca = 0;
     nValor = 0;
     nAcumProrr = 0;
     nPrecioProrr = 0;
     nTipo = 0;
     nCampo1 = 0;
     nNume = 0;
     nAnyHist = 0;
     nCampo2 = 0;
     nEdadParaBon = 0;
     nAnysParaAnt = 0;
     fecha_ini_bon = 0;
     any_ini_bon = 0;
     &bon_59 = 0;
     nume10 = 0;
     &swAgosto2012 = 0;
     nEdad = 0;

     &nDiasPagoSS = 0;
     &nBasePagoSS_CC = 0;
     &nBasePagoSS_CP = 0;
     &nJornPagoSS = 0;
     &nDiasPagoSS_SinMat = 0;
     &nJornPagoSS_SinMat = 0;
     &nBasePagoSS_CC_SinMat = 0;
     &nBasePagoSS_CP_SinMat = 0;

     &swBaseFija = 0;
     &swMensual = 0;
     &swJornadas = 0;
     nConceptoJor = 0;

     &denfe_cot = 0;
     &dacci_cot = 0;
     &dmate_cot = 0;
     &nRedCCEnf = 0;
     &nRedDesEnf = 0;
     &nRedCCMat = 0;
     &nRedDesMat = 0;
     &nRedCCAcc = 0;
     &nRedDesAcc = 0;
     &nRedCCEnfEmp = 0;
     &nRedDesEnfEmp = 0;
     &prom_enf_previo = 0;
     &prom_acc_previo = 0;
     &nATEP_IT = 0;
     nJornadasHis = 0;
     &n400Cot = 0;

     nDiasDevengo = 0;
     nDesdeMesDev = 0;
     nHastaMesDev = 0;
     nMesDev = 0;
     fFechaAlta = @;
     fFechaBaja = @;
     fFechaIniPer = @;
     fFechaFinPer = @;
     nMesPaga = 0;
     swPagaPropProrr = 0;
     swEncontrado = 0;
     swEnfMatPer = 0;
     &aVersion = "";
     &prom_enf_real = 0;
     &prom_acc_real = 0;
     nBase = 0;
     nDiasCotITEmp = 0;
     aUltimaIT = "";
     swCambiaCot = 0;
     nDiasEnfNat = 0; nDiasEnfCot = 0;
     nDiasAccNat = 0; nDiasAccCot = 0;
     nDiasMatNat = 0; nDiasMatCot = 0;
     nDiasPatNat = 0; nDiasPatCot = 0;
     nDiasDesCot = 0; nDiasDesNat = 0;
     nCampo3 = 0;
     aTipo = "";
     nDesde = 0; nHasta = 0;
     nLinUltimaIT = 0;
     aTipUltimaIT = "";
     nBaseIT2 = 0;
     prom_ac2 = 0;
     swPorcAnt = 0;
     aTipoIT = "";
     nRestoProrr = 0;
     aAlfa3 = "";
     swPerCompleto = 0;
     nDias = 0;
     swHayJornadas = 0;
     nBaseEmpTra = 0; nBaseEmp = 0; nCuotaEmpTra = 0; nCuotaEmp = 0;
     &nCuotaEmpCC = 0; &nCuotaEmpDes = 0; &nCuotaEmpFog = 0; &nCuotaEmpFP = 0;
     nCuotaTotal = 0; nCuotaTrab = 0;
|FIN;

|INCLUYE nomcal_4;

|INCLUYE i_tempo;
||INCLUYE i_verif;

||****************************************************************************
||                  LLAMADAS DESDE EL MANTENIMIENTO
||****************************************************************************

|PROGRAMA;
     ||SI traza = 0;  |HAZ verif;  |FINSI;
     |CLS;
     |CABEZA "Calculo Atrasos";
     |PINPA #0#0;
     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;  |BORRA 020#0a;  |FINSI;
     |CIERRA #0;

     #0#12 = "N";
     #0#13 = "1";
     #0#64 = 1;
     #0#65 = 00;
     #0#76 = 00;
     #0#16 = "N";

     runnom = "nomcalat";

     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
               nElAny = #0#9;
               nElMes = #0#8;
               |HAZ ValoresITIMS;
         |HAZ lectura;
     |FINSI;
     |ABRE #0;
     |GRABA 000#0n;
     |CIERRA #0;
     ||SI traza = 0;  |HAZ liber;  |FINSI;
|FPRO;

|PROCESO TipoAtrasos;
     #0#76 = #0#65;
     |PINTA #0#76;
|FPRC;

|PROCESO Verif76;
     |SI #0#76 < #0#65;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO mirames; |TIPO 7; ||calcula el mes por defecto segun fecha sistema
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % 402;
    #0Campo = alfa1;
|PINTA #0Campo;
|HAZ pintames;
|FPRC;

|PROCESO pintames; |TIPO 0;
|SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
|SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
|SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
|SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
|SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|PINTA 0736, p_mes;
|FPRC;

|PROCESO hasmayor; |TIPO 0;  || comprueba que el mes hasta sea mayor que el
|SI FSalida ! 2;             || /desde
    |SI #0Campo < #0#8;
        |MENAV mensaje3;
        |ERROR;
    |SINO;
        ||SI #0Campo > #0#63;
        ||    |MENAV "    No se podran calcular atrasos de meses posteriores al actual !!!";
        ||    |ERROR;
        ||FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
|SI #0Campo = "    ";
        fecsys = ~;
        alfa1 = fecsys;
        alfa1 = alfa1 % -104;
        #0Campo = alfa1;
    |PINTA #0Campo;
|FINSI;
|FPRC;

|PROCESO fecha_def; |TIPO 0; ||calcula la fecha defecto segun fecha sistema
     fecsys = ~;
     alfa1 = fecsys;
     |SI #0#66 = "N";
          |C_M #0#67, 1, "S";
          #0#67 = fecsys;
     |SINO;
          |C_M #0#67, 1, "N";
     |FINSI;
|FPRC;

|PROCESO seleccion; |TIPO 0;
|SI #0#21 = 0;
        alfa1 = "S";
        alfa2 = "N";
    |PARA nume1 = 21; |SI nume1 [ 62; |HACIENDO nume1 = nume1 + 1;
        #0nume1 = 0;
    |SIGUE;
    |PINDA #0#0;
|SINO;
        alfa1 = "N";
        alfa2 = "S";
|FINSI;
|CAMPO_MODIFICA #0#0, 1, alfa1;
|CAMPO_MODIFICA #0#1, 1, alfa1;
|CAMPO_MODIFICA #0#2, 1, alfa1;
|CAMPO_MODIFICA #0#3, 1, alfa1;
|CAMPO_MODIFICA #0#4, 1, alfa1;
|CAMPO_MODIFICA #0#5, 1, alfa1;
|CAMPO_MODIFICA #0#6, 1, alfa1;
|CAMPO_MODIFICA #0#7, 1, alfa1;
|CAMPO_MODIFICA #0#22, 1, alfa2;
|CAMPO_MODIFICA #0#23, 1, alfa2;
|CAMPO_MODIFICA #0#24, 1, alfa2;
|CAMPO_MODIFICA #0#25, 1, alfa2;
|CAMPO_MODIFICA #0#26, 1, alfa2;
|CAMPO_MODIFICA #0#27, 1, alfa2;
|CAMPO_MODIFICA #0#28, 1, alfa2;
|CAMPO_MODIFICA #0#29, 1, alfa2;
|CAMPO_MODIFICA #0#30, 1, alfa2;
|CAMPO_MODIFICA #0#31, 1, alfa2;
|CAMPO_MODIFICA #0#32, 1, alfa2;
|CAMPO_MODIFICA #0#33, 1, alfa2;
|CAMPO_MODIFICA #0#34, 1, alfa2;
|CAMPO_MODIFICA #0#35, 1, alfa2;
|CAMPO_MODIFICA #0#36, 1, alfa2;
|CAMPO_MODIFICA #0#37, 1, alfa2;
|CAMPO_MODIFICA #0#38, 1, alfa2;
|CAMPO_MODIFICA #0#39, 1, alfa2;
|CAMPO_MODIFICA #0#40, 1, alfa2;
|CAMPO_MODIFICA #0#41, 1, alfa2;
|CAMPO_MODIFICA #0#42, 1, alfa2;
|CAMPO_MODIFICA #0#43, 1, alfa2;
|CAMPO_MODIFICA #0#44, 1, alfa2;
|CAMPO_MODIFICA #0#45, 1, alfa2;
|CAMPO_MODIFICA #0#46, 1, alfa2;
|CAMPO_MODIFICA #0#47, 1, alfa2;
|CAMPO_MODIFICA #0#48, 1, alfa2;
|CAMPO_MODIFICA #0#49, 1, alfa2;
|CAMPO_MODIFICA #0#50, 1, alfa2;
|CAMPO_MODIFICA #0#51, 1, alfa2;
|CAMPO_MODIFICA #0#52, 1, alfa2;
|CAMPO_MODIFICA #0#53, 1, alfa2;
|CAMPO_MODIFICA #0#54, 1, alfa2;
|CAMPO_MODIFICA #0#55, 1, alfa2;
|CAMPO_MODIFICA #0#56, 1, alfa2;
|CAMPO_MODIFICA #0#57, 1, alfa2;
|CAMPO_MODIFICA #0#58, 1, alfa2;
|CAMPO_MODIFICA #0#59, 1, alfa2;
|CAMPO_MODIFICA #0#60, 1, alfa2;
|CAMPO_MODIFICA #0#61, 1, alfa2;
|CAMPO_MODIFICA #0#62, 1, alfa2;
|FPRC;

|PROCESO sirefunde; |TIPO 0;
/*
|SI #0#8 = #0#10;
        alfa1 = "N";
        #0#12 = "N";
    |PINTA #0#12;
|SINO;
        alfa1 = "S";
|FINSI;
|C_M #0#12, 1, alfa1;
*/
|FPRC;

|PROCESO mayus; |TIPO 0;
    #0Campo = #0Campo > #0Campo;
|PINTA #0Campo;
|FPRC;

|PROCESO ayuda1; |TIPO 7;
/*
|SI FSalida = 5;|O FSalida = 4;    |ACABA;   |FINSI;

|PUSHV 08101751;
|CUADRO 08 10 17 51;
|ATRI R;
||            1234567890123456789012345678901234567890
|PINTA 0911, " -------------------------------------- ";
|PINTA 1011, "  Por regla general se debe informar en ";
|PINTA 1111, " este  apartado la opcion 'N' para  que ";
|PINTA 1211, " se puedan generar las bases de cotiza- ";
|PINTA 1311, " cion de  atrasos individualizadas  por ";
|PINTA 1411, " meses  tanto en los  lotes FAN como en ";
|PINTA 1511, " los TC2.                               ";
|PINTA 1611, " -------------------------------------- ";
|ATRI 0;
*/
|FPRC;

|PROCESO CampoComp; |TIPO 7;
     |ABRE #labempre;
     #labempre#0 = 10330;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          aAlfa = #labempre#10;
          |QBF aAlfa;
          |SI aAlfa = "B61369435";      || GEMPSA
               |CAMPO_MODIFICA #0#79, 1, "S";
               |CAMPO_VISUAL #0#79, 1, "S";
               |PINTA 0873, "ITs.:  ³"
               |PINTA #0#79;
          |SINO;
               #0#79 = "S";
               |CAMPO_MODIFICA #0#79, 1, "N";
               |CAMPO_VISUAL #0#79, 1, "N";
               |PINTA 0873, "       ³"
               |PINTA #0#79;
          |FINSI;
     |FINSI;
     |CIERRA #labempre;
|FPRC;

|PROCESO ayuda3; |TIPO 7;
|SI FSalida = 5;|O FSalida = 4;    |ACABA;   |FINSI;

|PUSHV 08102251;
|CUADRO 08 10 22 51;
|ATRI R;
||            1234567890123456789012345678901234567890
|PINTA 0911, " -------------------------------------- ";
|PINTA 1011, "                                        ";
|PINTA 1111, "  Ejemplo de aplicacion de los tipos de ";
|PINTA 1211, " normalizacion  a multiplos  de  100 en ";
|PINTA 1311, " los casos de cotizacion diaria:        ";
|PINTA 1411, "                                        ";
|PINTA 1511, "  Base sin normalizar: 2.141            ";
|PINTA 1611, "  Dias de cotizacion : 31               ";
|PINTA 1711, "                                        ";
|PINTA 1811, "  Base normalizada tipo 1: 3.100        ";
|PINTA 1911, "  Base normalizada tipo 2: 2.100        ";
|PINTA 2011, "                                        ";
|PINTA 2111, " -------------------------------------- ";
|ATRI 0;
|FPRC;

|PROCESO ayuda2; |TIPO 0;
/*
|SI FSalida = 5;|O FSalida = 4;    |ACABA;   |FINSI;
|POPV;
*/
|FPRC;

|PROCESO PorcenFijo; |TIPO 7;
     |SI #0#14 = "F";
          |C_M #0#15, 1, "S";
     |SINO;
          |C_M #0#15, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Normaliza; |TIPO 7;
|DDEFECTO #32;
|ABRE #32;
|LEE 000#32p;
|CIERRA #32;
|SI #32#7 = 0; #0#64 = 1;     |FINSI;
|SI #32#7 = 1; #0#64 = 300;   |FINSI;
|SI #32#7 = 2; #0#64 = 3000;  |FINSI;
|PINTA #0#64;
|FPRC;

||****************************************************************************
||                    LECTURA PRINCIPAL DE TRABAJADORES
||****************************************************************************

|PROCESO ini_traba;
    sw_promedio = 0;

    pro_201 = 0;
    pro_202 = 0;
    pro_203 = 0;
    pro_204 = 0;
    pro_205 = 0;
    pro_206 = 0;
    pro_207 = 0;
    pro_208 = 0;
    pro_299 = 0;

    pra_201 = 0;
    pra_202 = 0;
    pra_203 = 0;
    pra_204 = 0;
    pra_205 = 0;
    pra_206 = 0;
    pra_207 = 0;
    pra_208 = 0;
    pra_299 = 0;

    pag_201 = 0;
    pag_202 = 0;
    pag_203 = 0;
    pag_204 = 0;
    pag_205 = 0;
    pag_206 = 0;
    pag_207 = 0;
    pag_208 = 0;
    pag_299 = 0;

    no_201 = 0;
    no_202 = 0;
    no_203 = 0;
    no_204 = 0;
    no_205 = 0;
    no_206 = 0;
    no_207 = 0;
    no_208 = 0;
    no_299 = 0;

    nPor1 = #2#30;
    nPor2 = #2#174;
    nPor3 = #2#175;

    |SI #0#14 = "F";
         nPor1 = #0#15;
         nPor2 = #0#15;
         nPor3 = #0#15;
    |FINSI;
|FPRC;


|PROCESO leecateg;     || lee y graba desde el fichero de variaciones/categ.
     |BUCLELIN 0gracateg#3;
|FPRC;

|DEFBUCLE leecateg;
     #3#1;
     ;
     #2#87, #2#17, #0#65;
     #2#87, #2#17, #0#76;
     ;
     NULL, leecateg;
|FIN;

|PROCESO leetraba;     || lee y graba desde el fichero de variaciones/trabaj.
     nUnid990 = 0;
     nImp989 = 0;
     |BUCLELIN 0gratraba#5;
|FPRC;

|DEFBUCLE leetraba;
     #5#1;
     ;
     #2#0, #2#1, #0#65;
     #2#0, #2#1, #0#76;
     ;
     NULL, leetraba;
|FIN;

|PROCESO proceso;
|HAZ comprueba;
|SI swCalcula = 1;
    mes_x = 12;
    |HAZ historico;          || comprueba si el a¤o que se calcula esta ya
    |SI Fhistorico = 0;      ||/vencido o no, para las pagas diferidas
        anyo_actual = "N";
    |SINO;
        anyo_actual = "S";
    |FINSI;
    |HAZ ini_traba;
     swMensual = 0;
     swJornadas = 0;
     |SI #2#42 = "A";
          swBaseFija = 1;
          swMensual = 1;
     |SINO;
          swJornadas = 1;
     |FINSI;
    |PARA mes_x = #0#8; |SI mes_x [ #0#10; |HACIENDO mes_x = mes_x + 1;
        |HAZ chequea;
        |HAZ activasino;
        |SI swfuera = 0; |Y swActiva = 1;
            |HAZ historico;
            |HAZ TipoCot;
                #9#0 = #2#87;
            |LEE 040#9=;
            |SI FSalida = 0;
                    cabecera = 0;
                    danti_0_his = 0;
                |HAZ pintalo;
                |HAZ lee_control;
                |HAZ EnPracticas;
                |HAZ leeregis;
                |HAZ historico;
                |SI #2#42 = "C";|O #2#42 = "F";  || recoge unidades 903
                    |HAZ citricos;               || /desde historico (si existe)
                |FINSI;
                |HAZ t_parcial;
                ||HAZ leecateg;
                ||HAZ leetraba;
                |BUCLE leecateg;
                |BUCLE leetraba;
                |HAZ cabecera;
            |SINO;
                |ATRI P;
                    trabamen = #2#87;
                    trabamen = "    " + mensaje1 + trabamen + mensaje2;
                |MENAV trabamen;
                |ATRI 0;
            |FINSI;
        |FINSI;
    |SIGUE;
|FINSI;
|FPRC;

|DEFBUCLE nomcalat0;
 #2#1;
 87, 17, 77;
 #0#0, #0#2, #0#4, #0#6, #0#77;
 #0#1, #0#3, #0#5, #0#7, #0#78;
 ;
 NULL, proceso;
|FIN;

|DEFBUCLE nomcalcg;
     #2#1;
     ;
     #nomgruel#1, 00001;
     #nomgruel#1, 99999;
     ;
     NULL, proceso;
|FIN;

|PROCESO CalGrupo;       || para cada una hace el proceso de siemrpe
     |BUCLE nomcalcg;
|FPRC;

|DEFBUCLE Grupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, CalGrupo;
|FIN;

|PROCESO PorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 68; |SI nCampoG [ 75; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE Grupo;
     |SIGUE;
|FPRC;

|PROCESO comprueba;
     swCalcula = 0;
     fFecha_Baja = #2#37;
     alfa2 = "R" + #2#37 + "R";
     |SI #0#66 = "N"; |Y fFecha_Baja ] #0#67;
          swCalcula = 1;
     |FINSI;
     |SI #0#66 = "S";
          swCalcula = 1;
     |FINSI;
     |SI fFecha_Baja = "          ";
          swCalcula = 1;
     |FINSI;
|FPRC;

|PROCESO salteadaAT;
|ABRE #2;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #2#0 = #0salte_1;
        #2#1 = #0salte_2;
    |SI #2#0 ] 1;|Y #2#1 ] 1;
        |LEE 000#2=;
        |SI FSalida = 0;
            ||SI #2#44 = "A";|O #2#44 = "B";
                |HAZ proceso;
            ||FINSI;
        |FINSI;
    |FINSI;
|SIGUE;
|CIERRA #2;
|FPRC;

|PROCESO lectura;             || INICIO DEL PROCESO
|ABRE #6;
|ABRE #09;
|ABRE #10;
|ABRET #11;
|ABRET #12;
nMes = #0#8;
nAny = #0#9;
|HAZ ini_log;
|SI #0#21 = 0;
    |SI #0#68 = 0;
        |BUCLE nomcalat0;
    |SINO;
        |HAZ PorGrupos;
    |FINSI;
|SINO;
    |HAZ salteadaAT;
|FINSI;
|HAZ fin_log;
|CIERRA #6;
|CIERRA #09;
|CIERRA #10;
|CIERRAT #11;
|CIERRAT #12;
|SI nNroErrores > 0;
     |HAZ CargaLog;
|FINSI;
|SI seleccio = 0;
    |MENAV "    Seleccion vacia ...";
|SINO;
/*
    |SI #0#12 = "S";|Y #0#8 ! #0#10;
        |HAZ refundir;
    |FINSI;
*/
|FINSI;
|FPRC;

||*************************************************************************
||                    LECTURA DE CONCEPTOS
||*************************************************************************

/*
|PROCESO leecateg;     || lee y graba desde el fichero de variaciones/categ.
|ABRE #3;             || atrasos !!!
    #3#0 = #2#87;
    #3#1 = #2#17;
    #3#3 = #0#65;
|LEE 000#3=;
|SI FSalida = 0;
    |BUCLELIN 0gracateg#3;
|SINO;
    |DDEFECTO #3;
    |DDEFECTO #4;
|FINSI;
|CIERRA #3;
|FPRC;
*/
/*
|PROCESO leetraba;     || lee y graba desde el fichero de var. de trabajadores
nUnid990 = 0;
nImp989 = 0;
|ABRE #5;             || atrasos !!!
    #5#0 = #2#0;
    #5#1 = #2#1;
    #5#3 = #0#65;
|LEE 000#5=;
|SI FSalida = 0;
    |BUCLELIN 0gratraba#5;
|SINO;
    |DDEFECTO #5;
    |DDEFECTO #6;
|FINSI;
|CIERRA #5;
|FPRC;
*/


||***************************************************************************
||                GRABACION DE LINEAS DE REGISTRO
||***************************************************************************

|PROCESO BuscaVarTrab;
     #6#0 = #2#0;
     #6#1 = #2#1;
     #6#2 = #4#2;
     #6#5 = #4#5;
     |LEE 000#6=;
     |SI FSalida = 0;
          swSigue = 0;
     |FINSI;
|FPRC;

|PROCESO CompruebaJornadas;   || busca si hay jornadas: 903
     |ABRE #nomhicli;
     #nomhicli#0 = #2#0;   || empresa
     #nomhicli#1 = #2#1;   || trabajador
     #nomhicli#12 = #0#9 - 2000;  || anyo
     #nomhicli#2 = mes_x;  || mes
     #nomhicli#3 = nTipo;
     #nomhicli#4 = nConceptoJor;    || concepto de Jornadas
     |LEE 000#nomhicli.=;
     |SI FSalida = 0;
          nJornadasHis = #12#9;
     |FINSI;
     |CIERRA #nomhicli;
|FPRC;

|PROCESO gracateg;  || de calculo 'leecateg', graba lineas de categorias
     concepto = #04#02;
     unidades = #04#04;

     |HAZ convenio;
     |SI convenio = 0;
          |DDEFECTO #12;
          #12#00 = #02#00;
          #12#01 = #02#01;
          #12#02 = mes_x;
          #12#03 = 5;  || (atrasos !!!)
          #12#04 = #04#02;                || concepto
          |LEE 000#12=;
          FEstado = FSalida;
          swSigue = 1;
          |HAZ BuscaVarTrab;
          |SI swSigue = 0;
               |ACABA;
          |FINSI;
          #12#04 = #04#02;                || concepto
          |SI #04#03 = "+";  signo = 1;  |SINO;  signo = -1;  |FINSI;
          nValor = (#4#4 * signo * tp);   || valor
          nValor = nValor * nPropPrac;
          #12#10 = #12#10 + nValor;
          |HAZ recarga;
          |SI #10#3 = "A";     #12#10 = 0;    |FINSI;

          |SI #labtraba#42 = "E";
               nJornadasHis = 0;
               nConceptoJor = 903;
               |HAZ CompruebaJornadas;
               |SI nJornadasHis = 0;
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI FEstado = 0;
               |GRABA 020#12a;
          |SINO;
               |GRABA 020#12n;
          |FINSI;
          cabecera = 1;           || switch para grabar posteriormente la cabecera
     |FINSI;
|FPRC;

|PROCESO gratraba;  || de calculo 'leetraba', graba lineas de trabajadores
     concepto = #06#02;
     unidades = #06#04;

     |HAZ convenio;
     |SI convenio = 0;
          |DDEFECTO #12;
          #12#00 = #02#00;
          #12#01 = #02#01;
          #12#02 = mes_x;
          #12#03 = 5;  || (atrasos !!!)
          #12#04 = #06#02;
          |LEE 000#12=;
          FEstado = FSalida;
          |SI FEstado = 0; |Y #0#65 = #0#76;
               || Y los tipos de atrasos son desde-hasta iguales, si no
               || lo borro, como siempre, para evitar que algo me viniera
               || de categorias y se me acumulara
               |BORRA 020#12a;
          |FINSI;

          #12#04 = #06#02;            || concepto
          |SI #06#03 = "+";  signo = 1;  |SINO;  signo = -1;  |FINSI;
          nValor = (#06#04 * signo);  || valor
          nValor = nValor * nPropPrac;
          #12#10 = #12#10 + nValor

          |HAZ recarga;
          |SI #10#3 = "A";     #12#10 = 0;    |FINSI;

          |SI #labtraba#42 = "E";
               nJornadasHis = 0;
               nConceptoJor = 903;
               |HAZ CompruebaJornadas;
               |SI nJornadasHis = 0;
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI FEstado = 0;
               |GRABA 020#12a;
          |SINO;
               |GRABA 020#12n;
          |FINSI;
          cabecera = 1;             || switch para grabar posteriormente la cabecera
     |FINSI;
|FPRC;

|PROCESO grajorna;   || para grabar el 903 y 922 y 931 al 934
     |ABRE #nomhicli;
     #nomhicli#0 = #2#0;   || empresa
     #nomhicli#1 = #2#1;   || trabajador
     #nomhicli#12 = #0#9 - 2000;  || anyo
     #nomhicli#2 = mes_x;  || mes
     #nomhicli#3 = nTipo;
     #nomhicli#4 = nConceptoJor;    || concepto de Jornadas
     |LEE 000#nomhicli.=;
     |SI FSalida = 0;
          |DDEFECTO #12;
          #12#00 = #02#00;
          #12#01 = #02#01;
          #12#02 = mes_x;
          #12#03 = 5;  || (atrasos !!!)
          #12#04 = nConceptoJor;
          |LEE 000#12=;
          FEstado = FSalida;

          #12#5 = #nomhicli#5;
          #12#6 = #nomhicli#6;
          #12#7 = #nomhicli#7;
          #12#8 = #nomhicli#8;
          #12#9 = #nomhicli#9;
          #12#10 = #nomhicli#10;
          #12#11 = #nomhicli#11;

          |SI FEstado = 0;
               |GRABA 020#12a;
          |SINO;
               |GRABA 020#12n;
          |FINSI;
          cabecera = 1;             || switch para grabar posteriormente la cabecera

          |SI nConceptoJor = 903;
               swgracon = 0;     || para que machaque campos si existe
               swcongra = 0;     || para que no acumule si existe
               duni1_101 = #nomhicli#9;
               duni2_101 = #nomhicli#11;
               graba04 = 101;
               graba09 = duni1_101;
               graba10 = dvalo_101;
               graba11 = duni2_101;
               |SI duni1_101 ! 0; |O dvalo_101 ! 0; |O duni2_101 ! 0;
                    |HAZ grabacon;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomhicli;
|FPRC;

|PROCESO cargaJornadas;
     nConceptoJor = 903; |HAZ grajorna;
     nConceptoJor = 922; |HAZ grajorna;
     nConceptoJor = 931; |HAZ grajorna;
     nConceptoJor = 932; |HAZ grajorna;
     nConceptoJor = 933; |HAZ grajorna;
     nConceptoJor = 934; |HAZ grajorna;
|FPRC;

|PROCESO recarga;
     #12#00 = #02#00;          || codigo empresa
     #12#01 = #02#01;          || codigo trabajador
     #12#02 = mes_x;           || mes
     #12#03 =      5;          || tipo (atrasos !!!)
     #12#05 = #10#03;          || calculo alfa
     |SI #10#03 = "Z";
          |SI #2#42 = "M";|O #2#42 = "X";|O es_irregul = 1;  #12#05 = "F";  |FINSI;
          |SI #2#42 = "D";|O #2#42 = "T";                    #12#05 = "M";  |FINSI;
     |FINSI;
     |SI #12#05 = "Z";       || si no es diario ni mensual
          #12#05 = "F";
     |FINSI;
     |SI #12#04 = 102; |Y #12#05 = "M";       || 3923.520
          #12#05 = "F";
     |FINSI;
     #12#06 = #10#04;          || calculo nume
     #12#07 = #10#05;          || situacion
     #12#08 = #10#06;          || descripcion

     Fhistorlinea = 111;
     |SI #12#5 = "F";|O #12#5 = "V";
          |HAZ historlinea;              || lee la linea del historico
     |FINSI;
     |SI Fhistorlinea = 0;
          #12#09 = #22#9;            || unidades desde historico
          swPorcAnt = 0;
          |HAZ valor_porcen;
          |SI #12#4 = 102;
          |Y swPorcAnt = 0; || porque si no, me hace lo de la antiguedad del
                            || historico, por diferencias con la actual, y en
                            || este caso hay que hacerlo por el porcentaje
               |HAZ historlinea;              || lee la linea del historico
               |SI Fhistorlinea = 0;
                    danti_0_his = 0;
                    |HAZ valor_antig_cat;

                    || esto es para que lo que hemos hecho en el proceso ante-
                    || rior de buscar importes de antiguedad de otros tipos
                    || de atrasos en el mismo periodo SOLO lo haga para ADADE
                    || ya que para otros clientes (Asecor) esta dando problemas
                    || por no quererlo

                    |SALVA_FICHA #labempre;
                    |ABRE #labempre;
                    #labempre#0 = 2788;
                    |LEE 000#labempre.=;
                    aAlfa = #labempre#10;
                    |QBF aAlfa;
                    |SI FSalida = 0; |Y aAlfa = "A53200598";
                         |HAZ histor_atrasos_siempre;
                    |SINO;
                         |HAZ histor_atrasos;
                    |FINSI;
                    |CIERRA #labempre;
                    |REPON_FICHA #labempre;
               |FINSI;
          |FINSI;
     |SINO;
          |HAZ busca_irregu;
          |SI con_irr = 1;|Y es_irregul = 1;|Y #12#5 = "F";
               #12#09 = tpz;          || unidades (sal.base irregulares)
          |SINO;
               #12#09 = 1;        || permito horas extra (2885.514)
               /*
               |SI #12#4 < 301;|O #12#4 > 399;
                     #12#09 = 1;        || unidades (resto, menos horas extras)
               |FINSI;
               */
          |FINSI;
     |FINSI;
     /*
     |SI #12#5 = "E";
          |HAZ historlinea;              || lee la linea del historico
          |SI Fhistorlinea = 0;
               #12#09 = #22#9;            || unidades desde historico
          |FINSI;
     |FINSI;
     */
     #12#11 = 0;                    || unidades calculo
|FPRC;

|PROCESO busca_irregu;
    con_irr = 0;
|ABRE #38;
    #38#0 = #2#87;
    #38#1 = #12#4;
|LEE 000#38=;
|SI FSalida = 0;|Y #38#3 = "S";
        con_irr = 1;
|FINSI;
|CIERRA #38;
|FPRC;

|PROCESO histor_atrasos_siempre;
     |ABRE #22;

     |PARA nTipo = 5; |SI nTipo [ 20; |HACIENDO nTipo = nTipo + 1;
          |SI swSigue = 1;
               #22#3 = nTipo;
               |LEE 000#22=;
               |SI FSalida = 0;
                    danti_0_his = danti_0_his + (#22#10 * #22#11);
               |FINSI;
          |FINSI;
     |SIGUE;

     |CIERRA #22;
|FPRC;

|PROCESO histor_atrasos;
     |ABRE #22;
     |ABRE #nomatant;

     #nomatant#0 = #labtraba#0;
     #nomatant#1 = #0#9;
     |LEE 000#nomatant.=;
     |SI FSalida = 0;
          swSigue = 0;
          |PARA nCampo = 2; |SI nCampo [ 10; |HACIENDO nCampo = nCampo + 2;
               nTipo = #nomatant#nCampo#;
               nCampo1 = nCampo + 1;
               nCampo2 = (nCampo / 2) + 11;
               aAlfa = #nomatant#nCampo2# % -102;
               nAnyHist = aAlfa;
               |SI #nomatant#nCampo1# = "S";
                    swSigue = 1;
               |FINSI;

               |SI swSigue = 1;
                    #22#0 = #2#0;   || empresa
                    #22#1 = #2#1;   || trabajador
                    #22#12 = nAnyHist; || anyo
                    #22#2 = mes_x;  || mes
                    #22#3 = nTipo;
                    #22#4 = 102;    || concepto 102
                    |LEE 000#22=;
                    |SI FSalida = 0;
                         danti_0_his = danti_0_his + (#22#10 * #22#11);
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #nomatant;
     |CIERRA #22;
|FPRC;

|PROCESO valor_antig_cat;
     danti_0_his = #22#10;
|FPRC;

|PROCESO valor_porcen;
     |ABRE #37;
     #37#0 = #2#87;
     #37#1 = #12#4;
     |LEE 000#37=;
     |SI FSalida = 0;
          #12#10 = #22#10 % #37#3;   || aplica porcentaje
          |SI #12#4 = 102;
               swPorcAnt = 1;
          |FINSI;
     |FINSI;
     |CIERRA #37;
|FPRC;

|PROCESO leedoce;
|LIBERA #12;
    #12#0 = #2#0;
    #12#1 = #2#1;
    #12#2 = mes_x;
    #12#3 = 5;   || (atrasos !!!)
    #12#4 = doce;
|LEE 100#12=;
|FPRC;

|PROCESO Incidencias;
     nIncid = 0;
     nMes = mes_x;
     |HAZ historico;
     |SI Fhistorico = 0;
          |ABRE #22;
          #22#0 = #2#0;   || empresa
          #22#1 = #2#1;   || trabajador
          #22#2 = mes_x;  || mes
          #22#3 = 0;       || tipo para resto
          alfa1 = #0#9 % -102;
          #22#12 = alfa1; || anyo
          #22#4 = 120;  || concepto     || busco el 120
          |LEE 000#22=;
          |SI FSalida = 0;
               nIncid = 501;
               |HAZ graba_inc;
          |SINO;
               #22#4 = #labtraba#213;  || concepto
               |LEE 000#22=;
               |SI FSalida = 0;
                    nIncid = 501;
                    |HAZ graba_inc;
               |FINSI;
          |FINSI;

          |SI #21#16 ! 0;     || hay paga
               |SI #2#157 ! "V"; |O #2#158 ! "V"; |O #2#159 ! "V"; |O #2#160 ! "V";
                |O #2#161 ! "V"; |O #2#162 ! "V"; |O #2#163 ! "V"; |O #2#164 ! "V";
                    |SI #2#165 = 0; |O #2#166 = 0; |O #2#167 = 0; |O #2#168 = 0;
                     |O #2#169 = 0; |O #2#170 = 0; |O #2#171 = 0; |O #2#172 = 0;
                          nIncid = 502;
                          |HAZ graba_inc;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #22;
     |FINSI;

     || comento la grabacion de la 999 por que me esta dando problemas
     || en principio solo saldra la 501 y la 502, que son las qua ha pedido
     || el Dany
     /*
     |SI nIncid = 0;
          nIncid = 999;
          |HAZ graba_inc;
     |FINSI;
     */
|FPRC;

|PROCESO CompAgosto2012;
     swAgosto2012 = 0;
     |SI #0#9 ] 2012;
          |SI #0#9 > 2012; |O mes_x ] 8;
                swAgosto2012 = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DiasPeriodo;
     aAlfa2 = mes_x; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = #0#9;

     aAlfa1 = "01";
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaIniPer = aAlfa;

     nMes = mes_x;
     nAny = #0#9;
     |HAZ topemes_plb;
     aAlfa1 = nTopemes;
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaFinPer = aAlfa;

     aAlfa = #labtraba#36
     fFechaAlta = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaBaja = #labtraba#37;
     |SINO;
          fFechaBaja = "31.12.2999";
     |FINSI;
/*
     aAlfa = #nomvarca#16;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaBaja = #nomvarca#16;
     |FINSI;
*/
     swPerCompleto = 1;
     |SI fFechaAlta > fFechaIniPer;
          fFechaIniPer = fFechaAlta;
          swPerCompleto = 0;
     |FINSI;
     |SI fFechaBaja < fFechaFinPer;
          fFechaFinPer = fFechaBaja;
          swPerCompleto = 0;
     |FINSI;
|FPRC;

|PROCESO Jornadas;
     nDias = 0;

     |ABRE #gomdetjr;
     #gomdetjr#0 = #labtraba#0;
     #gomdetjr#1 = #labtraba#1;
     #gomdetjr#2 = #0#9;
     #gomdetjr#3 = mes_x;
     |LEE 000#gomdetjr.=;

     |SI FSalida = 0;
          swHayJornadas = 1;
          |HAZ DiasPeriodo;
          aAlfa = fFechaIniPer; aAlfa = aAlfa % 102; nDesde = aAlfa;
          aAlfa = fFechaFinPer; aAlfa = aAlfa % 102; nHasta = aAlfa;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               nDia = nCampo - 3;
               |SI nDesde [ nDia; |Y nDia [ nHasta;
                    |SI #gomdetjr#nCampo# ! "D";
                         nDias = nDias + 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #gomdetjr;
|FPRC;

||***************************************************************************
||                 GRABACION DE CABECERA DE REGISTRO
||***************************************************************************

|PROCESO cabecera;
     |SI cabecera = 1;          || comprueba si hay que grabar la cabecera
          seleccio = seleccio + 1;
          |HAZ CompAgosto2012;
          |HAZ calleer;         || lee empresa, constantes y calendario
          |SI #0#9 ] 2007; |Y nEpigConv = 0;
               |ACABA;
          |FINSI;
          |HAZ caldias;         || calcula los dias de enfermedad, etc.  ????
          |HAZ calanti;         || calcula el salario base, antiguedad y plus
          |HAZ calunac;         || calcula las unidades y los acumulados
          acum1_200 = 0;
          acum2_200 = 0;
          |SI #2#42 ! "E"; |O #32#10 = "S";
               |HAZ calpror;     || calcula la prorrata
               |HAZ calpaga;     || calcula las pagas
          |FINSI;
          |HAZ calenfe;         || calcula base enfermedad
          |HAZ calfin1;         || calculo final 1
          |HAZ calfin2;         || calculo final 2
          |DDEFECTO #11;
          #11#0 = #2#0;    || empresa
          #11#1 = #2#1;    || trabajador
          #11#2 = mes_x;   || mes
          #11#3 = 5;  || tipo (atrasos !!!)
          #11#4 = #2#36;   || fecha de alta
          #11#5 = fecbaj;  || fecha de baja
          #11#6 = #2#34;   || fecha de antiguedad
          #11#7 = dia_2;   || dias periodo
          #11#8 = dcoti_0; || dias alta
          |SI swCambiaCot = 1;
               #11#8 = dbaja_3 - dalta_3 + 1;
          |FINSI;
          |SI ddese_2 > 0;
               || ddese_3 trae los dias naturales y no cotizables
               nNume1 = dia_4 - (dalta_2 + dbaja_2 + dhuel_2 + ddese_2);
               |SI swCambiaCot = 1; nNume1 = nNume1 + swAjuste3; |FINSI;
               #11#8 = nNume1;
          |FINSI;
          ||SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
               |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
                    |HAZ historico;
                    |SI Fhistorico = 0;
                         || para que coja lo declarado en el historico
                         #11#8 = #21#8;
                    |SINO;
                         swHayJornadas = 0;
                         |HAZ Jornadas;
                         |SI swHayJornadas = 1;
                              #11#8 = nDias;
                         |FINSI;
                    |FINSI;
               |FINSI;
          ||FINSI;
          nNume = #nomhicca#9;
          |SI nNume ! 000;
               #11#9 = nNume;   || tipo contrato
          |SINO;
               #11#9 = #2#45;   || tipo contrato
          |FINSI;
          #11#10 = #11#8;  || dias contrato (TC2) = dias alta
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               #11#10 = dcoti_0;  || citricos = me guardo las jornadas
          |FINSI;
          #11#11 = #2#47;  || horas contrato
          |SI #2#42 = "A"; |O #2#42 = "E";
               #11#9 = #21#9; || tipo contrato
               #11#10 = dbaja_3; || dias contrato  (AGRARIA*) hasta jornada
               #11#11 = #21#11;  || horas contrato (AGRARIA*) jornadas
          |FINSI;
          |SI es_irregul = 1;|Y tpz ! 0;
               #11#8 = tpz;      || dias alta
               #11#10 = #11#8;   || dias contrato (TC2) = dias alta
          |FINSI;
          |SI diastc2 ! 0;
               #11#10 = diastc2; || dias contrato (TC2) = concepto 917
          |FINSI;

          nume1 = (#2#47 * #11#8); || horas cto. por dias alta
          |SI 0 < nume1; |Y nume1 < 0.5;
               nume1 = 1;
          |SINO;
               nume1 = nume1 ! 0;
          |FINSI;
          |SI es_parcial = 1; |O es_irregul = 1;
               #11#11 = nume1;   || horas contrato por dias alta en t.parcial
          |SINO;
               |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
               |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";    || agrarios no
                    |SI #nomconca#162 = 0; #nomconca#162 = 40; |FINSI;
                    #11#11 = (((#nomconca#162 / 7) ! 2) * #11#8) ! 0;
                    |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
                         |SI #labtraba#47 ! 0;
                              #11#11 = (#labtraba#47 * #11#8) ! 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI horatc2 ! 0;
               #11#11 = horatc2; || horas contrato = concepto 918
          |FINSI;
          #11#12 = #02#39;   || codigo bonificacion
          #11#13 = nPor1;    || (%) IRPF
          #11#14 = acum_991; || base IRPF 1
          #11#15 = reten_11; || retencion IRPF 1
          #11#16 = acum2_200;|| base IRPF pagas
          #11#17 = reten_2;  || retencion IRPF pagas
          #11#18 = acum_41;  || base IRPF exenta
          |PARA campo = 12; |SI campo [ 15;
          |HACIENDO campo = campo + 1;
               desde = campo - 8;
               hasta = campo - 4;
               puntero = desde + 15;  #11puntero = #21puntero;   || tabla de
               puntero = hasta + 15;  #11puntero = #21puntero;   || /variaciones
               puntero = campo + 15;  #11puntero = #21puntero;   || /desde hist.
               puntero1 = campo + 80; puntero2 = campo + 122;
               #11puntero1 = #21puntero2;   || recaida S/N
               puntero1 = campo + 85; puntero2 = campo + 127;
               fFecha = #21puntero2;
               aAlfa = fFecha;
               |QBT aAlfa;
               |SI aAlfa = ".."; |O aAlfa = "00.00.0000";
               |O aAlfa = "01.01.0000";
                    aAlfa = "";
               |FINSI;
               #11puntero1 = aAlfa;         || fecha it inicial
          |SIGUE;
          #11#31 = denfe_2;  || total dias enfermedad
          #11#32 = dacci_2;  || total dias accidente
          #11#33 = dhuel_2;  || total dias huelga
          #11#34 = dabse_2;  || total dias absentismo
          #11#35 = prom_enf; || promedio enfermedad
          #11#36 = prom_acc; || promedio accidente
          #11#37 = acum_10 + coba_3 + n400Cot;  || base cotizacion
          #11#38 = dvalo_pro;|| base prorratas
          #11#39 = base_6;   || base cotizacion cont. comunes
          |SI #0#79 = "N";
               #11#103 = "S";
          |FINSI;
          |SI #2#42 ! "A";|Y #2#42 ! "B";|Y #2#42 ! "E";
               #11#40 = base_7;   || base cotizacion D+F+P
          |SINO;
               |SI #32#12 = 1;
                    #11#40 = base_7;            || conting. prof. segun nomina
               |FINSI;
               |SI #32#12 = 2;
                    #11#40 = #11#37 + #11#38;   || conting. prof. segun TC2
               |FINSI;
          |FINSI;
          #11#41 = dacum_30; || base H.E. 1
          #11#42 = dacum_31; || base H.E. 2
          #11#43 = bon_0;    || base 1 bonifi.
          #11#44 = bon_3;    || base 2 bonifi.
          #11#45 = base_E;   || S.S. cgo. empresa
          #11#46 = bruto_rec;|| bruto recibo
          #11#47 = bruto_pag;|| bruto paga
          #11#48 = dto_con + deducss;  || dto. cont. comunes
          #11#49 = dto_dfp;  || dto. D+F+P
          #11#50 = dto_ho1;  || dto. horas 1
          #11#51 = dto_ho2;  || dto. horas 2
          #11#52 = antici1;  || anticipos -1-
          #11#53 = antici2;  || anticipos -2-
          #11#54 = especie;  || en especie
          #11#55 = acum_51;  || importe ayuda familiar      (501)
          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";    || agrarios, solo mutuas
               #11#55 = #21#55;         || agrarios, jornadas en baja
          |FINSI;
          #11#56 = acum_52;  || importe ayuda subnormalidad (502)
          #11#57 = acum_53;  || importe enfermedad          (503)
          #11#58 = acum_54;  || importe accidentes          (504)
          #11#59 =       0;  || complemento enfermedad      (515)
          ||#11#60 =       0;  || complemento accidente       (512)
          #11#60 = dtodo_3;  || complemento automatico      (514)
          #11#61 = bon_1;    || (%) con. comunes
          #11#62 = base_5;   || base cotiz. enfe/acci
          #11#63 = base_F;   || cuota bonif. 1
          #11#64 = base_D;   || cuota bonif. 2
          #11#65 = dmate_2;  || total dias maternidad
          #11#66 = dvaca_2;  || total dias vacaciones
          #11#129 = dries_2;  || total dias riesgo embarazo
          #11#139 = dpate_2;  || total dias paternidad
          #11#67 = nPor2;    || (%) irpf 2
          #11#68 = nPor3;    || (%) irpf 3
          #11#69 = acum_992; || base irpf 2
          #11#70 = acum_993; || base irpf 3
          #11#71 = reten_12; || reten. irpf 2
          #11#72 = reten_13; || reten. irpf 3
          #11#73 = denfe_4;  || prestacion enf. empresa     (515)
          #11#74 = acum_99;  || total irpf
          #11#75 = reten_1;  || total retenciones
          #11#76 = #21#117;  || dto.pagas huelga
          #11#77 = #21#118;  || dto.pagas absentismo
          #11#78 = ddese_2;
          || #11#79 = zbon_0;   || base bonificada CC (2)
          || #11#80 = zbon_3;   || base bonificada CP (2)
          #11#79 = coba_4;   || base cont. empresa CC
          #11#80 = cobb_4;   || base cont. empresa CP
          #11#81 = zbase_F;  || cuota bonif. (1)
          #11#82 = nPorBon1; || (%) bonif. (1), para el TC2/1
          #11#83 = nPorBon2; || (%) bonif. (2), para el TC2/1
          #11#84 = bon_5;    || base ILT bonificada (1), para el TC2/1
          #11#85 = zbon_5;   || base ILT bonificada (2), para el TC2/1
          #11#88 = bon_60;   || importe bonificacion mayores 60 a¤os RDL 16/2001
          #11#86 = aSwDD;       || para los seguros sociales, me hara falta
          #11#106 = bon_59;

          #11#119 = #nomhicca#161;
          #11#120 = #nomhicca#162;
          #11#121 = #nomhicca#163;
          #11#122 = #nomhicca#164;

          #11#108 = bruto_rec + base_E;      || coste total trabajador
          #11#109 = bruto_rec - dto_con - deducss - dto_dfp - dto_ho1 - dto_ho2 - reten_1; || liquido nomina
          #11#110 = acum2_200;               || coste pagas
          #11#111 = acum2_200 - reten_2;     || liquido pagas
          #11#112 = #11#108 + #11#110;       || total coste
          #11#113 = #11#109 + #11#111;       || total liquido
          #11#117 = coba_4;
          #11#159 = #nomcontr#17;
          |SI dries_2 ! 0;              || base riesgo
               |SI dries_2 = dmate_2;
                    #11#130 = coba_4;
               |SINO;
                    #11#130 = (dries_2 - swAjuste3) * prom_enf;
               |FINSI;
               #11#117 = #11#117 - #11#130;
          |FINSI;
          #11#132 = base_11;

          |SI #2#42 = "A"; |O #2#42 = "E";
               |SI swBaseFija = 1;
                    #11#114 = nDiasPagoSS;
                    #11#115 = nBasePagoSS_CC;
                    #11#134 = nBasePagoSS_CP;
               |FINSI;
               |SI swJornadas = 1;
                    #11#114 = nJornPagoSS;
                    #11#115 = nBasePagoSS_CC;
                    #11#134 = nBasePagoSS_CP;
                    #11#124 = nDiasPagoSS;
               |FINSI;

               |HAZ GrabaCotiz;
               #11#117 = coba_4;
               #11#148 = #nomcalcc#42;       || reduccion CC Alta
               #11#155 = #nomcalcc#43;       || total reduccion CC IT
               #11#156 = #nomcalcc#44;       || total reduccion Des IT

               #11#149 = nRedCCEnf;
               #11#150 = nRedDesEnf;
               #11#151 = nRedCCMat;
               #11#152 = nRedDesMat;
               #11#153 = nRedCCAcc;
               #11#154 = nRedDesAcc;

               #11#157 = nRedCCEnfEmp;
               #11#158 = nRedDesEnfEmp;

               #11#146 = nATEP_IT;
          |FINSI;
          |SI swCambiaCot = 1;
               #11#181 = "S";
          |FINSI;

          #11#184 = #0#9;
          fFecha = ~; #11#188 = fFecha;
          |HAZ VersionNom_plb;
          #11#190 = aVersion;
          |SI #0#16 = "S";
               #11#171 = 1;
          |SINO;
               #11#171 = 0;
          |FINSI;
          |SI #2#42 = "A"; |O #2#42 = "E";
               |HAZ SS_Empresa_Agr;
          |SINO;
               |HAZ SS_Empresa;
          |FINSI;

          |GRABA 020#11a;           || ya habia grabado antes para |BUCLELIN
          enMes = mes_x; enAny = #0#9;
          ||HAZ GrabaBases;   || esto fuera, ya estamos todos el SILTRA

          |HAZ Incidencias;

          nTip = #nomcalac#3;
          |HAZ GrabaNompag;
          |LIBERA #11;
     |FINSI;
|FPRC;

||****************************************************************************
||            RUTINAS GENERALES ESPECIFICAS O COMUNES A CALCULOS
||****************************************************************************

|PROCESO pintalo;
|PINTA 2072, #2#0;
|PINTA 2172, #2#1;
    alfa1 = mes_x;
    alfa1 = " " + alfa1;
    alfa1 = alfa1 % -102;
|PINTA 2275, alfa1;
|FPRC;

|PROCESO leeregis;    || si existe registro anterior se borra
    #11#0 = #2#0;
    #11#1 = #2#1;
    #11#2 = mes_x;
    #11#3 =     5; || (atrasos !!!)
|LEE 000#11=;
|SI FSalida = 0;
        primera = 0;
    |CIERRAT #12;
    |BUCLELIN 1NULL#11;
    |ABRET #12;
    |BORRA 020#11a;
|FINSI;
    cabecera = 0;     || switch para ver si tiene que grabar cabecera al final
    fijo_1 = 0;
    jornadasIT = 0;

|SI #2#64 ! "M";|Y #2#64 ! "D";    || clave cotizacion
        #2#64 = #2#42;
|FINSI;

    es_aprendi = 0;
|SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
     es_aprendi = 1;
|FINSI;
|FPRC;

|PROCESO t_parcial;                || proporcion tiempo parcial
     tp1 = 40;
     |SI #2#42 = "X"; |O #2#42 = "T"; |O #2#42 = "P"; |O #2#42 = "I";
          tp2 = #nomconca#162;
     |SINO;
          tp2 = 40;
     |FINSI;
     tpx = -1;

    es_parcial = 0;
|SI #2#42 = "X";|O #2#42 = "T";|O #2#42 = "P";
        es_parcial = 1;
    |SI #2#234 ! 0;  tp1 = #2#234;  |FINSI;
        concepto = 910; |HAZ t_parcial2; |SI tp3 ! -1; tp1 = tp3; |FINSI;
        concepto = 912; |HAZ t_parcial2; |SI tp3 ! -1; tp1 = tp3; |FINSI;

        concepto = 909; |HAZ t_parcial2; |SI tp3 ! -1; tp2 = tp3; |FINSI;
        concepto = 911; |HAZ t_parcial2; |SI tp3 ! -1; tp2 = tp3; |FINSI;
|FINSI;
    tp = tp1 / tp2;

    es_irregul = 0;
|SI #2#42 = "I";|O #2#42 = "P";
        es_irregul = 1;
        concepto = 914; |HAZ t_parcial2; |SI tp3 ! -1; tpx = tp3; |FINSI;
    |SI tpx ! -1;
            tpz = tpx;            || de variaciones (si estan creadas)
    |SINO;
        |SI Fhistorico ! 0;
                tpz = #2#46;      || del trabajador (si no existe historico)
        |SINO;
                tpz = #21#8;      || del historico (si existe)
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO t_parcial2;
    tp3 = -1;
|ABRE #35;
    #35#0 = #2#87; #35#1 = #2#17; #35#2 = concepto;
|LEE 000#35=;
|SI FSalida = 0; tp3 = #35#3; |FINSI;
|CIERRA #35;

|ABRE #34;
    #34#0 = #2#0;  #34#1 = #2#1;  #34#2 = concepto;
|LEE 000#34=;
|SI FSalida = 0; tp3 = #34#3; |FINSI;
|CIERRA #34;

|ABRE #33;
    #33#0=#2#0;  #33#1=#2#1;  #33#2=mes_x;  #33#3=0;  #33#4=concepto;
|LEE 000#33=;
|SI FSalida = 0; tp3 = #33#5; |FINSI;
|CIERRA #33;
|FPRC;

|PROCESO chequea;  || chequea el trabajador este en periodo de alta
    swfuera = 0;
    fecalf = #2#36;   || fecha de alta
|HAZ desglosa;
|SI any > #0#9;|O any = 0;
        swfuera = 1;
|SINO;
    |SI mes > mes_x; |Y any = #0#9;
            swfuera = 1;
    |FINSI;
|FINSI;
|SI swfuera = 0;
        fecalf = #2#37;  || fecha de baja
    |HAZ desglosa;
    |SI any < #0#9; |Y any ! 0;
            swfuera = 1;
    |SINO;
        |SI mes < mes_x; |Y any = #0#9; |Y mes ! 0;
                swfuera = 1;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO convenio;     || comprueba si existe linea de convenio
|DDEFECTO #10;
    convenio = 0;
    #10#00 = #2#87;
    #10#02 = concepto;
|LEE 000#10=;
|SI FSalida = 0; |O concepto ] 901;  || los conceptos 9xx pasan aunque no esten
        convenio = 0;
    |SI concepto ] 901; |Y concepto [ 999;
        |SI concepto = 901;  #10#6 = "N§ HORAS";  |FINSI;
        |SI concepto = 902;  #10#6 = "INDEMNI.";  |FINSI;
        |SI concepto = 903;
                #10#6 = "CITRICOS";
                fijo_1 = unidades;    || jornadas citricos (prevalece sobre hist.)
        |FINSI;
        |SI concepto = 922;
                jornadasIT = unidades;
        |FINSI;
        |SI concepto = 904;  #10#6 = "VACACION";  |FINSI;
        |SI concepto = 905;  #10#6 = "HORAS TP";  |FINSI;
        |SI concepto = 906;  #10#6 = "ANTIC. 1";  |FINSI;
        |SI concepto = 907;  #10#6 = "ANTIC. 2";  |FINSI;
        |SI concepto = 908;  #10#6 = "ESPECIE ";  |FINSI;
        |SI concepto = 923;  #10#6 = "ESPECIE2";  |FINSI;
        |SI concepto = 924;  #10#6 = "ESPECIE3";  |FINSI;
        |SI concepto = 909;  #10#6 = "H.C.SEM.";  |FINSI;
        |SI concepto = 910;  #10#6 = "H.T.SEM.";  |FINSI;
        |SI concepto = 911;  #10#6 = "H.C.MES ";  |FINSI;
        |SI concepto = 912;  #10#6 = "H.T.MES ";  |FINSI;
        |SI concepto = 913;  #10#6 = "ALTA=CTO";  |FINSI;
        |SI concepto = 914;  #10#6 = "D.ALTA  ";  |FINSI;
        |SI concepto = 916;  #10#6 = "DED.S.S.";  |FINSI;
        |SI concepto = 917;  #10#6 = "DIAS TC2";  |FINSI;
        |SI concepto = 918;  #10#6 = "HORASTC2";  |FINSI;
        |SI concepto = 919;  #10#6 = "BASEIRPF";  |FINSI;

        |SI concepto = 991;  #10#6 = "PAGA 1  ";  |FINSI;
        |SI concepto = 992;  #10#6 = "PAGA 2  ";  |FINSI;
        |SI concepto = 993;  #10#6 = "PAGA 3  ";  |FINSI;
        |SI concepto = 994;  #10#6 = "PAGA 4  ";  |FINSI;
        |SI concepto = 995;  #10#6 = "PAGA 5  ";  |FINSI;
        |SI concepto = 996;  #10#6 = "PAGA 6  ";  |FINSI;
        |SI concepto = 997;  #10#6 = "PAGA 7  ";  |FINSI;
        |SI concepto = 998;  #10#6 = "PAGA 8  ";  |FINSI;
        |SI concepto = 990;
            #10#6 = "BASE ERE";
            nUnid990 = #nomtraal#4;
        |FINSI;
        |SI concepto = 989;
            #10#6 = "BASE IT ";
            nImp989 = #nomtraal#4;
        |FINSI;
        |SI concepto > 924;|Y concepto < 989;
                convenio = 1;         || los no contemplados no los graba
        |SINO;
            |SI FSalida ! 0;
                    #10#3 = "V";
                    #10#4 = 0;
                    #10#5 = 0;
            |FINSI;
        |FINSI;
    |FINSI;
|SINO;
        convenio = 1;
|FINSI;
|FPRC;

|PROCESO citricos;
|SI Fhistorico = 0;
        #12#4 = 903;
    |HAZ historlinea;
    |SI Fhistorlinea = 0;
            fijo_1 = #22#9;   || jornadas citricos (desde historico)
    |FINSI;
|FINSI;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
    numer = anynum $ 4;
|SI numer = 0;
        bisiesto = 1;
|SINO;
        bisiesto = 0;
|FINSI;
|SI mesnum =  1;  topemes = 31;            |FINSI;
|SI mesnum =  2;  topemes = 28 + bisiesto; |FINSI;
|SI mesnum =  3;  topemes = 31;            |FINSI;
|SI mesnum =  4;  topemes = 30;            |FINSI;
|SI mesnum =  5;  topemes = 31;            |FINSI;
|SI mesnum =  6;  topemes = 30;            |FINSI;
|SI mesnum =  7;  topemes = 31;            |FINSI;
|SI mesnum =  8;  topemes = 31;            |FINSI;
|SI mesnum =  9;  topemes = 30;            |FINSI;
|SI mesnum = 10;  topemes = 31;            |FINSI;
|SI mesnum = 11;  topemes = 30;            |FINSI;
|SI mesnum = 12;  topemes = 31;            |FINSI;
|FPRC;

|PROCESO grabacon;        || GRABA O REGRABA LINEAS DE CALCULO SEGUN VARIABLES
    #12#00 = #2#0;        || empresa
    #12#01 = #2#1;        || trabajador
    #12#02 = mes_x;       || mes
    #12#03 = 5;           || tipo  (atrasos !!!)
    #12#04 = graba04;     || concepto
|LIBERA #12;
|LEE 100#12=;
    FEstado = FSalida;
|SI FEstado ! 0; |O swgracon = 1;    || switch para regrabar campos convenio
        #12#05 = graba05; || calculo alfa
        #12#06 = graba06; || calculo nume
        #12#07 = graba07; || situacion
        #12#08 = graba08; || descripcion
|FINSI;
|SI FEstado = 0; |Y swcongra = 1;    || switch para regrabar acumulando
        tempo1 = #12#10;  || valor anterior
        tempo2 = #12#11;  || unidades calculo anterior
        tempo3 = graba10; || valor actual
        tempo4 = graba11; || unidades calculo actual
        tempo5 = (tempo1 * tempo2) + (tempo3 * tempo4); || importe total
        graba10 = tempo5; || valor concepto nuevo
        graba11 = 1;      || unidades calculo concepto nuevo
|FINSI;
    #12#09 = graba09;     || unidades
    #12#10 = graba10;     || valor
    #12#11 = graba11;     || unidades calculo
|SI FEstado ! 0;  |GRABA 020#12n;  |FINSI;
|SI FEstado = 0;  |GRABA 020#12a;  |FINSI;
|LIBERA #12;
|FPRC;

|PROCESO coefi;     || CALCULA EN 'dcofi_999' COEFICIENTE SEGUN LINEA CALCULO
    concepto = #12#4;
    unidades = #12#9;
|HAZ convenio;      || lee el concepto del convenio para recoger vacaciones
|SI #12#5 = "M"; #12#9 = dia_4;  |FINSI;  || si es 'M' le pone dias cotizables
|SI #12#5 = "D"; #12#9 = dia_2;  |FINSI;  || si es 'D' le pone dias del mes
|SI #12#6 =  0;  dcofi_999 = 1;         |FINSI;
|SI #12#6 =  1;  dcofi_999 = dcofi_1;   |FINSI;   || dias cobro
|SI #12#6 =  2;  dcofi_999 = dcofi_2;   |FINSI;   || dias cotizables
|SI #10#7 = "N";|Y #12#5 ! "V";         || no entra en vacaciones
    |SI #12#6 = 0;       || 'N0'
        |SI dvaca_2 ! 0;  dcofi_999 = 0;  |SINO;  dcofi_999 = 1;  |FINSI;
    |FINSI;
    |SI #12#6 = 1;       || 'N1'
            dcofi_999 = dcofi_5;
    |FINSI;
    |SI #12#6 = 2;       || 'N2'
            dcofi_999 = dcofi_7;
    |FINSI;
|FINSI;
|SI #10#7 = "E";|Y #12#5 ! "V";         || solo entra en vacaciones
    |SI #12#6 = 0;                      || 'E0'
        |SI dvaca_2 = 0;  dcofi_999 = 0;  |SINO;  dcofi_999 = 1;  |FINSI;
    |FINSI;
    |SI #12#6 = 1;|O #12#6 = 2;         || 'E1' / 'E2'
          |HAZ historlinea;
            dcofi_999 = dcofi_6;
    |FINSI;
|FINSI;
|SI #12#5 = "L";         || dias laborables
    |SI #10#7 = "S";
        |SI #12#6 = 0;  #12#9 = conser1;  |FINSI;
        |SI #12#6 = 1;  #12#9 = dlabo_0;  |FINSI;
        |SI #12#6 = 2;  #12#9 = dlabi_0;  |FINSI;
    |FINSI;
    |SI #10#7 = "N";    #12#9 = vlabo_0;  |FINSI;      || vac. no
    |SI #10#7 = "E";    #12#9 = dvaca_1;  |FINSI;      || solo vac.
|FINSI;
|SI #12#5 = "K";         || dias festivos
    |SI #10#7 = "S";
        |SI #12#6 = 0;  #12#9 = conser2;  |FINSI;
        |SI #12#6 = 1;  #12#9 = dlabo_k;  |FINSI;
        |SI #12#6 = 2;  #12#9 = dlabi_k;  |FINSI;
    |FINSI;
    |SI #10#7 = "N";    #12#9 = vlabo_k;  |FINSI;      || vac. no
    |SI #10#7 = "E";    #12#9 = dvaca_k;  |FINSI;      || solo vac.
|FINSI;
|SI #12#5 = "L";|O #12#5 = "K";
        dcofi_999 = 1;
|FINSI;
     |SI #12#5 = "E";
          |HAZ historlinea;              || lee la linea del historico
          |SI Fhistorlinea = 0;
               #12#09 = #22#9;            || unidades desde historico
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO lib_0;   || halla ultimo dia natural del mes
    mesnum = mes_x;
    anynum = #0#9;
|HAZ ulti_dia;
    guarda = topemes;
|FPRC;

|PROCESO lee_control;
|DDEFECTO #32;
|ABRE #32;
|LEE 000#32p;
|CIERRA #32;
|FPRC;

|PROCESO tipos; |TIPO 0;      || construye fechas vencimiento para antiguedad
    mesact = mes_x;
    anyact = #0#9;
    nume1 = mesact;
    nume2 = anyact;
|HAZ rellena;
    tipo1 = alfa1 + "." + alfa2;    || mes actual

    nume1 = nume1 - 1;
|SI nume1 = 0;
        nume1 = 12;
        nume2 = nume2 - 1;
|FINSI;
|HAZ rellena;
    tipo2 = alfa1 + "." + alfa2;    || mes siguiente

|SI mesact [  3;|Y mesact ] 1;  nume1 =  3;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =  6;  |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =  9;  |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 = 12;  |FINSI;
|HAZ rellena;
    tipo3 = alfa1 + "." + alfa2;    || trimestre actual

|SI mesact [  3;|Y mesact ] 1;  nume1 =  12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =   3;                      |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =   6;                      |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 =   9;                      |FINSI;
|HAZ rellena;
    tipo4 = alfa1 + "." + alfa2;    || trimestre siguiente

|SI mesact [  6;|Y mesact ] 1;  nume1 =  6;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 = 12;  |FINSI;
|HAZ rellena;
    tipo5 = alfa1 + "." + alfa2;     || semestre actual

|SI mesact [  6;|Y mesact ] 1;  nume1 = 12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 =  6;                      |FINSI;
|HAZ rellena;
    tipo6 = alfa1 + "." + alfa2;     || semestre siguiente

    nume1 = 12;
|HAZ rellena;
    tipo7 = alfa1 + "." + alfa2;     || a¤o actual

    nume1 = 12;
    nume2 = nume2 - 1;
|HAZ rellena;
    tipo8 = alfa1 + "." + alfa2;     || a¤o siguiente
|FPRC;

|PROCESO rellena;      || rellena de ceros campos numericos ('tipos')
    alfa1 = nume1;  alfa1 = "00" + nume1;  alfa1 = alfa1 % -102;
    alfa2 = nume2;
    nume1 = mesact;
    nume2 = anyact;
|FPRC;

||****************************************************************************
||   CALCULO DE LECTURA DE EMPRESA,CALENDARIO Y CONSTANTES Y BONIFICACIONES
||****************************************************************************

|PROCESO constante;
     alfa1 = "01";
     alfa2 = mes_x;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #0#9;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
     |SI aCError ! "";
          |SI nCConst = 500;
               aAlfa = "0000No se ha encontrado la Constante Comun del ";
               aAlfa = aAlfa + " Regimen General (500)";
               |MENAV aAlfa;
          |SINO;
               alfa1 = #labtraba#0; alfa1 = "00000" + #labtraba#0; alfa1 = alfa1 % -105;
               alfa2 = #labtraba#1; alfa2 = "00000" + #labtraba#1; alfa2 = alfa2 % -105;
               aAlfa = "0000ATENCION: Trabajador: " + alfa1 + "." + alfa2;
               aAlfa = aAlfa + " La constante del trabajador no esta definida.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calleer;  || LEE EMPRESA, CONSTANTE Y CALENDARIO
|SI #11#0 ! #1#0; |O swempre = 0;
        swempre = 1;
    |ABRE #1;
    |DDEFECTO #1;
        #1#0 = #11#0;
    |LEE 020#1=;
    |CIERRA #1;
|FINSI;
|SI #20#0 ! #2#156; |O #20#13 ! #0#9;
    |ABRE #20;
    |DDEFECTO #20;
        #20#0  = #2#156;
        #20#13 = #0#9;
    |LEE 000#20=;
    |CIERRA #20;
|FINSI;
/*
|SI es_aprendi = 1;|O #2#45 = "064";|O #2#45 = "065";
    |ABRE #36;
    |DDEFECTO #36;
        #36#0 = #1#32;
    |LEE 000#36=;
    |SI FSalida ! 0;
            alfa1 = "    Constante Especial [" + #1#32 + "] inaccesible o inexistente ...";
        |MENAV alfa1;
    |FINSI;
    |CIERRA #36;
|FINSI;
CodigoCons = 0;
|ABRE #101;
#101#0 = #2#0;
#101#1 = #2#1;
|LEE 000#101=;
|SI FSalida = 0;
     CodigoCons = #101#3;
|FINSI;
|CIERRA #101;
|SI CodigoCons = 0;
     CodigoCons = #1#32;
|FINSI;
*/

|DDEFECTO #52;
|ABRE #52;
    #52#0 = #2#0;
    #52#1 = #2#77;
|LEE 000#52=;            || deducciones de notarias
|CIERRA #52;
swSigue = 0;
|ABRE #41;
#41#77=#2#0;
#41#78=#2#1;
#41#79=mes_x;
#41#80=#0#9;
|LEE 000#41=;
|SI FSalida!0;  || si no existe esa constante
     nCConst = #labtraba#248;
     |HAZ constante;

/*     |ABRE #15;
     |DDEFECTO #15;                || lee la constante (sino hay remedio)
          #15#0 = CodigoCons;
     |LEE 020#15=;
     |CIERRA #15;
*/
|SINO;
     || #15#0=CodigoCons;    || leer codigos de constante por emp,trab,mes,anyo
     #15#0=#labtraba#248;    || aunque la encuentre da igual, pongo la del labtraba
                             || ya no leo mas la constante
     |PARA i=1;|SI i[76; |HACIENDO i=i+1;
          #15i=#41i;
     |SIGUE;
|FINSI;
|CIERRA #41;
    nRecAy = #15#74;
||SI #36#5 = "N";    nRecAy = 0;    |FINSI;
     |SI #0#9 [ 2018;
          nEl36 = 36;
     |SINO;
          nEl36 = 40;
     |FINSI;
|SI #2#112 ! "S";   nEl36 = 0;     |FINSI;

    por1_cont = #15#07;                             || (%) contigen.(tra.)
    por1_hor1 = #15#09;                             || (%) horas 1  (tra.)
    por1_hor2 = #15#11;                             || (%) horas 2  (tra.)
    por1_dfpg = #15#13 + #15#15 + #15#17 + #15#19;  || (%) d+f+p+g  (tra.)
    por1_des = #15#13;                              || (%) des      (tra.)
    por1_fp = #15#17;                               || (%) fp       (tra.)
    por2_cont = #15#06 + nRecAy;                    || (%) contigen.(emp.)
    por2_hor1 = #15#08;                             || (%) horas 1  (emp.)
    por2_hor2 = #15#10;                             || (%) horas 2  (emp.)
    por2_dfpg = #15#12 + #15#14 + #15#16 + #15#18;  || (%) d+f+p+g  (emp.)
    por2_des = #15#12; por2_fog = #15#14; por2_fp = #15#16; || ccc

|SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085";|O #2#45 = "421";
        por1_hor1 = por1_hor1 + por1_dfpg;         || (%) horas 1 (aprend)
        por1_hor2 = por1_hor2 + por1_dfpg;         || (%) horas 2 (aprend)
|FINSI;
|SI #2#45 = "064";        || temporales
        || por1_cont = por1_cont * #36#21;      || (%) contigen.(tra.)
        || por2_cont = por2_cont * #36#21;      || (%) contigen.(emp.)
|FINSI;
|SI #2#45 = "065";        || indefinidos
        || por1_cont = por1_cont * #36#22;      || (%) contigen.(tra.)
        || por2_cont = por2_cont * #36#22;      || (%) contigen.(emp.)
|FINSI;
    por1_cont = por1_cont ! 2;
    por2_cont = por2_cont ! 2;
/*
|SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";    || agrarios, solo mutuas
        por1_cont = 0;                                  || (%) contigen.(tra.)
        por1_hor1 = 0;                                  || (%) horas 1  (tra.)
        por1_hor2 = 0;                                  || (%) horas 2  (tra.)
        por1_dfpg = 0;                                  || (%) d+f+p+g  (tra.)
        por2_cont = 0;                                  || (%) contigen.(emp.)
        por2_hor1 = 0;                                  || (%) horas 1  (emp.)
        por2_hor2 = 0;                                  || (%) horas 2  (emp.)
        por2_dfpg = 0;                                  || (%) d+f+p+g  (emp.)
|FINSI;
*/
    notaria = #52#2;
|SI #2#42 = "L";
        por1_cont = por1_cont - #52#4;       || (%) deduccion ayuntamientos
        notaria = 0;
|FINSI;

||SI #16#0 ! #2#39; |O swlbonif = 0;
        swlbonif = 1;
    |ABRE #16;
    |DDEFECTO #16;
        #16#0 = #2#39;
    |LEE 000#16=;
    |SI FSalida = 0;
        nAny = #0#9;
        nMes = mes_x;
        nCodigoBon = #16#0;
        |HAZ VerifBonif;
          |SI swAgosto2012 = 1; |Y #nombonif#27 = "N";
              |DDEFECTO #16;
          |FINSI;
    |FINSI;
    |CIERRA #16;
    |SI #16#10 = 4;
            por1_dfpg = 0;  || (%) d+f+p+g  (tra.)
            por2_dfpg = 0;  || (%) d+f+p+g  (emp.)
            por1_des = 0; por1_fp = 0;
            por2_des = 0; por2_fog = 0; por2_fp = 0;
    |FINSI;
||FINSI;
|SI #17#0 ! #2#32; |O swlepigr = 0;
        swlepigr = 1;
    |ABRE #17;
    |DDEFECTO #17;
          |SI #0#9 [ 2006;
               nEpigConv = #2#32;
          |SINO;
               |HAZ VerifCNAE;
          |FINSI;
        #17#0 = nEpigConv;
    |LEE 000#17=;
        epig_ilt = #17#1;
        epig_ims = #17#2;
    |CIERRA #17;
|FINSI;

|ABRE #18;
    #18#0 = #2#0;        || el fichero epigrafes/trabajador lo lee siempre!!!
    #18#1 = #2#1;
    #18#2 = #2#32;
|LEE 000#18=;
|SI FSalida = 0; |Y #0#9 [ 2006;
        epig_ilt = #18#3;
        epig_ims = #18#4;
|FINSI;
|CIERRA #18;
|FPRC;

||****************************************************************************
||                       CALCULO DE DIAS
||****************************************************************************

|PROCESO nomabsca;
     nNume1 = 8;

     |ABRE #nomabsca;
     #nomabsca#0 = #labtraba#0;
     #nomabsca#1 = #labtraba#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;
          nNume1 = #nomabsca#2;
          swNoEntra = 1;
     |FINSI;

     |CIERRA #nomabsca;
|FPRC;

|PROCESO Absentismos;
     alfa1 = #nomabsli#2;
     alfa1 = alfa1 % 102;
     topemes1 = alfa1;
     alfa2 = #nomabsli#3;
     alfa2 = alfa2 % 102;
     topemes2 = alfa2;
     |SI #nomabsli#4 = "A";
          swmarca = "K";
     |FINSI;
     |SI #nomabsli#4 = "V";
          swmarca = "A";
     |FINSI;
     |SI #nomabsli#4 = "H";
          swmarca = "B";
     |FINSI;
     swNoEntra = 0;
     |HAZ nomabsca;

     dias_v = 0;
     |SI #nomabsli#6 = 0;
          dias_v = topemes2 - topemes1 + 1;
     |SINO;
          dias_v = (topemes2 - topemes1 + 1) * ((#nomabsli#6 / nNume1) ! 3);
     |FINSI;

     |HAZ calendar;

     |SI swmarca = "K";
          swaju_abs = 1;
          |HAZ absent;
     |FINSI;
     |SI swmarca = "A";
          swaju_vac = 1;
          |HAZ vacaci;
     |FINSI;
     |SI swmarca = "B";
          swaju_hue = 1;
          |HAZ huelga;
     |FINSI;
|FPRC;

|DEFBUCLE AbsHueVac;
     #nomabsli#1;
     ;
     #labtraba#0, #labtraba#1, fFechaDesde;
     #labtraba#0, #labtraba#1, fFechaHasta;
     ;
     NULL, Absentismos;
|FIN;

|PROCESO AbsHueVacNUEVO;
     dias_v = 0;
     mesnum = mes_x;
     anynum = #0#9;
     alfa1 = "01";
     alfa2 = topemes;
     alfa3 = mesnum; alfa3 = "00" + mesnum; alfa3 = alfa3 % -102;
     alfa4 = anynum;
     aFechaDesde = alfa1 + "." + alfa3 + "." + alfa4;
     aFechaHasta = alfa2 + "." + alfa3 + "." + alfa4;
     fFechaDesde = aFechaDesde;
     fFechaHasta = aFechaHasta;
     |BUCLE AbsHueVac;
|FPRC;

|PROCESO caldias;        || CALCULO DE DIAS VARIOS
|HAZ cerodias;           || inicializa variables
    dia_k = diafest;     || dias festivos del mes
    dia_1 = dialabo;     || dias laborables del mes
    dia_2 = topemes;     || dias que tiene el mes
    dia_3 = 30;          || dias cotizacion 'mensual'
|SI #2#42 = "D";|O #2#42 = "T";
        dia_3 = topemes; || dias cotizacion 'diario'
|FINSI;
    swmarca = "B";
|HAZ altas;              || calcula dias de alta (en su caso)
|HAZ bajas;              || calcula dias de baja (en su caso)
|PARA campos = 27; |SI campos [ 30; |HACIENDO campos = campos + 1;
    |SI #21campos ! " "; |Y #0#79 ! "N";
            camdes = campos - 8;  topemes1 = #21camdes;
            camhas = campos - 4;  topemes2 = #21camhas;

        |SI topemes1 = 0;  topemes1 =      1;  |FINSI;
        |SI topemes2 = 0;  topemes2 = guarda;  |FINSI;

        |SI topemes1<dalta_3; #21camdes=dalta_3; topemes1=dalta_3; |FINSI;
        |SI topemes2>dbaja_3; #21camhas=dbaja_3; topemes2=dbaja_3; |FINSI;

        |SI #21campos="H";|O #21campos="D"; swmarca="B"; |FINSI; || baja
        |SI #21campos="A";                  swmarca="J"; |FINSI; || accidente
        |SI #21campos="F";                  swmarca="K"; |FINSI; || absentismo
        |SI #21campos="E";                  swmarca="I"; |FINSI; || enfermedad
        |SI #21campos="M";                  swmarca="M"; |FINSI; || maternidad
        |SI #21campos="P";                  swmarca="M"; |FINSI; || paternidad
        |SI #21campos="R";                  swmarca="M"; |FINSI; || riesgo emb.
        |SI #21campos="O";                  swmarca="M"; |FINSI; || otras IT
        |SI #21campos="V";                  swmarca="A"; |FINSI; || vacaciones

        |HAZ calendar;

        |SI #21campos = "E";|Y topemes2 = guarda;  swaju_enf = 1;  |FINSI;
        |SI #21campos = "M";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
        |SI #21campos = "P";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
        |SI #21campos = "R";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
        |SI #21campos = "O";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
        |SI #21campos = "A";|Y topemes2 = guarda;  swaju_acc = 1;  |FINSI;
        |SI #21campos = "F";|Y topemes2 = guarda;  swaju_abs = 1;  |FINSI;
        |SI #21campos = "f";|Y topemes2 = guarda;  swaju_abs = 1;  |FINSI;
        |SI #21campos = "H";|Y topemes2 = guarda;  swaju_hue = 1;  |FINSI;
        |SI #21campos = "V";|Y topemes2 = guarda;  swaju_vac = 1;  |FINSI;
        |SI #21campos = "D";|Y topemes2 = guarda;  swaju_des = 1;  |FINSI;

        |SI #21campos = "H";  |HAZ huelga;  |FINSI;  || calcula dias huelga
        |SI #21campos = "F";  |HAZ absent;  |FINSI;  || calcula dias absen.
        |SI #21campos = "f";  |HAZ absent;  |FINSI;  || calcula dias absen.
        |SI #21campos = "A";  |HAZ accide;  |FINSI;  || calcula dias accid.
        |SI #21campos = "E";  |HAZ enferm;  |FINSI;  || calcula dias enfer.
        |SI #21campos = "M";  |HAZ matern;  |FINSI;  || calcula dias mater.
        |SI #21campos = "P";  |HAZ matern;  |FINSI;  || calcula dias mater.
        |SI #21campos = "R";  |HAZ matern;  |FINSI;  || calcula dias mater.
        |SI #21campos = "O";  |HAZ matern;  |FINSI;  || calcula dias mater.
        |SI #21campos = "C";  |HAZ matern;  |FINSI;  || calcula dias mater.
        |SI #21campos = "V";  |HAZ vacaci;  |FINSI;  || calcula dias vacac.
        |SI #21campos = "D";  |HAZ desemp;  |FINSI;  || calcula dias desemp.
    |FINSI;
|SIGUE;
     |HAZ AbsHueVacNUEVO;
     ddese_2 = #nomhicca#119;
     || dvaca_2 = #nomhicca#105;
     || variables paralelas para los mensuales diarios o diarios mensuales
    hbaja_2 = dbaja_2;
    ||hdese_2 = ddese_2;   hhuel_3 = dhuel_3;  habse_3 = dabse_3;
    hdese_2 = ddese_2;   hhuel_3 = dhuel_2;  habse_3 = dabse_2;
    hacci_2 = dacci_2;   henfe_2 = denfe_2;  hmate_2 = dmate_2;

|HAZ diatodos;
|HAZ diasenf0;           || desglosa los dias de enfermedad
|HAZ bonif;              || calcula dias bonificacion
|FPRC;

||****************************************************************************
||                        RUTINAS DEL CALCULO DE DIAS
||****************************************************************************

|PROCESO cerodias;     || INICIALIZA VARIABLES DEL CALCULO DE DIAS
    dalta_1 = 0;   dalta_2 = 0;   dalta_k = 0;
    dbaja_1 = 0;   dbaja_2 = 0;   dbaja_k = 0;
    ddese_1 = 0;   ddese_2 = 0;   ddese_k = 0;   ddese_3 = 0;
    dhuel_1 = 0;   dhuel_2 = 0;   dhuel_k = 0;   dhuel_3 = 0;
    dabse_1 = 0;   dabse_2 = 0;   dabse_k = 0;   dabse_3 = 0;
    dacci_0 = 0;   dacci_1 = 0;   dacci_k = 0;   dacci_2 = 0;
    denfe_0 = 0;   denfe_1 = 0;   denfe_k = 0;   denfe_2 = 0;
    denfe_21 = 0;  denfe_22 = 0;  denfe_23 = 0;  denfe_24 = 0;
    denfe_4 = 0;
    dreca_1 = 0; dreca_2 = 0; dreca_3 = 0; dreca_4 = 0;
    denfe_A = 0;   denfe_B = 0;   denfe_C = 0;   denfe_D = 0;
    dmate_0 = 0;   dmate_1 = 0;   dmate_k = 0;   dmate_2 = 0;
    dpate_2 = 0;   dries_2 = 0;   dcont_2 = 0;
    dvaca_1 = 0;   dvaca_2 = 0;   dvaca_k = 0;
    dboni_1 = 0;   dboni_2 = 0;
    dtodo_3 = 0;
    topemes1 = 0;  topemes2 = 0;
    swaju_mat = 0;
    swaju_acc = 0;
    swaju_enf = 0;
    swaju_abs = 0;
    swaju_des = 0;
    swaju_hue = 0;
    swaju_vac = 0;
    swmarca = "A";
    histori = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";  || hay 31 as
    sw_mater = 0;
|HAZ lib_0;              || restaura el ultimo dia natural del mes
|HAZ calendar;           || calcula los dias laborables del mes
    conser1 = dialabo;
    conser2 = diafest;
|HAZ tipos;              || calcula vencimientos de antiguedad

    dvalo_pro = 0;   || acumulador total prorratas
    dvalo_pag = 0;   || acumulador total pagas
    perio1 = 0;        perio5 = 0;
    perio2 = 0;        perio6 = 0;   || acumuladores de dias paga
    perio3 = 0;        perio7 = 0;
    perio4 = 0;        perio8 = 0;
        denfe_A1 = 0; denfe_B1 = 0; denfe_C1 = 0; denfe_D1 = 0;
        denfe_A2 = 0; denfe_B2 = 0; denfe_C2 = 0; denfe_D2 = 0;
        denfe_A3 = 0; denfe_B3 = 0; denfe_C3 = 0; denfe_D3 = 0;
        denfe_A4 = 0; denfe_B4 = 0; denfe_C4 = 0; denfe_D4 = 0; aSwDD = "";
     nImp989 = 0;
     swgrabacero = 0;
     n400Cot = 0;
     swITEmp = 0;
     base_10 = 0;
     base_11 = 0;
|FPRC;

|PROCESO calendar;                 || CALCULA LOS DIAS LABORABLES
    meslabo = #20mes_x;
    dialabo = 0;
    diafest = 0;
|SI topemes1 = 0; topemes1 = 1;       |FINSI;
|SI topemes2 = 0; topemes2 = guarda;  |FINSI;
|PARA mid = topemes1; |SI mid [ topemes2; |HACIENDO mid = mid + 1;
        nume1 = (mid * 100) + 1;
        alfa1 = meslabo % nume1;
    |SI alfa1 = "0";
            dialabo = dialabo + 1;     || cuenta dias laborables
    |SINO;
            diafest = diafest + 1;     || cuenta dias festivos
    |FINSI;
    |SI swmarca ! "A";                 || construye las variaciones en variab.
            alfa1 = histori % 0;  nume0 = alfa1;         || longitud
            nume1 = (100 + (mid - 1));                   || parte izquierda
            alfa1 = histori % nume1;
            nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
            alfa2 = histori % nume2;
            histori = alfa1 + swmarca + alfa2;           || une
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO historico;
     Fhistorico = 0;
     |ABRE #21;
     |DDEFECTO #21;
     #21#0 = #2#0;   || empresa
     #21#1 = #2#1;   || trabajador
     #21#2 = mes_x;  || mes
     #21#3 = 0;      || tipo
     alfa1 = #0#9 % -102;
     #21#66 = alfa1; || anyo
     |LEE 000#21=;
     Fhistorico = FSalida;
     |CIERRA #21;
|FPRC;

|PROCESO acum_mensu_esp;
/*
     |SI #0#8 > nDesdeMes;
          nDesdeMes = #0#8;
     |FINSI;
     |SI #0#10 < nHastaMes;
          nHastaMes = #0#10;
     |FINSI;
*/

     |PARA nMesBusca = nDesdeMes; |SI nMesBusca [ nHastaMes; |HACIENDO nMesBusca = nMesBusca + 1;
          |SI nMesBusca ] #0#8; |Y nMesBusca [ #0#10;
               || no entres en los meses de lo que estoy calculando los atrasos
          |SINO;
               #nomcalal#0 = #2#0;   || empresa
               #nomcalal#1 = #2#1;   || trabajador
               #nomcalal#2 = nMesBusca;  || mes
               #nomcalal#3 = 5;          || tipo 5
               #nomcalal#4 = paga + 200;
               |LEE 000#nomcalal.=;
               |SI FSalida = 0;
                    || nAcumProrr = nAcumProrr + ((#nomcalal#9 * #nomcalal#10) ! 2);
                    nAcumProrr = nAcumProrr + #nomcalal#9;
                    nPrecioProrr = #nomcalal#10;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO mensu_especial;
     |ABRE #labempre;
     |SALVA_FICHA #labempre;            || esto esta muy feo, horrible, pero
     #labempre#0 = 400;                 || de momento no quiero que lo use
     |LEE 000#labempre.=;               || nadie mas y luego salte por otro
     |SI FSalida = 0;                   || sitio
          aAlfa = #labempre#2;
          aAlfa = aAlfa % 106;
          |SI aAlfa ! "ASECOR";
               |REPON_FICHA #labempre;
               |ACABA;
          |FINSI;
     |FINSI;
     |REPON_FICHA #labempre;
     |CIERRA #labempre;

     |SALVA_FICHA #nomcalal;

     nAcumProrr = 0;
     nPrecioProrr = 0;

     |SI #nomconca#desde# < #nomconca#hasta#;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = #nomconca#hasta#;
     |SINO;
          nDesdeMes = 1;
          nHastaMes = #nomconca#hasta#;
     |FINSI;

     |HAZ acum_mensu_esp;
/*
     |SINO;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = 12;
          nAnyPaga = #0#9 - 2000 - 1;
          |HAZ acum_mensu_esp;

          nDesdeMes = 1;
          nHastaMes = #nomconca#hasta#;
          nAnyPaga = #0#9 - 2000;
          |HAZ acum_mensu_esp;
     |FINSI;
*/

     |REPON_FICHA #nomcalal;
|FPRC;

|PROCESO topemes_paga;
     |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
          nDiasDevengo = nDiasDevengo + 30;
     |SINO;
          |SI nMesPaga = 1; |O nMesPaga = 3; |O nMesPaga = 5; |O nMesPaga = 7;
          |O nMesPaga = 8; |O nMesPaga = 10; |O nMesPaga = 12;
               nDiasDevengo = nDiasDevengo + 31;
          |SINO;
               |SI nMesPaga ! 2;
                    nDiasDevengo = nDiasDevengo + 30;
               |SINO;
                    numer = nAnyPaga $ 4;
                    |SI numer = 0;
                         bisiesto = 1;
                    |SINO;
                         bisiesto = 0;
                    |FINSI;
                    nDiasDevengo = nDiasDevengo + 28 + bisiesto;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DiasDevengo;
     nDiasDevengo = 0;
     |SI #nomconca#desde# < #nomconca#hasta#;
          nDesdeMesDev = #nomconca#desde#;
          nHastaMesDev = #nomconca#hasta#;
          nAnyPaga = #0#9;
          |PARA nMesDev = nDesdeMesDev; |SI nMesDev [ nHastaMesDev; |HACIENDO nMesDev = nMesDev + 1;
               |HAZ topemes_paga;
          |SIGUE;
     |SINO;
          nDesdeMesDev = #nomconca#desde#;
          nHastaMesDev = 12;
          nAnyPaga = #0#9 - 1;
          |PARA nMesDev = nDesdeMesDev; |SI nMesDev [ nHastaMesDev; |HACIENDO nMesDev = nMesDev + 1;
               |HAZ topemes_paga;
          |SIGUE;

          nDesdeMesDev = 1;
          nHastaMesDev = #nomconca#hasta#;
          nAnyPaga = #0#9;
          |PARA nMesDev = nDesdeMesDev; |SI nMesDev [ nHastaMesDev; |HACIENDO nMesDev = nMesDev + 1;
               |HAZ topemes_paga;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO acum_paga_esp;
     |SI #0#8 > nDesdeMes;
          nDesdeMes = #0#8;
     |FINSI;
     |SI #0#10 < nHastaMes;
          nHastaMes = #0#10;
     |FINSI;

     || swPagaPropProrr
     || me indica que es una paga prorrateada por trabajador en un calculo de
     || atrasos tipo "P", es decir proporcional a los meses que se calculan

     |PARA nMesBusca = nDesdeMes; |SI nMesBusca [ nHastaMes; |HACIENDO nMesBusca = nMesBusca + 1;
          swEncontrado = 0;

          #22#0 = #2#0;   || empresa
          #22#1 = #2#1;   || trabajador
          #22#2 = nMesBusca;  || mes
          |SI #12#4 ] 201;|Y #12#4 [ 208;|Y swbaja = 1; |Y swPagaPropProrr = 0;
               |SI #1#39 ! "1"; |Y #2#48 = "S";
                    #22#3 = 2;   || tipo para pagas de finiquito aparte
               |SINO;
                    #22#3 = 0;   || tipo para pagas de finiquito junto
               |FINSI;
          |SINO;
               #22#3 = 0;       || tipo para resto
          |FINSI;

          #22#12 = nAnyPaga; || anyo
          #22#4 = #12#4;  || concepto
          |LEE 000#22=;
          |SI FSalida = 0;
               swEncontrado = 1;
               nUnidPaga = nUnidPaga + #22#9;
          |SINO;
               || pues no lo encuentro con este tipo, nada, buscare el otro
               |SI #22#3 = 0;       || tipo para resto
                    #22#3 = 2;
               |SINO;
                    #22#3 = 0;
               |FINSI;
               |LEE 000#22=;
               |SI FSalida = 0;
                    swEncontrado = 1;
                    nUnidPaga = nUnidPaga + #22#9;
               |FINSI;
          |FINSI;

          |SI swEncontrado = 0;
               || atencion, el trabajador no tiene ficha en el historico
               || compruebo si estaba de alta, y si lo estaba, tomo las unidades
               || de paga que deberia tener

               fFechaAlta = #labtraba#36;
               |SI #labtraba#37 = "          "; |O #labtraba#37 = "..........";
                    fFechaBaja = "31.12.2999";
               |SINO;
                    fFechaBaja = #labtraba#37;
               |FINSI;

               alfa1 = "01";
               || alfa2 = mes_x; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
               || esta puesto asi, pero no tiene logica, de esta manera solo
               || mira si el trabajador esta de alta en el mes que esta calculando
               || tengo que mirarlo recorriendo la paga (creo)

               alfa2 = nMesBusca; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
               alfa3 = #0#9; |QBF alfa3;
               aAlfa = alfa1 + "." + alfa2 + "." + alfa3;
               fFechaIniPer = aAlfa;

               alfa1 = topemes;
               aAlfa = alfa1 + "." + alfa2 + "." + alfa3;
               fFechaFinPer = aAlfa;

               |SI fFechaAlta [ fFechaFinPer; |Y fFechaBaja ] fFechaIniPer;
                    || estuvo de alta
                    |HAZ DiasDevengo;

                    |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
                         nNume = (#nomconca#diasp# / nDiasDevengo) * 30;
                    |SINO;
                         nNume = (#nomconca#diasp# / nDiasDevengo) * topemes;
                    |FINSI;
                    nUnidPaga = nUnidPaga + nNume
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO PagaSiNo;
     || Resulta que en casos en que por ejemplo una paga se prorratea (en coti-
     || zacion) del 1 al 6, y la otra del 7 al 12, al calcular atrasos de
     || enero a diciembre, pago la de junio en el mes 6, correcto, pero luego
     || el trabajador es baja en agosto, y en agosto le paga la parte de la
     || de diciembre proporcional PERO LE VOLVIA A PAGAR LA DE JUNIO ENTERA

     || PONGO ESTO para que solo continue con el calculo de la paga en caso
     || de que toque (el mes_x este comprendido entre el mes desde y hasta
     || de la prorrata)
     || esto solo afecta cuando ponemos que sea proporcional a los meses que
     || se calculan, claro

     swSigue = 1;
     |SI mes_x ! #9mesco;     || debe ser que es baja
          |SI nDesdeMes [ mes_x; |Y mes_x [ nHastaMes;
               swSigue = 1;
          |SINO;
               swSigue = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO histor_especial;
     |ABRE #22;
     |DDEFECTO #22;
     nUnidPaga = 0;

     |SI #nomconca#desde# < #nomconca#hasta#;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = #nomconca#hasta#;
          nAnyPaga = #0#9 - 2000;

          |HAZ PagaSiNo;

          |SI swSigue = 1;
               |HAZ acum_paga_esp;
          |FINSI;
     |SINO;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = 12;
          nAnyPaga = #0#9 - 2000 - 1;

          |HAZ PagaSiNo;

          |SI swSigue = 1;
               |HAZ acum_paga_esp;
          |FINSI;

          nDesdeMes = 1;
          nHastaMes = #nomconca#hasta#;
          nAnyPaga = #0#9 - 2000;

          |HAZ PagaSiNo;

          |SI swSigue = 1;
               |HAZ acum_paga_esp;
          |FINSI;
     |FINSI;

     |CIERRA #22;

     #22#11 = nUnidPaga;
|FPRC;

|PROCESO historlinea;
     mesnum = mes_x;
     anynum = #0#9;
     |HAZ ulti_dia;

     |ABRE #22;
     |DDEFECTO #22;
     #22#0 = #2#0;   || empresa
     #22#1 = #2#1;   || trabajador
     #22#2 = mes_x;  || mes
     alfa1 = #0#9 % -102;
     #22#12 = alfa1; || anyo
     #22#4 = #12#4;  || concepto

     |SI #12#4 ] 201; |Y #12#4 [ 208; |Y swbaja = 1;
          #22#3 = 2;   || tipo para pagas de finiquito aparte
          |LEE 000#22=;
          Fhistorlinea = FSalida;
          |SI FSalida ! 0;
               #22#3 = 0;   || tipo para pagas de finiquito junto
               |LEE 000#22=;
               Fhistorlinea = FSalida;
          |FINSI;
     |SINO;
          #22#3 = 0;       || tipo para resto
          |LEE 000#22=;
          Fhistorlinea = FSalida;
     |FINSI;

     |SI #12#4 ] 201; |Y #12#4 [ 208;
          || se trata de una paga
          |SI Fhistorlinea = 0;
               || he encontrado el concepto
               |SI swPagaPropProrr = 1;
                    || calculo de pagas "P", en un trabajador con la paga
                    || proporcional en el trabajador
                    |SI #22#5 = "P";
                         || la paga se pago en el mes, tipo "P" con lo que se
                         || supone que es paga que se pago prorrateada y sigue
                         || siendolo
                         || Asi que dejo sin efecto el swPagaPropProrr que
                         || usaba para saber que es un trabajador con para pro-
                         || rateada en el trabajador, al que le habia puesto
                         || el swPagaPropProrr a 1 y el #9mesco con el mes
                         ||de la paga  en lugar del 99

                         swPagaPropProrr = 0;
                         #9mesco = 99;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #22;
|FPRC;

|PROCESO altas;
    swalta = 0;
    fecalf = #2#36;
    dalta_3 = 1;
|HAZ desglosa;
|SI mes = mes_x; |Y any = #0#9;     || si es alta este mes
        swalta = 1;
        topemes1 = 0;
        topemes2 = dia - 1;
        dialabo = 0;
        diafest = 0;
    |SI topemes2 ! 0;  |HAZ calendar;  |FINSI;  || por si es alta el dia 1
        dalta_k = diafest;         || dias festivos antes del alta
        dalta_1 = dialabo;         || dias laborables antes del alta
        dalta_2 = dia - 1;         || dias cotizables antes del alta
        dalta_3 = dia;             || dia que es alta
|FINSI;
|FPRC;

|PROCESO bajas;
    swbaja = 0;
    fecbaj = #2#37;  || fecha de baja desde el trabajador
    fecalf = #2#37;
    dbaja_3 = dia_2;
|HAZ desglosa;
|SI mes = mes_x; |Y any = #0#9;     || si es baja este mes
        swbaja = 1;
        topemes1 = dia + 1;
        topemes2 = 0;
        dialabo = 0;
        diafest = 0;
    |SI topemes1 [ guarda;  |HAZ calendar;  |FINSI;  || por si es final de mes
        dbaja_k = diafest;         || dias festivos despues de la baja
        dbaja_1 = dialabo;         || dias laborables despues de la baja
        dbaja_2 = dia_2 - dia;     || dias cotizables despues de la baja
        dbaja_3 = dia;             || dia hasta el que trabaja
|FINSI;                  || resta de los dias naturales del mes
|FPRC;

|PROCESO huelga;
    dhuel_k = dhuel_k + diafest;     || dias festivos que esta en huelga
    dhuel_1 = dhuel_1 + dialabo;     || dias laborables que esta en huelga
    dhuel_2 = dhuel_2 + dias_v;    || dias huelga
    dhuel_3 = dhuel_3 + dias_v;    || dias huelga(sin decim.)
/*
|SI dhuel_2 = 0;
        dhuel_2 = ((#21#33 * 100) $ 100) / 100;     || parte decimal
|FINSI;
    dhuel_2 = dhuel_2 + (topemes2 - topemes1 + 1); || dias cotizables que idem
    dhuel_2 = #21#33;     || parte decimal
    dhuel_3 = dhuel_3 + (topemes2 - topemes1 + 1); || dias cotizables que idem
*/
|FPRC;

|PROCESO desemp;
    ddese_k = ddese_k + diafest;     || dias festivos desemp.
    ddese_1 = ddese_1 + dialabo;     || dias laborables desemp.
    ddese_2 = ddese_2 + (topemes2 - topemes1 + 1); || dias cotiz. desemp.
    |SI ddese_2 ! 0; |Y swMensa = 0;
        |SI nUnid990 = 0;
            aAlfa1 = #labtraba#0; aAlfa1 = "00000" + aAlfa1; aAlfa1 = aAlfa1 % -105;
            aAlfa2 = #labtraba#1; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
            || aAlfa = "    ATENCION: Trabajador " + aAlfa1 + "." + aAlfa2 + " tiene ";
            aAlfa = "    ATENCION: Existen trabajadores que tienen ";
            aAlfa = aAlfa + "informados dias de baja por Regulacion de Empleo.";
            |MENAV aAlfa;
            aAlfa = "    Para cotizar por este periodo en Atrasos debera utilizar ";
            aAlfa = aAlfa + "el concepto 990 en Variaciones Trabajador";
            |MENAV aAlfa;
            swMensa = 1;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO absent;
     dabse_k = dabse_k + diafest;     || dias festivos que esta absento
     dabse_1 = dabse_1 + dialabo;     || dias laborables que esta absento
     dabse_2 = dabse_2 + dias_v;

     |SI #nomabsli#5 = "S";
          dabse_3 = dabse_3 + dias_v;     || dias abs.(sin decim.para pagas)
          || #7#26 = "S";
     |FINSI;
/*
|SI dabse_2 = 0;
        dabse_2 = ((#21#34 * 100) $ 100) / 100;     || parte decimal
|FINSI;
    dabse_2 = dabse_2 + (topemes2 - topemes1 + 1);     || dias de absent.
|SI #21campos = "F";
        dabse_3 = dabse_3 + (topemes2 - topemes1 + 1); || para pagas sin dec.
|FINSI;
*/
|FPRC;

|PROCESO accide;
    dacci_0 = #21#73;
    dacci_k = dacci_k + diafest;     || dias festivos que esta accidentado
    dacci_1 = dacci_1 + dialabo;     || dias laborables que esta accidentado
    dacci_2 = dacci_2 + (topemes2 - topemes1 + 1); || dias cotizables que idem
|FPRC;

|PROCESO enferm;
     |SI #21#68 ! "M"; |Y #21#68 ! "P"; |Y #21#68 ! "R"; |Y #21#68 ! "O"; || arrastra meses anteriores si misma clave
          denfe_0 = #21#70;
          |ABRE #nomhisit;
          #nomhisit#0 = #labtraba#0;
          #nomhisit#1 = #labtraba#1;
          #nomhisit#2 = #0#9;
          #nomhisit#3 = mes_x;
          nNume = campos - 26;
          #nomhisit#8 = nNume;
          |LEE 000#nomhisit.=;
          |SI FSalida = 0;
               |SI #nomhisit#10 = "S";
                    |SI nNume = 1; dreca_1 = #nomhisit#11; |FINSI;
                    |SI nNume = 2; dreca_2 = #nomhisit#11; |FINSI;
                    |SI nNume = 3; dreca_3 = #nomhisit#11; |FINSI;
                    |SI nNume = 4; dreca_4 = #nomhisit#11; |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #nomhisit;
     |FINSI;
     denfe_k = denfe_k + diafest;     || dias festivos que esta enfermo
     denfe_1 = denfe_1 + dialabo;     || dias laborables que esta enfermo
     nume1 = topemes2 - topemes1 + 1;
     |SI denfe_21 = 0;  denfe_21 = nume1;  nume1 = 0;  |FINSI;
     |SI denfe_22 = 0;  denfe_22 = nume1;  nume1 = 0;  |FINSI;
     |SI denfe_23 = 0;  denfe_23 = nume1;  nume1 = 0;  |FINSI;
     |SI denfe_24 = 0;  denfe_24 = nume1;  nume1 = 0;  |FINSI;
     denfe_2 = denfe_2 + (topemes2 - topemes1 + 1); || dias cotizables que idem
|FPRC;

|PROCESO matern;
     |SI #21#68 ! "E";        || arrastra meses anteriores si misma clave
          dmate_0 = #21#70;
     |FINSI;
     dmate_k = dmate_k + diafest;     || dias festivos que esta pariendo
     dmate_1 = dmate_1 + dialabo;     || dias laborables que esta pariendo
     dmate_2 = dmate_2 + (topemes2 - topemes1 + 1); || dias cotiz. que idem

     sw_mater = 0;
     m_dias = dmate_0 + dmate_2;

     alfa1 = topemes2;    alfa1 = "00" + alfa1;    alfa1 = alfa1 % -102;
     alfa2 = mes_x;       alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = alfa1 + "." + alfa2 + "." + #0#9;
     fech1 = alfa3;            nume1 = fech1;
     fech2 = "01.01.1995";     nume2 = fech2;
     nume3 = nume1 - nume2 + 1;

     |SI m_dias [ nume3; sw_mater = 1;  |FINSI;
     |SI mes_x ] 6; sw_mater = 1;  |FINSI;

     |SI #21campos = "R";               || dias naturales en riesgo
          dries_2 = dries_2 + (topemes2 - topemes1 + 1);
     |FINSI;
     |SI #21campos = "C";               || dias naturales en IT control SS
          dcont_2 = dcont_2 + (topemes2 - topemes1 + 1);
     |FINSI;
     |SI #21campos = "P";               || dias naturales en paternidad
          dpate_2 = dpate_2 + (topemes2 - topemes1 + 1);
     |FINSI;
|FPRC;

|PROCESO vacaci;
     dvaca_k = dvaca_k + diafest;   || dias festivos de vacaci.
     dvaca_1 = dvaca_1 + dialabo;   || dias laborables de vacaci.
     || dvaca_2 = dvaca_2 + (topemes2 - topemes1 + 1); || dias cotiz. de vacaci.
     dvaca_2 = dvaca_2 + dias_v; || dias cotiz. de vacaci.
|FPRC;

|PROCESO diasenf0;  || DESGLOSA LOS DIAS DE ENFERMEDAD (posterior a 01.08.92)
                    || CALCULA DIAS (denfe_D) PARA COMPLEMENTO EMPRESA (515)
|PARA para1 = 1; |SI para1 [ 4; |Y #0#79 ! "N";
|HACIENDO para1 = para1 + 1;
        denfe_A0 = 0;
        denfe_B0 = 0;         || acumuladores parciales
        denfe_C0 = 0;
        denfe_D0 = 0;
    |SI para1 = 1;  nume1 = denfe_21 + dreca_1 + denfe_0;  |FINSI;
    |SI para1 = 2;  nume1 = denfe_22 + dreca_2;  |FINSI;    || dias enfermo
    |SI para1 = 3;  nume1 = denfe_23 + dreca_3;  |FINSI;
    |SI para1 = 4;  nume1 = denfe_24 + dreca_4;  |FINSI;

    |SI nume1 ! 0;
        |SI nume1 ] 3;
                denfe_A0 = 3;     nume1 = nume1 - 3;       || al  0%
        |SINO;
                denfe_A0 = nume1; nume1 = 0;
        |FINSI;
        |SI nume1 ] 12;
                denfe_D0 = 12;    nume1 = nume1 - 12;      || al 60% (empresario)
        |SINO;
                denfe_D0 = nume1; nume1 = 0;
        |FINSI;
        |SI nume1 ] 5;
                denfe_B0 = 5;     nume1 = nume1 - 5;       || al 60% (seg.social)
        |SINO;
                denfe_B0 = nume1; nume1 = 0;
        |FINSI;
        |SI nume1 ] 1;
                denfe_C0 = nume1;                          || al 75%
        |SINO;
                denfe_C0 = nume1; nume1 = 0;
        |FINSI;

        |SI para1 = 1;  nume1 = denfe_21;            |FINSI;
        |SI para1 = 2;  nume1 = denfe_22;            |FINSI;    || dias enfermo
        |SI para1 = 3;  nume1 = denfe_23;            |FINSI;
        |SI para1 = 4;  nume1 = denfe_24;            |FINSI;
        |SI denfe_C0 > nume1;
                denfe_A0 = 0;
                denfe_D0 = 0;
                denfe_B0 = 0;
                denfe_C0 = nume1;
        |SINO;
                nume1 = nume1 - denfe_C0;
        |FINSI;
        |SI denfe_B0 > nume1;
                denfe_A0 = 0;
                denfe_D0 = 0;
                denfe_B0 = nume1;
        |SINO;
                nume1 = nume1 - denfe_B0;
        |FINSI;
        |SI denfe_D0 > nume1;
                denfe_A0 = 0;
                denfe_D0 = nume1;
        |SINO;
                nume1 = nume1 - denfe_D0;
        |FINSI;
        |SI denfe_A0 > nume1;
                denfe_A0 = nume1;
        |FINSI;

            denfe_A = denfe_A + denfe_A0;
            denfe_B = denfe_B + denfe_B0;
            denfe_C = denfe_C + denfe_C0;
            denfe_D = denfe_D + denfe_D0;
    |FINSI;

     || esto lo hago para saber de cada una de las ITs cuantos dias van
     || en cada tramo de prestaciones

     |SI para1 = 1;
          denfe_A1 = denfe_A0;
          denfe_B1 = denfe_B0;
          denfe_C1 = denfe_C0;
          denfe_D1 = denfe_D0;
     |FINSI;
     |SI para1 = 2;
          denfe_A2 = denfe_A0;
          denfe_B2 = denfe_B0;
          denfe_C2 = denfe_C0;
          denfe_D2 = denfe_D0;
     |FINSI;
     |SI para1 = 3;
          denfe_A3 = denfe_A0;
          denfe_B3 = denfe_B0;
          denfe_C3 = denfe_C0;
          denfe_D3 = denfe_D0;
     |FINSI;
     |SI para1 = 4;
          denfe_A4 = denfe_A0;
          denfe_B4 = denfe_B0;
          denfe_C4 = denfe_C0;
          denfe_D4 = denfe_D0;
     |FINSI;
|SIGUE;
|FPRC;

|PROCESO diatodos;          || CALCULA TOTALES FINALES DE DIAS
|| dalta_3: dia de alta si es alta este mes
|| dbaja_3: dia de baja si es baja este mes


    dia_4 = dia_3;

|SI #32#17 = 2;     |HAZ modulo1;  |FINSI;
|| DIAS COTIZABLES ILT: solamente cuando incluya el ultimo dia del mes
nCotAlta = 0;
|SI #32#18 = 3;
     |HAZ Opcion3;
|SINO;
     nCotAlta = #32#18;
|FINSI;

|SI nCotAlta = 1;|Y dalta_3 ! 1;          dia_4 = dia_2; |FINSI;
|| DIAS NATURALES ALTA: solamente cuando es alta despues del dia 1

|SI nCotAlta = 2;|Y dalta_3 = guarda;     dia_4 = dia_2; |FINSI;
|| DIAS COTIZABLES ALTA: menos cuando es alta el ultimo dia del mes

    guarda_dia_4 = dia_4;     || para calcular los dias de bonificacion

    hdias_0=dia_4;       || pueden ser mensuales diarios y diarios menusales

|SI #2#64 ! #2#42;
    |SI #2#64 = "D";     hdias_0=dia_2;      |FINSI;
    |SI #2#64 = "M";     hdias_0=   30;      |FINSI;

    |SI #32#17 = 2;      |HAZ hmodulo1; |FINSI;
    |SI nCotAlta = 1;|Y dalta_3 ! 1;          hdias_0 = dia_2; |FINSI;
    |SI nCotAlta = 2;|Y dalta_3 = guarda;     hdias_0 = dia_2; |FINSI;
|SINO;
        ||hdese_2 = ddese_2;   hhuel_3 = dhuel_3;  habse_3 = dabse_3;
        hdese_2 = ddese_2;   hhuel_3 = dhuel_2;  habse_3 = dabse_2;
        hacci_2 = dacci_2;   henfe_2 = denfe_2;  hmate_2 = dmate_2;
|FINSI;        || vuelve a cargar por si se ha ejecutado el 'modulo1'

|SI swbaja ! 0;|Y dbaja_2 ! 0;
        nume1 = dia_4 - (dalta_2 + dbaja_2);
        nume1 = nume1 - ((dbaja_3 - dalta_3) + 1);
        dbaja_2 = dbaja_2 + nume1;
|FINSI;

|SI swbaja ! 0;|Y hbaja_2 ! 0;
        nume1 = hdias_0 - (dalta_2 + hbaja_2);
        nume1 = nume1 - ((dbaja_3 - dalta_3) + 1);
        hbaja_2 = hbaja_2 + nume1;
|FINSI;
    dcobr_0=dia_4-(dalta_2+dbaja_2+dhuel_2+ddese_2+dabse_2+dacci_2+denfe_2+dmate_2);
    |SI #2#42 = "E"; |Y #32#11 = 1;
         dcobr_0 = #21#11;
    |FINSI;
    dcoti_0 = dia_4-(dalta_2+dbaja_2+dhuel_2+ddese_2);
    dlabo_0 = dia_1-(dalta_1+dbaja_1+dhuel_1+ddese_1+dabse_1+dacci_1+denfe_1+dmate_1);
    dlabi_0 = dia_1-(dalta_1+dbaja_1+dhuel_1+ddese_1);
    dlabo_k = dia_k-(dalta_k+dbaja_k+dhuel_k+ddese_k+dabse_k+dacci_k+denfe_k+dmate_k);
    dlabi_k = dia_k-(dalta_k+dbaja_k+dhuel_k+ddese_k);

    |HAZ modulo2;

    |SI swAjuste3 ! 0; |Y #2#42 ! "E";
          dcobr_0 = dcobr_0 + swAjuste3;
    |FINSI;

     |HAZ historico;
     |SI Fhistorico = 0;
          |SI #labtraba#0 = 858; |Y #labtraba#1 = 851; |Y mes_x = 2; |Y #0#9 = 2018;
               || martillazo, feo, borrar enseguida 10/2018
               #nomhicca#8 = dcoti_0;
               dmate_2 = 16;
          |FINSI;
          |SI dcoti_0 ! #nomhicca#8;
               dcoti_0 = #nomhicca#8;
               dcobr_0 = #nomhicca#8;
               dcobr_0 = dcobr_0 - (dabse_2+dacci_2+denfe_2+dmate_2);
          |FINSI;
          |SI #labtraba#0 = 858; |Y #labtraba#1 = 182; |Y mes_x = 2; |Y #0#9 = 2018;
               || martillazo, feo, borrar enseguida 10/2018
               dcoti_0 = 0;
               dcobr_0 = 0;
          |FINSI;
     |FINSI;

    vcobr_0=dcobr_0 - dvaca_2;     || resta los dias de vacaciones
    vcoti_0=dcoti_0 - dvaca_2;
    vlabo_0=dlabo_0 - dvaca_1;
    vlabo_k=dlabo_k - dvaca_k;

    hcobr_0=hdias_0-(dalta_2+hbaja_2+hhuel_3+hdese_2+habse_3+hacci_2+henfe_2+hmate_2);
    hcoti_0=hdias_0-(dalta_2+hbaja_2+hhuel_3+hdese_2);

    |SI swAjuste3 ! 0;
          hcobr_0 = hcobr_0 + swAjuste3;
    |FINSI;

     |HAZ historico;
     |SI Fhistorico = 0;
          |SI hcoti_0 ! #nomhicca#8;
               hcoti_0 = #nomhicca#8;
               hcobr_0 = #nomhicca#8;
               hcobr_0 = hcobr_0 - (dabse_2+dacci_2+denfe_2+dmate_2);
          |FINSI;
     |FINSI;

|SI dcobr_0 < 0;  dcobr_0 = 0;  |FINSI;  || dias cobro
|SI dcoti_0 < 0;  dcoti_0 = 0;  |FINSI;  || dias cotizables
|SI dlabo_0 < 0;  dlabo_0 = 0;  |FINSI;  || dias laborables 1
|SI dlabi_0 < 0;  dlabi_0 = 0;  |FINSI;  || dias laborables 2
|SI dlabo_k < 0;  dlabo_k = 0;  |FINSI;  || dias festivos 1
|SI dlabi_k < 0;  dlabi_k = 0;  |FINSI;  || dias festivos 1
|SI vcobr_0 < 0;  vcobr_0 = 0;  |FINSI;  || dias cobro sin vaca.
|SI vcoti_0 < 0;  vcoti_0 = 0;  |FINSI;  || dias cotiz. sin vaca.
|SI vlabo_0 < 0;  vlabo_0 = 0;  |FINSI;  || dias labor. sin vaca.
|SI vlabo_k < 0;  vlabo_k = 0;  |FINSI;  || dias fest. sin vaca.
|SI hcobr_0 < 0;  hcobr_0 = 0;  |FINSI;  || dias cobro sin dec.
|SI hcoti_0 < 0;  hcoti_0 = 0;  |FINSI;  || dias cotiz. sin dec.

    dilt = dacci_2+denfe_2+dmate_2;
|SI dilt = guarda;
        dcobr_0 = 0;
        hcobr_0 = 0;          || por FEBRERO
        vcobr_0 = 0;
|FINSI;

    dia_4 = dia_3;  || recupera dias cotizables

|SI #2#42 = "C"; |O #2#42 = "F";
    |SI fijo_1 ! 0;  dcoti_0=fijo_1; dcobr_0=fijo_1; |FINSI;   || citricos
    |SI #2#42 = "C"; dcoti_0=dcoti_0*citri_c;        |FINSI;
    |SI #2#42 = "F"; dcoti_0=dcoti_0*citri_f;        |FINSI;
        dcoti_0 = dcoti_0 ! 0;
        hcoti_0 = dcoti_0;
|FINSI;

    dcofi_1 =dcobr_0 /dia_4;        || coeficiente para dias cobro
    dcofi_2 =dcoti_0 /dia_4;        || coeficiente para dias cotizables
    dcofi_3 =(dcobr_0+denfe_2+dmate_2) /dia_4;  || coefi. para no dto. enfermed.
|SI dcofi_3 > 1;  dcofi_3 = 1;  |FINSI;         || ajusta a 1
    dcofi_4 =(dcobr_0+dacci_2) /dia_4;          || coefi. no dto. acc.
|SI dcofi_4 > 1;  dcofi_4 = 1;  |FINSI;         || ajusta a 1
    dcofi_5 =vcobr_0 /dia_4;                    || coef. para vacac.=N1
|SI dcofi_5 < 0;  dcofi_5 = 0;  |FINSI;         || ajusta a 0
    dcofi_6 =dvaca_2 /dia_4;                    || coef. para vacac.=E1,E2
    dcofi_7 =vcoti_0 /dia_4;                    || coef. para vacac.=N2

    hcofi_1 =hcobr_0 /hdias_0;  || coef. cobro (sin dec.)
    hcofi_2 =hcoti_0 /hdias_0;  || coef. cotizables (sin dec.)
    hcofi_3 =(hcobr_0+denfe_2+dmate_2) /hdias_0;  || coefi. no dto. enf.
|SI hcofi_3 > 1;  hcofi_3 = 1;  |FINSI;           || ajusta a 1
    hcofi_4 =(hcobr_0+dacci_2) /hdias_0;          || coefi. no dto. acc.
|SI hcofi_4 > 1;  hcofi_4 = 1;  |FINSI;           || ajusta a 1

     |SI swTransRaro = 1;
          nIncid = 13;
          |HAZ graba_inc;
          nIncid = 14;
          |HAZ graba_inc;

          dcofi_1 = 0;
          dcofi_2 = 0;
          dcofi_3 = 0;
          dcofi_4 = 0;
          dcofi_5 = 0;
          dcofi_6 = 0;
          dcofi_7 = 0;
     |FINSI;
|FPRC;

/**** PROCESOS COPIADOS DEL nomcal_3 PARA LAS OPCION 3 EN DIAS DE ALTA ******/
/******************   Y EN CALCULOS DE DIAS DE IT  **************************/


|PROCESO buscaotro;
     fech1 = #labtraba#36;    || fech1, alfa1, nume1 para fecha alta
     alfa2 = #labtraba#37;
     |QBF alfa2;
     /*
     |SI alfa2 = "";
          |ABRE #nomvarca;
          #nomvarca#0 = #labtraba#0;
          #nomvarca#1 = #labtraba#1;
          #nomvarca#2 = mes_x;
          #nomvarca#3 = 0;
          |LEE 000#nomvarca.=;
          |SI FSalida = 0;
               alfa2 = #nomvarca#16;
               |QBF alfa2;
               |SI alfa2 = "..........";
                    alfa2 = "";
               |FINSI;
          |FINSI;
          |CIERRA #nomvarca;
     |FINSI;
     */
     |SI alfa2 = "";
          |ACABA;
     |FINSI;
     fech2 = alfa2;
     nume2 = fech2;
     |SI nume2 = nume3;
          || un trabajador con fecha baja el dia anterior a la fecha alta
          || de este, entonces si este esta todo el mes de alta, cogere
          || dias cotizables, si no seran dias naturales

          alfa1 = #labtraba#36;
          |QBF alfa1;
          fech1 = alfa1;      || fecha alta trabajador encontrado

          mesnum = #0#8;
          anynum = #0#9;

          alfa1 = "01";
          alfa2 = mesnum;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
          alfa3 = anynum;
          alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
          fech4 = alfa4;      || primer dia del mes que calculo

          |SI fech1 [ fech4;
               nCotAlta = 2;    || dias cotizables

               alfa1 = "31";
               alfa2 = mesnum;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
               alfa3 = anynum;
               alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
               fech4 = alfa4;      || dia 31 del mes que calculo

               |SI fech3 = fech4;
                    || ATENCION: caso raro, transformacion de contrato, mensual,
                    || todo el mes de alta y con el priomer contrato tengo fecha
                    || baja el 30 del mes, con el segundo fecha alta el dia 1, es
                    || decir, he cotizado todo con el primer contrato y el segundo
                    || trabajador no se debe calcular si no serian 31 dias coti-
                    || zados en un mensual

                    swTransRaro = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE buscaotro;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, buscaotro;
     #labtraba#36;
|FIN;

|PROCESO BuscaOtroAlta;
     aNif = #labtraba#7;
     |SALVA_FICHA #labtraba;
     |BUCLE buscaotro;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO Opcion3;
     swTransRaro = 0;
     nCotAlta = 2;    || en principio dias cotizables

     |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
     |Y #2#42 ! "D"; |Y #2#42 ! "T";
          |SI dalta_3 ! 1;
               nCotAlta = 1;    || dias naturales

               || como no esta de alta todo el mes
               || en principio dias naturales; pero si tengo algun registro
               || con este NIF de alta desde el dia 1 o antes sera
               || por dias cotizables, ya que estoy todo el mes de alta, y
               || entre los dos contratos no puede haber mas de 30 dias de
               || alta si soy mensual

               fech3 = #labtraba#36;
               nume3 = fech3;
               nume3 = nume3 - 1;  || aqui me guardo el dia antes del alta
               |HAZ BuscaOtroAlta;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/

|PROCESO modulo1;   || ajusta los dias de ILT (dias d)
|SI #2#42 ! "D"; |Y #2#42 ! "T";
    |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
            diff= 30 - guarda;
        |SI ddese_2!0; |Y swaju_des=1;  ddese_2 =ddese_2  + diff;   |FINSI;
        |SI dhuel_2!0; |Y swaju_hue=1;  dhuel_2 =dhuel_2  + diff;
                                        dhuel_3 =dhuel_3  + diff;   |FINSI;
        |SI dabse_2!0; |Y swaju_abs=1;  dabse_2 =dabse_2  + diff;
                                        dabse_3 =dabse_3  + diff;   |FINSI;
        |SI dmate_2!0; |Y swaju_mat=1;  dmate_2 =dmate_2  + diff;   |FINSI;
        |SI dacci_2!0; |Y swaju_acc=1;  dacci_2 =dacci_2  + diff;   |FINSI;
        |SI denfe_21!0;|Y swaju_enf=1;
             denfe_2 =denfe_2 + diff;
             |SI denfe_24!0;
                  denfe_24=denfe_24 + diff;
             |SINO;
                  |SI denfe_23!0;
                       denfe_23=denfe_23 + diff;
                  |SINO;
                       |SI denfe_22!0;
                            denfe_22=denfe_22 + diff;
                       |SINO;
                            denfe_21=denfe_21 + diff;
                       |FINSI;
                  |FINSI;
             |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO hmodulo1;  || ajusta los dias de ILT (dias h)
|SI #2#64 ! "D";
    |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
            diff= 30 - guarda;
        |SI hdese_2!0; |Y swaju_des=1;  hdese_2 =hdese_2  + diff;   |FINSI;
        |SI hhuel_3!0; |Y swaju_hue=1;  hhuel_3 =hhuel_3  + diff;   |FINSI;
        |SI habse_3!0; |Y swaju_abs=1;  habse_3 =habse_3  + diff;   |FINSI;
        |SI hmate_2!0; |Y swaju_mat=1;  hmate_2 =hmate_2  + diff;   |FINSI;
        |SI hacci_2!0; |Y swaju_acc=1;  hacci_2 =hacci_2  + diff;   |FINSI;
        |SI henfe_2!0; |Y swaju_enf=1;  henfe_2 =henfe_2  + diff;   |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO VtoBonif;
     |PARA nHastaBonif = 14; |SI nHastaBonif [ 19;
                             |HACIENDO nHastaBonif = nHastaBonif + 1;
          nNume1 = (#16nHastaBonif - (#16nHastaBonif $ 12)) / 12;
          nNume2 = #16nHastaBonif $ 12;
          nVtoBonif = totalt + (nNume1 * 100) + nNume2;
          |SI totact < nVtoBonif;
               totven = nVtoBonif;
               |SI nHastaBonif = 14;
                    nNume1 = 3;
               |SINO;
                    nNume1 = nHastaBonif + 5;
               |FINSI;
               nPorBon1 = #16nNume1;         || se lleva el porcent. bonif. 1
               |SAL;
          |SINO;
               |SI totact = nVtoBonif;|Y diaalt ! 1;
                    totven = nVtoBonif;
                    |SI nHastaBonif = 14;
                         nNume1 = 3;
                    |SINO;
                         nNume1 = nHastaBonif + 5;
                    |FINSI;
                    nPorBon1 = #16nNume1;         || se lleva el porcent. bonif. 1
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     nNume1 = nHastaBonif + 1;
     |SI nNume1 [ 19;
          |SI #16nNume1 ! 0;|Y #16nNume1 > #16nHastaBonif;
               nNume2 = nNume1 + 5;
               nPorBon2 = #16nNume2;         || se lleva el porcent. bonif. 2
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO bonif;
    fecalf = #2#40; |HAZ desglosa; || desglosa fecha alta bonificacion
    diaalt = dia;     mesalt = mes;          anyalt = any;
    totalt = (anyalt * 100) + mesalt;

    fecalf = #2#41; |HAZ desglosa; || desglosa fecha vto. bonificacion
    diaven = dia;     mesven = mes;          anyven = any;
    totven = (anyven * 100) + mesven;

    alfa1 = #0#9;     alfa1 = alfa1 % -104;  nume1 = alfa1;
    totact = (nume1 * 100) + mes_x;

    nPorBon1 = #16#3;
    nPorBon2 = 0;

|SI totven = 0;
    totven = totalt;
    |HAZ VtoBonif;
    diaven = diaalt;
    mesven = totven $ 100;
    anyven = (totven - mesven) / 100;

    alfa1 = diaven;  alfa1 = ("00" + alfa1) % -102;
    alfa2 = mesven;  alfa2 = ("00" + alfa2) % -102;
    alfa3 = anyven;

    alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

    fech1 = alfa4;
    nume1 = fech1;  nume1 = nume1 - 1;  fech1 = nume1;

    fecalf = fech1; |HAZ desglosa;
    diaven = dia;   mesven = mes;  anyven = any;
|FINSI;
    aFecBajaBon = fecalf;
    dboni_1 = 0;    || dias de bonificacion
    dboni_2 = 0;    || dias de no bonificacion

|SI totalt [ totact;|Y totven ] totact; || si esta vigente
    |SI dcoti_0 > dia_4;      || CITRICOS CON COEFICIENTE
            dboni_1 = dcoti_0;
            dboni_2 = 0;
    |SINO;
            dboni_1 = dia_4;
            dboni_2 = dcoti_0 - dboni_1;
    |FINSI;
|FINSI;

|SI totact = totalt;|Y totven ! totact; || si es alta este mes
    |SI dcoti_0 > guarda_dia_4;      || CITRICOS CON COEFICIENTE
            dboni_1 = (dcoti_0 - diaalt) + 1;
            dboni_2 = 0;
    |SINO;
            dboni_1 = (guarda_dia_4 - diaalt) + 1;
            dboni_2 = dcoti_0 - dboni_1;
    |FINSI;
|FINSI;

|SI totact ! totalt;|Y totven = totact; || si es baja este mes
        dboni_1 = diaven;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;
|SI totact = totalt;|Y totven = totact; || si es alta y baja este mes
        dboni_1 = diaven - diaalt + 1;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;

|SI dboni_1 < 0;  dboni_1 = 0;  |FINSI;
|SI dboni_2 < 0;  dboni_2 = 0;  |FINSI;

|SI dboni_1 > dcoti_0;   dboni_1 = dcoti_0;  |FINSI;
|FPRC;

||****************************************************************************
||                      SUBRUTINAS DEL CALCULO DE DIAS
||****************************************************************************

|PROCESO desglosa;     || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;
|FPRC;

||****************************************************************************
||                CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************

|PROCESO calanti;     || LANZA LOS CALCULOS DE ANTIGUEDAD Y PLUS
|HAZ leetodo;                    || prepara variables para antiguedad y plus
    duni1_101 = 0;  duni2_101 = 0;   dvalo_101 = 0;
    duni1_102 = 0;  duni2_102 = 0;   dvalo_102 = 0;
    duni1_103 = 0;  duni2_103 = 0;   dvalo_103 = 0;
    danti_0 = 0;    danti_1 = 0;
|HAZ cal_101;                    || calcula el salario base
|SI #9#2 = 3;                    || (si antig=3, calcula antes el plus !!!)
    |HAZ cal_103;
|FINSI;
|HAZ cal_102;                    || calcula la antiguedad
|SI #9#2 ! 3;                    || calcula los pluses
    |HAZ cal_103;                || (si antig=3, ya habra entrado antes !!!)
|FINSI;
|HAZ gratodo;                    || regraba o graba conceptos 101,102 y 103
     |SI #2#42 = "E";
          |HAZ cargaJornadas;
     |FINSI;
|FPRC;

||****************************************************************************
||            RUTINAS DEL CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************

|PROCESO leetodo;    || LEE ANTIGUEDADES/CATEGORIAS Y EL AUXILIAR DE CONVENIOS
    |ABRE #13;
    |DDEFECTO #13;
        #13#0 = #2#87;
        #13#1 = #2#17;
    |LEE 000#13=;                 || lee antiguedad/categoria
    |CIERRA #13;
|| ******
    |ABRE #14;
    |DDEFECTO #14;
        #14#0 = #2#87;
    |LEE 000#14=;                 || lee auxiliar de convenios
    |CIERRA #14;
|| ******
    |ABRE #30;
    |DDEFECTO #30;
        #30#0 = #2#87;
        #30#1 = #2#17;
    |LEE 000#30=;                 || lee ptas base antiguedad
    |CIERRA #30;
|FPRC;

|PROCESO cal_101;         || CALCULA EL SALARIO BASE
    doce = 101;
|HAZ leedoce;
|SI FSalida = 0;
    |HAZ coefi;
        duni1_101 = #12#9;
        duni2_101 = dcofi_999 * duni1_101;  || halla unid.calculo
        dvalo_101 = #12#10;
        duni2_101 = duni2_101 ! 6;          || redondea
|FINSI;
|FPRC;

|PROCESO cal_102;     || CALCULA LA ANTIGUEDAD
     doce = 102;
     |HAZ leedoce;
     |SI FSalida = 0;
          |HAZ coefi;
          duni1_102 = #12#9;
          dvalo_102 = #12#10;
          |SI #9#2 < 2;
               duni2_102 = duni1_102 *dcofi_999;
          |SINO;
               |HAZ anyanti;
               |HAZ poranti;
               |SI es_irregul = 1;|Y #2#239 = "D";
                    danti_0 = dvalo_101;
                    duni2_102 = duni1_102;
               |SINO;
                    duni1_102 = danti_1;
                    duni2_102 = danti_1 * dcofi_999;
               |FINSI;
               |SI #9#2 ! 4;
                    |SI #14#95 = 9;
                         |SI danti_0_his ! 0;
                              dvalo_102 = danti_0 - danti_0_his;
                         |FINSI;
                    |SINO;
                         |SI #9#2 = 2;
                              dvalo_102 = (duni1_101*danti_0)/100;
                         |SINO;
                              dvalo_102 = (duni1_101*danti_0)/100;
                              dvalo_102 = dvalo_102+((duni1_103*dvalo_103)/100);
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI #12#5 = "F"; |O #12#5 = "V";         || favor a los clientes
                         |SI #12#9 = 0;  #12#9 = 1;  |FINSI;
                    |FINSI;
                    || nume1 = #30#03 * #12#9;
                    nume1 = dvalo_102 * #12#9;
                    dvalo_102 = (nume1/100)*tp;  || tablas base categoria
               |FINSI;                              ||/proporciona tiempos parcial
          |FINSI;

          duni2_102 = duni2_102 ! 6;
          dvalo_102 = dvalo_102 ! (EURODB + 2);
     |FINSI;
|FPRC;

|PROCESO busca_103;
    por_103 = 0;
|ABRE #35;               || aux. categorias
    #35#0 = #2#87;
    #35#1 = #2#17;
    #35#2 = 103;
|LEE 001#35=;
|SI FSalida = 0;  por_103 = #35#3;   |FINSI;
|CIERRA #35;

|ABRE #34;               || aux. trabajadores
    #34#0 = #2#0;
    #34#1 = #2#1;
    #34#2 = 103;
|LEE 001#34=;
|SI FSalida = 0;  por_103 = #34#3;   |FINSI;
|CIERRA #34;

|ABRE #33;               || variaciones mes
    #33#0 = #2#0;
    #33#1 = #2#1;
    #33#2 = mes_x;
    #33#3 = 0;
    #33#4 = 103;
|LEE 001#33=;
|SI FSalida = 0;  por_103 = #33#5;   |FINSI;
|CIERRA #33;
|FPRC;

|PROCESO cal_103;       || CALCULA EL PLUS
    doce = 103;
|HAZ leedoce;
|SI FSalida = 0;
    |HAZ coefi;
    |SI #9#3 < 2;                  || manual
            duni1_103 = #12#9;
    |SINO;                         || automatico
        |HAZ busca_103;
            duni1_103 = por_103;
    |FINSI;
        duni2_103 = duni1_103 * dcofi_999;
        dvalo_103 = #12#10;
    |SI #9#3 = 2;
            dvalo_103 = duni1_101 *dvalo_101 /100;    || 1% sal.base
    |FINSI;
    |SI #9#3 = 3;
            dvalo_103 = (duni1_101*dvalo_101) /100;
            dvalo_103 = dvalo_103 + ((duni1_102 *dvalo_102) /100);
    |FINSI;
        duni2_103 = duni2_103 ! 6;   || redondea unid. calculo
        ||dvalo_103 = dvalo_103 ! 2   || redondea valor comentado por redon. euro
|FINSI;
|FPRC;

|PROCESO gratodo;     || GRABA O REGRABA CONCEPTOS 101,102 Y 103
    swgracon = 0;     || para que no machaque campos si existe
    swcongra = 0;     || para que no acumule si existe
    graba04 = 101;
    graba09 = duni1_101;
    graba10 = dvalo_101;
    graba11 = duni2_101;
|SI duni1_101 ! 0; |O dvalo_101 ! 0; |O duni2_101 ! 0;
    |HAZ grabacon;
|FINSI;
    graba04 = 102;
    graba09 = duni1_102;
    graba10 = dvalo_102;
    graba11 = duni2_102;
|SI duni1_102 ! 0; |O dvalo_102 ! 0; |O duni2_102 ! 0;
    |HAZ grabacon;
|FINSI;
    graba04 = 103;
    graba09 = duni1_103;
    graba10 = dvalo_103;
    graba11 = duni2_103;
|SI duni1_103 ! 0; |O dvalo_103 ! 0; |O duni2_103 ! 0;
    |HAZ grabacon;
|FINSI;
|FPRC;

||****************************************************************************
||          SUBRUTINAS DEL CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************


|PROCESO poranti;  || halla el porcentaje o, en su caso, la cantidad, a aplicar
    yaesta = 0;
|SI #14#95 = 9;                || segun tipo de calculo de aux.convenios
    |PARA campo=4;|SI campo[53;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
        |SI campo = 14;  campo = 24;    |FINSI;
        |SI campo = 34;  campo = 44;    |FINSI;
            sigui = campo + 1;
        |SI sigui = 14;  sigui = 24;    |FINSI;
        |SI sigui = 34;  sigui = 44;    |FINSI;
        |SI anyos ] #13campo; |Y anyos < #13sigui;
                yaesta = 1;
                elotro = campo + 10;
                danti_0 = #13elotro;   || carga cantidad fija de antig./categ.
                danti_1 = duni1_102;   || carga las unidades segun calculo
        |FINSI;
    |SIGUE;
        danti_0 = danti_0 * tp;    || proporciona los tiempo parcial
|SINO;
    |PARA campo=65;|SI campo[79;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
            sigui = campo + 1;
        |SI anyos ] #14campo; |Y anyos < #14sigui; |O campo = 79;
                yaesta = 1;
                elotro = campo + 15;
                danti_0 = dvalo_101;   || carga con valor del 101
                danti_1 = #14elotro;   || carga con el porcentaje corresp.
        |FINSI;
    |SIGUE;
|FINSI;
|FPRC;

|PROCESO anyanti;   || CALCULA LOS A¥OS DE ANTIGUEDAD
|SI #2#239 = "F";
        tipox = #14#95;            || tipo de calculo segun aux. convenios
    |SI #14#95 = 9;
            tipox = #13#3;         || tipo de calculo segun antig/categ.
    |FINSI;

        alfa2 = #2#34  % 402;  fanti_m = alfa2;   || meses antiguedad
        alfa3 = #2#34  % -104; fanti_a = alfa3;   || anyos antiguedad

    |HAZ seguntipo;                || saca vencimiento segun tipo

        alfa2 = fvenci % 102;  ganti_m = alfa2;   || meses vencimiento antiguedad
        alfa3 = fvenci % -104; ganti_a = alfa3;   || anyos vencimiento antiguedad

        difer_m = ganti_m - fanti_m;    || diferencia meses
        difer_a = ganti_a - fanti_a;    || diferencia anyos

    |SI difer_m < 0;  difer_a = difer_a - 1;  |FINSI;
    |SI difer_a < 0;  difer_a = 0;            |FINSI;

        anyos = difer_a;
|SINO;
        ||anyos = (#2#240 - (#2#240 $ 365)) / 365;
        anyos = 0;
|FINSI;
|FPRC;

|PROCESO seguntipo;      || SELECCIONA FECHA VENCIMIENTO ANTIGUEDAD
|SI tipox =  0;  fvenci = #2#34;  |FINSI;
|SI tipox =  1;  fvenci = tipo1;  |FINSI;
|SI tipox =  2;  fvenci = tipo2;  |FINSI;
|SI tipox =  3;  fvenci = tipo3;  |FINSI;
|SI tipox =  4;  fvenci = tipo4;  |FINSI;
|SI tipox =  5;  fvenci = tipo5;  |FINSI;
|SI tipox =  6;  fvenci = tipo6;  |FINSI;
|SI tipox =  7;  fvenci = tipo7;  |FINSI;
|SI tipox =  8;  fvenci = tipo8;  |FINSI;
|SI tipox = 10;  fvenci = tipo1;  |FINSI;
|SI tipox = 11; |Y fanti_m < 7;
        fvenci = tipo7;
|FINSI;
|SI tipox = 11; |Y fanti_m > 6;
        fvenci = tipo8;
|FINSI;
|FPRC;

|PROCESO cal_998_anticom;     || CALCULA EL ANTI-COMPLEMENTO, EN SU CASO
     nume1 = 0;
     |SI #12#6 = 1;
          |SI #12#4 > 100;|Y #12#4 [ 199;  nume1 = 1;  |FINSI; || los cien
          |SI #12#4 > 400;|Y #12#4 < 499;  nume1 = 1;  |FINSI; || los cuatrocientos
          |SI nume1 ! 0;
               concepto = #12#4;
               |HAZ convenio;
               |SI #10#10 ! "S";|O #10#7 = "E";     || complemento NO o
                    nume1 = 0;                   ||/EXCLUSIVO vacaciones
               |SINO;
                    |SI #10#7 = "N";|Y dvaca_2 ! 0;  || si un concepto no entra en
                         nume1 = 0;                  ||/vacaciones y en este mes
                    |FINSI;                          ||/hay dias de vacaciones
               |FINSI;                              ||/no entra!!!
          |FINSI;
          |SI nume1 ! 0;
               duni2_999 = #12#11;  || unidades cobro
               duni2_998 = #12#9;   || unidades cotiz.
               dvalo_999 = #12#10;  || valor
               |SI #12#5 = "L"; duni2_998 = conser1; |FINSI;
               |SI #12#5 = "K"; |O #12#5 = "E"; duni2_998 = conser2; |FINSI;
               |SI dmate_2 > 0;
                    duni2_998 = duni2_998 * ((denfe_2 + dacci_2) / dia_4);  || segun dias alta
               |SINO;
                    duni2_998 = duni2_998 * dcofi_2;  || segun dias alta
               |FINSI;
               duni2_998 = duni2_998 ! 6;
               |SI duni2_998 > dcoti_0; |Y concepto ! 102; || (no para antiguedad)
                    duni2_998 = dcoti_0;
               |FINSI;

               produc1 = duni2_999 * dvalo_999;
               produc1 = produc1 ! EURODB;

               produc2 = duni2_998 * dvalo_999;
               produc2 = produc2 ! EURODB;

               produc3 = produc2 - produc1;
               anticom = anticom + produc3;

               |SI #12#4 ] 411;|Y #12#4 [ 499; anti_41 = anti_41 + produc3; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SiBomberos;
     |SI swModulo = 3145;
          |SI denfe_2 ! 0; |O dacci_2 ! 0;
               anticom = 0;
               |CIERRAT #12;
               |BUCLELIN 0cal_998_anticom#11;
               |ABRET #12;
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||            CALCULO DE LAS UNIDADES Y DE LOS ACUMULADOS
||****************************************************************************

|PROCESO calunac;      || LECTURA DE CONCEPTOS
|CIERRAT #12;          || cierra aqui y abre abajo para dejarlo como viene
    #11#00 = #02#00;   || empresa
    #11#01 = #02#01;   || trabajador
    #11#02 = mes_x;    || mes
    #11#03 =      5;   || tipo  (atrasos !!!)
|GRABA 020#11n;        || graba la cabecera vacia para poder leer con |BUCLELIN
|LIBERA #11;
|LEE 120#11=;
    acum_10 = 0;
    acum_11 = 0;
    acum_12 = 0;
    acum_13 = 0;
    acum_30 = 0;
    acum_301 = 0;
    acum_302 = 0;
    acum_303 = 0;
    acum_31 = 0;
    acum_311 = 0;
    acum_312 = 0;
    acum_313 = 0;
    acum_40 = 0;
    acum_401 = 0;
    acum_402 = 0;
    acum_403 = 0;
    acum_41 = 0; anti_41 = 0;
    acum_50 = 0;
    acum_51 = 0;
    acum_52 = 0;
    acum_53 = 0;
    acum_54 = 0;
    acum_60 = 0;
    acum_90 = 0;
    horasex = 0;
    antici1 = 0;
    antici2 = 0;
    especie = 0;
    deducss = 0;
    diastc2 = 0;
    horatc2 = 0;
    pagaf_1 = 0;
    pagaf_2 = 0;
    pagaf_3 = 0;
    pagaf_4 = 0;
    pagaf_5 = 0;
    pagaf_6 = 0;
    pagaf_7 = 0;
    pagaf_8 = 0;
|CIERRAT #12;
|BUCLELIN 0cal_999#11;
|ABRET #12;
|HAZ calautom;

nEnEmpresa = #labtraba#0;
|HAZ BuscaModulo;
|HAZ SiBomberos;

    acum_10 = acum_10 ! EURODB;
    acum_11 = acum_11 ! EURODB;
    acum_12 = acum_12 ! EURODB;
    acum_13 = acum_13 ! EURODB;
    acum_30 = acum_30 ! EURODB;
    acum_301 = acum_301 ! EURODB;
    acum_302 = acum_302 ! EURODB;
    acum_303 = acum_303 ! EURODB;
    acum_31 = acum_31 ! EURODB;
    acum_311 = acum_311 ! EURODB;
    acum_312 = acum_312 ! EURODB;
    acum_313 = acum_313 ! EURODB;
    acum_40 = acum_40 ! EURODB;
    acum_401 = acum_401 ! EURODB;
    acum_402 = acum_402 ! EURODB;
    acum_403 = acum_403 ! EURODB;
    acum_41 = acum_41 ! EURODB; anti_41 = anti_41 ! 2;
    acum_60 = acum_60 ! EURODB;
    acum_50 = acum_50 ! EURODB;
    acum_90 = acum_90 ! EURODB;
|SI sw_promedio = 0;               || calcula el promedio solo
        acum_xx = 0;               ||/el primer mes
    |CIERRAT #12;
    |BUCLELIN 0cal_998#11;
    |ABRET #12;
        acum_xx = acum_xx ! EURODB;
|FINSI;
|ABRET #12;
|FPRC;

||****************************************************************************
||             RUTINAS DEL CALCULO DE LAS UNIDADES Y ACUMULADOS
||****************************************************************************

|PROCESO cal_999;     || CALCULA LAS UNIDADES CALCULO DE LOS DEMAS CONCEPTOS
     |SI #12#04 < 200; |O #12#04 > 208;    || los de pagas extras no entran
          |SI #12#04 > 103;                 || el 101,102 y 103 ya estan calculados
               |HAZ coefi;                   || saca el coeficiente y unidades
               duni1_999 = #12#9;                    || unidades de 'coefi'
               duni2_999 = duni1_999 * dcofi_999;    || halla unidades calculo
               duni2_999 = duni2_999 ! 6;            || redondea
               |SI #12#5 = "E";
                    |HAZ historlinea;
                    |SI FSalida = 0;
                         duni2_999 = #22#11;
                    |FINSI;
               |FINSI;
               graba04 = #12#4;                      || carga concepto
               graba09 = duni1_999;                  || carga unidades
               graba10 = #12#10;
               graba11 = duni2_999;                  || carga unidades calculo
               swgracon = 0;                         || para que no machaque campos
               swcongra = 0;                         || para que no acumule
               |HAZ grabacon;                            || regraba linea calculo
          |SINO;
               concepto = #12#04;
               |HAZ convenio;
          |FINSI;
          |HAZ acu_ctos;
     |FINSI;
|FPRC;

|PROCESO acu_ctos;
    duni2_999 = #12#11;
    dvalo_999 = #12#10;
    product = duni2_999 * dvalo_999;
    product = product ! EURODB;

|SI #12#4]101;|Y #12#4[199;
                    acum_10 =acum_10 +product;
    |SI #10#8 = 1;  acum_11 =acum_11 +product;  |FINSI;
    |SI #10#8 = 2;  acum_12 =acum_12 +product;  |FINSI;
    |SI #10#8 = 3;  acum_13 =acum_13 +product;  |FINSI;
|FINSI;
|SI #12#4]301;|Y #12#4[304;
                    acum_30 =acum_30 +product;
    |SI #10#8 = 1;  acum_301 =acum_301 +product;  |FINSI;
    |SI #10#8 = 2;  acum_302 =acum_302 +product;  |FINSI;
    |SI #10#8 = 3;  acum_303 =acum_303 +product;  |FINSI;
|FINSI;
|SI #12#4]305;|Y #12#4[399;
                    acum_31 =acum_31 +product;
    |SI #10#8 = 1;  acum_311 =acum_311 +product;  |FINSI;
    |SI #10#8 = 2;  acum_312 =acum_312 +product;  |FINSI;
    |SI #10#8 = 3;  acum_313 =acum_313 +product;  |FINSI;
|FINSI;
|SI #12#4]400;|Y #12#4[410;
                    acum_40 =acum_40 +product;
    |SI #10#8 = 1;  acum_401 =acum_401 +product;  |FINSI;
    |SI #10#8 = 2;  acum_402 =acum_402 +product;  |FINSI;
    |SI #10#8 = 3;  acum_403 =acum_403 +product;  |FINSI;
    |SI #10#11 = "S"; |Y #10#12 = 7;
          n400Cot = n400Cot + product;
    |FINSI;
|FINSI;
|SI #12#4]411; |Y #12#4[499;
    |SI #10#8 ! 0;
            acum_41 = acum_41 + product;
    |SINO;
            acum_60 = acum_60 + product;
    |FINSI;
    |SI #10#11 = "S"; |Y #10#12 = 7;
          n400Cot = n400Cot + product;
    |FINSI;
|FINSI;
|SI #12#4]501; |Y #12#4[501;  acum_51 = product;             |FINSI;
|SI #12#4]502; |Y #12#4[502;  acum_52 = product;             |FINSI;
|SI #12#4]505; |Y #12#4[599;  acum_50 = acum_50 + product;   |FINSI;
|SI #12#4=901;                horasex = duni1_999;           |FINSI;
|SI #12#4=906;                antici1 =product;              |FINSI;
|SI #12#4=907;                antici2 =product;              |FINSI;
|SI #12#4=908;                especie =product;              |FINSI;
|SI #12#4=923;                especie = especie + product;   |FINSI;
|SI #12#4=924;                especie = especie + product;   |FINSI;
|SI #12#4=916;                deducss =product;              |FINSI;
|SI #12#4=917;                diastc2 = duni1_999;           |FINSI;
|SI #12#4=918;                horatc2 = duni1_999;           |FINSI;
|SI #12#4=919;
                    acum_10 =acum_10 +product;
    |SI #10#8 = 1;  acum_11 =acum_11 +product;  |FINSI;
    |SI #10#8 = 2;  acum_12 =acum_12 +product;  |FINSI;
    |SI #10#8 = 3;  acum_13 =acum_13 +product;  |FINSI;
|FINSI;
|SI #12#4=991;                pagaf_1 = product;             |FINSI;
|SI #12#4=992;                pagaf_2 = product;             |FINSI;
|SI #12#4=993;                pagaf_3 = product;             |FINSI;
|SI #12#4=994;                pagaf_4 = product;             |FINSI;
|SI #12#4=995;                pagaf_5 = product;             |FINSI;
|SI #12#4=996;                pagaf_6 = product;             |FINSI;
|SI #12#4=997;                pagaf_7 = product;             |FINSI;
|SI #12#4=998;                pagaf_8 = product;             |FINSI;
|FPRC;

|PROCESO cal_998;    || calcula la nomina como si no hubiera existido ILT
|SI #12#04 ] 101; |Y #12#04 [ 199;      || los de pagas extras no entran
        duni1_999 = #12#09;
        duni2_998 = duni1_999 * dcofi_2;
        duni2_998 = duni2_998 ! 6;      || segun dias alta
        dvalo_999 = #12#10;
        |SI #labtraba#42 = "E";
          duni2_998 = 1;
        |FINSI;
        basepro = duni2_998 * dvalo_999;
        basepro = basepro ! EURODB;
        acum_xx = acum_xx + basepro;
|FINSI;
|FPRC;

||****************************************************************************
||        CALCULO DE LOS CONCEPTOS AUTOMATICOS
||****************************************************************************

|PROCESO lee_autom1;
    acu_auto = 0;
    concepto = #39#1;

    #12#0 = #2#0;
    #12#1 = #2#1;
    #12#2 = mes_x;
    #12#3 = 5;

    #12#4 = concepto;
|LEE 000#12=;
|SI FSalida = 0;
    |PARA auto3 = 32; |SI auto3 [ 46; |HACIENDO auto3 = auto3 + 1;
        |SI #39auto3 ! 0;
                auto1 = auto3 - 30;     auto2 = auto3 - 15;
                val_auto = 0;

            |SI #39auto2 ! "C";
                |SI #39auto2 = "U";|O #39auto2 = "I";
                        #12#4 = #39auto3;
                    |LEE 000#12=;
                    |SI FSalida = 0;
                        |SI #39auto2 = "U"; val_auto = #12#9;          |FINSI;
                        |SI #39auto2 = "I"; val_auto = #12#10 * #12#9; |FINSI;
                    |FINSI;
                |SINO;
                    |SI #39auto2 = "P";|O #39auto2 = "E";
                        |SI #39auto3 = 1;    val_auto = nPor1;   |FINSI;
                        |SI #39auto3 = 2;    val_auto = nPor2;   |FINSI;
                        |SI #39auto3 = 3;    val_auto = nPor3;   |FINSI;
                    |FINSI;
                    |SI #39auto2 = "E";
                            val_auto = 100 / (val_auto + 100);
                    |FINSI;
                |FINSI;
            |SINO;
                    val_auto = #39auto3;
            |FINSI;

            |SI #39auto1 = "+";    acu_auto = acu_auto + val_auto;    |FINSI;
            |SI #39auto1 = "-";    acu_auto = acu_auto - val_auto;    |FINSI;
            |SI #39auto1 = "/";    acu_auto = acu_auto / val_auto;    |FINSI;
            |SI #39auto1 = "*";    acu_auto = acu_auto * val_auto;    |FINSI;
            |SI #39auto1 = "%";    acu_auto = acu_auto % val_auto;    |FINSI;
        |FINSI;
    |SIGUE;

        #12#4 = concepto;
    |LEE 000#12=;
    |HAZ coefi;
        graba04 = concepto;
        graba05 = #10#3;
        graba06 = #10#4;
        graba07 = #10#5;
        graba08 = #10#6;
        graba09 = 1;
        graba10 = acu_auto;
        graba11 = graba09 * dcofi_999;
        swgracon = 1;     || para que regrabe campos
        swcongra = 0;     || para que acumule si existe
    |HAZ grabacon;
    |HAZ acu_ctos;
|FINSI;
|FPRC;

|DEFBUCLE lee_autom;
 #39#1;
 ;
 #2#87, 101;
 #2#87, 999;
 ;
 NULL, lee_autom1;
|FIN;

|PROCESO calautom;
|ABRET #12;
|BUCLE lee_autom;
|CIERRAT #12;
|FPRC;

||****************************************************************************
||                        CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO calpror;
|PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
    |HAZ empieza;
    |SI #9diasp ! 0;|O #9porcp ! 0;
        nQueBusca = 1;
        |HAZ busca;
        |HAZ leecon_200;      || lee en convenio el concepto 2xx
        |HAZ cal_cofi;        || calcula el valor del concepto 2xx
                              || /y el calcula coeficiente 2xx
        |HAZ cal_unid;        || calcula las unidades
        |HAZ pro_unid;        || calcula las unidades con tipo 2
        |SI swpro = 1;|Y no_299 = 0;
        |SINO;
                duni1_200 = 0;
                duni2_200 = 0;
               || dvalo_200 = 1;
        |FINSI;
        |HAZ gracal_200;      || graba el concepto 2xx
        |HAZ guarda_per;      || guarda acumulado dias corresp. a paga
    |FINSI;
|SIGUE;
|FPRC;

||****************************************************************************
||                   RUTINAS PARA EL CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO busca;  || BUSCA SI HAY PRORRATA EN LA PAGA ACTUAL Y VA CONTANDO DIAS
     mas = 0;
     rompe = 0;
     |SI #9hasta = #9desde; |Y #9dedia > #9hadia;  rompe = 1;  |FINSI;
     |SI #9hasta < #9desde; |O rompe = 1;
          nume1 = #0#9 - 1;
          des1  = #9desde;   des2 =       1;
          has1  =      12;   has2 = #9hasta;

          |SI nQueBusca = 1;
               || ojo, solo para el calculo de la prorrata a partir del
               || 08/04/2011, tiquet 1485.314. No tiene sentido hacer esto
               || para calcular unidades de paga ya que en este tipo de pagas
               || siempre se han de buscar las unidades del periodo "anterior"
               || es decir que si calculo atrasos de paga del 01/07 al 30/06
               || de 2010 tengo que buscar del 01/07 de 2009 al 30/06 de 2010

               |SI #9desde [ mes_x;     || si ya ha empezado el ejer. actual
                    mas = 1;            || ejemplo: desde=4, hasta=3, actual=4
               |FINSI;                  || empieza a contar en este a¤o !!!
          |FINSI;
     |SINO;
          nume1 = #0#9;
          des1 = #9desde;   des2 =  0;
          has1 = #9hasta;   has2 = -1;
     |FINSI;
    anyo1 = nume1 + mas;
    anyo2 = #0#09 + mas;

    des = (anyo1 * 100) + #9desde;  || mes desde
    has = (anyo2 * 100) + #9hasta;  || mes hasta
    act = (#0#9  * 100) + mes_x;    || mes actual

|SI act ] des; |Y act [ has;  swpro = 1;     |FINSI;

|PARA pp = des1; |SI pp [ has1; |HACIENDO pp = pp + 1;
        anynum = anyo1;  |HAZ busca2;
|SIGUE;
|PARA pp = des2; |SI pp [ has2; |HACIENDO pp = pp + 1;
        anynum = anyo2;  |HAZ busca2;
|SIGUE;

    mesnum = #9hasta;  anynum = nume2;         |HAZ ulti_dia;

|SI #2#42="D";|O #2#42="T";  pepulti=topemes;  |SINO;  pepulti=30;  |FINSI;

|SI #9dedia !       0;  nume6=#9dedia-      1; |SINO;  nume6 = 0;   |FINSI;
|SI #9hadia ! topemes;  nume7=pepulti-#9hadia; |SINO;  nume7 = 0;   |FINSI;

    perio = perio - (nume6 + nume7);
|FPRC;

|PROCESO busca2;
    topemes = 30;           || si es mensual cuenta por 30 los meses
|SI #2#42 = "D";|O #2#42 = "T";
        mesnum = pp;
    |HAZ ulti_dia;
|FINSI;

    perio = perio + topemes;
|FPRC;

|PROCESO leecon_200;      || LEE CONCEPTO 2xx EN CONVENIOS
    #10#0 = #9#0;
    #10#2 = concep0;
|LEE 000#10=;
|SI FSalida ! 0;  |DDEFECTO #10;  |FINSI;
|FPRC;

|PROCESO cal_cofi;
|SI #2tipo_p = "V"; |O #nomcontr#51 = 1;
        concep1 = 51 + paga;      || calcula el 1er. campo de conceptos
        concep2 = concep1 + 32;   || calcula el ultimo campo de concep.
    |PARA campo = concep1; |SI campo [ concep2; |HACIENDO campo=campo+8;
        |SI #9campo ! 0;
                                desc = #9campo;  hasc = #9campo;
            |SI #9campo = 100;  desc = 101;      hasc = 199;     |FINSI;
            |SI #9campo = 400;  desc = 401;      hasc = 420;     |FINSI;
            |PARA actc = desc; |SI actc [ hasc; |HACIENDO actc=actc+1;
                    concepto = actc;    || bucle para los 100 y 400
                |HAZ leeconcep; || lee y acumula conceptos paga
            |SIGUE;
        |FINSI;              || si el concepto no es cero
    |SIGUE;                  || pasa los conceptos
    dvalo_209 = dvalo_209 ! 4;
|SINO;
    |SI #2tipo_p = "B";    || importe bruto
            dvalo_209 = pagaf_9 / 30;
    |FINSI;
    |SI #2tipo_p = "L";    || importe liquido
            dvalo_209 = ((pagaf_9 * 100) / (100 - nPor1)) / 30;
    |FINSI;
        ||dvalo_209 = dvalo_209 ! 2  || valor pagas  comentado por redon. euro
        dvalo_200 = dvalo_209;      || valor prorrata
|FINSI;

|| ***********
|SI mes_x = #9desde;|Y #9dedia !      1;  estevale = 1;  |FINSI;
|SI mes_x = #9hasta;|Y #9hadia ! guarda;  estevale = 1;  |FINSI;

|SI estevale = 1;
    |HAZ recuento;
    |SI #10#4=1;    || dias trabajados
        dcofi_999=(pdia_a-(pdia_b+pdia_c+pdia_d+pdia_e+pdia_f))/pdia_a;
    |FINSI;
    |SI #10#4=2;    || dias cotizados
        dcofi_999=(pdia_a-        pdia_c                      )/pdia_a;
    |FINSI;
|SINO;
    |HAZ diaspaga;
    |SI #10#4=1; dcofi_999=hcofi_1; |FINSI;  || dias trabajados
    |SI #10#4=2; dcofi_999=hcofi_2; |FINSI;  || dias cotizados
|FINSI;
|SI #10#4 = 0;     dcofi_999 = 1;  |FINSI;   || sin descuento
|SI dcofi_999 < 0; dcofi_999 = 0;  |FINSI;

|SI paga = 1;  dcofi_201 = dcofi_999;   |FINSI;  || guarda los coeficientes
|SI paga = 2;  dcofi_202 = dcofi_999;   |FINSI;  ||/de cada paga para usarlos
|SI paga = 3;  dcofi_203 = dcofi_999;   |FINSI;  ||/en pagas que contienen
|SI paga = 4;  dcofi_204 = dcofi_999;   |FINSI;  ||/a su vez pagas
|SI paga = 5;  dcofi_205 = dcofi_999;   |FINSI;
|SI paga = 6;  dcofi_206 = dcofi_999;   |FINSI;
|SI paga = 7;  dcofi_207 = dcofi_999;   |FINSI;
|SI paga = 8;  dcofi_208 = dcofi_999;   |FINSI;
|FPRC;

|PROCESO leeconcep;  || lee y acumula concepto para paga
    doce = concepto;
|HAZ leedoce;
|SI FSalida = 0;
        duni1_999 = #12#09;
        duni2_999 = #12#11;
        dvalo_999 = #12#10;
    |SI #12#05="F";|Y duni1_999=0;|Y concepto!102; || si es calculo 'F' carga
            duni1_999 = 1;                         ||/las unidades con 1 !!!
    |FINSI;
    |SI concepto ] 201;|Y concepto [ 208;
        |SI concepto = 201;  dcofi_209 = dcofi_201;  |FINSI;
        |SI concepto = 202;  dcofi_209 = dcofi_202;  |FINSI; || cogemos las
        |SI concepto = 203;  dcofi_209 = dcofi_203;  |FINSI; ||/unidades
        |SI concepto = 204;  dcofi_209 = dcofi_204;  |FINSI; ||/originales
        |SI concepto = 205;  dcofi_209 = dcofi_205;  |FINSI; ||/para pagas
        |SI concepto = 206;  dcofi_209 = dcofi_206;  |FINSI; ||/que contienen
        |SI concepto = 207;  dcofi_209 = dcofi_207;  |FINSI; ||/pagas
        |SI concepto = 208;  dcofi_209 = dcofi_208;  |FINSI;
            duni1_999 = duni1_999 / dcofi_209;
    |FINSI;
    |HAZ cal_valo;   || va acumulando el valor de los 5
|FINSI;              || si el concepto existe en calculos
|FPRC;

|PROCESO cal_valo;   || CALCULA EL VALOR ACUMULADO DE LOS 5 CONCEPTOS POR PAGA
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|SI #9tipos = "N";   || si es tipo 'N' o 'P'
    |SI #12#05="D";                divide=dia_2;     |FINSI; || dias mes
    |SI #12#05="M";                divide=dia_4;     |FINSI; || dias cotiz.
    |SI #12#05="L";|O #12#05="K";  divide=duni1_999; |FINSI; || dias lab./fes.
    |SI #12#05="V";|O #12#05="F";|O #12#05="A";  divide=   30; |FINSI; ||fijos
    |SI es_irregul = 1;|Y tpz ! 0;
        |DDEFECTO #40;
        |ABRE #40;                 || si se carga con los dias de alta
            #40#0 = #2#87;         ||/se divide por los mismos
            #40#1 = #12#4;
        |LEE 000#40=;
        |SI #40#3 = "S";     divide = tpz;  |FINSI;
        |CIERRA #40;
    |FINSI;
|SINO;
        divide = 100;
|FINSI;

|SI concepto ] 401; |Y concepto [ 420;
    |SI #9#140 = "S";
            dvalo_200 = dvalo_200 + (product / divide);
    |FINSI;
|SINO;
        dvalo_200 = dvalo_200 + (product / divide);
|FINSI;

    dvalo_209 = dvalo_209 + (product / divide);
|FPRC;

|PROCESO cal_unid;   || CALCULA LAS UNIDADES DEL CONCEPTO 2xx
    duni1_200 = (pdia_a * #9diasp * dcofi_999) / perio;
|SI #9tipos = "P";   || pagas porcentuales
        duni1_200 = #9porcp * dcofi_999;
|FINSI;
    duni1_200 = duni1_200 ! 6;  || redondea
    ||dvalo_200 = dvalo_200 ! 2;
    ||dvalo_209 = dvalo_209 ! 2;
|FPRC;

|PROCESO pro_unid;   || CALCULA LAS UNIDADES DEL CONCEPTO 2xx (PARA EL PROMEDIO)
|SI #9tipos = "N";   || si es tipo 'N' o 'P'
        duni3_200 = (dia_4 * #9diasp * dcofi_2) / perio;
|SINO;
        duni3_200 = #9porcp * dcofi_2;
|FINSI;
    duni3_200 = duni3_200 ! 6;  || redondea
|SI swpro ! 1;
        duni3_200 = 0;
|FINSI;
    basepro = duni3_200 * dvalo_200;
    basepro = basepro ! EURODB;
    acum_xx = acum_xx + basepro;
|FPRC;

|PROCESO gracal_200;    || GRABA EL CONCEPTO 2xx;
    swgracon = 1;       || para que grabe todos los campos
    swcongra = 0;       || para que no acumule si existe
    graba04 = concep0;
    graba05 = #10#3;
    graba06 = #10#4;
    graba07 = #10#5;
    graba08 = #10#6;
    graba09 = duni1_200;
    graba10 = dvalo_200;
    graba11 = duni2_200;
|SI duni1_200 ! 0; |O duni2_200 ! 0; |O dvalo_200 ! 0;
    |HAZ grabacon;
        product = dvalo_200 * duni1_200;
    |SI #9mesco = 99;                 || cuando no son pagas 99 no
            product = product ! EURODB;    || redondea para lograr mayor exactitud
    |FINSI;
        dvalo_pro = dvalo_pro + product;    || acumula total prorratas
          |SI #labtraba#0 = 858; |Y #labtraba#1 = 182; |Y mes_x = 2; |Y #0#9 = 2018;
               || martillazo, feo, borrar enseguida 10/2018
             dvalo_pro = 0;
          |FINSI;

        product = dvalo_209 * duni1_200;
        product = product ! EURODB;
        dvalo_pag = dvalo_pag + product;    || acumula total pagas
    |SI paga = 1;   pro_201 = pro_201 + duni1_200;  pra_201 = pra_201 + duni3_200;  |FINSI;
    |SI paga = 2;   pro_202 = pro_202 + duni1_200;  pra_202 = pra_202 + duni3_200;  |FINSI;
    |SI paga = 3;   pro_203 = pro_203 + duni1_200;  pra_203 = pra_203 + duni3_200;  |FINSI;
    |SI paga = 4;   pro_204 = pro_204 + duni1_200;  pra_204 = pra_204 + duni3_200;  |FINSI;
    |SI paga = 5;   pro_205 = pro_205 + duni1_200;  pra_205 = pra_205 + duni3_200;  |FINSI;
    |SI paga = 6;   pro_206 = pro_206 + duni1_200;  pra_206 = pra_206 + duni3_200;  |FINSI;
    |SI paga = 7;   pro_207 = pro_207 + duni1_200;  pra_207 = pra_207 + duni3_200;  |FINSI;
    |SI paga = 8;   pro_208 = pro_208 + duni1_200;  pra_208 = pra_208 + duni3_200;  |FINSI;
|FINSI;
|FPRC;

|PROCESO guarda_per;      || PARA NO CALCULARLOS DESPUES EN PAGAS
|SI paga = 1;  perio1 = perio;  dvalo_201 = dvalo_209; |FINSI;
|SI paga = 2;  perio2 = perio;  dvalo_202 = dvalo_209; |FINSI;
|SI paga = 3;  perio3 = perio;  dvalo_203 = dvalo_209; |FINSI;
|SI paga = 4;  perio4 = perio;  dvalo_204 = dvalo_209; |FINSI;
|SI paga = 5;  perio5 = perio;  dvalo_205 = dvalo_209; |FINSI;
|SI paga = 6;  perio6 = perio;  dvalo_206 = dvalo_209; |FINSI;
|SI paga = 7;  perio7 = perio;  dvalo_207 = dvalo_209; |FINSI;
|SI paga = 8;  perio8 = perio;  dvalo_208 = dvalo_209; |FINSI;
|FPRC;

||****************************************************************************
||                        CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO calpaga;
    acum1_200 = 0;
    acum2_200 = 0;
|PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
    |HAZ empieza;             || inicializa
    nQueBusca = 2;
    |HAZ busca;               || para saber si las diferidas se prorratean
    |SI #9diasp ! 0;|O #9porcp ! 0;
        |HAZ confec_1;                  || calcula pagas
    |FINSI;
|SIGUE;
|FPRC;

||****************************************************************************
||                 RUTINAS PARA EL CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO calcula_acumu;
    nom_paga = Usuario;  |QBT nom_paga;
|NOME_DAT #50 nom_paga;
|DELINDEX #50;

    el_mes = mes_x - 1;
    el_any = #0#9;
|SI el_mes = 0;  el_mes = 12;   el_any = el_any - 1;     |FINSI;

    g_con = #9#0;
    g_emp = #2#0;
    g_tra = #2#1;
|CIERRA #9;
|CIERRAT #2;
|SUB_EJECUTA "nompagat";

|ABRE #9;
    #9#0 = g_con;
|LEE 020#9=;

|ABRE #2;
    #2#0 = g_emp;
    #2#1 = g_tra;
|LEE 020#2=;

|SI paga = 1;    puntero = 55;  |FINSI;
|SI paga = 2;    puntero = 56;  |FINSI;
|SI paga = 3;    puntero = 57;  |FINSI;
|SI paga = 4;    puntero = 58;  |FINSI;
|SI paga = 5;    puntero = 59;  |FINSI;
|SI paga = 6;    puntero = 81;  |FINSI;
|SI paga = 7;    puntero = 82;  |FINSI;
|SI paga = 8;    puntero = 83;  |FINSI;

|NOME_DAT #50 nom_paga;
|ABRE #50;
    #50#31 = #2#31;
    #50#0 = #2#0;
    #50#1 = #2#1;
|LEE 020#50=;
|CIERRA #50;

|SI swpro = 0;
    #22#11 = (#50puntero / perio) * #9diasp;
|SINO;
    #22#11 = ((#50puntero + (pdia_a * dcofi_999)) / perio) * #9diasp;
|FINSI;

|DELINDEX #50;
|FPRC;

|PROCESO confec_1;
     |HAZ cargavar;           || carga vars. y calcula coeficientes
     |HAZ leecal_200;         || lee el concepto paga
     |HAZ historlinea;        || lee unidades calculo desde el historico
     |SI #nomconca#163 = "P"; |Y #9mesco ! 99;
          || a ver, hasta ahora si por ejemplo en una paga prorrateada del 1 al 6
          || que se paga en el mes 6 yo calculaba atrasos del 1 al 6 me la pagaba
          || entera, pero es que si calculo del 5 al 6 o del 6 al 6 tambien

          || en el tiquet 000135.02305 Asefeco nos pide que LO HAGAMOS PROPORCIONALMENTE
          || a los atrasos que calculamos, es decir que si calculo atrasos del 5 al 6
          || me calcula la proporcion de paga de dos meses y no mas, para hacer eso
          || lo hacemos yendonos al historico y comprobando las prorratas de cada
          || mes que tenemos en el historico.

          || en pagas prorrateadas NO hay que hacerlo ya que lo hacia bien
          || pagando siempre solo la parte del mes, como es logico

          |HAZ histor_especial;
     |FINSI;

     || esto lo pongo porque si lo dejo como estaba,  en los casos
     || de que la paga sea por ej. prorr 01/07-30/06, que se paga en el mes 7
     || me pagaba la paga en atrasos en el mes 7 porque se creia que tenia que
     || pagarme por EMPEZAR en el mes 7, pero esa paga es la que venia de periodo
     || anterior, con lo cual no se tenia que pagar (26.01.2004 ticket 2775.69)

     |SI mas = 1;   || por lo explicado antes, no tiene que seguir
          aFecha1 = #nomhicca#4 % -108;
          aFecha1 = "01" + aFecha1;
          fFecha1 = #nomhicca#4;

          alfa1 = mes_x; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
          alfa2 = #0#9;
          aAlfa = "01" + "." + alfa1 + "." + alfa2;
          fFecha2 = aAlfa;

          |SI #9mesco ! 99;             || EN PAGAS PRORRATEADAS ESTO NO TIENE VALIDEZ
               |SI fFecha1 ] fFecha2;   || el mes que voy a comprobar viene del a¤o pasa-
                    |ACABA;             || do y ademas el trabajador no estaba de alta ese
               |FINSI;                  || mes, con lo que no le corresponde cobrar
          |FINSI;
     |FINSI;
     |SI #9mesco = mes_x;|O #9mesco = 99;|O swbaja = 1;
          || este proceso se hace para que si el trabajador no tiene
          || historico, se calculen los dias segun la prorrata y las
          || fechas de alta y baja del trabajador

          |SI Fhistorlinea ! 0;
               |SI #nomconca#163 = "P"; |Y #9mesco ! 99; |Y #22#11 ! 0;
                    || si no tengo nada en el historico, y tengo puesto que la
                    || paga sea proporcional a los meses que se calculen atrasos,
                    || ya me vendran las unidades calculadas en el #22#11
                    || (nUnidPaga)
               |SINO;
                    || si no es proporcional, tendre que hacer esta antigua movida
                    || para hacer el calculo de las unidades

                    |SI swbaja = 0;|O #2#48 = "S";  || si es baja y no tiene finiquito
                         |HAZ calcula_acumu;         ||/no calcula paga
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #22#11 ! 0;
          |Y #22#10 ! 0; || resulta que si estoy de IT el periodo completo
                         || de devengo de la paga, EN PAGAS DIFERIDAS
                         || al calcular el mes de paga
                         || me ponia unid. CERO, importe CERO, unid. calc. 30
                         || eso hace que al calcular atrasos pasa como si cobrara
                         || la paga entera, porque ahi si que me pone importe
                         || pongo esto de #22#10 ! 0 para que si esta a cero
                         || unid. calculo o importe, no haga nada
                         || 4333.1721 - 19/10/2017
                         || arreglado tambien en la nomina
               |HAZ confec_2;
               |HAZ grapaga;     || regraba/graba el concepto de paga
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||                 SUBRUTINAS DEL CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO cargavar;
|SI paga = 1; perio = perio1; dvalo_209 = dvalo_201; |FINSI;
|SI paga = 2; perio = perio2; dvalo_209 = dvalo_202; |FINSI;
|SI paga = 3; perio = perio3; dvalo_209 = dvalo_203; |FINSI;
|SI paga = 4; perio = perio4; dvalo_209 = dvalo_204; |FINSI;
|SI paga = 5; perio = perio5; dvalo_209 = dvalo_205; |FINSI;
|SI paga = 6; perio = perio6; dvalo_209 = dvalo_206; |FINSI;
|SI paga = 7; perio = perio7; dvalo_209 = dvalo_207; |FINSI;
|SI paga = 8; perio = perio8; dvalo_209 = dvalo_208; |FINSI;

dvalo_209 = dvalo_209 ! 4;

|SI mes_x = #9desde;|Y #9dedia !      1;  estevale = 1;  |FINSI;
|SI mes_x = #9hasta;|Y #9hadia ! guarda;  estevale = 1;  |FINSI;

|SI estevale = 1;
    |HAZ recuento;
        pcofi_1 = (pdia_0-(pdia_1+pdia_2+pdia_3+pdia_4))/pdia_0;
        pcofi_2 = (pdia_0-        pdia_2               )/pdia_0;
        pcofi_3 = (pdia_0-(       pdia_2+pdia_3+pdia_4))/pdia_0;
        pcofi_4 = (pdia_0-(pdia_1+pdia_2       +pdia_4))/pdia_0;
|SINO;
        pcofi_1 = hcofi_1;
        pcofi_2 = hcofi_2;
        pcofi_3 = hcofi_3;
        pcofi_4 = hcofi_4;
    |HAZ diaspaga;
|FINSI;
|SI #1#26="S";|Y #1#27="S"; dcofi_999=pcofi_1; |FINSI;  || calcula coefic.
|SI #1#26="N";|Y #1#27="N"; dcofi_999=pcofi_2; |FINSI;  || para pagas 99
|SI #1#26="N";|Y #1#27="S"; dcofi_999=pcofi_3; |FINSI;  || y porcentuales
|SI #1#26="S";|Y #1#27="N"; dcofi_999=pcofi_4; |FINSI;
|FPRC;

|PROCESO leecal_200;    || LEE CONCEPTO DE LINEAS DE CALCULOS CORREP. A PAGA
    doce = concep0;
|HAZ leedoce;
|SI FSalida ! 0;         || si no esta en calculos, lee convenio
        #10#0 = #9#0;
        #10#2 = concep0;
    |LEE 000#10=;
    |SI FSalida ! 0;
        |DDEFECTO #10;
    |FINSI;
        #12#05 = #10#3;   || carga calculo alfa de convenios
        #12#06 = #10#4;   || carga calculo nume de convenios
        #12#07 = #10#5;   || carga situacion de convenios
        #12#08 = #10#6;   || carga descripcion de convenios
        #12#09 = 0;
        #12#10 = 0;
        #12#11 = 0;
|FINSI;
    duni1_999 = #12#09;
    duni2_999 = #12#11;
    dvalo_999 = #12#10;
|FPRC;

|PROCESO confec_2;
|SI #9tipos = "P";       || si es porcentual
    |SI es_irregul = 0;
            duni2_999 = #9porcp * dcofi_999;
    |SINO;
            duni2_999 = duni1_999;
    |FINSI;
|SINO;
    |HAZ confec_3;       || si es normal intenta desde el historico
|FINSI;

    duni2_999 = (duni2_999*dvalo_209)/dvalo_999;  || ajusta a paga completa
    duni2_999 = duni2_999 ! 6;                    || redondea

    product = duni2_999 * dvalo_999;
    product = product ! EURODB;

    acum1_200 = acum1_200 + product;
|FPRC;

|PROCESO acum_unid_paga;
     |PARA nMesBusca = nDesdeMes; |SI nMesBusca [ nHastaMes; |HACIENDO nMesBusca = nMesBusca + 1;
          swEncontrado = 0;

          #22#0 = #2#0;   || empresa
          #22#1 = #2#1;   || trabajador
          #22#2 = nMesBusca;  || mes
          |SI #12#4 ] 201;|Y #12#4 [ 208;|Y swbaja = 1; |Y swPagaPropProrr = 0;
               |SI #1#39 ! "1"; |Y #2#48 = "S";
                    #22#3 = 2;   || tipo para pagas de finiquito aparte
               |SINO;
                    #22#3 = 0;   || tipo para pagas de finiquito junto
               |FINSI;
          |SINO;
               #22#3 = 0;       || tipo para resto
          |FINSI;

          #22#12 = nAnyPaga; || anyo
          #22#4 = #12#4;  || concepto
          |LEE 000#22=;
          |SI FSalida = 0;
               swEncontrado = 1;
               nUnidPaga = nUnidPaga + #22#9;
          |SINO;
               || pues no lo encuentro con este tipo, nada, buscare el otro
               |SI #22#3 = 0;       || tipo para resto
                    #22#3 = 2;
               |SINO;
                    #22#3 = 0;
               |FINSI;
               |LEE 000#22=;
               |SI FSalida = 0;
                    swEncontrado = 1;
                    nUnidPaga = nUnidPaga + #22#9;
               |FINSI;
          |FINSI;

          |SI swEncontrado = 1;
               || ahora voy a comprobar si de este mes voy a calcular despues
               || la nomina de atraso, porque si no es asi, tengo que a¤adir
               || estas unidades para ue se prorrateen si despues llego a
               || cobrar esta paga

               nNume = #0#9;
               nNume = nNume - 2000;
               |SI nNume ! nAnyPaga;
                    nRestoProrr = nRestoProrr + #22#9;
               |SINO;
                    |SI #0#8 [ nMesBusca; |Y nMesBusca [ #0#10;
                         || esta cotizada esta prorrata
                    |SINO;
                         || esta no, seguro
                         nRestoProrr = nRestoProrr + #22#9;
                    |FINSI;
               |FINSI;
          |FINSI;

          || aqui habia una paranoia por si el trabajador no tenia la nomina
          || calculada, que se calcularan las unidades si estaba de alta
          || pero he pasado, si te hace falta copiatela del acum_paga_esp
          || que es de donde me he copiado esto
     |SIGUE;
|FPRC;

|PROCESO unid_histo;
     |ABRE #22;
     |DDEFECTO #22;
     nUnidPaga = 0;
     nRestoProrr = 0;

     |SI #nomconca#desde# < #nomconca#hasta#;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = #nomconca#hasta#;
          nAnyPaga = #0#9 - 2000;

          |HAZ acum_unid_paga;
     |SINO;
          nDesdeMes = #nomconca#desde#;
          nHastaMes = 12;
          nAnyPaga = #0#9 - 2000 - 1;

          |HAZ acum_unid_paga;

          nDesdeMes = 1;
          nHastaMes = #nomconca#hasta#;
          nAnyPaga = #0#9 - 2000;

          |HAZ acum_unid_paga;
     |FINSI;

     |CIERRA #22;
|FPRC;

|PROCESO confec_3;
     duni2_999 = #22#11;        || desde historico (si existe)
                    || se comento por problemas con atrasos en maternidad
                    || ahora lo dajo como estaba, por valiente
     |SI paga = 1;   pag_201 = pag_201 + duni2_999;  |FINSI;
     |SI paga = 2;   pag_202 = pag_202 + duni2_999;  |FINSI;
     |SI paga = 3;   pag_203 = pag_203 + duni2_999;  |FINSI;
     |SI paga = 4;   pag_204 = pag_204 + duni2_999;  |FINSI;
     |SI paga = 5;   pag_205 = pag_205 + duni2_999;  |FINSI;
     |SI paga = 6;   pag_206 = pag_206 + duni2_999;  |FINSI;
     |SI paga = 7;   pag_207 = pag_207 + duni2_999;  |FINSI;
     |SI paga = 8;   pag_208 = pag_208 + duni2_999;  |FINSI;

     |SI #9mesco = mes_x;
          |SI paga = 1;   pro_299 = pro_201;   pag_299 = pag_201;   pra_299 = pra_201;  |FINSI;
          |SI paga = 2;   pro_299 = pro_202;   pag_299 = pag_202;   pra_299 = pra_202;  |FINSI;
          |SI paga = 3;   pro_299 = pro_203;   pag_299 = pag_203;   pra_299 = pra_203;  |FINSI;
          |SI paga = 4;   pro_299 = pro_204;   pag_299 = pag_204;   pra_299 = pra_204;  |FINSI;
          |SI paga = 5;   pro_299 = pro_205;   pag_299 = pag_205;   pra_299 = pra_205;  |FINSI;
          |SI paga = 6;   pro_299 = pro_206;   pag_299 = pag_206;   pra_299 = pra_206;  |FINSI;
          |SI paga = 7;   pro_299 = pro_207;   pag_299 = pag_207;   pra_299 = pra_207;  |FINSI;
          |SI paga = 8;   pro_299 = pro_208;   pag_299 = pag_208;   pra_299 = pra_208;  |FINSI;

          || duni2_999 = pro_299;      || para que coja el total calculado hasta
          || NO SE CAMBIA              || el mes de pago de la paga
          product = duni1_999 * dvalo_999;  product = product ! EURODB;
          dvalo_pro = dvalo_pro - product;     || resta valor anterior

          |SI swpro = 0;|Y #9mesco ! #9hasta;  || no se prorratea y es diferida
               || duni1_999 deberia ser cero, ya que no se prorratea
               || duni2_999 = (pro_299 ! 5);

               || antes teniamos esto pero a raiz del tiquet 3923.461 nos damos cuenta
               || de que no hay motivo para que porque una paga sea diferida no haya
               || prorrata y no se calcule entera si asi se ha puesto en el control
               || de la aplicacion, lo cambio 29.04.2011

               |SI #nomconca#163 = "P"; |Y #9mesco ! 99;
                    duni2_999 = (pro_299 ! 5);
                    duni1_999 = duni1_999 + (pag_299 - pro_299);    || dias totales
               |SINO;
                    || en las pagas diferidas siempre se guardan 30 unidades
                    || asi que si digo que la cobre completa, la va a cobrar
                    || toda, aunque no este de alta todo el periodo del prorra-
                    || teo de la paga, esto no es correcto, recalculo segun
                    || lo que haya en el historico:
                    || tiquet 98.4258

                    |HAZ unid_histo;
                    duni2_999 = nUnidPaga;
                    pag_299 = nUnidPaga;

                    || duni1_999 = duni1_999 + (pag_299 - pro_299);    || dias totales
                    duni1_999 = duni1_999 + nRestoProrr;
               |FINSI;
          |SINO;
               |SI #9mesco ! #9hasta;
                    || diferidas
                    duni1_999 = duni1_999 + (pag_299 - pra_299);    || dias totales
                    duni2_999 = duni2_999 - (pra_299 - pro_299);
               |SINO;
                    |HAZ mensu_especial;
                    || normales
                    duni1_999 = duni1_999 + (pag_299 - pro_299);    || dias totales
                    |SI dcofi_1 = 0;
                         duni1_999 = 0;      || cero dias en alta, no cotizo nada
                    |FINSI;                  || 15.01.2004
                    || comentado por problemas con atrasos en maternidad
                    || descomentado porque da mas problemas cambiarlo
               |FINSI;
          |FINSI;

          product = duni1_999 * dvalo_999;  product = product ! EURODB;
          dvalo_pro = dvalo_pro + product;     || acumula nuevo valor
/*
          || A ver, novedad 2012, tiquet 1624.1389
          || hasta ahora si yo calculaba atrasos por ejemplo del mes 01 al 09
          || y tenia una paga que se prorrateaba desde el 01/07 del a¤o pasado
          || hasta el 30/06 de este a¤o y se pagaba en junio, los meses de julio,
          || agosto y septiembre NO se prorrateaba esa paga, para eso se usaba esto

          || a raiz de este tiquet de atrasos de Asecor, se llega a la conclusion
          || de que SI que hay que prorratear siempre, la explicacion era que
          || si yo he cobrado la paga en estos atrasos, ya no tengo que prorra-
          || tear mas, que eso ya vendria en los atrasos del a¤o que viene

          || pero Rafa me cuenta que eso no es asi, que si yo he generado atrasos
          || que vienen de un mes en el que hubo prorrata en el mes, pues tendre
          || que cotizar en atrasos por la diferencia que se genera en esa prorrata
          || que cotice en el mes

          || en conclusion quito este switch que se usaba justamente para eso

          |SI paga = 1;   no_201 = 1;  |FINSI;
          |SI paga = 2;   no_202 = 1;  |FINSI;
          |SI paga = 3;   no_203 = 1;  |FINSI;
          |SI paga = 4;   no_204 = 1;  |FINSI;     || switch para cortar la paga
          |SI paga = 5;   no_205 = 1;  |FINSI;
          |SI paga = 6;   no_206 = 1;  |FINSI;
          |SI paga = 7;   no_207 = 1;  |FINSI;
          |SI paga = 8;   no_208 = 1;  |FINSI;
*/
     |FINSI;
|FPRC;

|PROCESO GrabaAjusteProrrata;
     |SI #9mesco = 99;   || en pagas prorrateadas no, por supuesto
          |ACABA;
     |FINSI;

     swcongra = 0;       || para que no acumule si existe
     swgracon = 1;       || para que regrabe
     graba04 = concep0 + 50;
     graba05 = "P";
     graba06 = 0;
     graba07 = 0;
     graba08 = "AJU.PROR";
     duni1_999 = nAcumProrr * (-1);
     duni2_999 = 0;
     ||dvalo_999 = dvalo_999 ! 2 comentado por redon. euro
     graba09 = duni1_999;
     graba10 = nPrecioProrr;
     graba11 = 0;
     |SI duni1_999 ! 0; |O duni2_999 ! 0; |O dvalo_999 ! 0;
          |HAZ grabacon;
     |FINSI;
     dvalo_pro = dvalo_pro + (duni1_999 * nPrecioProrr);
|FPRC;

|PROCESO grapaga;        || REGRABA LA PAGA
     swcongra = 0;        || para que no acumule si existe
     swgracon = 1;        || para que regrabe
     graba04 = concep0;
     graba05 = "P";
     graba06 = 0;
     graba07 = #12#7;
     graba08 = #12#8;
     duni1_999 = duni1_999 ! 6;
     duni2_999 = duni2_999 ! 6;
     ||dvalo_999 = dvalo_999 ! 2 comentado por redon. euro
     graba09 = duni1_999;
     graba10 = dvalo_999;
     graba11 = duni2_999;
     |SI duni1_999 ! 0; |O duni2_999 ! 0; |O dvalo_999 ! 0;
          |HAZ grabacon;
     |FINSI;

     |SI nAcumProrr > 0; |Y nPrecioProrr > 0;
          |HAZ GrabaAjusteProrrata;
     |FINSI;
|FPRC;

||****************************************************************************
||              RUTINAS COMUNES A PRORRATAS Y PAGAS
||****************************************************************************

|PROCESO recuento;
    de1 = 0;  ha1 = -1;  de2 = 0;  ha2 = -1;
|SI mes_x = #9desde;     de1 = #9dedia;  ha1 =  guarda;  |FINSI;
|SI mes_x = #9hasta;     de1 =       1;  ha1 = #9hadia;  |FINSI;
|SI #9desde = #9hasta;|Y #9dedia [ #9hadia;
        de1 = #9dedia;  ha1 = #9hadia;
|FINSI;
|SI #9desde = #9hasta;|Y #9dedia > #9hadia;
        de1 = #9dedia;  ha1 =  guarda;
        de2 =       1;  ha2 = #9hadia;
|FINSI;
|PARA mid = de1; |SI mid [ ha1; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_a = pdia_a + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_b = pdia_b + 1;  |FINSI;  || enf.
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_c = pdia_c + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_d = pdia_d + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_e = pdia_e + 1;  |FINSI;  || abs.
    |SI alfa1 = "M";                 pdia_f = pdia_f + 1;  |FINSI;  || mat.
    |SI alfa1 = "P";                 pdia_f = pdia_f + 1;  |FINSI;  || pat.
    |SI alfa1 = "R";                 pdia_f = pdia_f + 1;  |FINSI;  || rie.
    |SI alfa1 = "O";                 pdia_f = pdia_f + 1;  |FINSI;  || otr.
|SIGUE;
|PARA mid = de2; |SI mid [ ha2; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_0 = pdia_0 + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_1 = pdia_1 + 1;  |FINSI;  || enf.
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_2 = pdia_2 + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_3 = pdia_3 + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_4 = pdia_4 + 1;  |FINSI;  || abs.
    |SI alfa1 = "M";                 pdia_6 = pdia_6 + 1;  |FINSI;  || mat.
    |SI alfa1 = "P";                 pdia_6 = pdia_6 + 1;  |FINSI;  || pat.
    |SI alfa1 = "R";                 pdia_6 = pdia_6 + 1;  |FINSI;  || rie.
    |SI alfa1 = "O";                 pdia_6 = pdia_6 + 1;  |FINSI;  || otr.
|SIGUE;

    pdia_a = pdia_a + pdia_0;   || letras --> prorrata (contienen los de paga)
    pdia_b = pdia_b + pdia_1;   || numeros -> paga
    pdia_c = pdia_c + pdia_2;
    pdia_d = pdia_d + pdia_3;
    pdia_e = pdia_e + pdia_4;
    pdia_f = pdia_f + pdia_6;

|SI ha2 = -1;            || si la paga va en meses completos |O
    |O swpaga = 1;       || si es finiquito |O
    |O #9mesco = 99;     || si es paga de confeccion 99:
        pdia_0 = pdia_a;
        pdia_1 = pdia_b;
        pdia_2 = pdia_c; || se paga lo mismo que se prorratea!
        pdia_3 = pdia_d;
        pdia_4 = pdia_e;
        pdia_6 = pdia_f;
|FINSI;
|FPRC;

|PROCESO empieza;         || SACA LAS VARIABLES DEL CONVENIO SEGUN PAGA
    duni1_999 = 0;
    duni2_999 = 0;
    dvalo_999 = 0;
    dvalo_200 = 0;
    dvalo_209 = 0;
    duni1_200 = 0;
    duni2_200 = 0;
    dias_dto = 0;
    swpro = 0;
    perio = 0;
    pdia_0 = 0; pdia_1 = 0; pdia_2 = 0; pdia_3 = 0; pdia_4 = 0; pdia_6 = 0;
    pdia_a = 0; pdia_b = 0; pdia_c = 0; pdia_d = 0; pdia_e = 0; pdia_f = 0;
    estevale = 0;
    dedia = paga + 107;    || desde dia prorrata
    hadia = paga + 115;    || hasta dia prorrata
    desde = paga + 3;      || desde mes prorrata
    hasta = paga + 11;     || hasta mes prorrata
    tipos = paga + 27;     || tipo de calculo
    diasp = paga + 35;     || dias
    porcp = paga + 43;     || porcentaje
    concep0 = paga + 200;  || concepto de paga
    mesco = paga + 19;     || mes confeccion
    tipo_p = paga + 156;   || tipo ajuste paga (trabajador)
    ajus_p = paga + 164;   || importe ajuste paga (trabajador)
    pror_p = paga + 112;   || prorrateo paga S/N (trabajador)
     swPagaPropProrr = 0;
    |SI #labtraba#pror_p# = "S";
         |SI #9mesco ! 99; |Y #nomconca#163 = "P";
               || si el convenio tiene las pagas "sin prorratear", y estan
               || prorrateadas por trabajador, tenemos un problema si queremos
               || que se paguen proporcionalmente al perdiodo que estamos calculando,
               || pues iriamos a buscarlas al historico Y SI EN SU MOMENTO
               || tambien se calcularon prorrateadas no hay problema, pero si
               || se calcularon sin prorratear y se le puso al trabajador
               || que eran prorrateadas tras calcular las nominas, cogeria las
               || unidades que haya en el historico, que son por ejemplo la
               || paga completa.

               || para solucionar esto, simplemente trato la paga como "no
               || prorrateada" y luego se encargara el calculo de poner
               || las unidades correspondientes al periodo que se esta calcu-
               || lando con lo de la "P", aunque no se hara prorrateando
               || las unidades mes a mes, sino pagando en el ultimo mes,
               || pero eso si, la parte que le toca.

               || tiquet 001624.02159

               swPagaPropProrr = 1;
         |SINO;
              #9mesco = 99;
         |FINSI;
    |FINSI;
|SI paga = 1;  no_299 = no_201;    pagaf_9 = pagaf_1;  |FINSI;
|SI paga = 2;  no_299 = no_202;    pagaf_9 = pagaf_2;  |FINSI;
|SI paga = 3;  no_299 = no_203;    pagaf_9 = pagaf_3;  |FINSI;
|SI paga = 4;  no_299 = no_204;    pagaf_9 = pagaf_4;  |FINSI;
|SI paga = 5;  no_299 = no_205;    pagaf_9 = pagaf_5;  |FINSI;
|SI paga = 6;  no_299 = no_206;    pagaf_9 = pagaf_6;  |FINSI;
|SI paga = 7;  no_299 = no_207;    pagaf_9 = pagaf_7;  |FINSI;
|SI paga = 8;  no_299 = no_208;    pagaf_9 = pagaf_8;  |FINSI;

|SI #9mesco < #9hasta;|Y anyo_actual = "S";
                              || pagas diferidas de devengo en a¤o posterior
                              ||/al de prorrateo (ejemplo, 1-12/3):
                              || solamente se confeccionan cuando el a¤o de
        #9mesco = #9hasta;    ||/calculo ya esta actualizado completamente
|FINSI;
|FPRC;

|PROCESO diaspaga;
|SI es_irregul = 1;|Y tpz ! 0;
        pdia_0 = tpz;
|SINO;
        pdia_0 = hdias_0;
|FINSI;
                                                pdia_a = pdia_0;
    pdia_1 = denfe_2+dmate_2;                   pdia_b = pdia_1;
    pdia_2 = dalta_2+dbaja_2+dhuel_2+ddese_2;   pdia_c = pdia_2;
    pdia_3 = dacci_2;                           pdia_d = pdia_3;
    pdia_4 = dabse_2;                           pdia_e = pdia_4;
    pdia_6 = dmate_2;                           pdia_f = pdia_6;
|FPRC;

|PROCESO topes;
     prom_enf_gua = prom_enf;
     prom_acc_gua = prom_acc;

     nume1 = #2#33 + 35;
     maximo = #15nume1;   || c.comunes

     nume3 = #21#35 + prom_enf;
     |SI nume3 > maximo;
          prom_enf = maximo - #21#35;
          |SI prom_enf < 0;   prom_enf = 0;       |FINSI;
     |FINSI;

     maximo = #15#20;      || c.profesionales
     nume3 = #21#36 + prom_acc;
     |SI nume3 > maximo;
          prom_acc = maximo - #21#36;
          |SI prom_acc < 0;   prom_acc = 0;       |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||        CALCULO DE LA ENFERMEDAD (503), ACCID. (504)
||****************************************************************************

|PROCESO anticomp;    || CALCULA EL ANTI-COMPLEMENTO
     |SI denfe_2 ! 0; |O dmate_2 ! 0; |O dacci_2 ! 0;
          dtodo_3 = anticom - (acum_53 + acum_54 + denfe_4);
          |SI dtodo_3 < 0;     dtodo_3 = 0;   |FINSI;
     |FINSI;
|FPRC;

|PROCESO CompComIT;
     nDiasDescEnf = 0;
     nDiasDescAcc = 0;
     nDiasDescMat = 0;
     nDescEnf_A = 0;
     nDescEnf_B = 0;
     nDescEnf_C = 0;
     nDescEnf_D = 0;
     |SI mes_x = #0#8;
          || esta variable es para indicar que en este trabajador, durante el
          || periodo de calculo ha habido una enf que termina y empieza una
          || mat, para no cotizar por mat si no se ha hecho por enf
          || la inicio en cada trabajador el primer mes de calculo
          swEnfMatPer = 0;
     |FINSI;
     |PARA nBaja = 27; |SI nBaja [ 30; |Y #0#79 ! "N";
     |HACIENDO nBaja = nBaja + 1;
          aTipoIT = #nomhicca#nBaja#;
          |SI aTipoIT = "C"; |O aTipoIT = "P"; |O aTipoIT = "R";
               aTipoIT = "M";
          |FINSI;
          |SI aTipoIT = "E"; |O aTipoIT = "A"; |O aTipoIT = "M";
               nume1 = nBaja - 8;  || dia desde baja
               nume2 = nBaja - 4;  || dia hasta baja
               nInicioBaja = #nomhicca#nume1#;
               nFinBaja = #nomhicca#nume2#;
               |SI nFinBaja = 0;
                    mesnum = mes_x;
                    anynum = #0#9;
                    |HAZ ulti_dia;
                    nFinBaja = topemes;
               |FINSI;
               swSigue = 0;
               |SI nInicioBaja = 0;
                    swSigue = 1;
               |SINO;
                    |SI mes_x = #0#8; |Y nDiasDescEnf = 0;
                         swSigue = 2;
                         nDiasDescEnf = -1;
                         nDiasDescAcc = -1;
                         nDiasDescMat = -1;
                    |FINSI;
                    |SI nDiasDescEnf ! 0;         || ya hay dias de enf. este mes
                    |Y aTipoIT = "M";    || es una maternidad ademas
                         nDiasDescMat = nFinBaja - nInicioBaja + 1;

                         swEnfMatPer = 1; || la variable me servira en los demas
                                          || meses de maternidad si continua
                         |SI mes_x = #0#8;             || mes en que empiezo a calcular
                              swSigue = 2;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    alfa1 = "01";
                    alfa2 = mes_x; alfa2 = ("00" + alfa2) % -102;
                    alfa3 = #0#9;
                    aFechaIni = alfa1 + "." + alfa2 + "." + alfa3;
                    fFechaIni = aFechaIni;   || primer dia del mes que calculo
                    nFecha = fFechaIni;
                    |SI aTipoIT = "E"; |O aTipoIT = "M";
                         nDiasAcumIT = #nomhicca#70;
                    |SINO;
                         nDiasAcumIT = #nomhicca#73;
                    |FINSI;
                    nFecha = nFecha - nDiasAcumIT;
                    fFecha = nFecha;
                    aFechaIni = fFecha;      || fecha inicial de la IT
                    alfa2 = aFechaIni % 402;
                    alfa3 = aFechaIni % -104;
                    nume2 = alfa2;
                    nume3 = alfa3;
                    |SI nume3 < #0#9;
                         swSigue = 2;
                    |FINSI;
                    |SI nume3 = #0#9; |Y nume2 [ #0#8;
                         swSigue = 2;
                    |FINSI;
                    |SI aTipoIT = "E"; |Y swSigue = 2;
                         |SI nBaja = 27;
                              nDescEnf_A = nDescEnf_A + denfe_A1;
                              nDescEnf_B = nDescEnf_B + denfe_B1;
                              nDescEnf_C = nDescEnf_C + denfe_C1;
                              nDescEnf_D = nDescEnf_D + denfe_D1;
                              nDiasDescEnf = nDiasDescEnf + denfe_A1 + denfe_B1 + denfe_C1 + denfe_D1;
                         |FINSI;
                         |SI nBaja = 28;
                              nDescEnf_A = nDescEnf_A + denfe_A2;
                              nDescEnf_B = nDescEnf_B + denfe_B2;
                              nDescEnf_C = nDescEnf_C + denfe_C2;
                              nDescEnf_D = nDescEnf_D + denfe_D2;
                              nDiasDescEnf = nDiasDescEnf + denfe_A2 + denfe_B2 + denfe_C2 + denfe_D2;
                         |FINSI;
                         |SI nBaja = 29;
                              nDescEnf_A = nDescEnf_A + denfe_A3;
                              nDescEnf_B = nDescEnf_B + denfe_B3;
                              nDescEnf_C = nDescEnf_C + denfe_C3;
                              nDescEnf_D = nDescEnf_D + denfe_D3;
                              nDiasDescEnf = nDiasDescEnf + denfe_A3 + denfe_B3 + denfe_C3 + denfe_D3;
                         |FINSI;
                         |SI nBaja = 30;
                              nDescEnf_A = nDescEnf_A + denfe_A4;
                              nDescEnf_B = nDescEnf_B + denfe_B4;
                              nDescEnf_C = nDescEnf_C + denfe_C4;
                              nDescEnf_D = nDescEnf_D + denfe_D4;
                              nDiasDescEnf = nDiasDescEnf + denfe_A4 + denfe_B4 + denfe_C4 + denfe_D4;
                         |FINSI;
                    |FINSI;
                    |SI aTipoIT = "A"; |Y swSigue = 2;
                         nDiasDescAcc = nDiasDescAcc + nFinBaja - nInicioBaja;
                    |FINSI;
                    |SI aTipoIT = "M";
                         |SI swSigue = 2; |O swEnfMatPer = 1;
                              nDiasDescMat = nDiasDescMat + nFinBaja - nInicioBaja;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO calenfe;
     |SI sw_promedio = 0;
          |HAZ promedio;
     |SINO;
          prom_enf = ant_pro_enf;
          prom_acc = ant_pro_acc;
     |FINSI;
     |SI nImp989 ! 0;
          prom_enf = nImp989;
          prom_acc = nImp989;
     |FINSI;

     |HAZ topes;
     base_1 = ((prom_enf * 0.75) ! 2) * denfe_C;   || base enfermedad al 75% (503)
     base_2 = ((prom_enf * 0.60) ! 2) * denfe_B;   || base enfermedad al 60% (503)
     base_3 = ((prom_acc * 0.75) ! 2) * dacci_2;   || base accidente al 75% (504)
     base_4 = 0;
     |HAZ CompComIT;
     |SI sw_mater = 0;
          base_4 = ((prom_enf * 0.75) ! 2) * dmate_2;   || base maternidad al 75% (503)
     |FINSI;
     denfe_4= ((prom_enf * 0.60) ! 2) * denfe_D;   || complm. empresa al 60% (515)
     |SI nImp989 = 0;
          || como siempre, tengo en cuenta que no debo calcular prestaciones
          || ni cotizar en IT si el promedio no ha variado

          |SI nDiasDescEnf > 0;
               base_1 = base_1 - (((prom_enf * 0.75) ! 2) * nDescEnf_C);
               base_2 = base_2 - (((prom_enf * 0.60) ! 2) * nDescEnf_B);
               denfe_4 = denfe_4 - (((prom_enf * 0.60) ! 2) * nDescEnf_D);

               |SI base_1 < 0; base_1 = 0; |FINSI;     || por si acaso
               |SI base_2 < 0; base_2 = 0; |FINSI;
               |SI denfe_4 < 0; denfe_4 = 0; |FINSI;
          |FINSI;
          |SI nDiasDescEnf = -1;
               base_1 = 0;
               base_2 = 0;
               denfe_4 = 0;
          |FINSI;
          |SI nDiasDescAcc > 0;
               base_3 = base_3 - (((prom_acc * 0.75) ! 2) * nDiasDescAcc);
          |FINSI;
          |SI nDiasDescAcc = -1;
               base_3 = 0;
          |FINSI;
     |SINO;
          || he usado el concepto 989, eso quiere decir que fuerzo a que me
          || calcule siempre prestacion y coticemos siempre la parte de IT
          || por la diferencia que le meta en el concepto, no tengo dias de
          || descuento

          nDiasDescEnf = 0;
          nDiasDescAcc = 0;
          nDiasDescMat = 0;
          |SI #labtraba#0 = 1130; |Y #labtraba#1 = 24;      || horrible, quitar
          |Y mes_x = 3; |Y #labtraba#7 = "73390677T   ";
               nDiasDescMat = -1;
          |FINSI;
     |FINSI;

     || nume1 = denfe_2;     |HAZ liquidados;

     || nume1 = denfe_2 - nDiasDescEnf - nDiasDescAcc;
     || a ver, en teoria esto se pudo para descontar los dias que se habian
     || ya cobrado de prestacion de los dias de IT que hay que cobrar
     || el problema es que no esta teniendo en cuenta los dias que en
     || verdad no hay prestacion, (los tres primeros dias) y si luego uso eso
     || para hallar los dias de la base de IT que voy a tener en atrasos
     || estoy cotizando por esos dias que no debo, se supone
     || asi que le voy a restar el denfe_A que es el que se guarda esos dias
     || no me fio mucho pero es lo que veo mas logico, cuidado con esto
     || tiquet 3512.950
     || es siempre por el proceso para quitar los dias cuando se viene
     || de una enfermedad del mes anterior, ojo

     || enfermedad
     nume1 = 0;
     |SI nDiasDescEnf = -1;
          nDiasDescEnf = 0;
          nume1 = 0;
     |SINO;
          nume1 = denfe_2 - nDiasDescEnf;
     |FINSI;

     || atencion, esto es un poco fuerte, pero asi es, en enero no hay que co-
     || tizar nunca por IT ya que tenemos que basarnos en el promedio del mes
     || anterior, y como son atrasos, que los tienes que calcular a partir
     || de enero, no es posible que hay subido la base de cotizacion el mes
     || anterior, asi que se cotiza por lo mismo, por lo que se cotizo en el
     || historico
     || no ha venido tiquet de esto, pero a raiz del 3512.950 (18.11.2011)
     || lo pongo
     || CON LO DE LOS nDiasDescEnf lo estabamos haciendo pero solo para los
     || meses posteriores, no para ENERO
     |SI mes_x = 1;
     |Y nImp989 = 0;          || ojo, si tengo 989 no
          nume1 = 0;
     |FINSI;

     |SI nume1 < 0; nume1 = 0; |FINSI;
     |HAZ liquidados;

     |SI #2#42 = "E";
          nume1 = #21#55 * denfe_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales

     coba_1 = prom_enf * nume1;        || base CC (ILT)
     cobb_1 = prom_acc * nume1;        || base AT

     || maternidad
     nume1 = 0;
     |SI nDiasDescMat = -1;
          nDiasDescMat = 0;
          nume1 = 0;
     |SINO;
          nume1 = dmate_2 - nDiasDescMat;
     |FINSI;
     |SI nume1 < 0; nume1 = 0; |FINSI;
     |HAZ liquidados;
     |SI #2#42 = "E";
          nume1 = #21#55 * dmate_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales
     |SI mes_x = 1; || VER COMENTARIO ANTERIOR PARA ENFERMEDAD, ES LO MISMO
          nume1 = 0;
     |FINSI;
     coba_4 = prom_enf * nume1;        || base CC (ILT)
     cobb_4 = prom_acc * nume1;        || base AT

     || accidente

     nume1 = 0;
     |SI nDiasDescAcc = -1;
          nume1 = 0;
          nDiasDescAcc = 0;
     |SINO;
          nume1 = dacci_2 - nDiasDescAcc;
     |FINSI;
     |SI nume1 < 0; nume1 = 0; |FINSI;
     |HAZ liquidados;
     |SI mes_x = 1; || VER COMENTARIO ANTERIOR PARA ENFERMEDAD, ES LO MISMO
          nume1 = 0;
     |FINSI;
     |SI #2#42 = "E";
          nume1 = #21#55 * dacci_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales
     coba_2 = prom_acc * nume1;        || base AT (ILT)
     cobb_2 = prom_enf * nume1;        || base CC
     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          coba_4 = coba_4 + coba_1 + coba_2;
          cobb_4 = cobb_4 + cobb_1 + cobb_2;
          coba_1 = 0; cobb_1 = 0;
          coba_2 = 0; cobb_2 = 0;
          sw_mater = 1;
          swITEmp = 1;
     |FINSI;

     || absentismo

     nume1 = dabse_2;     |HAZ liquidados;
     |SI #2#42 = "E";
          nume1 = #21#55 * dabse_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales
     |SI #32#2 = "N";
          coba_3 = prom_enf * nume1;      || base CC
          cobb_3 = prom_acc * nume1;      || base AT
     |SINO;
          |SI #32#2 = "S";
               ||campomin = #2#33 + 23;  coti_0 = #15campomin * tp;  || minimo C.C.
               ||coba_3 = coti_0 * nume1;
          |SINO;
               coba_3 = 0;
               cobb_3 = 0;
          |FINSI;
     |FINSI;                            || base cotizacion absentismo

     |SI #2#45 = "087"; |O #2#45 = "097";
     |O #2#45 = "085"; |O #2#45 = "421";
          base_1 = 0;      || prestacion enfermedad comun S.S. 75%
          base_2 = 0;      || prestacion enfermedad comun S.S. 60%
          denfe_4 = 0;     || prestacion enfermedad comun emp. 60%
     |FINSI;

     |SI #2#241 = "N";             || prestaciones ILT: NO
          base_1 = 0; base_2 = 0;    base_3 = 0;    base_4 = 0;    denfe_4 = 0;
     |FINSI;
     |SI #2#42 = "A"; |O #2#42 = "E";
          ant_pro_enf = prom_enf;    || promedio enfermedad
          ant_pro_acc = prom_acc;    || promedio accidente
     |FINSI;

     || en nominas de atrasos negativas con IT salen prestaciones negativas

     |SI base_1 [ 0; base_1 = 0;  |FINSI;
     |SI base_2 [ 0; base_2 = 0;  |FINSI;
     |SI base_3 [ 0; base_3 = 0;  |FINSI;
     |SI base_4 [ 0; base_4 = 0;  |FINSI;
     |SI denfe_4 [ 0; denfe_4 = 0;  |FINSI;

     |SI #15#75 ! 0;               || si lleva porcentaje por deduccion voluntaria
                                   || la empresa asume a su cargo las prestaciones
                                   || por enf. comun y accid. no laboral
          base_1 = 0; base_2 = 0;    base_4 = 0;
     |FINSI;

     |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";    || agrarios
          |SI #32#14 = "N";             || prestaciones INSS: NO
               base_1 = 0; base_2 = 0;    base_3 = 0;    base_4 = 0;
          |FINSI;
     |FINSI;

     acum_53 = base_1 + base_2 + base_4;  || acumula (503)
     acum_54 = base_3;                    || acumula (504)
     acum_53 = acum_53 ! EURODB;  || redondea (503)
     acum_54 = acum_54 ! EURODB;  || redondea (504)

     |SI swModulo = 3145;
          |HAZ anticomp;       || calcula el anti-complemento
          dtodo_3 = dtodo_3 ! EURODB;    || compl. ilt (autom.)
     |SINO;
          dtodo_3 = 0;
     |FINSI;

     denfe_4 = denfe_4 ! EURODB;    || prest. empr.
     acum_53 = acum_53 ! EURODB;    || prest. enf.
     acum_54 = acum_54 ! EURODB;    || prest. acc.

     |SI denfe_4 ! 0; |O dtodo_3 ! 0;
          denfe_4 = denfe_4 ! EURODB;
          |HAZ grabados;    || graba concepto (515 y 514)
     |FINSI;

     prom_enf_real = prom_enf;
     prom_acc_real = prom_acc;

     || repon los promedios
     prom_enf = prom_enf_gua;
     prom_acc = prom_acc_gua;
     |SI #labtraba#7 = "21668318H   ";
          prom_enf = 1.66;
          prom_acc = 1.66;
     |FINSI;
|FPRC;

|PROCESO liquidados;
|SI nume1 > dia_4;  nume1 = dia_4;  |FINSI;
|SI nume1 = dia_2; |Y nume1<dia_4;  nume1 = dia_4;  |FINSI;
|FPRC;

|PROCESO grabados;
     swgracon = 1;  || para que grabe todos los campos
     swcongra = 0;  || para que no acumule si existe

     graba05 = "V";
     graba06 = 0;
     graba09 = "1";
     graba11 = 1;

     |SI denfe_4 ! 0; |O swgrabacero = 1;
          graba04 = 515;
          graba07 = 37;
          graba08 = "ENF.EMP.";
          graba10 = denfe_4;
          |HAZ grabacon;
          acum_50 = acum_50 + denfe_4;
     |FINSI;

     |SI dtodo_3 ! 0; |O swgrabacero = 1;
          graba04 = 514;
          graba07 = 39;
          graba08 = "COMP.ILT";
          graba10 = dtodo_3;
          |HAZ grabacon;
          acum_50 = acum_50 + dtodo_3;
     |FINSI;
|FPRC;

||****************************************************************************
||        CALCULO DEL PROMEDIO DE ENFERMEDAD/ACCIDENTE
||****************************************************************************

|PROCESO promedio;     || CALCULA EL PROMEDIO EL PRIMER MES
    gua_i = hcoti_0;
|SI es_irregul = 1;|Y tpz ! 0;   hcoti_0 = tpz; |FINSI;

     |SI #2#42 = "E"; || eventuales, busco jornadas alta y baja para prom
          || prom_enf = (acum_xx / #21#11) ! EURODB; || promedio enfermedad
          prom_enf = acum_xx;                    || promedio enfermedad
          prom_acc = prom_enf;                || promedio accidente
     |SINO;
          prom_enf = (acum_xx / hcoti_0) ! EURODB; || promedio enfermedad
          prom_acc = prom_enf;                || promedio accidente
     |FINSI;
     sw_promedio = 1;
     hcoti_0 = gua_i;
|FPRC;

||****************************************************************************
||                      CALCULO FINAL 1 (ajusta a brutos)
||****************************************************************************

|PROCESO calfin1;    || CALCULOS ANTERIORES AL AJUSTE A BRUTOS
|HAZ calirpfr;  || calcula base IRPF recibos
|HAZ calbruto;  || calculo bruto recibo
|HAZ calirpfp;  || calcula base IRPF pagas
|FPRC;

||****************************************************************************
||                       RUTINAS CALCULO FINAL 1
||****************************************************************************

|PROCESO calirpfr;   || CALCULA BASE IRPF
    acum_99  = acum_10 + acum_30  + acum_31  + acum_40;   || total
    acum_991 = acum_11 + acum_301 + acum_311 + acum_401;  || irpf 1
    acum_992 = acum_12 + acum_302 + acum_312 + acum_402;  || irpf 2
    acum_993 = acum_13 + acum_303 + acum_313 + acum_403;  || irpf 3

    acum_99  = acum_99 +acum_50+acum_51+acum_52+acum_53+acum_54+acum_90+acum1_200;
    acum_991 = acum_991+acum_50+acum_51+acum_52+acum_53+acum_54+acum_90+acum1_200;

    acum_99 = acum_99 - anti_41;
    acum_99 = acum_99  ! EURODB;
    acum_991= acum_991 ! EURODB;
    acum_992= acum_992 ! EURODB;
    acum_993= acum_993 ! EURODB;
|FPRC;

|PROCESO calbruto;   || CALCULA BRUTO RECIBOS Y PAGAS
    bruto_rec = acum_99 + acum_41 + anti_41 + acum_60;   || bruto recibo
    bruto_pag = acum2_200;                     || bruto pagas
    bruto_rec = bruto_rec ! EURODB;
    bruto_pag = bruto_pag ! EURODB;
|FPRC;

|PROCESO calirpfp;   || CALCULA RETENCIONES IRPF
     |SI acum_99 [ 0; acum_99 = 0; |FINSI;
     |SI acum_991 [ 0; acum_991 = 0; |FINSI;
     |SI acum_992 [ 0; acum_992 = 0; |FINSI;
     |SI acum_993 [ 0; acum_993 = 0; |FINSI;
    reten_11 = acum_991 % nPor1;   || retencion IRPF 1
    reten_12 = acum_992 % nPor2;   || retencion IRPF 2
    reten_13 = acum_993 % nPor3;   || retencion IRPF 3
    reten_11 = reten_11 ! EURODB;
    reten_12 = reten_12 ! EURODB;
    reten_13 = reten_13 ! EURODB;
    reten_1 = reten_11 + reten_12 + reten_13;  || total retenciones
    reten_2 = acum2_200 % nPor1;  || retencion IRPF pagas
    reten_2 = reten_2 ! EURODB;
|FPRC;

||****************************************************************************
||                            CALCULO FINAL 2
||****************************************************************************

|PROCESO calfin2;   || CALCULOS POSTERIORES AL AJUSTE A BRUTOS
     |SI #2#42 ! "H";
          |SI es_aprendi = 0;
               |SI #2#42 = "A"; |O #2#42 = "E";
                    |HAZ calcotiz12;
               |SINO;
                    |HAZ calcotiz;        || bases cotizacion
               |FINSI;
          |SINO;
               |HAZ calespec;        || bases cotiz. aprendizaje R.D.-Ley 18/93
          |FINSI;
     |SINO;
          base_5 = 0;
          base_6 = 0;
          base_7 = 0;
          dacum_30 = 0;
          dacum_31 = 0;
     |FINSI;
     |SI es_aprendi = 0;
          |SI #2#42 = "A"; |O #2#42 = "E";
               |HAZ calboni112;
          |SINO;
               |HAZ calboni1;  || calcula bases bonificacion y cuotas
               |HAZ calboni11;
          |FINSI;
          ||HAZ calboni60; || bonif mayores 60 a¤os, RDL 16/2001
     |SINO;
          |HAZ calboni2;  || calcula cuotas aprendices R.D.-Ley 18/93
     |FINSI;
     |HAZ calboni3;      || cuotas acumuladas
     |SI #2#42 = "A"; |O #2#42 = "E";
          |HAZ calssemp12_1
          |HAZ calssemp12_2
     |SINO;
          |HAZ calssemp;      || calcula S.S. cgo. empresa
     |FINSI;
|FPRC;

||****************************************************************************
||                       RUTINAS CALCULO FINAL 2
||****************************************************************************

|PROCESO calespec;       || BASES COTIZACION R.D.-Ley 18/93
    base_5 = 0;
    base_6 = 0;          || los aprendices no cotizan en atrasos!!!
    base_7 = 0;
|FPRC;

|PROCESO BuscaMater;
     |SI #nomcaldl#5 = 041000; |O #nomcaldl#5 = 051000; |O #nomcaldl#5 = 061000;
     |O #nomcaldl#5 = 071000;
          nBaseMater = nBaseMater + #nomcaldl#10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaMater;
     #nomcaldl#1;
     ;
     #labtraba#0, #labtraba#1, nAny, mes_x, 0, 041000;
     #labtraba#0, #labtraba#1, nAny, mes_x, 0, 091000;
     ;
     NULL, BuscaMater;
|FIN;

|PROCESO ExaminaIT;
     nDiasEnfNat = 0; nDiasEnfCot = 0;
     nDiasAccNat = 0; nDiasAccCot = 0;
     nDiasMatNat = 0; nDiasMatCot = 0;
     nDiasPatNat = 0; nDiasPatCot = 0;
     nDiasDesCot = 0; nDiasDesNat = 0;
     |PARA nCampo1 = 27; |SI nCampo1 [ 30; |HACIENDO nCampo1 = nCampo1 + 1;
          nCampo2 = nCampo1 - 8;
          nCampo3 = nCampo1 - 4;
          aTipo = #nomhicca#nCampo1#;
          |QBF aTipo;
          |SI aTipo ! "";
               nDesde = #nomhicca#nCampo2#;
               nHasta = #nomhicca#nCampo3#;

               |SI nDesde = 0; nDesde = 1; |FINSI;
               |SI nHasta = 0; nHasta = guarda; |FINSI;

               nNume = nHasta - nDesde + 1;

               |SI aTipo = "E";
                    nDiasEnfNat = nDiasEnfNat + nNume;
                    nDiasEnfCot = nDiasEnfNat;
               |FINSI;
               |SI aTipo = "A";
                    nDiasAccNat = nDiasAccNat + nNume;
                    nDiasAccCot = nDiasAccNat;
               |FINSI;
               |SI aTipo = "M";
                    nDiasMatNat = nDiasMatNat + nNume;
                    nDiasMatCot = nDiasMatNat;
               |FINSI;
               |SI aTipo = "P";
                    nDiasPatNat = nDiasPatNat + nNume;
                    nDiasPatCot = nDiasPatNat;
               |FINSI;
               |SI aTipo = "D";
                    nDiasDesNat = nDiasDesNat + nNume;
                    nDiasDesCot = nDiasDesNat;
               |FINSI;

               nLinUltimaIT = nCampo1 - 11;
               aTipUltimaIT = aTipo;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TPXenIT;
     |HAZ ExaminaIT;     || asi se cual ha sido la ultima IT (aTipUltimaIT)
     mesnum = mes_x;
     anynum = #0#9;
     |HAZ ulti_dia;
     |SI mes_x = 02;
          nNume = -2 + bisiesto;
     |SINO;
          nNume = 1;
     |FINSI;

     || esto es porque si las nDiasDescLoQueSea estan cargadas es porque era
     || una IT que comenzo en ENERO, por lo que no hay que cotizar por ella
     || comprueno que si los dias de IT menos los dias de dto. de la IT por
     || ese motivo son cero, eso es que en verdad no hay dias que cotizar por IT
     || con lo que no hay por que entrar en este ajuste.
     || mirar datos atasega, atrasos 01-09 2017, mes 03 el 924.67 que daba
     || mal porque salia una base que no debia debido a este ajuste

     |SI aTipUltimaIT = "E";
          nNume1 = denfe_2 - nDiasDescEnf;
          |SI nNume1 = 0; |ACABA; |FINSI;
     |FINSI;
     |SI aTipUltimaIT = "A";
          nNume1 = dacci_2 - nDiasDescAcc;
          |SI nNume1 = 0; |ACABA; |FINSI;
     |FINSI;
     |SI aTipUltimaIT = "M";
          nNume1 = dmate_2 - nDiasDescMat;
          |SI nNume1 = 0; |ACABA; |FINSI;
     |FINSI;
     |SI aTipUltimaIT = "E";
          |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
               || si es una IT de las que no cumple periodo de carencia tengo
               || que quitar de la base de maternidad, no de esta
               |SI nBaseIT2 ! 0;
                    coba_4 = coba_4 + (nBaseIT2 * nNume);
                    cobb_4 = cobb_4 + (nBaseIT2 * nNume);
               |SINO;
                    coba_4 = coba_4 + (prom_enf * nNume);
                    cobb_4 = cobb_4 + (prom_acc * nNume);
               |FINSI;
          |SINO;
               |SI nBaseIT2 ! 0;
                    coba_1 = coba_1 + (nBaseIT2 * nNume);
                    cobb_1 = cobb_1 + (nBaseIT2 * nNume);
               |SINO;
                    coba_1 = coba_1 + (prom_enf * nNume);
                    cobb_1 = cobb_1 + (prom_acc * nNume);
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aTipUltimaIT = "A";
          coba_2 = coba_2 + ((prom_acc + prom_ac2) * nNume);
          cobb_2 = cobb_2 + (prom_enf * nNume);
     |FINSI;

     |SI aTipUltimaIT = "M"; |O aTipUltimaIT = "P"; |O aTipUltimaIT = "R";
     |O aTipUltimaIT = "C";
          nNume1 = dcoti_0 + nNume;     || dias totales mes
          |SI dalta_3 ! 1;    || no soy alta desde el dia 1
          |Y nDiasMatNat = nNume1; || todos los dias que trabajo del mes en MAT
                                   || en este caso no hay que sumar el dia de
                                   || mas, porque ya cotizo toda la IT
               nNume = 0;
          |FINSI;

          |SI aTipUltimaIT = "M"; |O aTipUltimaIT = "P"; |O aTipUltimaIT = "R";
          |O aTipUltimaIT = "C";
               |SI mes_x ! 2; |Y coba_4 ! 0;
                    || febrero, maternidad, TPX no lo estaba haciendo bien
                    || no me meto en lios de momento, lo quito
                    |SI nBaseIT2 ! 0;
                         coba_4 = coba_4 + (nBaseIT2 * nNume);
                         cobb_4 = cobb_4 + (nBaseIT2 * nNume);
                    |SINO;
                         coba_4 = coba_4 + (prom_enf * nNume);
                         cobb_4 = cobb_4 + (prom_acc * nNume);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calcotiz;      || CALCULA BASE CON.COMUNES Y BASE D+F+P
     gua_i = hcoti_0;
     |SI es_irregul = 1;|Y tpz ! 0;   hcoti_0 = tpz; |FINSI;
     |SI swCambiaCot = 1;
          |SI dalta_3 = 1; |Y dbaja_3 = guarda;
               |HAZ TPXenIT;
          |FINSI;
     |FINSI;
     dacum_30 = acum_30;
     dacum_31 = acum_31;       || horas extraordinarias
     base_5 = cobb_1 + coba_2 + cobb_4;                 || base AT ILT

     nume1 = acum_10 + dvalo_pro + n400Cot;    || ctos.100 + prorrata
     |SI dvalo_pro > 0; |Y dilt = dia_2;
          || todo el mes en IT
          nume1 = nume1 - dvalo_pro;
     |FINSI;
     nume2 = dacum_30 + dacum_31;    || horas extras
     base_6 = nume1 + coba_1 + cobb_2 + coba_3 + coba_4;          || CC
     base_7 = nume1 + cobb_1 + coba_2 + cobb_3 + cobb_4 + nume2;  || AT

     |SI sw_mater ! 0;
          base_6 = base_6 - coba_4;
          base_7 = base_7 - cobb_4;
     |FINSI;
     |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
          base_6 = 0;
     |FINSI;
     swSigue = 0;
     |SI swAjuste3 ! 0;
          swSigue = 1;
          |SI mes_x = 2; |Y base_5 = 0;
               swSigue = 0;
               || 4413.130
          |FINSI;
          |SI mes_x = 2; |Y swCambiaCot = 1;
               |SI aTipUltimaIT = "M"; |O aTipUltimaIT = "P"; |O aTipUltimaIT = "R";
               || 5401.18
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #labtraba#0 = 1130; |Y #labtraba#1 = 24;
     |Y mes_x = 3; |Y #labtraba#7 = "73390677T   ";
          swSigue = 0;        || horrible, pero no tengo mas remedio, quitar
     |FINSI;
     |SI swSigue = 1;
          base_5 = base_5 - (swAjuste3 * prom_enf);
          ||SI dmate_2 = 0;    || en maternidad no me restes de las bases
          || cambio peligroso, para el caso en que no se haya cotizado por
          || la parte de IT al ser un trabajador que venia de IT de un mes
          || anterior al calculo, con lo que la base no le cambia y no tiene
          || que cotizar en IT
          |SI nDiasDescEnf > 0; |O nDiasDescAcc > 0;
               aSwDD = "1";
          |FINSI;
          |SI dmate_2 = 0; |Y nDiasDescEnf = 0; |Y nDiasDescAcc = 0;
          |Y swITEmp = 0;
          || en maternidad no me restes de las bases (aparte de lo nuevo)
               base_6 = base_6 - (swAjuste3 * prom_enf);
               base_7 = base_7 - (swAjuste3 * prom_enf);
          |FINSI;
     |FINSI;
     |SI base_5 < 0; base_5 = 0; |FINSI;
     |SI base_6 < 0; base_6 = 0; |FINSI;
     |SI base_7 < 0; base_7 = 0; |FINSI;

     gbase6 = base_6 ! EURODB;
     gbase7 = base_7 ! EURODB;

     |SI sw_mater ! 1;
          ant_pro_enf = (base_6 / hcoti_0) ! EURODB;    || promedio enfermedad
          ant_pro_acc = (base_7 / hcoti_0) ! EURODB;    || promedio accidente
     |SINO;
          ant_pro_enf = prom_enf;    || promedio enfermedad
          ant_pro_acc = prom_acc;    || promedio accidente
     |FINSI;

     |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
          ant_pro_enf = prom_enf;    || promedio enfermedad
          ant_pro_acc = prom_acc;    || promedio accidente
     |FINSI;

     nBaseMater = 0;
     |SI sw_mater = 1;
          |BUCLE BuscaMater;
     |FINSI;
     nume1 = #2#33 + 35;

     |SI #labtraba#237 = "S";
          |ABRE #nompluri;
          #nompluri#0 = #labtraba#0;
          #nompluri#1 = #labtraba#1;
          |LEE 000#nompluri.=;
          |SI FSalida = 0;
               #15nume1 = (#15nume1 * (#nompluri#3 / 100)) ! 2;
          |FINSI;
          |CIERRA #nompluri;
     |FINSI;

     maximo = #15nume1 * hcoti_0;   || c.comunes
     |SI hcoti_0 ] 30;
          maximo = #15nume1 * 30;
     |FINSI;

     nume3 = #21#39 + base_6 + nBaseMater;

     |SI nume3 > maximo;
          base_6 = base_6 - (nume3 - maximo);
          |SI base_6 < 0; base_6 = 0;    |FINSI;
          base_6 = base_6 ! 2;
          |SI base_6 = 0;
               base_5 = 0;
          |FINSI;
     |FINSI;

     |SI #labtraba#237 = "S";
          |ABRE #nompluri;
          #nompluri#0 = #labtraba#0;
          #nompluri#1 = #labtraba#1;
          |LEE 000#nompluri.=;
          |SI FSalida = 0;
               #15#20 = (#15#20 * (#nompluri#4 / 100)) ! 2;
          |FINSI;
          |CIERRA #nompluri;
     |FINSI;

     |SI hcoti_0 [ 30;
          maximo = #15#20 * hcoti_0;      || c.profesionales
          |SI mes_x = 2; |Y hcoti_0 = 28;
               |SI #labtraba#42 = "D"; |O #labtraba#42 = "T";
                    maximo = #15#20 * 30;      || c.profesionales
               |FINSI;
          |FINSI;
     |SINO;
          maximo = #15#20 * 30;           || c.profesionales
     |FINSI;


     nume3 = #21#40 + base_7 + nBaseMater;

     |SI nume3 > maximo;
          base_7 = base_7 - (nume3 - maximo);
          |SI base_7 < 0; base_7 = 0;    |FINSI;
          base_7 = base_7 ! 2;
     |FINSI;

     hcoti_0 = gua_i;     || lo repone por si ha variado

     || lo hago aqui: (06.06.2005)
     |SI base_6 = 0; |O base_7 = 0;

          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
               |SI base_6 = 0; |Y base_7 = 0;
                    sw_promedio = 0;
               |FINSI;
          |SINO;
               sw_promedio = 0;
          |FINSI;
          base_1 = 0;
          base_2 = 0;
          base_4 = 0;

          acum_53 = 0;  || importe enfermedad SS
          acum_54 = 0;  || importe accidente SS

          |SI denfe_4 > 0;
               acum_99 = acum_99 - denfe_4;
               acum_991 = acum_991 - denfe_4;
               reten_11 = acum_991 % nPor1;
               reten_11 = reten_11 ! EURODB;
               reten_1 = reten_11 + reten_12 + reten_13;
               bruto_rec = bruto_rec - denfe_4;
               denfe_4 = 0;
               acum_50 = 0;  || importe enfermedad Empresa
               swgrabacero = 1;
               |HAZ grabados;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO por_bon_16;
     alfa1 = #2#11 % -104;         || anyo nacimiento
     alfa2 = #2#11 % -602;         || mes nacimiento
     alfa5 = #2#11 % 102;          || dia nacimiento
     alfa3 = aFechaRef % -104;     || anyo Fecha Referencia
     alfa4 = aFechaRef % -602;     || mes Fecha Referencia
     alfa6 = aFechaRef % 102;      || dia Fecha Referencia
     nume1 = alfa1;
     nume1 = alfa1 + nEdadParaBon;           || a¤o que cumple 60 a¤os
     alfa1 = nume1;
     nume3 = alfa3;                || a¤o que cumple 5 a¤os antiguedad
     nume3 = alfa3 + nAnysParaAnt;
     alfa3 = nume3;
     nume2 = alfa2;                || mes edad
     nume4 = alfa4;                || mes antiguedad
     nume5 = alfa5;                || dia edad
     nume6 = alfa6;                || dia antiguedad
     |SI nEdadParaBon = 59;
          fecha_ini_bon = "01.01.2001";
          any_ini_bon = 2001;
     |SINO;
          fecha_ini_bon = "01.01.2002";
          any_ini_bon = 2002;
     |FINSI;

     |SI nume1 > nume3;            || cuando cumple 60 a¤os
          |SI nume1 < 2002;
               fecha_bon_16 = "01.01.2002";
          |SINO;
               fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
          |FINSI;
     |FINSI;
     |SI nume1 < nume3;            || cuando cumple antiguedad
          |SI nume3 < 2002;
               fecha_bon_16 = "01.01.2002";
          |SINO;
               fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
          |FINSI;
     |FINSI;
     |SI nume1 = nume3;            || mismo a¤o: comprobamos meses
          |SI nume2 > nume4;            || cuando cumple 60 a¤os
               |SI nume1 < 2002;
                    fecha_bon_16 = "01.01.2002";
               |SINO;
                    fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
               |FINSI;
          |FINSI;
          |SI nume2 < nume4;            || cuando cumple antiguedad
               |SI nume3 < 2002;
                    fecha_bon_16 = "01.01.2002";
               |SINO;
                    fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
               |FINSI;
          |FINSI;
          |SI nume2 = nume4;       || antiguedad y 60 a¤os en = a¤o, =mes
               |SI nume5 > nume6;            || cuando cumple 60 a¤os
                    |SI nume1 < 2002;
                         fecha_bon_16 = "01.01.2002";
                    |SINO;
                         fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
                    |FINSI;
               |FINSI;
               |SI nume5 < nume6;            || cuando cumple antiguedad
                    |SI nume3 < 2002;
                         fecha_bon_16 = "01.01.2002";
                    |SINO;
                         fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
                    |FINSI;
               |FINSI;
               |SI nume5 = nume6;
                    fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
               |FINSI;
          |FINSI;
     |FINSI;

     alfa7 = fecha_bon_16 % 402;
     nume7 = alfa7;                || mes en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % -104;
     nume8 = alfa7;                || anyo en que empieza a ser efectiva la bonif.
     nMesesBon16 = mes_x - nume7;
     nAnyosBon16 = #0#9 - nume8;
     |SI nAnyosBon16 > 0;
          |SI nMesesBon16 < 0;
               nMesesBon16 = 12 + nMesesBon16;
               nAnyosBon16 = nAnyosBon16 - 1;
          |FINSI;
     |FINSI;

     |SI nAnyosBon16 ] 0;
          |SI nEdadParaBon = 59;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 40 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nEdadParaBon = 60;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 50 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nEdadParaBon = 55;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 50;
               |FINSI;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI dalta_3 ! 1; |O dbaja_3 ! guarda;        || para sacar los dias reales en alta
          nume10 = dia_2;     || dias del mes reales
     |SINO;
          nume10 = dcoti_0;   || dias reales alta, dias alta: dias naturales
     |FINSI;

     nume10 = nume10 + ddese_2 + ddese_3;

     |SI mes_x = nume7; |Y #0#9 ] nume8;      || si estoy calculando el mes q entra
          alfa7 = fecha_bon_16 % 102;        || en vigor la bonif. calcula el % correspondiente
          nume7 = alfa7;                     || segun la fecha inicio de bonif.
          nume7 = nume10 - nume7 + 1;
          |SI #0#9 > nume8;                  || si llevo ya mas de un a¤o de bonif
               nume9 = #0#9 - nume8;         || este mes cambia el procentaje a
               |SI nume9 [ 5;                || bonificar, hay que proporcionar
                    por_bon_16A = nume10 - nume7;      || cada parte segun lo que
                    nPB16CalcA = nPB16Calc - 10;       || toque
               |SINO;
                    nume7 = nume10;
               |FINSI;
          |FINSI;
     |SINO;
          nume7 = nume10;                    || si es un mes posterior calcula el
     |FINSI;                                 || 100% ya que entra entera.

     por_bon_16 = (nume7 / nume10) * 100;
     |SI por_bon_16A > 0;
          por_bon_16A = 100 - por_bon_16;
     |FINSI;
|FPRC;

|PROCESO calboni60;      || BONIFICACION MAYORES 60 A¤OS RDL. 16/2001
     bon_59 = 0;
     bon_60 = 0;
     bon_60A = 0;
     nPB16Calc = 0;
     nPB16CalcA = 0;

     nElAny = #0#9;

     |SI nElAny ] 2014;
          |ACABA;
     |FINSI;

     alfa1 = #labtraba#11 % -104;        || anyo nacimiento
     alfa2 = #labtraba#11 % -602;        || mes nacimiento

     nNume = alfa1;
     nEdad = nElAny - nNume;
     nNume = alfa2;
     |SI nElMes < nNume;
          nEdad = nEdad - 1;
     |FINSI;

     |SI nElAny = 2013;
          |SALVA_FICHA #nomhicca;
          swSigue = 0;
                                        || en diciembre de 2012 la tuvo,
          |ABRE #nomhicca;              || con lo que se la debe poder
          #nomhicca#0 = #labtraba#0;    || seguir aplicando hasta que
          #nomhicca#1 = #labtraba#1;    || acabe
          #nomhicca#66 = 12;
          #nomhicca#2 = 12;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=;
          FEstado = FSalida;
          |SI FSalida = 0;
               |SI #nomhicca#148 ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |CIERRA #nomhicca;
          |REPON_FICHA #nomhicca;

          || inicia el derecho a la reduccion en 2013, que es cuando
          || cumplira 59 a¤os. A partir de 2013, solo se aplica a quie-
          || nes se la vinieran aplicando por haber cumplido 59 en 2012,
          || quienes cumplan en 2013 los 59, nada de nada

          || no haria falta con la condicion anterior, partiendo de swSigue = 0
          || pertampoco esta de mas

          alfa1 = #labtraba#11 % -104;    || anyo nacimiento
          nNume = alfa1;
          nNume1 = 2012 - nNume;          || edad con que acabo 2012
          |SI nNume1 = 58;
               swSigue = 0;
          |FINSI;

          || esto es por si ya sabemos que acabo el a¤o 2012 con 59 a¤os
          || pero resulta que el swSigue me venia a cero por no tener en
          || 2012 la nomina de diciembre

          |SI nNume1 = 59;
               |SI FEstado ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
          |ACABA;
     |FINSI;
     |SI #2#212 = 9;
          |ACABA;
     |FINSI;
     nume1 = #0#9;
     |SI nume1 > 2002;
           por_bon_60 = 22.18;
           |SI nume1 ] 2011;
                por_bon_60 = 22.14;
           |FINSI;
     |SINO;
           por_bon_60 = 22.30;
     |FINSI;
     |SI #2#212 = 2;
          aFechaRef = #2#36;       || fecha de referencia: fecha de Alta
     |SINO;
          aFechaRef = #2#34;       || fecha de referencia: fecha de Antiguedad
     |FINSI;
     alfa1 = #2#11; |QBF alfa1;    || compruebo que exista fecha nacimiento
     alfa2 = aFechaRef; |QBF alfa2;    || compruebo que exista fecha de refer.
     |SI alfa1 = ""; |O alfa2 = ""; |O alfa1 = ".........."; |O alfa2 = "..........";
          |ACABA;
     |FINSI;

     nEdadParaBon = 0;

     |SI #2#212 = 0; #2#212 = 1;   |FINSI;
     |SI #2#212 = 1; |O #2#212 = 2; |O #2#212 = 11;
          nume1 = #labtraba#45;
          |SI nume1 < 400;    || contrato indefinido
               nEdadParaBon = 59;  || a partir de los 59 a¤os
               nAnysParaAnt = 4;
          |SINO;
               nEdadParaBon = 60;  || a partir de los 60 a¤os
               nAnysParaAnt = 5;
          |FINSI;
     |SINO;
          nEdadParaBon = 55;
          |SI #2#212 = 3; |O #2#212 = 4; || bonificaciones del textil
               nAnysParaAnt = 5;
          |FINSI;
          |SI #2#212 = 5; |O #2#212 = 6; || bonificaciones del calzado
               nAnysParaAnt = 1;
          |FINSI;
          |SI #2#212 = 13; |O #2#212 = 14; || bonificaciones del juguete
               nAnysParaAnt = 3;
          |FINSI;
          |SI #2#212 = 15; |O #2#212 = 16; || bonificaciones del mueble
               nAnysParaAnt = 4;
          |FINSI;
     |FINSI;                  || a partir de los 55 a¤os

     |HAZ por_bon_16;

|| bon60 es lo que bonifico
|| base_6 es la base a bonificar
|| por_bon_60 es el porcentaje que dice la ley que se bonifica
|| nPB16Calc es el % que calculo segun el numero de a¤os que me corresponde
|| aplicar la bonif: 50% el primer a¤o y 10% mas cada a¤o a partir de ahi
|| por_bon_16 es la proporcion del mes a la que tengo que aplicar la bonif.

|| bon_60A, nPB16CalcA y por_bon_16A es lo analogo para cuando hay dos perio-
|| dos, en el periodo anterior
     |SI nPB16Calc ! 0;
          bon_60A = (base_6  % por_bon_60) % nPB16CalcA;
          bon_60A = (bon_60A % por_bon_16A) ! EURODB;

          bon_60 = (base_6  % por_bon_60) % nPB16Calc;
          bon_60 = (bon_60 % por_bon_16) ! EURODB;

     |FINSI;
     |SI nPB16CalcA = 40;
          bon_59 = bon_60A;
          bon_60A = 0;
     |FINSI;
     |SI nPB16Calc = 40;
          bon_59 = bon_60;
          bon_60 = 0;
     |FINSI;
     bon_60 = bon_60 + bon_60A;
     |SI swAgosto2012 = 1;
          bon_60 = 0;
     |FINSI;
|FPRC;

|PROCESO el_caso_raro;
     nDiasBonBaja = 0;
                                   || dias bonif distinto a dias cotiz
                                   || o acaba o empieza bonificacion este me
     alfa1 = #2#40 % 402;          || comprueba si este mes comienza bonif
     alfa2 = #2#40 % -104;
     nume1 = alfa1;      || mes inicio bonif
     nume2 = alfa2;      || mes fin bonif
     |SI nume1 = #0#8; |Y nume2 = #0#9;
          alfa1 = #2#40 % 102;
          nAltaBonif = alfa1;
          nBajaBonif = dcoti_0;
     |FINSI;

     aAlfa = aFecBajaBon;
     alfa1 = aAlfa % 402;     || si este mes NO comienza bonif. es porque
     alfa2 = aAlfa % -104;    || acaba, si no no deberia haber entrado
     nume1 = alfa1;      || mes inicio bonif
     nume2 = alfa2;      || mes fin bonif
     |SI nume1 = #0#8; |Y nume2 = #0#9;
          alfa1 = aAlfa % 102;
          nAltaBonif = 1;
          nBajaBonif = alfa1;
     |FINSI;

     |SI nAltaBonif = 0; |Y nBajaBonif = 0;
          |ACABA;        || no deberia haber entrado
     |FINSI;

     |PARA nDia = 1; |SI nDia [ dcoti_0; |HACIENDO nDia = nDia + 1;  ||
          |PARA nBaja = 12; |SI nBaja [ 15; |Y #0#79 ! "N";
          |HACIENDO nBaja = nBaja + 1;
               |SI #nomhicca#nBaja# = "E"; |O #nomhicca#nBaja# = "A"; |O #nomhicca#nBaja# = "M";
               |O #nomhicca#nBaja# = "P"; |O #nomhicca#nBaja# = "R"; |O #nomhicca#nBaja# = "O";
               ||SI #nomhicca#nBaja# = "M";
                    nume1 = nBaja - 8;  || dia desde baja
                    nume2 = nBaja - 4;  || dia hasta baja
                    nInicioBaja = #nomhicca#nume1#;
                    nFinBaja = #nomhicca#nume2#;
                    |SI nInicioBaja = 0; nInicioBaja = 1; |FINSI;
                    |SI nFinBaja = 0; nFinBaja = dcoti_0; |FINSI;
                    |SI nDia ] nInicioBaja; |Y nDia [ nFinBaja;
                         |SI nDia ] nAltaBonif; |Y nDia [ nBajaBonif;
                              nDiasBonBaja = nDiasBonBaja + 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |SIGUE;
|FPRC;

|PROCESO calboni1;       || CALCULA BASES BONIFICACION
     bon_0 = 0;           || base CC bonificacion (1)
     bon_3 = 0;           || base CP bonificacion (1)
     bon_5 = 0;           || base ILT bonificacion (1)
     bon_1 = por1_cont;   || (%) cont. comunes
     bon_2 = por1_dfpg;   || (%) D+F+P
     swSigue = 0;
     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0;     swSigue = 1; |FINSI;
     |SI #2#39 ! 0;                 |Y #nombonif#28 ! 0; swSigue = 1; |FINSI;
     |SI swSigue = 1;
          lin_1 = #16#6 % nPorBon1;
          lin_2 = #16#7 % nPorBon1;
          bon_0 = base_6;
          bon_3 = base_7;
          bon_5 = base_5;
          |SI sw_mater = 1;
               |SI dboni_1 = dmate_2;
                    || la bonificacion es por los mismos dias que tengo maternidad
                    || esto quiere decir que se trata de una bonif. de maternidad
                    || y que por tanto, solo debo bonificar la propia base de mater.
                    bon_0 = coba_4;
                    bon_3 = cobb_4;
               |SINO;
                    bon_0 = bon_0 + coba_4;
                    bon_3 = bon_3 + cobb_4;
               |FINSI;
          |FINSI;
          bon_1 = por1_cont - lin_1;
          bon_2 = por1_dfpg - lin_2;
          |SI #16#9 = "S";
               bon_1 = bon_1 - #15#5;
          |FINSI;

          aUltimaIT = "";
          |PARA campo = 27; |SI campo [ 30; |HACIENDO campo = campo + 1;
               |SI #21campo ! " ";
                    aUltimaIT = #21campo;
               |FINSI;
          |SIGUE;

          |SI dboni_1 ! dcoti_0;    || dias bonificacion distintos a dias cotizacion
               |HAZ el_caso_raro;
               |SI nDiasBonBaja ! 0;
                    bon_0 = bon_0 - bon_5;
                    bon_3 = bon_3 - bon_5;
                    nDiasBaja = denfe_2 + dmate_2 + dacci_2;
                    |SI nDiasBonBaja ] nDiasBaja;
                         nume1 = (dboni_1 - nDiasBonBaja) / dboni_1;
                    |SINO;
                         nume1 = (dboni_1 - nDiasBonBaja) / nDiasBaja;
                    |FINSI;
                    bon_0 = bon_0 * nume1;
                    bon_3 = bon_3 * nume1;
                    |SI nDiasBonBaja ] nDiasBaja;
                         nume2 = nDiasBonBaja / dboni_1;
                    |SINO;
                         nume2 = nDiasBonBaja / nDiasBaja;
                    |FINSI;
                    bon_5 = bon_5 * nume2;

                    bon_0 = bon_0 + bon_5;
                    bon_3 = bon_3 + bon_5;

               |SINO;
                    |SI dmate_2 = dboni_1;
                         || bonificacion de maternidad, todos los dias de mater.
                         || no hay nada que proporcionar
                         |SI aUltimaIT = "M";
                              |SI swCambiaCot = 1;
                                   bon_0 = dboni_1 * prom_enf;
                                   bon_3 = dboni_1 * prom_acc;
                              |SINO;
                                   bon_0 = (dboni_1 - swAjuste3) * prom_enf;
                                   bon_3 = (dboni_1 - swAjuste3) * prom_acc;
                                   || bon_5 = (dboni_1 - swAjuste3) * prom_enf;
                              |FINSI;
                         |FINSI;
                    |SINO;
                         |SI mes_x = 2; |Y dboni_1 = 28;
                              || no, febrero entero de alta, aunque baja el 28
                         |SINO;
                              nume1 = dboni_1 / (dboni_1 + dboni_2);
                              bon_0 = bon_0 * nume1;
                              bon_3 = bon_3 * nume1;
                              bon_5 = bon_5 * nume1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               gbase6 = bon_0 ! EURODB;
               gbase7 = bon_3 ! EURODB;
               |SI gbase6 ! 0;|Y bon_0 = 0;    bon_0 = gbase6;     |FINSI;
               |SI gbase7 ! 0;|Y bon_3 = 0;    bon_3 = gbase7;     |FINSI;
          |FINSI;
     |FINSI;

     || esto es para cuando estoy calculando una complementaria que si o si
     || tiene que cobrar el importe completo y si esta en IT se cobra entero
     || y no se proporciona nada
     nDiasCotITEmp = 0;
     |SI #0#79 = "N";
          |HAZ SSEmpresaAlta;
     |FINSI;

     nBase = base_6 - (base_6 * nDiasCotITEmp / dcoti_0);
     dto_con = nBase % bon_1;       dto_con = dto_con ! EURODB; || cont. comunes
     nBase = base_7 - (base_7 * nDiasCotITEmp / dcoti_0);
     || dto_dfp = nBase % bon_2;       dto_dfp = dto_dfp ! EURODB; || D+F+P
     dto_dfp = (nBase % por1_des) ! EURODB;
     dto_dfp = dto_dfp + (nBase % por1_fp) ! EURODB;
     dto_ho1 = dacum_30 % por1_hor1; dto_ho1 = dto_ho1 ! EURODB; || horas no
     dto_ho2 = dacum_31 % por1_hor2; dto_ho2 = dto_ho2 ! EURODB; || horas si
     |SI #16#10 = 4;           || RDL 16/2001 2.2.1
          bon_1 = por1_cont - #16#6;
     |FINSI;
|FPRC;

|PROCESO SSEmpresaAlta;

     || en estos casos, si en la nomina del mes habia una IT de solo cotizacion
     || empresarial, entonces por importe que se cobre en alta, tambien ha de
     || cotizar solo la empresa, va a la 509 del SILTRA, es un poco contradictorio
     || que cotice solo la empresa por un importe que se cobra completo, pero asi es

     aUltimaIT = "";
     |PARA campo = 27; |SI campo [ 30; |HACIENDO campo = campo + 1;
          |SI #21campo ! " ";
               aUltimaIT = #21campo;
          |FINSI;
     |SIGUE;

     nDiasCotITEmp = #21#65 + #21#173;
     |SI nDiasCotITEmp ! 0;
          |SI aUltimaIT = "M"; |O aUltimaIT = "P"; |O aUltimaIT = "R";
          |O aUltimaIT = "C";
               nDiasCotITEmp = nDiasCotITEmp - swAjuste3;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboni11;      || CALCULA BASES BONIFICACION
    zbon_0 = 0;          || base CC bonificacion (2)
    zbon_3 = 0;          || base CP bonificacion (2)
    zbon_5 = 0;          || base ILT bonificacion (2)
    bon_1 = por1_cont;  || (%) cont. comunes
    bon_2 = por1_dfpg;  || (%) D+F+P
|SI #2#39 ! 0; |Y dboni_2 ! 0; |Y nPorBon2 ! 0;
        lin_1 = #16#6 % nPorBon2;
        lin_2 = #16#7 % nPorBon2;
        zbon_0 = base_6;
        zbon_3 = base_7;
        zbon_5 = base_5;
    |SI sw_mater = 1;
            zbon_0 = zbon_0 + coba_4;  ||(dmate_2 * prom_enf);
            zbon_3 = zbon_3 + cobb_4;  ||(dmate_2 * prom_acc);
    |FINSI;
        bon_1 = por1_cont - lin_1;
        bon_2 = por1_dfpg - lin_2;
    |SI #16#9 = "S";
            bon_1 = bon_1 - #15#5;
    |FINSI;
    |SI dboni_2 ! dcoti_0;    || dias bonificacion distintos a dias cotizacion
            nume1 = dboni_2 / (dboni_1 + dboni_2);
            zbon_0 = zbon_0 * nume1;
            zbon_3 = zbon_3 * nume1;
            zbon_5 = zbon_5 * nume1;
            gbase6 = zbon_0 ! EURODB;
            gbase7 = zbon_3 ! EURODB;
        |SI gbase6 ! 0;|Y zbon_0 = 0;    zbon_0 = gbase6;     |FINSI;
        |SI gbase7 ! 0;|Y zbon_3 = 0;    zbon_3 = gbase7;     |FINSI;
    |FINSI;
        nume1 = bon_0 + zbon_0;
    |SI nume1 ! base_6;  zbon_0 = zbon_0 - (nume1 - base_6);     |FINSI;
        nume1 = bon_3 + zbon_3;
    |SI nume1 ! base_7;  zbon_3 = zbon_3 - (nume1 - base_7);     |FINSI;
|FINSI;
|SI #16#10 = 4;           || RDL 16/2001 2.2.1
        bon_1 = por1_cont - #16#6;
|FINSI;
|FPRC;

|PROCESO calboni2;
    bon_0 = 0; zbon_0 = 0;
    bon_1 = 0;
    bon_2 = 0;
    bon_3 = 0; zbon_3 = 0;
    bon_5 = 0; zbon_5 = 0;
    dto_con = 0;     || los aprendices no cotizan          || cont. comunes
    dto_dfp = 0;     || en atrasos!!!                      || D+F+P
    dto_ho1 = 0;                                           || horas no
    dto_ho2 = 0;                                           || horas si
|FPRC;

|PROCESO calboni3;
    dto_tot = dto_con + dto_dfp + dto_ho1 + dto_ho2;
    dto_tot = dto_tot + reten_1;       || total dtos. (atrasos !!!)
    liquido = bruto_rec - dto_tot;     || liquido
|FPRC;

|PROCESO lee904;
     |ABRE #nomepigr;
     #nomepigr#0 = 904;
     |LEE 000#nomepigr.=;
     |CIERRA #nomepigr;
|FPRC;

|PROCESO calssemp;    || CALCULA S.S. A CGO. EMPRESA (18/93 y resto)
     |SI sw_mater = 1;
          |SI swAjuste3 ! 0;
          |Y dmate_2 ! nDiasDescMat;
               coba_4 = coba_4 - (swAjuste3 * prom_enf);
               cobb_4 = cobb_4 - (swAjuste3 * prom_acc);
          |FINSI;
          base_6 = base_6 + coba_4;
          base_7 = base_7 + cobb_4;
     |FINSI;
     base_A = 0;  base_B = 0;  base_C = 0;  base_F = 0;
     base_D = 0;  base_E = 0;  base_G = 0;  base_M = 0;  base_N = 0;
     zbase_A = 0; zbase_B = 0; zbase_C = 0; zbase_F = 0;
     zbase_M = 0; zbase_N = 0;

     base_77 = acum_10 + coba_3 + dvalo_pro;  || base cont.profesionales
     base_8 = (dacum_30 % por2_hor1)+(dacum_31 % por2_hor2); || h.ext.
     |SI swITEmp = 1;
          base_11 = base_11 + coba_4;
     |FINSI;


     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y #16#11 = "S";
        base_D = horasex * #16#12;      || cuota (2) bonif. horas formacion
     |FINSI;

     |SI es_aprendi = 0;
          |SI #2#45 ! "064";|Y #2#45 ! "065";|Y #16#9 = "N";
               || deduc.volunt.(122): todos menos los 64/65 y los coef.reductores
               base_G = (base_6 % (por1_cont + por2_cont) ) ! EURODB;
               base_G = (base_G % #15#75) ! EURODB;
          |FINSI;

          nBaseEmpTra = base_6 - coba_4;
          nBaseEmp = coba_4;
          || cuota cc emp+tra
          nCuotaEmpCC = (nBaseEmpTra % (por1_cont + por2_cont) ! 2) - ((nBaseEmpTra % por1_cont) ! 2);
          || cuota cc emp
          nCuotaEmpCC = nCuotaEmpCC + ((nBaseEmp % por2_cont) ! 2); || cc
          base_8 = base_8 + nCuotaEmpCC;             || cc
/*
          || antes era solo esto 10.02.2020
          base_8 = base_8 + (base_6 % por2_cont);             || cc
*/
          base_8 = base_8 + (((ddese_2 - swAjuste3) * nUnid990) % por2_cont);             || cc
          base_8 = base_8 < notaria;                          || ded.notarias
/*
          || antes era solo esto 10.02.2020
          base_8 = base_8 + (base_7 % por2_dfpg);             || cp
*/
          nBaseEmpTra = base_7 - cobb_4;
          nBaseEmp = cobb_4;

          nCuotaEmpTra = (nBaseEmpTra % (por1_des + por2_des)) ! 2; || total
          nCuotaEmpTra = nCuotaEmpTra - ((nBaseEmpTra % por1_des) ! 2); || total
          nCuotaEmp = (nBaseEmp % por2_des) ! 2;
          nCuotaEmpDes = nCuotaEmpTra + nCuotaEmp;
          base_8 = base_8 + nCuotaEmpDes;

          nCuotaEmpTra = (nBaseEmpTra % (por1_fp + por2_fp)) ! 2; || total
          nCuotaEmpTra = nCuotaEmpTra - ((nBaseEmpTra % por1_fp) ! 2); || total
          nCuotaEmp = (nBaseEmp % por2_fp) ! 2;
          nCuotaEmpFP = nCuotaEmpTra + nCuotaEmp;
          base_8 = base_8 + nCuotaEmpFP;

          nCuotaEmpFog = (base_7 % por2_fog) ! 2;
          base_8 = base_8 + nCuotaEmpFog;

          base_8 = base_8 + (((ddese_2 - swAjuste3) * nUnid990) % por2_dfpg);             || cp
          base_8 = base_8 + ((((base_6 % por2_cont) ! EURODB) % nEl36) ! EURODB);
                                                              || 36% ctos.<7dias
          base_8 = base_8 ! EURODB;

          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
               base_8 = 0;
          |FINSI;

          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
               |SI #0#9 [ 2009;
                    base_9 = base_77 % (epig_ilt + epig_ims);           || epigrafe normal
                    |SI #32#16 = 2;
                         |SI #0#9 [ 2006;
                              base_9 = base_9 + (base_5 % (#15#3 + #15#4));            || epig.enf.
                         |SINO;
                              |HAZ lee904;
                              base_9 = base_9 + (base_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                              base_9 = base_9 + (((ddese_2 - swAjuste3)* nUnid990) % (#nomepigr#1 + #nomepigr#2));
                         |FINSI;
                    |FINSI;
               |SINO;
                    base_9 = (base_77 % epig_ilt) ! 2;           || epig. normal
                    base_9 = base_9 + ((base_77 % epig_ims) ! 2);|| epig. normal
                    |SI #32#16 = 2;
                         base_9 = (base_77 % epig_ilt) ! 2;
                         base_9 = base_9 + ((base_77 % epig_ims) ! 2);
                         base_9 = base_9 + ((base_5 % epig_ilt) ! 2);
                         base_9 = base_9 + ((base_5 % epig_ims) ! 2);
                         base_9 = base_9 + ((((ddese_2 - swAjuste3) * nUnid990) % epig_ilt) ! 2);
                         base_9 = base_9 + ((((ddese_2 - swAjuste3) * nUnid990) % epig_ims) ! 2);
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #0#9 [ 2009;
                    base_9 = (base_7 - base_5) % (epig_ilt + epig_ims);      || epig.normal
                    |SI #0#9 [ 2006;
                         base_9 = base_9 + (base_5 % (#15#3 + #15#4));            || epig.enf.
                    |SINO;
                         |HAZ lee904;
                         base_9 = base_9 + (base_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                         base_9 = base_9 + (((ddese_2 - swAjuste3)* nUnid990) % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                    |FINSI;
               |SINO;
                    base_9 = ((base_7 - base_5) % epig_ilt) ! 2;
                    base_9 = base_9 + (((base_7 - base_5) % epig_ims) ! 2);
                    base_9 = base_9 + ((base_5 % epig_ilt) ! 2);
                    base_9 = base_9 + ((base_5 % epig_ims) ! 2);
                    base_9 = base_9 + ((((ddese_2 - swAjuste3) * nUnid990) % epig_ilt) ! 2);
                    base_9 = base_9 + ((((ddese_2 - swAjuste3) * nUnid990) % epig_ims) ! 2);
               |FINSI;
          |FINSI;

          base_9 = base_9 ! EURODB;
    |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0;
            base_A = ((bon_0 % #16#4)!EURODB) % nPorBon1; || cuota bonif. linea 1
            base_A = base_A ! EURODB;
            base_B = ((bon_3 % #16#5)!EURODB) % nPorBon1; || cuota bonif. linea 2
            base_B = base_B ! EURODB;
            base_M = (bon_0 % #16#6) % nPorBon1; || cuota bonif. linea 1
            base_M = base_M ! EURODB;
            base_N = (bon_3 % #16#7) % nPorBon1; || cuota bonif. linea 2
            base_N = base_N ! EURODB;

          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
               base_A = 0;
               base_B = 0;
               base_M = 0;
               base_N = 0;
          |FINSI;

          |SI #16#08 = "S";
               |SI #0#9 [ 2009;
                    zbase_9 = (bon_3 - bon_5) % (epig_ilt + epig_ims);
                    zbase_9 = zbase_9 ! EURODB;
                    |SI #0#9 [ 2006;
                         zbase_9 = zbase_9 + (bon_5 % (#15#3 + #15#4));            || epig.enf.
                    |SINO;
                         |HAZ lee904;
                         zbase_9 = zbase_9 + (bon_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                    |FINSI;
               |SINO;
                    zbase_9 = ((bon_3 - bon_5) % epig_ilt) ! 2;
                    zbase_9 = zbase_9 + (((bon_3 - bon_5) % epig_ims) ! 2);
                    zbase_9 = zbase_9 + ((bon_5 % epig_ilt) ! 2);
                    zbase_9 = zbase_9 + ((bon_5 % epig_ims) ! 2);
               |FINSI;
               zbase_9 = zbase_9 ! EURODB;
               base_C = zbase_9 % nPorBon1;      || cuota bonificada accidentes
               base_C = base_C ! EURODB;
          |FINSI;
     |FINSI;
     |SI #2#39 ! 0; |Y dboni_2 ! 0; |Y nPorBon2 ! 0;
          zbase_A = ((zbon_0 % #16#4)!EURODB) % nPorBon2; || cuota bonif. linea 1
            zbase_A = zbase_A ! EURODB;
            zbase_B = ((zbon_3 % #16#5)!EURODB) % nPorBon2; || cuota bonif. linea 2
            zbase_B = zbase_B ! EURODB;
            zbase_M = (bon_0 % #16#6) % nPorBon1; || cuota bonif. linea 1
            zbase_M = zbase_M ! EURODB;
            zbase_N = (bon_3 % #16#7) % nPorBon1; || cuota bonif. linea 2
            zbase_N = zbase_N ! EURODB;
     |SI #16#08 = "S";
          |SI #0#9 [ 2009;
                zbase_9 = (zbon_3 - zbon_5) % (epig_ilt + epig_ims);
                zbase_9 = zbase_9 ! EURODB;
                |SI #0#9 [ 2006;
                    zbase_9 = zbase_9 + (zbon_5 % (#15#3 + #15#4));            || epig.enf.
                |SINO;
                    |HAZ lee904;
                    zbase_9 = zbase_9 + (zbon_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                |FINSI;
          |SINO;
                zbase_9 = ((zbon_3 - zbon_5) % epig_ilt) ! 2;
                zbase_9 = zbase_9 + (((zbon_3 - zbon_5) % epig_ims) ! 2);
                zbase_9 = zbase_9 + ((zbon_5 % epig_ilt) ! 2);
                zbase_9 = zbase_9 + ((zbon_5 % epig_ims) ! 2);
          |FINSI;
          zbase_9 = zbase_9 ! EURODB;
          zbase_C = zbase_9 % nPorBon2;     || cuota bonificada accidentes
          zbase_C = zbase_C ! EURODB;
     |FINSI;

          |SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
               zbase_A = 0;
               zbase_B = 0;
               zbase_M = 0;
               zbase_N = 0;
          |FINSI;
    |FINSI;
          |SI #2#39 = 501; |O #2#39 = 502;
               runnom = "nomcalat";
               |HAZ calboni_taripla;
          |FINSI;
        base_E = base_8+base_9-(base_A+base_B+base_C+zbase_A+zbase_B+zbase_C+base_D+base_G); ||SS emp.
        base_F = base_A + base_B + base_C + base_M + base_N;       || cuota (1) bonif.
        zbase_F = zbase_A + zbase_B + zbase_C + zbase_M + zbase_N;   || cuota (2) bonif.

     |SI #2#211 ! 0; |Y bon_60 ! 0;
          nume1 = (((base_6 % por2_cont) ! 2) - base_A) - bon_60;
          |SI nume1 < 0; || esto es para comprobar que no
               bon_60 = bon_60 + nume1; || se bonifique mas de la cuota
          |FINSI;                       || a pagar
          base_E = base_E - bon_60;        || bonif. mayores 60 a¤os
     |FINSI;

     |SI bon_59 ! 0;
          nume1 = (((base_6 % por2_cont) ! 2) - base_A) - bon_59;
          |SI nume1 < 0; || esto es para comprobar que no
               bon_59 = bon_59 + nume1; || se bonifique mas de la cuota
          |FINSI;                       || a pagar
          base_E = base_E - bon_59;        || bonif. mayores 59 a¤os
     |FINSI;

     |SI base_E < 0;
          base_E = 0;
     |FINSI;
|FINSI;

|SI sw_mater = 1;
        base_6 = base_6 - coba_4;
        base_7 = base_7 - cobb_4;
|FINSI;

|FPRC;

||*************************************************************************
||                    REFUNDIR MESES
||*************************************************************************

|PROCESO calcula_ref;
|HAZ lee_traba;     || lee el trabajador
|HAZ historico;     || historico correspondiente al mes de acumulacion
|HAZ t_parcial;     || variables y coeficientes de los tiempos parciales
    swempre = 0;
    swlbonif = 0;
    swlepigr = 0;
|HAZ calleer;       || empresa, constante, epigrafe, etc.

    dmate_2 = rdmate_2;
    prom_enf = (maternba / dmate_2) ! EURODB;
    prom_acc = (maternbb / dmate_2) ! EURODB;
|SI dmate_2 ! 0;    sw_mater = 1;  |SINO;    sw_mater = 0;  |FINSI;
    coba_4 = maternba;
    cobb_4 = maternbb;
    dboni_1 = rdboni_1;
    dboni_2 = rdboni_2;
    hcoti_0 = dias_cot;
    dacum_30 = horasex1;
    dacum_31 = horasex2;
    horasex = rhorasex;
    base_5 = base_ilt;
    base_6 = remunera + prorrata + base_5;
    base_7 = base_6 + dacum_30 + dacum_31;
|SI sw_mater = 1;
        base_6 = base_6 - maternba;
        base_7 = base_7 - maternbb;
|FINSI;

    gbase6 = base_6 ! EURODB;
    gbase7 = base_7 ! EURODB;
|SI gbase6 ! 0;|Y base_6 = 0;  base_6 = gbase6;    |FINSI;
|SI gbase7 ! 0;|Y base_7 = 0;  base_7 = gbase7;    |FINSI;

|SI sw_mater = 1;
        base_6 = base_6 + maternba;
        base_7 = base_7 + maternbb;
|FINSI;

|SI #2#42 = "H";|O es_aprendi = 1;
        base_5 = 0;           || apendices sin cotizacion en atrasos
        base_6 = 0;
        base_7 = 0;
    |SI #2#42 = "H";          || autonomos sin cotizacion de ningun tipo
            dacum_30 = 0;
            dacum_31 = 0;
    |FINSI;
|FINSI;
|SI es_aprendi = 0;
    |HAZ calboni1;  || calcula bases bonificacion y cuotas
    |HAZ calboni11;
    |HAZ calboni60; || bonif mayores 60 a¤os, RDL 16/2001
|SINO;
    |HAZ calboni2;  || calcula cuotas aprendices R.D.-Ley 18/93
|FINSI;
|HAZ calssemp;      || calcula S.S. cgo. empresa

    #11#37 = remunera; || remuneracion
    #11#38 = prorrata; || prorrata
    #11#39 = base_6;   || base CC
    #11#40 = base_7;   || base CP
    #11#41 = dacum_30; || base H.E. 1
    #11#42 = dacum_31; || base H.E. 2
    #11#43 = bon_0;    || base 1 bonifi.
    #11#44 = bon_3;    || base 2 bonifi.
    #11#45 = base_E;   || S.S. cgo. empresa
    #11#48 = dto_con + deducss;  || dto. cont. comunes
    #11#49 = dto_dfp;  || dto. D+F+P
    #11#50 = dto_ho1;  || dto. horas 1
    #11#51 = dto_ho2;  || dto. horas 2
    #11#62 = base_5;   || base cotiz. enfe/acci
    #11#63 = base_F;   || cuota bonif. 1
    #11#64 = base_D;   || cuota bonif. 2
|FPRC;

|PROCESO lee_traba;
|DDEFECTO #2;
    #2#0 = #11#0;
    #2#1 = #11#1;
|LEE 020#2=;
    mes_x = #11#2;
|FPRC;

|PROCESO inicializa;
    dias_cot = 0;
    remunera = 0;
    prorrata = 0;
    horasex1 = 0;
    horasex2 = 0;
    base_ilt = 0;
    maternba = 0;
    maternbb = 0;
    rdboni_1 = 0;
    rdboni_2 = 0;
    rdmate_2 = 0;
    rhorasex = 0;
|FPRC;

|PROCESO graba_ultimo;        || seleccion salteada
    #11#0 = emp_desde;
    #11#1 = tra_desde;
    #11#2 = mes_refun;
    #11#3 = 5;
|LEE 121#11=;
|SI FSalida = 0;
    |HAZ calcula_ref;
    |GRABA 020#11a;
|FINSI;
|HAZ inicializa;
|LIBERA #11;
|FPRC;

|PROCESO regraba_ultimo;      || seleccion desde/hasta
|HAZ calcula_ref;
|GRABA 020#11a;
|HAZ inicializa;
|FPRC;

|PROCESO lee_horas_bonif;
|DDEFECTO #12;
    #12#0 = #11#0;
    #12#1 = #11#1;
    #12#2 = #11#2;
    #12#3 = #11#3;
    #12#4 = 901;
|LEE 000#12=;
    rhorasex = rhorasex + #12#9;
|FPRC;
/*
|PROCESO nomcalac1;
|HAZ lee_traba;
|SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";
    |MENAV "    Proceso de refundir meses solo disponible para el Regimen General ...";
    |LIBERA #11;
    |ACABA;
|FINSI;

    dcoti_0 = #11#8;
|HAZ bonif;
    dias_cot = dias_cot + #11#8;        || dias cotizados
    remunera = remunera + #11#37;       || total remuneracion
    prorrata = prorrata + #11#38;       || total prorratas
    horasex1 = horasex1 + #11#41;       || horas extras 1
    horasex2 = horasex2 + #11#42;       || horas extras 2
    base_ilt = base_ilt + #11#62;       || base ILT
    maternba = maternba + (#11#35 * #11#65); || base CC (ILT maternidad)
    maternbb = maternbb + (#11#36 * #11#65); || base AT (ILT maternidad)
    rdboni_1 = rdboni_1 + dboni_1;      || dias de bonificacion
    rdboni_2 = rdboni_2 + dboni_2;      || dias de no bonificacion
    rdmate_2 = rdmate_2 + #11#65;       || dias maternidad
|HAZ lee_horas_bonif;

    #11#37 = 0;          || remuneracion
    #11#38 = 0;          || prorrata
    #11#39 = 0;          || base CC
    #11#40 = 0;          || base CP
    #11#41 = 0;          || horas 1
    #11#42 = 0;          || horas 2
    #11#43 = 0;          || bonif.1
    #11#44 = 0;          || bonif.2
    #11#45 = 0;          || S.S. cgo. empresa
    #11#48 = 0;          || cuota CC
    #11#49 = 0;          || cuota CP
    #11#50 = 0;          || cuota horas 1
    #11#51 = 0;          || cuota horas 2
    #11#63 = 0;          || cuota bonif.1
    #11#64 = 0;          || cuota bonif.2
|GRABA 020#11a;

|SI #0#21 = 0;
        #51#0 = #11#0;
        #51#1 = #11#1;
    |LEE 020#51=;        || debe de existir
    |SI FSalida = 0;
        |SI #11#2 = #51#2;         || en el ultimo mes regraba e inicializa
            |HAZ regraba_ultimo;
        |FINSI;
    |FINSI;
|SINO;
        mes_refun = #11#2;    || para la seleccion salteada
|FINSI;

|LIBERA #11;
|FPRC;

|DEFBUCLE nomcalac;
 #11#1;
 ;
 emp_desde, tra_desde, #0#8,  5;
 emp_hasta, tra_hasta, #0#10, 5;
 be;
 NULL, nomcalac1;
|FIN;

|PROCESO asaltos;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        emp_desde = #0salte_1;     emp_hasta = emp_desde;
        tra_desde = #0salte_2;     tra_hasta = tra_desde;
    |SI emp_desde ] 1;|Y tra_desde ] 1;
        |BUCLE nomcalac;
        |HAZ graba_ultimo;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO ulti_mes1;
|DDEFECTO #51;
    #51#0 = #11#0;
    #51#1 = #11#1;
|LEE 101#51=;
    FEstado = FSalida;

    #51#2 = #11#2;       || graba el mes

|SI FEstado = 0;    |GRABA 020#51a;     |FINSI;
|SI FEstado ! 0;    |GRABA 020#51n;     |FINSI;
|LIBERA #51;
|FPRC;

|DEFBUCLE ulti_mes;
 #11#1;
 ;
 emp_desde, tra_desde, #0#8,  5;
 emp_hasta, tra_hasta, #0#10, 5;
 ;
 NULL, ulti_mes1;
|FIN;

|PROCESO refundir;
|ATRI P;  |MENSA "    Refundiendo meses ...";     |ATRI 0;
|ABRET #2;
|ABRET #11;
|ABRET #12;
|SI #0#21 = 0;
        alfa1 = Usuario;
    |NOME_DAT #51 alfa1;
    |DELINDEX #51;
    |ABRE #51;
        emp_desde = #0#0;     emp_hasta = #0#1;
        tra_desde = #0#2;     tra_hasta = #0#3;
    |BUCLE ulti_mes;     || para saber cual es el ultimo mes
    |BUCLE nomcalac;
    |CIERRA #51;
    |DELINDEX #51;
|SINO;
    |HAZ asaltos;
|FINSI;
|CIERRAT #2;
|CIERRAT #11;
|CIERRAT #12;
|FPRC;
*/
||****************************************************************************
||                   COMPROBACION ACTIVACION EMPRESA
||****************************************************************************

|PROCESO activasino;
     swActiva = 1;
     |ABRE #1;
     #1#0 = #2#0;
     |LEE 000#1=;
     |SI #1#50 = "S";
          swActiva = 0;  || empresa no activa
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO TipoCot;
     swCambiaCot = 0;
     |SI mes_x = 04; |O mes_x = 06; |O mes_x = 09; |O mes_x = 11;
          |ACABA;
     |FINSI;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
          nNume = #nomhicca#31 + #nomhicca#32 + #nomhicca#65 + #nomhicca#33;
          nNume = nNume + #nomhicca#34 + #nomhicca#119 + #nomhicca#173;
          nNume = nNume + #nomhicca#236;
          |SI nNume ! 0;
               swCambiaCot = 1;
          |FINSI;
     |FINSI;
     || martillazo, feo, quitar enseguida
     |SI #labtraba#0 = 858; |Y #labtraba#1 = 887;
     |Y mes_x = 3; |Y #0#9 = 2018;
               swCambiaCot = 0;
     |FINSI;

|FPRC;

|PROCESO CompModulo2;
     swNoAjuste3 = 1;
     |PARA para1 = 27; |SI para1 [ 30; |Y #0#79 ! "N";
     |HACIENDO para1 = para1 + 1;
          |SI #21para1 = "E"; |O #21para1 = "A"; |O #21para1 = "M";
          |O #21para1 = "P"; |O #21para1 = "R"; |O #21para1 = "O";
               desde = para1 - 8;
               hasta = para1 - 4;
               |SI #21hasta = 0; |O mes_x = 2;
                    swNoAjuste3 = 0;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO modulo2;
     || este proceso se crea para controlar el tema de la opcion "3" en el
     || control de la aplicacion en el calculo de Dias de IT
     || solo si no soy diario, estoy en un mes de 31 dias y tengo parte en IT
     || esta igual en el silcon09 y en el silcon10, si se cambia algo tenerlo
     || en cuenta tambien alli

     swAjuste3 = 0;
     swAjuste3_C = 0;
     dilt = dacci_2 + denfe_2 + dmate_2;

     |SI #32#17 = 3;
          swSigue = 0;
          |SI #2#42 ! "D"; |Y #2#42 ! "T"; |Y #2#42 ! "E";
               swSigue = 1;
          |FINSI;
          |SI #2#42 = "C"; |O #2#42 = "F";
               |SI #labtraba#33 ] 08;
                    swSigue = 0;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               |SI dilt ! 0; |Y denfe_2 < dia_2; |Y dmate_2 < dia_2; |Y dacci_2 < dia_2;
               |Y dcoti_0 ] dia_3; |Y dalta_3 = 1; |Y dbaja_3 = topemes; |Y swNoAjuste3 = 0;
               || si no esta todo el mes de alta no pasa
                    |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
                         |SI mes_x ! 2;
                              swAjuste3 = 1;
                         |SINO;
                              swAjuste3 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI ddese_2 > 0;
               |Y dalta_3 = 1; |Y dbaja_3 = topemes;
               || si no esta todo el mes de alta no pasa
                    |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
                         |SI mes_x ! 2;
                              swAjuste3 = 1;
                         |SINO;
                              swAjuste3 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI dilt ! 0;
               |Y dmate_2 ! 0; |Y dries_2 ! 0;    || mes con rie y mat
               |Y dmate_2 = dia_2;                || TODO EL MES
               |Y dries_2 ! dmate_2;              || no es todo riesgo
                    |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
                         |SI mes_x ! 2;
                              swAjuste3 = 1;
                         |SINO;
                              swAjuste3 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #2#42 = "A";
               || agrarios, todo el mes Accidente, hay que hacerlo
               |SI dacci_2 = dia_2;
                    |SI dcoti_0 ] dia_3; |Y dalta_3 = 1; |Y dbaja_3 = topemes; |Y swNoAjuste3 = 0;
                         |SI mes_x ! 4; |Y mes_x ! 6; |Y mes_x ! 9; |Y mes_x ! 11;
                              |SI mes_x ! 2;
                                   swAjuste3_C = 1;
                              |SINO;
                                   swAjuste3_C = -2 + bisiesto;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EnPracticas;
     nPropPrac = 1;
     |SI #2#45 = "420"; |O #2#45 = "520";
          |SI #2#232 ! 0; |Y #2#233 ! 0; |Y #2#208 = "S";
               alfa1 = #2#36 % -104;         || anyo alta
               alfa2 = #2#36 % -602;         || mes alta
               alfa3 = #2#36 % 102;          || dia alta
               nume2 = alfa1;                || anyo alta
               nume3 = alfa2;                || mes alta
               nume1 = #0#9 - nume2;
               nume4 = #0#8 - nume3;

               |SI nume1 > 2;
                    nPropPrac = 1;      || mas de dos a¤os en alta
               |SINO;
                    |SI nume1 = 2;
                         |SI nume4 ] 0;
                              nPropPrac = 1;  || mas de dos a¤os en alta
                         |SINO;
                              nPropPrac = #labtraba#233 / 100;  || entre uno y dos a¤os en alta
                         |FINSI;
                    |FINSI;
                    |SI nume1 = 1;
                         |SI nume4 ] 0;
                              nPropPrac = #labtraba#233 / 100;  || mas de dos a¤os en alta
                         |SINO;
                              nPropPrac = #labtraba#232 / 100;  || entre uno y dos a¤os en alta
                         |FINSI;
                    |FINSI;
                    |SI nume1 = 0;
                         nPropPrac = #labtraba#232 / 100;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA GRABAR LA SS A CARGO DE LA EMPRESA ***********/
/****************************************************************************/

|PROCESO SS_Empresa;
     || Comunes
     nBase = base_6 + coba_4;
     nCuotaTotal = (nBase % (por1_cont + por2_cont)) ! 2;
     nCuotaTrab = (nBase % por1_cont) ! 2;
     || #nomcalac#173 = nCuotaTotal - nCuotaTrab;
     #nomcalac#173 = nCuotaEmpCC;

     || Desempleo
     nBase = (base_7 + cobb_4);
     nCuotaTotal = (nBase % (#nomconst#12 + #nomconst#13)) ! 2;
     nCuotaTrab = (nBase % #nomconst#13) ! 2;
     || #nomcalac#174 = nCuotaTotal - nCuotaTrab;
     #nomcalac#174 = nCuotaEmpDes;

     || FOGASA
     nBase = (base_7 + cobb_4);
     || #nomcalac#175 = (nBase % #nomconst#14) ! 2;
     #nomcalac#175 = nCuotaEmpFog;

     || FP
     nBase = (base_7 + cobb_4);
     nCuotaTotal = (nBase % (#nomconst#16 + #nomconst#17)) ! 2;
     nCuotaTrab = (nBase % #nomconst#17) ! 2;
     || #nomcalac#176 = nCuotaTotal - nCuotaTrab;
     #nomcalac#176 = nCuotaEmpFP;

     || AT + EP
     #nomcalac#177 = base_9;


     #nomcalac#179 = (dacum_30 % por2_hor1) + (dacum_31 % por2_hor2);  || Horas Extras
     || Bonificaciones
     #nomcalac#180 = (base_A + base_B + base_C + zbase_A + zbase_B + zbase_C + base_G);
|FPRC;
