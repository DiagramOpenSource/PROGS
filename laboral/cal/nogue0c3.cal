||PROCESOS PARA LA IMPRESION DE LA NOMINA EN CRYSTAL REPORTS

|FICHEROS;
     nomrecib #0;
     nombanco;
     :/basica/def/agidanif #8;
     &bancosc@  #709;
     labtraba #2;
     nomtrnom #10;
     nomcontr;
     labempre #1;
     labcentr #6;
     nom400eu;
     nomcom02;      || (lineas del mant. comentarios)
     nomcom04;      || (mant. comentarios/mes)
     nomcom05;      || (comentarios particular trabajador)
     nomcom07;      || (comentario general para toto el mundo)
     nomgir00;
     nomgirli;
     nomgirco;
     nomir009;
     nomcuadr;
     labclean;
     nomnomin;
     nomcenes #35;
     nomtmpca #93;
     gomccchi;

     nomimpr1;
     nomcalca;
     nomhicca;
     nomareci;
     nompluba;
     nomabsca;
     nomabsli;
     nomconli;
     nomcalac;
     copiadef@ #500;

     nomconst;
     nomepigr;
     nomlinom;

     nomcont1;
     nomcont2;
     nomcont3;
     nomcatli;
     nomconca;
|FIN;

|VARIABLES;
     &aSit_lab = "":
     &aSit_fam = "";
     &aGrado_minus  = "";
     &aNif_conyuge  = "";
     &aP1       = "";
     &aP11      = "";
     &aP2       = "";
     &aP21      = "";
     &aP1_del   = "";
     &aP11_del  = "";
     &aP2_del   = "";
     &aP21_del  = "";
     &aP1_al    = "";
     &aP11_al   = "";
     &aP2_al    = "";
     &aP21_al   = "";
     &aP1_mes   = "";
     &aP11_mes  = "";
     &aP2_mes   = "";
     &aP21_mes  = "";
     &nP1_mes   = 0;
     &nP11_mes  = 0;
     &nP2_mes   = 0;
     &nP21_mes  = 0;
     &aNume = "";

     aCampo = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aValor = "";
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     fFecha = @;

     &nEdad = 0;
     &nDesc3 = 0;
     &nDesc25 = 0;
     &nAscen = 0;
     &enCodBanco = 0;
     &nEnfer = 0;
     &nAccid = 0;
     i = 0;
     para1 = 0;
     para2 = 0;
     para3 = 0;
     nNume = 0;
     &concep = 0;
     &camdesc = 0;
     &topemes = 0;
     nLinea = 0;
     &nAny = 0;
     nTipo = 0;
     aComen = "";
     aComen1 = "";
     aComen2 = "";
     aComen3 = "";
     aComen4 = "";
     aLinea = "";
     aNomSN = "";
     aPagSN = "";
     aAtrSN = "";
     aFinSN = "";
     &nMes = 0;

     &infctos = 0;
     &infptas = 0;
     &infdesc = "";
     &infunid = 0;
     &infunia = 0;
     &infvalo = 0;
     &infporc = 0;
     &retoded = "";
     &nEmbargo = 0;
     aMes = "";
     nCampo = 0;
     nCampo1 = 0;

     &swStop = 0;
     &nEmp = 0;
     &nTra = 0;
     aClave = "";
     aDesdeClave = "";
     aHastaClave = "";
     &nTraNoEmi = 0;
     &aParam = "";
     &aParam1 = "";
     &aParam2 = "";
     &swHayIncid = 0;
     swNoMas = 0;
     aDesde = "";
     aHasta = "";
     aEmp = "";
     aCen = "";
     aTra = "";
     aNomEmp = "";
     aNomTra = "";
     aDef = "";
     aCuadre = "";
     aOrigen = "";
     aDestino = "";
     swSigue = 0;
     &nEmpCuad = 0;
     &nOpcion = 0;
     nTipoNom = 0;
     nRegistro = 0;
     &nContador2 = 0;
     aHora = "";
     &nEmision = 0;
     nUltimo = 0;
     &nTopemes = 0;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     &domemp = "";
     &pobemp = "";
     &afili = "";
     nHoras = 0;
     nTotalHorasAbs = 0;
     fFechaDesde = @;
     fFechaHasta = @;
     &eaVengoDe = "nomareci";
     &swModulo = 0;
     aMas = "";
     aBase = "";
     aFich = "";
     &nCuadre = 0;
     &aImpresora = "";
     &swPasada = 0;
     &descri = "";
     &unidad = 0;
     &valor = 0;
     &nEpigConv = 0;
     &nElAny = 0;
     &nElMes = 0;

     {1}aContiene = "";
     aIP = "";
     &ninguno = 0;

     numer = 0;
     numerl = 0;
     &import = 0;
     &incluye = 0;
|FIN;

|PROCESO Centro
     |DDEFECTO #labcentr;
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;           || centro
     |SI FSalida ! 0;
          aAlfa1 = #labtraba#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aAlfa2 = #labtraba#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
          aAlfa3 = #labtraba#77; |QBF aAlfa3; aAlfa3 = ("00" + aAlfa3) % -102;
          aAlfa = "    ATENCION. Trabajador " + aAlfa1 + "." + aAlfa2 + ".";
          aAlfa = aAlfa + " El centro " + aAlfa3 + " no existe.";
          |QBF aAlfa;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO BuscaCCCEmp_2;
     |ABRE #gomccchi;
     #gomccchi#0 = #labempre#0;
     #gomccchi#1 = 00;
     |LEE 000#gomccchi.=;
     |SI FSalida = 0;
          |SI #0#4 [ 11;
               afili = #gomccchi#2;
          |FINSI;
     |FINSI;
     |CIERRA #gomccchi;
|FPRC;

|PROCESO BuscaCCCCen_2;
     |ABRE #gomccchi;
     #gomccchi#0 = #labcentr#0;
     #gomccchi#1 = #labcentr#1;
     |LEE 000#gomccchi.=;
     |SI FSalida = 0;
          |SI #0#4 [ 11;
               afili = #gomccchi#2;
          |FINSI;
     |FINSI;
     |CIERRA #gomccchi;
|FPRC;

|PROCESO afili_agr_2;
     |SI #0#9 = 1;
          |HAZ BuscaCCCEmp_2;
     |SINO;
          |HAZ BuscaCCCCen_2;
     |FINSI;
|FPRC;

|PROCESO ultimodia1;
     |SI #nomcontr#19 = "S"; |Y #nomtrnom#para1# = "Accidente ";
          #10para2 = #10para2 - 1;

          || si estoy en el mes en que empiezo la baja y la he comenzado
          || el mismo dia de alta en la empresa, no puedo pintar que la IT
          || por accidente comience el dia antes

          aAlfa = #labtraba#36;
          aAlfa1 = aAlfa % 102; nNume1 = aAlfa1;
          aAlfa2 = aAlfa % 402; nNume2 = aAlfa2;
          aAlfa3 = aAlfa % -104; nNume3 = aAlfa3;
          nNume4 = #0#4 + 2000;
          |SI nNume2 = #0#5; |Y nNume3 = nNume4;
               |SI #10para2 < nNume1;
                    #10para2 = #10para2 + 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #10para2 = 0;
          #10para2 = 1;
     |FINSI;
     |SI #10para3 = 0;
          nMes = #0#5;
          nAny = #0#4 + 2000;
          |HAZ topemes_plb;
          #10para3 = nTopemes;
     |FINSI;
|FPRC;

|PROCESO DatosPersonalesCR;
     |SI #agidanif#2 = "TITULAR     ";

          aCampo = "sit_fam";      aValor = #agidanif#15;
          aSit_fam = aValor;

          aValor = #agidanif#17;
          |QBF aValor;
          |SI aValor ! "";
               aValor = aValor + "%";
          |FINSI;
          aCampo = "grado_minus";  aValor = #agidanif#17;
          aGrado_minus = aValor;

     |FINSI;
     |SI #agidanif#2 = "CONYUGE     ";
          aCampo = "nif_conyuge";  aValor = #agidanif#8;
          aNif_conyuge = aValor;
     |FINSI;
     |SI #agidanif#2 = "DESCENDIENTE";
          aAlfa1 = #agidanif#13;
          |QBF aAlfa1;
          aAlfa1 = aAlfa1 % -104;
          nNume1 = aAlfa1;              || El anyo de nacimiento
          fFecha = ~;
          aAlfa2 = fFecha;
          aAlfa2 = aAlfa2 % -104;
          nNume2 = aAlfa2;              || El anyo actual
          nEdad = nNume2 - nNume1;
          |SI nEdad < 3;
               nDesc3 = nDesc3 + 1;
          |FINSI;
          |SI nEdad ] 3; |Y nEdad < 25;
               nDesc25 = nDesc25 + 1;
          |FINSI;
     |FINSI;
     |SI #agidanif#2 = "ASCENDIENTE ";
          nAscen = nAscen + 1;
     |FINSI;
|FPRC;

|PROCESO BuscaBanco;
     enCodBanco = #labtraba#71;
     |HAZ LeeBancos;
     #nombanco#1 = #709#1;
|FPRC;

|DEFBUCLE agidanifCR;
     #agidanif#1;
     ;
     #10#12, 00;
     #10#12, 99;
     ;
     NULL, DatosPersonalesCR;
|FIN;

|PROCESO agidanifCR;
     aSit_lab = "":
     aSit_fam = "";
     aGrado_minus  = "";
     aNif_conyuge  = "";
     nDesc3 = 0;
     nDesc25 = 0;
     nAscen = 0;
     |BUCLE agidanifCR;

     || la situacion laboral del trabajador, se coge del labtraba a partir del
     || 2011, lo saco del bucle del agidanif

     aCampo = "sit_lab";
     ||aAlfa = #agidanif#36; |QBF aAlfa;
     aAlfa = #labtraba#111; |QBF aAlfa;
     aAlfa = "A" + aAlfa;
     aValor = aAlfa;
     aSit_lab = aValor;
|FPRC;

|PROCESO Formatea;
     aAlfa = aNume % -301;
     |SI aAlfa = ".";
          |ACABA;
     |FINSI;
     aAlfa = aNume % -201;
     |SI aAlfa = ".";
          aNume = aNume + "0";
          |ACABA;
     |FINSI;
     |SI aNume ! "0";
          aNume = aNume + ",00";
     |SINO;
          aNume = "";
     |FINSI;
|FPRC;

|PROCESO ColocaMat;
     || aValor es el tipo de IT

     nNume = #10para2;
     |SI nNume [ 0;
          nNume = 1;
     |FINSI;

     || aDesde es el dia de inicio de la IT
     || aHasta es el dia de fin de la IT
     aDesde = nNume;
     aHasta = #10para3;

     || esto que viene ahora lo hago para que la maternidad
     || salga donde haya hueco

     |QBF aP1;
     |SI aP1 = "";
          aP1 = aValor;
          aP1_del = aDesde;
          aP1_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP11;
     |SI aP11 = "";
          aP11 = aValor;
          aP11_del = aDesde;
          aP11_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP2;
     |SI aP2 = "";
          aP2 = aValor;
          aP2_del = aDesde;
          aP2_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP21;
     |SI aP21 = "";
          aP21 = aValor;
          aP21_del = aDesde;
          aP21_al = aHasta;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO LeeNomabsli;
     nHoras = #nomabsli#6;
     |SI nHoras = 0;
          nHoras = nNume1;
     |FINSI;
     nNume2 = #nomabsli#2;
     nNume3 = #nomabsli#3;
     nNume4 = nNume3 - nNume2 + 1;
     nTotalHorasAbs = nTotalHorasAbs + (nNume4 * nHoras);
|FPRC;

|DEFBUCLE LeeNomabsli;
     #nomabsli#1;
     ;
     #labtraba#0, #labtraba#1, fFechaDesde;
     #labtraba#0, #labtraba#1, fFechaHasta;
     ;
     NULL, LeeNomabsli;
|FIN;

|PROCESO HorasAbs;
     nMes = #0#5;
     nAny = #0#4 + 2000;
     |HAZ topemes_plb;

     aAlfa1 = "01";
     aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nAny;

     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaDesde = aAlfa;

     aAlfa1 = nTopemes; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaHasta = aAlfa;

     nNume1 = 0;
     |ABRE #nomabsca;
     #nomabsca#0 = #labtraba#0;
     #nomabsca#1 = #labtraba#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;
          nNume1 = #nomabsca#2;
     |FINSI;
     |CIERRA #nomabsca;

     nTotalHorasAbs = 0;
     |BUCLE LeeNomabsli;
|FPRC;

|PROCESO CargaIndemnizaCR;
     aP1       = "";
     aP11      = "";
     aP2       = "";
     aP21      = "";
     aP1_del   = "";
     aP11_del  = "";
     aP2_del   = "";
     aP21_del  = "";
     aP1_al    = "";
     aP11_al   = "";
     aP2_al    = "";
     aP21_al   = "";
     aP1_mes   = "";
     aP11_mes  = "";
     aP2_mes   = "";
     aP21_mes  = "";
     nEnfer = 0;
     nAccid = 0;
     nP1_mes   = 0;
     nP11_mes  = 0;
     nP2_mes   = 0;
     nP21_mes  = 0;
     |SI #0#67 = "A"; |Y #0#10 = 2;
          |SI #10#103 > 0;
               #10#186 = "Enfermedad";
          |SINO;
               #10#186 = "";
          |FINSI;
          |SI #10#104 > 0;
               #10#187 = "Accidente";
          |SINO;
               #10#187 = "";
          |FINSI;
     |FINSI;
     swNoMas = 0;
     |PARA i = 186; |SI i [ 189; |HACIENDO i = i + 1;
          para1 = i;
          para2 = i - 8;
          para3 = i - 4;
          |SI #10para1 = "Enfermedad";
               |HAZ ultimodia1;
               |SI nEnfer [ 1;
                    |SI nEnfer = 0;
                         aCampo = "prestacion1"; aValor = "Enfermedad";
                         aP1 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion1_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP1_del = aValor;
                              aCampo = "prestacion1_al";   aValor = #10para3;
                              aP1_al = aValor;
                         |FINSI;
                    |SINO;
                         aCampo = "prestacion11"; aValor = "Enfermedad";
                         aP11 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion11_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP11_del = aValor;
                              aCampo = "prestacion11_al";   aValor = #10para3;
                              aP11_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
               nEnfer = nEnfer + 1;
          |FINSI;
          |SI #10para1 = "Accidente ";
               |HAZ ultimodia1;
               |SI nAccid [ 1;
                    |SI nAccid = 0;
                         aCampo = "prestacion2"; aValor = "Accidente ";
                         aP2 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion2_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP2_del = aValor;
                              aCampo = "prestacion2_al";   aValor = #10para3;
                              aP2_al = aValor;
                         |FINSI;
                    |SINO;
                         aCampo = "prestacion21"; aValor = "Accidente ";
                         aP21 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion21_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP21_del = aValor;
                              aCampo = "prestacion21_al";   aValor = #10para3;
                              aP21_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
               nAccid = nAccid + 1;
          |FINSI;
          |SI #10para1 = "Maternidad"; |O #10para1 = "Paternidad";
          |O #10para1 = "Riesgo Emb"; |O #10para1 = "IT Cont.SS";
          |O #10para1 = "Perm.s/ret";
               |HAZ ultimodia1;
               aCampo = "prestacion2";
               aValor = #10para1;
               |SI #10para1 = "IT Cont.SS";
                    aValor = "IT Control SS por Agot. Pago";
               |FINSI;
               |SI #10para1 = "Perm.s/ret";
                    aValor = "Permiso sin retribuci¢n";
               |FINSI;
               |SI #0#10 ! 2;
                    |HAZ ColocaMat;
               |FINSI;
               |SI #10para1 ! "IT Cont.SS"; |Y para1 = 186;
                    nEnfer = nEnfer + 1;
                    || esto es porque si la primera linea de IT era una
                    || maternidad y la segunda una enfermedad, no salia la
                    || maternidad.
               |FINSI;
               |SI #10para1 = "IT Cont.SS";
                    nEnfer = nEnfer + 1;
               |FINSI;
          |FINSI;
          |SI #nomcontr#47 = "T";
               |SI #10para1 = "Absentismo"; |O #10para1 = "Vacaciones";
               |O #10para1 = "Huelga    ";
                    |SI #10para1 = "Absentismo";
                         aValor = "Absentismo";
                         nNume = #10#198;
                         |SI nNume ! 0; |Y swNoMas = 0;
                              aAlfa = nNume;
                              aValor = aValor + " (Total " + aAlfa + " d¡as)";
                              swNoMas = 1;
                              || solo pone una vez el total dias absentismo
                         |FINSI;
                    |FINSI;
                    |SI #10para1 = "Vacaciones"; aValor = "Vacaciones"; |FINSI;
                    |SI #10para1 = "Huelga    "; aValor = "Huelga"; |FINSI;
                    |SI para1 = 186;
                         aCampo = "prestacion1";
                         aP1 = aValor;
                    |FINSI;
                    |SI para1 = 187;
                         aCampo = "prestacion11";
                         aP11= aValor;
                    |FINSI;
                    |SI para1 = 188;
                         aCampo = "prestacion2";
                         aP2 = aValor;
                    |FINSI;
                    |SI para1 = 189;
                         aCampo = "prestacion21";
                         aP21 = aValor;
                    |FINSI;
                    |HAZ ultimodia1;
                    |SI #0#10 ! 2;
                         |SI para1 = 186;
                              aCampo = "prestacion1_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP1_del = aValor;
                              aCampo = "prestacion1_al";   aValor = #10para3;
                              aP1_al = aValor;
                         |FINSI;
                         |SI para1 = 187;
                              aCampo = "prestacion11_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP11_del = aValor;
                              aCampo = "prestacion11_al";   aValor = #10para3;
                              aP11_al = aValor;
                         |FINSI;
                         |SI para1 = 188;
                              aCampo = "prestacion2_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP2_del = aValor;
                              aCampo = "prestacion2_al";   aValor = #10para3;
                              aP2_al = aValor;
                         |FINSI;
                         |SI para1 = 189;
                              aCampo = "prestacion21_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP21_del = aValor;
                              aCampo = "prestacion21_al";   aValor = #10para3;
                              aP21_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
     |SI nEnfer > 0;
          |SI nEnfer = 1;
               aCampo = "prestacion1_mes";  aValor = #10#103;
               aNume = aValor;
               |HAZ Formatea;
               aValor = aNume;
               aP1_mes = aValor;
          |SINO;
               aCampo = "prestacion11_mes";  aValor = #10#103;
               aNume = aValor;
               |HAZ Formatea;
               aValor = aNume;
               aP11_mes = aValor;
          |FINSI;
     |FINSI;
     |SI nAccid > 0;
          |SI nAccid = 1;
               aCampo = "prestacion2_mes";  aValor = #10#104;
               aNume = aValor;
               |HAZ Formatea;
               aValor = aNume;
               aP2_mes = aValor;
          |SINO;
               aCampo = "prestacion21_mes";  aValor = #10#104;
               aNume = aValor;
               |HAZ Formatea;
               aValor = aNume;
               aP2_mes = aValor;
          |FINSI;
     |FINSI;
     |SI #10#198 ! 0; |Y #nomcontr#47 ! "T";
          aCampo = "prestacion21";
          nNume = #10#198;
          |SI #nomcontr#70 = "H";
               |HAZ HorasAbs;
               || xxxxxxxxxxx
               |SI nTotalHorasAbs ! 0;
                    nNume = nTotalHorasAbs;
               |FINSI;
          |FINSI;
          aValor = nNume;
          aValor = "ABSENTISMO: " + aValor;
          |SI #nomcontr#70 = "H";
               aValor = aValor + " hora";
          |SINO;
               aValor = aValor + " dia";
          |FINSI;
          |SI nNume > 1; aValor = aValor + "s"; |FINSI;

          || esto que viene ahora lo hago para que el absentismo
          || salga donde haya hueco
          |QBF aP1;
          |SI aP1 = "";
               aP1 = aValor;
               aNume = #10#199;
               |HAZ Formatea;
               aValor = aNume;
               aP1_mes = aValor;
               |ACABA;
          |FINSI;

          |QBF aP11;
          |SI aP11 ="";
               aP11 = aValor;
               aNume = #10#199;
               |HAZ Formatea;
               aValor = aNume;
               aP11_mes = aValor;
               |ACABA;
          |FINSI;

          |QBF aP2;
          |SI aP2 ="";
               aP2 = aValor;
               aNume = #10#199;
               |HAZ Formatea;
               aValor = aNume;
               aP2_mes = aValor;
               |ACABA;
          |FINSI;

          |QBF aP21;
          |SI aP21 ="";
               aP21 = aValor;
               aNume = #10#199;
               |HAZ Formatea;
               aValor = aNume;
               aP21_mes = aValor;
               |ACABA;
          |FINSI;
     |FINSI;
     |MODULO aAlfa;
     |SI aAlfa = "nomareci"; |Y #nomareci#8 = 2;
          aP1_del = "";
          aP1_al = "";
          aP11_del = "";
          aP11_al = "";
          aP2_del = "";
          aP2_al = "";
          aP21_del = "";
          aP21_al = "";
     |FINSI;
|FPRC;

|PROCESO ImpCrystal;     || procesos necesarios para impresion de la nomina
                         || en Crystal Reports
     |SI Impresora = "CrystalReport"; |O #0#69 = "P"; |O nOpcion = 2;
          |HAZ agidanifCR;       ||Datos personales para Crystal Reports
          |HAZ CargaIndemnizaCR;   ||Prestaciones e indemnizaciones Crystal Reports
          |HAZ BuscaBanco;
          |SI #0#9 = 2;
               #labempre#07 = #labcentr#07;
               #labempre#08 = #labcentr#08;
               #labempre#06 = #labcentr#06;
          |FINSI;
          |HAZ c400;
     |FINSI;
|FPRC;

|PROCESO CrystalDescComp;
     |SI Impresora = "CrystalReport"; |O nOpcion = 2;
          |SI concep = 511; #10camdesc = "Comp. Enfermedad";      |FINSI;
          |SI concep = 512; #10camdesc = "Comp. Accidente";       |FINSI;
          |SI concep = 513; #10camdesc = "Comp. Maternidad";      |FINSI;
          |SI concep = 514; #10camdesc = "Comp. ILT";             |FINSI;
          |SI concep = 515; #10camdesc = "Enfermedad Empresa";    |FINSI;
          |SI #labtraba#247 = 138;
               |SI concep = 512; #10camdesc = "Prestaci¢n Acc. Empresa";       |FINSI;
               |SI concep = 515; #10camdesc = "Prestaci¢n Enf. Empresa";    |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaCrystal;
     |ABRE #labempre;
     #labempre#0 = 00014;
     |LEE 000#labempre.=;
     aAlfa = #labempre#2;     || esto es una barbaridad para que si estoy
     |CIERRA #labempre;
     |QBF aAlfa;              || en Qualitas no me copie la nomina ya que no
     |SI aAlfa = "VICENTE NAVARRO CERDAN";
          |ACABA;             || funcionaba bien en FABRE por algun motivo que
     |FINSI;                  || esta por descubrir, cuando se resuelva quitare esto

     |DBASE aAlfa1;
     aAlfa1 = aAlfa1 + "def/nomycrys.rpt";
     aAlfa1 = "rb  " + aAlfa1;
     |FABRE aAlfa1;
     |SI FSalida < 0;
          |DBASE aAlfa1;
          aAlfa1 = aAlfa1 + "plantillas/nomycrys.r00";
          |DBASE aAlfa2;
          aAlfa2 = aAlfa2 + "def/nomycrys.rpt";
          |COPIA_FICHERO aAlfa1, aAlfa2;
     |FINSI;
     |FCIERRA aAlfa1;
|FPRC;

|PROCESO c400;
     |ACABA;
     |SI #nomcontr#53 ! "S";
          |ACABA;
     |FINSI;
     |SI #0#67 ! "M"; |Y #0#67 ! "H";   || ni en atrasos ni en atrasos hist.
          |ACABA;
     |FINSI;

     |ABRE #nom400eu;

     #nom400eu#0 = #nomtrnom#1;
     #nom400eu#1 = #nomtrnom#2;
     #nom400eu#2 = 2008;
     #nom400eu#3 = #0#5;
     |LEE 000#nom400eu.=;
     |SI FSalida = 0;
          |SI #0#68 = "N";
               |SI #0#10 ! 2;
                    nNume = #nom400eu#10 + #nom400eu#27 + #nom400eu#33;
                    |SI #labempre#25 = 2;    || paga junto mes
                         nNume = nNume + #nom400eu#13;
                    |FINSI;
                    |SI #labempre#39 = 1;    || finiquito junto mes
                         nNume = nNume + #nom400eu#21;
                    |FINSI;
               |SINO;
                    nNume = #nom400eu#21;
               |FINSI;
          |FINSI;
          |SI #0#68 = "P";
               nNume = #nom400eu#13;
          |FINSI;
          |SI #0#68 = "F";
               nNume = #nom400eu#21;
          |FINSI;
          aAlfa = nNume;
          |QBF aAlfa;
          aAlfa = "Importe deducci¢n de retenci¢n IRPF: " + aAlfa + " euros.";
          #nomtrnom#200 = aAlfa;
          || aqui se construiria el comentario
     |FINSI;
     |CIERRA #nom400eu;
|FPRC;


/********************** COMENTARIOS EN LA NOMINA ****************************/

|PROCESO CamposComen;
     || aqui contruyo comentario
     aComen1 = #nomtrnom#201; |QBF aComen1;
     aComen2 = #nomtrnom#202; |QBF aComen2;
     aComen3 = #nomtrnom#203; |QBF aComen3;
     aComen4 = #nomtrnom#204; |QBF aComen4;

     |SI aComen1 = ""; #nomtrnom#201 = aComen; |ACABA; |FINSI;
     |SI aComen2 = ""; #nomtrnom#202 = aComen; |ACABA; |FINSI;
     |SI aComen3 = ""; #nomtrnom#203 = aComen; |ACABA; |FINSI;
     |SI aComen4 = ""; #nomtrnom#204 = aComen; |ACABA; |FINSI;
|FPRC;

|PROCESO ConstruyeCom;
     |SI #nomcom04#11 ! "*"
          aLinea = #nomcom02#2;
     |SINO;
          aLinea = #nomcom05#5;
     |FINSI;
     |QBF aLinea;
     aComen = aComen + aLinea + " ";
|FPRC;

|DEFBUCLE LeeCom2;
     #nomcom05#1;
     ;
     #labtraba#0, nAny, nMes, #nomcom04#3, 001;
     #labtraba#0, nAny, nMes, #nomcom04#3, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|DEFBUCLE LeeCom;
     #nomcom02#1;
     ;
     #nomcom04#9, 001;
     #nomcom04#9, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|DEFBUCLE LeeComGen;
     #nomcom02#1;
     ;
     #nomcom07#9, 001;
     #nomcom07#9, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|PROCESO LeeCom;
     aComen = "";

     |SI nTipo = 0;
          aNomSN = #nomcom07#12;
          aPagSN = #nomcom07#13;
          aAtrSN = #nomcom07#14;
          aFinSN = #nomcom07#15;
     |SINO;
          aNomSN = #nomcom04#12;
          aPagSN = #nomcom04#13;
          aAtrSN = #nomcom04#14;
          aFinSN = #nomcom04#15;
     |FINSI;

     |SI #0#67 = "A"; |O #0#67 = "T";
          |SI aAtrSN ! "X";
               |ACABA;
          |FINSI;
     |SINO;
          |SI #0#68 = "N"; |Y aNomSN ! "X";
               |ACABA;
          |FINSI;
          |SI #0#68 = "P"; |Y aPagSN ! "X";
               |ACABA;
          |FINSI;
          |SI #0#68 = "F"; |Y aFinSN ! "X";
               |ACABA;
          |FINSI;
     |FINSI;

     |SI nTipo = 0;
          |BUCLE LeeComGen;
     |SINO;
          |SI #nomcom04#11 ! "*"
               |BUCLE LeeCom;
          |SINO;
               |BUCLE LeeCom2;
          |FINSI;
     |FINSI;

     |SI aComen ! "";
          |HAZ CamposComen;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaComTra;
     #nomcom04#1;
     4, 7;
     #labtraba#0, nAny, nMes, 001, nTipo, #labtraba#1;
     #labtraba#0, nAny, nMes, 999, nTipo, #labtraba#1;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComCat;
     #nomcom04#1;
     4, 5;
     #labtraba#0, nAny, nMes, 001, nTipo, #labtraba#17;
     #labtraba#0, nAny, nMes, 999, nTipo, #labtraba#17;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComEmp;
     #nomcom04#1;
     4;
     #labtraba#0, nAny, nMes, 001, nTipo;
     #labtraba#0, nAny, nMes, 999, nTipo;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComGen;
     #nomcom07#1;
     ;
     nAny, nMes, 001;
     nAny, nMes, 999;
     ;
     NULL, LeeCom;
|FIN;

|PROCESO ComentMes;
     nAny = #0#4 + 2000;
     nLinea = 0;
     nTipo = 0;
     nMes = 0;
     |BUCLE BuscaComGen;
     nMes = #0#5;
     |BUCLE BuscaComGen;

     nTipo = 1;
     nMes = 0;
     |BUCLE BuscaComEmp;
     nMes = #0#5;
     |BUCLE BuscaComEmp;
/*
     nTipo = 2;
     nMes = 0;
     |BUCLE BuscaComCat;
     nMes = #0#5;
     |BUCLE BuscaComCat;
*/
     nTipo = 2;
     nMes = 0;
     |BUCLE BuscaComTra;
     nMes = #0#5;
     |BUCLE BuscaComTra;
|FPRC;

|PROCESO Comentarios;
     #nomtrnom#201 = "";
     #nomtrnom#202 = "";
     #nomtrnom#203 = "";
     #nomtrnom#204 = "";
     |HAZ ComentMes;
|FPRC;

|PROCESO LineasDto;
     swSigue = 0;
     |SI #0#69 = "A";
          |SI Impresora = "CrystalReport"; |O nOpcion = 2;
               swSigue = 1;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          ninguno = ninguno + 1;
          infctos = 601;
          infptas = #10#116;
          infdesc = "-PRESTACIONES SEG. SOCIAL";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "R";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 602;
          infptas = #10#160;
          infdesc = #10#169; |QBF infdesc;
          |SI infdesc = ""; infdesc = "ANTICIPOS"; |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 603;
          infptas = #10#161;
          infdesc = #10#170; |QBF infdesc;
          |SI infdesc = ""; infdesc = "ANTICIPOS"; |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 604;
          infptas = #10#196;
          infdesc = #10#197; |QBF infdesc;
          |SI infdesc = ""; infdesc = "ANTICIPOS"; |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 605;
          infptas = #10#140;
          infdesc = #10#171; |QBF infdesc;
          |SI infdesc = ""; infdesc = "EN ESPECIE"; |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          |SI #0#68 = "P";
               ninguno = ninguno + 1;
               infctos = 605;      || ant. paga extra los meto en el concepto
                                   || de la especie, que en pagas no hay
               infptas = #10#175;
               infdesc = #10#176; |QBF infdesc;
               |SI infdesc = ""; infdesc = "ANTICIPOS"; |FINSI;
               infunid = 0;
               infunia = 0;
               infvalo = 0;
               infporc = 0;
               retoded = "D";
               |SI infptas ! 0; |PRINT; |FINSI;
          |FINSI;

          ninguno = ninguno + 1;
          infctos = 606;
          infptas = nEmbargo;
          infdesc = "EMBARGOS";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 607;
          infptas = #10#131;
          infdesc = "SEG. SOCIAL CONT. COMUNES";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#127;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 608;
          infptas = #10#164;
          infdesc = "COTIZACION DESEMPLEO";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#162;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 609;
          infptas = #10#165;
          infdesc = "COTIZACION FORMACION";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#163;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 610;
          infptas = #10#138;
          infdesc = "RETENCION I.R.P.F.";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#135;
          retoded = "D";
          ||SI infptas ! 0; |PRINT; |FINSI;
          |PRINT;

          ninguno = ninguno + 1;
          infctos = 611;
          infptas = #10#133;
          infdesc = "HORAS EXTRAS ESTRUCTURALES";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 612;
          infptas = #10#134;
          infdesc = "HORAS EXTRAS NO ESTRUCTURALES";
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          |HAZ CargaIndemnizaCR;   || Periodos de IT

          aMes = #0#5; |QBF aMes; aMes = ("00" + aMes) % -102;

          |QBF aP1;

          ninguno = ninguno + 1;
          infctos = 651;
          infptas = 0;
          infdesc = aP1 + " del " + aP1_del + "/" + aMes + " al " + aP1_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP1 ! ""; |PRINT; |FINSI;

          |QBF aP11;
          ninguno = ninguno + 1;
          infctos = 652;
          infptas = 0;
          infdesc = aP11 + " del " + aP11_del + "/" + aMes + " al " + aP11_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP11 ! ""; |PRINT; |FINSI;

          |QBF aP2;
          ninguno = ninguno + 1;
          infctos = 653;
          infptas = 0;
          infdesc = aP2 + " del " + aP2_del + "/" + aMes + " al " + aP2_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP2 ! ""; |PRINT; |FINSI;

          |QBF aP21;
          ninguno = ninguno + 1;
          infctos = 654;
          infptas = 0;
          infdesc = aP21 + " del " + aP21_del + "/" + aMes + " al " + aP21_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP21 ! ""; |PRINT; |FINSI;

          infctos = 000;
          infdesc = "";
     |FINSI;
|FPRC;

|PROCESO Cotizaciones;
     swSigue = 0;
     |SI #0#69 = "A";
          |SI Impresora = "CrystalReport"; |O nOpcion = 2;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;

          |SI infctos < 400;
               infdesc = "*" + infdesc;
          |FINSI;
          |SI infctos ] 400; |Y infctos < 599;
               |ABRE #nomconli;
               #nomconli#0 = #labtraba#87;
               #nomconli#2 = infctos;
               |LEE 000#nomconli.=;
               |SI FSalida = 0; |Y #nomconli#11 = "S"; |Y #nomconli#12 = 7;
                    infdesc = "*" + infdesc;
               |SINO;
                    infdesc = "-" + infdesc;
               |FINSI;
               |CIERRA #nomconli;
          |FINSI;
          |SI infctos > 500;
               infunid = 0;
               infunia = 0;
               infvalo = 0;
               infporc = 0;
               |QBF infdesc;
               |SI infdesc = "-ENF.EMP.";
                    infdesc = "-PRESTACIONES EMPRESA";
               |FINSI;
               |SI infdesc = "-COMP.ENF";
                    infdesc = "-COMPLEMENTO";
               |FINSI;
          |FINSI;
     |FINSI;
     |SI infctos = 101; |Y #nomcont3#1 = "S";
          |ABRE #nomcatli;
          #nomcatli#0 = #labtraba#87;
          #nomcatli#1 = #labtraba#17;
          #nomcatli#2 = infctos;
          |LEE 000#nomcatli.=;
          |SI FSalida = 0;
               aAlfa = #nomcatli#3;
               |QBT aAlfa;
               |SI aAlfa = "1";
                    infvalo = (infvalo / #10#19) ! 2;
                    infunid = #10#19;
               |FINSI;
          |FINSI;
          |CIERRA #nomcatli;
     |FINSI;
|FPRC;

/******************* PROCESOS PARA QUE SALTE EL GESTOR **********************/
/************************ DE INCIDENCIAS DEL IRPF ***************************/

|PROCESO nomgir00;
     |SI aParam = "AUTO";
          |ACABA;
     |FINSI;

     aAlfa = Usuario;         |QBF aAlfa;
     aAlfa = "m" +  aAlfa;
     |NOME_DAT #nomgir00#aAlfa#;
     |DELINDEX #nomgir00;
     |ABRE #nomgir00;

     |PARA nCampo = 0; |SI nCampo [ 3; |HACIENDO nCampo = nCampo + 1;
          #nomgir00#nCampo# = #nomrecib#nCampo#;
     |SIGUE;
     #nomgir00#4 = 001;    || convenio
     #nomgir00#5 = 999;
     #nomgir00#6 = 001;    || categoria
     #nomgir00#7 = 999;
     #nomgir00#8 = #nomrecib#5;
     nNume = #nomrecib#4;
     nNume = nNume + 2000;
     #nomgir00#9 = nNume;
     #nomgir00#20 = 1;     || clave fija
     |PARA nCampo = 21; |SI nCampo [ 62; |HACIENDO nCampo = nCampo + 1;
          #nomgir00#nCampo# = #nomrecib#nCampo#;
     |SIGUE;
     |PARA nCampo = 63; |SI nCampo [ 70; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo + 7;
          #nomgir00#nCampo# = #nomrecib#nCampo1#;
     |SIGUE;
     |SI #0#69 = "P";
          |PARA nCampo = 23; |SI nCampo [ 70; |HACIENDO nCampo = nCampo + 1;
               #nomgir00#nCampo# = #nomrecib#nCampo#;
          |SIGUE;
          #nomgir00#21 = #nomrecib#11;
          #nomgir00#42 = #nomrecib#12;
     |FINSI;
     |GRABA 000#nomgir00.n;
     |CIERRA #nomgir00;

     |SUB_EJECUTA "nomgir00;nomrecib";
|FPRC;

|| PROCESO PARA BUSCAR SI EL TRABAJADOR TIENE INCIDENCIAS DE IRPF
|| PENDIENTES DE VALIDAR

|PROCESO nomgirli;
     |SI #nomgirli#9 = "N";
          swHayIncid = swHayIncid + 1;
     |FINSI;

     #nomir009#0 = nEmp;
     |LEE 000#nomir009.=;
     |SI FSalida = 0;
          |SI #nomir009#21 = 0;
               |ACABA;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI #0#68 = "N"; |Y #nomgirco#1 = "S";
          |SI #nomgirli#9 = "N";
               swStop = swStop + 1;
               swHayIncid = swHayIncid - 1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomgirli;
     #nomgirli#1;
     ;
     nEmp, nAny, #0#5, aDesdeClave;
     nEmp, nAny, #0#5, aHastaClave;
     ;
     NULL, nomgirli;
|FIN;

|PROCESO IncidIRPF;
     swStop = 0;

     |DDEFECTO #nomgirco;
     |ABRE #nomgirco; |LEE 000#nomgirco.p;  |CIERRA #nomgirco;

     |DDEFECTO #nomir009;
     |ABRE #nomir009;

     nAny = #0#4;
     nAny = nAny + 2000;
     aClave = nTra;
     aClave = ("00000" + aClave) % -105;
     aDesdeClave = aClave + ".001";
     aHastaClave = aClave + ".999";
     |BUCLE nomgirli;

     |CIERRA #nomir009;
|FPRC;

|PROCESO AvisoIRPF;
     aParam2 = aParam2 % -102;
     |SI nTraNoEmi ! 0;
          aAlfa = nTraNoEmi;
          |SI nTraNoEmi = 1;
               aAlfa = "    ATENCION: No se ha impreso " + aAlfa + " nómina";
          |SINO;
               aAlfa = "    ATENCION: No se han impreso " + aAlfa + " nóminas";
          |FINSI;
          aAlfa = aAlfa + " por incidencias de nivel 2 en el IRPF. Pulse OK para ver el informe.";
          |MENAV aAlfa;

          nAny = #0#4 + 2000;
          |SUB_EJECUTA "nomgirin;nomrecib";
     |FINSI;
     |SI swHayIncid ! 0;
          |SI aParam2 = "PI";
               aAlfa = "    ATENCION: existen empresas con incidencias en el IRPF";
               aAlfa = aAlfa + " y el gestor de incid. está desactivado. Consulte: ";
               |MENAV aAlfa;

               aAlfa = "     Emisión de Recibos de Salarios / Emisión de Nóminas del Mes Actual / ";
               aAlfa = aAlfa + "Informe Incidencias IRPF";
               |MENAV aAlfa;
          |SINO;
               aAlfa = "    ATENCION: existen empresas con incidencias en el IRPF ";
               aAlfa = aAlfa + "y el gestor de incidencias está desactivado. ";
               |MENAV aAlfa;

               aAlfa = "Proceso Mensual / Informe Incidencias IRPF";
               aAlfa = "    Consulte la opción " + aAlfa + " para comprobarlas.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************** MENSAJE DE ENVIO AL DSARCHI *******************************/
/****************************************************************************/

|PROCESO Mensaje;
     aEmp = "                                             ";
     aCen = "                                             ";
     aTra = "                                             ";

     aAlfa = #nomtrnom#1;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aNomEmp = #nomtrnom#3;
     aNomEmp = aNomEmp % 126;
     aEmp = "Empresa: " + aAlfa + " - " + aNomEmp;
     aEmp = " " + aEmp + " ";

     aCen = " Archivando nóminas ... ";
     aCen = aCen + "                            ";
     aCen = aCen % 145;

     nTra = #nomtrnom#2;
     aAlfa = nTra;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aNomTra = #nomtrnom#6;
     aNomTra = aNomTra % 126;
     aTra = "Trabaj.: " + aAlfa + " - " + aNomTra;
     aTra = " " + aTra + " ";

               ||  1 2        3         4         5          6
               ||  890123456789012345678901234567890123456789012
     |ATRI R;
     |PINTA 1318, "      - Procesando archivo de nóminas -      ";
     |PINTA 1418, aEmp;
     |PINTA 1518, aCen;
     |PINTA 1618, aTra;
     |ATRI 0;
|FPRC;

|PROCESO ConfCuadre;
     aCuadre = nCuadre;
     aCuadre = ("00" + aCuadre) % -102;
     |SI #0#69 ! "A";
          aCuadre = "nomycrys.d" + aCuadre;
     |SINO;
          aCuadre = "nomyabie.e" + aCuadre;
     |FINSI;

     |DDEF aDef;
     |QBF aDef;
     aOrigen = aDef + aCuadre;
     |SI #0#69 ! "A";
          aDestino = aDef + "nomycrys.inf";
     |SINO;
          aDestino = aDef + "nomyabie.inf";
     |FINSI;

     |COPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
          aAlfa = "    No se ha encontrado el cuadre " + aOrigen;
          |MENAV aAlfa;
          nEmpCuad = 0;
          |ACABA;
     |FINSI;

     aCuadre = nCuadre;
     aCuadre = ("00" + aCuadre) % -102;
     |SI #0#69 ! "A";
          aCuadre = "nomycrys.r" + aCuadre;
     |SINO;
          aCuadre = "nomyabie.r" + aCuadre;
     |FINSI;

     |DBASE aDef;
     |QBF aDef;
     aOrigen = aDef + "plantillas/" + aCuadre;
     |SI #0#69 ! "A";
          aDestino = aDef + "def/nomycrys.rpt";
     |SINO;
          aDestino = aDef + "def/nomyabie.rpt";
     |FINSI;

     |COPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
          aAlfa = "    No se ha encontrado el cuadre " + aOrigen;
          |MENAV aAlfa;
          nEmpCuad = 0;
     |FINSI;
|FPRC;

|PROCESO cuadre_emp;
     nEmpCuad = 0;
     |DDEF aDef;
     |QBF aDef;
     aDestino = aDef + "nomycrys.infcop";
     |FBORRA aDestino;
     aDestino = aDef + "nomycrys.rptcop";
     |FBORRA aDestino;

     |ABRE #nomcuadr; |LEE 000#nomcuadr.p; |CIERRA #nomcuadr;

     |ABRE #nomcuadr;
     |LEE 000#nomcuadr.p;
     aAlfa = #nomcuadr#6;
     |QBF aAlfa;
     |SI aAlfa ! "ABR2015";
          |SI #nomcuadr#4 = 32;
               #nomcuadr#4 = 82;
          |SINO;
               |SI #nomcuadr#4 ! 00; |Y #nomcuadr#4 ! 05;
                    #nomcuadr#4 = 00;
               |FINSI;
          |FINSI;
          #nomcuadr#6 = "ABR2015";
          |GRABA 020#nomcuadr.a;
          |LIBERA #nomcuadr;
     |FINSI;
     |CIERRA #nomcuadr;

     |SI #nomcuadr#4 = -1;
          nCuadre = #nomcuadr#4;
          |ACABA;
     |FINSI;
     |SI #0#69 ! "A";
          nCuadre = #nomcuadr#4;
     |SINO;
          nCuadre = #nomcuadr#5;
     |FINSI;
     |HAZ ConfCuadre;

     |SI nCuadre = 00; |O nCuadre = 05; |O nCuadre = 82;
          |ACABA;
     |FINSI;
     |SI #0#69 = "A";
          |SI nCuadre = 31;
               |ACABA;
          |FINSI;
     |FINSI;

     nEmpCuad = 0;

     |ABRE #labclean;
     #labclean#0 = "labempre";
     #labclean#1 = 132;
     |LEE 000#labclean.=;
     |SI FSalida ! 0;         || SI EL CAMPO NO ESTA INICIALIZADO
          |ACABA;             || NO PASES POR AQUI
     |FINSI;
     |CIERRA #labclean;

     swSigue = 1;
     |SI #0#21 = 0;
          |SI #0#0 ! #0#1;
               swSigue = 0;
          |SINO;
               nEmpCuad = #0#0;
          |FINSI;
     |SINO;
          nEmpCuad = #0#21;
          |PARA nCampo = 21; |SI nCampo [ 40; |HACIENDO nCampo = nCampo + 1;
               |SI nCampo = 27; nCampo = 28; |FINSI;
               |SI nCampo = 34; nCampo = 35; |FINSI;
               |PARA nCampo1 = nCampo; |SI nCampo1 [ 40; |HACIENDO nCampo1 = nCampo1 + 1;
                    |SI #0nCampo ! #0nCampo1; |Y #0nCampo ! 0; |Y #0nCampo1 ! 0;
                         swSigue = 0;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |SIGUE;
     |FINSI;

     |SI swSigue = 0;
          nEmpCuad = 0;
          |ACABA;
     |SINO;
          |ABRE #labempre;
          #labempre#0 = nEmpCuad;
          |LEE 000#labempre.=;
          |CIERRA #labempre;
     |FINSI;

     |ABRE #nomcuadr; |LEE 000#nomcuadr.p; |CIERRA #nomcuadr;

     |SI #nomcuadr#4 ! #labempre#132; |Y #labempre#132 ! -1;
          |DDEF aDef;
          |QBF aDef;
          aOrigen = aDef + "nomycrys.inf";
          aDestino = aDef + "nomycrys.infcop";
          |COPIA_FICHERO aOrigen, aDestino;
          aOrigen = aDef + "nomycrys.rpt";
          aDestino = aDef + "nomycrys.rptcop";
          |COPIA_FICHERO aOrigen, aDestino;

          nCuadre = #labempre#132;
          |HAZ ConfCuadre;
     |FINSI;
|FPRC;

|PROCESO recupera_cuadres;
     |SI nEmpCuad ! 0;
          |DDEF aDef;
          |QBF aDef;
          aOrigen = aDef + "nomycrys.infcop";
          aDestino = aDef + "nomycrys.inf";
          |COPIA_FICHERO aOrigen, aDestino;
          aOrigen = aDef + "nomycrys.rptcop";
          aDestino = aDef + "nomycrys.rpt";
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

/****************************************************************************/
/*                 GRABACION DEL REGISTRO DE NOMINAS IMPRESAS               */
/****************************************************************************/

|PROCESO IniciaRegistro;
     |ABRE #nomnomin;
     |SELECT #2#nomnomin;
     |LEE 000#nomnomin.u;
     |SI FSalida = 0;
          nEmision = #nomnomin#12;
     |SINO;
          nEmision = 0;
     |FINSI;
     nEmision = nEmision + 1;
     |CIERRA #nomnomin;
|FPRC;

|PROCESO ActualizaRegistro;
     #nomnomin#10 = aHora;
     #nomnomin#11 = nContador2;
     |GRABA 000#nomnomin.a;
|FPRC;

|DEFBUCLE ActualizaRegistro;
     #nomnomin#2;
     ;
     nEmision;
     nEmision;
     ;
     NULL, ActualizaRegistro;
|FIN;

|PROCESO TerminaRegistro;
     |HORA aHora;
     |BUCLE ActualizaRegistro;
|FPRC;

|PROCESO nomnomin;
     nUltimo = #nomnomin#5;
|FPRC;

|DEFBUCLE nomnomin;
     #nomnomin#1;
     ;
     #10#1, #10#2, #10#18, #0#5, nTipoNom, 01;
     #10#1, #10#2, #10#18, #0#5, nTipoNom, 99;
     ;
     NULL, nomnomin;
|FIN;

|PROCESO GuardaRegistro;
     |ABRE #nomnomin;
     |SELECT #1#nomnomin;

     |SI #0#68 = "N";
          nTipoNom = 0;       || nomina mes
     |FINSI;
     |SI #0#68 = "P";
          nTipoNom = 1;       || paga
     |FINSI;
     |SI #0#68 = "F"; |O #0#10 = 2;
          nTipoNom = 2;       || finiquito
     |FINSI;

     nUltimo = 0;
     |BUCLE nomnomin;    || busco el ultimo, simepre acabo igual
     nRegistro = nUltimo + 1;

     #nomnomin#0 = #10#1;     || empresa
     #nomnomin#1 = #10#2;     || trabajador
     #nomnomin#2 = #10#18;    || a¤o
     #nomnomin#3 = #0#5;      || mes
     #nomnomin#4 = nTipoNom;  || tipo nomina
     #nomnomin#5 = nRegistro; || contador

     #nomnomin#6 = #10#6;     || nombre trabajador
     aAlfa = Usuario % 0810;
     #nomnomin#7 = aAlfa;   || usuario

     fFecha = ~;
     #nomnomin#8 = fFecha;
     |HORA aHora;
     #nomnomin#9 = aHora;
     #nomnomin#10 = "XX:XX:XX";
     #nomnomin#11 = 99999;
     #nomnomin#12 = nEmision;
     |GRABA 020#nomnomin.n;
     |LIBERA #nomnomin;
     |CIERRA #nomnomin;
|FPRC;

|PROCESO comple_1PagMensu;       || CONSTRUYE LITERALES DATOS EMPRESA
     |SI #0#9 = 1; alfa1 = #1#03; |SINO; alfa1 = #6#03; |FINSI;
     |QBF alfa1;
     |SI #0#9 = 1; alfa2 = #1#04; |SINO; alfa2 = #6#04; |FINSI;
     |QBF alfa2;
     |SI #0#9 = 1; alfa3 = #1#05; |SINO; alfa3 = #6#05; |FINSI;
     |QBF alfa3;
     domemp = alfa1 + " " + alfa2 + " " + alfa3;  || domicilio empresa
     |SI #0#9 = 1; alfa1 = "00" + #1#07; |SINO; alfa1 = "00" + #6#07; |FINSI;
     alfa1 = alfa1 % -102;
     |SI #0#9 = 1; alfa2 = "000" + #1#08;|SINO; alfa2 = "000" + #6#08;|FINSI;
     alfa2 = alfa2 % -103;
     alfa3 = "(" + alfa1 + alfa2 + ") ";
     |SI #0#9 = 1; alfa1 = #1#06; |SINO; alfa1 = #6#06; |FINSI;
     |QBF alfa1;
     pobemp = alfa3 + alfa1;                      || poblacion empresa
     |SI #0#9 = 1; afili = #1#13; |SINO; afili = #6#10; |FINSI;
     |HAZ afili_agr_2;
     |SI #93#9 = 87;|O #93#9 = 85;|O #93#9 = 97; |O #93#9 = 64;|O #93#9 = 65;|O #93#9 = 421;
          |DDEFECTO #35;
          #35#0 = #2#0;
          #35#13 = #2#77;
          |SI #93#9 = 85;|O #93#9 = 97;|O #93#9 = 421;
               #35#1 = 87;
          |SINO;
               |SI #93#9 = 65;
                    #35#1 = 64;
               |SINO;
                    #35#1 = #93#9;
               |FINSI;
          |FINSI;
          |LEE 000#35=;
          afili = #35#10;
     |FINSI;
|FPRC;

|PROCESO EmbargoPaga;
/*
     |ABRE #nomimpr1;

     #nomimpr1#0 = #labtraba#0;
     #nomimpr1#1 = #labtraba#1;
     #nomimpr1#2 = #0#5;
     #nomimpr1#3 = 0;
     #nomimpr1#4 = #0#4 + 2000;
     |LEE 000#nomimpr1.=;
     |SI FSalida = 0; |Y #nomimpr1#10 ! 0;
          |SI #0#68 = "N";    || nomina
               |SI #0#67 = "M";    || desde mensual
                    nEmbargo = #nomcalca#104 - #nomimpr1#10;
               |FINSI;

               |SI #0#67 = "H";    || desde historico
                    nEmbargo = #nomhicca#146 - #nomimpr1#10;
               |FINSI;
          |FINSI;
          |SI #0#68 = "P";    || nomina
               |SI #0#67 = "M";    || desde mensual
                    nEmbargo = #nomimpr1#10;
               |FINSI;

               |SI #0#67 = "H";    || desde historico
                    nEmbargo = #nomimpr1#10;
               |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #nomimpr1;
*/
|FPRC;

|PROCESO Pluriempleo;
     |ABRE #nompluba;
     #nompluba#0 = #nomtrnom#1;
     #nompluba#1 = #nomtrnom#2;
     #nompluba#2 = #0#4 + 2000;
     #nompluba#3 = #0#5;
     #nompluba#4 = 0;
     |LEE 000#nompluba.=;
     |SI FSalida = 0;
          #nomtrnom#124 = #nompluba#6;
          #nomtrnom#206 = #nompluba#8;
     |FINSI;
     |CIERRA #nompluba;
|FPRC;

|PROCESO UnidadesConcepto;
     || esto solo en Malpesa de momento
     || conceptos 108 y 134

     |SI concep ! 108; |Y concep ! 134;
          |ACABA;
     |FINSI;

     swSigue = 0;

     nEmp = #labempre#0;

     #labempre#0 = 1;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          aAlfa = #labempre#10;
          |QBF aAlfa;
          |SI aAlfa = "A23016157";
               swSigue = 1;
          |FINSI;
     |FINSI;

     #labempre#0 = nEmp;
     |LEE 000#labempre.=;

     |SI swSigue = 1;
          |QBF descri;
          aAlfa1 = unidad; |QBF aAlfa; aAlfa2 = valor; |QBF aAlfa2;
          descri = descri + " (" + aAlfa1 + "u. x " + aAlfa2 + ")";
     |FINSI;
|FPRC;

/****************************************************************************/
/*************    PROCESOS PARA MOSTRAR EL RESUMEN DE HORAS    **************/
/****************************************************************************/

|PROCESO Horas;

|FPRC;

|PROCESO FuerzaFiniqSep;
     |HAZ BuscaModulo;

     |SI swModulo ! 2884; |Y swModulo ! 1;
          |ACABA;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/adade005.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labempre#0;
     |LEE 000#500=;
     |SI FSalida = 0;
          #labempre#39 = 3;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO HorasFormacion;
     nNume = 0;
     |SI #labtraba#45 = "421";
          |SI #0#67 = "M";
               nNume = #nomcalca#64;
          |FINSI;
          |SI #0#67 = "H";
               nNume = #nomhicca#64;
          |FINSI;
          |SI nNume ! 0;
               aAlfa = nNume;
               aAlfa = "HFB: " + aAlfa;
               #10#200 = aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  CAMPOS DE SEGURIDAD SOCIAL A CARGO DE LA EMPRESA ***********/
/****************************************************************************/

|PROCESO SS_Empresa;
     aAlfa = #labtraba#136;
     |SI #labtraba#136 ! "ESP"; |Y #labtraba#136 ! "FRA";
          #labtraba#136 = "ESP";
     |FINSI;

     |SI #0#67 = "M";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo - 35;
               #nomtrnom#nCampo# = #nomcalca#nCampo1#;
               |SI nCampo = 209;
                    |SI #nomcalca#164 ! 0; || cotizacion solidaridad
                         #nomtrnom#nCampo# = #nomcalca#164;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |SI #nomcalca#64 ! 0; |Y #nomtrnom#215 > 81;
               || tengo horas formacion bonificadas y estan guardadas
               || en el campo "bonificaciones" (bonif mayor que 80 euros
               || que es la cuota maxima a bonificar en formacion)
               #nomtrnom#215 = #nomtrnom#215 - #nomcalca#64;
          |FINSI;
          |HAZ HorasFormacion;

          #nomtrnom#216 = #nomcalca#79;
          #nomtrnom#224 = #nomcalca#80;

          |SI Impresora ! "CrystalReport";
          |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomcalca#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomcalca#40;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#67 = "H"; |O #0#67 = "T";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo + 7;
               #nomtrnom#nCampo# = #nomhicca#nCampo1#;
               |SI nCampo = 209;
                    |SI #nomhicca#206 ! 0; || cotizacion solidaridad
                         #nomtrnom#nCampo# = #nomhicca#164;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |SI #nomhicca#64 ! 0; |Y #nomtrnom#215 > 81;
               || tengo horas formacion bonificadas y estan guardadas
               || en el campo "bonificaciones" (bonif mayor que 80 euros
               || que es la cuota maxima a bonificar en formacion)
               #nomtrnom#215 = #nomtrnom#215 - #nomhicca#64;
          |FINSI;
          |HAZ HorasFormacion;

          #nomtrnom#216 = #nomhicca#121;
          #nomtrnom#224 = #nomhicca#122;
          |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomhicca#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomhicca#40;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#67 = "A";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo - 35;
               #nomtrnom#nCampo# = #nomtrnom#nCampo# + #nomcalac#nCampo1#;
          |SIGUE;
/*
          #nomtrnom#216 = #nomcalac#39 + #nomcalac#79;
          #nomtrnom#224 = #nomcalac#40 + #nomcalac#80;
*/
          |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomcalac#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomcalac#40;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
          |SI nOpcion = 0; |O nOpcion = 1;
               || bonificaciones en negativo en word
               #nomtrnom#215 = #nomtrnom#215 * (-1);
          |FINSI;
     |FINSI;

     || el total:
     #nomtrnom#223 = #nomtrnom#208 + #nomtrnom#209 + #nomtrnom#210;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#211 + #nomtrnom#212;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#214;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#215; || (bonif en negativo)

     || los tipos:
     /*
     #nomtrnom#217 = ((#nomtrnom#208 / #nomtrnom#216) * 100) ! 2; || cc
     #nomtrnom#218 = ((#nomtrnom#209 / #nomtrnom#224) * 100) ! 2; || Des
     #nomtrnom#219 = ((#nomtrnom#210 / #nomtrnom#224) * 100) ! 2; || Fog
     #nomtrnom#220 = ((#nomtrnom#211 / #nomtrnom#224) * 100) ! 2; || FP
     #nomtrnom#221 = ((#nomtrnom#212 / #nomtrnom#224) * 100) ! 2; || ATEP
     #nomtrnom#222 = ((#nomtrnom#214 / #nomtrnom#125) * 100) ! 2; || H.Ex.
     */
     #nomtrnom#217 = #nomconst#6;  || cc
     #nomtrnom#218 = #nomconst#12; || Des
     #nomtrnom#219 = #nomconst#14; || Fog
     #nomtrnom#220 = #nomconst#16; || FP
     |SI #nomconst#92 ! 0;
          #nomtrnom#218 = #nomconst#92; || Des
     |FINSI;
     |SI #nomtrnom#125 ! 0;
          #nomtrnom#222 = #nomconst#8;  || H.Ex.
     |FINSI;

     nElAny = #0#4 + 2000;
     nElMes = 1;
     |HAZ VerifCNAE;

     |ABRE #nomepigr;
     |DDEFECTO #nomepigr;
     #nomepigr#0  = nEpigConv;
     |LEE 000#nomepigr.=;            || lee epigrafe
     |SI FSalida = 0;
          #nomtrnom#221 = #nomepigr#1 + #nomepigr#2;   || ATEP
     |FINSI;
     |CIERRA #nomepigr;
|FPRC;

/****************************************************************************/
/**************  LITERALES DEL RECIBO, SEGUN IDIOMA   ***********************/
/****************************************************************************/

|PROCESO Literales;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aDestino = aContiene1; |QBF aDestino;
     aDestino = aDestino + "crystal/literales.dbf";

     |DFICB aOrigen; |QBF aOrigen;
     aOrigen = aOrigen + "nomlinom.dbf";
     aIP = ""; |IP_REMOTO aIP;

     |SI aIP = "";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          |ENVIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PARAMETROS DE RECIBO POR EMPRESA  **************************/
/****************************************************************************/

|PROCESO ParamEmpresa;
     |ABRE #nomcont1;
     |LEE 000#nomcont1.p;
     |SI FSalida ! 0;
          |DDEFECTO #nomcont1;
     |FINSI;
     |CIERRA #nomcont1;

     |ABRE #nomcont2;
     #nomcont2#0 = #labempre#0;
     |LEE 000#nomcont2.=;
     |SI FSalida = 0;
          |PARA nCampo = 1; |SI nCampo [ 16; |HACIENDO nCampo = nCampo + 1;
               #nomcont1#nCampo# = #nomcont2#nCampo#;
          |SIGUE;
     |FINSI;
     |CIERRA #nomcont2;
|FPRC;

/****************************************************************************/
/************* PAGAS PRORRATEADAS EN REMUNERACION Y NO EN PRORRATA **********/
/****************************************************************************/

|PROCESO PagasProrr;
     |SI concep ] 201; |Y concep [ 208; |Y #0#10 = 0;
          |ABRE #nomconca;
          #nomconca#0 = #2#87;
          #nomconca#2 = concep;
          |LEE 000#nomconca.=;
          |SI FSalida ! 0;
               |CIERRA #nomconca;
               |ACABA;
          |FINSI;

          numer = concep - 200 + 19;
          numerl = concep - 88;
          |SI #0#68 = "N"; |Y incluye = 1;
          |Y #labtraba#numerl# = "S"; |O #nomconca#numer# = 99;
               #10#119 = #10#119 + import;
               #10#120 = #10#120 - import;
          |FINSI;
          |CIERRA #nomconca;
     |FINSI;
|FPRC;
