|FICHEROS;
     vipe0011 #0;
     vipe0012 #12
     vipe0002;
     vipe0007 #7;

     labempre;
     labcentr;
     labtraba;
     vipe0017 #17;
|FIN;

|VARIABLES;
     aDia = "";
     nDia = 0;
     aMes = "";
     nMes = 0;
     aFecha = "";
     fFecha = @;
     aAny = "";
     nAny = 0;

     aAnyD = "";
     nAnyD = 0;
     aAnyH = "";
     nAnyH = 0;
     aMesD = "";
     nMesD = 0;
     aMesH = "";
     nMesH = 0;
     aAlfa = "";
     alfa1 = "";
     alfa2 = "";
     fech1 = @;
     fech2 = @;
     nNume = 0;
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     sdia = 0;
     smas = 0;
     sdife = 0;
     srest = 0;

     verrfec = "0000ATENCION !! Fecha erronea o formato incorrecto ";
     vdia1 = "";
     vme1 = "";
     vany1 = "";
     vdia = 0;
     vme = 0;
     vany = 0;
     vtope = 0;
     vsw = 0;
     vfec = "";
     vblanco = "          ";
     vpuntos = "..........";
     v = 0;
     mod = 0;

     swVengoDe = 0;
     nFechaDesde = 0;
     aFechaHasta = "";
     swCreaNueva = 0;
     nLinea = 0;
     nCampo = 0;
     nLineaAct = 0;
     swEstoy = 0;
     swCuenta = 0;
     nModo = 0;
     numer = 0;
     anynum = 0;
     bisiesto = 0;
     mesnum = 0;
     topemes = 0;
     FEstado = 0;

     &fFechaDesde = @;
     &fFechaHasta = @;

     nSemana = 0;
     aPrimeroMes = "";

     &nSemana1 = 0; &nSemana2 = 0; &nSemana3 = 0; &nSemana4 = 0; &nSemana5 = 0; &nSemana6 = 0;
     &fDesde1 = @; &fDesde2 = @; &fDesde3 = @; &fDesde4 = @; &fDesde5 = @; &fDesde6 = @;
     &fHasta1 = @; &fHasta2 = @; &fHasta3 = @; &fHasta4 = @; &fHasta5 = @; &fHasta6 = @;
     aHora = "";
     aParam = "";
|FIN;

|PROCESO Defectos; |TIPO 7;
     fFecha = ~;
     aFecha = fFecha;
     aAny = aFecha % -104;
     nAny = aAny;

     aMes = aFecha % 402;
     nMes = aMes;

     #0#3 = nMes;
     |PINTA #0#3;
     #0#2 = nAny;
     |PINTA #0#2;
|FPRC;

|PROCESO imprime;
     |PRINT;
|FPRC;

|DEFBUCLE impresion;
     #vipe0012#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, imprime;
|FIN;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
     numer = anynum $ 4;
     |SI numer = 0;
             bisiesto = 1;
     |SINO;
             bisiesto = 0;
     |FINSI;
     |SI mesnum =  1;  topemes = 31;            |FINSI;
     |SI mesnum =  2;  topemes = 28 + bisiesto; |FINSI;
     |SI mesnum =  3;  topemes = 31;            |FINSI;
     |SI mesnum =  4;  topemes = 30;            |FINSI;
     |SI mesnum =  5;  topemes = 31;            |FINSI;
     |SI mesnum =  6;  topemes = 30;            |FINSI;
     |SI mesnum =  7;  topemes = 31;            |FINSI;
     |SI mesnum =  8;  topemes = 31;            |FINSI;
     |SI mesnum =  9;  topemes = 30;            |FINSI;
     |SI mesnum = 10;  topemes = 31;            |FINSI;
     |SI mesnum = 11;  topemes = 30;            |FINSI;
     |SI mesnum = 12;  topemes = 31;            |FINSI;
|FPRC;

|PROCESO deshas; |TIPO 7;   || calcula segun semana, desde dia hasta dia
     nume2 = nSemana - smas;
     nume2 = (nume2 * 7) + (sdia - 1);   || dias hasta
     nume1 = nume2 - 6;                  || dias desde

     nume3 = #0#2;
     nume3 = nume3 - 1;
     alfa1 = "31.12." + nume3;    || saca los dias que hay hasta el 31.12
     fech1 = alfa1;
     nume3 = fech1;

     nume1 = nume1 + nume3;
     fech1 = nume1;         || fecha desde
     fFechaDesde = fech1;

     nume2 = nume2 + nume3;
     fech1 = nume2;         || fecha hasta
     fFechaHasta = fech1;

     aAlfa = fFechaDesde;
     aMesD = aAlfa % 402;
     nMesD = aMesD;
     aAnyD = aAlfa % -104
     nAnyD = aAnyD;

     aAlfa = fFechaHasta;
     aMesH = aAlfa % 402;
     nMesH = aMesH;
     aAnyH = aAlfa % -104
     nAnyH = aAnyH;

     |SI nMesD ! nMesH;
          aAlfa = aPrimeroMes;
          aMes = aAlfa % 402;
          nMes = aMes;
          aAny = aAlfa % -104;
          nAny = aAny;

          |SI nMesD = nMes;
               mesnum = nMesD;
               anynum = aAnyD;
               |HAZ ulti_dia;

               aAlfa = topemes;
               aAlfa = aAlfa + "." + aMesD + "." + aAnyD;
               fFechaHasta = aAlfa;
          |FINSI;
          |SI nMesH = nMes;
               aAlfa = "01" + "." + aMesH + "." + aAnyH;
               fFechaDesde = aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO mirasem; |TIPO 7;
     alfa1 = #0#2;
     alfa1 = "01.01." + alfa1;
     fech1 = alfa1;            || primero saca el dia de la semana
     fech2 = fech1 % 1;        ||/que fue el uno de enero
     alfa1 = fech2 % 11;

     |SI alfa1 = "Lunes";     sdia=1; smas=1; |FINSI;
     |SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
     |SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
     |SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
     |SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
     |SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
     |SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

     alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
     || fech1 = #0#4;
     fech1 = aPrimeroMes;

     alfa2 = fech1 % -104;
     alfa1 = alfa1 + ".01." + alfa2;
     fech1 = alfa1;
     nume1 = fech1;                 || calcula dias hasta primer lunes a¤o

     fech1 = aPrimeroMes;
     nume2 = fech1;

     sdife = nume2 - nume1;         || calcula la diferencia desde el primer
     |SI sdife ] 0;
          srest = sdife $ 7;           || lunes hasta la fecha actual,la redondea,
          sdife = sdife + (7 - srest); || la divide por 7 y le suma 1 por la
          nNume = (sdife / 7) + smas;|| primera semana (en su caso !!!)
          nSemana = nNume;
     |SINO;
          nNume = 1;
          nSemana = nNume;
     |FINSI;

     |SI nNume = 0; nNume = 52; |FINSI;
     nSemana = nNume;

     |HAZ deshas;
|FPRC;


|PROCESO QueSemana;
     aMes = #0#3;
     aMes = "00" + aMes; aMes = aMes % -102;
     aAny = #0#2;
     aAlfa = "01" + "." + aMes + "." + aAny;

     aPrimeroMes = aAlfa;
     || aAlfa = #vipe0002#5;
     |QBF aAlfa;
     |HAZ mirasem;

     nSemana1 = nSemana;
     fDesde1 = fFechaDesde;
     fHasta1 = fFechaHasta;

     nSemana = nSemana + 1;
     |HAZ deshas;
     nSemana2 = nSemana;
     fDesde2 = fFechaDesde;
     fHasta2 = fFechaHasta;

     nSemana = nSemana + 1;
     |HAZ deshas;
     nSemana3 = nSemana;
     fDesde3 = fFechaDesde;
     fHasta3 = fFechaHasta;

     nSemana = nSemana + 1;
     |HAZ deshas;
     nSemana4 = nSemana;
     fDesde4 = fFechaDesde;
     fHasta4 = fFechaHasta;

     nSemana = nSemana + 1;
     |HAZ deshas;
     nSemana5 = nSemana;
     fDesde5 = fFechaDesde;
     fHasta5 = fFechaHasta;

     nSemana = nSemana + 1;
     |HAZ deshas;
     nSemana6 = nSemana;
     fDesde6 = fFechaDesde;
     fHasta6 = fFechaHasta;
|FPRC;

|PROCESO LeeVarios;
     #vipe0007#0 = #vipe0002#0;
     #vipe0007#1 = #vipe0002#1;
     #vipe0007#3 = #vipe0002#3;
     #vipe0007#4 = #vipe0002#10;
     |LEE 000#vipe0007.=;

     #labempre#0 = #vipe0002#0;
     |LEE 000#labempre.=;

     #labtraba#0 = #vipe0002#0;
     #labtraba#1 = #vipe0002#1;
     |LEE 000#labtraba.=;

     #labcentr#0 = #vipe0002#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
|FPRC;

|PROCESO GrabaAcu;
     |PARA nCampo = 0; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          #17nCampo = #vipe0007#nCampo#;
     |SIGUE;
     |GRABA 000#17n;
|FPRC;

|PROCESO grabatmp;
     |HAZ LeeVarios;
     |DDEFECTO #12;

     #vipe0012#0 = #vipe0002#0;         || codigo empresa
     #vipe0012#1 = #vipe0002#1;         || codigo trabajador
     |LEE 101#vipe0012.=;
     FEstado = FSalida;

     #vipe0012#2 = #labtraba#77;        || centro
     #vipe0012#3 = #labempre#2;         || nombre empresa
     #vipe0012#4 = #labtraba#2;         || nombre trabajador
     #vipe0012#5 = #labcentr#2;         || nombre centro
     #vipe0012#6 = #vipe0007#5;           || dias trabajados
     #vipe0012#7 = #vipe0007#6;           || horas contrato

     |SI #vipe0002#7 = "N";
          |SI #vipe0002#4 = nSemana1;
               #vipe0012#8 = #vipe0012#8 + #vipe0002#9; || horas normales sem 1
          |FINSI;
          |SI #vipe0002#4 = nSemana2;
               #vipe0012#9 = #vipe0012#9 + #vipe0002#9; || horas normales sem 2
          |FINSI;
          |SI #vipe0002#4 = nSemana3;
               #vipe0012#10 = #vipe0012#10 + #vipe0002#9; ||horas normales sem 3
          |FINSI;
          |SI #vipe0002#4 = nSemana4;
               #vipe0012#11 = #vipe0012#11 + #vipe0002#9; ||horas normales sem 4
          |FINSI;
          |SI #vipe0002#4 = nSemana5;
               #vipe0012#12 = #vipe0012#12 + #vipe0002#9; ||horas normales sem 5
          |FINSI;
          |SI #vipe0002#4 = nSemana6;
               #vipe0012#13 = #vipe0012#13 + #vipe0002#9; ||horas normales sem 6
          |FINSI;
     |FINSI;

     #vipe0012#14 = #vipe0007#09;         || horas IT
     #vipe0012#15 = #vipe0007#10;         || horas vacaciones
     #vipe0012#16 = #vipe0007#11;         || horas absentismo
     #vipe0012#28 = #vipe0007#7;         || horas mes contrato
     #vipe0012#17 = #vipe0007#12;         || total horas mes
     #vipe0012#18 = #vipe0007#13;         || dif horas contrato
     #vipe0012#19 = #vipe0007#14;          || dif horas mes anterior
     || #vipe0012#20 = #vipe0007#24;           || nif
     #vipe0012#20 = #labtraba#7;           || nif
     #vipe0012#21 = #vipe0007#16;           || horas pagadas mes
     #vipe0012#22 = #vipe0007#18;           || diferencia total
     #vipe0012#23 = #vipe0007#21;           || vacaciones disfrutadas mes
     #vipe0012#24 = #vipe0007#19 + #vipe0007#27; || vacaciones pendientes
                                        || mes anterior (incluido a¤o anterior)
     #vipe0012#25 = #vipe0007#20;           || vacaciones generadas mes
     #vipe0012#26 = #vipe0007#29;           || vacaciones pagadas mes
     #vipe0012#27 = #vipe0007#28;           || total vacaciones pendientes
     #vipe0012#29 = #vipe0007#15;           || total horas regularizacion

     |SI FEstado = 0;
          |GRABA 020#vipe0012.a;
     |SINO;
          |GRABA 020#vipe0012.n;
     |FINSI;
     |LIBERA #12;

     |HAZ GrabaAcu;
|FPRC;

|| MIGUE: ESTE ES EL BUENO

|DEFBUCLE vipe0002;
     #vipe0002#2;
     11;
     #0#0, 00001, #0#2, #0#3, 01, #0#1;
     #0#0, 99999, #0#2, #0#3, 56, #0#1;
     ;
     NULL, grabatmp;
|FIN;

|| MIGUE: ESTE ES EL DE PRUEBA
/*
|DEFBUCLE vipe0002;
     #vipe0002#2;
     11;
     00007, 41167, #0#2, #0#3, 01, 01;
     00007, 99999, #0#2, #0#3, 56, 99;
     ;
     NULL, grabatmp;
|FIN;
*/

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam ! "";
          |NOME_DAT #7 aParam;
     |FINSI;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          Impresora = "CrystalReport";
          |IMPRE -1;
          || IMPRE 0;
          |SI #0#4 = "N";
               |INFOR "vipe0011";
          |SINO;
               |INFOR "vipe11de";
          |FINSI;

          |HORA aHora;
          |QBF aHora;
          aHora = aHora - ":" - ":";
          || alfa1 = Usuario; |QBT alfa1;    alfa1 = ("ff" + alfa1) % 108;
          alfa1 = "ff" + aHora;
          |NOME_DAT #12 alfa1;
          |DELINDEX #12;

          || alfa1 = Usuario; |QBT alfa1;    alfa1 = ("gg" + alfa1) % 108;
          alfa1 = "gg" + aHora;
          |NOME_DAT #17 alfa1;
          |DELINDEX #17;

          |ABRE #vipe0017;
          |ABRE #vipe0012;
          |ABRE #vipe0007;
          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #labcentr;
          |HAZ QueSemana;

          |BUCLE vipe0002;
          |BUCLE impresion;

          |CIERRA #labcentr;
          |CIERRA #labtraba;
          |CIERRA #labempre;
          |CIERRA #vipe0007;
          |CIERRA #vipe0012;
          |CIERRA #vipe0017;

          |PIEINF;
          |FININF;
          |FINIMP;
     |FINSI;
|FPRO;
