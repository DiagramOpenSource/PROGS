|FICHEROS;
    gomcalcu #00;      || pantalla calculo
    labempre #01;      || empresas
    labtraba #02;      || trabajadores
    nomcatca #03;      || aux. categorias cabeceras
    nomcatli #04;      || aux. categorias lineas
    nomtraca #05;      || aux. trabajadores cabeceras
    nomtrali #06;      || aux. trabajadores lineas
    nomvarca #07;      || variaciones trabajadores/mes cabeceras
    nomvarli #08;      || variaciones trabajadores/mes lineas
    nomconca #09;      || convenios cabeceras
    nomconli #10;      || convenios lineas
    nomcalca #11;      || registro calculos cabeceras
    nomcalli #12;      || registro calculos lineas
    nomantca #13;      || antiguedades/categorias
    nomconax #14;      || auxiliar convenios
    nomconst #15;      || constantes
    nombonif #16;      || bonificaciones
    nomepigr #17;      || epigrafes
    gomcotiz #18;      || tabla de cotizaciones (AGRARIA*)
    nomepitr #19;      || epigrafes por trabajador
    nomtrcal #20;      || calendario laboral
    nomantpl #30;      || ptas. base antiguedad convenio/categoria
    nomtrahx #31;      || bases cotiz. horas extraordinarias
    nomcontr #32;      || control aplicacion
    nomconat #37;
    nomhicca #39;      || historico cabs.
    nomgruec;          || grupos de empresas Cabs.
    nomgruel;          || grupos de empresas Lins.
    nomlogca;          || log incidencias calculo de la nomina Cabs.
    nomlogli;          || log incidencias calculo de la nomina Lins.
    nomincid;          || fichero de incidencias
    nombotra;
    nomboni3;
    gombojli;
     nomabsca;
     nomabsli;
     nomembca;
     nomembli;
     nomembcf;
     labcentr;
     nompanta;
     nomcalcc;
     copiadef@ #500;
|FIN;

|VARIABLES;
     htipo = 0;
    FEstado = 0;
    act = 0;
    actc = 0;
    acum1_200 = 0;
    acum2_200 = 0;
    &acum_10 = 0;
    acum_11 = 0;
    acum_12 = 0;
    acum_13 = 0;
    acum_30 = 0;
    acum_301 = 0;
    acum_302 = 0;
    acum_303 = 0;
    acum_31 = 0;
    acum_311 = 0;
    acum_312 = 0;
    acum_313 = 0;
    &acum_40 = 0;
    &acum_401 = 0;
    &acum_402 = 0;
    &acum_403 = 0;
    acum_41 = 0;
    acum_50 = 0;
    acum_51 = 0;
    acum_52 = 0;
    acum_53 = 0;
    acum_54 = 0;
    acum_90 = 0;
    &acum_99 = 0;
    &acum_991 = 0;
    &acum_992 = 0;
    &acum_993 = 0;
    acumb = 0;
    ajus_1 = 0;
    ajus_2 = 0;
    ajus_p = 0;
    alfa1 = "";        || variable de trabajo
    alfa2 = "";        || variable de trabajo
    alfa3 = "";        || variable de trabajo
    alfa4 = "";        || variable de trabajo
    alfa5 = "";        || variable de trabajo
    alfa6 = "";        || variable de trabajo
    alfa7 = "";        || variable de trabajo
    alfa8 = "";        || variable de trabajo
    anti_41 = 0;
    anticom = 0;
    any = 0;           || calculo 'desglosa'
    anyact = 0;
    anyalt = 0;
    anynum = 0;
    anyos = 0;
    anyven = 0;
    base_1 = 0;
    base_2 = 0;
    base_3 = 0;
    base_4 = 0;
    &base_5 = 0;
    &base_6 = 0;
    &base_7 = 0;
    &base_77 = 0;
    &base_8 = 0;
    &base_9 = 0;
    &zbase_9 = 0;
    &base_A = 0;
    &bbase_A = 0;
    &zbase_A = 0;
    &base_B = 0;
    &bbase_B = 0;
    &zbase_B = 0;
    &base_C = 0;
    &bbase_C = 0;
    &zbase_C = 0;
    &base_D = 0;
    &base_E = 0;
    &base_F = 0;
    &base_M = 0;
    &basemat_B = 0;
    &basemat_C = 0;
    bbase_F = 0;
    &zbase_F = 0;
    bases = 0;
    bisiesto = 0;
    &zbon_0 = 0;
    &bon_0 = 0;
    &bbon_0 = 0;
    &bon_1 = 0;     || (calculo finiquitos)
    &bon_2 = 0;     || (calculo finiquitos)
    &bon_3 = 0;
    &bbon_3 = 0;
    &zbon_3 = 0;
    &bon_5 = 0;
    &bbon_5 = 0;
    &zbon_5 = 0;
    bruto_aju = 0;
    bruto_pag = 0;
    &bruto_rec = 0;
    cabecera = 0;      || switch para grabar o no cabeceras de calculos
    camdes = 0;
    camhas = 0;
    campo = 0;
    campomax = 0;
    campomin = 0;
    campos = 0;
    catego = 0;
    ||citri_c = 1.33;    || coef. citricos tipo C
    ||citri_f = 1.67;    || coef. citricos tipo F
    citri_c = 1;       || coef. citricos tipo C
    citri_f = 1;       || coef. citricos tipo F
    &coba_1 = 0;
    &cobb_1 = 0;
    &coba_2 = 0;
    &cobb_2 = 0;
    &coba_3 = 0;
    &cobb_3 = 0;
    &coba_4 = 0;
    &cobb_4 = 0;
    concep0 = 0;
    concep1 = 0;
    concep2 = 0;
    concepto = 0;      || variable de trabajo del campo 'concepto'
    conser1 = 0;
    conser2 = 0;
    convenio = 0;      || switch de error de existencia o no de linea convenio
    coti_0 = 0;
    coti_1 = 0;
    coti_2 = 0;
    dabse_k = 0;
    dabse_1 = 0;
    &dabse_2 = 0;
    dacci_k = 0;
    dacci_0 = 0;
    dacci_1 = 0;
    &dacci_2 = 0;
    dacci_3 = 0;
    dacci_Y = 0;
    dacci_Z = 0;
    dacci_t = 0;
    &dacum_30 = 0;
    &dacum_31 = 0;
    dacum_999 = 0;
    dacum_vac = 0;
    dalta_k = 0;
    dalta_1 = 0;
    dalta_2 = 0;
    &dalta_3 = 0;
    danti_0 = 0;
    danti_1 = 0;
    dbaja_k = 0;
    dbaja_1 = 0;
    dbaja_2 = 0;
    &dbaja_3 = 0;
    &dboni_1 = 0;
    &dboni_2 = 0;
    &dcobr_0 = 0;
    dcofi_1 = 0;
    dcofi_2 = 0;
    dcofi_3 = 0;
    dcofi_4 = 0;
    dcofi_5 = 0;
    dcofi_6 = 0;
    dcofi_999 = 0;
    &dcoti_0 = 0;   || (calculo finiquitos)
    de1 = 0;
    de2 = 0;
    dedia = 0;
    denfe_k = 0;
    denfe_0 = 0;
    denfe_1 = 0;
    &denfe_2 = 0;
    denfe_3 = 0;
    denfe_4 = 0;
    &denfe_A = 0;
    &denfe_B = 0;
    &denfe_C = 0;
    &denfe_D = 0;
    denfe_V = 0;
    denfe_W = 0;
    denfe_X = 0;
    denfe_Y = 0;
    denfe_Z = 0;
    denfe_t = 0;
    des = 0;
    des1 = 0;
    des2 = 0;
    desc = 0;
    desde = 0;
    dhuel_k = 0;
    dhuel_1 = 0;
    dhuel_2 = 0;
    dia = 0;
    dia_k = 0;
    dia_1 = 0;
    dia_2 = 0;
    dia_3 = 0;
    dia_4 = 0;
    diaalt = 0;
    diafest = 0;
    dialabo = 0;
    dias_dto = 0;
    diasp = 0;
    diast = 0;
    diaven = 0;
    difer1 = 0;
    difer_a = 0;
    difer_m = 0;
    difere = 0;
    diff = 0;
    dilt = 0;
    divide = 0;
    dlabo_0 = 0;
    dlabo_k = 0;
    dmate_k = 0;
    dmate_0 = 0;
    dmate_1 = 0;
    &dmate_2 = 0;
    doce = 0;
    &dto_con = 0;
    &dto_dfp = 0;
    &dto_ho1 = 0;
    &dto_ho2 = 0;
    &dto_tot = 0;
    dtot = 0;
    duni1_101 = 0;
    duni1_102 = 0;
    duni1_103 = 0;
    duni1_200 = 0;
    duni1_902 = 0;
    duni1_903 = 0;
    duni1_999 = 0;
    duni2_101 = 0;
    duni2_102 = 0;
    duni2_103 = 0;
    duni2_200 = 0;
    duni2_902 = 0;
    duni2_903 = 0;
    duni2_998 = 0;
    duni2_999 = 0;
    dvaca_1 = 0;
    dvaca_2 = 0;
    dvaca_k = 0;
    dvalo_101 = 0;
    dvalo_102 = 0;
    dvalo_103 = 0;
    dvalo_200 = 0;
    dvalo_201 = 0;
    dvalo_202 = 0;
    dvalo_203 = 0;
    dvalo_204 = 0;
    dvalo_205 = 0;
    dvalo_206 = 0;
    dvalo_207 = 0;
    dvalo_208 = 0;
    dvalo_209 = 0;
    dvalo_902 = 0;
    dvalo_903 = 0;
    dvalo_999 = 0;
    dvalo_pag = 0;
    &dvalo_pro = 0;
    &epig_ilt = 0;
    &epig_ims = 0;
    elotro = 0;
    estevale = 0;
    fanti_a = 0;
    fanti_m = 0;
    fecalf = "";       || calculo 'desglosa'
    &fecbaj = "";       || calculo 'baja'
    fecsis = @;        || variable fecha de trabajo
    fecsys = @;        || variable fecha de trabajo
    &fijo_1 = 0;
    &fijo_1_red = 0;
    fijo_922 = 0;
    fvenci = "";       || fecha vencimiento antiguedad
    ganti_a = 0;
    ganti_m = 0;
    graba04 = 0;
    graba05 = "";
    graba06 = 0;
    graba07 = 0;
    graba08 = "";
    graba09 = 0;
    graba10 = 0;
    graba11 = 0;
    &guarda = 0;
    guarda_dia_4 = 0;
    ha1 = 0;
    ha2 = 0;
    hadia = 0;
    has = 0;
    has1 = 0;
    has2 = 0;
    hasc = 0;
    hasta = 0;
    histori = "";      || variable tabla indicando variaciones/trabajador
    &horasex = 0;
    horastp = 0;
    indemni = 0;
    lin_1 = 0;
    lin_2 = 0;
    liq_aju = 0;
    liquido = 0;
    mas = 0;
    mensaje0 = "    * SELECCION VACIA * ";
    mensaje1 = "ATENCION, PROCESO DETENIDO !!! Convenio ";
    mensaje2 = ", INEXISTENTE en fichero ";
    mes = 0;
    mesact = 0;
    mesalt = 0;
    mesco = 0;
    meslabo = "";      || mes del calendario laboral
    mesnum = 0;
    mespinta = "";     || variable de trabajo para pintar el mes
    mesven = 0;
    mid = 0;
    nume0 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    nume7 = 0;
    nume10 = 0;
    numer = 0;
    p_mes = "";        || variable de trabajo para pintar mes literal
    paga = 0;
    pcofi_1 = 0;
    pcofi_2 = 0;
    pcofi_3 = 0;
    pcofi_4 = 0;
    pdia_0 = 0;
    pdia_1 = 0;
    pdia_2 = 0;
    pdia_3 = 0;
    pdia_4 = 0;
    pdia_5 = 0;
    pdia_a = 0;
    pdia_b = 0;
    pdia_c = 0;
    pdia_d = 0;
    pdia_e = 0;
    pepulti = 0;
    perio = 0;
    perio1 = 0;
    perio2 = 0;
    perio3 = 0;
    perio4 = 0;
    perio5 = 0;
    perio6 = 0;
    perio7 = 0;
    perio8 = 0;
    pilt_enf = 0;
    pilt_acc = 0;
    &por1_cont = 0;
    &por1_dfpg = 0;
    &por1_hor1 = 0;
    &por1_hor2 = 0;
    &por2_cont = 0;
    &por2_dfpg = 0;
    &por2_hor1 = 0;
    &por2_hor2 = 0;
    porce = 0;
    porcp = 0;
    pp = 0;
    produc1 = 0;
    produc2 = 0;
    produc3 = 0;
    product = 0;
    &prom_ac2 = 0;
    &prom_acc = 0;
    &prom_enf = 0;
    puntero = 0;
    &reten_1 = 0;
    &reten_11 = 0;
    &reten_12 = 0;
    &reten_13 = 0;
    &reten_2 = 0;
    rompe = 0;
    s_reajus = 0;
    salte_1 = 0;
    salte_2 = 0;
    seleccio = 0;      || switch para mensaje 'Seleccion vacia' o no
    sigui = 0;
    stop = 0;
    sw_bruaju = 0;
    swaju_abs = 0;
    swaju_acc = 0;
    swaju_enf = 0;
    swaju_hue = 0;
    swaju_mat = 0;
    swaju_vac = 0;
    swajuac = 0;
    swajuen = 0;
    swalta = 0;
    swbaja = 0;
    swcongra = 0;
    swfuera = 0;
    swgracon = 0;
    swmarca = "";      || indicador de variaciones/trabajador
    swpaga = 0;
    swpro = 0;
    tempo1 = 0;
    tempo2 = 0;
    tempo3 = 0;
    tempo4 = 0;
    tempo5 = 0;
    tempor = 0;
    tipo_p = 0;
    tipo1 = "";        || mes que cumple a¤o (actual)
    tipo2 = "";        || mes que cumple a¤o (siguiente)
    tipo3 = "";        || trimestre que cumple a¤o (actual)
    tipo4 = "";        || trimestre que cumple a¤o (siguiente)
    tipo5 = "";        || semestre que cumple a¤o (actual)
    tipo6 = "";        || semestre que cumple a¤o (siguiente)
    tipo7 = "";        || a¤o que cumple a¤o (actual)
    tipo8 = "";        || a¤o que cumple a¤o (siguiente)
    tipos = 0;
    tipox = 0;
    &topemes = 0;
    topemes1 = 0;
    topemes2 = 0;
    totact = 0;
    totalt = 0;
    totven = 0;
    tp = 0;
    trabamen = "";     || variable de trabajo para construir mensaje
    unidades = 0;
    vacacio = 0;
    valorito = 0;
    vcobr_0 = 0;
    vlabo_0 = 0;
    vlabo_k = 0;
    yaesta = 0;
    runnom = "gomcalcu"; || ojo con esta variable, si se pone GLOBAL
                         || no funciona la seleccion de empresas
    &eaVengoDe = "gomcalcu";

    CodigoCons = 0;

     nHastaBonif = 0;
     nVtoBonif = 0;
     nNume1 = 0;
     nNume2 = 0;
     nPara1 = 0;
     nPara2 = 0;
     &nPorBon1 = 0;
     &nPorBon2 = 0;
     difbase = 0;
     &EURODB = 0;
     swActiva = 0;
     &jornadasIT = 0;
     jornadasMat = 0;
     &jornadasEA = 0;
     aAviso = "";
     &cbon_3 = 0;
     &sw_tope = 0;
     dias_baja = 0;
     nBase_cp = 0;
     &grupo = 0;
     dias_tope = 0;
     nMax_cp = 0;
     nMin_cp = 0;
     swPorGrupos = 0;
     nGrupo = 0;
     nCampoG = 0;
     para1 = 0;
     pror_p = 0;

     &nCConst = 0;
     &fCFecha = @;
     &aCError = "";
     aAlfa = "";

     &nContLog = 0;
     &nNroErrores = 0;
     &nIncid = 0;
     &swIniLog = 0;

     nMesesBon16 = 0;
     nAnyosBon16 = 0;
     nPB16Calc = 0;
     nume8 = 0;
     nume9 = 0;
     nPB16CalcA = 0;
     por_bon_16A = 0;
     nBon60_2 = 0;
     &bon_60 = 0;
     fecha_bon_16 = "";
     por_bon_16 = 0;
     por_bon_60 = 0;
     aFechaRef = "";
     nAnyoBase = 0;
     aAnyoBase = "";
     &nElMes = 0;
     &nElAny = 0;
     &nElMesIRPF = 0;    || para nomir008
     &nElAnyIRPF = 0;    || para nomir008
     &nJorAgr = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aIniPer = "";
     fIniPer = @;
     aFinPer = "";
     fFinPer = @;
     aFechaCambio = "";
     fFechaCambio = @;
     nFechaCambio = 0;
     nDiasAny1 = 0;
     nDiasAny2 = 0;


     &fCFechaCot = @;
     &aCErrorCot = "";
     swExtTem = 0;

     nEmp = 0;
     nTra = 0;
     &nBonifFCI = 0;
     fFechaIniBon = @;
     fFechaFinBon = @;
     fFecha = @;
     nDiasBon = 0;
     aFecha = "";
     &nMes = 0;
     &nAny = 0;
     &nCodigoBon = 0;
     &nEpigConv = 0;
     nAnysParaAnt = 0;
     &bon_59 = 0;
     nEdadParaBon = 0;
     aEPBon = "";
     nBonifJOR = 0;
     swNoEntra = 0;
     aFechaDesde = "";
     aFechaHasta = "";
     fFechaDesde = @;
     fFechaHasta = @;
     dias_v = 0;
     &swBaseFija = 0;
     &swJornadas = 0;

     &swAjuste3 = 0;
     swNoAjuste3 = 0;
     swAjuste3_2 = 0;
     swNoAjuste3_2 = 0;
     swAjuste3_C = 0;
     swSigue = 0;
     &swModulo = 0;
     nRedFijaCC = 0;     || reduccion fija cot. General, 21 euros
     nRedFijaATEP = 0;     || reduccion fija cot. General, 21 euros
     nRedJorCC = 0;    || reduccion fija cot. Jornadas, 0.70 euros
     nRedJorATEP = 0;    || reduccion fija cot. Jornadas, 0.70 euros
     nRedFija = 0;
     &nDiasPagoSS = 0;
     &nBasePagoSS = 0;
     &nBasePagoSS_CC = 0;
     &nBasePagoSS_CP = 0;
     &nJornPagoSS = 0;
     &nBaseATEP = 0;
     &nATEP_Alta = 0;
     &nATEP_IT = 0;
     nBonFijaGen = 2.17;
     nBonFijaJor = 2.71;
     nNume = 0;
     nDesdeAny = 0;
     nHastaAny = 0;
     aNif = "";
     fFecha1 = @;
     fFecha2 = @;
     nEmbargo = 0;
     nCuotaEmb = 0;
     nLiquidoNom = 0;
     nLiquidoPag = 0;
     nLiqEmb = 0;
     nSMI = 0;
     nPasada = 0;
     nPor = 0;
     nLimite1 = 0;
     nLimite2 = 0;
     nIngresos = 0;
     nIngresosPag = 0;
     nDeducc = 0;
     nDeduccPag = 0;
     &nEmpAUTO = 0;
     &nEmpAUTO_D = 0;
     &nEmpAUTO_H = 0;
     &nTraAUTO = 0;
     &nTraAUTO_D = 0;
     &nTraAUTO_H = 0;
     &nMesAUTO = 0;
     &nAnyAUTO = 0;
     aParam = "";
     nBonif = 0;
     swBaseDiario = 0;
     nLimiteJor = 0;
     nCotAlta = 0;
     nDiasITPaga = 0;
     nMaximo = 0;
     nMinimo = 0;
     &nBase = 0;
     prom_enf_929 = 0;
     importe = 0;
     nMesBusca = 0;
     nAnyBusca = 0;
     swAjuste3_1 = 0;
     &base_11 = 0;
     &dcont_2 = 0;

     &swMensual = 0;
     &nBasePorJornada = 0;
     &nBasePorJornada_red = 0;
     &nReduccion = 0;

     &nImporteRedCC_Alta = 0;
     &nImporteRedCC_IT = 0;
     nRedCC = 0;

     &denfe_cot = 0;
     &dacci_cot = 0;
     &dmate_cot = 0;
     &nRedCCEnf = 0;
     &nRedDesEnf = 0;
     &nRedCCMat = 0;
     &nRedDesMat = 0;
     &nRedCCAcc = 0;
     &nRedDesAcc = 0;
     &nRedCCEnfEmp = 0;
     &nRedDesEnfEmp = 0;
     &prom_enf_previo = 0;
     &prom_acc_previo = 0;
     nDiasCotIT = 0;
     &propo = 0;

     aFechaAlta = "";
     fFechaAlta = @;
     fAlta = @;
     aFechaBaja = "";
     fFechaBaja = @;
     fech3 = @;
     fech4 = @;
     fech5 = @;
     nCuantos = 0;
     &nTopemes = 0;
     nDiasMesTrab = 0;
     swDupli = 0;
     aCot = "";
     aAlta = "";
     &swAgosto2012 = 0;

     nNroNomina = 0;
     nTotalNominas = 0;
     swRecuento = 0;
     denfe_A0 = 0;
     denfe_B0 = 0;
     denfe_C0 = 0;
     denfe_D0 = 0;
     nDiaRealIniIT = 0;
     nEdad = 0;

     ddese_k = 0;
     ddese_1 = 0;
     &ddese_2 = 0;
     &nBonifERE = 0;
     nDiasBonifERE = 0;
     &nJornadasERE = 0;
     &nDesem = 0;
     &nJorITCotEmpTra = 0;
     &nJorITCotEmp = 0;
     &n400Cot = 0;
     especie = 0;
     &dto_sol_emp = 0;
     &dto_sol_tra = 0;
     &aDesIncid = "";
     aPath = "";
     aDef = "";
     aFic = "";
     antici1 = 0;
     antici2 = 0;
     nAjuEmb = 0;
     &sw949 = 0;
     &dreca_0 = 0; &dreca_1 = 0; &dreca_2 = 0; &dreca_3 = 0; &dreca_4 = 0;
     &aUltimaIT = "";
     nDesde = 0;
     nHasta = 0;
     nMinCC = 0;
     nMinCP = 0;
     swPagasProrr = 0;
     nCampoPT = 0;
     nInembargable = 0;
     nPropProrr = 0;
     &aVersion = "";
     &nPrestacionEnf = 0;

     acu_auto = 0;
     val_auto = 0;
     auto1 = 0;
     auto2 = 0;
     auto3 = 0;
     nIRPF1 = 0; nIRPF2 = 0; nIRPF3 = 0;
     swITEmp = 0;
     nPropPrac = 1;
     &enMes = 0;
     &enAny = 0;
     &enDiasAlta = 0;
     nDiferencia = 0;
     fIniBon = @;
     aIniBon = "";
     nBonifFCI_T1 = 0;
     nBonifFCI_T2 = 0;
     swCambioBon = 0;
     nDiasBon_1 = 0;
     fFechaCal = @;
     fAny1Bon = @;
     fAny2Bon = @;
     &nCuotaCC_Alta = 0;
     &nBaseAlta = 0;
     &nDiasAlta = 0;
     aSexo = "";
|FIN;

|INCLUYE nomcal_4;

||****************************************************************************
||                    LECTURA PRINCIPAL DE TRABAJADORES
||****************************************************************************

|PROCESO chequea;  || chequea el trabajador este en periodo de alta
    swfuera = 0;
|SI #2#42 = "A";|O #2#42 = "B";|O #2#42 = "E";   || AGRARIA *
        fecalf = #2#36;   || fecha de alta
    |HAZ desglosa;
    |SI any > #0#9;|O any = 0;
            swfuera = 1;
    |SINO;
        |SI mes > #0#8; |Y any = #0#9;
                swfuera = 1;
        |FINSI;
    |FINSI;
    |SI swfuera = 0;
            fecalf = #2#37;  || fecha de baja
        |HAZ desglosa;
        |SI any < #0#9; |Y any ! 0;
                swfuera = 1;
        |SINO;
            |SI mes < #0#8; |Y any = #0#9; |Y mes ! 0;
                    swfuera = 1;
            |FINSI;
        |FINSI;
    |FINSI;
|SINO;
        swfuera = 1;
|FINSI;
|FPRC;

|PROCESO chequea2;
     |ABRE #nomcalca;
     #nomcalca#0 = #labtraba#0;
     #nomcalca#1 = #labtraba#1;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          alfa2 = #nomcalca#5 % 402;
          alfa3 = #nomcalca#5 % -104;
          mes = alfa2;
          any = alfa3;
          |SI mes = nElMes; |Y any = nElAny;     || soy baja este mes y ya tengo
               swfuera = 1;   || pues no compruebo nada, si es baja no entra
                              || y ya esta
          |FINSI;
     |FINSI;
     |CIERRA #nomcalca;
|FPRC;

|PROCESO chequeaBloqueo;
     |ABRE #nomcalca;
     #nomcalca#0 = #labtraba#0;
     #nomcalca#1 = #labtraba#1;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          |SI #nomcalca#145 = "S";
               swfuera = 1;
               nIncid = 40;
               |HAZ graba_inc;
          |FINSI;
     |FINSI;
     |CIERRA #nomcalca;
|FPRC;

|PROCESO historico;
|ABRE #39;
    #39#0 = #2#0;   || empresa
    #39#1 = #2#1;   || trabajador
    nume1 = #0#9;   nume1 = nume1 $ 100;
    #39#66= nume1;  || a¤o
    #39#2 = #0#8;   || mes
    #39#3 = htipo;  || tipo
|LEE 000#39=;
|SI FSalida = 0;
        alfa1 = "    Debera desactualizar a [" + #39#0 + "." + #39#1 + "." + #39#66 + "." + #39#2 + "." + #39#3 + "] para poder calcularlo ...";
    |MENAV alfa1;
        swfuera = 1;
|FINSI;
|CIERRA #39;
|FPRC;

|PROCESO proceso;
     |SI #2#42 = "e";      || cambio clave de salario en extrajeros
          #2#42 = "E";      || para que me los trate igual que los event.
          swExtTem = 1;
     |SINO;
          swExtTem = 0;
     |FINSI;

     || 2009
     swBaseFija = 0;
     swJornadas = 0;
     swMensual = 0;
     |SI #2#42 = "A";
          swBaseFija = 1;
          swMensual = 1;
     |SINO;
          swJornadas = 1;
     |FINSI;
     |HAZ chequea;
     |SI #0#11 = "N";
          |HAZ chequea2;
     |FINSI;
     |HAZ activasino;
     |HAZ chequeaBloqueo;
     |SI swfuera = 0; |Y swActiva = 1;

          |SI swRecuento = 1;
               nTotalNominas = nTotalNominas + 1;
               |ACABA;
          |SINO;
               nNroNomina = nNroNomina + 1;
               alfa1 = nNroNomina; |QBF alfa1;
               alfa2 = nTotalNominas; |QBF alfa2;
               aAlfa = "    Calculando nómina " + alfa1 + " de " + alfa2 + ".";
               |MENSA aAlfa;
          |FINSI;

          |HAZ historico;
          |SI swfuera = 0;
               #9#0 = #2#87;
               |LEE 000#9=;
               |SI FSalida = 0;
                    cabecera = 0;
                    nIncid = 0;
                    |HAZ pintalo;
                    |HAZ lee_control;
                    |HAZ leeregis;
                    |HAZ EnPracticas;
                    prom_enf_929 = 0;
                    |HAZ leecateg;
                    |HAZ leetraba;
                    |HAZ leevaria;
                    |HAZ cabecera;
                    |SI fijo_1 = 0;|Y #2#42 = "E";|Y #32#11 = 1;|Y fijo_922 = 0;
                         |HAZ leeregis;         || los eventuales con jornadas cero
                    |FINSI;                    ||/no se calculan (en modo 1)
                    |SI #2#42 = "E";
                         |SI fijo_1 = 0; |Y jornadasIT = 0;
                              nIncid = 57;
                              |HAZ graba_inc;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |ATRI P;
                    trabamen = #2#87;
                    trabamen = "    " + mensaje1 + trabamen + mensaje2;
                    |MENAV trabamen;
                    |ATRI 0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomcalc0;
 #2#1;
 87, 17, 77, 44;
 #0#0, #0#2, #0#4, #0#6, #0#71, AA;
 #0#1, #0#3, #0#5, #0#7, #0#72, AA;
 e;
 NULL, proceso;
|FIN;

|PROCESO salteadaAG;
|ABRE #2;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #2#0 = #0salte_1;
        #2#1 = #0salte_2;
    |LEE 000#2=;
    |SI FSalida = 0;|Y #2#44 = "A";
        |HAZ proceso;
    |FINSI;
|SIGUE;
|CIERRA #2;
|FPRC;

|DEFBUCLE nomcalcg;
     #2#1;
     44;
     #nomgruel#1, 00001, "A";
     #nomgruel#1, 99999, "A";
     ;
     NULL, proceso;
|FIN;

|PROCESO CalGrupo;       || para cada una hace el proceso de siemrpe
     |BUCLE nomcalcg;
|FPRC;

|DEFBUCLE Grupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, CalGrupo;
|FIN;

|PROCESO PorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 63; |SI nCampoG [ 70; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE Grupo;
     |SIGUE;
|FPRC;

|PROCESO lectura;             ||   INICIO DEL CALCULO!!!
     swModulo = 0;
     |HAZ BuscaModulo;

     |ABRE #09;
     |ABRE #10;
     |ABRET #11;
     |ABRET #12;

     nMes = #0#8;
     nAny = #0#9;
     |HAZ ini_log;

     nNroNomina = 0;
     nTotalNominas = 0;
     swRecuento = 1;
     |SI #0#21 = 0;
          |SI #0#63 = 0;
               |BUCLE nomcalc0;
          |SINO;
               |HAZ PorGrupos;
          |FINSI;
     |SINO;
          |HAZ salteadaAG;
     |FINSI;

     swRecuento = 0;
     |SI #0#21 = 0;
          |SI #0#63 = 0;
               |BUCLE nomcalc0;
          |SINO;
               |HAZ PorGrupos;
          |FINSI;
     |SINO;
          |HAZ salteadaAG;
     |FINSI;
     |HAZ fin_log;
     |SI seleccio = 0;
          |ATRI P;
          |MENAV mensaje0;
          |ATRI 0;
     |FINSI;
     |SI nNroErrores > 0;
          |HAZ CargaLog;
     |FINSI;
     |CIERRA #09;
     |CIERRA #10;
     |CIERRAT #11;
     |CIERRAT #12;
|FPRC;

|PROCESO Aviso;
     |PUSHV 05012380;
     |BLANCO 05012380;
     |PINPA #8#nompanta;
     |AVISO;
     |PAUSA;
     |POPV;
|FPRC;

|PROCESO ActualizaCons;
     |ABRE #nomconst;

     |SI #0#9 ] 2020;
          #nomconst#0 = 700;
          #nomconst#79 = "01.01.2020";
          |LEE 000#nomconst.=;
          |SI FSalida ! 0;
               |SUB_EJECUTA "nomfan02;ACTUALIZACION";

               aAlfa = "    Se han actualizado las constantes con los tipos de cotización";
               aAlfa = aAlfa + " para 2020";
               ||MENAV aAlfa;
          |FINSI;
     |FINSI;

     |CIERRA #nomconst;
|FPRC;

|PROGRAMA;
     |HAZ LeeEURODB;
     |CLS;
     |CABEZA "Calculo Mensual";

     aAlfa = Usuario;         |QBF aAlfa;
     aAlfa = "n" +  aAlfa;
     |NOME_DAT #0 aAlfa;
     aParam = PARAMETRO;
     |QBF aParam;

     |DDEFECTO #0;
     |ABRE #0;
     |LEE 000#0p;
     |SI FSalida = 0;
          |BORRA 020#0a;
     |FINSI;
     |CIERRA #0;

     |SI aParam = "";
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
     |SINO;
          |DDEFECTO #0;
          |SI aParam = "NOMVARCA"; |O aParam = "NOMSICOS"; |O aParam = "NOMSICOSR";
               nEmpAUTO_D = nEmpAUTO;
               nEmpAUTO_H = nEmpAUTO;
               nTraAUTO_D = nTraAUTO;
               nTraAUTO_H = nTraAUTO;
          |FINSI;
          #0#0 = nEmpAUTO_D
          #0#1 = nEmpAUTO_H
          #0#2 = nTraAUTO_D
          #0#3 = nTraAUTO_H
          #0#4 = 000;
          #0#5 = 999;
          #0#6 = 000;
          #0#7 = 999;
          #0#8 = nMesAUTO;
          #0#9 = nAnyAUTO;
          nElMes = #0#8;
          nElAny = #0#9;
          FSalida = 0;
     |FINSI;

     |SI FSalida = 0;
          nElMes = #0#8;
          nElAny = #0#9;
          |HAZ ValoresITIMS;
          |HAZ ActualizaCons;
          |ABRE #0;
          |GRABA 020#0n;
          |CIERRA #0;
          |HAZ lib_0;
          |HAZ tipos;
          |HAZ lectura;

          eaVengoDe = "gomcalcu";
          nElMesIRPF = #0#8;
          nElAnyIRPF = #0#9;
          nJorAgr = fijo_1 + jornadasIT;
          |SUB_EJECUTA "nomir008";
          nElMesIRPF = #0#8;
          nElAnyIRPF = #0#9;
          |SUB_EJECUTA "nom400ca";

          |SUB_EJECUTA "nomgir00;gomcalcu";

          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa % -109;
          |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
          |Y #0#21 ! 0; |Y #0#42 ! 0; |Y #0#22 = 0; |Y #0#43 = 0;
               |ABRE #nomcalca;
               #nomcalca#0 = #0#21;
               #nomcalca#1 = #0#42;
               #nomcalca#2 = #0#8;
               #nomcalca#3 = 0;
               |LEE 000#nomcalca.=
               |SI FSalida = 0;
                    |CLS;
                    |PINPA #0#nomcalca;
                    |PINDA #0#nomcalca;
                    |ENDATOS #4#nomcalca;
               |FINSI;
               |CIERRA #nomcalca;
          |FINSI;
     |FINSI;
|FPRO;

||****************************************************************************
||                  LLAMADAS DESDE EL MANTENIMIENTO
||****************************************************************************

|PROCESO seleccion; |TIPO 0;
|SI #0#21 = 0;
        alfa1 = "S";
        alfa2 = "N";
    |PARA nume1 = 21; |SI nume1 [ 62; |HACIENDO nume1 = nume1 + 1;
        #0nume1 = 0;
    |SIGUE;
    |PINDA #0#0;
|SINO;
        alfa1 = "N";
        alfa2 = "S";
|FINSI;
|CAMPO_MODIFICA #0#0, 1, alfa1;
|CAMPO_MODIFICA #0#1, 1, alfa1;
|CAMPO_MODIFICA #0#2, 1, alfa1;
|CAMPO_MODIFICA #0#3, 1, alfa1;
|CAMPO_MODIFICA #0#4, 1, alfa1;
|CAMPO_MODIFICA #0#5, 1, alfa1;
|CAMPO_MODIFICA #0#6, 1, alfa1;
|CAMPO_MODIFICA #0#7, 1, alfa1;
|CAMPO_MODIFICA #0#22, 1, alfa2;
|CAMPO_MODIFICA #0#23, 1, alfa2;
|CAMPO_MODIFICA #0#24, 1, alfa2;
|CAMPO_MODIFICA #0#25, 1, alfa2;
|CAMPO_MODIFICA #0#26, 1, alfa2;
|CAMPO_MODIFICA #0#27, 1, alfa2;
|CAMPO_MODIFICA #0#28, 1, alfa2;
|CAMPO_MODIFICA #0#29, 1, alfa2;
|CAMPO_MODIFICA #0#30, 1, alfa2;
|CAMPO_MODIFICA #0#31, 1, alfa2;
|CAMPO_MODIFICA #0#32, 1, alfa2;
|CAMPO_MODIFICA #0#33, 1, alfa2;
|CAMPO_MODIFICA #0#34, 1, alfa2;
|CAMPO_MODIFICA #0#35, 1, alfa2;
|CAMPO_MODIFICA #0#36, 1, alfa2;
|CAMPO_MODIFICA #0#37, 1, alfa2;
|CAMPO_MODIFICA #0#38, 1, alfa2;
|CAMPO_MODIFICA #0#39, 1, alfa2;
|CAMPO_MODIFICA #0#40, 1, alfa2;
|CAMPO_MODIFICA #0#41, 1, alfa2;
|CAMPO_MODIFICA #0#42, 1, alfa2;
|CAMPO_MODIFICA #0#43, 1, alfa2;
|CAMPO_MODIFICA #0#44, 1, alfa2;
|CAMPO_MODIFICA #0#45, 1, alfa2;
|CAMPO_MODIFICA #0#46, 1, alfa2;
|CAMPO_MODIFICA #0#47, 1, alfa2;
|CAMPO_MODIFICA #0#48, 1, alfa2;
|CAMPO_MODIFICA #0#49, 1, alfa2;
|CAMPO_MODIFICA #0#50, 1, alfa2;
|CAMPO_MODIFICA #0#51, 1, alfa2;
|CAMPO_MODIFICA #0#52, 1, alfa2;
|CAMPO_MODIFICA #0#53, 1, alfa2;
|CAMPO_MODIFICA #0#54, 1, alfa2;
|CAMPO_MODIFICA #0#55, 1, alfa2;
|CAMPO_MODIFICA #0#56, 1, alfa2;
|CAMPO_MODIFICA #0#57, 1, alfa2;
|CAMPO_MODIFICA #0#58, 1, alfa2;
|CAMPO_MODIFICA #0#59, 1, alfa2;
|CAMPO_MODIFICA #0#60, 1, alfa2;
|CAMPO_MODIFICA #0#61, 1, alfa2;
|CAMPO_MODIFICA #0#62, 1, alfa2;
|FPRC;

|PROCESO pintames; |TIPO 0;
|SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
|SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
|SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
|SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
|SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|PINTA 0656, p_mes;
|FPRC;

|PROCESO mirames; |TIPO 7; ||calcula el mes por defecto segun fecha sistema
/*
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % 402;
    #0Campo = alfa1;
|PINTA #0Campo;
*/
|HAZ pintames;
|FPRC;

|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % -104;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO lib_0; |TIPO 0;   || halla ultimo dia natural del mes
    mesnum = #0#8;
    anynum = #0#9;
|HAZ ulti_dia;
    guarda = topemes;      || cambia de variable para no perderlo
|FPRC;

|PROCESO tipos; |TIPO 0;      || construye fechas vencimiento para antiguedad
    mesact = #0#8;
    anyact = #0#9;
    nume1 = mesact;
    nume2 = anyact;
|HAZ rellena;
    tipo1 = alfa1 + "." + alfa2;    || mes actual

    nume1 = nume1 - 1;
|SI nume1 = 0;
        nume1 = 12;
        nume2 = nume2 - 1;
|FINSI;
|HAZ rellena;
    tipo2 = alfa1 + "." + alfa2;    || mes siguiente

|SI mesact [  3;|Y mesact ] 1;  nume1 =  3;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =  6;  |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =  9;  |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 = 12;  |FINSI;
|HAZ rellena;
    tipo3 = alfa1 + "." + alfa2;    || trimestre actual

|SI mesact [  3;|Y mesact ] 1;  nume1 =  12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =   3;                      |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =   6;                      |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 =   9;                      |FINSI;
|HAZ rellena;
    tipo4 = alfa1 + "." + alfa2;    || trimestre siguiente

|SI mesact [  6;|Y mesact ] 1;  nume1 =  6;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 = 12;  |FINSI;
|HAZ rellena;
    tipo5 = alfa1 + "." + alfa2;     || semestre actual

|SI mesact [  6;|Y mesact ] 1;  nume1 = 12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 =  6;                      |FINSI;
|HAZ rellena;
    tipo6 = alfa1 + "." + alfa2;     || semestre siguiente

    nume1 = 12;
|HAZ rellena;
    tipo7 = alfa1 + "." + alfa2;     || a¤o actual

    nume1 = 12;
    nume2 = nume2 - 1;
|HAZ rellena;
    tipo8 = alfa1 + "." + alfa2;     || a¤o siguiente
|FPRC;

|PROCESO rellena;      || rellena de ceros campos numericos ('tipos')
    alfa1 = nume1;  alfa1 = "00" + nume1;  alfa1 = alfa1 % -102;
    alfa2 = nume2;
    nume1 = mesact;
    nume2 = anyact;
|FPRC;

||*************************************************************************
||                    LECTURA DE CONCEPTOS
||*************************************************************************

|PROCESO leecateg;    || lee y graba desde el fichero de categorias
|ABRE #3;
|DDEFECTO #3;
|DDEFECTO #4;
    #3#0 = #2#87;
    #3#1 = #2#17;
|LEE 000#3=;
|SI FSalida = 0;
    |BUCLELIN 2gracateg#3;
|FINSI;
|CIERRA #3;
|FPRC;

|PROCESO leetraba;     || lee y graba desde el fichero de aux. de trabajadores
    CodigoCons = 0;
|ABRE #5;
|DDEFECTO #5;
|DDEFECTO #6;
    #5#0 = #2#0;
    #5#1 = #2#1;
|LEE 000#5=;
|SI FSalida = 0;
    CodigoCons = #5#3;
    |BUCLELIN 2gratraba#5;
|FINSI;
|CIERRA #5;
|FPRC;

|PROCESO leevaria;     || lee y graba desde el fichero de var. de trabajadores
     especie = 0;
     antici1 = 0;
     antici2 = 0;

     |ABRE #7;
     |DDEFECTO #7;
     |DDEFECTO #8;
     #7#0 = #2#0;
     #7#1 = #2#1;
     #7#2 = #0#8;
     #7#3 =    0;
     |LEE 000#7=;
     |SI FSalida = 0;
          |BUCLELIN 2gravaria#7;

          antici1 = #7#19;      || anticipos 1
          antici2 = #7#20;      || anticipos 2
          especie = #7#21;
     |FINSI;
     |CIERRA #7;
|FPRC;

||***************************************************************************
||                GRABACION DE LINEAS DE REGISTRO
||***************************************************************************

|PROCESO gracateg;  || de calculo 'leecateg', graba lineas de categorias
    concepto = #04#02;
    unidades = #04#03;
    importe = #04#04;
|HAZ convenio;
|SI convenio = 0;
    |HAZ recarga;
        #12#04 = #04#02;       || concepto
        #12#09 = #04#03;       || unidades
        #12#10 = #04#04 * tp;  || valor (proporcion de los tiempos parciales)
        #12#10 = #12#10 * nPropPrac;
    |GRABA 020#12n;
        cabecera = 1;     || switch para grabar posteriormente la cabecera
|FINSI;
|FPRC;

|PROCESO gratraba;  || de calculo 'leetraba', graba lineas de trabajadores
    concepto = #06#02;
    unidades = #06#03;
    importe = #06#04;
|HAZ convenio;
|SI convenio = 0;
    |DDEFECTO #12;
    |HAZ recarga;
        #12#04 = #06#02;
    |LEE 000#12=;
    |SI FSalida = 0;  |BORRA 020#12a;  |FINSI;
    |HAZ recarga;
        #12#04 = #06#02;      || concepto
    |SI #06#03 ! "          ";    #12#09 = #06#03;  |FINSI;  || unid.
    |SI #06#04 ! "            ";  #12#10 = #06#04;  |FINSI;  || valor
    |GRABA 020#12n;
        cabecera = 1;     || switch para grabar posteriormente la cabecera
|FINSI;
|FPRC;

|PROCESO gravaria;  || de calculo 'leevaria', graba lineas de variaciones
    concepto = #08#04;
    unidades = #08#05;
    importe = #08#06;
|HAZ convenio;
|SI convenio = 0;
    |DDEFECTO #12;
    |HAZ recarga;
        #12#04 = #08#04;
    |LEE 000#12=;
    |SI FSalida = 0;  |BORRA 020#12a;  |FINSI;
    |HAZ recarga;
        #12#04 = #08#04;  || concepto
    |SI #08#05 ! "          ";    #12#09 = #08#05;  |FINSI;  || unid.
    |SI #08#06 ! "            ";  #12#10 = #08#06;  |FINSI;  || valor
    |GRABA 020#12n;
        cabecera = 1;     || switch para grabar posteriormente la cabecera
|FINSI;
|FPRC;

|PROCESO borralineas;
     |BORRA 020#12a;
|FPRC;

||***************************************************************************
||                        CALCULO DE EMBARGOS
||***************************************************************************

|PROCESO nomembcf;
     nNume = 0;

     #nomcalli#0 = #labtraba#0;
     #nomcalli#1 = #labtraba#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = #nomembcf#2;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nNume = ((#nomcalli#10 * #nomcalli#11) ! 2)
     |SINO;
          |SI #nomembcf#2 = 906; nNume = antici1; |FINSI;
          |SI #nomembcf#2 = 907; nNume = antici2; |FINSI;
          || SI #nomembcf#2 = 926; nNume = antici4; |FINSI;
          |SI #nomembcf#2 = 908; nNume = especie; |FINSI;
     |FINSI;
     |SI nNume ! 0;
          |SI #nomembcf#4 = "+";
               nAjuEmb = nAjuEmb + nNume;
          |SINO;
               nAjuEmb = nAjuEmb - nNume;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomembcf;
     #nomembcf#1;
     ;
     #labtraba#0, #labtraba#1, 101;
     #labtraba#0, #labtraba#1, 999;
     ;
     NULL, nomembcf;
|FIN;

|PROCESO AjuEmb;
     nAjuEmb = 0;
     |BUCLE nomembcf;
|FPRC;

|PROCESO PagasProrr;
     swPagasProrr = 0;

     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
               mesco = paga + 19;     || mes confeccion
               nCampoPT = paga + 112;
               swSigue = 0;
               |SI #nomconca#mesco# ! 0;     || mes confeccion paga que no sea cero
                    |SI #nomconca#mesco# = 99; |O #labtraba#nCampoPT# = "S";
                         swSigue = 1;
                         || concepto = paga + 200;
                         || HAZ ExcepPagaProrr;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    swPagasProrr = swPagasProrr + 1;   || valor
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO ImporteEmbargo;
     |HAZ AjuEmb;

     |SI #nomembca#4 = 1;     || cantidad fija
          nCuotaEmb = #nomembca#5;
     |FINSI;
     |SI #nomembca#4 = 2;     || % sobre el liquido
          nCuotaEmb = ((nLiquidoNom + nLiquidoPag + nAjuEmb) % #nomembca#5) ! 2;
     |FINSI;
     |SI #nomembca#4 ] 3;     || calculo automatico
          |SI #labtraba#42 = "E";
               |SI nElAny ] 2019;
                    nSMI = 42.62 * 23;
               |FINSI;
               /*
               |SI nElAny ] 2020;
                    nSMI = 44.96 * 23;
               |FINSI;
               */
          |SINO;
               nSMI = #nomconst#89;   || Salario Minimo Interprofesional
          |FINSI;

          nInembargable = nSMI;
          |SI #labtraba#42 = "E"; |Y #nomcontr#10 = "N";
               || eventuales sin pagas
          |SINO;
               swPagasProrr = 0;
               nPropProrr = 0;
               |HAZ PagasProrr;
               |SI swPagasProrr ! 0;
                    |SI #nomcontr#64 = 2;
                         swPagasProrr = 2;
                    |FINSI;
                    nPropProrr = nInembargable * (swPagasProrr / 12);
                    nInembargable = nInembargable + nPropProrr;
               |FINSI;
          |FINSI;
          |SI nLiquidoPag > 0;
               nInembargable = nInembargable + nSMI;
          |FINSI;
          |SI #nomembca#4 = 5; |O #nomcontr#64 = 3;
               || calculo automatico, no se tienen en cuenta pagas
               nInembargable = nSMI;
          |FINSI;

          nLiqEmb = nLiquidoNom + nLiquidoPag + nAjuEmb; || liquido para calculo embargo

          |SI #labtraba#42 = "E"; |Y #nomcontr#63 = "J";
               nSMI = (nSMI / 23) ! 2;
               nLiqEmb = (nLiqEmb / fijo_1) ! 2;
               nInembargable = (nInembargable / 23) ! 2;
          |FINSI;

          |PARA nPasada = 1; |SI nPasada [ 10; |HACIENDO nPasada = nPasada + 1;
               |SI nPasada = 1; nPor = 30; |FINSI;
               |SI nPasada = 2; nPor = 50; |FINSI;
               |SI nPasada = 3; nPor = 60; |FINSI;
               |SI nPasada = 4; nPor = 75; |FINSI;
               |SI nPasada ] 5; nPor = 90; |FINSI;

               nLimite1 = nInembargable + (nSMI * (nPasada - 1));
               nLimite2 = nInembargable + (nSMI * nPasada);
               |SI nLiqEmb > nLimite1;
                    |SI nLiqEmb > nLimite2;
                         nNume1 = ((nLimite2 - nLimite1) % nPor) ! 2;
                         nCuotaEmb = nCuotaEmb + nNume1;
                    |SINO;
                         nNume1 = ((nLiqEmb - nLimite1) % nPor) ! 2;
                         nCuotaEmb = nCuotaEmb + nNume1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |SI #labtraba#42 = "E"; |Y #nomcontr#63 = "J";
               nCuotaEmb = nCuotaEmb * fijo_1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Liquido;
     nIngresos = 0;
     nDeducc = 0;
     nLiquidoNom = 0;

     nIngresosPag = 0;
     nDeduccPag = 0;
     nLiquidoPag = 0;
     nIngresos = bruto_rec;                            || BRUTO
     nDeducc = dto_con;                 || cont. comunes.
     || nDeducc = dto_con + deducss;                 || cont. comunes.
     nDeducc = nDeducc + dto_dfp;            || cont. profesionales
     nDeducc = nDeducc + dto_ho1 + dto_ho2;  || cont. horas
     nDeducc = nDeducc + antici1 + antici2 + #7#44;  || anticipos
     || nDeducc = nDeducc + antici1 + antici2 + antici4;  || anticipos
     nDeducc = nDeducc + especie;            || en especie
     || nDeducc = nDeducc + nAcumAbs;           || absentismos
     nDeducc = nDeducc + reten_1;            || retenciones IRPF

     nLiquidoNom = nIngresos - nDeducc;

     ||SI swbaja = 1; |O #labempre#25 = 2;
          nIngresosPag = 0;
          nDeduccPag = 0;

          nIngresosPag = nIngresosPag + acum2_200;  || si es baja este mes o la paga va
          nDeduccPag = nDeduccPag + reten_2;  ||/junto con el recibo, a¤ade paga
          || nDeduccPag = nDeduccPag + antici3;  || y anticipo de pagas extras

          nLiquidoPag = nIngresosPag - nDeduccPag;
     ||FINSI;
|FPRC;

|PROCESO embargame;
     nCuotaEmb = 0;
     |HAZ ImporteEmbargo;
     #nomembli#0 = #2#0;
     #nomembli#1 = #2#1;
     #nomembli#2 = nAny;
     |LEE 000#nomembli.=;
     |SI FSalida = 0;
          nEmbargo = nCuotaEmb;
          |SI #nomembli#29 < nEmbargo;
               nEmbargo = #nomembli#29;
          |FINSI;
          |SI bruto_pag = 0;
               nLiquidoNom = nLiquidoNom - nEmbargo;
          |SINO;
               nLiquidoNom = nLiquidoNom - ((nEmbargo / 2) ! 2);
               nLiquidoPag = nLiquidoPag - (nEmbargo - ((nEmbargo / 2) ! 2));
          |FINSI;
     |SINO;
          #nomembli#2 = nElAny;
          |LEE 000#nomembli.=;
          |SI FSalida = 0;
               nEmbargo = nCuotaEmb;
               |SI #nomembli#29 < nEmbargo;
                    nEmbargo = #nomembli#29;
               |FINSI;
               |SI bruto_pag = 0;
                    nLiquidoNom = nLiquidoNom - nEmbargo;
               |SINO;
                    nLiquidoNom = nLiquidoNom - ((nEmbargo / 2) ! 2);
                    nLiquidoPag = nLiquidoPag - (nEmbargo - ((nEmbargo / 2) ! 2));
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO embargos;
     nEmbargo = 0;

     |SI runnom = "nomcalfi"; |ACABA; |FINSI;

     |ABRE #nomembca;
     |ABRE #nomembli;

     #nomembca#0 = #2#0;
     #nomembca#1 = #2#1;
     |LEE 000#nomembca.=;
     |SI FSalida = 0;         || tengo embargo
          nMes = nElMes - 1;
          |SI nMes = 0;
               nMes = 12;
               nAny = nElAny - 1;
          |SINO;
               nAny = nElAny;
          |FINSI;
          |HAZ embargame;
     |FINSI;

     |CIERRA #nomembli;
     |CIERRA #nomembca;
|FPRC;

|PROCESO CompAgosto2012;
     swAgosto2012 = 0;
     |SI #0#9 ] 2012;
          |SI #0#9 > 2012; |O #0#8 ] 8;
                swAgosto2012 = 1;
          |FINSI;
     |FINSI;
|FPRC;

||***************************************************************************
||                 GRABACION DE CABECERA DE REGISTRO
||***************************************************************************

|PROCESO cabecera;
|SI cabecera = 1;          || comprueba si hay que grabar la cabecera
        seleccio = 1;
    |SI fijo_1 = 0;|Y #2#42 = "E";|Y #32#11 = 1;|Y fijo_922 = 0;
    |SINO;
        |HAZ CompAgosto2012
        |HAZ calleer;          || lee empresa, constantes y calendario
        |SI #0#9 ] 2007; |Y nEpigConv = 0;
              |BUCLELIN 0borralineas#11;
              |ACABA;
        |FINSI;

        |HAZ caldias;          || calcula los dias de enfermedad, etc.
          |SI runnom ! "nomcalir"; |Y runnom ! "nomcalfi";
               |DBASS aAlfa; |QBF aAlfa;
               |SI aAlfa = "/u/dsprofes/"; |O aAlfa = "/u/ccprofes/";
               |O aAlfa = "/u/dsasesor/"; |O aAlfa = "/u/ccasesor/";
                    |SI #labtraba#42 ! "H"; |Y #labtraba#247 ! 0138;
                         |HAZ Distribucion;
                         |HAZ Tramos;
                    |FINSI;
               |FINSI;
          |FINSI;
        |HAZ calanti;          || calcula el salario base, antiguedad y plus
        |HAZ calunac;          || calcula las unidades y los acumulados
        ||HAZ calenfe;          || calcula los complementos de enf. y acc.
        |SI #2#42 ! "E";|O #32#10 = "S";
            |HAZ calpror;          || calcula la prorrata
            |HAZ calpaga;          || calcula las pagas
        |FINSI;
        |HAZ calenfe;          || calcula los complementos de enf. y acc.
        |HAZ ERE;
        |HAZ calfin1;          || calculo final 1
        |HAZ calfin2;          || calculo final 2
        |HAZ CalIndAgr;
    |FINSI;

     |HAZ Liquido;
     |HAZ embargos;

        |DDEFECTO #11;
        #11#00 = #02#00;   || empresa
        #11#01 = #02#01;   || trabajador
        #11#02 = #00#08;   || mes
        #11#03 =      0;   || tipo
        #11#04 = #02#36;   || fecha de alta
        #11#05 = fecbaj;   || fecha de baja
        #11#06 = #02#34;   || fecha de antiguedad
        #11#07 = dia_2;    || dias periodo
        #11#08 = dcoti_0;  || dias alta
        || #11#09 = dalta_3;  || tipo contrato  (AGRARIA*) desde jornada
        #11#09 = #2#45;  || tipo contrato
        #11#10 = dbaja_3;  || dias contrato  (AGRARIA*) hasta jornada
        #11#11 = fijo_1;   || horas contrato (AGRARIA*) jornadas
        #11#12 = #02#39;   || codigo bonificacion
        #11#13 = #02#30;   || (%) IRPF 1
        #11#14 = acum_991; || base IRPF 1
        #11#15 = reten_11; || retencion IRPF 1
        #11#16 = acum2_200;|| base IRPF pagas
        #11#17 = reten_2;  || retencion IRPF pagas
        #11#18 = acum_41;  || base IRPF exenta
    |PARA campo = 12; |SI campo [ 15; |HACIENDO campo = campo + 1;
            desde = campo - 8;
            hasta = campo - 4;
            puntero = desde + 15;  #11puntero = #7desde;   || tabla de
            puntero = hasta + 15;  #11puntero = #7hasta;   || /variaciones
            puntero = campo + 15;  #11puntero = #7campo;
    |SIGUE;
        #11#31 = denfe_2;  || total dias enfermedad
        #11#32 = dacci_2;  || total dias accidente
        #11#33 = dhuel_2;  || total dias huelga
        #11#34 = dabse_2;  || total dias absentismo
        #11#35 = prom_enf; || promedio enfermedad
        #11#36 = prom_acc; || promedio accidente
        #11#37 = acum_10 + coba_3 + n400Cot;  || base cotizacion
        #11#38 = dvalo_pro;|| base prorratas
        |SI swModulo = 2884; |HAZ ModuloAdade; |FINSI;
        #11#39 = base_6;   || base cotizacion cont. comunes
        #11#40 = base_7;            || conting. profesionales segun nomina
        |SI #labtraba#42 = "E"; |Y #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || en los agrarios, el campo con la base de CC y CP sale la base
          || entera en caso de IT, incluida a parte de enf que el trabajador
          || no cotiza
          || en caso de Carencia NO, tiene que ser igual, como no cotiza nada
          || el trabajador por la parte de IT en ningun tramo (ni en los 1os
          || 15 dias), tiene que sumarse aqui todo
              #11#39 = #11#39 + nBasePagoSS_CC + (nJorITCotEmpTra * prom_enf);
              #11#40 = #11#40 + nBasePagoSS_CP + (nJorITCotEmpTra * prom_acc);
              || hombre y le resto la maternidad/paternidad, que tambien
              || puede ser un prestacion N, carencia N en maternidad y la liamos
              || o en accidente
              #11#39 = #11#39 - coba_4 - coba_2;
              #11#40 = #11#40 - cobb_4 - cobb_2;
        |FINSI;
/*
    |SI #32#12 = 1;
            #11#40 = base_7;            || conting. profesionales segun nomina
    |FINSI;
    |SI #32#12 = 2;
            #11#40 = #11#37 + #11#38;   || conting. profesionales segun TC2
    |FINSI;
*/
        #11#41 = dacum_30; || base H.E. 1
        #11#42 = dacum_31; || base H.E. 2
        #11#43 = bon_0;    || base 1 bonifi.
        #11#44 = bon_3;    || base 2 bonifi.
        #11#45 = base_E;   || S.S. cgo. empresa
        #11#46 = bruto_rec;|| bruto recibo
        #11#47 = bruto_pag;|| bruto paga
        #11#48 = dto_con;  || dto. cont. comunes
        #11#49 = dto_dfp;  || dto. D+F+P
        #11#50 = dto_ho1;  || dto. horas 1
        #11#51 = dto_ho2;  || dto. horas 2
        #11#52 = antici1;    || anticipos -1-
        #11#53 = antici2;    || anticipos -2-
        #11#54 = especie;    || en especie
        #11#89 = #7#44;    || en especie
        ||#11#55 = acum_51;  || importe ayuda familiar      (501)
        ||#11#56 = acum_52;  || importe ayuda subnormalidad (502)
        #11#57 = acum_53;  || importe enfermedad          (503)
        #11#58 = acum_54;  || importe accidentes          (504)
        #11#59 = denfe_3;  || complemento enfermedad      (511)
        #11#60 = dacci_3;  || complemento accidente       (512)
        #11#61 = bon_1;    || (%) con. comunes
        #11#62 = base_5;   || base cotiz. enfe/acci
        #11#63 = base_F;   || cuota bonif. 1
        #11#64 = base_D;   || cuota bonif. 2
        #11#107 = horasex;   || horas formacion subvencionadas
        #11#65 = dmate_2;  || total dias maternidad
        #11#66 = dvaca_2;  || total dias vacaciones
        #11#67 = #2#174;   || (%) irpf 2
        #11#68 = #2#175;   || (%) irpf 3
        #11#69 = acum_992; || base irpf 2
        #11#70 = acum_993; || base irpf 3
        #11#71 = reten_12; || reten. irpf 2
        #11#72 = reten_13; || reten. irpf 3
        #11#73 = denfe_4;  || prestacion enf. empresa     (515)
        #11#74 = acum_99;  || total irpf
        #11#75 = reten_1;  || total retenciones
        ||#11#76 = ;       || dto.pagas huelga
        ||#11#77 = ;       || dto.pagas absentismo
        #11#78 = ddese_2;       || total dias desempleo
    |SI #32#15 = "D";
            || #11#78 = difbase;   || diferencia cotizacion mes anterior (IT)
    |FINSI;
        || #11#79 = zbon_0;   || base bonificada CC (2)
        || #11#80 = zbon_3;   || base bonificada CP (2)
        #11#79 = nBasePagoSS_CC;   || BASE CONT. EMP. CC
        #11#80 = nBasePagoSS_CP;   || BASE CONT. EMP. CP
        |SI #labtraba#42 = "E"; |Y #labtraba#241 = "N"; |Y #labtraba#138 = "N";
              #11#79 = #11#79 + (nJorITCotEmpTra * prom_enf);
              #11#80 = #11#80 + (nJorITCotEmpTra * prom_acc);
        |FINSI;
        #11#81 = zbase_F;  || cuota bonif. (1)
        #11#82 = nPorBon1; || (%) bonif. (1), para el TC2/1
        #11#83 = nPorBon2; || (%) bonif. (2), para el TC2/1
        #11#84 = nDesem;    || base ILT bonificada (1), para el TC2/1
        || #11#85 = zbon_5;   || base ILT bonificada (2), para el TC2/1
        #11#55 =  jornadasIT - nJornadasERE;  || jornadas en IT
        #11#56 = bbase_F;  || cuota bonificada en baja
        ||#11#89 = base_M;  || cuota bonificada en maternidad
        #11#87 = #2#30;       || % IRPF Pagas
        #11#88 = bon_60;   || importe bonificacion mayores 60 a¤os RDL 16/2001
        #11#96 = nBonifFCI;   || importe boni. fomento cont. indef. RDL 5/2006

        #11#104 = nEmbargo; || importe embargo
        #11#106 = bon_59;
        |SI swBaseFija = 1;
             #11#114 = nDiasPagoSS;
             #11#115 = nBasePagoSS_CC;
             #11#134 = nBasePagoSS_CP;
        |FINSI;
        |SI swJornadas = 1;
             #11#114 = nJornPagoSS;
             #11#115 = nBasePagoSS_CC;
             #11#134 = nBasePagoSS_CP;
             #11#124 = nDiasPagoSS;
        |FINSI;
        |SI #labtraba#42 = "E"; |Y #labtraba#241 = "N"; |Y #labtraba#138 = "N";
             #11#115 = nBasePagoSS_CC + (nJorITCotEmpTra * prom_enf);
             #11#134 = nBasePagoSS_CP + (nJorITCotEmpTra * prom_acc);
        |FINSI;
        #11#116 = pilt_enf;
        #11#118 = nRedFija;

        #11#92 = #nomvarca#35;
        #11#93 = #nomvarca#36;
        #11#94 = #nomvarca#37;
        #11#95 = #nomvarca#38;
        #11#97 = #nomvarca#39;
        #11#98 = #nomvarca#40;
        #11#99 = #nomvarca#41;
        #11#100 = #nomvarca#42;
        #11#101 = #nomvarca#43;

          #11#108 = bruto_rec + base_E;      || coste total trabajador
          #11#109 = nLiquidoNom;             || liquido nomina
          #11#110 = acum2_200;               || coste pagas
          #11#111 = nLiquidoPag;             || liquido pagas
          #11#112 = #11#108 + #11#110;       || total coste
          #11#113 = #11#109 + #11#111;       || total liquido
          #11#131 = dcont_2;       || dias en situacion de IT control S.S.
          |SI #11#131 > 0;
               #11#65 = #11#65 - #11#131;
          |FINSI;
          #11#132 = base_11;       || base en situacion de IT control S.S.

        #11#125 = nBonifERE;     || importe bonificacion ERE 50% CC
        #11#126 = nDiasBonifERE; || Dias bonificacion ERE 50% CC
        #11#127 = #2#242;        || base diaria en ERE
        #11#128 = nDesem;        || base total en ERE
        #11#138 = nJornadasERE;  || Jornadas en ERE, este campo mismo

     |SI runnom ! "nomcalir";
          |SI #0#9 ] 2012;
               |HAZ GrabaCotiz;
          |FINSI;
     |FINSI;

     #11#117 = coba_4;
     |SI #labtraba#138 = "N"; |Y #labtraba#241 = "N";
          #11#117 = #11#117 - coba_1;
     |FINSI;

     #11#148 = #nomcalcc#42;       || reduccion CC Alta
     #11#155 = #nomcalcc#43;       || total reduccion CC IT
     #11#156 = #nomcalcc#44;       || total reduccion Des IT

     #11#149 = nRedCCEnf;
     #11#150 = nRedDesEnf;
     #11#151 = nRedCCMat;
     #11#152 = nRedDesMat;
     #11#153 = nRedCCAcc;
     #11#154 = nRedDesAcc;

     #11#157 = nRedCCEnfEmp;
     #11#158 = nRedDesEnfEmp;

     #11#146 = nATEP_IT;

     #11#164 = dto_sol_emp;
     #11#165 = dto_sol_tra;

     #11#184 = #0#9;
     fFecha = ~; #11#188 = fFecha;
     |SI #nomvarca#19 ! 0; #11#185 = #nomvarca#28; |FINSI;
     |SI #nomvarca#20 ! 0; #11#186 = #nomvarca#29; |FINSI;
     |SI #nomvarca#44 ! 0; #11#187 = #nomvarca#45; |FINSI;
     |HAZ VersionNom_plb;
     #11#190 = aVersion;

     |HAZ SS_Empresa;

    |SI #2#42 = "E";|Y #32#11 = 1;
        |SI fijo_1 ! 0;|O fijo_922 ! 0;  |GRABA 020#11a;   |FINSI;
        |SI fijo_1 = 0;|Y fijo_922 = 0;  |GRABA 020#11n;   |FINSI;
    |SINO;
        |GRABA 020#11a;
    |FINSI;
     |SI runnom ! "nomcalir";
          |SI #0#9 ] 2012;
               |HAZ GrabaCotiz;
          |FINSI;
     |FINSI;
     |LIBERA #11;
     |SI #0#9 ] 2012; |Y #labtraba#247 = 613;
          #labtraba#247 = 163;
          |GRABA 020#labtraba.a;
          |LIBERA #labtraba;
     |FINSI;
     |SI nIncid = 0;
          nIncid = 999;
          |HAZ graba_inc;
     |FINSI;
     |HAZ BuscaModulo;
     |SI swModulo = 002884; |O swModulo = 1;
          |SI swbaja = 1;
               |HAZ GrabaFiniqCero;
          |FINSI;
     |FINSI;
|FINSI;
|FPRC;

||****************************************************************************
||            RUTINAS GENERALES ESPECIFICAS O COMUNES A CALCULOS
||****************************************************************************

|PROCESO pintalo;
|PINTA 2171, #2#0;
|PINTA 2271, #2#1;
|FPRC;

|PROCESO leeregis;  || si existe registro anterior se borra (nomcalcu,nomcalf2)
    #11#0 = #2#0;
    #11#1 = #2#1;
    #11#2 = #0#8;
    #11#3 = 0;
|LEE 000#11=;
|SI FSalida = 0;
    |BUCLELIN 1NULL#11;
    |BORRA 020#11a;
|FINSI;
    cabecera = 0;     || switch para ver si tiene que grabar cabecera al final
    fijo_1 = 0;       || dias cotizados citricos
    fijo_922 = 0;
    tp = 1;
|SI #2#42 = "X";|O #2#42 = "T";
    |SI #2#234 ! 0;
            tp = #2#234 / 40;    || proporcion de los tiempos parciales
    |FINSI;
|FINSI;
     |SI #2#237 = "N";                  || variables para los pluriempleados
          grupo = #2#33;
          propo = 100;
     |SINO;
          grupo = #2#236;       || grupo mayor de cotiz. en pluriempleo
          propo = #2#235;       || proporcion en pluriempleo
     |FINSI;
|FPRC;

|PROCESO convenio;     || comprueba si existe linea de convenio
    convenio = 1;
    #10#00 = #2#87;
    #10#02 = concepto;
|LEE 000#10=;
|SI FSalida = 0;|O concepto ] 901; || los conceptos 9xx pasan aunque no esten
        convenio = 0;
    |SI concepto ] 901;
        |HAZ novecien;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO novecien;    || chequea los conceptos 9xx
|SI concepto = 901;
    |HAZ novecie1;
        #10#6 = "N§ HORAS";
|FINSI;
|SI concepto = 902;
    |HAZ novecie1;
        #10#6 = "INDEMNI.";
|FINSI;
|SI concepto = 903;
        #10#3 = "V";
        #10#4 = 0;               || el concepto 903 esta reservado
        #10#5 = 0;               || /para que guarde los dias cotizados
        #10#6 = "*AGRARIO";      || en el modulo agrario (AGRARIA*)
        fijo_1= unidades;        || se los guarda en `fijo_1`
|FINSI;
|SI concepto = 904;
    |HAZ novecie1;
        #10#6 = "VACACION";
|FINSI;
|SI concepto = 905;
    |HAZ novecie1;
        #10#6 = "HORAS TP";
|FINSI;
|SI concepto =906;
    |HAZ novecie1;
     #10#6 = "ANTICIPOS";
|FINSI;
|SI concepto=907;
    |HAZ novecie1;
     #10#6 = "ANTICIPOS";
|FINSI;
|SI concepto = 908;
    |HAZ novecie1;
        #10#6 = "ESPECIE";
|FINSI;
|SI concepto = 922;
    |HAZ novecie1;
        #10#6 = "JORN. IT";
        fijo_922 = unidades;        || se los guarda en `fijo_922`
|FINSI;
|SI concepto = 929;
    |HAZ novecie1;
        #10#6 = "PROMEDIO IT";
        prom_enf_929 = importe;
|FINSI;
|SI concepto = 931;
    |HAZ novecie1;
    #10#6 = "JOR.IT 1";
|FINSI;
|SI concepto = 932;
    |HAZ novecie1;
    #10#6 = "JOR.IT 2";
|FINSI;
|SI concepto = 933;
    |HAZ novecie1;
    #10#6 = "JOR.IT 3";
|FINSI;
|SI concepto = 934;
    |HAZ novecie1;
    #10#6 = "JOR.IT 4";
|FINSI;
|SI concepto = 935;
    |HAZ novecie1;
    #10#6 = "JORN.ERE";
    nJornadasERE = unidades;
|FINSI;
|SI concepto = 941;
    |HAZ novecie1;
    #10#6 = "J.COT.ET";
    nJorITCotEmpTra = unidades;
|FINSI;
|SI concepto = 942;
    |HAZ novecie1;
    #10#6 = "J.COT.E.";
    nJorITCotEmp = unidades;
|FINSI;

|SI concepto ] 909; |Y concepto ! 922; |Y concepto ! 929;
|Y concepto ! 931; |Y concepto ! 932; |Y concepto ! 933; |Y concepto ! 934;
|Y concepto ! 935; |Y concepto ! 941; |Y concepto ! 942;
        || si es ] 906 no lo graba !!!
        convenio = 1;
|FINSI;
|FPRC;

|PROCESO novecie1;
    #10#3 = "V";
    #10#4 = 0;
    #10#5 = 0;
|FPRC;

|PROCESO recarga;   || recarga campos de las lineas del nomcalli
    #12#00 = #02#00;   || codigo empresa
    #12#01 = #02#01;   || codigo trabajador
    #12#02 = #00#08;   || mes
    #12#03 =      0;   || tipo
    #12#05 = #10#03;   || calculo alfa
|SI #10#03 = "Z";
    |SI #2#42 = "M";|O #2#42 = "X";  #12#05 = "F";  |FINSI;  || mensual
    |SI #2#42 = "D";|O #2#42 = "T";  #12#05 = "M";  |FINSI;  || diario
|FINSI;
|SI #12#05 = "Z";        || si no es mensual ni diario
        #12#05 = "F";
|FINSI;
    #12#06 = #10#04;   || calculo nume
    #12#07 = #10#05;   || situacion
    #12#08 = #10#06;   || descripcion
    #12#11 =      0;   || unidades calculo
|FPRC;

|PROCESO leedoce;
|LIBERA #12;
    #12#0 = #2#0;
    #12#1 = #2#1;
    #12#2 = #0#8;
    #12#3 = 0;
    #12#4 = doce;
|LEE 100#12=;
|FPRC;

|PROCESO cogegra;
    graba05 = #10#3;
    graba06 = #10#4;
    graba07 = #10#5;
    graba08 = #10#6;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
    bisiesto = 0;
    numer = anynum $ 4;
|SI numer = 0;|Y #32#9 = "S";
        bisiesto = 1;
|FINSI;
    topemes = 31;
|SI mesnum= 2;
        topemes = 28 + bisiesto;
|FINSI;
|SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
        topemes = 30;
|FINSI;
|FPRC;

|PROCESO grabacon;        || GRABA O REGRABA LINEAS DE CALCULO SEGUN VARIABLES
    doce = graba04;
|HAZ leedoce;
    FEstado = FSalida;
|SI FEstado ! 0; |O swgracon = 1;    || switch para regrabar campos convenio
        #12#05 = graba05; || calculo alfa
        #12#06 = graba06; || calculo nume
        #12#07 = graba07; || situacion
        #12#08 = graba08; || descripcion
|FINSI;
|SI FEstado = 0; |Y swcongra = 1;    || switch para regrabar acumulando
        tempo1 = #12#10;  || valor anterior
        tempo2 = #12#11;  || unidades calculo anterior
        tempo3 = graba10; || valor actual
        tempo4 = graba11; || unidades calculo actual
        tempo5 = (tempo1 * tempo2) + (tempo3 * tempo4); || importe total
        graba10 = tempo5; || valor concepto nuevo
        graba11 = 1;      || unidades calculo concepto nuevo
|FINSI;
    #12#09 = graba09;     || unidades
    #12#10 = graba10;     || valor
    #12#11 = graba11;     || unidades calculo
|SI FEstado ! 0;  |GRABA 020#12n;  |FINSI;
|SI FEstado = 0;  |GRABA 020#12a;  |FINSI;
|LIBERA #12;
|FPRC;

|PROCESO coefi;      || CALCULA EN 'dcofi_999' COEFICIENTE SEGUN LINEA CALCULO
    concepto = #12#4;
    unidades = #12#9;
|HAZ convenio;       || lee el concepto del convenio para recoger vacaciones
|SI #12#5 ="M"; #12#9 = dia_4;  |FINSI; || si es 'M' le pone dias cotizables
|SI #12#5 ="D"; #12#9 = dia_2;  |FINSI; || si es 'D' le pone dias del mes
|SI #12#6 = 0;  dcofi_999 = 1;        |FINSI;
|SI #12#6 = 1;  dcofi_999 = dcofi_1;  |FINSI;  || dias cobro
|SI #12#6 = 2;  dcofi_999 = dcofi_2;  |FINSI;  || dias cotizables
|SI #10#7="N";|Y #12#6=1; dcofi_999=dcofi_5; |FINSI; || no entra en vacaciones
|SI #10#7="E";|Y #12#6=1; dcofi_999=dcofi_6; |FINSI; || solo entra en vacaciones
|SI #12#5 ="L";         || dias laborables
    |SI #10#7 = "S";  #12#9 = dlabo_0;  |FINSI;
    |SI #10#7 = "N";  #12#9 = vlabo_0;  |FINSI;
    |SI #10#7 = "E";  #12#9 = dvaca_1;  |FINSI;
|FINSI;
|SI #12#5 ="K";         || dias festivos
    |SI #10#7 = "S";  #12#9 = dlabo_k;  |FINSI;
    |SI #10#7 = "N";  #12#9 = vlabo_k;  |FINSI;
    |SI #10#7 = "E";  #12#9 = dvaca_k;  |FINSI;
|FINSI;
|SI #12#5 ="L";|O #12#5 ="K";
        dcofi_999 = 1;
|FINSI;
|FPRC;

|PROCESO cal_vaca;
|SI #10#7 = "S";|O #10#7 = "E";   || si entra en vacaciones
    |SI #12#05="D";                divide=dia_2;     |FINSI; || dias mes
    |SI #12#05="M";                divide=dia_4;     |FINSI; || dias cotiz.
    |SI #12#05="L";|O #12#05="K";  divide=#12#09;    |FINSI; || dias lab./fes.
    |SI #12#05="V";|O #12#05="F";  divide=   30;     |FINSI; || dias fijos
        product = #12#09 * #12#10;
        product = product ! EURODB;
        dacum_vac = dacum_vac + (product / divide);
|FINSI;
|FPRC;

||***************************************************************************
||   CALCULO DE LECTURA DE EMPRESA,CALENDARIO Y CONSTANTES Y BONIFICACIONES
||****************************************************************************

|PROCESO constante;
     alfa1 = "01";
     alfa2 = #0#8;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #0#9;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
     |SI aCError ! "";
/*          |SI nCConst = 900;
               aAlfa = "0000No se ha encontrado la Constante Comun del ";
               aAlfa = aAlfa + " Regimen General (900)";
               |MENAV aAlfa;
          |SINO;
               alfa1 = #labtraba#0; alfa1 = "00000" + #labtraba#0; alfa1 = alfa1 % -105;
               alfa2 = #labtraba#1; alfa2 = "00000" + #labtraba#1; alfa2 = alfa2 % -105;
               aAlfa = "0000ATENCION: Trabajador: " + alfa1 + "." + alfa2;
               aAlfa = aAlfa + " La constante del trabajador no esta definida.";
               |MENAV aAlfa;
          |FINSI;
*/
     |FINSI;
|FPRC;

|PROCESO lee_control;
     |DDEFECTO #32;
     |ABRE #32;
     |LEE 000#32p;
     |CIERRA #32;

     #32#17 = 3;    || paso, para los agrarios mensuales que lo haga
     #32#18 = 3;    || siempre como "3"
|FPRC;

|PROCESO calleer;  || LEE EMPRESA, CONSTANTE Y CALENDARIO
     |DDEFECTO #1;
     |ABRE #1;
     #1#0 = #11#0;
     |LEE 000#1=;
     |CIERRA #1;
     |SI CodigoCons = 0;
          CodigoCons = #1#32;
     |FINSI;

     |SI #20#0 ! #2#156; |O #20#13 ! #0#9;
          |DDEFECTO #20;
          |ABRE #20;
          #20#0  = #2#156;
          #20#13 = #0#9;
          |LEE 000#20=;                  || solo lee el calendario si ha cambiado
          topemes1 = 0;
          topemes2 = 0;   || calcula los dias laborables del mes
          swmarca = "A";
          |HAZ calendar;
          conser1 = dialabo;   || guarda los dias laborables del mes
          conser2 = diafest;   || guarda los dias festivos del mes
          |CIERRA #20;
     |FINSI;

     nCConst = #labtraba#248;
     |HAZ constante;

     |SI aCError ! "";
          nIncid = 3;
          |HAZ graba_inc;
     |FINSI;

     por1_cont = #15#07;                             || (%) contigen. (trab.)
     por2_cont = #15#06 + #15#74;                    || (%) contigen. (emp.)
     por1_hor1 = #15#09;                             || (%) horas 1   (trab.)
     por2_hor1 = #15#08;                             || (%) horas 1   (emp.)
     por1_hor2 = #15#11;                             || (%) horas 2   (trab.)
     por2_hor2 = #15#10;                             || (%) horas 2   (emp.)
     por1_dfpg = #15#13 + #15#15 + #15#17 + #15#19;  || (%) d+f+p+g   (trab.)
     por2_dfpg = #15#12 + #15#14 + #15#16 + #15#18;  || (%) d+f+p+g   (emp.)
     |SI #2#42 ! "A"; |Y #2#42 ! "E";  || eventuales cotizan desempleo Jun02
          por1_dfpg = por1_dfpg - #15#13;      || fijos sin desempleo
          por2_dfpg = por2_dfpg - #15#12;      || eventuales ya no
     |FINSI;

     |DDEFECTO #16;
     |ABRE #16;
     #16#0 = #2#39;
     |LEE 000#16=;
     |SI FSalida = 0;
          nMes = #0#8;
          nAny = #0#9;
          nCodigoBon = #16#0;
          |HAZ VerifBonif;
          |SI swAgosto2012 = 1; |Y #nombonif#27 = "N";
              |DDEFECTO #16;
          |FINSI;
     |FINSI;
     |SI #16#10 = 4;
          por1_dfpg = 0;  || (%) d+f+p+g  (tra.)
          por2_dfpg = 0;  || (%) d+f+p+g  (emp.)
     |FINSI;

     |CIERRA #16;

     |ABRE #17;
     |DDEFECTO #17;
     |SI #0#9 [ 2006;
          nEpigConv = #2#32;
     |SINO;
          |HAZ VerifCNAE;
     |FINSI;
     #17#0 = nEpigConv;
     |LEE 000#17=;            || lee epigrafe
     epig_ilt = #17#1;
     epig_ims = #17#2;
     |CIERRA #17;

     |ABRE #19;
     #19#0 = #2#0;
     #19#1 = #2#1;
     #19#2 = #2#32;
     |LEE 000#19=;            || lee epigrafes/trabajador
     |SI FSalida = 0;
          epig_ilt = #19#3;
          epig_ims = #19#4;
     |FINSI;
     |CIERRA #19;

     alfa1 = "01";
     alfa2 = #0#8;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #0#9;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFechaCot = alfa4;         || primer dia de mes de calculo
     aCErrorCot = "";            || inicializo errores
     |HAZ LeeCotAgr;
     |SI aCErrorCot ! "";
          |MENAV aCErrorCot;
     |FINSI;
|FPRC;

||****************************************************************************
||                       CALCULO DE DIAS (nomcalcu,nomcalf2)
||****************************************************************************

|PROCESO caldias;        || CALCULA DIAS VARIOS
     |HAZ cerodias;           || inicializa variables
     dia_k = diafest;     || dias festivos del mes
     dia_1 = dialabo;     || dias laborables del mes
     dia_2 = topemes;     || dias que tiene el mes
     dia_3 = 30;          || dias cotizacion 'mensual'
     |SI #2#42 = "D";|O #2#42 = "T";
     |O #2#42 = "E";     || se supone que los eventuales los trato como diarios
                    || 09.03.2009 (3923.95)
          dia_3 = topemes; || dias cotizacion 'diario'
     |FINSI;
     swmarca = "B";
     |HAZ altas;              || calcula dias de alta (en su caso)
     |HAZ bajas;              || calcula dias de baja (en su caso)
     |SI #7#12 = " ";|Y #7#13 = " ";|Y #7#14 = " ";|Y #7#15 = " ";
          |SI #2#89 ! 0;  #7#12 = #2#60;  |FINSI;
          |SI #2#92 ! 0;  #7#12 = "A";    |FINSI;
     |FINSI;
     |PARA campos = 12; |SI campos [ 15; |HACIENDO campos = campos + 1;
          |SI #7campos ! " ";
               camdes = campos - 8;  topemes1 = #7camdes;
               camhas = campos - 4;  topemes2 = #7camhas;
               nDiaRealIniIT = topemes1;

               |SI swbaja = 1;
                    aAlfa = fecbaj % 102;
                    nume1 = aAlfa;
                    nume2 = #7camdes;
                    |SI nume2 = 0; nume2 = 1; |FINSI;
                    nume3 = #7camhas;
                    |SI nume3 = 0; nume3 = topemes; |FINSI;
                    |SI nume2 [ nume1; |Y nume1 [ nume3;
                         nIncid = 62;
                         |HAZ graba_inc;
                    |FINSI;
               |FINSI;

               dias_v = 0;

               |SI topemes1 = 0;  topemes1 =      1;  |FINSI;
               |SI topemes2 = 0;  topemes2 = guarda;  |FINSI;

               |SI topemes1 < dalta_3; #7camdes = dalta_3; topemes1 = dalta_3; |FINSI;
               |SI topemes2 > dbaja_3; #7camhas = dbaja_3; topemes2 = dbaja_3; |FINSI;

               |SI #7campos="H";                 swmarca="B"; |FINSI; || baja
               |SI #7campos="A";                 swmarca="J"; |FINSI; || accidente
               |SI #7campos="F";                 swmarca="K"; |FINSI; || absentismo
               |SI #7campos="E";|O #7campos="M"; |O #7campos="P"; |O #7campos="R";
               |O #7campos="C";
                    swmarca="I";
               |FINSI; || enfer./mater.
               |SI #7campos="V";                 swmarca="A"; |FINSI; || vacaciones

               |HAZ calendar;

               |SI #7campos = "H";|Y topemes2 = guarda;  swaju_hue = 1;  |FINSI;
               |SI #7campos = "F";|Y topemes2 = guarda;  swaju_abs = 1;  |FINSI;
               |SI #7campos = "A";|Y topemes2 = guarda;  swaju_acc = 1;  |FINSI;
               |SI #7campos = "E";|Y topemes2 = guarda;  swaju_enf = 1;  |FINSI;
               |SI #7campos = "M";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
               |SI #7campos = "P";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
               |SI #7campos = "R";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
               |SI #7campos = "C";|Y topemes2 = guarda;  swaju_mat = 1;  |FINSI;
               |SI #7campos = "V";|Y topemes2 = guarda;  swaju_vac = 1;  |FINSI;

               dias_v = (topemes2 - topemes1) + 1;

               |SI #7campos = "H";  |HAZ huelga;  |FINSI;  || calcula dias huelga
               |SI #7campos = "F";  |HAZ absent;  |FINSI;  || calcula dias absen.
               |SI #7campos = "A";  |HAZ accide;  |FINSI;  || calcula dias accid.
               |SI #7campos = "E";  |HAZ enferm;  |FINSI;  || calcula dias enfer.
               |SI #7campos = "M";  |HAZ matern;  |FINSI;  || calcula dias mater.
               |SI #7campos = "P";  |HAZ matern;  |FINSI;  || calcula dias mater.
               |SI #7campos = "R";  |HAZ matern;  |FINSI;  || calcula dias mater.
               |SI #7campos = "C";  |HAZ matern;  |FINSI;  || calcula dias mater.
               |SI #7campos = "V";  |HAZ vacaci;  |FINSI;  || calcula dias vacac.
               |SI #7campos = "D";  |HAZ desemp;  |FINSI;  || calcula dias ERE.
               |SI #7campos = "E";
                    |HAZ diasenf0;           || desglosa los dias de enfermedad
               |FINSI;
          |FINSI;
     |SIGUE;
     |HAZ AbsHueVacNUEVO;
     |HAZ diatodos;
     ||HAZ diasenf0;           || desglosa los dias de enfermedad

     |HAZ bonif;              || calcula dias bonificacion
|FPRC;

|PROCESO nomabsca;
     swNoEntra = 0;
     nNume1 = 8;

     |ABRE #nomabsca;
     #nomabsca#0 = #labtraba#0;
     #nomabsca#1 = #labtraba#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;
          nNume1 = #nomabsca#2;
          swNoEntra = 1;
     |FINSI;

     |CIERRA #nomabsca;
|FPRC;

|PROCESO Absentismos;
     alfa1 = #nomabsli#2;
     alfa1 = alfa1 % 102;
     topemes1 = alfa1;
     alfa2 = #nomabsli#3;
     alfa2 = alfa2 % 102;
     topemes2 = alfa2;
     |SI #nomabsli#4 = "A";
          swmarca = "K";
     |FINSI;
     |SI #nomabsli#4 = "V";
          swmarca = "A";
     |FINSI;
     |SI #nomabsli#4 = "H";
          swmarca = "B";
     |FINSI;
     |HAZ nomabsca;

     |SI #nomabsli#6 = 0;
          dias_v = topemes2 - topemes1 + 1;
     |SINO;
          dias_v = (topemes2 - topemes1 + 1) * ((#nomabsli#6 / nNume1) ! 3);
     |FINSI;

     |HAZ calendar;

     |SI swmarca = "K";
          swaju_abs = 1;
          |HAZ absent;
     |FINSI;
     |SI swmarca = "A";
          swaju_vac = 1;
          |HAZ vacaci;
     |FINSI;
     |SI swmarca = "B";
          swaju_hue = 1;
          |HAZ huelga;
     |FINSI;
|FPRC;

|DEFBUCLE AbsHueVac;
     #nomabsli#1;
     ;
     #labtraba#0, #labtraba#1, fFechaDesde;
     #labtraba#0, #labtraba#1, fFechaHasta;
     ;
     NULL, Absentismos;
|FIN;

|PROCESO AbsHueVacNUEVO;
     mesnum = #0#8;
     anynum = #0#9;
     alfa1 = "01";
     alfa2 = topemes;
     alfa3 = mesnum; alfa3 = "00" + mesnum; alfa3 = alfa3 % -102;
     alfa4 = anynum;
     aFechaDesde = alfa1 + "." + alfa3 + "." + alfa4;
     aFechaHasta = alfa2 + "." + alfa3 + "." + alfa4;
     fFechaDesde = aFechaDesde;
     fFechaHasta = aFechaHasta;
     |BUCLE AbsHueVac;
|FPRC;


||****************************************************************************
||                        RUTINAS DEL CALCULO DE DIAS
||****************************************************************************

|PROCESO cerodias;     || INICIALIZA VARIABLES DEL CALCULO DE DIAS
    dalta_1 = 0;   dalta_2 = 0;   dalta_k = 0;
    dbaja_1 = 0;   dbaja_2 = 0;   dbaja_k = 0;
    dhuel_1 = 0;   dhuel_2 = 0;   dhuel_k = 0;
    dabse_1 = 0;   dabse_2 = 0;   dabse_k = 0;
    ddese_1 = 0;   ddese_2 = 0;   ddese_k = 0;
    dacci_0 = 0;   dacci_1 = 0;   dacci_k = 0;   dacci_2 = 0;
    denfe_0 = 0;   denfe_1 = 0;   denfe_k = 0;   denfe_2 = 0;
    denfe_3 = 0;   denfe_4 = 0;
    denfe_A = 0;   denfe_B = 0;   denfe_C = 0;   denfe_D = 0;
    dmate_0 = 0;   dmate_1 = 0;   dmate_k = 0;   dmate_2 = 0;
    dvaca_1 = 0;   dvaca_2 = 0;   dvaca_k = 0;
    dboni_1 = 0;   dboni_2 = 0;
    topemes1 = 0;  topemes2 = 0;
    topemes = guarda;             || restaura ultimo dia natural del mes
    dialabo = conser1;            || restaura dias laborables del mes
    diafest = conser2;            || restaura dias festivos del mes
    swaju_mat = 0;
    swaju_acc = 0;
    swaju_enf = 0;
    swaju_hue = 0;
    swaju_abs = 0;
    swaju_vac = 0;
    swajuen = 0;
    swajuac = 0;
    histori = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";  || hay 31 as
    dacum_vac = 0;

    dvalo_pro = 0;  || acumulador total prorratas
    dvalo_pag = 0;  || acumulador total pagas
    perio1 = 0;        perio5 = 0;
    perio2 = 0;        perio6 = 0; || acumuladores de dias paga
    perio3 = 0;        perio7 = 0;
    perio4 = 0;        perio8 = 0;
    acum1_200 = 0;
    acum2_200 = 0;
    swpaga = 0;
    swBaseDiario = 0;
    dcont_2 = 0;

    coba_1 = 0;
    cobb_1 = 0;
    coba_2 = 0;
    cobb_2 = 0;
    coba_3 = 0;
    cobb_3 = 0;
    coba_4 = 0;
    cobb_4 = 0;
     nJorITCotEmpTra = 0;
     nJorITCotEmp = 0;
     n400Cot = 0;
     dto_sol_emp = 0;
     dto_sol_tra = 0;
     dreca_0 = 0; dreca_1 = 0; dreca_2 = 0; dreca_3 = 0; dreca_4 = 0;
     swITEmp = 0;
     nPrestacionEnf = 0;
|FPRC;

|PROCESO calendar;                 || CALCULA LOS DIAS LABORABLES
    nume1 = #0#8;
    meslabo = #20nume1;
    dialabo = 0;
    diafest = 0;
|SI topemes1 = 0; topemes1 = 1;      |FINSI;
|SI topemes2 = 0; topemes2 = guarda; |FINSI;
|PARA mid = topemes1; |SI mid [ topemes2; |HACIENDO mid = mid + 1;
        nume1 = (mid * 100) + 1;
        alfa1 = meslabo % nume1;
    |SI alfa1 = "0";
            dialabo = dialabo + 1;     || cuenta dias laborables
    |SINO;
            diafest = diafest + 1;     || cuenta dias festivos
    |FINSI;
    |SI swmarca ! "A";                 || construye las variaciones en variab.
            alfa1 = histori % 0;  nume0 = alfa1;         || longitud
            nume1 = (100 + (mid - 1));                   || parte izquierda
            alfa1 = histori % nume1;
            nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
            alfa2 = histori % nume2;
            histori = alfa1 + swmarca + alfa2;           || une
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO altas;
    swalta = 0;
    fecalf = #2#36;
    dalta_3 = 1;
|HAZ desglosa;
|SI mes = #0#8; |Y any = #0#9;     || si es alta este mes
        swalta = 1;
        topemes1 = 0;
        topemes2 = dia - 1;
        dialabo = 0;
        diafest = 0;
    |SI topemes2 ! 0;  |HAZ calendar;  |FINSI;  || por si es alta el dia 1
        dalta_k = diafest;         || dias festivos antes del alta
        dalta_1 = dialabo;         || dias laborables antes del alta
        dalta_2 = dia - 1;         || dias cotizables antes del alta
        dalta_3 = dia;             || dia que es alta
|FINSI;
|FPRC;

|PROCESO bajas;
    swbaja = 0;
    dbaja_3 = dia_2;
    fecbaj = #2#37;
|SI #7#16 ! "..........";|Y #7#16 ! "          ";
        fecbaj = #7#16;
|FINSI;
    fecalf = fecbaj;
|HAZ desglosa;
|SI mes = #0#8; |Y any = #0#9;     || si es baja este mes
        swbaja = 1;
        topemes1 = dia + 1;
        topemes2 = 0;
        dialabo = 0;
        diafest = 0;
    |SI topemes1 [ guarda;  |HAZ calendar;  |FINSI;  || por si es final de mes
        dbaja_k = diafest;         || dias festivos despues de la baja
        dbaja_1 = dialabo;         || dias laborables despues de la baja
        dbaja_2 = dia_2 - dia;     || dias cotizables despues de la baja
        dbaja_3 = dia;             || dia hasta el que trabaja
|FINSI;
|FPRC;

|PROCESO huelga;
    dhuel_k = dhuel_k + diafest;     || dias festivos que esta en huelga
    dhuel_1 = dhuel_1 + dialabo;     || dias laborables que esta en huelga
    dhuel_2 = dhuel_2 + dias_v; || dias cotizables que idem
|FPRC;

|PROCESO absent;
    dabse_k = dabse_k + diafest;     || dias festivos que esta absento
    dabse_1 = dabse_1 + dialabo;     || dias laborables que esta absento
    dabse_2 = dabse_2 + dias_v; || dias cotizables que idem
|FPRC;

|PROCESO accide;
    dacci_0 = #2#92;
    dacci_k = dacci_k + diafest;     || dias festivos que esta accidentado
    dacci_1 = dacci_1 + dialabo;     || dias laborables que esta accidentado
    dacci_2 = dacci_2 + dias_v; || dias cotizables que idem
     nume1 = campos + 23;
     |SI #7#43 ! 0; |Y #7nume1 = "S";
          |SI campos = 12; dreca_1 = #7#43; |FINSI;
          |SI campos = 13; dreca_2 = #7#43; |FINSI;
          |SI campos = 14; dreca_3 = #7#43; |FINSI;
          |SI campos = 15; dreca_4 = #7#43; |FINSI;
     |FINSI;
|FPRC;

|PROCESO enferm;   || solo lo tendra en cuenta si no esta en periodo de
     |SI #2#60 ! "M"; |Y #2#60 ! "P"; |Y #2#60 ! "C";
           ||     maternidad !!! o paternidad !!!
          denfe_0 = #2#89;
     |FINSI;
     denfe_k = denfe_k + diafest;     || dias festivos que esta enfermo
     denfe_1 = denfe_1 + dialabo;     || dias laborables que esta enfermo
     denfe_2 = denfe_2 + dias_v; || dias cotizables que idem
     nume1 = campos + 23;
     |SI #7#43 ! 0; |Y #7nume1 = "S";
          |SI campos = 12; dreca_1 = #7#43; |FINSI;
          |SI campos = 13; dreca_2 = #7#43; |FINSI;
          |SI campos = 14; dreca_3 = #7#43; |FINSI;
          |SI campos = 15; dreca_4 = #7#43; |FINSI;
     |FINSI;
|FPRC;

|PROCESO desemp;
    ddese_k = ddese_k + diafest;     || dias festivos en desempleo
    ddese_1 = ddese_1 + dialabo;     || dias laborables en desempleo
    ddese_2 = ddese_2 + (topemes2 - topemes1 + 1); || dias cotizables
|FPRC;

|PROCESO matern;   || solo lo tendra en cuenta si no esta en periodo de
|SI #2#60 ! "E";   ||                                        enfermedad !!!
    dmate_0 = #2#89;
|FINSI;
    dmate_k = dmate_k + diafest;     || dias festivos que esta pariendo
    dmate_1 = dmate_1 + dialabo;     || dias laborables que esta pariendo
    dmate_2 = dmate_2 + dias_v; || dias cotizables que idem

     |SI #7campos = "C";
          dcont_2 = dcont_2 + dias_v;      || dias naturales en IT control SS
     |FINSI;

||FINSI; antes estaba aqui el FINSI pero no lo hacia bien en el caso de
|| del 0 - 25 "E" y del 26 - 0 "M" por ejemplo 07.10.2004
|FPRC;

|PROCESO vacaci;
    dvaca_k = dvaca_k + diafest;   || dias festivos de vacaci.
    dvaca_1 = dvaca_1 + dialabo;   || dias laborables de vacaci.
    dvaca_2 = dvaca_2 + dias_v; || dias cotiz. de vacaci.
|FPRC;

|PROCESO diasenf0;  || DESGLOSA LOS DIAS DE ENFERMEDAD (posterior a 01.08.92)
                    || CALCULA DIAS (denfe_D) PARA COMPLEMENTO EMPRESA (515)
     denfe_A0 = 0; denfe_B0 = 0; denfe_C0 = 0; denfe_D0 = 0;
     |SI nDiaRealIniIT = 0;             || solo en la primera enfermedad, claro
          nume1 = dias_v + denfe_0;
     |SINO;
          nume1 = dias_v;
     |FINSI;

     |SI campos = 12; nume1 = nume1 + dreca_1; |FINSI;
     |SI campos = 13; nume1 = nume1 + dreca_2; |FINSI;
     |SI campos = 14; nume1 = nume1 + dreca_3; |FINSI;
     |SI campos = 15; nume1 = nume1 + dreca_4; |FINSI;

     |SI nume1 ] 3;
          denfe_A0 = 3;     nume1 = nume1 - 3;       || al  0%
     |SINO;
          denfe_A0 = nume1; nume1 = 0;
     |FINSI;
     |SI nume1 ] 12;
          denfe_D0 = 12;    nume1 = nume1 - 12;      || al  0% (empresario)
     |SINO;
          denfe_D0 = nume1; nume1 = 0;
     |FINSI;
     |SI nume1 ] 5;
          denfe_B0 = 5;     nume1 = nume1 - 5;       || al 60%
     |SINO;
          denfe_B0 = nume1; nume1 = 0;
     |FINSI;
     |SI nume1 ] 1;
          denfe_C0 = nume1;                          || al 75%
     |SINO;
          denfe_C0 = nume1; nume1 = 0;
     |FINSI;

     nume1 = denfe_2;
     |SI denfe_C0 > nume1;
          denfe_A0 = 0;
          denfe_D0 = 0;
          denfe_B0 = 0;
          denfe_C0 = nume1;
     |SINO;
          nume1 = nume1 - denfe_C0;
     |FINSI;
     |SI denfe_B0 > nume1;
          denfe_A0 = 0;
          denfe_D0 = 0;
          denfe_B0 = nume1;
     |SINO;
          nume1 = nume1 - denfe_B0;
     |FINSI;
     |SI denfe_D0 > nume1;
          denfe_A0 = 0;
          denfe_D0 = nume1;
     |SINO;
          nume1 = nume1 - denfe_D0;
     |FINSI;
     |SI denfe_A0 > nume1;
          denfe_A0 = nume1;
     |FINSI;

     denfe_A = denfe_A + denfe_A0;
     denfe_B = denfe_B + denfe_B0;
     denfe_C = denfe_C + denfe_C0;
     denfe_D = denfe_D + denfe_D0;
|FPRC;

|PROCESO buscafichas;
     || hay que contemplar la posibilidad de que tenga mas de dos fichas en
     || el mismo mes, lo que hare sera comprobar
     || si entre todas las fichas del trabajador por sus fechas de alta y baja
     || suman 31 dias en el mes y si es asi aplico para que se le descuente un dia
     || en el ultimo calculado
     || solo si hay mas de una ficha por supuesto, no vayamos a liarla

     |SI nEmp ! #labtraba#0;
          |ACABA;
     |FINSI;

     fFechaAlta = #labtraba#36;
     |SI fFechaAlta > fAlta;
          |ACABA;
     |FINSI;

     |SI #labtraba#42 ! "A";
          |ACABA;
     |FINSI;

     aFechaBaja = #labtraba#37;
     |QBF aFechaBaja;
     |SI aFechaBaja ! "";
          fFechaBaja = aFechaBaja;
     |FINSI;

     alfa1 = "01";
     alfa2 = nElMes;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech4 = alfa4;      || primer dia del mes que calculo

     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     alfa5 = nTopemes;
     alfa5 = alfa5 + "." + alfa2 + "." + alfa3;   || ultimo dia del mes que calculo
     fech5 = alfa5;

     swSigue = 0;
     |SI fech4 [ fFechaBaja; |Y fFechaBaja [ fech5; || es baja en este mes
          swSigue = 1;
     |FINSI;
     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;  || trabajador actual
          |SI aFechaBaja = ""; |O fFechaBaja ] fech5;
               fFechaBaja = fech5;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          nCuantos = nCuantos + 1;
          aFechaAlta = #labtraba#36;
          |QBF aFechaAlta;
          fFechaAlta = aFechaAlta;      || fecha alta trabajador encontrado
          |SI fFechaAlta > fech4;
               fech4 = fFechaAlta;
          |FINSI;
          nume4 = fech4;
          nume5 = fFechaBaja;
          nDiasMesTrab = nDiasMesTrab + (nume5 - nume4 + 1);
     |FINSI;
|FPRC;

|DEFBUCLE buscafichas;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, buscafichas;
|FIN;

|PROCESO BuscaOtroAlta;
     nDiasMesTrab = 0;
     nCuantos = 0;
     swDupli = 0;

     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     aNif = #labtraba#7;
     aCot = #labtraba#42;
     aAlta = #labtraba#36;
     fAlta = #labtraba#36;

     |SALVA_FICHA #labtraba;
     |SALVA_FICHA #nomvarca;

     |BUCLE buscafichas;

     |REPON_FICHA #nomvarca;
     |REPON_FICHA #labtraba;

     |SI nDiasMesTrab ] 31; |Y nCuantos > 1;
          nCotAlta = 2;    || dias cotizables
     |FINSI;
     |SI nElMes = 2; |Y nCuantos > 1;
          |SI nDiasMesTrab = 28; |O nDiasMesTrab = 29;
               nCotAlta = 2;    || dias cotizables
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Opcion3;
     || copiado del nomcal_3 y quitado lo que no hacia falta de momento
     || para agrarios
     || swTransRaro = 0;
     nCotAlta = 2;    || en principio dias cotizables

     |SI #0#8 ! 4; |Y #0#8 ! 6; |Y #0#8 ! 9; |Y #0#8 ! 11;
     |Y #2#42 = "A";
          |SI dalta_3 ! 1;
               nCotAlta = 1;    || dias naturales
               || como no esta de alta todo el mes
               || en principio dias naturales; pero si tengo algun registro
               || con este NIF de alta desde el dia 1 o antes sera
               || por dias cotizables, ya que estoy todo el mes de alta, y
               || entre los dos contratos no puede haber mas de 30 dias de
               || alta si soy mensual

               fech3 = #labtraba#36;
               nume3 = fech3;
               nume3 = nume3 - 1;  || aqui me guardo el dia antes del alta
               |HAZ BuscaOtroAlta;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO diatodos;          || CALCULA TOTALES FINALES DE DIAS
     dia_4 = dia_3;

     |SI #32#17 = 2;     |HAZ modulo1;  |FINSI;
     || DIAS COTIZABLES ILT: solamente cuando incluya el ultimo dia del mes

     nCotAlta = 0;
     |SI #32#18 = 3;
          |HAZ Opcion3;
     |SINO;
          nCotAlta = #32#18;
     |FINSI;

     |SI nCotAlta = 1;|Y dalta_3 ! 1;          dia_4 = dia_2; |FINSI;
     || DIAS NATURALES ALTA: solamente cuando es alta despues del dia 1

     |SI #32#18 ! 3;
          |SI nCotAlta = 2;|Y dalta_3 = guarda;     dia_4 = dia_2; |FINSI;
          || DIAS COTIZABLES ALTA: menos cuando es alta el ultimo dia del mes
     |FINSI;

     guarda_dia_4 = dia_4;    || para calcular los dias de bonificacion

     |SI swbaja ! 0;|Y dbaja_2 ! 0;
          nume1 = dia_4 - (dalta_2 + dbaja_2);
          nume1 = nume1 - ((dbaja_3 - dalta_3) + 1);
          dbaja_2 = dbaja_2 + nume1;
     |FINSI;

     dcoti_0=dia_4-(dalta_2+dbaja_2+dhuel_2+ddese_2);
     dlabo_0=dia_1-(dalta_1+dbaja_1+dhuel_1+dabse_1+dacci_1+denfe_1+dmate_1+ddese_1);
     dlabo_k=dia_k-(dalta_k+dbaja_k+dhuel_k+dabse_k+dacci_k+denfe_k+dmate_k+ddese_k);

     |HAZ modulo2;

     |SI #2#42 = "E";|Y #32#11 = 1;
          dcobr_0=fijo_1;                    || AGRARIA*
     |SINO;
          dcobr_0=dia_4-(dalta_2+dbaja_2+dhuel_2+dabse_2+dacci_2+denfe_2+dmate_2);
          dcobr_0 = dcobr_0 - ddese_2;
          |SI swAjuste3 ! 0;
               dcobr_0 = dcobr_0 + swAjuste3;
          |FINSI;
     |FINSI;

    vcobr_0=dcobr_0 - dvaca_2;  || resta los dias de vacaciones
    vlabo_0=dlabo_0 - dvaca_1;
    vlabo_k=dlabo_k - dvaca_k;

|SI dcobr_0 < 0;  dcobr_0 = 0;  |FINSI;  || chequea negativos dias cobro
|SI dcoti_0 < 0;  dcoti_0 = 0;  |FINSI;  || chequea negativos dias cotizables
|SI dlabo_0 < 0;  dlabo_0 = 0;  |FINSI;  || chequea negativos dias laborables
|SI dlabo_k < 0;  dlabo_k = 0;  |FINSI;  || chequea negativos dias festivos
|SI vcobr_0 < 0;  vcobr_0 = 0;  |FINSI;  || chequea neg. dias cobro sin vaca.
|SI vlabo_0 < 0;  vlabo_0 = 0;  |FINSI;  || chequea neg. dias labor. sin vaca.
|SI vlabo_k < 0;  vlabo_k = 0;  |FINSI;  || chequea neg. dias fest. sin vaca.

    dilt = dacci_2+denfe_2+dmate_2+ddese_2;
|SI dilt = guarda;  dcobr_0 = 0;  |FINSI;  || por FEBRERO !!!
|SI dilt = guarda;  vcobr_0 = 0;  |FINSI;  || por FEBRERO !!!
    dia_4 = dia_3;  || recupera dias cotizables
    dcofi_1 =dcobr_0 /dia_4;        || coeficiente para dias cobro
    dcofi_2 =dcoti_0 /dia_4;        || coeficiente para dias cotizables
    dcofi_3 =(dcobr_0+denfe_2+dmate_2) /dia_4;  || coefi. para no dto. enfermed.
|SI dcofi_3 > 1;  dcofi_3 = 1;  |FINSI;         || ajusta a 1
    dcofi_4 =(dcobr_0+dacci_2) /dia_4;          || coefi. para no dto. accident.
|SI dcofi_4 > 1;  dcofi_4 = 1;  |FINSI;         || ajusta a 1
    dcofi_5 =vcobr_0 /dia_4;              || coef. para vacac.=N
    dcofi_6 =(dcobr_0-vcobr_0) /dia_4;    || coef. para vacac.=E
|SI dcofi_6 < 0;  dcofi_6 = 0;  |FINSI;         || ajusta a 0

|SI denfe_2 = dia_2;  swajuen = 1;  swajuac = 1;  |FINSI;
|SI dmate_2 = dia_2;  swajuen = 1;  swajuac = 1;  |FINSI;
|SI dabse_2 = dia_2;  swajuen = 1;  swajuac = 1;  |FINSI;
|SI dacci_2 = dia_2;  swajuen = 1;  swajuac = 1;  |FINSI;
|FPRC;

|PROCESO reajuste;   || CHEQUEA Y AJUSTA LOS DIAS COTIZABLES
    s_reajus = 0;                           || inicializa el switch

|SI #2#42 ! "D"; |Y #2#42 ! "T";   || si es mensual y este mes es irregular
    |SI #0#8!04; |Y #0#8!06; |Y #0#8!09; |Y #0#8!11;

            dtot= dalta_2+dbaja_2+dhuel_2+dabse_2+dacci_2+denfe_2+dmate_2;
            diff= 30 - guarda;

        |SI dtot = guarda;    || si esta todo el mes en baja
            |SI dabse_2 ! 0;
                    dabse_2 = dabse_2 + diff;
            |SINO;
                |SI dhuel_2 ! 0;
                        dhuel_2 = dhuel_2 + diff;
                |SINO;
                    |SI dalta_2 ! 0;
                            dalta_2 = dalta_2 + diff;
                    |FINSI;
                |FINSI;
            |FINSI;
        |FINSI;

    |FINSI;
|FINSI;
|FPRC;

|PROCESO modulo1;   || ajusta los dias de ILT segun modulo -1-
|SI #2#42 ! "D"; |Y #2#42 ! "T";
    |SI #0#8!04; |Y #0#8!06; |Y #0#8!09; |Y #0#8!11;
            diff= 30 - guarda;
        |SI dhuel_2!0;|Y swaju_hue=1;  dhuel_2=dhuel_2 + diff;  |FINSI;
        |SI dabse_2!0;|Y swaju_abs=1;  dabse_2=dabse_2 + diff;  |FINSI;
        |SI dmate_2!0;|Y swaju_mat=1;  dmate_2=dmate_2 + diff;  |FINSI;
        |SI dacci_2!0;|Y swaju_acc=1;  dacci_2=dacci_2 + diff;  |FINSI;
        |SI denfe_2!0;|Y swaju_enf=1;  denfe_2=denfe_2 + diff;  |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO VtoBonif;
     |PARA nHastaBonif = 14; |SI nHastaBonif [ 19;
                             |HACIENDO nHastaBonif = nHastaBonif + 1;
          nNume1 = (#16nHastaBonif - (#16nHastaBonif $ 12)) / 12;
          nNume2 = #16nHastaBonif $ 12;
          nVtoBonif = totalt + (nNume1 * 100) + nNume2;
          aAlfa = nVtoBonif; aAlfa = aAlfa % -102; nume1 = aAlfa;
          |SI nume1 > 12;
               nVtoBonif = nVtoBonif - 12 + 100;
          |FINSI;
          |SI totact < nVtoBonif;
               totven = nVtoBonif;
               |SI nHastaBonif = 14;
                    nNume1 = 3;
               |SINO;
                    nNume1 = nHastaBonif + 5;
               |FINSI;
               nPorBon1 = #16nNume1;         || se lleva el porcent. bonif. 1
               |SAL;
          |SINO;
               |SI totact = nVtoBonif;|Y diaalt ! 1;
                    totven = nVtoBonif;
                    |SI nHastaBonif = 14;
                         nNume1 = 3;
                    |SINO;
                         nNume1 = nHastaBonif + 5;
                    |FINSI;
                    nPorBon1 = #16nNume1;         || se lleva el porcent. bonif. 1
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     nNume1 = nHastaBonif + 1;
     |SI nNume1 [ 19;
          |SI #16nNume1 ! 0;|Y #16nNume1 > #16nHastaBonif;
               nNume2 = nNume1 + 5;
               nPorBon2 = #16nNume2;         || se lleva el porcent. bonif. 2
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO bonif;
|DEBUG;
    fecalf = #2#40; |HAZ desglosa; || desglosa fecha alta bonificacion
    diaalt = dia;     mesalt = mes;          anyalt = any;
    totalt = (anyalt * 100) + mesalt;

    fecalf = #2#41; |HAZ desglosa; || desglosa fecha vto. bonificacion
    diaven = dia;     mesven = mes;          anyven = any;
    totven = (anyven * 100) + mesven;

    alfa1 = #0#9;     alfa1 = alfa1 % -104;  nume1 = alfa1;
    totact = (nume1 * 100) + #0#8;

    nPorBon1 = #16#3;
    nPorBon2 = 0;

|SI totven = 0;
    totven = totalt;
    |HAZ VtoBonif;
    diaven = diaalt;
    mesven = totven $ 100;
    anyven = (totven - mesven) / 100;
|FINSI;

    dboni_1 = 0;    || dias de bonificacion
    dboni_2 = 0;    || dias de no bonificacion

|SI totalt [ totact;|Y totven ] totact; || si esta vigente
        dboni_1 = dia_4;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;
|SI totact = totalt;|Y totven ! totact; || si es alta este mes
        dboni_1 = (guarda_dia_4 - diaalt) + 1;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;
|SI totact ! totalt;|Y totven = totact; || si es baja este mes
        dboni_1 = diaven;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;
|SI totact = totalt;|Y totven = totact; || si es alta y baja este mes
        dboni_1 = diaven - diaalt + 1;
        dboni_2 = dcoti_0 - dboni_1;
|FINSI;

|SI dboni_1 < 0;  dboni_1 = 0;  |FINSI;
|SI dboni_2 < 0;  dboni_2 = 0;  |FINSI;

|SI dboni_1 > dcoti_0;   dboni_1 = dcoti_0;  |FINSI;

|| por salir del paso, de momento, ya veremos 26.05.2020
|SI #labtraba#188 = "S"; |O #labtraba#188 = "1"; |O #labtraba#188 = "2";
|O #labtraba#188 = "A";
     dboni_1 = dboni_1 + ddese_2;
|FINSI;

|FPRC;

|PROCESO DosPeriodos;
     aAlfa1 = "01";
     aAlfa2 = nElMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nElAny;
     aIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fIniPer = aIniPer;

     aAlfa1 = topemes;
     aAlfa2 = nElMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nElAny;
     aFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFinPer = aFinPer;

     aFechaAlta = #labtraba#36;
     |SI aFechaBaja = "";
          aFechaBaja = aFinPer;
     |FINSI;

     fFechaAlta = aFechaAlta;
     fFechaBaja = aFechaBaja;

     |SI fFechaAlta ] fIniPer;
          fIniPer = fFechaAlta;
     |FINSI;
     |SI fFechaBaja [ fFinPer;
          fFinPer = fFechaBaja;
     |FINSI;

     aFechaCambio = #labtraba#34;
     aAlfa = aFechaCambio % -104;
     nNume = aAlfa;
     nNume = nNume + 1;
     aAlfa = nNume;
     aFechaCambio = (aFechaCambio % 106) + aAlfa;
     fFechaCambio = aFechaCambio;
     nFechaCambio = fFechaCambio;

     nNume1 = fIniPer;
     nNume2 = fFinPer;

     |SI nNume1 > nFechaCambio; |O nNume2 < nFechaCambio;
          || NO ESTA COMPRENDIDO ENTRE ESTAS FECHAS
          |SI nNume1 > nFechaCambio;
               || la fecha de inicio de periodo es superior a la fecha en que
               || se cambia de a¤o (raro, pero asi es), los dias pertenecen
               || todos al a¤o 2
               nDiasAny2 = nNume2 - nNume1 + 1;
          |FINSI;
          |SI nNume2 < nFechaCambio;
               || la fecha de fin de periodo es anterior a la fecha en que se
               || cambiaba de a¤o, todos los dias perteneceran al a¤o 1
               nDiasAny1 = nNume2 - nNume1 + 1;
          |FINSI;
     |SINO;
          nDiasAny1 = nFechaCambio - nNume1
          nDiasAny2 = nNume2 - nFechaCambio + 1;
     |FINSI;
|FPRC;

|PROCESO EnPracticas;
     nPropPrac = 1;

     swSigue = 0;
     |SI #2#45 = "420"; |O #2#45 = "520";
          swSigue = 1;
     |FINSI;
     |SI #2#45 = "421";
          swSigue = 1;
     |FINSI;

     |SI swSigue = 1;
          |SI #2#232 ! 0; |Y #2#233 ! 0; |Y #2#208 = "S";
               enMes = nElMes;
               enAny = nElAny;
               |HAZ CompAltaTrab_plb;

               alfa1 = #2#34 % -104;         || anyo alta
               alfa2 = #2#34 % -602;         || mes alta
               alfa3 = #2#34 % 102;          || dia alta
               nume2 = alfa1;                || anyo alta
               nume3 = alfa2;                || mes alta
               nume1 = nElAny - nume2;
               nume4 = nElMes - nume3;
               nume5 = alfa3;                || dia alta

               aFechaBaja = #2#37;

               |ABRE #nomvarca;
               #nomvarca#0 = #labtraba#0;
               #nomvarca#1 = #labtraba#1;
               #nomvarca#2 = nElMes;
               #nomvarca#3 = 0;
               |LEE 000#nomvarca.=;
               |SI FSalida = 0;
                    aAlfa = #nomvarca#16;
                    |QBF aAlfa;
                    |SI aAlfa ! ""; |Y aAlfa ! "..........";
                         aFechaBaja = aAlfa;
                    |FINSI;
               |FINSI;
               |CIERRA #nomvarca;
               |QBF aFechaBaja;

               alfa1 = aFechaBaja % -104;         || anyo baja
               alfa2 = aFechaBaja % -602;         || mes baja
               alfa3 = aFechaBaja % 102;          || dia baja
               nume6 = alfa1;                || anyo baja
               nume7 = alfa2;                || mes baja
               nume8 = alfa3;                || dia baja

               |SI nume1 = 0;      || dif a¤o calculo y a¤o alta es cero
                    nPropPrac = #labtraba#232 / 100;
                    || estoy en el primer a¤o
               |FINSI;

               |SI nume1 = 1;      || puede ser que este en el primer a¤o,
                                   || en el segundo o en el mes de cambio
                    |SI nume4 < 0; || primer a¤o
                         nPropPrac = #labtraba#232 / 100;
                    |FINSI;
                    |SI nume4 = 0; || mes de cambio a¤o
                         nDiasAny1 = 0;
                         nDiasAny2 = 0;
                         |HAZ DosPeriodos;
                         nPropPrac = (nDiasAny1 / enDiasAlta) * (#labtraba#232 / 100);  || primer a¤o
                         nPropPrac = nPropPrac + (nDiasAny2 / enDiasAlta) * (#labtraba#233 / 100);  || segundo a¤o
                    |FINSI;
                    |SI nume4 > 0; || segundo a¤o
                         nPropPrac = #labtraba#233 / 100;
                    |FINSI;
               |FINSI;

               |SI nume1 = 2;      || segundo a¤o,
                    nPropPrac = #labtraba#233 / 100;  || entre 1 y 2 a¤os en alta
               |FINSI;

               |SI nume1 = 3;      || estoy en el a¤o que cumplo el tercer a¤o
                                   || puede ser que este antes de cumplirlo, en el mes
                                   || que cumplo tres o que ya los haya cumplido

                    |SI nume4 < 0; || aun no ha cumplido el tercer a¤o
                         nPropPrac = #labtraba#233 / 100;  || entre 2 y 3 a¤os en alta
                    |FINSI;
                    |SI nume4 = 0; || el mes que termino el tercer a¤o
                         nPropPrac = #labtraba#233 / 100;
                         || a la fuerza con el porcentaje del segundo y tercer a¤o,
                         || no puedo estar una parte en practicas del segundo a¤o
                         || y otra parte con proporcion 1 por llevar mas de dos
                         || a¤os ya que eso deberia estar en otro contrato
                    |FINSI;
                    |SI nume4 > 0; || mas de tres a¤os
                         nPropPrac = #labtraba#233 / 100; || mas de tres a¤os en alta
                         || en teoria imposible, no puedo estar mas de tres
                         || a¤os en practicas
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||                      SUBRUTINAS DEL CALCULO DE DIAS
||****************************************************************************

|PROCESO desglosa;     || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;
|FPRC;

||****************************************************************************
||                CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************

|PROCESO calanti;     || LANZA LOS CALCULOS DE ANTIGUEDAD Y PLUS
|HAZ leetodo;
    duni1_101 = 0;    duni2_101 = 0;    dvalo_101 = 0;
    duni1_102 = 0;    duni2_102 = 0;    dvalo_102 = 0;
    duni1_103 = 0;    duni2_103 = 0;    dvalo_103 = 0;
    danti_0 = 0;      danti_1 = 0;
|HAZ cal_101;                    || calcula el salario base
|SI #9#2 = 3;                    || (si antig=3, calcula antes el plus !!!)
    |HAZ cal_103;
|FINSI;
|HAZ cal_102;                    || calcula la antiguedad
|SI #9#2 ! 3;                    || calcula los pluses
    |HAZ cal_103;                || (si antig=3, ya habra entrado antes !!!)
|FINSI;
|HAZ gratodo;                    || regraba o graba conceptos 101,102 y 103
|FPRC;

||****************************************************************************
||            RUTINAS DEL CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************

|PROCESO leetodo;    || LEE ANTIG./CATEG., AUX. CONVENIOS Y PTAS. BASE ANTIG.
    |ABRE #13;
    |DDEFECTO #13;
        #13#0 = #2#87;
        #13#1 = #2#17;
    |LEE 000#13=;                 || lee antiguedad/categoria
    |CIERRA #13;
|| ******
    |ABRE #14;
    |DDEFECTO #14;
        #14#0 = #2#87;
    |LEE 000#14=;                 || lee auxiliar de convenios
    |CIERRA #14;
|| ******
    |ABRE #30;
    |DDEFECTO #30;
        #30#0 = #2#87;
        #30#1 = #2#17;
    |LEE 000#30=;                 || lee ptas. base antiguedad
    |CIERRA #30;
|FPRC;

|PROCESO cal_101;         || CALCULA EL SALARIO BASE
     swBaseDiario = 0;
     doce = 101;
     |HAZ leedoce;
     |SI FSalida = 0;
          |HAZ coefi;
          duni1_101 = #12#9;
          duni2_101 = dcofi_999 * duni1_101;
          |SI #12#5 = "D";  || si el concepto es diario
               |SI dalta_3 ! 1; |O dbaja_3 ! topemes;
                    duni2_101 = (dcobr_0 / dia_2) * duni1_101;
               |FINSI;
               swBaseDiario = 1;

               || esto es para saber que tengo el 101 diario y que en
               || este caso, las pagas tiene que ir como si fuera diario
          |FINSI;
          dvalo_101 = #12#10;
          duni2_101 = duni2_101 ! 6;
     |FINSI;
|FPRC;

|PROCESO cal_102;     || CALCULA LA ANTIGUEDAD
    doce = 102;
|HAZ leedoce;
|SI FSalida = 0;
    |HAZ coefi;
        duni1_102 = #12#9;
        dvalo_102 = #12#10;
    |SI #9#2 < 2;
            duni2_102 = duni1_102 * dcofi_999;
    |SINO;
        |HAZ anyanti;
        |HAZ poranti;
            duni1_102 = danti_1;
            duni2_102 = danti_1 * dcofi_999;
        |SI #9#2 ! 4;
            |SI #14#95 = 9;                    || si es sobre antig./categ.
                    dvalo_102 = danti_0;       || se inhibe la clave 3 !!!
            |SINO;
                |SI #9#2 = 2;
                        dvalo_102 = (duni1_101 * danti_0) /100;
                |SINO;
                        dvalo_102 = (duni1_101 * danti_0) /100;
                        dvalo_102 = dvalo_102 + ((duni1_103*dvalo_103)/100);
                |FINSI;
            |FINSI;
        |SINO;
                dvalo_102 = #30#03 / 100;  || 1% de ptas. base antiguedad
        |FINSI;
    |FINSI;
        dvalo_102 = dvalo_102 * nPropPrac;
        duni2_102 = duni2_102 ! 6;
        ||dvalo_102 = dvalo_102 ! 2;
|FINSI;
|FPRC;

|PROCESO cal_103;       || CALCULA EL PLUS
    doce = 103;
|HAZ leedoce;
|SI FSalida = 0;
        duni1_103 = #12#9;
    |HAZ coefi;
    |SI #9#3 < 2;
            duni1_103 = #12#9;
    |FINSI;
        duni2_103 = duni1_103 * dcofi_999;
        dvalo_103 = #12#10;
    |SI #9#3 = 2;
            dvalo_103 = duni1_101 *dvalo_101 /100;    || 1% sal.base
    |FINSI;
    |SI #9#3 = 3;
            dvalo_103 = (duni1_101*dvalo_101) /100;
            dvalo_103 = dvalo_103 + ((duni1_102 *dvalo_102) /100);
    |FINSI;
        duni2_103 = duni2_103 ! 6;   || redondea unid. calculo
        ||dvalo_103 = dvalo_103 ! 2;   || redondea valor
|FINSI;
|FPRC;

|PROCESO gratodo;     || GRABA O REGRABA CONCEPTOS 101,102 Y 103
    swgracon = 0;     || para que no machaque campos si existe
    swcongra = 0;     || para que no acumule si existe
    graba04 = 101;
    graba09 = duni1_101;
    graba10 = dvalo_101;
    graba11 = duni2_101;
|SI duni1_101 ! 0; |O dvalo_101 ! 0; |O duni2_101 ! 0;
    |HAZ grabacon;
|FINSI;
    graba04 = 102;
    graba09 = duni1_102;
    graba10 = dvalo_102;
    graba11 = duni2_102;
|SI duni1_102 ! 0; |O dvalo_102 ! 0; |O duni2_102 ! 0;
    |HAZ grabacon;
|FINSI;
    graba04 = 103;
    graba09 = duni1_103;
    graba10 = dvalo_103;
    graba11 = duni2_103;
|SI duni1_103 ! 0; |O dvalo_103 ! 0; |O duni2_103 ! 0;
    |HAZ grabacon;
|FINSI;
|FPRC;

||****************************************************************************
||          SUBRUTINAS DEL CALCULO DEL SALARIO BASE, ANTIGUEDAD Y PLUS
||****************************************************************************


|PROCESO poranti;  || halla el porcentaje o, en su caso, la cantidad, a aplicar
    yaesta = 0;
|SI #14#95 = 9;               || segun tipo de calculo de aux.convenios
    |PARA campo=4;|SI campo[33;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
        |SI campo = 14;  campo = 24;    |FINSI;
            sigui = campo + 1;
        |SI sigui = 14;  sigui = 24;    |FINSI;
        |SI anyos ] #13campo; |Y anyos < #13sigui; |O campo = 33;
                yaesta = 1;
                elotro = campo + 10;
                danti_0 = #13elotro;   || carga cantidad fija de antig./categ.
                danti_1 = duni1_102;   || carga las unidades segun calculo
        |FINSI;
    |SIGUE;
|SINO;
    |PARA campo=65;|SI campo[79;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
            sigui = campo + 1;
        |SI anyos ] #14campo; |Y anyos < #14sigui; |O campo = 79;
                yaesta = 1;
                elotro = campo + 15;
                danti_0 = dvalo_101;   || carga con valor del 101
                danti_1 = #14elotro;   || carga con el porcentaje corresp.
        |FINSI;
    |SIGUE;
|FINSI;
|FPRC;

|PROCESO anyanti;              || CALCULA LOS A¥OS DE ANTIGUEDAD
|SI #14#95 = 9;
        tipox = #13#3;         || tipo de calculo segun antig/categ.
|SINO;
        tipox = #14#95;        || tipo de calculo segun aux. convenios
|FINSI;

    alfa2 = #2#34  % 402;  fanti_m = alfa2;   || meses antiguedad
    alfa3 = #2#34  % -104; fanti_a = alfa3;   || anyos antiguedad

|HAZ seguntipo;                || saca vencimiento segun tipo

    alfa2 = fvenci % 102;  ganti_m = alfa2;   || meses vencimiento antiguedad
    alfa3 = fvenci % -104; ganti_a = alfa3;   || anyos vencimiento antiguedad

    difer_m = ganti_m - fanti_m;    || diferencia meses
    difer_a = ganti_a - fanti_a;    || diferencia anyos

|SI difer_m < 0;  difer_a = difer_a - 1;  |FINSI;
|SI difer_a < 0;  difer_a = 0;            |FINSI;

    anyos = difer_a;

|FPRC;

|PROCESO seguntipo;      || SELECCIONA FECHA VENCIMIENTO ANTIGUEDAD
|SI tipox =  0;  fvenci = #2#34;  |FINSI;
|SI tipox =  1;  fvenci = tipo1;  |FINSI;
|SI tipox =  2;  fvenci = tipo2;  |FINSI;
|SI tipox =  3;  fvenci = tipo3;  |FINSI;
|SI tipox =  4;  fvenci = tipo4;  |FINSI;
|SI tipox =  5;  fvenci = tipo5;  |FINSI;
|SI tipox =  6;  fvenci = tipo6;  |FINSI;
|SI tipox =  7;  fvenci = tipo7;  |FINSI;
|SI tipox =  8;  fvenci = tipo8;  |FINSI;
|SI tipox = 10; |Y fanti_m < 7;
        fvenci = tipo7;
|FINSI;
|SI tipox = 10; |Y fanti_m > 6;
        fvenci = tipo8;
|FINSI;
|FPRC;

||****************************************************************************
||            CALCULO DE LAS UNIDADES Y DE LOS ACUMULADOS
||****************************************************************************

|PROCESO calunac;      || LECTURA DE CONCEPTOS
|CIERRAT #12;          || cierra aqui y abre abajo para dejarlo como viene
    #11#00 = #02#00;   || empresa
    #11#01 = #02#01;   || trabajador
    #11#02 = #00#08;   || mes
    #11#03 =      0;   || tipo
|GRABA 020#11n;        || graba la cabecera vacia para poder leer con |BUCLELIN
|LIBERA #11;
|LEE 120#11=;
    acum_10 = 0;
    acum_11 = 0;
    acum_12 = 0;
    acum_13 = 0;
    acum_30 = 0;
    acum_301 = 0;
    acum_302 = 0;
    acum_303 = 0;
    acum_31 = 0;
    acum_311 = 0;
    acum_312 = 0;
    acum_313 = 0;
    acum_40 = 0;
    acum_401 = 0;
    acum_402 = 0;
    acum_403 = 0;
    acum_41 = 0;    anti_41 = 0;
    acum_50 = 0;
    acum_90 = 0;
    horasex = 0;  || horas subvencionadas
    vacacio = 30; || dias vacaciones a¤o (por defecto 30!!!)
    indemni = -1; || dias indemnizacion al a¤o
    anticom = -1; || acumulado del anti-complemento
    bruto_aju = 0;  || bruto base para ajustes
    sw_bruaju = 0;
    liq_aju = 0;    || liquido base para ajustes
    jornadasIT = 0; || nro. jornadas en IT
     nJornadasERE = 0;

|CIERRAT #12;
|BUCLELIN 0cal_999#11;
|ABRET #12;
|HAZ calautom;
|SI denfe_2 ! 0; |O dacci_2 ! 0; |O dmate_2 ! 0;
    |SI #2#43 = "S"; |O #2#43 = "s";  || si ha estado enfermo y el anti-comp.
            anticom = 0;              || es valido, lo calcula
        |CIERRAT #12;
        |BUCLELIN 0cal_998#11;
        |ABRET #12;
    |FINSI;
|FINSI;

    acum_10 = acum_10 ! EURODB;
    acum_11 = acum_11 ! EURODB;
    acum_12 = acum_12 ! EURODB;
    acum_13 = acum_13 ! EURODB;
    acum_30 = acum_30 ! EURODB;
    acum_301 = acum_301 ! EURODB;
    acum_302 = acum_302 ! EURODB;
    acum_303 = acum_303 ! EURODB;
    acum_31 = acum_31 ! EURODB;
    acum_311 = acum_311 ! EURODB;
    acum_312 = acum_312 ! EURODB;
    acum_313 = acum_313 ! EURODB;
    acum_40 = acum_40 ! EURODB;
    acum_401 = acum_401 ! EURODB;
    acum_402 = acum_402 ! EURODB;
    acum_403 = acum_403 ! EURODB;
    acum_41 = acum_41 ! EURODB;    anti_41 = anti_41 ! EURODB;
    acum_50 = acum_50 ! EURODB;
    acum_90 = acum_90 ! EURODB;
|ABRET #12;
|FPRC;

||****************************************************************************
||             RUTINAS DEL CALCULO DE LAS UNIDADES Y ACUMULADOS
||****************************************************************************

|PROCESO acu_ctos;
         duni2_999 = #12#11;
        dvalo_999 = #12#10;
        product = duni2_999 * dvalo_999;
        product = product ! EURODB;
    |SI #12#4]101;|Y #12#4[199;
                        acum_10 =acum_10 +product;
        |SI #10#8 = 1;  acum_11 =acum_11 +product;  |FINSI;
        |SI #10#8 = 2;  acum_12 =acum_12 +product;  |FINSI;
        |SI #10#8 = 3;  acum_13 =acum_13 +product;  |FINSI;
    |FINSI;
    |SI #12#4]301;|Y #12#4[304;
                        acum_30 =acum_30 +product;
        |SI #10#8 = 1;  acum_301 =acum_301 +product;  |FINSI;
        |SI #10#8 = 2;  acum_302 =acum_302 +product;  |FINSI;
        |SI #10#8 = 3;  acum_303 =acum_303 +product;  |FINSI;
    |FINSI;
    |SI #12#4]305;|Y #12#4[399;
                        acum_31 =acum_31 +product;
        |SI #10#8 = 1;  acum_311 =acum_311 +product;  |FINSI;
        |SI #10#8 = 2;  acum_312 =acum_312 +product;  |FINSI;
        |SI #10#8 = 3;  acum_313 =acum_313 +product;  |FINSI;
    |FINSI;
    |SI #12#4]400;|Y #12#4[410;
                        acum_40 =acum_40 +product;
        |SI #10#8 = 1;  acum_401 =acum_401 +product;  |FINSI;
        |SI #10#8 = 2;  acum_402 =acum_402 +product;  |FINSI;
        |SI #10#8 = 3;  acum_403 =acum_403 +product;  |FINSI;
        |SI #10#11 = "S"; |Y #10#12 = 7;
               n400Cot = n400Cot + product;
        |FINSI;
    |FINSI;
    |SI #12#4]411;|Y #12#4[499;                ||IRPF exent.
          acum_41 =acum_41 +product;
          |SI #10#11 = "S"; |Y #10#12 = 7;
               n400Cot = n400Cot + product;
          |FINSI;
    |FINSI;
    |SI #12#4]501;|Y #12#4[501; acum_51 =product;          |FINSI;
    |SI #12#4]502;|Y #12#4[502; acum_52 =product;          |FINSI;
    |SI #12#4]505;|Y #12#4[599; acum_50 =acum_50 +product; |FINSI;
    |SI #12#4]901;|Y #12#4[901; horasex =duni1_999;        |FINSI;||ho.extras
    |SI #12#4]902;|Y #12#4[902; indemni =duni1_999;        |FINSI;||di.indemn.
    |SI #12#4]904;|Y #12#4[904; vacacio =duni1_999;        |FINSI;||di.vacaci.
    |SI #12#4]905;|Y #12#4[905; horastp =duni1_999;        |FINSI;||horas tp.
    |SI #12#4=906; |Y antici1=0; antici1 = product; |FINSI;
    |SI #12#4=907; |Y antici2=0; antici2 = product; |FINSI;
    |SI #12#4=908;|Y especie=0; especie =product;                |FINSI;
    |SI #12#4]922;|Y #12#4[922; jornadasIT = duni1_999;    |FINSI;||jornadas
    |SI #12#4]929;|Y #12#4[929; prom_enf_929 = dvalo_999;    |FINSI;||promIT
    |SI #12#4]935;|Y #12#4[935; nJornadasERE = duni1_999;    |FINSI;||jornadas en ERE
/*
    ||jornadas en IT por las que cotizan empresa y trabajador:
    |SI #12#4]941;|Y #12#4[941; nJorITCotEmpTra = duni1_999;    |FINSI;

    ||jornadas en IT por las que cotiza solo empresa:
    |SI #12#4]942;|Y #12#4[942; nJorITCotEmp = duni1_999;    |FINSI;||jornadas
*/
    |SI #12#4]101;|Y #12#4[499;
        |SI #10#9="S";  bruto_aju = bruto_aju + product;  |FINSI;
    |FINSI;
    |HAZ cal_vaca;
|FPRC;

|PROCESO cal_999;     || CALCULA LAS UNIDADES CALCULO DE LOS DEMAS CONCEPTOS
     |SI #12#04 < 200; |O #12#04 > 208;    || los de pagas extras no entran
          |SI #12#04 > 103;                 || el 101,102 y 103 ya estan calculados
               |HAZ coefi;                   || saca el coeficiente y unidades
               duni1_999 = #12#9;                    || unidades de 'coefi'
               duni2_999 = duni1_999 * dcofi_999;    || halla unidades calculo
               duni2_999 = duni2_999 ! 6;            || redondea
               graba04 = #12#4;                      || carga concepto
               graba09 = duni1_999;                  || carga unidades
               graba10 = #12#10;
               graba11 = duni2_999;                  || carga unidades calculo
               swgracon = 0;                         || para que no machaque campos
               swcongra = 0;                         || para que no acumule
               |HAZ grabacon;                            || regraba linea calculo
          |SINO;
               concepto = #12#04;
               |HAZ convenio;
          |FINSI;
          |HAZ acu_ctos;
     |FINSI;
|FPRC;

|PROCESO cal_998;     || CALCULA EL ANTI-COMPLEMENTO, EN SU CASO
|SI #12#04 > 100; |Y #12#04 [ 199;
    |SI #12#05 ! "L";|Y #12#05 ! "K";|Y #12#06 = 1;
            duni2_999 = #12#11;  || unidades cobro
            duni2_998 = #12#9;   || unidades cotiz.
            dvalo_999 = #12#10;  || valor

            duni2_998 = duni2_998 * dcofi_2;  || segun dias alta
            duni2_998 = duni2_998 ! 6;

            produc1 = duni2_999 * dvalo_999;
            produc1 = produc1 ! EURODB;

            produc2 = duni2_998 * dvalo_999;
            produc2 = produc2 ! EURODB;

            produc3 = produc2 - produc1;
            anticom = anticom + (produc2 - produc1);

        |SI #12#4]411;|Y #12#4[499; anti_41 =anti_41 +produc3; |FINSI;
    |FINSI;
|FINSI;
|FPRC;

||****************************************************************************
||        CALCULO DE LOS CONCEPTOS AUTOMATICOS
||****************************************************************************

|PROCESO autovarca;
     |ABRE #6;
     #6#0 = #2#0;
     #6#1 = #2#1;
     #6#2 = concepto;
     |LEE 000#6=;
     |SI FSalida = 0;
          nume1 = #6#3;
          |SI nume1 = 0;
               graba11 = 0;
          |FINSI;
     |FINSI;
     |CIERRA #6;
|FPRC;

|PROCESO lee_autom1;
    acu_auto = 0;
    concepto = #37#1;

     |SI concepto = 903; || por algun extra¤o motivo, resulta que "se dio de
     |O concepto = 922;  || alta" el 903 en los conceptos autom. y no se pueden
                         || borrar despues
          |ACABA;
     |FINSI;

    #12#0 = #2#0;
    #12#1 = #2#1;
    #12#2 = #0#8;
    #12#3 = 0;

    #12#4 = concepto;
|LEE 000#12=;
|SI FSalida = 0;
    |PARA auto3 = 32; |SI auto3 [ 46; |HACIENDO auto3 = auto3 + 1;
        |SI #37auto3 ! 0;
                auto1 = auto3 - 30;     auto2 = auto3 - 15;
                val_auto = 0;
            |SI #37auto2 ! "C";
                |SI #37auto2 = "U";|O #37auto2 = "I";
                        #12#4 = #37auto3;
                    |LEE 000#12=;
                    |SI FSalida = 0;
                        |SI #37auto2 = "U"; val_auto = #12#9;          |FINSI;
                        |SI #37auto2 = "I"; val_auto = #12#10 * #12#9; |FINSI;
                        || despues al multiplicar por la parte en alta,
                        || los "L" y los "E" han de ir enteros 1624.2512
                        |SI #12#5 = "L"; |O #12#5 = "E"; val_auto = val_auto / dcofi_999; |FINSI;
                    |FINSI;
                |SINO;
                    |SI #37auto2 = "P";|O #37auto2 = "E";
                        |SI #37auto3 = 1;    val_auto = nIRPF1;   |FINSI;
                        |SI #37auto3 = 2;    val_auto = nIRPF2;  |FINSI;
                        |SI #37auto3 = 3;    val_auto = nIRPF3;  |FINSI;
                    |FINSI;
                    |SI #37auto2 = "E";
                            val_auto = 100 / (val_auto + 100);
                    |FINSI;
                |FINSI;
            |SINO;
                    val_auto = #37auto3;
            |FINSI;

            |SI #37auto1 = "+";    acu_auto = acu_auto + val_auto;    |FINSI;
            |SI #37auto1 = "-";    acu_auto = acu_auto - val_auto;    |FINSI;
            |SI #37auto1 = "/";    acu_auto = acu_auto / val_auto;    |FINSI;
            |SI #37auto1 = "*";    acu_auto = acu_auto * val_auto;    |FINSI;
            |SI #37auto1 = "%";    acu_auto = acu_auto % val_auto;    |FINSI;
        |FINSI;
    |SIGUE;

        #12#4 = concepto;
    |LEE 000#12=;
    |HAZ coefi;
        graba04 = concepto;
        graba05 = #10#3;
        graba06 = #10#4;
        graba07 = #10#5;
        graba08 = #10#6;
        graba09 = 1;
        graba10 = acu_auto;
        graba11 = graba09 * dcofi_999;
        swgracon = 1;     || para que regrabe campos
        swcongra = 0;     || para que acumule si existe
     |SI concepto ] 900;
         |HAZ autovarca;      || comprueba si algun concepto autom. se anula
    |FINSI;
    |HAZ grabacon;
    |HAZ acu_ctos;
|FINSI;
|FPRC;

|DEFBUCLE lee_autom;
 #37#1;
 ;
 #2#87, 101;
 #2#87, 999;
 ;
 NULL, lee_autom1;
|FIN;

|PROCESO calautom;
     acu_auto = 0;
     val_auto = 0;
     auto1 = 0;
     auto2 = 0;
     auto3 = 0;
     nIRPF1 = 0; nIRPF2 = 0; nIRPF3 = 0;

     |BUCLE lee_autom;
|FPRC;

||****************************************************************************
||        CALCULO DE LA ENFERMEDAD (503), ACCID. (504) Y COMPLEMENTOS
||****************************************************************************

|PROCESO modulo2_1;
     swAjuste3_1 = 0;
     |SI #32#17 = 3;
          |SI nMesBusca = 1; |O nMesBusca = 3; |O nMesBusca = 5;
          |O nMesBusca = 7; |O nMesBusca = 8;  |O nMesBusca = 10;
          |O nMesBusca = 12;
               swAjuste3_1 = 1;
          |SINO;
               |SI nMesBusca = 2;
                    swAjuste3_1 = -2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BaseMesAnterior;
     prom_enf = 0;
     prom_acc = 0;
     nMesBusca = 0;
     nAnyBusca = 0;

     |SI #labtraba#89 ! 0;
/*
          || no, no es util, lo que hare sera irme a buscar la base de IT
          || (el promedio) que use el mes anterior en la IT, ese no puede
          || haber cambiado
          aAlfa = #labtraba#125;
          |QBF aAlfa;
          |SI aAlfa ! "";
              aAlfa = aAlfa % 402;
              nMesBusca = aAlfa;
              aAlfa = #labtraba#125;
              aAlfa = aAlfa % -104;
              nAnyBusca = aAlfa;
          |FINSI;
*/
          nMesBusca = #0#8;
          nAnyBusca = #0#9;
     |SINO;
          nMesBusca = #0#8;
          nAnyBusca = #0#9;
     |FINSI;

     |SI nMesBusca ! 0; |Y nAnyBusca ! 0;
          nMesBusca = nMesBusca - 1;
          nAnyBusca = nAnyBusca - 2000;
          |SI nMesBusca = 0;
               nMesBusca = 12;
               nAnyBusca = nAnyBusca - 1;
          |FINSI;
     |FINSI;

     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#2 = nMesBusca;
     #nomhicca#3 = 0;
     #nomhicca#66 = nAnyBusca;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |SI #labtraba#89 = 0; |Y #labtraba#92 = 0;
               || empiezo IT este mes
               nBase = #nomhicca#39;
               |SI swBaseFija = 1;
                    |HAZ modulo2_1;
                    nNume = #nomhicca#31 + #nomhicca#32 + #nomhicca#65;
                    |SI nNume > 0;
                         nNume = nNume - swAjuste3_1;
                    |FINSI;
                    prom_enf = nBase / (#nomhicca#8 - nNume);
               |SINO;
                    prom_enf = nBase / #nomhicca#11;
               |FINSI;
               prom_enf = prom_enf ! 2;
               prom_acc = prom_enf;
          |SINO;
               || vengo de IT del mes anterior
               prom_enf = #nomhicca#35;
               prom_acc = prom_enf;
          |FINSI;
     |FINSI;
     |SI prom_enf_929 ! 0;
          prom_enf = prom_enf_929;
     |FINSI;
     prom_acc = prom_enf;

     |CIERRA #nomhicca;

     |SI runnom ! "nomcalfi";
          nume1 = denfe_2 + dmate_2 + dacci_2;
          |SI #2#33 = 01; |Y nume1 > 0;
               |SI prom_enf = 0;
                    alfa1 = #labtraba#0; alfa1 = "00000" + alfa1; alfa1 = alfa1 % -105;
                    alfa2 = #labtraba#1; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
                    aAlfa = "    ATENCION. Trabajador " + alfa1 + "." + alfa2;
                    aAlfa = aAlfa + " con grupo de cotiz. 01, está en IT";
                    aAlfa = aAlfa + " y no tiene base de cotiz. el mes anterior"
                    |MENAV aAlfa;
                    aAlfa = "    Utilice el concepto 929 para introducir la base ";
                    aAlfa = aAlfa + " de cotización DIARIA o POR JORNADA";
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BaseITEnero;
     |SI swBaseFija = 1;
          || por la base fija
          |SI #2#33 = 12;
               catego = 11 + 23;        || OJO, en enom1 es + 22
          |SINO;
               catego = #2#33 + 23;
          |FINSI;
          prom_enf = #18catego / 30;      || prom. IT
          || prom_acc = #18catego / 30;      || prom. IT
          || lo que tuviera en los promedios
          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    |HAZ BaseMesAnterior;
               |FINSI;
          |FINSI;
     |SINO;
          || por jornadas
          |SI #2#33 = 12;
               catego = 11;
          |SINO;
               catego = #2#33;
          |FINSI;
          prom_enf = #18catego;      || prom. IT
          || prom_acc = #18catego;      || prom. IT
          || lo que tuviera en los promedios
          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    |HAZ BaseMesAnterior;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MinJornadas;
     |SI #2#33 = 12;
          catego = 11;
     |SINO;
          catego = #2#33;
     |FINSI;
     nCampo = catego + 23;
     nMinCC = #nomconst#nCampo#;
     nMinCP = #nomconst#23;
     |SI prom_enf < nMinCC;
          prom_enf = nMinCC;
     |FINSI;
     |SI prom_acc < nMinCP;
          prom_acc = nMinCP;
     |FINSI;
|FPRC;

|PROCESO calenfe;
     prom_enf = #02#95;   || promedio enfermedad (trabajador)
     prom_acc = #02#96;   || promedio accidente (trabajador)
     |SI nElAny ] 2012;
          || aqui no hago nada, ya no tengo que buscar bases fijas
          |SI nElAny = 2012; |Y #0#8 = 1; || solo para enero de 2012
               ||SI #2#89 ! 0;
               |HAZ BaseITEnero;
               prom_acc = #2#96;
          |FINSI;
     |SINO;
          |SI swBaseFija = 1;
               || por la base fija
               |SI #2#33 = 12;
                    catego = 11 + 23;        || OJO, en enom1 es + 22
               |SINO;
                    catego = #2#33 + 23;
               |FINSI;
               prom_enf = #18catego / 30;      || prom. IT
               prom_acc = #18catego / 30;      || prom. IT

               |SI nElAny ] 2011
                    |SI #2#33 = 01;
                         |HAZ BaseMesAnterior;
                    |FINSI;
               |FINSI;
          |SINO;
               || por jornadas
               |SI #2#33 = 12;
                    catego = 11;
               |SINO;
                    catego = #2#33;
               |FINSI;
               prom_enf = #18catego;      || prom. IT
               prom_acc = #18catego;      || prom. IT
               |SI nElAny ] 2011
                    |SI #2#33 = 01;
                         |HAZ BaseMesAnterior;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #7#17 ! 0;  prom_enf = #7#17;  |FINSI;  || promedio enfermedad (variac.)
     |SI #7#18 ! 0;  prom_acc = #7#18;  |FINSI;  || promedio accidente (variac.)

     |SI swBaseFija = 1;
          || bueno de momento no lo pruebo mas que para jornadas
     |SINO;
          |HAZ MinJornadas;
     |FINSI;

     |HAZ calproac;
     pilt_enf = prom_enf;      || para base ILT 126
     pilt_acc = prom_acc;

     base_1 = prom_enf           * .75 *denfe_C; ||base enfermedad al 75% (503)
     base_2 = prom_enf           * .60 *denfe_B; ||base enfermedad al 60% (503)
     base_3 =(prom_acc+prom_ac2) * .75 *dacci_2; ||base accidente  al 75% (504)
     base_4 = 0;
     denfe_4= prom_enf           * .60 *denfe_D; ||complem. empresa al 60% (515)

     || primero enfermedad

     nume1 = denfe_2;
     |SI #2#42 = "E";
          nume1 = jornadasIT * denfe_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales

     |SI aUltimaIT = "E";
          nume1 = nume1 - swAjuste3;
     |FINSI;

     coba_1 = prom_enf * nume1;   || base CC
     cobb_1 = prom_acc * nume1;   || base AT

     |SI jornadasIT ! 0;
          || despues hago esto otra vez, pero es que me hace falta para saber
          || la prestacion ya
          |HAZ DesglosaJorCreta;
     |FINSI;

     || ahora maternidad

     nume1 = dmate_2;
     |SI #2#42 = "E";
          nume1 = jornadasIT * dmate_2 / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales

     |SI aUltimaIT = "M"; |O aUltimaIT = "P"; |O aUltimaIT = "R"; |O aUltimaIT = "C";
          nume1 = nume1 - swAjuste3;
     |FINSI;

     coba_4 = prom_enf * nume1;   || base CC
     cobb_4 = prom_acc * nume1;   || base AT

                                   || accidente
     nume1 = dacci_2;
     |SI #2#42 = "E";
          nume1 = jornadasIT * (dacci_2)/ (denfe_2 + dmate_2 + dacci_2 + dabse_2);
     |FINSI;   || solo eventuales

     |SI nElAny [ 2011;
          |SI nume1 > dia_4; |Y #labtraba#42 ! "E"; nume1 = dia_4;  |FINSI;
          |SI nume1 = dia_2; |Y #labtraba#42 ! "E"; nume1 = dia_4;  |FINSI;
     |FINSI;

     |SI nElAny ] 2012;
          |SI aUltimaIT = "A";
               nume1 = nume1 - swAjuste3;
          |FINSI;
          coba_2 = prom_acc * nume1;   || base AT
          cobb_2 = prom_enf * nume1;   || base CC
     |SINO;
          coba_2 = prom_acc * nume1;   || base AT
          cobb_2 = prom_enf * nume1;   || base CC
     |FINSI;

                                 || absentismo
     |SI #2#42 = "E"; |Y dabse_2 > 0;
          nume1 = jornadasIT * (dabse_2) / (denfe_2 + dmate_2 + dacci_2 + dabse_2);
          |SI #nomcontr#2 = "S";
               nNume = #labtraba#33;
               nNume = nNume + 23;
               coba_3 = #nomconst#nNume# * nume1;   || base CC
               cobb_3 = #nomconst#23 * nume1;   || base AT
          |FINSI;
          |SI #nomcontr#2 = "N";
               coba_3 = prom_enf * nume1;   || base CC
               cobb_3 = prom_acc * nume1;   || base AT
          |FINSI;
     |FINSI;

     |SI #2#42 = "A"; |Y dabse_2 > 0; || mensuales
          nume1 = dabse_2;
          |SI nume1 > dia_4; nume1 = dia_4;  |FINSI;
          |SI nume1 = dia_2; |Y nume1 < dia_4;  nume1 = dia_4;  |FINSI;
          |SI #nomcontr#2 = "S";
               nNume = #labtraba#33;
               nNume = nNume + 23;
               coba_3 = #nomconst#nNume# * nume1;   || base CC
               cobb_3 = #nomconst#23 * nume1;   || base AT
          |FINSI;
          |SI #nomcontr#2 = "N";
               coba_3 = prom_enf * nume1;   || base CC
               cobb_3 = prom_acc * nume1;   || base AT
          |FINSI;
     |FINSI;

     |SI #2#241 = "N";             || prestaciones INSS,empresa: NO
          base_1 = 0; base_2 = 0;    base_3 = 0;    base_4 = 0;    denfe_4 = 0;

          |SI #labtraba#138 = "N"
               || coba_4 = coba_4 + coba_1 + coba_2;
               || cobb_4 = cobb_4 + cobb_1 + cobb_2;
               coba_4 = coba_4 + coba_1;
               cobb_4 = cobb_4 + cobb_1;

               coba_1 = 0; cobb_1 = 0;
               || coba_2 = 0; cobb_2 = 0;    || accidente NO
               || sw_mater = 1;
               swITEmp = 1;
          |FINSI;

     |FINSI;
     |SI #32#14 = "N";             || prestaciones INSS: NO
          base_1 = 0; base_2 = 0;    base_3 = 0;    base_4 = 0;
     |FINSI;

     acum_53 = base_1 + base_2 + base_4;  || acumula (503)
     acum_54 = base_3;                    || acumula (504)
     acum_53 = acum_53 ! EURODB;   || redondea (503)
     acum_54 = acum_54 ! EURODB;   || redondea (504)
     |SI anticom = -1;
          |HAZ diasenf2;    || calcula complm. segun convenio (enfer.)
          |HAZ diasacc1;    || calcula complm. segun convenio (accid.)
     |SINO;
          |HAZ anticomp;    || calcula el anti-complemento
     |FINSI;
     |SI denfe_3 ! 0; |O dacci_3 ! 0;
          |SI #2#179 = "N";
               denfe_3 = 0;
               dacci_3 = 0;
          |FINSI;
     |FINSI;
     denfe_3 = denfe_3 ! EURODB;   || redondea
     denfe_4 = denfe_4 ! EURODB;
     dacci_3 = dacci_3 ! EURODB;
     |HAZ grabados;    || graba conceptos (511, 512 y 515)
|FPRC;

||****************************************************************************
||      RUTINAS DEL CALCULO DE LA ENFERMEDAD, ACCIDENTE Y COMPLEMENTOS
||****************************************************************************

|PROCESO calproac;
    nume1 = 0;      || acumulador de nro. de meses
    nume2 = 0;      || acumulador de bases cotizadas
    prom_ac2 = 0;   || promedio accid.
|SI #1#40 = "S";|Y dacci_2 ! 0;
    |ABRE #31;
        #31#0 = #2#0;
        #31#1 = #2#1;
    |LEE 000#31=;
    |SI FSalida ! 0;  |DDEFECTO #31;  |FINSI;
    |PARA nume0 = 2; |SI nume0 [ 13; |HACIENDO nume0 = nume0 + 1;
        |SI #31nume0 ! -1;
                nume1 = nume1 + 1;
                nume2 = nume2 + #31nume0;
        |FINSI;
    |SIGUE;
    |SI nume1 ! 0;
            prom_ac2 = nume2 / nume1;
            prom_ac2 = prom_ac2 ! EURODB;
    |FINSI;
    |CIERRA #31;
|FINSI;
|FPRC;

|PROCESO diasenf2;     || DESGLOSA DIAS ENFERMEDAD SEGUN AUX. CONVENIOS
    denfe_Z = 0;    || dias 1ra. enfermedad
    denfe_Y = 0;    || 1ra. linea resto enfermedades
    denfe_X = 0;    || 2da. linea resto enfermedades
    denfe_W = 0;    || 3ra. linea resto enfermedades
    denfe_V = 0;    || 4ta. linea resto enfermedades
|SI #2#60 ! "M"; |Y #2#60 ! "C"; || si no es maternidad
    |SI denfe_2 ! 0;                     || si ha estado enfermo
            denfe_t = denfe_2 + #2#89;   || suma los dias enfermedad actual

        || esto en su dia se comento aqui
        || con esto, no cuenta la primera enfermedad
        || solo los complementos de "resto enfermedades"
/*
        |SI #2#90 = 0;|O #2#89 = #2#90;  || si es 1ra. enfermedad
            |SI denfe_t > #14#03;
                    denfe_Z = #14#03 - #14#02 + 1;
            |SINO;
                    denfe_Z = denfe_t;
            |FINSI;
        |FINSI;
*/

        |SI denfe_Z ] #14#11;  #14#11 = denfe_Z + 1;  |FINSI;
        |SI denfe_Z < #14#15;
            |SI denfe_t > #14#15;
                    denfe_Y = #14#15 - #14#11 + 1;
            |SINO;
                    denfe_Y = denfe_t - (denfe_Z);
            |FINSI;
        |FINSI;
        |SI denfe_Z ] #14#12;  #14#12 = denfe_Z + 1;  |FINSI;
        |SI denfe_Z < #14#16;
            |SI denfe_t > #14#16;
                    denfe_X = #14#16 - #14#12 + 1;
            |SINO;
                    denfe_X = denfe_t - (denfe_Y + denfe_Z);
            |FINSI;
        |FINSI;
        |SI denfe_Z ] #14#13;  #14#13 = denfe_Z + 1;  |FINSI;
        |SI denfe_Z < #14#17;
            |SI denfe_t > #14#17;
                    denfe_W = #14#17 - #14#13 + 1;
            |SINO;
                    denfe_W = denfe_t - (denfe_X + denfe_Y + denfe_Z);
            |FINSI;
        |FINSI;
        |SI denfe_Z ] #14#14;  #14#14 = denfe_Z + 1;  |FINSI;
        |SI denfe_Z < #14#18;
            |SI denfe_t > #14#18;
                    denfe_V = #14#18 - #14#14 + 1;
            |SINO;
                    denfe_V = denfe_t - (denfe_W + denfe_X + denfe_Y + denfe_Z);
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
                       || QUITA LOS DIAS COMPLEMENTADOS EN MESES ANTERIORES
     nume1 = denfe_2;
     |SI denfe_V > nume1;
          denfe_Z = 0;
          denfe_Y = 0;
          denfe_X = 0;
          denfe_W = 0;
          denfe_V = nume1;

          || esto es nuevo 593.1196 de 21.02.2018, ya que si no pongo esto
          || no se estaba controlando que si tenias mas dias de los que
          || habia que complementar, dejara de complementar
          || complementaba todos los dias en el ultimo tramo en ese caso
          || aunque por los limites del ultimo trao ya no tuviera derecho

          nNume = (#14#15 - #14#11 + 1);
          nNume = nNume + (#14#16 - #14#12 + 1);
          nNume = nNume + (#14#17 - #14#13 + 1);
          nNume = nNume + (#14#18 - #14#14 + 1);
          nNume = denfe_t - nNume;
          |SI nNume > 0;
               denfe_V = denfe_V - nNume;
               |SI denfe_V < 0;
                    denfe_V = 0;
               |FINSI;
          |FINSI;
     |SINO;
          nume1 = nume1 - denfe_V;
     |FINSI;

|SI denfe_W > nume1;
        denfe_Z = 0;
        denfe_Y = 0;
        denfe_X = 0;
        denfe_W = nume1;
|SINO;
        nume1 = nume1 - denfe_W;
|FINSI;
|SI denfe_X > nume1;
        denfe_Z = 0;
        denfe_Y = 0;
        denfe_X = nume1;
|SINO;
        nume1 = nume1 - denfe_X;
|FINSI;
|SI denfe_Y > nume1;
        denfe_Z = 0;
        denfe_Y = nume1;
|SINO;
        nume1 = nume1 - denfe_Y;
|FINSI;
|SI denfe_Z > nume1;
        denfe_Z = nume1;
|FINSI;
                   || CALCULA COMPLEMENTO ENFERMEDAD
    denfe_3 = 0;         || inicializa acumuladores
|SI denfe_Z ! 0;         || si no es cero
    |SI #14#05 = "P";    || si es por promedio
        denfe_3 = denfe_3 + (denfe_Z * prom_enf * (#14#04/100));
    |SINO;
            desde = 6;
            hasta = 10;
            porce = #14#04;
        |HAZ acumcomp;
            denfe_3 = denfe_3 +(dacum_999 * denfe_Z);
            dacum_999 = 0;
    |FINSI;
|FINSI;

|SI denfe_Y ! 0;         || si no es cero
    |SI #14#23 = "P";    || si es por promedio
        denfe_3 = denfe_3 + (denfe_Y * prom_enf * (#14#19/100));
    |SINO;
            desde = 27;
            hasta = 31;
            porce = #14#19;
        |HAZ acumcomp;
            denfe_3 = denfe_3 +(dacum_999 * denfe_Y);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|SI denfe_X ! 0;         || si no es cero
    |SI #14#24 = "P";    || si es por promedio
        denfe_3 = denfe_3 + (denfe_X * prom_enf * (#14#20/100));
    |SINO;
            desde = 32;
            hasta = 36;
            porce = #14#20;
        |HAZ acumcomp;
            denfe_3 = denfe_3 +(dacum_999 * denfe_X);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|SI denfe_W ! 0;         || si no es cero
    |SI #14#25 = "P";    || si es por promedio
        denfe_3 = denfe_3 + (denfe_W * prom_enf * (#14#21/100));
    |SINO;
            desde = 37;
            hasta = 41;
            porce = #14#21;
        |HAZ acumcomp;
            denfe_3 = denfe_3 +(dacum_999 * denfe_W);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|SI denfe_V ! 0;         || si no es cero
    |SI #14#26 = "P";    || si es por promedio
        denfe_3 = denfe_3 + (denfe_V * prom_enf * (#14#22/100));
    |SINO;
            desde = 42;
            hasta = 46;
            porce = #14#22;
        |HAZ acumcomp;
            denfe_3 = denfe_3 +(dacum_999 * denfe_V);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO diasacc1;       || DESGLOSA DIAS ACCIDENTE SEGUN AUX. CONVENIOS
    dacci_Z = 0;   || 1ra. linea accidentes
    dacci_Y = 0;   || 2da. linea accidentes
|SI dacci_2 ! 0;                       || si ha estado accidentado
            dacci_t = dacci_2 + #2#92; || suma los dias accidente actual
    |SI dacci_t > #14#49;
            dacci_Z = #14#49 - #14#47 + 1;
    |SINO;
            dacci_Z = dacci_t;
    |FINSI;
    |SI dacci_t > #14#50;
            dacci_Y = #14#50 - #14#48 + 1;
    |SINO;
            dacci_Y = dacci_t - dacci_Z;
    |FINSI;
|FINSI;
               || QUITA LOS DIAS COMPLEMENTADOS EN MESES ANTERIORES
     nume1 = dacci_2;
|SI dacci_Y > nume1;
        dacci_Z = 0;
        dacci_Y = nume1;
|SINO;
        nume1 = nume1 - dacci_Y;
|FINSI;
|SI dacci_Z > nume1;
        dacci_Z = nume1;
|FINSI;
               || CALCULA COMPLEMENTO ACCIDENTE
    dacci_3 = 0;         || inicializa acumuladores
|SI dacci_Z ! 0;         || si no es cero
    |SI #14#53 = "P";    || si es por promedio
        dacci_3 = dacci_3 + (dacci_Z * prom_acc * (#14#51/100));
    |SINO;
            desde = 55;
            hasta = 59;
            porce = #14#51;
        |HAZ acumcomp;
            dacci_3 = dacci_3 +(dacum_999 * dacci_Z);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|SI dacci_Y ! 0;         || si no es cero
    |SI #14#54 = "P";    || si es por promedio
        dacci_3 = dacci_3 + (dacci_Y * prom_acc * (#14#52/100));
    |SINO;
            desde = 60;
            hasta = 64;
            porce = #14#52;
        |HAZ acumcomp;
            dacci_3 = dacci_3 +(dacum_999 * dacci_Y);
            dacum_999 = 0;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO anticomp;    || CALCULA EL ANTI-COMPLEMENTO
    denfe_3 = 0;
    dacci_3 = 0;
|SI denfe_2 ! 0; |O dmate_2 ! 0;
        denfe_3 = anticom - (acum_53 + denfe_4);
|FINSI;
|SI dacci_2 ! 0;
        dacci_3 = anticom - acum_54;
|FINSI;
|FPRC;

|PROCESO grabados;    || GRABA CONCEPTOS 511 Y 512
    swgracon = 1;     || para que grabe todos los campos
    swcongra = 0;     || para que no acumule si existe
    graba04 = 511;
    graba05 = "V";
    graba06 = 0;
    graba07 = 38;
    graba08 = "COMP.ENF";
    graba09 = 1;
    graba10 = denfe_3;
    graba11 = 1;
|SI denfe_3 ! 0;
    |HAZ grabacon;
        acum_50 = acum_50 + denfe_3;
|FINSI;
    graba04 = 512;
    graba05 = "V";
    graba06 = 0;
    graba07 = 39;
    graba08 = "COMP.ACC";
    graba09 = 1;
    graba10 = dacci_3;
    graba11 = 1;
|SI dacci_3 ! 0;
    |HAZ grabacon;
        acum_50 = acum_50 + dacci_3;
|FINSI;

    graba04 = 515;
    graba05 = "V";
    graba06 = 0;
    graba07 = 37;
    graba08 = "ENF.EMP.";
    graba09 = 1;
    graba10 = denfe_4;
    graba11 = 1;
|SI denfe_4 ! 0;
    |HAZ grabacon;
        acum_50 = acum_50 + denfe_4;
|FINSI;
|FPRC;

||****************************************************************************
||    SUBRUTINAS DEL CALCULO DE LA ENFERMEDAD, ACCIDENTE Y COMPLEMENTOS
||****************************************************************************

|PROCESO acumcomp;   || LEE CONCEPTOS Y ACUMULA VALOR DE COMPLEMENTOS
|PARA campo = desde; |SI campo [ hasta; |HACIENDO campo = campo + 1;
    |SI #14campo ! 0;
                             desc = #14campo; hasc = #14campo;
        |SI #14campo = 100;  desc = 101;      hasc = 199;     |FINSI;
        |SI #14campo = 400;  desc = 401;      hasc = 420;     |FINSI;
        |PARA actc = desc; |SI actc [ hasc; |HACIENDO actc = actc + 1;
                concepto = actc;    || bucle para los 100 y 400
            |HAZ leecompl;          || lee y acumula conceptos paga
            |SI FSalida = 0; |Y #12#06 = 1;  || si existe y el tipo es 1 !!!
                    duni1_999 = #12#09;
                    duni2_999 = #12#11;
                    dvalo_999 = #12#10;
                |SI #12#05="D";                divide=dia_2;     |FINSI;
                |SI #12#05="M";                divide=dia_4;     |FINSI;
                |SI #12#05="L";|O #12#05="K";  divide=duni1_999; |FINSI;
                |SI #12#05="V";|O #12#05="F";  divide=   30;     |FINSI;
                    product = duni1_999 * dvalo_999;
                    product = product ! EURODB;
                    dacum_999 = dacum_999+(((product / divide) * porce)/100);
            |FINSI;
        |SIGUE;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO leecompl;    || LEE CONCEPTOS PARA EL CALCULO DE COMPLEMENTOS
    doce = concepto;
|HAZ leedoce;
|FPRC;

||****************************************************************************
||                        CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO calpror;
     |PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
          |HAZ empieza;
          |SI #9diasp ! 0;|O #9porcp ! 0;
               |HAZ busca;
               |SI swpro = 1;
                    |HAZ leecon_200;    || lee en convenio el concepto 2xx
                                        || calcula el valor del conepto 2xx
                                        || calcula coeficiente 2xx
                    |HAZ cal_unid;      || calcula las unidades del 2xx
                    |HAZ gracal_200;    || graba el concepto 2xx
               |FINSI;                  || si la prorrata corresponde a este mes
               |HAZ guarda_per;         || guarda acumulado dias corresp. a paga
          |FINSI;
     |SIGUE;                            || pasa las pagas de 1 a 8
|FPRC;

||****************************************************************************
||                   RUTINAS PARA EL CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO busca;  || BUSCA SI HAY PRORRATA EN LA PAGA ACTUAL Y VA CONTANDO DIAS
     mas = 0;
     rompe = 0;
     |SI #9hasta = #9desde; |Y #9dedia > #9hadia;  rompe = 1;  |FINSI;
     |SI #9hasta < #9desde; |O rompe = 1;
          nume1 = #0#9 - 1;
          des1  = #9desde;   des2 =       1;
          has1  =      12;   has2 = #9hasta;
          |SI #9desde [ #0#8;                   || si ya ha empezado el ejer. actual
               mas = 1;                      || ejemplo: desde=4, hasta=3, actual=4
          |FINSI;                               || empieza a contar en este a¤o !!!
     |SINO;
          nume1 = #0#9;
          des1 = #9desde;   des2 =  0;
          has1 = #9hasta;   has2 = -1;
     |FINSI;
     nume1 = nume1 + mas;
     nume2 = #0#09 + mas;

     des = (nume1 * 100) + #9desde;  || mes desde
     has = (nume2 * 100) + #9hasta;  || mes hasta
     act = (#0#9  * 100) + #0#8;     || mes actual

     |SI act ] des; |Y act [ has;
          swpro = 1;
     |FINSI;

     |PARA pp = des1; |SI pp [ has1; |HACIENDO pp = pp + 1;
          anynum = nume1;
          |HAZ suma;
     |SIGUE;
     |PARA pp = des2; |SI pp [ has2; |HACIENDO pp = pp + 1;
          anynum = nume2;
          |HAZ suma;
     |SIGUE;
     mesnum = #9hasta;  anynum = nume2;         |HAZ ulti_dia;
     |SI #2#42="D";|O #2#42="T"; |O swBaseDiario = 1;
          pepulti=topemes;
     |SINO;
          pepulti=30;
     |FINSI;

     |SI #9dedia !       0;  nume6=#9dedia-      1; |SINO;  nume6 = 0;   |FINSI;
     |SI #9hadia ! topemes;  nume7=pepulti-#9hadia; |SINO;  nume7 = 0;   |FINSI;

     perio = perio - (nume6 + nume7);
|FPRC;

|PROCESO suma;
|SI #2#42 = "D";|O #2#42 = "T"; |O swBaseDiario = 1;
        mesnum = pp;
    |HAZ ulti_dia;
|SINO;
        topemes = 30;           || si es mensual cuenta por 30 los meses
|FINSI;
    perio = perio + topemes;
|FPRC;

|PROCESO leecon_200;      || LEE CONCEPTO 2xx EN CONVENIOS
|DDEFECTO #10;
    #10#0 = #9#0;
    #10#2 = concep0;
|LEE 000#10=;

|| ***********
|SI #2tipo_p = "V";
        concep1 = 51 + paga;      || calcula el 1er. campo de conceptos
        concep2 = concep1 + 32;   || calcula el ultimo campo de concep.
    |PARA campo = concep1; |SI campo [ concep2; |HACIENDO campo=campo+8;
        |SI #9campo ! 0;
                                desc = #9campo;  hasc = #9campo;
            |SI #9campo = 100;  desc = 101;      hasc = 199;     |FINSI;
            |SI #9campo = 400;  desc = 401;      hasc = 420;     |FINSI;
            |PARA actc = desc; |SI actc [ hasc; |HACIENDO actc=actc+1;
                    concepto = actc;    || bucle para los 100 y 400
                |HAZ leeconcep; || lee y acumula conceptos paga
            |SIGUE;
        |FINSI;              || si el concepto no es cero
    |SIGUE;                  || pasa los conceptos
|SINO;
    |SI #2tipo_p = "B";    || importe bruto
            dvalo_209 = #2ajus_p / 30;
    |FINSI;
    |SI #2tipo_p = "L";    || importe liquido
            dvalo_209 = ((#2ajus_p * 100) / (100 - #2#30)) / 30;
    |FINSI;
        ||dvalo_209 = dvalo_209 ! 2  || valor pagas (comentado por redond. euro)
        dvalo_200 = dvalo_209;      || valor prorrata
|FINSI;
|| ***********
|SI #0#8 = #9desde;|Y #9dedia !      1;  estevale = 1;  |FINSI;
|SI #0#8 = #9hasta;|Y #9hadia ! guarda;  estevale = 1;  |FINSI;

|SI estevale = 1;
    |HAZ recuento;
    |SI #10#4=1; dcofi_999=(pdia_a-(pdia_b+pdia_c+pdia_d+pdia_e))/pdia_a;|FINSI;
    |SI #10#4=2; dcofi_999=(pdia_a-        pdia_c               )/pdia_a;|FINSI;
|SINO;
    |HAZ diaspaga;
    |SI #10#4=1; dcofi_999=dcofi_1; |FINSI;
    |SI #10#4=2; dcofi_999=dcofi_2; |FINSI;
|FINSI;
|SI #10#4=0; dcofi_999=      1; |FINSI;
|SI dcofi_999 < 0;  dcofi_999 = 0;  |FINSI;
|FPRC;

|PROCESO leeconcep;  || lee y acumula concepto para paga
     doce = concepto;
|HAZ leedoce;
|SI FSalida = 0;
        duni1_999 = #12#09;
        duni2_999 = #12#11;
        dvalo_999 = #12#10;
    |SI #12#05 = "F"; |Y duni1_999 = 0; || si es calculo 'F' carga las unidades
    |Y concepto ! 102;
            duni1_999 = 1;              || con la unidad !!!
    |FINSI;
    |HAZ cal_valo;   || va acumulando el valor de los 5
|FINSI;              || si el concepto existe en calculos
|FPRC;

|PROCESO cal_valo;   || CALCULA EL VALOR ACUMULADO DE LOS 5 CONCEPTOS POR PAGA
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|SI #9tipos = "N";   || si es tipo 'N' o 'P'
    |SI #12#05="D";                divide=dia_2;     |FINSI; || dias mes
    |SI #12#05="M";                divide=dia_4;     |FINSI; || dias cotiz.
    |SI #12#05="L";|O #12#05="K";  divide=duni1_999; |FINSI; || dias lab./fes.
    |SI #12#05="V";|O #12#05="F";  divide=   30;     |FINSI; || dias fijos
|SINO;
        divide = 100;
|FINSI;
    dvalo_209 = dvalo_209 + (product / divide);  || entran todos los conceptos
|SI concepto ] 401; |Y concepto [ 420;
    |SI #9#140 = "S";
            dvalo_200 = dvalo_200 + (product / divide);
    |FINSI;
|SINO;
        dvalo_200 = dvalo_200 + (product / divide);
|FINSI;
|FPRC;

|PROCESO cal_unid;   || CALCULA LAS UNIDADES DEL CONCEPTO 2xx
     |SI swBaseDiario = 0;
          duni1_200 = (pdia_a * #9diasp * dcofi_999) / perio;
     |SINO;
          duni1_200 = (pdia_a * #9diasp * (duni2_101 / dia_2)) / perio;
     |FINSI;
     |SI #9tipos = "P";   || si es porcentual!!!
          duni1_200 = #9porcp * dcofi_999;
     |FINSI;
     duni1_200 = duni1_200 ! 4;  || redondea
|FPRC;

|PROCESO gracal_200;    || GRABA EL CONCEPTO 2xx;
    swgracon = 1;       || para que grabe todos los campos
    swcongra = 0;       || para que no acumule si existe
    graba04 = concep0;
|HAZ cogegra;
    graba09 = duni1_200;
    graba10 = dvalo_200;
    graba11 = duni2_200;
|SI duni1_200 ! 0; |O duni2_200 ! 0; |O dvalo_200 ! 0;
    |HAZ grabacon;
        product = dvalo_200 * duni1_200;
    |SI #9mesco = 99;                 || cuando no son pagas 99 no
            product = product ! EURODB;    || redondea para lograr mayor exactitud
    |FINSI;
        dvalo_pro = dvalo_pro + product;    || acumula total prorratas

        product = dvalo_209 * duni1_200;
    |SI #9mesco = 99;                 || cuando no son pagas 99 no
            product = product ! EURODB;    || redondea para lograr mayor exactitud
    |FINSI;
        dvalo_pag = dvalo_pag + product;    || acumula total pagas
|FINSI;
|FPRC;

|PROCESO guarda_per;      || PARA NO CALCULARLOS DESPUES EN PAGAS
|SI paga = 1;  perio1 = perio;  dvalo_201 = dvalo_209; |FINSI;
|SI paga = 2;  perio2 = perio;  dvalo_202 = dvalo_209; |FINSI;
|SI paga = 3;  perio3 = perio;  dvalo_203 = dvalo_209; |FINSI;
|SI paga = 4;  perio4 = perio;  dvalo_204 = dvalo_209; |FINSI;
|SI paga = 5;  perio5 = perio;  dvalo_205 = dvalo_209; |FINSI;
|SI paga = 6;  perio6 = perio;  dvalo_206 = dvalo_209; |FINSI;
|SI paga = 7;  perio7 = perio;  dvalo_207 = dvalo_209; |FINSI;
|SI paga = 8;  perio8 = perio;  dvalo_208 = dvalo_209; |FINSI;
|FPRC;

||****************************************************************************
||                        CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO calpaga;
|SI swbaja = 1;|Y #2#48 = "S";|Y #1#39 = "1";|Y runnom ! "nomcalfi";
        swpaga = 1;
|FINSI;
|SI swbaja = 1;|Y #2#48 = "S";|Y #1#39 ! "1";|Y runnom = "nomcalfi";
        swpaga = 1;
|FINSI;
|PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
    |HAZ empieza;                 || inicializa
    |SI #9diasp ! 0;|O #9porcp ! 0;
        |HAZ confec_1;                || calcula pagas
    |FINSI;
|SIGUE;
|FPRC;

||****************************************************************************
||                 RUTINAS PARA EL CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO confec_1;     || LANZA CALCULO DE PAGAS
|SI #9mesco = 99; |O #9mesco = #0#8; |O swpaga = 1;
    |SI runnom="nomcalfi";|Y dbaja_3=dia_2; || si es baja el ult.dia del mes
        |SI #9mesco=99;|O #9mesco=#0#8;     ||/y es mes de confeccion
            |ACABA;                         ||/y estamos calculando finiquito
        |FINSI;                             ||/ NO INCLUYE ESTA PAGA!!!
    |FINSI;
    |SI runnom!"nomcalfi";|Y dbaja_3!dia_2;|Y swpaga=0;|Y swbaja=1;
        ||SI #9mesco=99;|O #9mesco=#0#8;     || si no es finiquito y es baja a
        |SI #9mesco=#0#8;     || si no es finiquito y es baja a
            |ACABA;                         || /mitad de mes y es mes de paga
        |FINSI;                             || /NO INCLUYE ESTA PAGA!!!
        || esto en pagas prorrateadas no, en las 99 tengo que pagarlas aunque
        || sea baja en el mes al igual que en el regimen general 1044.461
    |FINSI;
    |HAZ cargavar;                 || carga vars. y calcula coeficientes
    |HAZ leecal_200;               || lee el concepto paga
    |SI #9mesco = 99;              || si el mes de confeccion es el 99
        |HAZ confec_2;             || /calcula solo lo de este mes
    |SINO;
        |HAZ confec_3;             || si el mes de confeccion no es 99
    |FINSI;                        || /pueden pasar dos cosas (Ver 'confec_3')
    |HAZ grapaga;
|FINSI;
|FPRC;

||****************************************************************************
||                 SUBRUTINAS DEL CALCULO DE LAS PAGAS
||****************************************************************************

|PROCESO cargavar;
    diast = paga + 49;    || dias dto. enfe/acci
    acumb = paga + 54;    || acumulado bases o dias
    bases = paga + 64;    || bases diferidas
|SI paga > 5;                 || desorden de campos !!!
        diast = paga + 72;
        acumb = paga + 75;
        bases = paga + 78;
|FINSI;
|SI paga = 1; perio = perio1; dvalo_209 = dvalo_201; |FINSI;
|SI paga = 2; perio = perio2; dvalo_209 = dvalo_202; |FINSI;
|SI paga = 3; perio = perio3; dvalo_209 = dvalo_203; |FINSI;
|SI paga = 4; perio = perio4; dvalo_209 = dvalo_204; |FINSI;
|SI paga = 5; perio = perio5; dvalo_209 = dvalo_205; |FINSI;
|SI paga = 6; perio = perio6; dvalo_209 = dvalo_206; |FINSI;
|SI paga = 7; perio = perio7; dvalo_209 = dvalo_207; |FINSI;
|SI paga = 8; perio = perio8; dvalo_209 = dvalo_208; |FINSI;

|SI #0#8 = #9desde;|Y #9dedia !      1;  estevale = 1;  |FINSI;
|SI #0#8 = #9hasta;|Y #9hadia ! guarda;  estevale = 1;  |FINSI;

|SI estevale = 1;
    |HAZ recuento;
        pcofi_1 = (pdia_0-(pdia_1+pdia_2+pdia_3+pdia_4))/pdia_0;
        pcofi_2 = (pdia_0-        pdia_2               )/pdia_0;
        pcofi_3 = (pdia_0-(       pdia_2+pdia_3+pdia_4))/pdia_0;
        pcofi_4 = (pdia_0-(pdia_1+pdia_2       +pdia_4))/pdia_0;
|SINO;
        pcofi_1 = dcofi_1;
        pcofi_2 = dcofi_2;
        pcofi_3 = dcofi_3;
        pcofi_4 = dcofi_4;
    |HAZ diaspaga;
|FINSI;

|SI #1#26="S";|Y #1#27="S"; dcofi_999=pcofi_1; |FINSI;  || calcula coefic.
|SI #1#26="N";|Y #1#27="N"; dcofi_999=pcofi_2; |FINSI;  || para pagas 99
|SI #1#26="N";|Y #1#27="S"; dcofi_999=pcofi_3; |FINSI;  || y porcentuales
|SI #1#26="S";|Y #1#27="N"; dcofi_999=pcofi_4; |FINSI;
|FPRC;

|PROCESO leecal_200;    || LEE CONCEPTO DE LINEAS DE CALCULOS CORREP. A PAGA
    doce = concep0;
|HAZ leedoce;
|SI FSalida ! 0;         || si no esta en calculos, lee convenio
        #10#0 = #9#0;
        #10#2 = concep0;
    |LEE 000#10=;
    |SI FSalida ! 0;
        |DDEFECTO #10;
    |FINSI;
        #12#05 = #10#3;   || carga calculo alfa de convenios
        #12#06 = #10#4;   || carga calculo nume de convenios
        #12#07 = #10#5;   || carga situacion de convenios
        #12#08 = #10#6;   || carga descripcion de convenios
        #12#09 = 0;
        #12#10 = 0;
        #12#11 = 0;
|FINSI;
    duni1_999 = #12#09;
    duni2_999 = #12#11;
    dvalo_999 = #12#10;
|FPRC;


|PROCESO confec_2;    || CALCULA PAGA CUANDO ES 99 (propor. a los dias en alta)
     |SI swBaseDiario = 0;
          duni2_999 = (pdia_0 * dcofi_999) * (#9diasp / perio);
     |SINO;
          duni2_999 = (pdia_0 * ((duni2_101 + nDiasITPaga) / dia_2)) * (#9diasp / perio);
     |FINSI;
     |SI #9tipos = "P";    || si es porcentual
          duni2_999 = #9porcp * dcofi_999;
     |FINSI;
     duni2_999 = (duni2_999*dvalo_209)/dvalo_999;  || ajusta a paga completa
     duni2_999 = duni2_999 ! 4;                    || redondea
     product = duni2_999 * dvalo_999;  product = product ! EURODB;
     acum1_200 = acum1_200 + product;
|FPRC;


|PROCESO confec_3;    || CALCULA PAGA CUANDO NO ES 99
                      || si el mes actual es distinto al de fin calculo paga
|SI #9hasta ! #9mesco;            || /coge las bases diferidas de dos formas:
    |SI dvalo_999 = 0;            || si no hay prorrata este mes
            duni2_999 = 1;        || /mete las bases diferidas en valor
            dvalo_999 = #2bases;
            product = duni2_999 * dvalo_999;  product = product ! EURODB;
        |SI swpaga = 0;
                acum2_200 = acum2_200 + product;
        |SINO;
                acum1_200 = acum1_200 + product;
        |FINSI;
    |SINO;                                    || si si que hay calcula
            duni2_999 = #2bases/dvalo_999;    || /las unidades calculo
        |SI swpaga = 1;
            |HAZ confec_X;
        |SINO;
                product = duni2_999 * dvalo_999;  product = product ! EURODB;
                acum2_200 = acum2_200 + product;
        |FINSI;
    |FINSI;
|SINO;
    |HAZ confec_X;    || cuando en el mes actual es cuando se acaba la paga
|FINSI;               || /no hay que coger nada diferido
|FPRC;

|PROCESO confec_X;   || CALCULA LA PAGA ACTUAL
    dias_dto = #2diast;
|SI #1#26="S";  dias_dto=dias_dto+pdia_1; |FINSI;   || enf./mat.
|SI #1#27="S";  dias_dto=dias_dto+pdia_3; |FINSI;   || accid.
                dias_dto=dias_dto+pdia_4;           || absen.

|SI #9tipos = "N";
        duni2_200= (#2acumb+ (pdia_0*pcofi_2) ) -dias_dto;
    |SI duni2_200<0;  duni2_200 = 0;  |FINSI;
        duni2_200= (duni2_200*#9diasp)/perio;
|SINO;
        duni2_200=(#2acumb+( (#9porcp*dcofi_999)*dvalo_999) ) /dvalo_999;
|FINSI;
    duni2_200=(duni2_200*dvalo_209)/dvalo_999;  || ajusta a paga completa

    duni2_999 = duni2_999 + duni2_200; || unidades calculo totales
    duni2_999 = duni2_999 ! 4;         || se redondea como las prorratas !!!
    product = duni2_999 * dvalo_999;  product = product ! EURODB;
|SI swpaga = 0;
        acum2_200 = acum2_200 + product;
|SINO;
        acum1_200 = acum1_200 + product;
|FINSI;
|FPRC;

|PROCESO grapaga;       || REGRABA LA PAGA
    graba04 = concep0;
    swcongra = 0;       || para que no acumule si existe
|SI swpaga = 1; |O #9mesco = 99;
        swgracon = 1;     || para que regrabe los campos si existe
        graba05 = "P";
        graba06 = 0;
|SINO;
        swgracon = 0;
        graba05 = #12#05;
        graba06 = #12#06;
|FINSI;
    graba07 = #12#7;
    graba08 = #12#8;
    duni1_999 = duni1_999 ! 4;
    duni2_999 = duni2_999 ! 4;
    graba09 = duni1_999;
    graba10 = dvalo_999;
    graba11 = duni2_999;
|SI duni1_999 ! 0; |O duni2_999 ! 0; |O dvalo_999 ! 0;
    |HAZ grabacon;
|FINSI;
|FPRC;

||****************************************************************************
||              RUTINAS COMUNES A PRORRATAS Y PAGAS
||****************************************************************************

|PROCESO recuento;
    de1 = 0;  ha1 = -1;  de2 = 0;  ha2 = -1;
|SI #0#8 = #9desde;     de1 = #9dedia;  ha1 =  guarda;  |FINSI;
|SI #0#8 = #9hasta;     de1 =       1;  ha1 = #9hadia;  |FINSI;
|SI #9desde = #9hasta;|Y #9dedia [ #9hadia;
        de1 = #9dedia;  ha1 = #9hadia;
|FINSI;
|SI #9desde = #9hasta;|Y #9dedia > #9hadia;
        de1 = #9dedia;  ha1 =  guarda;
        de2 =       1;  ha2 = #9hadia;
|FINSI;
|PARA mid = de1; |SI mid [ ha1; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_a = pdia_a + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_b = pdia_b + 1;  |FINSI;  || enf/mat
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_c = pdia_c + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_d = pdia_d + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_e = pdia_e + 1;  |FINSI;  || abs.
|SIGUE;
|PARA mid = de2; |SI mid [ ha2; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_0 = pdia_0 + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_1 = pdia_1 + 1;  |FINSI;  || enf/mat
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_2 = pdia_2 + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_3 = pdia_3 + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_4 = pdia_4 + 1;  |FINSI;  || abs.
|SIGUE;

    pdia_5 = pdia_2;
|SI pdia_a > pdia_c;|Y ha2 ! -1;|Y swpaga = 1; || si es finiquito y hay que
        pdia_5 = pdia_c - pdia_a;              || guardar dias para sig.vencim.
|FINSI;                                        || se incluyen en este !!!!!!!

    pdia_a = pdia_a + pdia_0;   || letras --> prorrata (contienen los de paga)
    pdia_b = pdia_b + pdia_1;   || numeros -> paga
    pdia_c = pdia_c + pdia_2;
    pdia_d = pdia_d + pdia_3;
    pdia_e = pdia_e + pdia_4;

    pdia_2 = pdia_5;
|FPRC;

|PROCESO empieza;         || SACA LAS VARIABLES DEL CONVENIO SEGUN PAGA
     duni1_999 = 0;
     duni2_999 = 0;
     dvalo_999 = 0;
     dvalo_200 = 0;
     dvalo_209 = 0;
     duni1_200 = 0;
     duni2_200 = 0;
     dias_dto = 0;
     swpro = 0;
     perio = 0;
     pdia_0 = 0;    pdia_1 = 0;    pdia_2 = 0;    pdia_3 = 0;    pdia_4 = 0;
     pdia_a = 0;    pdia_b = 0;    pdia_c = 0;    pdia_d = 0;    pdia_e = 0;
     estevale = 0;
     dedia = paga + 107;    || desde dia prorrata
     hadia = paga + 115;    || hasta dia prorrata
     desde = paga + 3;      || desde mes prorrata
     hasta = paga + 11;     || hasta mes prorrata
     tipos = paga + 27;     || tipo de calculo
     diasp = paga + 35;     || dias
     porcp = paga + 43;     || porcentaje
     concep0 = paga + 200;  || concepto de paga
     mesco = paga + 19;     || mes confeccion
     tipo_p = paga + 156;   || tipo ajuste paga (trabajador)
     ajus_p = paga + 164;   || importe ajuste paga (trabajador)

     pror_p = paga + 112;   || prorrateo paga S/N (trabajador)
     |SI #labtraba#pror_p# = "S"; || xxx
          #9mesco = 99;
     |FINSI;
|FPRC;

|PROCESO diaspaga;
     |SI swBaseDiario = 1;
          pdia_0 = dia_2;
     |SINO;
          pdia_0 = dia_4;
     |FINSI;
     pdia_a = pdia_0;
     pdia_1 = denfe_2 + dmate_2;            pdia_b = pdia_1;
     pdia_2 = dalta_2 + dbaja_2 + dhuel_2 + ddese_2;  pdia_c = pdia_2;
     pdia_3 = dacci_2;                      pdia_d = pdia_3;
     pdia_4 = dabse_2;                      pdia_e = pdia_4;

     nDiasITPaga = 0;    || aqui me guardo los dias que he de a¤adir a
                         || los dias de paga estando en IT segun configuracion
                         || de la empresa
     |SI swBaseDiario = 1;
          |SI #labempre#26 = "N";
               nDiasITPaga = nDiasITPaga + denfe_2;
               nDiasITPaga = nDiasITPaga + dcont_2;
          |FINSI;
          |SI #labempre#27 = "N";
               nDiasITPaga = nDiasITPaga + dacci_2;
          |FINSI;
          |SI #labempre#43 = "N";
               nDiasITPaga = nDiasITPaga + dmate_2;
          |FINSI;
          |SI #labempre#44 = "N";
               nDiasITPaga = nDiasITPaga + dabse_2;
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||                      CALCULO FINAL 1 (ajusta a brutos)
||****************************************************************************

|PROCESO calfin1;    || CALCULOS ANTERIORES AL AJUSTE A BRUTOS
     |HAZ calindem;  || calcula la indemnizacion
     |HAZ calvacac;  || calcula las vacaciones
     |HAZ calirpfr;  || calcula base IRPF recibos

     || tiquet 2685.725, 5312.103 y ojo el 5432.63 (solo para ajustes)
     |SI #2#42 = "E"; |Y #2#241 ! "N";   || prestaciones SI
          |SI #labtraba#97 = 2; |Y #labtraba#98 ! 0;;
               |HAZ PrestaJor;
          |SINO;
               || en ajustes a bruto lo ha de hacer aqui, para tener el
               || importe completo antes de ajustar, en el resto abajo, como
               || siempre
          |FINSI;
     |FINSI;

     |HAZ calajus1;  || ajusta a brutos, concepto 407 (no cotiza) y 120 (cotiza)
     |HAZ calirpfp;  || calcula base IRPF pagas
|FPRC;

||****************************************************************************
||                       RUTINAS CALCULO FINAL 1
||****************************************************************************

|PROCESO calindem;   || CALCULA LA INDEMNIZACION
|SI indemni ! -1; |Y swpaga = 1;
    |SI #2#36 ! "..........";|Y #2#36 ! "          ";      || fecha alta valida
        |SI fecbaj ! "..........";|Y fecbaj ! "          ";|| fecha baja valida
                fecsys = #2#36;
                fecsis = fecbaj;
                nume0 = fecsis - fecsys;
            |SI nume0 = 366; |Y bisiesto = 1; || si es bisiesto y ha trabajado
                    nume0 = 365;              || /un a¤o exacto le pone 365
            |FINSI;
                duni1_902 = indemni;
                duni2_902 = (nume0 / 365) * indemni;  || proporciona los dias
                duni2_902 = duni2_902 ! 0;            || /por a¤o trabajado
                dvalo_902 = prom_enf;
                product = dvalo_902 * duni2_902;
                product = product ! EURODB;
                concepto = 415;
            |HAZ convenio;                   || regraba el concepto
            |SI convenio = 0;                || /415 si existe en convenios
                    graba04 = 415;
                    graba09 = indemni;
                    graba10 = dvalo_902;
                    graba11 = duni2_902;
                |SI product ! 0;
                        swgracon = 1;   || para que regrabe campos
                        swcongra = 1;   || para que acumule si existe
                    |HAZ cogegra;
                    |HAZ grabacon;
                        acum_41 = acum_41 + product;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO calvacac;   || CALCULA LAS VACACIONES
|SI vacacio ! -1; |Y swpaga = 1;
    |SI #2#36 ! "..........";|Y #2#36 ! "          ";      || fecha alta valida
        |SI fecbaj ! "..........";|Y fecbaj ! "          ";|| fecha baja valida
                fecsys = #2#36;
                fecsis = fecbaj;
                nume0 = fecsis - fecsys;
            |SI nume0 = 366; |Y bisiesto = 1; || si es bisiesto y ha trabajado
                    nume0 = 365;              || /un a¤o exacto le pone 365
            |FINSI;
                duni1_903 = vacacio;
                duni2_903 = (nume0 / 365) * vacacio;  || proporciona los dias
                duni2_903 = duni2_903 ! 0;            || /por a¤o trabajado
                duni2_903 = duni2_903 - #2#173;       || resta los disfrutados
            |SI duni2_903 < 0;  duni2_903 = 0;  |FINSI;
                dacum_vac = dacum_vac ! EURODB;  || acumulador precio dia vacacion
                dvalo_903 = dacum_vac;
                product = dvalo_903 * duni2_903;
                product = product ! EURODB;
            |SI #32#1 = "N";  concepto = 409;  |FINSI;
            |SI #32#1 = "S";  concepto = 125;  |FINSI;
            |HAZ convenio;                   || regraba el concepto
            |SI convenio = 0;                || /416 si existe en convenios
                    graba04 = concepto;
                    graba09 = vacacio;
                    graba10 = dvalo_903;
                    graba11 = duni2_903;
                |SI product ! 0;
                        swgracon = 1;   || para que regrabe campos
                        swcongra = 1;   || para que acumule si existe
                    |HAZ cogegra;
                    |HAZ grabacon;
                    |SI #32#1 = "N";
                                        acum_40  =acum_40 +product;
                        |SI #10#8 = 1;  acum_401 =acum_401+product;  |FINSI;
                        |SI #10#8 = 2;  acum_402 =acum_402+product;  |FINSI;
                        |SI #10#8 = 3;  acum_403 =acum_403+product;  |FINSI;
                    |SINO;
                                        acum_10  =acum_10 +product;
                        |SI #10#8 = 1;  acum_11  =acum_11 +product;  |FINSI;
                        |SI #10#8 = 2;  acum_12  =acum_12 +product;  |FINSI;
                        |SI #10#8 = 3;  acum_13  =acum_13 +product;  |FINSI;
                    |FINSI;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO calirpfr;   || CALCULA BASE IRPF, BRUTO RECIBOS Y BRUTO PAGAS
    acum_99  = acum_10 + acum_30  + acum_31  + acum_40;   || total
    acum_991 = acum_11 + acum_301 + acum_311 + acum_401;  || irpf 1
    acum_992 = acum_12 + acum_302 + acum_312 + acum_402;  || irpf 2
    acum_993 = acum_13 + acum_303 + acum_313 + acum_403;  || irpf 3
|SI runnom = "nomcalir";     || en el calculo de (%) IRPF no acumula pagas 99!
        acum_99  = acum_99 +acum_50+acum_51+acum_52+acum_53+acum_54+acum_90;
        acum_991 = acum_991+acum_50+acum_51+acum_52+acum_53+acum_54+acum_90;
|SINO;
        acum_99  = acum_99 +acum_50+acum_51+acum_52+acum_53+acum_54+acum_90+acum1_200;
        acum_991 = acum_991+acum_50+acum_51+acum_52+acum_53+acum_54+acum_90+acum1_200;
    |SI sw_bruaju = 0;
            bruto_aju=bruto_aju+acum1_200+acum_50+acum_51+acum_52+acum_53+acum_54;
            sw_bruaju=1;
    |FINSI;    || le suma al bruto ajustes lo que le falta (solo una vez)
|FINSI;
    acum_99 = acum_99 -anti_41;    || le quita la parte del anti-complemento
    acum_99 = acum_99  ! EURODB;        || /de los conceptos que no retienen IRPF
    acum_991= acum_991 ! EURODB;
    acum_992= acum_992 ! EURODB;
    acum_993= acum_993 ! EURODB;
    bruto_rec = acum_99 + acum_41 + anti_41;   || bruto recibo
    bruto_pag = acum2_200;                     || bruto pagas
    bruto_rec = bruto_rec ! EURODB;
    bruto_pag = bruto_pag ! EURODB;
|FPRC;

|PROCESO ImporteAjuste;
     |SI #labtraba#207 = "D";
          |SI #labtraba#42 = "A";
               stop = #2#98 * 30;
               stop = stop * dcofi_999;
          |SINO;
               stop = #2#98 * fijo_1;
          |FINSI;
     |SINO;
          stop = #2#98 * dcofi_999;
     |FINSI;
     stop = stop ! EURODB;
|FPRC;

|PROCESO calajus1;   || AJUSTA A BRUTOS (cotizando -120-, o sin cotizar -407-)
     |SI #2#97 [ 2; |Y #2#97 ! 0;
          |SI #2#97 = 1;
                 concepto = 407;
          |SINO;
                 concepto = 120;
          |FINSI;
          |HAZ ajustes;
          |SI convenio = 0;
               |HAZ ImporteAjuste;
               ajus_1 = stop - bruto_aju;
               |SI ajus_1 > 0;|O #2#61 = "S";
                     graba04 = concepto;
                     |HAZ cogegra;
                     graba09 = 1;
                     graba10 = ajus_1;
                     graba11 = 1;
                     swgracon = 1;     || para que regrabe campos
                     swcongra = 1;     || para que acumule si existe
                 |HAZ grabacon;
                 |SI #2#97 = 1;
                                     acum_40  =acum_40  +ajus_1;
                     |SI #10#8 = 1;  acum_401 =acum_401 +ajus_1;  |FINSI;
                     |SI #10#8 = 2;  acum_402 =acum_402 +ajus_1;  |FINSI;
                     |SI #10#8 = 3;  acum_403 =acum_403 +ajus_1;  |FINSI;
                 |SINO;
                                     acum_10 =acum_10 +ajus_1;
                         |SI #10#8 = 1;  acum_11 =acum_11 +ajus_1;  |FINSI;
                         |SI #10#8 = 2;  acum_12 =acum_12 +ajus_1;  |FINSI;
                         |SI #10#8 = 3;  acum_13 =acum_13 +ajus_1;  |FINSI;
                    |FINSI;
                    bruto_aju = bruto_aju + ajus_1;
                    bruto_rec = bruto_rec + ajus_1; || actualiza bruto recibo
                    |SI #10#8 = 1;  acum_991 =acum_991 +ajus_1;  |FINSI;
                    |SI #10#8 = 2;  acum_992 =acum_992 +ajus_1;  |FINSI;
                    |SI #10#8 = 3;  acum_993 =acum_993 +ajus_1;  |FINSI;
                    acum_99 = acum_99 + ajus_1;     || actualiza IRPF total
               |FINSI;
               |SI ajus_1 < 0;
                    nIncid = 5;
                    |HAZ graba_inc;
                    nIncid = 6;
                    |SI #2#213 ] 101; aAlfa = #2#213; |SINO; aAlfa = #10#2; |FINSI;
                    aDesIncid = "  *** Concepto: " + aAlfa + ". CIF Empresa: " + #labempre#10 + "***";
                    |HAZ graba_inc;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calirpfp;   || CALCULA RETENCIONES IRPF
    reten_11 = acum_991 % #2#030;  || retencion IRPF 1
    reten_12 = acum_992 % #2#174;  || retencion IRPF 2
    reten_13 = acum_993 % #2#175;  || retencion IRPF 3
    reten_11 = reten_11 ! EURODB;
    reten_12 = reten_12 ! EURODB;
    reten_13 = reten_13 ! EURODB;
    reten_1 = reten_11 + reten_12 + reten_13;  || total retenciones
    reten_2 = acum2_200 % #2#30;  || retencion IRPF pagas
    reten_2 = reten_2 ! EURODB;
|FPRC;

|PROCESO ERE;
     nDesem = 0;
     |SI ddese_2 > 0;                        || ATENCION:tengo regulacion de empleo
          |SI swBaseFija = 1;
               nume1 = ddese_2;
               nDesem = nume1 * #labtraba#242;  || si tengo regulacion de empleo, los
               nDesem = nDesem ! EURODB;          || los tengo que calcular tomando en
          |SINO;
               nume1 = nJornadasERE;
               nDesem = nume1 * #labtraba#242;  || si tengo regulacion de empleo, los
               nDesem = nDesem ! EURODB;          || los tengo que calcular tomando en
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PrestaJor;
     || regraba las prestaciones segun lo calculado por el calendario
     || de jornadas

     |SI denfe_4 = 0; |Y nPrestacionEnf = 0;
          |ACABA;
     |FINSI;

     acum_50 = acum_50 - denfe_4;  || lo que pudiera haber calculado
     bruto_aju = bruto_aju - denfe_4;
     denfe_4 = nPrestacionEnf;

     graba04 = 515;
     graba05 = "V";
     graba06 = 0;
     graba07 = 37;
     graba08 = "ENF.EMP.";
     graba09 = 1;
     graba10 = denfe_4;
     graba11 = 1;
     swcongra = 0;       || para que no acumule
     |HAZ grabacon;
     acum_50 = acum_50 + denfe_4;
     bruto_aju = bruto_aju + denfe_4;

     |HAZ calirpfr;   || RECALCULA IRPF, BRUTO RECIBOS Y BRUTO PAGAS
     |HAZ calirpfp;   || RECALCULA RETENCIONES IRPF
|FPRC;

||****************************************************************************
||                            CALCULO FINAL 2 (ajuste a liquidos)
||****************************************************************************

|PROCESO calfin2;   || CALCULOS POSTERIORES AL AJUSTE A BRUTOS
     |SI #2#42 ! "H";
          |HAZ calextra;      || calcula bases h. extras redondeadas
          |SI #0#9 ] 2012;
               |HAZ calcotiz12;
               |SI #2#42 = "E"; |Y #2#241 ! "N";   || por jornadas y
                                                   || prestaciones SI
                    |SI #labtraba#97 = 2; |Y #labtraba#98 ! 0;;
                         || en ajustes no es ahora cuando pasa
                    |SINO;
                         || el resto si, claro
                         |HAZ PrestaJor;
                    |FINSI;
               |FINSI;
          |SINO;
               |HAZ calcotiz;
          |FINSI;
     |SINO;
          base_5 = 0;
          base_6 = 0;   || los gerentes/coperativistas autonomos
          base_7 = 0;   || no cotizan !!!
     |FINSI;
     |SI #0#9 ] 2012;
          |HAZ calboni112;
     |SINO;
          |HAZ calboni1;
          |HAZ calboni11;     || bonificacion doble
     |FINSI;
     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     nMes = #0#8;
     nAny = #0#9;
     nBonifFCI = 0;
     ||HAZ calboniFCI; || bonif comento contratacion indefinida RDL 5/2006
     nBonifJOR = 0;
     |HAZ calboniJOR;
     |HAZ calboniFIJA;
     |HAZ calboni3;
     |HAZ calboni60;
     |HAZ calajus3;      || ajusta a liquidos, concepto 407 (no cotiza)
     |HAZ calajus4;      || ajusta a liquidos, concepto 120 (cotiza)
     |HAZ calajus5;      || ajusta a liquidos y brutos, concepto 411 (no cotiza y no IRPF)
     |SI #0#9 ] 2012;

          |HAZ calssemp12_1;  || calcula S.S. cgo. empresa, primera parte
                              || para saber las reducciones, que me hacen
                              || falta para la bonif de mayores de 60
          |HAZ calboni60;     || otra vez
          |HAZ calboniFCI;

          |HAZ calssemp12_2;  || calcula S.S. cgo. empresa, el resto del
                              || proceso
     |SINO;
          |HAZ calssemp;      || calcula S.S. cgo. empresa
     |FINSI;
     |HAZ avisoJorIT;    || aviso para los que tienen baja y no tienen jornadas IT
     |HAZ avisoJorERE;    || aviso para los que tienen baja y no tienen jornadas ERE
|FPRC;

||****************************************************************************
||                       RUTINAS CALCULO FINAL 2
||****************************************************************************

|PROCESO calextra;      || CALCULA BASE H.EXTRA REDONDEADAS A 300
    dacum_30 = acum_30;
    dacum_31 = acum_31;
|FPRC;

/*
|PROCESO historico;
|SI denfe_2 = 0;|Y dmate_2 = 0;|Y dacci_2 = 0;|Y dabse_2 = 0;
     |ACABA;   || si no hay ILT
|FINSI;

    nume1 = #0#9;   nume1 = nume1 $ 100;          || a¤o
    nume2 = #0#8 - 1;                             || mes
|SI nume2 = 0;
        nume1 = nume1 - 1;
    |SI nume1 < 0;  nume1 = 99;    |FINSI;
        nume2 = 12;
|FINSI;

|ABRE #39;
    #39#0 = #2#0;   || empresa
    #39#1 = #2#1;   || trabajador
    #39#2 = nume2;  || mes
    #39#66= nume1;  || a¤o
    #39#3 = 0;      || tipo
|LEE 000#39=;
|SI FSalida = 0;
        base_5 = (#39#37 + #39#38) - (acum_10 + coba_3 + dvalo_pro);
        difbase = #39#39 - base_6;
|SINO;
        alfa1 = "0000IT: Mes anterior de [" + #2#0 + "." + #2#1 + "] inaccesible.";
    |MENAV alfa1;
    |HAZ segun_control;
|FINSI;
|CIERRA #39;
|FPRC;

|PROCESO segun_control;
    |SI #32#16 = 1;
            base_5 = coba_1 + cobb_2 + coba_3;   || base ILT (comunes)
    |FINSI;
    |SI #32#16 = 2;
            base_5 = cobb_1 + coba_2 + cobb_3;   || base ILT (profesionales)
    |FINSI;
|FPRC;
*/

|PROCESO LimiteJor;
     nLimiteJor = 0;
     nume1 = fijo_1 + jornadasIT;
     alfa1 = #labtraba#0; alfa1 = "00000" + alfa1; alfa1 = alfa1 % -105;
     alfa2 = #labtraba#1; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
     |SI #0#9 = 2009;
          alfa3 = "2009";
          alfa4 = "24";
          |SI nume1 > 24;
               aAlfa = "    ATENCION: el trabajador " + alfa1 + "." + alfa2;
               aAlfa = aAlfa + " supera el límite máximo de " + alfa4  + " jornadas cotizables para ";
               aAlfa = aAlfa + alfa3;
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |SI #0#9 ] 2010;
          || en los convenios con conceptos 101 que sean D1 o M1 no tienen
          || que limitar las jornadas a 23 en la introduccion ya que se cobra
          || segun las jornadas introducidas y se puede cobrar lo que se quiera
          || siempre que luego la nomina limite a 23

          |SALVA_FICHA #nomconli;
          #nomconli#0 = #labtraba#87;
          #nomconli#2 = 101;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               |SI nume1 > 23;
                    |SI #nomconli#3 = "D"; |O #nomconli#3 = "M";
                         |SI #nomconli#4 = 1;
                              nLimiteJor = 23;
                              |ACABA;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |REPON_FICHA #nomconli;

          || alfa3 = "2010";
          alfa4 = "23";
          |SI nume1 > 23;
               aAlfa = "    ATENCION: el trabajador " + alfa1 + "." + alfa2;
               aAlfa = aAlfa + " supera el límite máximo de " + alfa4  + " jornadas cotizables.";
               || aAlfa = aAlfa + " supera el límite máximo de " + alfa4  + " jornadas cotizables para ";
               || aAlfa = aAlfa + alfa3;
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calcotiz;      || CALCULA BASE CON.COMUNES Y BASE D+F+P (AGRARIA*)
     base_5 = 0;
     |SI swBaseFija = 1;
          || por la base fija
          |SI #2#33 = 12;
               catego = 11 + 23;
          |SINO;
               catego = #2#33 + 23;
          |FINSI;

          base_6 = #18catego / 30;   || base cotiz. CONT.COM.
          nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
          base_6 = (dcoti_0 - nume2) * base_6;

          base_7 = #18catego / 30;   || base cotiz. DES.+FOGASA
          base_7 = dcoti_0 * base_7;

          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    nume1 = acum_10 + dvalo_pro;   || ctos. 100 + prorr.
                    base_6 = nume1;
                    base_7 = nume1 + coba_1 + cobb_2 + coba_3;
                    nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
                    nMinimo = #18#36;
                    nMinimo = (nMinimo / 30) * (dcoti_0 - nume2)
                    nMaximo = #18#24;
                    nMaximo = (nMaximo / 30) * (dcoti_0 - nume2)
                    |SI base_6 < nMinimo;
                         base_6 = nMinimo;
                    |FINSI;
                    |SI base_6 > nMaximo;
                         base_6 = nMaximo;
                    |FINSI;

                    nMinimo = #18#36;
                    nMinimo = (nMinimo / 30) * (dcoti_0)
                    nMaximo = #18#24;
                    nMaximo = (nMaximo / 30) * (dcoti_0)
                    |SI base_7 < nMinimo;
                         base_7 = nMinimo;
                    |FINSI;
                    |SI base_7 > nMaximo;
                         base_7 = nMaximo;
                    |FINSI;
               |FINSI;
          |FINSI;

     |SINO;

          || por jornadas
          |SI #2#33 = 12;
               catego = 11;
          |SINO;
               catego = #2#33;
          |FINSI;

          |HAZ LimiteJor;

          |SI nLimiteJor ! 0;
               || he limitado las jornadas porque me pasaba del limite
               || reparto entre las jornadas en alta y las en IT
               |SI fijo_1 ] nLimiteJor;      || todas en alta, limito al maximo
                    fijo_1 = nLimiteJor;
                    jornadasIT = 0;
               |SINO;
                    fijo_1 = fijo_1;         || las que fueran en alta, en alta
                    jornadasIT = nLimiteJor - fijo_1; || el resto hasta el limite en IT
               |FINSI;
          |FINSI;

          base_6 = fijo_1 * #18catego;   || base cotiz. CONT.COM.
          base_7 = (fijo_1 + jornadasIT) * #18catego;   || base cotiz. CONT.PROF.

          || maximo para grupo de cotizacion 1 por jornadas

          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    nume1 = acum_10 + dvalo_pro;   || ctos. 100 + prorr.
                    base_6 = nume1;
                    base_7 = nume1 + coba_1 + cobb_2 + coba_3;
                    nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
                    |SI fijo_1 [ 23;
                         nMinimo = #18#35;
                         nMinimo = nMinimo * fijo_1;
                         nMaximo = #18#1;
                         nMaximo = nMaximo * fijo_1;
                    |SINO;
                         || superior a 23 jornadas
                         nMinimo = #18#36;
                         nMaximo = #18#24;
                    |FINSI;
                    |SI base_6 < nMinimo;
                         base_6 = nMinimo;
                    |FINSI;
                    |SI base_6 > nMaximo;
                         base_6 = nMaximo;
                    |FINSI;
                    |SI base_7 < nMinimo;
                         base_7 = nMinimo;
                    |FINSI;
                    |SI base_7 > nMaximo;
                         base_7 = nMaximo;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || PARA HALLAR LA PARTE A CARGO DE LA SEG. SOCIAL
     || POR LA QUE NO HAY QUE COTIZAR POR CONT. PROF.
     |SI swBaseFija = 1;
          || base fija
          nDiasPagoSS = (denfe_B + denfe_C + dacci_2 - swAjuste3);    || pago SS ;
          nDiasPagoSS = nDiasPagoSS + dmate_2;
          |SI nDiasPagoSS < 0; nDiasPagoSS = 0; |FINSI;

          |SI nElAny ] 2011; |Y #2#33 = 01;
               nBasePagoSS = nDiasPagoSS * prom_enf;
          |SINO;
               nBasePagoSS = nDiasPagoSS * (#18catego / 30);
          |FINSI;
     |SINO;
          || jornadas
          nume1 = (denfe_B + denfe_C + dacci_2);    || pago SS
          nume1 = nume1 + dmate_2;
          || migue
          || nume1 = nume1 - swAjuste3;
          |SI nume1 < 0; nume1 = 0; |FINSI;
          nDiasPagoSS = nume1;
          |DEBUG;
          nume2 = denfe_D + denfe_A;         || pago empresario
          nume1 = jornadasIT * nume1 / (nume1 + nume2);   || parte de las jornadas en IT que
          nume1 = nume1 ! 0;                 || paga la Seg. Social
          nJornPagoSS = nume1;
          |SI nElAny ] 2011; |Y #2#33 = 01;
               nBasePagoSS = nJornPagoSS * #18catego;   || base cotiz. CONT.PROF.
          |SINO;
               nBasePagoSS = nJornPagoSS * prom_enf;   || base cotiz. CONT.PROF.
          |FINSI;
     |FINSI;

     base_5 = coba_1 + cobb_2 + coba_3;   || base IT

     nume2 = (denfe_2 + dacci_2 + dmate_2);
     |SI swBaseFija = 1; |Y nume2 ! guarda;
          || si esta todo el mes de baja no me debe quitar aqui el dia
          base_5 = base_5 - (swAjuste3 * (prom_enf + prom_ac2));
     |FINSI;

     nume1 = denfe_2 + dmate_2 + dacci_2;
     |SI nume1 = 0; |Y #2#33 = 01;
          || no tengo IT, pero se tiene que quedar grabada la base
          || del mes para el mes que viene, en los grupo 01 tambien claro
          || y no se estaba grabando por no estar cargando las variables
          || prom_enf ni prom_acc a no ser que hubiera algo del mes anterior
          || con IT

          nBase = base_6;
          |SI swBaseFija = 1;
               prom_enf = nBase / dcoti_0;
          |SINO;
               prom_enf = nBase / fijo_1;
          |FINSI;
          prom_enf = prom_enf ! 2;
          prom_acc = prom_enf;
     |FINSI;
|FPRC;

|PROCESO calboniFIJA;
     nRedFija = 0;
     |ABRE #labcentr;
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |CIERRA #labcentr;

     |SI #labcentr#24 = "S";  || trabajadores excluidos del censo agrario
          |ACABA;
     |FINSI;
     |SI #labtraba#33 = 1;  || trabajadores con grupo de tarifa 1
          |ACABA;
     |FINSI;

     |SI #0#9 [ 2009;
          nRedFijaCC = 18.90;     || reduccion fija cot. General, 21 euros
          nRedFijaATEP = 2.10;    || reduccion fija cot. General, 21 euros
          nRedJorCC = 0.63;    || reduccion fija cot. Jornadas, 0.70 euros
          nRedJorATEP = 0.07;  || reduccion fija cot. Jornadas, 0.70 euros
     |FINSI;
     |SI #0#9 = 2010;
          nRedFijaCC = 1.16;     || reduccion fija cot. General, 38.70 euros
          nRedFijaATEP = 0.13;   || reduccion fija cot. General, 38.70 euros
          nRedJorCC = 1.50;    || reduccion fija cot. Jornadas, 1.68 euros
          nRedJorATEP = 0.18;  || reduccion fija cot. Jornadas, 1.68 euros
     |FINSI;
     |SI #0#9 ] 2011;
          nRedFijaCC = 50.72;     || reduccion fija cot. General, 56.35 euros
          nRedFijaATEP = 5.63;    || reduccion fija cot. General, 56.35 euros
          nRedJorCC = 2.20;    || reduccion fija cot. Jornadas, 2.45 euros
          nRedJorATEP = 0.25;  || reduccion fija cot. Jornadas, 2.45 euros
     |FINSI;
     |SI #0#9 ] 2012;
          nRedFijaCC = 0;
          nRedFijaATEP = 0;
          nRedJorCC = 0;
          nRedJorATEP = 0;
     |FINSI;
     |SI swBaseFija = 1;
          nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;

          |SI #0#9 [ 2009; |O #0#9 ] 2011;
               nRedFija = (nRedFijaCC * (dcoti_0 - nume2)) / 30;
               |SI #nomcontr#54 = "S";
                    nRedFija = nRedFija + (nRedFijaATEP * dcoti_0) / 30;
               |SINO;
                    nRedFija = nRedFija + (nRedFijaATEP * (dcoti_0 - nume2)) / 30;
               |FINSI;
          |SINO;
               || para el 2010
               nRedFija = nRedFijaCC * (dcoti_0 - nume2);
               |SI #nomcontr#54 = "S";
                    nRedFija = nRedFija + (nRedFijaATEP * dcoti_0);
               |SINO;
                    nRedFija = nRedFija + (nRedFijaATEP * (dcoti_0 - nume2));
               |FINSI;
          |FINSI;
          nRedFija = nRedFija ! 2;
          |SI nRedFija = 3.90;
               nRedFija = 3.87;
          |FINSI;
          || si tengo activada la reduccion en ATEP en IT, en verdad resulta que si es
          || IT todo el mes NO SERIAN 30*0.13 sino 30*0.129 y en estos casos
          || devuelven el lote. Lo dejo asi a pelo que no me fio de cambiar
          || ahora estos valores ya que es el unico caso que da problemas.
          || 98.2357 - 24.11.2010
     |FINSI;

     |SI swJornadas = 1;
          |SI #0#9 [ 2009;
               |SI fijo_1 ] 24;
                    nRedFija = (nRedJorCC + nRedJorATEP) * 30;
               |SINO;
                    |SI #labtraba#187 = "S";
                         nRedFija = nRedJorCC * fijo_1;
                         nRedFija = nRedFija + (nRedJorATEP * fijo_1);
                         |SI #nomcontr#54 = "S";
                              nRedFija = nRedFija + (nRedJorATEP * jornadasIT);
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI fijo_1 ] 23;
                    |SI #0#9 = 2010;
                         nRedFija = (nRedFijaCC + nRedFijaATEP) * 30;
                    |FINSI;
                    |SI #0#9 ] 2011;
                         nRedFija = (nRedFijaCC + nRedFijaATEP);
                    |FINSI;
               |SINO;
                    |SI #labtraba#187 = "S";
                         nRedFija = nRedJorCC * fijo_1;
                         nRedFija = nRedFija + (nRedJorATEP * fijo_1);
                         |SI #nomcontr#54 = "S";
                              nRedFija = nRedFija + (nRedJorATEP * jornadasIT);
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO nombotra;
     nBonif = #nombotra#2;
     |ERROR10;
|FPRC;

|DEFBUCLE nombotra;
     #nombotra#1;
     ;
     #labtraba#0, #labtraba#1, 001;
     #labtraba#0, #labtraba#1, 999;
     ;
     NULL, nombotra;
|FIN;

|PROCESO calboniJOR;
     nBonifJOR = 0;

     |SI #labtraba#121 ! "S"; |Y #labtraba#121 ! "T";
          |ACABA;
     |FINSI;

     |ABRE #gombojli;
     #gombojli#0 = #labtraba#0;
     #gombojli#1 = #labtraba#1;
     |LEE 000#gombojli.=;
     |SI FSalida = 0;
          |ABRE #nombotra;
          |ABRE #nomboni3;

          nBonif = 0;
          |BUCLE nombotra;

          |SI nBonif ! 0;
               |DDEFECTO #nomboni3;
               #nomboni3#0 = #nombotra#2;
               |LEE 000#nomboni3.=;
          |FINSI;

          |CIERRA #nombotra;
          |CIERRA #nomboni3;

          |SI nBonif ! 0;
               |SI #nomboni3#4 = 1; |O #nomboni3#4 = 2;
                    |SI nDiasBon > 0;
                         |SI swBaseFija = 1;
                              nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
                              nBonifJOR = (dcoti_0 - nume2) * nBonFijaGen;
                         |SINO;
                              nBonifJOR = fijo_1 * nBonFijaJor;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nBonifJOR > 0;
          nBonifFCI = nBonifJOR;

          |ABRE #39;
          #39#0 = #2#0;   || empresa
          #39#1 = #2#1;   || trabajador
          alfa1 = #0#9;
          nume1 = alfa1;
          nume1 = nume1 - 2000;
          #39#66= nume1;  || a¤o
          #39#3 = 0;      || tipo
          nume3 = 0;
          |PARA nume2 = 1; |SI nume2 [ 12; |HACIENDO nume2 = nume2 + 1;
               #39#2 = nume2;  || mes
               |LEE 000#39=;
               |SI FSalida = 0;
                    nume3 = nume3 + #39#138;
               |FINSI;
          |SIGUE;

          alfa1 = #labtraba#0; alfa1 = "00000" + alfa1; alfa1 = alfa1 % -105;
          alfa2 = #labtraba#1; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;

          nume4 = nume3 + nBonifFCI;
          |SI nume3 < 800; |Y nume4 ] 800;    || maximo de 800 euros
               nBonifFCI = 800 - nume3;
               alfa3 = "    ATENCION: El trabajador " + alfa1 + "." + alfa2;
               alfa3 = alfa3 + " supera el máximo de 800 euros anuales de bonificación."
               |MENAV alfa3;
               alfa3 = "    Se aplicará la bonificación hasta el tope.";
               |MENAV alfa3;
          |FINSI;
          |SI nume3 > 800;
               nBonifFCI = 0;
               alfa3 = "    ATENCION: El trabajador " + alfa1 + "." + alfa2;
               alfa3 = alfa3 + " supera el máximo de 800 euros anuales de bonificación."
               |MENAV alfa3;
               alfa3 = "    No se aplicará la bonificación.";
               |MENAV alfa3;
          |FINSI;
          |CIERRA #39;

     |FINSI;

     |CIERRA #gombojli;
|FPRC;

|PROCESO CompCambioImp;
     alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     fFechaCal = fFecha;

     #nomboni3#0 = #nombotra#2;
     |LEE 000#nomboni3.=;
     |SI FSalida = 0;
          |SI swAgosto2012 = 1;
               |SI #nomboni3#5 = #nomboni3#6; |Y #nomboni3#6 > #nomboni3#7;
                    nNume1 = #nomboni3#7 + (#nomboni3#7 % 5);
                    nDiferencia = #nomboni3#5 - nNume1;
                    |SI -1 [ nDiferencia; |Y nDiferencia [ 1;
                         #nomboni3#5 = #nomboni3#7;
                         #nomboni3#6 = #nomboni3#7;
                         nBonifFCI = #nomboni3#7;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #nomboni3#5 ! #nomboni3#6; |O #nomboni3#6 ! #nomboni3#7;
               fIniBon = #nombotra#4;
               aIniBon = fIniBon;
               alfa1 = aIniBon % -104;
               nume1 = alfa1;
               nume1 = nume1 + 1;
               alfa1 = nume1;
               alfa1 = (aIniBon % 106) + alfa1;
               fAny1Bon = alfa1;

               alfa1 = aIniBon % -104;
               nume1 = alfa1;
               nume1 = nume1 + 2;
               alfa1 = nume1;
               alfa1 = (aIniBon % 106) + alfa1;
               fAny2Bon = alfa1;

               nBonifFCI_T1 = 0;
               swCambioBon = 1;    || por defecto estyo en el 1er a¤o
               nDiasBon_1 = 0;

               |SI fFechaCal < fAny1Bon;
                    swCambioBon = 1;    || se confirma: estoy en el 1er a¤o
                    #nombotra#6 = #nomboni3#2;
                    #nombotra#7 = #nomboni3#5;
                    nBonifFCI = #nomboni3#5;
                    |GRABA 020#nombotra.a;
               |FINSI;

              |SI fFechaCal ] fAny1Bon; |Y fFechaCal < fAny2Bon;
                    swCambioBon = 2;    || estoy en "a partir del 2do a¤o"
                    alfa1 = fAny1Bon;
                    alfa2 = alfa1 % 402;
                    alfa3 = alfa1 % -104;
                    nume2 = alfa2;
                    nume3 = alfa3;
                    |SI nElMes = nume2; |Y nElAny = nume3;
                         || estoy en el mes de cambio del 1ro al 2do a¤o
                         |SI #nomboni3#5 = #nomboni3#6;     || no proporciones nada
                              |ACABA;             || si el importe de un a¤o
                         |FINSI;                  || y el otro es el mismo
                         swCambioBon = 12;
                         alfa1 = alfa1 % 102;
                         nDiasBon_1 = alfa1; || a partir de este dia con la cantidad 2
                         nBonifFCI_T1 = #nomboni3#5;
                         nBonifFCI_T2 = #nomboni3#6;
                    |SINO;
                         swCambioBon = 2;
                         nBonifFCI = #nomboni3#6;
                         #nombotra#6 = nBonifFCI * 12;
                         #nombotra#7 = nBonifFCI;
                         |GRABA 020#nombotra.a;
                    |FINSI;
               |FINSI;
               |SI fFechaCal ] fAny2Bon;
                    || estoy en "a partir del 2do a¤o"
                    swCambioBon = 3;
                    alfa1 = fAny2Bon;
                    alfa2 = alfa1 % 402;
                    alfa3 = alfa1 % -104;
                    nume2 = alfa2;
                    nume3 = alfa3;
                    |SI nElMes = nume2; |Y nElAny = nume3;
                         || estoy en el mes de cambio del 2do al 3er a¤o
                         |SI #nomboni3#6 = #nomboni3#7;     || no proporciones nada
                              |ACABA;             || si el importe de un a¤o
                         |FINSI;                  || y el otro es el mismo
                         swCambioBon = 23;
                         alfa1 = alfa1 % 102;
                         nDiasBon_1 = alfa1; || a partir de este dia con la cantidad 2
                         nBonifFCI_T1 = #nomboni3#6;
                         nBonifFCI_T2 = #nomboni3#7;
                    |SINO;
                         swCambioBon = 3;
                         nBonifFCI = #nomboni3#7;
                         #nombotra#6 = nBonifFCI * 12;
                         #nombotra#7 = nBonifFCI;
                         |GRABA 020#nombotra.a;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PFETP;
     || aAlfa1 = #labtraba#36;
     aAlfa1 = #nombotra#4;
     aAlfa2 = "08.03.2009";
     fFecha1 = aAlfa1;
     fFecha2 = aAlfa2;
     |SI fFecha1 < fFecha2;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |SI #labtraba#234 > 0; |Y #labtraba#234 < 10;
                    nBonifFCI = nBonifFCI * 0.25;
                    || nBonifFCI_1 = nBonifFCI_1 * 0.25;
                    || nBonifFCI_2 = nBonifFCI_2 * 0.25;
               |FINSI;
               |SI #labtraba#234 ] 10; |Y #labtraba#234 < 20;
                    nBonifFCI = nBonifFCI * 0.50;
                    || nBonifFCI_1 = nBonifFCI_1 * 0.50;
                    || nBonifFCI_2 = nBonifFCI_2 * 0.50;
               |FINSI;
               |SI #labtraba#234 ] 20; |Y #labtraba#234 < 30;
                    nBonifFCI = nBonifFCI * 0.75;
                    || nBonifFCI_1 = nBonifFCI_1 * 0.75;
                    || nBonifFCI_2 = nBonifFCI_2 * 0.75;
               |FINSI;
               |SI #labtraba#234 ] 30;
                    nBonifFCI = nBonifFCI * 1;
                    || nBonifFCI_1 = nBonifFCI_1 * 1;
                    || nBonifFCI_2 = nBonifFCI_2 * 1;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               || nNume = tp + 0.3;
               nNume = ((#2#234 / 40) ! 2) + 0.3;
               |SI nNume > 1;
                    nNume = 1;
               |FINSI;
               nBonifFCI = nBonifFCI * nNume;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Bonif135;
     aSexo = #labtraba#252;
     |SI #labtraba#42 = "A";                 || mensuales
          nNume = nBaseAlta / nDiasAlta;
          |SI nNume < 60;
               || adelante
          |SINO;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #labtraba#42 = "E";                 || jornadas
          |SI fijo_1 ] 22;                   || 22 jornadas o mas
               |SI nBaseAlta < 1800;
                    || adelante
               |SINO;
                    |ACABA;
               |FINSI;
          |SINO;                             || menos de 22 jornadas
               nNume = nBaseAlta / fijo_1;
               |SI #labtraba#33 = 01;
                    nNume1 = 81;
               |SINO;
                    nNume1 = 81.82;
               |FINSI;
               |SI nNume < nNume1;
                    || adelante
               |SINO;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #labtraba#33 = 01;
          |SI #labtraba#42 = "A";
               |SI #labtraba#252 = "V";
                    |SI nDiasAlta = 30;
                         nBonifFCI = 40;
                    |SINO;
                         nBonifFCI = ((40 / 30) ! 2) * nDiasAlta;
                    |FINSI;
               |SINO;
                    |SI nDiasAlta = 30;
                         nBonifFCI = 53.33;
                    |SINO;
                         nBonifFCI = ((53.33 / 30) ! 2) * nDiasAlta;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #labtraba#252 = "V";
                    nBonifFCI = fijo_1 * 2;
               |SINO;
                    nBonifFCI = fijo_1 * 2.66;
               |FINSI;
          |FINSI;
     |SINO;
          nNume = nCuotaCC_Alta - nImporteRedCC_Alta;
          |SI #labtraba#42 = "A";
               |SI #labtraba#252 = "V";
                    |SI nDiasAlta = 30;
                          nNume1 = 88.15;
                    |SINO;
                          nNume1 = ((88.15 / 30) ! 2) * nDiasAlta;
                    |FINSI;
                    |SI nNume > nNume1;
                         nBonifFCI = nNume - nNume1;
                    |FINSI;
               |SINO;
                    |SI nDiasAlta = 30;
                         nNume1 = 58.77;
                    |SINO;
                         nNume1 = ((58.77 / 30) ! 2) * nDiasAlta;
                    |FINSI;
                    |SI nNume > nNume1;
                         nBonifFCI = nNume - nNume1;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #labtraba#252 = "V";
                    nNume1 = 4.01 * fijo_1;
                    |SI nNume > nNume1;
                         nBonifFCI = nNume - nNume1;
                    |FINSI;
               |SINO;
                    nNume1 = 2.68 * fijo_1;
                    |SI nNume > nNume1;
                         nBonifFCI = nNume - nNume1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboniFCI;
     nBonifFCI = 0;

     |SI #labtraba#121 ! "S"; |Y #labtraba#121 ! "T";
          |ACABA;
     |FINSI;

     |ABRE #nombotra;
     |ABRE #nomboni3;

     nBonif = 0;
     |BUCLE nombotra;

     |SI nBonif ! 0;
          |DDEFECTO #nomboni3;
          #nomboni3#0 = #nombotra#2;
          |LEE 000#nomboni3.=;

          #nombotra#0 = #labtraba#0;
          #nombotra#1 = #labtraba#1;
          #nombotra#2 = nBonif;
          |LEE 000#nombotra.=;

          |SI swAgosto2012 = 1;
               |SI #nomboni3#11 = "N";
                     nBonif = 0;
                     |CIERRA #nomboni3;
                     |CIERRA #nombotra;
                     |ACABA;
                |FINSI;
          |FINSI;

          || dia_2 son los dias naturales en alta del mes
          || topemes los dias que tiene el mes, como siempre
          fFechaIniBon = #nombotra#4;
          fFechaFinBon = #nombotra#5;

          || comprobaciones
          alfa1 = "01";
          alfa2 = #0#8; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
          alfa3 = #0#9;
          aFecha = alfa1 + "." + alfa2 + "." + alfa3;
          fFecha = aFecha;
          |SI fFechaIniBon [ fFecha;
               fFechaIniBon = fFecha;
          |SINO;
               nMes = alfa2;
               nAny = alfa3;
               |SI nMes = #0#8; |Y nAny = #0#9;
                    fFechaIniBon = fFechaIniBon;
               |FINSI;
          |FINSI;

          anynum = nAny;
          mesnum = nMes;
          |HAZ ulti_dia;

          alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
          alfa2 = #0#8; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
          alfa3 = #0#9;
          aFecha = alfa1 + "." + alfa2 + "." + alfa3;
          fFecha = aFecha;
          |SI fFechaFinBon ] fFecha;
               fFechaFinBon = fFecha;
          |SINO;
               nMes = alfa2;
               nAny = alfa3;
               |SI nMes = #0#8; |Y nAny = #0#9;
                    fFechaFinBon = fFechaFinBon;
               |FINSI;
          |FINSI;

          aAlfa = #labtraba#37;
          |SI aAlfa ! "          "; |Y aAlfa ! "..........";
               fFecha = aAlfa;
               |SI fFecha [ fFechaFinBon;
                    fFechaFinBon = fFecha;
               |FINSI;
          |FINSI;

          nume1 = fFechaIniBon;
          nume2 = fFechaFinBon;
          nDiasBon = nume2 - nume1 + 1;

          |SI nDiasBon [ 0;        || si por lo que sea me llegan negativos, cero
               nDiasBon = 0;
          |FINSI;
          |SI nDiasBon ] 30;       || si estoy en un mes de 31 dias y bonificado
               nDiasBon = 30;      || todo el mes, 30 ya que luego divido siempre
          |FINSI;                  || por 30
          |SI nDiasBon ] 28; |Y #0#8 = 2;
               nDiasBon = 30;      || si estoy en febrero y bonificado todo el mes,
          |FINSI;                  || 30 porque divido por 30
          || asigno valor
          |SI #nombotra#2 = 133; |O #nombotra#2 = 134;
               |SI #nombotra#2 = 133;
                    nBonifFCI = nDiasBon * #nomboni3#8;
               |FINSI;
               |SI #nombotra#2 = 134;
                    nBonifFCI = fijo_1 * #nomboni3#8;
               |FINSI;
          |SINO;
               nBonifFCI = #nombotra#7;
          |FINSI;

          || compruebo importe para las del textil que cambian importes segun
          || el tiempo que lleven de alta

          nBonifFCI_T1 = 0;
          nBonifFCI_T2 = 0;
          swCambioBon = 0;    || por defecto estyo en el 1er a¤o

          |SI nDiasBon ! 0;
               |HAZ CompCambioImp;
               |HAZ PFETP;         || recorto si hay tiempo parcial
          |FINSI;

          |SI #nombotra#2 ! 133; |Y #nombotra#2 ! 134;
               |SI #2#42 = "E";
                    /*
                    || asi era como teniamos que se calculaban "de siempre"
                    || pero segun SILTRA hay que calcularlas dividiendo entre
                    || 30 y multiplicando por las jornadas, lo cual no tiene
                    || mucho sentido. Lo hemos enviado como consulta al RED
                    || y nos han dicho que "lo miraran". Lo dejo como lo cal-
                    || culan ellos, para que no haya descuadre, aunque no tenga
                    || sentido. 001594.01416

                    |SI fijo_1 < 24;
                         nDiasBon = fijo_1 * 1.25;
                         nBonifFCI = ((nBonifFCI / 30) ! 2) * nDiasBon;
                    |FINSI;
                    */
                    |SI fijo_1 < 30;
                         nBonifFCI = ((nBonifFCI / 30) ! 2) * (fijo_1 + jornadasIT);
                    |FINSI;
               |SINO;
                    |SI nDiasBon < 30;  || si no estoy mes completo
                         nBonifFCI = ((nBonifFCI / 30) ! 2) * nDiasBon;
                    |FINSI;
               |FINSI;
               |SI #nombotra#2 = 135;
                    |HAZ Bonif135;
               |FINSI;
          |SINO;
               |SI nBonifFCI > 125;     || limite de bonif. fom. empleo
                    nBonifFCI = 125;    || para la 133 y 134 en Agrarios
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomboni3;
     |CIERRA #nombotra;
|FPRC;

|PROCESO liquidados_c1;
     || necesario para que en meses de 31 dias en mensuales me bonifique
     || la base de 30 dias - 002752.00517. En meses de 28 dias tambien

     |SI nNume > dia_4;
          nNume = dia_4;
     |FINSI;
     |SI nNume = dia_2; |Y nNume < dia_4;
          |SI #2#42 ! "C";
               nNume = dia_4;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboni1;       || CALCULA BASES BONIFICACION
|DEBUG;
     bon_0 = 0;           || base CC bonificacion (1)
     bon_3 = 0;           || base CP bonificacion (1)
     bon_5 = 0;           || base ILT bonificacion (1)
     bon_1 = por1_cont;   || (%) cont. comunes
     bon_2 = por1_dfpg;   || (%) D+F+P
     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0;
          lin_1 = #16#6 % nPorBon1;
          lin_2 = #16#7 % nPorBon1;
          bon_0 = base_6 + nDesem;
          bon_3 = base_7 + nDesem;
          bon_5 = base_5;
          bon_1 = por1_cont - lin_1;
          bon_2 = por1_dfpg - lin_2;
          |SI #16#9 = "S";
               bon_1 = bon_1 - #15#5;
          |FINSI;
          |SI dboni_1 ! dcoti_0;    || dias bonificacion distintos a dias cotizacion
               nume1 = dboni_1 / (dboni_1 + dboni_2);
               bon_0 = bon_0 * nume1;
               bon_3 = bon_3 * nume1;
               bon_5 = bon_5 * nume1;
          |FINSI;
     |FINSI;
     dto_con = 0;                   || dto. CON.COM.  AGRARIA*

     || 2009
     |SI swBaseFija = 1;
          |SI #2#33 = 12;
               catego = 11 + 23;
          |SINO;
               catego = #2#33 + 23;
          |FINSI;
          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    catego = 36;
               |FINSI;
          |FINSI;

          nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
          |SI dcoti_0 ! 30;   || no estoy de alta el mes completo
               nume1 = (dcoti_0 - nume2); || dias trabajados
          |SINO;
               |SI dilt > 0;  || estoy de alta el mes completo pero tengo IT
                    nume1 = (dcoti_0 - nume2); || dias trabajados
               |SINO;         || mes completo sin IT
                    nume1 = 30;
               |FINSI;
          |FINSI;

          |SI #2#33 = 01; |Y nElAny ] 2011
               || en verdad para todo el mundo deberia ser asi, pero en principio
               || como los unicos que van por maximos y minimos son los del
               || grupo 01 lo dejo asi por no arriesgarme

               dto_con = ((base_6 * nume1) / 30) ! 2; || base comunes extranjeros event.
          |SINO;
               dto_con = ((#18catego * nume1) / 30) ! 2; || base comunes extranjeros event.
          |FINSI;
          dto_con = (dto_con % #15#7) ! 2;          || cuota

          |SI #2#33 = 01; |Y nElAny ] 2011
               || lo mismo que antes

               dto_dfp = ((base_7 * (dcoti_0 - nDiasPagoSS)) / 30) ! 2; || base
          |SINO;
               dto_dfp = ((#18catego * (dcoti_0 - nDiasPagoSS)) / 30) ! 2; || base
          |FINSI;
          dto_dfp = (dto_dfp % #15#13) ! 2;          || cuota
     |FINSI;

     |SI swJornadas = 1;
          |SI #2#33 = 12;
               catego = 11;
          |SINO;
               catego = #2#33;
          |FINSI;
          |SI nElAny ] 2011
               |SI #2#33 = 01;
                    catego = 35;
               |FINSI;
          |FINSI;

          nume1 = fijo_1;

          |SI #2#33 = 01; |Y nElAny ] 2011
               || lo mismo que antes para los que no son por jornadas
               dto_con = base_6; || base comunes extranjeros event.
          |SINO;
               dto_con = (#18catego * nume1); || base comunes extranjeros event.
          |FINSI;
          dto_con = (dto_con % #15#7) ! 2;          || cuota

          |SI #2#33 = 01; |Y nElAny ] 2011
               || ojo ahora con la forma de calcular cuando hay IT las jornadas
               || en que las prestaciones van a cargo de la seguridad social
               dto_dfp = ((base_6 * (fijo_1 + jornadasIT - nJornPagoSS)) / (fijo_1 + jornadasIT)) ! 2;
          |SINO;
               dto_dfp = ((#18catego * (fijo_1 + jornadasIT - nJornPagoSS))) ! 2; || base comunes extranjeros event.
          |FINSI;
          dto_dfp = (dto_dfp % #15#13) ! 2;          || cuota
     |FINSI;

     |SI #2#42 ! "A"; |Y #2#42 ! "E";
          || se supone que extranjeros clave "e"
          dto_dfp = 0;
     |FINSI;

     dto_ho1 = dacum_30 % por1_hor1; dto_ho1 = dto_ho1 ! EURODB; || dto. horas 1
     dto_ho2 = dacum_31 % por1_hor2; dto_ho2 = dto_ho2 ! EURODB; || dto. horas 2

     |SI #16#10 = 4;           || RDL 16/2001 2.2.1
          bon_1 = por1_cont - #16#6;
     |FINSI;
|FPRC;

|PROCESO calboni11;      || CALCULA BASES BONIFICACION
    zbon_0 = 0;          || base CC bonificacion (2)
    zbon_3 = 0;          || base CP bonificacion (2)
    zbon_5 = 0;          || base ILT bonificacion (2)
    bon_1 = por1_cont;  || (%) cont. comunes
    bon_2 = por1_dfpg;  || (%) D+F+P
|SI #2#39 ! 0; |Y dboni_2 ! 0; |Y nPorBon2 ! 0;
        lin_1 = #16#6 % nPorBon2;
        lin_2 = #16#7 % nPorBon2;
        zbon_0 = base_6;
        zbon_3 = base_7;
        zbon_5 = base_5;
        bon_1 = por1_cont - lin_1;
        bon_2 = por1_dfpg - lin_2;
    |SI #16#9 = "S";
            bon_1 = bon_1 - #15#5;
    |FINSI;
    |SI dboni_2 ! dcoti_0;    || dias bonificacion distintos a dias cotizacion
            nume1 = dboni_2 / (dboni_1 + dboni_2);
            zbon_0 = zbon_0 * nume1;
            zbon_3 = zbon_3 * nume1;
            zbon_5 = zbon_5 * nume1;
    |FINSI;
        nume1 = bon_0 + zbon_0;
    |SI nume1 ! base_6;  zbon_0 = zbon_0 - (nume1 - base_6);     |FINSI;
        nume1 = bon_3 + zbon_3;
    |SI nume1 ! base_7;  zbon_3 = zbon_3 - (nume1 - base_7);     |FINSI;
|FINSI;
|FPRC;

|PROCESO calboni3;
    dto_tot = dto_con + dto_dfp + dto_ho1 + dto_ho2;
    dto_tot = dto_tot + reten_1;  || total dtos. (excluidos anticipos/especie)
    liquido = bruto_rec - dto_tot;   || liquido bueno
    liq_aju = bruto_aju - dto_tot;   || liquido ajustes
||SI liq_aju < 0;  liq_aju = 0;  |FINSI;     || provocaba bucle infinito
                                             ||/con importe a ajustar negativo
|FPRC;

|PROCESO por_bon_16;
     alfa1 = #2#11 % -104;        || anyo nacimiento
     alfa2 = #2#11 % -602;        || mes nacimiento
     alfa5 = #2#11 % 102;         || dia nacimiento
     alfa3 = aFechaRef % -104;        || anyo Fecha Referencia
     alfa4 = aFechaRef % -602;        || mes Fecha Referencia
     alfa6 = aFechaRef % 102;         || dia Fecha Referencia
     nume1 = alfa1;
     nume1 = alfa1 + nEdadParaBon;           || a¤o que cumple 59 o 60 a¤os
     alfa1 = nume1;
     nume3 = alfa3;                || a¤o que cumple 4 o 5 a¤os antiguedad
     nume3 = alfa3 + nAnysParaAnt;
     alfa3 = nume3;
     nume2 = alfa2;                || mes edad
     nume4 = alfa4;                || mes antiguedad
     nume5 = alfa5;                || dia edad
     nume6 = alfa6;                || dia antiguedad

     nAnyoBase = #nomcontr#38;
     |SI nAnyoBase = 0;
          nAnyoBase = 2003;
     |FINSI;
     |SI nEdadParaBon = 59;
         nAnyoBase = nAnyoBase - 1;
     |FINSI;
     aAnyoBase = nAnyoBase;

     |SI nume1 > nume3;            || cuando cumple 60 (o 59) a¤os
          |SI nume1 < nAnyoBase;
               fecha_bon_16 = "01.01." + aAnyoBase;
          |SINO;
               fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
          |FINSI;
     |FINSI;
     |SI nume1 < nume3;            || cuando cumple antiguedad
          |SI nume3 < nAnyoBase;
               fecha_bon_16 = "01.01." + aAnyoBase;
          |SINO;
               fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
          |FINSI;
     |FINSI;
     |SI nume1 = nume3;            || mismo a¤o: comprobamos meses
          |SI nume2 > nume4;            || cuando cumple 60 (o 59) a¤os
               |SI nume1 < nAnyoBase;
                    fecha_bon_16 = "01.01." + aAnyoBase;
               |SINO;
                    fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
               |FINSI;
          |FINSI;
          |SI nume2 < nume4;            || cuando cumple antiguedad
               |SI nume3 < nAnyoBase;
                    fecha_bon_16 = "01.01." + nAnyoBase;
               |SINO;
                    fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
               |FINSI;
          |FINSI;
          |SI nume2 = nume4;       || antiguedad y 60 (o 59) a¤os en = a¤o, =mes
               |SI nume5 > nume6;            || cuando cumple 60 (o 59) a¤os
                    |SI nume1 < nAnyoBase;
                         fecha_bon_16 = "01.01." + aAnyoBase;
                    |SINO;
                         fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
                    |FINSI;
               |FINSI;
               |SI nume5 < nume6;            || cuando cumple antiguedad
                    |SI nume3 < nAnyoBase;
                         fecha_bon_16 = "01.01." + aAnyoBase;
                    |SINO;
                         fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
                    |FINSI;
               |FINSI;
               |SI nume5 = nume6;
                    |SI nume3 [ nAnyoBase;
                         fecha_bon_16 = alfa6 + "." + alfa4 + "." + aAnyoBase;
                    |SINO;
                         fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     alfa7 = fecha_bon_16 % 402;
     nume7 = alfa7;                || mes en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % -104;
     nume8 = alfa7;                || anyo en que empieza a ser efectiva la bonif.
     nMesesBon16 = #0#8 - nume7;
     nAnyosBon16 = #0#9 - nume8;
     |SI nAnyosBon16 > 0;
          |SI nMesesBon16 < 0;
               nMesesBon16 = 12 + nMesesBon16;
               nAnyosBon16 = nAnyosBon16 - 1;
          |FINSI;
     |FINSI;

     |SI nAnyosBon16 ] 0;
          |SI nEdadParaBon = 59;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 40 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nEdadParaBon = 60;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 50 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI dalta_3 ! 1; |O dbaja_3 ! guarda;        || para sacar los dias reales en alta
          nume10 = dcoti_0;   || dias reales alta, dias alta: dias naturales
     |SINO;
          nume10 = dia_2;     || dias del mes reales
     |FINSI;

     |SI #0#8 = nume7; |Y #0#9 ] nume8;      || si estoy calculando el mes q entra
          alfa7 = fecha_bon_16 % 102;        || en vigor la bonif. calcula el % correspondiente
          nume7 = alfa7;                     || segun la fecha inicio de bonif.
          nume7 = nume10 - nume7 + 1;        || "guarda" se trae los dias del mes
          |SI nume7 < 0; nume7 = nume10; |FINSI;
          |SI #0#9 > nume8;                  || si llevo ya mas de un a¤o de bonif
               nume9 = #0#9 - nume8;         || este mes cambia el porcentaje a
               |SI nume9 [ 6;                || bonificar, hay que proporcionar
                    |SI dalta_3 ! 1; |Y dbaja_3 = guarda;
                         nume7 = nume10;
                    |FINSI;
                    por_bon_16A = nume10 - nume7;      || cada parte segun lo que
                    nPB16CalcA = nPB16Calc - 10;       || toque
               |SINO;
                    nume7 = nume10;
               |FINSI;
          |FINSI;
     |SINO;
          nume7 = nume10;                    || si es un mes posterior calcula el
     |FINSI;                                 || 100% ya que entra entera.

     por_bon_16 = (nume7 / nume10) * 100;
     |SI por_bon_16A > 0;
          por_bon_16A = 100 - por_bon_16;
     |FINSI;
|FPRC;

|PROCESO MensajesBon60;
     |SI nPB16Calc ! #2#211;
          |SI nPB16Calc > #2#211;
               alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
               alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;
               |SI #2#211 = 0;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa1 = alfa1 + " cumple requisitos de bonificacion ";
                    alfa1 = alfa1 + " para mayores de " + aEPBon + " años.";
                    |MENAV alfa1;
                    alfa1 = "     Desea comenzar a aplicar la bonificacion?";
                    |CONFI alfa1;
                    |SI FSalida ! 0;
                         nPB16Calc = 0
                         #2#211 = 0;
                    |FINSI;
               |SINO;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa2 = #2#211;         || lo que habia en labtraba
                    alfa3 = nPB16Calc;      || lo que he calculado
                    alfa1 = alfa1 + ". El porcentaje de bonif. para ";
                    alfa1 = alfa1 + "mayores de " + aEPBon + " años cambia del " + alfa2 + "% al ";
                    alfa1 = alfa1 + alfa3 + "%.";
                    |MENAV alfa1;
                    alfa1 = "    Se actualizara la ficha del trabajador.";
                    |MENAV alfa1;
                    #2#211 = nPB16Calc;
               |FINSI;
          |FINSI;
          |SI nPB16Calc < #2#211;
               alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
               alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;
               alfa4 = #2#211;
               |SI nPB16Calc = 0;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa1 = alfa1 + " NO cumple requisitos de bonificacion ";
                    alfa1 = alfa1 + " para mayores de " + aEPBon + " años.";
                    |MENAV alfa1;
                    alfa1 = "     Aun asi desea aplicar la bonificacion especificada en";
                    alfa1 = alfa1 + " la ficha del trabajador? (" + alfa4 + "%)";
                    |CONFI alfa1;
                    |SI FSalida = 0;
                         nPB16Calc = #2#211;
                         por_bon_16 = 100;
                    |SINO;
                         nPB16Calc = 0;
                         #2#211 = 0;
                    |FINSI;
               |SINO;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa2 = #2#211;         || lo que habia en labtraba
                    alfa3 = nPB16Calc;      || lo que he calculado
                    alfa1 = alfa1 + ". La bonificacion para ";
                    alfa1 = alfa1 + "mayores de " + aEPBon + " a¤os de su ficha (" + alfa2 + "%)";
                    alfa1 = alfa1 + " es incorrecta.";
                    |MENAV alfa1;
                    alfa1 = "     Deberia aplicarse un " + alfa3 + "%.";
                    alfa1 = alfa1 + " Desea comenzar a ";
                    alfa1 = alfa1 + "aplicar el % correcto?";
                    |CONFI alfa1;
                    |SI FSalida ! 0;
                         nPB16Calc = #2#211;
                    |SINO;
                         #2#211 = nPB16Calc;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboni60;      || BONIFICACION MAYORES 60 A¤OS RDL. 16/2001
     bon_59 = 0;
     bon_60 = 0;
     nBon60_2 = 0;
     nPB16Calc = 0;
     nPB16CalcA = 0;

     nume1 = #0#9;
     |SI nume1 < 2004;   || entro en vigor a partir de 2004
          |ACABA;
     |FINSI;

     |SI nElAny ] 2014;
          |ACABA;
     |FINSI;

     alfa1 = #labtraba#11 % -104;        || anyo nacimiento
     alfa2 = #labtraba#11 % -602;        || mes nacimiento

     nNume = alfa1;
     nEdad = nElAny - nNume;
     nNume = alfa2;
     |SI nElMes < nNume;
          nEdad = nEdad - 1;
     |FINSI;

     |SI nElAny = 2013;
          swSigue = 0;
                                        || en diciembre de 2012 la tuvo,
          |ABRE #nomhicca;              || con lo que se la debe poder
          #nomhicca#0 = #labtraba#0;    || seguir aplicando hasta que
          #nomhicca#1 = #labtraba#1;    || acabe
          #nomhicca#66 = 12;
          #nomhicca#2 = 12;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=;
          FEstado = FSalida;
          |SI FSalida = 0;
               |SI #nomhicca#148 ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || inicia el derecho a la reduccion en 2013, que es cuando
          || cumplira 59 a¤os. A partir de 2013, solo se aplica a quie-
          || nes se la vinieran aplicando por haber cumplido 59 en 2012,
          || quienes cumplan en 2013 los 59, nada de nada

          || no haria falta con la condicion anterior, partiendo de swSigue = 0
          || pertampoco esta de mas

          alfa1 = #labtraba#11 % -104;    || anyo nacimiento
          nNume = alfa1;
          nNume1 = 2012 - nNume;          || edad con que acabo 2012
          |SI nNume1 = 58;
               swSigue = 0;
          |FINSI;

          || esto es por si ya sabemos que acabo el a¤o 2012 con 59 a¤os
          || pero resulta que el swSigue me venia a cero por no tener en
          || 2012 la nomina de diciembre

          |SI nNume1 = 59;
               |SI FEstado ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     por_bon_60 = 14.57;      || porcentaje que se bonifica en agrarios

     |SI runnom = "nomcalir";      || no calcules bonificacion al regularizar
          |ACABA;
     |FINSI;

     |SI #2#212 = 9;
          |ACABA;
     |FINSI;

     |SI #labtraba#42 ! "A";
          nume1 = #labtraba#45;
          |SI nume1 ] 400
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #2#212 = 2;
          aFechaRef = #2#36;       || fecha de referencia: fecha de Alta
     |SINO;
          aFechaRef = #2#34;       || fecha de referencia: fecha de Antiguedad
     |FINSI;
     alfa1 = #2#11; |QBF alfa1;    || compruebo que exista fecha nacimiento
     alfa2 = aFechaRef; |QBF alfa2;    || compruebo que exista fecha de refer.
     |SI alfa1 = ""; |O alfa2 = ""; |O alfa1 = ".........."; |O alfa2 = "..........";
          |ACABA;
     |FINSI;

     nEdadParaBon = 0;

     |SI #2#212 = 0; #2#212 = 1;   |FINSI;
     |SI #2#212 = 1; |O #2#212 = 2;
          nume1 = #labtraba#45;
          |SI nume1 < 400;    || contrato indefinido
               nEdadParaBon = 59;  || a partir de los 59 a¤os
               nAnysParaAnt = 4;
          |SINO;
               nEdadParaBon = 60;  || a partir de los 60 a¤os
               nAnysParaAnt = 5;
          |FINSI;
     |FINSI;                  || a partir de los 55 a¤os

     aEPBon = nEdadParaBon;
     |QBF aEPBon;

     |HAZ por_bon_16;

     |SI nPB16Calc ] 50;
          aEPBon = "60";
     |FINSI;

     |SI swAgosto2012 = 1;
          |SI nPB16Calc = 40;
               |HAZ MensajesBon60;
          |SINO;
               || nada de nada
          |FINSI;
     |SINO;
          |HAZ MensajesBon60;
     |FINSI;

|| bon60 es lo que bonifico
|| base_6 es la base a bonificar
|| por_bon_60 es el porcentaje que dice la ley que se bonifica
|| nPB16Calc es el % que calculo segun el numero de a¤os que me corresponde
|| aplicar la bonif: 50% el primer a¤o y 10% mas cada a¤o a partir de ahi
|| por_bon_16 es la proporcion del mes a la que tengo que aplicar la bonif.

|| nBon60_2, nPB16CalcA y por_bon_16A es lo analogo para cuando hay dos perio-
|| dos, en el periodo anterior

     nRedCC = nImporteRedCC_Alta + nImporteRedCC_IT;

     |SI #0#9 ] 2012;
/*
          nBon60_2 = (base_6 % por_bon_60);
          nBon60_2 = nBon60_2 - nRedCC;
          nBon60_2 = nBon60_2 % nPB16CalcA;
*/
          por_bon_60 = (por2_cont - nReduccion);
          por_bon_60 = por_bon_60 - ((por_bon_60 % 6.20) ! 2);
          nBon60_2 = ((base_6 + nDesem) % por_bon_60);
          nBon60_2 = (nBon60_2 % nPB16CalcA) ! 2;
     |SINO;
          nBon60_2 = (base_6 % por_bon_60) % nPB16CalcA;
     |FINSI;
     nBon60_2 = (nBon60_2 % por_bon_16A) ! EURODB;

     |SI nPB16CalcA = 40;
          bon_59 = nBon60_2;
          nBon60_2 = 0;
     |FINSI;

     nRedCC = nImporteRedCC_Alta + nImporteRedCC_IT;

     |SI #0#9 ] 2012;
/*
          bon_60 = (base_6 % por_bon_60);
          bon_60 = bon_60 - nRedCC;
          bon_60 = bon_60 % nPB16Calc;
*/
          por_bon_60 = (por2_cont - nReduccion);
          por_bon_60 = por_bon_60 - ((por_bon_60 % 6.20) ! 2);
          bon_60 = ((base_6 + nDesem) % por_bon_60) ! 2;
          bon_60 = (bon_60 % nPB16Calc) ! 2;
     |SINO;
          bon_60 = (base_6 % por_bon_60) % nPB16Calc;
     |FINSI;
     bon_60 = (bon_60 % por_bon_16) ! EURODB;

     |SI nPB16Calc = 40;
          bon_59 = bon_60;
          bon_60 = 0;
     |FINSI;

     bon_60 = bon_60 + nBon60_2;
     #2#211 = nPB16Calc;

     |SI swAgosto2012 = 1;
          bon_60 = 0;
     |FINSI;

     |SI runnom = "gomcalcu"; || en finiquitos no regrabes porcentaje
          |SI swExtTem ! 0;
               #2#42 = "e";
          |FINSI;
          |GRABA 020#2a;
          |SI swExtTem ! 0;
               #2#42 = "E";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calajus3;   || AJUSTA A LIQUIDOS (no cotizar -407-)
     |SI #2#97 = 3;
          concepto = 407;
          |HAZ ajustes;
          |SI convenio = 0;
               stop = #2#98 * dcofi_999;   stop = stop ! EURODB;
               difere = stop - liq_aju;               || cantidad a ajustar
               |SI difere > 0;|O #2#61 = "S";
                    ajus_2 = (difere*100)/(100-#2#30); || cant.a aj. sin (%)ret.
                    ajus_2 = ajus_2 ! EURODB;
                    difere = (bruto_aju+ajus_2)-(dto_tot-reten_1);  || recalculo
                    difer1 = (acum_99+ajus_2)%#2#30;                || /del IRPF
                    difer1 = difer1 ! EURODB;
                    difere = difere - difer1;
                    ajus_2 = ajus_2 + (stop - difere); || reaj. por diferencia
                    ajus_2 = ajus_2 ! EURODB;
                                    acum_40  =acum_40  +ajus_2;
                    |SI #10#8 = 1;  acum_401 =acum_401 +ajus_2;  |FINSI;
                    |SI #10#8 = 2;  acum_402 =acum_402 +ajus_2;  |FINSI;
                    |SI #10#8 = 3;  acum_403 =acum_403 +ajus_2;  |FINSI;
                            bruto_aju=bruto_aju+ajus_2;
                    |HAZ calirpfr;
                    |HAZ calirpfp;
                    graba04 = concepto;
                    |HAZ cogegra;
                    graba09 = 1;
                    graba10 = ajus_2;
                    graba11 = 1;
                    swgracon = 1;  || para que regrabe los campos si existe
                    swcongra = 1;  || para que acumule si existe
                    |HAZ grabacon;

                    |SI difere < 0;
                         nIncid = 5;
                         |HAZ graba_inc;
                         nIncid = 6;
                         |SI #2#213 ] 101; aAlfa = #2#213; |SINO; aAlfa = #10#2; |FINSI;
                         aDesIncid = "  *** Concepto: " + aAlfa + ". CIF Empresa: " + #labempre#10 + "***";
                         |HAZ graba_inc;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calajus4;   || AJUSTA A LIQUIDOS (cotiza -120-)
|SI #2#97 = 4;
        difere = 0;
        concepto = 120;
    |HAZ ajustes;
    |SI convenio = 0;
            liq_aju = liq_aju ! EURODB;
            |HAZ ImporteAjuste;
        |PARA; |SI liq_aju ! stop; |HACIENDO;
                difer1 = stop - liq_aju;
            |SI difer1 > 0;|O #2#61 = "S";
                    difere = difere + difer1;   || acumula dif. en var.trab.
                                acum_10 =acum_10 +difer1;
                |SI #10#8 = 1;  acum_11 =acum_11 +difer1;  |FINSI;
                |SI #10#8 = 2;  acum_12 =acum_12 +difer1;  |FINSI;
                |SI #10#8 = 3;  acum_13 =acum_13 +difer1;  |FINSI;
                                bruto_aju =bruto_aju +difer1;
                |HAZ calirpfr; || recalcula base IRPF recibo
                |HAZ calirpfp; || recalcula retenciones IRPF recibo
                |SI #0#9 ] 2012;
                     |HAZ calcotiz12;
                     |HAZ calboni112;
                |SINO;
                     |HAZ calcotiz;
                     |HAZ calboni1;
                     |HAZ calboni11;|| bonificacion doble
                |FINSI;
                |HAZ calboni60;
                nEmp = #labtraba#0;
                nTra = #labtraba#1;
                nMes = #0#8;
                nAny = #0#9;
                nBonifFCI = 0;
                |HAZ calboniFCI; || bonif comento contratacion indefinida RDL 5/2006
                nBonifJOR = 0;
                |HAZ calboniJOR;
                |HAZ calboni3;
            |SINO;
                    stop = liq_aju;  || corta el bucle
            |FINSI;
            liq_aju = liq_aju ! EURODB;
        |SIGUE;
            graba04 = concepto;
        |HAZ cogegra;
            graba09 = 1;
            graba10 = difere;   || diferencia acumulada en el bucle
            graba11 = 1;
            swgracon = 1;   || para que regrabe si existe
            swcongra = 1;   || para que acumule si existe
        |HAZ grabacon;
               |SI difere < 0;
                    nIncid = 5;
                    |HAZ graba_inc;
                    nIncid = 6;
                    |SI #2#213 ] 101; aAlfa = #2#213; |SINO; aAlfa = #10#2; |FINSI;
                    aDesIncid = "  *** Concepto: " + aAlfa + ". CIF Empresa: " + #labempre#10 + "***";
                    |HAZ graba_inc;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calajus5;  || AJUSTA A BRUTOS Y LIQUIDOS (sin cotizar y sin IRPF -411-)
|SI #2#97 ] 5;
         concepto = 411;
    |HAZ ajustes;
    |SI convenio = 0;
            stop = #2#98 * dcofi_999;   stop = stop ! EURODB;
        |SI #2#97 = 5;
                 ajus_1 = stop - bruto_aju;
        |SINO;
                 ajus_1 = stop - liq_aju;
        |FINSI;
        |SI ajus_1 > 0;|O #2#61 = "S";
                graba04 = concepto;
            |HAZ cogegra;
                graba09 = 1;
                graba10 = ajus_1;
                graba11 = 1;
                swgracon = 1;  || para que regrabe si existe
                swcongra = 1;  || para que acumule si existe
            |HAZ grabacon;
                acum_41 = acum_41 + ajus_1;     || actualiza acumulado
                bruto_aju = bruto_aju + ajus_1;
                bruto_rec = bruto_rec + ajus_1; || actualiza bruto recibo
            |SI #2#97 = 6;
                    liquido = liquido + ajus_1; || actualiza liquido recibo
                    liq_aju = liq_aju + ajus_1;
            |FINSI;
               |SI ajus_1 < 0;
                    nIncid = 5;
                    |HAZ graba_inc;
                    nIncid = 6;
                    |SI #2#213 ] 101; aAlfa = #2#213; |SINO; aAlfa = #10#2; |FINSI;
                    aDesIncid = "  *** Concepto: " + aAlfa + ". CIF Empresa: " + #labempre#10 + "***";
                    |HAZ graba_inc;
              |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO avisoJorIT;
     nume1 = denfe_2 + dmate_2 + dacci_2;
     nume2 = jornadasIT - nJornadasERE;
     alfa1 = #labtraba#0;
     alfa1 = "00000" + alfa1;
     alfa1 = alfa1 % -105;
     alfa2 = #labtraba#1;
     alfa2 = "00000" + alfa2;
     alfa2 = alfa2 % -105;
     |SI nume1 > 0; |Y nume2 = 0; |Y swJornadas = 1;
          aAviso = "    ATENCION: Trabajador [" + alfa1 + "." + alfa2 + "] ";
          aAviso = aAviso + "tiene algun periodo en IT sin Jornadas en baja.";
          |MENAV aAviso;
          aAviso = "    Debera informar el numero de jornadas en baja en el ";
          aAviso = aAviso + "concepto 922 en casos de baja";
          |MENAV aAviso;
     |FINSI;
     |SI nume1 = 0; |Y nume2 > 0; |Y swJornadas = 1;
          aAviso = "    ATENCION: Trabajador [" + alfa1 + "." + alfa2 + "] ";
          aAviso = aAviso + "tiene jornadas informadas en el concepto 922 ";
          |MENAV aAviso;
          aAviso = "    Debera informar el periodo que ha estado de baja en Variaciones ";
          |MENAV aAviso;
     |FINSI;
|FPRC;

|PROCESO avisoJorERE;
     nume1 = ddese_2;
     alfa1 = #labtraba#0;
     alfa1 = "00000" + alfa1;
     alfa1 = alfa1 % -105;
     alfa2 = #labtraba#1;
     alfa2 = "00000" + alfa2;
     alfa2 = alfa2 % -105;
     |SI nume1 > 0; |Y nJornadasERE = 0; |Y swJornadas = 1;
          aAviso = "    ATENCION: Trabajador [" + alfa1 + "." + alfa2 + "] ";
          aAviso = aAviso + "tiene algun periodo en ERE sin Jornadas informadas.";
          |MENAV aAviso;
          aAviso = "    Debera informar el numero de jornadas en ERE en el ";
          aAviso = aAviso + "concepto 935.";
          |MENAV aAviso;
     |FINSI;
     |SI nume1 = 0; |Y nJornadasERE > 0; |Y swJornadas = 1;
          aAviso = "    ATENCION: Trabajador [" + alfa1 + "." + alfa2 + "] ";
          aAviso = aAviso + "tiene jornadas informadas en el concepto 935 ";
          |MENAV aAviso;
          aAviso = "    Debera informar el periodo que ha estado en ERE en Variaciones ";
          |MENAV aAviso;
     |FINSI;
|FPRC;

|PROCESO calbonifmater;

          || bonificacion sobre jornadas en maternidad

     |SI dmate_2 > 0;
          || proporciono las jornadas IT segun los dias de enfermedad y maternidad
          || para ver las que cogere para base bonif mater
          || nume1 = (dmate_2 * jornadasIT) / (denfe_2 + dacci_2 + dmate_2);
          || jornadasMat = nume1 ! 0;
          jornadasMat = jornadasIT - jornadasEA; || por diferencias

          alfa1 = #16#13;            || esto es porque la bonif. con clave 18
          |QBF alfa1;                || de los agrarios no cotiza en nomina y
          alfa1 = "000" + alfa1;     || si en TC's. Cotiza el 1.25% todo a
          alfa1 = alfa1 % -103;      || cargo de la empresa. Pero si hay baja
          |SI alfa1 = "018";         || en el TC solo cotiza el 1,01.
               |SI #labtraba#42 = "E";
                    nume1 = (#nomconst#12 + #nomconst#14 +#nomconst#16) - 0.24;
               |SINO;
                    nume1 = (#nomconst#12 + #nomconst#14 +#nomconst#16) - 1.55;
               |FINSI;
          |SINO;
               nume1 = (#nomconst#12 + #nomconst#14 +#nomconst#16)
          |FINSI;

          |SI nElAny ] 2011; |Y #2#33 = 01;
               basemat_B = jornadasMat * prom_enf;     || base desempleo Maternidad
          |SINO;
               basemat_B = jornadasMat * #18catego;     || base desempleo Maternidad
          |FINSI;
          ||basemat_B = basemat_B % (#nomconst#12 + #nomconst#14 +#nomconst#16);
          basemat_B = basemat_B % nume1;
          basemat_B = basemat_B ! EURODB;         || base AT/EP Maternidad
          || lo mismo para la base AT/EP, multiplico los dias matern por el
          || promedio IT y lo hago por diferesncias con la base de Enf/Accid
          nume4 = ((denfe_2 * prom_enf) + (dacci_2 * prom_acc));
          basemat_C = (base_5 - nume4) % (#nomconst#3 + #nomconst#4);
          basemat_C = basemat_C ! EURODB;
          base_M = basemat_B + basemat_C;
          |SI bbase_F < 0; bbase_F = 0; |FINSI; || por si acaso q no me fio 1 pelo
     |FINSI;
|FPRC;

|PROCESO topes_cp;
     sw_tope = sw_tope + 1;        || en alta: sw_tope=1; en baja: sw_tope=2
     dias_baja = (denfe_2 + dmate_2 + dacci_2) - swAjuste3;
     |SI nBaseATEP = 0;             || solo topeo si tengo algo en la base
          |ACABA;
     |FINSI;
     |SI #labtraba#42 = "E";         || eventuales calculan los topes por jornadas
          |SI sw_tope = 1;    || reales, no por dias trabajados
               dias_tope = fijo_1;
          |SINO;
               dias_tope = jornadasIT;
          |FINSI;
     |SINO;
          |SI sw_tope = 1;    || fijos calculas los topes por dias trabajados
               |SI dias_baja > 0;
                    dias_tope = dcoti_0 - dias_baja;
               |SINO;
                    dias_tope = dcoti_0;
               |FINSI;
          |SINO;
               dias_tope = dias_baja;
          |FINSI;
     |FINSI;
     |SI dias_tope > 30; dias_tope = 30; |FINSI;
     nMax_cp = #nomconst#20 * dias_tope;                     || maximo A.T.
     |SI grupo = 12; nMin_cp = #nomconst#22 * dias_tope; |FINSI;    || minimo A.T.
     |SI grupo = 11; nMin_cp = #nomconst#21 * dias_tope; |FINSI;
     |SI grupo < 11; nMin_cp = #nomconst#23 * dias_tope; |FINSI;
     |SI nMax_cp [ nBaseATEP; |Y nMax_cp > 0;
          nBaseATEP = nMax_cp;      || topeo maximo
          pilt_enf = #nomconst#20;
     |FINSI;
     |SI nMin_cp ] nBaseATEP; |Y nMin_cp > 0;
          nBaseATEP = nMin_cp;      || topeo minimo
          pilt_enf = #nomconst#23;
     |FINSI;
|FPRC;

|PROCESO lee904;
     |ABRE #nomepigr;
     #nomepigr#0 = 904;
     |LEE 000#nomepigr.=;
     |CIERRA #nomepigr;
|FPRC;

|| PROCESO PARA BUSCAR LA CANTIDAD BONIFICADA EN BONIFICACIONES PARA
|| BENEFICIARIOS DE PRESTACION DE DESEMPLEO, QUE TIENEN LIMITADO EL MAXIMO

|PROCESO BuscaBonif;
     nNume = nNume + #nomhicca#63;
|FPRC;

|DEFBUCLE BuscaBonif;
     #nomhicca#1;
     12;
     #labtraba#0, #labtraba#1, nDesdeAny, 01, 00, #nombonif#0;
     #labtraba#0, #labtraba#1, nHastaAny, 12, 99, #nombonif#0;
     ;
     NULL, BuscaBonif;
|FIN;

|PROCESO BuscaBonifNIF;
     |BUCLE BuscaBonif;
|FPRC;

|DEFBUCLE BuscaBonifNIF;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaBonifNIF;
|FIN;

|PROCESO LimiteBonif;
     nNume = 0;
     |SI #nombonif#26 = "S"; |Y #labtraba#217 ! 0;
          nDesdeAny = 09;
          nHastaAny = nElAny - 2000;
          aNif = #labtraba#7;
          |SALVA_FICHA #labtraba;
          |BUCLE BuscaBonifNIF;
          |REPON_FICHA #labtraba;
          nNume = #labtraba#217 - nNume;
          |SI nNume < 0;
               base_A = 0;
          |SINO;
               |SI nNume ] base_A;
                    base_A = base_A;
               |SINO;
                    base_A = nNume;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calssemp;    || CALCULA S.S. A CGO. EMPRESA (18/93 y resto)
     base_A = 0;  base_B = 0;  base_C = 0;  base_F = 0;
     bbase_A = 0;  bbase_B = 0;  bbase_C = 0;  base_M = 0;
     basemat_B = 0;  basemat_C = 0;
     base_D = 0;  base_E = 0;
     zbase_A = 0; zbase_B = 0; zbase_C = 0; zbase_F = 0;
     base_77 = acum_10 + coba_3 + dvalo_pro;  || base cont.profesionales
     base_11 = 0;

     base_8 = (dacum_30 % por2_hor1)+(dacum_31 % por2_hor2); || h.ext.
     base_11 = dcont_2 * prom_enf;
     /*
     |SI swITEmp = 1;
          base_11 = base_11 + coba_4;
     |FINSI;
     */

     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y #16#11 = "S";
          base_D = horasex * #16#12;      || cuota (2) bonif. horas formacion
     |FINSI;

     base_8 = base_8 + (base_6 % por2_cont);             || cc
     base_8 = base_8 + (base_7 % por2_dfpg);             || cp

     sw_tope = 0;
     nBaseATEP = base_77;
     |HAZ topes_cp;
     base_77 = nBaseATEP;
     nATEP_Alta = base_77;

     || parte en alta
     |SI #0#9 [ 2009;
          base_9 = nATEP_Alta % (epig_ilt + epig_ims);
          || a partir del 2010 como no se cotiza por la ocupacion "c"
          || cotizo por at/ep sumando las dos bases despues, para no hacerlo
          || por separado al mismo porcentaje, por no provocar diferencias
     |SINO;
          || TAMBIEN, porque en los seguros sociales lo hacemos asi, hay que
          || hacerlo igual
          base_9 = (nATEP_Alta % epig_ilt) ! 2;
          base_9 = base_9 + (nATEP_Alta % epig_ims) ! 2;
     |FINSI;

     || parte en IT
     nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
     |SI nume2 < 0; nume2 = 0; |FINSI;
     nume1 = dcoti_0 - nume2;

     |SI #2#42 ! "E";
          nBaseATEP = nume2 * pilt_enf;
     |SINO;
          nBaseATEP = jornadasIT * pilt_enf;
     |FINSI;
     |HAZ topes_cp;
     nATEP_IT  = nBaseATEP;
     |SI #0#9 [ 2009;
          |SI #0#9 [ 2006;
               base_9 = base_9 + (base_5 % (#15#3 + #15#4));
          |SINO;
               |HAZ lee904;
               base_9 = base_9 + (nATEP_IT % (#nomepigr#1 + #nomepigr#2));
          |FINSI;
     |SINO;
          base_9 = base_9 + ((nATEP_IT % epig_ilt) ! 2);
          base_9 = base_9 + ((nATEP_IT % epig_ims) ! 2);
     |FINSI;
               || bonificacion sobre base jornadas reales en alta
               || si es maternidad no bonifico la parte en alta
     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0; |Y dmate_2 = 0;
          base_A = ((bon_0 % #16#4)!EURODB) % nPorBon1; || cuota bonif. linea 1
          base_A = base_A ! EURODB;
          base_B = ((bon_3 % #16#5)!EURODB) % nPorBon1; || cuota bonif. linea 2
          base_B = base_B ! EURODB;
          |HAZ LimiteBonif;
          |SI #16#08 = "S";
               zbase_9 = (acum_10 + coba_3) % (epig_ilt + epig_ims);
               zbase_9 = zbase_9 ! EURODB;
               base_C = zbase_9 % nPorBon1;      || cuota bonificada accidentes
               base_C = base_C ! EURODB;
          |FINSI;
     |FINSI;

     jornadasEA = jornadasIT;

     |SI #2#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0;
          nume1 = 0;
          bbon_0 = jornadasEA * #18catego;
          bbon_3 = jornadasEA * #18catego;
          ||bbon_5 = bon_5;
          bbon_5 = base_5;
          alfa1 = #16#13;            || esto es porque la bonif. con clave 18
          |QBF alfa1;                || de los agrarios no cotiza en nomina y
          alfa1 = "000" + alfa1;     || si en TC's. Cotiza el 1.25% todo a
          alfa1 = alfa1 % -103;      || cargo de la empresa. Pero si hay baja
          |SI alfa1 = "018";         || en el TC solo cotiza el 1,01.
               |SI #labtraba#42 = "E";
                    nume1 = #16#5 - 0.24;
               |SINO;
                    nume1 = #16#5 - 1.55;
               |FINSI;
          |SINO;
               nume1 = #16#5;
          |FINSI;
          bbase_A = ((bbon_0 % #16#4)!EURODB) % nPorBon1; || cuota bonif. linea 1
          bbase_A = bbase_A ! EURODB;
          bbase_A = 0; || porque no hay base de CC para bonificar por ser baja
          bbase_B = ((bbon_3 % nume1)!EURODB) % nPorBon1; || cuota bonif. linea 2
          bbase_B = bbase_B ! EURODB;
          |SI #16#08 = "S";
               |SI #0#9 [ 2009;
                    |SI #0#9 [ 2006;
                         zbase_9 = (bbon_5 % (#15#3 + #15#4));            || epig.enf.
                    |SINO;
                         |HAZ lee904;
                         zbase_9 = (bbon_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                    |FINSI;
               |SINO;
                    zbase_9 = ((bbon_5 % epig_ilt) ! 2);           || epig.enf.
                    zbase_9 = zbase_9 + ((bbon_5 % epig_ims) ! 2); || epig.enf.
               |FINSI;
               zbase_9 = zbase_9 ! EURODB;
               bbase_C = zbase_9 % nPorBon1;      || cuota bonificada accidentes
               bbase_C = bbase_C ! EURODB;
          |FINSI;
     |FINSI;
/*
     cbon_3 = jornadasEA * #18catego;
     |SI alfa1 = "018"; || por lo de la reduccion familiares
          cbon_3 = cbon_3 % (nume1 + #nomconst#14 + #nomconst#16);
     |SINO;
          cbon_3 = cbon_3 % (#nomconst#12 + #nomconst#14 + #nomconst#16);
     |FINSI;
     cbon_3 = cbon_3 ! EURODB;     || cuota en baja para a¤adir a S.S.Empresa
*/
     ||HAZ calbonifmater;     COMENTADO: HACEMOS LA BONIF MATER COMO SIEMPRE

     |SI #2#39 ! 0; |Y dboni_2 ! 0; |Y nPorBon2 ! 0;
          zbase_A = ((zbon_0 % #16#4)!EURODB) % nPorBon2; || cuota bonif. linea 1
          zbase_A = zbase_A ! EURODB;
          zbase_B = ((zbon_3 % #16#5)!EURODB) % nPorBon2; || cuota bonif. linea 2
          zbase_B = zbase_B ! EURODB;
          |SI #16#08 = "S";
               |SI #0#9 [ 2009;
                    zbase_9 = (zbon_3 - zbon_5) % (epig_ilt + epig_ims);
                    zbase_9 = zbase_9 ! EURODB;
                    |SI #0#9 [ 2006;
                         zbase_9 = zbase_9 + (zbon_5 % (#15#3 + #15#4));            || epig.enf.
                    |SINO;
                         |HAZ lee904;
                         zbase_9 = zbase_9 + (zbon_5 % (#nomepigr#1 + #nomepigr#2));            || epig.enf.
                    |FINSI;
               |SINO;
                    zbase_9 = ((zbon_3 - zbon_5) % epig_ilt) ! 2;
                    zbase_9 = zbase_9 + (((zbon_3 - zbon_5) % epig_ims) ! 2);
                    zbase_9 = zbase_9 + ((zbon_5 % epig_ilt) ! 2);
                    zbase_9 = zbase_9 + ((zbon_5 % epig_ims) ! 2);
               |FINSI;
               zbase_9 = zbase_9 ! EURODB;
               zbase_C = zbase_9 % nPorBon2;     || cuota bonificada accidentes
               zbase_C = zbase_C ! EURODB;
          |FINSI;
     |FINSI;

     || empresa las cuotas de la bonificacion de la parte de baja y maternidad
     base_F = base_A + base_B + base_C;       || cuota (1) bonif. en alta
     bbase_F = bbase_A + bbase_B + bbase_C;   || cuota (1) bonif. en baja
     base_F = base_F + bbase_F + base_M;
     zbase_F = zbase_A + zbase_B + zbase_C;   || cuota (2) bonif.

     || S.Social cargo empresa:

     base_E = base_8+base_9-(base_A+base_B+base_C+zbase_A+zbase_B+zbase_C+base_D); ||SS emp.
     base_E = base_E - (bbase_A + bbase_B + bbase_C + base_M); || quito a la SS.cgo.
     base_E = base_E + cbon_3;     || a¤ado desempleo en baja

     |SI base_E < 0;
         base_E = 0;     || por si acaso sale negativa
     |FINSI;

     base_E = base_E - nRedFija;
     |SI base_E < 0;
          nRedFija = nRedFija + base_E;
          base_E = 0;
     |FINSI;
     |SI nBonifFCI > 0;
          base_E = base_E - nBonifFCI;
          |SI base_E < 0;
               nBonifFCI = nBonifFCI + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI bon_59 > 0;
          base_E = base_E - bon_59;
          |SI base_E < 0;
               bon_59 = bon_59 + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI bon_60 > 0;
          base_E = base_E - bon_60;
          |SI base_E < 0;
               bon_60 = bon_60 + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||                   SUBRUTINAS CALCULOS FINALES
||****************************************************************************

|PROCESO ajustes;
|HAZ convenio;
|SI convenio = 0;
    |SI #10#4 = 0;  dcofi_999 =       1;  |FINSI;
    |SI #10#4 = 1;  dcofi_999 = dcofi_1;  |FINSI;
    |SI #10#4 = 2;  dcofi_999 = dcofi_2;  |FINSI;
|FINSI;
|FPRC;

||****************************************************************************
||                   COMPROBACION ACTIVACION EMPRESA
||****************************************************************************

|PROCESO activasino;
     swActiva = 1;
     |ABRE #1;
     #1#0 = #2#0;
     |LEE 000#1=;
     |SI #1#50 = "S";
          swActiva = 0;  || empresa no activa
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO CompModulo2;
     swNoAjuste3 = 0;
     |SI #0#8 = 2;       || EN FEBRERO
          |PARA para1 = 12; |SI para1 [ 15; |HACIENDO para1 = para1 + 1;
               |SI #7para1 = "E"; |O #7para1 = "A"; |O #7para1 = "M";
               |O #7para1 = "P"; |O #7para1 = "R"; |O #7para1 = "O";
               |O #7para1 = "C";
                    desde = para1 - 8;
                    hasta = para1 - 4;
                    |SI #7hasta = topemes; |O #7hasta ! 0;
                         swNoAjuste3 = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO modulo2;
     || este proceso se crea para controlar el tema de la opcion "3" en el
     || control de la aplicacion en el calculo de Dias de IT
     || solo si no soy diario, estoy en un mes de 31 dias y tengo parte en IT
     || esta igual en el silcon09 y en el silcon10, si se cambia algo tenerlo
     || en cuenta tambien alli

     swAjuste3 = 0;
     swAjuste3_2 = 0;
     swNoAjuste3 = 0;
     swNoAjuste3_2 = 0;
     swAjuste3_C = 0;
     dilt = dacci_2 + denfe_2 + dmate_2;
     |SI #32#17 = 3;
          swSigue = 1;
          |SI #labtraba#42 = "E";
               swSigue = 0;
          |FINSI;
          |SI swSigue = 1;
               |SI dilt ! 0;
||Y denfe_2 < dia_2; |Y dacci_2 < dia_2; |Y dmate_2 < dia_2;
               |Y dcoti_0 ] dia_3; |Y dalta_3 = 1; |Y dbaja_3 = topemes; |Y swNoAjuste3 = 0;
               || si no esta todo el mes de alta no pasa
                    |SI #0#8 ! 4; |Y #0#8 ! 6; |Y #0#8 ! 9; |Y #0#8 ! 11;
                         |SI #0#8 ! 2;
                              swAjuste3 = 1;
                         |SINO;
                              swAjuste3 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || mensuales, mes completo en alta entre dos fichas e IT
               |SI nCotAlta = 2; |Y nDiasMesTrab ] 31; |Y nCuantos > 1; |Y dilt ! 0;
                    |SI #0#8 ! 4; |Y #0#8 ! 6; |Y #0#8 ! 9; |Y #0#8 ! 11;
                         |SI #0#8 ! 2;
                              swAjuste3 = 1;
                         |SINO;
                              swAjuste3 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;

               ||SI swAjuste3 = 0; |Y dilt ! 0; |Y denfe_2 = dia_2;
               |SI dilt ! 0;
               |Y dcoti_0 ] dia_3; |Y dalta_3 = 1; |Y dbaja_3 = topemes; |Y swNoAjuste3 = 0;
               || novedad: estoy TODO el mes de baja, tengo que complementar por 30 DIAS
               || si estoy en mes que no sea de 30 dias si soy mensual 07/06/2006
               || no entra en el anterior pero en este si que tiene que entrar
               || para complementos

               || atencion: quito lo de que tenga que estar todo el mes de baja
               || porque esto debe ser para todos los meses de 31 o 28 dias igual
               || en mensuales, ademas quito tambien lo de que solo entre si no ha
               || hecho ya el otro ajuste 25.01.2007

                    |SI #0#8 ! 4; |Y #0#8 ! 6; |Y #0#8 ! 9; |Y #0#8 ! 11;
                         |SI #0#8 ! 2;
                              swAjuste3_C = 1;
                         |SINO;
                              bisiesto = 0;
                              numer = anynum $ 4;
                              |SI numer = 0;
                                   bisiesto = 1;
                              |FINSI;
                              swAjuste3_C = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #32#17 = 2;
          swSigue = 0;
          |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
               swSigue = 1;
          |FINSI;
          |SI #labtraba#247 = 132; |Y #labtraba#33 < 8;
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1;
               |SI dilt ! 0;
               |Y dcoti_0 ] dia_3; |Y dalta_3 = 1; |Y dbaja_3 = topemes; |Y swNoAjuste3_2 = 0;
               || si no esta todo el mes de alta no pasa
                    |SI #0#8 ! 4; |Y #0#8 ! 6; |Y #0#8 ! 9; |Y #0#8 ! 11;
                         |SI #0#8 ! 2;
                              swAjuste3_2 = 1;
                         |SINO;
                              swAjuste3_2 = -2 + bisiesto;
                         |FINSI;
                    |FINSI;
               |FINSI;
         |FINSI;
     |FINSI;
     |SI swAjuste3 ! 0;
          |HAZ UltimaIT;
     |FINSI;
|FPRC;

|PROCESO UltimaIT;
     aUltimaIT = "";
     |PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
          nDesde = nCampo - 8;
          nHasta = nCampo - 4;
          |SI #nomvarca#nCampo# ! " ";
               aUltimaIT = #nomvarca#nCampo#;
          |FINSI;
     |SIGUE;
|FPRC;

/****************************************************************************/
/**************     PROCESO PARA MODULO DE ADADE AGRARIOS *******************/
/****************************************************************************/

|PROCESO ModuloAdade;
     |DBASE aPath;
     |QBF aPath;
     aDef = aPath + "def/adade004.mas";
     aFic = aPath + "fich/";
     |CARGA_DEF aDef, copiadef@;
     |SI FSalida = 0;
          |PATH_DAT #copiadef@#aFic#;

          nNume = 0;

          |ABRE #500;
          #500#0 = #labtraba#87;
          |LEE 000#500=;
          |SI FSalida = 0;
               |PARA nCampo = 1; |SI nCampo [ 5; |HACIENDO nCampo = nCampo + 1;
                    #nomcalli#0 = #nomcalca#0;
                    #nomcalli#1 = #nomcalca#1;
                    #nomcalli#2 = #nomcalca#2;
                    #nomcalli#3 = #nomcalca#3;
                    #nomcalli#4 = #500nCampo;
                    |LEE 000#nomcalli.=;
                    |SI FSalida = 0;
                         nNume = nNume + ((#nomcalli#10 * #nomcalli#11) ! 2);
                    |FINSI;
               |SIGUE;
               #nomcalca#37 = #nomcalca#37 - nNume;
               #nomcalca#38 = #nomcalca#38 + nNume;
          |FINSI;
          |CIERRA #500;
     |FINSI;
     |DESCARGA_DEF #copiadef@;
|FPRC;
