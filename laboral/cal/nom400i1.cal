|FICHEROS;
     nom400i1 #0;
     nom400eu;
     nomcalca;
     nomhicca;

     labempre;
     labtraba;
     labcentr;

     nomtminf #100;
|FIN;

|VARIABLES;
     aAlfa = "";
     &swCrystal = 0;
     &aMes1 = "";
     &aMes2 = "";
     &nMes = 0;
     &aMes = "";
     fFecha = @;
     nMesBase = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nCampo4 = 0;
     nEmpAnt = 0;
     &swCabecera = 0;
|FIN;

|PROCESO Impresion;
     swCabecera = 0;
     |SI #100#0 ! nEmpAnt;
          swCabecera = 1;
     |FINSI;
     |PRINT;
     nEmpAnt = #100#0;
|FPRC;

|DEFBUCLE Impresion;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impresion;
|FIN;

|PROCESO Mensual;
     #nomcalca#0 = #100#0;
     #nomcalca#1 = #100#1;
     #nomcalca#2 = nMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          nCampo1 = 6 + ((nMes - 6) * 4)
          nCampo2 = nCampo1 + 1;
          nCampo3 = nCampo1 + 2;
          nCampo4 = nCampo1 + 3;
          |SI #100nCampo1 = 0; |Y #100nCampo2 = 0; |Y #100nCampo3 = 0;
               #100nCampo1 = #nomcalca#74 + #nomcalca#16;     || Base IRPF
               #100nCampo2 = #nomcalca#13;     || IRPF
               #100nCampo3 = #nomcalca#75 + #nomcalca#17;     || Retencion IRPF
               #100nCampo4 = (#100nCampo1 % #100#3) - #100nCampo3;     || Retencion IRPF
               #100#34 = #100#34 + #100nCampo4;
               |GRABA 020#nomtminf.a;
               |LIBERA #nomtminf;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Historico;
     #nomhicca#0 = #100#0;
     #nomhicca#1 = #100#1;
     #nomhicca#66 = 8;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          nCampo1 = 6 + ((nMes - 6) * 4)
          nCampo2 = nCampo1 + 1;
          nCampo3 = nCampo1 + 2;
          nCampo4 = nCampo1 + 3;
          #100nCampo1 = #nomhicca#113 + #nomhicca#16;     || Base IRPF
          #100nCampo2 = #nomhicca#13;     || IRPF
          #100nCampo3 = #nomhicca#114 + #nomhicca#17;     || Retencion IRPF
          #100nCampo4 = (#100nCampo1 % #100#3) - #100nCampo3;     || Retencion IRPF
          #100#34 = #100#34 + #100nCampo4;
          |GRABA 020#nomtminf.a;
     |FINSI;
     |LIBERA #nomtminf;
|FPRC;

|PROCESO nomtminf;
     |PARA nMes = 6; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
          |HAZ Historico;
          |HAZ Mensual;
     |SIGUE;
|FPRC;

|DEFBUCLE nomtminf;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, nomtminf;
|FIN;

|PROCESO MesBase;
     #100#0 = #nomhicca#0;           || campo 0: codigo empresa
     #100#1 = #nomhicca#1;           || campo 1: codigo trabajador
     #labempre#0 = #nomhicca#0;
     |LEE 000#labempre.=;

     #labtraba#0 = #nomhicca#0;
     #labtraba#1 = #nomhicca#1;
     |LEE 000#labtraba.=;

     #100#35 = #labtraba#77;           || campo 8: codigo centro
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;

     #100#52 = #labempre#2;     || campo 52: nombre empresa
     #100#53 = #labtraba#2;     || campo 53: nombre trabajador
     #100#54 = #labcentr#2;     || campo 54: nombre centro

     #100#2 = #nomhicca#113 +  #nomhicca#16; || campo 2: Base IRPF 1
     #100#3 = #nomhicca#13;     || campo 3: % IRPF 1
     #100#4 = #nomhicca#114 + #nomhicca#17;    || campo 4: Retencion IRPF 1
     #100#5 = 0;                || campo 5: Diferencia (aqui no sirve)
     |GRABA 020#100n;

     |LIBERA #100;
|FPRC;

|DEFBUCLE MesBase;
     #nomhicca#1;
     ;
     #0#0, #0#2, 08, nMesBase, 0;
     #0#1, #0#3, 08, nMesBase, 0;
     ;
     NULL, MesBase;
|FIN;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = Usuario; |QBF aAlfa;    aAlfa = "w" + aAlfa;
          |NOME_DAT #100 aAlfa;
          |DELINDEX #100;

          |ABRE #100;
          |ABRE #labcentr;
          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #nomcalca;
          |ABRE #nomhicca;


          || primero el mes base, busco en historico, se supone que sera el mes 5
          nMesBase = #0#4;
          |BUCLE MesBase;

          |BUCLE nomtminf;

          |LEE 000#100p;
          |SI FSalida = 0;
               |IMPRE 0;
               swCrystal = 0;
               |SI Impresora = "CrystalReport";
                    swCrystal = 1;
               |FINSI;
               |SI FSalida = 0;
                    nMes = #0#4;
                    |HAZ MesLetra_plb;
                    aMes1 = aMes;

                    |INFOR "nom400i1";
                    |BUCLE Impresion;
                    |PIEINF;
               |FINSI;
               |FININF;
          |SINO;
               aAlfa = "    No existen trabajadores con nómina en el histórico ";
               aAlfa = aAlfa + "en el mes de referencia. Revise la selección";
               |MENAV aAlfa;
          |FINSI;

          |CIERRA #100;
          |CIERRA #labcentr;
          |CIERRA #labtraba;
          |CIERRA #labempre;
          |CIERRA #nomcalca;
          |CIERRA #nomhicca;
     |FINSI;
|FPRO;
