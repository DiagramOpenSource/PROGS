|FICHEROS;
     laborn15;
     laborn05;
     labempre;
     labtraba;
     labtrtra;
     labort15;
     labregis;
     nomequiv;
     laborn90;
     labcontr;
     nompmail;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aParam = "";
     &eaUsuario = "";
     &eaFecha = "";
     &eaHora = "";
     nCampo = 0;
     aHora = "";
     nEmp = 0;
     nTra = 0;

     &eaAsunto   = "";
     &eaTexto    = "";
     &eaEmpresa  = "";
     &eaTrabajador = "";
     &eaAccion  = "";
     swGrabalo = 0;

     fFechaHoy = @;
     nFechaHoy = 0;
     nFecha30 = 0;
     fFecha30 = @;
     nContrato = 0;
     aAltaTrab = "";
     aBajaTrab = "";
     fAltaTrab = @;
     fBajaTrab = @;
     fFechaBaja = @;
     nDias = 0;
     fInicio30 = @;
     nAltaTrab = 0;
     nBajaTrab = 0;
     fFechaDif = @;
     aFecha = "";
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     nMeses = 0;
     nAnys = 0;
     nTotalDias = 0;
     nTotalMeses = 0;
     aNif = "";
     aDia = "";
     aMes = "";
     aAny = "";
     nMes = 0;
     nAny = 0;
     swPasa = 0;
     nAntEmpresa = 0;
     &eaDirDest = "";

     nEmpresas = 0;
     nCodEmp = 0;
     aNomEmp = "";
     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     &swMeHeSalido = 0;
     swLaborbox = 0;

     &eaQueEs            = "";
|FIN;

|PROCESO CompTraba;
     #nomequiv#0 = #labtraba#45;
     |LEE 000#nomequiv.=;
     |SI FSalida = 0;
          nContrato = #nomequiv#1;
     |SINO;
          nContrato = #labtraba#45;
     |FINSI;
     |SI nContrato < 400;          || es un contrato temporal: adelante
          |ACABA;
     |FINSI;

     || si cambio de empresa ya no vale
     |SI nAntEmpresa ! 0; |Y nAntEmpresa ! #labtraba#0;
     ||SI #labtraba#0 ! #laborn15#5;
          |ACABA;
     |FINSI;

     || empezamos a contar dias trabajados en contato temporal en los
     || ultimos 30 meses

     aAltaTrab = #labtraba#36;
     aBajaTrab = #labtraba#37;

     fAltaTrab = aAltaTrab;
     |QBF aBajaTrab;
     |SI aBajaTrab ! ""; |Y aBajaTrab ! "..........";
          fBajaTrab = aBajaTrab;
     |SINO;
          fBajaTrab = fFechaBaja;
     |FINSI;

     nDias = 0;

     |SI fBajaTrab < fInicio30;
          |ACABA;
     |FINSI;
     |SI fAltaTrab < fInicio30;
          fAltaTrab = fInicio30;
     |FINSI;

     nAltaTrab = fAltaTrab;
     nBajaTrab = fBajaTrab;

     || nDias = nBajaTrab - nAltaTrab;

     fFechaDif = fBajaTrab - fAltaTrab;
     aFecha = fFechaDif;
     alfa1 = aFecha % 102;
     alfa2 = aFecha % 402;
     alfa3 = aFecha % -104;
     nDias = alfa1;
     nMeses = alfa2;
     nAnys = alfa3;
     |SI nDias ] 30;
          nDias = nDias - 30;
          nMeses = nMeses + 1;
     |FINSI;
     nMeses = nMeses + (nAnys * 12);

     nTotalDias = nTotalDias + nDias;
     nTotalMeses = nTotalMeses + nMeses;
     |SI nTotalDias ] 30;
          nTotalMeses = nTotalMeses + 1;
          nTotalDias = nTotalDias - 30;
     |FINSI;

     nAntEmpresa = #labtraba#0;
|FPRC;

|DEFBUCLE CompTraba;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, CompTraba;
|FIN;

|PROCESO Maximo;
     fFechaBaja = #labort15#6;

     aFecha = fFechaBaja;
     aDia = aFecha % 102;
     aMes = aFecha % 402;
     aAny = aFecha % -104;

     nMes = aMes;
     nMes = nMes - 6;
     nAny = aAny;
     nAny = nAny - 2;
     |SI nMes < 0;
          nMes = 12 + nMes;
          nAny = nAny - 1;
     |FINSI;
     aDia = ("00" + aDia) % -102;
     aMes = nMes;
     aMes = ("00" + aMes) % -102;
     aAny = nAny;
     aFecha = aDia + "." + aMes + "." + aAny;

     fInicio30 = aFecha;
     aNif = #labtraba#7;
     nTotalMeses = 0;
     nTotalDias = 0;
     nAntEmpresa = 0;

     |BUCLE CompTraba;
|FPRC;

|PROCESO Posibles1;
     swGrabalo = 0;

     fFechaHoy = ~;
     nFechaHoy = fFechaHoy;
     nFecha30 = nFechaHoy + 30;
     fFecha30 = nFecha30;

     |SI #labregis#24 ] fFechaHoy; |Y #labregis#24 [ fFecha30;
          swGrabalo = 1;
     |FINSI;
     |SI #labregis#26 ] fFechaHoy; |Y #labregis#26 [ fFecha30;
          swGrabalo = 2;
     |FINSI;

     |SI swGrabalo ! 0;
          #labtraba#0 = #labregis#1;
          #labtraba#1 = #labregis#2;
          |LEE 000#labtraba.=;

          #labort15#0 = #labtraba#0;
          #labort15#1 = #labtraba#1;
          |LEE 000#labort15.=;
          |SI FSalida ! 0;
               #labort15#0 = #labtraba#0;
               #labort15#1 = #labtraba#1;
               #labort15#2 = #labtraba#2;
               #labort15#3 = #labtraba#7;
               #labort15#4 = #labtraba#45;
               #labort15#5 = #labtraba#36;
               |SI swGrabalo = 1;
                    #labort15#6 = #labregis#24;
               |SINO;
                    #labort15#6 = #labregis#26;
               |FINSI;

               |ABRE #nomequiv;
               |HAZ Maximo;
               |CIERRA #nomequiv;

               #labort15#7 = 0;
               #labort15#8 = 0;

               swPasa = 0;
               |SI nTotalMeses [ 24;
                    |SI nTotalMeses = 24;
                         |SI nTotalDias = 0;
                              swPasa = 1;
                              nTotalMeses = 23;
                              nTotalDias = 30;
                         |SINO;
                              swPasa = 0;
                         |FINSI;
                    |SINO;
                         swPasa = 1;
                    |FINSI;
               |SINO;
                    swPasa = 0;
               |FINSI;
               |SI swPasa = 1;
                    #labort15#7 = 23 - nTotalMeses;
                    #labort15#8 = 30 - nTotalDias;
               |SINO;
                    #labort15#7 = 24 - nTotalMeses;
                    #labort15#8 = nTotalDias * (-1);
                    #labort15#9 = "EXCEDIDO";
               |FINSI;

               |SI #labort15#8 ] 29;
                    #labort15#8 = 0;
                    #labort15#7 = #labort15#7 + 1;
               |FINSI;
               |SI #labort15#8 [ -29;
                    #labort15#8 = 0;
                    #labort15#7 = #labort15#7 - 1;
               |FINSI;

               |SI #labort15#8 = 1; |O #labort15#8 = -1;
                    #labort15#8 = 0;
               |FINSI;

               |GRABA 000#labort15.n;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Posibles1;
     #labregis#2;
     ;
     00001, 00001;
     99999, 99999;
     ;
     NULL, Posibles1;
|FIN;

|PROCESO labtraba;
     |PARA nCampo = 0; |SI nCampo [ 253; |HACIENDO nCampo = nCampo + 1;
          #labtrtra#nCampo# = #labtraba#nCampo#;
     |SIGUE;
     |GRABA 020#labtrtra.n;
     |LIBERA #labtrtra;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44;
     #laborn15#5, 00001, "A";
     #laborn15#5, 99999, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO CargaTra;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ACABA;
     |FINSI;

     |ABRE #labregis;
     |ABRE #labtraba;

     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "U" + aAlfa;
     |NOME_DAT #labort15#aAlfa#;
     |DELINDEX #labort15;
     |ABRE #labort15;
     |BUCLE Posibles1;
     |CIERRA #labort15;

     |CIERRA #labtraba;
     |CIERRA #labregis;
|FPRC;

|PROCESO ValidaTra;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ACABA;
     |FINSI;

     |ABRE #labort15;
     #labort15#0 = #laborn15#5;
     #labort15#1 = #laborn15#6;
     |LEE 000#labort15.=;
     |SI FSalida ! 0;
          aAlfa = "    ATENCION. Trabajador no encontrado o con contrato no prorrogable";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
     |CIERRA #labort15;

     #laborn15#7 = #labort15#3;
     #laborn15#8 = #labort15#5;
     #laborn15#9 = #labort15#6;
     #laborn15#10 = #labort15#7;      || maximo meses prorroga
     #laborn15#11 = #labort15#8;      || maximo dias prorroga
     #laborn15#15 = #labort15#2;
     |PINTA #laborn15#7;
     |PINTA #laborn15#8;
     |PINTA #laborn15#9;
     |PINTA #laborn15#10;
     |PINTA #laborn15#11;
     |PINTA #laborn15#15;
     |SI #laborn15#10 [ -1; |O #laborn15#11 [ -1;
          |ATRI R;
          |PINTA 1437, "ATENCION: EL TRABAJADOR EXCEDE EL LIMITE";
          |PINTA 1537, "DE 24 MESES EN CONTRATOS TEMPORALES     ";
          |ATRI 0;
     |SINO;
          |PINTA 1437, "                                        ";
          |PINTA 1537, "                                        ";
     |FINSI;
|FPRC;

|PROCESO Min;
     #labort15#0 = #laborn15#5;
     #labort15#1 = 00001;
|FPRC;

|PROCESO Max;
     #labort15#0 = #laborn15#5;
     #labort15#1 = 99999;
|FPRC;

|PROCESO ConsultaTra; |TIPO 66;
     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "U" + aAlfa;
     |NOME_DAT #labort15#aAlfa#;
     |ABRE #labort15;
     |LEE 000#labtrtra.p;
     |CONSULTA_F_CLAVE #1#labort15, Min, Max;
     |SI FSalida = 0;
          #laborn15#6 = #labort15#1;
          |PINTA #laborn15#6;
          |HAZ ValidaTra;
     |FINSI;
     |CIERRA #labort15;
|FPRC;

|PROCESO Proceso;
     |ATRI R;
     |PINTA 1224, "CARGANDO LISTA DE TRABAJADORES";
     |ATRI 0;
     |CLS;

     |PINPA #0#laborn15;
     |PINDA #0#laborn15;

     swMeHeSalido = 0;
     |ENDATOS #1#laborn15;
     |SI FSalida ! 0;
           swMeHeSalido = 1;
     |FINSI;
|FPRC;

|PROCESO Email;
     aAlfa = #laborn15#5; |QBF aAlfa;
     eaEmpresa = ("00000" + aAlfa) % -105;
     eaEmpresa = eaEmpresa + " - " + #laborn15#14;
     aAlfa = #laborn15#6; |QBF aAlfa;
     eaTrabajador = ("00000" + aAlfa) % -105;
     eaTrabajador = eaTrabajador + " - " + #laborn15#15;
     eaAccion = "prórroga";

     |HAZ ConsEmail;
|FPRC;

|PROCESO labempre;
     nEmpresas = nEmpresas + 1;
     nCodEmp = #labempre#0;
     aNomEmp = #labempre#2;
|FPRC;

|DEFBUCLE labempre;
     #labempre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, labempre;
|FIN;

|PROCESO Empresas; |TIPO 7;
     |ABRE #labempre;
     |BUCLE labempre;
     |CIERRA #labempre;

     |SI nEmpresas = 1;
          || tengo una unica empresa que elegir

          #laborn15#5 = nCodEmp;
          #laborn15#14 = aNomEmp;
          |CAMPO_MODIFICA #laborn15#5, 1, "N";
          |CAMPO_MODIFICA #laborn15#14, 1, "N";
          |PINTA #laborn15#5;
          |PINTA #laborn15#14;
     |FINSI;
|FPRC;

|PROCESO Impresion;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |SI #labcontr#84 ! "S";
          |ACABA;
     |FINSI;

     eaQueEs = "P";

     aAlfa = "*laborn10;X";
     aAlfa = aAlfa + "15";
     aAlfa = aAlfa + #laborn05#0;
     aAlfa = aAlfa + #laborn05#1;
     aAlfa1 = #laborn05#3;
     aAlfa = aAlfa + aAlfa1;
     aAlfa = aAlfa + #laborn05#4;
     aAlfa = aAlfa + "IMPRE";

     |MENSA "    Imprimiendo solicitud de prórroga";

     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO Contador;
     |ABRE #laborn90;

     #laborn90#0 = #laborn05#5;
     #laborn90#1 = 99999;

     |LEE 000#laborn90.];
     |SI FSalida = 0;
          |SI #laborn90#0 ! #laborn05#5;
               |LEE 000#laborn90.a;
          |FINSI;
     |SINO;
          |LEE 000#laborn90.u;
     |FINSI;

     |SI FSalida = 0;
     |Y #laborn90#0 = #laborn05#5;
          nNume = #laborn90#1;

          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn05#5;
          #laborn90#1 = nNume + 1;

     |SINO;
          || es el primero de esta empresa !!!
          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn05#5;
          #laborn90#1 = 1;
     |FINSI;

     #laborn90#2 = "P";
     #laborn90#3 = "Pr¢rroga";
     #laborn90#4 = #laborn05#1;
     #laborn90#5 = #laborn05#2;
     #laborn90#6 = #laborn05#3;
     #laborn90#7 = #laborn05#4;

     |GRABA 020#laborn90.n;

     #laborn05#22 = #laborn90#1;

     |LIBERA #laborn90;
     |CIERRA #laborn90;
|FPRC;

|PROCESO Comprueba;
     nMeses = #laborn15#10 + #laborn15#12;
     nDias = #laborn15#11 + #laborn15#13;
     nNume1 = ((nDias / 30) - 0.49) ! 0;
     nNume2 = nDias $ 30;
     nMeses = nMeses + nNume1;
     nDias = nNume2;

     aAlfa = nMeses; |QBF aAlfa;
     aAlfa = ("  " + aAlfa) % -102; aAlfa = aAlfa + " meses";
     |PINTA 1742, aAlfa;
     aAlfa = nDias; |QBF aAlfa;
     aAlfa = ("  " + aAlfa) % -102; aAlfa = aAlfa + " d¡as ";
     |PINTA 1842, aAlfa;
|FPRC;

|PROCESO MaximoBox;
     |ABRE #labregis;
     |SELECT #2#labregis;
     #labregis#1 = #labtraba#0;
     #labregis#2 = #labtraba#1;
     |LEE 000#labregis.=;

     |CIERRA #labregis;

     #laborn15#10 = #labregis#18;
     #laborn15#11 = #labregis#22;

     |PINTA #laborn15#10;
     |PINTA #laborn15#11;

     |HAZ Comprueba;
|FPRC;

|PROGRAMA;
     |CLS;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa1#;
     |FINSI;

     swLaborbox = 0;
     |QBF eaUsuario;
     aAlfa1 = eaUsuario % 105;
     |SI eaUsuario = "WEB";
     |O aAlfa1 = "NUBEA";
          swLaborbox = 1;
     |FINSI;

     aParam = PARAMETRO;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ABRE #laborn05;
          |SI aParam = "MODIF";
               #laborn05#0 = "P";         || estado: pendiente, consulta/modificacion
          |FINSI;
          |SI aParam = "CONSUL";
               #laborn05#0 = "A";         || estado: actualizado, solo consulta
          |FINSI;
          #laborn05#1 = eaUsuario;
          #laborn05#2 = "";
          #laborn05#3 = eaFecha;
          #laborn05#4 = eaHora;
          |LEE 101#laborn05.=;

          |PARA nCampo = 0; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
               #laborn15#nCampo# = #laborn05#nCampo#;
          |SIGUE;
          #laborn15#19 = #laborn05#22;
          |PINPA #0#laborn15;
          |PINDA #0#laborn15;
          |CAMPO_MODIFICA #laborn15#5, 1, "N";
          |CAMPO_MODIFICA #laborn15#6, 1, "N";
          |CAMPO_MODIFICA #laborn15#7, 1, "N";

          |ABRE #labtraba;
          #labtraba#0 = #laborn15#5;
          #labtraba#1 = #laborn15#6;
          |LEE 000#labtraba.=;
          |CIERRA #labtraba;

          ||HAZ CargaTra;

          |SI swLaborbox = 1;
               |HAZ MaximoBox;
          |FINSI;

          |SI aParam = "MODIF";
               swMeHeSalido = 0;
               |ENDATOS #1#laborn15;
               |SI FSalida ! 0;
                    swMeHeSalido = 1;
               |FINSI;
          |FINSI;
          |SI aParam = "CONSUL";
               |PAUSA;
          |FINSI;
     |SINO;
          |HAZ Proceso;
     |FINSI;
     |SI swMeHeSalido = 0;
          |SI aParam = "MODIF";
               |PARA nCampo = 0; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
                    #laborn05#nCampo# = #laborn15#nCampo#;
               |SIGUE;
               |GRABA 020#laborn05.a;
          |SINO;
               |ABRE #laborn05;
               #laborn05#0 = "P";    || Estado: Pendiente
               #laborn05#1 = Usuario % 0810;     || Usuario
               #laborn05#2 = "";     || Perfiles, en principio no lo uso
               #laborn05#3 = ~;      || Fecha
               |HORA aHora;
               #laborn05#4 = aHora;  || Hora
               |PARA nCampo = 5; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
                    #laborn05#nCampo# = #laborn15#nCampo#;
               |SIGUE;
               |HAZ Contador;
               |GRABA 020#laborn05.n;

               |MENAV "    La solicitud de prórroga ha sido grabada";

               |HAZ Impresion;

               |ABRE #nompmail; |LEE 000#nompmail.p; |CIERRA #nompmail;
               |SI #nompmail#11 = "S";
                    |HAZ Email;
               |FINSI;
          |FINSI;

          |CIERRA #laborn05;
     |FINSI;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa2#;
     |FINSI;
|FPRO;
