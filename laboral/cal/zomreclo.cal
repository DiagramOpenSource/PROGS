|FICHEROS;
     zomreclo #0;
     referen@ #1;

     zomrectm #100;
     nompmail;
|FIN;

|VARIABLES;
     nOk        = 0;
     nNumCampos = 0;
     i          = 0;
     nLonCam    = 0;
     nCamClave  = 0;
     nPosCam    = 0;
     nNume      = 0;
     aValor = "";
     aCamClave = "";
     aValClave = "";
     aCampo = "";
     aBase = "";
     aPath = "";
     aDes = "";
     aFic = "";
     aAlfa = "";
     aAlfa1 = "";
     aOrg = "";
     aEmpAnt = "";
     aDefAnt = "";
     aEmp = "";
     aDef = "";
     aLon = "";
     aPathApli1 = "";
     aPathApli2 = "";
     aFicDef = "";
     nCarga = 0;
     aFichero = "";
     aQueQuiero = "";
     aTipoAnt   = "";
     aAbre     = "";
     aGraba     = "";
     nHandle    = 0;

     aLong     = "";
     nLong     = 0;
     aTab      = "";
     aCadena   = "";
     nCampo    = 0;
     nPos      = 0;
     nCarac    = 0;
     aCaracter = "";
     nRegis    = 0;
     aRegis    = "";
     nHandle1 = 0;
     nIntervaloCorreo = 50000;
     nLimiteLineas = 99999999;
|FIN;

|| **************************************************************************
|| ********************** ENVIO DE CORREOS ELECTRONICOS *********************
|| **************************************************************************

|VARIABLES;
   aIPDsCorreo1 = "";
   aSMTP        = "";
   aDirOrigen   = "";

{2}nDato        = 0;

   &eaDirDest   = "";
   &eaAsunto    = "";
   &eaTexto     = "";
   &eaFichero   = "";

   &eaEmpresa = "";
   &eaTrabajador = "";
   &eaAccion = "";
     nCodAdmin = 0;
     aAlfa2 = "";
     nCont = 0;
     nCalc = 0;
     nCalc1 = 0;
|FIN;

|PROCESO EnviaCorreo;
   |ABRE #nompmail;
   |LEE 000#nompmail.p;
/*
   |SI FSalida ! 0;
      |MENAV "    No se han indicado los parametros de envio de correos. Proceso cancelado";
      |CIERRA #nompmail;
      |ACABA;
   |FINSI;
*/
   |CIERRA #nompmail;

     || lo pongo a mano
     || no me fio de que lo tuvieran relleno o con que parametros

     #nompmail#1 = 217; #nompmail#2 = 13; #nompmail#3 = 81; #nompmail#4 = 114;
     #nompmail#6 = "N";
     #nompmail#7 = "mangel@diagram.es";
     #nompmail#8 = "mac";
     #nompmail#5 = "asmtp.diagram.es";
     #nompmail#10 = "mangel@diagram.es";

   aIPDsCorreo1 = #nompmail#1 + "." + #nompmail#2 + "." + #nompmail#3 + "." + #nompmail#4;
   aSMTP = #nompmail#5; |QBF aSMTP;
   aDirOrigen = #nompmail#10; |QBF aDirOrigen;

   |SI #nompmail#6 = "S";
      aAlfa = #nompmail#9; |QBF aAlfa;
      aAlfa1 = aAlfa % 0; nCalc = aAlfa1; aAlfa2 = "";
      |PARA nCont = 1; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
         nCalc1 = (nCont * 100) + 1;
         aAlfa1 = aAlfa % nCalc1; nDato1 = &aAlfa1; nDato2 = 255;
         InDato = nDato1<-;
         |ESPECIFICA "XOR", nDato;
         nCalc1 = FSalida; aAlfa2 = aAlfa2 + &nCalc1;
      |SIGUE;
      aAlfa = aAlfa2;              |QBF aAlfa; aAlfa = aAlfa + ":";
      aAlfa = aAlfa + #nompmail#7; |QBF aAlfa; aAlfa = aAlfa + ":";
      aDirOrigen = aAlfa + aDirOrigen;
   |FINSI;

   |DSCORREO_ENVIA aIPDsCorreo1, aSMTP, aDirOrigen, eaDirDest, eaAsunto, eaTexto, eaFichero;
   |SI FSalida < 0;
      ||MENAV "    Problemas al enviar correo";
   |FINSI;
|FPRC;

|PROCESO Email;
     |ACABA;

     || bueno al final esto tampoco, haciendolo con el fichero en local es
     || rapidisimo

     eaTexto = "Mensaje de estado de recuperación de ficheros del log.";
     eaFichero = "";
     eaDirDest = "mangel@diagram.es";
     |HAZ EnviaCorreo;
|FPRC;

|PROCESO Browse;
     |SI FSalida = 10;
          aAlfa = "F"; |BROWSE aAlfa;
          aAlfa = aAlfa % 0299; |QBF aAlfa;
          |SI aAlfa ! "";
               #0#0 = aAlfa; |PINTA #0#0;
          |FINSI;
          |ERROR;
          |ACABA;
     |FINSI;

      aAlfa = #0#0; |QBF aAlfa;
/*
      |XABRE "EC", aAlfa, nHandle;
      |SI FSalida < 0;
           |MENAV "    No encuentro el fichero"; |ERROR;
      |SINO;
           |XCIERRA nHandle;
      |FINSI;
*/
|FPRC;

|PROCESO LeeReg;
     aValClave = #100#7;
     aAlfa = "|K000";
     aCamClave = #1aAlfa;
     aAlfa = aCamClave % 103;
     nCamClave = aAlfa;
     nPos = 4;
     nPosCam = 1;
     |PARA i = 1; |SI i [ nCamClave; |HACIENDO i = i + 1;
          nNume = nPos * 100 + 3;
          aCampo = aCamClave % nNume;
          nCampo = aCampo;

          aAlfa = "|C" + aCampo + "LONGITUD";
          aAlfa = #1aAlfa;
          nLonCam = aAlfa;
          nNume = nPosCam * 100 + nLonCam;
          aValor = aValClave % nNume;

          #1nCampo = aValor;
          nPos = nPos + 3;
          nPosCam = nPosCam + nLonCam + 1;
     |SIGUE;

     |LEE 101#1=;
     |SI FSalida ! 0;
         aValClave = #100#7;
         aAlfa = "|K000";
         aCamClave = #1aAlfa;
         aAlfa = aCamClave % 103;
         nCamClave = aAlfa;
         nPos = 4;
         nPosCam = 1;
         |PARA i = 1; |SI i [ nCamClave; |HACIENDO i = i + 1;
              nNume = nPos * 100 + 3;
              aCampo = aCamClave % nNume;
              nCampo = aCampo;

              aAlfa = "|C" + aCampo + "LONGITUD";
              aAlfa = #1aAlfa;
              nLonCam = aAlfa;
              nNume = nPosCam * 100 + nLonCam;
              aValor = aValClave % nNume;

              #1nCampo = aValor;
              nPos = nPos + 3;
              nPosCam = nPosCam + nLonCam + 1;
        |SIGUE;

        |GRABA 020#1b;

        aGraba = "Nueva ficha: Tab-" + #100#5 + " Clave-" + #100#7 + &13 + &10;
        |XGRABA nHandle1, aGraba;
     |FINSI;
|FPRC;

|PROCESO Log;
     aAlfa = #100#14;
     |QBF aAlfa;
     aAlfa = aAlfa + " de " + aRegis;
     |PINTA 1738, aAlfa;
     aFicDef = #100#5; |QBF aFicDef;

     nOk = 0;

     |SI #100#3 = "C";
          |SI aTipoAnt ! "R32";
               nOk = 1;
          |FINSI;
          |SI #100#4 = "34";
               nOk = 1;
          |FINSI;
     |FINSI;

     |SI #100#3 = "R";
          |SI #100#4 = "32";
               nOk = 1;
          |FINSI;
          aTipoAnt = #100#3 + #100#4;
     |FINSI;


     |DFICE aFic;  |QBF aFic;

     |SI nOk = 0; |ACABA; |FINSI;

     nOk = 1;

     |SI nOk = 0; |ACABA; |FINSI;

     |SI aFicDef = aDefAnt; |Y nCarga = 0;
         |ACABA;
     |FINSI;

     |SI aFicDef ! aDefAnt;
         |SI nCarga = 1;
             |CIERRA #1;
             |DESCARGA_DEF #1;
             nCarga = 0;
         |FINSI;

         aDefAnt = aFicDef;

         aAlfa = aBase + "def/" +  aFicDef;
         |CARGA_DEF aAlfa, referen@;
         |SI FSalida ! 0;
             |ACABA;
         |FINSI;

         aQueQuiero = "|FICHERO";
         aAlfa      = #1#aQueQuiero# - aFic;
         |SI FSalida ! 0;
             aFichero = aFic;
         |SINO;
             |DBASE aFichero;
             aFichero = aFichero + "fich/";
         |FINSI;

         aQueQuiero = "|NC";
         aAlfa      = #1#aQueQuiero#;
         nNumCampos = aAlfa;
         nNumCampos = nNumCampos - 1;

         |PATH_DAT #1 aFic;

         nCarga = 1;
         ||BLIN 21; |PINTA 2102, aAlfa;

         |ABRE #1;
     |FINSI;

     nCampo   = #100#6;
     |SI nCampo > nNumCampos;  |ACABA;  |FINSI;

     |DDEFECTO #1;
     |HAZ LeeReg;

     |SI #100#3 = "C";               || Modifica campo
          nCampo   = #100#6;
          #1nCampo = #100#11;
          |GRABA 020#1a;

          aGraba = "Actualizacion: Tab-" + #100#5 + " Clave-" + #100#7 + " Campo-" + #100#6 + " Valor-" + #100#11 + &13 + &10;
          |XGRABA nHandle1, aGraba;
     |FINSI;
/*
     |SI #100#3 = "R"; |Y #100#4 = "32";
          |BORRA 000#1a;

          aGraba = "Borrado: Tab-" + #100#5 + " Clave-" + #100#7 + &13 + &10;
          |XGRABA nHandle, aGraba;
     |FINSI;
*/
     |LIBERA #1;

     nNume = #100#14 $ nIntervaloCorreo;
     aAlfa = #100#14;
     |SI nNume = 0;
          eaAsunto = "Número de líneas actualizadas: " + aAlfa;
          |HAZ Email;
     |FINSI;
|FPRC;

|DEFBUCLE Log;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Log;
|FIN;

|PROCESO Grabacion;
     aAbre = "/u/dsprofes/laboral/tablas/incidencias.txt";
     ||XABRE "CE", aAbre, nHandle1;     || esto si se pone que este en local
     |XABRE "E", aAbre, nHandle1;
     |SI FSalida ] 0;
          |RFBORRA aAbre;
     |FINSI;
     |XCIERRA nHandle1;

     |XABRE "W", aAbre, nHandle1;

     aRegis = nRegis;
     |QBF aRegis;

               ||  1  2         3         4         5         6
               ||  78901234567890123456789012345678901234567890
     |PINTA 1417, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿"
     |PINTA 1517, "³   Grabaci¢n de registros del log desde   ³"
     |PINTA 1617, "³            archivo temporal.             ³"
     |PINTA 1717, "³   Leyendo registro                       ³"
     |PINTA 1817, "³                                          ³"
     |PINTA 1917, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ"

     |DBASE aBase;
     |BUCLE Log;
     |SI nCarga = 1;
          |CIERRA #1;
          |DESCARGA_DEF #1;
     |FINSI;

     |XCIERRA nHandle1;

     aAlfa = #100#14;
     eaAsunto = "Fin de actualización de registros. Total registros leídos: " + aAlfa;
     |HAZ Email;
|FPRC;

|PROCESO Indexa;
     aLong   = aAlfa % 0;
     nLong   = aLong;
     aTab    = &9;
     aCadena = "";
     nCampo  = 0;

     aAlfa1  = aAlfa % 110;
     #100#0 = aAlfa1;

     aAlfa1  = (aAlfa % 1702) + "." + (aAlfa % 1502) + "." + (aAlfa % 1104);
     #100#1 = aAlfa1;

     aAlfa1      = aAlfa % 1908;
     #100#2 = aAlfa1;

     aAlfa1      = aAlfa % 2701;
     #100#3 = aAlfa1;

     aAlfa1      = aAlfa % 2802;
     #100#4 = aAlfa1;

     aAlfa1      = aAlfa % 3012;
     #100#5 = aAlfa1;

     aAlfa1      = aAlfa % 4203;
     #100#6 = aAlfa1;

     aAlfa1      = aAlfa % 4550;
     #100#7 = aAlfa1;

     aAlfa1      = aAlfa % 9517;
     #100#8 = aAlfa1;

     aAlfa1      = aAlfa % 11210;
     #100#9 = aAlfa1;

     aAlfa1       = aAlfa % 12250;
     #100#10 = aAlfa1;

     aAlfa1       = aAlfa % 17230;
     #100#11 = aAlfa1;

     aAlfa1       = aAlfa % 20230;
     #100#12 = aAlfa1;

     nRegis = nRegis + 1;
     #100#14 = nRegis;

     aAlfa = nRegis;
     |PINTA 1738, aAlfa;

     nNume = nRegis $ nIntervaloCorreo;
     |SI nNume = 0;
          eaAsunto = "Número de líneas leídas: " + aAlfa;
          |HAZ Email;
     |FINSI;

     |GRABA 020#100n;
     |LIBERA #100;
|FPRC;

|PROCESO IndexaTxt;
     nRegis = 0;
     aPath = #0#0; |QBF aPath;
     aAbre  = aPath;
     |XABRE "U", aAbre, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

               ||  1  2         3         4         5         6
               ||  78901234567890123456789012345678901234567890
     |PINTA 1417, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿"
     |PINTA 1517, "³   Realizando lectura de l¡neas del log   ³"
     |PINTA 1617, "³     y grabaci¢n de archivo temporal.     ³"
     |PINTA 1717, "³             L¡nea:                       ³"
     |PINTA 1817, "³                                          ³"
     |PINTA 1917, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ"

     |PARA; |SI nRegis [ nLimiteLineas; |HACIENDO;
          |XLEE nHandle, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;
          |QBF aAlfa;

          |HAZ Indexa;
     |SIGUE;

     |XCIERRA nHandle;
|FPRC;

|PROCESO Indexado;
     |DBASE aPath;  |QBF aPath;
     aPath = aPath + "fich/";

     |PATH_DAT #100 aPath;
     |NOME_DAT #100 "ficlog";
     aDefAnt = "";
     nCarga  = 0;

     |ABRE #100; |CIERRA #100; |DELINDEX #100;

     |ABRE #100;

     |HAZ IndexaTxt;

     |CONSULTA_CLAVE #1#100;

     aAlfa = nRegis;
     eaAsunto = "Final de lectura de líneas. Total de líneas leídas: " + aAlfa;
     |HAZ Email;

     |CIERRA #100;
|FPRC;

|PROGRAMA;
     |CLS;

     #0#0 = "/u/dspi/laboral/tablas/log.txt";

     |PINPA #0#0;
     |PINDA #0#0;
     ||ENDATOS #1#0;
     || al final pongo el archivo en el servidor para que todo vaya mucho
     || mas rapido, lo pongo a pelo
     FSalida = 0;
     |SI FSalida = 0;
          |HAZ Indexado;
          |HAZ Grabacion;
     |FINSI;
|FPRO;
