|FICHEROS;
     hotm0042;
     hotm0038;
     hotm0039;
     hotm0040;
     labtraba;
     hotm0013;
     hotm0047; ||Tmp de Usuarios
|FIN;

|VARIABLES;
     aUsrD = "";
     aUsrH = "";
     nSal = 0;
     nPara = 0;
     nHandle = 0;

     nLinea = 0;
     aAlfa = "";
     aBase = "";
     aOrigen = "";
     aDestinoTrab = "";
     aDestino = "";
     aIPRemoto = "";
     {1}aVersion      = "";
     aPath = "";
     aLongitud = "";
     nLongitud = 0;
     nPos = 0;
     nCaracter = 0;
     aCaracter = "";

     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     nPara1 = 0;
     nPara2 = 0;
     nPara3 = 0;
     nPara4 = 0;
     fFech1 = @;
     fFech2 = @;
     fFech3 = @;
     fFech4 = @;
     nFEstado = 0;
     nSeleccio = 0;
     nModo = 0;

     nAntEmpre = 0;
     nAntTraba = 0;
     &enSwTotal = 0;
     &enTot1 = 0;
     &enTot2 = 0;
     &enTot3 = 0;
     &enTot4 = 0;
     &enSwGrp = 0;

     aMesDesde = "";
     aAnyDesde = "";
     aFechaDesde = "";
     fFechaDesde = @;
     aMesHasta = "";
     aAnyHasta = "";
     aFechaHasta = "";
     fFechaHasta = @;
     aMes = "";
     aAny = "";
     aFecha = "";
     fFecha = @;
     swNoVale = 0;

     aUsr = "";
     aUsrAnt = "";
     nSwSis = 0;
|FIN;
____________________________________/
|PROCESO Defecto; |TIPO 7;    || calcula el a¤o por defecto segun sistema
     fFech1 = ~;
     aAlfa1 = fFech1;
     aAlfa1 = aAlfa1 % -104;
     #hotm0042#Campo# = aAlfa1;
     |PINTA #hotm0042#Campo#;
|FPRC;

|PROCESO Mirames; |TIPO 7;    || calcula el mes por defecto segun sistema
     fFech1 = ~;
     aAlfa1 = fFech1;
     aAlfa1 = aAlfa1 % 402;
     #hotm0042#Campo# = aAlfa1;
     |PINTA #hotm0042#Campo#;
|FPRC;
____________________________________/
|PROCESO Fechas;
     swNoVale = 0;

     aMesDesde = #hotm0042#5;
     aMesDesde = "00" + aMesDesde;
     aMesDesde = aMesDesde % -102;
     aAnyDesde = #hotm0042#4;
     aFechaDesde = "01" + "." + aMesDesde + "." + aAnyDesde;
     fFechaDesde = aFechaDesde;

     aMesHasta = #hotm0042#9;
     aMesHasta = "00" + aMesHasta;
     aMesHasta = aMesHasta % -102;
     aAnyHasta = #hotm0042#10;
     aFechaHasta = "01" + "." + aMesHasta + "." + aAnyHasta;
     fFechaHasta = aFechaHasta;

     aMes = #hotm0040#3;
     aMes = "00" + aMes;
     aMes = aMes % -102;
     aAny = #hotm0040#2;
     aFecha = "01" + "." + aMes + "." + aAny;
     fFecha = aFecha;

     |SI fFecha < fFechaDesde; |O fFecha > fFechaHasta;
          swNoVale = 1;
     |FINSI;
|FPRC;

|PROCESO hotm0040;
/*
     |SI #hotm0042#11 = "S";
          aUsr = #hotm0040#10;     |QBF aUsr;
          |SI aUsr ! aUsrAnt; |Y nSwSis = 1;
               |PIEINF;
          |FINSI;
          aUsrAnt = #hotm0040#10;  |QBF aUsrAnt;
          nSwSis = 1;
     |FINSI;
*/
     |HAZ Fechas;
     |SI swNoVale = 1;
          |ACABA;
     |FINSI;
     #hotm0039#0 = #hotm0040#0;
     #hotm0039#1 = #hotm0040#1;
     #hotm0039#2 = #hotm0040#2;
     #hotm0039#3 = #hotm0040#3;
     |LEE 000#hotm0039.=;
     |SI FSalida = 0;              || si existe la cabecera
          #hotm0038#0 = #hotm0040#4;
          |LEE 000#hotm0038.=;
          |SI FSalida = 0;
               |SI nAntEmpre = 0;|Y nAntTraba = 0;
                    nAntEmpre = #hotm0040#0;
                    nAntTraba = #hotm0040#1;
               |FINSI;
               |SI nAntEmpre ! #hotm0040#0;|O nAntTraba ! #hotm0040#1;
                    |DDEFECTO #labtraba;
                    #labtraba#0 = nAntEmpre;
                    #labtraba#1 = nAntTraba;
                    |LEE 000#labtraba.=;
                    enSwTotal = 1;
                    |DDEFECTO #hotm0013;
                    #hotm0013#0 = #labtraba#0;
                    #hotm0013#1 = #labtraba#1;
                    #hotm0013#2 = 1;
                    |LEE 000#hotm0013.];
                    |SI FSalida = 0;|Y #hotm0013#0 = #labtraba#0;|Y #hotm0013#1 = #labtraba#1;
                         || leido
                    |SINO;
                         |DDEFECTO #hotm0013;
                         #hotm0013#4 = "Sin asignar";
                    |FINSI;
                    |PRINT;
                    enTot1 = 0;
                    enTot2 = 0;
                    enTot3 = 0;
                    enTot4 = 0;
                    nAntEmpre = #hotm0040#0;
                    nAntTraba = #hotm0040#1;
               |FINSI;

     |SI #hotm0042#11 = "S";
          aUsr = #hotm0040#10;     |QBF aUsr;
          |SI aUsr ! aUsrAnt; |Y nSwSis = 1;
               |PIEINF;
          |FINSI;
          aUsrAnt = #hotm0040#10;  |QBF aUsrAnt;
          nSwSis = 1;
     |FINSI;

               |SI #hotm0042#8 = "D";
                    enSwTotal = 0; |PRINT;
               |FINSI;

               enTot1 = enTot1 + #hotm0040#6;
               enTot4 = enTot4 + #hotm0040#7;
               enTot2 = enTot2 + #hotm0040#8;
               enTot3 = enTot3 + #hotm0040#9;

               nSeleccio = 1;
          |FINSI;
     |FINSI;

|FPRC;

|DEFBUCLE hotm0040;
     #hotm0040#1;
     ;
     #hotm0042#0, #hotm0042#2,  #hotm0042#4, 01, #hotm0042#6;
     #hotm0042#1, #hotm0042#3, #hotm0042#10, 12, #hotm0042#7;
     ;
     NULL, hotm0040;
|FIN;

|DEFBUCLE hotm0040_w2;
     #hotm0040#2;
     ;
     aUsrD, #hotm0042#0, #hotm0042#2,  #hotm0042#4, 01, #hotm0042#6;
     aUsrH, #hotm0042#1, #hotm0042#3, #hotm0042#10, 12, #hotm0042#7;
     ;
     NULL, hotm0040;
|FIN;

/*|DEFBUCLE hotm0040;
     #hotm0040#1;
     ;
     #hotm0042#0, #hotm0042#2, #hotm0042#4, #hotm0042#5, #hotm0042#6;
     #hotm0042#1, #hotm0042#3, #hotm0042#4, #hotm0042#9, #hotm0042#7;
     ;
     NULL, hotm0040;
|FIN;*/

|PROCESO Tipo3; |TIPO 3;
  |SI #hotm0042#8 = "X";
     |HAZ ImpreExcel;
  |SINO;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "hotm0042";
          |SI FSalida = 0;
               |ABRE #hotm0013;
               |ABRE #hotm0038;
               |ABRE #hotm0039;
               |ABRE #labtraba;
               |SI #hotm0042#11 = "N";
                    |BUCLE hotm0040;
               |FINSI;

               |SI #hotm0042#11 = "S";
                    aUsrD = "          ";
                    aUsrH = "zzzzzzzzzz";

                    nSwSis = 0;
                    |SI #hotm0040#8 = "D"; enSwGrp = 1; |FINSI;
                    |BUCLE hotm0040_w2;
               |FINSI;

               |SI #hotm0042#11 = "P";
                    |PARA nPara = 12; |SI nPara < 22; |HACIENDO nPara = nPara + 1;
                         aAlfa = #hotm0042#nPara#;     |QBF aAlfa;
                         |SI aAlfa ! "";
                              aUsrD = #hotm0042#nPara#;
                              aUsrH = #hotm0042#nPara#;
                              nSwSis = 0;
                              |SI #hotm0040#8 = "D"; enSwGrp = 1; |FINSI;
                              |BUCLE hotm0040_w2;
                         |FINSI;
                    |SIGUE;
               |FINSI;

               |SI nSeleccio = 0;
                    |MENAV "0000Seleccion vacia.";
               |SINO;
                    |DDEFECTO #labtraba;
                    #labtraba#0 = nAntEmpre;
                    #labtraba#1 = nAntTraba;
                    |LEE 000#labtraba.=;
                    enSwTotal = 1;
                    |DDEFECTO #hotm0013;
                    #hotm0013#0 = #labtraba#0;
                    #hotm0013#1 = #labtraba#1;
                    #hotm0013#2 = 1;
                    |LEE 000#hotm0013.];
                    |SI FSalida = 0;|Y #hotm0013#0 = #labtraba#0;|Y #hotm0013#1 = #labtraba#1;
                         || leido
                    |SINO;
                         |DDEFECTO #hotm0013;
                         #hotm0013#4 = "Sin asignar";
                    |FINSI;
                    |PRINT;
                    |PIEINF;
               |FINSI;
               |CIERRA #hotm0013;
               |CIERRA #hotm0038;
               |CIERRA #hotm0039;
               |CIERRA #labtraba;
          |SINO;
               |MENAV "0000Informe [hotm0042] inaccesible o inexistente.";
          |FINSI;
          |FININF;
     |SINO;
          |MENAV "0000Proceso abortado.";
     |FINSI;
     |FINIMP;
  |FINSI;
|FPRC;

|PROCESO hotm0040xls;
     nLinea = nLinea + 1;
     aAlfa = "A" + nLinea + "," + #hotm0040#10; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "B" + nLinea + "," + #hotm0040#3; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "C" + nLinea + "," + #hotm0040#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "D" + nLinea + "," + #hotm0040#0; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "E" + nLinea + "," + #hotm0040#1; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     ||Nombre Trabajador
     #labtraba#0 = #hotm0040#0;
     #labtraba#1 = #hotm0040#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          aAlfa = "F" + nLinea + "," + #labtraba#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     ||Centro de Costo
     |DDEFECTO #hotm0013;
     #hotm0013#0 = #hotm0040#0;
     #hotm0013#1 = #hotm0040#1;
     #hotm0013#2 = 1;
     |LEE 000#hotm0013.];
     |SI FSalida = 0;|Y #hotm0013#0 = #hotm0040#0;|Y #hotm0013#1 = #hotm0040#1;
          || leido
     |SINO;
          |DDEFECTO #hotm0013;
          #hotm0013#4 = "Sin asignar";
     |FINSI;

     aAlfa = "G" + nLinea + "," + #hotm0013#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "H" + nLinea + "," + #hotm0040#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "I" + nLinea + "," + #hotm0040#5; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "J" + nLinea + "," + #hotm0040#7; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "K" + nLinea + "," + #hotm0040#6; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|DEFBUCLE hotm0040xls;
     #hotm0040#1;
     ;
     #hotm0042#0, #hotm0042#2,  #hotm0042#4, 01, #hotm0042#6;
     #hotm0042#1, #hotm0042#3, #hotm0042#10, 12, #hotm0042#7;
     ;
     NULL, hotm0040xls;
|FIN;

|DEFBUCLE hotm0040_w2xls;
     #hotm0040#2;
     ;
     aUsrD, #hotm0042#0, #hotm0042#2,  #hotm0042#4, 01, #hotm0042#6;
     aUsrH, #hotm0042#1, #hotm0042#3, #hotm0042#10, 12, #hotm0042#7;
     ;
     NULL, hotm0040xls;
|FIN;

|PROCESO CabeceraXLS;
     nLinea = 1;
     aAlfa = "A" + nLinea + ",Usuario"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "B" + nLinea + ",Mes"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "C" + nLinea + ",A¤o"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "D" + nLinea + ",Empresa"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "E" + nLinea + ",Cod. Trab"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "F" + nLinea + ",Trabajador"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "G" + nLinea + ",Centro de Costo"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "H" + nLinea + ",Tipo"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "I" + nLinea + ",Concepto"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "J" + nLinea + ",Unidad"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "K" + nLinea + ",Total"; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|PROCESO ImpreExcel;
     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
          |MENAV "0000No se puede usar la DLL de Excel.";
          |ACABA;
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen = aBase + "pdf/dias_libres.xls";
     aDestinoTrab = "C:\DOCUMENTOS";         |RMKDIR aDestino;
     aDestino = aDestinoTrab + "\trabajo.xls";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |ALFACALLDLL "agixl97.dll", "carga_book", aDestino;
     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "DIAS LIBRES";

     |HAZ CabeceraXLS;

     |ABRE #hotm0013;
     |ABRE #labtraba;
     |SI #hotm0042#11 = "S";
          aUsrD = "          ";
          aUsrH = "zzzzzzzzzz";
          |BUCLE hotm0040_w2xls;
     |FINSI;

     |SI #hotm0042#11 = "N";
          |BUCLE hotm0040xls;
     |FINSI;

     |SI #hotm0042#11 = "P";
          |PARA nPara = 12; |SI nPara < 22; |HACIENDO nPara = nPara + 1;
               aAlfa = #hotm0042#nPara#;     |QBF aAlfa;
               |SI aAlfa ! "";
                    aUsrD = #hotm0042#nPara#;
                    aUsrH = #hotm0042#nPara#;
                    |BUCLE hotm0040_w2xls;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #hotm0013;
     |CIERRA #labtraba;

     aAlfa = aDestinoTrab + "\dias_libres.xls";
     |RFBORRA aAlfa;

     |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
     |DESCARGADLL "agixl97.dll";

     aDestino   = aDestinoTrab + "\trabajo.xls";
     |RFBORRA aDestino;

     aVersion1 = "Excel.Sheet";
     |ESPECIFICA "VERSION_PROGRAMA", aVersion;
     |HAZ ExtraePath;
     |SI aPath = "NO LOCALIZADO";
         |MENAV "0000 No puedo encontrar automaticamente la Excel";
         |ACABA;
     |FINSI;

     |QBF aPath;

     aAlfa  = "cmd " + &34 + "/c START /WAIT " + aPath + " " + aAlfa + &34;
     |RSYSTEM aAlfa;
|FPRC;

|PROCESO ExtraePath;
     aPath     = aVersion1;
     aLongitud = aPath % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
           nCaracter = (nPos * 100) + 1;
           aCaracter = aPath % nCaracter;
           |SI aCaracter = ",";
               nPos = nLongitud - nPos;
               nPos = nPos + 100;
               nPos = (-1) * nPos;
               aPath = aPath % nPos;
               |SAL;
          |FINSI;
     |SIGUE;

     aPath = aPath - "[";
     aPath = aPath - "]";
     |QBF aPath;
|FPRC;

|PROCESO CargaUsu;
     |ABRE #hotm0047;
     |CIERRA #hotm0047;
     |DELINDEX #hotm0047;

     nSal = 1;
     |DBASS aAlfa;
     aAlfa = aAlfa + "dev/usr/ds_sys.psw";
     |XABRE "", aAlfa, nHandle;
     |SI FSalida = 0;
          |ABRE #hotm0047;
          |XLEE nHandle, 200, aAlfa;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               nSal = 0;
               #hotm0047#0 = aAlfa % 410;
               |GRABA 000#hotm0047.n;
               |XLEE nHandle, 200, aAlfa;
          |SIGUE;
          |CIERRA #hotm0047;
          |XCIERRA nHandle;
     |FINSI;
     FSalida = nSal;
|FPRC;

|PROCESO Parrilla;
     |SI #hotm0042#11 = "P";
          |HAZ CargaUsu;
          |BLANCO 0855 2068;
          |CUADRO 0955 2068;
          |ATRI R;
          |PINTA 0857, " Usuarios ";
          |ATRI 0;
          |PARA nPara = 12; |SI nPara < 22; |HACIENDO nPara = nPara + 1;
               |C_M #hotm0042#nPara#, 1, "S";
               |C_V #hotm0042#nPara#, 1, "S";
               |PINTA #hotm0042#nPara#;
          |SIGUE;
     |SINO;
          |BLANCO 0855 2068;
          |PARA nPara = 12; |SI nPara < 22; |HACIENDO nPara = nPara + 1;
               |C_M #hotm0042#nPara#, 1, "N";
               |C_V #hotm0042#nPara#, 1, "N";
               |PINTA #hotm0042#nPara#;
          |SIGUE;
     |FINSI;
|FPRC;

|PROGRAMA
     |CLS;
     |CABEZA "Informe Dias Libres";
     |PARA nPara = 12; |SI nPara < 22; |HACIENDO nPara = nPara + 1;
          |C_M #hotm0042#nPara#, 1, "N";
          |C_V #hotm0042#nPara#, 1, "N";
          |PINTA #hotm0042#nPara#;
     |SIGUE;
     |PINPA #0#hotm0042;
     |PINDA #0#hotm0042;

     |ENDATOS #1#hotm0042;
     |SI FSalida = 0;
          |HAZ Tipo3;
     |FINSI;
|FPRO;
