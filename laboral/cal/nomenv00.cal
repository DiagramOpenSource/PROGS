|FICHEROS;
     nomenv00 #0;
     nomenv01,MANTE;
     nomenv02,MANTE;
     nomenv03,MANTE;
     nomenv04,MANTE;
     nomenv05,MANTE;

     labempre;
     labcentr;
     labtraba;

     nomenvme;
|FIN;

|VARIABLES;
     fFecha = @;
     aFecha = "";
     aAlfa = "";
     nNume = 0;

     nOpcion = 0;
     {-1}menu = "";
     menu1 = "2400";
     menu2 = "1";
     menu3 = "Elegir Opcion:";
     menu4 = "ERS";
     menu5 = "Enviar Nóminas por Email";
     menu6 = "Volver al Lineal";
     menu7 = "Salir";

     swActivoUno = 0;
     swPorEmpresa = 0;
     swPorCentro = 0;
     &swPorTrabajador = 0;
     nModo = 0;
     swActCentro = 0;
     swActTraba = 0;
     &nDocs = 0;
     &eaEmail = "";
     nDesdeEmpresa = 0;
     nHastaEmpresa = 0;
     nDesdeActivo = "";
     nHastaActivo = "";
     swAct = 0;
     nEmp = 0;
     nTra = 0;
     nCen = 0;
     &enSwNominaEmpCen = 0;
     &nArchi = 0;
     swNoAct = 0;
     &nMes = 0;
     &aMes = 0;
     &swAlMenosUno = 0;
     &nDesdeTipo = 0;
     &nHastaTipo = 0;
     &nDesdeMes = 0;
     &nHastaMes = 0;
     &enDesdeMod = 0;
     &enHastaMod = 0;
     &eaEmailCen = "";
     &eaEmailTra = "";
|FIN;

|PROCESO PintaMes;
     nMes = #0#0;
     |HAZ MesLetra_plb;
     |ATRI I;
     aMes = aMes + "            ";
     aMes = aMes % 110;
     |PINTA 0720, aMes;
     |ATRI 0;
|FPRC;

|PROCESO EnviaCorreo;
     ||MENAV "    Envio de correos";
     swAlMenosUno = 0;
     |HAZ MiraSiImpreDsPDF;
     |HAZ Correos;
     |SI swAlMenosUno = 1;
          aAlfa = "    Se han realizado los envíos de correo solicitados.";
     |SINO;
          aAlfa = "    No se han encontrado nóminas para enviar. Revise la selección.";
     |FINSI;
     |MENAV aAlfa;
|FPRC;

|PROCESO MarcaSI_tra;
     aAlfa = #nomenv04#3;
     |QBF aAlfa;
     |SI aAlfa ! "";
          #nomenv04#4 = "**";
          |PINTA #nomenv04#4;
     |SINO;
          #nomenv04#4 = "  ";
          |PINTA #nomenv04#4;
     |FINSI;
|FPRC;

|PROCESO CompEmail_tra;
     eaEmail = #nomenv03#Campo#;
     |HAZ CompEmail_plb;
|FPRC;

|PROCESO MarcaSI_cen;
     aAlfa = #nomenv03#3;
     |QBF aAlfa;
     |SI aAlfa ! "";
          #nomenv03#4 = "**";
          |PINTA #nomenv03#4;
     |SINO;
          #nomenv03#4 = "  ";
          |PINTA #nomenv03#4;
     |FINSI;
|FPRC;

|PROCESO CompEmail_cen;
     eaEmail = #nomenv03#Campo#;
     |HAZ CompEmail_plb;
|FPRC;

|PROCESO CompEmail_emp;
     eaEmail = #nomenv02#Campo#;
     |HAZ CompEmail_plb;
|FPRC;

|PROCESO ActTodasEmp;
     |SI swAct = 0;
          #nomenv01#6 = "  ";
     |FINSI;
     |SI swAct = 1;
          #nomenv01#6 = "**";
     |FINSI;
     |PINTA #nomenv01#6;
     |GRABA 020#nomenv01.a;
     |LIBERA #nomenv01;
|FPRC;

|DEFBUCLE ActTodasEmp;
     #nomenv01#1;
     ;
     00001;
     99999;
     be;
     NULL, ActTodasEmp;
|FIN;

|PROCESO ActivarEmpresa; |TIPO 11;
     |SI FSalida = 13;
          |SI #nomenv01#6 = "**";
               #nomenv01#6 = "  ";
               |PINTA #nomenv01#6;
               |GRABA 020#nomenv01.a;
               |LIBERA #nomenv01;
          |SINO;
               |SI #nomenv01#6 = "  ";
                    #nomenv01#6 = "**";
                    |PINTA #nomenv01#6;
                    |GRABA 020#nomenv01.a;
                    |LIBERA #nomenv01;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI FSalida = 15;
          nEmp = #nomenv01#0;
          swAct = 1;
          swNoAct = 0;
          |BUCLE ActTodasEmp;
          #nomenv01#0 = nEmp;
          |LEE 000#nomenv01.=;
          |PONCONTROL 23, "si";
     |FINSI;
     |SI FSalida = 16;
          nEmp = #nomenv01#0;
          swAct = 0;
          |BUCLE ActTodasEmp;
          #nomenv01#0 = nEmp;
          |LEE 000#nomenv01.=;
          |PONCONTROL 23, "si";
     |FINSI;
|FPRC;

|PROCESO NombreCentro; |TIPO 7;
     |ABRE #labcentr;
     #labcentr#0 = #nomenv03#0;
     #labcentr#1 = #nomenv03#1;
     |LEE 000#labcentr.=;
     |SI FSalida = 0;
          #nomenv03#2 = #labcentr#2;
          |PINTA #nomenv03#2;
     |FINSI;
     |CIERRA #labcentr;
|FPRC;

|PROCESO ActTodosCen;
     |SI swAct = 0;
          #nomenv03#4 = "  ";
     |FINSI;
     |SI swAct = 1;
          aAlfa = #nomenv03#3;
          |QBF aAlfa;
          |SI aAlfa ! "";
               #nomenv03#4 = "**";
          |SINO;
               swNoAct = 1;
          |FINSI;
     |FINSI;
     |PINTA #nomenv03#4;
     |GRABA 020#nomenv03.a;
     |LIBERA #nomenv03;
|FPRC;

|DEFBUCLE ActTodosCen;
     #nomenv03#1;
     ;
     #nomenv01#0, 001;
     #nomenv01#0, 999;
     be;
     NULL, ActTodosCen;
|FIN;

|PROCESO ActivarCentro; |TIPO 11;
     |SI FSalida = 13;
          |SI #nomenv03#4 = "**";
               #nomenv03#4 = "  ";
               |PINTA #nomenv03#4;
               |GRABA 020#nomenv03.a;
               |LIBERA #nomenv03;
          |SINO;
               |SI #nomenv03#4 = "  ";
                    aAlfa = #nomenv03#3;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         #nomenv03#4 = "**";
                         |PINTA #nomenv03#4;
                         |GRABA 020#nomenv03.a;
                         |LIBERA #nomenv03;
                    |SINO;
                         |MENAV "    Debe introducir una dirección de email para poder activar el envío en este centro";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI FSalida = 15;
          nEmp = #nomenv03#0;
          nCen = #nomenv03#1;
          swAct = 1;
          swNoAct = 0;
          |BUCLE ActTodosCen;
          #nomenv03#0 = nEmp;
          #nomenv03#1 = nCen;
          |LEE 000#nomenv03.=;
          |PONCONTROL 23, "si";
          |SI swNoAct = 1;
               aAlfa = "    Existen centros con la dirección de email en blanco ";
               aAlfa = aAlfa + "que no han sido activados.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |SI FSalida = 16;
          nEmp = #nomenv03#0;
          nCen = #nomenv03#1;
          swAct = 0;
          |BUCLE ActTodosCen;
          #nomenv03#0 = nEmp;
          #nomenv03#1 = nCen;
          |LEE 000#nomenv03.=;
          |PONCONTROL 23, "si";
     |FINSI;
|FPRC;

|PROCESO NombreTrab; |TIPO 7;
     |ABRE #labtraba;
     #labtraba#0 = #nomenv04#0;
     #labtraba#1 = #nomenv04#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          #nomenv04#2 = #labtraba#2;
          |PINTA #nomenv04#2;
     |FINSI;
     |CIERRA #labtraba;
|FPRC;

|PROCESO ActTodosTrab;
     |SI swAct = 0;
          #nomenv04#4 = "  ";
     |FINSI;
     |SI swAct = 1;
          aAlfa = #nomenv04#3;
          |QBF aAlfa;
          |SI aAlfa ! "";
               #nomenv04#4 = "**";
          |SINO;
               swNoAct = 1;
          |FINSI;
     |FINSI;
     |PINTA #nomenv04#4;
     |GRABA 020#nomenv04.a;
     |LIBERA #nomenv04;
|FPRC;

|DEFBUCLE ActTodosTrab;
     #nomenv04#1;
     ;
     #nomenv01#0, 00001;
     #nomenv01#0, 99999;
     be;
     NULL, ActTodosTrab;
|FIN;

|PROCESO ActivarTraba; |TIPO 11;
     |SI FSalida = 13;
          |SI #nomenv04#4 = "**";
               #nomenv04#4 = "  ";
               |PINTA #nomenv04#4;
               |GRABA 020#nomenv04.a;
               |LIBERA #nomenv04;
          |SINO;
               |SI #nomenv04#4 = "  ";
                    aAlfa = #nomenv04#3;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         #nomenv04#4 = "**";
                         |PINTA #nomenv04#4;
                         |GRABA  020#nomenv04.a;
                         |LIBERA #nomenv04;
                    |SINO;
                         |MENAV "    Debe introducir una dirección de email para poder activar el envío en este trabajador";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI FSalida = 15;
          nEmp = #nomenv04#0;
          nTra = #nomenv04#1;
          swAct = 1;
          swNoAct = 0;
          |BUCLE ActTodosTrab;
          #nomenv04#0 = nEmp;
          #nomenv04#1 = nTra;
          |LEE 000#nomenv04.=;
          |PONCONTROL 23, "si";
          |SI swNoAct = 1;
               aAlfa = "    Existen trabajadores con la dirección de email en blanco ";
               aAlfa = aAlfa + "que no han sido activados.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |SI FSalida = 16;
          nEmp = #nomenv04#0;
          nTra = #nomenv04#1;
          swAct = 0;
          |BUCLE ActTodosTrab;
          #nomenv04#0 = nEmp;
          #nomenv04#1 = nTra;
          |LEE 000#nomenv04.=;
          |PONCONTROL 23, "si";
     |FINSI;
|FPRC;

|PROCESO act_labtraba;
     #labtraba#0 = #nomenv04#0;
     #labtraba#1 = #nomenv04#1;
     |LEE 101#labtraba.=;
     |SI FSalida = 0;
          #labtraba#127 = #nomenv04#3;
          aAlfa = #nomenv04#3;
          |GRABA 020#labtraba.a;

          |QBF aAlfa;
          |SI #nomenv04#4 = "**"; |Y aAlfa ! "";
               swActivoUno = 1;
               |SI swActTraba = 1;
                    #labtraba#128 = "S";
                    |GRABA 020#labtraba.a;
               |FINSI;
          |SINO;
               |SI swActTraba = 1;
                    #labtraba#128 = "N";
                    |GRABA 020#labtraba.a;
               |FINSI;
          |FINSI;
          |LIBERA #labtraba;
     |FINSI;
|FPRC;

|DEFBUCLE act_labtraba;
     #nomenv04#1;
     ;
     #nomenv01#0, 00001;
     #nomenv01#0, 99999;
     ;
     NULL, act_labtraba;
|FIN;

|PROCESO inf_nomenv04;
     #nomenv04#0 = #nomenv01#0;
     #nomenv04#1 = 00001;
|FPRC;

|PROCESO sup_nomenv04;
     #nomenv04#0 = #nomenv01#0;
     #nomenv04#1 = 99999;
|FPRC;

|PROCESO EditaTraba;
     |SI FSalida = 13;
          |SI #nomenv01#Campo# = "SI";
               #nomenv01#Campo# = "NO";
          |SINO;
               |SI #nomenv01#Campo# = "NO"; |O #nomenv01#Campo# = "  ";
                    #nomenv01#Campo# = "SI";
               |FINSI;
          |FINSI;
          |PINTA #nomenv01#Campo#;
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |PUSHV 06062279;
          |BLANCO 07072279;

          |ENTLINEAL #1#nomenv04, -1, 2, 21, 1, inf_nomenv04, sup_nomenv04;

          swActCentro = 0;
          aAlfa = "    S¿Desea conservar la configuración actual del envío ";
          aAlfa = aAlfa + "de nóminas a los trabajadores?"
          |CONFI aAlfa;
          |SI FSalida = 0;
               swActTraba = 1;
          |FINSI;

          |ABRE #labtraba;
          swActivoUno = 0;
          |BUCLE act_labtraba;
          |CIERRA #labtraba;

          |POPV;

          |SI swActivoUno = 1;
               #nomenv01#5 = "SI";
          |SINO;
               #nomenv01#5 = "NO";
          |FINSI;
          |PINTA #nomenv01#5;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO act_labcentr;
     #labcentr#0 = #nomenv03#0;
     #labcentr#1 = #nomenv03#1;
     |LEE 101#labcentr.=;
     |SI FSalida = 0;
          #labcentr#25 = #nomenv03#3;
          aAlfa = #nomenv03#3;
          |GRABA 020#labcentr.a;

          |QBF aAlfa;
          |SI #nomenv03#4 = "**"; |Y aAlfa ! "";
               swActivoUno = 1;
               |SI swActCentro = 1;
                    #labcentr#26 = "S";
                    |GRABA 020#labcentr.a;
               |FINSI;
          |SINO;
               |SI swActCentro = 1;
                    #labcentr#26 = "N";
                    |GRABA 020#labcentr.a;
               |FINSI;
          |FINSI;
          |LIBERA #labcentr;
     |FINSI;
|FPRC;

|DEFBUCLE act_labcentr;
     #nomenv03#1;
     ;
     #nomenv01#0, 001;
     #nomenv01#0, 999;
     ;
     NULL, act_labcentr;
|FIN;

|PROCESO inf_nomenv03;
     #nomenv03#0 = #nomenv01#0;
     #nomenv03#1 = 001;
|FPRC;

|PROCESO sup_nomenv03;
     #nomenv03#0 = #nomenv01#0;
     #nomenv03#1 = 999;
|FPRC;

|PROCESO EditaCentro;
     |SI FSalida = 13;
          |SI #nomenv01#Campo# = "SI";
               #nomenv01#Campo# = "NO";
          |SINO;
               |SI #nomenv01#Campo# = "NO"; |O #nomenv01#Campo# = "  ";
                    #nomenv01#Campo# = "SI";
               |FINSI;
          |FINSI;
          |PINTA #nomenv01#Campo#;
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |PUSHV 06062279;
          |BLANCO 07072279;

          |HAZ AltaCentros;
          |ENTLINEAL #1#nomenv03, -1, 2, 21, 1, inf_nomenv03, sup_nomenv03;

          swActCentro = 0;
          aAlfa = "    S¿Desea conservar la configuración actual del envío ";
          aAlfa = aAlfa + "de nóminas a los centros?"
          |CONFI aAlfa;
          |SI FSalida = 0;
               swActCentro = 1;
          |FINSI;

          |ABRE #labcentr;
          swActivoUno = 0;
          |BUCLE act_labcentr;
          |CIERRA #labcentr;

          |POPV;

          |SI swActivoUno = 1;
               #nomenv01#4 = "SI";
          |SINO;
               #nomenv01#4 = "NO";
          |FINSI;
          |PINTA #nomenv01#4;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO EditaEmpresa;
     |SI FSalida = 13;
          |SI #nomenv01#Campo# = "SI";
               #nomenv01#Campo# = "NO";
          |SINO;
               |SI #nomenv01#Campo# = "NO"; |O #nomenv01#Campo# = "  ";
                    #nomenv01#Campo# = "SI";
               |FINSI;
          |FINSI;
          |PINTA #nomenv01#Campo#;
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |ABRE #labempre;
          #labempre#0 = #nomenv01#0;
          |LEE 101#labempre.=;
          |SI FSalida = 0;
               |DDEFECTO #nomenv02;
               |ABRE #nomenv02;
               #nomenv02#0 = #labempre#0;
               |LEE 101#nomenv02.=;
               |SI FSalida ! 0;
                    #nomenv02#0 = #labempre#0;
                    #nomenv02#1 = #labempre#2;
                    #nomenv02#2 = #labempre#130;
                    || #nomenv02#3 = #labempre#131;
                    |GRABA 020#nomenv02.n;

                    #nomenv02#0 = #labempre#0;
                    |LEE 101#nomenv02.=
               |FINSI;

               |PUSHV 08141872;
               |BLANCO 09151771;
               |PINPA #0#nomenv02;
               |PINDA #0#nomenv02;
               |ENDATOS #2#nomenv02;
               |POPV;
               |SI FSalida = 0;
                    |GRABA 020#nomenv02.a;
                    |LIBERA #nomenv02;

                    #labempre#130 = #nomenv02#2;
                    #labempre#131 = #nomenv02#3;
                    |GRABA 020#labempre.a;
                    |LIBERA #labempre;

                    aAlfa = #nomenv02#2;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         #nomenv01#3 = "SI";
                    |SINO;
                         #nomenv01#3 = "NO";
                    |FINSI;

                    |PINTA #nomenv01#3;
               |SINO;
                    |LIBERA #nomenv02;
               |FINSI;
               |CIERRA #nomenv02;
          |FINSI;
          |CIERRA #labempre;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO inf_nomenv05;
     #nomenv05#0 = #nomenv01#0;
     #nomenv05#1 = 000000001;
|FPRC;

|PROCESO sup_nomenv05;
     #nomenv05#0 = #nomenv01#0;
     #nomenv05#1 = 999999999;
|FPRC;

|PROCESO comp_resumen;
     aAlfa = #nomenv05#5;
     |QBF aAlfa;
     |SI #nomenv05#5 = "**"; |Y aAlfa ! "";
          swActivoUno = 1;
     |FINSI;
|FPRC;

|DEFBUCLE comp_resumen;
     #nomenv05#1;
     ;
     #nomenv01#0, 000000001;
     #nomenv01#0, 999999999;
     ;
     NULL, comp_resumen;
|FIN;

|PROCESO ActivarResumen; |TIPO 11;
     |SI FSalida = 13;
          |SI #nomenv05#5 = "**";
               #nomenv05#5 = "  ";
               |PINTA #nomenv05#5;
               |GRABA 020#nomenv05.a;
               |LIBERA #nomenv05;
          |SINO;
               |SI #nomenv05#5 = "  ";
                    #nomenv05#5 = "**";
                    |PINTA #nomenv05#5;
                    |GRABA  020#nomenv05.a;
                    |LIBERA #nomenv05;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EditaResumen;
     |SI FSalida = 13;
          |SI #nomenv01#Campo# = "SI";
               #nomenv01#Campo# = "NO";
          |SINO;
               |SI #nomenv01#Campo# = "NO"; |O #nomenv01#Campo# = "  ";
                    #nomenv01#Campo# = "SI";
               |FINSI;
          |FINSI;
          |PINTA #nomenv01#Campo#;
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |PUSHV 06062279;
          |BLANCO 07072279;

          |ENTLINEAL #1#nomenv05, -1, 4, 21, 1, inf_nomenv05, sup_nomenv05;

          |POPV;

          swActivoUno = 0;
          |BUCLE comp_resumen;
          |SI swActivoUno = 1;
               #nomenv01#7 = "SI";
               |PINTA #nomenv01#7;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Defecto;
     fFecha = ~;
     aFecha = fFecha;
     |QBF aFecha;

     aAlfa = aFecha % 402;
     nNume = aAlfa;
     #0#0 = aAlfa;
     #0#4 = aAlfa;

     aAlfa = aFecha % -104;
     nNume = aAlfa;
     #0#1 = aAlfa;
|FPRC;

|PROCESO Defecto3; |TIPO 7;
     |SI #0#2 [ 2;
          #0#3 = 2;      || desde tipo 0 o 2
     |SINO;
          #0#3 = 9;      || desde tipo 5 o superior (atrasos)
     |FINSI;

     |PINTA #0#3;
|FPRC;

|PROCESO Defecto4; |TIPO 7;
     #0#4 = #0#0;
     |PINTA #0#4;
|FPRC;

|PROCESO Ayuda3; |TIPO 7;
     |PUSHV 06520969;
     |ATRI R
     |PINTA 0652, " 0 - n¢mina     ";
     |PINTA 0752, " 1 - pagas      ";
     |PINTA 0852, " 2 - finiquitos ";
     |PINTA 0952, " 5-9 - atrasos  ";
     |ATRI 0;
|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO Cuenta;
     |HAZ CuentaUna;
     #nomenv01#2 = nDocs;
     |GRABA 020#nomenv01.a;
     |LIBERA #nomenv01;
|FPRC;

|DEFBUCLE CuentaDocs;
     #nomenv01#1;
     ;
     00001;
     99999;
     be;
     NULL, Cuenta;
|FIN;

|PROCESO labtraba;
     #nomenv04#0 = #labtraba#0;
     #nomenv04#1 = #labtraba#1;
     |LEE 101#nomenv04.=;
     |SI FSalida = 0;
          #nomenv04#2 = #labtraba#2;
          #nomenv04#3 = #labtraba#127;
          #nomenv04#4 = "**";
          |GRABA 020#nomenv04.a;
     |SINO;
          #nomenv04#2 = #labtraba#2;
          #nomenv04#3 = #labtraba#127;
          #nomenv04#4 = "**";
          |GRABA 020#nomenv04.n;
     |FINSI;
     |LIBERA #nomenv04;

     || en cuanto haya algun trabajador, creo la linea, para que despues
     || me ponga el nro de documentos y me cree el lineal de trabajadores
     || si tengo documentos

     #nomenv01#0 = #nomenv04#0;
     |LEE 101#nomenv01.=;
     |SI FSalida = 0;
          #nomenv01#5 = "SI";
          |GRABA 020#nomenv01.a;
     |SINO;
          |ABRE #labempre;
          #labempre#0 = #nomenv04#0;
          |LEE 000#labempre.=;
          |CIERRA #labempre;

          |DDEFECTO #nomenv01;
          #nomenv01#0 = #nomenv04#0;
          #nomenv01#1 = #labempre#2;
          #nomenv01#5 = "SI";
          |GRABA 020#nomenv01.n;
     |FINSI;
     |LIBERA #nomenv01;
     swPorTrabajador = 1;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44, 128;
     nDesdeEmpresa, 00001, "A", "S";
     nHastaEmpresa, 99999, "A", "S";
     ;
     NULL, labtraba;
|FIN;

|PROCESO labcentr;
     |DDEFECTO #nomenv03;
     #nomenv03#0 = #labcentr#0;
     #nomenv03#1 = #labcentr#1;
     |LEE 101#nomenv03.=;
     |SI FSalida ! 0;
          #nomenv03#2 = #labcentr#2;
          #nomenv03#3 = #labcentr#25;
          |SI #labcentr#26 = "S";
               #nomenv03#4 = "**";
          |FINSI;
          |SI #nomenv03#4 = "**";
               swActivoUno = 1;
          |FINSI;
          |GRABA 020#nomenv03.n;
          swPorCentro = 1;
     |SINO;
          || ya existe, eso es porque ya lo habia grabado de antes
          |SI #nomenv03#4 = "**";
               swActivoUno = 1;
          |FINSI;
     |FINSI;
     |LIBERA #nomenv03;

     #nomenv01#0 = #nomenv03#0;
     |LEE 101#nomenv01.=;
     |SI FSalida = 0;
          #nomenv01#4 = "SI";
          |GRABA 020#nomenv01.a;
     |SINO;
          |ABRE #labempre;
          #labempre#0 = #nomenv03#0;
          |LEE 000#labempre.=;
          |CIERRA #labempre;

          |DDEFECTO #nomenv01;
          #nomenv01#0 = #nomenv03#0;
          #nomenv01#1 = #labempre#2;
          #nomenv01#4 = "SI";
          |GRABA 020#nomenv01.n;
     |FINSI;
     |LIBERA #nomenv01;
|FPRC;

|DEFBUCLE labcentr;
     #labcentr#1;
     26;
     nDesdeEmpresa, 001, nDesdeActivo;
     nHastaEmpresa, 999, nHastaActivo;
     ;
     NULL, labcentr;
|FIN;

|PROCESO BuscaCentros;
     nDesdeEmpresa = #nomenv01#0;
     nHastaEmpresa = #nomenv01#0;
     nDesdeActivo = "S";
     nHastaActivo = "S";
     swActivoUno = 0;
     |ABRE #nomenv03;
     |BUCLE labcentr;
     |SI swActivoUno = 1;
          #nomenv01#4 = "SI";
     |SINO;
          #nomenv01#4 = "NO";
     |FINSI;
     |CIERRA #nomenv03;

     |GRABA 020#nomenv01.a;
     |PINTA #nomenv01#4;
     |LIBERA #nomenv01;
|FPRC;

|PROCESO labempre;
     #nomenv01#0 = #labempre#0;
     #nomenv01#1 = #labempre#2;
     #nomenv01#3 = "SI";
     |GRABA 020#nomenv01.n;
     |LIBERA #nomenv01;
     swPorEmpresa = 1;

     #nomenv02#0 = #labempre#0;
     #nomenv02#1 = #labempre#2;
     #nomenv02#2 = #labempre#130;
     #nomenv02#3 = #labempre#131;
     |GRABA 020#nomenv02.n;
     |LIBERA #nomenv02;
|FPRC;

|DEFBUCLE labempre;
     #labempre#1;
     131;
     00001, "S";
     99999, "S";
     ;
     NULL, labempre;
|FIN;

|PROCESO comp_trabajadores;
     aAlfa = #nomenv04#3;
     |QBF aAlfa;
     |SI #nomenv04#4 = "**"; |Y aAlfa ! "";
          swActivoUno = 1;
     |FINSI;
|FPRC;

|DEFBUCLE comp_trabajadores;
     #nomenv04#1;
     ;
     #nomenv01#0, 00001;
     #nomenv01#0, 99999;
     ;
     NULL, comp_trabajadores;
|FIN;

|PROCESO CompTraba;
     |SI #nomenv01#5 = "SI";
          swActivoUno = 0;
          |BUCLE comp_trabajadores;
          |SI swActivoUno = 0;
               aAlfa = "    ATENCION. No hay ningún trabajador con envío de ";
               aAlfa = aAlfa + "nóminas activado o dirección de email válida.";
               |MENAV aAlfa;
               aAlfa = "    Pulse F6 para activarlos e introducir la dirección de email ";
               aAlfa = aAlfa + " de los trabajadores.";
               |MENAV aAlfa;

               #nomenv01#5 = "NO";
               |PINTA #nomenv01#4;
               |ERROR;
          |FINSI;

          |ABRE #labtraba;
          |BUCLE act_labtraba;
          |CIERRA #labtraba;
     |FINSI;
|FPRC;

|PROCESO comp_centros;
     aAlfa = #nomenv03#3;
     |QBF aAlfa;
     |SI #nomenv03#4 = "**"; |Y aAlfa ! "";
          swActivoUno = 1;
     |FINSI;
|FPRC;

|DEFBUCLE comp_centros;
     #nomenv03#1;
     ;
     #nomenv01#0, 001;
     #nomenv01#0, 999;
     ;
     NULL, comp_centros;
|FIN;

|PROCESO CompCentro;
     |SI #nomenv01#4 = "SI";
          swActivoUno = 0;
          |BUCLE comp_centros;
          |SI swActivoUno = 0;
               aAlfa = "    ATENCION. No hay ningún centro con envío de ";
               aAlfa = aAlfa + "nóminas activado o dirección de email válida.";
               |MENAV aAlfa;
               aAlfa = "    Pulse F6 para activarlo e introducir la dirección de email ";
               aAlfa = aAlfa + " de los centros.";
               |MENAV aAlfa;

               #nomenv01#4 = "NO";
               |PINTA #nomenv01#4;
               |ERROR;
          |FINSI;

          |ABRE #labcentr;
          |BUCLE act_labcentr;
          |CIERRA #labcentr;
     |FINSI;
|FPRC;

|PROCESO CompEmpresa;
     |GRABA 020#nomenv01.a;
     |LIBERA #nomenv01;
     |SI #nomenv01#3 = "SI";
          aAlfa = "";
          |ABRE #nomenv02;
          #nomenv02#0 = #nomenv01#0;
          |LEE 101#nomenv02.=;
          |SI FSalida = 0;
               aAlfa = #nomenv02#2;
          |SINO;
               |ABRE #labempre;
               #labempre#0 = #nomenv01#0;
               |LEE 000#labempre.=;
               |SI FSalida = 0;
                    #nomenv02#0 = #labempre#0;
                    #nomenv02#1 = #labempre#2;
                    #nomenv02#2 = #labempre#130;
                    |GRABA 020#nomenv02.n;
                    |LIBERA #nomenv02;

                    |HAZ BuscaCentros;
               |FINSI;
               |CIERRA #labempre;
          |FINSI;
          |CIERRA #nomenv02;
          aAlfa = #nomenv02#2;

          |QBF aAlfa;
          |SI aAlfa = "";
               FSalida = 14;
               |HAZ EditaEmpresa;
/*
               aAlfa = "    ATENCION. El email de la empresa esta en blanco. ";
               aAlfa = aAlfa + "Pulse F6 para introducir la dirección.";
               |MENAV aAlfa;
               #nomenv01#3 = "NO";
               |PINTA #nomenv01#3;
               |ERROR;
*/
          |FINSI;
     |FINSI;

     |ABRE #labempre;
     #labempre#0 = #nomenv01#0;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          |SI #nomenv01#3 = "SI";
               #labempre#130 = #nomenv02#2;
               #labempre#131 = "S";
          |SINO;
               #labempre#131 = "N";
          |FINSI;
          |GRABA 020#labempre.a;
          |LIBERA #labempre;
     |FINSI;
     |CIERRA #labempre;
|FPRC;

|PROCESO CompResumen;
     swActivoUno = 0;
     |BUCLE comp_resumen;
     |SI swActivoUno = 0;
          |SI #nomenv01#7 = "SI";
               aAlfa = "    ATENCION. No se ha marcado ningún resumen de ";
               aAlfa = aAlfa + "nóminas para su envío.";
               |MENAV aAlfa;
               aAlfa = "    Pulse F6 para visualizar los resúmenes archivados y ";
               aAlfa = aAlfa + " seleccionar los que desee enviar.";
               |MENAV aAlfa;

               #nomenv01#7 = "NO";
               |PINTA #nomenv01#7;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AltaCentros;
     swActivoUno = 0;
     |ABRE #nomenv03;
     nDesdeEmpresa = #nomenv01#0;
     nHastaEmpresa = #nomenv01#0;
     nDesdeActivo = " ";
     nHastaActivo = "z";
     |BUCLE labcentr;
     |CIERRA #nomenv03;
     |SI swActivoUno = 1;
          #nomenv01#4 = "SI";
     |SINO;
          #nomenv01#4 = "NO";
     |FINSI;
     |PINTA #nomenv01#4;
|FPRC;

|PROCESO AltaEmpresa;
     nModo = (FEntrada / 100) ! 0;
     swActivoUno = 0;
     |ABRE #labempre;
     #labempre#0 = #nomenv01#0;
     |LEE 101#labempre.=;
     |SI FSalida = 0;
          |DDEFECTO #nomenv02;
          |ABRE #nomenv02;
          #nomenv02#0 = #labempre#0;
          |LEE 101#nomenv02.=;
          |SI FSalida ! 0;
               #nomenv02#0 = #labempre#0;
               #nomenv02#1 = #labempre#2;
               #nomenv02#2 = #labempre#130;
               |GRABA 020#nomenv02.n;
               |LIBERA #nomenv02;
          |FINSI;
          |CIERRA #nomenv02;
     |FINSI;
     |CIERRA #labempre;

     #nomenv01#1 = #labempre#2;
     |PINTA #nomenv01#1;

     |SI nModo = 1;           || esto solo en modo alta
          aAlfa = #nomenv02#2;
          |QBF aAlfa;
          |SI aAlfa ! "";
               #nomenv01#3 = "SI";
          |SINO;
               #nomenv01#3 = "NO";
          |FINSI;
     |FINSI;
     |PINTA #nomenv01#3;

     |HAZ CuentaUna;
     #nomenv01#2 = nDocs;
     |PINTA #nomenv01#2;
     |GRABA 020#nomenv01.a;
     |LIBERA #nomenv01;
|FPRC;

|PROCESO Alta;
     nModo = (FEntrada / 100) ! 0;
     swActivoUno = 0;
     |SI nModo = 1;
          |HAZ AltaEmpresa;
          |HAZ AltaCentros;
          |PINTA #nomenv01#2;
          |PINTA #nomenv01#3;

          |ABRE #nomenv04;
          nDesdeEmpresa = #nomenv01#0;
          nHastaEmpresa = #nomenv01#0;
          |BUCLE labtraba;
          |CIERRA #nomenv04;

          |PINTA #nomenv01#4;
          |PINTA #nomenv01#5;
     |FINSI;
|FPRC;

|PROCESO Nombre;
     |ABRE #labempre;
     #labempre#0 = #nomenv01#0;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          #nomenv01#1 = #labempre#2;
          |PINTA #nomenv01#1;
     |FINSI;
     |CIERRA #labempre;
|FPRC;

|PROCESO inferior;
     #nomenv01#0 = 00001;
     #nomenv01#2 = 00001;
|FPRC;

|PROCESO superior;
     #nomenv01#0 = 99999;
     #nomenv01#2 = 9999;
|FPRC;

|PROGRAMA;
     |CLS;

     nArchi = 0;
     |HAZ MiraSiArchiva;
     |SI nArchi = 0;
          |PINPA #1#nomenvme;
          |AVISO;
          |PAUSA;
          |ACABA;
     |FINSI;

     |SI nArchi = 2;
          |PINPA #2#nomenvme;
          |AVISO;
          |PAUSA;
          |ACABA;
     |FINSI;

     |PINPA #0#0;

     |HAZ Defecto;

     |PINDA #0#0;

     |ENDATOS #1#0;

     |SI FSalida = 0;
          nDesdeTipo = #0#2;
          nHastaTipo = #0#3;
          nDesdeMes  = #0#0;
          nHastaMes  = #0#4;
          enDesdeMod = 990;
          enHastaMod = 995;
          |SI #nomenv00#2 ! 0;
              enDesdeMod = 990;
              enHastaMod = 990;
          |FINSI;

          aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("e" + aAlfa) % 108;
          |NOME_DAT #nomenv01#aAlfa#;
          |DELINDEX #nomenv01;
          aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("f" + aAlfa) % 108;
          |NOME_DAT #nomenv02#aAlfa#;
          |DELINDEX #nomenv02;
          aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("g" + aAlfa) % 108;
          |NOME_DAT #nomenv03#aAlfa#;
          |DELINDEX #nomenv03;
          aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("h" + aAlfa) % 108;
          |NOME_DAT #nomenv04#aAlfa#;
          |DELINDEX #nomenv04;
          aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("i" + aAlfa) % 108;
          |NOME_DAT #nomenv05#aAlfa#;
          |DELINDEX #nomenv05;

          |ABRE #nomenv01;
          |ABRE #nomenv02;
          |ABRE #nomenv03;
          |ABRE #nomenv04;
          |ABRE #nomenv05;

          swPorEmpresa = 0;
          |BUCLE labempre;

          swPorCentro = 0;
          nDesdeEmpresa = 00001;
          nHastaEmpresa = 99999;
          nDesdeActivo = "S";
          nHastaActivo = "S";
          |BUCLE labcentr;

          swPorTrabajador = 0;
          nDesdeEmpresa = 00001;
          nHastaEmpresa = 99999;
          |BUCLE labtraba;

          |HAZ ResumenNominas;

          |BUCLE CuentaDocs;

          |CIERRA #nomenv04;
          |CIERRA #nomenv03;
          |CIERRA #nomenv02;
          |CIERRA #nomenv01;
     |SINO;
          |ACABA;
     |FINSI;

     |SI swPorEmpresa = 0; |Y swPorCentro = 0; |Y swPorTrabajador = 0;
          |HAZ Aviso1;
     |FINSI;

     |PARA; |SI; |HACIENDO;
          |ENTLINEAL #2#nomenv01, -1, 2, 22, 0, inferior, superior;
          |MENU menu;
          nOpcion = FSalida;
          |SI FSalida = 1;
               |HAZ EnviaCorreo;
               |SAL;
          |FINSI;
          |SI FSalida = 2;
               || nada, vuelvo al lineal
          |FINSI;
          |SI FSalida = 3; || Salir
               |SAL;
          |FINSI;
          |SI FSalida = 0; || ESC
               |CONFI "    S¿Está seguro de que desea abandonar el lineal y salir al menú?";
               |SI FSalida = 0;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRO;
