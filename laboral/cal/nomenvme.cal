|| MENSAJES EN PANTALLA
|| INSTALACION DE DSPDF

|FICHEROS;
     nomenvme;
|FIN;

|VARIABLES;
     nInstala = 0;
     nHandle = 0;
     nCalc = 0;
     nSwError = 0;

     aIP = "";
     aAlfa = "";
     aOrigen = "";
     aDestino = "";
     aDocRemoto = "";
     aDocServidor = "";
     {1}aContiene = "";

     aAlfaX = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aUnidadLocal = "";

     &nEmp = 0;
     &nCen = 0;
     &nTra = 0;
     &aNomEmp = "";
     &aNomCen = "";
     &aNomTra = "";
     aEmp = "";
     aCen = "";
     aTra = "";
     &nEnvio = 0;
     &swAlMenosUno = 0;
     &nDocMensa = 0;
     &nTotalDoc = 0;
     &nTotalDocMensa = 0;
     &nTotalTrab = 0;
     {1}aRutaLocal = "";

     &aVersionGS = "";
     aIPRemoto = "";
     aLocal = "";
     aServidor = "";
|FINSI;

|PROCESO Aviso1;
     |PUSHV 05012380;
     |PINPA #0#nomenvme;
     |PAUSA;
     |POPV;
|FPRC;

|PROCESO EnviaFichero;
   aIP = ""; |IP_REMOTO aIP;
   aContiene = "";
   |ESPECIFICA "RBASS", aContiene;
   aAlfaX = aContiene1;
   aAlfaX = aAlfaX - "\";
   |SI FSalida ! 0;
      nCalc = ((FSalida / 100) ! 0) + 99;
      aAlfaX = aAlfaX % nCalc;
   |SINO;
      aAlfaX = aAlfaX - "/";
      |SI FSalida ! 0;
         nCalc = ((FSalida / 100) ! 0) + 99;
         aAlfaX = aAlfaX % nCalc;
      |FINSI;
   |FINSI;
   aUnidadLocal = aAlfaX;

   aAlfaX = aUnidadLocal + "/DOCUMENTOS/";
   |SI aIP = ""; |MKDIR aAlfaX; |SINO; |RMKDIR aAlfaX; |FINSI;
   aAlfaX = aAlfaX + "TMP/";
   |SI aIP = ""; |MKDIR aAlfaX; |SINO; |RMKDIR aAlfaX; |FINSI;
   aAlfaX = aAlfaX + "PARAMCOPIA.TXT";
   |XABRE "CW", aAlfaX, nHandle;
   |SI FSalida ] 0;
      aAlfa1 = aOrigen  + &13 + &10; |XGRABA nHandle, aAlfa1;
      aAlfa1 = aDestino + &13 + &10; |XGRABA nHandle, aAlfa1;
      |XCIERRA nHandle;

      aAlfa1 = "|:laboral/nomca8zc.tab;" + aAlfaX;
      |SUB_EJECUTA aAlfa1;

      |XABRE "C", aAlfaX, nHandle;
      |SI FSalida ] 0;
         |XLEE nHandle, 254, aAlfa1;
         |XCIERRA nHandle;
         FSalida = aAlfa1;
      |SINO;
         aAlfa1 = "-1";
         FSalida = aAlfa1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO PantallaInst;
         |PUSHV 05012380;
         |ATRI R;
         |BLANCO 07191359;
         |CUADRO 07191359;
             ||        2        3         4         5
             ||        1234567890123456789012345678901234567
         |PINTA 0921, "  Se está realizando la instalación  ";
         |PINTA 1021, "   inicial. Espere unos segundos.    ";
|FPRC;

/*
|PROCESO MiraSiImpreDsPDF;
     nInstala = 0;
     aVersionGS = "";
     |ESPECIFICA "RBASS", aRutaLocal;
     |QBF aRutaLocal1;

     || primero busco el 9.05
     aAlfa = aRutaLocal1 + "gs9\gs9.05\bin\gswin32.exe";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;
          || si no esta busco si esta instalado el 9.01
          aAlfa = aRutaLocal1 + "gs9\gs9.01\bin\gswin32.exe";
          |XABRE "EC", aAlfa, nHandle;
          |SI FSalida < 0;
               nInstala = 1;
          |SINO;
               aVersionGS = "9.01";
          |FINSI;
     |SINO;
          aVersionGS = "9.05";
     |FINSI;

     |DBASS aOrigen; |QBF aOrigen;      || busco patrones
     aOrigen = aOrigen + "basica/patrones/gs9.tgz";

     aIP = ""; |IP_REMOTO aIP;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aAlfa = aContiene1;
     aAlfa = aAlfa - "\";
     |SI FSalida ! 0;
          nCalc = ((FSalida / 100) ! 0) + 99;
          aAlfa = aAlfa % nCalc;
     |SINO;
          aAlfa = aAlfa - "/";
          |SI FSalida ! 0;
               nCalc = ((FSalida / 100) ! 0) + 99;
               aAlfa = aAlfa % nCalc;
          |FINSI;
     |FINSI;
     aAlfa = aAlfa + "/DOCUMENTOS/TMP/";
     |SI aIP ! ""; |RMKDIR aAlfa; |SINO; |MKDIR aAlfa; |FINSI;
     aDestino      = aAlfa + "gs9.tgz";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |PULSATECLA;

     |SI nInstala = 1;
         |HAZ PantallaInst;
     |FINSI;

     |SI aDocRemoto ! aDocServidor;
          |SI nInstala ! 1;
               |HAZ PantallaInst;
          |FINSI;
          |PINTA 1121, "   Estado: descargando instalador.   ";

          |HAZ EnviaFichero;
          nInstala = 1;
     |FINSI;

     |SI nInstala = 1;
          |PINTA 1121, "   Estado: instalando Ghostscript   ";
          Pos   = -1;
          |PINTA 1121, " Estado: descompresi¢n Ghostscript  ";
          |RDESCOMPRIME aDestino;
          |PINTA 1121, " Estado:  extracci¢n del instalador ";
          |RDETAR aDestino, aRutaLocal1;
          aDestino = aAlfa + "gs9.tar"; |RFBORRA aDestino;

          aAlfa = aRutaLocal1 + "gs9\gs9.05\bin\gswin32.exe";
          |XABRE "EC", aAlfa, nHandle;
          |SI FSalida < 0;
               aAlfa = aRutaLocal1 + "gs9\gs9.01\bin\gswin32.exe";
               |XABRE "EC", aAlfa, nHandle;
               |SI FSalida < 0;
                    |MENAV "Se ha producido un error en la instalaci¢n de GhostScript 9";
                    nSwError = -1; |ACABA;
               |SINO;
                    aVersionGS = "9.01";
               |FINSI;
          |SINO;
               aVersionGS = "9.05";
          |FINSI;

          |POPV;
          |ATRI 0;
     |FINSI;
|FPRC;
*/

|PROCESO MiraSiImpreDsPDF;
     |HAZ PantallaInst;
     aVersionGS = "";
     |ESPECIFICA "RBASS", aRutaLocal;
     |QBF aRutaLocal1;

     aAlfa = aRutaLocal1 + "spoolpdf\dsarchi\";
     |RMKDIR aAlfa;      || por si no existiera

     aLocal = aAlfa;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |DBASS aOrigen; |QBF aOrigen;      || busco patrones
     aServidor = aOrigen;

     aOrigen = aServidor + "laboral/ejecutables/dsmini.exe";
     aDestino = aLocal + "dsmini.exe";

     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aOrigen = aServidor + "laboral/ejecutables/libiconv2.dll";
     aDestino = aLocal + "libiconv2.dll";

     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aOrigen = aServidor + "laboral/ejecutables/pdftk.exe";
     aDestino = aLocal + "pdftk.exe";

     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |POPV;
     |ATRI 0;
|FPRC;

/*
|PROCESO MiraSiImpreDsPDF_Jun2012;
     nInstala = 0;

     |ESPECIFICA "RBASS", aRutaLocal;
     |QBF aRutaLocal1;

     aAlfa = aRutaLocal1 + "gs9\gs9.01\bin\gswin32.exe";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;  nInstala = 1;  |FINSI;

     |DBASS aOrigen; |QBF aOrigen;      || busco patrones
     aOrigen = aOrigen + "basica/patrones/gs9.tgz";

     aIP = ""; |IP_REMOTO aIP;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aAlfa = aContiene1;
     aAlfa = aAlfa - "\";
     |SI FSalida ! 0;
          nCalc = ((FSalida / 100) ! 0) + 99;
          aAlfa = aAlfa % nCalc;
     |SINO;
          aAlfa = aAlfa - "/";
          |SI FSalida ! 0;
               nCalc = ((FSalida / 100) ! 0) + 99;
               aAlfa = aAlfa % nCalc;
          |FINSI;
     |FINSI;
     aAlfa = aAlfa + "/DOCUMENTOS/TMP/";
     |SI aIP ! ""; |RMKDIR aAlfa; |SINO; |MKDIR aAlfa; |FINSI;
     aDestino      = aAlfa + "gs9.tgz";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |PULSATECLA;

     |SI nInstala = 1;
         |HAZ PantallaInst;
     |FINSI;

     |SI aDocRemoto ! aDocServidor;
          |SI nInstala ! 1;
               |HAZ PantallaInst;
          |FINSI;
          |PINTA 1121, "   Estado: descargando instalador.   ";

          |HAZ EnviaFichero;
          nInstala = 1;
     |FINSI;

     |SI nInstala = 1;
          |PINTA 1121, "   Estado: instalando Ghostscript   ";
          Pos   = -1;
          |RDESCOMPRIME aDestino;
          |RDETAR aDestino, aRutaLocal1;
          aDestino = aAlfa + "gs9.tar"; |RFBORRA aDestino;
          aAlfa = aRutaLocal1 + "gs9\gs9.01\bin\gswin32.exe";
          |XABRE "EC", aAlfa, nHandle;
          |SI FSalida < 0;
               |MENAV "Se ha producido un error en la instalaci¢n de GhostScript 9";
               nSwError = -1; |ACABA;
          |FINSI;
          |POPV;
          |ATRI 0;
     |FINSI;
|FPRC;
*/

|PROCESO MensajeCorreo;
     aTra = " Archivando y enviando correo ...            ";
     |ATRI R;
     |PINTA 1618, aTra;
     |ATRI 0
|FPRC;

|PROCESO MensajeUnion;
     aTra = " Procesando la unión de los PDF en uno ...   ";
     |ATRI R;
     |PINTA 1618, aTra;
     |ATRI 0
|FPRC;

|PROCESO Mensaje;
     aEmp = "                                             ";
     aCen = "                                             ";
     aTra = "                                             ";

     aAlfa = nEmp;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aNomEmp = aNomEmp % 126;
     aEmp = "Empresa: " + aAlfa + " - " + aNomEmp;
     aEmp = " " + aEmp + " ";

     aAlfa1 = nDocMensa;
     |QBF aAlfa1;
     aAlfa2 = nTotalDoc;
     |QBF aAlfa2;
     aTra = " Generando documento PDF. Nómina " + aAlfa1 + " de " + aAlfa2;
     aTra = aTra + "                 ";
     aTra = aTra % 145;

     |SI nEnvio = 2;
          aAlfa = nCen;
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;
          aNomCen = aNomCen % 129;
          aCen = "Centro.: " + aAlfa + " - " + aNomCen;
          aCen = " " + aCen + " ";
     |FINSI;

     |SI nEnvio = 3;
          || aAlfa1 = nDocMensa;
          aAlfa1 = nDocMensa;
          |QBF aAlfa1;
          aAlfa2 = nTotalTrab;
          |QBF aAlfa2;
          aCen = " Enviando documento PDF. Trab. " + aAlfa1 + " de " + aAlfa2;
          aCen = aCen + "                 ";
          aCen = aCen % 145;

          aAlfa = nTra;
          |QBF aAlfa;
          aAlfa = ("00000" + aAlfa) % -105;
          aNomTra = aNomTra % 126;
          aTra = "Trabaj.: " + aAlfa + " - " + aNomTra;
          aTra = " " + aTra + " ";
     |FINSI;

               ||  1 2        3         4         5          6
               ||  890123456789012345678901234567890123456789012
     |ATRI R;
     |PINTA 1318, "        - Procesando env¡o de correo -       ";
     |PINTA 1418, aEmp;
     |PINTA 1518, aCen;
     |PINTA 1618, aTra;
     |ATRI 0;
     |PULSATECLA;
|FPRC;
