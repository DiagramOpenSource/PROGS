|| COPIA DE TODO LO ANTIGUO HASTA 29.08.2018
/*
|FICHEROS;
     mod00245 #0;
     mod00242 #1;   || horas
     mod00244 #2;   || introd. lins.

     nomvarca #3;   || variaciones cabs.
     nomvarli #4;   || variaciones lins.
     labempre #5;   || empresas
     labtraba #6;   || trabajadores
     mod00246 #20;  || historico recibos
     gomcotiz;      || cotizacion agrarios

     gomdetjr;      || detalles dia de jornadas agrarios
     nomtrcal;      || calendario laboral trabajador
     nomcontr;      || control de la aplicacion
     nomcalca;
     nomconst;
     nomtraca;
     mod00258;

     mod00262;
     nomfical;
|FIN;

|VARIABLES;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     para1 = 0;
     para2 = 0;
     para3 = 0;
     para4 = 0;
     fech1 = @;
     fech2 = @;
     fech3 = @;
     fech4 = @;
     elsw1 = 0;
     elsw2 = 0;
     elsw3 = 0;
     elsw4 = 0;
     FEstado = 0;
     seleccio = 0;
     modo = 0;
     sw_rup = 0;

     p_mes = "";
     bisiesto = 0;
     topemes = 0;
     atopemes = "";
     ames = "";
     &importe = 0;
     &detalle = 0;
     &d_altas = 0;
     &s_bases = 0;
     emp_ant = 0;
     tra_ant = 0;
     cuantos = 0;
     desde1 = @;
     desde2 = @;
     hasta1 = @;
     hasta2 = @;
     &d_horas = 0;
     &d_horas1 = 0;
     exces = 0;
     &EURODB = 0;
     &reten = 0;
     &bases = 0;
     &cuotacc = 0;
     &cuotades = 0;
     &liqui = 0;
     &jorna = 0;
     &jorna1 = 0;
     al903 = 0;

     numer = 0;
     mesnum = 0;
     nPara1 = 0;
     nPara2 = 0;
     nPara3 = 0;
     nCampo = 0;
     swYaexiste = 0;
     aAnyo = "";
     nMes = 0;
     nDia = 0;
     aCalendario = "";
     nNume1 = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aAlfa5 = "";
     nTotal = 0;
     &nPorCC = 0;
     &nPorDes = 0;
     aFechaBaja = "";
     aAlfa = "";
     nDiaBaja = 0;
     nMesBaja = 0;
     nAnyBaja = 0;
     nMaxDiasMes = 0;
     &basescc = 0;
     &basesdes = 0;
     &jorna1cc = 0;
     &jorna1des = 0;
     jornacc = 0;
     jornades = 0;
     nJornIT = 0;
     nJornPagoSS = 0;
     nBasePagoSS = 0;
     nJornadasMax = 0;
     nBaseJornadaCC = 0;
     nBaseJornadaDes = 0;
     nBaseCC = 0;
     nBaseDes = 0;
     nGrupo = 0;
     nTopeMin = 0;
     nTopeMaxJor = 0;
     sw_tope = 0;
     nDiasCotIT = 0;
     nBaseATEP = 0;
     grupo = 0;
     dias_tope = 0;
     nMax_cp = 0;
     nMin_cp = 0;
     pilt_ATEP = 0;
     nBasePorJornada = 0;
     nBaseOriginal = 0;
     jornadas = 0;
     nCodigoCons = 0;
     &basesfp = 0;
     &nPorFP = 0;
     &cuotafp = 0;
     nBaseProv = 0;
     catego = 0;
     nBaseIT = 0;

     aParam = "";
     &nSalarioBase = 0;
     &nComplemento = 0;
     nHorasIDAL = 0;
     &nHorasInc = 0;
     nHorasDia = 8;
     nHorasTeoricas = 0;

     fFecha = @;
     aFecha = "";
     nAny = 0;
     swInactividad = 0;
     nEmpAnt = 0;
     nTraAnt = 0;
     fFechaAlta = @;
     fFechaBaja = @;

     fDiaLet = @;
     aDiaLet = "";
     nDiaSem = 0;
     nCampoF = 0;
     nCampoF1 = 0;
     nCampoF2 = 0;
     nCampoF3 = 0;

     swFestivo = 0;
     nFechaNume = 0;
     nNume2 = 0;
     nNume3 = 0;
     swSigue = 0;
     nCalendario = 0;
     nUltimoPrecio = 0;
|FIN;

____________________________________/ DESDE CAMPOS
|PROCESO Mensa10; |TIPO 7;
     |SI aParam = "Q";
          |MENSA "    Limite maximo de jornadas a cotizar por QUINCENA";
     |FINSI;
     |SI aParam = "M";
          |MENSA "    Limite maximo de jornadas a cotizar por MES";
     |FINSI;
|FPRC;

|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
    fech1 = ~;
    alfa1 = fech1;
    alfa1 = alfa1 % -104;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO mirames; |TIPO 7; ||CALCULA EL MES POR DEFECTO SEGUN FECHA SISTEMA
     fech1 = ~;
     alfa1 = fech1;
     alfa1 = alfa1 % 402;
     #0Campo = alfa1;
     |PINTA #0Campo;
|FPRC;

|PROCESO topetope;
|SI nMes =  1;  p_mes = "ENERO     ";  topemes = 31; |FINSI;
|SI nMes =  2;  p_mes = "FEBRERO   ";  topemes = 28+bisiesto; |FINSI;
|SI nMes =  3;  p_mes = "MARZO     ";  topemes = 31; |FINSI;
|SI nMes =  4;  p_mes = "ABRIL     ";  topemes = 30; |FINSI;
|SI nMes =  5;  p_mes = "MAYO      ";  topemes = 31; |FINSI;
|SI nMes =  6;  p_mes = "JUNIO     ";  topemes = 30; |FINSI;
|SI nMes =  7;  p_mes = "JULIO     ";  topemes = 31; |FINSI;
|SI nMes =  8;  p_mes = "AGOSTO    ";  topemes = 31; |FINSI;
|SI nMes =  9;  p_mes = "SEPTIEMBRE";  topemes = 30; |FINSI;
|SI nMes = 10;  p_mes = "OCTUBRE   ";  topemes = 31; |FINSI;
|SI nMes = 11;  p_mes = "NOVIEMBRE ";  topemes = 30; |FINSI;
|SI nMes = 12;  p_mes = "DICIEMBRE ";  topemes = 31; |FINSI;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
     bisiesto = #0#9 $ 4;
     |SI bisiesto = 0;   bisiesto = 1;  |SINO;    bisiesto = 0;  |FINSI;
     nMes = #0Campo;
     |HAZ topetope;
     atopemes = topemes;  atopemes = ("00" + atopemes) % -102;
     ames = #0Campo;      ames = ("00" + ames) % -102;
     |PINTA 1627, p_mes;
|FPRC;

|PROCESO no_antic; |TIPO 7;
|SI #0#8 = 1;
        alfa1 = "S";
|SINO;
        alfa1 = "N";
|FINSI;
|C_M #0#6, 1, alfa1;
|FPRC;

|PROCESO quincena; |TIPO 0;
     alfa1 = "01." + ames + "." + #0#9;  desde1 = alfa1;
     alfa1 = "15." + ames + "." + #0#9;  hasta1 = alfa1;

     alfa1 = "16." + ames + "." + #0#9;            desde2 = alfa1;
     alfa1 = atopemes + "." + ames + "." + #0#9;   hasta2 = alfa1;

     |SI aParam = "Q";
          |SI #0#8 = 1;
               #0#4 = desde1;   #0#5 = hasta1;
          |SINO;
               #0#4 = desde2;   #0#5 = hasta2;
          |FINSI;
     |FINSI;
     |SI aParam = "M";
          #0#4 = desde1;   #0#5 = hasta2;
     |FINSI;

     |PINTA #0#4;
     |PINTA #0#5;
|FPRC;
____________________________________/ CREACION VARIACIONES
|PROCESO el914;
    #4#0 = #3#0;
    #4#1 = #3#1;
    #4#2 = #3#2;
    #4#3 = #3#3;
    #4#4 = 903;
|LEE 101#4=;
    FEstado = FSalida;

||    alfa1 = jorna;
    alfa1 = al903;
    alfa1 = ("          " + alfa1) % -110;
    #4#5 = alfa1;                            || unidades
|SI exces = 0;
        #4#6 = "Jornadas ";                  || valor
|SINO;
        #4#6 = "Jornadas*";                  || valor
|FINSI;

|SI FEstado = 0;    |GRABA 020#4a; |FINSI;
|SI FEstado ! 0;    |GRABA 020#4n; |FINSI;
|LIBERA #4;
|FPRC;

|PROCESO anticipo;
    #4#0 = #3#0;
    #4#1 = #3#1;
    #4#2 = #3#2;
    #4#3 = #3#3;
|SI #0#6 = 1;  #4#4 = 906;    |FINSI;
|SI #0#6 = 2;  #4#4 = 907;    |FINSI;
|LEE 101#4=;
    FEstado = FSalida;

    #4#5 = "         1";                     || unidades
    alfa1 = importe;
    alfa1 = ("            " + alfa1) % -112;
    #4#6 = alfa1;                            || valor

|SI FEstado = 0;    |GRABA 020#4a; |FINSI;
|SI FEstado ! 0;    |GRABA 020#4n; |FINSI;
|LIBERA #4;
|FPRC;

|PROCESO mod00262;
     nHorasIDAL = nHorasIDAL + #mod00262#5;
|FPRC;

|DEFBUCLE mod00262;
     #mod00262#1;
     ;
     #3#0, #3#1, #mod00245#9, #mod00245#7, 01;
     #3#0, #3#1, #mod00245#9, #mod00245#7, 31;
     ;
     NULL, mod00262;
|FIN;

|PROCESO HorasIDAL;
     || primero a ver las horas totales que se han hecho

     nSalarioBase = 0;
     nComplemento = 0;
     nHorasIDAL = 0;
     nHorasTeoricas = 0;
     |BUCLE mod00262;

     |SI nHorasIDAL ! 0;
          #mod00242#0 = " ";
          |LEE 000#mod00242.=;
          |SI FSalida = 0;
               nHorasTeoricas = al903 * nHorasDia;
               |SI nHorasIDAL > nHorasTeoricas;
                    nSalarioBase = nHorasTeoricas * #mod00242#2;
                    nComplemento = (nHorasIDAL - nHorasTeoricas) * #mod00242#2;
               |SINO;
                    nSalarioBase = nHorasIDAL * #mod00242#2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO complemento;
     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = #3#2;
     #4#3 = #3#3;
     #4#4 = #0#16;
     |LEE 101#4=;
     |SI FSalida = 0;
          |BORRA 020#4a;
     |FINSI;
     |SI nComplemento = 0;
          |ACABA;
     |FINSI;

     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = #3#2;
     #4#3 = #3#3;
     #4#4 = #0#16;
     |LEE 101#4=;
     FEstado = FSalida;

     #4#5 = "         1";                     || unidades

     alfa1 = nComplemento;
     alfa1 = ("            " + alfa1) % -112;
     #4#6 = alfa1;                            || valor

     |SI FEstado = 0;    |GRABA 020#4a; |FINSI;
     |SI FEstado ! 0;    |GRABA 020#4n; |FINSI;
     |LIBERA #4;
|FPRC;

|PROCESO sbase;
    #4#0 = #3#0;
    #4#1 = #3#1;
    #4#2 = #3#2;
    #4#3 = #3#3;
    #4#4 = 101;
    |LEE 101#4=;

    FEstado = FSalida;

    #4#5 = "         1";                     || unidades
     |HAZ HorasIDAL;
     |SI nHorasIDAL ! 0;
          s_bases = nSalarioBase;
     |FINSI;
     alfa1 = s_bases;
    alfa1 = ("            " + alfa1) % -112;
    #4#6 = alfa1;                            || valor

|SI FEstado = 0;    |GRABA 020#4a; |FINSI;
|SI FEstado ! 0;    |GRABA 020#4n; |FINSI;
|LIBERA #4;
|FPRC;

|PROCESO variacion;
|SI #0#8 = 1;|Y importe = 0;  |ACABA;   |FINSI;
|SI #0#8 = 2;|Y s_bases = 0;  |ACABA;   |FINSI;

|DDEFECTO #3;
    #3#0 = emp_ant;
    #3#1 = tra_ant;
    #3#2 = #0#7;
    #3#3 = 0;
|LEE 000#3=;
|SI FSalida ! 0;
    |GRABA 020#3n;
    |SI FSalida = 0;
        |SI #0#8 = 1;
            |HAZ anticipo;
        |SINO;
            |HAZ sbase;
            |HAZ el914;
        |FINSI;
    |FINSI;
|SINO;
    |SI #0#8 = 1;
        |HAZ anticipo;
    |SINO;
        |HAZ sbase;
        |HAZ complemento;
        |HAZ el914;
    |FINSI;
|FINSI;
|FPRC;

____________________________________/ LECTURA E IMPRESION
|PROCESO LeeHistorico;
     |DDEFECTO #20;

     |SI aParam = "M";
          |ACABA;
     |FINSI;

     #20#0 = #6#0;   || empresa
     #20#1 = #6#1;   || trabajador
     #20#2 = #0#9;   || a¤o
     #20#3 = #0#7;   || mes
     #20#4 = 1;      || quincena
     #20#7 = "0";    || tipo
     |LEE 000#20=;
|FPRC;

|PROCESO GrabaHistorico;
|SI #0#8 = 1;|Y importe = 0;  |ACABA;   |FINSI;
|SI #0#8 = 2;|Y s_bases = 0;  |ACABA;   |FINSI;

|DDEFECTO #20;
    #20#0 = #6#0;   || empresa
    #20#1 = #6#1;   || trabajador
    #20#2 = #0#9;   || a¤o
    #20#3 = #0#7;   || mes
    #20#4 = #0#8;   || quincena
    |SI aParam = "M";
         #20#4 = 0;      || quincena
    |SINO;
         #20#4 = #0#8;   || quincena
    |FINSI;
    #20#7 = "0";    || tipo
|LEE 101#20=;
    FEstado = FSalida;

    #20#5 = importe;     || importe bruto
    #20#6 = d_altas;     || dias alta quincena
    #20#8 = reten;       || retencion IRPF
    #20#13 = #6#30;      || %IRPF
|SI #20#5 ! 0; |O nJornIT ! 0;
        #20#16 = cuotacc;       || cuota cc
        #20#9 = cuotades;       || cuota desempleo
        #20#10 = basescc;      || base SS CC
        #20#17 = basesdes;      || base SS CP
        #20#11 = jorna1cc;     || jornadas
        #20#18 = jorna1des;     || jornadas
        #20#12 = liqui;      || liquido

        #20#20 = cuotafp;       || cuota formacion profesional
|SINO;
        #20#9 = 0;           || cuota desempleo
        #20#16 = 0;          || cuota cc
        #20#10 = 0;          || base SS
        #20#11 = 0;          || jornadas
        #20#12 = 0;          || liquido
|FINSI;
    #20#14 = nPorDes;      || % Desempleo
    #20#15 = nPorCC;      || % Cont. Comunes
    #20#19 = nPorFP;      || % Cont. Comunes

|SI FEstado = 0;    |GRABA 020#20a;     |FINSI;
|SI FEstado ! 0;    |GRABA 020#20n;     |FINSI;
|LIBERA #20;
|FPRC;

|PROCESO ultimo_dia;  || halla el ultimo dia del mes
     bisiesto = 0;
     numer = #0#9 $ 4;
     |SI numer = 0;
          bisiesto = 1;
     |FINSI;
     topemes = 31;
     mesnum = #0#7;
     |SI mesnum= 2;
          topemes = 28 + bisiesto;
     |FINSI;
     |SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO cambia;
     |SI #nomvarca#12 = " ";|Y #nomvarca#13 = " ";|Y #nomvarca#14 = " ";|Y #nomvarca#15 = " ";
         |SI #labtraba#89 ! 0;  #nomvarca#12 = #labtraba#60;  |FINSI;
         |SI #labtraba#92 ! 0;  #nomvarca#12 = "A";    |FINSI;
     |FINSI;

     |PARA nPara1 = 4; |SI nPara1 [ 7; |HACIENDO nPara1 = nPara1 + 1;
          nPara2 = nPara1 + 4;
          nPara3 = nPara1 + 8;
          |SI #nomvarca#nPara3# ! " ";
               |SI #nomvarca#nPara1# = 0; #nomvarca#nPara1# = 1; |FINSI;
               |SI #nomvarca#nPara2# = 0; #nomvarca#nPara2# = topemes; |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AjusteQ1;
     nTotal = 0;
     |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
          nCampo = nDia + 3;
          |SI #gomdetjr#nCampo# = " ";
               nTotal = nTotal + 1;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AjusteQ2;
     nTotal = 0;
     |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
          nCampo = nDia + 3;
          |SI #gomdetjr#nCampo# = "x";
               #gomdetjr#nCampo# = " ";
          |SINO;
               |SI nTotal ! jorna;
                    #gomdetjr#nCampo# = "X";
                    nTotal = nTotal + 1;
               |FINSI;
          |FINSI;
     |SIGUE;
     |SI nTotal < jorna; |Y #labtraba#42 ! "A";   || mensuales NO
          al903 = nTotal;
          aAlfa2 = jorna;
          aAlfa3 = d_horas;
          aAlfa4 = #labtraba#0; aAlfa4 = "00000" + aAlfa4; aAlfa4 = aAlfa4 % -105;
          aAlfa5 = #labtraba#1; aAlfa5 = "00000" + aAlfa5; aAlfa5 = aAlfa5 % -105;
          aAlfa1 = "    Trab: " + aAlfa4 + "." + aAlfa5;
          aAlfa1 = aAlfa1 + ". Se han ajustado los dias resultantes (" + aAlfa2;
          aAlfa1 = aAlfa1 + ") del total de horas (" + aAlfa3 + ") a los disponibles (";
          aAlfa2 = nTotal;
          aAlfa1 = aAlfa1 + aAlfa2 + ")";
          |MENAV aAlfa1;
     |SINO;
          al903 = jorna;
     |FINSI;
|FPRC;

|PROCESO Ajustes903;
|ACABA;
     |ABRE #nomcontr;
     |LEE 000#nomcontr.p;
     |CIERRA #nomcontr;

     |DDEFECTO #gomdetjr;
     #gomdetjr#0 = #labtraba#0;    || Empresa
     #gomdetjr#1 = #labtraba#1;    || Trabajador
     #gomdetjr#2 = #0#9;           || A¤o
     #gomdetjr#3 = #0#7;           || Mes
     |LEE 101#gomdetjr.=;
     |SI FSalida = 0;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               #gomdetjr#nCampo# = " ";
          |SIGUE;
          swYaexiste = 1;
     |SINO;
          swYaexiste = 0;
     |FINSI;

     alfa1 = #labtraba#36;              || comprobamos fecha de alta
     alfa2 = alfa1 % 102;               || dia
     alfa3 = alfa1 % 402;               || mes
     alfa4 = alfa1 % -104;              || a¤o

     nume2 = alfa2;
     nume3 = alfa3;
     nume4 = alfa4;

     |SI nume3 = #0#7; |Y nume4 = #0#9;
          nume2 = nume2 + 3;
          |PARA nCampo = 4; |SI nCampo < nume2; |HACIENDO nCampo = nCampo + 1;
               #gomdetjr#nCampo# = "x"; || dia no disponible
          |SIGUE;
     |FINSI;

     ||  busco fecha de baja en el nomvarca
     #nomvarca#0 = #labtraba#0;    || Empresa
     #nomvarca#1 = #labtraba#1;    || Trabajador
     #nomvarca#2 = #0#7;           || Mes
     #nomvarca#3 = 0;              || Tipo
     |LEE 000#nomvarca.=;
     alfa1 = "";
     |SI FSalida = 0;
          alfa1 = #nomvarca#16;
     |FINSI;
     |SI alfa1 = ".........."; alfa1 = ""; |FINSI;
     |QBF alfa1;
     |SI alfa1 = "";     || no tengo fecha baja en nomvarca, busco en labtraba
          alfa1 = #labtraba#37;
     |FINSI;
     |SI alfa1 = ".........."; alfa1 = ""; |FINSI;
     |QBF alfa1;
     |SI alfa1 ! "";     || hay alguna fecha de baja: nomvarca o labtraba
          alfa2 = alfa1 % 102;               || dia
          alfa3 = alfa1 % 402;               || mes
          alfa4 = alfa1 % -104;              || a¤o

          nume2 = alfa2;
          nume3 = alfa3;
          nume4 = alfa4;

          |SI nume3 = #0#7; |Y nume4 = #0#9;
               nume2 = nume2 + 4;
               |PARA nCampo = nume2; |SI nCampo < 35; |HACIENDO nCampo = nCampo + 1;
                    #gomdetjr#nCampo# = "x"; || dia no disponible
               |SIGUE;
          |FINSI;
     |FINSI;

     |ABRE #nomtrcal;
     aAnyo = #0#9;
     #nomtrcal#0 = #labtraba#156;       || defecto calendario laboral
     #nomtrcal#13 = aAnyo;
     |LEE 000#nomtrcal.=;
     nMes = #0#7;
     aCalendario = #nomtrcal#nMes#;
     |CIERRA #nomtrcal;
     |HAZ ultimo_dia;
     |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
          nCampo = nDia + 3;
          nNume1 = (nDia * 100) + 1;
          aAlfa1 = aCalendario % nNume1;
          |SI aAlfa1 = 1;
               #gomdetjr#nCampo# = "x"; || x minuscula: dia no disponible
          |FINSI;
     |SIGUE;

     #nomvarca#0 = #labtraba#0;    || Empresa
     #nomvarca#1 = #labtraba#1;    || Trabajador
     #nomvarca#2 = #0#7;           || Mes
     #nomvarca#3 = 0;              || Tipo
     |LEE 000#nomvarca.=;
     |HAZ cambia;   || controla las bajas tipo "del dia 1 al dia 0"
     |SI FSalida = 0;
          |PARA nPara1 = 4; |SI nPara1 [ 7; |HACIENDO nPara1 = nPara1 + 1;
               |SI #nomvarca#nPara1# ! 0;
                    nPara2 = nPara1 + 4;
                    |PARA nDia = #nomvarca#nPara1#; |SI nDia [ #nomvarca#nPara2#; |HACIENDO nDia = nDia + 1;
                        nCampo = nDia + 3;
                        #gomdetjr#nCampo# = "x"; || x minuscula: dia no disponible
                    |SIGUE;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #0#8 = 1;
          || esto es lo nuevo , para que me ajuste cuando el trabajador sea baja
          || durante la primera jornada, que no lo estabamos contemplando
          |HAZ AjusteQ1;
     |FINSI;
     |SI #0#8 = 2;
          || esto es lo que hacia siempre
          |HAZ AjusteQ2;
     |FINSI;
|FPRC;

|PROCESO nomcalca;
     nJornIT = 0;
     nJornPagoSS = 0;
     nBasePagoSS = 0;

     #nomcalca#0 = #6#0;
     #nomcalca#1 = #6#1;
     #nomcalca#2 = #0#7;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          nJornIT = #nomcalca#55;
          nJornPagoSS = #nomcalca#114;
          nBasePagoSS = #nomcalca#115;
     |FINSI;
|FPRC;

|PROCESO fin_informe;
     |DDEFECTO #5;   #5#0 = emp_ant;                         |LEE 000#5=;
     |DDEFECTO #6;   #6#0 = emp_ant;     #6#1 = tra_ant;     |LEE 000#6=;
     |SI #6#45 = "401";
          nPorCC = #0#12;
          nPorDes = #0#11;
     |SINO;
          nPorCC = #0#14;
          nPorDes = #0#13;
     |FINSI;
     |SI #0#8 = 1;
          nume1 = #6#33;
          bases = (jorna1 * #gomcotiz#nume1#) ! EURODB;
          cuotades = (bases % nPorDes) ! EURODB;
          cuotacc = (bases % nPorCC) ! EURODB;
          basescc = bases;
          basesdes = bases;
          jorna1cc = jorna1;
          jorna1des = jorna1;
     |FINSI;
     |SI #0#8 = 2;  || en la segunda quincena ajusta por diferencias las jornadas
          nume1 = #6#33;
          bases = (jorna * #gomcotiz#nume1#) ! EURODB;
          cuotades = (bases % nPorDes) ! EURODB;
          cuotacc = (bases % nPorCC) ! EURODB;
          |HAZ LeeHistorico;
          al903 = #20#11;          || jornadas quincena 1
          |HAZ Ajustes903;
          jornacc = al903;

          |HAZ nomcalca;
          jornades = jornacc + nJornIT - nJornPagoSS;

          basescc = (jornacc * #gomcotiz#nume1#) ! EURODB;
          basesdes = (jornades * #gomcotiz#nume1#) ! EURODB;
          cuotacc = (basescc % nPorCC) ! EURODB;
          cuotades = (basesdes % nPorDes) ! EURODB;
          |HAZ LeeHistorico;

          jorna1cc = jornacc - #20#11;
          jorna1des = jornades - #20#18;
          basescc = basescc - #20#10;
          basesdes = basesdes - #20#17;
          cuotacc = cuotacc - #20#16;
          cuotades = cuotades - #20#9;
     |SI nJornIT ! 0;
          || en estos caso es posible que sea negativo el recibo de la
          || segunda quincena
          |SI jorna1cc < 0;  jorna1cc = 0;    |FINSI;
          |SI jorna1des < 0;  jorna1des = 0;    |FINSI;
          |SI basescc < 0;   basescc = 0;     |FINSI;
          |SI basesdes < 0;   basesdes = 0;     |FINSI;
          |SI cuotacc < 0;   cuotacc = 0;     |FINSI;
          |SI cuotades < 0;   cuotades = 0;     |FINSI;
     |FINSI;
     |FINSI;
     reten = (importe % #6#30) ! EURODB;
     liqui = importe - (reten + cuotades + cuotacc);

     |SI importe ! 0; |O nJornIT ! 0;
          |PIEINF;
          cuantos = cuantos + 1;
     |FINSI;
     |FININF;
     |HAZ GrabaHistorico;
     |SI #0#8 = 2;
          || al903 = al903 + #20#11;         || jornadas quincena 2
          || HAZ Ajustes903;
     |FINSI;
     |HAZ variacion;
|FPRC;

|PROCESO topescp;
     sw_tope = sw_tope + 1;        || en alta: sw_tope=1; en baja: sw_tope=2
     nBaseATEP = nBaseProv;
     |SI nBaseATEP = 0;             || solo topeo si tengo algo en la base
          |ACABA;
     |FINSI;
     grupo = #labtraba#33;

     |SI sw_tope = 1;    || reales, no por dias trabajados
          dias_tope = jornadas;
     |SINO;
          ||dias_tope = jornadasIT;
     |FINSI;

     nMax_cp = #nomconst#20 * dias_tope;                     || maximo A.T.
     |SI grupo = 12; nMin_cp = #nomconst#22 * dias_tope; |FINSI;    || minimo A.T.
     |SI grupo = 11; nMin_cp = #nomconst#21 * dias_tope; |FINSI;
     |SI grupo < 11; nMin_cp = #nomconst#23 * dias_tope; |FINSI;
     |SI nMax_cp [ nBaseATEP; |Y nMax_cp > 0;
          nBaseATEP = nMax_cp;      || topeo maximo
          pilt_ATEP = #nomconst#20;
     |FINSI;
     |SI nMin_cp ] nBaseATEP; |Y nMin_cp > 0;
          nBaseATEP = nMin_cp;      || topeo minimo
          pilt_ATEP = #nomconst#23;
     |FINSI;
|FPRC;

|PROCESO topescc;
     nTopeMin = #nomconst#nCampo#;

     nTopeMaxJor = 0;
     nCampo = nGrupo + 35;
     nTopeMaxJor = #nomconst#nCampo#;

     nBasePorJornada = nBaseProv / jornadas;
     || nBasePorJornada = nBasePorJornada ! 2;
     nBaseOriginal = nBasePorJornada;
     |SI nBasePorJornada > nTopeMaxJor;
          nBasePorJornada = nTopeMaxJor;
     |SINO;
          || si he topeado a maximos no puedo topear tambien a
          || minimos, asi me quedo con una variable, nBasePorJornada
          |SI nBasePorJornada < nTopeMin;
               nBasePorJornada = nTopeMin;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO fin_informe_2012;
     |DDEFECTO #5;   #5#0 = emp_ant;                         |LEE 000#5=;
     |DDEFECTO #6;   #6#0 = emp_ant;     #6#1 = tra_ant;     |LEE 000#6=;
     |SI #6#45 = "401";
          nPorCC = #0#12;
          nPorDes = #0#11;
     |SINO;
          nPorCC = #0#14;
          nPorDes = #0#13;
     |FINSI;

     nBaseJornadaCC = 0;
     nBaseJornadaDes = 0;
     nBaseCC = 0;
     nBaseDes = 0;
     |SI #0#9 [ 2011;
          nume1 = #6#33;
          nBaseJornadaCC = #gomcotiz#nume1#;
          nBaseJornadaDes = #gomcotiz#nume1#;
     |SINO;
          nGrupo = #labtraba#33;
          nCampo = nGrupo + 23;

          nCodigoCons = #labempre#32;
          #nomtraca#0 = #labtraba#0;
          #nomtraca#1 = #labtraba#1;
          |LEE 000#nomtraca.=;
          |SI FSalida = 0;
               nCodigoCons = #nomtraca#3;
          |FINSI;

          #nomconst#0 = nCodigoCons;
          |LEE 000#nomconst.=;


          |SI #0#8 = 1;

          |FINSI;
     |FINSI;

     nPorFP = #0#15;
     cuotafp = 0;

     |SI #0#8 = 1;
          jornadas = jorna1;
          nBaseProv = importe;

          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;
          sw_tope = 0;
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;

          nBaseCC = (jorna1 * nBaseJornadaCC) ! EURODB;
          nBaseDes = (jorna1 * nBaseJornadaDes) ! EURODB;

          nBaseCC = importe;
          nBaseDes = importe;

          cuotacc = (nBaseCC % nPorCC) ! EURODB;
          cuotades = (nBaseDes % nPorDes) ! EURODB;
          |SI #0#9 ] 2012;
               cuotafp = (nBaseDes % nPorFP) ! EURODB;
          |FINSI;
          basescc = nBaseCC;
          basesdes = nBaseDes;
          jorna1cc = jorna1;
          jorna1des = jorna1;
     |FINSI;

     |SI #0#8 = 2;  || en la segunda quincena ajusta por diferencias las jornadas
          |HAZ LeeHistorico;

          jornadas = jorna;
          nBaseProv = importe + #20#5;
          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;
          sw_tope = 0;
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;

          nBaseCC = (jorna * nBaseJornadaCC) ! EURODB;
          nBaseDes = (jorna * nBaseJornadaDes) ! EURODB;

          nSalarioBase = 0;
          nComplemento = 0;
          nHorasInc = 0;
          nHorasIDAL = 0;
          nHorasTeoricas = 0;

          |BUCLE mod00262;

          |SI nHorasIDAL ! 0;
               nSalarioBase = nHorasIDAL * nUltimoPrecio;
               nHorasTeoricas = jorna1 * nHorasDia;
               |SI nHorasIDAL > nHorasTeoricas;
                    nSalarioBase = nHorasTeoricas * #mod00242#2;
                    nComplemento = (nHorasIDAL - nHorasTeoricas) * #mod00242#2;
               |SINO;
                    nSalarioBase = nHorasIDAL * #mod00242#2;
               |FINSI;
               nHorasInc = (nHorasIDAL - nHorasTeoricas);
          |FINSI;

          importe = nSalarioBase;

          nBaseCC = importe;
          nBaseDes = importe;

          jornadas = jorna1;
          nBaseProv = importe + nComplemento;
          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;
          nBaseCC = nBasePorJornada * jornadas;

          sw_tope = 0;
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;
          nBaseDes = nBasePorJornada * jornadas;

          cuotacc = (nBaseCC % nPorCC) ! EURODB;
          cuotades = (nBaseDes % nPorDes) ! EURODB;
          |SI #0#9 ] 2012;
               cuotafp = (nBaseDes % nPorFP) ! EURODB;
          |FINSI;

          || al903 = #20#11;          || jornadas quincena 1
          || HAZ Ajustes903;

          al903 = jorna1;               || jornadas
          jornacc = al903;

          |HAZ nomcalca;
          jornades = jornacc + nJornIT - nJornPagoSS;
          jornacc = jornades;

          |SI #0#7 = 01; |Y #0#9 = 2012; || para buscar la base para enero de IT comunes
               |SI #labtraba#33 = 12;
                    catego = 11;
               |SINO;
                    catego = #labtraba#33;
               |FINSI;
               nBaseIT = #gomcotiz#catego#;
          |SINO;
               nBaseIT = #labtraba#95;
          |FINSI;

          jornadas = jornacc;
          nBaseProv = importe + #20#5 + ((nJornIT - nJornPagoSS) * nBaseIT);
          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;

          nBaseIT = #labtraba#96;

          sw_tope = 0;
          jornadas = jornades;
          nBaseProv = importe + #20#5 + ((nJornIT - nJornPagoSS) * nBaseIT);
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;

          || basescc = (jornacc * nBaseJornadaCC) ! EURODB;
          || basesdes = (jornades * nBaseJornadaDes) ! EURODB;

          basescc = importe;
          basesdes = importe;

          cuotacc = (basescc % nPorCC) ! EURODB;
          cuotades = (basesdes % nPorDes) ! EURODB;
          |SI #0#9 ] 2012;
               cuotafp = (basesdes % nPorFP) ! EURODB;
          |FINSI;
          |HAZ LeeHistorico;

          jorna1cc = jornacc - #20#11;
          jorna1des = jornades - #20#18;
          basescc = basescc - #20#10;
          basesdes = basesdes - #20#17;
          cuotacc = cuotacc - #20#16;
          cuotades = cuotades - #20#9;
          cuotafp = cuotafp - #20#20;

          |SI nJornIT ! 0;
               || en estos caso es posible que sea negativo el recibo de la
               || segunda quincena
               |SI jorna1cc < 0;  jorna1cc = 0;    |FINSI;
               |SI jorna1des < 0;  jorna1des = 0;    |FINSI;
               |SI basescc < 0;   basescc = 0;     |FINSI;
               |SI basesdes < 0;   basesdes = 0;     |FINSI;
               |SI cuotacc < 0;   cuotacc = 0;     |FINSI;
               |SI cuotades < 0;   cuotades = 0;     |FINSI;
               |SI cuotafp < 0;   cuotafp = 0;     |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#8 = 2;  || en la segunda quincena tengo en cuenta prestaciones
                    || SS como parte del bruto, base IRPF y liquido al final
                    || digo yo que las otras prestaciones y complementos
                    || tambien deberia, pero de momento no se hace, lo dejo
                    || como esta
          || importe = importe + #nomcalca#73;
          || pues no, este hombre no paga las prestaciones de la empresa porque
          || es asi, asi que no hay que sumarlas aqui, de ninguna manera
     |FINSI;
     reten = (importe % #6#30) ! EURODB;
     liqui = importe - (reten + cuotades + cuotacc + cuotafp);

     |SI importe ! 0; |O nJornIT ! 0;
          |PIEINF;
          cuantos = cuantos + 1;
     |FINSI;
     |FININF;
     |HAZ GrabaHistorico;
     |SI #0#8 = 2;
          || al903 = al903 + #20#11;         || jornadas quincena 2
          || HAZ Ajustes903;
     |FINSI;
     |HAZ variacion;
|FPRC;

|PROCESO ini_informe;
    emp_ant = #2#0;
    tra_ant = #2#1;
    importe = 0;
    d_altas = 0;
    d_horas = 0;
    d_horas1 = 0;
    s_bases = 0;
     jorna = 0;
     jorna1 = 0;
     nJornadasMax = #0#10;
     |INFOR "mod00245";
|FPRC;

|PROCESO LeeHistorico2;
     |DDEFECTO #20;

     |SI aParam = "M";
          |ACABA;
     |FINSI;

     #20#0 = #2#0;   || empresa
     #20#1 = #2#1;   || trabajador
     #20#2 = #0#9;   || a¤o
     #20#3 = #0#7;   || mes
     #20#4 = 1;      || quincena
     #20#7 = "0";    || tipo
     |LEE 000#20=;
|FPRC;

|PROCESO FechaBaja;
     aFechaBaja = "";

     #nomvarca#0 = #2#0;
     #nomvarca#1 = #2#1;
     #nomvarca#2 = #0#7;
     #nomvarca#3 = 0;
     |LEE 000#nomvarca.=;
     |SI FSalida = 0;
          aAlfa = #nomvarca#16;
          |QBF aAlfa;
          |SI aAlfa ! ""; |Y aAlfa ! "..........";
               aFechaBaja = aAlfa;
          |FINSI;
     |FINSI;

     |SI aFechaBaja = "";
          #labtraba#0 = #2#0;
          #labtraba#1 = #2#1;
          |LEE 000#labtraba.=;

          aAlfa = #labtraba#37;
          |QBF aAlfa;
          |SI aAlfa ! ""; |Y aAlfa ! "..........";
               aFechaBaja = aAlfa;
          |FINSI;
     |FINSI;

     nDiaBaja = 0;
     |SI aFechaBaja ! "";
          aAlfa = aFechaBaja % 402;
          nMesBaja = aAlfa;
          aAlfa = aFechaBaja % -104;
          nAnyBaja = aAlfa;
          |SI nMesBaja = #0#7; |Y nAnyBaja = #0#9;
               aAlfa = aFechaBaja % 102;
               nDiaBaja = aAlfa;
          |FINSI;
     |FINSI;

     nMaxDiasMes = 0;
     |SI nDiaBaja ! 0;
          |SI aParam = "M";
               nMaxDiasMes = nDiaBaja;
          |SINO;
               |SI #0#8 = 1;       || primera quincena
                    |SI nDiaBaja [ 15;
                         nMaxDiasMes = nDiaBaja;
                    |FINSI;
               |FINSI;
               |SI #0#8 = 2;       || segunda quincena
                    |SI nDiaBaja > 15;
                         nMaxDiasMes = nDiaBaja - 15;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     #labtraba#0 = #2#0;
     #labtraba#1 = #2#1;
     |LEE 000#labtraba.=;

     nJornadasMax = #0#10;
     |SI #labtraba#42 = "A";
          nJornadasMax = 30;
     |FINSI;

     |SI nMaxDiasMes ! 0; |Y nMaxDiasMes < nJornadasMax;
          nJornadasMax = nMaxDiasMes;
     |FINSI;
     |SI #0#8 = 1;
          |HAZ Ajustes903;
          |SI nTotal < nJornadasMax; |Y nTotal ! 0;
               nJornadasMax = nTotal;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO genero1;
     #mod00258#0 = #2#0;
     #mod00258#1 = #2#1;
     |LEE 000#mod00258.=;
     |SI FSalida = 0;
          |SI aParam = "M";
               |SI #mod00258#3 = "Q";
                    |ACABA;
               |FINSI;
          |FINSI;
          |SI aParam = "Q";
               |SI #mod00258#3 = "M";
                    |ACABA;
               |FINSI;
          |FINSI;
     |SINO;
          |SI aParam = "Q";
               |ACABA;
          |FINSI;
     |FINSI;

     |SI sw_rup = 0;
          sw_rup = 1;
          |HAZ ini_informe;
     |FINSI;
     |SI emp_ant ! #2#0;|O tra_ant ! #2#1;
          |SI #0#9 ] 2012;
               |HAZ fin_informe_2012;
          |SINO;
               |HAZ fin_informe;
          |FINSI;
          |HAZ ini_informe;
     |FINSI;

     |DDEFECTO #1;  #1#0 = #2#3;   |LEE 000#1=;
     |HAZ FechaBaja;

     |SI #2#2 ] #0#4;|Y #2#2 [ #0#5;
          jorna1 = jorna1 + 1;

          nHorasDia = #2#5;
          nUltimoPrecio = #2#6;
          detalle = (#2#5 * #2#6) ! EURODB;              || detalle quincena
          importe = importe + ((#2#5 * #2#6) ! EURODB);  || total quincena
          d_altas = d_altas + 1;                         || dias alta quincena
          |SI #1#3 = "S";
               d_horas1 = d_horas1 + #2#5;                 || horas, para jornadas
               exces = 0;
               nume1 = ((d_horas1 / 8) + .49) ! 0;
               nume2 = nJornadasMax;
               |SI #6#42 = "A";
                    nume1 = 30;
                    nume2 = 30;
               |FINSI;
               || nume2 = #0#10 / 2;
               |SI nume1 > nume2;
                    exces = nume1 - nume2;
                    nume1 = nume2;
               |FINSI;
               || migue
               || jorna1 = nume1;
         |FINSI;
          jorna1cc = jorna1;
          jorna1des = jorna1;
         |PRINT;
     |FINSI;

     nHorasDia = #2#5;
     s_bases = s_bases + ((#2#5 * #2#6) ! EURODB); || total salario base mes

     |SI #1#3 = "S";
          d_horas = d_horas + #2#5;                 || horas, para jornadas
          exces = 0;
          nume1 = ((d_horas / 8) + .49) ! 0;
          |SI #6#42 = "A";
               nume1 = 30;
          |FINSI;
          |SI #0#8 = 2;
               |HAZ LeeHistorico2;
          |FINSI;
          jorna = jorna1 + #20#11;
     |FINSI;

     |SI nEmpAnt ! #mod00244#0; |O nTraAnt ! #mod00244#1;
          |SI nTraAnt ! 0; || no es el primero
               || el ultimo, creo dias en inactividad para citricos
               |HAZ Citricos;
          |FINSI;
          |HAZ BorraCalen;
     |FINSI;

     fFecha = #mod00244#2;
     |HAZ GrabaJornada; || esta debajo

     nEmpAnt = #mod00244#0;
     nTraAnt = #mod00244#1;
|FPRC;

|PROCESO Calendario;
     swFestivo = 0;

     #nomfical#0 = #labtraba#156;
     #nomfical#1 = #0#9;
     |LEE 000#nomfical.=;

     fDiaLet = fFecha % 1;
     aDiaLet = fDiaLet;
     aDiaLet = aDiaLet % 1103;

     |SI aDiaLet = "Lun"; |Y #nomfical#2 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Mar"; |Y #nomfical#3 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Mie"; |Y #nomfical#4 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Jue"; |Y #nomfical#5 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Vie"; |Y #nomfical#6 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Sab"; |Y #nomfical#7 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Dom"; |Y #nomfical#8 = 1; swFestivo = 1; |FINSI;

     aFecha = fFecha;
     aAlfa = (aFecha % 402) + (aFecha % 102);
     nFechaNume = aAlfa;

     |PARA nCampoF = 9; |SI nCampoF [ 96; |HACIENDO nCampoF = nCampoF + 3;
          nCampoF1 = nCampoF;
          nCampoF2 = nCampoF + 1;
          nCampoF3 = nCampoF + 2;

          aAlfa1 = #nomfical#nCampoF1#; |QBF aAlfa1;
          aAlfa2 = #nomfical#nCampoF2#; |QBF aAlfa2;
          nNume3 = #nomfical#nCampoF3#;
          |SI aAlfa1 ! ""; |Y aAlfa2 ! ""; |Y nNume3 = 1;
               aAlfa1 = (aAlfa1 % 302) + (aAlfa1 % 102);
               nNume1 = aAlfa1;
               aAlfa2 = (aAlfa2 % 302) + (aAlfa2 % 102);
               nNume2 = aAlfa2;
               |SI nNume1 [ nFechaNume; |Y nFechaNume [ nNume2;
                    swFestivo = 1;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     |SI swFestivo = 0;
          |PARA nCampoF = 99; |SI nCampoF [ 157; |HACIENDO nCampoF = nCampoF + 2;
               nCampoF1 = nCampoF;
               nCampoF3 = nCampoF + 1;

               aAlfa1 = #nomfical#nCampoF1#; |QBF aAlfa1;
               nNume3 = #nomfical#nCampoF3#;
               |SI aAlfa1 ! ""; |Y nNume3 = 1;
                    aAlfa1 = (aAlfa1 % 302) + (aAlfa1 % 102);
                    nNume1 = aAlfa1;
                    |SI nNume1 = nFechaNume;
                         swFestivo = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Citricos;
     #labtraba#0 = #mod00244#0;
     #labtraba#1 = #mod00244#1;
     |LEE 000#labtraba.=;

     aAlfa = #labtraba#36;
     fFechaAlta = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2099";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |SI #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
          |ACABA;
     |FINSI;

     |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
          aAlfa1 = nDia; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa2 = #0#7; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
          aAlfa3 = #0#9;
          aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
          fFecha = aAlfa;

          |SI fFechaAlta [ fFecha; |Y fFecha [ fFechaBaja;
               |HAZ Calendario;

               |SI swFestivo = 0;
                    swInactividad = 1;
                    |HAZ GrabaJornada;
                    swInactividad = 0;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO BorraCalen;
     #gomdetjr#0 = #mod00244#0;
     #gomdetjr#1 = #mod00244#1;
     #gomdetjr#2 = #0#9;
     #gomdetjr#3 = #0#7;
     |LEE 101#gomdetjr.=;
     |SI FSalida = 0;
          |BORRA 020#gomdetjr.a;
     |FINSI;
     |LIBERA #gomdetjr;
|FPRC;

|PROCESO GrabaJornada;
     |DDEFECTO #gomdetjr;
     #labtraba#0 = #mod00244#0;
     #labtraba#1 = #mod00244#1;
     |LEE 000#labtraba.=;

     aAlfa = #labtraba#36;
     fFechaAlta = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2099";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |SI fFechaAlta [ fFecha; |Y fFecha [ fFechaBaja;
          || sigue
     |SINO;
          |ACABA;
     |FINSI;

     aFecha = fFecha;

     aAlfa = aFecha % 102;
     nDia = aAlfa;
     aAlfa = aFecha % 402;
     nMes = aAlfa;
     aAlfa = aFecha % -104;
     nAny = aAlfa;

     #gomdetjr#0 = #mod00244#0;
     #gomdetjr#1 = #mod00244#1;
     #gomdetjr#2 = nAny;
     #gomdetjr#3 = nMes;
     |LEE 101#gomdetjr.=;
     |SI FSalida = 0;

          nCampo = nDia + 3;
          |SI swInactividad = 1;
               |SI #gomdetjr#nCampo# = " ";
                    #gomdetjr#nCampo# = "D";
               |FINSI;
          |SINO;
               #gomdetjr#nCampo# = "X";
          |FINSI;
          |GRABA 020#gomdetjr.a;
     |SINO;
          nCampo = nDia + 3;
          |SI swInactividad = 1;
               #gomdetjr#nCampo# = "D";
          |SINO;
               #gomdetjr#nCampo# = "X";
          |FINSI;
          |GRABA 020#gomdetjr.n;
     |FINSI;
     |LIBERA #gomdetjr;
|FPRC;

|DEFBUCLE genero;
 #2#1;
 ;
 #0#0, #0#2, desde1, " ";
 #0#1, #0#3, hasta2, "z";
 ;
 NULL, genero1;
|FIN;

|PROCESO tipo3;
     |IMPRE 0;
     |SI FSalida = 0;
          |ABRE #gomcotiz;
          |LEE 000#gomcotiz.p;
          |CIERRA #gomcotiz;

          |ABRE #1;       || horas
          |ABRE #3;       || variaciones cabs.
          |ABRE #4;       || variaciones lins.
          |ABRE #5;       || empresas
          |ABRE #6;       || trabajadores
          |ABRE #20;      || historico
          |ABRE #nomcalca;
          |ABRE #nomconst;
          |ABRE #nomtraca;
          |ABRE #mod00258;
          |ABRE #mod00262;
          |ABRE #gomdetjr;
          |ABRE #nomfical;

          |BUCLE genero;

          #mod00244#0 = nEmpAnt;
          #mod00244#1 = nTraAnt;
          |HAZ Citricos;           || (el ultimo)

          |SI sw_rup ! 0;
               |SI #0#9 ] 2012;
                    |HAZ fin_informe_2012;
               |SINO;
                    |HAZ fin_informe;
               |FINSI;
               alfa1 = "    Emitidos [" + cuantos + "] recibos ...";
               |MENAV alfa1;
          |SINO;
               |MENAV "    Seleccion vacia ...";
          |FINSI;

          |CIERRA #nomfical;
          |CIERRA #gomdetjr;
          |CIERRA #mod00262;
          |CIERRA #mod00258;
          |CIERRA #nomtraca;
          |CIERRA #nomconst;
          |CIERRA #1;
          |CIERRA #3;
          |CIERRA #4;
          |CIERRA #5;
          |CIERRA #6;
          |CIERRA #20;
          |CIERRA #nomcalca;
     |SINO;
          |MENAV "    Proceso abortado ...";
     |FINSI;
     |FINIMP;
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;
     |LEE 001#0p;
     |SI FSalida ! 0;
          |DDEFECTO #0;
          |GRABA 020#0n;
     |FINSI;
     |LEE 101#0=;

     aParam = PARAMETRO;
     |QBF aParam;

     #0#8 = 2;
     #0#10 = 30;
     |PINPA #0#0;

     |ATRI I;
     |PINDA #0#0;

     |SI aParam = "M";
          |CAMPO_MODIFICA #0#6, 1, "N";
          |CAMPO_MODIFICA #0#8, 1, "N";
          |CAMPO_VISUAL #0#6, 1, "N";
          |CAMPO_VISUAL #0#8, 1, "N";
          |PINTA 1910, "                           ";
          |PINTA 2110, "                           ";
     |FINSI;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          nMes = #0#7;
          |HAZ topetope;
          atopemes = topemes;  atopemes = ("00" + atopemes) % -102;
          ames = #0#7; |QBF ames; ames = ("00" + ames) % -102;
          |HAZ quincena;

          |SI aParam = "Q";
               |HAZ tipo3;
          |SINO;
               |HAZ tipo3;
          |FINSI;
     |FINSI;

     |GRABA 020#0a;

     |LIBERA #0;
     |CIERRA #0;
|FPRO;
*/

/*
|| TAL Y COMO LO TENIA HASTA EL 31/10/2018
|PROCESO fin_informe_2012;
     nEmp = emp_ant;
     nTra = tra_ant;
     |HAZ Citricos;

     |DDEFECTO #5;   #5#0 = emp_ant;                         |LEE 000#5=;
     |DDEFECTO #6;   #6#0 = emp_ant;     #6#1 = tra_ant;     |LEE 000#6=;
     |SI #6#45 = "401";
          nPorCC = #0#12;
          nPorDes = #0#11;
     |SINO;
          nPorCC = #0#14;
          nPorDes = #0#13;
     |FINSI;

     nBaseJornadaCC = 0;
     nBaseJornadaDes = 0;
     nBaseCC = 0;
     nBaseDes = 0;
     |SI #0#9 [ 2011;
          nume1 = #6#33;
          nBaseJornadaCC = #gomcotiz#nume1#;
          nBaseJornadaDes = #gomcotiz#nume1#;
     |SINO;
          nGrupo = #labtraba#33;
          nCampo = nGrupo + 23;

          nCConst = #labtraba#248;
          |HAZ constante;

          nPorCC = #nomconst#7;
          nPorDes = #nomconst#13;
          nPorFP = #nomconst#17;

          nPorCCEmp = #nomconst#6;
          nPorDesEmp = #nomconst#12;
          nPorFPEmp = #nomconst#16;
     |FINSI;
     cuotafp = 0;

     |SI #0#8 = 2;  || en la segunda quincena ajusta por diferencias las jornadas
          |HAZ LeeHistorico;

          jornadas = jorna;
          nBaseProv = importe + #20#5;
          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;
          sw_tope = 0;
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;

          nBaseCC = (jorna * nBaseJornadaCC) ! EURODB;
          nBaseDes = (jorna * nBaseJornadaDes) ! EURODB;

          nSalarioBase = 0;
          nComplemento = 0;
          nHorasInc = 0;
          nHorasIDAL = 0;
          nHorasTeoricas = 0;
          |BUCLE mod00262;
          |HAZ HorasTeoricas;

          |SI nHorasIDAL ! 0;
               nSalarioBase = nHorasIDAL * nPrecioIDAL;
               || nHorasTeoricas = jorna1 * nHorasDia;
               || si vengo del IDAL asi, si no me quedo sin complemento
               || si despues vienen horas de uno y otro sitio
               nHorasTeoricas = nJornadasIDAL * #mod00264#8;
               |SI nHorasIDAL > nHorasTeoricas;
                    nSalarioBase = nHorasTeoricas * nPrecioIDAL;
                    |HAZ PrecioCompIDAL;
                    nComplemento = (nHorasIDAL - nHorasTeoricas) * nPrecioCompIDAL;
                    nHorasInc = (nHorasIDAL - nHorasTeoricas);
                    nNume = d_horas1 - nHorasTeoricas;
                    |SI nNume > 0;
                         nComplemento = nComplemento + (nNume * nPrecioCompIDAL);
                         nHorasInc = nHorasInc + nNume;
                         d_horas1 = nHorasTeoricas;
                    |FINSI;
               |SINO;
                    nSalarioBase = nHorasIDAL * nPrecioIDAL;
               |FINSI;
          |SINO;
               || horas IDAL son CERO

               nSalarioBase = importe;

          |FINSI;
          |SI nHorasIDAL ! 0;
               |SI d_horas1 > nHorasIDAL;
                    nSalarioBase = nSalarioBase + ((d_horas1 + nHorasInc - nHorasIDAL) * #mod00242#2);
                    || el nHorasInc no deberia tener que sumarse ahi, pero
                    || asi es como sale bien, lo dejo asi
               |FINSI;
          |FINSI;

          || esto para el caso de que tenga horas a diferente precio

          |SI nComplemento = 0;
               |SI importe ! nSalarioBase;
                    nSalarioBase = importe;
               |FINSI;
          |FINSI;

          || d_horas son las horas TOTALES que vienen del lineal
          || nHorasIDAL son las horas REALES del IDAL
          || d_horas1: si hay IDAL, las horas provenientes del IDAL que hay
          ||           en el lineal, si se ha ajustado a jornadas seran siempre
          ||           inferiores a nHorasIDAL
          || d_horas1: si no hay horas IDAL, las que vienen del lineal, igual
          ||           a d_horas

|| cuidado
|| esto es lo nuevo

          |SI d_horas1 > nHorasIDAL;
               nNume = ((d_horas1 / nHorasDia) + .49) ! 0;
               |SI nHorasIDAL = 0;
                    nNume = ((d_horas1 / nHorasDia) - .49) ! 0;
                    |SI nNume > nJornadasMax;
                         nNume = nJornadasMax;
                    |FINSI;
                    nNume1 = d_horas1 - (nNume * 8);
                    nHorasInc = nNume1;
                    |HAZ PrecioCompManual;
                    nComplemento = nHorasInc * nPrecioCompManual;
                    nSalarioBase = nSalarioBase - (nHorasInc * nUltimoPrecio);
                    d_horas1 = d_horas1 - nHorasInc;
               |FINSI;

               jorna1 = nNume;
               jorna1cc = nNume;
               jorna1des = nNume;
               nRestoJornadas = nNume - nJornadasIDAL;
               jorna = nRestoJornadas;

               al903 = al903 + #20#11;         || jornadas quincena 2

               |HAZ Ajustes903;
          |SINO;
               |SI d_horas > d_horas1;
                    || tengo horas en el lineal que no vienen del IDAL
                    nHorasMan = d_horas - d_horas1;

                    || jornadas provenientes de las horas manuales
                    || tambien horas sobrantes y complemento
                    nJorMan = ((nHorasMan / 8) - .49) ! 0;
                    nNume = jorna1 + nJorMan;
                    |SI nNume > nJornadasMax;
                         nJorMan = nJornadasMax - jorna1;
                    |FINSI;
                    nHorasIncMan = nHorasMan - (nJorMan * 8);
                    |HAZ PrecioCompManual;
                    nComplementoMan = nHorasIncMan * nPrecioCompManual;

                    || en el nHorasInc venian las horas sobrantes de IDAL
                    || mas las manuales, le quito las manuales, tanto
                    || a las horas incentivo como al complemento
                    nHorasInc = nHorasInc - nHorasMan;
                    nComplemento = nComplemento - (nHorasMan * nPrecioCompManual);

                    || sumo a las horas incentivo las horas que mes sobran
                    || de las manuales (las que no entran en jornadas)
                    nHorasInc = nHorasInc + nHorasIncMan;
                    nComplemento = nComplemento + nComplementoMan;

                    nSalarioBase = nSalarioBase + (nHorasMan * nPrecioCompManual);
                    nSalarioBase = nSalarioBase - nComplementoMan;

                    jorna1 = jorna1 + nJorMan;
                    jorna1cc = jorna1cc + nJorMan;
                    jorna1des = jorna1des + nJorMan;
                    d_horas1 = d_horas1 + nHorasMan - nHorasIncMan;

                    || esto es para que me ponga las jornadas correspondientes
                    || a las horas manuales ademas de las que
                    || ya me hubiera puesto por el IDAL
                    jorna = nJorMan;
                    |HAZ Ajustes903;
               |FINSI;
          |FINSI;
|| hasta aqui


          importe = nSalarioBase;

          nBaseCC = importe;
          nBaseDes = importe;

          nDiasCit = 0;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |HAZ CuentaDias;
               jornadas = nDiasCit;
          |SINO;
               jornadas = jorna1;
          |FINSI;

          nBaseProv = importe + nComplemento;
          |HAZ topescc;
          nBaseJornadaCC = nBasePorJornada;
          nBaseCC = nBasePorJornada * jornadas;

          sw_tope = 0;
          |HAZ topescp;
          nBaseJornadaDes = nBaseATEP / jornadas;
          nBaseDes = nBasePorJornada * jornadas;

          cuotacc = (nBaseCC % nPorCC) ! EURODB;
          cuotades = (nBaseDes % nPorDes) ! EURODB;
          cuotafp = (nBaseDes % nPorFP) ! EURODB;

          || al903 = #20#11;          || jornadas quincena 1
          || HAZ Ajustes903;

          al903 = jorna1;               || jornadas
          jornacc = al903;

          || para la IT imagino .... lo quito de momento

          |HAZ nomcalca;
          |SI nJornIT ! 0;
               jornades = jornacc + nJornIT - nJornPagoSS;
               jornacc = jornades;

               nBaseIT = #labtraba#95;

               jornadas = jornacc;
               nBaseProv = importe + nComplemento + #20#5 + ((nJornIT - nJornPagoSS) * nBaseIT);
               |HAZ topescc;
               nBaseJornadaCC = nBasePorJornada;
               nBaseCC = nBaseJornadaCC * jornadas;

               nBaseIT = #labtraba#96;

               sw_tope = 0;
               jornadas = jornades;
               nBaseProv = importe + nComplemento + #20#5 + ((nJornIT - nJornPagoSS) * nBaseIT);
               |HAZ topescp;
               nBaseJornadaDes = nBaseATEP / jornadas;
               nBaseDes = nBaseJornadaDes * jornadas;
          |FINSI;

          basescc = nBaseCC ! 2;
          basesdes = nBaseDes ! 2;
          basesfp = nBaseDes ! 2;

          |SI nJornIT ! 0;
               cuotacc = (basescc % (nPorCC + nPorCCEmp)) ! EURODB;
               cuotacc = cuotacc - ((basescc % nPorCCEmp) ! EURODB);
               cuotades = (basesdes % (nPorDes + nPorDesEmp)) ! EURODB;
               cuotades = cuotades - ((basesdes % nPorDesEmp) ! EURODB);
               cuotafp = (basesfp % (nPorFP + nPorFPEmp)) ! EURODB;
               cuotafp = cuotafp - ((basesfp % nPorFPEmp) ! EURODB);
          |SINO;
               cuotacc = (basescc % nPorCC) ! EURODB;
               cuotades = (basesdes % nPorDes) ! EURODB;
               cuotafp = (basesfp % nPorFP) ! EURODB;
          |FINSI;

          |SI nJornIT ! 0;
               || en estos caso es posible que sea negativo el recibo de la
               || segunda quincena
               |SI jorna1cc < 0;  jorna1cc = 0;    |FINSI;
               |SI jorna1des < 0;  jorna1des = 0;    |FINSI;
               |SI basescc < 0;   basescc = 0;     |FINSI;
               |SI basesdes < 0;   basesdes = 0;     |FINSI;
               |SI cuotacc < 0;   cuotacc = 0;     |FINSI;
               |SI cuotades < 0;   cuotades = 0;     |FINSI;
               |SI cuotafp < 0;   cuotafp = 0;     |FINSI;

               jorna1cc = jorna1cc + nJornIT;
               jorna1des = jorna1des + nJornIT;
          |FINSI;
     |FINSI;

     |SI #0#8 = 2;  || en la segunda quincena tengo en cuenta prestaciones
                    || SS como parte del bruto, base IRPF y liquido al f                    || digo yo que las otras prestaciones y complementos

                    || tambien deberia, pero de momento no se hace, lo dejo
                    || como esta
          || importe = importe + #nomcalca#73;
          || pues no, este hombre no paga las prestaciones de la empresa porque
          || es asi, asi que no hay que sumarlas aqui, de ninguna manera
     |FINSI;

     nBaseIRPF = (nSalarioBase + nComplemento);
     reten = ((nSalarioBase + nComplemento) % #6#30) ! EURODB;
     liqui = nBaseIRPF - (reten + cuotades + cuotacc + cuotafp);

     |SI importe ! 0; |O nJornIT ! 0;
          |PIEINF;
          cuantos = cuantos + 1;
     |FINSI;
     |FININF;
     |HAZ GrabaHistorico;
     |SI #0#8 = 2;
     |FINSI;

     |HAZ variacion;
|FPRC;
*/
