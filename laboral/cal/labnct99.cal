|FICHEROS;
     labnct99;
     labcontr;

     labnct11;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nHandle = 0;
     nHandle2 = 0;
     &swSigue = 0;
     &eaVengoDe = "";
     &nOpcionSS = 0;

     {1}aContiene = "";
     aBase = "";
     aBaseLocal = "";
     aRuta = "";

     aOrigen = "";
     aDestino = "";
     aIPRemoto = "";
     aRutaOrigen = "";
     aRutaDestino = "";
     aUnidadLocal = "";
     aFicheroTgz = "";
     aAbre = "";
     nHandleTgz = 0;
     aFicheroTar = "";
     aFicheroTxt = "";
     aParam = "";

     aFicheroBAT = "";
     aFicheroBAT2 = "";
     nCanal = 0;
     aLinea = "";
     nNume = 0;
     FEstado = 0;
     aDescarga = "";
     nHandleDes = 0;
     nHandleSize = 0;
     nBytes = 0;
     nTama¤oZip = 77000000;
     nProgreso = 0;
     nProgresoAnt = 0;
     nPorcentaje = 0;
     aProgreso = "";

     aSize = "";
     nPaso = 0;
     nPasoLim = 0;
     swSal = 0;

     &eaCadena = "";
     &eaCadenaSal = "";
     aLongitud = "";
     nLongitud = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";
     nNume1 = 0;
     nNume2 = 0;

     aFinal = "";
     nHandleFin = 0;
     swGeconet = 0;
     aCif = "";
|FIN;

|PROCESO NetContrata;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa1 = aAlfa % -101;
     |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
          aAlfa = aAlfa + "\";
     |FINSI;
     aAlfa = aAlfa + "rdn.exe";

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          aAlfa = "    No es posible realizar el envío. El módulo para envíos online no se ha instalado.";
          |MENAV aAlfa;
          aAlfa = "    Consulte al departamento de atención al cliente de Diagram Software, S.L.";
          |MENAV aAlfa;
          |ERROR;
          swSigue = 0;
          |XCIERRA nHandle;
          |ACABA;
     |SINO;
          swSigue = 1;
          |XCIERRA nHandle;
     |FINSI;

     |ABRE #labnct99;
     |LEE 000#labnct99.u;
     #labnct99#0 = #labnct99#0 + 1;
     |GRABA 020#labnct99.n;
     |SI FSalida ! 0; |O #labnct99#0 [ 40;
          aAlfa = "    La opción no está disponible. El módulo para envíos online no ha sido activado.";
          |MENAV aAlfa;
          aAlfa = "    Consulte al departamento de atención al cliente de Diagram Software, S.L.";
          |MENAV aAlfa;
          |ERROR;
          swSigue = 0;
     |SINO;
          swSigue = 1;
          |LEE 000#labnct99.u;
          |BORRA 020#labnct99.a;
     |FINSI;

     |LIBERA #labnct99;
     |CIERRA #labnct99;
|FPRC;

|PROCESO BuscaCIF;
     aAlfa = #labcontr#62;
     |QBF aAlfa;
     aCif = aAlfa;
     |SI aAlfa ! "";
          || HABIA CIF, PUEDE QUE USARAN NETCONTRATA
          aAlfa = #labcontr#63; |QBF aAlfa;
          aAlfa1 = aAlfa % -101;
          |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
               aAlfa = aAlfa + "\";
          |FINSI;
          aAlfa = aAlfa + "datos\usuarios.dbf";
          |XABRE "CE", aAlfa, nHandle;
          |SI FSalida < 0;
               || NO ENCUENTRO INSTALACION DE NETCONTRATA, HAY QUE EMPEZAR DE CERO

               aAlfa = "    A continuación se procederá al alta de su nuevo usuario conecta2";
               ||MENAV aAlfa;
          |SINO;
               || TENGO INSTALACION DE NETCONTRATA

               aOrigen = aAlfa;

               aDestino = aBase + "fich/usu_netc.dbf";

               |IP_REMOTO aIPRemoto;
               |SI aIPRemoto ! "";
                    |RECIBE_FICHERO aOrigen, aDestino;
               |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
               |FINSI;

               |SI FSalida ] 0;
                    aOrigen = aDestino;
                    aDestino = aBaseLocal + "conecta2\Datos\usuarios.dbf";
                    |SI aIPRemoto ! "";
                         |ENVIA_FICHERO aOrigen, aDestino;
                    |SINO;
                         |COPIA_FICHERO aOrigen, aDestino;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || NO HABIA CIF, INSTALACION COMPLETAMENTE NUEVA

          |PINPA #0#labnct11;
          |PINDA #0#labnct11;
          |ENDATOS #1#labnct11;
          |SI FSalida = 0;
               aCif = #labnct11#0;
               |QBF aCif;
               |SI aCif ! "";
                    |ABRE #labcontr;
                    |LEE 000#labcontr.p;
                    #labcontr#62 = aCif;
                    |GRABA 020#labcontr.a;
                    |LIBERA #labcontr;
                    |CIERRA #labcontr;
               |SINO;
                    aAlfa = "    ATENCION. Es necesario indicar el CIF/NIF del autorizacion Contrat@";
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
          |SI aCif ! "";
               aAlfa = "    A continuación se procederá al alta de nuevo usuario conecta2";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SizeBAT;
     aAlfa = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsmini.exe";
     aAlfa = aDestino + " " + aFicheroBAT2;
     |RSYSTEM aAlfa;

     |XABRE "C", aSize, nHandleSize;
     swSal = 0;
     || nBytes = 0;
     |PARA; |SI swSal = 0; |HACIENDO;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida < 0;
               swSal = 1;
          |FINSI;
          |QBF aLinea;
          aAlfa = aLinea;
          aAlfa = aLinea - "conecta2.zip";
          |SI aAlfa ! aLinea;
               |QBF aAlfa;
               aAlfa = aAlfa % -110;
               |QBT aAlfa;
               nBytes = aAlfa;
               swSal = 1;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandleSize;
|FPRC;

|PROCESO PintaProgreso2;
     aFicheroBAT2 = aBaseLocal + "downsize.bat";
     |RFBORRA aFicheroBAT2;
     aAlfa = aBaseLocal + "size.txt";
     |RFBORRA aAlfa;
     |XABRE "CBW", aFicheroBAT2, nCanal;
     |SI FSalida ] 0;
          aLinea = "@echo off" + &13 + &10;
          |XGRABA nCanal, aLinea;
          aLinea = "dir /-c " + aBaseLocal + "conecta2.zip > " + aBaseLocal + "size.txt";
          aLinea = aLinea + &13 + &10;
          |XGRABA nCanal, aLinea;
     |FINSI;
     |XCIERRA nCanal;

     aSize = aBaseLocal + "size.txt";
     |PINTA 1420, "³                                      ³"

     |PARA; |SI FEstado < 0; |HACIENDO;
          |XABRE "EC", aFinal, nHandleFin;
          FEstado = FSalida;

          nPaso = nPaso + 1;
          |SI nPaso > nPasoLim;
               nPaso = 0;

               |HAZ SizeBAT;

               nPorcentaje = ((nBytes / nTama¤oZip) * 100) ! 0;
               aAlfa1 = nPorcentaje;
               aAlfa1 = ("   " + aAlfa1) % -103;
               aAlfa1 = aAlfa1 + " % Completado";
               |PINTA 1432, aAlfa1;
               |PULSATECLA;

               nNume = nBytes;
               nNume = nNume / 2139000;
               nNume = nNume ! 0;
               nProgreso = nNume;
               |SI nProgreso > nProgresoAnt;
                    aProgreso = aProgreso + " ";
                    |ATRI R;
                    |PINTA 1522, aProgreso;
                    |ATRI 0;
                    nProgresoAnt = nProgreso;
                    |PULSATECLA;
               |FINSI;
          |FINSI;
          |PULSATECLA;
     |SIGUE;
     |PINTA 1420, "³   Descarga completada. Instalando.   ³"
     |PULSATECLA;
|FPRC;

|PROCESO PintaProgreso;
     |PARA; |SI FEstado < 0; |HACIENDO;
          |XABRE "EC", aFinal, nHandleFin;
          FEstado = FSalida;

          nNume = nNume + 1;
          |SI nNume > 3000; |Y FEstado < 0;
               nNume = 0;
               aProgreso = aProgreso + " ";
               |ATRI R;
               |PINTA 1522, aProgreso;
               |ATRI 0;
               |SI aProgreso = "                                    ";
                    |PINTA 1522, aProgreso;
                    aProgreso = "";
               |FINSI;
               |PULSATECLA;
          |FINSI;
          |PULSATECLA;
     |SIGUE;
|FPRC;

|PROCESO Descarga;
/*
     aAlfa = aRutaOrigen + aFicheroTar + " " + aFicheroTxt;
     |ATAR aAlfa, aRutaOrigen;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaOrigen + aFicheroTar;
          |XABRE "E", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaOrigen + aFicheroTar;
     |COMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaOrigen + aFicheroTgz;
          |XABRE "E", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaOrigen + aFicheroTxt;  |FBORRA aAlfa;
     aAlfa = aRutaOrigen + aFicheroTar;  |FBORRA aAlfa;
*/
     aAlfa = aBaseLocal + "conecta2.zip";
     |RFBORRA aAlfa;

     aRutaOrigen = aBase + "ejecutables/"
     aRutaDestino = aUnidadLocal + "\DOCUMENTOS\"
     aFicheroTgz = "dsdownlo.tgz"
     aFicheroTar = "dsdownlo.tar"
     aFicheroTxt = "dsdownlo\LEEME.txt";

     aOrigen = aRutaOrigen + aFicheroTgz;
     aDestino = aRutaDestino + aFicheroTgz;

     |RFBORRA aDestino;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTgz;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     Pos   = -1;
     aAlfa = aRutaDestino + aFicheroTgz;
     |RDESCOMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTar;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |RDETAR aAbre, aRutaDestino;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTxt;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaDestino + aFicheroTgz;  |RFBORRA aAlfa;
     aAlfa = aRutaDestino + aFicheroTar;  |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "conecta2.zip"; |RFBORRA aAlfa;

     aAlfa = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsdownloader.exe ";
     aAlfa = aAlfa + "-u http://anillo.dv.diagram.net/basprog/master9/Externos/conecta2/conecta2.zip -c ";
     aAlfa = aAlfa + aBaseLocal;

     aFicheroBAT = aUnidadLocal + "\DOCUMENTOS\dsdownlo\" + "descarga.bat";
     |RFBORRA aFicheroBAT;
     |XABRE "CBW", aFicheroBAT, nCanal;
     |SI FSalida ] 0;
          aLinea = "@echo off" + &13 + &10;
          |XGRABA nCanal, aLinea;
          aLinea = aAlfa + &13 + &10;
          |XGRABA nCanal, aLinea;
     |FINSI;
     |XCIERRA nCanal;

     aOrigen = aBase + "ejecutables/dsmini.exe";
     aDestino = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsmini.exe";
     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aAlfa = aDestino + " " + aFicheroBAT;

     |RSYSTEM aAlfa;

     |PUSHV 05012380;
     |PINTA 1220, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿";
     |PINTA 1320, "³                                      ³";
     |ATRI R;
     |PINTA 1328,        " Descargando conecta2 ";
     |ATRI 0;
     |PINTA 1420, "³                                      ³"
     |PINTA 1520, "³                                      ³"
     |PINTA 1620, "³                                      ³"
     |PINTA 1720, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ"

     nNume = 0;
     aFinal = aBaseLocal + "conecta2/rdn.exe";
     aDescarga = aBaseLocal + "conecta2.zip";
     nProgreso = 0;
     nProgresoAnt = 0;
     FEstado = -1;

     |HAZ PintaProgreso2;

     |XCIERRA nHandleFin;

     |POPV;

     |SLEEP 5;
     aAlfa = aBaseLocal + "conecta2.zip"; |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "downsize.bat"; |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "size.txt"; |RFBORRA aAlfa;
|FPRC;

|PROCESO Conecta2;
     |DBASE aBase;

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;

     eaCadena = aBaseLocal;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aBaseLocal = eaCadenaSal;

     aUnidadLocal = aBaseLocal % 102;

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     aAlfa = aBaseLocal + "conecta2\rdn.exe";

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          || NO EXISTE conecta2
          || hay que descargarse el programa.

          |HAZ Descarga;

          |HAZ BuscaCIF;
     |SINO;
          || SI QUE EXISTE conecta2

          || adelante pues

          || por si no hubieran llegado a meter el CIF

          aAlfa = #labcontr#62;
          |QBF aAlfa;
          aCif = aAlfa;
          |SI aAlfa = "";
               |HAZ BuscaCIF;
          |FINSI;
     |FINSI;

     |XCIERRA nHandle;
|FPRC;

|PROGRAMA;
     || aParam = "";
     aParam = "conecta2";
     |QBF aParam;

     swSigue = 0;
     swGeconet = 0;

     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;
     aAlfa = aBaseLocal + "conecta2.txt";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          swSigue = 1;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa1 = aBaseLocal;
     aAlfa2 = aBaseLocal - "geconet";
     |SI aAlfa1 ! aAlfa2;
          swGeconet = 1;
          nPasoLim = 2;
     |SINO;
          swGeconet = 0;
          nPasoLim = 2000;
     |FINSI;

     |SI aParam = "conecta2"; |Y swSigue = 1;
          |HAZ Conecta2;
          |SI aCif ! "";
               swSigue = 2;
          |SINO;
               swSigue = 0;
          |FINSI;
     |SINO;
          |HAZ NetContrata;
     |FINSI;
|FPRO;
