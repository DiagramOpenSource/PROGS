|FICHEROS;
     cretap12 #0;
     cretam05;

     cretam22;
     cretam23;
     cretam24;

     cretam27;
     cretam25;
     cretam26;

     cretam01;
     cretam02;
     cretam04;

     labempre;
     labtraba;
     labcentr;
     nomcenes;
|FIN;

|VARIABLES;
     aRuta = "";
     aLocal = "";
     {1}aContiene = "";
     aDirLocal = "";
     aUnidad = "";
     aAux = "";
     aPrograma = "";
     aPathDSSelect = "";
     aBorra = "";
     aParaIni = "";
     aCarpetaCaptura = "";
     aTextoIni = "";
     nHandle = 0;
     aEjecuta = "";
     aAbre = "";
     aPath = "";
     nError = 0;
     aAlfa = "";
     aFichero = "";
     &eaFichero = "";
     aLong = "";
     nLong = 0;
     nCarac = 0;
     nPos = 0;
     aCarac = "";
     aProg = "";

     &eaReferencia = "";
     aDia = "";
     aMes = "";
     aAny = "";
     aHora = "";
     aFecha = "";
     fFecha = @;
     swAcaba = 0;
     aLinea = "";
     FLinea = 0;

     &enMes = 0;
     &enAny = 0;
     &enSwAlta = 0;

     nLoc = 0;
     aEtiqueta = "";
     aValor = "";
     aEtiquetaIni = "";
     aEtiquetaFin = "";
     aAlfa1 = "";
     aAlfa2 = "";
     &aCCC = "";
     &aMesLiq = "";
     &aAnyLiq = "";
     nMesLiq = 0;
     nAnyLiq = 0;
     &nEmp = 0;
     &nTra = 0;
     &aNaf = "";
     aNafBusca = "";
     FEstado = 0;
     aDesdeDiaTramo = "";
     aDesdeMesTramo = "";
     aDesdeAnyTramo = "";
     aHastaDiaTramo = "";
     aHastaMesTramo = "";
     aHastaAnyTramo = "";
     aDiasCot = "";
     aCampoFecha = "";
     aNIF = "";
     aDiaRec = "";
     aMesRec = "";
     aAnyRec = "";
     aHoraRec = "";
     aMesDesde = "";
     aMesHasta = "";
     aAnyDesde = "";
     aAnyHasta = "";
     &nMesDesde = 0;
     &nMesHasta = 0;
     nAnyDesde = 0;
     aTipo = "";
     &nTipoFichero = 0;
     nCodigo1 = 0; nCodigo2 = 0; nCodigo3 = 0; nCodigo4 = 0; nCodigo5 = 0;
     nBase1 = 0; nBase2 = 0; nBase3 = 0; nBase4 = 0; nBase5 = 0;
     aCodErr1 = ""; aCodErr2 = ""; aCodErr3 = ""; aCodErr4 = ""; aCodErr5 = "";
     aDesErr1 = ""; aDesErr2 = ""; aDesErr3 = ""; aDesErr4 = ""; aDesErr5 = "";
     aCodErrCCC1 = ""; aCodErrCCC2 = ""; aCodErrCCC3 = ""; aCodErrCCC4 = ""; aCodErrCCC5 = "";
     aDesErrCCC1 = ""; aDesErrCCC2 = ""; aDesErrCCC3 = ""; aDesErrCCC4 = ""; aDesErrCCC5 = "";
     aCodErrNAF1 = ""; aCodErrNAF2 = ""; aCodErrNAF3 = ""; aCodErrNAF4 = ""; aCodErrNAF5 = "";
     aDesErrNAF1 = ""; aDesErrNAF2 = ""; aDesErrNAF3 = ""; aDesErrNAF4 = ""; aDesErrNAF5 = "";
     aTipoDato1 = ""; aTipoDato2 = ""; aTipoDato3 = ""; aTipoDato4 = ""; aTipoDato5 = "";

     &aTipoRespuesta = "";
     &nErrores = 0;
     &swCCCCorrecto = 0;
     swSigue = 0;
     aErrorNoContemplado = "";
     nTotalLineas = 0;
     &aTotalLineas = "";
     nNroLinea = 0;
     aNroLinea = "";
     nTipoError = 0;
     swEncontrada = 0;
     aParam = "";

     &nFichero = 0;
     &nTotalFicheros = 0;
     &aSoloFichero = "";

     nNume = 0;
     aLon = "";
     nLon = 0;
     nEspacio = 0;
     aEspacio = "";
     nBlancos = 0;
     nBlancosIzd = 0;
     nBlancosDer = 0;
     aBlancosIzd = "";
     aBlancosDer = "";

     aCadena = "";
     aCadenaSal = "";

     aTipoDato = "";
     nCampo = 0;
     nCampo1 = 0;
     nCodigo = 0;
     nBase = 0;
     nElemento = 0;
     aCodPec1 = ""; aCodPec2 = ""; aCodPec3 = ""; aCodPec4 = ""; aCodPec5 = "";
     aCodCol1 = ""; aCodCol2 = ""; aCodCol3 = ""; aCodCol4 = ""; aCodCol5 = "";
     aCodPecAnt = "";
     &nTipo = 0;

     nEmp1 = 0; nEmp2 = 0; nEmp3 = 0; nEmp4 = 0; nEmp5 = 0;
     nTra1 = 0; nTra2 = 0; nTra3 = 0; nTra4 = 0; nTra5 = 0;
     nTrabAlta = 0;
     nVeces = 0;

     &aMesControl = "";
     &aAnyControl = "";
     &nMesControl = 0;
     &nAnyControl = 0;
     swAtrasos = 0;
|FIN;

/****************************************************************************/
/**********   PROCESO DESDE LA PANTALLA PARA BUSCAR EL FICHERO   ************/
/****************************************************************************/

|PROCESO Browse;
     swSigue = 0;
     aAlfa = #0#0;
     |QBF aAlfa;
     |SI FSalida = 10;
          swSigue = 1;
     |FINSI;
     |SI FSalida = 0; |Y aAlfa = "";
          swSigue = 1;
     |FINSI;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     aRuta    = "";

     |HAZ Traete_dsselect;

     |ESPECIFICA "RBASS", aContiene;
     aDirLocal = aContiene;
     aUnidad = aDirLocal % 102;

     aAux = aUnidad + "\DOCUMENTOS\";
     aPrograma = aAux + "dsselect.exe";

     aPathDSSelect = aAux;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aParaIni = aAux + "dsselect.ini";
     |RFBORRA aParaIni;

     aCarpetaCaptura = aUnidad;

     aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aTextoIni;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPrograma;
     |RSYSTEM aEjecuta;

     aAbre = aPathDSSelect + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
          aPath = "";
          nError = 1;
          |ACABA;
     |SINO;
          |XLEE nHandle, 250, aPath;
          |SI FSalida < 0
               nError = 1;
          |SINO;
               |QBF aPath;
               |SI aPath ! "";
                    aAlfa    = aPath;
                    aFichero = "";
                    aLong    = aAlfa % 0;
                    nLong    = aLong;
                    aRuta    = "";
                    |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
                          nPos   = (nCarac * 100) + 1;
                          aCarac =  aAlfa % nPos;
                          |SI aCarac = "/";  |O aCarac = "\";
                              aProg = "";
                          |SINO;
                              aProg = aProg + aCarac;
                          |FINSI;

                          aRuta = aRuta + aCarac;
                    |SIGUE;
               |FINSI;
          |FINSI;
     |FINSI;
     |XCIERRA nHandle;
     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     #0#0 = aRuta;
     |PINTA #0#0;
|FPRC;

/****************************************************************************/
/***********     PROCESOS PARA BUSCAR LAS ETIQUETAS       *******************/
/****************************************************************************/

|PROCESO BuscaEtiFin;
     nLoc = 0;
     aEtiqueta = "</" + aEtiqueta + ">";
     aAlfa = aLinea - aEtiqueta;
     |SI aAlfa ! aLinea;
          nLoc = 1;
     |FINSI;
|FPRC;

|PROCESO BuscaEtiIni;
     nLoc = 0;
     aEtiqueta = "<" + aEtiqueta;
     aAlfa = aLinea - aEtiqueta;
     |SI aAlfa ! aLinea;
          nLoc = 1;
     |FINSI;
|FPRC;

|PROCESO BuscaEtiIniFin;
     aValor = "";
     nLoc = 0;

     aEtiquetaIni = "<" + aEtiqueta + ">";
     aEtiquetaFin = "</" + aEtiqueta + ">";
     aAlfa = aLinea - aEtiquetaIni - aEtiquetaFin;
     |SI aAlfa ! aLinea;
          aValor = aAlfa;
          |SI aEtiqueta = "Descripcion";
               |QBF aValor;
          |SINO;
               |QBT aValor;
          |FINSI;
          nLoc = 1;
     |FINSI;
|FPRC;

|PROCESO Alinea;
     aAlfa = nNume; |QBF aAlfa;
     |SI nNume < 10;
          aAlfa = "  " + aAlfa;
     |SINO;
          |SI nNume < 100;
               aAlfa = " " + aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Centra;
     aLon = aCadena % 0;
     nLon = aLon;
     nBlancos = nEspacio - nLon;
     nNume = nBlancos / 2;
     nBlancosIzd = nNume ! 0;
     nBlancosDer = nBlancos - nBlancosIzd;
     aBlancosIzd = " " * nBlancosIzd;
     aBlancosDer = " " * nBlancosDer;
     aCadenaSal = aBlancosIzd + aCadena + aBlancosDer;
|FPRC;

|PROCESO LeeLinea;
     |XLEE nHandle, 250, aLinea;
     FLinea = FSalida;
     nNroLinea = nNroLinea + 1;
     aNroLinea = nNroLinea;
     aAlfa = " Linea " + aNroLinea + " de " + aTotalLineas;

     |ATRI R;
     aCadena = aAlfa; nEspacio = 34; |HAZ Centra;
     |PINTA 2223, aCadenaSal;
     |ATRI 0;
|FPRC;

/****************************************************************************/
/*********** PROCESOS PARA GRABAR LOS TRAMOS Y TRABAJADORES *****************/
/****************************************************************************/

|PROCESO BuscaCodigo;
     nTra = #cretam04#7;
|FPRC;

|DEFBUCLE BuscaCodigo;
     #cretam04#1;
     ;
     nEmp, enAny, enMes, nTipo, aCCC, aNaf, 01;
     nEmp, enAny, enMes, nTipo, aCCC, aNaf, 99;
     ;
     NULL, BuscaCodigo;
|FIN;

|PROCESO BuscaCodTrab;
     nTra = 0;

     enMes = aMesLiq;
     enAny = aAnyLiq;
     |SI nTipo = 2;
          |SI nMesDesde ! nMesLiq;
               enMes = nMesDesde;
               enAny = nAnyDesde;
          |FINSI;
     |FINSI;

     |BUCLE BuscaCodigo;


/*
     |SI nTipo = 2; |Y nMesTramo ! nMesDesde; |Y aDiaDesdeTramo = "01";
          #cretam04#2 = nMesDesde;
          #cretam04#6 = 99;
     |FINSI;
*/
     |SI nTra = 0;
/*
          || no doy mensaje, de momento
          aAlfa1 = "";
          aAlfa = nEmp; |QBF aAlfa; aAlfa = ("00000" + aAlfa) % -105;
          aAlfa = "    Emp: " + aAlfa; |QBF aAlfa;
          aAlfa1 = aAlfa1 + aAlfa;

          aAlfa = ". NAF " + aNaf; |QBF aAlfa;
          aAlfa1 = aAlfa1 + aAlfa;

          aAlfa = " del Fichero de Bases no existe en Liq."; |QBF aAlfa;
          aAlfa1 = aAlfa1 + aAlfa + " " + aSoloFichero;

          |MENAV aAlfa1;
*/
     |FINSI;
|FPRC;

|PROCESO BuscaCCC;
     nEmp = #cretam02#0;
     swEncontrada = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE BuscaCCC_At;
     #cretam02#1;
     19;
     00001, 2000, nMesDesde, nTipo, aCCC, nAnyDesde;
     99999, 2999, nMesHasta, nTipo, aCCC, nAnyDesde;
     ;
     NULL, BuscaCCC;
|FIN;

|DEFBUCLE BuscaCCC;
     #cretam02#1;
     ;
     00001, nAnyDesde, nMesDesde, nTipo, aCCC;
     99999, nAnyDesde, nMesHasta, nTipo, aCCC;
     ;
     NULL, BuscaCCC;
|FIN;

|PROCESO BuscaPorCCC;
     swEncontrada = 0;

     |SI swAtrasos = 0;
          |BUCLE BuscaCCC;
     |SINO;
          |BUCLE BuscaCCC_At;
     |FINSI;

     #labempre#0 = nEmp;
     |LEE 000#labempre.=;
|FPRC;

|PROCESO BuscaPorNaf;
     #labempre#0 = #labtraba#0;
     |LEE 000#labempre.=;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida = 0;
          aAlfa1 = #labcentr#10;
          |QBF aAlfa1;
          |SI aAlfa1 = "";
               aAlfa1 = #labempre#13;
          |FINSI;
     |FINSI;

     |SI #labtraba#45 = "421"; |O #labtraba#45 = "422";
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = "87";
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aAlfa1 = #nomcenes#10;
          |FINSI;
     |FINSI;

     |QBF aAlfa1;
     aAlfa2 = aCCC % 511;
     |SI aAlfa1 = aAlfa2;
          || el CCC al que pertenece el trabajador es el mismo que me viene
          || en el XML, ahora voy a ver si esta de alta en este periodo

          enMes = aMesLiq;
          enAny = aAnyLiq;
          |SI nTipo = 2;
               |SI nMesDesde ! nMesLiq;
                    enMes = nMesDesde;
                    enAny = nAnyDesde;
               |FINSI;
          |FINSI;
          |HAZ CompAltaTrab_plb;
          |SI enSwAlta = 1;
               nTrabAlta = nTrabAlta + 1;
               |SI nEmp1 = 0;
                    nEmp1 = #labtraba#0;
                    nTra1 = #labtraba#1;
               |SINO;
                    |SI nEmp2 = 0;
                         nEmp2 = #labtraba#0;
                         nTra2 = #labtraba#1;
                    |SINO;
                         |SI nEmp3 = 0;
                              nEmp3 = #labtraba#0;
                              nTra3 = #labtraba#1;
                         |SINO;
                              |SI nEmp4 = 0;
                                   nEmp4 = #labtraba#0;
                                   nTra4 = #labtraba#1;
                              |SINO;
                                   |SI nEmp5 = 0;
                                        nEmp5 = #labtraba#0;
                                        nTra5 = #labtraba#1;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaPorNaf;
     #labtraba#1;
     75;
     nEmp, 00001, aNafBusca;
     nEmp, 99999, aNafBusca;
     ;
     NULL, BuscaPorNaf;
|FIN;

|PROCESO GrabaTipoDato;
     |SI aTipoDato = "C";
          |PARA nCampo = 30; |SI nCampo [ 39; |HACIENDO nCampo = nCampo + 2;
               nCampo1 = nCampo + 1;
               |SI #cretam24#nCampo# = 0;
                    #cretam24#nCampo# = nCodigo;
                    #cretam24#nCampo1# = nBase / 100;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI aTipoDato = "I";
          |PARA nCampo = 50; |SI nCampo [ 59; |HACIENDO nCampo = nCampo + 2;
               nCampo1 = nCampo + 1;
               |SI #cretam24#nCampo# = 0;
                    #cretam24#nCampo# = nCodigo;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI aTipoDato = "H";
          |PARA nCampo = 60; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 2;
               nCampo1 = nCampo + 1;
               |SI #cretam24#nCampo# = 0;
                    #cretam24#nCampo# = nCodigo;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO GrabaTramo;
     |DDEFECTO #labtraba;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     |SI nEmp = 0;
          |HAZ BuscaPorCCC;
     |FINSI;

     |SI nTipoFichero = 2;
          |DDEFECTO #cretam24;
          #cretam24#0 = nEmp;
          #cretam24#1 = aAnyLiq;
          #cretam24#2 = aMesLiq;
          #cretam24#3 = 0;
          #cretam24#4 = aCCC;
          #cretam24#5 = aNaf;
          #cretam24#6 = aDesdeDiaTramo;
          #cretam24#72 = eaReferencia;
          |LEE 101#cretam24.=;
          FEstado = FSalida;

          #cretam24#7 = nTra;
          aFecha = aDesdeDiaTramo + "." + aDesdeMesTramo + "." + aDesdeAnyTramo;
          #cretam24#8 = aFecha;
          aFecha = aHastaDiaTramo + "." + aHastaMesTramo + "." + aHastaAnyTramo;
          #cretam24#9 = aFecha;
          #cretam24#20 = aDesdeDiaTramo;
          #cretam24#21 = aHastaDiaTramo;
          #cretam24#22 = aDiasCot;
          #cretam24#29 = #labtraba#2;
          |SI aTipoDato1 ! "";
               aTipoDato = aTipoDato1; nCodigo = nCodigo1; nBase = nBase1;
               |HAZ GrabaTipoDato;
          |FINSI;
          |SI aTipoDato2 ! "";
               aTipoDato = aTipoDato2; nCodigo = nCodigo2; nBase = nBase2;
               |HAZ GrabaTipoDato;
          |FINSI;
          |SI aTipoDato3 ! "";
               aTipoDato = aTipoDato3; nCodigo = nCodigo3; nBase = nBase3;
               |HAZ GrabaTipoDato;
          |FINSI;
          |SI aTipoDato4 ! "";
               aTipoDato = aTipoDato4; nCodigo = nCodigo4; nBase = nBase4;
               |HAZ GrabaTipoDato;
          |FINSI;
          |SI aTipoDato5 ! "";
               aTipoDato = aTipoDato5; nCodigo = nCodigo5; nBase = nBase5;
               |HAZ GrabaTipoDato;
          |FINSI;

          #cretam24#73 = aSoloFichero;

          |SI aCodPec1 ! "";
               #cretam24#74 = aCodPec1;
               #cretam24#75 = aCodCol1;
          |FINSI;
          |SI aCodPec2 ! "";
               #cretam24#76 = aCodPec2;
               #cretam24#77 = aCodCol2;
          |FINSI;
          |SI aCodPec3 ! "";
               #cretam24#78 = aCodPec3;
               #cretam24#79 = aCodCol3;
          |FINSI;
          |SI aCodPec4 ! "";
               #cretam24#80 = aCodPec4;
               #cretam24#81 = aCodCol4;
          |FINSI;
          |SI aCodPec5 ! "";
               #cretam24#82 = aCodPec5;
               #cretam24#83 = aCodCol5;
          |FINSI;

          |SI FEstado = 0;
               |GRABA 020#cretam24.a;
          |SINO;
               |GRABA 020#cretam24.n;
          |FINSI;

          |LIBERA #cretam24;
     |FINSI;
     |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
          |DDEFECTO #cretam26;
          #cretam26#0 = nEmp;
          #cretam26#1 = aAnyLiq;
          #cretam26#2 = aMesLiq;
          #cretam26#3 = nTipo;
          #cretam26#4 = aCCC;
          #cretam26#5 = aNaf;
          #cretam26#6 = aDesdeDiaTramo;
          #cretam26#72 = eaReferencia;
          #cretam26#73 = nTipoError;

          |LEE 101#cretam26.=;
          FEstado = FSalida;

          #cretam26#7 = nTra;
          aFecha = aDesdeDiaTramo + "." + aDesdeMesTramo + "." + aDesdeAnyTramo;
          #cretam26#8 = aFecha;
          aFecha = aHastaDiaTramo + "." + aHastaMesTramo + "." + aHastaAnyTramo;
          #cretam26#9 = aFecha;
          #cretam26#20 = aDesdeDiaTramo;
          #cretam26#21 = aHastaDiaTramo;
          #cretam26#22 = aDiasCot;
          #cretam26#29 = #labtraba#2;

          #cretam26#10 = aCodErr1;
          #cretam26#11 = aDesErr1;
          #cretam26#12 = aCodErr2;
          #cretam26#13 = aDesErr2;
          #cretam26#14 = aCodErr3;
          #cretam26#15 = aDesErr3;
          #cretam26#16 = aCodErr4;
          #cretam26#17 = aDesErr4;
          #cretam26#18 = aCodErr5;
          #cretam26#19 = aDesErr5;

          #cretam26#30 = nCodigo1;
          |SI aTipoDato1 = "C";
               #cretam26#31 = nBase1 / 100;
          |SINO;
               #cretam26#31 = nBase1;
          |FINSI;

          #cretam26#32 = nCodigo2;
          |SI aTipoDato2 = "C";
               #cretam26#33 = nBase2 / 100;
          |SINO;
               #cretam26#33 = nBase2;
          |FINSI;

          #cretam26#34 = nCodigo3;
          |SI aTipoDato3 = "C";
               #cretam26#35 = nBase3 / 100;
          |SINO;
               #cretam26#35 = nBase3;
          |FINSI;

          #cretam26#36 = nCodigo4;
          |SI aTipoDato4 = "C";
               #cretam26#37 = nBase4 / 100;
          |SINO;
               #cretam26#37 = nBase4;
          |FINSI;

          #cretam26#38 = nCodigo5;
          |SI aTipoDato5 = "C";
               #cretam26#39 = nBase5 / 100;
          |SINO;
               #cretam26#39 = nBase5;
          |FINSI;

          |SI FEstado = 0;
               |GRABA 020#cretam26.a;
          |SINO;
               |GRABA 020#cretam26.n;
          |FINSI;

          |LIBERA #cretam26;
     |FINSI;
|FPRC;

|PROCESO GrabaTrabajador;
     |DDEFECTO #labtraba;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     |SI nEmp = 0;
          |HAZ BuscaPorCCC;
     |FINSI;

     #labempre#0 = nEmp;
     |LEE 000#labempre.=;

     |SI nTipoFichero = 2;
          |DDEFECTO #cretam23;
          #cretam23#0 = nEmp;
          #cretam23#1 = aAnyLiq;
          #cretam23#2 = aMesLiq;
          #cretam23#3 = 0;
          #cretam23#4 = aCCC;
          #cretam23#5 = aNaf;
          #cretam23#13 = eaReferencia;
          |LEE 101#cretam23.=;
          FEstado = FSalida;

          #cretam23#6 = #labempre#2;
          #cretam23#8 = #labcentr#2;
          #cretam23#9 = #labtraba#2;
          || #cretam23#10 = #labtraba#7;
          #cretam23#10 = aNIF;
          #cretam23#11 = nTra;
          #cretam23#14 = aSoloFichero;

          |SI FEstado = 0;
               |GRABA 020#cretam23.a;
          |SINO;
               |GRABA 020#cretam23.n;
          |FINSI;

          |LIBERA #cretam23;
     |FINSI;

     |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
          |DDEFECTO #cretam25;
          #cretam25#0 = nEmp;
          #cretam25#1 = aAnyLiq;
          #cretam25#2 = aMesLiq;
          #cretam25#3 = nTipo;
          #cretam25#4 = aCCC;
          #cretam25#5 = aNaf;
          #cretam25#13 = eaReferencia;
          |LEE 101#cretam25.=;
          FEstado = FSalida;
          #cretam25#6 = #labempre#2;
          #cretam25#8 = #labcentr#2;
          #cretam25#9 = #labtraba#2;
          #cretam25#10 = aNIF;
          #cretam25#11 = nTra;

          #cretam25#14 = aCodErrNAF1;
          #cretam25#15 = aDesErrNAF1;
          #cretam25#16 = aCodErrNAF2;
          #cretam25#17 = aDesErrNAF2;
          #cretam25#18 = aCodErrNAF3;
          #cretam25#19 = aDesErrNAF3;
          #cretam25#20 = aCodErrNAF4;
          #cretam25#21 = aDesErrNAF4;
          #cretam25#22 = aCodErrNAF5;
          #cretam25#23 = aDesErrNAF5;

          |SI FEstado = 0;
               |GRABA 020#cretam25.a;
          |SINO;
               |GRABA 020#cretam25.n;
          |FINSI;

          |LIBERA #cretam25;
     |FINSI;
|FPRC;

|PROCESO GrabaCCC;
     |SI nEmp = 0;
          |HAZ BuscaPorCCC;
     |FINSI;

     |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
          |DDEFECTO #cretam27;
          #cretam27#0 = nEmp;
          #cretam27#1 = aAnyLiq;
          #cretam27#2 = aMesLiq;
          #cretam27#3 = nTipo;
          #cretam27#4 = aCCC;
          || #cretam25#5 = aNaf;
          #cretam27#13 = eaReferencia;
          |LEE 101#cretam27.=;
          FEstado = FSalida;
          #cretam27#6 = #labempre#2;
          || #cretam27#8 = #labcentr#2;
          || #cretam27#9 = #labtraba#2;
          || #cretam27#10 = aNIF;
          || #cretam27#11 = nTra;

          #cretam27#14 = aCodErrCCC1;
          #cretam27#15 = aDesErrCCC1;
          #cretam27#16 = aCodErrCCC2;
          #cretam27#17 = aDesErrCCC2;
          #cretam27#18 = aCodErrCCC3;
          #cretam27#19 = aDesErrCCC3;
          #cretam27#20 = aCodErrCCC4;
          #cretam27#21 = aDesErrCCC4;
          #cretam27#22 = aCodErrCCC5;
          #cretam27#23 = aDesErrCCC5;

          |SI FEstado = 0;
               |GRABA 020#cretam27.a;
          |SINO;
               |GRABA 020#cretam27.n;
          |FINSI;

          |LIBERA #cretam27;
     |FINSI;
     |SI nTipoFichero = 2;
          |DDEFECTO #cretam22;
          #cretam22#0 = nEmp;
          #cretam22#1 = aAnyLiq;
          #cretam22#2 = aMesLiq;
          #cretam22#3 = 0;
          #cretam22#4 = aCCC;
          #cretam22#13 = eaReferencia;
          |LEE 101#cretam22.=;
          FEstado = FSalida;

          #cretam22#6 = #labempre#2;
          #cretam22#8 = #labcentr#2;
          #cretam22#14 = aSoloFichero;

          |SI FEstado = 0;
               |GRABA 020#cretam22.a;
          |SINO;
               |GRABA 020#cretam22.n;
          |FINSI;

          |LIBERA #cretam22;
     |FINSI;
|FPRC;

/****************************************************************************/
/***********        PROCESOS PARA LEER LOS XML            *******************/
/****************************************************************************/

|PROCESO TipoErrorCCC;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "CodigoErr";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;

               |SI aCodErrCCC1 = "";
                    aCodErrCCC1 = aValor;
               |SINO;
                    |SI aCodErrCCC2 = "";
                         aCodErrCCC2 = aValor;
                    |SINO;
                         |SI aCodErrCCC3 = "";
                              aCodErrCCC3 = aValor;
                         |SINO;
                              |SI aCodErrCCC4 = "";
                                   aCodErrCCC4 = aValor;
                              |SINO;
                                   |SI aCodErrCCC5 = "";
                                        aCodErrCCC5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Descripcion";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aDesErrCCC1 = "";
                    aDesErrCCC1 = aValor;
               |SINO;
                    |SI aDesErrCCC2 = "";
                         aDesErrCCC2 = aValor;
                    |SINO;
                         |SI aDesErrCCC3 = "";
                              aDesErrCCC3 = aValor;
                         |SINO;
                              |SI aDesErrCCC4 = "";
                                   aDesErrCCC4 = aValor;
                              |SINO;
                                   |SI aDesErrCCC5 = "";
                                        aDesErrCCC5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Errores";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TipoErrorNAFSS;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "CodigoErr";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;

               |SI aCodErrNAF1 = "";
                    aCodErrNAF1 = aValor;
               |SINO;
                    |SI aCodErrNAF2 = "";
                         aCodErrNAF2 = aValor;
                    |SINO;
                         |SI aCodErrNAF3 = "";
                              aCodErrNAF3 = aValor;
                         |SINO;
                              |SI aCodErrNAF4 = "";
                                   aCodErrNAF4 = aValor;
                              |SINO;
                                   |SI aCodErrNAF5 = "";
                                        aCodErrNAF5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Descripcion";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aDesErrNAF1 = "";
                    aDesErrNAF1 = aValor;
               |SINO;
                    |SI aDesErrNAF2 = "";
                         aDesErrNAF2 = aValor;
                    |SINO;
                         |SI aDesErrNAF3 = "";
                              aDesErrNAF3 = aValor;
                         |SINO;
                              |SI aDesErrNAF4 = "";
                                   aDesErrNAF4 = aValor;
                              |SINO;
                                   |SI aDesErrNAF5 = "";
                                        aDesErrNAF5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Errores";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TipoErrorTramos;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "CodigoErr";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aCodErr1 = "";
                    aCodErr1 = aValor;
               |SINO;
                    |SI aCodErr2 = "";
                         aCodErr2 = aValor;
                    |SINO;
                         |SI aCodErr3 = "";
                              aCodErr3 = aValor;
                         |SINO;
                              |SI aCodErr4 = "";
                                   aCodErr4 = aValor;
                              |SINO;
                                   |SI aCodErr5 = "";
                                        aCodErr5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Descripcion";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aDesErr1 = "";
                    aDesErr1 = aValor;
               |SINO;
                    |SI aDesErr2 = "";
                         aDesErr2 = aValor;
                    |SINO;
                         |SI aDesErr3 = "";
                              aDesErr3 = aValor;
                         |SINO;
                              |SI aDesErr4 = "";
                                   aDesErr4 = aValor;
                              |SINO;
                                   |SI aDesErr5 = "";
                                        aDesErr5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Errores";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TipoFecha;
     aDia = "";
     aMes = "";
     aAny = "";

     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Dia";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aDia = aValor;
          |FINSI;

          aEtiqueta = "Mes";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aMes = aValor;
          |FINSI;

          aEtiqueta = "Anho";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aAny = aValor;
          |FINSI;

          aEtiqueta = aCampoFecha;
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TipoDato;
     nElemento = 0;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "TipoDato";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aTipoDato1 = "";
                    aTipoDato1 = aValor;
                    nElemento = 1;
               |SINO;
                    |SI aTipoDato2 = "";
                         aTipoDato2 = aValor;
                         nElemento = 2;
                    |SINO;
                         |SI aTipoDato3 = "";
                              aTipoDato3 = aValor;
                              nElemento = 3;
                         |SINO;
                              |SI aTipoDato4 = "";
                                   aTipoDato4 = aValor;
                                   nElemento = 4;
                              |SINO;
                                   |SI aTipoDato5 = "";
                                        aTipoDato5 = aValor;
                                        nElemento = 5;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Codigo";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI nCodigo1 = 0;
                    nCodigo1 = aValor;
               |SINO;
                    |SI nCodigo2 = 0;
                         nCodigo2 = aValor;
                    |SINO;
                         |SI nCodigo3 = 0;
                              nCodigo3 = aValor;
                         |SINO;
                              |SI nCodigo4 = 0;
                                   nCodigo4 = aValor;
                              |SINO;
                                   |SI nCodigo5 = 0;
                                        nCodigo5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Valor";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI nBase1 = 0;
                    nBase1 = aValor;
               |SINO;
                    |SI nBase2 = 0;
                         nBase2 = aValor;
                    |SINO;
                         |SI nBase3 = 0;
                              nBase3 = aValor;
                         |SINO;
                              |SI nBase4 = 0;
                                   nBase4 = aValor;
                              |SINO;
                                   |SI nBase5 = 0;
                                        nBase5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
               aEtiqueta = "Errores";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    |HAZ TipoErrorTramos;
               |FINSI;
          |FINSI;

          |SI nTipoFichero = 2;
               aEtiqueta = "IndicadorObligatoriedad";
               |HAZ BuscaEtiIniFin;
               |SI nLoc = 1; |Y aValor = "P";
                    |SI nElemento = 1;
                         aTipoDato1 = ""; nBase1 = 0; nCodigo1 = 0;
                    |FINSI;
                    |SI nElemento = 2;
                         aTipoDato2 = ""; nBase2 = 0; nCodigo2 = 0;
                    |FINSI;
                    |SI nElemento = 3;
                         aTipoDato3 = ""; nBase3 = 0; nCodigo3 = 0;
                    |FINSI;
                    |SI nElemento = 4;
                         aTipoDato4 = ""; nBase4 = 0; nCodigo4 = 0;
                    |FINSI;
                    |SI nElemento = 5;
                         aTipoDato5 = ""; nBase5 = 0; nCodigo5 = 0;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI nTipoFichero = 2;
               aEtiqueta = "DatoSolicitado";
               |HAZ BuscaEtiFin;
               |SI nLoc = 1;
                    |SAL;
               |FINSI;
          |FINSI;

          |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
               aEtiqueta = "Dato";
               |HAZ BuscaEtiFin;
               |SI nLoc = 1;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DatosTramo;
     aTipoDato1 = ""; aTipoDato2 = ""; aTipoDato3 = ""; aTipoDato4 = ""; aTipoDato5 = "";
     nCodigo1 = 0; nCodigo2 = 0; nCodigo3 = 0; nCodigo4 = 0; nCodigo5 = 0;
     nBase1 = 0; nBase2 = 0; nBase3 = 0; nBase4 = 0; nBase5 = 0;

     aCodErr1 = ""; aCodErr2 = ""; aCodErr3 = ""; aCodErr4 = ""; aCodErr5 = "";
     aDesErr1 = ""; aDesErr2 = ""; aDesErr3 = ""; aDesErr4 = ""; aDesErr5 = "";

     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          |SI nTipoFichero = 2;
               aEtiqueta = "DatoSolicitado";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    |HAZ TipoDato;
               |FINSI;
          |FINSI;

          |SI aTipoRespuesta = "B"; |O aTipoRespuesta = "R";
               aEtiqueta = "Dato";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    |HAZ TipoDato;
               |FINSI;
          |FINSI;

          aEtiqueta = "DatosTramo";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Peculiaridades;
     aCodPec1 = ""; aCodPec2 = ""; aCodPec3 = ""; aCodPec4 = ""; aCodPec5 = "";
     aCodPecAnt = "";
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "CodPec";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1; |Y aValor ! aCodPecAnt;
               aCodPecAnt = aValor;
               |SI aCodPec1 = "";
                    aCodPec1 = aValor;
               |SINO;
                    |SI aCodPec2 = "";
                         aCodPec2 = aValor;
                    |SINO;
                         |SI aCodPec3 = "";
                              aCodPec3 = aValor;
                         |SINO;
                              |SI aCodPec4 = "";
                                   aCodPec4 = aValor;
                              |SINO;
                                   |SI aCodPec5 = "";
                                        aCodPec5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "ColectIncentivado";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |SI aCodCol1 = "";
                    aCodCol1 = aValor;
               |SINO;
                    |SI aCodCol2 = "";
                         aCodCol2 = aValor;
                    |SINO;
                         |SI aCodCol3 = "";
                              aCodCol3 = aValor;
                         |SINO;
                              |SI aCodCol4 = "";
                                   aCodCol4 = aValor;
                              |SINO;
                                   |SI aCodCol5 = "";
                                        aCodCol5 = aValor;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;

          aEtiqueta = "Peculiaridades";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Tramo;
     aCodPec1 = ""; aCodPec2 = ""; aCodPec3 = ""; aCodPec4 = ""; aCodPec5 = "";
     aCodCol1 = ""; aCodCol2 = ""; aCodCol3 = ""; aCodCol4 = ""; aCodCol5 = "";
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;
          aEtiqueta = "FechaDesde";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "FechaDesde";
               |HAZ TipoFecha;
               aDesdeDiaTramo = aDia;
               aDesdeMesTramo = aMes;
               aDesdeAnyTramo = aAny;
          |FINSI;

          aEtiqueta = "FechaHasta";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "FechaHasta";
               |HAZ TipoFecha;
               aHastaDiaTramo = aDia;
               aHastaMesTramo = aMes;
               aHastaAnyTramo = aAny;
          |FINSI;

          aEtiqueta = "DiasCotizados";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aDiasCot = aValor;
          |FINSI;

          |SI nTipoError = 1; |O nTipoError = 2;
               || los errores y demas datos del tramo para el tipo de error
               || uno, que son los datos no enviados o mal enviados aqui

               aEtiqueta = "DatosTramo";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    |HAZ DatosTramo;
               |FINSI;
          |FINSI;

          aEtiqueta = "Peculiaridades";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ Peculiaridades;
          |FINSI;

          |SI nTipoError = 1; |O nTipoError = 2;
               || los errores y demas datos del tramo para el tipo de error
               || DOS, que son los datos no tratados aqui

               aEtiqueta = "Errores";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nCodigo1 = 0; nCodigo2 = 0; nCodigo3 = 0; nCodigo4 = 0; nCodigo5 = 0;
                    nBase1 = 0; nBase2 = 0; nBase3 = 0; nBase4 = 0; nBase5 = 0;

                    aCodErr1 = ""; aCodErr2 = ""; aCodErr3 = ""; aCodErr4 = ""; aCodErr5 = "";
                    aDesErr1 = ""; aDesErr2 = ""; aDesErr3 = ""; aDesErr4 = ""; aDesErr5 = "";

                    |HAZ TipoErrorTramos;
               |FINSI;
          |FINSI;


          aEtiqueta = "Tramo";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |HAZ GrabaTramo;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Tramos;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Tramo";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ Tramo;
          |FINSI;

          aEtiqueta = "Tramos";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

/****************************************************************************/
/********   BUCLES PARA BORRAR LECTURAS ANTERIORES DEL MISMO FICHERO ********/
/****************************************************************************/

|PROCESO Borra_cretam26;
     |BORRA 020#cretam26.a;
     |LIBERA #cretam26;
|FPRC;

|DEFBUCLE Borra_cretam26;
     #cretam26#3;
     ;
     eaReferencia;
     eaReferencia;
     ;
     NULL, Borra_cretam26;
|FIN;

|PROCESO Borra_cretam27;
     |BORRA 020#cretam27.a;
     |LIBERA #cretam27;
|FPRC;

|DEFBUCLE Borra_cretam27;
     #cretam27#2;
     ;
     eaReferencia;
     eaReferencia;
     ;
     NULL, Borra_cretam27;
|FIN;

|PROCESO Borra_cretam25;
     |BORRA 020#cretam25.a;
     |LIBERA #cretam25;
|FPRC;

|DEFBUCLE Borra_cretam25;
     #cretam25#2;
     ;
     eaReferencia;
     eaReferencia;
     ;
     NULL, Borra_cretam25;
|FIN;

|PROCESO Borra_cretam24;
     |BORRA 020#cretam24.a;
     |LIBERA #cretam24;
|FPRC;

|DEFBUCLE Borra_cretam24;
     #cretam24#3;
     4;
     eaReferencia, aCCC;
     eaReferencia, aCCC;
     ;
     NULL, Borra_cretam24;
|FIN;

|PROCESO Borra_cretam23;
     |BORRA 020#cretam23.a;
     |LIBERA #cretam23;
|FPRC;

|DEFBUCLE Borra_cretam23;
     #cretam23#2;
     4;
     eaReferencia, aCCC;
     eaReferencia, aCCC;
     ;
     NULL, Borra_cretam23;
|FIN;

|PROCESO BorraAnteriores;
     |BUCLE Borra_cretam27;
     |BUCLE Borra_cretam25;
     |BUCLE Borra_cretam26;
|FPRC;

/****************************************************************************/

|PROCESO BuscaTrabajador;
     || nEmp = 0;
     nTra = 0;
     nEmp1 = 0; nEmp2 = 0; nEmp3 = 0; nEmp4 = 0; nEmp5 = 0;
     nTra1 = 0; nTra2 = 0; nTra3 = 0; nTra4 = 0; nTra5 = 0;
     nTrabAlta = 0;
     aNaf = (aNaf + "                  ") % 115;
     aNafBusca = aNaf;
     |BUCLE BuscaPorNaf;

     nTra = nTra1;

     |SI nTra = 00000;
          || puede ser un Naf mal introducido, intento buscarlo
          || quitando un cero detras de la provincia si existe,
          || es el tipico fallo

          aAlfa = aNaf % 301;
          |SI aAlfa = "0";
               aNafBusca = (aNaf % 102) + (aNaf % 409);
               aNafBusca = (aNafBusca + "                  ") % 115;
               |BUCLE BuscaPorNaf;
          |FINSI;
     |FINSI;
     |SI nTra = 00000;
          || lo mismo, pero con dos ceros

          aAlfa = aNaf % 302;
          |SI aAlfa = "00";
               aNafBusca = (aNaf % 102) + (aNaf % 508);
               aNafBusca = (aNafBusca + "                  ") % 115;
               |BUCLE BuscaPorNaf;
          |FINSI;
     |FINSI;
     |SI nTra = 00000;
          || y hasta con tres ceros, por si acaso, que de todo hay

          aAlfa = aNaf % 303;
          |SI aAlfa = "000";
               aNafBusca = (aNaf % 102) + (aNaf % 607);
               aNafBusca = (aNafBusca + "                  ") % 115;
               |BUCLE BuscaPorNaf;
          |FINSI;
     |FINSI;

     |SI nTrabAlta > 1;
          |PARA nVeces = 1; |SI nVeces [ nTrabAlta; |HACIENDO nVeces = nVeces + 1;
               |SI nVeces = 1; nEmp = nEmp1; nTra = nTra1; |FINSI;
               |SI nVeces = 2; nEmp = nEmp2; nTra = nTra2; |FINSI;
               |SI nVeces = 3; nEmp = nEmp3; nTra = nTra3; |FINSI;
               |SI nVeces = 4; nEmp = nEmp4; nTra = nTra4; |FINSI;
               |SI nVeces = 5; nEmp = nEmp5; nTra = nTra5; |FINSI;

               #cretam01#0 = nEmp;
               #cretam01#1 = nAnyLiq;
               #cretam01#2 = nMesLiq;
               #cretam01#3 = nTipo;
               |LEE 000#cretam01.=;
               |SI FSalida = 0;
                    || quiere decir que EXISTE en este mes una liquidacion
                    || de esta empresa, con lo que supongo que es la buena,
                    || en la que esta el trabajador calculado.

                    |SAL;
               |FINSI;
          |SIGUE;
     |SINO;
          nEmp = nEmp1;
          nTra = nTra1;
     |FINSI;
|FPRC;

|PROCESO Trabajador;
     ||SI nTipoError = 1;
          || los tiene que poner a cero solo en la primera pasada
          || no se por que solo para los errores tipo 1, para los del tipo 2
          || evidentemente tambien
          aCodErrNAF1 = ""; aCodErrNAF2 = ""; aCodErrNAF3 = ""; aCodErrNAF4 = ""; aCodErrNAF5 = "";
          aDesErrNAF1 = ""; aDesErrNAF2 = ""; aDesErrNAF3 = ""; aDesErrNAF4 = ""; aDesErrNAF5 = "";
     ||FINSI;

     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Naf";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aNaf = aValor;
               || busco ya el codigo de trabajador
               |HAZ BuscaCodTrab;
               |SI nTra = 0;
                    |HAZ BuscaTrabajador;
               |FINSI;
          |FINSI;

          aEtiqueta = "NumeroIpf";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aNIF = aValor % -109;
          |FINSI;

          || la etiqueta "Errores" en principio solo en el fichero de BASES
          aEtiqueta = "Errores";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ TipoErrorNAFSS;
          |FINSI;

          aEtiqueta = "Tramos";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               |HAZ Tramos;
          |FINSI;

          aEtiqueta = "Trabajador";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |HAZ GrabaTrabajador;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Trabajadores;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Trabajador";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ Trabajador;

               || acabo con el error devuelto por este trabajador
               || lo cuento y luego grabo registro

               |SI nTipoFichero = 1;   || fichero de bases
                    ||SI aCodErrNAF1 ! "R9501";
                         || este codigo de error no invalida la liquidacion
                         || si no hay errores de CCC
                         nErrores = nErrores + 1
                    ||FINSI;
               |FINSI;

               || el registro lo grabo para la respuesta al fichero de bases
               || y para el fichero de trabajadores y tramos, pero si he entrado
               || en la etiqueta Trabajador se trata de un error solo si estoy
               || en el fichero de bases, si estoy en el de trabajadores y
               || tramos, son los datos del trabajador, no cuento error
               |HAZ RegistroNAFSS;
          |FINSI;

          aEtiqueta = "Trabajadores";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO LiquidacionMes;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "MesLiquidativo";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "MesLiquidativo";
               |HAZ TipoFecha;
               aMesLiq = aMes;
               nMesLiq = aMesLiq;
               aAnyLiq = aAny;
               nAnyLiq = aAnyLiq;
          |FINSI;

          aEtiqueta = "Trabajadores";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ Trabajadores;
          |FINSI;

          || esto es para errores por CCC que aparecen en "Datos No Tratados"
          aEtiqueta = "Errores";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ TipoErrorCCC;
               |SI aCodErrCCC1 = "R9500"; |O aCodErrCCC2 = "R9500";
               |O aCodErrCCC3 = "R9500"; |O aCodErrCCC4 = "R9500";
               |O aCodErrCCC5 = "R9500";
                    swCCCCorrecto = 2;  || liquidacion ya confirmada
               |FINSI;
          |FINSI;

          aEtiqueta = "LiquidacionMes";         || Fin de la liquidacion
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO FechaHoraRec;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "FechaRecaudacion";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "FechaRecaudacion";
               |HAZ TipoFecha;
               aDiaRec = aDia;
               aMesRec = aMes;
               aAnyRec = aAny;
          |FINSI;

          aEtiqueta = "HoraRecaudacion";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aHoraRec = aValor;
          |FINSI;

          aEtiqueta = "FechaHoraRecaudacion";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CCC;
     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Regimen";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aCCC = aValor;
          |FINSI;

          aEtiqueta = "Provincia";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aCCC = aCCC + aValor;
          |FINSI;

          aEtiqueta = "Numero";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               aCCC = aCCC + aValor;
          |FINSI;

          aEtiqueta = "Ccc";
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaReferencia;
     |ABRE #cretam05;

     || aqui se atualizaran los datos de la referencia asociada

     #cretam05#0 = eaReferencia % 101;
     #cretam05#1 = eaReferencia % 202;
     #cretam05#2 = eaReferencia % 402;
     #cretam05#3 = eaReferencia % 603;
     |LEE 101#cretam05.=;
     |SI FSalida = 0;
          #cretam05#11 = "R";
          #cretam05#12 = "Recibida respuesta";

          aAlfa = aDia + "." + aMes + "." + aAny;
          fFecha = aAlfa;
          #cretam05#13 = fFecha;

          aAlfa = (aHora % 102) + ":" + (aHora % 302);
          #cretam05#14 = aAlfa;

          |GRABA 020#cretam05.a;
     |FINSI;
     |LIBERA #cretam05;

     |CIERRA #cretam05;
|FPRC;

|PROCESO Liquidacion;
     aCodErrCCC1 = ""; aCodErrCCC2 = ""; aCodErrCCC3 = ""; aCodErrCCC4 = ""; aCodErrCCC5 = "";
     aDesErrCCC1 = ""; aDesErrCCC2 = ""; aDesErrCCC3 = ""; aDesErrCCC4 = ""; aDesErrCCC5 = "";

     |PARA; |SI; |HACIENDO;
          |HAZ LeeLinea;

          aEtiqueta = "Ccc";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ CCC;
               |BUCLE Borra_cretam23;
               |BUCLE Borra_cretam24;
          |FINSI;

          aEtiqueta = "PeriodoDesde";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "PeriodoDesde";
               |HAZ TipoFecha;
               aMesDesde = aMes;
               aAnyDesde = aAny;

               nAnyDesde = aAnyDesde;
               nMesDesde = aMesDesde;
          |FINSI;

          aEtiqueta = "PeriodoHasta";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "PeriodoHasta";
               |HAZ TipoFecha;
               aMesHasta = aMes;
               aAnyHasta = aAny;

               nMesHasta = aMesHasta;
          |FINSI;

          aEtiqueta = "Tipo";
          |HAZ BuscaEtiIniFin;
          |SI nLoc = 1;
               swAtrasos = 0;
               aTipo = aValor;
               |SI aTipo = "L00";
                    nTipo = 00;
               |FINSI;
               |SI aTipo = "L13";
                    nTipo = 02;
               |FINSI;
               |SI aTipo = "L03";
                    || son atrasos, hay que buscar el tipo que se grabo en
                    || la referencia

                    swAtrasos = 1;

                    |HAZ LeeReferencia_plb;

                    || despues de esto, ya tengo mi nTipo de atrasos
               |FINSI;
               |SI aTipo = "L90";
                    nTipo = 90;
               |FINSI;

               || lo busco aqui, que ya tengo mes, ao y tipo
               nEmp = 0;
               |HAZ BuscaPorCCC;
          |FINSI;

          aEtiqueta = "FechaControl";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               aCampoFecha = "FechaControl";
               |HAZ TipoFecha;
               aMesControl = aMes;
               aAnyControl = aAny;
               nMesControl = aMesControl;
               nAnyControl = aAnyControl;
          |FINSI;

          aEtiqueta = "FechaHoraRecaudacion";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ FechaHoraRec;
          |FINSI;

          |HAZ GrabaReferencia;

          aEtiqueta = "LiquidacionMes";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               || en el fichero de bases
               || si entro aqui es porque se han encontrado errores
               || errores de datos no informados o mal informados

               || en el fichero de trabajadores y tramos, es el sitio
               || donde se muestran los datos de los tramos

               nTipoError = 1;
               |HAZ LiquidacionMes;
          |FINSI;

          aEtiqueta = "Errores";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               |HAZ TipoErrorCCC;
               |SI aCodErrCCC1 = "R9529"; |O aCodErrCCC2 = "R9529";
               |O aCodErrCCC3 = "R9529"; |O aCodErrCCC4 = "R9529";
               |O aCodErrCCC5 = "R9529";
                    swCCCCorrecto = 1;
               |FINSI;
               |SI aCodErrCCC1 = "R9566"; |O aCodErrCCC2 = "R9566";
               |O aCodErrCCC3 = "R9566"; |O aCodErrCCC4 = "R9566";
               |O aCodErrCCC5 = "R9566";
                    swCCCCorrecto = 2;  || liquidacion ya confirmada
               |FINSI;
               |SI aCodErrCCC1 = "R9500"; |O aCodErrCCC2 = "R9500";
               |O aCodErrCCC3 = "R9500"; |O aCodErrCCC4 = "R9500";
               |O aCodErrCCC5 = "R9500";
                    swCCCCorrecto = 2;  || liquidacion ya confirmada
               |FINSI;
               |SI aCodErrCCC1 = "R9523"; |O aCodErrCCC2 = "R9523";
               |O aCodErrCCC3 = "R9523"; |O aCodErrCCC4 = "R9523";
               |O aCodErrCCC5 = "R9523";
                    swCCCCorrecto = 3;  || confirmada de OFICIO
               |FINSI;
          |FINSI;

          || aqui, en el ntipoerror = 2, entrare solo en el fichero de BASES
          aEtiqueta = "DatosNoTratados";
          |HAZ BuscaEtiIni;
          |SI nLoc = 1;
               || si entro aqui es porque se han encontrado errores
               nTipoError = 2;
               || errores de datos no tratados
               |HAZ LiquidacionMes;
          |FINSI;

          aEtiqueta = "Liquidacion";         || Fin de la liquidacion
          |HAZ BuscaEtiFin;
          |SI nLoc = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CuantasLineas;
               ||  2    3         4         5
               ||  5678901234567890123456789012345
/*
     |ATRI R;
     aCadena = 34 * " ";
     |PINTA 1923, aCadena;
     |PINTA 2223, aCadena;
     |PINTA 2323, aCadena;

     aAlfa1 = nFichero;
     aAlfa2 = nTotalFicheros;

     aAlfa = " Verificando fichero " + aAlfa1 + " de " + aAlfa2;
     aCadena = aAlfa; nEspacio = 32; |HAZ Centra;
     |PINTA 2023, aCadenaSal;
*/

     |ATRI R;
     aAlfa = aSoloFichero;
     |QBF aAlfa;
     aCadena = aAlfa; nEspacio = 35; |HAZ Centra;
     |PINTA 2123, aCadenaSal;

     aAlfa = aFichero;
     |XABRE "", aAlfa, nHandle; nHandle = FSalida;
     |SI FSalida ] 0;
          |PARA;
          |SI FLinea ] 0; |Y swAcaba = 0;
          |HACIENDO;
               |XLEE nHandle, 250, aLinea;
               swAcaba = 0;
               FLinea = 0;

               FLinea = FSalida;

               nTotalLineas = nTotalLineas + 1;
          |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     aTotalLineas = nTotalLineas;

     aAlfa1 = nFichero;
     aAlfa2 = nTotalFicheros;

     aAlfa = " Leyendo fichero " + aAlfa1 + " de " + aAlfa2;
     aCadena = aAlfa; nEspacio = 35; |HAZ Centra;
     |PINTA 2023, aCadenaSal;

     |ATRI 0;
|FPRC;

|PROCESO Lectura;
     nTipoFichero = 0;
     FLinea = 0;

     aAlfa = aFichero;

     |XABRE "", aAlfa, nHandle; nHandle = FSalida;

     aAlfa1 = aAlfa % -103;
     |SI aAlfa1 = "t01";
          nTipoFichero = 7;
          || un mensaje transmision de ficheros
     |FINSI;

     aAlfa1 = aAlfa % -103;
     |SI aAlfa1 = "msj";
          nTipoFichero = 10;
          || busco un mensaje de datos FIE
     |FINSI;

     |SI FSalida ] 0;
          |PARA;
          |SI FLinea ] 0; |Y swAcaba = 0;
          |HACIENDO;
               |SI nTipoFichero = 7; |O nTipoFichero = 10;
                    |SAL;
               |FINSI;

               swAcaba = 0;
               FLinea = 0;
               |HAZ LeeLinea;

               aEtiqueta = "Respuesta";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 1;   || respuesta, en general, ya veremos
                                        || de que tipo
               |FINSI;

               aEtiqueta = "TrabajadoresTramos";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 2;   || trabajadores y tramos
               |FINSI;

               aEtiqueta = "RelacionNominalTrabajadores";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 3;   || RNT
                    swAcaba = 1;
               |FINSI;

               aEtiqueta = "DCL";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 4;   || DCL
                    swAcaba = 1;
               |FINSI;

               aEtiqueta = "ReciboLiquidacionCotizaciones";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 5;   || RLC
                    swAcaba = 1;
               |FINSI;

               aEtiqueta = "Calculos";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    nTipoFichero = 6;   || ser el 6, en un futuro
                    || aErrorNoContemplado = "Calculos";
                    || ACABA;
               |FINSI;

               aEtiqueta = "ReferenciaExterna";
               |HAZ BuscaEtiIniFin;
               |SI nLoc = 1;
                    |QBT aValor;
                    eaReferencia = aValor;

                    || Si nTipoFichero = 1, en aTipoRespuesta sabre que tipo
                    || de respuesta estoy obteniendo

                    || B - Respuesta a un fichero de Bases
                    || T - Respuesta a una solicitud de Trabajadores y Tramos
                    ||     (solo la respuesta, el fichero es otro XML)
                    || R - Respuesta a una solicitud de Borrador
                    || C - Respuesta a una solicitud de calculos
                    || F - Respuesta a una solicitud de confirmacion
                    || D - Respuesta a una comunicacion de datos bancarios
                    || C.OFICIO - Reeferencia de las confirmaciones de Oficio

                    aTipoRespuesta = eaReferencia % 101;

                    |SI nTipoFichero = 1;
                         |SI eaReferencia = "C.OFICIO"; |O eaReferencia = "On-Line";
                              aTipoRespuesta = "F";
                         |FINSI;

                         |SI aTipoRespuesta = "T"; |O aTipoRespuesta = "C";
                         |O aTipoRespuesta = "F";
                         || respuesta a una solicitud de trab. y tram. (solo respuesta)
                         || respuesta a una solicitud de ficheros de calculos
                              nTipoFichero = 8;
                              swAcaba = 1;
                         |FINSI;
                         |SI aTipoRespuesta = "D";
                              nTipoFichero = 9;
                              swAcaba = 1;
                         |FINSI;
                    |FINSI;

                    |SI eaReferencia ! "";
                         |HAZ BorraAnteriores;
                    |FINSI;
               |FINSI;

               aEtiqueta = "Liquidacion";
               |HAZ BuscaEtiIni;
               |SI nLoc = 1;
                    || Comenzamos una nueva liquidacion
                    nErrores = 0;
                    swCCCCorrecto = 0;
                    nEmp = 0;

                    |HAZ Liquidacion;

                    || se acaba la liquidacion, guardamos registro

                    aAnyLiq = aAnyDesde;
                    aMesLiq = aMesDesde;

                    |SI nEmp = 0;
                         |HAZ BuscaPorCCC;
                    |FINSI;

                    |SI 5 [ nTipo; |Y nTipo [ 20;
                         || aAnyLiq = aAnyControl;
                         || esto no, el ao donde estan guardados puede ser cualquiera
                         || el de la liquidacion o el de control

                         || Vale pero en principio esto esta para guardarme este
                         || registro y es mas normal que me lo guarde en el
                         || ao de la fecha de control, ya que es el ao de
                         || la liquidacion
                         || lo vuelvo a poner 05.03.2018
                         aAnyLiq = aAnyControl;

                         aMesLiq = aMesControl;
                    |FINSI;
                    |HAZ RegistroCCC;
                    |HAZ GrabaCCC;
               |FINSI;

               |SI nTipoFichero = 1;
                    aEtiqueta = "Respuesta";
                    |HAZ BuscaEtiFin;
                    |SI nLoc = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
               |SI nTipoFichero = 2;
                    aEtiqueta = "TrabajadoresTramos";
                    |HAZ BuscaEtiFin;
                    |SI nLoc = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |XCIERRA nHandle;

          |SI nTipoFichero = 3;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap21";
          |FINSI;

          |SI nTipoFichero = 4;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap22";
          |FINSI;

          |SI nTipoFichero = 5;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap23";
          |FINSI;

          |SI nTipoFichero = 6;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap26";
          |FINSI;

          |SI nTipoFichero = 7;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap24";
          |FINSI;

          |SI nTipoFichero = 8;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap25";
          |FINSI;

          |SI nTipoFichero = 9;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap28";
          |FINSI;

          |SI nTipoFichero = 10;
               eaFichero = aFichero;
               |SUB_EJECUTA_NP "cretap31";
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     aFichero = "";
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam ! "";
          aFichero = aParam;
     |SINO;
          |CLS;
          |PINPA #0#0;
          |PINDA #0#0;

          |ENDATOS #1#0;
          |SI FSalida = 0;
               aFichero = #0#0;
               |QBF aFichero;
          |FINSI;
     |FINSI;
     |SI aFichero ! "";
          |ABRE #cretam01;
          |ABRE #cretam04;
          |ABRE #cretam05;
          |ABRE #cretam26;
          |ABRE #cretam25;
          |ABRE #cretam27;
          |ABRE #cretam24;
          |ABRE #cretam23;
          |ABRE #cretam22;

          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #labcentr;
          |ABRE #nomcenes;

          |HAZ CuantasLineas;
          |HAZ Lectura;

          |CIERRA #nomcenes;
          |CIERRA #labcentr;
          |CIERRA #labtraba;
          |CIERRA #labempre;

          |CIERRA #cretam22;
          |CIERRA #cretam23;
          |CIERRA #cretam24;
          |CIERRA #cretam25;
          |CIERRA #cretam27;
          |CIERRA #cretam26;
          |CIERRA #cretam05;
          |CIERRA #cretam04;
          |CIERRA #cretam01;

          |SI aErrorNoContemplado ! "";
               aAlfa = "    " + aErrorNoContemplado;
               aAlfa = aAlfa + ". Lectura no soportada en esta version";
               |MENAV aAlfa;
          |FINSI;
     |SINO;
          |MENAV "    No se ha seleccionado ningn fichero.";
     |FINSI;
|FPRO;
