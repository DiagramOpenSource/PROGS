|FICHEROS;
     hotm0063 #0;
     hotm0054;
     hotm0009 #9;        || cabecera planilla mensual
     hotm0010 #10;       || lineas planilla mensual
     hotm0012 #12;       || cabecera planilla general
     hotm0013 #13;       || lineas planilla general
     copiacab@ #100;
     copialin@ #101;
     labtraba;
     nomconca;
     hotm0060;           || Equivalencia Diagram-Evology Empresas
     hotm0061;           || Equivalencia Diagram-Evology Centros
     hotm0062;           || Equivalencia Diagram-Evology Areas

     nomcalca;
     nomcalli;
     nomhicca;
     nomhicli;
|FIN;

|VARIABLES;
     nDesdeTipo = 0;
     nHastaTipo = 0;
     fFecha = @;
     fFechaIni = @;
     aFecha = "";
     aHora = "";
     aDia = "";
     aMes = "";
     aAny = "";
     nDia = 0;
     nMes = 0;
     nAny = 0;
     nNume = 0;

     &aFichero = "";
     nCanal = 0;
     aLinea = "";
     aDato = "";
     aTipo = "";

     taporta = 0;
     tantici = 0;
     deducir = 0;
     nConcepto = 0;
     aDef = "";
     aElDef = "";
     &nGenerados = 0;
     &nNoGenerados = 0;
     &nRepetidos = 0;
     swSTOP = 0;
     aPath = "";
     aAlfa = "";
     nCar = 0;
     aTip = "";
     nAnyHis = 0;
     nCampo = 0;
     nCampoE = 0;
     nCampoT = 0;
     swFiniquito = 0;
     swMensual = 0;
     swGeneral = 0;
     nCoefi = 0;
     nBruto = 0;
     nBaseIRPF = 0;
     nNeto = 0;
     nReten = 0;
     n414 = 0;
     n418 = 0;
     n906 = 0;
     n907 = 0;
     n908 = 0;
     n201 = 0;
     n202 = 0;
     n203 = 0;
     n204 = 0;
     nA201 = 0;
     nA202 = 0;
     nA203 = 0;
     nA204 = 0;
     nTotBruto = 0;
     nTotBaseIRPF = 0;
     nTotNeto = 0;
     nTotReten = 0;
     nTot414 = 0;
     nTot418 = 0;
     nTot906 = 0;
     nTot907 = 0;
     nTot908 = 0;
     nTot201 = 0;
     nTot202 = 0;
     nTot203 = 0;
     nTot204 = 0;
     nTotA201 = 0;
     nTotA202 = 0;
     nTotA203 = 0;
     nTotA204 = 0;
     nLinea = 0;
     nTotLineas = 0;
     nSSTra = 0;
     nTotSSTra = 0;
     nSSEmp = 0;
     nTotSSEmp = 0;
     nExento = 0;
     nTotExento = 0;
     nExentoFin = 0;
     nTotExentoFin = 0;
     nLineaPro = 0;
     nPresSS = 0;
     nTotPresSS = 0;
     nDato = 0;
     swBuscoPro = 0;
     aDelimitador = "#";
     &nAcumBru = 0;
     &nAcumBas = 0;
     &nAcumRet = 0;
     &nAcumEx1 = 0;
     &nAcumSST = 0;
     &nAcumSSE = 0;
     &nAcumPSS = 0;
     &nAcumNet = 0;
     &nAcum906 = 0;
     &nAcum414 = 0;
     &nAcum418 = 0;
     &nAcum4XX = 0;
     &nAcum907 = 0;
     &nAcum908 = 0;
     &nAcum201 = 0;
     &nAcum202 = 0;
     &nAcum203 = 0;
     &nAcum204 = 0;
     &nAcumA201 = 0;
     &nAcumA202 = 0;
     &nAcumA203 = 0;
     &nAcumA204 = 0;

     nTipoPaga = 0;
     nMesPago = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     aEstoyEn = "";
     nTotal = 0;
     aError = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nUnid = 0;
     nPrecio = 0;
     swSoyDiferida = 0;
     swUnid = 0;
|FIN;

/****************** PROCESOS DESDE LA PANTALLA ******************************/

|PROCESO LimpiaParr;
     nCampoE = Campo;
     |SI #0nCampoE = 0;
          |PARA nCampoE = 13; |SI nCampoE [ 30; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 21;
               #0nCampoE = 0;
               #0nCampoT = 0;
               |PINTA #0nCampoE;
               |PINTA #0nCampoT;
               |SI nCampoE ! 13;
                    |CAMPO_MODIFICA #0nCampoE, 1, "N";
               |FINSI;
               |CAMPO_MODIFICA #0nCampoT, 1, "N";
          |SIGUE;
          |PARA nCampoE = 0; |SI nCampoE [ 1; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 2;
               |CAMPO_MODIFICA #0nCampoE, 1, "S";
               |CAMPO_MODIFICA #0nCampoT, 1, "S";
          |SIGUE;
     |SINO;
          |PARA nCampoE = 13; |SI nCampoE [ 30; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 21;
               |CAMPO_MODIFICA #0nCampoE, 1, "S";
               |CAMPO_MODIFICA #0nCampoT, 1, "S";
          |SIGUE;
          |PARA nCampoE = 0; |SI nCampoE [ 1; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 2;
               |CAMPO_MODIFICA #0nCampoE, 1, "N";
               |CAMPO_MODIFICA #0nCampoT, 1, "N";
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Defecto; |TIPO 7;
     fFecha = ~;
     aFecha = fFecha;
     aMes = aFecha % 402;
     aAny = aFecha % -104;
     nMes = aMes;
     nAny = aAny;
     #0#6 = nMes;
     |PINTA #0#6;
     #0#7 = nAny;
     |PINTA #0#7;
|FPRC;

|PROCESO Marca;
     |SI #0Campo = " ";
          #0Campo = "X";
          |PINTA #0Campo;
     |SINO;
          #0Campo = "X";
          |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO MensHisAtra;
/*
     |PINTA 0906, "                                   ";
     |SI #0#4 = "M";
          |ATRI R;
          |PINTA 0911,      " MANTENIMIENTO MENSUAL ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "H";
          |ATRI R;
          |PINTA 0910,     " MANTENIMIENTO HISTORICO ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "A";
          |ATRI R;
          |PINTA 0911,      " MANTENIMIENTO ATRASOS ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "T";
          |ATRI R;
          |PINTA 0906, "  MANTENIMIENTO ATRASOS HISTORICO  ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "A"; |O #0#4 = "T";
          #0#8 = "X";
          #0#9 = " ";
          #0#10 = " ";
          |CAMPO_MODIFICA #0#8, 1, "N";
          |CAMPO_MODIFICA #0#9, 1, "N";
          |CAMPO_MODIFICA #0#10, 1, "N";
          |PINTA #0#8;
          |PINTA #0#9;
          |PINTA #0#10;
     |SINO;
          |CAMPO_MODIFICA #0#8, 1, "S";
          |CAMPO_MODIFICA #0#9, 1, "S";
          |CAMPO_MODIFICA #0#10, 1, "S";
     |FINSI;
*/
|FPRC;

|PROCESO Fichero;
     fFecha = ~;
     aFecha = fFecha;
     |HORA aHora;
     aFecha = aFecha - ".";
     aFecha = aFecha - ".";
     aHora = aHora - ":";
     aHora = aHora - ":";
     || aHora = aHora % 105;
     || aFichero = (aFecha % -104) + (aFecha % 402) + (aFecha % 102);
     aFichero = aFecha + "_" + aHora;
     aFichero = aFichero + "_DP";
     aFichero = aFichero + ".txt";
     aPath = #0#12;
     |QBF aPath;
     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\";
          aPath = aPath + "/";
     |FINSI;
     aPath = aPath + aFichero;
|FPRC;

|PROCESO Seleccion;
/*
     |SI #0#8 = " "; |Y #0#9 = " "; |Y #0#10 = " ";
          |MENAV "    Debera marcar algun tipo de nomina: Normal, Finiquito o Pagas";
          |POSICIONATE #0#8;
     |FINSI;
*/
|FPRC;

|PROCESO FechaIni;
     nDia = 1;
     nMes = #0#6;
     nAny = #0#7;

     aDia = "01";
     aMes = nMes; aMes = "00" + aMes; aMes = aMes % -102;
     aAny = nAny;

     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;

     fFechaIni = #100#4;
     |SI fFechaIni > fFecha;
          aDia = #100#4 % 102;
          nDia = aDia;
     |FINSI;
|FPRC;

|PROCESO FechaFin;
     nMes = #0#6;
     nAny = #0#7;
     nNume = nAny $ 4;

     |SI nMes = 1; |O nMes = 3; |O nMes = 5; |O nMes = 7; |O nMes = 8;
     |O nMes = 10; |O nMes = 12;
          nDia = 31;
     |FINSI;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          nDia = 30;
     |FINSI;
     |SI nMes = 2;
          |SI nNume ! 0;
               nDia = 28;
          |SINO;
               nDia = 29;
          |FINSI;
     |FINSI;

     |SI aTipo = "FINIQUITO   ";
          aAlfa = #100#5 % 102;
          nDia = aAlfa;
     |FINSI;
|FPRC;

|PROCESO Registro;
     #hotm0054#0 = #100#0;    || Empresa
     #hotm0054#1 = #100#1;    || Trabajador
     #hotm0054#2 = #0#7;      || A¤o
     #hotm0054#3 = #0#6;      || Mes
     #hotm0054#4 = 3;

     #hotm0054#5 = "P";         || Acumulados Pagas
     /*
     |SI aTipo = "NORMAL      ";        || Tipo
          #hotm0054#4 = 0;
          |SI swFiniquito = 1;
               #hotm0054#4 = 2;
          |FINSI;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  ";        || Tipo
          #hotm0054#4 = 1;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";        || Tipo
          #hotm0054#4 = 2;
     |FINSI;
     */

     /*
     |SI #0#4 = "M"
          #hotm0054#5 = "M";         || Desde Mensual
     |FINSI;
     |SI #0#4 = "H"
          #hotm0054#5 = "H";         || Desde Historico
     |FINSI;
     |SI #0#4 = "A"
          #hotm0054#5 = "A";         || Desde Atrasos
     |FINSI;
     |SI #0#4 = "T"
          #hotm0054#5 = "T";         || Desde Atrasos
     |FINSI;
     */

     #hotm0054#6 = aFichero;       || Fichero
     #hotm0054#7 = ~;              || Fecha
     #hotm0054#8 = aHora;          || Hora Creacion
     #hotm0054#9 = nLineaPro;      || Linea Prorrata

     |GRABA 020#hotm0054.n;
     |LIBERA #hotm0054;
|FPRC;

|PROCESO ParaFiniq;
     nNume = 0;
     |PARA nConcepto = 201; |SI nConcepto [ 208; |HACIENDO nConcepto = nConcepto + 1;
          #101#0 = #100#0;
          #101#1 = #100#1;
          |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
               #101#12 = #0#7 - 2000;
          |FINSI;
          #101#2 = #100#2;
          #101#3 = #100#3;
          #101#4 = nConcepto;
          |LEE 000#101=;
          |SI FSalida = 0;
               #nomconca#0 = #labtraba#87;        || busco convenio
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nCampo = nConcepto - 181;  || para buscar si es "99"
                    |SI #nomconca#nCampo# ! 99;
                         nNume = nNume + ((#101#9 * #101#10) ! 2);
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
     nNume = nNume ! 2;
|FPRC;

|PROCESO LeeConcepto;
     nNume = 0;
     #101#0 = #100#0;
     #101#1 = #100#1;
     |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
          #101#12 = #0#7 - 2000;
     |FINSI;
     #101#2 = #100#2;
     #101#3 = #100#3;
     #101#4 = nConcepto;
     |LEE 000#101=;
     |SI FSalida = 0; |O swBuscoPro = 1;
          |SI nConcepto > 299;                    || no es una paga
               nNume = #101#11 * #101#10;
          |SINO;                                  || es una paga
               #nomconca#0 = #labtraba#87;        || busco convenio
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nConcepto = nConcepto - 181;  || para buscar si es "99"
                    ||SI #nomconca#nConcepto# ! 99;
                         nNume = #101#9 * #101#10;
                    ||SINO;
                    ||     nNume = 0;
                    ||FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     nNume = nNume ! 2;
|FPRC;

|PROCESO BuscaPagaMes;
     swUnid = 0;
     nNume = 0;
     #nomhicli#0 = #100#0;
     #nomhicli#1 = #100#1;

     |SI nTipoPaga = 1;
          #nomhicli#12 = #0#7 - 2000;
          |SI nMes [ #0#6; || solo acumulo unidades hasta el mes que pido
               swUnid = 1;
          |FINSI;
     |FINSI;

     |SI nTipoPaga = 21;                        || viene del a¤o pasado
          #nomhicli#12 = #0#7 - 2000 - 1;
          swUnid = 1;
     |FINSI;
     |SI nTipoPaga = 22;                        || lo que llevo de este a¤o
          #nomhicli#12 = #0#7 - 2000;
          |SI nMes [ #0#6;
               swUnid = 1;
          |FINSI;
     |FINSI;

     |SI nDesdeMes [ #0#6; |Y #0#6 [ 12;
          |SI nTipoPaga = 31;
               #nomhicli#12 = #0#7 - 2000;
               |SI nMes [ #0#6;
                    swUnid = 1;
               |SINO;
                    swUnid = 0;
               |FINSI;
          |FINSI;
          |SI nTipoPaga = 32;
               #nomhicli#12 = #0#7 - 2000 + 1;
               swUnid = 0;
          |FINSI;
     |FINSI;
     |SI 1 [ #0#6; |Y #0#6 [ nHastaMes;
          |SI nTipoPaga = 31;
               #nomhicli#12 = #0#7 - 2000 - 1;
               swUnid = 1;
          |FINSI;
          |SI nTipoPaga = 32;
               #nomhicli#12 = #0#7 - 2000;
               |SI nMes [ #0#6;
                    swUnid = 1;
               |SINO;
                    swUnid = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nHastaMes < #0#6; |Y #0#6 < nDesdeMes;
          |SI nTipoPaga = 31;
               #nomhicli#12 = #0#7 - 2000 - 1;
               swUnid = 1;
          |FINSI;
          |SI nTipoPaga = 32;
               #nomhicli#12 = #0#7 - 2000;
               swUnid = 1;
          |FINSI;
     |FINSI;

     #nomhicli#2 = nMes;
     #nomhicli#3 = #100#3;
     #nomhicli#4 = nConcepto;
     |LEE 000#nomhicli.=;

     |SI FSalida = 0;
          |SI swUnid = 1; || solo acumulo unidades hasta el mes que pido
               nUnid = nUnid + #nomhicli#9;
          |FINSI;
          |SI swSoyDiferida = 1;
               nNume = (#nomhicli#9 * #nomhicli#10);
          |FINSI;
          nPrecio = #nomhicli#10;  || pero el precio lo busco hasta
     |SINO;
          #nomcalli#0 = #100#0;
          #nomcalli#1 = #100#1;
          #nomcalli#2 = nMes;
          #nomcalli#3 = #100#3;
          #nomcalli#4 = nConcepto;
          |LEE 000#nomcalli.=;

          |SI FSalida = 0;
               |SI swUnid = 1; || solo acumulo unidades hasta el mes que pido
                     nUnid = nUnid + #nomcalli#9;
               |FINSI;
               |SI swSoyDiferida = 1;
                    nNume = (#nomcalli#9 * #nomcalli#10);
               |FINSI;
               nPrecio = #nomcalli#10;  || pero el precio lo busco hasta
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaAcumPaga;
     nNume = 0;
     nPrecio = 0;
     nTotal = 0;

     #nomconca#0 = #labtraba#87;        || busco convenio
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          nCampo = nConcepto - 181;  || para buscar si es "99"
          |SI #nomconca#nCampo# ! 99; |Y #nomconca#nCampo# ! #0#6;
               nMesPago = #nomconca#nCampo#;
               nCampo = nConcepto - 197;
               nDesdeMes = #nomconca#nCampo#;
               nCampo = nConcepto - 189;
               nHastaMes = #nomconca#nCampo#;

               swSoyDiferida = 0;
               |SI nDesdeMes < nHastaMes; |Y nMesPago ] nHastaMes;
                    nTipoPaga = 1;
                    |SI nMesPago ! nHastaMes;
                         swSoyDiferida = 1;
                    |FINSI;
                    || tipo desde 01 hasta 06 pago mes 06 o 07
                    || tipo desde 01 hasta 12 pago mes 12
               |FINSI;
               |SI nDesdeMes < nHastaMes; |Y nMesPago < nHastaMes;
                    nTipoPaga = 2;
                    swSoyDiferida = 1;
                    || tipo desde 01 hasta 12 pago mes 03 a¤o siguiente
               |FINSI;
               |SI nDesdeMes ] nHastaMes; |Y nMesPago ] nHastaMes;
                    nTipoPaga = 3;
                    |SI nMesPago ! nHastaMes;
                         swSoyDiferida = 1;
                    |FINSI;
                    || tipo desde 07 hasta 06 o hasta 07 pago mes 06 o mes 07
               |FINSI;

               |SI nTipoPaga = 1;
                    nTotal = 0;
                    |SI nDesdeMes [ #0#6; |Y #0#6 < nHastaMes;
                         ||PARA nMes = nDesdeMes; |SI nMes [ #0#6; |HACIENDO nMes = nMes + 1;
                         |PARA nMes = nDesdeMes; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
                              |HAZ BuscaPagaMes;
                              |SI swSoyDiferida = 1;
                                   nTotal = nTotal + nNume;
                              |FINSI;
                         |SIGUE;
                         |SI swSoyDiferida ! 1
                              nTotal = nTotal + ((nUnid * nPrecio) ! 2);
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI nTipoPaga = 2;
                    nTotal = 0;
                    nTipoPaga = 21;
                    |PARA nMes = nDesdeMes; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
                         |HAZ BuscaPagaMes;            || la parte del a¤o anterior
                         nTotal = nTotal + nNume;      || (diferida)
                    |SIGUE;
                    nTipoPaga = 22;
                    |PARA nMes = nDesdeMes; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
                         |HAZ BuscaPagaMes;            || la parte de este a¤o, precio actual
                         nTotal = nTotal + ((nUnid * nPrecio) ! 2);
                    |SIGUE;
               |FINSI;

               |SI nTipoPaga = 3;
                    nTotal = 0;
                    |SI nHastaMes < #0#6; |Y #0#6 < nDesdeMes;
                         swSoyDiferida = 1;  || solo la contemplo como diferida
                    |SINO;                   || para coger el precio si ya se ha pagado
                         swSoyDiferida = 0;  || entera, si no tengo que buscar el
                    |FINSI;                  || ultimo precio
                    nTipoPaga = 31;
                    |PARA nMes = nDesdeMes; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
                         |HAZ BuscaPagaMes;
                         |SI swSoyDiferida = 1;
                              nTotal = nTotal + nNume;
                         |FINSI;
                    |SIGUE;
                    nTipoPaga = 32;
                    |PARA nMes = 01; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
                         |HAZ BuscaPagaMes;
                         |SI swSoyDiferida = 1
                              nTotal = nTotal + nNume;
                         |FINSI;
                    |SIGUE;

                    |SI swSoyDiferida ! 1
                         nTotal = nTotal + ((nUnid * nPrecio) ! 2);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     nNume = nTotal;
     nNume = nNume ! 2;
|FPRC;

|PROCESO LeeCAS;

|FPRC;

|PROCESO DatosAdic;
     #labtraba#0 = #100#0;
     #labtraba#1 = #100#1;
     |LEE 000#labtraba.=;

     |SI #0#55 = "A"; |Y #labtraba#44 ! "A";
          swSTOP = 1;
     |FINSI;
     |SI #0#55 = "B"; |Y #labtraba#44 ! "B";
          swSTOP = 1;
     |FINSI;

     aAlfa = #100#5;
     aAlfa = aAlfa % 402;
     nNume = aAlfa;

     |SI nNume = #0#6;
          swFiniquito = 1;    || tengo finiquito en el mes
     |SINO;
          swFiniquito = 0;
     |FINSI;

     |SI aTipo = "NORMAL      ";        || Tipo
          |SI swFiniquito = 1;
               swSTOP = 1;
          |FINSI;
     |FINSI;
     /*
     |SI aTipo = "FINIQUITO   ";        || Tipo
          |SI swFiniquito = 0;
               swSTOP = 1;
          |FINSI;
     |FINSI;
     */
|FPRC;

|PROCESO Comprobaciones;
     #hotm0054#0 = #100#0;    || Empresa
     #hotm0054#1 = #100#1;    || Trabajador
     #hotm0054#2 = #0#7;      || A¤o
     #hotm0054#3 = #0#6;      || Mes
     #hotm0054#4 = 3;

/*
     |SI aTipo = "NORMAL      ";        || Tipo
          #hotm0054#4 = 0;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  ";        || Tipo
          #hotm0054#4 = 1;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";        || Tipo
          #hotm0054#4 = 2;
     |FINSI;
     |SI #0#4 = "M"; #hotm0054#5 = "M"; |FINSI;
     |SI #0#4 = "H"; #hotm0054#5 = "H"; |FINSI;
     |SI #0#4 = "A"; #hotm0054#5 = "A"; |FINSI;
     |SI #0#4 = "T"; #hotm0054#5 = "T"; |FINSI;
*/

     #hotm0054#5 = "P";
     #hotm0054#9 = nLineaPro;
     |LEE 000#hotm0054.=;
     |SI FSalida ! 0;
          swSTOP = 0;
     |SINO;
          swSTOP = 1;
          nNoGenerados = nNoGenerados + 1;
          nRepetidos = nRepetidos + 1;
          |PRINT;
     |FINSI;
|FPRC;

|PROCESO Formatea;
     || N = numero, rellena por la izquierda con ceros
     || A = alfanumerico, rellena por la derecha con blancos
     || D = numero con decimales, por la derecha con blancos y si es entero
     ||     lo transforma a ,00
     || F = Fecha, construye fecha a partir de nDia, nMes, nAny

     |SI aTip = "N"; |O aTip = "A"; |O aTip = "D";
          |SI aTip = "D";
               aAlfa = aDato % -301;
               |SI aAlfa ! ".";
                    aAlfa = aDato % -201;
                    |SI aAlfa ! ".";
                         aDato = aDato + ".00";
                    |SINO;
                         aDato = aDato + "0";
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI aTip = "N";
               aAlfa = "0" * nCar;
          |SINO;
               aAlfa = " " * nCar;
          |FINSI;
          aDato = aAlfa + aDato;
          nCar = (nCar + 100) * (-1)
          aDato = aDato % nCar;
     |FINSI;

     |SI aTip = "F";
          aDia = nDia; aDia = "00" + aDia; aDia = aDia % -102;
          aMes = nMes; aMes = "00" + aMes; aMes = aMes % -102;
          aAny = nAny;
          aDato = aDia + "." + aMes + "." + aAny;
     |FINSI;

     aLinea = aLinea + aDato + aDelimitador;
|FPRC;

|PROCESO Lineas;
     nLinea = nLinea + 1;
     nLineaPro = 0;
     swBuscoPro = 0;

     |SI swMensual = 1;
          nCoefi = #hotm0010#11;
          nLineaPro = #hotm0010#4;
     |SINO;
          nCoefi = #hotm0013#9;
          nLineaPro = #hotm0013#2;
     |FINSI;

     |HAZ Comprobaciones;

     |HAZ DatosAdic;
     |SI swSTOP = 1;
          |ACABA;
     |FINSI;

     aLinea = "";

     nDato = #100#0;
     #hotm0060#0 = nDato;
     |LEE 000#hotm0060.=;
     |SI FSalida = 0;
          nDato = #hotm0060#1;
     |SINO;
          aDato = nDato;               || Empresa
          aError = "la Empresa " + aDato;
     |FINSI;

     aDato = nDato;               || Empresa
     nCar = 5; aTip = "N";    |HAZ Formatea;

     |HAZ LeeCAS;

     |SI swMensual = 1;                      || CENTRO
          nDato = #10#5;
     |SINO;
          nDato = #13#3;
     |FINSI;
     #hotm0061#0 = nDato;
     |LEE 000#hotm0061.=;
     |SI FSalida = 0;
          nDato = #hotm0061#1;
     |SINO;
          aDato = nDato;
          aError = "el Centro " + aDato;
     |FINSI;
     aDato = nDato;
     nCar = 2; aTip = "N";    |HAZ Formatea;

     |SI swMensual = 1;                      || AREA
          aDato = #10#7;
     |SINO;
          aDato = #13#5;
     |FINSI;

     #hotm0062#0 = aDato;
     |LEE 000#hotm0062.=;
     |SI FSalida = 0;
          aDato = #hotm0062#1;
     |SINO;
          aError = "el Area " + aDato;
     |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;

     |SI swMensual = 1;                      || SECCION
          aDato = #10#9;
     |SINO;
          aDato = #13#7;
     |FINSI;
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = #100#1;                         || Trabajador
     nCar = 5; aTip = "N";    |HAZ Formatea;
     aDato = #labtraba#7;                    || NIF
     nCar = 12; aTip = "A";    |HAZ Formatea;
     aDato = #labtraba#2;                    || Nombre trabajador
     nCar = 40; aTip = "A";    |HAZ Formatea;

     |SI aError ! "";
          aAlfa1 = #100#0; aAlfa1 = "00000" + aAlfa1; aAlfa1 = aAlfa1 % -105;
          aAlfa2 = #100#1; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
          aError = aError + " (" + aAlfa1 + "." + aAlfa2 + ")"
     |FINSI;

     nDia = 1;
     nMes = #0#6;
     nAny = #0#7;
     |HAZ FechaIni;
     nCar = 0; aTip = "F";    |HAZ Formatea;

     |HAZ FechaFin;
     nCar = 0; aTip = "F";    |HAZ Formatea;

     nConcepto = 201;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Junio

     nConcepto = 202;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Octubre

     nConcepto = 203;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Diciembre

     nConcepto = 204;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Diciembre

     nConcepto = 201;                   || acumulados de cada paga
     nUnid = 0;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA201 = nNume;
     |SI nLinea ! nTotLineas;
          nA201 = nA201 * nCoefi;
          nA201 = nA201 ! 2;
          nTotA201 = nTotA201 + nA201;
     |SINO;
          nAcumA201 = nAcumA201 + nA201;
          nA201 = nA201 - nTotA201;
     |FINSI;
     aDato = nA201;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 202;
     nUnid = 0;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA202 = nNume;
     |SI nLinea ! nTotLineas;
          nA202 = nA202 * nCoefi;
          nA202 = nA202 ! 2;
          nTotA202 = nTotA202 + nA202;
     |SINO;
          nAcumA202 = nAcumA202 + nA202;
          nA202 = nA202 - nTotA202;
     |FINSI;
     aDato = nA202;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 203;
     nUnid = 0;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA203 = nNume;
     |SI nLinea ! nTotLineas;
          nA203 = nA203 * nCoefi;
          nA203 = nA203 ! 2;
          nTotA203 = nTotA203 + nA203;
     |SINO;
          nAcumA203 = nAcumA203 + nA203;
          nA203 = nA203 - nTotA203;
     |FINSI;
     aDato = nA203;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 204;
     nUnid = 0;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA204 = nNume;
     |SI nLinea ! nTotLineas;
          nA204 = nA204 * nCoefi;
          nA204 = nA204 ! 2;
          nTotA204 = nTotA204 + nA204;
     |SINO;
          nAcumA204 = nAcumA204 + nA204;
          nA204 = nA204 - nTotA204;
     |FINSI;
     aDato = nA204;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio
     aLinea = aLinea + &13 + &10;

     nNume = nA201 + nA202 + nA203 + nA204;
     |SI nNume > 0;
          |XGRABA nCanal, aLinea;
          |HAZ Registro;
          nGenerados = nGenerados + 1;
     |FINSI;
|FPRC;

|PROCESO Cuenta;
     nTotLineas = nTotLineas + 1;
|FPRC;

|PROCESO Cabecera;
     |SI #0#57 ! "S";
          |ACABA;
     |FINSI;

     aLinea = "";

     aDato = "EMPR.";               || Empresa
     nCar = 5; aTip = "A";    |HAZ Formatea;

     aDato = "CE";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "AR";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "SE";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "TRAB.";                         || Trabajador
     nCar = 5; aTip = "N";    |HAZ Formatea;

     aDato = "NIF";                    || NIF
     nCar = 12; aTip = "A";    |HAZ Formatea;

     aDato = "NOMBRE";                    || NOMBRE TRABAJADOR
     nCar = 40; aTip = "A";    |HAZ Formatea;

     aDato = "FECHA INI.";           || INICIO PERIODO
     nCar = 10; aTip = "A";    |HAZ Formatea;

     aDato = "FECHA FIN";           || FIN PERIODO
     nCar = 10; aTip = "A";    |HAZ Formatea;
/*
     aDato = "TIPO";                || Id. Tipo de Nomina
     nCar = 12; aTip = "A";    |HAZ Formatea;

     aDato ="BRUTO";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || BRUTO

     aDato = "BASE IRPF";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || BRUTO

     aDato = "RETENCION";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || Retencion IRPF

     aDato = "EXENTO (401-410)";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || Importe Dietas: Bases Exentas

     aDato = "S.S. TRABAJADOR";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || SS Trabajador

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas
     aDato = "S.S. EMPRESA";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || SS Trabajador

     aDato = "NETO";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || NETO

     aDato = "EL 906";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 906

     aDato = "EXENTA (414)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 414

     aDato = "EXENTA (418)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 418

     aDato = "EXENTA (RESTO 4XX)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 414

     aDato = "EL 907";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 907

     aDato = "EL 908";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 908

     aDato = "PRES. SS. ACC/ENF";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || PRESTACION A CARGO DE SS

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas
     aDato = "PRORR. PAGA 201";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Junio

     aDato = "PRORR. PAGA 202";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Diciembre

     aDato = "PRORR. PAGA 203";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Octubre

     aDato = "PRORR. PAGA 204";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Octubre 2
*/
     aDato = "M1";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Junio

     aDato = "M2";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Octubre

     aDato = "M3";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Diciembre

     aDato = "M4";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Diciembre

     aDato = "ACUM. PAGA 201";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Junio

     aDato = "ACUM. PAGA 202";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Diciembre

     aDato = "ACUM. PAGA 203";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre

     aDato = "ACUM. PAGA 204";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre 2

     aLinea = aLinea + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|PROCESO Inicializa;
     nTotLineas = 0;
     nLinea = 0;
     swGeneral = 0
     swMensual = 1;
     nCoefi = 0;
     nBruto = 0;
     nNeto = 0;
     nBaseIRPF = 0;
     nReten = 0;
     nSSTra = 0;
     nSSEmp = 0;
     nPresSS = 0;
     nExento = 0;
     nExentoFin = 0;
     n414 = 0;
     n418 = 0;
     n906 = 0;
     n907 = 0;
     n908 = 0;
     n201 = 0;
     n202 = 0;
     n203 = 0;
     n204 = 0;
     nA201 = 0;
     nA202 = 0;
     nA203 = 0;
     nA204 = 0;
     nTotBruto = 0;
     nTotNeto = 0;
     nTotReten = 0;
     nTotBaseIRPF = 0;
     nTotSSEmp = 0;
     nTotSSTra = 0;
     nTotPresSS = 0;
     nTotExento = 0;
     nTotExentoFin = 0;
     nTot414 = 0;
     nTot418 = 0;
     nTot906 = 0;
     nTot907 = 0;
     nTot908 = 0;
     nTot201 = 0;
     nTot202 = 0;
     nTot203 = 0;
     nTot204 = 0;
     nTotA201 = 0;
     nTotA202 = 0;
     nTotA203 = 0;
     nTotA204 = 0;
|FPRC;

|PROCESO Centros;
     |HAZ Inicializa;
     #hotm0009#0 = #100#0;         || empresa
     #hotm0009#1 = #100#1;         || trabajador
     #hotm0009#2 = #0#7;           || a¤o
     #hotm0009#3 = #0#6;           || mes
     |LEE 000#hotm0009.=;
     |SI FSalida = 0;
          swMensual = 1;
          |BUCLELIN 2Cuenta#9;
          |BUCLELIN 2Lineas#9;
     |SINO;
          #hotm0012#0 = #100#0;         || empresa
          #hotm0012#1 = #100#1;         || trabajador
          |LEE 000#hotm0012.=;
          |SI FSalida = 0;
               swMensual = 0;
               |BUCLELIN 2Cuenta#12;
               |BUCLELIN 2Lineas#12;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE historico;
     #100#1005;
     ;
     #0#0, #0#2, nAnyHis, #0#6, nDesdeTipo;
     #0#1, #0#3, nAnyHis, #0#6, nHastaTipo;
     ;
     NULL, Centros;
|FIN;

|DEFBUCLE mensual;
     #100#1004;
     ;
     #0#0, #0#2, #0#6, nDesdeTipo;
     #0#1, #0#3, #0#6, nHastaTipo;
     ;
     NULL, Centros;
|FIN;

|PROCESO BorraRegistro;
     |BORRA 020#hotm0054.a;
|FPRC;

|DEFBUCLE BorraRegistro;
     #hotm0054#2;
     ;
     aFichero;
     aFichero;
     be;
     NULL, BorraRegistro;
|FIN;

|PROCESO ElProceso;
     |HAZ Cabecera;
     |SI #0#13 = 0;      || SELECCION DESDE/HASTA

          aElDef = aDef + "nomhicca";
          |CARGA_DEF aElDef, copiacab@;
          aElDef = aDef + "nomhicli";
          |CARGA_DEF aElDef, copialin@;
          |ABRE #100;
          |ABRE #101;

          aEstoyEn = "H";
          |BUCLE historico;       || normales historico

          |CIERRA #101;
          |CIERRA #100;
          |DESCARGA_DEF #copialin@;
          |DESCARGA_DEF #copiacab@;

          aElDef = aDef + "nomcalca";
          |CARGA_DEF aElDef, copiacab@;
          aElDef = aDef + "nomcalli";
          |CARGA_DEF aElDef, copialin@;
          |ABRE #100;
          |ABRE #101;

          aEstoyEn = "M";
          |BUCLE mensual;       || normales mensual

          |CIERRA #101;
          |CIERRA #100;
          |DESCARGA_DEF #copialin@;
          |DESCARGA_DEF #copiacab@;
          |SI aError ! "";
               aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
               |MENAV aAlfa;
               |BUCLE BorraRegistro;
          |FINSI;
     |SINO;              || PARRILLA
          |PARA nCampoE = 13; |SI nCampoE [ 30; |HACIENDO nCampoE = nCampoE + 1;
               |SI #0nCampoE ! 0;

                    aElDef = aDef + "nomhicca";
                    |CARGA_DEF aElDef, copiacab@;
                    aElDef = aDef + "nomhicli";
                    |CARGA_DEF aElDef, copialin@;
                    |ABRE #100;
                    |ABRE #101;

                    nCampoT = nCampoE + 21;
                    #100#0 = #0nCampoE;
                    #100#1 = #0nCampoT;
                    #100#2 = #0#6;
                    #100#3 = nDesdeTipo;
                    #100#66 = nAnyHis;
                    |LEE 000#100=;
                    |SI FSalida = 0;

                         |HAZ Centros;

                         |CIERRA #101;
                         |CIERRA #100;
                         |DESCARGA_DEF #copialin@;
                         |DESCARGA_DEF #copiacab@;
                    |SINO;
                         |CIERRA #101;
                         |CIERRA #100;
                         |DESCARGA_DEF #copialin@;
                         |DESCARGA_DEF #copiacab@;

                         aElDef = aDef + "nomcalca";
                         |CARGA_DEF aElDef, copiacab@;
                         aElDef = aDef + "nomcalli";
                         |CARGA_DEF aElDef, copialin@;
                         |ABRE #100;
                         |ABRE #101;

                         #100#0 = #0nCampoE;
                         #100#1 = #0nCampoT;
                         #100#2 = #0#6;
                         #100#3 = nDesdeTipo;
                         |LEE 000#100=;
                         |SI FSalida = 0;
                              |HAZ Centros;
                         |FINSI;

                         |CIERRA #101;
                         |CIERRA #100;
                         |DESCARGA_DEF #copialin@;
                         |DESCARGA_DEF #copiacab@;
                    |FINSI;
               |FINSI;
               |SI aError ! "";
                    aAlfa = "ATENCION: No se ha encontrado la equivalencia para " + aError;
                    |MENAV aAlfa;
                    |BUCLE BorraRegistro;
                    |ERROR10;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO GeneraFichero;
     |HAZ Fichero;
     nGenerados = 0;
     nNoGenerados = 0;
     nRepetidos = 0;

     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "hotm0063";
          |XABRE "CWB", aPath, nCanal;
          nAnyHis = #0#7 - 2000;

          aTipo = "NORMAL      ";
          |HAZ ElProceso;

          |SI aError ! "";
               |FBORRA aPath;
               |ACABA;
          |FINSI;

          |XCIERRA nCanal;
          |PIEINF;
          |FININF;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO tipo3; |TIPO 3;
     |SI #0#11 ! "S";
          |ACABA;
     |FINSI;
     |ABRE #nomconca;
     |ABRE #labtraba;
     |ABRE #hotm0009;
     |ABRE #hotm0010;
     |ABRE #hotm0012;
     |ABRE #hotm0013;
     |ABRE #hotm0054;
     |ABRE #hotm0060;
     |ABRE #hotm0061;
     |ABRE #hotm0062;

     |ABRE #nomcalca;
     |ABRE #nomcalli;
     |ABRE #nomhicca;
     |ABRE #nomhicli;
     |DDEF aDef;

     nDesdeTipo = 0;
     nHastaTipo = 0;

     |HAZ GeneraFichero;

     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
     |CIERRA #nomcalli;
     |CIERRA #nomcalca;

     |CIERRA #hotm0062;
     |CIERRA #hotm0061;
     |CIERRA #hotm0060;
     |CIERRA #hotm0054;
     |CIERRA #hotm0013;
     |CIERRA #hotm0012;
     |CIERRA #hotm0010;
     |CIERRA #hotm0009;
     |CIERRA #labtraba;
     |CIERRA #nomconca;
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;
     #0#56 = 1;
     |LEE 101#0=;
     |SI FSalida ! 0;
          |GRABA 020#0.n;
     |FINSI;

     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0.a;
          |HAZ tipo3;
     |FINSI;
     |CIERRA #0;
|FPRO;
