|FICHEROS;
     labimpre #0;
     labtmpct #1,MANTE;

     labregis #2;
     labhisto #3;
     labtmpc1 #4,MANTE;

     labempre #4;
     labtraba #5;
     labcentr #6;
     labcontr #10;

     labenvcc #11;
     labenvcl #12;
     labmunic #13;
     nomconca #15;

     dsnetm00@ #150;     || parametros dsnetcom

     labtmpdt #2000,MANTE;
     Referen@ #2001;
     labvaltb #2002;
     Refere1@ #2003;
     &regisnif@ #712;
     labnct03;           || REGISTRO CONTRATOS
     labnct06;           || REGISTRO ERRORES NETCONTRATA
     labnct10;           || REGISTRO ENVIOS ONLINE
     labacuer;
     labtmpc2 #102,MANTE;

     dsarm005@ #505;
|FIN;

|VARIABLES;
     &aCodPos = "";
     &aCodigoMunicipio = "";
     &eaCodNif = "";

     Result = 0;
     nNumMarcas = 0;

   nSwCont = 0;
   nSwTrns = 0;
   nSwPror = 0;
   nSwCPBs = 0;

   nSwEtiq   = 0;
   aEtiqu    = "";
   aError    = "";
   nNumChars = 0;
   aAlfaP1   = "";
   aAlfaP2   = "";

     nContador = 0;
     nCont  = 0;
     nCalc  = 0;
     nCalc2 = 0;
     nSalida = 0;
     nTecla  = 0;
     nSwUno  = 0;

     nInd    = 0;
     nHayComa = 0;
     nPos    = 0;
     SwSalir = 0;
     aEspacios = "";

     aAlfa  = "";
     aDSitu = "";
     aHSitu = "";
     aNom   = "";
     aApel1 = "";
     aApel2 = "";

     nSwNuevo   = 0;
     nSwLectura = 0;
     nCampo1    = 0;
     nAbierto   = 0;
     nPosic     = 0;
     nCalc1     = 0;
     nLong      = 0;
     nSwImp     = 0;

     aLong      = "";
     aLF        = "";
     aCR        = "";
     aComillas  = "";
     aCadena    = "";
     aAlfa3     = "";
     aAlfa4     = "";

     aTipoDat = "";
     nLongDat = 0;

     &nLabHisto = 0;
     &enNumRegis = 0;
     &eaNumProrr = "";

     &enWeb = 0;
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     &eaWebDirPDF = "";

     fFecha = @;
     nHandle  = 0;
     nHandle1 = 0;
     nHandleE = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aFichs = "";

     aTitulo  = "";
     aNombre  = "";
     aRegistro = "";
     aValor   = "";
     aFich    = "";
     aTabla   = "";
     aClv     = "";
     aClv1    = "";
     aClv2    = "";
     nCmp     = 0;
     nSwError = 0;
     nClave   = 0;
     nLinea   = 0;
     nCampo   = 0;

{1}aContiene  = "";
{-1}aMenu = "";
    aMenu1 = "2400";
    aMenu2 = "1";
    aMenu3 = "";
    aMenu4 = "123";
    aMenu5 = "     1 - Contrato     ";
    aMenu6 = "2 - Comunicacion datos";
    aMenu7 = "      3 - Ambos       ";

    &enTipoEmision = 0;
    swHeGrabado = 0;

    aMD5Origen  = "";
    aMD5Destino = "";
    aOrigen     = "";
    aDestino    = "";
    aIP         = "";

     &swNetContrata = 0;
     aParam = "";
     nJornada = 0;
     nHorasMax = 0;
     aHora = "";
     nNume = 0;
     FEstado = 0;
     aUsuario = "";
     aFecha = "";
     aFichero = "";
     nUltimo = 0;
     nDesdeChar = 0;
     aLinea = "";
     aCodigo = "";
     swAcaba = 0;
     &aIdContrata = "";
     swEstado = 0;
     aProrroga = "";
     nProrroga = 0;
     aCabeza = "";

     aLongRar = "";
     nLongRar = 0;
     aAlfaRar = "";
     aAlfaRar1 = "";
     aAlfaRar2 = "";
     CalcRar1 = 0;
     nContRar1 = 0;
     aPrefijo = "";
     aMensa = "";
     aEsc1 = "";
     aTecla = "";
     aStop = "";
     aRuta = "";
     aRutaSal = "";
     aLon = "";
     nLon = 0;
     aCaracter = "";
     nPunt = 0;
     aTipo = "";
     &nSwTrans = 0;
     &enExtRegis = 0;
     &eaExtProrr = "";
     &eaExtDef = "";
     &enExtEmp = 0;
     &enExtTra = 0;

     fFechaAlta = @;
     &nArchi = 0;
     &eaOrig = "";
     &eaObservaciones = "";
     &enMes = 0;
     &enAny = 0;
     &eaVengoDe = "";
     &swSigue = 0;
     &enSwErrorRecDoc = 0;
     &enSwDesde9 = 0;
     &enSwMeteGrupoSubTipo = 0;
     &enEmp = 0;
     &enTra = 0;

     aFichHuella = "";
     aFichCertif = "";
     aNif = "";
     aFichero1 = "";
     aCCC = "";
     aFechaAlta = "";
     &swNetContEmi = 0;       || llamada a NetContrata desde la emision
                              || del contrato, no desde historico
     &swStopProrr   = 0;
     &enCtoModifica = 0;
     &eaIdContrato  = "";
     aResultado = "";
     nHandleBAT = 0;
     aUnidad = "";
     aResto = "";
     aRutaBAT = "";
     aCarpetaCont = "";
     aFicheroUni = "";
     aRutaDesCont = "";
     swImpreso = 0;
     aUbicacion = "";
     aDocumento = "";
     aPathDestino = "";
     aIPRemoto = "";
     nTipo = 0;
     aBass = "";
     aDef = "";
     aPathDatos = "";

     nAnyCont = 0;
     nMesCont = 0;

     &swModulo = 0;
     &swImpMasiva = 0;
     &aRutaExt = "";
     &aFichExt = "";
     aPathLocFDF = "";
     nContrato = 0;
     &aMensaje = "";
     FTecla = 0;
     &eaTipoImpresion = "";

     &enEmpGAD        = 0;
     &enTraGAD        = 0;
     &enTipGAD        = 0;
     &enMesGAD        = 0;
     &enAnyGAD        = 0;
     &enModGAD        = 0;
     &enImpGAD        = 0;
     &enExiGAD        = 0;
     &eaFicGAD        = "";
     nRegistro = 0;

     &eaCadena = "";
     &eaCadenaSal = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";

     swMillenium = 0;
     &enEmpLabornet = 0;
     swImpLabornet = 0;
     nRegAct1 = 0;
     aRegAct2 = "";
     aMarca = "";
     swHabiaUno = 0;
     &eaUsaGADSiExiste = "";
     aTit = "";
     &swNetContrataMas = 0;
     nContratos = 0;

     nReg = 0;
     nEmp = 0;
     nTra = 0;
     aUno = "";
     nPro = 0;

{-1}aMenuMas = "";
    aMenuMas1 = "2400";
    aMenuMas2 = "1";
    aMenuMas3 = "";
    aMenuMas4 = "EVS";
    aMenuMas5 = " Enviar marcados ";
    aMenuMas6 = " Volver al lineal ";
    aMenuMas7 = " Salir al Menu ";

{-1}aMenuNoMas = "";
    aMenuNoMas1 = "2400";
    aMenuNoMas2 = "1";
    aMenuNoMas3 = "";
    aMenuNoMas4 = "VS";
    aMenuNoMas5 = " Volver al lineal ";
    aMenuNoMas6 = " Salir al Menu ";

     swFase = 0;
     nOpcion = 0;
     swRespuesta = 0;

     &swPortal = 0;
     &eaMensaPortal = "";
     &eaQueEs            = "";
|FIN;

|PROCESO ConsEmp; |TIPO 66;
     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #1 aAlfa1;
     |FINSI;

     |ABRE #labempre;
     |LEE 000#labempre.p;
     |CONSULTA_CLAVE #1#labempre;
     |SI FSalida = 0;
          #0Campo = #labempre#0;
          |PINTA #0Campo;
     |FINSI;
     |CIERRA #labempre;
|FPRC;

|PROCESO Tildes;
     aLongRar = aCadena % 0; nLongRar = aLongRar; aAlfaRar2 = "";
     |PARA nContRar1 = 1; |SI nContRar1 [ nLongRar; |HACIENDO nContRar1 = nContRar1 + 1;
          CalcRar1 = (nContRar1 * 100) + 1; aAlfaRar1  = aCadena % CalcRar1;
          |SI aAlfaRar1 = " ";                     |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "A"; |Y aAlfaRar1 [ "Z"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "a"; |Y aAlfaRar1 [ "z"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "0"; |Y aAlfaRar1 [ "9"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 = "."; |O aAlfaRar1 = ","; |O aAlfaRar1 = ";"; |O aAlfaRar1 = ":";
          |O aAlfaRar1 = "_"; |O aAlfaRar1 = "'"; |O aAlfaRar1 = "-";
               |VETE Sigue1;
          |FINSI;

          |SI aAlfaRar1 = "Ã";  aAlfaRar1 = "";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "¡";  aAlfaRar1 = "á";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "©";  aAlfaRar1 = "é";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "­";  aAlfaRar1 = "í";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "³";  aAlfaRar1 = "ó";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "º";  aAlfaRar1 = "ú";   |VETE Sigue1;|FINSI;

          |SI aAlfaRar1 = "Ã";  aAlfaRar1 = "";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = " ";  aAlfaRar1 = "á";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "‚";  aAlfaRar1 = "é";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "¡";  aAlfaRar1 = "í";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "¢";  aAlfaRar1 = "ó";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "£";  aAlfaRar1 = "ú";   |VETE Sigue1;|FINSI;

          aAlfaRar = " ";
          |ET Sigue1;
          aAlfaRar2 = aAlfaRar2 + aAlfaRar1;
     |SIGUE;
     aCadena = aAlfaRar2;
|FPRC;

|PROCESO CompRuta;
     aRutaSal = "";
     |QBF aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nPunt = 1; |SI nPunt [ nLon; |HACIENDO nPunt = nPunt + 1;
          nPos = (nPunt * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "/";
               aRutaSal = aRutaSal + "\";
          |SINO;
               aRutaSal = aRutaSal + aCaracter;
          |FINSI;
     |SIGUE;
     aCaracter = aRutaSal % -101;
     |SI aCaracter ! "\";
          aRutaSal = aRutaSal + "\";
     |FINSI;
     aRuta = aRutaSal;

     eaCadena = aRuta;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aRuta = eaCadenaSal;
|FPRC;

|PROCESO Comprobacion;
   #labempre#0 = #labtmpct#1;
   |LEE 101#labempre.=;
   |SI FSalida ! 0;
      aAlfa = "    No se encuentra la empresa [" + #labtmpct#1 + "]"; |MENAV aAlfa;
      |ACABA;
   |FINSI;

   #labtraba#0 = #labtmpct#1;
   #labtraba#1 = #labtmpct#2;
   |LEE 101#labtraba.=;
   |SI FSalida ! 0;
      |LIBERA #labempre;
      aAlfa = "    No se encuentra el trabajador [" + #labtmpct#1 + "/" + #labtmpct#2 + "]"; |MENAV aAlfa;
      |ACABA;
   |FINSI;
   |HAZ Comprueba;
   |LIBERA #labempre; |LIBERA #labtraba;
|FPRC;

|PROCESO MarcaCon;
     |SI aMarca = "";
          |SI #labtmpc1#14 = " ";
               aMarca = "S";
          |SINO;
               aMarca = "N";
          |FINSI;
     |FINSI;
     |SI aMarca = "S";
          #labtmpc1#14 = "*";
          nNumMarcas = nNumMarcas + 1;
     |SINO;
          #labtmpc1#14 = " ";
     |FINSI;
     |GRABA 020#labtmpc1.a;
     |LIBERA #labtmpc1;
|FPRC;

|DEFBUCLE MarcaTodos;
     #labtmpc1#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, MarcaCon;
|FIN;

|PROCESO MarcaImp;  |TIPO 11;
/*
     || TODOS 01.06.2017
     |SI swModulo = 2884; |O swModulo = 1;
          || adelante;
     |SINO;
          |ACABA;
     |FINSI;
*/
     |SI FSalida = 13; |Y aParam = "";
          |SI #labtmpc1#14 = " ";
               #labtmpc1#14 = "*";
               nNumMarcas = nNumMarcas + 1;
          |SINO;
               #labtmpc1#14 = " ";
               nNumMarcas = nNumMarcas - 1;
          |FINSI;
          |GRABA 020#labtmpc1.a;
          |LIBERA #labtmpc1;

          |PONCONTROL 23, "si";
          |PTEC 802;
     |FINSI;

     |SI FSalida = 14; |Y aParam = "";
          nRegAct1 = #labtmpc1#0;
          aRegAct2 = #labtmpc1#17;
          aMarca = "";
          nNumMarcas = 0;
          |BUCLE MarcaTodos;

          #labtmpc1#0 = nRegAct1;
          #labtmpc1#17 = aRegAct2;
          |LEE 000#labtmpc1.=;

          |PONCONTROL 23, "si";
          |PTEC 802;
     |FINSI;
|FPRC;

|PROCESO Tipo11tmp;  |TIPO 11;
     FTecla = FSalida;
     |SI FSalida ! 18;  |ACABA;  |FINSI;

     |SI aParam = "";
         #labtmpct#0  = #labtmpc1#0;
         #labtmpct#17 = #labtmpc1#17;
         |LEE 000#labtmpct.=;
     |FINSI;

     nLabHisto = 1;
     |SI aParam = "NETCONTRAT@";
          enNumRegis = #labtmpc2#0;
          eaNumProrr = #labtmpc2#17;
     |SINO;
          enNumRegis = #labtmpct#0;
          eaNumProrr = #labtmpct#17;
     |FINSI;

     |SI aParam = "NETCONTRAT@";
          aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SINO;
          aAlfa = #labtmpct#16; |QBF aAlfa;
     |FINSI;

     |SI aAlfa ! "labconb7";
         |MENAV "0000No procede con este tipo de contrato.";
         |ACABA;
     |FINSI;

     aAlfa = aAlfa + ".tab";
     |SI aAlfa = "labproli.tab";
          aAlfa = "labprorr.tab";
     |FINSI;

     |SI aParam = "CONTRAT@"; |O aParam = "NETCONTRAT@";
          aAlfa = aAlfa + ";CONTRAT@";
     |FINSI;

     swStopProrr   = 0;
     enCtoModifica = 1;
     |SUB_EJECUTA_NP aAlfa;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |ERROR;
|FPRC;

|PROCESO BuscaID;
     || esto consiste en que si emitimos un contrato, se guarda en el GAD
     || luego le meto en el registro su ID, y luego voy a imprimirlo desde
     || el historico de contratos, como ya se grabo el contrato sin el ID
     || pues no sale, con lo que no se me imprime si lo tengo asi configurado

     || lo que he hecho es poner un campo nuevo en el labhisto, por defecto
     || en blanco, de modo que si este esta en blanco y en el registro hay
     || algun numero, no me coja el contrato desde el GAD, sino que me lo
     || haga otra vez y lo archive de nuevo actualizado

     || despues grabo ese campo en el labhisto como que ya tengo el contrato
     || archivado con su ID, y asi ya podre despues ir al GAD a recogerlo

     |SI #labcontr#76 ! "S"; |ACABA; |FINSI;

     |ABRE #labhisto;
     #labhisto#100 = #labtmpc1#0;
     #labhisto#103 = #labtmpc1#17;
     |LEE 101#labhisto.=;
     |SI FSalida = 0;
          |SI #labhisto#107 ! "S";
               |ABRE #labregis;
               #labregis#0 = #labtmpc1#0;
               |LEE 000#labregis.=;
               |SI FSalida = 0;
                    aAlfa = #labregis#14;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         nArchi = 0;
                         #labhisto#107 = "S";
                         |GRABA 020#labhisto.a;
                    |FINSI;
               |FINSI;
               |CIERRA #labregis;
          |FINSI;
     |FINSI;
     |CIERRA #labhisto;
|FPRC;

|PROCESO BuscaContGAD;
     eaVengoDe = "contrato";
     nArchi = 0;
     |HAZ MiraSiArchiva;

     |HAZ BuscaID;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;
     |SI swImpLabornet = 1;
          || desde la impresion del contrato desde labornet no se carga
          || el labtmpc1, que despues usa para todo, asi que como es una
          || los copio de ahi con el registro actual

          #labtmpc1#0 = #labregis#0;
          #labtmpc1#1 = #labregis#1;
          #labtmpc1#2 = #labregis#2;
          #labtmpc1#5 = #labregis#3;
          #labtmpc1#7 = #labregis#6;
          #labtmpc1#8 = #labregis#5;
          #labtmpc1#9 = #labregis#9;
          #labtmpc1#10 = #labregis#10;

          #labtmpc1#11 = #labregis#11;
          #labtmpc1#12 = #labregis#7;
          #labtmpc1#13 = #labregis#8;
          #labtmpc1#14 = "*";
          #labtmpc1#15 = #labregis#4;
          #labtmpc1#17 = #labregis#15;
          #labtmpc1#18 = #labregis#19;
          #labtmpc1#19 = #labregis#20;
          #labtmpc1#20 = #labregis#16;
          #labtmpc1#21 = #labregis#17;
     |FINSI;

     aAlfa = #labtmpc1#17;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "0"; |O aAlfa = "00";
          nTipo = 01;    || contrato
     |SINO;
          nTipo = 02;    || prorroga
     |FINSI;

     |DBASS aBass;
     |QBF aBass;
     aDef = aBass + "dsarchi/def/dsarm005.mas";
     |CARGA_DEF aDef, dsarm005@;
     |SI FSalida ! 0;
          aAlfa = aDef; |QBF aAlfa;
          aAlfa = "    ATENCION: Error en CARGADEF: " + aAlfa;
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     aPathDatos = aBass + "dsarchi/fich/";
     |PATH_DAT #505 aPathDatos;

     |SI nTipo = 01;     || contrato
          aAlfa = #labtmpc1#12;
     |SINO;              || prorroga
          aAlfa = #labtmpc1#18;
     |FINSI;
     aAlfa = aAlfa % 402;
     nMesCont = aAlfa;

     |SI nTipo = 01;     || contrato
          aAlfa = #labtmpc1#12;
     |SINO;              || prorroga
          aAlfa = #labtmpc1#18;
     |FINSI;
     aAlfa = aAlfa % -104;
     nAnyCont = aAlfa;

     eaVengoDe  = "contrato";
     nArchi     = 0;
     |HAZ MiraSiArchiva;
     |SI nArchi ! 1;  |ACABA;  |FINSI;

     enEmpGAD = #labtmpc1#1
     enTraGAD = #labtmpc1#2;
     enTipGAD = nTipo;
     enMesGAD = nMesCont;
     enAnyGAD = nAnyCont;
     enModGAD = 992;
     enImpGAD = 1;
     enExiGAD = 0;
     aAlfa1   = enEmpGAD; |QBF aAlfa1;
     aAlfa1   = ("00000" + aAlfa1) % -105;
     aAlfa2   = enTraGAD; |QBF aAlfa2;
     aAlfa2   = ("00000" + aAlfa2) % -105;

     aAlfa1   = #labtmpc1#1; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2   = #labtmpc1#2; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
     eaFicGAD = "contrato_" + aAlfa1 + "_" + aAlfa2;

     aAlfa = #labtmpc1#17;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "0"; |Y aAlfa ! "00";
          aAlfa = "P" + aAlfa;
          eaFicGAD = eaFicGAD + "_" + aAlfa;
     |FINSI;
     eaFicGAD = eaFicGAD + ".pdf";

     |HAZ BuscaDocuGAD;

     swImpreso = enExiGAD;
|FPRC;

|PROCESO ImpresionMasiva;
     nSwImp = 1;
     enTipoEmision = 1;

     #labtmpct#0 = #labtmpc1#0;
     #labtmpct#17 = #labtmpc1#17;
     |LEE 000#labtmpct.=;

     nContrato = nContrato + 1;

     aAlfa3 = nContrato;
     aAlfa4 = nNumMarcas;
     aMensaje = "    Generando contrato " + aAlfa3 + " de " + aAlfa4;

     |HAZ Impresion;
|FPRC;

|DEFBUCLE ImpresionMasiva;
     #labtmpc1#1;
     14;
     000001, "  ", "*";
     999999, "zz", "*";
     ;
     NULL, ImpresionMasiva;
|FINSI;

|PROCESO Borrador;
     |R_PDIR aAlfa;
     |SI FSalida = 0;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aAlfa1 = aAlfa;
               |RFBORRA aAlfa1;
               |R_SDIR aAlfa;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO LimpiaSpoolPDF;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aPathDestino = aContiene1;
     |QBF aPathDestino;
     aPathDestino = aPathDestino + "spoolpdf/";
     |RMKDIR aPathDestino;       || lo creo primero de nada, por si no hubiera

     aPathLocFDF = aPathDestino;  || aqui va la plantilla y el FDF local

     || borro restos de contratos anteriores,

     aAlfa = aPathLocFDF + "contrato*";
     |HAZ Borrador;
|FPRC;

|PROCESO TipoImpresion;
               ||    2         3         4         5         6
               ||  8901234567890123456789012345678901234567890123
     |PINTA 1018, "                                              ";
     |ATRI R;
     |PINTA 0918, "            Opciones de impresi¢n             ";
     |ATRI 0;
     |PINTA 1018, " (1) Imprimir contrato y copia b sica         ";
     |PINTA 1118, " (2) Imprimir solo el contrato                ";
     |PINTA 1218, " (3) Imprimir solo la copia b sica            ";
     |PINTA 1318, "                                              ";
     |ATRI S;
     |PINTA 1019, "(1)";
     |PINTA 1119, "(2)";
     |PINTA 1219, "(3)";
     |ATRI 0;
     |PINTA 1318, "                  Opci¢n:                     ";
     |PINTA 1418, "                                              ";
     |PINTA 1518, "                                              ";
     |PINTA 1618, "                                              ";
     |PINTA 1718, "                                              ";
     |PINTA 1818, "                                              ";
     |PINTA 1918, "                                              ";
     |PINTA 2018, "                                              ";
     |PINTA 2118, "                                              ";
     |PINTA 2218, "                                              ";
     |CUADRO 08182363;

     E_sup = 1;
     E_inf = "";
     aAlfa = "1";
     aAlfa = 1344 ? 1;
     |QBF aAlfa;
     |SI aAlfa = "2";
          eaTipoImpresion = "C";
     |FINSI;
     |SI aAlfa = "3";
          eaTipoImpresion = "B";
     |FINSI;
|FPRC;

|PROCESO TipoImpresion2;
               ||    2         3         4         5         6
               ||  8901234567890123456789012345678901234567890123
     |ATRI R;
     |PINTA 1518, "             Opciones de emisi¢n              ";
     |ATRI 0;
     |PINTA 1618, " (1) Si los contratos est n  archivados en el ";
     |PINTA 1718, " en el GAD,se emitir n tal como se guardaron. ";
     |PINTA 1818, " Si no lo est n, se archivar n.               ";
     |PINTA 1918, " (2) Se generan siempre los contratos, aunque ";
     |PINTA 2018, " ya existieran  en el  GAD. No se archiva  la "
     |PINTA 2118, " nueva emisi¢n.                               ";
     |ATRI S;
     |PINTA 1619, "(1)";
     |PINTA 1919, "(2)";
     |ATRI 0;
     |PINTA 2218, "                  Opci¢n:                     ";
     |CUADRO 08182363;

     E_sup = 1;
     E_inf = "";
     aAlfa = "1";
     aAlfa = 2244 ? 1;
     |QBF aAlfa;
     |SI aAlfa = "2";
          eaUsaGADSiExiste = "N";
     |FINSI;
|FPRC;

|PROCESO Masiva;
     swImpMasiva = 1;
     nContrato = 0;

     || no lo hago, siempre imprimo todo ¨para que? Si el contrato esta en
     || el GAD no voy a sacar solo una de las dos cosas, no se si estaba
     || porque Dany lo pidio o por cosa mia, lo quito ahora que activamos
     || para todo el mundo la impresion masiva

     |PUSHV 08052370;

     eaTipoImpresion = "";
     |HAZ TipoImpresion;

     eaUsaGADSiExiste = "S";
     nArchi = 0;
     |HAZ MiraSiArchiva;

     |SI nArchi = 1;
          |HAZ TipoImpresion2;
     |FINSI;

     |POPV;

     |HAZ LimpiaSpoolPDF;

     |BUCLE ImpresionMasiva;

     || de momento no, no los estoy archivando siquiera
     || aAlfa = ":dsarchi/dpntz001;CLI";
     || SUB_EJECUTA aAlfa;

     |SI aRutaExt = "";
          || si los contratos ya estaban en el GAD, esta variable viene vacia
          || porque se asigna en el pdfimpre

          aAlfa = aPathDestino + "dsarchi/pdftk.exe ";
          aAlfa = aAlfa + aPathDestino + "contrato_?????_?????_U.pdf ";
          aAlfa = aAlfa + "cat output " + aPathDestino + "contratos_masivo.pdf";
          aRutaExt = aAlfa;
          aFichExt = aPathDestino + "contratos_masivo.pdf";
     |FINSI;

     |MENSA "    Realizando la union de todos los contratos en un PDF";
     |RSYSTEM aRutaExt;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |RSYSTEM aFichExt;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |MENSA "     ";
|FPRC;

|PROCESO Individual;
     swImpreso = 0;
     swImpMasiva = 0;

     |HAZ BuscaContGAD;

     |SI swImpreso = 1;
          |ACABA;
     |FINSI;

     |SI #labcontr#55 = "N";
          #labtmpct#0 = #labtmpc1#0;
          #labtmpct#17 = #labtmpc1#17;
          |LEE 000#labtmpct.=;
          |HAZ Impresion;
          |ACABA;
     |FINSI;

     nSwImp = 1;

     |SI #labcontr#41 = "S";
          enTipoEmision = 0;
          |MENU aMenu;
          |SI FSalida [ 0; |ERROR; |ACABA; |FINSI;
          enTipoEmision = FSalida;
     |SINO;
          enTipoEmision = 1;
     |FINSI;

     #labtmpct#0 = #labtmpc1#0;
     #labtmpct#17 = #labtmpc1#17;
     |LEE 000#labtmpct.=;

     aAlfa = "tm" + Usuario; |NOME_DAT #2000 aAlfa;
     |DELINDEX #labtmpdt; |ABRE #labtmpdt; nLinea = 1;
     |ABRE #labvaltb;
     nSwError = 0; |HAZ Comprobacion;
     |PARA; |SI nSwError = 1; |HACIENDO;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#labtmpdt, -1, 4, 18, 1, inf, sup;
          |POPV;
          |CIERRA #labtmpdt; |DELINDEX #labtmpdt; |ABRE #labtmpdt;
          nSwError = 0; |HAZ Comprobacion;
          |SI nSwError ! 0;
               |CONFI "    NAun hay datos erroneos. Volver a editar ?";
               |SI FSalida ! 0;
                    nSwError = 1;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #labvaltb;

     |CIERRA #labtmpdt; |DELINDEX #labtmpdt;
     |SI nSwError = 0;
          #labtmpct#0 = #labtmpc1#0;
          #labtmpct#17 = #labtmpc1#17;
          |LEE 000#labtmpct.=;
          |HAZ Impresion; |ERROR;
     |FINSI;

     nSwImp = 0;
|FPRC;

|PROCESO Imprime;
     swHabiaUno = 0;
     |SI nNumMarcas = 1;
          nNumMarcas = 0;
          swHabiaUno = 1;
     |FINSI;
     |SI nNumMarcas ! 0;
          || IMPRESION MASIVA;

          aAlfa = nNumMarcas; |QBF aAlfa;
          aAlfa = "    S¿Desea imprimir los " + aAlfa + " contratos seleccionados?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               |HAZ Masiva;
          |FINSI;
     |SINO;
          |HAZ Individual;
     |FINSI;
     |SI swHabiaUno = 1;
          nNumMarcas = 1;
     |FINSI;
|FPRC;

|PROCESO Jornada;
     nHorasMax = 40;
     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |SI #nomconca#162 ! 0;
               nHorasMax = #nomconca#162;
          |FINSI;
     |FINSI;
     |CIERRA #nomconca;

     nNume = #labtraba#234;
     nJornada = 0;
     |SI nNume ! 0;
          nJornada = nNume / nHorasMax;
          nJornada = (nJornada * 1000) ! 0;
     |FINSI;
|FPRC;

|PROCESO Ultimo;
     nUltimo = nUltimo + 1;
|FPRC;

|DEFBUCLE Ultimo;
     #labnct03#1;
     ;
     #labtraba#0, #labtraba#1, eaQueEs, 01;
     #labtraba#0, #labtraba#1, eaQueEs, 99;
     ;
     NULL, Ultimo;
|FIN;

|PROCESO RegistroOnline;
     |ABRE #labnct10;

     #labnct10#0 = #labtraba#0;
     #labnct10#1 = #labtraba#1;
     #labnct10#11 = #labtraba#77;
     |SI eaQueEs = "C";
          #labnct10#2 = 101;
          #labnct10#3 = "Contrato";
     |FINSI;
     |SI eaQueEs = "P"
          #labnct10#2 = 102;
          #labnct10#3 = "Pr¢rroga";
     |FINSI;
     |SI eaQueEs = "T"
          #labnct10#2 = 103;
          #labnct10#3 = "Transformaci¢n";
     |FINSI;

     fFecha = ~;
     aFecha = fFecha;
     #labnct10#4 = fFecha;         || fecha

     |HORA aHora;
     |QBF aHora;
     #labnct10#5 = aHora;          || hora

     aUsuario = Usuario % 810;
     |QBF aUsuario;
     #labnct10#6 = aUsuario;       || usuario

     |SI eaExtDef = "";
          #labnct10#7 = "labimpre";         || desde envio a NetContrata
     |SINO;
          #labnct10#7 = eaExtDef;           || desde un contrato directamente
     |FINSI;

     #labnct10#8 = #labtraba#45;             || tipo de contrato
     #labnct10#9 = #labtraba#36;             || fecha de alta
     #labnct10#10 = #labtraba#37;            || fecha de baja

     |GRABA 020#labnct10.n;
     |LIBERA #labnct10;
|FPRC;

|PROCESO RegistroNetC_Act;
     |ABRE #labnct03;

     #labnct03#0 = #labtraba#0;
     #labnct03#1 = #labtraba#1;
     #labnct03#10 = eaQueEs;           || para la prorroga
     |SI eaQueEs = "C";
          #labnct03#16 = 00;
     |FINSI;
     |SI eaQueEs = "P"
          #labnct03#16 = aProrroga;
     |FINSI;
     |SI eaQueEs = "T";
          #labnct03#16 = 00;
     |FINSI;
     |LEE 101#labnct03.=;
     |SI FSalida = 0;
          |SI swEstado = 1;
               #labnct03#13 = "1";                || indicador con errores
               #labnct03#14 = "RECHAZADO";      || descripcion
               #labnct03#17 = "";                 || id contrata
          |FINSI;
          |SI swEstado = 2;
               #labnct03#13 = "2";                || indicador aceptado
               #labnct03#14 = "ACEPTADO";         || descripcion
               #labnct03#17 = aIdContrata;        || id contrata

               || en caso de prorroga no se graba el IdContrata
          |FINSI;
          |GRABA 020#labnct03.a;
     |FINSI;

     |LIBERA #labnct03;
     |CIERRA #labnct03;
|FPRC;

|PROCESO RegistroNetC_Inicial;
     |ABRE #labnct03;
/*
     nUltimo = 0;
     |BUCLE Ultimo;
*/

     #labnct03#0 = #labtraba#0;
     #labnct03#1 = #labtraba#1;
     #labnct03#10 = eaQueEs;           || para el contrato
     |SI eaQueEs = "C";
          #labnct03#16 = 00;
     |FINSI;
     |SI eaQueEs = "P";
          #labnct03#16 = aProrroga;
     |FINSI;
     |LEE 000#labnct03.=;
     FEstado = FSalida;


     #labnct03#2 = #labtraba#45;
     #labnct03#3 = #labtraba#36;
     #labnct03#4 = #labtraba#37;
     |HAZ Jornada;
     #labnct03#5 = nJornada;
     #labnct03#6 = #labtraba#33;

     aUsuario = Usuario % 810;
     |QBF aUsuario;
     #labnct03#7 = aUsuario;       || usuario

     fFecha = ~;
     aFecha = fFecha;
     #labnct03#8 = fFecha;         || fecha

     |HORA aHora;
     |QBF aHora;
     aHora = aHora % 105;
     #labnct03#9 = aHora;               || hora
     #labnct03#10 = eaQueEs;             || para el envio desde aqui
     |SI eaExtDef = "";
          #labnct03#11 = "labimpre";         || desde envio a NetContrata
     |SINO;
          #labnct03#11 = eaExtDef;           || desde un contrato directamente
     |FINSI;
     #labnct03#12 = aFichero;           || Nombre de fichero desde el que fue generado
     #labnct03#13 = "0";                || estado inicial
     #labnct03#14 = "NO COMPLETADO";    || descripcion estado
     #labnct03#15 = #labtmpc2#0;        || codigo registro labregis
     #labnct03#17 = "";                 || Id Contrata

     |SI FEstado = 0;
          |GRABA 020#labnct03.a;
     |SINO;
          |GRABA 020#labnct03.n;
     |FINSI;

     swEstado = 0;
     aIdContrata = "";
     |HAZ labhisto_act;
     |HAZ labregis_act;

     |LIBERA #labnct03;
     |CIERRA #labnct03;
|FPRC;

|PROCESO IniErrores;
     |BORRA 020#labnct06.a;
|FPRC;

|DEFBUCLE IniErrores;
     #labnct06#1;
     ;
     #labtmpc2#0, nProrroga, 01;
     #labtmpc2#0, nProrroga, 99;
     ;
     NULL, IniErrores;
|FIN;

|PROCESO labhisto_act;
     #labhisto#100 = #labtmpc2#0;
     #labhisto#103 = #labtmpc2#17;
     |LEE 101#labhisto.=;
     |SI FSalida = 0;
          |SI swEstado = 0;
               #labhisto#161 = "0";
               #labhisto#162 = "NO COMPLETADO";
               #labhisto#163 = "";
          |FINSI;
          |SI swEstado = 1;
               #labhisto#161 = "1";
               #labhisto#162 = "RECHAZADO";
               #labhisto#163 = "";
          |FINSI;
          |SI swEstado = 2;
               #labhisto#161 = "2";
               #labhisto#162 = "ACEPTADO";
               #labhisto#163 = aIdContrata;
          |FINSI;

          |GRABA 020#labhisto.a;
          |LIBERA #labhisto;

          #labtmpc2#23 = #labhisto#161;
          #labtmpc2#24 = #labhisto#162;
          #labtmpc2#25 = #labhisto#163;

          |SI eaExtDef = "";       || si vengo de un contrato directamente no
          |Y swNetContrataMas = 0; || grabo nada, aunque me quedo con los va-
                                   || lores en los campos para guardar errores
               |GRABA 020#labtmpc2.a;
          |FINSI;                  || de Netcontrata Masivo tampoco, depues
     |FINSI;                       || no voy a mostrar el lineal
|FPRC;

|PROCESO labregis_act;
     |ABRE #labregis;
     #labregis#0 = #labtmpc2#0;
     |LEE 101#labregis.=;
     |SI FSalida = 0;
          #labregis#14 = aIdContrata;
          #labregis#29 = swEstado;
          |GRABA 020#labregis.a; |LIBERA #labregis;
     |FINSI;
     |CIERRA #labregis;
|FPRC;

|PROCESO labacuer_act;
     |ABRE #labacuer;
     #labacuer#0 = #labtmpc2#1;
     #labacuer#1 = #labtmpc2#2;
     |LEE 101#labacuer.=;
     |SI FSalida = 0;
          aAlfa = aIdContrata;
          #labacuer#28 = aIdContrata % 101;
          #labacuer#29 = aIdContrata % 202;
          #labacuer#31 = aIdContrata % 404;
          #labacuer#34 = aIdContrata % 807;
          |GRABA 020#labacuer.a;
          |LIBERA #labacuer;

          |SI swNetContrataMas = 0;
               aAlfa = "    Se ha actualizado el número de registro " + aIdContrata;
               aAlfa = aAlfa + " en el acuerdo de formación del trabajador."
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |CIERRA #labacuer;
|FPRC;

|PROCESO Correcciones;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     |ABRE #labregis;
     #labregis#0 = #labtmpc2#0;
     |LEE 000#labregis.=;
     |SI FSalida ! 0;
          |MENAV "    No existe el registro de emision del contrato";
          |ACABA;
     |FINSI;
     |CIERRA #labregis;

     aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SI aAlfa = "labprorr"; |O aAlfa = "labproli";
          aPrefijo = "pr";
          aTipo = "PRORROGA";
     |SINO;
          |SI nSwTrans = 1;
               aPrefijo = "tr";
               aTipo = "TRANSFORMACION";
          |SINO;
               aPrefijo = "co";
               aTipo = "CONTRATO";
          |FINSI;
     |FINSI;

     aAlfa = #labcontr#51;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
     |RMKDIR aAlfa;
     aRutaBAT = aRuta + "ejecuta.bat";
     aAlfa1 = (("000000" + #labtmpc2#0) % -106);

     |SI aPrefijo = "co";
          aFich = aAlfa + "CORRECCION_CONTR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "pr";
          aFich = aAlfa + "CORRECCION_PRORR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "tr";
          aFich = aAlfa + "CORRECCION_TRANS" + aAlfa1 + ".xml";
     |FINSI;

     |XABRE "CBW", aFich, nHandle;
     |SI FSalida ] 0;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "<CORRECCIONES>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "     <CORRECCION_" + aTipo + ">" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "          <DATOS_CONTRATO>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = #labregis#14; |QBF aAlfa;
          aAlfa = "               <IDENTIFICADOR>" + aAlfa + "</IDENTIFICADOR>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "          </DATOS_CONTRATO>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "     </CORRECCION_" + aTipo + ">" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "</CORRECCIONES>" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |PULSATECLA;
          |XCIERRA nHandle;
     |FINSI;

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     |DBASE aOrigen; |QBF aOrigen;
     aOrigen = aOrigen + "ejecutables/rdn.exe";
     aDestino = #labcontr#63; |QBF aDestino; aDestino = aDestino + "rdn.exe";

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;
     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     || en las correcciones, paso de esto de momento

     ||HAZ RegistroNetC_Inicial;
     ||HAZ RegistroOnline;
     ||BUCLE IniErrores;

     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO Millenium;
     |ABRE #labempre;
     #labempre#0 = 92;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          aAlfa = #labempre#10;
          |QBF aAlfa;
          |SI aAlfa = "B02378578";
               swMillenium = 1;
          |FINSI;
     |FINSI;
     |CIERRA #labempre;
|FPRC;

|PROCESO ElXML;
     |SI swNetContrataMas = 1;
          |HAZ DatosContrato;
     |FINSI;

     aAlfa = #labtmpc2#17; |QBF aAlfa;
     aFichs = "C:/DOCUMENTOS/Contrat@/" + aPrefijo + (("000000" + #labtmpc2#0) % -106) + (("00" + aAlfa) % -102) + ".txt";
     |XABRE "CB", aFichs, nHandle1;
     |SI FSalida ] 0;
          |XLEE nHandle1, 20, aAlfa;
          |PARA; |SI FSalida ! 0; |HACIENDO;
               |XGRABA nHandle, aAlfa;
               |XLEE nHandle1, 20, aAlfa;
          |SIGUE;
          |XCIERRA nHandle1;

          |ABRE #labregis;
          #labregis#0 = #labtmpc2#0;
          |LEE 101#labregis.=;
          |SI FSalida = 0;
               #labregis#27 = "R";
               |GRABA 020#labregis.a; |LIBERA #labregis;
          |FINSI;
          |CIERRA #labregis;
     |FINSI;

     |SI swNetContrataMas = 1;
          eaQueEs = "C";
          |HAZ RegistroNetC_Inicial;
          |HAZ RegistroOnline;
          |BUCLE IniErrores;
     |FINSI;
|FPRC;

|DEFBUCLE LosXML;
     #labtmpc2#1;
     14;
     000001, "  ", "*";
     999999, "zz", "*";
     ;
     NULL, ElXML;
|FIN;

|PROCESO DatosContrato;
     #labempre#0 = #labtmpc2#1;
     |LEE 000#labempre.=;
     |SI FSalida ! 0; |DDEFECTO #labempre; |FINSI;

     #labtraba#0 = #labtmpc2#1;
     #labtraba#1 = #labtmpc2#2;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0; |DDEFECTO #labtraba; |FINSI;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida ! 0; |DDEFECTO #labcentr; |FINSI;

     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida ! 0; |DDEFECTO #nomconca; |FINSI;

     #labhisto#100 = #labtmpc2#0;
     #labhisto#103 = #labtmpc2#17;
     |LEE 000#labhisto.=;
     |SI FSalida ! 0; |MENAV "    No encuentro el registro de emision del contrato"; |ERROR; |ACABA; |FINSI;

     eaCodNif = #labempre#10;
     |HAZ LeeNifs;

     aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SI aAlfa = "labprorr"; |O aAlfa = "labproli";
          aPrefijo = "pr";
          aTipo = "PRORROGAS";
     |SINO;
          |SI nSwTrans = 1;
               aPrefijo = "tr";
               aTipo = "TRANSFORMACIONES";
          |SINO;
               aPrefijo = "co";
               aTipo = "CONTRATOS";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaContrato;
     nReg = #labtmpc2#0
     nPro = #labtmpc2#17
     nEmp = #labtmpc2#1;
     nTra = #labtmpc2#2;
|FPRC;

|DEFBUCLE BuscaContrato;
     #labtmpc2#1;
     5, 14;
     0000001, "  ", aNif, "*";
     9999999, "zz", aNif, "*";
     ;
     NULL, BuscaContrato;
|FIN;

|PROCESO QuitaBlancos;
     |SI aAlfa = "";
          |ACABA;
     |FINSI;
     aEspacios = "";
     |PARA nPos = 1; |SI nPos [ 99; |HACIENDO nPos = nPos + 1;
          nNume = (nPos * 100) + 1;
          aUno = aAlfa % nNume;
          |SI aUno = " ";
               aEspacios = aEspacios + " ";
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     aAlfa = aAlfa - aEspacios;
|FPRC;

|PROCESO Respuesta;
     |XABRE "C", aAlfa, nHandle; nHandle = FSalida;
     |SI FSalida ] 0;
          swRespuesta = 1;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               |XLEE nHandle, 250, aAlfa;
               aAlfa = aAlfa - "<CONTRATO_";
               |SI FSalida ! 0;
                    |PARA; |SI FSalida ] 0; |HACIENDO;
                         |XLEE nHandle, 250, aAlfa;

                         aAlfa = aAlfa - "</CONTRATO_";
                         |SI FSalida ! 0;
                              |SAL;
                         |FINSI;

                         aAlfa = aAlfa - "<DNITRABA>";
                         |SI FSalida ! 0;
                              aAlfa = aAlfa - "</DNITRABA>";
                              |QBT aAlfa;
                              aNif = aAlfa + "   ";
                              |BUCLE BuscaContrato;
                         |FINSI;

                         aAlfa = aAlfa - "<IDCONTRATO>";
                         |SI FSalida ! 0;
                              || todo ha ido bien, me guardo el ID del contrato
                              aLinea = aAlfa;
                              |QBF aLinea;
                              aLinea = aLinea - "</IDCONTRATO>";
                              aIdContrata = aLinea;
                              |QBT aIdContrata;
                              |SI aIdContrata ! "";
                                   swEstado = 2;

                                   #labtraba#0 = nEmp;
                                   #labtraba#1 = nTra;
                                   eaQueEs = "C";
                                   |HAZ RegistroNetC_Act;

                                   #labtmpc2#0 = nReg;
                                   #labtmpc2#17 = "  ";
                                   |LEE 101#labtmpc2.=;

                                   |HAZ labhisto_act;
                                   |HAZ labregis_act;

                                   aAlfa1 = #labtmpc2#15; |QBF aAlfa1;
                                   |SI aAlfa1 = "";
                                        aAlfa1 = #labhisto#0; |QBF aAlfa1;
                                   |FINSI;
                                   |SI aAlfa1 = "421"; |O aAlfa1 = "085";
                                        |HAZ labacuer_act;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         aAlfa = aAlfa - "<RESULTADO>";
                         |SI FSalida ! 0;
                              aAlfa = aAlfa - "</RESULTADO>";
                              |QBT aAlfa;
                              aResultado = aAlfa;

                              |SI aResultado = "RECHAZADO";
                                   swEstado = 1;
                                   #labtraba#0 = nEmp;
                                   #labtraba#1 = nTra;
                                   eaQueEs = "C";
                                   |HAZ RegistroNetC_Act;

                                   #labtmpc2#0 = nReg;
                                   #labtmpc2#17 = "  ";
                                   |LEE 101#labtmpc2.=;

                                   |HAZ labhisto_act;
                                   |HAZ labregis_act;
                              |FINSI;
                         |FINSI;

                         aAlfa = aAlfa - "<ERRORES>";
                         |SI FSalida ! 0;
                              || Ha habido errores, me los guardo
                              || A partir de aqui leo hasta encontrar la etiqueta </ERRORES>

                              |PARA; |SI; |HACIENDO;
                                   |XLEE nHandle, 250, aAlfa;
                                   |QBF aAlfa;
                                   |HAZ QuitaBlancos;

                                   aAlfa = aAlfa - "</ERRORES>";
                                   |SI FSalida ! 0;
                                        |SAL;
                                   |FINSI;

                                   aLinea = aAlfa - "<ERROR";
                                   |SI FSalida ! 0;
                                        aCodigo = aLinea % 101;
                                        aAlfa = aLinea % 201;
                                        |SI aAlfa ! ">";
                                             aCodigo = aCodigo + aAlfa;
                                        |FINSI;
                                        aLinea = "-" + aLinea;
                                        aAlfa = "-" + aCodigo + ">";
                                        aLinea = aLinea - aAlfa;
                                        aLinea = aLinea - (aCodigo + ". ");
                                        aLinea = aLinea - ("</ERROR" + aCodigo + ">");

                                        || bueno pues en teoria aqui ya tengo el numero
                                        || de error y la descripcion,

                                        aCadena = aLinea;
                                        aCadena = aCadena - "No se acepta la comunicación.";
                                        |HAZ Tildes;
                                        aLinea = aCadena;

                                        |ABRE #labnct06;
                                        #labnct06#0 = nReg;
                                        #labnct06#1 = nPro;
                                        #labnct06#2 = aCodigo;
                                        #labnct06#3 = aLinea;
                                        |GRABA 020#labnct06.n;
                                        |LIBERA #labnct06;
                                        |CIERRA #labnct06;
                                   |FINSI;
                              |SIGUE;
                              |SAL;
                         |FINSI;
                    |SIGUE;
               |FINSI;
               aAlfa = aAlfa - "</RESPUESTA_CONTRATA>";
               |SI FSalida ! 0;
                    |SAL;
               |FINSI;
          |SIGUE;
     |SINO;
          |MENAV "    Fichero de respuesta NO encontrado. Proceso de envío no completado";
          swRespuesta = -1;
     |FINSI;
|FPRC;

|PROCESO NetContrataMas;
     |SI swStopProrr = 1; |ACABA; |FINSI;

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     swSigue = 0;

     swMillenium = 0;
     |HAZ Millenium;

     |SI swMillenium = 1;
          swSigue = 2;
     |SINO;
          |SUB_EJECUTA "labnct00";
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     ||HAZ DatosContrato;     || se hara en el bucle de despues

     aAlfa = #labcontr#51;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
     |RMKDIR aAlfa;
     aRutaBAT = aRuta + "ejecuta.bat";

     || aAlfa1 = (("000000" + #labtmpc2#0) % -106);
     aPrefijo = "co";
     aAlfa1 = "_MASIVO";
     aTipo = "CONTRATOS";

     |SI aPrefijo = "co";
          aFich = aAlfa + "CONTR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "pr";
          aFich = aAlfa + "PRORR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "tr";
          aFich = aAlfa + "TRANS" + aAlfa1 + ".xml";
     |FINSI;

     || ojo, eso lo hago solo para CONTRATOS, para PRORROGAS Y TRANSFORMACIONES
     || entro siempre por aqui, por donde siempre
     |XABRE "CBW", aFich, nHandle;
     |SI FSalida ] 0;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "<" + aTipo + ">" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |BUCLE LosXML;

          aAlfa = "</" + aTipo + ">" + &13 + &10;          |XGRABA nHandle, aAlfa;
     |FINSI;
     |PULSATECLA;
     |XCIERRA nHandle;

     || A PARTIR DE AQUI SI ME VALDRA, EL SE PONE A HACER SU NETCONTRATA
     || Y SUS COSAS

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     |DBASE aOrigen; |QBF aOrigen;
     aOrigen = aOrigen + "ejecutables/rdn.exe";
     aDestino = #labcontr#63; |QBF aDestino; aDestino = aDestino + "rdn.exe";

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;
     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aProrroga = #labtmpc2#17;
     nProrroga = aProrroga;
     |QBF aProrroga;
     |SI aProrroga ! "";
          eaQueEs = "P";       || es una prorroga
     |SINO;
          |SI nSwTrans = 1;
               eaQueEs = "T";       || es una transformacion
          |SINO;
               eaQueEs = "C";       || es un contrato
          |FINSI;
     |FINSI;

     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     || examinamos la respuesta que nos da

     nSwEtiq = 0; aEtiqu = ""; aError = ""; nNumChars = 0;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     |PUSHV 12191859;
     |BLANCO 13201758;
     |CUADRO 13201758;
     |ATRI S;
     aMensa = " -- Esperando respuesta Online -- ";
     |PINTA 1422, aMensa;
     aMensa = "Pulse ENTER cuando procese el envío";
     |PINTA 1522, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;

     |HAZ Respuesta;

     |XCIERRA nHandle1;


     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";
     |RFBORRA aAlfa;
/*
     || si vengo de Labornet, la llamada al dsarchi la hare desde el
     || lineal de actualizacion de altas

     |SI eaQueEs ! "P"; |Y enEmpLabornet = 0;
          || de momento no cojo la respuesta de la prorroga

          |SI #labtmpc2#23 = 2;
               |HAZ DSArchi;  || esta mas abajo, el siguiente proceso
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO NetContrata;
     |SI swStopProrr = 1; |ACABA; |FINSI;

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     swSigue = 0;

     swMillenium = 0;
     |HAZ Millenium;

     |SI swMillenium = 1;
          swSigue = 2;
     |SINO;
          |SUB_EJECUTA "labnct00";
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     #labempre#0 = #labtmpc2#1;
     |LEE 000#labempre.=;
     |SI FSalida ! 0; |DDEFECTO #labempre; |FINSI;

     #labtraba#0 = #labtmpc2#1;
     #labtraba#1 = #labtmpc2#2;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0; |DDEFECTO #labtraba; |FINSI;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida ! 0; |DDEFECTO #labcentr; |FINSI;

     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida ! 0; |DDEFECTO #nomconca; |FINSI;

     #labhisto#100 = #labtmpc2#0;
     #labhisto#103 = #labtmpc2#17;
     |LEE 000#labhisto.=;
     |SI FSalida ! 0; |MENAV "    No encuentro el registro de emision del contrato"; |ERROR; |ACABA; |FINSI;

     eaCodNif = #labempre#10;
     |HAZ LeeNifs;

     aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SI aAlfa = "labprorr"; |O aAlfa = "labproli";
          aPrefijo = "pr";
          aTipo = "PRORROGAS";
     |SINO;
          |SI nSwTrans = 1;
               aPrefijo = "tr";
               aTipo = "TRANSFORMACIONES";
          |SINO;
               aPrefijo = "co";
               aTipo = "CONTRATOS";
          |FINSI;
     |FINSI;

     aAlfa = #labcontr#51;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
     |RMKDIR aAlfa;
     aRutaBAT = aRuta + "ejecuta.bat";
     aAlfa1 = (("000000" + #labtmpc2#0) % -106);

     |SI aPrefijo = "co";
          aFich = aAlfa + "CONTR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "pr";
          aFich = aAlfa + "PRORR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "tr";
          aFich = aAlfa + "TRANS" + aAlfa1 + ".xml";
     |FINSI;

     swSigue = 0;
     |SI swNetContrata = 0; |Y aTipo ! "CONTRATOS";
          swSigue = 1;
     |FINSI;
     |SI swNetContrata = 1; |Y aTipo = "PRORROGAS";
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
          || esto lo hago cuando estoy creando los xml para Contrata, que
          || pueden llevar varios contratos, si es un solo contrato para
          || NetContrata, copio directamente el txt que he generado antes
          || en el zpdfdoc1, que ya lo tengo con cabecera

          || ojo, eso lo hago solo para CONTRATOS, para PRORROGAS Y TRANSFORMACIONES
          || entro siempre por aqui, por donde siempre

          |XABRE "CBW", aFich, nHandle;
          |SI FSalida ] 0;
               aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;
               |XGRABA nHandle, aAlfa;
               aAlfa = "<" + aTipo + ">" + &13 + &10;
               |XGRABA nHandle, aAlfa;

               |HAZ ElXML;

               aAlfa = "</" + aTipo + ">" + &13 + &10;          |XGRABA nHandle, aAlfa;
          |FINSI;
          |PULSATECLA;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = #labtmpc2#17; |QBF aAlfa;
          aFichs = "C:/DOCUMENTOS/Contrat@/" + aPrefijo + (("000000" + #labtmpc2#0) % -106) + (("00" + aAlfa) % -102) + ".txt";
          |RCOPIA_FICHERO aFichs, aFich;
     |FINSI;

     || A PARTIR DE AQUI SI ME VALDRA, EL SE PONE A HACER SU NETCONTRATA
     || Y SUS COSAS

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     |DBASE aOrigen; |QBF aOrigen;
     aOrigen = aOrigen + "ejecutables/rdn.exe";
     aDestino = #labcontr#63; |QBF aDestino; aDestino = aDestino + "rdn.exe";

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;
     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aProrroga = #labtmpc2#17;
     nProrroga = aProrroga;
     |QBF aProrroga;
     |SI aProrroga ! "";
          eaQueEs = "P";       || es una prorroga
     |SINO;
          |SI nSwTrans = 1;
               eaQueEs = "T";       || es una transformacion
          |SINO;
               eaQueEs = "C";       || es un contrato
          |FINSI;
     |FINSI;

     |HAZ RegistroNetC_Inicial;
     |HAZ RegistroOnline;
     |BUCLE IniErrores;

     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     || examinamos la respuesta que nos da

     nSwEtiq = 0; aEtiqu = ""; aError = ""; nNumChars = 0;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     |PUSHV 12191859;
     |BLANCO 13201758;
     |CUADRO 13201758;
     |ATRI S;
     || aMensa = "Esperando respuesta  de NetContrat@";
     aMensa = " -- Esperando respuesta Online -- ";
     |PINTA 1422, aMensa;
     aMensa = "Pulse ENTER cuando procese el envío";
     |PINTA 1522, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;

     |XABRE "C", aAlfa, nHandle; nHandle = FSalida;
     |SI FSalida ] 0;
          swAcaba = 0;
          |PARA; |SI FSalida ] 0; |Y swAcaba = 0; |HACIENDO;
               |XLEE nHandle, 250, aAlfa;
               aAlfa = aAlfa - "<IDCONTRATO>";
               |SI FSalida ! 0;
                    || todo ha ido bien, me guardo el ID del contrato
                    aLinea = aAlfa;
                    |QBF aLinea;
                    aLinea = aLinea - "</IDCONTRATO>";
                    aIdContrata = aLinea;
                    |QBT aIdContrata;
                    |SI aIdContrata ! "";
                         swEstado = 2;
                         |HAZ RegistroNetC_Act;
                         |HAZ labhisto_act;
                         |HAZ labregis_act;
                         aAlfa1 = #labtmpc2#15; |QBF aAlfa1;
                         |SI aAlfa1 = "";
                              aAlfa1 = #labhisto#0; |QBF aAlfa1;
                         |FINSI;
                         |SI aAlfa1 = "421"; |O aAlfa1 = "085";
                              |HAZ labacuer_act;
                         |FINSI;
                         swAcaba = 1;
                    |FINSI;
               |FINSI;

               |SI eaQueEs = "P";       || es una prorroga
                    aAlfa = aAlfa - "<RESULTADO>";
                    |SI FSalida ! 0;    || prorroga aceptada
                         aLinea = aAlfa;
                         |QBF aLinea;
                         aLinea = aLinea - "</RESULTADO>";
                         aResultado = aLinea;
                         |QBT aResultado;
                         |SI aResultado = "ACEPTADO";
                              swEstado = 2;
                              aIdContrata = eaIdContrato;
                              |HAZ RegistroNetC_Act;
                              |HAZ labhisto_act;
                              /*
                              || se supone que esto no hace falta para la prorroga
                              |HAZ labregis_act;
                              aAlfa1 = #labtmpc2#15; |QBF aAlfa1;
                              |SI aAlfa1 = "";
                                   aAlfa1 = #labhisto#0; |QBF aAlfa1;
                              |FINSI;
                              |SI aAlfa1 = "421"; |O aAlfa1 = "085";
                                   |HAZ labacuer_act;
                              |FINSI;
                              */
                              swAcaba = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI eaQueEs = "T";       || es una transformacion
                    aAlfa = aAlfa - "<RESULTADO>";
                    |SI FSalida ! 0;    || transformacion aceptada
                         aLinea = aAlfa;
                         |QBF aLinea;
                         aLinea = aLinea - "</RESULTADO>";
                         aResultado = aLinea;
                         |QBT aResultado;
                         |SI aResultado = "ACEPTADO";
                              swEstado = 2;
                              |SI #labtmpc2#16 = "labcona5"; |O #labtmpc2#16 = "labcona6";
                                   aAlfa = #labhisto#56;
                              |SINO;
                                   aAlfa = #labhisto#75;
                              |FINSI;
                              |QBF aAlfa;
                              eaIdContrato = aAlfa;
                              aIdContrata = aAlfa;
                              |HAZ RegistroNetC_Act;
                              |HAZ labhisto_act;
                              |HAZ labregis_act;
                              swAcaba = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               aAlfa = aAlfa - "<ERRORES>";
                         |SI FSalida ! 0;
                              || Ha habido errores, me los guardo
                              || A partir de aqui leo hasta encontrar la etiqueta </ERRORES>

                              |PARA; |SI; |HACIENDO;
                                   |XLEE nHandle, 250, aAlfa;
                                   |QBF aAlfa;
                                   |HAZ QuitaBlancos;

                                   aAlfa = aAlfa - "</ERRORES>";
                                   |SI FSalida ! 0;
                                        |SAL;
                                   |FINSI;

                                   aLinea = aAlfa - "<ERROR";
                                   |SI FSalida ! 0;
                                        aCodigo = aLinea % 101;
                                        aAlfa = aLinea % 201;
                                        |SI aAlfa ! ">";
                                             aCodigo = aCodigo + aAlfa;
                                        |FINSI;
                                        aLinea = "-" + aLinea;
                                        aAlfa = "-" + aCodigo + ">";
                                        aLinea = aLinea - aAlfa;
                                        aLinea = aLinea - (aCodigo + ". ");
                                        aLinea = aLinea - ("</ERROR" + aCodigo + ">");

                                        || bueno pues en teoria aqui ya tengo el numero
                                        || de error y la descripcion,

                                        aCadena = aLinea;
                                        |HAZ Tildes;
                                        aLinea = aCadena;

                                        |ABRE #labnct06;
                                        #labnct06#0 = #labtmpc2#0;
                                        #labnct06#1 = #labtmpc2#17;
                                        #labnct06#2 = aCodigo;
                                        #labnct06#3 = aLinea;
                                        |GRABA 020#labnct06.n;
                                        |LIBERA #labnct06;
                                        |CIERRA #labnct06;
                                   |FINSI;
                              |SIGUE;

                              swEstado = 1;
                              |HAZ RegistroNetC_Act;
                              |HAZ labhisto_act;

                              |SAL;
                         |FINSI;
/*
               |SI FSalida ! 0;
                    || Ha habido errores, me los guardo
                    || A partir de aqui leo hasta encontrar la etiqueta </ERRORES>

                    |ABRE #labnct06;

                    |XLEE nHandle, 250, aAlfa; nNumChars = FSalida;
                    swAcaba = 0;
                    |PARA; |SI nNumChars ! 0; |Y swAcaba = 0; |HACIENDO;
                         || es una de las lineas con el codigo de error

                         aAlfa = aAlfa - "</ERRORES>";
                         |QBF aAlfa;
                         aLinea = aAlfa;
                         aLinea = aLinea - "        ";
                         |SI aLinea = "";
                              swAcaba = 1;
                              |SAL;
                              || fin de las lineas de errores;
                         |SINO;
                              aLinea = aLinea - "<ERROR";
                              aCodigo = aLinea % 101;
                              aLinea = aLinea - aCodigo;
                              aAlfa = aLinea % 101;
                              |SI aAlfa ! ">";
                                   aCodigo = aCodigo + aAlfa;
                              |FINSI;
                              aLinea = aLinea - aAlfa;
                              aLinea = aLinea - (aCodigo + ". ");
                              aLinea = aLinea - ("</ERROR" + aCodigo + ">");
                              aLinea = aLinea % 180;

                              || bueno pues en teoria aqui ya tengo el numero
                              || de error y la descripcion, me quedo en principio
                              || con los primeros 80 caracteres

                              aCadena = aLinea;
                              |HAZ Tildes;
                              aLinea = aCadena;

                              #labnct06#2 = aCodigo;
                              #labnct06#3 = aLinea;
                              |GRABA 020#labnct06.n;
                              |LIBERA #labnct06;
                         |FINSI;
                         |XLEE nHandle, 250, aAlfa; nNumChars = FSalida;
                    |SIGUE;

                    swEstado = 1;
                    |HAZ RegistroNetC_Act;
                    |HAZ labhisto_act;
                    |CIERRA #labnct06;

                    |SAL;
               |FINSI;
*/
          |SIGUE;
          |XLEE nHandle, 250, aAlfa;
     |FINSI;
     |XCIERRA nHandle1;

     |SI #labtmpc2#23 = 0;
          |MENAV "    Fichero de respuesta NO encontrado. Proceso de envío no completado";
     |FINSI;
     |SI #labtmpc2#23 = 1;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado con errores";
     |FINSI;
     |SI #labtmpc2#23 = 2;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado correctamente";
     |FINSI;

     |XCIERRA nHandle;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";
     |RFBORRA aAlfa;

     || si vengo de Labornet, la llamada al dsarchi la hare desde el
     || lineal de actualizacion de altas

     |SI eaQueEs ! "P"; |Y enEmpLabornet = 0;
          || de momento no cojo la respuesta de la prorroga

          |SI #labtmpc2#23 = 2;
               |HAZ DSArchi;  || esta mas abajo, el siguiente proceso
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Mensaje;
/*
     |PUSHV 11151965;
     |BLANCO 12181763;
     |CUADRO 12181762;
     |ATRI S;
          ||   2         3         4         5        6
          ||   0123456789012345678901234567890123467890
     aMensa = "Pulse ENTER cuando haya validado la ope-";
     |PINTA 1320, aMensa;
     aMensa = "raci¢n y enviado el certificado  online,";
     |PINTA 1420, aMensa;
     aMensa = "para archivar  los documentos recibidos.";
     |PINTA 1520, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;
*/

     aAlfa = "    SSOLO tras registrar y validar el contrato, ";
     aAlfa = aAlfa + "pulse SI para archivarlo o NO para no archivar.";
     |CONFI aAlfa;
     |SI FSalida ! 0;
          nArchi = 0;
     |FINSI;
|FPRC;

|PROCESO NombreFichero;
/*
     || QUEDE CON MIGUEL ANGEL EN QUE FUERA DE ESTA MANERA, PERO AL FINAL
     || EL TIO ESTA USANDO EL ID. DEL CONTRATO. COMO ME DA IGUAL, YO
     || USO LO MISMO

     aNif = #labtraba#7; |QBF aNif;
     aCCC = #labcentr#10; |QBF aCCC;
     aFechaAlta = #labtraba#34; |QBF aFechaAlta;

     aFichero1 = aCCC + "_" + aNif + "_" + (aFechaAlta % -104);
     aFichero1 = aFichero1 + (aFechaAlta % 402) + (aFechaAlta % 102);
*/

     aFichero1 = (aIdContrata % 101) + "-" + (aIdContrata % 202) + "-" + (aIdContrata % 404) + "-" + (aIdContrata % 807);

     |SI eaQueEs = "C";
          aFichero1 = (aIdContrata % 101) + "-" + (aIdContrata % 202) + "-" + (aIdContrata % 404) + "-" + (aIdContrata % 807) + "_CON";
     |FINSI;

     |SI eaQueEs = "P"
          aFichero1 = (aIdContrata % 101) + "-" + (aIdContrata % 202) + "-" + (aIdContrata % 404) + "-" + (aIdContrata % 807) + "_PRO";
     |FINSI;

     |SI eaQueEs = "T"
          aFichero1 = (aIdContrata % 101) + "-" + (aIdContrata % 202) + "-" + (aIdContrata % 404) + "-" + (aIdContrata % 807) + "_TRANS";
     |FINSI;
|FPRC;

|PROCESO DSArchi;
     eaVengoDe = "labimpre";
     nArchi = 0;
     |HAZ MiraSiArchiva;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     |HAZ Mensaje;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     swSigue = 1;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aFichCertif = "";
     aFichHuella = "";

     aAlfa = #labcontr#63; |QBF aAlfa;
     |HAZ NombreFichero;
     aFichero1 = aFichero1 + ".pdf";
     aFichHuella = aFichero1;
     aAlfa = aAlfa + "\HCONTRATOS\" + aFichero1;

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     |SI swSigue = 0;
          aAlfa = "    No se ha encontrado la huella del contrato para archivar";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     enEmp = #labregis#1;
     enTra = #labregis#2;

     |SI eaQueEs = "C";  fFechaAlta = #labregis#7;   |FINSI;
     |SI eaQueEs = "P";  fFechaAlta = #labregis#19;  |FINSI;
     |SI eaQueEs = "T";  fFechaAlta = #labregis#7;   |FINSI;

     aAlfa = fFechaAlta;
     aAlfa = aAlfa % 402;
     enMes = aAlfa;
     aAlfa = fFechaAlta;
     aAlfa = aAlfa % -104;
     enAny = aAlfa;

     || aqui le tengo que poner el nombre de los archivos para enviar uno y
     || despues el otro

     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\HCONTRATOS\" + aFichHuella;
     eaOrig = aAlfa;

     |SI eaQueEs = "C";
          eaObservaciones = "Huella del contrato de trabajo";
     |FINSI;

     |SI eaQueEs = "P";
          eaObservaciones = "Huella de la pr¢rroga";
     |FINSI;

     |SI eaQueEs = "T";
          eaObservaciones = "Huella de la transformaci¢n";
     |FINSI;
     |HAZ Archivando;

     |SI enSwErrorRecDoc ! 1;
          aAlfa = "    Se ha archivado la huella del registro ";
          |SI eaQueEs = "C";
               aAlfa = aAlfa + "del contrato de trabajo del trabajador.";
          |FINSI;
          |SI eaQueEs = "P";
               aAlfa = aAlfa + "de la prórroga del trabajador.";
          |FINSI;
          |SI eaQueEs = "T";
               aAlfa = aAlfa + "de la transformación del trabajador.";
          |FINSI;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO inf_nct06;
     #labnct06#0 = #labtmpc2#0;
     #labnct06#1 = #labtmpc2#17;
     #labnct06#2 = 01;
|FPRC;

|PROCESO sup_nct06;
     #labnct06#0 = #labtmpc2#0;
     #labnct06#1 = #labtmpc2#17;
     #labnct06#2 = 99;
|FPRC;

|PROCESO MarcaTodosCon;
     |SI #labtmpc2#17 ! "  ";
     |O #labtmpc2#15 = "109"; |O #labtmpc2#15 = "189";
     |O #labtmpc2#15 = "289"; |O #labtmpc2#15 = "389";
          |ACABA;
     |FINSI;
     |SI aMarca = "";
          |SI #labtmpc2#14 = " ";
               aMarca = "S";
          |SINO;
               aMarca = "N";
          |FINSI;
     |FINSI;
     |SI aMarca = "S";
          #labtmpc2#14 = "*";
          nNumMarcas = nNumMarcas + 1;
     |SINO;
          #labtmpc2#14 = " ";
     |FINSI;
     |GRABA 020#labtmpc2.a;
     |LIBERA #labtmpc2;
|FPRC;

|DEFBUCLE MarcaTodosCon;
     #labtmpc2#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, MarcaTodosCon;
|FIN;

|PROCESO Marca; |TIPO 11;
     |SI FSalida ! 10; |Y FSalida ! 11; |Y FSalida ! 12;
     |Y FSalida ! 13; |Y FSalida ! 0;
          |ACABA;
     |FINSI;

     |SI FSalida = 10; |Y aParam = "CONTRAT@";
        |SI #labtmpct#14 = " ";
             #labtmpct#14 = "*";
             nNumMarcas = nNumMarcas + 1;
        |SINO;
             #labtmpct#14 = " ";
             nNumMarcas = nNumMarcas - 1;
        |FINSI;
        |GRABA 020#labtmpct.a;

        |PONCONTROL 23, "si";
        |PTEC 802;
     |FINSI;
     |SI aParam = "NETCONTRAT@";
          |SI FSalida = 11;
               swNetContrata = 1;
               swNetContrataMas = 0;
               |HAZ Impresion;
               |HAZ NetContrata;
               |PINTA #labtmpc2#23;
               |PINTA #labtmpc2#24;
               |PINTA #labtmpc2#25;
               |PONCONTROL 23, "si";
          |FINSI;
          |SI FSalida = 12;
               |SI swPortal = 0;
                    ||MENAV eaMensaPortal;
                    |ACABA;
               |FINSI;
               |SI #labtmpc2#17 ! "  ";
                    |MENAV "    Envío masivo de prórrogas aún no disponible. Pulse F3 para enviar individualmente";
                    |PTEC 808;
                    |ACABA;
               |FINSI;
               |SI #labtmpc2#15 = "109"; |O #labtmpc2#15 = "189";
               |O #labtmpc2#15 = "289"; |O #labtmpc2#15 = "389";
                    |MENAV "    Envío masivo de transformaciones aún no disponible. Pulse F3 para enviar individualmente";
                    |PTEC 808;
                    |ACABA;
               |FINSI;
               |SI #labtmpc2#14 = " ";
                    #labtmpc2#14 = "*";
                    nNumMarcas = nNumMarcas + 1;
               |SINO;
                    #labtmpc2#14 = " ";
                    nNumMarcas = nNumMarcas - 1;
               |FINSI;
               |GRABA 020#labtmpc2.a;

               |PONCONTROL 23, "si";
          |FINSI;

          |SI FSalida = 13;
               |SI swPortal = 0;
                    ||MENAV eaMensaPortal;
                    |ACABA;
               |FINSI;

               nRegAct1 = #labtmpc2#0;
               aRegAct2 = #labtmpc2#17;
               aMarca = "";
               nNumMarcas = 0;
               |BUCLE MarcaTodosCon;

               #labtmpc2#0 = nRegAct1;
               #labtmpc2#17 = aRegAct2;
               |LEE 000#labtmpc2.=;

               |PONCONTROL 23, "si";
               ||PTEC 802;
          |FINSI;
          |SI FSalida = 14;
               |PUSHV 10012380;
               |CUADRO 10671480
               |ATRI R;
               |PINTA 1169, "Emp:";
               |PINTA 1269, "Tra:";
               |PINTA 1369, "Reg:";
               |ATRI 0;
               |PINTA 1174, #labtmpc2#1;
               |PINTA 1274, #labtmpc2#2;
               |PINTA 1374, #labtmpc2#0;
               |ENTLINEAL #1#labnct06, -3, 4, 22, 1, inf_nct06, sup_nct06;
               |POPV;
               |ERROR;
          |FINSI;
          /*
          || Correccion errores, yo diria que no lo usa nadie, lo quito
          || de momento: 25.10.2018
          |SI FSalida = 13;
               |HAZ Correcciones;
               |PINTA #labtmpc2#23;
               |PINTA #labtmpc2#24;
               |PINTA #labtmpc2#25;
               |PONCONTROL 23, "si";
          |FINSI;
          */
     |FINSI;
|FPRC;

|PROCESO Impresion;
     swImpreso = 0;
     |SI swImpMasiva = 1; |Y eaUsaGADSiExiste ! "N";
          |HAZ BuscaContGAD;
          |SI swImpreso = 1;
               |ACABA;
          |FINSI;
     |FINSI;

     nLabHisto = 1;
     |SI aParam = "NETCONTRAT@";
          enNumRegis = #labtmpc2#0;
          eaNumProrr = #labtmpc2#17;
     |SINO;
          enNumRegis = #labtmpct#0;
          eaNumProrr = #labtmpct#17;
     |FINSI;

     |SI aParam = "NETCONTRAT@";
          aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SINO;
          aAlfa = #labtmpct#16; |QBF aAlfa;
     |FINSI;
     aAlfa = aAlfa + ".tab";
     |SI aAlfa = "labproli.tab";
          aAlfa = "labprorr.tab";
     |FINSI;

     |SI aParam = "CONTRAT@"; |O aParam = "NETCONTRAT@";
          aAlfa = aAlfa + ";CONTRAT@";
     |FINSI;

     swStopProrr   = 0;
     enCtoModifica = 0;

     |SUB_EJECUTA_NP aAlfa;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |ABRE #labregis;
     #labregis#0 = enNumRegis;
     |LEE 101#labregis.=;
     |SI FSalida = 0;
          |SI nSwImp = 0;
               #labregis#27 = "R";
               |GRABA 020#labregis.a;
          |FINSI;
          |LIBERA #labregis;
     |FINSI;
     |CIERRA #labregis;

     nContratos = nContratos + 1;
|FPRC;

|DEFBUCLE Impresion;
     #labtmpct#1;
     14;
          1, "  ", "*";
     999999, "zz", "*";
     ;
     NULL, Impresion;
|FIN;

|PROCESO infimpre;
     #labtmpct#0 = 1;
     #labtmpct#17 = "  ";
|FPRC;

|PROCESO supimpre;
     #labtmpct#0 = 999999;
     #labtmpct#17 = "zz";
|FPRC;

|PROCESO infimpre1;
     #labtmpc1#0 = 1;
     #labtmpc1#17 = "  ";
|FPRC;

|PROCESO supimpre1;
     #labtmpc1#0 = 999999;
     #labtmpc1#17 = "zz";
|FPRC;

|PROCESO infimpre2;
     #labtmpc2#0 = 1;
     #labtmpc2#17 = "  ";
|FPRC;

|PROCESO supimpre2;
     #labtmpc2#0 = 999999;
     #labtmpc2#17 = "zz";
|FPRC;

|PROCESO Registro;
|DEBUG;
     fFechaAlta = #labregis#7;

     |SI #0#2 [ fFechaAlta; |Y fFechaAlta [ #0#5;
          || adelante
     |SINO;
          |ACABA;
     |FINSI;

     #labempre#0 = #labregis#1;
     |LEE 000#labempre.=;

     #labtraba#0 = #labregis#1;
     #labtraba#1 = #labregis#2;
     |LEE 000#labtraba.=;

     |SI #0#12 [ #labtraba#77; |Y #labtraba#77 [ #0#13;
          || entra
     |SINO;
          |ACABA;
     |FINSI;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;

     #labhisto#100 = #labregis#0;
     #labhisto#103 = "  ";
     |LEE 000#labhisto.];
     |PARA; |SI FSalida = 0; |Y #labhisto#100 = #labregis#0; |HACIENDO;
          |DDEFECTO #labtmpct;
          #labtmpct#0  = #labregis#0;     || Contador
          #labtmpct#1  = #labregis#1;     || Empresa
          #labtmpct#2  = #labregis#2;     || Trabajador
          #labtmpct#3  = #labempre#2;     || Nombre empresa
          #labtmpct#4  = #labtraba#2;     || Nombre Trabajador
          #labtmpct#5  = #labregis#3;     || DNI
          #labtmpct#6  = #labtraba#75;    || NAFSS
          #labtmpct#7  = #labregis#6;     || Real Decreto
          #labtmpct#8  = #labregis#5;     || Descripcion Real Decreto
          #labtmpct#9  = #labregis#9;     || Meses duracion contrato
          #labtmpct#10 = #labregis#10;    || Dias duracion contrato
          #labtmpct#11 = #labregis#21;    || Fecha registro
          #labtmpct#12 = #labregis#7;     || Fecha inicio contrato
          #labtmpct#13 = #labregis#8;     || Fecha fin contrato
          |SI nRegistro ! 0;
               #labtmpct#14 = "*";        || Marcado para PDF's
          |FINSI;
          #labtmpct#15 = #labregis#4;     || Codigo Contrato
          #labtmpct#16 = #labhisto#101;   || Modulo ejecucion
          #labtmpct#17 = #labhisto#103;   || N§ Prorroga
          |SI #labhisto#101 = "labprorr";
               #labtmpct#18 = #labhisto#7; #labtmpct#19 = #labhisto#8;
               #labtmpct#20 = #labhisto#5; #labtmpct#21 = #labhisto#6;
          |FINSI;
          |SI #labhisto#101 = "labproli";
               #labtmpct#18 = #labhisto#9;  #labtmpct#19 = #labhisto#42;
               #labtmpct#20 = #labhisto#10; #labtmpct#21 = #labhisto#11;
          |FINSI;
          #labtmpct#22 = #labregis#27;    || Situacion
          |SI aParam = "NETCONTRAT@";
               #labtmpct#23 = #labhisto#161;    || Situacion Netcontrat@
               #labtmpct#24 = #labhisto#162;    || Descripcion Situacion Netcontrat@
               #labtmpct#25 = #labhisto#163;    || Id Contrat@ Netcontrat@
          |FINSI;
          #labtmpct#26 = #labcentr#1;     || Centro
          #labtmpct#27 = #labcentr#2;     || Nombre centro
          |GRABA 020#labtmpct.n;
          |SI swImpLabornet = 0;
               || ojo, que si vengo de la impresion desde Labornet no tengo
               || que hacer esto, ya que pierdo el registro que tenia leido
               |LEE 000#labhisto.s;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE Registro;
     #labregis#1;
     1, 2, 27;
          1, #labimpre#0, #labimpre#1, aDSitu;
     999999, #labimpre#3, #labimpre#4, aHSitu;
     ;
     NULL, Registro;
|FIN;

|DEFBUCLE Registro2;
     #labregis#1;
     1, 2, 29;
          1, #labimpre#0, #labimpre#1, aDSitu;
     999999, #labimpre#3, #labimpre#4, aHSitu;
     ;
     NULL, Registro;
|FIN;

|PROCESO Cabeza;
          |ATRI R;
          |SI aParam = "";
               aCabeza = " EMISION DE CONTRATOS  DESDE HISTORICO ";
               |PINTA 0623, aCabeza;
          |FINSI;
          |SI aParam = "CONTRAT@";
               aCabeza = " CREACION DE FICHEROS XML PARA CONTRAT@ ";
               |PINTA 0623, aCabeza;
          |FINSI;
          |SI aParam = "NETCONTRAT@";
               aCabeza = " ENVIO DE CONTRATOS ONLINE ";
               |PINTA 0520, aCabeza;
          |FINSI;
          |ATRI 0;
|FPRC;

|PROCESO EnlaceCont;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |ABRE #labhisto;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #labcentr;
     |ABRE #nomconca;

     #labtmpc2#0 = enExtRegis;
     #labtmpc2#1 = enExtEmp;
     #labtmpc2#2 = enExtTra;
     #labtmpc2#17 = eaExtProrr;
     #labtmpc2#16 = eaExtDef;

     |HAZ Impresion;
     |HAZ NetContrata;

     |CIERRA #nomconca;
     |CIERRA #labcentr;
     |CIERRA #labtraba;
     |CIERRA #labempre;
     |CIERRA #labhisto;
|FPRC;

|PROCESO PinPan;
     || 0        1         2         3         4         5         6         7         8
     || 12345678901234567890123456789012345678901234567890123456789012345678901234567890
aTit =  "                                                                               ";
     |PINTA 0501, aTit;

|ATRI R;
aTit = " ENVIO DE CONTRATOS ONLINE ";
     |PINTA 0503, aTit;
|ATRI S;
                            aTit =  "- Seleccione y pulse ESC para enviar marcados -";
     |PINTA 0533, aTit;
|ATRI 0;
|FPRC;

|PROCESO labnct06;
     |PRINT;
|FPRC;

|DEFBUCLE labnct06;
     #labnct06#1;
     ;
     #labnct03#15, 00, 01;
     #labnct03#15, 00, 99;
     ;
     NULL, labnct06;
|FIN;

|PROCESO BuscaDatosCont;
     |ABRE #labempre;
     #labempre#0 = #labtmpc2#1;
     |LEE 000#labempre.=;
     |CIERRA #labempre;

     |ABRE #labtraba;
     #labtraba#0 = #labtmpc2#1;
     #labtraba#1 = #labtmpc2#2;
     |LEE 000#labtraba.=;
     |CIERRA #labtraba;

     |ABRE #labnct03;
     #labnct03#0 = #labtraba#0;
     #labnct03#1 = #labtraba#1;
     #labnct03#10 = "C";
     #labnct03#16 = 00;
     |LEE 000#labnct03.=;
     |SI FSalida = 0;
          |SI #labnct03#13 = "0"; |O #labnct03#13 = "1";
               |BUCLE labnct06;
          |SINO;
               |PRINT;
          |FINSI;
     |FINSI;
     |CIERRA #labnct03;
|FPRC;

|PROCESO Marcados;
     |SI swFase = 0;
          nContratos = nContratos + 1;
     |FINSI;
     |SI swFase = 1;
          |HAZ Impresion;
     |FINSI;
     |SI swFase = 2;
          |HAZ BuscaDatosCont;
     |FINSI;
|FPRC;

|DEFBUCLE Marcados;
     #labtmpc2#1;
     14;
     000001, "  ", "*";
     999999, "zz", "*";
     ;
     NULL, Marcados;
|FIN;

|PROCESO Informe;
     Impresora = "CrystalReport";
     |IMPRE -1;
     |INFOR "labimpre";

     swFase = 2;
     |BUCLE Marcados;

     |PIEINF;
     |FININF;
     |FINIMP;
|FPRC;

|PROCESO mincen;
     #labcentr#0 = #0#0;
     #labcentr#1 = 001;
|FPRC;

|PROCESO maxcen;
     #labcentr#0 = #0#3;
     #labcentr#1 = 999;
|FPRC;

|PROCESO ConsultaCentros; |TIPO 66;
     |ABRE #labcentr;
     |CONSULTA_F_CLAVE #1#labcentr, mincen, maxcen;
     |SI FSalida = 0;
          |SI Campo = 12;
               #0#12 = #labcentr#1;
               #0#13 = #labcentr#1;
          |FINSI;
          |SI Campo = 13;
               #0#13 = #labcentr#1;
          |FINSI;
          |PINTA #0#12;
          |PINTA #0#13;
     |FINSI;
     |CIERRA #labcentr;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "ENLACECONT";     || vengo directamente del contrato
          aParam = "NETCONTRAT@";
          |HAZ EnlaceCont;
          |ACABA;
     |FINSI;
     |SI aParam ! ""; |Y aParam ! "CONTRAT@"; |Y aParam ! "NETCONTRAT@";
          ||HAZ LeeParam;
          ||HAZ LeeOrigen;

          || para ver si vengo de la impresion en labornet, me hara falta

          aAlfa = aParam - "IMPLABORNET";
          |SI aAlfa ! aParam;
               aParam = aAlfa;
               swImpLabornet = 1;
          |FINSI;

          |ABRE #labhisto;
          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #labcentr;
          aAlfa = "li" + Usuario; |NOME_DAT #1 aAlfa; |NOME_DAT #4 aAlfa;
          |DELINDEX #labtmpct;
          |ABRE #labtmpct;

          nRegistro = aParam;

          |ABRE #labregis;
          nNume = nRegistro;
          #labregis#0 = nNume;
          |LEE 000#labregis.=;
          |SI FSalida = 0;
               |HAZ Registro;
          |FINSI;
          |CIERRA #labregis;
          swImpreso = 0;
          swImpMasiva = 0;
          |HAZ BuscaContGAD;

          |SI swImpreso = 0;
               |BUCLE Impresion;
          |FINSI;

          |CIERRA #labhisto;
          |CIERRA #labempre;
          |CIERRA #labtraba;
          |CIERRA #labcentr;
          |CIERRA #labtmpct;
          |DELINDEX #labtmpct;
     |SINO;
          |CLS;
          |CABEZA "Historico contratos";
          |PINPA #0#0;
          |PINDA #0#0;

          |HAZ Cabeza;

          |SI aParam = "CONTRAT@"; |O aParam = "NETCONTRAT@";
               |HAZ Portal;

               |ABRE #labcontr;
               |LEE 000#labcontr.p;
               |SI FSalida ! 0; |DDEFECTO #labcontr; |FINSI;
               |CIERRA #labcontr;
               |SI #labcontr#55 = "N";
                    |MENAV "    Opcion para uso de Contrat@ desactivada";
                    |ACABA;
               |FINSI;
               |CUADRO 1622 1860;
               |C_M #labimpre#11, 1, "S"; |C_V #labimpre#11, 1, "S";
               |C_P #labimpre#11, 1, 1751; |PINTA #labimpre#11;
               |PINTA 1724, "Pendientes / Todos (P/T) :";
          |FINSI;
          |ABRE #labcontr;
          |LEE 000#labcontr.p;
          |CIERRA #labcontr;
          /*
          |SI #labcontr#50 = "N";
               |MENAV "    Opcion de historico de contratos desactivada";
               |ACABA;
          |FINSI;
          */
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |ABRE #labhisto;
               |ABRE #labempre;
               |ABRE #labtraba;
               |ABRE #labcentr;
               aAlfa = "li" + Usuario;
               |NOME_DAT #1 aAlfa;
               |NOME_DAT #4 aAlfa;
               |NOME_DAT #102 aAlfa;
               |DELINDEX #labtmpct;
               |ABRE #labtmpct;
               |ABRE #labtmpc1;
               |ABRE #labtmpc2;
               |SI aParam = "CONTRAT@";
                  |SI #labimpre#11 = "P";
                     aDSitu = "P"; aHSitu = "P";
                  |SINO;
                     aDSitu = " "; aHSitu = "z";
                  |FINSI;
                  |BUCLE Registro;
                  |ENTLINEAL #1#labtmpct,-1,4,21,1,infimpre,supimpre;
                  |SI nNumMarcas > 0;
                     aAlfa = #labcontr#44;
                     |QBF aAlfa;
                     Impresora = aAlfa;
                     ||IMPRE 0;
                     |SI FSalida = 0;
                         aAlfa = "tm" + Usuario; |NOME_DAT #2000 aAlfa;
                         |DELINDEX #labtmpdt; |ABRE #labtmpdt; nLinea = 1;
                         |ABRE #labvaltb;
                         nSwError = 0; |HAZ Comprobacion;
                         |PARA; |SI nSwError = 1; |HACIENDO;
                            |PUSHV 0501 2380;
                            |ENTLINEAL #1#labtmpdt, -1, 4, 18, 1, inf, sup;
                            |POPV;
                            |CIERRA #labtmpdt; |DELINDEX #labtmpdt; |ABRE #labtmpdt;
                            nSwError = 0; |HAZ Comprobacion;
                            |SI nSwError ! 0;
                               |CONFI "    NAun hay datos erroneos. Volver a editar ?";
                               |SI FSalida ! 0;
                                  nSwError = 1; |SAL;
                               |FINSI;
                            |FINSI;
                         |SIGUE;

                         |CIERRA #labvaltb;
                         |CIERRA #labtmpdt; |DELINDEX #labtmpdt;
                         |SI nSwError = 0;
                            |BUCLE Impresion;
                            |HAZ GeneraXML;
                         |FINSI;
                     |SINO;
                         aAlfa = "0000Impresora [" + Impresora + "] inaccesible o inexistente.";
                         |MENAV aAlfa;
                     |FINSI;
                     ||FINIMP;
                  |FINSI;
               |SINO;
                  |SI aParam = "NETCONTRAT@";
                         |SI #labimpre#11 = "P";
                              aDSitu = " "; aHSitu = "1";
                         |SINO;
                              aDSitu = " "; aHSitu = "2";
                         |FINSI;

                         |BUCLE Registro2;
                         |HAZ PinPan;


                         |PARA; |SI; |HACIENDO;
                              |ENTLINEAL #1#labtmpc2, -1, 4, 22, 1, infimpre2, supimpre2;

                              swNetContrata = 1;
                              swNetContrataMas = 1;

                              nContratos = 0;
                              swFase = 0;
                              |BUCLE Marcados;

                              |ENTLINEAL #1#labtmpc2, -1, 7, 22, 1, infimpre2, supimpre2;
                              |SI nContratos ! 0;
                                   |MENU aMenuMas;
                              |SINO;
                                   |MENU aMenuNoMas;
                              |FINSI;
                              nOpcion = FSalida;

                              |SI nContratos ! 0;
                                   |SI nOpcion = 1;
                                        swFase = 1;
                                        |BUCLE Marcados;
                                        |ENTLINEAL #1#labtmpc2, -1, 7, 22, 1, infimpre2, supimpre2;
                                        |HAZ NetContrataMas;
                                        |SI swRespuesta = 1;
                                             |HAZ Informe;
                                        |FINSI;
                                        |SAL;
                                   |FINSI;
                                   |SI nOpcion = 2;
                                        || vuelta al lineal
                                   |FINSI;
                                   |SI nOpcion = 3;
                                        |SAL;
                                   |FINSI;
                              |SINO;
                                   |SI nOpcion = 1;
                                        || vuelta al lineal
                                   |FINSI;
                                   |SI nOpcion = 2;
                                        |SAL;
                                   |FINSI;
                              |FINSI;
                         |SIGUE;
                    |SINO;
                         |HAZ BuscaModulo;
                         |CAMPO_VISUAL #labtmpc1#14, 1, "S";
                         aDSitu = " "; aHSitu = "z";
                         |BUCLE Registro;
                         |PARA; |SI FSalida ! 1; |HACIENDO;
                              |ENTLINEAL #1#labtmpc1,-1,4,21,1,infimpre1,supimpre1;
                              |SI FTecla = 1;
                                   |SI nNumMarcas > 0;
                                        aAlfa = "    S¿Desea salir del lineal de selección de contratos?";
                                        |CONFI aAlfa;
                                        |SI FSalida = 0;
                                             |SAL;
                                        |FINSI;
                                   |SINO;
                                        |SAL;
                                   |FINSI;
                              |FINSI;
                         |SIGUE;
                    |FINSI;
               |FINSI;
               |CIERRA #labcentr;
               |CIERRA #labhisto; |CIERRA #labempre; |CIERRA #labtraba;
               |CIERRA #labtmpc1; |CIERRA #labtmpct;
               |CIERRA #labtmpc2;
               |DELINDEX #labtmpct;
               |DELINDEX #labtmpc2;
          |FINSI;
     |FINSI;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRO;

_________________________________________ DESDE WEB
|VARIABLES;
     aRutaDes = "";
     aRutaDatos = "";
     aDirOri = "";
     nCanal = 0;
     aCabecera = "";
     aWRegistro = "";
     aDireccion = "";
|FIN;

|PROCESO LeeParam;
     |DBASS aRutaDes;
     |DBASS aRutaDatos;
     |QBF aRutaDes;
     |QBF aRutaDatos;
     aRutaDes = aRutaDes + "dsnetcom/def/dsnetm00.mas";
     |CARGA_DEF aRutaDes, dsnetm00@;
     |SI FSalida ! 0;
          |MENAV "    Error en CARGADEF: dsnetm00";
     |SINO;
          aRutaDatos = aRutaDatos + "dsnetcom/fich/";
          |PATH_DAT #150 aRutaDatos;
          |ABRE #150;
          |LEE 000#150p;
          |SI FSalida = 0;
               eaWebDirDes = #150#7;    |QBF eaWebDirDes;
               aDirOri = eaWebDirDes;
          |SINO;
               |MENAV "    Error de datos en fichero de configuracion dsnetm00";
          |FINSI;
          |CIERRA #150;
     |FINSI;
     |DESCARGA_DEF #dsnetm00@;
|FPRC;

|PROCESO LeeOrigen;

     eaWebArchivo = PARAMETRO;
     |QBF aDirOri;
     aRuta = aDirOri + eaWebArchivo;

     |XABRE "U", aRuta, nCanal;
     |SI FSalida ] 0;
          |XLEE nCanal, 100, aCabecera;
          |XLEE nCanal, 10, aWRegistro;
          |XLEE nCanal, 100, aDireccion;
     |FINSI;
     |XCIERRA nCanal;
     |QBF aCabecera;
     |QBF aWRegistro;
     |QBF aDireccion;

     enWeb = aWRegistro;
     eaWebDirPDF = aDireccion + "/pdf/";
|FPRC;

|PROCESO Contratos;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/co" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Contratos;
#labenvcl#1;
11;
#labenvcc#0, #labenvcc#6, 001, "C";
#labenvcc#0, #labenvcc#6, 999, "C";
;
NULL,Contratos;
|FIN;

|PROCESO Prorrogas;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/pr" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Prorrogas;
#labenvcl#1;
11;
#labenvcc#0, #labenvcc#6, 001, "P";
#labenvcc#0, #labenvcc#6, 999, "P";
;
NULL,Prorrogas;
|FIN;

|PROCESO Transformaciones;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/tr" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Transformaciones;
#labenvcl#1;
11;
#labenvcc#0, #labenvcc#6, 001, "T";
#labenvcc#0, #labenvcc#6, 999, "T";
;
NULL,Transformaciones;
|FIN;

|PROCESO CopiasBasicas;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/cb" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE CopiasBasicas;
#labenvcl#1;
;
#labenvcc#0, #labenvcc#6, 001;
#labenvcc#0, #labenvcc#6, 999;
;
NULL,CopiasBasicas;
|FIN;

|PROCESO GeneraXML;
   nSwCont = 0;
   nSwTrns = 0;
   nSwPror = 0;
   nSwCPBs = 0;

   |ABRE #labenvcc; |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "C";
         nSwCont = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         |RMKDIR aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "co" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         ||XABRE "BW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<CONTRATOS>" + &13 + &10;                                                                             |XGRABA nHandle, aAlfa;
            |BUCLE Contratos;
            aAlfa = "</CONTRATOS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "P";
         nSwPror = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "pr" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<PRORROGAS>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE Prorrogas;
            aAlfa = "</PRORROGAS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "O";
         nSwCPBs = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "cb" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         ||XABRE "BW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<COPIASBASICAS>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE CopiasBasicas;
            aAlfa = "</COPIASBASICAS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "T";
         nSwTrns = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "tr" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<TRANSFORMACIONES>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE Transformaciones;
            aAlfa = "</TRANSFORMACIONES>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #1#labenvcc;
   |CIERRA #labenvcc;

   |SI nSwCont ! 0; |O nSwPror ! 0; |O nSwCPBs ! 0; |O nSwTrns ! 0;
      aAlfa1 = "    Ficheros generados correctamente en el directorio '";
      aAlfa = #labcontr#51;
      aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
      aAlfa = aAlfa1 + aAlfa + "'";
      |MENAV aAlfa;
   |FINSI;
|FPRC;

|RUTINA inf;
   #labtmpdt#0 = 0000001;
|FRUT;

|RUTINA sup;
   #labtmpdt#0 = 9999999;
|FRUT;

|PROCESO Comprueba;
   nSwError = 0;
   aClv1 = #labtraba#0; aClv2 = #labtraba#1;

   aCodPos = (("00" + #labtraba#8) % -102) + (("000" + #labtraba#9) % -103);
   || aFich = "labtraba"; nCampo = 6;  |HAZ CompruebaMunic;

   || aFich = "labtraba"; nCampo = 12; aTabla = "stiacatc"; nCmp = 1; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 12; aTabla = "thitiaca"; nCmp = 1; |HAZ CompruebaValor;
   || aFich = "labtraba"; nCampo = 19; aTabla = "socupatc"; nCmp = 1; |HAZ CompruebaValor;
   || los quito ... esto hay que eliminarlo y sustituirlo por otra cosa
   || si procede
   || aFich = "labtraba"; nCampo = 19; aTabla = "taiclaoc"; nCmp = 0; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 33; aTabla = "tfggrcot"; nCmp = 0; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 73; aTabla = "tbonvfor"; nCmp = 0; |HAZ CompruebaValor;
   aAlfa = #labtraba#7; |QBF aAlfa; aAlfa = aAlfa % 0101;
   |SI aAlfa < "0"; |O aAlfa > "9";
      aFich = "labtraba"; nCampo = 76; aTabla = "spaisxtc"; nCmp = 1; |HAZ CompruebaValor;
   |FINSI;

   aClv1 = #labempre#0; aClv2 = "";
   ||aFich = "labempre"; nCampo = 12; aTabla = "sacecotc"; nCmp = 1; |HAZ CompruebaValor;

   aClv1 = #labtraba#0; aClv2 = #labtraba#1;
   aFich = "labpadre"; nCampo = 5; aTabla = "ssexoxtc"; nCmp = 0; |HAZ CompruebaValor;
|FPRC;

|PROCESO CompruebaMunic;
   nTecla = FSalida;

   |ABRE #labmunic; |DDEFECTO #labmunic;

   #labmunic#4 = aCodPos;
   |LEE 000#labmunic.];
   |SI FSalida = 0; |Y #labmunic#4 = aCodPos;
      |SALVA_FICHA #labmunic;
      |LEE 000#labmunic.s;
      |SI FSalida = 0; |Y #labmunic#4 = aCodPos;
         nSwUno = 0;
      |SINO;
         nSwUno = 1;
      |FINSI;
      |REPON_FICHA #labmunic;
      |SI nSwUno = 0;
         #labmunic#4 = aCodPos;
         |LEE 000#labmunic.];
         |PARA; |SI FSalida = 0; |Y #labmunic#4 = aCodPos; |HACIENDO;
            aAlfa1 = #labmunic#3; |QBF aAlfa1; aLong = aAlfa1 % 0; nCalc1 = aLong;
            aAlfa2 = #labtraba#6; |QBF aAlfa2; aLong = aAlfa2 % 0; nCalc2 = aLong;
            |SI nCalc1 ] nCalc2;
               nCalc = 100 + nCalc2; aAlfa = aAlfa % nCalc;
            |SINO;
               nCalc = 100 + nCalc1; aAlfa1 = aAlfa1 % nCalc;
            |FINSI;
            |SI aAlfa1 = aAlfa2; |SAL; |FINSI;
            |LEE 000#labmunic.s;
         |SIGUE;
         |SI aAlfa1 ! aAlfa2;
            aCodPos = (("00" + #labtraba#8) % -102) + (("000" + #labtraba#9) % -103);
            |SUB_EJECUTA "labmunic.tab";
            |PULSATECLA;
            |PULSATECLA;
            |PULSATECLA;
            |PULSATECLA;
            |PULSATECLA;

            #labmunic#1 = aCodigoMunicipio;
            #labmunic#4 = aCodPos;
            |LEE 000#labmunic.=;
            |SI FSalida ! 0; |DDEFECTO #labmunic; |FINSI;
            #labtraba#6 = #labmunic#3; |PINTA #labtraba#6;
         |FINSI;
      |FINSI;
      |SI nSwUno = 1;
         #labtraba#6 = #labmunic#3; |PINTA #labtraba#6;
      |FINSI;
   |SINO;
      nSwError = 1; |ACABA;
      ||MENAV "    No se encuentra el codigo postal en la tabla de municipios"; |ERROR;
   |FINSI;
   |CIERRA #labmunic;
|FPRC;

|PROCESO CompruebaValor;
   |DDEFECTO #labvaltb;
   #labvaltb#0 = aFich;
   #labvaltb#1 = nCampo;
   #labvaltb#5 = aClv1;
   #labvaltb#6 = aClv2;
   |LEE 000#labvaltb.=;
   |SI FSalida = 0;
      aValor = #labvaltb#4; |QBF aValor;
      |SI aFich = "labempre";
         aAlfa = #labempre#nCampo#; |QBF aAlfa;
      |FINSI;
      |SI aFich = "labtraba";
         aAlfa = #labtraba#nCampo#; |QBF aAlfa;

         |SI aFich = "labtraba"; |Y nCampo = 76;
            aAlfa1 = aAlfa % 0101;
            |SI aAlfa ] "0"; |Y aAlfa [ "9"; aAlfa = aAlfa % 0599; |FINSI;

            aLon = aValor % 0;
            nLon = aLon;
            |SI nLon ] 27;    || tama¤o maximo del campo del labtraba sin cod. pais
                 aAlfa = aValor;
            |FINSI;

            aValor = aAlfa;
         |FINSI;
      |FINSI;
   |SINO;
      |DBASE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "def/" + aFich + ".mas";
      |CARGA_DEF aAlfa, Referen@;
      |SI FSalida = 0;
         |ABRE #Referen@;
         nClave = 1;
         aAlfa = "|K000"; aAlfa = #Referen@#aAlfa#; aAlfa = aAlfa % 0499;
         |PARA; |SI aAlfa ! ""; |HACIENDO;
            |SI nClave = 1; aClv = aClv1; |FINSI;
            |SI nClave = 2; aClv = aClv2; |FINSI;
            aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
            #Referen@#nCalc# = aClv;
            nClave = nClave + 1;
         |SIGUE;
         |LEE 000#Referen@.=;
         |SI FSalida = 0;
            aValor = #Referen@#nCampo#; |QBF aValor;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "TIPO";     aTipoDat = #Referen@#aAlfa#;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "LONGITUD"; nLongDat = #Referen@#aAlfa#;
            |SI aTipoDat = "N";
               aAlfa = "0" * nLongDat; aAlfa = aAlfa + aValor;
               nLongDat = -(nLongDat + 100); aValor = aAlfa % nLongDat;
            |FINSI;
         |SINO;
            |SI aTabla = "ssexoxtc";
               |DDEFECTO #Referen@;
               nClave = 1;
               aAlfa = "|K000"; aAlfa = #Referen@#aAlfa#; aAlfa = aAlfa % 0499;
               |PARA; |SI aAlfa ! ""; |HACIENDO;
                  |SI nClave = 1; aClv = aClv1; |FINSI;
                  |SI nClave = 2; aClv = aClv2; |FINSI;
                  aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
                  #Referen@#nCalc# = aClv;
                  nClave = nClave + 1;
               |SIGUE;
               |GRABA 020#Referen@.n;
            |SINO;
               |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
               nSwError = 1; |ACABA;
            |FINSI;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |FINSI;
   ||SINO;
   ||   nSwError = 1; |ACABA;
   |FINSI;

   nSwNuevo = 0;
/*
   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "def/" + aTabla + ".mas";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida < 0;
      aAlfa1 = aTabla;
      aAlfa = "SELECT * FROM labcotmp INTO " + aAlfa1 + ".def WHERE"; |SQL aAlfa;
      nSwNuevo = 1;
   |SINO;
      nSwNuevo = 0;
   |FINSI;
*/
   aAlfa1 = aTabla; |QBF aAlfa1; aAlfa1 = aAlfa1 - ".txt";
   |DBASE aAlfa; aAlfa = aAlfa + "def/" + aAlfa1 + ".mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |ABRE #Referen@;
      |LEE 000#Referen@.p;
      |SI FSalida ! 0; nSwLectura = 1; |FINSI;
      |SI nSwNuevo = 1; |O nSwLectura = 1; |DELINDEX #Referen@; |FINSI;
      |ABRE #Referen@;
      |SI nSwLectura = 1;
         aLF = &13; aComillas = &34; aCR = &10;
         |DBASE aAlfa; aAlfa = aAlfa + "tablas/" + aTabla + ".txt";
         aAlfa = "rb  " + aAlfa;
         |FABRE aAlfa;
         |SI FSalida ] 0;
            nHandle = FSalida;
            |MENSA "    Rellenando tabla .....";
            nCampo1 = 0; nAbierto = 0; nPosic = 0;
            |DDEFECTO #Referen@;
            aAlfa = nHandle + " 250"; |FLEE aAlfa;
            |PARA; |SI FSalida > 0; |HACIENDO;
               aAlfa1 = aAlfa - aLF;
               |PARA; |SI FSalida ! 0; |HACIENDO;
                  nCalc = ((FSalida / 100) ! 0) - 1; nPosic = nPosic + nCalc;
                  |SI nCalc > 99;
                     nCalc1 = 199; aAlfa1 = aAlfa % nCalc1; aAlfa = aAlfa - aAlfa1;
                     nCalc = nCalc - 99;
                  |SINO;
                     aAlfa1 = "";
                  |FINSI;
                  nCalc = nCalc + 100; aAlfa2 = (aAlfa % nCalc);
                  aAlfa1 = aAlfa1 + aAlfa2; aAlfa = aAlfa - aAlfa2;
                  aAlfa2 = aLF + aCR;     aAlfa = aAlfa - aAlfa2; nPosic = nPosic + 2;
                  nCampo1 = 0;
                  aAlfa2 = aAlfa1 - ";";
                  |PARA; |SI FSalida ! 0; |HACIENDO;
                     nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2 = aAlfa1 % nCalc;
                     aLong = aAlfa1 % 0; nLong = aLong;
                     |SI nLong > 99;
                        nCalc1 = ((((FSalida / 100) ! 0) + 1) * 100) + 99; aAlfa3 = aAlfa1 % nCalc1;
                        aAlfa1 = aAlfa1 - aAlfa3;                    aAlfa1 = aAlfa1 % nCalc1;
                        aAlfa1 = aAlfa3 + aAlfa1;
                     |SINO;
                        nCalc = FSalida + 198;                       aAlfa1 = aAlfa1 % nCalc;
                     |FINSI;
                     aAlfa2 = aAlfa2 - aComillas;
                     |PARA; |SI FSalida ! 0; |HACIENDO;
                        aAlfa2 = aAlfa2 - aComillas;
                     |SIGUE;
                     |SI nCampo = 2; |O nCampo = 3;
                        aAlfa2 = (aAlfa2 % 0702) + "." + (aAlfa2 % 0502) + "." (aAlfa2 % 0104);
                     |FINSI;
                     #Referen@#nCampo1# = aAlfa2;
                     nCampo1 = nCampo1 + 1;
                     aAlfa2 = aAlfa1 - ";";
                  |SIGUE;
                  aAlfa1 = aAlfa1 - aComillas;
                  |PARA; |SI FSalida ! 0; |HACIENDO;
                     aAlfa1 = aAlfa1 - aComillas;
                  |SIGUE;
                  |SI nCampo = 2; |O nCampo = 3;
                     aAlfa1 = (aAlfa1 % 0702) + "." + (aAlfa1 % 0502) + "." (aAlfa1 % 0104);
                  |FINSI;
                  aCadena = aAlfa1; |HAZ QuitaRaros; aAlfa1 = aCadena;
                  #Referen@#nCampo1# = aAlfa1;
                  #Referen@#4 = aTabla;
                  |GRABA 020#Referen@.n; |DDEFECTO #Referen@;
                  aAlfa1 = aAlfa - aLF;
                  |SI aAlfa1 = ""; FSalida = 0; |FINSI;
               |SIGUE;
               Pos = nPosic;
               aAlfa = nHandle + " 250"; |FLEE aAlfa;
            |SIGUE;
            |BLIN 4;
         |FINSI;
         FSalida = nHandle; |FCIERRA FSalida;
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;

   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "def/" + aTabla + ".mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |ABRE #Referen@;
      |SI nCmp = 0; |SELECT #1#Referen@; |FINSI;
      |SI nCmp = 1; |SELECT #2#Referen@; |FINSI;
      #Referen@#nCmp# = aValor;
      |LEE 000#Referen@.=;
      |SI FSalida ! 0;
         |DBASE aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "def/" + aFich + ".mas";
         |CARGA_DEF aAlfa, Refere1@;
         |SI FSalida = 0;
            |ABRE #Refere1@; nClave = 1; aRegistro = "";
            aAlfa = "|TITULO"; aTitulo = #Refere1@#aAlfa#;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "NOMBRE";
            aNombre = #Refere1@#aAlfa#;
            aAlfa = "|K000"; aAlfa = #Refere1@#aAlfa#; aAlfa = aAlfa % 0499;
            |PARA; |SI aAlfa ! ""; |HACIENDO;
               |SI nClave = 1; aClv = aClv1; |FINSI;
               |SI nClave = 2; aClv = aClv2; |FINSI;
               aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
               #Refere1@#nCalc# = aClv;
               nClave = nClave + 1;
            |SIGUE;
            |LEE 000#Refere1@.=;
            |SI FSalida = 0;
               aRegistro = #Refere1@#2;
               aAlfa1 = aClv1; |QBF aAlfa1;
               |SI aAlfa1 ! "";
                  aAlfa = "[" + aAlfa1;
                  aAlfa1 = aClv2; |QBF aAlfa1;
                  |SI aAlfa1 ! "";
                     aAlfa = aAlfa + "/" + aAlfa1 + "] ";
                  |SINO;
                     aAlfa = aAlfa + "] ";
                  |FINSI;
               |SINO;
                  aAlfa1 = aClv2; |QBF aAlfa1;
                  |SI aAlfa1 ! ""; aAlfa = "[" + aAlfa1 + "] "; |FINSI;
               |FINSI;
               aRegistro = aAlfa + aRegistro;
            |FINSI;
            |CIERRA #Refere1@; |DESCARGA_DEF #Refere1@;
         |FINSI;

         |DDEFECTO #labtmpdt;
         |SELECT #2#labtmpdt;
         #labtmpdt#1 = aFich;
         #labtmpdt#2 = nCampo;
         #labtmpdt#3 = aClv1;
         #labtmpdt#4 = aClv2;
         |LEE 000#labtmpdt.=;
         nSalida = FSalida;
         |SELECT #1#labtmpdt;
         |SI nSalida ! 0;
            |DDEFECTO #labtmpdt;
            #labtmpdt#0 = nLinea; nLinea = nLinea + 1;
            #labtmpdt#1 = aFich;
            #labtmpdt#2 = nCampo;
            #labtmpdt#3 = aClv1;
            #labtmpdt#4 = aClv2;
            #labtmpdt#5 = aValor;
            #labtmpdt#6 = aTitulo;
            #labtmpdt#7 = aNombre;
            #labtmpdt#8 = aRegistro;
            |GRABA 020#labtmpdt.n;
            nSwError = 1;
         |FINSI;
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |SINO;
      nSwError = 1; |ACABA;
   |FINSI;
|FPRC;

|PROCESO Ayuda001; |TIPO 7;
     |SI aParam = "";
         aAlfa = #labtmpc1#16;
     |FINSI;

     |SI aParam = "NETCONTRAT@";
         aAlfa = #labtmpc2#16;
     |FINSI;

     |SI aParam = "NETCONTRAT@";
         aAlfa = #labtmpct#16;
     |FINSI;

     |SI aAlfa ! "labconb7";
         aAlfa = "";
     |FINSI;


     |SI aParam = "NETCONTRAT@";
          |SI swPortal = 0;
               |MENSA "    <F3> Envío del contrato online a través de ConectaSS <F6> Mostrar Errores";
          |SINO;
               |MENSA "    <F3> Envío indiv. <F4> Marcar para envío masivo <F5> Todos <F6> Errores";
          |FINSI;
          |ACABA;
     |FINSI;

     |SI aParam = "CONTRAT@";
         |SI aAlfa = "";
             |MENSA "    Pulse <F2> para marcar/desmarcar el registro para su envio";
         |SINO;
             |MENSA "    Pulse <F2> para marcar/desmarcar el registro para su envio, <F10> Modificar";
         |FINSI;
         |ACABA;
     |FINSI;

     |SI aAlfa = "";
          ||     "    1234567890123456789012345678901234567890123456789012345678901234567890123456"
          |MENSA "    <Intro> Imprimir contrato/s; <F5> Seleccionar contrato; <F6> Todos/Ninguno  ";
          || TODOS 01.06.2017
          /*
          |SI swModulo = 2884; |O swModulo = 1;
               |MENSA "    <Intro> Imprimir contrato/s; <F5> Seleccionar varios";
          |SINO;
               |MENSA "    <Intro> Imprimir contrato";
          |FINSI;
          */
     |SINO;
          ||     "    1234567890123456789012345678901234567890123456789012345678901234567890123456"
          |MENSA "    <Intro> Emitir; <F5> Seleccionar; <F6> Todos/Ninguno; <F10> Modificar";
          || TODOS 01.06.2017
          /*
          |SI swModulo = 2884; |O swModulo = 1;
               |MENSA "    <Intro> Imprimir contrato/s; <F5> Seleccionar varios; <F10> Modificar";
          |SINO;
               |MENSA "    <Intro> Imprimir contrato; <F10> Modificar";
          |FINSI;
          */
     |FINSI;
|FPRC;
