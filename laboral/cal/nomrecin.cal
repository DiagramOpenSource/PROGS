|FICHEROS;
     nomrecib #0;  || def de impresion
     nomcalcu #40;  || parrilla de codigos
     nomcalat #41;  || parrilla de codigos atrasos
     labempre #1;  || empresas
     labtraba #2;  || trabajadores
     nomconst #3;  || constantes                 **********************
     nomcalca #4;  || calculo cabeceras          * OJO QUE ESTO  ESTA *
     nomcalli #5;  || calculo lineas             * CERCANO A LAS OCHO *
     labcentr #6;  || centros de trabajo         *    MIL LINEAS:     *
     nomtrnom #10;  || def nomina                 *                    *
     nomcenes #35;  || centros 18/93              *  ­­­ CUIDADO !!!   *
     nomcontr #36;  || control                    **********************
     nomdesam #100; || descrip. ampliadas
     nomtraca #101; || trabajadores cabs.
     nomconca #102; || convenios cabs.
     nomvarca #103; || variaciones empresa mes
     nomhicca #11;  || historico
     nomhicli #12;
     nomcalac #13;  || atrasos
     nomcalal #14;
     nomtrabi #15;  || def nomina abierta
     nomtmpca #93;
     nomtmpli #94;
     nomtmphc #95;
     nomtmphl #96;
     nomvart3 #99;
     nomimpra;      || Registro tipos IRPF en Paga Extra Dic Cabs.
     nomimpre;      || Registro tipos IRPF en Paga Extra Dic Lins.

     nomgruec;
     nomgruel;
     nompagfe;      || fecha recibi paga extra por convenio
     nombanco;

     labtraba;
     pdfimtmp #200;
     pdfdocca;
     pdfdocli;
     :/basica/def/agidanif #8;
     &bancosc@  #709;
     nomgirco;
     nomcont1;
     nomcont3;
     motibaja;
|FIN;

|VARIABLES;
     &enGrupoTres = 0; &enSubGTres = 0; &enTipoTres = 0;
     &enSwMeteGrupoSubTipo = 0; &enSwDesde9 = 0;

     aMensaje = ""; nVar = 0;  aLong = ""; nLong = 0; aMod = ""; nPara = 0;
     nAlfa = 0; &enCodBanco = 0;  nDec = 0; alfacampo = ""; aVar = "";
     &nEmpresa = 0;
     &nTrabajador = 0;
     &nMes = 0;
     &nTipo = 0;
     d_para1 = 0;
     d_conc = 0;
     d_paga = 0;
     d_diasp = 0;
     d_porcp = 0;
     d_tipos = 0;
     d_campo = 0;
     concep1 = 0;
     concep2 = 0;
     desc = 0;
     hasc = 0;
     actc = 0;
     concepto = 0;
     duni1_999 = 0; duni2_999 = 0; dvalo_999 = 0;
     duni2_200 = 0; dvalo_200 = 0; dprod_200 = 0;
     dreal_200 = 0;
     product = 0;
     divide = 0;
     dia_2 = 0;
     dia_4 = 0;
     sd_bucle = 0;
     d_tipo_p = 0;
     d_entrada = 0;
     dcociente = 0;
     dnume1 = 0;
     dnume2 = 0;
     dbisiesto = 0;
     dalfa1 = "";
     dtopemes = 0;

     desglo="";
     dsalte_1 = 0;
     dsalte_2 = 0;
     nDesdeFuera=0;
     informe="";
     &poblafir = "";
     &causa = "";
     &importe = 0;
     &unidade = 0;
     &elvalor = 0;
     &liquido = "";
     &nLiquido = 0;

     &uniant=0;
     camctos = 0; camunia = 0; camunid = 0; camvalo = 0;
     &infunia = 0; &infctos = 0; &infptas = 0; &infdesc = "";
     &infvalo = 0; &infunid = 0;

     alguno = 0;
     linea16 = 0;
     &ninguno = 0;
     situac2 = 0;
     i=0;
     mes_i = 0;
     &afili = "";
     alfa1 = ""; alfa2 = ""; alfa3 = ""; alfa4 = "";
     anyo = 0;
     anyrec = 0;
     anytra = 0;
     anypaga = 0;
     apordfp = 0;
     apord = 0;
     aporfp = 0;
     aporhe1 = 0;
     aporhe2 = 0;
     arteris = "";
     bisiesto = 0;
     &camdesc = 0;
     campo = 0;
     camptas = 0;
     coment = 0;
     &concep = 0;
     dcal_101 = "";
     deducir = 0;
     desacc = 0;
     &descri = "";
     desdia = 0;
     desenf = 0;
     diaalta = 0;
     diabaja = 0;
     diarec = 0;
     diatra = 0;
     &domemp = "";
     duni_101 = 0;
     dval_101 = 0;
     duni_102 = 0;
     fecsys = @;
     fectra = "";
     hasacc = 0;
     hasdia = 0;
     hasenf = 0;
     &import = 0;
     &incluye = 0;
     lineas = 0;
     &mesalf = "";
     mesalta = 0;
     mesbaja = 0;
     mesliq = "";
     &mesnum = 0;
     mesrec = "";
     mestra = 0;
     nume1 = 0; nume2 = 0; nume3 = 0; nume4 = 0; numer = 0;
     nro_copias = 0;
     p_mes = "";
     pantalla = 0;
     &pobemp = "";
     &seleccio = 0;
     situac = 0;
     sw_comen = 0;
     &swbaja = 0;
     &swbaja_real = 0;
     swtacc = 0;
     swtenf = 0;
     tantici = 0;
     taporta = 0;
     tbcotiz = 0;
     tcotiz = 0;
     &topemes = 0;
     tot_109 = 0; tot_110 = 0; tot_111 = 0; tot_112 = 0;
     tot_113 = 0; tot_114 = 0; tot_115 = 0; &unidad = 0;
     &valor = 0;
     deci_h = 0;
     sw_control = 0;
     CodigoCons = 0;
     cta_co = "";
     salte_1 = 0;
     salte_2 = 0;

     &acum = 1;
     &runnom = "nomyreci";
     guarda_emp = 0;
     guarda_cen = 0;
     guarda_are = "";
     guarda_sec = "";
     el_66 = 0; el_67 = 0; el_68 = 0; el_69 = 0; el_70 = 0; el_71 = 0;
     el_72 = 0; el_73 = 0; el_74 = 0; el_75 = 0; el_76 = 0; el_77 = 0;
     sw_equiv = 0;
     ante_emp = 0;
     ante_tra = 0;
     el_a00 = 0;
     el_a31 = 0;
     el_a32 = 0;
     el_a33 = 0;
     el_a34 = 0;
     el_a35 = 0;
     mesliq1 = "";
     mesliq2 = "";
     &EURODB = 0;
     &swDesdeWeb = 0;
     duni_hest = 0;
     duni_hnoest = 0;
     swPrimerMes = 0;
     nDesdeEmp = 0;
     nHastaEmp = 0;
     nDesdeTra = 0;
     nHastaTra = 0;
     swPorGrupos = 0;
     nGrupo = 0;
     nCampoG = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nCampo = 0;
     nPaga = 0;
     nNume = 0;

     &aCError = "";
     &fCFecha = @;
     &nCConst = 0;
     &enCanti = 0;
     &eaMoneda = "";
     &aMonedaRec = "";

     nAscii = 0;
     aCaracter = "";
     aCaracterSal = "";
     aCadena = "";
     aCadenaSal = "";
     nPos = 0;
     nBusca = 0;
     &aValor = "";
     aCampo = "";
     &swCopia = 0;
     &aID = "";
     &enWeb = 0;
     &eaWebDirPDF = "";
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     aTipoEmiAt = "";
     nSwNumer = 0;
     &aListaFich = "";
     &swPDFMasivo = 0;
     aLongitud = "";
     nLongitud = 0;
     &aArchivo = "";
     &nContador = 0; &nContadorImp = 0;
     &nContador2 = 0;
     &aContador = "";
     &aParam = "";
     &aParam1 = "";
     &aParam2 = "";
     &aProcedencia = "";
     para1 = 0;
     para2 = 0;
     &nNroCopias = 0;
     nNume1 = 0;
     nNume2 = 0;
     &nEdad = 0;
     &fFecha = @;
     &nDesc3 = 0;
     &nDesc25 = 0;
     &nAscen = 0;
     &swComercio = 0;
     &nEnfer = 0;
     &nAccid = 0;
     para3 = 0;
     nAny = 0;
     &nConcepto = 0;
     &FEstado = 0;
     &swModulo = 0;
     swCarga = 0;
     swHaEntrado = 0;
     swAgrupa = 0;
     aAgrupa = "";
     aNormal = "";
     situac_ult = 0;
     nPos1 = 0;
     aAlfa3 = "";
     situcon = 0;
     &aOrden = "";
     &tipoit = "";
     &nEmbargo = 0;
     nPropDesTP = 0;
     nDiasDesTP = 0;
     nDias = 0;
     &retoded = "";
     &nEmp = 0;
     &nTra = 0;
     &nTraNoEmi = 0;
     &swStopIRPF = 0;
     &swHayIncid = 0;
     &nArchi = 0;
 {-1}aMenu  = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "Archivo documental activado. Elija opci¢n: ";
     aMenu4 = "IAB";
     aMenu5 = "Imprimir";
     aMenu6 = "Archivar";
     aMenu7 = "Ambos";
     &nOpcion = 0;
     &swEmailDirecto = 0;     || de momento para el modulo de Salus Baleares
     &swImpDirecto = 0;     || de momento para el modulo de Salus Baleares
     &aImpresora = "";
     &swPasada = 0;
     &swErrorDSArchi = 0;
     &nEmision = 0;
     &swNoArchives = 0;
     &nCuadre = 0;
     &nEmpresaLogo = 0;
     &enTipoAt = 0;
     &swParamEmpresa = 0;
     &aTipoIT = "";
     &nDiasIT = 0;
     nContrato = 0;
     &enSwSimulacion = 0;
     &eaFichSimBox = "";
     &rlecan = 0;
     &rlsali = "";
     {1}aContiene = "";
     aDestino = "";
     aOrigen = "";
     aIP = "";
     &aMotivoBaja = "";
|FIN;

|INCLUYE i_cuadr;
|INCLUYE i_pdfrec;
|INCLUYE i_nomre2;
|INCLUYE i_nomcr;

||****************************************************************************
||******* LIBRERIAS **********************************************************
||****************************************************************************

|PROCESO ElFININF;
     |SI nOpcion = 0; |O nOpcion = 1;   || no tengo DSArchi o he pedido impresion
          |SI swDesdeWeb = 0; |Y aParam1 ! "PDF"; |Y Impresora ! "CrystalReport";
               |FININF;
          |FINSI;
     |SINO;
          |FININF;
          |SI swErrorDSArchi = 0;
               |HAZ Mensaje;
               |HAZ Archivando;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CuadreImpre;
          |SI Impresora = "CrystalReport"; |O nOpcion = 2;
               |HAZ Literales;
               |HAZ BuscaCrystal;
               |SI #0#68 ! "F";
                  |HAZ cuadre_emp;
                  |SI #0#69 ! "A";
                       |INFOR "nomycrys";
                  |SINO;
                       |INFOR "nomyabie";
                  |FINSI;
              |SINO;
                  |SI #0#13 = "F";
                      |INFOR "nomccalf";
                  |SINO;
                      |HAZ cuadre_emp;
                      |INFOR "nomycrys";
                  |FINSI;
              |FINSI;
              |SI #nomcontr#60 = "S"; |HAZ IniciaRegistro; |FINSI;
          |FINSI;
|FPRC;

|PROCESO Borra_dbf;
     || por si acaso

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aDestino = aContiene1; |QBF aDestino;
     aDestino = aDestino + "crystal/" + "tm" + Usuario + ".pdf";

     |RFBORRA aDestino;
|FPRC;

|PROCESO ElIMPRE;
     |SI nArchi = 1;
          FEstado = 0;
          |SI swEmailDirecto = 0;       || = 1 VA DIRECTO POR EMAIL SIN PREGUNTAR
               |SI swImpDirecto = 0;    || = 1 VA DIRECTO POR IMPRE. SIN PREGUNTAR
                    |SI swPasada = 0;
                         |SI #0#67 = "T";
                              aMenu4 = "IA";
                              aMenu5 = "Imprimir";
                              aMenu6 = "Archivar";
                         |FINSI;
                         |MENU aMenu;
                         nOpcion = FSalida;
                    |SINO;         || solo es posible que sea 2
                         nOpcion = 2;
                    |FINSI;
               |SINO;
                    nOpcion = 0;
               |FINSI;
          |SINO;
               nOpcion = 2;
          |FINSI;
     |SINO;
          nOpcion = 0;
     |FINSI;
     |SI nOpcion = 3;
          nOpcion = 1;
          swPasada = 1;
     |FINSI;
     |SI nOpcion = 0; |O nOpcion = 1;   || no tengo DSArchi o he pedido impresion
          |SI aParam = "AUTO"; || en auto no me pidas impresora
               aImpresora = "CrystalReport";
          |FINSI;
          |SI swDesdeWeb = 0; |Y aParam1 ! "PDF";
               |SI aImpresora = "";
                                             || en la variable aImpresora me
                    |IMPRE 0;                || guardo la impresora, asi en
                    aImpresora = Impresora;  || las emisiones de varios meses
               |SINO;                        || solo pregunta una vez
                    Impresora = aImpresora;
                    |IMPRE -1;
               |FINSI;
               FEstado = FSalida;
          |FINSI;
          |HAZ CuadreImpre;
     |SINO;
          |SI nOpcion = 2;
               || todo esto es para que si la primera vez que se manda al GAD
               || no esta el .rpt funcione

               |ESPECIFICA "RBASS", aContiene;
               aOrigen = aContiene1; |QBF aOrigen;
               aOrigen = aOrigen + "crystal/";
               aOrigen = aOrigen + "tm" + Usuario + ".pdf";
               |RFBORRA aOrigen;
               aImpresora = "CrystalReport;" + aOrigen;
               Impresora = aImpresora;
               |IMPRE -1;
               |HAZ CuadreImpre;
               |FININF;
               |FINIMP;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ElFINIMP;
     |SI nOpcion = 0; |O nOpcion = 1;   || no tengo DSArchi o he pedido impresion
          |SI Impresora = "CrystalReport";
               |FININF;
               |HAZ recupera_cuadres;
          |FINSI;
          |SI swDesdeWeb = 0; |Y aParam1 ! "PDF";
               |FINIMP;
               |SI #nomcontr#60 = "S"; |HAZ TerminaRegistro; |FINSI;
          |FINSI;
     |SINO;
          |SI seleccio ! 0; |Y swNoArchives = 0;
               |SI swErrorDSArchi = 0;
                    |MENAV "    Se han enviado al archivo documental los recibos de nómina emitidos.";
                    aAlfa = ":dsarchi/dpntz001;CLI";
                    |SUB_EJECUTA aAlfa;
               |SINO;
                    |MENAV "    No se han archivado las nóminas debido a los errores previos.";
               |FINSI;
          |FINSI;
          |SI nOpcion = 2;
               |HAZ Borra_dbf;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ElINFOR;
     |SI nOpcion = 0; |O nOpcion = 1;   || no tengo DSArchi o he pedido impresion
          |SI swComercio = 1;
               c_informe = "nomyreco";
          |SINO;
               c_informe = "nomyreci";
          |FINSI;
          |INFOR c_informe;
     |FINSI;
|FPRC;

|PROCESO imprime;
     |SI enSwSimulacion = 2;
          |HAZ GrabaDatos;
     |FINSI;
     |SI nOpcion = 2;  |Y #nomrecib#69 ! "A";  || al DSArchi
          |HAZ IMPREArchi;
     |FINSI;
     |SI Impresora ! "CrystalReport"; |Y nOpcion ! 2;
          |HAZ ElINFOR;
     |FINSI;
     |SI swDesdeWeb = 0; |Y aParam1 ! "PDF";
          |SI #0#69 ! "A";
               |SI #0#63 = 6;
                    aAlfa = #10#2;
                    |QBF aAlfa;
                    aAlfa = ("00000" + aAlfa) % -105;
                    aOrden = #10#3;
                    aOrden = #10#3 + aAlfa;
               |SINO;
                    nContadorImp = nContadorImp + 1;
                    aOrden = nContadorImp;  |QBF aOrden; aOrden = ("0000" + aOrden) % -104;
               |FINSI;
          |FINSI;
          |HAZ Comentarios;
          |SI nOpcion = 1; |O nOpcion = 3; || impresion
               |SI #nomcontr#60 = "S"; |HAZ GuardaRegistro; |FINSI;
               nContador2 = nContador2 + 1
          |FINSI;
          |SI #0#69 ! "A";
               |PRINT;
          |FINSI;
          |PIEINF;
     |FINSI;
     |HAZ ElFININF;
|FPRC;

|PROCESO FinTotales;     || moneda y varios temas finales
     enCanti = #10#142;       ||  conversion de liquidos a euros o a pesetas
     |HAZ ConverMoneda2;
     #10#173 = aMonedaRec;
     #10#174 = enCanti;

     || liquido cero si negativo
     |SI #10#142 < 0; |Y #labtraba#141 = "S"; #10#142 = 0; |FINSI;
|FPRC;

|PROCESO cta_cotizacion;
     |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085";
     |O #2#45 = "064";|O #2#45 = "065"; |O #2#45 = "421"; |O #2#45 = "422";
          |DDEFECTO #35;
          #35#0 = #2#0;
          #35#13= #2#77;
          |SI #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421"; |O #2#45 = "422";
               #35#1 = "87";
          |SINO;
               |SI #2#45 = "065";
                    #35#1 = "64";
               |SINO;
                    #35#1 = #2#45 % 2;
               |FINSI;
          |FINSI;
          |LEE 000#35=;
          cta_co = #35#10;      || cta.cto. del centro de trabajo especial
     |SINO;
          cta_co = #1#13;       || cta.cot. de la empresa
          |DDEFECTO #6;
          #6#0 = #2#0;
          #6#1 = #2#77;
          |LEE 000#6=;
          |SI #1#45 = "S";
               cta_co = #6#10;        || cta.cot. centro de trabajo
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO control;
     |DDEFECTO #36;
     |ABRE #36;
     |LEE 000#36p;
     |SI FSalida ! 0;
         |MENAV "    No existe control, usando defectos ...";
     |FINSI;
     |CIERRA #36;
|FPRC;

|PROCESO lib_0;        || CONVIERTE A LITERAL MES EN NUMERO Y HALLA ULTIMO DIA
                       || PARAMETROS ENTRADA:  'mesnum', 'anynum'
                       || PARAMETROS SALIDA:   'mesalf', 'topemes'
     aTipoIT = mesnum;
     |QBF aTipoIT;
     aTipoIT = ("00" + aTipoIT) % -102;
     |HAZ LiteralIT;
     mesalf = aValor;
     topemes = 31;
     |SI mesnum = 4; |O mesnum = 6; |O mesnum = 9; |O mesnum = 11;
          topemes = 30;
     |FINSI;
     |SI mesnum = 2;
          numer = #0#4 $ 4;
          |SI numer = 0; topemes = 29;  |SINO;  topemes = 28;  |FINSI;
     |FINSI;
     |SI mesnum =  0;  mesalf = "          ";  topemes =  0;  |FINSI;

     aTipoIT = "52";
     |HAZ LiteralIT;
     #10#234 = aValor;
|FPRC;

|PROCESO lib_1;        || SEPARA UNA FECHA DADA EN DIA,MES Y A¥O
                       || PARAMETROS ENTRADA:  'fectra'
                       || PARAMETROS SALIDA:   'diatra', 'mestra', 'anytra'
                       || VARIABLES: G_
         diatra = 0;
         mestra = 0;
         anytra = 0;
     |SI fectra ! "          "; |Y fectra ! "..........";
         alfa1 = fectra % 102;
         diatra = alfa1;
         alfa1 = fectra % 402;
         mestra = alfa1;
         alfa1 = fectra % -102;
         anytra = alfa1;
     |FINSI;
|FPRC;

|PROCESO constante;
     alfa1 = "01";
     alfa2 = #0#5;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     nume1 = 2000 + #0#4;
     alfa3 = nume1;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
     |SI aCError ! "";
          |SI nCConst = 500;
               aAlfa = "0000No se ha encontrado la Constante Comun del ";
               aAlfa = aAlfa + " Regimen General (500)";
               |MENAV aAlfa;
          |SINO;
               alfa1 = #labtraba#0; alfa1 = "00000" + #labtraba#0; alfa1 = alfa1 % -105;
               alfa2 = #labtraba#1; alfa2 = "00000" + #labtraba#1; alfa2 = alfa2 % -105;
               aAlfa = "0000ATENCION: Trabajador: " + alfa1 + "." + alfa2;
               aAlfa = aAlfa + " La constante del trabajador no esta definida.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

/*****************************************************************/
/*  MENSUAL-NOMINAS-IMPRESORA                                    */
/*****************************************************************/

|PROCESO salteadaMensualNomFin;
|ABRE #4;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #4#0 = #0salte_1;     || empresa
        #4#1 = #0salte_2;     || trabajador
        #4#2 = #0#5;          || mes

        |SI #0#68="F";
               #4#3=2;
        |SINO;
               #4#3 = #0#10;         || tipo
        |FINSI;

        #4#66 = #0#4;         || a¤o (en las emisiones desde el historico)
    |LEE 001#4=;
    |SI FSalida = 0;
          |SI #0#68="N"; |Y #0#69="I";
               |HAZ procesoNomMensuImpre;
          |FINSI;
          |SI #0#68="N"; |Y #0#69="A";
               |HAZ procesoNomMensuAb;
          |FINSI;
          |SI #0#68="F";
               |HAZ procesoNomMensuImpre;
          |FINSI;
    |FINSI;
|SIGUE;
|CIERRA #4;
|FPRC;

|DEFBUCLE EmpTraNomMensuImpre;     || por nombre empresa, codigo trabajador
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuImpre, NULL, NULL, NULL, procesoNomMensuImpre;
 #1#2, #2#0, #2#1, #4#3;
|FIN;

|DEFBUCLE nomyreci0;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, procesoNomMensuImpre;
|FIN;

|DEFBUCLE nombresNomMensuImpre;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuImpre, NULL, NULL, NULL, procesoNomMensuImpre;
 #2#0, #2#2, #2#1, #4#3;
|FIN;

|DEFBUCLE areasNomMensuImpre;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuImpre, NULL, NULL, NULL, procesoNomMensuImpre;
 #2#0, #2#62, #2#63, #2#1, #4#3;
|FIN;

|DEFBUCLE centrosNomMensuImpre;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuImpre, NULL, NULL, NULL, procesoNomMensuImpre;
 #2#0, #2#77, #2#1, #4#3;
|FIN;

|DEFBUCLE tc2NomMensuImpre;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuImpre, NULL, NULL, NULL, procesoNomMensuImpre;
 #2#0, #0#64, #102#142, #2#75, #2#1, #4#3;
|FIN;

|PROCESO impreMNI2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomyreci0;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresNomMensuImpre;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasNomMensuImpre;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosNomMensuImpre;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2NomMensuImpre;         |FINSI;
     |SI #0#63 = 6;    |BUCLE EmpTraNomMensuImpre;     |FINSI;
|FPRC;

|DEFBUCLE MNIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreMNI2;
|FIN;
|PROCESO MNIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE MNIGrupo;
     |SIGUE;
|FPRC;
|PROCESO proceso;
     || por compatibilizarlo con el nomcal_4
|FPRC;

|PROCESO impreMNI;
     |SI swPasada = 0;
          swStopIRPF = 0;
          |HAZ nomgir00;
          nTraNoEmi = 0;
          swHayIncid = 0;
          |DDEFECTO #nomgirco;
          |ABRE #nomgirco; |LEE 000#nomgirco.p;  |CIERRA #nomgirco;
     |FINSI;
     c_informe = "nomyreci";
     |HAZ cuadres;
     |SI sw_cuadre = 0; |Y swStopIRPF = 0;
          |HAZ ElIMPRE;
          |SI FEstado = 0;
               |HAZ BuscaModulo;
               |ABRE #1;
               |ABRE #2;
               |ABRE #3;
               |ABRE #6;
               |ABRE #35;
               |ABRE #100;
               |ABRE #102;
               seleccio = 0;

               |SI #0#21 = 0;
                    |SI #0#70 = 0;
                         |HAZ impreMNI2;
                    |SINO;
                         |HAZ MNIPorGrupos;
                    |FINSI;
               |SINO;
                    |HAZ salteadaMensualNomFin;
               |FINSI;
               |SI seleccio = 0;
                    |MENAV "    Seleccion vacia ...";
               |FINSI;
               |CIERRA #1;
               |CIERRA #2;
               |CIERRA #3;
               |CIERRA #6;
               |CIERRA #35;
               |CIERRA #100;
               |CIERRA #102;
          |SINO;
               |MENAV "    Proceso ABORTADO !!!";
          |FINSI;
          |HAZ ElFINIMP;

          |SI swStopIRPF = 0;
               |HAZ AvisoIRPF;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO procesoNomMensuImpre;
     nEmp = #nomcalca#0;      || busco si el trabajador tiene incidencias por
     nTra = #nomcalca#1;      || resolver, si es asi swStop no se devolvera
     |HAZ IncidIRPF;          || a cero y ya tendre al menos un trabajador
                              || no emitido por esta causa, mostrare aviso
     |SI swStop ! 0;
          nTraNoEmi = nTraNoEmi + 1;
          |SI #0#69 ! "P";
               |ACABA;
          |FINSI;
     |FINSI;

|SI sw_control = 0; |HAZ control;  sw_control = 1;     |FINSI;

    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
    coment = 0;
|DDEFECTO #10;
nEmp = #nomcalca#0; nTra = #nomcalca#1;
|HAZ comple_0;            ;   || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI runnom = "nomyreci";
     |SI #0#10 = 2;|Y #1#39 ! "2";
          |ACABA;      || finiquito no separado!!! (recibo)
     |FINSI;
|FINSI;
|SI runnom = "nomycalf";
     |SI #0#10 = 2;|Y #1#39 ! "3";
          |ACABA;      || finiquito no separado!!! (carta)
     |FINSI;
|FINSI;

|SI runnom="nomyreci"; |O runnom="nomycalf";
     |SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
          |ACABA;
     |FINSI;
|FINSI;
nContrato = #4#9;
|HAZ comple_1;   || construye literales datos empresa
|HAZ comple_2;                || construye periodo de liquidacion nomina
|HAZ comple_3NomMensu;        || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_NomMensuImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4NomMensuImpre;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5NomMensuImpre;   || construye fecha firma
|HAZ cargas_0NomMensuImpre;           || carga campos cabecera calculos
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1NomMensuImpre#4;   || carga campos lineas calculos
|HAZ ImpCrystal;
|SI lineas = 1; |O #0#10 = 2;
        seleccio = 1;    || para saber si se ha leido algo
    |HAZ cargas_2NomMensuImpre;       || carga campos totales
    |HAZ comple_6;   || construye el comentario
     |SI swPDFMasivo = 1;
          |HAZ PreparaPDF;
     |SINO;
          ||SI #0#67="M"; |Y #0#68="N"; |Y #0#69="P"; |HAZ imprimeNomMensuPan; |FINSI;

          |SI #0#67="M"; |Y #0#68="F";
               |HAZ imprimeFinMensu;
          |FINSI;

          |SI #0#67="M"; |Y #0#68="N"; |Y #0#69="I";
               nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion)
               |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                    |HAZ imprime;
               |SIGUE;
          |FINSI;
     |FINSI;
|FINSI;
|FPRC;

|PROCESO ordenaNomMensuImpre;
|DDEFECTO #1;
    #1#0 = #4#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #4#0;
    #2#1 = #4#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO cargas_0NomMensuImpre;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS (no todos !!!)
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa (*)
    #10#005 = pobemp;         || poblacion empresa (*)
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa (*)
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq;         || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
     |SI #2#42 = "E";
          #10#19 = #4#11 + #4#55;          || total jornadas (AGRARIOS*)
     |SINO;
          #10#19 = #4#08;          || total dias liquidacion
          |SI swModulo = 2884;
               |SI #2#42 = "C"; |O #2#42 = "F"; #10#19 = #4#10; |FINSI;
          |FINSI;
     |FINSI;
    #10#205 = #4#55;          || jornadas en IT agrarios
    #10#207 = #4#11;          || jornadas en IT agrarios
    #10#103 = #4#57;          || ptas. enfermedad
    #10#104 = #4#58;          || ptas. accidente
    #10#105 = desenf;         || del dia enfermedad
    #10#106 = hasenf;         || al dia enfermedad
    #10#107 = desacc;         || del dia accidente
    #10#108 = hasacc;         || al dia accidente
    #10#119 = tcotiz;         || base cotizacion
    #10#120 = #4#38;          || base prorratas
    #10#121 = tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #4#39 - #4#115;           || base contingencias comunes
    #10#124 = #4#40 - #4#134;           || base Des
    |SI #2#42 = "A"; |O #2#42 = "E";    || sumo mat, que estaba inc. en parte empresarial
         |SI #4#117 > 0;
              #10#123 = #10#123 + #4#117; #10#124 = #10#124 + #4#117;
         |FINSI;
    |FINSI;
    |SI #10#123 < 0; #10#123 = 0; |FINSI; |SI #10#124 < 0; #10#124 = 0; |FINSI;
    #10#206 = #10#124;                  || base FP
    |HAZ Pluriempleo;
    #10#125 = #4#41;          || base horas extra estruc.
    #10#126 = #4#42;          || base horas extra no estruc.
    #10#127 = #4#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+fp
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #4#48;          || ptas. contingencias comunes
    #10#132 = #4#49;          || ptas. d+fp
    #10#133 = #4#50;          || ptas. horas extra estruc.
    #10#134 = #4#51;          || ptas. horas extra no estruc.
    |SI #labtraba#42 = "e"; #10#123 = #10#131 * 100 / #10#127; |FINSI;
    |SI #4#165 ! 0;     || Cot. Solidaridad
         #10#124 = #10#123; #10#164 = #4#165; #10#162 = (#10#164 / #10#124) * 100;
         taporta = taporta + #10#164; deducir = deducir + #10#164;
    |FINSI;
    |SI #4#167 ! 0;     || Cont. Excluidas
         |HAZ CC_Excluidas;
    |FINSI;
    #10#135 = #4#13;          || (%) IRPF 1
    #10#137 = taporta;        || total aportacion
    #10#139 = tantici;        || total anticipos
    #10#140 = #4#54;          || en especie
    #10#141 = deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    #10#150 = "";             || Literal fijo
    |SI #labtraba#247 = 138; #10#150 = "REG. ESP. EMPLEADOS DEL HOGAR"; |FINSI;
    #10#151 = #4#67;          || (%) IRPF 2
    #10#152 = #4#68;          || (%) IRPF 3
    #10#160 = #4#52;          || anticipos 1
    #10#161 = #4#53;          || anticipos 2
    #10#196 = #4#89 + nEmbargo;          || anticipos 3 + embargo
    #10#193 = #4#45;                     || S.S. cargo empresa
    |SI #4#199 < 0; #10#231 = (-1) * #4#199;  |FINSI;            || Preaviso
    |SI #4#200 < 0; #10#232 = (-1) * #4#200;  |FINSI;            || Dto.Vac
|SI #4#49 ! 0;
        |SI apord ! 0; #10#162 = apord; |FINSI;          || (%) desempleo
        #10#163 = aporfp;          || (%) form.prof.
        |SI apord ! 0; #10#164 = #10#124 % apord; |FINSI;  || desempleo
        |SI #labtraba#190 = "S"; |Y #4#142 ! 0; #10#164 = #4#142; |FINSI;
        #10#165 = #4#49 - #10#164; || ptas. form.prof.
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
             #10#165 = #4#49;
        |FINSI;
|FINSI;

nEmpresa=#4#0;      || empresa
nTrabajador=#4#1;   || trabajador
nMes=#4#2;          || mes
nTipo=#4#3;         || tipo
|HAZ ComentariosNomvarca;

|HAZ AcumuladosIRPF;
|FPRC;

|PROCESO AgrupaSiNo;
     swAgrupa = 0;
     |SI #nomcontr#45 = "S"; ||Y concep < 201; las pagas tambien, ya veremos
     |Y situcon < 36;        || estaba puesto que las pagas no jugaban a esto
                             || lo quito para que jueguen el 22.10.2007 por el 3006.555
     |Y concep < 900; || anticipos no
     |Y situcon ! 17; || la situacion de las pagas en la nomina
          swAgrupa = 1;
     |FINSI;
     |SI concep > 400; swAgrupa = 0; |FINSI;
     |SI #0#69 = "A"; swAgrupa = 0; |FINSI;
     |SI swAgrupa = 1;
          situac2 = 0;
          |PARA nPos = 1; |SI nPos [ 256; |HACIENDO nPos = nPos + 7;
               nPos1 = (nPos * 100) + 7;     || (XXX YY ) (XXX concepto, YY posicion
               aAlfa = aNormal % nPos1;      || que ocupa por convenio)
               |SI aAlfa = "       ";
                    |SAL;
               |FINSI;
               aAlfa1 = aAlfa % 103;         || concepto alfa
               nNume1 = aAlfa1;              || concepto nume
               aAlfa2 = aAlfa % 502;         || posicion alfa
               nNume2 = aAlfa2;              || posicion nume
               |SI situcon = nNume2; |Y nNume1 ! concep; || vaya, el concepto en que
                    aAlfa = aAgrupa % nPos1;        || estoy se agrupaba ya con
                    aAlfa1 = aAlfa % 103;    || otro, tenia la misma posicion
                    nNume1 = aAlfa1;
                    aAlfa2 = aAlfa % 502;
                    nNume2 = aAlfa2;

                    |SI nNume2 ! 0;          || vale, pues a ver en cual ha quedado
                         situac2 = nNume2;   || y esa sera mi situacion
                    |FINSI;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO RegAgrupa;
     aAlfa1 = concep;
     aAlfa2 = situcon; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = situac; aAlfa3 = ("00" + aAlfa3) % -102;
     aNormal = aNormal + aAlfa1 + " " + aAlfa2 + " ";
     aAgrupa = aAgrupa + aAlfa1 + " " + aAlfa3 + " ";
|FPRC;

|PROCESO situacion;
     |SI concep = 965; |Y import [ 0;
          situac = 00; situcon = 00;
          |ACABA;
     |FINSI;
     |HAZ AgrupaSiNo;
     |SI swAgrupa = 1;
          |SI import ! 0;
               || parche para que en finiquitos, el primer conceptono salga
               || en el lugar del salario base, ya que no hay salario base
               |SI #0#10 = 2; |Y concep ! 101; |Y situac_ult = 0;
                    situac_ult = 1;
               |FINSI;
               |SI situac2 ! 0;
                    situac = situac2;
               |SINO;
                    situac = situac_ult + 1;
                    situac_ult = situac;
               |FINSI;
          |SINO;
               lineas = 1;    || he de poner esto porque si no, no se imprime
                              || una nomina con el mes entero de IT sin conceptos
                              || que solo tenga la prestacion
               situcon = 00;
               situac = 00;
          |FINSI;
     |SINO;
          situac = situcon;
     |FINSI;
     |HAZ RegAgrupa;
|FPRC;

|PROCESO DiasAgrarios;
     |SI swModulo = 2884; |ACABA; |FINSI;
     |SI #2#42 = "E"; |O #2#42 = "e";
          nNume = unidad + #10#205;
          |SI nNume > 23; #10#19 = nNume; |FINSI;
     |FINSI;
|FPRC;
|PROCESO cargas_1NomMensuImpre;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     descri = #5#08;
     unidad = #5#11;      || unidades calculo
     valor  = #5#10;
     import = unidad * valor;
     incluye = 0;
     concep = #5#4;
     situcon = #5#7;
     |HAZ situacion;
     |SI situac ! 0; |O concep = 906; |O concep = 907; |O concep = 926; |O situcon ! 0;
          |SI concep ] 201; |Y concep [ 208; |Y #5#5 ! "P"; |Y #0#10 = 0;
               |SI swbaja = 1;
                    |SI #2#48="S"; |Y #1#25=2; incluye = 1; |FINSI;  || si es finiquito
               |SINO;
                    |SI #1#25=2;   incluye = 1; |FINSI;  || si la paga va junta
               |FINSI;
          |SINO;
               incluye = 1;
          |FINSI;
          |HAZ Dtos;
          |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
          |SI concep = 301; |O concep = 306;
               |SI #nomcontr#37 = "S";
                    incluye = 0;
                    #10#118 = #10#118 + import;
               |FINSI;
          |FINSI;
          |SI incluye = 1;
               lineas = 1;
               camptas = situac + 22;
               camdesc = situac + 61;
               #10camptas = #10camptas + import;
               arteris = descri % 101;
               |SI concep ! 906; |Y concep ! 907; |Y concep ! 926;
                    |SI arteris ! "*";
                         |DDEFECTO #100; #100#0 = #2#87; #100#1 = concep; |LEE 000#100=;
                         alfa1 = #100#2;     |QBF alfa1;
                         |SI alfa1 ! "";
                              descri = alfa1;
                         |FINSI;
                         |HAZ UnidadesConcepto;
                         #10camdesc = descri;
                    |SINO;
                         #10camdesc = "";
                    |FINSI;
               |FINSI;
               |HAZ Ampliada2;
               |SI concep = 101;
                    dcal_101 = #5#05;
                    duni_101 = unidad;
                    dval_101 = valor;
               |FINSI;
               |SI concep = 102;               ||   unidades concepto 102
                    duni_102 = unidad;
               |FINSI;
          |FINSI;
          |HAZ DescAntic;
          |SI concep ] 301; |Y concep [ 305;
               duni_hest = duni_hest + #5#11;
          |FINSI;
          |SI concep ] 306; |Y concep [ 310;
               duni_hnoest = duni_hnoest + #5#11;
          |FINSI;
          |HAZ CrystalDescComp;
     |FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
|FPRC;

|PROCESO cargas_2NomMensuImpre;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#4#33 * 100) $ 100) / 100;
            ||#10#21 = #4#8 - (#4#31 + #4#32 + #4#34 + #4#65 + deci_h + #4#66); ||unid.sal.base
            #10#21 = #4#8 - (#4#31 + #4#32 + #4#34 + #4#65 + #4#66); ||unid.sal.base
    |SINO;
            #10#21 = duni_101;
    |FINSI;
|SINO;
        #10#21 = duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3;          || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
    #10#195 = #4#46 - #10#116 + #nomtrnom#193;  || Total Neto + SS Emp
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23 + #10#199;         || t.devengado+s.base-absent
    #10#20 = #10#118;                             || importe total
    #10#142 = #10#118 - #10#141;                   || liquido a percibir
    #10#136 = #4#14 + #4#69 + #4#70;                    || tot.base IRPF
    #10#138 = #4#15 + #4#71 + #4#72;                    || tot.ret. IRPF
    #10#153 = #4#14;                                    || base IRPF 1
    #10#154 = #4#69;                                    || base IRPF 2
    #10#155 = #4#70;                                    || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #4#15;                                    || ret. IRPF 1
    #10#158 = #4#71;                                    || ret. IRPF 2
    #10#159 = #4#72;                                    || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #4#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #4#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #4#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #4#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = duni_hest;
    #10#191 = duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO LogoEmp;
     nEmpresaLogo = #labempre#0;                  || imprime logo por empresa si hay
     |SI #nomcont1#9 ! 0; |Y #nomcont1#10 ! 0;    || imprime logo general
          nEmpresaLogo = 0;
     |FINSI;
     |SI #nomcont1#9 = 0; nEmpresaLogo = 0; |FINSI;
     |SI swParamEmpresa = 1; |Y #nomcont1#10 ! 0;    || imprime logo general
          nEmpresaLogo = #labempre#0;                  || imprime logo por empresa si hay
          || logo cabecera o pie POR EMPRESA, no general
     |FINSI;
|FPRC;

|PROCESO comple_0;           || LEE EMPRESA,TRABAJADOR,CONSTANTE Y CENTRO
     |DDEFECTO #1;
     #1#0 = nEmp;
     |LEE 020#1=;             || empresa
     |HAZ ParamEmpresa;
     |DDEFECTO #2;
     #2#0 = nEmp; #2#1 = nTra;
     |LEE 020#2=;             || trabajador
     nCConst = #labtraba#248; |HAZ constante;
     |HAZ Centro;
     |HAZ Auxiliar;
     duni_hest = 0;           || inicializa variables acumuladoras del
     duni_hnoest = 0;         || nro. de horas extras estructurales y no estruct.
     |DDEFECTO #102;
     #102#0 = #2#87;
     |LEE 000#102=;
     #2#25 = #102#1;
     |HAZ LogoEmp;
|FPRC;

|PROCESO comple_1;       || CONSTRUYE LITERALES DATOS EMPRESA
     |SI #0#9 = 1; alfa1 = #1#03; |SINO; alfa1 = #6#03; |FINSI;
     |SI #0#9 = 1; alfa2 = #1#04; |SINO; alfa2 = #6#04; |FINSI;
     |SI #0#9 = 1; alfa3 = #1#05; |SINO; alfa3 = #6#05; |FINSI;
     |QBF alfa1; |QBF alfa2; |QBF alfa3;
     domemp = alfa1 + " " + alfa2 + " " + alfa3;  || domicilio empresa
     |SI runnom = "nomycalf"; |Y #0#10 = 2; |Y #1#39 = "3";
          domemp = alfa1;  || domicilio empresa
          |SI #0#9 = 2;
               #1#04 = #6#04;
               #1#05 = #6#05;
          |FINSI;
     |FINSI;
     |SI #0#9 = 1; alfa1 = "00" + #1#07; |SINO; alfa1 = "00" + #6#07; |FINSI;
     |SI #0#9 = 1; alfa2 = "000" + #1#08;|SINO; alfa2 = "000" + #6#08;|FINSI;
     alfa1 = alfa1 % -102;
     alfa2 = alfa2 % -103;
     alfa3 = "(" + alfa1 + alfa2 + ") ";
     |SI #0#9 = 1; alfa1 = #1#06; |SINO; alfa1 = #6#06; |FINSI;
     |QBF alfa1;
     pobemp = alfa3 + alfa1;                      || poblacion empresa
     |SI runnom = "nomycalf"; |Y #0#10 = 2; |Y #1#39 = "3";
          pobemp = alfa1;                      || poblacion empresa
          |SI #0#9 = 2;
               #1#9 = #6#9;
          |FINSI;
     |FINSI;
     afili = #6#10;
     |QBF afili;
     |SI afili = "";
          afili = #1#13;
     |FINSI;
     ||HAZ afili_agr;
     |SI #4#9 = 87; |O #4#9 = 85; |O #4#9 = 97; |O #4#9 = 64; |O #4#9 = 65;
     |O #4#9 = 421; |O #4#9 = 422;
          |DDEFECTO #35;
          #35#0 = #2#0;
          #35#13 = #2#77;
          |SI nContrato = 421; |O nContrato = 422;
               #35#1 = 87;
          |FINSI;
          |LEE 000#35=;
          afili = #35#10;
     |FINSI;
|FPRC;

|PROCESO comple_2;        || CONSTRUYE PERIODO DE LIQUIDACION
     swbaja_real = 0;
     mesnum = #0#5;
     anytra = #0#4;
     |HAZ lib_0;             || saca ultimo dia natural del mes
     mesliq = mesalf;
     |SI #0#67 = "M";
          |SI #0#68 = "N"; fectra = #4#4; |FINSI;
          |SI #0#68 = "P"; fectra = #93#4; |FINSI;
     |FINSI;
     |SI #0#67 = "H";
          |SI #0#68 = "N"; fectra = #11#4; |FINSI;
          |SI #0#68 = "P"; fectra = #95#4; |FINSI;
     |FINSI;
     |HAZ lib_1;
     diaalta = diatra;
     mesalta = mestra;
     |SI mesalta = #0#5; |Y anytra = #0#4;  || si es alta este mes
          desdia = diaalta;
     |SINO;
          desdia = 1;
     |FINSI;
     |SI #0#67 = "M";
          |SI #0#68 = "N"; fectra = #4#5; |FINSI;
          |SI #0#68 = "P"; fectra = #93#5; |FINSI;
     |FINSI;
     |SI #0#67 = "H";
          |SI #0#68 = "N"; fectra = #11#5; |FINSI;
          |SI #0#68 = "P"; fectra = #95#5; |FINSI;
     |FINSI;
     |HAZ lib_1;
     diabaja = diatra;
     mesbaja = mestra;
     |SI mesbaja = #0#5; |Y anytra = #0#4;
          |SI diabaja ! topemes;
               swbaja = 1;      || switch para saber si es baja en 'cargas_1'
          |FINSI;
          swbaja_real = 1;
          hasdia = diabaja;
     |SINO;
          hasdia = topemes;
     |FINSI;
     |SI mesbaja = #0#5; |Y anytra = #0#4;
          coment = 1;
     |FINSI;
     |SI swbaja_real = 1;
          aMotivo = "";
          nNume = 0;
          |ABRE #nomvarca;
          #nomvarca#0 = #labtraba#0;
          #nomvarca#1 = #labtraba#1;
          #nomvarca#2 = #0#5;
          #nomvarca#3 = 0;
          |LEE 000#nomvarca.=;
          |SI FSalida = 0;
               nNume = #nomvarca#46;
               |SI nNume = 0;
                    aAlfa = #labtraba#184;
                    aAlfa = aAlfa % 102;
                    nNume = aAlfa;
               |FINSI;
          |FINSI;
          |CIERRA #nomvarca;

          |SI nNume ! 0;
               |ABRE #motibaja;
               #motibaja#0 = nNume;
               |LEE 000#motibaja.=;
               |SI FSalida = 0;
                    aMotivo = #motibaja#1;
               |FINSI;
               |CIERRA #motibaja;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TipoIT;
     |SI tipoit = "E"; tipoit = "Enfermedad"; |FINSI;
     |SI tipoit = "A";
          tipoit = "Accidente";
     |FINSI;
     |SI tipoit = "H"; tipoit = "Huelga"; |FINSI;
     |SI tipoit = "F"; |O tipoit = "f"; tipoit = "Absentismo"; |FINSI;
     |SI tipoit = "M"; tipoit = "Maternidad"; |FINSI;
     |SI tipoit = "P"; tipoit = "Paternidad"; |FINSI;
     |SI tipoit = "R"; tipoit = "Riesgo Emb"; |FINSI;
     |SI tipoit = "C"; tipoit = "IT Cont.SS"; |FINSI;
     |SI tipoit = "V"; tipoit = "Vacaciones"; |FINSI;
     |SI tipoit = "D"; tipoit = "Desempleo"; |FINSI;
     |SI tipoit = "S"; tipoit = "Perm.s/ret"; |FINSI;
|FPRC;

|PROCESO comple_3NomMensu;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
     nDiasIT = 0;
    tipoit = "";
    desenf = 0;  hasenf = 0;
    desacc = 0;  hasacc = 0;
    swtenf = 0;  swtacc = 0;
|SI #4#27="E"; |O #4#27="M"; |O #4#27="P"; |O #4#27="R";
       desenf=#4#19; hasenf=#4#23; swtenf=1;
    tipoit = #4#27;
|FINSI;
|SI #4#28="E"; |O #4#28="M"; |O #4#28="P"; |O #4#28="R";
    |SI swtenf=0; desenf=#4#20; hasenf=#4#24; swtenf=1; |FINSI;
    tipoit = #4#28;
|FINSI;
|SI #4#29="E"; |O #4#29="M"; |O #4#29="P"; |O #4#29="R";
    |SI swtenf=0; desenf=#4#21; hasenf=#4#25; swtenf=1; |FINSI;
    tipoit = #4#29;
|FINSI;
|SI #4#30="E"; |O #4#30="M"; |O #4#30="P"; |O #4#30="R";
    |SI swtenf=0; desenf=#4#22; hasenf=#4#26; swtenf=1; |FINSI;
    tipoit = #4#30;
|FINSI;
     |SI swtenf = 1;
       |HAZ TipoIT;
     |FINSI;
|SI #4#27="A";              desacc=#4#19; hasacc=#4#23; swtacc=1; |FINSI;
|SI #4#28="A"; |Y swtacc=0; desacc=#4#20; hasacc=#4#24; swtacc=1; |FINSI;
|SI #4#29="A"; |Y swtacc=0; desacc=#4#21; hasacc=#4#25; swtacc=1; |FINSI;
|SI #4#30="A"; |Y swtacc=0; desacc=#4#22; hasacc=#4#26; swtacc=1; |FINSI;
|SI swtacc = 1;|Y #36#19 = "S";
        desacc = desacc - 1;
    |SI desacc < 0;  desacc = 1;  |FINSI;  || por el rollo de las mutuas
|FINSI;
|SI desenf = 0;|Y swtenf = 1;   desenf = 1;    |FINSI;
|SI hasenf = 0;|Y swtenf = 1;   hasenf = #4#7; |FINSI;
|SI desacc = 0;|Y swtacc = 1;   desacc = 1;    |FINSI;
|SI hasacc = 0;|Y swtacc = 1;   hasacc = #4#7; |FINSI;
nDiasIT = #4#31 + #4#32 + #4#33 + #4#34 + #4#194 + #4#131 + #4#65 + #4#66;
|FPRC;

|PROCESO comple_3_1_NomMensuImpre;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
     |HAZ carga_AHV_Men; || precarga de Abs, Hue, Vac segun nomabsca, nomabsli
     |PARA para1 = 19; |SI para1 [ 30; |HACIENDO para1 = para1 + 1;
          para2 = para1 + 159;
          |SI para1 [ 26;
               #10para2 = #4para1;
          |SINO;
               tipoit = #4para1;
               |HAZ TipoIT;
               #10para2 = tipoit;
          |FINSI;
     |SIGUE;
     |SI #4#34 ! 0; #10#198 = #4#34; |FINSI; || dias absentismo
     |SI #nomcontr#47 = "C"; |Y #10#198 ! 0; #10#199 = (-1) * #4#105; |FINSI;
|FPRC;

|PROCESO comple_4NomMensuImpre;        || HALLA TOTALES VARIOS
     |SI swComercio = 1;
          |HAZ comple_4NMI_Comercio;
          |ACABA;
     |FINSI;
     tcotiz  = #4#37 + #4#62;
     tbcotiz = tcotiz + #4#38;           || total bases de cotizacion
     |SI #4#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
          apordfp = #3#13+#3#15+#3#17+#3#19;   ||(%) d+fp
          aporfp = #3#17;                      ||(%) fp
          apord = apordfp - aporfp;            ||(%) d
     |SINO;
          apordfp = 0;
          aporfp = 0;
          apord = 0;
     |FINSI;
     |SI #4#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
          aporhe1 = #3#09;                || (%) horas extra estruc.
          |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
               aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
          |FINSI;
     |SINO;
          aporhe1 = 0;
     |FINSI;
     |SI #4#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
          aporhe2 = #3#11;                || (%)horas extra no estruc.
          |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
               aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
          |FINSI;
     |SINO;
          aporhe2 = 0;
     |FINSI;
     |HAZ parcheformacionM;
     taporta = #4#48 + #4#49 + #4#50 + #4#51;      || total aportacion
     tantici = #4#52 + #4#53 + #4#89;              || total anticipos
     deducir = taporta + #4#75 + tantici + #4#54;  || total a deducir
     |SI #4#199 < 0; deducir = deducir + ((-1) * #4#199);  |FINSI;   || Preaviso
     |SI #4#200 < 0; deducir = deducir + ((-1) * #4#200);  |FINSI;   || Dto.Vac
     nEmbargo = 0;
     |SI #4#104 ! 0;
          |SI #4#47 = 0; |O #1#25 = 2;
               nEmbargo = #4#104;
          |SINO;
               nEmbargo = (#4#104 * (#4#46 / (#4#46 + #4#47))) ! 2;
               |HAZ EmbargoPaga;
          |FINSI;
     |FINSI;
     deducir = deducir + nEmbargo;

     |SI swbaja = 0; |Y #1#25 = 2;         || si la paga va junta y no es baja,
          deducir = deducir + #4#17;    || /le suma la parte IRPF de pagas
          tantici = tantici + #4#86;    || y le suma el anticipo Paga Ext(-3-)
          deducir = deducir + #4#86;    || al total anticipos y deducciones
     |FINSI;
|FPRC;

|PROCESO comple_5NomMensuImpre;        || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaNomMensuImpre;              || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0; diarec = diabaja; |SINO; diarec = diatra; |FINSI;
|SI mesbaja ! 0; mesrec = mesbaja; |SINO; mesrec = mestra; |FINSI;
    anyrec = anytra;
    mesnum = mesrec;
    |HAZ lib_0;
    mesrec = mesalf;
|FPRC;

|PROCESO sibajaNomMensuImpre;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
    mesbaja = 0;
|SI #4#5 ! "          "; |Y #4#5 ! "..........";
        fectra = #4#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
            mesbaja = mestra;
    |FINSI;
|FINSI;
|FPRC;


|| CALCULO DE ACUMULADOS IRPF

|PROCESO nomhicca_1;
     #10#166 = #10#166 + (#nomhicca#14 + #nomhicca#108 + #nomhicca#109 + #nomhicca#16);
     #10#167 = #10#167 + (#nomhicca#15 + #nomhicca#110 + #nomhicca#111 + #nomhicca#17);
     #10#168 = #10#168 + (#nomhicca#48 + #nomhicca#49 + #nomhicca#50 + #nomhicca#51);
|FPRC;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #4#0, #4#1, #0#4,  1,  0;
     #4#0, #4#1, #0#4, 12, 99;
     ;
     NULL, nomhicca_1;
|FIN;

|PROCESO AcumuladosIRPF;
     #10#166 = 0;
     #10#167 = 0;
     #10#168 = 0;
     |BUCLE nomhicca;
     #10#166 = #10#166 + (#4#14 + #4#69 + #4#70 + #4#16);
     #10#167 = #10#167 + (#4#15 + #4#71 + #4#72 + #4#17);
     #10#168 = #10#168 + (#4#48 + #4#49 + #4#50 + #4#51);
|FPRC;

/*****************************************************************/
/*  HISTORICO-NOMINAS-IMPRESORA                                  */
/*****************************************************************/

|PROCESO salteadaHistoNomFin;
|ABRE #11;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #11#0 = #0salte_1;     || empresa
        #11#1 = #0salte_2;     || trabajador
        #11#2 = #0#5;          || mes

        |SI #0#68="F";
               #11#3=2;
        |SINO;
               #11#3 = #0#10;         || tipo
        |FINSI;

        #11#66 = #0#4;         || a¤o (en las emisiones desde el historico)
    |LEE 001#11=;
    |SI FSalida = 0;

        |SI #0#68="N"; |Y #0#69="I";
               |HAZ procesoNomHistoImpre;
        |FINSI;
        |SI #0#68="N"; |Y #0#69="A";
               |HAZ procesoNomHistoAb;
        |FINSI;
        |SI #0#68="F";
               |HAZ procesoNomHistoImpre;
        |FINSI;

    |FINSI;
|SIGUE;
|CIERRA #11;
|FPRC;

|DEFBUCLE nomwreci0;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, procesoNomHistoImpre;
|FIN;

|DEFBUCLE EmpTraNomHistoImpre;     || por nombre empresa, codigo trabajador
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoImpre, NULL, NULL, NULL, procesoNomHistoImpre;
 #1#0, #2#0, #2#1, #11#3;
|FIN;

|DEFBUCLE nombresNomHistoImpre;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoImpre, NULL, NULL, NULL, procesoNomHistoImpre;
 #2#0, #2#2, #2#1, #11#3;
|FIN;

|DEFBUCLE areasNomHistoImpre;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoImpre, NULL, NULL, NULL, procesoNomHistoImpre;
 #2#0, #2#62, #2#63, #2#1, #11#3;
|FIN;

|DEFBUCLE centrosNomHistoImpre;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoImpre, NULL, NULL, NULL, procesoNomHistoImpre;
 #2#0, #2#77, #2#1, #11#3;
|FIN;

|DEFBUCLE tc2NomHistoImpre;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoImpre, NULL, NULL, NULL, procesoNomHistoImpre;
 #2#0, #0#64, #102#142, #2#75, #2#1, #11#3;
|FIN;

|PROCESO impreHNI2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomwreci0;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresNomHistoImpre;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasNomHistoImpre;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosNomHistoImpre;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2NomHistoImpre;         |FINSI;
     |SI #0#63 = 6;    |BUCLE EmpTraNomHistoImpre;     |FINSI;
|FPRC;

|DEFBUCLE HNIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreHNI2;
|FIN;

|PROCESO HNIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE HNIGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreHNI; |TIPO 3;
     c_informe = "nomyreci";
|HAZ cuadres;
|SI sw_cuadre = 0;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
          |HAZ BuscaModulo;
            seleccio = 0;
        |SI #0#21 = 0;
            |SI #0#70 = 0;
                |HAZ impreHNI2;
            |SINO;
                |HAZ HNIPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaHistoNomFin;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
|FINSI;
|FPRC;


|PROCESO procesoNomHistoImpre;
|SI sw_control = 0; |HAZ control;  sw_control = 1;     |FINSI;

    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
    coment = 0;
|DDEFECTO #10;
nEmp = #nomhicca#0; nTra = #nomhicca#1;
|HAZ comple_0;                || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI runnom = "nomwreci";
     |SI #0#10 = 2;|Y #1#39 ! "2";
          |ACABA;      || finiquito no separado!!! (recibo)
     |FINSI;
|FINSI;
|SI runnom = "nomwcalf";
     |SI #0#10 = 2;|Y #1#39 ! "3";
          |ACABA;      || finiquito no separado!!! (carta)
     |FINSI;
|FINSI;
|SI runnom="nomwreci"; |O runnom="nomwcalf";
     |SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
          |ACABA;
     |FINSI;
|FINSI;
nContrato = #11#9;
|HAZ comple_1;              || construye literales datos empresa
|HAZ comple_2;                || construye periodo de liquidacion nomina
|HAZ comple_3NomHisto;        || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_NomHistoImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4NomHistoImpre;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5NomHistoImpre;   || construye fecha firma
|HAZ cargas_0NomHistoImpre;           || carga campos cabecera calculos
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1NomHistoImpre#11;   || carga campos lineas calculos
|HAZ ImpCrystal;
|SI lineas = 1;
        seleccio = 1;        || para saber si se ha leido algo
    |HAZ cargas_2NomHistoImpre;           || carga campos totales
    |HAZ comple_6;   || construye comentario

     |SI swPDFMasivo = 1;
          |HAZ PreparaPDF;
     |SINO;
          ||SI #0#67="H"; |Y #0#68="N"; |Y #0#69="P"; |HAZ imprimeNomHistoPan; |FINSI;

          |SI #0#67="H"; |Y #0#68="F";
               |HAZ imprimeFinHisto;
          |FINSI;

          |SI #0#67="H"; |Y #0#68="N"; |Y #0#69="I";
               nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion
               |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                    |HAZ imprime;
               |SIGUE;
          |FINSI;
     |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomhiccaHis;
     #nomhicca#1;
     ;
     nEmpresa, nTrabajador, nAny,    1,  0;
     nEmpresa, nTrabajador, nAny, nMes, 99;
     ;
     NULL, nomhicca_1;
|FIN;

|PROCESO cargas_0NomHistoImpre;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq;         || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
     |SI #2#42 = "E";
          #10#19 = #11#11 + #11#55;          || total jornadas (AGRARIOS*)
     |SINO;
          #10#19 = #11#8;          || total dias liquidacion
          |SI swModulo = 2884;
               |SI #2#42 = "C"; |O #2#42 = "F"; #10#19 = #11#10; |FINSI;
          |FINSI;
     |FINSI;
    #10#205 = #11#55;          || jornadas en IT agrarios
    #10#207 = #11#11;          || jornadas alta
    #10#103 = #11#57;          || ptas. enfermedad
    #10#104 = #11#58;          || ptas. accidente
    #10#105 = desenf;         || del dia enfermedad
    #10#106 = hasenf;         || al dia enfermedad
    #10#107 = desacc;         || del dia accidente
    #10#108 = hasacc;         || al dia accidente
    #10#119 = tcotiz;         || base cotizacion
    #10#120 = #11#38;          || base prorratas
    #10#121 = tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #11#39 - #11#157;          || base contingencias comunes
    #10#124 = #11#40 - #11#176;          || base D+FP
    |SI #2#42 = "A"; |O #2#42 = "E";    || sumo mat, que estaba inc. en parte empresarial
         |SI #11#159 > 0;
              #10#123 = #10#123 + #11#159; #10#124 = #10#124 + #11#159;
         |FINSI;
    |FINSI;
    |SI #10#123 < 0; #10#123 = 0; |FINSI; |SI #10#124 < 0; #10#124 = 0; |FINSI;
    #10#206 = #10#124;                  || base FP
    |HAZ Pluriempleo;
    #10#125 = #11#41;          || base horas extra estruc.
    #10#126 = #11#42;          || base horas extra no estruc.
    #10#127 = #11#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+fp
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #11#48;          || ptas. contingencias comunes
    #10#132 = #11#49;          || ptas. d+fp
    #10#133 = #11#50;          || ptas. horas extra estruc.
    #10#134 = #11#51;          || ptas. horas extra no estruc.
    |SI #11#207 ! 0;     || Cot. Solidaridad
         #10#124 = #10#123; #10#164 = #11#207; #10#162 = (#10#164 / #10#124) * 100;
         taporta = taporta + #10#164; deducir = deducir + #10#164;
    |FINSI;
    |SI #11#209 ! 0;     || Cont. Excluidas
          |HAZ CC_Excluidas;
    |FINSI;
    |SI #labtraba#42 = "e"; #10#123 = #10#131 * 100 / #10#127; |FINSI;
    #10#135 = #11#13;          || (%) I.R.P.F.
    #10#137 = taporta;        || total aportacion
    #10#139 = tantici;        || total anticipos
    #10#140 = #11#54;          || en especie
    #10#141 = deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    #10#150 = "";             || Literal fijo
    |SI #labtraba#247 = 138; #10#150 = "REG. ESP. EMPLEADOS DEL HOGAR"; |FINSI;
    #10#151 = #11#106;         || (%) IRPF 2
    #10#152 = #11#107;         || (%) IRPF 3
    #10#160 = #11#52;          || anticipos 1
    #10#161 = #11#53;          || anticipos 2
    #10#196 = #11#131 + nEmbargo;          || anticipos 3 + embargo
    #10#193 = #11#45;                     || S.S. cargo empresa
    |SI #11#241 < 0; #10#231 = (-1) * #11#241;  |FINSI;            || Preaviso
    |SI #11#242 < 0; #10#232 = (-1) * #11#242;  |FINSI;            || Dto. Vac
|SI #11#49 ! 0;
        |SI apord ! 0; #10#162 = apord;  |FINSI;         || (%) desempleo
        #10#163 = aporfp;          || (%) form.prof.
        |SI apord ! 0; #10#164 = #10#124 % apord;   |FINSI; || desempleo
        |SI #labtraba#190 = "S"; |Y #11#184 ! 0; #10#164 = #11#184; |FINSI;
        #10#165 = #11#49 - #10#164; || ptas. form.prof.
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
              #10#165 = #11#49;
        |FINSI;
|FINSI;

nEmpresa=#11#0; nTrabajador=#11#1; nMes=#11#2; nTipo=#11#3; nAny = #11#66;
|HAZ ComentariosLabempre;

|BUCLE nomhiccaHis;

|| recupero el trabajador en el que estaba
#11#0 = nEmpresa;      || empresa
#11#1 = nTrabajador;   || trabajador
#11#2 = nMes;          || mes
#11#3 = nTipo;         || tipo
#11#66 = nAny;        || ANYO
|LEE 000#11=;
|FPRC;

|PROCESO cargas_1NomHistoImpre;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     descri = #12#08;
     unidad = #12#11;      || unidades calculo
     valor  = #12#10;
     import = unidad * valor;

     incluye = 0;
     concep = #12#4;
     situcon = #12#7;

     |HAZ situacion;

     |SI situac ! 0; |O situcon ! 0;
          |SI concep ] 201; |Y concep [ 208; |Y #12#5 ! "P"; |Y #0#10 = 0;
               |SI swbaja = 1;
                    |SI #2#48 = "S"; |Y #1#25=2; incluye = 1;  |FINSI;  || si es finiquito
               |SINO;
                    |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
               |FINSI;
          |SINO;
               incluye = 1;
          |FINSI;
          |HAZ Dtos;
          |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
          |SI concep = 301; |O concep = 306;
               |SI #nomcontr#37 = "S";
                    incluye = 0;
                    #10#118 = #10#118 + import;
               |FINSI;
          |FINSI;
          |SI incluye = 1;
          || Y situac ! 0;
               lineas = 1;
               camptas = situac + 22;
               camdesc = situac + 61;
               #10camptas = #10camptas + import;
               arteris = descri % 101;
               |SI concep ! 906; |Y concep ! 907; |Y concep ! 926;
                    |SI arteris ! "*";
                         |DDEFECTO #100; #100#0 = #2#87; #100#1 = concep; |LEE 000#100=;
                         alfa1 = #100#2;     |QBF alfa1;
                         |SI alfa1 ! "";
                              descri = alfa1;
                         |FINSI;
                         |HAZ UnidadesConcepto;
                         #10camdesc = descri;
                    |SINO;
                         #10camdesc = "";
                    |FINSI;
               |FINSI;
               |HAZ Ampliada2;
               |SI concep = 101;
                    dcal_101 = #12#05;
                    duni_101 = unidad;
                    dval_101 = valor;
               |FINSI;
               |SI concep = 102;               ||   unidades concepto 102
                    duni_102 = unidad;
               |FINSI;
          |FINSI;
          |HAZ DescAntic;
          |SI concep ] 301; |Y concep [ 305;
               duni_hest = duni_hest + #5#11;
          |FINSI;
          |SI concep ] 306; |Y concep [ 310;
               duni_hnoest = duni_hnoest + #5#11;
          |FINSI;
          |HAZ CrystalDescComp;
     |FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
|FPRC;

|PROCESO cargas_2NomHistoImpre;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#11#33 * 100) $ 100) / 100;
            ||#10#21 = #11#8 - (#11#31 + #11#32 + #11#34 + #11#65 + deci_h + #11#105); ||unid.sal.base
            #10#21 = #11#8 - (#11#31 + #11#32 + #11#34 + #11#65 + #11#105); ||unid.sal.base
    |SINO;
            #10#21 = duni_101;
    |FINSI;
|SINO;
        #10#21 = duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3;          || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#195 = #11#46 - #10#116 + #nomtrnom#193;  || Total Neto + SS Emp
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23 + #10#199;              || t.devengado + s.base + abs
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #11#14 + #11#108 + #11#109;                  || tot.base IRPF
    #10#138 = #11#15 + #11#110 + #11#111;                  || tot.ret. IRPF
    #10#153 = #11#14;                                    || base IRPF 1
    #10#154 = #11#108;                                   || base IRPF 2
    #10#155 = #11#109;                                   || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #11#15;                                    || ret. IRPF 1
    #10#158 = #11#110;                                   || ret. IRPF 2
    #10#159 = #11#111;                                   || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #11#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #11#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #11#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #11#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = duni_hest;
    #10#191 = duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO ordenaNomHistoImpre;
|DDEFECTO #1;
    #1#0 = #11#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #11#0;
    #2#1 = #11#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO comple_3NomHisto;             || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
     nDiasIT = 0;
    tipoit = "";
    desenf = 0;  hasenf = 0;
    desacc = 0;  hasacc = 0;
    swtenf = 0;  swtacc = 0;
|SI #11#27="E"; |O #11#27="M"; |O #11#27="P"; |O #11#27="R";
       desenf=#11#19; hasenf=#11#23; swtenf=1;
    tipoit = #11#27;
|FINSI;
|SI #11#28="E"; |O #11#28="M"; |O #11#28="P"; |O #11#28="R";
    |SI swtenf=0; desenf=#11#20; hasenf=#11#24; swtenf=1; |FINSI;
    tipoit = #11#28;
|FINSI;
|SI #11#29="E"; |O #11#29="M"; |O #11#29="P"; |O #11#29="R";
    |SI swtenf=0; desenf=#11#21; hasenf=#11#25; swtenf=1; |FINSI;
    tipoit = #11#29;
|FINSI;
|SI #11#30="E"; |O #11#30="M"; |O #11#30="P"; |O #11#30="R";
    |SI swtenf=0; desenf=#11#22; hasenf=#11#26; swtenf=1; |FINSI;
    tipoit = #11#30;
|FINSI;
     |SI swtenf = 1;
       |HAZ TipoIT;
     |FINSI;
|SI #11#27="A";              desacc=#11#19; hasacc=#11#23; swtacc=1; |FINSI;
|SI #11#28="A"; |Y swtacc=0; desacc=#11#20; hasacc=#11#24; swtacc=1; |FINSI;
|SI #11#29="A"; |Y swtacc=0; desacc=#11#21; hasacc=#11#25; swtacc=1; |FINSI;
|SI #11#30="A"; |Y swtacc=0; desacc=#11#22; hasacc=#11#26; swtacc=1; |FINSI;
|SI swtacc = 1;|Y #36#19 = "S";
        desacc = desacc - 1;
    |SI desacc < 0;  desacc = 1;  |FINSI;  || por el rollo de las mutuas
|FINSI;
|SI desenf = 0;|Y swtenf = 1;   desenf = 1;    |FINSI;
|SI hasenf = 0;|Y swtenf = 1;   hasenf = #11#7; |FINSI;
|SI desacc = 0;|Y swtacc = 1;   desacc = 1;    |FINSI;
|SI hasacc = 0;|Y swtacc = 1;   hasacc = #11#7; |FINSI;
nDiasIT = #11#31 + #11#32 + #11#65 + #11#105 + #11#33 + #11#34 + #11#173 + #11#236;
|FPRC;

|PROCESO comple_3_1_NomHistoImpre;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
     |HAZ carga_AHV_His; || precarga de Abs, Hue, Vac segun nomabsca, nomabsli
     |PARA para1 = 19; |SI para1 [ 30; |HACIENDO para1 = para1 + 1;
          para2 = para1 + 159;
          |SI para1 [ 26;
               #10para2 = #11para1;
          |SINO;
               tipoit = #11para1;
               |HAZ TipoIT;
               #10para2 = tipoit;
          |FINSI;
     |SIGUE;
     |SI #11#34 ! 0; #10#198 = #11#34; |FINSI; || dias absentismo
     |SI #nomcontr#47 = "C"; |Y #10#198 ! 0; #10#199 = (-1) * #11#147; |FINSI;
|FPRC;

|PROCESO comple_4NomHistoImpre;        || HALLA TOTALES VARIOS
     |SI swComercio = 1;
          |HAZ comple_4NHI_Comercio;
          |ACABA;
     |FINSI;
    tcotiz  = #11#37 + #11#62;
    tbcotiz = tcotiz + #11#38;                || total bases de cotizacion
|SI #11#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19;   ||(%) d+fp
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #11#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #11#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
    |HAZ parcheformacionH;
    taporta = #11#48 + #11#49 + #11#50 + #11#51;           || total aportacion
    tantici = #11#52 + #11#53 + #11#131;         || total anticipos
    nume1   = #11#15 + #11#110 + #11#111;                 || total retenciones
    deducir = taporta + nume1 + tantici + #11#54;       || total a deducir
     |SI #11#241 < 0; deducir = deducir + ((-1) * #11#241);  |FINSI;   || Preaviso
     |SI #11#242 < 0; deducir = deducir + ((-1) * #11#242);  |FINSI;   || Dto.Vac
    nEmbargo = 0;
    |SI #11#146 ! 0;
         |SI #11#47 = 0; |O #1#25 = 2;
              nEmbargo = #11#146;
         |SINO;
              nEmbargo = (#11#146 * (#11#46 / (#11#46 + #11#47))) ! 2;
              |HAZ EmbargoPaga;
         |FINSI;
    |FINSI;
     deducir = deducir + nEmbargo;
|SI swbaja = 0; |Y #1#25 = 2;           || si la paga va junta y no es baja,
        deducir = deducir + #11#17;      || /le suma la parte IRPF de pagas
        tantici = tantici + #11#128;    || y le suma el anticipo Paga Ext(-3-)
        deducir = deducir + #11#128;    || al total anticipos y deducciones
|FINSI;
|FPRC;

|PROCESO comple_5NomHistoImpre;       || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaNomHistoImpre;             || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0;
        diarec = diabaja;
|SINO;
        diarec = diatra;
|FINSI;
    anyrec = anytra;
    mesnum = mestra;
|HAZ lib_0;
    mesrec = mesalf;
|FPRC;

|PROCESO ComenFiniq;
     nNume = #labtraba#45;
     |SI nNume < 300; |O nNume > 399;
          #10#146 = #36#3;
          #10#147 = #36#4;
          #10#148 = #36#5;
          #10#149 = #36#6;
     |SINO;
          #10#146 = #36#66;
          #10#147 = #36#67;
          #10#148 = #36#68;
          #10#149 = #36#69;
     |FINSI;
|FPRC;

|PROCESO comple_6;        || CONSTRUYE COMENTARIO
     sw_comen = 0;

     |SI runnom ! "nomwcalf";|Y #1#39 = "1";
          sw_comen = 1;
     |SINO;
          |SI runnom ! "nomwcalf";|Y #0#10 ! 0;  sw_comen = 1;  |FINSI;
     |FINSI;

     |SI sw_comen = 1;
          alfa1 = #2#49 % 109;
          alfa2 = #2#49 % 101;
          |SI alfa2 = "*";
               |SI coment ! 1;
                    alfa2 = " ";
                    #2#49 = "";
               |FINSI;
          |FINSI;
          |SI alfa1 = "FINIQUITO"; |O alfa2 = "*";
               |HAZ ComenFiniq;
               |SI #10#142 = 0; |Y #0#68 ! "F";
                    alfa1 = #labtraba#0; alfa1 = "00000" + #labtraba#0; alfa1 = alfa1 % -105;
                    alfa2 = #labtraba#1; alfa2 = "00000" + #labtraba#1; alfa2 = alfa2 % -105;
                    aAlfa = alfa1 + "." + alfa2;
                    aAlfa = "    NATENCION: El trabajador " + aAlfa + " tiene el finiquito a cero.";
                    aAlfa = aAlfa + "¿Desea imprimir el texto?";
                    |CONFI aAlfa;
                    |SI FSalida ! 0;
                          #10#146 = ""; #10#147 = ""; #10#148 = ""; #10#149 = "";
                    |FINSI;
               |FINSI;
          |SINO;
               #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
          |FINSI;
     |SINO;
          alfa1 = #2#49 % 101;
          |SI alfa1 = "*";     #2#49 = "";    |FINSI;
          #10#146 = #2#49;      || comentario del fichero en 'carta finiquito'
          #10#147 = ""; #10#148 = ""; #10#149 = "";
     |FINSI;
|FPRC;


|PROCESO sibajaNomHistoImpre;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #11#5 ! "          "; |Y #11#5 ! "..........";
        fectra = #11#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

/*****************************************************************/
/*  ATRASOS-NOMINAS-IMPRESORA                                    */
/*****************************************************************/

|PROCESO equiv;
|MODULO alfa1;
|SI alfa1 = "nomwpara";
        el_66 = 105;
        el_67 = 106;
        el_68 = 107;          || fichero 'nomhicca'
        el_69 = 108;
        el_70 = 109;
        el_71 = 110;
        el_72 = 111;
        el_73 = 112;
        el_74 = 113;
        el_75 = 114;
        el_76 = 117;
        el_77 = 118;
|SINO;
        el_66 = 66;
        el_67 = 67;
        el_68 = 68;           || fichero 'nomcalca'
        el_69 = 69;
        el_70 = 70;
        el_71 = 71;
        el_72 = 72;
        el_73 = 73;
        el_74 = 74;
        el_75 = 75;
        el_76 = 76;
        el_77 = 77;
|FINSI;
|FPRC;

|PROCESO salteadaAtrasos;
|ABRE #13;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
    |PARA mes_i = #0#5; |SI mes_i [ #0#7; |HACIENDO mes_i = mes_i + 1;
            #13#0 = #0salte_1;     || empresa
            #13#1 = #0salte_2;     || trabajador
            #13#2 = mes_i;         || mes
            #13#3 = 5;             || tipo
        |LEE 001#13=;
        |SI FSalida = 0;
               |SI #0#69="I";
                    |HAZ procesoAtrasImpre;
               |FINSI;
               |SI #0#69="A";
                    |HAZ procesoAtrasAb;
               |FINSI;
        |FINSI;
    |SIGUE;
|SIGUE;
|CIERRA #13;
|FPRC;

|PROCESO procesoAtrasImpre;
|SI sw_control = 0; |HAZ control;  sw_control = 1;     |FINSI;
|SI sw_equiv = 0;   |HAZ equiv;    sw_equiv = 1;  |FINSI;

|SI ante_tra=0;  ante_emp = #13#0;  ante_tra = #13#1;  |FINSI;
|SI #0#10 = 2;
    |SI ante_tra ! #13#1; |O ante_emp ! #13#0;
        |SI lineas = 1;
               nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion)
               |SI swPDFMasivo = 1;
                    |HAZ PreparaPDF;
               |SINO;
                     |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                         |HAZ comple_6AtrasImpre;
                     |SIGUE;
               |FINSI;
               |DDEFECTO #10;
        |FINSI;
        swPrimerMes = 0;
    |FINSI;
|FINSI;
    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
nEmp = #nomcalac#0; nTra = #nomcalac#1;
|HAZ comple_0;             || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
     |ACABA;
|FINSI;
nContrato = #13#9;
|HAZ comple_1;   || construye literales datos empresa
|HAZ comple_2AtrasImpre;   || construye periodo de liquidacion nomina
|HAZ comple_3AtrasImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_AtrasImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4AtrasImpre;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5AtrasImpre;   || construye fecha firma
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1AtrasImpre#13;   || carga campos lineas calculos
    ante_emp = #13#0;
    ante_tra = #13#1;
|SI lineas = 1;
        seleccio = 1;    || para saber si se ha leido algo
    |HAZ cargas_0AtrasImpre;       || carga campos cabecera calculos
    |HAZ cargas_2AtrasImpre;       || carga campos totales
    |HAZ ImpCrystal;
    |SI #0#10 = 1;
          |SI swPDFMasivo = 1;
               |HAZ PreparaPDF;
          |SINO;
               ||SI #0#67="A"; |Y #0#68="N"; |Y #0#69="P";
                    ||HAZ comple_6AtrasPan;
               ||SINO;
                    nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion)
                    |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                         |HAZ comple_6AtrasImpre;
                    |SIGUE;
                    |DDEFECTO #10;
               ||FINSI;
          |FINSI;
    |SINO;
        guarda_emp = #2#0;    || guarda
        guarda_cen = #2#77;   || las guarda porque en
        guarda_are = #2#62;
        guarda_sec = #2#63;
    |FINSI;
|FINSI;
|FPRC;


|PROCESO cargas_0AtrasImpre;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq1;        || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq2;        || hasta el mes
    #10#18 = #13#184;          || a¤o confeccion
/*
    #10#18 = #0#04;          || a¤o confeccion
    |SI #13#184 ! 0;
         #10#18 = #13#184;          || a¤o confeccion
    |FINSI;
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
*/
|SI #2#42 ! "E";|Y #2#42 ! "e";
        #10#19 = #10#19 + #13#08;          || total dias liquidacion
          |SI swModulo = 2884;
               |SI #2#42 = "C"; |O #2#42 = "F"; #10#19 = #10#19 + #13#10; |FINSI;
          |FINSI;
|SINO;
        #10#19 = #10#19 + #13#11;          || total jornadas (AGRARIA*)
|FINSI;
    #10#103 = #10#103 + #13#57;          || ptas. enfermedad
    #10#104 = #10#104 + #13#58;          || ptas. accidente
|SI #0#10 = 1;
        #10#105 = desenf;         || del dia enfermedad
        #10#106 = hasenf;         || al dia enfermedad
        #10#107 = desacc;         || del dia accidente
        #10#108 = hasacc;         || al dia accidente
|SINO;
        #10#105 = 0; #10#106 = 0; #10#107 = 0; #10#108 = 0;
|FINSI;
    #10#119 = #10#119 + tcotiz;         || base cotizacion
    #10#120 = #10#120 + #13#38;          || base prorratas
    #10#121 = #10#121 + tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #10#123 + #13#39;          || base contingencias comunes
    #10#124 = #10#124 + #13#40;          || base D+P+F
    #10#125 = #10#125 + #13#41;          || base horas extra estruc.
    #10#126 = #10#126 + #13#42;          || base horas extra no estruc.
    #10#127 = #13#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+f+p
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #10#131 + #13#48;          || ptas. contingencias comunes
    #10#132 = #10#132 + #13#49;          || ptas. d+f+p
    #10#133 = #10#133 + #13#50;          || ptas. horas extra estruc.
    #10#134 = #10#134 + #13#51;          || ptas. horas extra no estruc.
    #10#135 = #13#13;          || (%) I.R.P.F.
    #10#137 = #10#137 + taporta;        || total aportacion
    #10#139 = #10#139 + tantici;        || total anticipos
    #10#140 = #10#140 + #13#54;          || en especie
    #10#141 = #10#141 + deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    aTipoIT = "53"; |HAZ LiteralIT;
    #10#150 = aValor;                || Literal fijo
    #10#151 = #13el_67;                  || (%) IRPF 2
    #10#152 = #13el_68;                  || (%) IRPF 3
    #10#160 = #10#160 + #13#52;          || anticipos 1
    #10#161 = #10#161 + #13#53;          || anticipos 2
    #10#196 = #10#196 + #13#89;          || anticipos 3
    #10#193 = #10#193 + #13#45;          || S.S. cargo empresa
|SI #13#49 ! 0;
        |SI apord ! 0; #10#162 = apord; |FINSI;           || (%) desempleo
        #10#163 = aporfp;                                   || (%) form.prof.
        #10#164 = #10#164 + ((#13#40 % apord) ! EURODB);            || ptas. desempleo
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
             #10#165 = #10#165 + #13#49; || ptas. form.prof.
        |SINO;
             #10#165 = #10#165 + (#13#49 - ((#13#40 % apord) ! EURODB)); || ptas. form.prof.
        |FINSI;
|FINSI;
    #10#206 = #10#124;                  || base FP
    el_a00 = el_a00 + #13#45;            || seg.social a cgo.empresa
    el_a31 = el_a31 + #13#52;            || anticipos 1
    el_a32 = el_a32 + #13#53;            || anticipos 2
    el_a35 = el_a35 + #13#89;            || anticipos 3
    el_a33 = el_a33 + #13#17;            || cuota IRPF pagas
    el_a34 = el_a34 + #13#16;            || base IRPF pagas

nEmpresa=#13#0;   || empresa
nTrabajador=#13#1;   || trabajador
nMes=#13#2;   || mes
nTipo=#13#3;   || tipo
|HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1AtrasImpre;       || CARGA LOS CAMPOS SEGUN SU SITUACION
    descri = #14#08;
    unidad = #14#11;      || unidades calculo
    valor  = #14#10;
    import = unidad * valor;

     incluye = 0;
     concep = #14#4;
     situcon = #14#7;

     |HAZ situacion;

|SI situac ! 0; |O situcon ! 0;
    |SI concep ] 201; |Y concep [ 208; |Y #14#5 ! "P";
        |SI runnom ! "nomypara";|Y runnom ! "nomwpara";
            |SI swbaja = 1;
                |SI #2#48 = "S"; |Y #1#25=2;  incluye = 1;  |FINSI;  || si es finiquito
            |SINO;
                |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
            |FINSI;
        |SINO;
                incluye = 1;
        |FINSI;
    |SINO;
            incluye = 1;
    |FINSI;
    |HAZ Dtos;
          |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
          |SI concep = 301; |O concep = 306;
               |SI #nomcontr#37 = "S";
                    incluye = 0;
                    #10#118 = #10#118 + import;
               |FINSI;
          |FINSI;
    |SI incluye = 1;
            lineas = 1;
            camptas = situac + 22;
            camdesc = situac + 61;
            #10camptas = #10camptas + import;
            arteris = descri % 101;
        |SI arteris ! "*";
            |DDEFECTO #100; #100#0 = #2#87; #100#1 = concep; |LEE 000#100=;
            alfa1 = #100#2;     |QBF alfa1;
            |SI alfa1 ! "";
                    descri = alfa1;
            |FINSI;
            |HAZ UnidadesConcepto;
            #10camdesc = descri;
        |SINO;
                #10camdesc = "";
        |FINSI;
        |HAZ Ampliada2;
        |SI concep = 101;
                dcal_101 = #14#05;
                duni_101 = unidad;
                dval_101 = valor;
        |FINSI;
        |SI concep = 102;               ||   unidades concepto 102
                duni_102 = unidad;
        |FINSI;
|FINSI;
        |SI concep ] 301; |Y concep [ 305;
            duni_hest = duni_hest + #5#11;
        |FINSI;
        |SI concep ] 306; |Y concep [ 310;
            duni_hnoest = duni_hnoest + #5#11;
        |FINSI;
    |FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
|FPRC;

|PROCESO cargas_2AtrasImpre;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#13#33 * 100) $ 100) / 100;
            ||#10#21 = #10#21 + (#13#8-(#13#31+#13#32+#13#34+#13#65+deci_h+#13#66)); ||unid.sal.base
            || #10#21 = #10#21 + (#13#8-(#13#31+#13#32+#13#34+#13#65+#13#66)); ||unid.sal.base
            #10#21 = #10#21 + (#13#8-(#13#31+#13#32+#13#34+#13#65)); ||unid.sal.base
            || quito lo de que en las unid. sal base se descuenten las vacaciones
            || no tiene por que y da problemas 001156.01116
    |SINO;
            #10#21 = #10#21 + duni_101;
    |FINSI;
|SINO;
        #10#21 = #10#21 + duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3; |Y #0#10 ! 2;   || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 109; |SI campo [ 115; |HACIENDO campo = campo + 1;
    #10campo = 0;    || vacia los totales, porque acumula en conceptos
|SIGUE;
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#195 = #10#195 + (#13#46 - #10#116 + #nomtrnom#193);  || Total Neto + SS Emp
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
    #10#118 = 0;
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23 + #10#199;              || t.devengado + s.base + abs
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #10#136 + (#13#14 + #13el_69 + #13el_70);    || tot.base IRPF
    #10#138 = #10#138 + (#13#15 + #13el_71 + #13el_72);    || tot.ret. IRPF
    #10#153 = #10#153 + #13#14;                          || base IRPF 1
    #10#154 = #10#154 + #13el_69;                        || base IRPF 2
    #10#155 = #10#155 + #13el_70;                        || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #10#157 + #13#15;                          || ret. IRPF 1
    #10#158 = #10#158 + #13el_71;                        || ret. IRPF 2
    #10#159 = #10#159 + #13el_72;                        || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #13#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #13#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #13#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #13#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = #10#190 + duni_hest;
    #10#191 = #10#191 + duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO ordenaAtrasImpre;
|DDEFECTO #1;
    #1#0 = #13#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #13#0;
    #2#1 = #13#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO comple_2AtrasImpre;        || CONSTRUYE PERIODO DE LIQUIDACION
|SI #0#10 = 2;
        mesnum = #0#5;
|SINO;
        mesnum = #13#2;
        |HAZ lib_0;
        mesliq1 = mesalf;
        |HAZ lib_0;
        mesliq2 = mesalf;
|FINSI;
|SI #0#10 = 2;
     |SI swPrimerMes = 0;
          mesnum = #13#2;
          swPrimerMes = 1;
          |HAZ lib_0;
          desdia = 1;
          mesliq1 = mesalf;
     |FINSI;
     mesnum = #13#2;
     |HAZ lib_0;
     hasdia = topemes;
     mesliq2 = mesalf;
|FINSI;
    anytra = #0#4;
|HAZ lib_0;             || saca ultimo dia natural del mes desde !!!
    ||mesliq1 = mesalf;
    ||mesliq2 = mesalf;

|SI #0#10 = 2;           || si tiene que refundir
        mesnum = #0#7;
        anytra = #0#4;
    |HAZ lib_0;         || saca ultimo dia natural del mes hasta !!!
    ||mesliq2 = mesalf;
|FINSI;

    fectra = #13#4;      || desglosa fecha de alta
|HAZ lib_1;
    diaalta = diatra;
    mesalta = mestra;
|SI #0#10 = 2;
    |SI mesalta ] #0#5; |Y anytra = #0#4;  || si es alta este mes
            desdia = diaalta;
            mesnum = mesalta;
            anytra = #0#4;
        |HAZ lib_0;
            mesliq1 = mesalf;
    |SINO;
            desdia = 1;
    |FINSI;
|SINO;
    |SI mesalta = #13#2; |Y anytra = #0#4;  || si es alta este mes
            desdia = diaalta;
    |SINO;
            desdia = 1;
    |FINSI;
|FINSI;

    fectra = #13#5;      || desglosa fecha de baja
|HAZ lib_1;
    diabaja = diatra;
    mesbaja = mestra;
|SI #0#10 = 2;
    |SI mesbaja [ #0#7; |Y mesbaja ! 0; |Y anytra = #0#4; || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
            mesnum = mesbaja;
            anytra = #0#4;
        |HAZ lib_0;
            mesliq2 = mesalf;
    |SINO;
            ||mesnum = #0#7;
            ||anytra = #0#4;
            ||HAZ lib_0;
            ||hasdia = topemes;
    |FINSI;
|SINO;
    |SI mesbaja = #13#2; |Y anytra = #0#4;  || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
    |SINO;
            hasdia = topemes;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_3AtrasImpre;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
    tipoit = "";
    desenf = 0;  hasenf = 0;
    desacc = 0;  hasacc = 0;
    swtenf = 0;  swtacc = 0;
|SI #13#27="E"; |O #13#27="M"; |O #13#27="P"; |O #13#27="R";
       desenf=#13#19; hasenf=#13#23; swtenf=1;
    tipoit = #13#27;
|FINSI;
|SI #13#28="E"; |O #13#28="M"; |O #13#28="P"; |O #13#28="R";
    |SI swtenf=0; desenf=#13#20; hasenf=#13#24; swtenf=1; |FINSI;
    tipoit = #13#28;
|FINSI;
|SI #13#29="E"; |O #13#29="M"; |O #13#29="P"; |O #13#29="R";
    |SI swtenf=0; desenf=#13#21; hasenf=#13#25; swtenf=1; |FINSI;
    tipoit = #13#29;
|FINSI;
|SI #13#30="E"; |O #13#30="M"; |O #13#30="P"; |O #13#30="R";
    |SI swtenf=0; desenf=#13#22; hasenf=#13#26; swtenf=1; |FINSI;
    tipoit = #13#30;
|FINSI;
     |SI swtenf = 1;
       |HAZ TipoIT;
     |FINSI;
|SI #13#27="A";              desacc=#13#19; hasacc=#13#23; swtacc=1; |FINSI;
|SI #13#28="A"; |Y swtacc=0; desacc=#13#20; hasacc=#13#24; swtacc=1; |FINSI;
|SI #13#29="A"; |Y swtacc=0; desacc=#13#21; hasacc=#13#25; swtacc=1; |FINSI;
|SI #13#30="A"; |Y swtacc=0; desacc=#13#22; hasacc=#13#26; swtacc=1; |FINSI;
|SI swtacc = 1;|Y #36#19 = "S";
        desacc = desacc - 1;
    |SI desacc < 0;  desacc = 1;  |FINSI;  || por el rollo de las mutuas
|FINSI;
|SI desenf = 0;|Y swtenf = 1;   desenf = 1;    |FINSI;
|SI hasenf = 0;|Y swtenf = 1;   hasenf = #13#7; |FINSI;
|SI desacc = 0;|Y swtacc = 1;   desacc = 1;    |FINSI;
|SI hasacc = 0;|Y swtacc = 1;   hasacc = #13#7; |FINSI;
|FPRC;

|PROCESO comple_3_1_AtrasImpre;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
     |PARA para1 = 19; |SI para1 [ 30; |HACIENDO para1 = para1 + 1;
          para2 = para1 + 159;
          |SI para1 [ 26;
               #10para2 = #13para1;
          |SINO;
               tipoit = #13para1;
               |HAZ TipoIT;
               #10para2 = tipoit;
          |FINSI;
     |SIGUE;
     |SI #13#34 ! 0; #10#198 = #13#34; |FINSI; || dias absentismo
|FPRC;

|PROCESO comple_4AtrasImpre;        || HALLA TOTALES VARIOS
    tcotiz  = #13#37 + #13#62;
    tbcotiz = tcotiz + #13#38;         || total bases de cotizacion
|SI #13#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19;   ||(%) d+f+p
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #13#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #13#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
    taporta = #13#48 + #13#49 + #13#50 + #13#51;         || total aportacion
    tantici = #13#52 + #13#53 + #13#89;                  || total anticipos
    deducir = taporta + #13el_75 + tantici + #13#54;     || total a deducir

|SI runnom ! "nomypara";|Y runnom ! "nomwpara";
    |SI swbaja = 0; |Y #1#25 = 2;       || si la paga va junta y no es baja,
            deducir = deducir + #13#17;  || /le suma la parte IRPF de pagas
    |FINSI;
|SINO;
        deducir = deducir + #13#17;      || pagas juntas en parametrizados
|FINSI;
|FPRC;

|PROCESO comple_5AtrasImpre;        || CONSTRUYE FECHA LITERAL DEL RECIBI
     |HAZ sibajaAtrasImpre;              || (tiene en cuenta si el trabajador es baja)
     fectra = #0#6;
     |HAZ lib_1;
     diarec = diatra;
     anyrec = anytra;
     mesnum = mestra;
     |HAZ lib_0;
     mesrec = mesalf;
|FPRC;


|PROCESO sibajaAtrasImpre;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #13#5 ! "          "; |Y #13#5 ! "..........";
        fectra = #13#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomsreci0;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, procesoAtrasImpre;
|FIN;

|DEFBUCLE EmpTraAtrasImpre;   || por nombre empresa, codigo trabajador
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasImpre, NULL, NULL, NULL, procesoAtrasImpre;
     #1#2, #2#0, #2#1;
|FIN;

|DEFBUCLE nombresAtrasImpre;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasImpre, NULL, NULL, NULL, procesoAtrasImpre;
     #2#0, #2#2, #2#1;
|FIN;

|DEFBUCLE areasAtrasImpre;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasImpre, NULL, NULL, NULL, procesoAtrasImpre;
     #2#0, #2#62, #2#63, #2#1;
|FIN;

|DEFBUCLE centrosAtrasImpre;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasImpre, NULL, NULL, NULL, procesoAtrasImpre;
     #2#0, #2#77, #2#1;
|FIN;

|DEFBUCLE tc2AtrasImpre;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasImpre, NULL, NULL, NULL, procesoAtrasImpre;
     #2#0, #0#64, #102#142, #2#75, #2#1, #13#2;
|FIN;

|PROCESO comple_6AtrasImpre;    || imprime y limpia
|HAZ imprime;
|SI #0#10 ! 2;
     |DDEFECTO #10;
|FINSI;
|FPRC;

|PROCESO impreAI2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomsreci0;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresAtrasImpre;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasAtrasImpre;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosAtrasImpre;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2AtrasImpre;         |FINSI;
     |SI #0#63 = 6;    |BUCLE EmpTraAtrasImpre;     |FINSI;
|FPRC;

|DEFBUCLE AIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreAI2;
|FIN;

|PROCESO AIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE AIGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreAI; |TIPO 3;
     c_informe = "nomyreci";
|HAZ cuadres;
|SI sw_cuadre = 0;
    ||HAZ ElINFOR;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
            seleccio = 0;
        |SI #0#21 = 0;
            |HAZ equiv;
            |SI #0#70 = 0;
                |HAZ impreAI2;
            |SINO;
                |HAZ AIPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaAtrasos;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |SINO;
            |SI #0#10 = 2;
                |SI lineas = 1;
                    nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion)
                    |SI swPDFMasivo = 1;
                         |HAZ PreparaPDF;
                    |SINO;
                         |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                             |HAZ comple_6AtrasImpre;
                         |SIGUE;
                    |FINSI;
                    |DDEFECTO #10;
                |FINSI;
            |FINSI;
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
|FINSI;
|FPRC;

/*****************************************************************/
/*  MENSUAL-NOMINAS-ABIERTA                                      */
/*****************************************************************/

|PROCESO procesoNomMensuAb;
     nEmp = #nomcalca#0;      || busco si el trabajador tiene incidencias por
     nTra = #nomcalca#1;      || resolver, si es asi swStop no se devolvera
     |HAZ IncidIRPF;          || a cero y ya tendre al menos un trabajador
                              || no emitido por esta causa, mostrare aviso
     |SI swStop ! 0;
          nTraNoEmi = nTraNoEmi + 1;
          |ACABA;
     |FINSI;

     seleccio = 1;   || para saber si se ha leido algo
     lineas = 0;     || para saber si los conceptos leidos son buenos
     swbaja = 0;
     coment = 0;
     |DDEFECTO #10;
     |DDEFECTO #15;
     nEmp = #nomcalca#0; nTra = #nomcalca#1;
     |HAZ comple_0;             || lee empresa, trabajador y constante
     |HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
     |SI #0#10 = 2;|Y #1#39 = 3;
          |ACABA;              || si es finiquito separado por carta
     |FINSI;
     |SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
          |ACABA;
     |FINSI;
     nContrato = #4#9;
     |HAZ comple_1;             || construye literales datos empresa
     |HAZ comple_2;             || construye periodo de liquidacion nomina
     |HAZ comple_3NomMensu;     || construye periodo de liquidacion de enferm. y accte.
     |HAZ comple_3_1_NomMensuImpre;   || construye periodo de liquidacion de enferm. y accte.
     |HAZ comple_4NomMensuAb;   || halla totales varios
     |HAZ SS_Empresa;
     |HAZ comple_5NomMensuAb;   || construye fecha firma
     |HAZ comple_6Abierta;   || construye el comentario
     |HAZ cargas_0NomMensuAb;           || carga campos cabecera calculos
     |HAZ BuscaBanco;
     situac = 0; situac_ult = 0;
     aNormal = ""; aAgrupa = "";
     |BUCLELIN 0cargas_1NomMensuAb#4;   || carga campos lineas calculos
     |SI lineas = 1;
          |HAZ cargas_2NomMensuAb;           || carga campos totales
          |SI nOpcion = 2;
               |HAZ IMPREArchi;
          |SINO;
               |INFOR "nomyabie";
          |FINSI;
          alguno = 0; ninguno = 0; situac2 = 0;
          |PARA situac = 1; |SI situac [ 39; |HACIENDO situac = situac + 1;
               camctos = situac + 116;  infctos = #15camctos;
               camptas = situac + 22;   infptas = #10camptas;
               camdesc = situac + 77;   infdesc = #15camdesc;
               camunid = situac -  1;   infunid = #15camunid;
               camvalo = situac + 38;   infvalo = #15camvalo;
               camunia = situac + 155;  infunia = #15camunia;
               |HAZ Cotizaciones;
               retoded = "R";
               |SI infptas ! 0;
                    alguno = 1;
                    ninguno = ninguno + 1;
                    |PRINT;
                    |SI ninguno = 15;
                         situac2 = situac + 1;
                         situac = 39;
                    |FINSI;
               |FINSI;
          |SIGUE;
          linea16 = 0;
          |SI situac2 ! 0;
               |PARA situac=situac2;|SI situac[39; |HACIENDO situac=situac+1;
                    camctos = situac + 116;  infctos = #15camctos;
                    camptas = situac + 22;   infptas = #10camptas;
                    camdesc = situac + 77;   infdesc = #15camdesc;
                    camunid = situac -  1;   infunid = #15camunid;
                    camvalo = situac + 38;   infvalo = #15camvalo;
                    camunia = situac + 155;  infunia = #15camunia;
                    linea16 = linea16 + infptas;
               |SIGUE;
               |SI linea16 ! 0;
                    alguno = 1;
                    infctos = 0;
                    infptas = linea16;
                    infdesc = "GLOBAL VARIOS ...";
                    infunid = 1;
                    infunia = 1;
                    infvalo = 1;
                    |PRINT;
               |FINSI;
          |FINSI;
          |HAZ LineasDto;
          aAlfa = Impresora; |QBF aAlfa; aAlfa = aAlfa % 113;
          |SI alguno = 1; |O aAlfa = "CrystalReport";
               |SI Impresora = "CrystalReport";
                    |HAZ imprime;
               |SINO;
                    |PIEINF;
                    |HAZ ElFININF;
               |FINSI;
          |SINO;
               |SI #10#119 ! 0;
                    infctos = 0;
                    infptas = 0;
                    infdesc = "-------------------------";
                    infunid = 0;
                    infunia = 0;
                    infvalo = 0;
                    |PRINT;
                    |HAZ imprime;
                    ||PIEINF;
               |SINO;
                    |HAZ ElFININF;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomyreci0Abierta;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, procesoNomMensuAb;
|FIN;

|PROCESO ordenaNomMensuAb;
|DDEFECTO #1;
    #1#0 = #4#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #4#0;
    #2#1 = #4#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|DEFBUCLE nombresNomMensuAb;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuAb, NULL, NULL, NULL, procesoNomMensuAb;
 #2#0, #2#2, #2#1, #4#3;
|FIN;

|DEFBUCLE areasNomMensuAb;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuAb, NULL, NULL, NULL, procesoNomMensuAb;
 #2#0, #2#62, #2#63, #2#1, #4#3;
|FIN;

|DEFBUCLE centrosNomMensuAb;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuAb, NULL, NULL, NULL, procesoNomMensuAb;
 #2#0, #2#77, #2#1, #4#3;
|FIN;

|DEFBUCLE tc2NomMensuAb;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#5, #0#10;
 ;
 NULL, ordenaNomMensuAb, NULL, NULL, NULL, procesoNomMensuAb;
 #2#0, #0#64, #102#142, #2#75, #2#1, #4#3;
|FIN;

|PROCESO impreMNA2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomyreci0Abierta;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresNomMensuAb;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasNomMensuAb;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosNomMensuAb;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2NomMensuAb;         |FINSI;
|FPRC;

|DEFBUCLE MNAGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreMNA2;
|FIN;

|PROCESO MNAPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE MNAGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreMNA; |TIPO 3;
     swStopIRPF = 0;
     |HAZ nomgir00;
     nTraNoEmi = 0;
     swHayIncid = 0;
     aOrden = #0#63;
     |DDEFECTO #nomgirco;
     |ABRE #nomgirco; |LEE 000#nomgirco.p;  |CIERRA #nomgirco;

     c_informe = "nomyabie";
     |HAZ cuadres;
     |SI sw_cuadre = 0; |Y swStopIRPF = 0;
          |ABRE #1;
          |ABRE #2;
          |ABRE #3;
          |ABRE #6;
          |ABRE #35;
          |ABRE #100;
          |ABRE #102;
          |HAZ BuscaModulo;
          |HAZ ElIMPRE;
          |SI FEstado = 0;
               |HAZ control;
               seleccio = 0;
               |SI #0#21 = 0;
                    |SI #0#70 = 0;
                         |HAZ impreMNA2;
                    |SINO;
                         |HAZ MNAPorGrupos;
                    |FINSI;
               |SINO;
                    |HAZ salteadaMensualNomFin;
               |FINSI;
               |SI seleccio = 0;
                    |MENAV "    Seleccion vacia ...";
               |FINSI;
         |SINO;
               |MENAV "    Proceso ABORTADO !!!";
         |FINSI;
         |HAZ ElFINIMP;
         |SI swStopIRPF = 0;
              |HAZ AvisoIRPF;
         |FINSI;
         |CIERRA #1;
         |CIERRA #2;
         |CIERRA #3;
         |CIERRA #6;
         |CIERRA #35;
         |CIERRA #100;
         |CIERRA #102;
     |FINSI;
|FPRC;

|PROCESO cargas_0NomMensuAb;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS (no todos !!!)
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa (*)
    #10#005 = pobemp;         || poblacion empresa (*)
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa (*)
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq;         || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
|SI #2#42 ! "E";|Y #2#42 ! "e";
        #10#19 = #4#08;          || total dias liquidacion
|SINO;
        #10#19 = #4#11 + #4#55;          || total jornadas (AGRARIA*)
|FINSI;
    #10#205 = #4#55;          || jornadas en IT agrarios
    #10#207 = #4#11;          || jornadas en IT agrarios
    #10#103 = #4#57;          || ptas. enfermedad
    #10#104 = #4#58;          || ptas. accidente
    #10#105 = desenf;         || del dia enfermedad
    #10#106 = hasenf;         || al dia enfermedad
    #10#107 = desacc;         || del dia accidente
    #10#108 = hasacc;         || al dia accidente
    #10#119 = tcotiz;         || base cotizacion
    #10#120 = #4#38;          || base prorratas
    #10#121 = tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #4#39 - #4#115;          || base contingencias comunes
    #10#124 = #4#40 - #4#134;          || base D+P+F
    |SI #10#123 < 0; #10#123 = 0; |FINSI; |SI #10#124 < 0; #10#124 = 0; |FINSI;
    #10#125 = #4#41;          || base horas extra estruc.
    #10#126 = #4#42;          || base horas extra no estruc.
    #10#127 = #4#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+f+p
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #4#48;          || ptas. contingencias comunes
    #10#132 = #4#49;          || ptas. d+f+p
    #10#133 = #4#50;          || ptas. horas extra estruc.
    #10#134 = #4#51;          || ptas. horas extra no estruc.
    |SI #labtraba#42 = "e"; #10#123 = #10#131 * 100 / #10#127; |FINSI;
    #10#135 = #4#13;          || (%) I.R.P.F.
    #10#137 = taporta;        || total aportacion
    #10#139 = tantici;        || total anticipos
    #10#140 = #4#54;          || en especie
    |SI #4#165 ! 0;     || Cot. Solidaridad
         #10#124 = #10#123; #10#164 = #4#165; #10#162 = (#10#164 / #10#124) * 100;
         taporta = taporta + #10#164; deducir = deducir + #10#164;
    |FINSI;
    #10#141 = deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    #10#150 = "";             || Literal fijo
    |SI #labtraba#247 = 138;
        aTipoIT = "55"; |HAZ LiteralIT;
        #10#150 = aValor;
    |FINSI;
    #10#151 = #4#67;          || (%) IRPF 2
    #10#152 = #4#68;          || (%) IRPF 3
    #10#160 = #4#52;          || anticipos 1
    #10#161 = #4#53;          || anticipos 2
    #10#196 = #4#89;          || anticipos 3
    #10#193 = #4#45;          || S.S. cgo. empresa
|SI #4#49 ! 0;
        |SI apord ! 0; #10#162 = apord; |FINSI;          || (%) desempleo
        #10#163 = aporfp;          || (%) form.prof.
        |SI apord ! 0; #10#164 = #10#124 % apord; |FINSI;  || desempleo
        |SI #labtraba#190 = "S"; |Y #4#142 ! 0; #10#164 = #4#142; |FINSI;
        #10#165 = #4#49 - #10#164; || ptas. form.prof.
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
             #10#165 = #4#49;
        |FINSI;   || ptas. form.prof.
|FINSI;

nEmpresa=#4#0;   || empresa
nTrabajador=#4#1;   || trabajador
nMes=#4#2;   || mes
nTipo=#4#3;   || tipo
|HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1NomMensuAb;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     incluye = 0;
     concep = #5#4;
     situcon = #5#7;
     |HAZ situacion;
     descri = #5#08;
     unidad = #5#11;      || unidades calculo
     uniant = #5#09;      || unidades anteriores
     valor  = #5#10;
     import = unidad * valor;
     |SI concep ] 951; |Y concep [ 960; situac = 0; situcon = 0; |FINSI;
     |SI situac ! 0; |O situcon ! 0;
          |SI concep ] 201; |Y concep [ 208; |Y #5#5 ! "P"; |Y #0#10 = 0;
               |SI swbaja = 1;
                    |SI #2#48 = "S"; |Y #1#25=2;  incluye = 1;  |FINSI;  || si es finiquito
               |SINO;
                    |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
               |FINSI;
          |SINO;
               incluye = 1;
          |FINSI;
          |HAZ Dtos;
          |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
          |SI incluye = 1;
               lineas = 1;
               |HAZ leedescriNomMensuAb;

               camctos = situac + 116;
               camptas = situac + 22;
               camdesc = situac + 77;
               camunid = situac -  1;
               camvalo = situac + 38;
               camunia = situac + 155;
               #15camctos = concep;
               aAlfa = #100#2; |QBF aAlfa;
               |SI aAlfa ! "";
                    #15camdesc = #100#2;                      || descripcion ampliada
               |FINSI;
               |HAZ Ampliada2;
               #10camptas = #10camptas + import;        || devengado
               |SI concep = 515;
                    #15camunia = 0;
                    #15camunid = 0;        || unidades cero en ENF.EMP.
                    #15camvalo = #4#35;    || promedio de enfermedad en ENF.EMP.
               |SINO;
                    #15camunia = #15camunia + uniant;        || unidades anterior
                    #15camunid = #15camunid + unidad;        || unidades
                    #15camvalo = #10camptas / #15camunid;    || valor base
               |FINSI;
               |SI concep = 101;
                    dcal_101 = #5#05;
                    duni_101 = unidad;
                    dval_101 = valor;
               |FINSI;
               |SI concep = 102;               ||   unidades concepto 102
                    duni_102 = unidad;
               |FINSI;
               |SI concep ] 301; |Y concep [ 305;
                    duni_hest = duni_hest + #5#11;
               |FINSI;
               |SI concep ] 306; |Y concep [ 310;
                    duni_hnoest = duni_hnoest + #5#11;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
     |SI concep = 906; |O concep = 907; |O concep = 926;
          |HAZ DescAntic;
     |FINSI;
|FPRC;

|PROCESO cargas_2NomMensuAb;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#4#33 * 100) $ 100) / 100;
            ||#10#21 = #4#8 - (#4#31 + #4#32 + #4#34 + #4#65 + deci_h + #4#66); ||unid.sal.base
            #10#21 = #4#8 - (#4#31 + #4#32 + #4#34 + #4#65 + #4#66); ||unid.sal.base
    |SINO;
            #10#21 = duni_101;
    |FINSI;
|SINO;
        #10#21 = duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3;          || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#195 = (#4#46 - #10#116 + #nomtrnom#193);  || Total Neto + SS Emp
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado+s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir
    #10#136 = #4#14 + #4#69 + #4#70;                    || tot.base IRPF
    #10#138 = #4#15 + #4#71 + #4#72;                    || tot.ret. IRPF
    #10#153 = #4#14;                                    || base IRPF 1
    #10#154 = #4#69;                                    || base IRPF 2
    #10#155 = #4#70;                                    || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #4#15;                                    || ret. IRPF 1
    #10#158 = #4#71;                                    || ret. IRPF 2
    #10#159 = #4#72;                                    || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #4#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #4#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #4#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #4#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = duni_hest;
    #10#191 = duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_4NomMensuAb;        || HALLA TOTALES VARIOS
    tcotiz  = #4#37 + #4#62;
    tbcotiz = tcotiz + #4#38;         || total bases de cotizacion
|SI #4#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19; ||(%) d+f+p
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #4#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #4#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
     |HAZ parcheformacionM;
    taporta = #4#48 + #4#49 + #4#50 + #4#51;      || total aportacion
    tantici = #4#52 + #4#53 + #4#89;      || total anticipos
    deducir = taporta + #4#75 + tantici + #4#54;  || total a deducir
|SI swbaja = 0; |Y #1#25 = 2;         || si la paga va junta y no es baja,
        deducir = deducir + #4#17;    || /le suma la parte IRPF de pagas
        tantici = tantici + #4#86;    || y le suma el anticipo Paga Ext(-3-)
        deducir = deducir + #4#86;    || al total anticipos y deducciones
|FINSI;
     nEmbargo = 0;
     |SI #4#104 ! 0;
          |SI #4#47 = 0; |O #1#25 = 2;
               nEmbargo = #4#104;
          |SINO;
               nEmbargo = (#4#104 * (#4#46 / (#4#46 + #4#47))) ! 2;
               |HAZ EmbargoPaga;
          |FINSI;
     |FINSI;
     deducir = deducir + nEmbargo;
|FPRC;

|PROCESO comple_5NomMensuAb;        || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaNomMensuAb;              || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0;
        diarec = diabaja;
|SINO;
        diarec = diatra;
|FINSI;
    anyrec = anytra;
    mesnum = mestra;
|HAZ lib_0;
    mesrec = mesalf;
|FPRC;

|PROCESO sibajaNomMensuAb;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #4#5 ! "          "; |Y #4#5 ! "..........";
        fectra = #4#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_6Abierta;        || CONSTRUYE COMENTARIO
    sw_comen = 0;

|SI #0#10 = 2;|O #1#39 = "1";
        sw_comen = 1;
|FINSI;

|SI sw_comen = 1;
        alfa1 = #2#49 % 109;
        alfa2 = #2#49 % 101;
    |SI alfa2 = "*";
        |SI coment ! 1;
                alfa2 = " ";
                #2#49 = "";
        |FINSI;
    |FINSI;
    |SI alfa1 = "FINIQUITO"; |O alfa2 = "*";
          |HAZ ComenFiniq;
    |SINO;
           #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
    |FINSI;
|SINO;
        alfa1 = #2#49 % 101;
    |SI alfa1 = "*";     #2#49 = "";    |FINSI;
        #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
|FINSI;
|FPRC;

/*****************************************************************/
/*  HISTORICO-NOMINAS-ABIERTA                                    */
/*****************************************************************/

|PROCESO procesoNomHistoAb;
    seleccio = 1;   || para saber si se ha leido algo
    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
    coment = 0;
|DDEFECTO #10;
|DDEFECTO #15;
nEmp = #nomhicca#0; nTra = #nomhicca#1;
|HAZ comple_0;             || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI #0#10 = 2; |Y #1#39 = 3;
    |ACABA;         || si es finiquito separado por carta
|FINSI;
|SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
     |ACABA;
|FINSI;
nContrato = #11#9;
|HAZ comple_1;             || construye literales datos empresa
|HAZ comple_2;             || construye periodo de liquidacion nomina
|HAZ comple_3NomHisto;     || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_NomHistoImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4NomHistoAb;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5NomHistoAb;   || construye fecha firma
|HAZ comple_6Abierta;   || construye el comentario
|HAZ cargas_0NomHistoAb;           || carga campos cabecera calculos
|HAZ BuscaBanco;
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1NomHistoAb#11;   || carga campos lineas calculos
|SI lineas = 1;
    |HAZ cargas_2NomHistoAb;           || carga campos totales
    |SI nOpcion = 2;
         |HAZ IMPREArchi;
    |SINO;
         |INFOR "nomyabie";
    |FINSI;
        alguno = 0;
        ninguno = 0;
        situac2 = 0;
          |PARA situac = 1; |SI situac [ 39; |HACIENDO situac = situac + 1;
               camctos = situac + 116;  infctos = #15camctos;
               camptas = situac + 22;   infptas = #10camptas;
               camdesc = situac + 77;   infdesc = #15camdesc;
               camunid = situac -  1;   infunid = #15camunid;
               camvalo = situac + 38;   infvalo = #15camvalo;
               camunia = situac + 155;  infunia = #15camunia;
               |HAZ Cotizaciones;
               retoded = "R";
               |SI infptas ! 0;
                    alguno = 1;
                    ninguno = ninguno + 1;
                    |PRINT;
                    |SI ninguno = 15;
                         situac2 = situac + 1;
                         situac = 39;
                    |FINSI;
               |FINSI;
          |SIGUE;
          linea16 = 0;
          |SI situac2 ! 0;
               |PARA situac = situac2; |SI situac [ 39; |HACIENDO situac = situac + 1;
                    camctos = situac + 116;  infctos = #15camctos;
                    camptas = situac + 22;   infptas = #10camptas;
                    camdesc = situac + 77;   infdesc = #15camdesc;
                    camunid = situac -  1;   infunid = #15camunid;
                    camvalo = situac + 38;   infvalo = #15camvalo;
                    camunia = situac + 155;  infunia = #15camunia;
                    linea16 = linea16 + infptas;
               |SIGUE;
               |SI linea16 ! 0;
                    alguno = 1;
                    infctos = 0;
                    infptas = linea16;
                    infdesc = "GLOBAL VARIOS ...";
                    infunid = 1;
                    infunia = 1;
                    infvalo = 1;
                    |PRINT;
               |FINSI;
          |FINSI;
          |HAZ LineasDto;
          aAlfa = Impresora; |QBF aAlfa; aAlfa = aAlfa % 113;
          |SI alguno = 1; |O aAlfa = "CrystalReport";
               |SI Impresora = "CrystalReport";
                    |HAZ imprime;
               |SINO;
                    |PIEINF;
                    |HAZ ElFININF;
               |FINSI;
          |SINO;
               |SI #10#119 ! 0;
                    infctos = 0;
                    infptas = 0;
                    infdesc = "-------------------------";
                    infunid = 0;
                    infunia = 0;
                    infvalo = 0;
                    |PRINT;
                    |HAZ imprime;
               |SINO;
                    |HAZ ElFININF;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomwreci0Abierta;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, procesoNomHistoAb;
|FIN;


|PROCESO ordenaNomHistoAb;
|DDEFECTO #1;
    #1#0 = #11#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #11#0;
    #2#1 = #11#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|DEFBUCLE nombresNomHistoAb;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoAb, NULL, NULL, NULL, procesoNomHistoAb;
 #2#0, #2#2, #2#1, #11#3;
|FIN;

|DEFBUCLE areasNomHistoAb;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoAb, NULL, NULL, NULL, procesoNomHistoAb;
 #2#0, #2#62, #2#63, #2#1, #11#3;
|FIN;

|DEFBUCLE centrosNomHistoAb;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoAb, NULL, NULL, NULL, procesoNomHistoAb;
 #2#0, #2#77, #2#1, #11#3;
|FIN;

|DEFBUCLE tc2NomHistoAb;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, #0#10;
 nHastaEmp, nHastaTra, #0#4, #0#5, #0#10;
 ;
 NULL, ordenaNomHistoAb, NULL, NULL, NULL, procesoNomHistoAb;
 #2#0, #0#64, #102#142, #2#75, #2#1, #11#3;
|FIN;

|PROCESO impreHNA2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomwreci0Abierta;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresNomHistoAb;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasNomHistoAb;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosNomHistoAb;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2NomHistoAb;         |FINSI;
|FPRC;

|DEFBUCLE HNAGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreHNA2;
|FIN;

|PROCESO HNAPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE HNAGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreHNA; |TIPO 3;
    c_informe = "nomyabie";
|HAZ cuadres;
|SI sw_cuadre = 0;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ BuscaModulo;
    |HAZ ElIMPRE;
    aOrden = #0#63;
    |SI FEstado = 0;
        |HAZ control;
            seleccio = 0;
        |SI #0#21 = 0;
            |SI #0#70 = 0;
                |HAZ impreHNA2;
            |SINO;
                |HAZ HNAPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaHistoNomFin;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
|FINSI;
|FPRC;

|PROCESO cargas_0NomHistoAb;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq;         || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
||SI #2#42 ! "A";|Y #2#42 ! "B";|Y #2#42 ! "E";|Y #2#42 ! "e";
|SI #2#42 ! "E";|Y #2#42 ! "e";
        #10#19 = #11#08;          || total dias liquidacion
|SINO;
        #10#19 = #11#11 + #11#55;          || total jornadas (AGRARIA*)
|FINSI;
    #10#205 = #11#55;          || jornadas en IT agrarios
    #10#207 = #11#11;          || jornadas alta
    #10#103 = #11#57;          || ptas. enfermedad
    #10#104 = #11#58;          || ptas. accidente
    #10#105 = desenf;         || del dia enfermedad
    #10#106 = hasenf;         || al dia enfermedad
    #10#107 = desacc;         || del dia accidente
    #10#108 = hasacc;         || al dia accidente
    #10#119 = tcotiz;         || base cotizacion
    #10#120 = #11#38;          || base prorratas
    #10#121 = tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #11#39 - #11#157;          || base contingencias comunes
    #10#124 = #11#40 - #11#176;          || base D+P+F
    |SI #10#123 < 0; #10#123 = 0; |FINSI; |SI #10#124 < 0; #10#124 = 0; |FINSI;
    #10#125 = #11#41;          || base horas extra estruc.
    #10#126 = #11#42;          || base horas extra no estruc.
    #10#127 = #11#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+f+p
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #11#48;          || ptas. contingencias comunes
    #10#132 = #11#49;          || ptas. d+f+p
    #10#133 = #11#50;          || ptas. horas extra estruc.
    #10#134 = #11#51;          || ptas. horas extra no estruc.
    |SI #labtraba#42 = "e"; #10#123 = #10#131 * 100 / #10#127; |FINSI;
    #10#135 = #11#13;          || (%) I.R.P.F.
    #10#137 = taporta;        || total aportacion
    #10#139 = tantici;        || total anticipos
    #10#140 = #11#54;          || en especie
    |SI #11#207 ! 0;     || Cot. Solidaridad
         #10#124 = #10#123; #10#164 = #11#207; #10#162 = (#10#164 / #10#124) * 100;
         taporta = taporta + #10#164; deducir = deducir + #10#164;
    |FINSI;
    #10#141 = deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    #10#150 = "";             || Literal fijo
    |SI #labtraba#247 = 138;
         aTipoIT = "55"; |HAZ LiteralIT;
         #10#150 = aValor;
    |FINSI;
    #10#151 = #11#106;         || (%) IRPF 2
    #10#152 = #11#107;         || (%) IRPF 3
    #10#160 = #11#52;          || anticipos 1
    #10#161 = #11#53;          || anticipos 2
    #10#196 = #11#131;         || anticipos 3
    #10#193 = #11#45;          || ss. cargo empresa
|SI #11#49 ! 0;
        |SI apord ! 0; #10#162 = apord; |FINSI;          || (%) desempleo
        #10#163 = aporfp;          || (%) form.prof.
        |SI apord ! 0; #10#164 = #11#40 % apord; |FINSI;  || desempleo
        |SI #labtraba#190 = "S"; |Y #11#184 ! 0; #10#164 = #11#184; |FINSI;
        #10#165 = #11#49 - #10#164; || ptas. form.prof.
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
             #10#165 = #11#49;
        |FINSI;   || ptas. form.prof.
|FINSI;

nEmpresa=#11#0;   || empresa
nTrabajador=#11#1;   || trabajador
nMes=#11#2;   || mes
nTipo=#11#3;   || tipo
|HAZ ComentariosLabempre;
|FPRC;

|PROCESO cargas_1NomHistoAb;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     incluye = 0;
     concep = #12#4;
     situcon = #12#7;

     |HAZ situacion;
    descri = #12#08;
    unidad = #12#11;      || unidades calculo
    uniant = #12#09;      || unidades anterior
    valor  = #12#10;
    import = unidad * valor;
     |SI concep ] 951; |Y concep [ 960; situac = 0; situcon = 0; |FINSI;
|SI situac ! 0; |O situcon ! 0;
    |SI concep ] 201; |Y concep [ 208; |Y #12#5 ! "P"; |Y #0#10 = 0;
        |SI swbaja = 1;
            |SI #2#48 = "S"; |Y #1#25=2;  incluye = 1;  |FINSI;  || si es finiquito
        |SINO;
            |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
        |FINSI;
    |SINO;
            incluye = 1;
    |FINSI;
    |HAZ Dtos;
    |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
    |SI incluye = 1;
            lineas = 1;
        |HAZ leedescriNomHistoAb;
            camctos = situac + 116;
            camptas = situac + 22;
            camdesc = situac + 77;
            camunid = situac -  1;
            camvalo = situac + 38;
            camunia = situac + 155;
            #15camctos = concep;
            #15camdesc = #100#2;                      || descripcion ampliada
            |HAZ Ampliada2;
            #10camptas = #10camptas + import;        || devengado
        |SI concep = 515;
                #15camunid = 0;        || unidades cero en ENF.EMP.
                #15camunia = 0;
                #15camvalo = #11#35;    || promedio de enfermedad en ENF.EMP.
        |SINO;
                #15camunia = #15camunia + uniant;        || unidades anterior
                #15camunid = #15camunid + unidad;        || unidades
                #15camvalo = #10camptas / #15camunid;    || valor base
        |FINSI;
        |SI concep = 101;
                dcal_101 = #12#05;
                duni_101 = unidad;
                dval_101 = valor;
        |FINSI;
        |SI concep = 102;               ||   unidades concepto 102
                duni_102 = unidad;
        |FINSI;
        |SI concep ] 301; |Y concep [ 305;
            duni_hest = duni_hest + #5#11;
        |FINSI;
        |SI concep ] 306; |Y concep [ 310;
            duni_hnoest = duni_hnoest + #5#11;
        |FINSI;
    |FINSI;
|FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
     |SI concep = 906; |O concep = 907; |O concep = 926;
          |HAZ DescAntic;
     |FINSI;
|FPRC;

|PROCESO cargas_2NomHistoAb;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#11#33 * 100) $ 100) / 100;
            ||#10#21 = #11#8 - (#11#31 + #11#32 + #11#34 + #11#65 + deci_h + #11#105); ||unid.sal.base
            #10#21 = #11#8 - (#11#31 + #11#32 + #11#34 + #11#65 + #11#105); ||unid.sal.base
    |SINO;
            #10#21 = duni_101;
    |FINSI;
|SINO;
        #10#21 = duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3;          || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#195 = (#11#46 - #10#116 + #nomtrnom#193);  || Total Neto + SS Emp
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #11#14 + #11#108 + #11#109;                  || tot.base IRPF
    #10#138 = #11#15 + #11#110 + #11#111;                  || tot.ret. IRPF
    #10#153 = #11#14;                                    || base IRPF 1
    #10#154 = #11#108;                                   || base IRPF 2
    #10#155 = #11#109;                                   || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #11#15;                                    || ret. IRPF 1
    #10#158 = #11#110;                                   || ret. IRPF 2
    #10#159 = #11#111;                                   || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #11#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #11#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #11#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #11#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = duni_hest;
    #10#191 = duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_4NomHistoAb;        || HALLA TOTALES VARIOS
    tcotiz  = #11#37 + #11#62;
    tbcotiz = tcotiz + #11#38;         || total bases de cotizacion
|SI #11#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19; ||(%) d+f+p
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #11#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #11#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
    |HAZ parcheformacionH;
    taporta = #11#48 + #11#49 + #11#50 + #11#51;       || total aportacion
    tantici = #11#52 + #11#53 + #11#128 + #11#131;     || total anticipos
    deducir = taporta + #11#114 + tantici + #11#54;    || total a deducir
|SI swbaja = 0; |Y #1#25 = 2;          || si la paga va junta y no es baja,
        deducir = deducir + #11#17;    || /le suma la parte IRPF de pagas
        tantici = tantici + #11#128;   || y le suma el anticipo Paga Ext(-3-)
        deducir = deducir + #11#128;   || al total anticipos y deducciones
|FINSI;
    nEmbargo = 0;
    |SI #11#146 ! 0;
         |SI #11#47 = 0; |O #1#25 = 2;
              nEmbargo = #11#146;
         |SINO;
              nEmbargo = (#11#146 * (#11#46 / (#11#46 + #11#47))) ! 2;
              |HAZ EmbargoPaga;
         |FINSI;
    |FINSI;
     deducir = deducir + nEmbargo;
|FPRC;

|PROCESO comple_5NomHistoAb;        || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaNomHistoAb;              || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0;
        diarec = diabaja;
|SINO;
        diarec = diatra;
|FINSI;
    anyrec = anytra;
    mesnum = mestra;
|HAZ lib_0;
    mesrec = mesalf;
|FPRC;


|PROCESO sibajaNomHistoAb;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #11#5 ! "          "; |Y #11#5 ! "..........";
        fectra = #11#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

/*****************************************************************/
/*  ATRASOS-NOMINAS-ABIERTA                                      */
/*****************************************************************/

|PROCESO procesoAtrasAb;
|SI sw_control = 0; |HAZ control;  sw_control = 1;     |FINSI;

    seleccio = 1;   || para saber si se ha leido algo
|SI ante_tra=0;  ante_emp = #13#0;  ante_tra = #13#1;  |FINSI;
|SI #0#10 = 2;
    |SI ante_emp ! #13#0; |O ante_tra ! #13#1;
        |SI lineas = 1;
            |HAZ comple_6AtrasAb;
        |FINSI;
    |FINSI;
|FINSI;
    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
nEmp = #nomcalac#0; nTra = #nomcalac#1;
|HAZ comple_0;          || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
     |ACABA;
|FINSI;
nContrato = #13#9;
|HAZ comple_1;          || construye literales datos empresa
|HAZ comple_2AtrasAb;   || construye periodo de liquidacion nomina
|HAZ comple_3AtrasAb;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_AtrasImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4AtrasAb;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5AtrasAb;     || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ cargas_0AtrasAb;           || carga campos cabecera calculos
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1AtrasAb#13;   || carga campos lineas calculos
    ante_emp = #13#0;
    ante_tra = #13#1;
|SI lineas = 1;
    |HAZ cargas_2AtrasAb;       || carga campos totales
     |HAZ BuscaBanco;
    |SI #0#10 = 1;
        |HAZ comple_6AtrasAb;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomsreci0Abierta;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, procesoAtrasAb;
|FIN;

|PROCESO ordenaAtrasAb;
|DDEFECTO #1;
    #1#0 = #13#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #13#0;
    #2#1 = #13#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|DEFBUCLE nombresAtrasAb;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasAb, NULL, NULL, NULL, procesoAtrasAb;
     #2#0, #2#2, #2#1;
|FIN;

|DEFBUCLE areasAtrasAb;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasAb, NULL, NULL, NULL, procesoAtrasAb;
     #2#0, #2#62, #2#63, #2#1;
|FIN;

|DEFBUCLE centrosAtrasAb;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasAb, NULL, NULL, NULL, procesoAtrasAb;
     #2#0, #2#77, #2#1;
|FIN;

|DEFBUCLE tc2AtrasAb;
     #13#1;
     ;
     nDesdeEmp, nDesdeTra, #0#5, 5;
     nHastaEmp, nHastaTra, #0#7, 5;
     ;
     NULL, ordenaAtrasAb, NULL, NULL, NULL, procesoAtrasAb;
     #2#0, #0#64, #102#142, #2#75, #2#1, #13#2;
|FIN;

|PROCESO impreANA2
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomsreci0Abierta;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresAtrasAb;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasAtrasAb;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosAtrasAb;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2AtrasAb;         |FINSI;
|FPRC;

|DEFBUCLE ANAGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreANA2;
|FIN;

|PROCESO ANAPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE ANAGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreANA; |TIPO 3;
    c_informe = "nomyabie";
|HAZ cuadres;
|SI sw_cuadre = 0;
    aOrden = #0#63;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
            seleccio = 0;
        |SI #0#21 = 0;
            |SI #0#70 = 0;
                |HAZ impreANA2;
            |SINO;
                |HAZ ANAPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaAtrasos;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |SINO;
            |SI #0#10 = 2;
                |SI lineas = 1;
                    |HAZ comple_6AtrasAb;
                |FINSI;
            |FINSI;
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
|FINSI;
|FPRC;

|PROCESO cargas_0AtrasAb;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq1;        || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq2;        || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    #10#18 = #13#184;
/*
    |SI #13#184 ! 0;
         #10#18 = #13#184;
    |FINSI;
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
*/
    #10#19 = #10#19 + #13#08;          || total dias liquidacion
    || #10#101 = #10#101 + #13#55;          || proteccion a la familia
    || #10#102 = #10#102 + #13#56;          || ayuda a la subnormalidad
    #10#103 = #10#103 + #13#57;          || ptas. enfermedad
    #10#104 = #10#104 + #13#58;          || ptas. accidente
|SI #0#10 = 1;
        #10#105 = desenf;         || del dia enfermedad
        #10#106 = hasenf;         || al dia enfermedad
        #10#107 = desacc;         || del dia accidente
        #10#108 = hasacc;         || al dia accidente
|SINO;
        #10#105 = 0; #10#106 = 0; #10#107 = 0; #10#108 = 0;
|FINSI;
    #10#119 = #10#119 + tcotiz;         || base cotizacion
    #10#120 = #10#120 + #13#38;          || base prorratas
    #10#121 = #10#121 + tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #10#123 + #13#39;          || base contingencias comunes
    #10#124 = #10#124 + #13#40;          || base D+P+F
    #10#125 = #10#125 + #13#41;          || base horas extra estruc.
    #10#126 = #10#126 + #13#42;          || base horas extra no estruc.
    #10#127 = #13#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+fp
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #10#131 + #13#48;          || ptas. contingencias comunes
    #10#132 = #10#132 + #13#49;          || ptas. d+f+p
    #10#133 = #10#133 + #13#50;          || ptas. horas extra estruc.
    #10#134 = #10#134 + #13#51;          || ptas. horas extra no estruc.
    #10#135 = #13#13;          || (%)IRPF 1
    #10#137 = #10#137 + taporta;        || total aportacion
    #10#139 = #10#139 + tantici;        || total anticipos
    #10#140 = #10#140 + #13#54;          || en especie
    #10#141 = #10#141 + deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    aTipoIT = "53"; |HAZ LiteralIT;
    #10#150 = aValor;          || Literal fijo
    #10#151 = #13#67;          || (%)IRPF 2
    #10#152 = #13#68;          || (%)IRPF 3
    #10#160 = #10#160 + #13#52;          || anticipos 1
    #10#161 = #10#161 + #13#53;          || anticipos 2
    #10#196 = #10#196 + #13#89;          || anticipos 3
    #10#193 = #10#193 + #13#45;          || ss. cargo empresa
    #10#195 = #10#195 + (#13#46 - deducir + #nomtrnom#193);  || Total Neto + SS Emp
|SI #13#49 ! 0;
        |SI apord ! 0; #10#162 = apord; |FINSI;          || (%) desempleo
        #10#163 = aporfp;                                   || (%) form.prof.
        #10#164 = #10#164 + ((#13#40 % apord) ! EURODB);           || ptas. desempleo
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
               #10#165 = #10#165 + #13#49;  || ptas. form.prof.
        |SINO;
               #10#165 = #10#165 + (#13#49 - (#13#40 % apord) ! EURODB);  || ptas. form.prof.
        |FINSI;
|FINSI;

nEmpresa=#13#0;   || empresa
nTrabajador=#13#1;   || trabajador
nMes=#13#2;   || mes
nTipo=#13#3;   || tipo
|HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1AtrasAb;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     incluye = 0;
     concep = #14#4;
     situcon = #14#7;

     |HAZ situacion;

    descri = #14#08;
    unidad = #14#11;      || unidades calculo
    uniant = #14#09;
    valor  = #14#10;
    import = unidad * valor;
|SI situac ! 0; |O situcon ! 0;
    |SI concep ] 201; |Y concep [ 208; |Y #14#5 ! "P";
        |SI swbaja = 1;
            |SI #2#48 = "S"; |Y #1#25=2;  incluye = 1;  |FINSI;  || si es finiquito
        |SINO;
            |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
        |FINSI;
    |SINO;
            incluye = 1;
    |FINSI;
    |HAZ Dtos;
    |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
    |SI incluye = 1;
            lineas = 1;
        |HAZ leedescriAtrasAb;
            camctos = situac + 116;
            camptas = situac + 22;
            camdesc = situac + 77;
            camunid = situac -  1;
            camvalo = situac + 38;
            camunia = situac + 155;
            retoded = "R";
            #15camctos = concep;
            #15camdesc = #100#2;                      || descripcion ampliada
            |HAZ Ampliada2;
            #10camptas = #10camptas + import;        || devengado
        |SI concep = 515;
                #15camunid = 0;        || unidades cero en ENF.EMP.
                #15camunia = 0;
                #15camvalo = #13#35;    || promedio de enfermedad en ENF.EMP.
        |SINO;
                #15camunia = #15camunia + uniant;        || unidades anterior
                #15camunid = #15camunid + unidad;        || unidades
                #15camvalo = #10camptas / #15camunid;    || valor base
        |FINSI;
        |SI concep = 101;
                dcal_101 = #14#05;
                duni_101 = unidad;
                dval_101 = valor;
        |FINSI;
        |SI concep = 102;               ||   unidades concepto 102
                duni_102 = unidad;
        |FINSI;
        |SI concep ] 301; |Y concep [ 305;
            duni_hest = duni_hest + #5#11;
        |FINSI;
        |SI concep ] 306; |Y concep [ 310;
            duni_hnoest = duni_hnoest + #5#11;
        |FINSI;
    |FINSI;
|FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
|FPRC;

|PROCESO cargas_2AtrasAb;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#13#33 * 100) $ 100) / 100;
            ||#10#21 = #10#21 + (#13#8-(#13#31+#13#32+#13#34+#13#65+deci_h+#13#66)); ||unid.sal.base
            #10#21 = #10#21 + (#13#8-(#13#31+#13#32+#13#34+#13#65+#13#66)); ||unid.sal.base
    |SINO;
            #10#21 = #10#21 + duni_101;
    |FINSI;
|SINO;
        #10#21 = #10#21 + duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3; |Y #0#10 ! 2;   || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 109; |SI campo [ 115; |HACIENDO campo = campo + 1;
    #10campo = 0;    || vacia los totales, porque acumula en conceptos
|SIGUE;
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
    #10#118 = 0;
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #10#136 + (#13#14 + #13#69 + #13#70);        || tot.base IRPF
    #10#138 = #10#138 + (#13#15 + #13#71 + #13#72);        || tot.ret. IRPF
    #10#153 = #10#153 + #13#14;                          || base IRPF 1
    #10#154 = #10#154 + #13#69;                          || base IRPF 2
    #10#155 = #10#155 + #13#70;                          || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #10#157 + #13#15;                          || ret. IRPF 1
    #10#158 = #10#158 + #13#71;                          || ret. IRPF 2
    #10#159 = #10#159 + #13#72;                          || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #13#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #13#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #13#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #13#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = #10#190 + duni_hest;
    #10#191 = #10#191 + duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_2AtrasAb;        || CONSTRUYE PERIODO DE LIQUIDACION
|SI #0#10 = 2;
        mesnum = #0#5;
|SINO;
        mesnum = #13#2;
|FINSI;

    anytra = #0#4;
|HAZ lib_0;             || saca ultimo dia natural del mes desde !!!
    mesliq1 = mesalf;
    mesliq2 = mesalf;

|SI #0#10 = 2;           || si tiene que refundir
        mesnum = #0#7;
        anytra = #0#4;
    |HAZ lib_0;         || saca ultimo dia natural del mes hasta !!!
    mesliq2 = mesalf;
|FINSI;

    fectra = #13#4;      || desglosa fecha de alta
|HAZ lib_1;
    diaalta = diatra;
    mesalta = mestra;
|SI #0#10 = 2;
    |SI mesalta ] #0#5; |Y anytra = #0#4;  || si es alta este mes
            desdia = diaalta;
            mesnum = mesalta;
            anytra = #0#4;
        |HAZ lib_0;
            mesliq1 = mesalf;
    |SINO;
            desdia = 1;
    |FINSI;
|SINO;
    |SI mesalta = #13#2; |Y anytra = #0#4;  || si es alta este mes
            desdia = diaalta;
    |SINO;
            desdia = 1;
    |FINSI;
|FINSI;

    fectra = #13#5;      || desglosa fecha de baja
|HAZ lib_1;
    diabaja = diatra;
    mesbaja = mestra;
|SI #0#10 = 2;
    |SI mesbaja [ #0#7; |Y mesbaja ! 0; |Y anytra = #0#4; || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
            mesnum = mesbaja;
            anytra = #0#4;
        |HAZ lib_0;
            mesliq2 = mesalf;
    |SINO;
            mesnum = #0#7;
            anytra = #0#4;
        |HAZ lib_0;
            hasdia = topemes;
    |FINSI;
|SINO;
    |SI mesbaja = #13#2; |Y anytra = #0#4; || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
    |SINO;
            hasdia = topemes;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_3AtrasAb;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
    tipoit = "";
    desenf = 0;  hasenf = 0;
    desacc = 0;  hasacc = 0;
    swtenf = 0;  swtacc = 0;
|SI #13#27="E"; |O #13#27="M"; |O #13#27="P"; |O #13#27="R";
       desenf=#13#19; hasenf=#13#23; swtenf=1;
    tipoit = #13#27;
|FINSI;
|SI #13#28="E"; |O #13#28="M"; |O #13#28="P"; |O #13#28="R";
    |SI swtenf=0; desenf=#13#20; hasenf=#13#24; swtenf=1; |FINSI;
    tipoit = #13#28;
|FINSI;
|SI #13#29="E"; |O #13#29="M"; |O #13#29="P"; |O #13#29="R";
    |SI swtenf=0; desenf=#13#21; hasenf=#13#25; swtenf=1; |FINSI;
    tipoit = #13#29;
|FINSI;
|SI #13#30="E"; |O #13#30="M"; |O #13#30="P"; |O #13#30="R";
    |SI swtenf=0; desenf=#13#22; hasenf=#13#26; swtenf=1; |FINSI;
    tipoit = #13#30;
|FINSI;
     |SI swtenf = 1;
       |HAZ TipoIT;
     |FINSI;
|SI #13#27="A";              desacc=#13#19; hasacc=#13#23; swtacc=1; |FINSI;
|SI #13#28="A"; |Y swtacc=0; desacc=#13#20; hasacc=#13#24; swtacc=1; |FINSI;
|SI #13#29="A"; |Y swtacc=0; desacc=#13#21; hasacc=#13#25; swtacc=1; |FINSI;
|SI #13#30="A"; |Y swtacc=0; desacc=#13#22; hasacc=#13#26; swtacc=1; |FINSI;
|SI swtacc = 1;|Y #36#19 = "S";
        desacc = desacc - 1;
    |SI desacc < 0;  desacc = 1;  |FINSI;  || por el rollo de las mutuas
|FINSI;
|SI desenf = 0;|Y swtenf = 1;   desenf = 1;    |FINSI;
|SI hasenf = 0;|Y swtenf = 1;   hasenf = #13#7; |FINSI;
|SI desacc = 0;|Y swtacc = 1;   desacc = 1;    |FINSI;
|SI hasacc = 0;|Y swtacc = 1;   hasacc = #13#7; |FINSI;
|FPRC;

|PROCESO comple_4AtrasAb;        || HALLA TOTALES VARIOS
    tcotiz  = #13#37 + #13#62;
    tbcotiz = tcotiz + #13#38;         || total bases de cotizacion
|SI #13#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19;   ||(%) d+f+p
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #13#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #13#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
    taporta = #13#48 + #13#49 + #13#50 + #13#51;      || total aportacion
    tantici = #13#52 + #13#53 + #13#89;               || total anticipos
    deducir = taporta + #13#75 + tantici + #13#54;  || total a deducir
|SI swbaja = 0; |Y #1#25 = 2;         || si la paga va junta y no es baja,
        deducir = deducir + #13#17;    || /le suma la parte IRPF de pagas
|FINSI;
|FPRC;

|PROCESO comple_5AtrasAb;        || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaAtrasAb;              || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0;
        diarec = diabaja;
|SINO;
        diarec = diatra;
|FINSI;
    anyrec = anytra;
    mesnum = mestra;
|HAZ lib_0;
    mesrec = mesalf;
|FPRC;

|PROCESO sibajaAtrasAb;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #13#5 ! "          "; |Y #13#5 ! "..........";
        fectra = #13#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_6AtrasAb;    || imprime y limpia
|INFOR "nomyabie";
    alguno = 0;
    ninguno = 0;
    situac2 = 0;
|PARA situac = 1; |SI situac [ 39; |HACIENDO situac = situac + 1;
        camctos = situac + 116;  infctos = #15camctos;
        camptas = situac + 22;   infptas = #10camptas;
        camdesc = situac + 77;   infdesc = #15camdesc;
        camunid = situac -  1;   infunid = #15camunid;
        camvalo = situac + 38;   infvalo = #15camvalo;
        camunia = situac + 155;  infunia = #15camunia;
        |HAZ Cotizaciones;
    |SI infptas ! 0;
            alguno = 1;
            ninguno = ninguno + 1;
        |PRINT;
        |SI ninguno = 15;
                situac2 = situac + 1;
                situac = 39;
        |FINSI;
    |FINSI;
|SIGUE;
    linea16 = 0;
|SI situac2 ! 0;
    |PARA situac=situac2;|SI situac[39; |HACIENDO situac=situac+1;
            camctos = situac + 116;  infctos = #15camctos;
            camptas = situac + 22;   infptas = #10camptas;
            camdesc = situac + 77;   infdesc = #15camdesc;
            camunid = situac -  1;   infunid = #15camunid;
            camvalo = situac + 38;   infvalo = #15camvalo;
            camunia = situac + 155;  infunia = #15camunia;
            linea16 = linea16 + infptas;
            |HAZ Cotizaciones;
    |SIGUE;
    |SI linea16 ! 0;
            alguno = 1;
            infctos = 0;
            infptas = linea16;
            infdesc = "GLOBAL VARIOS ...";
            infunid = 1;
            infunia = 1;
            infvalo = 1;
        |PRINT;
    |FINSI;
|FINSI;
|SI alguno = 1;
    |HAZ LineasDto;
    |PIEINF;
|SINO;
    |SI #10#119 ! 0;
            infctos = 0;
            infptas = 0;
            infdesc = "-------------------------";
            infunid = 0;
            infunia = 0;
            infvalo = 0;
        |PRINT;
        |PIEINF;
    |FINSI;
|FINSI;
|HAZ ElFININF;
|DDEFECTO #10;
|DDEFECTO #15;
|FPRC;

/*****************************************************************/
/*  MENSUAL-FINIQUITO                                            */
/*****************************************************************/

|PROCESO detalleFiniq;
    poblafir = #1#6;
|QBF poblafir;
    alfa1 = " " * 30;
    poblafir = alfa1 + poblafir;
    poblafir = poblafir % -130;

    causa = #10#146;
|QBF causa;
    alfa1 = "." * 36;
    causa = causa + alfa1;
    causa = causa % 136;

    liquido = #10#142;
    nLiquido = #10#142;
|QBF liquido;
    liquido = "-----------" + liquido;
    liquido = liquido % -111;
|FPRC;

|PROCESO DiasVacaciones;
     |SI nConcepto = 125; |Y #nomcontr#80 = "S";
          nNume = unidade; nNume = nNume ! 2;
          aAlfa = nNume; |QBF aAlfa;
          aAlfa = " (" + aAlfa + " d¡as)";
          aAlfa1 = #100#2;
          |QBF aAlfa1;
          aAlfa = aAlfa1 + aAlfa;
          #nomdesam#2 = aAlfa;
     |FINSI;
|FPRC;

|PROCESO conceptosFinMensu;
     nConcepto = #5#4;         || el concepto
     |HAZ leedescriFinMensu;
     unidade = #5#11;          || unidades en carta
     |HAZ DiasVacaciones;

     elvalor = #5#10;          || valor en carta
     importe = #5#10 * #5#11;  || importe en carta
     importe = importe ! EURODB;
     |PRINT;
     swHaEntrado = 1;
|FPRC;

|PROCESO imprimeFinMensu;
    seleccio = 0;
|SI #1#39 = "3";
        seleccio = 1;
     |SI nOpcion = 2;  || al DSArchi
          |HAZ IMPREArchi;
     |FINSI;
    |SI Impresora ! "CrystalReport"; |Y nOpcion ! 2;
         |SI #0#13 = "P";     informe = "nompcalf";    |FINSI;
         |SI #0#13 = "F";     informe = "nomycalf";    |FINSI;
         |INFOR informe;
    |FINSI;
    |SI FSalida = 0;
        rlecan = #10#142;
        |HAZ lletres;
        |HAZ VariosFiniq;
        |HAZ detalleFiniq;
        swHaEntrado = 0;
        nConcepto = 0;         || el concepto
        unidade = 0;          || unidades en carta
        elvalor = 0;          || valor en carta
        importe = 0;  || importe en carta
        |BUCLELIN 2conceptosFinMensu#4;
        |SI swHaEntrado = 0; |PRINT; |FINSI;
          |SI nOpcion = 1; |O nOpcion = 3; || impresion
               |SI #nomcontr#60 = "S"; |HAZ GuardaRegistro; |FINSI;
               nContador2 = nContador2 + 1
          |FINSI;
        |PIEINF;
        |HAZ ElFININF;
    |SINO;
        |ATRI P;
        |MENAV "    ATENCION!!! Cuadres no configurados ('Utilidades/Configurar Cuadres')";
        |ATRI 0;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomycalf0;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 2;
 nHastaEmp, nHastaTra, #0#5, 2;
 e;
 NULL, procesoNomMensuImpre;
|FIN;

|PROCESO impreMF2;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |BUCLE nomycalf0;
|FPRC;

|DEFBUCLE MFGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreMF2;
|FIN;

|PROCESO MFPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE MFGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreMF; |TIPO 3;
|ABRE #1;
|ABRE #2;
|ABRE #3;
|ABRE #6;
|ABRE #100;
|ABRE #102;
|HAZ ElIMPRE;
|SI FEstado = 0;
        seleccio = 0;
    |SI #0#21 = 0;
        |SI #0#70 = 0;
            |HAZ impreMF2
        |SINO;
            |HAZ MFPorGrupos;
        |FINSI;
    |SINO;
        |HAZ salteadaMensualNomFin;
    |FINSI;
    |SI seleccio = 0;
        |MENAV "    Seleccion vacia ...";
    |FINSI;
|SINO;
    |MENAV "    Proceso ABORTADO !!!";
|FINSI;
|HAZ ElFINIMP;
|CIERRA #1;
|CIERRA #2;
|CIERRA #3;
|CIERRA #6;
|CIERRA #100;
|FPRC;

/*****************************************************************/
/*  HISTORICO-FINIQUITO                                          */
/*****************************************************************/

|PROCESO conceptosFinHisto;
|HAZ leedescriFinHisto;
    nConcepto = #12#4;         || el concepto
    unidade = #12#11;          || unidades en carta
    elvalor = #12#10;          || valor en carta
    importe = #12#11 * #12#10;  || importe para la carta
    importe = importe ! EURODB;
    |HAZ DiasVacaciones;

     |SI swDesdeWeb = 1;
          aAlfa = unidade;
          nDec = 6;
          |HAZ PonDecimales;
          aCampo = "unidade" + alfacampo;
          aValor = aVar + "   x";
          |HAZ GrabaTemporal;

          aAlfa = elvalor;
          nDec = 2;
          |HAZ PonDecimales;
          aCampo = "elvalor" +  alfacampo;
          aValor = aVar + " :";
          |HAZ GrabaTemporal;

          aAlfa = importe;
          nDec = 2;
          |HAZ PonDecimales;
          aCampo = "importe" + alfacampo;
          aValor = aVar;
          |HAZ GrabaTemporal;

          aCampo = "concepto" + alfacampo;
          aValor = #100#2;
          |HAZ GrabaTemporal;
     |SINO;
          |PRINT;
          swHaEntrado = 1;
     |FINSI;
|FPRC;

|PROCESO imprimeFinHisto;
    seleccio = 0;
|SI #1#39 = "3";
        seleccio = 1;
     |SI nOpcion = 2;  || al DSArchi
          |HAZ IMPREArchi;
     |FINSI;
    |SI Impresora ! "CrystalReport"; |Y nOpcion ! 2;
         |SI #0#13 = "P";     informe = "nompcalf";    |FINSI;
         |SI #0#13 = "F";     informe = "nomycalf";    |FINSI;
         |SI swDesdeWeb ! 1;
               |INFOR informe;
         |FINSI;
    |FINSI;
    |SI FSalida = 0;
      |SI swDesdeWeb ! 1;
        rlecan = #10#142;
        |HAZ lletres;
        |HAZ VariosFiniq;
        |HAZ detalleFiniq;
        swHaEntrado = 0;
        nConcepto = 0;         || el concepto
        unidade = 0;          || unidades en carta
        elvalor = 0;          || valor en carta
        importe = 0;  || importe en carta
        |BUCLELIN 2conceptosFinHisto#11;
        |SI swHaEntrado = 0; |PRINT; |FINSI;
          |SI nOpcion = 1; |O nOpcion = 3; || impresion
               |SI #nomcontr#60 = "S"; |HAZ GuardaRegistro; |FINSI;
               nContador2 = nContador2 + 1
          |FINSI;
        |PIEINF;
        |HAZ ElFININF;
      |FINSI;
    |SINO;
        |ATRI P;
        |MENAV "    ATENCION!!! Cuadres no configurados ('Utilidades/Configurar Cuadres')";
        |ATRI 0;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomwcalf0;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 2;
 nHastaEmp, nHastaTra, #0#4, #0#5, 2;
 e;
 NULL, procesoNomHistoImpre;
|FIN;

|PROCESO impreHF2;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |BUCLE nomwcalf0;
|FPRC;

|DEFBUCLE HFGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreHF2;
|FIN;

|PROCESO HFPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE HFGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreHF; |TIPO 3;
|ABRE #1;
|ABRE #2;
|ABRE #3;
|ABRE #6;
|ABRE #100;
|ABRE #102;
|HAZ ElIMPRE;
|SI FEstado = 0;
        seleccio = 0;
    |SI #0#21 = 0;
        |SI #0#70 = 0;
            |HAZ impreHF2;
        |SINO;
            |HAZ HFPorGrupos;
        |FINSI;
    |SINO;
        |HAZ salteadaHistoNomFin;
    |FINSI;
    |SI seleccio = 0;
        |MENAV "    Seleccion vacia ...";
    |FINSI;
|SINO;
    |MENAV "    Proceso ABORTADO !!!";
|FINSI;
|HAZ ElFINIMP;
|CIERRA #1;
|CIERRA #2;
|CIERRA #3;
|CIERRA #6;
|CIERRA #100;
|FPRC;

/*****************************************************************/
/*  MENSUAL-PAGAS-IMPRESORA                                      */
/*****************************************************************/

|PROCESO salteadaPagasMensu;
|ABRE #93;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #93#0 = #0salte_1;     || empresa
        #93#1 = #0salte_2;     || trabajador
        #93#2 = #0#5;          || mes
        #93#3 = #0#10;         || tipo
        #93#66 = #0#4;         || a¤o (en las emisiones desde el historico)
    |LEE 001#93=;
    |SI FSalida = 0;
        |SI #0#69="I";
               |HAZ procesoPagMensuImpre;
        |FINSI;
        |SI #0#69="A";
               |HAZ procesoPagMensuAb;
        |FINSI;
    |FINSI;
|SIGUE;
|CIERRA #93;
|FPRC;

|DEFBUCLE d_nomcalca;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, d_proceso_cabPagMensuImpre;
|FIN;

|DEFBUCLE nomypaga0;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, procesoPagMensuImpre;
|FIN;

|DEFBUCLE EmpTraPagMensuImpre;     || por nombre empresa, codigo trabajador
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuImpre, NULL, NULL, NULL, procesoPagMensuImpre;
 #1#0, #2#0, #2#1, #93#3;
|FIN;

|DEFBUCLE nombresPagMensuImpre;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuImpre, NULL, NULL, NULL, procesoPagMensuImpre;
 #2#0, #2#2, #2#1, #93#3;
|FIN;

|DEFBUCLE areasPagMensuImpre;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuImpre, NULL, NULL, NULL, procesoPagMensuImpre;
 #2#0, #2#62, #2#63, #2#1, #93#3;
|FIN;

|DEFBUCLE centrosPagMensuImpre;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuImpre, NULL, NULL, NULL, procesoPagMensuImpre;
 #2#0, #2#77, #2#1, #93#3;
|FIN;

|DEFBUCLE tc2PagMensuImpre;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuImpre, NULL, NULL, NULL, procesoPagMensuImpre;
 #2#0, #0#64, #102#142, #2#75, #2#1, #93#3;
|FIN;

|PROCESO impreMPI2;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomypaga0;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresPagMensuImpre;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasPagMensuImpre;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosPagMensuImpre;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2PagMensuImpre;         |FINSI;
     |SI #0#63 = 6;    |BUCLE EmpTraPagMensuImpre;     |FINSI;
|FPRC;

|DEFBUCLE MPIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreMPI2;
|FIN;

|PROCESO MPIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE MPIGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreMPI; |TIPO 3;
    c_informe = "nomyreci";
|HAZ cuadres;
|SI sw_cuadre = 0;
        desglo = #0#14;
    |HAZ desglosaPagMensuImpre;
    |HAZ control;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
            seleccio = 0;
        |SI #0#21  = 0;
            |SI #0#70 = 0;
                |HAZ impreMPI2;
            |SINO;
                |HAZ MPIPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaPagasMensu;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |FINSI;
    |SINO;
        |MENAV "    Proceso abortado ...";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
    |SI desglo = "S";
        |DELINDEX #93;
        |DELINDEX #94;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO d_grabaPagMensuImpre;
|DDEFECTO #94;
    #94#0 = #5#0;    || empresa
    #94#1 = #5#1;    || trabajador
    #94#2 = #5#2;    || mes
    #94#3 = #5#3;    || tipo
    #94#4 = #5#4;    || concepto
|LEE 101#94=;
    d_entrada = FSalida;

    #94#5 = #5#5;    || tipo calculo alf.
|SI concepto ] 201;|Y concepto [ 208;   || con la X fuerza a los 200
        #94#5 = "X";                     ||/que se contienen en pagas a
|FINSI;                                 ||/que se emitan
    #94#6 = #5#6;   || tipo calculo num.
    #94#7 = #5#7;   || situacion
    #94#8 = #5#8;   || descripcion

    dcociente = (product / divide) ! (2+EURODB);
    dprod_200 = dprod_200 - (dcociente * duni2_200);
|SI d_campo = concep1;
        dcociente = dcociente + (dprod_200 / duni2_200);
        dcociente = dcociente ! (2+EURODB);
|FINSI;                                 || ajusta posibles diferencias

|SI d_entrada ! 0;
        #94#9 = duni2_200;     || unidades
        #94#10= dcociente;     || valor
|SINO;
    |SI #94#9 = duni2_200;               || unidades del mismo tipo
            #94#10 = #94#10 + dcociente;  ||/suma los valores
    |SINO;
        |SI #94#10 = dcociente;          || valores del mismo tipo
                #94#9 = #94#9 + duni2_200;||/suma las unidades
        |SINO;
                dnume1 = (#94#9 * #94#10) ! EURODB;  || lo que hay grabado
                dnume2 = (duni2_200 * dcociente);    || lo que hay que a¤adir
                #94#9 = 1;
                #94#10 = dnume1 + dnume2;           || el resultado
        |FINSI;
    |FINSI;
|FINSI;
    #94#11= #94#9;    || unidades calculo

|SI d_entrada ! 0;   |GRABA 020#94n; |FINSI;
|SI d_entrada = 0;   |GRABA 020#94a; |FINSI;
|LIBERA #94;
|FPRC;

|PROCESO d_dividePagMensuImpre;
|SI #5#5="D";                            divide = dia_2;        |FINSI;
|SI #5#5="M";                            divide = dia_4;        |FINSI;
|SI #5#5="L";|O #5#5="K";               divide = duni1_999;    |FINSI;
|SI #5#5="V";|O #5#5="F";|O #5#5="A";  divide = 30;           |FINSI;
|SI #2#42 = "I";|O #2#42 = "P";
    |DDEFECTO #99;
    |ABRE #99;                || si se carga con los dias de alta
        #99#0 = #2#87;        ||/se divide por los mismos
        #99#1 = #5#4;
    |LEE 000#99=;
    |SI #99#3 = "S";     divide = #4#8;  |FINSI;
    |CIERRA #99;
|FINSI;
|FPRC;

|PROCESO d_cal_valoPagMensuImpre;
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|HAZ d_dividePagMensuImpre;
|SI sd_bucle = 1;
        dreal_200 = dreal_200 + (product / divide);
|SINO;
    |HAZ d_grabaPagMensuImpre;
|FINSI;
|FPRC;

|PROCESO d_leeconcepPagMensuImpre;
    #5#0 = #4#0;       || empresa
    #5#1 = #4#1;       || trabajador
    #5#2 = #4#2;       || mes
    #5#3 = #4#3;       || tipo
    #5#4 = concepto;    || concepto
|LEE 000#5=;
|SI FSalida = 0;
        duni1_999 = #5#9;
        duni2_999 = #5#11;
        dvalo_999 = #5#10;
    |SI #5#5="F";|Y duni1_999=0;|Y concepto!102; || si es calculo 'F' carga
            duni1_999 = 1;                        ||/las unidades con 1 !!!
    |FINSI;
    |HAZ d_cal_valoPagMensuImpre;
|FINSI;
|FPRC;

|PROCESO d_buclePagMensuImpre;
    concep1 = 51 + d_paga;      || calcula el 1er. campo de conceptos
    concep2 = concep1 + 32;     || calcula el ultimo campo de concep.
|PARA d_campo = concep2;|SI d_campo ] concep1;|HACIENDO d_campo = d_campo - 8;
    |SI #102d_campo ! 0;
                            desc = #102d_campo; hasc = #102d_campo;
        |SI #102d_campo = 100; desc = 101;      hasc = 199;     |FINSI;
        |SI #102d_campo = 400; desc = 401;      hasc = 420;     |FINSI;
        |PARA actc = desc;|SI actc [ hasc;|HACIENDO actc = actc + 1;
                concepto = actc;
            |HAZ d_leeconcepPagMensuImpre;
        |SIGUE;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO d_proceso_linPagMensuImpre;
    #5#0 = #4#0;       || empresa
    #5#1 = #4#1;       || trabajador
    #5#2 = #4#2;       || mes
    #5#3 = #4#3;       || tipo
    #5#4 = d_conc;      || concepto
|LEE 000#5=;
|SI FSalida = 0;|Y #5#11 ! 0;|Y #5#5 ! "P";|Y #5#7 ! 0;
        duni2_200 = #5#11;
        dvalo_200 = #5#10;
        dprod_200 = (duni2_200 * dvalo_200) ! EURODB;

    |SI #2d_tipo_p = "V";|Y #102d_tipos = "N"; || !!pagas normales
        |SI #102#140 = "N";                    || ctos.400 sin prorrateo:
                dreal_200 = 0;                ||/calcula el valor real
                sd_bucle = 1;  |HAZ d_buclePagMensuImpre;  ||/y las unidades reales
                dreal_200 = dreal_200 ! (2+EURODB);
                duni2_200 = ((dvalo_200 * duni2_200) / dreal_200) ! 6;
        |FINSI;
            sd_bucle = 2;  |HAZ d_buclePagMensuImpre;
    |SINO;                    || !!pagas ajustadas o porcentuales
        |PARA d_para1 = 0; |SI d_para1 [ 11; |HACIENDO d_para1 = d_para1 + 1;
                #94d_para1 = #5d_para1;
        |SIGUE;
            #94#5 = "X";
        |GRABA 020#94n;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO dias_coti;
    dbisiesto = 0;
    dnume1 = #0#4 $ 4;
|SI dnume1 = 0;|Y #36#9 = "S";
        dbisiesto = 1;
|FINSI;
    dtopemes = 31;
|SI #0#5 = 2;
        dtopemes = 28 + dbisiesto;
|FINSI;
|SI #0#5 = 4;|O #0#5 = 6;|O #0#5 = 9;|O #0#5 = 11;
        dtopemes = 30;
|FINSI;

    dia_2 = dtopemes;     || dias naturales del mes
    dia_4 = 30;           || dias cotizacion 'mensual'
|SI #2#42 = "D";|O #2#42 = "T";
        dia_4 = dtopemes; || dias cotizacion 'diario'
|FINSI;
|FPRC;

|PROCESO d_proceso_cabPagMensuImpre;
    #2#0 = #4#0;
    #2#1 = #4#1;
|LEE 000#2=;                  || lee trabajador
|SI FSalida = 0;
        #102#0 = #2#87;
    |LEE 000#102=;             || lee convenio
    |SI FSalida = 0;
        |PARA d_para1 = 0; |SI d_para1 [ 88; |HACIENDO d_para1 = d_para1 + 1;
                #93d_para1 = #4d_para1;
        |SIGUE;
        |GRABA 020#93n;
        |SI FSalida = 0;
            |HAZ dias_coti;
            |PARA d_paga = 1; |SI d_paga [ 8; |HACIENDO d_paga = d_paga + 1;
                    d_tipos = d_paga + 27;   || tipo de paga
                    d_diasp = d_paga + 35;   || dias
                    d_porcp = d_paga + 43;   || porcentaje
                    d_conc = d_paga + 200;   || concepto de paga
                    d_tipo_p = d_paga + 156; || tipo ajuste paga
                |SI #102d_diasp ! 0;|O #102d_porcp ! 0;
                    |HAZ d_proceso_linPagMensuImpre;
                |FINSI;
            |SIGUE;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO desglosaPagMensuImpre;
|SI desglo = "S";
    |MENSA "0402Preparando desglose ...";
    |HAZ control;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "c" + dalfa1;
    |NOME_DAT #93 dalfa1; |DELINDEX #93;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "l" + dalfa1;
    |NOME_DAT #94 dalfa1; |DELINDEX #94;
    |ABRE #2;            || trabajadores
    |ABRE #93;            || tmp. calculos cabs.
    |ABRE #94;            || tmp. calculos lins.
    |ABRE #5;           || calculos lins.
    |ABRE #102;           || convenios cabs.
    |HAZ d_seleccionPagMensuImpre;
    |CIERRA #2;
    |CIERRA #93;
    |CIERRA #94;
    |CIERRA #5;
    |CIERRA #102;
    |BLIN 4;
|SINO;
    |NOME_DAT #93 "nomcalca"; || ni se te ocurra hacer aqui DELINDEX
    |NOME_DAT #94 "nomcalli";
|FINSI;
|FPRC;


|PROCESO d_salteada;
|ABRE #4;
|PARA dsalte_1 = 21; |SI dsalte_1 [ 41; |HACIENDO dsalte_1 = dsalte_1 + 1;
        dsalte_2 = dsalte_1 + 21;
        #4#0 = #0dsalte_1;   || empresa
        #4#1 = #0dsalte_2;   || trabajador
        #4#2 = #0#5;         || mes
        #4#3 = 0;            || tipo
    |LEE 000#4=;
    |SI FSalida = 0;
        |HAZ d_proceso_cabPagMensuImpre;
    |FINSI;
|SIGUE;
|CIERRA #4;
|FPRC;

|PROCESO d_sPMI;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |BUCLE d_nomcalca;
|FPRC;

|DEFBUCLE PMIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, d_sPMI;
|FIN;

|PROCESO d_sPMIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE PMIGrupo;
     |SIGUE;
|FPRC;

|PROCESO d_seleccionPagMensuImpre;
    |SI #0#21  = 0;
        |SI #0#70 = 0;
            |HAZ d_sPMI;
        |SINO;
            |HAZ d_sPMIPorGrupos;
        |FINSI;
    |SINO;
        |HAZ d_salteada;
    |FINSI;
|FPRC;

|PROCESO procesoPagMensuImpre;
     lineas = 0;
     swbaja = 0;
     |DDEFECTO #10;
     nEmp = #93#0; nTra = #93#1;
     |HAZ comple_0;           || lee empresa, trabajador y constante
     |HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
     |SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
          |ACABA;
     |FINSI;
     nContrato = #93#9;
     |HAZ comple_1;           || construye literales datos empresa
     |HAZ comple_2;           || construye periodo de liquidacion nomina
     |HAZ comple_5PagMensu;   || CONSTRUYE FECHA LITERAL DEL RECIBI
     situac = 0; situac_ult = 0;
     aNormal = ""; aAgrupa = "";
     |BUCLELIN 0cargas_1PagMensuImpre#93;   || carga campos lineas calculos
     |HAZ comple_4PagMensu;   || halla totales varios
     |HAZ cargas_0PagMensuImpre;           || carga campos cabecera calculos
     |HAZ c400;
     |SI lineas = 1;              || para saber si hay conceptos 2?? !!!
             seleccio = 1;        || para saber si se ha leido algo
         |HAZ cargas_2PagMensuImpre;           || carga campos totales
         |HAZ graba_irpfpaga;
         |SI swPDFMasivo = 1;
             |HAZ PreparaPDF;
         |SINO;
              ||SI #0#67="M"; |Y #0#38="P"; |Y #0#69="P";
              ||      |HAZ imprimePagMensuPan;
              ||SINO;
                    nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion
                    |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                         |HAZ imprime;
                    |SIGUE;
              ||FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ordenaPagMensuImpre;
|DDEFECTO #1;
    #1#0 = #93#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #93#0;
    #2#1 = #93#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO cargas_0PagMensuImpre;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
    #10#122 = #2#33;          || grupo de cotizacion
    #10#135 = #93#87;          || (%) I.R.P.F.
    #10#141 = deducir;        || total a deducir
    #10#175 = #93#86;         || anticipos paga extra
    #10#139 = #93#86;         || total anticipos
     |SI Impresora ! "CrystalReport";
         #10#160 = #93#86;         || anticipos paga extra
         || para que en Word salgan impresos
     |FINSI;
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    alfa1 = #2#49 % 101;
|SI alfa1 ! "*";
        #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
|FINSI;
    aTipoIT = "54"; |HAZ LiteralIT;
    #10#150 = aValor; || literal
    #10#196 = nEmbargo;          || embargo

     nEmpresa=#93#0;   || empresa
     nTrabajador=#93#1;   || trabajador
     nAny = #0#4
     nMes=#93#2;   || mes
     nTipo=#93#3;   || tipo

     #10#166 = 0;
     #10#167 = 0;
     #10#168 = 0;
     |BUCLE nomhiccaHis;
     #10#166 = #10#166 + (#93#14 + #93#69 + #93#70 + #93#16);
     #10#167 = #10#167 + (#93#15 + #93#71 + #93#72 + #93#17);
     #10#168 = #10#168 + (#93#48 + #93#49 + #93#50 + #93#51);

     |HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1_ambosPagMensuImpre;
|SI swbaja = 1;
    |SI #2#48 = "N"; |O #1#25 ! 2;  incluye = 1;  |FINSI;  || si no es finiquito
|SINO;
    |SI #1#25 = 1;    incluye = 1;  |FINSI;  || si la paga va separada
|FINSI;
|SI incluye = 1;
        lineas = 1;   || para saber si se ha cargado algo de conceptos 2??
        camptas = situac + 22;
        camdesc = situac + 61;
        #10camptas = #10camptas + import;
        arteris = descri % 101;
    |SI arteris ! "*";
        |DDEFECTO #100; #100#0 = #2#87; #100#1 = concep; |LEE 000#100=;
            alfa1 = #100#2;     |QBF alfa1;
        |SI alfa1 ! "";
            descri = alfa1;
        |FINSI;
            |HAZ UnidadesConcepto;
            #10camdesc = descri;
    |SINO;
            #10camdesc = "";
    |FINSI;
    |HAZ Ampliada2;
    |SI concep = 101;
            dcal_101 = #94#05;
            duni_101 = unidad;
    |FINSI;
    |SI #10#19 < unidad;  #10#19 = unidad;  |FINSI;     || dias alta
    |SI concep ] 201; |Y concep < 208;
        |HAZ BuscaImpDifer;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO cargas_1_conPagMensuImpre;
|SI concep < 201; |O concep > 208; |O #94#5 = "X";
    |HAZ cargas_1_ambosPagMensuImpre;
|FINSI;
|FPRC;

|PROCESO cargas_1_sinPagMensuImpre;
|SI concep ] 201; |Y concep [ 208; |Y #94#5 ! "P";
    |HAZ cargas_1_ambosPagMensuImpre;
|FINSI;
|FPRC;

|PROCESO cargas_1PagMensuImpre;       || CARGA LOS CAMPOS SEGUN SU SITUACION
    incluye = 0;
    concep = #94#04;
    situac = #94#07;
    descri = #94#08;
    unidad = #94#11;      || unidades calculo
    valor  = #94#10;
    import = unidad * valor;
|SI situac ! 0;|Y import ! 0;
    |SI desglo = "N";   |HAZ cargas_1_sinPagMensuImpre;  |FINSI;
    |SI desglo = "S";   |HAZ cargas_1_conPagMensuImpre;  |FINSI;
|FINSI;
    |HAZ Dtos;
|FPRC;

|PROCESO cargas_2PagMensuImpre;       || CARGA LOS CAMPOS TOTALES
    #10#21 = duni_101;
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;   || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #93#16;                                    || base IRPF paga
    #10#138 = #93#17;                                    || ptas. IRPF paga
    #10#153 = #93#16;                                    || base IRPF paga
    #10#157 = #93#17;                                    || ptas. IRPF paga
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_4PagMensu;        || HALLA TOTALES VARIOS
     tbcotiz = #93#37 + #93#38;                      || total bases de cotizacion
     apordfp = 0;
     aporhe1 = 0;
     aporhe2 = 0;
     deducir = #93#17;                              || total a deducir (solo IRPF)
     deducir = deducir + #93#86;
     nEmbargo = 0;
     |SI #93#104 ! 0;
          nEmbargo = #93#104 - ((#93#104 * (#93#46 / (#93#46 + #93#47))) ! 2);
          |HAZ EmbargoPaga;
     |FINSI;
     deducir = deducir + nEmbargo;
|FPRC;

|PROCESO comple_5PagMensu;        || CONSTRUYE FECHA LITERAL DEL RECIBI
     |HAZ sibajaPagMensu;         || (tiene en cuenta si el trabajador es baja)
     fectra = #0#6;
     |HAZ FechaFijaRecibi;
     |HAZ lib_1;
     |SI diabaja ! 0; |Y diabaja < diatra;
        diarec = diabaja;
     |SINO;
        diarec = diatra;
     |FINSI;
     anyrec = anytra;
     mesnum = mestra;
     |HAZ lib_0;
     mesrec = mesalf;
|FPRC;


|PROCESO sibajaPagMensu;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #93#5 ! "          "; |Y #93#5 ! "..........";
        fectra = #93#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO graba_irpfpaga;
     |SI #0#4 < 80;
          anyo = #0#4 + 2000;
     |SINO;
          anyo = #0#4 + 1900;
     |FINSI;
     ||SI #0#5 = 12;                  ||  SOLO EN DICIEMBRE !!!!
          |ABRE #nomimpra;
          #nomimpra#0 = anyo;        ||  a¤o
          #nomimpra#1 = #0#5;        ||  mes
          #nomimpra#2 = #93#0;        ||  empresa
          |LEE 101#nomimpra.=;
          |SI FSalida ! 0;
               |GRABA 020#nomimpra.n;
          |SINO;
               |GRABA 020#nomimpra.a;
          |FINSI;
          |LIBERA #nomimpra;
          |CIERRA #nomimpra;
          |ABRE #nomimpre;
          #nomimpre#0 = anyo;        ||  a¤o
          #nomimpre#1 = #0#5;        ||  mes
          #nomimpre#2 = #93#0;        ||  empresa
          #nomimpre#3 = #93#1;        ||  trabajador
          #nomimpre#4 = 0;           ||  tipo
          #nomimpre#5 = "P";         ||  clase de nomina (por defecto de pagas)
          |LEE 101#nomimpre.=;
          #nomimpre#6 = #93#87;       ||  (%) IRPF paga extra
          #nomimpre#7 = #2#2;       ||  nombre trabajador
          |SI FSalida ! 0;
               |GRABA 020#nomimpre.n;
          |SINO;
               |GRABA 020#nomimpre.a;
          |FINSI;
          |LIBERA #nomimpre;
          |CIERRA #nomimpre;
     ||FINSI;

          |HAZ grabapaga;
|FPRC;

|PROCESO graba_irpfpagaHis;
     |SI #0#4 < 80;
          anyo = #0#4 + 2000;
     |SINO;
          anyo = #0#4 + 1900;
     |FINSI;
     ||SI #0#5 = 12;                  ||  SOLO EN DICIEMBRE !!!!
          anypaga = 0; anypaga = 2000 + #0#4;
          |ABRE #nomimpra;
          #nomimpra#0 = anypaga;        ||  a¤o
          #nomimpra#1 = #0#5;        ||  mes
          #nomimpra#2 = #95#0;        ||  empresa
          |LEE 101#nomimpra.=;
          |SI FSalida ! 0;
               |GRABA 020#nomimpra.n;
          |SINO;
               |GRABA 020#nomimpra.a;
          |FINSI;
          |LIBERA #nomimpra;
          |CIERRA #nomimpra;
          |ABRE #nomimpre;
          #nomimpre#0 = anypaga;        ||  a¤o
          #nomimpre#1 = #0#5;        ||  mes
          #nomimpre#2 = #95#0;        ||  empresa
          #nomimpre#3 = #95#1;        ||  trabajador
          #nomimpre#4 = 0;           ||  tipo
          #nomimpre#5 = "P";         ||  clase de nomina (por defecto de pagas)
          |LEE 101#nomimpre.=;
          #nomimpre#6 = #95#129;       ||  (%) IRPF paga extra
          #nomimpre#7 = #2#2;        ||  nombre trabajador
          |SI FSalida ! 0;
               |GRABA 020#nomimpre.n;
          |SINO;
               |GRABA 020#nomimpre.a;
          |FINSI;
          |LIBERA #nomimpre;
          |CIERRA #nomimpre;
     ||FINSI;
|FPRC;

/*****************************************************************/
/*  MENSUAL-PAGAS-ABIERTA                                         */
/*****************************************************************/

|PROCESO procesoPagMensuAb;
     seleccio = 1;   || para saber si se ha leido algo
     lineas = 0;
     swbaja = 0;
     |DDEFECTO #10;
     |DDEFECTO #15;
     nEmp = #93#0; nTra = #93#1;
     |HAZ comple_0;     || lee empresa, trabajador y constante
     |HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
     |SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
          |ACABA;
     |FINSI;
     nContrato = #93#9;
     |HAZ comple_1;           || construye literales datos empresa
     |HAZ comple_2;           || construye periodo de liquidacion nomina
     |HAZ comple_5PagMensu;     || CONSTRUYE FECHA LITERAL DEL RECIBI
     situac = 0; situac_ult = 0;
     aNormal = ""; aAgrupa = "";
     |BUCLELIN 0cargas_1PagMensuAb#93;   || carga campos lineas calculos
     |HAZ comple_4PagMensu;   || halla totales varios
     |HAZ cargas_0PagMensuAb;           || carga campos cabecera calculos
     |SI lineas = 1;              || para saber si hay conceptos 2?? !!!
          |HAZ cargas_2PagMensuAb;           || carga campos totales
          |HAZ graba_irpfpaga;
          |SI nOpcion = 2;
               |HAZ IMPREArchi;
          |SINO;
               |INFOR "nomyabie";
          |FINSI;
          alguno = 0;
          ninguno = 0;
          situac2 = 0;
          |PARA situac = 1; |SI situac [ 39; |HACIENDO situac = situac + 1;
               camctos = situac + 116;  infctos = #15camctos;
               camptas = situac + 22;   infptas = #10camptas;
               camdesc = situac + 77;   infdesc = #15camdesc;
               camunid = situac -  1;   infunid = #15camunid;
               camvalo = situac + 38;   infvalo = #15camvalo;
               camunia = situac + 155;  infunia = #15camunia;
                                        retoded = "R";
               |SI infptas ! 0;
                    alguno = 1;
                    ninguno = ninguno + 1;
                    |PRINT;
                    |SI ninguno = 15;
                         situac2 = situac + 1;
                         situac = 39;
                    |FINSI;
               |FINSI;
          |SIGUE;
          linea16 = 0;
          |SI situac2 ! 0;
               |PARA situac=situac2;|SI situac[39; |HACIENDO situac=situac+1;
                    camctos = situac + 116;  infctos = #15camctos;
                    camptas = situac + 22;   infptas = #10camptas;
                    camdesc = situac + 77;   infdesc = #15camdesc;
                    camunid = situac -  1;   infunid = #15camunid;
                    camvalo = situac + 38;   infvalo = #15camvalo;
                    camunia = situac + 155;  infunia = #15camunia;
                    linea16 = linea16 + infptas;
               |SIGUE;
               |SI linea16 ! 0;
                    alguno = 1; infctos = 0;
                    infptas = linea16;
                    infdesc = "GLOBAL VARIOS ...";
                    infunid = 1; infunia = 1; infvalo = 1;
                    |PRINT;
               |FINSI;
          |FINSI;
          aAlfa = Impresora; |QBF aAlfa; aAlfa = aAlfa % 113;
          |SI alguno = 1; |O aAlfa = "CrystalReport";
               |HAZ LineasDto;
               |SI Impresora = "CrystalReport";
                    |HAZ imprime;
               |SINO;
                    |PIEINF;
                    |HAZ ElFININF;
               |FINSI;
          |SINO;
               |SI #10#142 ! 0;
                    infctos = 0; infptas = 0;
                    infdesc = "-------------------------";
                    infunid = 0; infunia = 0; infvalo = 0;
                    |PRINT;
                    |HAZ imprime;
               |SINO;
                    |HAZ ElFININF;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomypaga0PagMensuAb;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, procesoPagMensuAb;
|FIN;

|DEFBUCLE nombresPagMensuAb;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuAb, NULL, NULL, NULL, procesoPagMensuAb;
 #2#0, #2#2, #2#1, #93#3;
|FIN;

|DEFBUCLE areasPagMensuAb;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuAb, NULL, NULL, NULL, procesoPagMensuAb;
 #2#0, #2#62, #2#63, #2#1, #93#3;
|FIN;

|DEFBUCLE centrosPagMensuAb;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuAb, NULL, NULL, NULL, procesoPagMensuAb;
 #2#0, #2#77, #2#1, #93#3;
|FIN;

|DEFBUCLE tc2PagMensuAb;
 #93#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, ordenaPagMensuAb, NULL, NULL, NULL, procesoPagMensuAb;
 #2#0, #0#64, #102#142, #2#75, #2#1, #93#3;
|FIN;

|PROCESO desglosaPagMensuAb;
|SI desglo = "S";
    |MENSA "0402Preparando desglose ...";
    |HAZ control;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "c" + dalfa1;
    |NOME_DAT #93 dalfa1; |DELINDEX #93;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "l" + dalfa1;
    |NOME_DAT #94 dalfa1; |DELINDEX #94;
    |ABRE #2;            || trabajadores
    |ABRE #93;            || tmp. calculos cabs.
    |ABRE #94;            || tmp. calculos lins.
    |ABRE #5;           || calculos lins.
    |ABRE #102;           || convenios cabs.
    |HAZ d_seleccionPagMensuAb;
    |CIERRA #2;
    |CIERRA #93;
    |CIERRA #94;
    |CIERRA #5;
    |CIERRA #102;
    |BLIN 4;
|SINO;
    |NOME_DAT #93 "nomcalca"; || ni se te ocurra hacer aqui DELINDEX
    |NOME_DAT #94 "nomcalli";
|FINSI;
|FPRC;

|PROCESO impreMPA2;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomypaga0PagMensuAb;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresPagMensuAb;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasPagMensuAb;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosPagMensuAb;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2PagMensuAb;         |FINSI;
|FPRC;

|DEFBUCLE MPAGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreMPA2;
|FIN;

|PROCESO MPAPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE MPAGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreMPA; |TIPO 3;
     c_informe = "nomyabie";
     |HAZ cuadres;
     |SI sw_cuadre = 0;
          desglo = #0#14;
          aOrden = #0#63;
          |HAZ desglosaPagMensuAb;
          |ABRE #1;
          |ABRE #2;
          |ABRE #3;
          |ABRE #6;
          |ABRE #12;
          |ABRE #35;
          |ABRE #102;
          |HAZ ElIMPRE;
          |SI FEstado = 0;
               |HAZ control;
               seleccio = 0;
               |SI #0#21 = 0;
                    |SI #0#70 = 0;
                         |HAZ impreMPA2;
                    |SINO;
                         |HAZ MPAPorGrupos;
                    |FINSI;
               |SINO;
                    |HAZ salteadaPagasMensu;
               |FINSI;
          |SINO;
               |MENAV "    Proceso ABORTADO !!!";
          |FINSI;
          |HAZ ElFINIMP;
          |SI seleccio = 0;
               |MENAV "    Seleccion vacia ...";
          |FINSI;
          |CIERRA #1;
          |CIERRA #2;
          |CIERRA #3;
          |CIERRA #6;
          |CIERRA #12;
          |CIERRA #35;
          |CIERRA #102;
          |SI desglo = "S";
               |DELINDEX #93;
               |DELINDEX #94;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ordenaPagMensuAb;
|DDEFECTO #1;
    #1#0 = #93#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #93#0;
    #2#1 = #93#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO cargas_0PagMensuAb;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
    #10#122 = #2#33;          || grupo de cotizacion
    #10#135 = #93#87;          || (%) I.R.P.F.
    #10#141 = deducir;        || total a deducir
    #10#139 = #93#86;         || total anticipos
    #10#175 = #93#86;         || anticipos paga extra
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    alfa1 = #2#49 % 101;
|SI alfa1 ! "*";
            #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
|FINSI;
     aTipoIT = "54"; |HAZ LiteralIT;
    #10#150 = aValor;  || literal

nEmpresa=#93#0;   || empresa
nTrabajador=#93#1;   || trabajador
nMes=#93#2;   || mes
nTipo=#93#3;   || tipo
|HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1_ambosPagMensuAb;
|SI swbaja = 1;
    |SI #2#48 = "N"; |O #1#25 ! 2; incluye = 1;  |FINSI;  || si no es finiquito
|SINO;
    |SI #1#25 = 1;    incluye = 1;  |FINSI;  || si la paga va separada
|FINSI;
|SI incluye = 1;
        lineas = 1;   || para saber si se ha cargado algo de conceptos 2??
    |HAZ leedescriPagMensuAb;
        camptas = situac + 22;
        camdesc = situac + 77;
        camunid = situac -  1;
        camvalo = situac + 38;
        camunia = situac + 155;
        aAlfa = #100#2; |QBF aAlfa;
        |SI aAlfa ! "";
              #15camdesc = #100#2;                      || descripcion ampliada
        |FINSI;
        |HAZ Ampliada2;
        #10camptas = #10camptas + import;        || devengado
    |SI concep = 515;
            #15camunid = 0;        || unidades cero en ENF.EMP.
            #15camunia = 0;
            #15camvalo = #93#35;    || promedio de enfermedad en ENF.EMP.
    |SINO;
            #15camunia = #15camunia + uniant;        || unidades anterior
            #15camunid = #15camunid + unidad;        || unidades
            #15camvalo = #10camptas / #15camunid;    || valor base
    |FINSI;
    |SI concep = 101;
            dcal_101 = #94#05;
            duni_101 = unidad;
    |FINSI;
    |SI #10#19 < unidad;  #10#19 = unidad;  |FINSI;     || dias alta
    |SI concep ] 201; |Y concep < 208;
        |HAZ BuscaImpDifer;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO cargas_1_conPagMensuAb;
|SI concep < 201; |O concep > 208; |O #94#5 = "X";
    |HAZ cargas_1_ambosPagMensuAb;
|FINSI;
|FPRC;

|PROCESO cargas_1_sinPagMensuAb;
|SI concep ] 201; |Y concep [ 208; |Y #94#5 ! "P";
    |HAZ cargas_1_ambosPagMensuAb;
|FINSI;
|FPRC;

|PROCESO cargas_1PagMensuAb;       || CARGA LOS CAMPOS SEGUN SU SITUACION
    incluye = 0;
    concep = #94#04;
    situac = #94#07;
    descri = #94#08;
    unidad = #94#11;      || unidades calculo
    uniant = #94#09;
    valor  = #94#10;
    import = unidad * valor;
|SI situac ! 0;|Y import ! 0;
    |SI desglo = "N";   |HAZ cargas_1_sinPagMensuAb;  |FINSI;
    |SI desglo = "S";   |HAZ cargas_1_conPagMensuAb;  |FINSI;
|FINSI;
     |HAZ Dtos;
|FPRC;

|PROCESO cargas_2PagMensuAb;       || CARGA LOS CAMPOS TOTALES
    #10#21 = duni_101;
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;   || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #93#16;                                    || base IRPF paga
    #10#138 = #93#17;                                    || ptas. IRPF paga
    #10#153 = #93#16;                                    || base IRPF paga
    #10#157 = #93#17;                                    || ptas. IRPF paga
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|DEFBUCLE d_nomcalcaPagMensuAb;
 #4#1;
 ;
 nDesdeEmp, nDesdeTra, #0#5, 0;
 nHastaEmp, nHastaTra, #0#5, 0;
 ;
 NULL, d_proceso_cabPagMensuImpre;
|FIN;

|PROCESO d_salteadaPagMensuAb;
|ABRE #4;
|PARA dsalte_1 = 21; |SI dsalte_1 [ 41; |HACIENDO dsalte_1 = dsalte_1 + 1;
        dsalte_2 = dsalte_1 + 21;
        #4#0 = #0dsalte_1;   || empresa
        #4#1 = #0dsalte_2;   || trabajador
        #4#2 = #0#5;         || mes
        #4#3 = 0;            || tipo
    |LEE 000#4=;
    |SI FSalida = 0;
        |HAZ d_proceso_cabPagMensuImpre;
    |FINSI;
|SIGUE;
|CIERRA #4;
|FPRC;

|PROCESO d_sPMA;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |BUCLE d_nomcalcaPagMensuAb;
|FPRC;

|DEFBUCLE PMAGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, d_sPMA;
|FIN;

|PROCESO d_sPMAPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE PMAGrupo;
     |SIGUE;
|FPRC;

|PROCESO d_seleccionPagMensuAb;
|SI #0#21  = 0;
    |SI #0#70 = 0;
        |HAZ d_sPMA;
    |SINO;
        |HAZ d_sPMAPorGrupos;
    |FINSI;
|SINO;
    |HAZ d_salteadaPagMensuAb;
|FINSI;
|FPRC;

/*****************************************************************/
/*  HISTORICO-PAGAS-IMPRESORA                                     */
/*****************************************************************/
|DEFBUCLE nomwpaga0;
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, procesoPagHistoImpre;
|FIN;

|DEFBUCLE EmpTraPagHistoImpre;     || por nombre empresa, codigo trabajador
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, ordenaPagHistoImpre, NULL, NULL, NULL, procesoPagHistoImpre;
 #1#0, #2#0, #2#1, #95#3;
|FIN;

|DEFBUCLE nombresPagHistoImpre;
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, ordenaPagHistoImpre, NULL, NULL, NULL, procesoPagHistoImpre;
 #2#0, #2#2, #2#1, #95#3;
|FIN;

|DEFBUCLE areasPagHistoImpre;
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, ordenaPagHistoImpre, NULL, NULL, NULL, procesoPagHistoImpre;
 #2#0, #2#62, #2#63, #2#1, #95#3;
|FIN;

|DEFBUCLE centrosPagHistoImpre;
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, ordenaPagHistoImpre, NULL, NULL, NULL, procesoPagHistoImpre;
 #2#0, #2#77, #2#1, #95#3;
|FIN;

|DEFBUCLE tc2PagHistoImpre;
 #95#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, ordenaPagHistoImpre, NULL, NULL, NULL, procesoPagHistoImpre;
 #2#0, #0#64, #102#142, #2#75, #2#1, #95#3;
|FIN;

|PROCESO impreHPI2;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #0#63 = 1;    |BUCLE nomwpaga0;   |FINSI;
     |SI #0#63 = 2;    |BUCLE nombresPagHistoImpre;     |FINSI;
     |SI #0#63 = 3;    |BUCLE areasPagHistoImpre;       |FINSI;
     |SI #0#63 = 4;    |BUCLE centrosPagHistoImpre;     |FINSI;
     |SI #0#63 = 5;    |BUCLE tc2PagHistoImpre;         |FINSI;
     |SI #0#63 = 6;    |BUCLE EmpTraPagHistoImpre;     |FINSI;
|FPRC;

|DEFBUCLE HPIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, impreHPI2;
|FIN;

|PROCESO HPIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE HPIGrupo;
     |SIGUE;
|FPRC;

|PROCESO impreHPI; |TIPO 3;
    c_informe = "nomyreci";
|HAZ cuadres;
|SI sw_cuadre = 0;
        desglo = #0#14;
    |HAZ desglosaPagHistoImpre;
    |HAZ control;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
            seleccio = 0;
        |SI #0#21 = 0;
            |SI #0#70 = 0;
                |HAZ impreHPI2;
            |SINO;
                |HAZ HPIPorGrupos;
            |FINSI;
        |SINO;
            |HAZ salteadaPagasHisto;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
    |SI desglo = "S";
        |DELINDEX #95;
        |DELINDEX #96;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE d_nomcalcaPagHistoImpre;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, 0;
 nHastaEmp, nHastaTra, #0#4, #0#5, 0;
 ;
 NULL, d_proceso_cabPagHistoImpre;
|FIN;

|PROCESO d_salteadaPagHistoImpre;
|ABRE #11;
|PARA dsalte_1 = 21; |SI dsalte_1 [ 41; |HACIENDO dsalte_1 = dsalte_1 + 1;
        dsalte_2 = dsalte_1 + 21;
        #11#0 = #0dsalte_1;   || empresa
        #11#1 = #0dsalte_2;   || trabajador
        #11#66 = #0#4;        || a¤o
        #11#2 = #0#5;         || mes
        #11#3 = 0;            || tipo
    |LEE 000#11=;
    |SI FSalida = 0;
        |HAZ d_proceso_cabPagHistoImpre;
    |FINSI;
|SIGUE;
|CIERRA #11;
|FPRC;

|PROCESO d_sPHI;
     |SI swPorGrupos = 0;
          nDesdeEmp = #0#0;
          nHastaEmp = #0#1;
          nDesdeTra = #0#2;
          nHastaTra = #0#3;
     |SINO;
          nDesdeEmp = #nomgruel#1;
          nHastaEmp = #nomgruel#1;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |BUCLE d_nomcalcaPagHistoImpre;
|FPRC;

|DEFBUCLE PHIGrupo;         || lee empresas del grupo
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, d_sPHI;
|FIN;

|PROCESO d_sPHIPorGrupos;
     swPorGrupos = 1;
     |PARA nCampoG = 70; |SI nCampoG [ 77; |HACIENDO nCampoG = nCampoG + 1;
          nGrupo = #0nCampoG;
          |BUCLE PHIGrupo;
     |SIGUE;
|FPRC;

|PROCESO d_seleccionPagHistoImpre;
|SI #0#21 = 0;
    |SI #0#70 = 0;
        |HAZ d_sPHI;
    |SINO;
        |HAZ d_sPHIPorGrupos;
    |FINSI;
|SINO;
    |HAZ d_salteadaPagHistoImpre;
|FINSI;
|FPRC;

|PROCESO d_grabaPagHistoImpre;
|DDEFECTO #96;
    #96#0 = #12#0;    || empresa
    #96#1 = #12#1;    || trabajador
    #96#12= #12#12;   || a¤o
    #96#2 = #12#2;    || mes
    #96#3 = #12#3;    || tipo
    #96#4 = #12#4;    || concepto
|LEE 101#96=;
    d_entrada = FSalida;

    #96#5 = #12#5;    || tipo calculo alf.
|SI concepto ] 201;|Y concepto [ 208;   || con la X fuerza a los 200
        #96#5 = "X";                     ||/que se contienen en pagas a
|FINSI;                                 ||/que se emitan
    #96#6 = #12#6;   || tipo calculo num.
    #96#7 = #12#7;   || situacion
    #96#8 = #12#8;   || descripcion

    dcociente = (product / divide) ! (2+EURODB);
    dprod_200 = dprod_200 - (dcociente * duni2_200);
|SI d_campo = concep1;
        dcociente = dcociente + (dprod_200 / duni2_200);
        dcociente = dcociente ! (2+EURODB);
|FINSI;                                 || ajusta posibles diferencias

|SI d_entrada ! 0;
        #96#9 = duni2_200;     || unidades
        #96#10= dcociente;     || valor
|SINO;
    |SI #96#9 = duni2_200;               || unidades del mismo tipo
            #96#10 = #96#10 + dcociente;  ||/suma los valores
    |SINO;
        |SI #96#10 = dcociente;          || valores del mismo tipo
                #96#9 = #96#9 + duni2_200;||/suma las unidades
        |SINO;
                dnume1 = (#96#9 * #96#10) ! EURODB;  || lo que hay grabado
                dnume2 = (duni2_200 * dcociente);    || lo que hay que a¤adir
                #96#9 = 1;
                #96#10 = dnume1 + dnume2;            || el resultado
        |FINSI;
    |FINSI;
|FINSI;
    #96#11= #96#9;    || unidades calculo

|SI d_entrada ! 0;   |GRABA 020#96n; |FINSI;
|SI d_entrada = 0;   |GRABA 020#96a; |FINSI;
|LIBERA #96;
|FPRC;

|PROCESO d_dividePagHistoImpre;
|SI #12#5="D";                            divide = dia_2;        |FINSI;
|SI #12#5="M";                            divide = dia_4;        |FINSI;
|SI #12#5="L";|O #12#5="K";               divide = duni1_999;    |FINSI;
|SI #12#5="V";|O #12#5="F";|O #12#5="A";  divide = 30;           |FINSI;
|SI #2#42 = "I";|O #2#42 = "P";
    |DDEFECTO #99;
    |ABRE #99;                || si se carga con los dias de alta
        #99#0 = #2#87;        ||/se divide por los mismos
        #99#1 = #12#4;
    |LEE 000#99=;
    |SI #99#3 = "S";     divide = #11#8;  |FINSI;
    |CIERRA #99;
|FINSI;
|FPRC;

|PROCESO d_cal_valoPagHistoImpre;
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|HAZ d_dividePagHistoImpre;
|SI sd_bucle = 1;
        dreal_200 = dreal_200 + (product / divide);
|SINO;
    |HAZ d_grabaPagHistoImpre;
|FINSI;
|FPRC;

|PROCESO d_leeconcepPagHistoImpre;
    #12#0 = #11#0;       || empresa
    #12#1 = #11#1;       || trabajador
    #12#12= #11#66;      || a¤o
    #12#2 = #11#2;       || mes
    #12#3 = #11#3;       || tipo
    #12#4 = concepto;    || concepto
|LEE 000#12=;
|SI FSalida = 0;
        duni1_999 = #12#9;
        duni2_999 = #12#11;
        dvalo_999 = #12#10;
    |SI #12#5="F";|Y duni1_999=0;|Y concepto!102; || si es calculo 'F' carga
            duni1_999 = 1;                        ||/las unidades con 1 !!!
    |FINSI;
    |HAZ d_cal_valoPagHistoImpre;
|FINSI;
|FPRC;

|PROCESO d_buclePagHistoImpre;
    concep1 = 51 + d_paga;      || calcula el 1er. campo de conceptos
    concep2 = concep1 + 32;     || calcula el ultimo campo de concep.
|PARA d_campo = concep2;|SI d_campo ] concep1;|HACIENDO d_campo = d_campo - 8;
    |SI #102d_campo ! 0;
                            desc = #102d_campo; hasc = #102d_campo;
        |SI #102d_campo = 100; desc = 101;      hasc = 199;     |FINSI;
        |SI #102d_campo = 400; desc = 401;      hasc = 420;     |FINSI;
        |PARA actc = desc;|SI actc [ hasc;|HACIENDO actc = actc + 1;
                concepto = actc;
            |HAZ d_leeconcepPagHistoImpre;
        |SIGUE;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO d_proceso_linPagHistoImpre;
    #12#0 = #11#0;       || empresa
    #12#1 = #11#1;       || trabajador
    #12#12= #11#66;      || a¤o
    #12#2 = #11#2;       || mes
    #12#3 = #11#3;       || tipo
    #12#4 = d_conc;      || concepto
|LEE 000#12=;
|SI FSalida = 0;|Y #12#11 ! 0;|Y #12#5 ! "P";|Y #12#7 ! 0;
        duni2_200 = #12#11;
        dvalo_200 = #12#10;
        dprod_200 = (duni2_200 * dvalo_200) ! EURODB;

    |SI #2d_tipo_p = "V";|Y #102d_tipos = "N"; || !!pagas normales
        |SI #102#140 = "N";                    || ctos.400 sin prorrateo:
                dreal_200 = 0;                ||/calcula el valor real
                sd_bucle = 1;  |HAZ d_buclePagHistoImpre;  ||/y las unidades reales
                dreal_200 = dreal_200 ! (2+EURODB);
                duni2_200 = ((dvalo_200 * duni2_200) / dreal_200) ! 6;
        |FINSI;
            sd_bucle = 2;  |HAZ d_buclePagHistoImpre;
    |SINO;                    || !!pagas ajustadas o porcentuales
        |PARA d_para1 = 0; |SI d_para1 [ 12; |HACIENDO d_para1 = d_para1 + 1;
                #96d_para1 = #12d_para1;
        |SIGUE;
            #96#5 = "X";
        |GRABA 020#96n;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO d_proceso_cabPagHistoImpre;
    #2#0 = #11#0;
    #2#1 = #11#1;
|LEE 000#2=;                  || lee trabajador
|SI FSalida = 0;
        #102#0 = #2#87;
    |LEE 000#102=;             || lee convenio
    |SI FSalida = 0;
        |PARA d_para1 = 0; |SI d_para1 [ 130; |HACIENDO d_para1 = d_para1 + 1;
                #95d_para1 = #11d_para1;
        |SIGUE;
        |GRABA 020#95n;
        |SI FSalida = 0;
            |HAZ dias_coti;
            |PARA d_paga = 1; |SI d_paga [ 8; |HACIENDO d_paga = d_paga + 1;
                    d_tipos = d_paga + 27;   || tipo de paga
                    d_diasp = d_paga + 35;   || dias
                    d_porcp = d_paga + 43;   || porcentaje
                    d_conc = d_paga + 200;   || concepto de paga
                    d_tipo_p = d_paga + 156; || tipo ajuste paga
                |SI #102d_diasp ! 0;|O #102d_porcp ! 0;
                    |HAZ d_proceso_linPagHistoImpre;
                |FINSI;
            |SIGUE;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO desglosaPagHistoImpre;
|SI desglo = "S";
    |MENSA "0402Preparando desglose ...";
    |HAZ control;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "c" + dalfa1;
    |NOME_DAT #95 dalfa1; |DELINDEX #95;
        dalfa1 = Usuario; |QBF dalfa1; dalfa1 = "l" + dalfa1;
    |NOME_DAT #96 dalfa1; |DELINDEX #96;
    |ABRE #2;            || trabajadores
    |ABRE #95;            || tmp. calculos cabs.
    |ABRE #96;            || tmp. calculos lins.
    |ABRE #12;           || calculos lins.
    |ABRE #102;           || convenios cabs.
    |HAZ d_seleccionPagHistoImpre;
    |CIERRA #2; |CIERRA #95; |CIERRA #96; |CIERRA #12; |CIERRA #102;
    |BLIN 4;
|SINO;
    |NOME_DAT #95 "nomhicca"; || ni se te ocurra hacer aqui DELINDEX
    |NOME_DAT #96 "nomhicli";
|FINSI;
|FPRC;

|PROCESO salteadaPagasHisto
|ABRE #95;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
        #95#0 = #0salte_1;     || empresa
        #95#1 = #0salte_2;     || trabajador
        #95#2 = #0#5;          || mes
        #95#3 = #0#10;         || tipo
        #95#66 = #0#4;         || a¤o (en las emisiones desde el historico)
    |LEE 001#95=;
    |SI FSalida = 0;
          |SI #0#69="I";
               |HAZ procesoPagHistoImpre;
          |FINSI;
          |SI #0#69="A";
               |HAZ procesoPagHistoAb;
          |FINSI;
    |FINSI;
|SIGUE;
|CIERRA #95;
|FPRC;

|PROCESO procesoPagHistoImpre;
    lineas = 0;
    swbaja = 0;
|DDEFECTO #10;
nEmp = #95#0; nTra = #95#1;
|HAZ comple_0;           || lee empresa, trabajador y constante
|SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
     |ACABA;
|FINSI;
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
nContrato = #95#9;
|HAZ comple_1;           || construye literales datos empresa
|HAZ comple_2;           || construye periodo de liquidacion nomina
|HAZ comple_5PagHisto;     || CONSTRUYE FECHA LITERAL DEL RECIBI
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1PagHistoImpre#95;   || carga campos lineas calculos
|HAZ comple_4PagHisto;   || halla totales varios
|HAZ cargas_0PagHistoImpre;           || carga campos cabecera calculos
|HAZ c400;
|SI lineas = 1;              || para saber si hay conceptos 2?? !!!
        seleccio = 1;        || para saber si se ha leido algo
    |HAZ cargas_2PagHistoImpre;           || carga campos totales
    |HAZ graba_irpfpagaHis;
    |SI swPDFMasivo = 1;
        |HAZ PreparaPDF;
    |SINO;
        ||SI #0#69="P";
              ||HAZ imprimePagHistoPan;
        ||SINO;
             nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion
             |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                  |HAZ imprime;
             |SIGUE;
        ||FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO ordenaPagHistoImpre;
|DDEFECTO #1;
    #1#0 = #95#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #95#0;
    #2#1 = #95#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO cargas_0PagHistoImpre;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#17 = mesliq;         || hasta el mes
    #10#18 = #0#04;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
    #10#122 = #2#33;          || grupo de cotizacion
    #10#135 = #95#129;          || (%) I.R.P.F.
    #10#141 = deducir;        || total a deducir
    #10#175 = #95#128;         || anticipos paga extra
    #10#139 = #95#128;         || total anticipos
     |SI Impresora ! "CrystalReport";
         #10#160 = #95#128;         || anticipos paga extra
         || para que en Word salgan impresos
     |FINSI;
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    alfa1 = #2#49 % 101;
|SI alfa1 ! "*";
            #10#146 = #2#49; #10#147 = ""; #10#148 = ""; #10#149 = "";
|FINSI;
    aTipoIT = "54"; |HAZ LiteralIT;
    #10#150 = aValor;        || literal
    #10#153 = #95#16;          || base IRPF
    #10#196 = nEmbargo;          || embargo

nEmpresa=#95#0;   || empresa
nTrabajador=#95#1;   || trabajador
nMes=#95#2;   || mes
nTipo=#95#3;   || tipo
nAny = #95#66;
|HAZ ComentariosNomvarca;

|BUCLE nomhiccaHis;
|FPRC;

|PROCESO cargas_1_ambosPagHistoImpre;
|SI swbaja = 1;
    |SI #2#48 = "N"; |O #1#25 ! 2; incluye = 1;  |FINSI;  || si no es finiquito
|SINO;
    |SI #1#25 = 1;    incluye = 1;  |FINSI;  || si la paga va separada
|FINSI;
|SI incluye = 1;
        lineas = 1;   || para saber si se ha cargado algo de conceptos 2??
        camptas = situac + 22;
        camdesc = situac + 61;
        #10camptas = #10camptas + import;
        arteris = descri % 101;
    |SI arteris ! "*";
        |DDEFECTO #100; #100#0 = #2#87; #100#1 = concep; |LEE 000#100=;
            alfa1 = #100#2;     |QBF alfa1;
        |SI alfa1 ! "";
            descri = alfa1;
        |FINSI;
        |HAZ UnidadesConcepto;
        #10camdesc = descri;
    |SINO;
            #10camdesc = "";
    |FINSI;
    |HAZ Ampliada2;
    |SI concep = 101;
            dcal_101 = #96#05;
            duni_101 = unidad;
    |FINSI;
    |SI #10#19 < unidad;  #10#19 = unidad;  |FINSI;     || dias alta
    |SI concep ] 201; |Y concep < 208;
        |HAZ BuscaImpDifer;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO cargas_1_conPagHistoImpre;
|SI concep < 201; |O concep > 208; |O #96#5 = "X";
    |HAZ cargas_1_ambosPagHistoImpre;
|FINSI;
|FPRC;

|PROCESO cargas_1_sinPagHistoImpre;
|SI concep ] 201; |Y concep [ 208; |Y #96#5 ! "P";
    |HAZ cargas_1_ambosPagHistoImpre;
|FINSI;
|FPRC;

|PROCESO cargas_1PagHistoImpre;       || CARGA LOS CAMPOS SEGUN SU SITUACION
    incluye = 0;
    concep = #96#04;
    situac = #96#07;
    descri = #96#08;
    unidad = #96#11;      || unidades calculo
    valor  = #96#10;
    import = unidad * valor;
|SI situac ! 0;|Y import ! 0;
    |SI desglo = "N";   |HAZ cargas_1_sinPagHistoImpre;  |FINSI;
    |SI desglo = "S";   |HAZ cargas_1_conPagHistoImpre;  |FINSI;
|FINSI;
|HAZ Dtos;
|FPRC;

|PROCESO cargas_2PagHistoImpre;       || CARGA LOS CAMPOS TOTALES
    #10#21 = duni_101;
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;   || si valor es 0, unidades tambien
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #95#16;                                    || base IRPF paga
    #10#138 = #95#17;                                    || ptas. IRPF paga
    #10#153 = #95#16;                                    || base IRPF paga
    #10#157 = #95#17;                                    || ptas. IRPF paga
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_4PagHisto;        || HALLA TOTALES VARIOS
    tbcotiz = #95#37 + #95#38;                      || total bases de cotizacion
        apordfp = 0;
        aporhe1 = 0;
        aporhe2 = 0;
    deducir = #95#17 + #95#128;                      || total a deducir (solo IRPF)
    nEmbargo = 0;
    |SI #95#146 ! 0;
         nEmbargo = #95#146 - ((#95#146 * (#95#46 / (#95#46 + #95#47))) ! 2);
         |HAZ EmbargoPaga;
    |FINSI;
    deducir = deducir + nEmbargo;
|FPRC;

|PROCESO comple_5PagHisto;        || CONSTRUYE FECHA LITERAL DEL RECIBI
     |HAZ sibajaPagHisto;         || (tiene en cuenta si el trabajador es baja)
     fectra = #0#6;
     |HAZ FechaFijaRecibi;
     |HAZ lib_1;
     |SI diabaja ! 0; |Y diabaja < diatra;
          diarec = diabaja;
     |SINO;
          diarec = diatra;
     |FINSI;
     anyrec = anytra;
     mesnum = mestra;
     |HAZ lib_0;
     mesrec = mesalf;
|FPRC;

|PROCESO sibajaPagHisto;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #95#5 ! "          "; |Y #95#5 ! "..........";
        fectra = #95#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y #0#4 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

/*****************************************************************/
/*  ATRASOS-HISTORICO-NOMINAS-ABIERTA                            */
/*****************************************************************/

|PROCESO procesoAtHisAb;
|SI sw_control = 0; |HAZ control;  sw_control = 1;     |FINSI;
    seleccio = 1;   || para saber si se ha leido algo
|SI ante_tra=0;  ante_emp = #11#0;  ante_tra = #11#1;  |FINSI;
|SI #0#10 = 2;
    |SI ante_emp ! #11#0; |O ante_tra ! #11#1;
        |SI lineas = 1;
            |HAZ comple_6AtHisAb;
        |FINSI;
    |FINSI;
|FINSI;
    lineas = 0;     || para saber si los conceptos leidos son buenos
    swbaja = 0;
nEmp = #nomhicca#0; nTra = #nomhicca#1;
|HAZ comple_0;     || lee empresa, trabajador y constante
|HAZ StopComercio; |SI swStop = 1; |ACABA; |FINSI;
|SI #0#66 < #2#77;|O #0#65 > #2#77;     || seleccion centros
     |ACABA;
|FINSI;
nContrato = #13#9;
|HAZ comple_1;          || construye literales datos empresa
|HAZ comple_2AtHisAb;   || construye periodo de liquidacion nomina
|HAZ comple_3AtHisAb;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_3_1_AtrasImpre;   || construye periodo de liquidacion de enferm. y accte.
|HAZ comple_4AtHisAb;   || halla totales varios
|HAZ SS_Empresa;
|HAZ comple_5AtHisAb;     || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ cargas_0AtHisAb;           || carga campos cabecera calculos
situac = 0; situac_ult = 0;
aNormal = ""; aAgrupa = "";
|BUCLELIN 0cargas_1AtHisAb#11;   || carga campos lineas calculos
    ante_emp = #11#0;
    ante_tra = #11#1;
|SI lineas = 1;
    |HAZ cargas_2AtHisAb;       || carga campos totales
     |HAZ BuscaBanco;
    |SI #0#10 = 1;
        |HAZ comple_6AtHisAb;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE nomtreci0Abierta;
 #11#1;
 ;
 nDesdeEmp, nDesdeTra, #0#4, #0#5, enTipoAt;
 nHastaEmp, nHastaTra, #0#4, #0#7, enTipoAt;
 ;
 NULL, procesoAtHisAb;
|FIN;

|PROCESO ordenaAtHisAb;
|DDEFECTO #1;
    #1#0 = #11#0;
|LEE 000#1=;

|DDEFECTO #2;
    #2#0 = #11#0;
    #2#1 = #11#1;
|LEE 000#2=;

|DDEFECTO #102;
    #102#0 = #2#87;
|LEE 000#102=;
#2#25 = #102#1;
|HAZ cta_cotizacion;
    #0#64 = cta_co;
|FPRC;

|PROCESO impreTNA2
     nDesdeEmp = #0#0;
     nHastaEmp = #0#1;
     nDesdeTra = #0#2;
     nHastaTra = #0#3;
     |BUCLE nomtreci0Abierta;
|FPRC;

|PROCESO salteadaAtHis;
     |ABRE #11;
     |PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
          salte_2 = salte_1 + 21;
          |PARA mes_i = #0#5; |SI mes_i [ #0#7; |HACIENDO mes_i = mes_i + 1;
               #11#0 = #0salte_1;     || empresa
               #11#1 = #0salte_2;     || trabajador
               #11#66 = #0#4;         || a¤o
               #11#2 = mes_i;         || mes
               #11#3 = enTipoAt;             || tipo
               |LEE 001#11=;
               |SI FSalida = 0;
                    |SI #0#69="I";
                         ||HAZ procesoAtrasImpre;
                    |FINSI;
                    |SI #0#69="A";
                         |HAZ procesoAtHisAb;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |SIGUE;
     |CIERRA #11;
|FPRC;

|PROCESO impreTNA; |TIPO 3;
    c_informe = "nomyabie";
|HAZ cuadres;
|SI sw_cuadre = 0;
    aOrden = #0#63;
    |ABRE #1;
    |ABRE #2;
    |ABRE #3;
    |ABRE #6;
    |ABRE #35;
    |ABRE #100;
    |ABRE #102;
    |HAZ ElIMPRE;
    |SI FEstado = 0;
            seleccio = 0;
        |SI #0#21 = 0;
            |HAZ impreTNA2;
        |SINO;
            |HAZ salteadaAtHis;
        |FINSI;
        |SI seleccio = 0;
            |MENAV "    Seleccion vacia ...";
        |SINO;
            |SI #0#10 = 2;
                |SI lineas = 1;
                    |HAZ comple_6AtHisAb;
                |FINSI;
            |FINSI;
        |FINSI;
    |SINO;
        |MENAV "    Proceso ABORTADO !!!";
    |FINSI;
    |HAZ ElFINIMP;
    |CIERRA #1;
    |CIERRA #2;
    |CIERRA #3;
    |CIERRA #6;
    |CIERRA #35;
    |CIERRA #100;
    |CIERRA #102;
|FINSI;
|FPRC;

|PROCESO cargas_0AtHisAb;      || CARGA LOS CAMPOS LITERALES Y LOS FIJOS
    #10#000 = #1#10;          || cif empresa
    #10#001 = #1#00;          || codigo empresa
    #10#002 = #2#1;          || codigo trabajador
    #10#003 = #1#2;          || nombre empresa
    #10#004 = domemp;         || direccion empresa
    #10#005 = pobemp;         || poblacion empresa
    #10#006 = #2#2;          || nombre trabajador
    |HAZ BuscaCateg;          || categoria profesional
    #10#008 = #2#238;         || puesto de trabajo
    #10#009 = afili;          || s.s. empresa
    #10#10 = #2#38;          || fecha de impresion
    #10#11 = #2#31;          || nro. de matricula
    #10#12 = #2#07;          || d.n.i. trabajador
    #10#13 = #2#75;          || s.s. trabajador
    #10#172 = #2#77;          || centro de trabajo
    #10#14 = desdia;         || desde el dia
    #10#15 = mesliq1;        || desde el mes
    #10#16 = hasdia;         || hasta el dia
    #10#17 = mesliq2;        || hasta el mes
    #10#18 = #0#78;          || a¤o confeccion
    |SI #10#18 > 80;  #10#18 = #10#18 + 1900;  |SINO;  #10#18 = #10#18 + 2000;  |FINSI;
    |SI #11#226 ! 0;
         #10#18 = #11#226;
    |FINSI;
    #10#19 = #10#19 + #11#08;          || total dias liquidacion
    #10#103 = #10#103 + #11#57;          || ptas. enfermedad
    #10#104 = #10#104 + #11#58;          || ptas. accidente
|SI #0#10 = 1;
        #10#105 = desenf;         || del dia enfermedad
        #10#106 = hasenf;         || al dia enfermedad
        #10#107 = desacc;         || del dia accidente
        #10#108 = hasacc;         || al dia accidente
|SINO;
        #10#105 = 0; #10#106 = 0; #10#107 = 0; #10#108 = 0;
|FINSI;
    #10#119 = #10#119 + tcotiz;         || base cotizacion
    #10#120 = #10#120 + #11#38;          || base prorratas
    #10#121 = #10#121 + tbcotiz;        || total bases de cotizacion
    #10#122 = #2#33;          || grupo de cotizacion
    #10#123 = #10#123 + #11#39;          || base contingencias comunes
    #10#124 = #10#124 + #11#40;          || base D+P+F
    #10#125 = #10#125 + #11#41;          || base horas extra estruc.
    #10#126 = #10#126 + #11#42;          || base horas extra no estruc.
    #10#127 = #11#61;          || (%) contingencias comunes
    #10#128 = apordfp;        || (%) d+fp
    #10#129 = aporhe1;        || (%) horas extra estruc.
    #10#130 = aporhe2;        || (%) horas extra no estruc.
    #10#131 = #10#131 + #11#48;          || ptas. contingencias comunes
    #10#132 = #10#132 + #11#49;          || ptas. d+f+p
    #10#133 = #10#133 + #11#50;          || ptas. horas extra estruc.
    #10#134 = #10#134 + #11#51;          || ptas. horas extra no estruc.
    #10#135 = #11#13;          || (%)IRPF 1
    #10#137 = #10#137 + taporta;        || total aportacion
    #10#139 = #10#139 + tantici;        || total anticipos
    #10#140 = #10#140 + #11#54;          || en especie
    #10#141 = #10#141 + deducir;        || total a deducir
    #10#143 = diarec;         || dia RECIBI
    #10#144 = mesrec;         || mes RECIBI
    #10#145 = anyrec;         || a¤o RECIBI
    |SI #10#145 > 80;  #10#145 = #10#145 + 1900;  |SINO;  #10#145 = #10#145 + 2000;  |FINSI;
    aTipoIT = "53"; |HAZ LiteralIT;
    #10#150 = aValor;                || Literal fijo
    #10#151 = #11#106;          || (%)IRPF 2
    #10#152 = #11#107;          || (%)IRPF 3
    #10#160 = #10#160 + #11#52;          || anticipos 1
    #10#161 = #10#161 + #11#53;          || anticipos 2
    #10#196 = #10#196 + #11#128;          || anticipos 3
    #10#193 = #10#193 + #11#45;          || ss. cargo empresa
    #10#195 = #10#195 + (#11#46 - deducir + #nomtrnom#193);  || Total Neto + SS Emp
|SI #11#49 ! 0;
        |SI apord ! 0; #10#162 = apord;  |FINSI;          || (%) desempleo
        #10#163 = aporfp;                                   || (%) form.prof.
        #10#164 = #10#164 + ((#11#40 % apord) ! EURODB);           || ptas. desempleo
        |SI apord = 0; |Y #labtraba#45 ! 421; |Y #labtraba#45 ! 422;
             #10#165 = #10#165 + #11#49;  || ptas. form.prof.
        |SINO;
             #10#165 = #10#165 + (#11#49 - (#11#40 % apord) ! EURODB);  || ptas. form.prof.
        |FINSI;
|FINSI;

nEmpresa=#11#0;   || empresa
nTrabajador=#11#1;   || trabajador
nMes=#11#2;   || mes
nTipo=#11#3;   || tipo
|HAZ ComentariosNomvarca;
|FPRC;

|PROCESO cargas_1AtHisAb;       || CARGA LOS CAMPOS SEGUN SU SITUACION
     incluye = 0;
     concep = #12#4;
     situcon = #12#7;

     |HAZ situacion;

    descri = #12#08;
    unidad = #12#11;      || unidades calculo
    uniant = #12#09;
    valor  = #12#10;
    import = unidad * valor;
|SI situac ! 0; |O situcon ! 0;
    |SI concep ] 201; |Y concep [ 208; |Y #12#5 ! "P";
        |SI swbaja = 1;
            |SI #2#48 = "S"; |Y #1#25=2;  incluye = 1;  |FINSI;  || si es finiquito
        |SINO;
            |SI #1#25 = 2;    incluye = 1;  |FINSI;  || si la paga va junta
        |FINSI;
    |SINO;
            incluye = 1;
    |FINSI;
    |HAZ Dtos;
    |SI #nomcont3#2 = "S"; |HAZ PagasProrr; |FINSI;
    |SI incluye = 1;
            lineas = 1;
            |HAZ leedescriNomHistoAb;
            camctos = situac + 116;
            camptas = situac + 22;
            camdesc = situac + 77;
            camunid = situac -  1;
            camvalo = situac + 38;
            camunia = situac + 155;
            retoded = "R";
            #15camctos = concep;
            #15camdesc = #100#2;                      || descripcion ampliada
            |HAZ Ampliada2;
            #10camptas = #10camptas + import;        || devengado
        |SI concep = 515;
                #15camunid = 0;        || unidades cero en ENF.EMP.
                #15camunia = 0;
                #15camvalo = #11#35;    || promedio de enfermedad en ENF.EMP.
        |SINO;
                #15camunia = #15camunia + uniant;        || unidades anterior
                #15camunid = #15camunid + unidad;        || unidades
                #15camvalo = #10camptas / #15camunid;    || valor base
        |FINSI;
        |SI concep = 101;
                dcal_101 = #12#05;
                duni_101 = unidad;
                dval_101 = valor;
        |FINSI;
        |SI concep = 102;               ||   unidades concepto 102
                duni_102 = unidad;
        |FINSI;
        |SI concep ] 301; |Y concep [ 305;
            duni_hest = duni_hest + #5#11;
        |FINSI;
        |SI concep ] 306; |Y concep [ 310;
            duni_hnoest = duni_hnoest + #5#11;
        |FINSI;
    |FINSI;
|FINSI;
     |SI concep = 101; |HAZ DiasAgrarios; |FINSI;
|FPRC;

|PROCESO cargas_2AtHisAb;       || CARGA LOS CAMPOS TOTALES
|SI #2#42!"A";|Y #2#42!"B";|Y #2#42!"E";|Y #2#42 ! "e";
|Y #2#42!"C";|Y #2#42!"F";|Y #2#42!"P";|Y #2#42!"I";
    |SI dcal_101 ! "L";
            deci_h = ((#11#33 * 100) $ 100) / 100;
            ||#10#21 = #10#21 + (#11#8-(#11#31+#11#32+#11#34+#11#65+deci_h+#11#105)); ||unid.sal.base
            #10#21 = #10#21 + (#11#8-(#11#31+#11#32+#11#34+#11#65+#11#105)); ||unid.sal.base
    |SINO;
            #10#21 = #10#21 + duni_101;
    |FINSI;
|SINO;
        #10#21 = #10#21 + duni_101;  || AGRARIA/CITRICOS
|FINSI;
|SI #nomcontr#17 = 3; |Y #0#10 ! 2;   || con la opcion "3" en calculo dias IT cojo siempre
     #10#21 = duni_101;      || las unidades del 101, que es lo que deberia hacer
|FINSI;                       || siempre, pero por no casrgarme nada, pongo esto
|SI #10#21 < 0;
        #10#21 = 0;                                   || si es neg., igual a 0
        #10#22 = 0;
|SINO;
        #10#22 = #10#23 / #10#21;                     || valor salario base
|FINSI;
        #10#177 = duni_102;              || unidades concepto 102
|SI #10#22 = 0;  #10#21 = 0;  |FINSI;  || si valor es 0, unidades tambien
|PARA campo = 109; |SI campo [ 115; |HACIENDO campo = campo + 1;
    #10campo = 0;    || vacia los totales, porque acumula en conceptos
|SIGUE;
|PARA campo = 24; |SI campo [ 28;  |HACIENDO campo = campo + 1;
        tot_109 = campo;        #10#109 = #10#109 + #10tot_109;  || personales
        tot_110 = campo +  5;   #10#110 = #10#110 + #10tot_110;  || puesto trab.
        tot_111 = campo + 10;   #10#111 = #10#111 + #10tot_111;  || calidad ...
        tot_112 = campo + 15;   #10#112 = #10#112 + #10tot_112;  || vencimientos
        tot_113 = campo + 20;   #10#113 = #10#113 + #10tot_113;  || en especie
        tot_114 = campo + 25;   #10#114 = #10#114 + #10tot_114;  || acc.empres.
        tot_115 = campo + 30;   #10#115 = #10#115 + #10tot_115;  || indemnizac.
|SIGUE;
    #10#116 = #10#102 + #10#103 + #10#104;    || prestaciones S.S.
    #10#117 = #10#059 + #10#060 + #10#061;              || mejoras voluntarias
    #10#118 = 0;
|PARA campo = 109; |SI campo [ 117; |HACIENDO campo = campo + 1;
    #10#118 = #10#118 + #10campo;                       || t.devengado parcial
|SIGUE;
    #10#118 = #10#118 + #10#23;                        || t.devengado + s.base
    #10#20 = #10#118;                                  || importe total
    #10#142 = #10#118 - #10#141;                        || liquido a percibir

    #10#136 = #10#136 + (#11#14 + #11#108 + #11#109);        || tot.base IRPF
    #10#138 = #10#138 + (#11#15 + #11#110 + #11#111);        || tot.ret. IRPF
    #10#153 = #10#153 + #11#14;                          || base IRPF 1
    #10#154 = #10#154 + #11#108;                          || base IRPF 2
    #10#155 = #10#155 + #11#109;                          || base IRPF 3
    #10#156 = dval_101;                                 || valor orig. s.base
    #10#157 = #10#157 + #11#15;                          || ret. IRPF 1
    #10#158 = #10#158 + #11#110;                          || ret. IRPF 2
    #10#159 = #10#159 + #11#111;                          || ret. IRPF 3
|SI swbaja = 0; |Y #1#25 = 2;      || si la paga va junta y no es baja
        #10#136 = #10#136 + #11#16;    || tot. base IRPF + pagas
        #10#138 = #10#138 + #11#17;    || tot. ret. IRPF + ret. pagas
        #10#153 = #10#153 + #11#16;    || base IRPF 1 + pagas
        #10#157 = #10#157 + #11#17;    || ret. IRPF 1 + ret. pagas
|FINSI;
    #10#190 = #10#190 + duni_hest;
    #10#191 = #10#191 + duni_hnoest;
    |HAZ FinTotales;     || moneda y varios temas finales
|FPRC;

|PROCESO comple_2AtHisAb;        || CONSTRUYE PERIODO DE LIQUIDACION
|SI #0#10 = 2;
        mesnum = #0#5;
|SINO;
        mesnum = #11#2;
|FINSI;

    || anytra = #0#78;
    anytra = #11#226;
|HAZ lib_0;             || saca ultimo dia natural del mes desde !!!
    mesliq1 = mesalf;
    mesliq2 = mesalf;

|SI #0#10 = 2;           || si tiene que refundir
        mesnum = #0#7;
        anytra = #0#79;
    |HAZ lib_0;         || saca ultimo dia natural del mes hasta !!!
    mesliq2 = mesalf;
|FINSI;

    fectra = #11#4;      || desglosa fecha de alta
|HAZ lib_1;
    diaalta = diatra;
    mesalta = mestra;
|SI #0#10 = 2;
    |SI mesalta ] #0#5; |Y anytra = #0#4;  || si es alta este mes
            desdia = diaalta;
            mesnum = mesalta;
            ||anytra = #0#78;
            anytra = #11#226;
        |HAZ lib_0;
            mesliq1 = mesalf;
    |SINO;
            desdia = 1;
    |FINSI;
|SINO;
    |SI mesalta = #11#2;
    |Y anytra = #11#226;
||Y anytra = #0#78;  || si es alta este mes
            desdia = diaalta;
    |SINO;
            desdia = 1;
    |FINSI;
|FINSI;

    fectra = #11#5;      || desglosa fecha de baja
|HAZ lib_1;
    diabaja = diatra;
    mesbaja = mestra;
|SI #0#10 = 2;
    |SI mesbaja [ #0#7; |Y mesbaja ! 0; |Y anytra = #0#4; || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
            mesnum = mesbaja;
            anytra = #0#4;
        |HAZ lib_0;
            mesliq2 = mesalf;
    |SINO;
            mesnum = #0#7;
            anytra = #0#4;
        |HAZ lib_0;
            hasdia = topemes;
    |FINSI;
|SINO;
    |SI mesbaja = #11#2; |Y anytra = #0#4; || si es baja este mes
            swbaja = 1;      || switch para saber si es baja en 'cargas_1'
            hasdia = diabaja;
    |SINO;
            hasdia = topemes;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_3AtHisAb;        || CARGA LOS PERIODOS DE LIQ. DE ENFERM. Y ACCTE.
    tipoit = "";
    desenf = 0;  hasenf = 0;
    desacc = 0;  hasacc = 0;
    swtenf = 0;  swtacc = 0;
|SI #11#27="E"; |O #11#27="M"; |O #11#27="P"; |O #11#27="R";
       desenf=#11#19; hasenf=#11#23; swtenf=1;
    tipoit = #11#27;
|FINSI;
|SI #11#28="E"; |O #11#28="M"; |O #11#28="P"; |O #11#28="R";
    |SI swtenf=0; desenf=#11#20; hasenf=#11#24; swtenf=1; |FINSI;
    tipoit = #11#28;
|FINSI;
|SI #11#29="E"; |O #11#29="M"; |O #11#29="P"; |O #11#29="R";
    |SI swtenf=0; desenf=#11#21; hasenf=#11#25; swtenf=1; |FINSI;
    tipoit = #11#29;
|FINSI;
|SI #11#30="E"; |O #11#30="M"; |O #11#30="P"; |O #11#30="R";
    |SI swtenf=0; desenf=#11#22; hasenf=#11#26; swtenf=1; |FINSI;
    tipoit = #11#30;
|FINSI;
     |SI swtenf = 1;
       |HAZ TipoIT;
     |FINSI;
|SI #11#27="A";              desacc=#11#19; hasacc=#11#23; swtacc=1; |FINSI;
|SI #11#28="A"; |Y swtacc=0; desacc=#11#20; hasacc=#11#24; swtacc=1; |FINSI;
|SI #11#29="A"; |Y swtacc=0; desacc=#11#21; hasacc=#11#25; swtacc=1; |FINSI;
|SI #11#30="A"; |Y swtacc=0; desacc=#11#22; hasacc=#11#26; swtacc=1; |FINSI;
|SI swtacc = 1;|Y #36#19 = "S";
        desacc = desacc - 1;
    |SI desacc < 0;  desacc = 1;  |FINSI;  || por el rollo de las mutuas
|FINSI;
|SI desenf = 0;|Y swtenf = 1;   desenf = 1;    |FINSI;
|SI hasenf = 0;|Y swtenf = 1;   hasenf = #11#7; |FINSI;
|SI desacc = 0;|Y swtacc = 1;   desacc = 1;    |FINSI;
|SI hasacc = 0;|Y swtacc = 1;   hasacc = #11#7; |FINSI;
|FPRC;

|PROCESO comple_4AtHisAb;        || HALLA TOTALES VARIOS
    tcotiz  = #11#37 + #11#62;
    tbcotiz = tcotiz + #11#38;         || total bases de cotizacion
|SI #11#40 ! 0;|Y #2#45 ! "087";|Y #2#45 ! "097";|Y #2#45 ! "085"; |Y #2#45 ! "421";
        apordfp = #3#13+#3#15+#3#17+#3#19;   ||(%) d+f+p
        aporfp = #3#17;                      ||(%) fp
        apord = apordfp - aporfp;            ||(%) d
|SINO;
        apordfp = 0;
        aporfp = 0;
        apord = 0;
|FINSI;
|SI #11#41 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe1 = #3#09;                || (%) horas extra estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe1 = aporhe1 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe1 = 0;
|FINSI;
|SI #11#42 ! 0; |Y #labtraba#42 ! "T"; |Y #labtraba#42 ! "X";
        aporhe2 = #3#11;                || (%)horas extra no estruc.
    |SI #2#45 = "087";|O #2#45 = "097";|O #2#45 = "085"; |O #2#45 = "421";
            aporhe2 = aporhe2 + #3#13+#3#15+#3#17+#3#19;    || aprendices
    |FINSI;
|SINO;
        aporhe2 = 0;
|FINSI;
    taporta = #11#48 + #11#49 + #11#50 + #11#51;      || total aportacion
    tantici = #11#52 + #11#53 + #11#128;               || total anticipos
    deducir = taporta + #11#114 + tantici + #11#54;  || total a deducir
|SI swbaja = 0; |Y #1#25 = 2;         || si la paga va junta y no es baja,
        deducir = deducir + #11#17;    || /le suma la parte IRPF de pagas
|FINSI;
|FPRC;

|PROCESO comple_5AtHisAb;        || CONSTRUYE FECHA LITERAL DEL RECIBI
|HAZ sibajaAtHisAb;              || (tiene en cuenta si el trabajador es baja)
    fectra = #0#6;
|HAZ lib_1;
|SI diabaja ! 0;
        diarec = diabaja;
|SINO;
        diarec = diatra;
|FINSI;
    anyrec = anytra;
    mesnum = mestra;
|HAZ lib_0;
    mesrec = mesalf;
|FPRC;

|PROCESO sibajaAtHisAb;   || COMPRUEBA SI EL TRABAJADOR ES BAJA EN ESTE MES
    diabaja = 0;
|SI #11#5 ! "          "; |Y #11#5 ! "..........";
        fectra = #11#5;
    |HAZ lib_1;
    |SI #0#5 = mestra; |Y anytra = #11#226;
||Y #0#78 = anytra;
            diabaja = diatra;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO comple_6AtHisAb;    || imprime y limpia
|SI nOpcion = 2;
     |HAZ IMPREArchi;
|SINO;
     |INFOR "nomyabie";
|FINSI;
    alguno = 0;
    ninguno = 0;
    situac2 = 0;
|PARA situac = 1; |SI situac [ 39; |HACIENDO situac = situac + 1;
        camctos = situac + 116;  infctos = #15camctos;
        camptas = situac + 22;   infptas = #10camptas;
        camdesc = situac + 77;   infdesc = #15camdesc;
        camunid = situac -  1;   infunid = #15camunid;
        camvalo = situac + 38;   infvalo = #15camvalo;
        camunia = situac + 155;  infunia = #15camunia;
        |HAZ Cotizaciones;
    |SI infptas ! 0;
            alguno = 1;
            ninguno = ninguno + 1;
        |PRINT;
        |SI ninguno = 15;
                situac2 = situac + 1;
                situac = 39;
        |FINSI;
    |FINSI;
|SIGUE;
    linea16 = 0;
|SI situac2 ! 0;
    |PARA situac=situac2;|SI situac[39; |HACIENDO situac=situac+1;
            camctos = situac + 116;  infctos = #15camctos;
            camptas = situac + 22;   infptas = #10camptas;
            camdesc = situac + 77;   infdesc = #15camdesc;
            camunid = situac -  1;   infunid = #15camunid;
            camvalo = situac + 38;   infvalo = #15camvalo;
            camunia = situac + 155;  infunia = #15camunia;
            linea16 = linea16 + infptas;
            |HAZ Cotizaciones;
    |SIGUE;
    |SI linea16 ! 0;
            alguno = 1;
            infctos = 0;
            infptas = linea16;
            infdesc = "GLOBAL VARIOS ...";
            infunid = 1;
            infunia = 1;
            infvalo = 1;
        |PRINT;
    |FINSI;
|FINSI;
|SI alguno = 1;
    |HAZ LineasDto;
    |PIEINF;
|SINO;
    |SI #10#119 ! 0;
            infctos = 0;
            infptas = 0;
            infdesc = "-------------------------";
            infunid = 0;
            infunia = 0;
            infvalo = 0;
        |PRINT;
        |PIEINF;
    |FINSI;
|FINSI;
|HAZ ElFININF;
|DDEFECTO #10;
|DDEFECTO #15;
|FPRC;
