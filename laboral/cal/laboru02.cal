|FICHEROS;
     laboru01;

     laborn01;
     laborn02;
     laborn03;
     laborn05;

     nompmail;
|FIN;

|VARIABLES;
     nAlt                = 0;
     nBaj                = 0;
     nVar                = 0;
     nPro                = 0;
     nDias               = 0;
     nOk                 = 0;
     nHandle             = 0;
     nCalc               = 0;
     nCalc1              = 0;
     nCont               = 0;

     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aPal                = "";
     aBase               = "";
     aBaseTmp            = "";
     aAdjunto            = "";
     aIP                 = "";
     aSMTP               = "";
     aFrom               = "";
     aTo                 = "";
     aAsunto             = "";
     aCuerpo             = "";
     aHora               = "";
     aDia                = "";
     aMes                = "";
     aAny                = "";

     fFecha              = @;
     fHFecha             = @;
     fFechaSys           = @;
     fLetra              = @;

 {-1}aAviso              = "";
     aAviso1             = "";
     aAviso2             = "";
     aAviso3             = "";
     aAviso4             = "";

  {2}nDato               = 0;

     &eaAlfa             = "";
|FIN;

|PROCESO GrabaCuerpo;
     |XGRABA nHandle, eaAlfa;
|FPRC;

|PROCESO Cuerpo;
     |DBASE aBase;
     aBaseTmp = aBase + "tmp";                   |MKDIR aBaseTmp;
     aBaseTmp = aBase + "tmp/" + Usuario;        |MKDIR aBaseTmp;
     aBaseTmp = aBase + "tmp/" + Usuario + "/";

     aAdjunto  = aBaseTmp + "adjunto.txt";
     |XABRE "WB", aAdjunto, nHandle;

     eaAlfa = "Buenas." + &13 + &10;           |HAZ GrabaCuerpo;
     eaAlfa = "" + &13 + &10;                  |HAZ GrabaCuerpo;

     |SI nAlt ! 0;
                        aPal = " altas";
         |SI nAlt = 1;  aPal = " alta";  |FINSI;

         aAlfa = nAlt + aPal;
     |FINSI;

     |SI nBaj ! 0;
                        aPal = " bajas";
         |SI nBaj = 1;  aPal = " baja";  |FINSI;

         |SI aAlfa ! "";
             aAlfa = aAlfa + ", " + nBaj + aPal;
         |SINO;
             aAlfa = nBaj + aPal;
         |FINSI;
     |FINSI;

     |SI nVar ! 0;
                        aPal = " variaciones";
         |SI nBaj = 1;  aPal = " variación";  |FINSI;

         |SI aAlfa ! "";
             aAlfa = aAlfa + ", " + nVar + aPal;
         |SINO;
             aAlfa = nVar + aPal;
         |FINSI;
     |FINSI;

     |SI nPro ! 0;
                        aPal = " prórrogas";
         |SI nPro = 1;  aPal = " prórroga";  |FINSI;

         |SI aAlfa ! "";
             aAlfa = aAlfa + ", " + nPro + aPal;
         |SINO;
             aAlfa = nPro + aPal;
         |FINSI;
     |FINSI;

     eaAlfa = "Tiene pendiente " + aAlfa +  "." + &13 + &10;  |HAZ GrabaCuerpo;
     eaAlfa = "" + &13 + &10;                 |HAZ GrabaCuerpo;

     eaAlfa = "Recuerde comprobarlos en su mantenimiento.";
     |HAZ GrabaCuerpo;

     eaAlfa = "" + &13 + &10;                 |HAZ GrabaCuerpo;
     eaAlfa = "" + &13 + &10;                 |HAZ GrabaCuerpo;
     eaAlfa = "" + &13 + &10;                 |HAZ GrabaCuerpo;
     eaAlfa = "" + &13 + &10;                 |HAZ GrabaCuerpo;
     eaAlfa = "Saludos " +  &13 + &10;        |HAZ GrabaCuerpo;

     |XCIERRA nHandle;
|FPRC;

|PROCESO SendMail;
     |SI #laboru01#4 = fFechaSys;
         |ACABA;
     |FINSI;

     |ABRE #nompmail;
     |LEE 000#nompmail.p;
     |SI FSalida ! 0;
         |CIERRA #nompmail;
         |ACABA;
     |FINSI;
     |CIERRA #nompmail;

     aIP     = #nompmail#1 + "." + #nompmail#2 + "." + #nompmail#3 + "." + #nompmail#4;
     aSMTP   = #nompmail#5;  |QBF aSMTP;
     aFrom   = #nompmail#10; |QBF aFrom;
     aTo     = #laboru01#2;  |QBF aTo;
     aAsunto = "Gestión de solicitudes pendientes";

     |HAZ Cuerpo;

     aCuerpo = "$$$$" + aAdjunto;

     |SI #nompmail#6 = "S";
         aAlfa = #nompmail#9; |QBF aAlfa;
         aAlfa1 = aAlfa % 0; nCalc = aAlfa1; aAlfa2 = "";
         |PARA nCont = 1; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
               nCalc1 = (nCont * 100) + 1;
               aAlfa1 = aAlfa % nCalc1; nDato1 = &aAlfa1; nDato2 = 255;
               InDato = nDato1<-;
               |ESPECIFICA "XOR", nDato;
               nCalc1 = FSalida; aAlfa2 = aAlfa2 + &nCalc1;
         |SIGUE;

         aAlfa = aAlfa2;              |QBF aAlfa;
         aAlfa = aAlfa + ":";
         aAlfa = aAlfa + #nompmail#7; |QBF aAlfa;
         aAlfa = aAlfa + ":";

         aFrom = aAlfa + aFrom;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSMTP, aFrom, aTo, aAsunto, aCuerpo, aAdjunto;
|FPRC;

|PROCESO laborn01;
     aDia = #laborn01#193;  |QBF aDia;
     aMes = #laborn01#194;  |QBF aMes;
     aAny = #laborn01#195;  |QBF aAny;

     aDia = ("00" + aDia) % -102;
     aMes = ("00" + aMes) % -102;
     aAlfa = aDia + "." + aMes + "." + aAny;
     fFecha = aAlfa;

     |SI fFecha > fHFecha;
         |ACABA;
     |FINSI;

     nAlt = nAlt + 1;
|FPRC;

|DEFBUCLE laborn01;
     #laborn01#2;
     ;
     "P", 00001, "01.01.0000", "          ", "          ", "        ";
     "P", 99999, "31.12.2999", "zzzzzzzzzz", "zzzzzzzzzz", "zzzzzzzz";
     ;
     NULL, laborn01;
|FIN;

|PROCESO laborn02;
     |SI #laborn02#8 > fHFecha;
         |ACABA;
     |FINSI;

     nBaj = nBaj + 1;
|FPRC;

|DEFBUCLE laborn02;
     #laborn02#2;
     ;
     "P", 00001, "01.01.0000", "          ", "          ", "        ";
     "P", 99999, "31.12.2999", "zzzzzzzzzz", "zzzzzzzzzz", "zzzzzzzz";
     ;
     NULL, laborn02;
|FIN;

|PROCESO laborn03;
     |SI #laborn03#30 > fHFecha;
         |ACABA;
     |FINSI;

     nVar = nVar + 1;
|FPRC;

|DEFBUCLE laborn03;
     #laborn03#2;
     ;
     "P", 00001, "01.01.0000", "          ", "          ", "        ";
     "P", 99999, "31.12.2999", "zzzzzzzzzz", "zzzzzzzzzz", "zzzzzzzz";
     ;
     NULL, laborn03;
|FIN;

|PROCESO laborn05;
     fFecha = #laborn05#9;
     nDias  = fFecha;
     nDias  = nDias + 1;
     fFecha = nDias;

     |SI fFecha > fHFecha;
         |ACABA;
     |FINSI;

     nPro = nPro + 1;
|FPRC;

|DEFBUCLE laborn05;
     #laborn05#2;
     ;
     "P", 00001, "01.01.0000", "          ", "          ", "        ";
     "P", 99999, "31.12.2999", "zzzzzzzzzz", "zzzzzzzzzz", "zzzzzzzz";
     ;
     NULL, laborn05;
|FIN;

|PROGRAMA;
     #laboru01#0 = Usuario % 810;
     |LEE 000#laboru01.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nAlt = 0;
     nBaj = 0;
     nVar = 0;
     nPro = 0;

     fFechaSys = ~;

     nDias     = fFechaSys;
     nDias     = nDias + 1;
     fHFecha   = nDias;
     fLetra    = fHFecha % 1;
     aDia      = (fLetra % 1109) > " ";   |QBF aDia;
     |SI aDia = "SABADO";
         nDias = nDias + 2;
     |FINSI;
     fHFecha   = nDias;

     |BUCLE laborn01;
     |BUCLE laborn03;
     |BUCLE laborn05;

     nDias     = fFechaSys;
     nDias     = nDias - 1;
     fHFecha   = nDias;
     fLetra    = fHFecha % 1;
     aDia      = (fLetra % 1109) > " ";   |QBF aDia;
     |SI aDia = "DOMINGO";
         nDias = nDias - 2;
     |FINSI;
     fHFecha   = nDias;
     |BUCLE laborn02;

     nOk = 0;
     |SI nAlt ! 0;  nOk = 1;  |FINSI;
     |SI nBaj ! 0;  nOk = 1;  |FINSI;
     |SI nVar ! 0;  nOk = 1;  |FINSI;
     |SI nPro ! 0;  nOk = 1;  |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     |SI #laboru01#3 = "1";  |O #laboru01#3 = "3";
         aAviso1 = "0";
         aAviso2 = "2";
         aAviso3 = "Avisos LABORNET ";
         aAviso4 = "";

         |SI nAlt ! 0;
                            aPal = " altas";
             |SI nAlt = 1;  aPal = " alta";  |FINSI;

             aAviso4 = nAlt + aPal;
         |FINSI;

         |SI nBaj ! 0;
                            aPal = " bajas";
             |SI nBaj = 1;  aPal = " baja";  |FINSI;

             |SI aAviso4 ! "";
                 aAviso4 = aAviso4 + ", " + nBaj + aPal;
             |SINO;
                 aAviso4 = nBaj + aPal;
             |FINSI;
         |FINSI;

         |SI nVar ! 0;
                            aPal = " variaciones";
             |SI nBaj = 1;  aPal = " variacion";  |FINSI;

             |SI aAviso4 ! "";
                 aAviso4 = aAviso4 + ", " + nVar + aPal;
             |SINO;
                 aAviso4 = nVar + aPal;
             |FINSI;
         |FINSI;

         |SI nPro ! 0;
                            aPal = " prorrogas";
             |SI nPro = 1;  aPal = " prorroga";  |FINSI;

             |SI aAviso4 ! "";
                 aAviso4 = aAviso4 + ", " + nPro + aPal;
             |SINO;
                 aAviso4 = nPro + aPal;
             |FINSI;
         |FINSI;

         aAviso4 = "Tienes " + aAviso4 + ". Recuerde comprobarlos en su mantenimiento";
         |ESPECIFICA "MENSAJETRAY", aAviso;
     |FINSI;

     |SI #laboru01#3 = "2";  |O #laboru01#3 = "3";
         |HAZ SendMail;
     |FINSI;

     |HORA aHora;
     #laboru01#4 = fFechaSys;
     #laboru01#5 = aHora;

     |GRABA 000#laboru01.a;
     |LIBERA #laboru01;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |ABRET #laboru01;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #laboru01;
|FPRC;
