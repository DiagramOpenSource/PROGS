|FICHEROS;
     nomactca #0;    || actualizacion mensual
     nomcalca #1;    || calculos cabs.
     nomcalli #2;    || calculos lins.
     nomhicca #3;    || calculos cabs. hist.
     nomhicli #4;    || calculos lins. hist.
     labtraba #5;    || trabajadores
     labempax #6;    || aux. empresas
     nomvarca #7;    || variaciones cabs.
     nomvarli #8;    || variaciones lins.
     labbasec #9;    || bases cabs.
     labbasel #10;   || bases lins.
     nomconca #11;   || convenios cabs.
     labempre #12;   || empresas
     nomtepig #13;   || aux. epigrafes
     labtrtra #25;   || trabajo de trabajadores
     nomtrahx #31;   || bases de cotizacion por horas extraordinarias
     nomvart3 #40;   || variaciones t.parcial (ctos.irregulares)
     nompanta #50;   || pantalla del rastreador
     nomatcon #14;   || historico constantes para atrasos
     nomconst #15;   || constantes
     nomtraca;       || constantes por trabajador
     nomcarli;       || caregorias regimen del carbon
     nomtrali;
     nomcatli;
     motibaja;
     copiadef@ #500;
     nomembca;
     nomembli;
     nomgirli;
     nomgirco;
     nomir009;
     nomconli;
     nomvarcb;
     nomcalcc;
     nomcontr;
     :integral/dsam0017 #17;
     :integral/dsam0018 #18;
     :modelos/dsmom107;
     :modelos/dsmom004;
     gomdetjr;
     nomtrcal;
     nomcont1;
|FIN;

|VARIABLES;
     &nXDesdeEmpresa=0;
     &nXHastaEmpresa=0;
     &nXDesdeTrabajador=0;
     &nXHastaTrabajador=0;
     &nXDesdeMes=0;
     &nXHastaMes=0;
     &nXAnyo=0;
    i=0;
    aCadena="";
    nExiste=0;
    FEstado = 0;
    a_bases = 0;
    act = 0;
    actc = 0;
    alfa = "";
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    antemp = 0;
    anttra = 0;
    any = 0;
    anyb = "";
    anyn = 0;
    anynum = 0;
    anyonum = 0;
    aver = 0;
    b_dif = 0;
    base1 = 0;
    base2 = 0;
    bisiesto = 0;
    calcdto = 0;
    campo = 0;
    cl = 0;
    clave = "";
    concep1 = 0;
    concep2 = 0;
    concepto = 0;
    confecc = 0;
    continua = 0;
    d_dto = 0;
    de1 = 0;
    de2 = 0;
    dedia_i = 0;
    dedia_p = 0;
    des = 0;
    des1 = 0;
    des2 = 0;
    desc = 0;
    descl = 0;
    desde = 0;
    desde_i = 0;
    desde_p = 0;
    dia = 0;
    dia_2 = 0;
    dia_3 = 0;
    dia_4 = 0;
    dia_accid = 0;
    dia_d = 0;
    dia_enfer = 0;
    dia_h = 0;
    diab = "";
    dias = 0;
    diasefe = 0;
    div_prom = 0;
    divide = 0;
    duni1_999 = 0;
    duni2_999 = 0;
    dvalo_209 = 0;
    dvalo_999 = 0;
    el_anyo = 0;
    estado = 0;
    estevale = 0;
    fecalf = "";
    fecha = "";
    fecsys = @;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;
    fech5 = @;
    fech6 = @;
    guarda = 0;
    ha1 = 0;
    ha2 = 0;
    hadia_i = 0;
    hadia_p = 0;
    has = 0;
    has1 = 0;
    has2 = 0;
    hasc = 0;
    hascl = 0;
    hasta = 0;
    hasta_i = 0;
    hasta_p = 0;
    histori = "";
    labtraba = 0;
    linea = 0;
    m_dias = 0;
    mas = 0;
    menos = 0;
    mes = 0;
    mes_d1 = 0;
    mes_d2 = 0;
    mes_d3 = 0;
    mes_d4 = 0;
    mes_h1 = 0;
    mes_h2 = 0;
    mes_h3 = 0;
    mes_h4 = 0;
    mes_proximo = 0;
    mesb = "";
    mesn = 0;
    mesnum = 0;
    mid = 0;
    no_promac = 0;
    num_accid = 0;
    num_enfer = 0;
    num_veces = 0;
    nume0 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume6 = 0;
    nume7 = 0;
    numer = 0;
    p_mes = "";
    prom_ac2 = 0;
    paga = 0;
    pageta = 0;
    pdia_0 = 0;
    pdia_1 = 0;
    pdia_2 = 0;
    pdia_3 = 0;
    pdia_4 = 0;
    pdia_6 = 0;
    pdia_7 = 0;
    pdia_a = 0;
    pdia_b = 0;
    pdia_c = 0;
    pdia_d = 0;
    pdia_e = 0;
    pdia_f = 0;
    pdia_g = 0;
    pepulti = 0;
    perio = 0;
    pp = 0;
    pr_acc = 0;
    pr_enf = 0;
    product = 0;
    resta = 0;
    rompe = 0;
    seleccio = 0;
    sw_mater = 0;
    swcalcdto = 0;
    swdesde = 0;
    swhasta = 0;
    swmarca = "";
    swpro = 0;
    t_prorrata = 0;
    tipos = 0;
    topemes = 0;
    topemes1 = 0;
    topemes2 = 0;
    vari_desde = 0;
    vari_hasta = 0;
    x = 0;
    x1 = 0;
    x2 = 0;
    x3 = 0;
    y1 = 0;
    y2 = 0;
    y3 = 0;
    ant_empresa = -1;
    tpz = 0;
    es_irregul = 0;
    hany = 0;
    hmes = 0;
    hbase = 0;
    henfe = 0;
    hdias = 0;
    hhor1 = 0;
    hhor2 = 0;
    hhor3 = 0;
    CodigoCons = 0;
    &EURODB = 0;
|| variables para llenar de ceros
     aCadena1="";
     r_alfa = "";
     r_long = "";
     r_num  = 0;
     r_masc = "000000"; || mascara para tama¤o 2
     tipo_p = 0;
     ajus_p = 0;
     swConst = 0;
     nEmp_ult = 0;
     nTra_ult = 0;
     nMes_ult = 0;
     aAny_ult = "";
     nHastaM = 0;
     aHastaA = "";
     nSwNoSigas = 0;
     num_veces_e = 0;
     num_veces_m = 0;
     d_acum = 0;
     nAnyo = 0;
     no_promen = 0;
     swAcaba = 0;
     prenf_ant = 0;
     pracc_ant = 0;
     pror_p = 0;
     nNume = 0;
     nTopeMin = 0;
     nTopeMax = 0;

     &nEmpAUTO = 0;
     &nTraAUTO = 0;
     &nMesAUTO = 0;
     &nAnyAUTO = 0;
     aParam = "";

     tp = 0;
     tp1 = 0;
     tp2 = 0;
     tp3 = 0;
     tpx = 0;
     es_parcial = 0;
     aAlfa = "";
     aMotivoBaja = "";
     dias_mat = 0;

     &nCConst = 0;
     &fCFecha = @;
     &aCError = "";
     nAnyCons = 0;
     nMesCons = 0;
     &swModulo = 0;
     nImpTeor = 0;
     nImpReal = 0;
     &nEnEmpresa = 0;

     nCampoMen = 0;
     nCampoHis = 0;
     nCampo = 0;
     nCampoD = 0;
     nCampoH = 0;
     nCampoR = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampoRSN = 0;
     nDiferencia = 0;

     &nDesdeEmp = 0;
     &nHastaEmp = 0;
     &nDesdeTra = 0;
     &nHastaTra = 0;
     &nMes = 0;
     &nAny = 0;
     &nTopemes = 0;
     swStop = 0;
     nEmp = 0;
     nTra = 0;
     aClave = "";
     aDesdeClave = "";
     aHastaClave = "";
     nTraNoAct = 0;
     &swStopIRPF = 0;
     &aParam2 = "";
     swHayIncid = 0;
     nDiasNatAlta = 0;
     swSigue = 0;
     nElAny = 0;
     grupo = 0;
     campomin = 0;
     nRetAnyAnt = 0;
     nPenAnyAnt = 0;
     aOrigenControlIT = "";
     swAcaboControlIT = 0;

     nRegistro = 0;
     nRegistro1 = 0;
     nRegistro2 = 0;
     nUltima = 0;
     aDia = "";
     &aMes = "";
     aAny = "";
     fFecha = @;
     aFecha = "";
     nEmbargo = 0;
     nEmbargo1 = 0;
     nEmbargo2 = 0;
     fFechaAlta = @;
     fFechaBaja = @;
     aNif      = "";

     nEmpOri   = 0;
     nTraOri   = 0;
     nEmpDes   = 0;
     nTraDes   = 0;
     nErroMod  = 0;
     nAnyoMod  = 0;
     aFichMod  = "";
     nEmpreMod = 0;
     swFechaBaja = 0;
     nTipo = 0;
     nDias = 0;

     aFecha1 = "";
     aFecha2 = "";
     fFecha1 = @;
     fFecha2 = @;
     aFechaAlta = "";
     aFechaBaja = "";
     nFecha1 = 0;
     nFecha2 = 0;
     &enEmpresa = 0;
     &enTrabajador = 0;
     nContrato = 0;
     swFijoDisc = 0;
     aAntIT = "";
     nAntDiasIT = 0;
     aAnyo = "";
     aCalendario = "";
     nDia = 0;
     nCampoDia = 0;
     nNume1 = 0;
     aAlfa1 = "";
     nAnyJor = 0;
     nMesJor = 0;
     swContratoTP = 0;
     swHis = 0;
     swSigueC = 0;
     nPropIT = 0;
     nCampo3 = 0;
|FIN;

|PROCESO Tipo88; |TIPO 88;
     |HAZ LeeEURODB;
|FPRC;

|PROCESO llena_ceros;
          |QBF aCadena;
          r_alfa= aCadena;
          |QBF r_alfa;
          r_long = aCadena % A0;
          r_alfa = r_masc + r_alfa;
          r_num = -106;    || para tama¤o 6
          aCadena = r_alfa % r_num;
|FPRC;



****************************************************************************
    GESTION PANTALLA
****************************************************************************

|PROCESO defecto;|TIPO 7;  || Para hallar las dos ultimas cifras del a¤o
     fecsys = ~;
     alfa = fecsys;
     alfa1 = (alfa % 402);
     nMes = alfa1;
     alfa2 = alfa % -102;
     nAny = alfa2;
     #0Campo = nAny;
     |SI nMes = 01; |O nMes = 02;  || estamos en enero o febrero
          |SI #0#4 = 12;           || y quiero actualizar dic
                #0Campo = nAny - 1;     || propongo a¤o anterior
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO guardalo; |TIPO 0;   || para cargar el ultimo dia del mes de act.
    mesnum = #0#4;
    anynum = #0#5;
|HAZ ulti_dia;
    guarda = topemes;
|FPRC;

|PROCESO mes;|TIPO 7;
    fecsys = ~;
    alfa = fecsys;
    alfa = alfa % 402;
    #0Campo = alfa;
    #0Campo = #0Campo - 1;  || le resta un mes porque lo normal
|SI #0Campo = 0;            || / es actualizar el mes anterior
        #0Campo = 12;
        menos = 1;
|SINO;
        menos = 0;
|FINSI;
|PINTA #0Campo;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
|SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
|SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
|SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
|SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
|SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|PINTA 1148, p_mes;
|FPRC;

*************************************************************************
     CALCULOS DE COMPROBACION DE LOS QUE QUEDAN POR ACTUALIZAR
*************************************************************************

|PROCESO basurero1;
|SI #1#2 ! #0#4;|Y #1#2 ! mes_proximo;  || borra los calculos que no sean del
    ||BUCLELIN 1NULL#1;                 ||/mes actual o del proximo
    ||BORRA 020#1a;                          || BORRADO INHIBIDO!!!
    ||SI FSalida = 0;     #50#8 = #50#8 + 1;       |FINSI;
        #50#8 = #50#8 + 1;
|SINO;
    |SI #1#2 = #0#4;          #50#6 = #50#6 + 1;  |FINSI;
    |SI #1#2 = mes_proximo;   #50#7 = #50#7 + 1;  |FINSI;
|FINSI;
|LIBERA #1;
|FPRC;

|DEFBUCLE basurero;
 #1#1;
 ;
     1,     1,  1, 0;
 99999, 99999, 12, 9;
 be;
 NULL, basurero1;
|FIN;

|PROCESO limpia_patio;
     mes_proximo = #0#4 + 1;
     |SI mes_proximo = 13;    mes_proximo = 1;    |FINSI;

     |PINPA #1#50;
     |PINDA #1#50;
     |BUCLE basurero;
     |PINDA #1#50;

     |ATRI P;
     |SI aParam ! "AUTO";
          |SI #50#6 = 0;
               |MENAV "    AVISO: Proceso Mensual TOTALMENTE actualizado ...";
          |SINO;
               |MENAV "    AVISO: Proceso Mensual PARCIALMENTE actualizado ...";
          |FINSI;
     |FINSI;
     |ATRI 0;
|FPRC;

*************************************************************************
     CALCULOS PROCESO DE ACTUALIZACION
*************************************************************************
|PROCESO constante;
     alfa1 = "01";
     alfa2 = #0#4;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     nNume = 2000 + #0#5;
     alfa3 = nNume;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
     |SI aCError ! "";
          alfa1 = #labtraba#0; alfa1 = "00000" + #labtraba#0; alfa1 = alfa1 % -105;
          alfa2 = #labtraba#1; alfa2 = "00000" + #labtraba#1; alfa2 = alfa2 % -105;
          aAlfa = "0000ATENCION: Trabajador: " + alfa1 + "." + alfa2;
          aAlfa = aAlfa + " La constante del trabajador no esta definida.";
          |SI aParam ! "AUTO";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO grabaConstantes;
/*
     |ABRE #nomtraca;              || mira por si el trabajador tiene
     #nomtraca#0 = #5#0;           || asignada constante en nomtraca
     #nomtraca#1 = #5#1;
     |LEE 000#nomtraca.=
     |SI FSalida = 0;
          CodigoCons = #nomtraca#3;
     |SINO;
          CodigoCons = #12#32;
     |FINSI;
     |CIERRA #nomtraca;

     |ABRE #15;
     #15#0=CodigoCons;
     |LEE 000#15=;
     |SI FSalida=0; || si existe constante seguimos
*/
     nCConst = #labtraba#248;
     |HAZ constante;
     |SI aCError = "";
          |ABRE #14;
          #14#0 = CodigoCons;   || codigo de constante. Esta leida desde la empresa
          #14#77 = #1#0;   || codigo empresa
          #14#78 = #1#1;   || codigo trabajador
          #14#79 = #1#2;   || mes

          aCadena=#0#5;
          |SI #0#5<10; aCadena="0"+aCadena; |FINSI; || completar 2 digitos
          |SI #0#5>0;
               #14#80="20"+aCadena;     || a¤o
          |SINO;
               #14#80="19"+aCadena;     || a¤o
          |FINSI;
          |LEE 101#14=;
          nExiste=FSalida;

          |PARA i=0;|SI i[76; |HACIENDO i=i+1;
               #14i=#15i;
          |SIGUE;
          #14#81 = #15#92;
          #14#82 = #15#93;
          |SI nExiste=0;
               |GRABA 020#14a;
          |SINO;
               |GRABA 020#14n;
          |FINSI;
          |CIERRA #14;
     |FINSI;
     ||CIERRA #15;
|FPRC;

|PROCESO comp_const;
     |SI #nomatcon#80 < "2002";    |ACABA;   |FINSI;
     |SI #nomatcon#80 = "2002";
          |SI #nomatcon#79 < 10;   |ACABA;   |FINSI;
     |FINSI;

     |SI #nomatcon#80 > aHastaA;   |ACABA;   |FINSI;
     |SI #nomatcon#80 = aHastaA;
          |SI #nomatcon#79 > nHastaM;   |ACABA;   |FINSI;
     |FINSI;

     nEmp_ult = #14#77;
     nTra_ult = #14#78;
     aAny_ult = #14#80;
     nMes_ult = #14#79;
     nSwNoSigas = 1;
|FPRC;

|DEFBUCLE comp_const;
     #nomatcon#1;
     ;
     #1#0, #1#1, "0000",  1;
     #1#0, #1#1, "9999", 12;
     ;
     NULL, comp_const;
|FIN;

|PROCESO compara;
     swConst = 0;
     aHastaA = #0#5;
     nHastaM = #0#4 - 1;
     |SI nHastaM = 0;
          nHastaM = 12;
          nume1 = #0#5 - 1;
          aHastaA = nume1;
     |FINSI;
     aHastaA = "20" + (("00" + aHastaA) % -102);  || (seremos viejos en 2100)

     nEmp_ult = 0;   nTra_ult = 0;  nMes_ult = 0;  aAny_ult = "";
     nSwNoSigas = 0;
     |BUCLE comp_const;
     |SI nSwNoSigas = 0; |ACABA;   |FINSI;

|ABRE #5;
    #5#0 = #1#0;    || Codigo empresa
    #5#1 = #1#1;    || Codigo trabajador
|LEE 000#5=;
|SI FSalida = 0;
/*
     |ABRE #nomtraca;              || mira por si el trabajador tiene
     #nomtraca#0 = #5#0;           || asignada constante en nomtraca
     #nomtraca#1 = #5#1;
     |LEE 000#nomtraca.=
     |SI FSalida = 0;
          CodigoCons = #nomtraca#3;
     |SINO;
          CodigoCons = #12#32;
     |FINSI;
     |CIERRA #nomtraca;
*/
     swAcaba = 0;
     |ABRE #14;
     #14#77 = nEmp_ult;
     #14#78 = nTra_ult;
     #14#79 = nMes_ult;
     #14#80 = aAny_ult;
     |LEE 000#14=;
     |SI FSalida = 0;

          || ABRE #15;
          || #15#0 = CodigoCons;
          || LEE 000#15=;
          nCConst = #labtraba#248;
          |HAZ constante;
          aAlfa = #15#79;
          aAlfa = aAlfa % 402;
          nMesCons = aAlfa;
          aAlfa = #15#79;
          aAlfa = aAlfa % -104;
          nAnyCons = aAlfa;

                                 || comparo con la fecha ultima modificacion
          nAnyo = #0#5 + 2000;   || de la cte y si es igual que no haga nada
          |SI nAnyCons = nAnyo; |Y nMesCons = #0#4;
               swAcaba = 1;
          |FINSI;

|| si la fecha ultima revision de la cte. es superior a la de la ultima nomina q
|| q tengo actualizada puede ser pq no haya nomina calculada el mes de la
|| actualizacion de la cte. (event) asi que dejo pasar y no compruebo mas

          nume1 = #14#80;     || #14#79 es el mes ultima ficha en Hco
          |SI nume1 < nAnyCons; || #14#80 es el a¤o ultima ficha en Hco
               swAcaba = 1;   || #15#78 es el mes ultima revision
          |FINSI;             || #15#77 es el a¤o ultima revision
          |SI nume1 = nAnyCons; |Y #14#79 < nMesCons;
               swAcaba = 1;
          |FINSI;
          |SI #labtraba#248 = 821;
               swAcaba = 1;
          |FINSI;
          |SI swAcaba = 1;
               |CIERRA #5;
               |CIERRA #14;
               ||CIERRA #15;
               |ACABA;
          |FINSI;
          |SI FSalida = 0; || si existe constante seguimos
               |PARA i = 6; |SI i [ 19; |HACIENDO i = i + 1;
                    || campos  2, 3 y 4 no estan vigentes de desde 2006 !!!
                    || el campo  5 (coef. reductor no se usa ya para nada)
                    |SI #14i ! #15i; |Y #14i ! 0;
                         swConst = 1;
                         |SAL;
                    |FINSI;
               |SIGUE;
               |PARA i = 74;|SI i [ 75; |HACIENDO i = i + 1;
                    |SI #14i ! #15i;
                         swConst = 1;
                         |SAL;
                    |FINSI;
               |SIGUE;

               alfa1 = aAny_ult % -102;
               nume1 = alfa1;
               |SI nMes_ult ] #0#4; |Y nume1 ] #0#5;   || si es el mismo mes
                    swConst = 0;                       || que machaque lo q habia
               |FINSI;                  || o mayor por si se ha desactualizado algo

               |SI swConst = 1;
                    #50#10 = #5#0;
                    #50#11 = #5#1;
                    #50#12 = #5#2;
                    #50#13 = #14#79;
                    #50#14 = #14#80;
               |FINSI;
          |FINSI;
          |CIERRA #15;
     |FINSI;
     |CIERRA #14;
|FINSI;
|CIERRA #5;
|FPRC;

|| PROCESO PARA BUSCAR SI EL TRABAJADOR TIENE INCIDENCIAS DE IRPF
|| PENDIENTES DE VALIDAR

|PROCESO nomgirli;
     |SI #nomgirli#9 = "N";
          swHayIncid = swHayIncid + 1;
     |FINSI;

     #nomir009#0 = nEmp;
     |LEE 000#nomir009.=;
     |SI FSalida = 0;
          |SI #nomir009#21 = 0;
               |ACABA;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI #nomgirco#1 ! "S"; |ACABA; |FINSI;

     |SI #nomgirli#9 = "N";
          swStop = swStop + 1;
          swHayIncid = swHayIncid - 1;
     |FINSI;
|FPRC;

|DEFBUCLE nomgirli;
     #nomgirli#1;
     ;
     nEmp, nAny, #0#4, aDesdeClave;
     nEmp, nAny, #0#4, aHastaClave;
     ;
     NULL, nomgirli;
|FIN;

|PROCESO IncidIRPF;
     swStop = 0;

     |DDEFECTO #nomir009;
     |ABRE #nomir009;

     nAny = #0#5;
     nAny = nAny + 2000;
     aClave = nTra;
     aClave = ("00000" + aClave) % -105;
     aDesdeClave = aClave + ".001";
     aHastaClave = aClave + ".999";
     |BUCLE nomgirli;

     |CIERRA #nomir009;
|FPRC;

/*
|PROCESO ControlModelo;
     nErroMod = 1;
     nAnyoMod = 2000 + #nomactca#5;

     |ABRE #dsmom004;
     #dsmom004#0 = #nomcalca#0;
     #dsmom004#1 = nAnyoMod;
     #dsmom004#2 = 1;
     #dsmom004#3 = 110;
     #dsmom004#4 = 00;
     |LEE 041#dsmom004.];
     |SI FSalida = 0;  |Y #dsmom004#0 = #nomcalca#0;
      |Y #dsmom004#1 = nAnyoMod;
      |Y #dsmom004#3 = 110;
         nErroMod = 0;
     |FINSI;
     |CIERRA #dsmom004;
|FPRC;
*/

|PROCESO LeoDsmom004;
     nErroMod = 0;
     |ERROR10;
|FPRC;

|DEFBUCLE LeoDsmom004;
    #dsmom004#1;
    ;
    #nomcalca#0, nAnyoMod, #0#4, 110, 00;
    #nomcalca#0, nAnyoMod,   12, 110, 99;
    e;
    NULL, LeoDsmom004;
|FIN;

|PROCESO ControlModelo;
     nErroMod = 1;
     nAnyoMod = 2000 + #nomactca#5;

     |BUCLE LeoDsmom004;
|FPRC;


|PROCESO actual;
     |SI nEmpreMod = #nomcalca#0;
         |SI nErroMod = 1;  |ACABA;  |FINSI;
     |SINO;
         nEmpreMod = #nomcalca#0;

         |SI #dsmom107#33 ! "N";
             |HAZ ControlModelo;
             |SI nErroMod = 1;
                 |SI #dsmom107#33 = "S";
                     aAlfa = "0000ERROR: No existe el modelo 110 en el planing, empresa: ";
                     aAlfa = aAlfa + #nomcalca#0 + ".";
                     |MENAV aAlfa;

                     |ACABA;
                 |FINSI;

                 |SI #dsmom107#33 = "P";
                     aAlfa = "0000NAVISO: No existe el modelo 110 en el planing, empresa: ";
                     aAlfa = aAlfa + #nomcalca#0 + ". Actualizamos el registro?";
                     |CONFI aAlfa;
                     |SI FSalida ! 0;
                         |ACABA;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     nErroMod  = 0;

     |PINTA 2218,#1#0;
     |PINTA 2239,#1#1;
     |PINTA 2254,#1#3;
     |HAZ por_si_esta;
     |HAZ compara;

     || ignacio prieto. tiquet 2996.1134
     |ABRE #nomcont1; |LEE 000#nomcont1.p; |CIERRA #nomcont1;
     |SI #nomcont1#9 = 2996;
          swConst = 0;
     |FINSI;

     |SI continua = 0; |Y swConst = 0;
          nEmp = #nomcalca#0;
          nTra = #nomcalca#1;
          |HAZ IncidIRPF;
          |SI swStop ! 0;
               nTraNoAct = nTraNoAct + 1;
               |ACABA;
          |FINSI;

          seleccio = 1;
          |HAZ MotivoBaja;
          |HAZ promvar;
          |SI ant_empresa ! #1#0;
               |HAZ borepi;
               |HAZ boraux;
               ant_empresa = #1#0;
          |FINSI;
          |HAZ trabaj;
          |HAZ borvar;
          |HAZ basesd;
          |HAZ grabahis;
          |HAZ grabaConstantes; || Constantes para atrasos
          || se elimina por la puesta en marcha del cambio en las constantes
     |FINSI;

     |SI swConst ! 0;
          |PUSHV 0501 2380;
          |AVISO;
          |PINPA #3#50;
          |PINDA #3#50;
          |PAUSA;
          |POPV;
     |FINSI;
|FPRC;

|DEFBUCLE nomactca0;
 #1#1;
 ;
 #0#0, #0#2, #0#4, 0;
 #0#1, #0#3, #0#4, 9;
 ;
 NULL, actual;
|FIN;

|PROCESO AvisosGestor;
     |SI aParam = "AUTO";
          |ACABA;
     |FINSI;

     |SI nTraNoAct ! 0; |Y swStopIRPF = 0;
          aAlfa = nTraNoAct;
          |SI nTraNoAct = 1;
               aAlfa = "    ATENCION: No se ha actualizado " + aAlfa + " trabajador";
          |SINO;
               aAlfa = "    ATENCION: No se han actualizado " + aAlfa + " trabajadores";
          |FINSI;
          aAlfa = aAlfa + " por tener incidencias de nivel 2 en el IRPF. ";
          |MENAV aAlfa;
          aAlfa = "    Pulse OK para emitir el informe de los trabajadores ";
          aAlfa = aAlfa + "que no han sido actualizados al histórico.";
          |MENAV aAlfa;

          |SUB_EJECUTA "nomgirin;nomactca";
     |FINSI;
     |SI swHayIncid ! 0;
          |SI aParam2 = "PI";
               aAlfa = "    ATENCION: existen empresas con incidencias de nivel 2 en el IRPF";
               aAlfa = aAlfa + " y el gestor de incid. está desactivado. ";
               |MENAV aAlfa;

               aAlfa = "    Consulte: Gestión de Procesos Laborales Mensuales / ";
               aAlfa = aAlfa + "Informe Incidencias IRPF";
               |MENAV aAlfa;
          |SINO;
               aAlfa = "    ATENCION: existen empresas con incidencias de nivel 2 en el IRPF ";
               aAlfa = aAlfa + "y el gestor de incid. está desactivado. ";
               |MENAV aAlfa;

               aAlfa = "Proceso Mensual / Informe Incidencias IRPF";
               aAlfa = "    Consulte la opción " + aAlfa + " para comprobarlo.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO IniciaGestor;
     |SI aParam = "AUTO";
          swStopIRPF = 0;
          |ACABA;
     |FINSI;

     nDesdeEmp = #0#0;
     nHastaEmp = #0#1;
     nDesdeTra = #0#2;
     nHastaTra = #0#3;
     nMes = #0#4;
     nNume = #0#5;
     nNume = nNume + 2000;
     nAny = nNume;

     swStopIRPF = 0;
     |SUB_EJECUTA "nomgir00;nomactca";
     nTraNoAct = 0;
     |DDEFECTO #nomgirco;
     |ABRE #nomgirco; |LEE 000#nomgirco.p;  |CIERRA #nomgirco;
|FPRC;

|PROCESO tipo3; |TIPO 3;           || proceso de actualizacion
     |SI #0#6 = "NO";    |ACABA;   |FINSI;

     |SI #0#5 < 80; el_anyo = #0#5 + 2000; |SINO; el_anyo = #0#5 + 1900; |FINSI;
     |DDEFECTO #50;

     |DBASS aFichMod;
     aFichMod = aFichMod + "modelos/fich/";
     |PATH_DAT #dsmom107#aFichMod#;

     |ABRE #dsmom107;
     |LEE 000#dsmom107.p;
     |SI FSalida ! 0;  |DDEFECTO #dsmom107;  |FINSI;
     |CIERRA #dsmom107;

/*
|HAZ AsientosContables;   || pase a contabilidad
*/

     |HAZ IniciaGestor;

     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;

     |SI swStopIRPF = 0;
          nEmpreMod = 0;
          |BUCLE nomactca0;             || bucle del fichero de cab. calculos
     |FINSI;

     |HAZ AvisosGestor;

     |SI seleccio = 0; |Y aParam ! "AUTO";
          |MENAV "    ATENCION !!! Seleccion vacia ...";
     |FINSI;

     |HAZ limpia_patio;
|FPRC;

*************************************************************************
     RUTINAS PROCESO DE ACTUALIZACION
*************************************************************************

|PROCESO AsientosContables;
     nXDesdeEmpresa=#0#0;
     nXHastaEmpresa=#0#1;
     nXDesdeTrabajador=#0#2;
     nXHastaTrabajador=#0#3;
     nXDesdeMes=#0#4;
     nXHastaMes=#0#4;
     nXAnyo=#0#5;
     |SUB_EJECUTA "nomagicu;nomactca";
|FPRC;

|PROCESO por_si_esta;         || aviso de sobreactualizacion
    continua = 0;
|ABRE #3;
    #3#0  = #1#0;   || Codigo empresa
    #3#1  = #1#1;   || Codigo trabajador
    #3#2  = #1#2;   || mes
    #3#3  = #1#3;   || tipo
    #3#66 = #0#5;   || a¤o
|LEE 000#3=;
|SI FSalida = 0;
    |AVISO;
        alfa1 = "    ATENCION! SOBREACTUALIZANDO FICHA: " + #3#0 + "/" + #3#1 + "/" + #3#2 + "/" + #3#3 + "/" + #3#66;
    |ATRI P;
    |MENSA alfa1;
    |ATRI 0;
    |CONFI "    N¨Sobreactualizarla (S/N)?: ";
        continua = FSalida;
|FINSI;
|CIERRA #3;
|BLIN 4;
|FPRC;

|PROCESO promvar;
     pr_enf = 0;
     pr_acc = 0;
     |ABRE #7;
     #7#0 = #1#0;  || Codigo empresa
     #7#1 = #1#1;  || Codigo trabajador
     #7#2 = #1#2;  || Mes
     #7#3 = #1#3;  || Tipo
     |LEE 000#7=;
     |SI FSalida = 0;
          |SI #7#17 ! 0;
               pr_enf = #7#17;
          |FINSI;
          |SI #7#18 ! 0;
               pr_acc = #7#18;
          |FINSI;
     |FINSI;
     |CIERRA #7;
|FPRC;

|PROCESO borvar;   || borra las variaciones trabajador
    pr_enf = 0;
    pr_acc = 0;
|ABRE #7;
    #7#0 = #1#0;  || Codigo empresa
    #7#1 = #1#1;  || Codigo trabajador
    #7#2 = #1#2;  || Mes
    #7#3 = #1#3;  || Tipo
|LEE 140#7=;
|SI FSalida = 0;
        pr_enf = #7#17;
        pr_acc = #7#18;
    |BUCLELIN 0borralin#7;
    |BORRA 020#7a;
    |LIBERA #7;
|FINSI;
|CIERRA #7;
|FPRC;

|PROCESO borrando;
|SI #6#2 ! 5;|Y #6#2 ! 6;|Y #6#2 ! 7;
    |BORRA 020#6a;
|FINSI;
|FPRC;

|DEFBUCLE bor_empresa;
 #6#1;
 ;
 #1#0,  0, #1#2,  0;
 #1#0, 99, #1#2, 19;
 e;
 NULL, borrando;
|FIN;

|PROCESO boraux;   || borra el auxiliar de empresa
|BUCLE bor_empresa;
|FPRC;

|PROCESO PorCalendario;
     nDias = 0;

     |ABRE #nomtrcal;
     aAnyo = #gomdetjr#2;
     #nomtrcal#0 = #labtraba#156;       || defecto calendario laboral
     #nomtrcal#13 = aAnyo;
     |LEE 000#nomtrcal.=;
     nMes = #gomdetjr#3;
     aCalendario = #nomtrcal#nMes#;
     |CIERRA #nomtrcal;

     anynum = #gomdetjr#2;
     mesnum = #gomdetjr#3;
     |HAZ ulti_dia;
     |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
          nCampoDia = nDia + 3;
          |SI #gomdetjr#nCampoDia# = "X";
               nDias = nDias + 1;
          |FINSI;
          |SI #gomdetjr#nCampoDia# = "I";
               nCampo = nDia + 3;
               nNume1 = (nDia * 100) + 1;
               aAlfa1 = aCalendario % nNume1;
               |SI aAlfa1 = 1;
                    || era un dia de fiesta
               |SINO;
                    nDias = nDias + 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DiasActividad;
     nDias = 0;

     |ABRE #gomdetjr;
     #gomdetjr#0 = #labtraba#0;
     #gomdetjr#1 = #labtraba#1;
     #gomdetjr#2 = nAnyJor;
     #gomdetjr#3 = nMesJor;
     |LEE 000#gomdetjr.=;
     |SI FSalida = 0;
          |SI #gomdetjr#35 ! 0;
               nDias = #gomdetjr#35;
          |SINO;
               |HAZ PorCalendario;
               nDias = nDias;
          |FINSI;
     |FINSI;
     |CIERRA #gomdetjr;
|FPRC;

|PROCESO basesd;   || actualiza bases
     |ABRE #9;
     #9#0 = #1#0;    || Codigo empresa
     #9#1 = #1#1;    || Codigo trabajador
     |LEE 101#9=;
     estado = FSalida;
     |DDEFECTO #9;
     #9#0 = #1#0;    || Codigo empresa
     #9#1 = #1#1;    || Codigo trabajador
     |SI estado = 0;
          |GRABA 020#9a;
     |SINO;
          |GRABA 020#9n;
     |FINSI;
     |LIBERA #9;

     || ********************* Graba lineas bases

     |SI sw_mater = 0; |O #labtraba#42 = "A"; |O #labtraba#42 = "E";
          base1 = #1#39;
          base2 = #1#40;
          |SI #labtraba#241 = "N";
          |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               base1 = base1 + #1#62;
               base2 = base2 + #1#62;
          |FINSI;
     |SINO;
          base1 = #1#39 + ((dias_mat * #1#35) ! EURODB);
          base2 = #1#40 + ((dias_mat * #1#35) ! EURODB);

          nume1 = #1#35 * (dias_mat + #1#31 + #1#32);
          |SI nume1 ! #1#62;    || comparo base en baja de mto. con base en baja real
               nume1 = nume1 - #1#62;  || si son distintas ajusto restando diferencia
               base1 = base1 - nume1;  || a base de comunes de y profesionales, esto es
               base2 = base2 - nume1;  || todo por lo del ajuste que se hizo (busca
          |FINSI;                    || swAjuste3 en nomcal_3

     |FINSI;

     |SI #5#42 ! "X"; |Y #5#42 ! "T"; |Y #5#42 ! "I"; |Y #5#42 ! "P";
          base2 = base2 - #1#41 - #1#42;
     |FINSI;

     swSigue = 0;
     |SI #0#5 [ 12; swSigue = 1; |FINSI;
     |SI #0#5 = 13; |Y #0#4 [ 10; swSigue = 1; |FINSI;

     |SI swSigue = 1;
          |SI #labtraba#190 = "S"; |Y #0#5 ] 11;
               base2 = base2 / 0.75;
          |FINSI;
     |FINSI;

     |HAZ fechabas;

     |SI estado = 0;
          linea = 0;
          |BUCLELIN 0bases#9;
          |SI linea = 0;
               linea = #10#2 + 1;
          |FINSI;
          |ABRE #10;
          #10#0 = #1#0;      || Codigo empresa
          #10#1 = #1#1;      || Codigo trabajador
          #10#2 = linea;     || Linea
          |LEE 101#10=;
          FEstado = FSalida;
          #10#0 = #1#0;      || Codigo empresa
          #10#1 = #1#1;      || Codigo trabajador
          #10#2 = linea;     || Linea
          #10#3 = fecha;     || Fecha
          |SI #1#3 ! 2;
               || en finiquito los dias que me acumula son CERO si tengo regulacion
               || de empleo, no tiene por que acumular dias ya que me borra los
               || reales

               #10#4 = #1#8;      || Dias cotizados
          |FINSI;
          |SI #5#42 = "C"; |O #5#42 = "F";
               /*
               |SI #nomcontr#76 = "2";  || se guardan jornadas (dias) trabajadas
                   nNume = 0;
                   #10#4 = #1#10;
                   |SI #5#42 = "C";
                         nNume = (#1#56 / 1.61) ! 0;
                   |FINSI;
                   |SI #5#42 = "F";
                         nNume = (#1#56 / 1.33) ! 0;
                   |FINSI;
                   #10#4 = #10#4 + nNume;
               |SINO;                   || se imprimen dias cotizados
                   #10#4 = #1#8;
               |FINSI;
               */
               nAnyJor = #0#5 + 2000;
               nMesJor = #0#4;
               |HAZ DiasActividad;
               |SI nDias ! 0;
                   #10#4 = nDias;
               |FINSI;
          |FINSI;
          |SI #5#42 = "E";
               #10#5 = #1#11 + #1#55;     || Horas contratos
          |SINO;
               #10#5 = #1#11;     || Horas contratos
          |FINSI;
          alfa1 = #1#9;
          alfa1 = ("000" + alfa1) % -103;
          #10#6 = alfa1;     || Tipo de contrato
          |SI FEstado ! 0;
               #10#7 = base1; || Bases contigencias
               #10#8 = base2; || Bases desempleo
               #10#9 = "";    || Observaciones
          |SINO;
               #10#7 = #10#7 + base1;   || Bases contigencias
               #10#8 = #10#8 + base2;   || Bases desempleo
          |FINSI;

          || SI TENGO Exp. Reg. Empleo

          |SI #1#78 ! 0; |Y #1#3 = 0; |Y #1#9 ! 87; |Y #1#9 ! 97; |Y #1#9 ! 85;
               #10#4 = #10#4 + #1#78;      || Dias cotizados
               #10#7 = #10#7 + #1#128;
               #10#8 = #10#8 + #1#128;
               |SI #10#4 = 30.50;
                    #10#4 = 30;
               |FINSI;
          |FINSI;

          |SI #1#3 = 2;
               |SI base1 ! 0;|O base2 ! 0;
                    #10#9 = "Finiquito incluido.";
               |FINSI;
          |FINSI;
          |SI FEstado ! 0;  |GRABA 020#10n;  |FINSI;
          |SI FEstado = 0;  |GRABA 020#10a;  |FINSI;
          |LIBERA #10;
          |CIERRA #10;
     |SINO;
          |ABRE #10;
          #10#0 = #1#0;      || Codigo empresa
          #10#1 = #1#1;      || Codigo trabajador
          #10#2 = 1;         || Linea
          #10#3 = fecha;     || Fecha
          #10#4 = #1#8;      || Dias cotizados
          /*
          |SI #5#42 = "C"; |O #5#42 = "F";
               |SI #nomcontr#71 = "D";  || citricos, cotizacion por dias
                   #10#4 = #1#55;       || no por jornadas jornadas
               |FINSI;
          |FINSI;
          */
          |SI #5#42 = "E";
               #10#5 = #1#11 + #1#55;     || Horas contratos
          |SINO;
               #10#5 = #1#11;     || Horas contratos
          |FINSI;
          #10#6 = #1#9;      || Tipo de contrato
          #10#7 = base1;     || Bases contigencias
          #10#8 = base2;     || Bases desempleo
          #10#9 = "";        || Observaciones

          || SI TENGO Exp. Reg. Empleo

          |SI #1#78 ! 0; |Y #1#3 = 0; |Y #1#9 ! 87; |Y #1#9 ! 97; |Y #1#9 ! 85;
               #10#4 = #10#4 + #1#78;      || Dias cotizados
               #10#7 = #10#7 + #1#128;
               #10#8 = #10#8 + #1#128;
               |SI #10#4 = 30.50;       || ni tengo tiempo ni se me ocurre
                    #10#4 = 30;         || algo mejor
               |FINSI;
          |FINSI;
          |GRABA 020#10n;
          |LIBERA #10;
          |CIERRA #10;
     |FINSI;
     |CIERRA #9;
|FPRC;

|PROCESO MotivoBaja;
     aMotivoBaja = "";
     |ABRE #7;
     #7#0 = #1#0;  || Codigo empresa
     #7#1 = #1#1;  || Codigo trabajador
     #7#2 = #1#2;  || Mes
     #7#3 = #1#3;  || Tipo
     |LEE 000#7=;
     |SI FSalida = 0;
          aAlfa = #7#16;
          |QBF aAlfa;
          |SI aAlfa ! ".........."; |Y aAlfa ! "";
               |SI #7#46 ! 0;
                    |ABRE #motibaja;
                    aAlfa = #7#46; aAlfa = "00" + #7#46; aAlfa = aAlfa % -102;
                    nNume = aAlfa;
                    #motibaja#0 = nNume;
                    |LEE 000#motibaja.=;
                    |SI FSalida = 0;
                         aAlfa = #7#46; aAlfa = "00" + #7#46; aAlfa = aAlfa % -102;
                         aMotivoBaja = aAlfa + " - " + #motibaja#1;
                         |QBF aMotivoBaja;
                    |FINSI;
                    |CIERRA #motibaja;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #7;
|FPRC;

|PROCESO OrigenControlIT;
     aOrigenControlIT = "";
     |ABRE #7;
     #7#0 = #1#0;  || Codigo empresa
     #7#1 = #1#1;  || Codigo trabajador
     #7#2 = #1#2;  || Mes
     #7#3 = 0;     || Tipo
     |LEE 000#7=;
     |SI FSalida = 0;
          |PARA nCampo = 12; |SI nCampo [ 15;|HACIENDO nCampo = nCampo + 1;
               |SI #7nCampo = "C";
                    nCampo1 = nCampo - 8;
                    nCampo2 = nCampo - 4;
                    |SI #7nCampo1 ! 0; |Y #7nCampo2 = 0;
                         || empiezo control IT
                         aOrigenControlIT = #7#51;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #7;
|FPRC;

|PROCESO Concepto948;
     #nomcalli#0 = #1#0;
     #nomcalli#1 = #1#1;
     #nomcalli#2 = #0#4;
     #nomcalli#3 = 0;
     #nomcalli#4 = 948;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          #5#242 = #nomcalli#10;
          |SI #5#188 = "2";
               #5#188 = "S";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Concepto927;
     #nomcalli#0 = #1#0;
     #nomcalli#1 = #1#1;
     #nomcalli#2 = #0#4;
     #nomcalli#3 = 0;
     #nomcalli#4 = 927;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          #5#95 = #nomcalli#10;
          #5#96 = #nomcalli#10;
     |FINSI;
|FPRC;

|PROCESO DesemTP;
     nPropIT = 1;
     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo - 8;
          nCampo2 = nCampo - 4;

          |SI #nomcalca#nCampo# = "D";
               nCampo3 = nCampo + 92;
               |SI #nomcalca#nCampo3# ! 0; |O #nomcalca#nCampo3# ! 100;
                    nNume1 = #nomcalca#nCampo1#;
                    |SI nNume1 = 0; nNume1 = 1; |FINSI;
                    |SI nNume1 [ dia_d; |Y dia_h [ #nomcalca#nCampo2#;
                         nPropIT = (100 - #nomcalca#nCampo3#) / 100;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO trabaj;  || actualiza el trabajador
     |ABRE #2;
     |ABRE #5;
     |ABRE #11;
     |ABRE #12;
     #5#0 = #1#0;    || Codigo empresa
     #5#1 = #1#1;    || Codigo trabajador
     |LEE 121#5=;
     |SI FSalida = 0;
          |HAZ leetodo;   || lee empresa, convenio y cotiz. 18/93
          |HAZ empieza1;  || carga historial de ILT del trabajador para dto.ILT
          |SI antemp ! #5#0;|O anttra ! #5#1;
               |HAZ cargatra;
               antemp = #5#0;   ||  cuando existen fichas dobles (0 y 2)
               anttra = #5#1;   || /hace la carga en la primera solamente
          |FINSI;
                         || PANTALLA DE ENFEMEDAD Y ACCIDENTES TRABAJADOR
          |HAZ si_mater;            || maternidad (1995)
          dia_d = 0;
          dia_h = 0;
          num_enfer = 0;  num_accid = 0;  num_veces = 0;
          dia_enfer = 0;  dia_accid = 0;
          num_veces_e = 0; num_veces_m = 0; d_acum = 0; nume1 = 0;
          no_promac = 0;   || switch para no tocar el promedio de AT
          no_promen = 0;   || switch para no tocar el promedio de EP
          prenf_ant = #5#95;
          pracc_ant = #5#96;
          swFechaBaja = 0;

          swFijoDisc = 0;
          swContratoTP = 0;
          nContrato = #labtraba#45;
          |SI 300 [ nContrato; |Y nContrato [ 399;
               swFijoDisc = 1;
          |FINSI;
          |SI 200 [ nContrato; |Y nContrato [ 299;
               swContratoTP = 1;
          |FINSI;
          |SI 500 [ nContrato; |Y nContrato [ 599;
               swContratoTP = 1;
          |FINSI;

          mes_d1 = #1#19; mes_d2 = #1#20;  || Desde mesde
          mes_d3 = #1#21; mes_d4 = #1#22;

          mes_h1 = #1#23; mes_h2 = #1#24;  || Hasta meses
          mes_h3 = #1#25; mes_h4 = #1#26;

          |SI #1#23 = 0; mes_h1 = #1#7; |FINSI;
          |SI #1#24 = 0; mes_h2 = #1#7; |FINSI;
          |SI #1#25 = 0; mes_h3 = #1#7; |FINSI;
          |SI #1#26 = 0; mes_h4 = #1#7; |FINSI;

          |SI #1#19 = 0; mes_d1 = 1; |FINSI;
          |SI #1#20 = 0; mes_d2 = 1; |FINSI;
          |SI #1#21 = 0; mes_d3 = 1; |FINSI;
          |SI #1#22 = 0; mes_d4 = 1; |FINSI;

                            || ENFERMEDADES

          |SI #1#27 = "E";
          |O #1#27 = "M"; |O #1#27 = "P"; |O #1#27 = "R"; |O #1#27 = "C";
               num_enfer = num_enfer + 1;
          |FINSI;
          |SI #1#28 = "E";
          |O #1#28 = "M"; |O #1#28 = "P"; |O #1#28 = "R"; |O #1#28 = "C";
               num_enfer = num_enfer + 1;
          |FINSI;
          |SI #1#29 = "E";
          |O #1#29 = "M"; |O #1#29 = "P"; |O #1#29 = "R"; |O #1#29 = "C";
               num_enfer = num_enfer + 1;
          |FINSI;
          |SI #1#30 = "E";
          |O #1#30 = "M"; |O #1#30 = "P"; |O #1#30 = "R"; |O #1#30 = "C";
               num_enfer = num_enfer + 1;
          |FINSI;
          num_veces = num_enfer;
          |SI num_veces > 1;
               |PARA x = 27;|SI num_veces ] 1;|HACIENDO x = x + 1;
                    |SI x = 27; desde = 19; hasta = 23; resta = mes_h1 - mes_d1; |FINSI;
                    |SI x = 28; desde = 20; hasta = 24; resta = mes_h2 - mes_d2; |FINSI;
                    |SI x = 29; desde = 21; hasta = 25; resta = mes_h3 - mes_d3; |FINSI;
                    |SI x = 30; desde = 22; hasta = 26; resta = mes_h4 - mes_d4; |FINSI;

                    |SI #1x = "E";
                    |O #1x = "M"; |O #1x = "P"; |O #1x = "R"; |O #1x = "C";
                         num_veces = num_veces - 1;
                         |SI #1x = "E"; |O #1x = "C";
                              num_veces_e = num_veces_e + 1;
                         |FINSI;
                         |SI #1x = "M"; |O #1x = "P"; |O #1x = "R";
                              num_veces_m = num_veces_m + 1;
                         |FINSI;
                    |FINSI;
                    |SI num_veces = 0;
                         |SI #1x = "E";
                         |O #1x = "M"; |O #1x = "P"; |O #1x = "R"; |O #1x = "C";
                         ||O #1x = "D";
                              clave = #1x;
                              dia_d = #1desde;
                              dia_h = #1hasta;
                              |SI #1x = "E"; |O #1x = "C";
                                   |SI num_veces_e > 1; d_acum = resta + 1; |FINSI;
                              |FINSI;
                              |SI #1x = "M"; |O #1x = "P"; |O #1x = "R";
                                   |SI num_veces_m > 1; d_acum = resta + 1; |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SIGUE;
          |SINO;
               |SI num_veces = 1;
                    |PARA x = 27;|SI x [ 30;|HACIENDO x = x + 1;
                         |SI x = 27; desde = 19; hasta = 23; |FINSI;
                         |SI x = 28; desde = 20; hasta = 24; |FINSI;
                         |SI x = 29; desde = 21; hasta = 25; |FINSI;
                         |SI x = 30; desde = 22; hasta = 26; |FINSI;
                         |SI #1x = "E";
                         |O #1x = "M"; |O #1x = "P"; |O #1x = "R"; |O #1x = "C";
                         ||O #1x = "D";
                              clave = #1x;
                              dia_d = #1desde;
                              dia_h = #1hasta;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;

          div_prom = #1#8;                               || resto (dias alta)
          || si hay huelga, los dias cotizables que aplica la seguridad social
          || a la hora de calcular la base de cotizacion para el mes que viene
          || NO TIENEN decimales, por lo que si son los clasico 1.40 o 1.25
          || dias de huelga, es como si fuera 1 solo, asi que hay que redondear
          |SI #1#33 > 0;
               div_prom = div_prom + #1#33 - (#1#33 ! 0);
               || redondeo huelga aparte, por posible conflicto con ERE a TP
          |FINSI;
          |SI #5#42 = "E";                                   || eventuales agrarios
               |SI #0#5 ] 12;
                    div_prom = #1#11 + #1#55;     || (jornadas reales + en IT)

                    |SI div_prom > 23;
                         |ABRE #nomcalcc;
                         #nomcalcc#0 = #5#0;
                         #nomcalcc#1 = #5#1;
                         #nomcalcc#2 = #0#5 + 2000;
                         #nomcalcc#3 = #0#4;
                         #nomcalcc#4 = 0;
                         |LEE 000#nomcalcc.=;
                         |SI FSalida = 0;
                              |SI #nomcalcc#8 = "M"; |O #nomcalcc#8 = "m";
                                   div_prom = 23;
                              |FINSI;
                         |FINSI;
                         |CIERRA #nomcalcc;
                    |FINSI;
               |SINO;
                    div_prom = #1#11;             || (jornadas reales)
               |FINSI;
          |FINSI;
                                                  ||...EC=enfermedad comun...
                                                  || sigue de EC del mes anterior
          |SI dia_d = 0;|Y dia_h = 0;|Y #5#89 ! 0; |Y #5#60 ! " ";
          |Y #1#3 ! 2;        || en finiquitos NO
               #5#88 = #5#88 + #1#7;  || dias a¤o
               #5#89 = #5#89 + #1#7;  || dias actual
               #5#90 = #5#90 + #1#7;  || dias enfer.anual
               |SI #5#95 = 0;  #5#95 = pr_enf;  |FINSI;
               no_promac = 1;

               |SI #5#42 = "A"; |O #5#42 = "E";
                    #5#95 = #1#35;
                    #5#96 = #1#36;
               |FINSI;
          |FINSI;

          |SI num_enfer = 0;
               aAlfa = #5#60;
               |QBF aAlfa;
               |SI #5#89 = 0; |O aAlfa = "";    || ni alta ni baja de EC este mes
               || antes comprobaba solo los dias (el #5#89) pero se ha dado
               || el caso de algun trabajador que tenia dias porque se habian
               || quedado por algun motivo, y el tipo de IT estaba en blanco
               || porque en verdad NO arrastran ninguna IT. Esto provocaba que
               || no se actualizara el promedio de CC. Pongo tambien la
               || comprobacion del #5#60 14.05.2015
                    #5#60 = "";
                    #5#90 = #5#88;
                    |HAZ prom_enf;   || en el caso de que no haya enfermedad,
               |FINSI;
          |FINSI;

          |SI dia_d ! 0;|Y dia_h = 0;         || baja de EC este mes
               aAntIT = #5#60;
               nAntDiasIT = #5#89;
               #5#60 = clave;
               |SI #5#60 = "E"; |O #5#60 = "C";
                    |SI num_veces_e > 1;
                         nume1 = d_acum;
                    |SINO;
                         |SI #5#60 = "E";
                              nume1 = #1#31;
                         |FINSI;
                         |SI #5#60 = "C";
                              nume1 = #1#131;
                         |FINSI;
                    |FINSI;
                    |SI #5#60 = "E";
                         #5#88 = #5#88 + #1#31;
                         swSigueC = 0;
                         |SI #5#89 ! 0; |Y aAntIT = clave;
                              swSigueC = 1;
                              |SI num_veces_e > 1;
                              |Y dia_d ! 0;
                                   || no es una IT que venia de otra ficha, es
                                   || un trab. que venia de una IT que ha acabado
                                   || y empieza otra, que se queda pendiente
                                   || 1269.2102
                                   swSigueC = 0;
                              |FINSI;
                         |FINSI;

                         |HAZ DesemTP;
                         nume1 = nume1 / nPropIT;
                         |SI swSigueC = 1;
                              || una IT que venia de otra ficha y continua
                              || en esta
                              #5#89 = #5#89 + nume1;
                         |SINO;
                              #5#89 = nume1;
                         |FINSI;
                         #5#90 = #5#90 + #1#31;
                    |FINSI;

                    |SI #5#60 = "C";
                         |HAZ DesemTP;
                         nume1 = nume1 / nPropIT;
                         #5#88 = #5#88 + #1#131;
                         #5#89 = nume1;
                         #5#90 = #5#90 + #1#131;
                    |FINSI;
               |FINSI;

               |SI #5#60 = "M"; |O #5#60 = "P"; |O #5#60 = "R";
                    |SI num_veces_m > 1;
                         nume1 = d_acum;
                    |SINO;
                         nume1 = #1#65;
                    |FINSI;
                    #5#88 = #5#88 + #1#65;
                    |HAZ DesemTP;
                    nume1 = nume1 / nPropIT;
                    #5#89 = nume1;
                    #5#90 = #5#90 + #1#65;
               |FINSI;
               |SI #5#95 = 0; |O pr_enf ! 0;      || cuando empieza la EC, que
                    #5#95 = pr_enf;               || coja el promedio de variaciones
               |FINSI;                            || si lo tiene metido, para el mes
               no_promac = 1;                     || que viene
               |SI #5#42 = "A"; |O #5#42 = "E";
                    #5#95 = #1#35;
                    #5#96 = #1#36;
               |FINSI;

               |HAZ Concepto927;

               aAlfa = #labtraba#125; |QBF aAlfa;
               |SI aAlfa ! ""; |Y nAntDiasIT ! 0; |Y aAntIT = clave;
               |Y swSigueC = 1; || ojo con esto, viene de arriba 1269.2102
                    || es una ficha en la que se acumula una IT de otra
                    || ya que tengo una fecha puesta en la ficha del trab.
                    || y ya tenia dias de IT y la IT que empieza este mes
                    || es la misma que la que venia acumulandose en la ficha
                    || por tanto no modifico la fecha
               |SINO;
                    alfa1 = dia_d; alfa1 = ("00" + alfa1) % -102;
                    alfa2 = #0#4; alfa2 = ("00" + alfa2) % -102;
                    nume3 = 2000 + #0#5; alfa3 = nume3;
                    #labtraba#125 = alfa1 + "." + alfa2 + "." + alfa3;
                    swFechaBaja = 1;
               |FINSI;
          |FINSI;

          |SI dia_d = 0;|Y dia_h ! 0;         || alta de EC este mes
               #5#60 = "";
               #5#88 = #5#88 + #1#31 + #1#65;
               #5#89 = 0;
               #5#90 = #5#90 + #1#31 + #1#65;
               |HAZ prom_enf;
               #labtraba#125 = "          ";
          |FINSI;

          |SI dia_d ! 0;|Y dia_h ! 0;         || baja y alta de EC este mes
               #5#60 = "";
               #5#88 = #5#88 + #1#31 + #1#65;
               #5#89 = 0;
               #5#90 = #5#90 + #1#31 + #1#65;
               |HAZ prom_enf;
          |FINSI;

                             || ACCIDENTES
          dia_d = 0;
          dia_h = 0;

         |SI #1#27 = "A"; num_accid = num_accid + 1; |FINSI;
         |SI #1#28 = "A"; num_accid = num_accid + 1; |FINSI;
         |SI #1#29 = "A"; num_accid = num_accid + 1; |FINSI;
         |SI #1#30 = "A"; num_accid = num_accid + 1; |FINSI;

             num_veces = num_accid;
         |SI num_veces > 1;
             |PARA x = 27;|SI num_veces ] 1;|HACIENDO x = x + 1;
                 |SI x = 27; desde = 19; hasta = 23; resta = mes_h1 - mes_d1; |FINSI;
                 |SI x = 28; desde = 20; hasta = 24; resta = mes_h2 - mes_d2; |FINSI;
                 |SI x = 29; desde = 21; hasta = 25; resta = mes_h3 - mes_d3; |FINSI;
                 |SI x = 30; desde = 22; hasta = 26; resta = mes_h4 - mes_d4; |FINSI;

                 |SI #1x = "A";
                         num_veces = num_veces - 1;
                         dia_accid = dia_accid + resta + 1;
                 |FINSI;
                 |SI num_veces = 0;
                     |SI #1x = "A";
                             dia_d = #1desde;
                             dia_h = #1hasta;
                             dia_accid = dia_accid - resta - 1;
                     |FINSI;
                 |FINSI;
             |SIGUE;
         |SINO;
             |SI num_veces = 1;
                 |PARA x = 27;|SI x [ 30;|HACIENDO x = x + 1;
                     |SI x = 27; desde = 19; hasta = 23; |FINSI;
                     |SI x = 28; desde = 20; hasta = 24; |FINSI;
                     |SI x = 29; desde = 21; hasta = 25; |FINSI;
                     |SI x = 30; desde = 22; hasta = 26; |FINSI;
                         |SI #1x = "A";
                                 dia_d = #1desde;
                                 dia_h = #1hasta;
                         |FINSI;
                 |SIGUE;
             |FINSI;
         |FINSI;                                       ||...AT=accidente trabajo...
         |SI dia_d = 0;|Y dia_h = 0;|Y #5#92 ! 0; || sigue de AT del mes anterior
                 #5#91 = #5#91 + #1#7;  || dias a¤o
                 #5#92 = #5#92 + #1#7;  || dias actual
             |SI #5#96 = 0;  #5#96 = pr_acc;  |FINSI;
                 #5#95 = prenf_ant;
         |FINSI;

         |SI num_accid = 0;|Y #5#92 = 0;     || ni alta ni baja de AT este mes
             |HAZ prom_acc;
         |FINSI;
         |SI dia_d ! 0;|Y dia_h = 0;         || baja de AT este mes
                 nume1 = #1#32;
                 |HAZ DesemTP;
                 nume1 = nume1 / nPropIT;
                 #5#91 = #5#91 + nume1;
                 #5#92 = nume1 - dia_accid;
               |SI #5#95 = 0; |O pr_enf ! 0;      || cuando empieza la EC, que
                    #5#95 = pr_enf;               || coja el promedio de variaciones
               |SINO;
                    || asi antes (22.06.2016)
                    |SI prenf_ant ! 0;         || existia promedio del trab.
                         #5#95 = prenf_ant;     || es lo que habia antes
                    |SINO;                     || estaba el promedio del trab. a cero
                         #5#95 = pr_enf;        || cojo lo calculado en el mantenimiento
                                     || que vendra de variaciones se supone
                    |FINSI;
               |FINSI;                            || si lo tiene metido, para el mes
               |SI #5#96 = 0;  |O pr_acc ! 0;
                    #5#96 = pr_acc;
               |FINSI;      || esta en ILT de Enf.Comun

               || asi antes (22.06.2016)
               ||SI #5#96 = 0;  #5#96 = pr_acc;  |FINSI;

               |HAZ Concepto927;
               alfa1 = dia_d; alfa1 = ("00" + alfa1) % -102;
               alfa2 = #0#4; alfa2 = ("00" + alfa2) % -102;
               nume3 = 2000 + #0#5; alfa3 = nume3;
               #labtraba#125 = alfa1 + "." + alfa2 + "." + alfa3;
         |FINSI;

         |SI dia_d = 0;|Y dia_h ! 0;         || alta de AT este mes
                 #5#91 = #5#91 + #1#32;
                 #5#92 = 0;
             |HAZ prom_acc;
               |SI swFechaBaja = 0;     || para que si hay enf y acc no lo quite
                    #labtraba#125 = "          ";
               |FINSI;
         |FINSI;

         |SI dia_d ! 0;|Y dia_h ! 0;         || baja y alta de AT este mes
                 #5#91 = #5#91 + #1#32;
                 #5#92 = 0;
             |HAZ prom_acc;
         |FINSI;

         |SI #5#247 = 112; |Y num_enfer ! 0; || a los artistas que nunca les cambie el
                 #5#95 = prenf_ant;     || el promedio, ya que este promedio lo di-
                 #5#96 = pracc_ant;     || ce la SS y si se lo recalculo lo jodo
         |FINSI;
                             || RESTO DE CAMPOS

             #5#36 = #1#4;         || fecha de alta
         |SI #5#37 = "          ";|O #5#37 = "..........";
                 #5#37 = #1#5;                              || fecha de baja
         |SINO;
             |SI #1#5 ! "          ";|Y #1#5 ! "..........";
                     #5#37 = #1#5;
             |FINSI;
         |FINSI;

             #5#34 = #1#6;         || fecha antiguedad
             alfa1 = #5#37;
             alfa = alfa1 % 402;
             alfa1 = alfa1 % -102;
             mesn = alfa;
             anyn = alfa1;
         |SI mesn = #0#4; |Y anyn = #0#5;   || situacion (baja)
                 #5#44 = "B";
         |FINSI;
             #5#093 = #5#093 + #1#33; || Dias de huelga
             #5#094 = #5#094 + #1#34; || Dias de absentismo
             #5#173 = #5#173 + #1#66; || Dias de vacaciones
             #5#243 = #5#243 + #1#78; || Dias de desempleo

         |SI #1#2 = 12;
                 #5#088 = 0;
                 #5#091 = 0;
                 #5#093 = 0;
                 #5#094 = 0;
                 #5#243 = 0;
             |SI #5#60 = " ";
                     #5#90 = 0;
             |FINSI;
         |FINSI;

             #5#148 = "A";         || clave "A" siempre
         |SI #5#42 ! "T"; |Y #5#42 ! "X"; |Y #5#42 ! "P";
                 #5#46 = #1#10;    || dias contrato (en los t.p. no se actualizan)
         |FINSI;

         |SI #5#239 = "D";    #5#240 = #5#240 + #1#8;  |FINSI;   || dias antig.

                  || **************** TERCERA PANTALLA DEL TRABAJADOR
         |HAZ prorrata;

          aAlfa = #5#184;
          |QBF aAlfa;
          |SI aAlfa = ""; |Y aMotivoBaja ! "";
               #5#184 = aMotivoBaja;
          |FINSI;

                  || **************** CUARTA PANTALLA DEL TRABAJADOR

         #labtraba#218 = #labtraba#218 + #1#126;
         |HAZ ITnomvarca;

          |HAZ OrigenControlIT;    || busco origen control IT en variaciones
          |SI #labtraba#60 = "C";
               |SI aOrigenControlIT ! "";    || si sigue no habra nada en variaciones
                    #labtraba#133 = aOrigenControlIT;
               |FINSI;
          |FINSI;

          |HAZ Concepto948;

         |GRABA 020#5a;
         |LIBERA #5;

                  || **************** ACUMULADOS HORAS EXTRAORDINARIAS
         |SI #12#40 = "S";|Y #1#3 ! 2;  || en los finiquitos no actualiza horas
             |ABRE #31;
             |DDEFECTO #31;
                 #31#0 = #1#0;
                 #31#1 = #1#1;
             |LEE 101#31=;
             |SI FSalida ! 0;  |GRABA 020#31b;  |LEE 101#31=;  |FINSI;
                 nume0 = #1#2 + 1;
                 prom_ac2 = #31nume0;   || guarda para historico
                 #31nume0 = (#1#41 + #1#42) / #1#8;
             |GRABA 020#31a;
             |LIBERA #31;
             |CIERRA #31;
         |SINO;
             |SI #1#3 ! 2;           || en el finiquito conserva el valor del
                     prom_ac2 = -1;  || mes, sino lo inicializa
             |FINSI;
         |FINSI;

     |FINSI;
     |CIERRA #2;
     |CIERRA #5;
     |CIERRA #11;
     |CIERRA #12;
|FPRC;

|PROCESO t_parcial2;
     tp3 = -1;
     |ABRE #nomcatli;
     #nomcatli#0 = #labtraba#87;
     #nomcatli#1 = #labtraba#17;
     #nomcatli#2 = concepto;
     |LEE 000#nomcatli.=;
     |SI FSalida = 0; tp3 = #nomcatli#3; |FINSI;
     |CIERRA #nomcatli;

     |ABRE #nomtrali;
     #nomtrali#0 = #labtraba#0;
     #nomtrali#1 = #labtraba#1;
     #nomtrali#2 = concepto;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0; tp3 = #nomtrali#3; |FINSI;
     |CIERRA #nomtrali;

     |ABRE #nomvarli;
     #nomvarli#0 = #labtraba#0;
     #nomvarli#1 = #labtraba#1;
     #nomvarli#2 = #0#4;      || mes
     #nomvarli#3 = 0;
     #nomvarli#4 = concepto;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0; tp3 = #nomvarli#5; |FINSI;
     |CIERRA #nomvarli;
|FPRC;

|PROCESO t_parcial;                || proporcion tiempo parcial
     tp1 = 40;
     tp2 = 40;
     tpx = -1;

     es_parcial = 0;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T"; |O #labtraba#42 = "P";
          es_parcial = 1;
          |SI #labtraba#234 ! 0;  tp1 = #labtraba#234;  |FINSI;
          concepto = 910; |HAZ t_parcial2; |SI tp3 ! -1; tp1 = tp3; |FINSI;
          concepto = 912; |HAZ t_parcial2; |SI tp3 ! -1; tp1 = tp3; |FINSI;

          concepto = 909; |HAZ t_parcial2; |SI tp3 ! -1; tp2 = tp3; |FINSI;
          concepto = 911; |HAZ t_parcial2; |SI tp3 ! -1; tp2 = tp3; |FINSI;
     |FINSI;
     tp = tp1 / tp2;

     es_irregul = 0;
     |SI #labtraba#42 = "I";|O #labtraba#42 = "P";
          concepto = 914; |HAZ t_parcial2; |SI tp3 ! -1; tpx = tp3; |FINSI;
          es_irregul = 1;
          |SI tpx ! -1;  tpz = tpx;  |SINO;  tpz = #labtraba#46;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO resta_mes;
    hmes = hmes - 1;
|SI hmes = 0;
        hmes = 12;
        hany = hany - 1;
    |SI hany < 0;
            hany = 99;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO busca_acc_mes;
     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;
          || es el mismo, lo contaria dos veces
          |ACABA;
     |FINSI;

     |SI #5#42 ! "T"; |Y #5#42 ! "X"; |Y #5#42 ! "P";
          |ACABA;
     |FINSI;

     |DDEFECTO #1;
     #1#0  = #labtraba#0;   || empresa
     #1#1  = #labtraba#1;   || trabajador
     #1#2  = #0#4;   || mes
     #1#3  = nTipo;   || tipo
     |LEE 000#1=;
     |SI FSalida = 0;
          |SI #1#65 ! 0; |O #1#131 ! 0;
               henfe = henfe + #1#62;
          |FINSI;
          |SI #12#40 ! "S";
               hhor1 = 0;
               hhor2 = 0;
          |SINO;
               hhor1 = hhor1 + #1#41;
               hhor2 = hhor2 + #1#42;
          |FINSI;
          hbase = hbase + #1#39;
          hmes = #0#4;
          hany = #0#5;
          |HAZ Dias;
          swSigue = 0;
          |SI nDias ! 0;
               |SI #5#42 = "X";
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #1#8;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE busca_acc_mes;
     #labtraba#5;
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, busca_acc_mes;
|FIN;

|PROCESO busca_acc_his;
     |SI #5#42 ! "T"; |Y #5#42 ! "X"; |Y #5#42 ! "P";
          |ACABA;
     |FINSI;

     |DDEFECTO #3;
     #3#0  = #labtraba#0;   || empresa
     #3#1  = #labtraba#1;   || trabajador
     #3#2  = hmes;   || mes
     #3#3  = nTipo;   || tipo
     #3#66 = hany;   || a¤o
     |LEE 000#3=;
     |SI FSalida = 0;
          |SI #3#65 ! 0; |O #3#173 ! 0;
               henfe = henfe + #3#62;
          |FINSI;
          |SI #12#40 ! "S";
               hhor1 = 0;
               hhor2 = 0;
          |SINO;
               hhor1 = hhor1 + #3#41;
               hhor2 = hhor2 + #3#42;
          |FINSI;
          hbase = hbase + #3#39;

          swHis = 1;
          |HAZ Dias;
          swHis = 0;

          swSigue = 0;
          |SI nDias ! 0;
               |SI #5#42 = "X";
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #3#8;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE busca_acc_his;
     #labtraba#5;
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, busca_acc_his;
|FIN;

|PROCESO busca_acc;
     |HAZ resta_mes;
     |DDEFECTO #3;
     #3#0  = #1#0;   || empresa
     #3#1  = #1#1;   || trabajador
     #3#2  = hmes;   || mes
     #3#3  = #1#3;   || tipo
     #3#66 = hany;   || a¤o
     |LEE 000#3=;
     |SI FSalida = 0;
          |SI #3#65 ! 0; |O #3#173 ! 0;
               henfe = henfe + #3#62;
          |FINSI;
          |SI #12#40 ! "S";
               hhor1 = 0;
               hhor2 = 0;
          |SINO;
               hhor1 = hhor1 + #3#41;
               hhor2 = hhor2 + #3#42;
          |FINSI;
          hbase = hbase + #3#39;

          swHis = 1;
          |HAZ Dias;
          swHis = 0;

          swSigue = 0;
          |SI nDias ! 0;
               ||SI #5#42 = "C"; |O #5#42 = "F";
                    || citricos no tengo en cuenta esto
                    || aunque sean fijos discontinuos
               ||SINO;
                    |SI swFijoDisc = 1;
                         swSigue = 1;
                    |FINSI;
                    |SI #5#42 = "X"; |Y swContratoTP = 1;
                         swSigue = 1;
                    |FINSI;
               ||FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #3#8;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO prom_tp_acc;
     |SI #1#3 = 2; |ACABA;    |FINSI;
     /*
     |SI #5#42 = "C"; |O #5#42 = "F";
          |ACABA;
     |FINSI;
     */
     swSigue = 0;
     |SI swFijoDisc = 1;
          swSigue = 1;
     |FINSI;
     |SI #5#42 = "T";|O #5#42 = "X"; |O #5#42 = "P";
          |SI swContratoTP = 1;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          swModulo = 0;
          |HAZ BuscaModulo;
          |SI swModulo = 3462;
               hmes = #1#2;
               hany = #0#5;

               nEmp = #1#0;
               nTra = #1#1;
               aNif = #labtraba#7;
               nTipo = #1#3;

               |SALVA_FICHA #labtraba;
               |SALVA_FICHA #nomcalca;

               |ABRE #3;
               |BUCLE busca_acc_mes;
               |BUCLE busca_acc_his;
               |HAZ resta_mes;
               |BUCLE busca_acc_his;
               |HAZ resta_mes;
               |BUCLE busca_acc_his;
               |CIERRA #3;

               |REPON_FICHA #nomcalca;
               |REPON_FICHA #labtraba;
          |SINO;
               || EL METODO DE SIEMPRE;
               hmes = #1#2;
               hany = #0#5;

               |ABRE #3;
               |HAZ busca_acc;
               |HAZ busca_acc;
               |CIERRA #3;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO busca_enf_mes;
     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;
          || es el mismo, lo contaria dos veces
          |ACABA;
     |FINSI;

     |SI #5#42 ! "T"; |Y #5#42 ! "X"; |Y #5#42 ! "P";
          |ACABA;
     |FINSI;

     |DDEFECTO #1;
     #1#0  = #labtraba#0;   || empresa
     #1#1  = #labtraba#1;   || trabajador
     #1#2  = #0#4;   || mes
     #1#3  = nTipo;   || tipo
     |LEE 000#1=;
     |SI FSalida = 0;
          |SI #1#65 ! 0; |O #1#131 ! 0;
               henfe = henfe + #1#62;
          |FINSI;
          hbase = hbase + #1#39;
          hmes = #0#4;
          hany = #0#5;
          |HAZ Dias;

          swSigue = 0;
          |SI nDias ! 0;
               |SI #5#42 = "X";
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #1#8;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE busca_enf_mes;
     #labtraba#5;
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, busca_enf_mes;
|FIN;

|PROCESO busca_enf_his;
     |SI #5#42 ! "T"; |Y #5#42 ! "X"; |Y #5#42 ! "P";
          |ACABA;
     |FINSI;

     |DDEFECTO #3;
     #3#0  = #labtraba#0;   || empresa
     #3#1  = #labtraba#1;   || trabajador
     #3#2  = hmes;   || mes
     #3#3  = nTipo;   || tipo
     #3#66 = hany;   || a¤o
     |LEE 000#3=;
     |SI FSalida = 0;
          |SI #3#65 ! 0; |O #3#173 ! 0;
               henfe = henfe + #3#62;
          |FINSI;
          hbase = hbase + #3#39;

          swHis = 1;
          |HAZ Dias;
          swHis = 0;

          swSigue = 0;
          |SI nDias ! 0;
               |SI #5#42 = "X";
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #3#8;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE busca_enf_his;
     #labtraba#5;
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, busca_enf_his;
|FIN;

|PROCESO Dias;
     nDias = 0;

     aMes = hmes;
     |QBF aMes;
     aMes = ("00" + aMes) % -102;
     anynum = hany + 2000;
     aAny = anynum;
     aFecha1 = "01." + aMes + "." + aAny;
     fFecha1 = aFecha1;

     mesnum = hmes;
     |HAZ ulti_dia;
     aDia = topemes;
     aFecha2 = aDia + "." + aMes + "." + aAny;
     fFecha2 = aFecha2;

     aFechaAlta = #labtraba#36;
     aFechaBaja = #labtraba#37;
     |QBF aFechaBaja;
     |SI aFechaBaja = ""; |O aFechaBaja = "..........";
          aFechaBaja = "31.12.2099";
     |FINSI;

     fFechaAlta = aFechaAlta;
     fFechaBaja = aFechaBaja;

     |SI fFechaAlta > fFecha1;
          fFecha1 = fFechaAlta;
     |FINSI;
     |SI fFechaBaja < fFecha2;
          fFecha2 = fFechaBaja;
     |FINSI;

     nFecha1 = fFecha1;
     nFecha2 = fFecha2;
     nDias = fFecha2 - fFecha1 + 1;

     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI swHis = 0;
               nDias = nDias - #1#118;
          |SINO;
               nDias = nDias - #3#160;
          |FINSI;
     |FINSI;

     |SI swHis = 0;
          nDias = nDias - #nomcalca#78;
     |SINO;
          nDias = nDias - #nomhicca#119;
     |FINSI;
|FPRC;

|PROCESO busca_enf;
     |HAZ resta_mes;
     |DDEFECTO #3;
     #3#0  = #1#0;   || empresa
     #3#1  = #1#1;   || trabajador
     #3#2  = hmes;   || mes
     #3#3  = #1#3;   || tipo
     #3#66 = hany;   || a¤o
     |LEE 000#3=;
     |SI FSalida = 0;
          |SI #3#65 ! 0; |O #3#173 ! 0;
               henfe = henfe + #3#62;
          |FINSI;
          hbase = hbase + #3#39;

          swHis = 1;
          |HAZ Dias;
          swHis = 0;

          swSigue = 0;
          |SI nDias ! 0;
               ||SI #5#42 = "C"; |O #5#42 = "F";
                    || citricos no tengo en cuenta esto
                    || aunque sean fijos discontinuos
               ||SINO;
                    |SI swFijoDisc = 1;
                         swSigue = 1;
                    |FINSI;
                    |SI #5#42 = "X"; |Y swContratoTP = 1;
                         swSigue = 1;
                    |FINSI;
               ||FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = hdias + nDias;
          |SINO;
               hdias = hdias + #3#8;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO prom_tp_enf;
     |SI #1#3 = 2; |ACABA;    |FINSI;
     /*
     |SI #5#42 = "C"; |O #5#42 = "F";
          |ACABA;
     |FINSI;
     */
     swSigue = 0;
     |SI swFijoDisc = 1;
          swSigue = 1;
     |FINSI;
     |SI #5#42 = "T";|O #5#42 = "X"; |O #5#42 = "P";
          |SI swContratoTP = 1;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          swModulo = 0;
          |HAZ BuscaModulo;
          |SI swModulo = 3462;
               hmes = #1#2;
               hany = #0#5;

               nEmp = #1#0;
               nTra = #1#1;
               aNif = #labtraba#7;
               nTipo = #1#3;

               |SALVA_FICHA #labtraba;
               |SALVA_FICHA #nomcalca;

               |ABRE #3;
               |BUCLE busca_enf_mes;
               |BUCLE busca_enf_his;
               |HAZ resta_mes;
               |BUCLE busca_enf_his;
               |HAZ resta_mes;
               |BUCLE busca_enf_his;
               |CIERRA #3;

               |REPON_FICHA #nomcalca;
               |REPON_FICHA #labtraba;
          |SINO;
               || EL METODO DE SIEMPRE

               hmes = #1#2;
               hany = #0#5;

               |ABRE #3;
               |HAZ busca_enf;
               |HAZ busca_enf;
               |CIERRA #3;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO prom_enf;
     |SI #1#3 = 2; |ACABA;    |FINSI;
     swSigue = 0;

     || Distingue a los agrarios. Tipos A fijos discontinuos como los del
     || Regimen General

     |SI #5#42 = "A"; |Y swFijoDisc = 0;
          swSigue = 1;
     |FINSI;
     |SI #5#42 = "E";
          swSigue = 1;
     |FINSI;

     |SI swSigue = 0;
          |SI sw_mater ! 0;
               henfe = #1#62;    || si tiene maternidad la base de cotizacion
          |SINO;                    ||/es la suma de la de maternidad + la normal
               henfe = 0;
          |FINSI;
          hbase = #1#39;

          hmes = #0#4;
          hany = #0#5;

          |HAZ Dias;
          swSigue = 0;
          |SI nDias ! 0;
               ||SI #5#42 = "C"; |O #5#42 = "F";
                    || citricos no tengo en cuenta esto
                    || aunque sean fijos discontinuos
               ||SINO;
                    |SI swFijoDisc = 1;
                         swSigue = 1;
                    |FINSI;
                    |SI #5#42 = "X"; |Y swContratoTP = 1;
                         swSigue = 1;
                    |FINSI;
               ||FINSI;
          |FINSI;
          |SI swSigue = 1;
               hdias = nDias;
          |SINO;
               hdias = div_prom;
          |FINSI;

          |HAZ prom_tp_enf;         || busca los 2 ultimos meses para los t.parcial
          nNume = (hbase + henfe); || veamos: si cotizo por el maximo,
          |HAZ tope_parche;        || supongo que estoy topeando, asi
          |SI nNume = nTopeMin; |O nNume = nTopeMax;  || que no puedo dividir por 31 si soy
               hdias = 30;      || diario, divido siempre por 30
          |FINSI;                  || parche 23.11.2004 para promedios
          |SI #labtraba#45 = "421"; |O #labtraba#45 = "085";
               |SI hdias > 30;      || diario en formacion, divido siempre por 30
                    hdias = 30;
               |FINSI;
               |SI #0#4 = 2;
                    |SI hdias = 28; |O hdias = 29;
                         hdias = 30;
                    |FINSI;
               |FINSI;
          |FINSI;
          #5#95 = (hbase + henfe) / hdias;
          |SI #labtraba#247 = 911; || mineros del carbon: para hallar el
               |ABRE #nomcarli;
               #nomcarli#0 = #labtraba#87;
               #nomcarli#1 = #labtraba#17;
               |LEE 000#nomcarli.=;
               #5#95 = #nomcarli#3;
               |CIERRA #nomcarli;
          |FINSI;
     |SINO;
          |SI div_prom ! 0;
               |SI #0#5 ] 12;
                    #5#95 = (#1#39 / div_prom);  || base cot. cc. / dias alta
               |SINO;
                    #5#95 = (#1#37 + #1#38) / div_prom;  || total remuneracion / dias alta
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO prom_acc;
     |SI #1#3 = 2; |ACABA;    |FINSI;
     |SI no_promac = 0;
          swSigue = 0;

          || Distingue a los agrarios. Tipos A fijos discontinuos como los del
          || Regimen General

          |SI #5#42 = "A"; |Y swFijoDisc = 0;
               swSigue = 1;
          |FINSI;
          |SI #5#42 = "E";
               swSigue = 1;
          |FINSI;

          |SI swSigue = 0;
               |SI sw_mater ! 0;
                    henfe = #1#62;  || si tiene maternidad la base de cotizacion
               |SINO;                  ||/es la suma de la de maternidad + la normal
                    henfe = 0;
               |FINSI;
               |SI #12#40 ! "S";
                    hhor1 = 0;
                    hhor2 = 0;
               |SINO;
                    hhor1 = #1#41;
                    hhor2 = #1#42;
               |FINSI;
               hbase = #1#40;
               hmes = #0#4;
               hany = #0#5;
               |HAZ Dias;

               swSigue = 0;
               |SI nDias ! 0;
                    ||SI #5#42 = "C"; |O #5#42 = "F";
                         || citricos no tengo en cuenta esto
                         || aunque sean fijos discontinuos
                    ||SINO;
                         |SI swFijoDisc = 1;
                              swSigue = 1;
                         |FINSI;
                         |SI #5#42 = "X"; |Y swContratoTP = 1;
                              swSigue = 1;
                         |FINSI;
                    ||FINSI;
               |FINSI;
               |SI swSigue = 1;
                    hdias = nDias;
               |SINO;
                    hdias = div_prom;
               |FINSI;
               |HAZ prom_tp_acc;     || busca los 2 ultimos meses para los t.parcial
               nNume = ((hbase + henfe) - (hhor1 + hhor2));   || veamos: si cotizo por el maximo,
               |HAZ tope_parche;        || supongo que estoy topeando, asi
               |SI nNume = nTopeMin; |O nNume = nTopeMax;      || que no puedo dividir por 31 si soy
                    hdias = 30;      || diario, divido siempre por 30
               |FINSI;                  || parche 23.11.2004

               |SI #labtraba#45 = "421"; |O #labtraba#45 = "085";
                    |SI hdias > 30;      || diario en formacion, divido siempre por 30
                         hdias = 30;
                    |FINSI;
                    |SI #0#4 = 2;
                         |SI hdias = 28; |O hdias = 29;
                              hdias = 30;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI #labtraba#247 = 911; || mineros del carbon: para hallar el
                    hdias = #1#55;      || promedio divido por dias laborables
                    nNume = #1#31 + #1#32 + #1#65;
                    |SI nNume = 0;           || no hay baja en el mes
                         hdias = #1#55;      || dias trabajados laborables
                    |SINO;
                         hdias = nNume + #1#55; || los dias trabajados
                    |FINSI;                  || mas lo que se cotiza en alta
               |FINSI;

               hhor3 = 0;
               |SI #1#32 ! 0;           || vamos a ver: tengo accidente
                    |SI #1#35 ! #1#36;  || y las bases son distintas
                         || entonces al generar la base en IT la parte de
                         || accidente hay que multiplicarla por su promedio
                         || que sera diferente por ser un trabajador con
                         || horas extra, esto genera una diferencia en el promedio
                         || que hay que quitar pues el promedio se graba en la
                         || ficha del trabajador tal cual, sin incluir diferen-
                         || cias generadas por horas extra ya que estas se calculan
                         || luego en la nomina (lo que sale del nomtrahx)

                         hhor3 = #1#32 * (#1#36 - #1#35);
                    |FINSI;
               |FINSI;
               #5#96 = ((hbase + henfe) - (hhor1 + hhor2 + hhor3)) / hdias;
               |HAZ tope_parche2;
          |SINO;                                        || agrarios SI
               |SI div_prom ! 0;
                    |SI #0#5 ] 12;
                         #5#96 = #1#40 / div_prom;   || base cp / dias alta
                    |SINO;
                         #5#96 = (#1#37 + #1#38) / div_prom;   || total remuner./dias alta
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #5#96 = 0;  |O pr_acc ! 0;
               #5#96 = pr_acc;
          |FINSI;      || esta en ILT de Enf.Comun
     |FINSI;           ||/(no se toca)
|FPRC;

|PROCESO si_mater;
     sw_mater = 0;
     |SI #1#65 ! 0; |O #1#131 ! 0;
          m_dias = #1#65 + #1#131;
          |SI #5#60 = "M"; |O #5#60 = "P"; |O #5#60 = "R"; |O #5#60 = "C";
               m_dias = m_dias + #5#89;
          |FINSI;
          nume1 = 0;
          |SI #1#27 = "M"; |O #1#27 = "P"; |O #1#27 = "R"; |O #1#27 = "C";
               nume1 = #1#23;
          |FINSI;
          |SI #1#28 = "M"; |O #1#28 = "P"; |O #1#28 = "R"; |O #1#28 = "C";
               nume1 = #1#24;
          |FINSI;
          |SI #1#29 = "M"; |O #1#29 = "P"; |O #1#29 = "R"; |O #1#29 = "C";
               nume1 = #1#25;
          |FINSI;
          |SI #1#30 = "M"; |O #1#30 = "P"; |O #1#30 = "R"; |O #1#30 = "C";
               nume1 = #1#26;
          |FINSI;
          |SI nume1 = 0;       nume1 = #1#7;  |FINSI;

          alfa1 = nume1;       alfa1 = "00" + alfa1;    alfa1 = alfa1 % -102;
          alfa2 = #0#4;        alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
          alfa3 = alfa1 + "." + alfa2 + "." + el_anyo;
          fech1 = alfa3;            nume1 = fech1;
          fech2 = "01.01.1995";     nume2 = fech2;
          nume3 = nume1 - nume2 + 1;

          |SI m_dias [ nume3; sw_mater = 1;  |FINSI;
          |SI #0#4 ] 6;   sw_mater = 1;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO Carga003145;
     |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/bomb0017.mas";
     |CARGA_DEF aAlfa, copiadef@;
     |SI FSalida = 0;
          |ABRE #500;
          |SELECT #2#500;
          #500#0 = #labtraba#0;
          #500#1 = #labtraba#1;
          #500#2 = #0#5 + 2000;
          #500#3 = #0#4;
          #500#4 = pageta;
          |LEE 000#500=;
          |SI FSalida = 0;
               nImpReal = #500#5;
               nImpTeor = #500#6;
          |FINSI;
          |CIERRA #500;
     |FINSI;
     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO Bomberos;
     nImpReal = 0;
     nImpTeor = 0;
     nEnEmpresa = #1#0;
     |HAZ BuscaModulo;
     |SI swModulo = 3145;
          |HAZ Carga003145;
          #5b_dif = #5b_dif - nImpTeor + nImpReal;
     |FINSI;
|FPRC;

|PROCESO prorrata;   || ****** TERCERA PANTALLA DEL TRABAJADOR
     tpz = #1#8;
     es_irregul = 0;
     |SI #5#42 = "I";|O #5#42 = "P";
          es_irregul = 1;
     |FINSI;

     #2#0 = #1#0;
     #2#1 = #1#1;
     #2#2 = #0#4;
     #2#3 = 0;
     |PARA pageta = 201; |SI pageta [ 208; |HACIENDO pageta = pageta + 1;
          #2#4 = pageta;
          |LEE 040#2=;
          aver = #2#10;
          |SI FSalida = 0; |Y aver ! 0;            || si la paga tiene valor
               |HAZ empieza2;
               |SI #11confecc ! 99;
                    |HAZ busca;                        || carga dias periodo y 'swpro'
                    |SI #11paga = "N";                 || si es normal o porcentual
                         |HAZ deshas;                  || si hay que descontar ILT
                         |SI swdesde = 1;|O swhasta = 1;
                              |HAZ diasilt;            || cuenta los dias ILT
                              |HAZ descuen;            || acumula dias ILT
                         |SINO;
                              calcdto = #5d_dto;       || diferidas con distinto periodo
                         |FINSI;                       || /de ILT que de prorrateo
                         |HAZ diasacu;                 || cuenta los dias prorrateados
                         |HAZ normal;
                    |SINO;
                         |HAZ porcen;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

***************************************************************************
  SUBRUTINAS DEL BUCLELIN 'prorrata'
***************************************************************************

|PROCESO empieza2;      || CARGA VARIABLES PARA LA PAGA ESPECIFICA
|SI #2#4 = 201; desde_p = 4;  b_dif = 65; a_bases = 55; d_dto = 50; |FINSI;
|SI #2#4 = 202; desde_p = 5;  b_dif = 66; a_bases = 56; d_dto = 51; |FINSI;
|SI #2#4 = 203; desde_p = 6;  b_dif = 67; a_bases = 57; d_dto = 52; |FINSI;
|SI #2#4 = 204; desde_p = 7;  b_dif = 68; a_bases = 58; d_dto = 53; |FINSI;
|SI #2#4 = 205; desde_p = 8;  b_dif = 69; a_bases = 59; d_dto = 54; |FINSI;
|SI #2#4 = 206; desde_p = 9;  b_dif = 84; a_bases = 81; d_dto = 78; |FINSI;
|SI #2#4 = 207; desde_p = 10; b_dif = 85; a_bases = 82; d_dto = 79; |FINSI;
|SI #2#4 = 208; desde_p = 11; b_dif = 86; a_bases = 83; d_dto = 80; |FINSI;
    hasta_p = desde_p + 8;  || hasta mes prorratas
    confecc = hasta_p + 8;  || mes confeccion
    paga    = confecc + 8;  || tipo de paga
    dias    = paga + 8;     || dias paga
    desde_i = desde_p + 88; || desde mes ILT
    hasta_i = desde_i + 8;  || hasta mes ILT
    dedia_i = hasta_i + 24; || desde dia ILT
    hadia_i = dedia_i + 8;  || hasta dia ILT
    dedia_p = hadia_i - 24; || desde dia prorrata
    hadia_p = dedia_p + 8;  || hasta dia prorrata
    tipos = hadia_p - 88;   || tipo paga
    estevale = 0;
    ha2 = -1;
    pdia_0 = 0; pdia_1 = 0; pdia_2 = 0; pdia_3 = 0; pdia_4 = 0; pdia_6 = 0;
    pdia_a = 0; pdia_b = 0; pdia_c = 0; pdia_d = 0; pdia_e = 0; pdia_f = 0;
    pdia_7 = 0; pdia_g = 0;
    calcdto = 0;
    dvalo_209 = #2#10;
    tipo_p = (pageta - 200) + 156;
    ajus_p = (pageta - 200) + 164;

    pror_p = (pageta - 200) + 112;   || prorrateo paga S/N (trabajador)
    |SI #labtraba#pror_p# = "S";
         #11confecc = 99;
    |FINSI;
|FPRC;

|PROCESO deshas;  || CARGA LOS DESDE/HASTA ILT PARA CONTAR LOS DIAS DE DTO.
    swdesde = 0;
    swhasta = 0;
|SI #11desde_i < #11hasta_i;
        vari_desde = #11desde_i;
        vari_hasta = #11hasta_i;
|FINSI;
|SI #11desde_i > #11hasta_i;
        vari_desde =  1;
        vari_hasta = 12;
|FINSI;
|SI #11desde_i = #11hasta_i;|Y #11dedia_i > #11hadia_i;
        vari_desde =  1;
        vari_hasta = 12;
|FINSI;
|SI #11desde_i = #11hasta_i;|Y #11dedia_i [ #11hadia_i;
        vari_desde = #11desde_i;
        vari_hasta = #11hasta_i;
|FINSI;
|SI #1#2 ] #11desde_i; |Y #1#2 [ vari_hasta;   swdesde = 1;  |FINSI;
|SI #1#2 ] vari_desde; |Y #1#2 [ #11hasta_i;   swhasta = 1;  |FINSI;
|FPRC;

|PROCESO diasilt;        || CUENTA DIAS ILT

|SI #0#4 = #11desde_i;|Y #11dedia_i !      1;  estevale = 1;  |FINSI;
|SI #0#4 = #11hasta_i;|Y #11hadia_i ! guarda;  estevale = 1;  |FINSI;
|SI estevale = 1;
    |HAZ recuento1;
|SINO;
    |HAZ diaspaga1;
    |HAZ diasotro1;
|FINSI;
|FPRC;

|PROCESO topeit;
     nNume = 0;
     |SI #12#26 = "S"; nNume = nNume + pdia_b;  |FINSI;     || enf.
     |SI #12#26 = "S"; nNume = nNume + pdia_g;  |FINSI;     || ctrl. IT
     |SI #12#27 = "S"; nNume = nNume + pdia_d;  |FINSI;     || accid.
     |SI #12#43 = "S"; nNume = nNume + pdia_f;  |FINSI;     || mat.
     |SI #12#44 = "S"; nNume = nNume + pdia_e;  |FINSI;     || absen.

     nDiferencia = 0;
     mesnum = #0#4;  anynum = #0#5 + 2000;   |HAZ ulti_dia;

     || no puede ser, soy mensual, no puedo descontar 31
     |SI topemes = 31; |SI nNume > 30;
               nDiferencia = 1;
          |FINSI;
     |FINSI;

     || y en febrero, si estoy el mes completo en it, descuento 30 dias
     || si soy mensual
     |SI topemes = 28; |Y nNume = 28;
          nDiferencia = -2;
     |FINSI;
     |SI topemes = 29; |Y nNume = 29; || (bisiesto)
          nDiferencia = -1;
     |FINSI;


     |SI nDiferencia ! 0;     || no puede ser, soy mensual, no puedo descontar 31
          |SI #12#44 = "S"; |Y pdia_e > 0;     || absen.
               pdia_e = pdia_e - nDiferencia;
               |ACABA;
          |FINSI;
          |SI #12#43 = "S"; |Y pdia_f > 0;     || mat.
               pdia_f = pdia_f - nDiferencia;
               |ACABA;
          |FINSI;
          |SI #12#27 = "S"; |Y pdia_d > 0;     || accid.
               pdia_d = pdia_d - nDiferencia;
               |ACABA;
          |FINSI;
          |SI #12#26 = "S"; |Y pdia_b > 0;     || enf.
               pdia_b = pdia_b - nDiferencia;
               |ACABA;
          |FINSI;
          |SI #12#26 = "S"; |Y pdia_g > 0;     || IT ctrol SS
               pdia_g = pdia_g - nDiferencia;
               |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO descuen;        || ACUMULA DIAS ILT
    swcalcdto = 0;
|SI ha2 ! -1;
                        calcdto = #5d_dto;
    |SI #12#43 = "S";   calcdto = calcdto + pdia_6;  |FINSI;     || mat.
    |SI #12#44 = "S";   calcdto = calcdto + pdia_4;  |FINSI;     || absen.
    |SI #12#26 = "S";   calcdto = calcdto + pdia_1;  |FINSI;     || enf.
    |SI #12#26 = "S";   calcdto = calcdto + pdia_7;  |FINSI;     || ctrl. IT
    |SI #12#27 = "S";   calcdto = calcdto + pdia_3;  |FINSI;     || accid.
        #5d_dto = 0;
        swcalcdto = 1;
|SINO;
    |SI #11hasta_i ! #0#4;|Y #11hasta_p = #0#4;   || si toca paga y el
            calcdto = #5d_dto;                    || periodo ILT cambia
            #5d_dto = 0;
            swcalcdto = 1;
    |FINSI;
|FINSI;
|SI #12#43 = "S";   #5d_dto = #5d_dto + pdia_f;  |FINSI;    || matern.
|SI #12#44 = "S";   #5d_dto = #5d_dto + pdia_e;  |FINSI;    || absen.
|SI #12#26 = "S";   #5d_dto = #5d_dto + pdia_b;  |FINSI;    || enf.
|SI #12#26 = "S";   #5d_dto = #5d_dto + pdia_g;  |FINSI;    || ctrl. IT
|SI #12#27 = "S";   #5d_dto = #5d_dto + pdia_d;  |FINSI;    || accid.

|SI swcalcdto = 0;
        calcdto = #5d_dto;
|FINSI;
|FPRC;

|PROCESO diasacu;
     |SI #0#4 = #11desde_p;|Y #11dedia_p !      1;  estevale = 1;  |FINSI;
     |SI #0#4 = #11hasta_p;|Y #11hadia_p ! guarda;  estevale = 1;  |FINSI;
     |SI estevale = 1;
          |HAZ recuento2;      || dias de prorrateo
     |SINO;
          |HAZ diaspaga2;
          |HAZ diasotro2;
     |FINSI;
|FPRC;

|PROCESO recuento1;
    de1 = 0;  ha1 = -1;       || limites para dias a acumular
    de2 = 0;  ha2 = -1;       || limites para dias a pagar (diferidas)
|SI #0#4 = #11desde_i;     de1 = #11dedia_i;  ha1 =     guarda;  |FINSI;
|SI #0#4 = #11hasta_i;     de1 =          1;  ha1 = #11hadia_i;  |FINSI;
|SI #11desde_i = #11hasta_i;|Y #11dedia_i [ #11hadia_i;
        de1 = #11dedia_i;  ha1 = #11hadia_i;
|FINSI;
|SI #11desde_i = #11hasta_i;|Y #11dedia_i > #11hadia_i;
        de1 = #11dedia_i;  ha1 =     guarda;
        de2 =          1;  ha2 = #11hadia_i;
|FINSI;
|PARA mid = de1; |SI mid [ ha1; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI alfa1 = "I";                 pdia_b = pdia_b + 1;  |FINSI;  || enf.
    |SI alfa1 = "J";                 pdia_d = pdia_d + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_e = pdia_e + 1;  |FINSI;  || abs.
    |SI alfa1 = "M"; |O alfa1 = "P"; |O alfa1 = "R"; |O alfa1 = "O";
         pdia_f = pdia_f + 1;
    |FINSI;  || mat.
    |SI alfa1 = "C";                 pdia_g = pdia_g + 1;  |FINSI;  || ctrol. IT SS
|SIGUE;
|PARA mid = de2; |SI mid [ ha2; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI alfa1 = "I";                 pdia_1 = pdia_1 + 1;  |FINSI;  || enf.
    |SI alfa1 = "J";                 pdia_3 = pdia_3 + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_4 = pdia_4 + 1;  |FINSI;  || abs.
    |SI alfa1 = "M"; |O alfa1 = "P"; |O alfa1 = "R"; |O alfa1 = "O";
         pdia_6 = pdia_6 + 1;
    |FINSI;  || mat.
    |SI alfa1 = "C";                 pdia_7 = pdia_7 + 1;  |FINSI;  || enf.
|SIGUE;
|SI ha2 = -1;  |HAZ diasotro1;  |FINSI;
|FPRC;

|PROCESO recuento2;
    de1 = 0;  ha1 = -1;       || limites para dias a acumular
    de2 = 0;  ha2 = -1;       || limites para dias a pagar (diferidas)
|SI #0#4 = #11desde_p;     de1 = #11dedia_p;  ha1 =     guarda;  |FINSI;
|SI #0#4 = #11hasta_p;     de1 =          1;  ha1 = #11hadia_p;  |FINSI;
|SI #11desde_p = #11hasta_p;|Y #11dedia_p [ #11hadia_p;
        de1 = #11dedia_p;  ha1 = #11hadia_p;
|FINSI;
|SI #11desde_p = #11hasta_p;|Y #11dedia_p > #11hadia_p;
        de1 = #11dedia_p;  ha1 =     guarda;
        de2 =          1;  ha2 = #11hadia_p;
|FINSI;
|PARA mid = de1; |SI mid [ ha1; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_a = pdia_a + 1;  |FINSI;  || alta
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_c = pdia_c + 1;  |FINSI;  || baja
|SIGUE;
    pdia_a = pdia_a - pdia_c;
|PARA mid = de2; |SI mid [ ha2; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_0 = pdia_0 + 1;  |FINSI;  || alta
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_2 = pdia_2 + 1;  |FINSI;  || baja
|SIGUE;
    pdia_0 = pdia_0 - pdia_2;
|SI ha1 = -1;  |HAZ diaspaga2;  |FINSI;
|SI ha2 = -1;  |HAZ diasotro2;  |FINSI;
|FPRC;

|PROCESO diaspaga1;
    pdia_b = #1#31;                || enf.
    pdia_d = #1#32;                || accid.
    pdia_e = #1#34;                || absentismo
    pdia_f = #1#65;                || mat.
    pdia_g = #1#131;               || ctrol. IT SS.

     |SI #5#42 ! "D"; |Y #5#42 ! "T";        || mensuales
          |HAZ topeit;
     |FINSI;


|SI #1#77 = "S";  pdia_e = 0;  |FINSI;  || como ya los ha restado de la paga
                                        ||/no lo actualiza

|SI #1#27 = "f";|O #1#28 = "f";|O #1#29 = "f";|O #1#30 = "f";
        pdia_e = 0;           || si es absentismo sin dto. no lo actualiza
|FINSI;
|FPRC;

|PROCESO Dias_nat_alta;
     nDiasNatAlta = 0;

     alfa1 = "01";
     alfa2 = #0#4; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     nume3 = #0#5 + 2000;
     alfa3 = nume3;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech1 = alfa4;      || PRIMER DIA DEL MES

     nMes = #0#4;
     nAny = #0#5 + 2000;
     |HAZ topemes_plb;

     alfa1 = nTopemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = #0#4; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     nume3 = #0#5 + 2000;
     alfa3 = nume3;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech2 = alfa4;      || ULTIMO DIA DEL MES

     alfa1 = #1#4;
     fech3 = alfa1;      || DIA ALTA TRABAJADOR

     alfa1 = #1#5;
     |QBF alfa1;
     |SI alfa1 ! ""; |Y alfa1 ! "..........";
          fech4 = alfa1;      || DIA BAJA TRABAJADOR
     |SINO;
          fech4 = fech2;
     |FINSI;

     |SI fech3 ] fech1;
          fech5 = fech3;
     |SINO;
          fech5 = fech1;
     |FINSI;

     |SI fech4 [ fech2;
          fech6 = fech4;
     |SINO;
          fech6 = fech2;
     |FINSI;

     nume1 = fech5;
     nume2 = fech6;

     nDiasNatAlta = nume2 - nume1 + 1;
|FPRC;

|PROCESO diaspaga2;
     |SI #labempre#137 = "0";
          pdia_a = #1#8;           || alta
     |SINO;
          pdia_a = #1#10;           || alta
     |FINSI;
     |SI #nomcalca#181 = "S";
          |SI #0#4 = 1; |O #0#4 = 3; |O #0#4 = 5; |O #0#4 = 7; |O #0#4 = 8;
          |O #0#4 = 10; |O #0#4 = 12;
               pdia_a = pdia_a - 1;
          |FINSI;
          |SI #0#4 = 2;
               pdia_a = pdia_a + 2 - bisiesto;
          |FINSI;
     |FINSI;
     pdia_c = dia_3 - #1#8;   || baja

     ||PARCHE PARA LOS M-D

     |SI #5#42 = "M"; |Y #5#64 = "D";
          |SI #1#8 = 30; |Y #1#8 ! #1#7;     || estoy todo el mes de alta
               pdia_a = #1#7;                || cojo dias del mes
          |SINO;                             || no estoy todo el mes de alta
               pdia_a = #1#8;                || cojo dias de alta
          |FINSI;
     |FINSI;

     || PARCHE PARA LOS Agrarios fijos con concepto 101 definido como "D",
     || ha de tener acumulados los dias reales, como si fueran diarios

     |SI #5#42 = "A";
          |ABRE #nomconli;
          #nomconli#0 = #labtraba#87;
          #nomconli#2 = 101;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               |SI #nomconli#3 = "D";
                    |HAZ Dias_nat_alta;
                    pdia_a = nDiasNatAlta;
                    pdia_c = dia_3 - pdia_a;   || baja
               |FINSI;
          |FINSI;
          |CIERRA #nomconli;
     |FINSI;

     ||SI #1#76 = "S";   || estaba a que lo hiciera si SI pero lo logico es
                         || que lo haga cuando #1#76 = "N" 23.09.2010
     |SI #1#76 = "N";
          nume1 = #1#33 - (((#1#33 * 100) $ 100) / 100);
          pdia_a = pdia_a + nume1;
     |FINSI;
|FPRC;

|PROCESO diasotro1;
    pdia_1 = pdia_b;     || enf.
    pdia_3 = pdia_d;     || accid.
    pdia_4 = pdia_e;     || absentismo
    pdia_6 = pdia_f;     || mat.
    pdia_7 = pdia_g;     || IT Control SS
|FPRC;

|PROCESO diasotro2;
    pdia_0 = pdia_a;     || alta
    pdia_2 = pdia_c;     || baja
|FPRC;

|PROCESO normal;    || PROCESO PAGAS NORMALES
     |SI #1#2 = #11hasta_p;             || si finaliza el prorrateo
          |SI #11hasta_p = #11confecc;   || si es mes de confeccion
               #5b_dif = 0;           || cierra acumulados
               |SI ha2 = -1;
                    #5a_bases = 0;
                    |HAZ descuento;
               |SINO;
                    #5a_bases = pdia_a;     || el '#5d_dto' ya viene cargado
               |FINSI;
          |SINO;                              || si no es mes de confeccion
               |SI #11#140 = "N";  |HAZ calpror;  |FINSI;
               #5a_bases = #5a_bases + pdia_0;       || dias prorrateados
               diasefe = #5a_bases - calcdto;        || menos dias ILT
               |SI diasefe < 0;  diasefe = 0;  |FINSI;   || chequea negativo
               #5b_dif = ( (diasefe*dvalo_209) /perio) *#11dias;    || importe
               |SI #5b_dif > 0;
                    |HAZ Bomberos;
               |FINSI;
               |SI ha2 = -1;
                    #5a_bases = 0;
                    |SI swcalcdto = 0;  #5d_dto = 0;  |FINSI;
               |SINO;
                    #5a_bases = pdia_a;  || el '#5d_dto' ya viene cargado
               |FINSI;
          |FINSI;
     |SINO;                      || si se sigue prorrateando
          |SI swpro = 1;                           || si se ha prorrateado
               #5a_bases = #5a_bases + pdia_a;  || acumula dias
          |FINSI;
          |SI #1#2 = #11confecc;              || si es mes de confeccion
               #5b_dif = 0;                || descarga bases diferidas
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO descuento;      || deja los dias dto. para una proxima paga
|SI #0#4 = #11desde_i;   || a tener en cuenta que '#5d_dto' viene cargado
    |SI #11dedia_i ! 1;
            #5d_dto = 0;
        |PARA mid = #11dedia_i; |SI mid [ guarda; |HACIENDO mid = mid + 1;
                nume1 = (100 * mid) + 1;
                alfa1 = histori % nume1;
            |SI alfa1="M"; |O alfa1 = "P"; |O alfa1 = "R"; |O alfa1 = "O";
               |SI #12#43="S";
                 #5d_dto=#5d_dto+1;
               |FINSI;
            |FINSI; || mat.
            |SI alfa1="I";|Y #12#26="S"; #5d_dto=#5d_dto+1; |FINSI; || enf.
            |SI alfa1="J";|Y #12#27="S"; #5d_dto=#5d_dto+1; |FINSI; || accid.
            |SI alfa1="K";|Y #12#44="S"; #5d_dto=#5d_dto+1; |FINSI; || abs.
        |SIGUE;
    |FINSI;
|SINO;
        #5d_dto = 0;
|FINSI;
|FPRC;

|PROCESO porcen;    || PROCESO PAGAS PORCENTUALES
    t_prorrata = #2#9 * #2#10;
    t_prorrata = t_prorrata ! EURODB;
    #5d_dto =   0;
|SI #1#2 = #11hasta_p;      || si finaliza el prorrateo
    |SI #11hasta_p = #11confecc;  || si es mes de confeccion
            #5b_dif = 0;          || cierra acumulados
            #5a_bases = 0;
    |SINO;                                     || si no es mes de confeccion
            #5b_dif = #5a_bases + t_prorrata;  || carga en bases diferidas
            #5a_bases = 0;
    |FINSI;
|SINO;                      || si se sigue prorrateando
    |SI swpro = 1;                                || si se ha prorrateado
            #5a_bases = #5a_bases + t_prorrata;   || acumula ptas.
    |FINSI;
    |SI #1#2 = #11confecc;                   || si es mes de confeccion
            #5b_dif = 0;                     || descarga bases diferidas
    |FINSI;
|FINSI;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
    numer = anynum $ 4;
|SI numer = 0;
        bisiesto = 1;
|SINO;
        bisiesto = 0;
|FINSI;
|SI mesnum =  1;  topemes = 31;            |FINSI;
|SI mesnum =  2;  topemes = 28 + bisiesto; |FINSI;
|SI mesnum =  3;  topemes = 31;            |FINSI;
|SI mesnum =  4;  topemes = 30;            |FINSI;
|SI mesnum =  5;  topemes = 31;            |FINSI;
|SI mesnum =  6;  topemes = 30;            |FINSI;
|SI mesnum =  7;  topemes = 31;            |FINSI;
|SI mesnum =  8;  topemes = 31;            |FINSI;
|SI mesnum =  9;  topemes = 30;            |FINSI;
|SI mesnum = 10;  topemes = 31;            |FINSI;
|SI mesnum = 11;  topemes = 30;            |FINSI;
|SI mesnum = 12;  topemes = 31;            |FINSI;
|FPRC;

|PROCESO busca;  || BUSCA SI HAY PRORRATA EN LA PAGA ACTUAL Y VA CONTANDO DIAS
    perio = 0;
    mas = 0;
    rompe = 0;
    swpro = 0;
|SI #11hasta_p = #11desde_p; |Y #11dedia_p > #11hadia_p;  rompe = 1;  |FINSI;
|SI #11hasta_p < #11desde_p; |O rompe = 1;
        nume1 = #0#5 - 1;
        des1  = #11desde_p;   des2 =       1;
        has1  =      12;      has2 = #11hasta_p;
    |SI #11desde_p [ #0#4;                || si ya ha empezado el ejer. actual
            mas = 1;                      || ejemplo: desde=4, hasta=3, actual=4
    |FINSI;                               || empieza a contar en este a¤o !!!
|SINO;
        nume1 = #0#5;
        des1 = #11desde_p;   des2 =  0;
        has1 = #11hasta_p;   has2 = -1;
|FINSI;

    nume1 = nume1 + mas;
    nume2 = #0#05 + mas;

    des = (nume1 * 100) + #11desde_p;  || mes desde
    has = (nume2 * 100) + #11hasta_p;  || mes hasta
    act = (#0#5  * 100) + #0#4;        || mes actual

|SI act ] des; |Y act [ has;
        swpro = 1;
|FINSI;

|PARA pp = des1; |SI pp [ has1; |HACIENDO pp = pp + 1;
        anynum = nume1;
    |HAZ suma;
|SIGUE;
|PARA pp = des2; |SI pp [ has2; |HACIENDO pp = pp + 1;
        anynum = nume2;
    |HAZ suma;
|SIGUE;

    mesnum = #11hasta_p;  anynum = nume2;      |HAZ ulti_dia;

|SI #5#42="D";|O #5#42="T";  pepulti=topemes;  |SINO;  pepulti=30;  |FINSI;

|SI #11dedia_p !       0; nume6=#11dedia_p-      1; |SINO;  nume6 = 0; |FINSI;
|SI #11hadia_p ! topemes; nume7=pepulti-#11hadia_p; |SINO;  nume7 = 0; |FINSI;

    perio = perio - (nume6 + nume7);

|FPRC;

|PROCESO suma;
     |SI #5#42 = "D";|O #5#42 = "T";
          mesnum = pp;
          |HAZ ulti_dia;
     |SINO;
          |SI #5#42 = "M"; |Y #5#64 = "D";
               mesnum = pp;
               |HAZ ulti_dia;
          |SINO;
               topemes = 30;        || si es mensual cuenta por 30 los meses
          |FINSI;
     |FINSI;
     perio = perio + topemes;
|FPRC;

|PROCESO calpror;
    dvalo_209 = 0;                 || inicializa acumulador
    paga      = #2#4 - 200;        || numero de paga
|HAZ buclet;
    dvalo_209 = dvalo_209;
|FPRC;

|PROCESO buclet;
|SI #5tipo_p = "V";
        concep1 = 51 + paga;      || calcula el 1er. campo de conceptos
        concep2 = concep1 + 32;   || calcula el ultimo campo de concep.
    |PARA campo = concep1; |SI campo [ concep2; |HACIENDO campo=campo+8;
        |SI #11campo ! 0;
                desc = #11campo;  hasc = #11campo;
            |SI #11campo = 100;  desc = 101;      hasc = 199;     |FINSI;
            |SI #11campo = 400;  desc = 401;      hasc = 420;     |FINSI;
            |PARA actc = desc; |SI actc [ hasc; |HACIENDO actc=actc+1;
                    concepto = actc;    || bucle para los 100 y 400
                |HAZ leeconcep;         || lee y acumula conceptos paga
            |SIGUE;
        |FINSI;
    |SIGUE;
|SINO;
    |SI #5tipo_p = "B";      || importe bruto
            dvalo_209 = #5ajus_p / #11dias;
    |FINSI;
    |SI #5tipo_p = "L";      || importe liquido
            dvalo_209 = ((#5ajus_p * 100) / (100 - #5#30)) / #11dias;
    |FINSI;
        dvalo_209 = dvalo_209 ! (EURODB + 2);     || valor pagas
|FINSI;
|FPRC;

|PROCESO leeconcep;  || lee y acumula concepto para paga
    #2#4 = concepto;
|LEE 000#2=;
|SI FSalida = 0;
        duni1_999 = #2#09;
        duni2_999 = #2#11;
        dvalo_999 = #2#10;
    |SI #2#05="F";|Y duni1_999=0;|Y concepto!102; || si es calculo 'F' carga
            duni1_999 = 1;                        || las unidades con 1
    |FINSI;
    |HAZ cal_valo;
|FINSI;
|FPRC;

|PROCESO cal_valo;   || CALCULA EL VALOR ACUMULADO DE LOS 5 CONCEPTOS POR PAGA
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|SI #11tipos = "N";   || si es tipo 'N' o 'P'
    |SI #2#05="D";                divide=dia_2;     |FINSI;  || dias mes
    |SI #2#05="M";                divide=dia_4;     |FINSI;  || dias cotiz.
    |SI #2#05="L";|O #2#05="K";   divide=duni1_999; |FINSI;  || dias lab./fes.
    |SI #2#05="F";|O #2#05="V";|O #2#05="A";  divide=   30;  |FINSI;  || fijos
    |SI es_irregul = 1;|Y tpz ! 0;
        |DDEFECTO #40;
        |ABRE #40;                 || si se carga con los dias de alta
            #40#0 = #5#87;         ||/se divide por los mismos
            #40#1 = #2#4;
        |LEE 000#40=;
        |SI #40#3 = "S";     divide = tpz;  |FINSI;
        |CIERRA #40;
    |FINSI;
|SINO;
        divide = 100;
|FINSI;
    dvalo_209 = dvalo_209 + (product / divide);  || entran todos los conceptos
|FPRC;


*************************************************************************
     SUBRUTINAS PROCESO DE ACTUALIZACION
*************************************************************************

|PROCESO tope_parche2;
     |SI #5#45 = "087";|O #5#45 = "097";|O #5#45 = "085";|O #5#45 = "421";    || aprend./format.
          |ACABA;
     |FINSI;
     |SI #5#42 = "H";
          |ACABA;
     |FINSI;
     |SI #5#237 = "S";
          || este proceso no se para que sirve, imagino que es por alguna
          || historia que saliera hace tiempo, pero no le veo sentido ya
          || que los maximos y minimos tienen que venir de la cotizacion
          || de la propia nomina, en fin, no me atrevo a quitarlo
          || pero en casos de pluriempleo, me esta molestando 31.05.2016

          |ACABA;
     |FINSI;
     |HAZ t_parcial;
     nNume = #nomconst#23 * tp;

     nElAny = #0#5 + 2000;
     |SI #labtraba#248 = 509; |Y tp ! 1; |Y nElAny ] 2011;
          || excluidos de fogasa, limite por horas que salio en el boletin
          || 2011/1
          grupo = #labtraba#33;
          campomin = 47;
          campomin = campomin + grupo;
          nNume = #15campomin * tp;
     |FINSI;

     |SI #5#96 < nNume;
          #5#96 = nNume;
     |FINSI;
|FPRC;

|PROCESO tope_parche;
     |SI #5#45 = "087";|O #5#45 = "097";|O #5#45 = "085";|O #5#45 = "421";    || aprend./format.
          |ACABA;
     |FINSI;
     |HAZ t_parcial;
     nTopeMin = 0;
     nTopeMax = 0;

     nCConst = #labtraba#248;
     |HAZ constante;
     |SI aCError = "";
          |SI tp = 1;
               nTopeMax = 30 * #nomconst#20 * tp;
               nTopeMin = 30 * #nomconst#23 * tp;
          |SINO;
               nTopeMax = hdias * #nomconst#20 * tp;
               nTopeMin = hdias * #nomconst#23 * tp;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO bases;
|SI #10#3 = fecha;
    linea = #10#2;
|FINSI;
|FPRC;

|PROCESO borralin;      || Borra lineas de variaciones trabajador
|BORRA 020#8c;
|LIBERA #8;
|FPRC;

|PROCESO leetodo;
|DDEFECTO #12;
    #12#0 = #5#0;
|LEE 020#12=;            || empresa

|DDEFECTO #11;
    #11#0 = #5#87;
|LEE 020#11=;            || convenio
|FPRC;

|PROCESO empieza1;      || CARGA EL HISTORIAL DE ILT DEL TRABAJADOR
    dia_2 = guarda;
    dia_3 = 30;
|SI #5#42 = "D"; |O #5#42 = "T"; |O #5#42 = "A"; |O #5#42 = "E";
        dia_3 = guarda;
|FINSI;
    dia_4 = dia_3;
    histori = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    swmarca = "B";
|HAZ altas;
|HAZ bajas;
|PARA cl = 27; |SI cl [ 30; |HACIENDO cl = cl + 1;
    |SI #1cl ! " ";
        |SI #1cl = "E";                  swmarca = "I";  |FINSI;
        |SI #1cl = "M";                  swmarca = "M";  |FINSI;
        |SI #1cl = "P";                  swmarca = "P";  |FINSI;
        |SI #1cl = "R";                  swmarca = "R";  |FINSI;
        |SI #1cl = "A";                  swmarca = "J";  |FINSI;
        |SI #1cl = "D";                  swmarca = "B";  |FINSI;
        |SI #1cl = "H";|Y #1#76 = "S";   swmarca = "B";  |FINSI;
        |SI #1cl = "F";|Y #1#77 = "S";   swmarca = "K";  |FINSI;
        |SI #1cl = "C";                  swmarca = "C";  |FINSI;
            descl = cl - 8;     hascl = cl - 4;
            topemes1 = #1descl; topemes2 = #1hascl;
        |HAZ calendar;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO altas;
    fecalf = #5#36;
|HAZ desglosa;
|SI mes = #0#4; |Y any = anyonum;       || si es alta este mes
        topemes1 = 0;
        topemes2 = dia - 1;
    |SI topemes2 ! 0;  |HAZ calendar;  |FINSI;  || por si es alta el dia 1
|FINSI;
|FPRC;

|PROCESO bajas;
    fecalf = #5#37;
|HAZ desglosa;
|SI mes = #0#4; |Y any = anyonum;       || si es baja este mes
        topemes1 = dia + 1;
        topemes2 = 0;
    |SI topemes1 [ guarda;  |HAZ calendar;  |FINSI;  || por si es final de mes
|FINSI;
|FPRC;

|PROCESO calendar;
|SI topemes1 = 0;  topemes1 =      1;  |FINSI;
|SI topemes2 = 0;  topemes2 = guarda;  |FINSI;
|PARA mid = topemes1; |SI mid [ topemes2; |HACIENDO mid = mid + 1;
        alfa1 = histori % 0;  nume0 = alfa1;         || longitud
        nume1 = (100 + (mid - 1));                   || parte izquierda
        alfa1 = histori % nume1;
        nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
        alfa2 = histori % nume2;
        histori = alfa1 + swmarca + alfa2;           || une
|SIGUE;
|FPRC;

|PROCESO cargatra;   || CARGA LOS CAMPOS DEL TRABAJADOR
|DDEFECTO #25;
|PARA x = 0; |SI x [ 247; |HACIENDO x = x + 1;
    #25x = #5x;
|SIGUE;
|FPRC;

***************************************************************************
  RUTINAS DE BORRADO DEL AUXILIAR DE EPIGRAFES
***************************************************************************

|PROCESO borepi2;
|SI #13#9 ! 5;|Y #13#9 ! 6;|Y #13#9 ! 7;|Y #13#9 ! 15;|Y #13#9 ! 16;|Y #13#9 ! 17;
    |BORRA 020#13a;
|FINSI;
|FPRC;

|DEFBUCLE nomactca1;
 #13#1;
 ;
 #1#0,  0, #1#2,   0,  0;
 #1#0, 99, #1#2, 999, 19;
 e;
 NULL, borepi2;
|FIN;

|PROCESO borepi;   || borra el Auxiliar de Epigrafes
|BUCLE nomactca1;
|FPRC;

|PROCESO ITnomvarca;
     |PARA x = 27; |SI x [ 30;|HACIENDO x = x + 1;
          nCampoRSN = x + 65;
          nCampoH = x - 4;
          |SI #1x = "E"; |O #1x = "A"; |O #1x = "C";
               |SI #1nCampoH = 0;
                    |SI #1nCampoRSN = "S";
                         #5#123 = "S";
                    |SINO;
                         #5#123 = "N";
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
/*
     |ABRE #nomvarca;
     #nomvarca#0 = #1#0;  || Codigo empresa
     #nomvarca#1 = #1#1;  || Codigo trabajador
     #nomvarca#2 = #1#2;  || Mes
     #nomvarca#3 = #1#3;  || Tipo
     |LEE 000#nomvarca.=;
     |SI FSalida = 0;
          |PARA nCampo = 12;|SI nCampo [ 15;|HACIENDO nCampo = nCampo + 1;
               |SI #nomvarca#nCampo# = "E"; |O #nomvarca#nCampo# = "A";
               |O #nomvarca#nCampo# = "C";
                    nCampoD = nCampo - 8;
                    nCampoH = nCampo - 4;
                    |SI dia_d = #nomvarca#nCampoD#; |Y dia_h = #nomvarca#nCampoH#;
                         nCampoR = nCampo + 23;
                         |SI #nomvarca#nCampoR# = "S";
                              #5#123 = "S";
                         |SINO;
                              #5#123 = "N";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #nomvarca;
*/
|FPRC;

|PROCESO dsam0018;
     nUltima = #18#3;
|FPRC;

|DEFBUCLE dsam0018;
     #18#1;
     ;
     #labtraba#0, #labtraba#7, nRegistro, 01;
     #labtraba#0, #labtraba#7, nRegistro, 99;
     ;
     NULL, dsam0018;
|FIN;

|PROCESO RegistraEmbargo;
     #17#0 = #labtraba#0;
     #17#1 = #labtraba#7;
     #17#2 = nRegistro;
     |LEE 101#17=;
     |SI FSalida = 0;
          #17#9 = #17#9 + nEmbargo;
          #17#10 = #17#10 - nEmbargo;
          |GRABA 020#17a;
          |LIBERA #17;
     |FINSI;

     nUltima = 0;
     |BUCLE dsam0018;

     #18#0 = #labtraba#0;
     #18#1 = #labtraba#7;
     #18#2 = nRegistro;
     #18#3 = nUltima + 1;

     nMes = #0#4;
     nAny = #0#5 + 2000;
     |HAZ topemes_plb;
     aDia = nTopemes; |QBF aDia;
     aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
     aAny = nAny;
     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;
     #18#4 = fFecha;

     |HAZ MesLetra_plb;
     aAlfa = "NOMINA " + aMes + " " + aAny;
     |SI #1#3 = 2;
          aAlfa = "FINIQUITO " + aMes + " " + aAny;
     |FINSI;
     #18#5 = aAlfa;
     #18#6 = nEmbargo;
     #18#13 = #labtraba#1;
     |GRABA 020#18n;
     |LIBERA #18;
|FPRC;

|PROCESO dsam0017;
     |SI #17#10 ! 0;
          |SI #17#10 ] #1#104;
               nRegistro1 = #17#2;
               nEmbargo1 = #1#104;
               |ERROR10;
          |SINO;
               nRegistro1 = #17#2;
               nEmbargo1 = #17#10;

               nRegistro2 = #17#2 + 1;
               nEmbargo2 = #1#104 - #17#10;
               |ERROR10;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsam0017;
     #17#1;
     13;
     #labtraba#0, #labtraba#7, 01, "S";
     #labtraba#0, #labtraba#7, 99, "S";
     ;
     NULL, dsam0017;
|FIN;

|PROCESO EmbargosIntegral;
     |ABRE #17;
     |ABRE #18;

     |BUCLE dsam0017;

     |SI nRegistro1 ! 0;
          nRegistro = nRegistro1;
          nEmbargo = nEmbargo1;
          |HAZ RegistraEmbargo;
     |FINSI;

     |SI nRegistro2 ! 0;
          nRegistro = nRegistro2;
          nEmbargo = nEmbargo2;
          |HAZ RegistraEmbargo;
     |FINSI;

     |CIERRA #17;
     |CIERRA #18;
|FPRC;

|PROCESO EmbargoMes12;
          |ABRE #nomembca;
          #nomembca#0 = #1#0;
          #nomembca#1 = #1#1;
          |LEE 000#nomembca.=;
          |SI FSalida = 0;         || he tenido embargo el durante el a¤o
               |ABRE #nomembli;
               #nomembli#0 = #1#0;
               #nomembli#1 = #1#1;
               #nomembli#2 = #0#5 + 2000;
               |LEE 000#nomembli.=;
               |SI FSalida = 0;
                    |SI #nomembli#29 ! 0;
                         swSigue = 1;
                         || aunque el mes 12 no haya tenido embargo por no
                         || llegar al minimo por ejemplo, me queda cantidad
                         || para retener el a¤o que viene: creo la ficha

                         #nomembli#2 = #nomembli#2 + 1;
                         |LEE 000#nomembli.=;
                         FEstado = FSalida;
                         |PARA nCampo = 3; |SI nCampo [ 26; |HACIENDO nCampo = nCampo + 1;
                              #nomembli#nCampo# = 0;
                         |SIGUE;
                         |SI FEstado ! 0; || lo logico
                              |GRABA 020#nomembli.n;
                         |SINO;
                              |GRABA 020#nomembli.a;
                         |FINSI;
                         |LIBERA #nomembli;
                    |FINSI;
               |FINSI;
               |CIERRA #nomembli;
          |FINSI;

          |CIERRA #nomembca;
|FPRC;

|PROCESO OtroTrabEmb;
     fFechaAlta = #labtraba#36;
     |SI fFechaAlta > fFechaBaja;
          || tengo otro trabajador con el mismo NIF que tiene una fecha de
          || alta superior a la fecha de baja del que estoy actualizando

          #nomembli#0 = #labtraba#0;
          #nomembli#1 = #labtraba#1;
          #nomembli#2 = #0#5 + 2000;
          |LEE 101#nomembli.=;
          |SI FSalida = 0;
               || el trabajador que continua con el mismo Nif tiene embargo

               |SI #nomembli#29 ! 0;
                    #nomembli#30 = nEmpOri;
                    #nomembli#31 = nTraOri;
                    #nomembli#32 = #0#4;
                    #nomembli#33 = #1#104;

                    nCampo1 = (#0#4 * 2) + 1;
                    nCampo2 = nCampo1 + 1;
                    #nomembli#nCampo1# = #1#104;
                    #nomembli#nCampo2# = #nomembli#nCampo2# + (#nomembli#29 - #1#104);

                    #nomembli#28 = #nomembli#28 + #1#104;
                    #nomembli#29 = #nomembli#29 - #1#104;

                    |GRABA 020#nomembli.a;
                    |LIBERA #nomembli;

                    nEmpDes = #labtraba#0;
                    nTraDes = #labtraba#1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE OtroTrabEmb;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, OtroTrabEmb;
|FIN;

|PROCESO DosTrabajadores;
     |SALVA_FICHA #labtraba;
     |SALVA_FICHA #nomembli;

     nEmpDes = 0;
     nTraDes = 0;

     |SI #labtraba#44 = "B";
          fFechaBaja = #labtraba#37;

          nEmpOri = #labtraba#0;
          nTraOri = #labtraba#1;
          aNif = #labtraba#7;
          |BUCLE OtroTrabEmb;
     |FINSI;

     |REPON_FICHA #nomembli;
     |REPON_FICHA #labtraba;

     |SI nEmpDes ! 0; |Y nTraDes ! 0;
          #nomembli#34 = nEmpDes;
          #nomembli#35 = nTraDes;
          #nomembli#36 = #0#4;
          #nomembli#37 = #1#104;
          |GRABA 020#nomembli.a;
          |LIBERA #nomembli;
     |FINSI;
|FPRC;

|PROCESO embargos;
     swSigue = 0;
     |SI #1#104 ! 0;
          swSigue = 1;
     |FINSI;

     |ABRE #nomembli;                        || para que aunque no se haya
     #nomembli#0 = #1#0;                     || retenido nada este mes se
     #nomembli#1 = #1#1;                     || guarde la cantida restante
     #nomembli#2 = #0#5 + 2000;
     |LEE 000#nomembli.=;
     |SI FSalida = 0;
          |SI #nomembli#29 ! 0;
               swSigue = 1;
          |FINSI;
     |FINSI;
/*
     |SI #1#3 ! 0;       || solo tipo cero, finiquitos NO
          swSigue = 0;
     |FINSI;
*/
     |SI swSigue = 1;
          |ABRE #nomembca;
          #nomembca#0 = #1#0;
          #nomembca#1 = #1#1;
          |LEE 000#nomembca.=;
          |CIERRA #nomembca;

          |ABRE #nomembli;
          #nomembli#0 = #1#0;
          #nomembli#1 = #1#1;
          #nomembli#2 = #0#5 + 2000;
          |LEE 101#nomembli.=;
          |SI FSalida ! 0;              || si no existe el a¤o lo creo
               |GRABA 020#nomembli.n;

               #nomembli#2 = #nomembli#2 - 1;     || busco el a¤o anterior
               |LEE 000#nomembli.=;
               |SI FSalida = 0;
                    nume1 = #nomembli#27;
                    nume2 = #nomembli#28;
                    nume3 = #nomembli#29;

                    #nomembli#2 = #nomembli#2 + 1;
                    |LEE 101#nomembli.=;
                    #nomembli#27 = nume1;      || grabo totales a¤o anterior
                    #nomembli#28 = nume2;
                    #nomembli#29 = nume3;
                    |GRABA 020#nomembli.a;
               |FINSI;
          |FINSI;
          nCampo1 = (#0#4 * 2) + 1;
          nCampo2 = nCampo1 + 1;
          #nomembli#nCampo1# = #nomembli#nCampo1# + #1#104;
          |SI #nomembli#29 = 0;
               #nomembli#29 = #nomembca#6;
          |FINSI;
          #nomembli#nCampo2# = #nomembli#29 - #1#104;

          |SI #0#4 = 1;       || en enero porque no pasaban bien
                              || los importes totales al a¤o siguiente
               |SALVA_FICHA #nomembli;
               #nomembli#2 = #nomembli#2 - 1;
               |LEE 000#nomembli.=;
               |SI FSalida = 0;
                    nRetAnyAnt = #nomembli#28;
                    nPenAnyAnt = #nomembli#29;
               |FINSI;
               |REPON_FICHA #nomembli;
               |SI nRetAnyAnt ! 0;
                    #nomembli#28 = nRetAnyAnt;
                    #nomembli#29 = nPenAnyAnt;
                    #nomembli#nCampo2# = #nomembli#29 - #1#104;
               |FINSI;
          |FINSI;

          #nomembli#28 = #nomembli#28 + #1#104;
          #nomembli#29 = #nomembli#29 - #1#104;
          |GRABA 020#nomembli.a;

          |SI #0#4 = 12;
               |HAZ EmbargoMes12;
          |FINSI;

          |SI #nomcontr#65 = "S";
               nRegistro = 0;
               nRegistro1 = 0;
               nRegistro2 = 0;

               nEmbargo = 0;
               nEmbargo1 = 0;
               nEmbargo2 = 0;

               |HAZ EmbargosIntegral;
          |FINSI;

          |HAZ DosTrabajadores;

          |LIBERA #nomembli;
          |CIERRA #nomembli;
     |FINSI;
|FPRC;

|PROCESO nomvarcb;
     |BORRA 020#nomvarcb.a;
     #nomvarcb#4 = #0#5 + 2000;
     |GRABA 020#nomvarcb.n;
     |LIBERA #nomvarcb;
|FPRC;

|DEFBUCLE nomvarcb;
     #nomvarcb#1;
     ;
     #labtraba#0, #labtraba#1, #0#4, 0, 0000, 00;
     #labtraba#0, #labtraba#1, #0#4, 0, 0000, 31;
     be;
     NULL, nomvarcb;
|FIN;

*************************************************************************
    CALCULOS DE ACTUALIZACION DEL HISTORICO DESDE EL CALCULO MENSUAL
*************************************************************************

|PROCESO grabahis;
     |ABRE #3;
     #3#0  = #1#0;   || Codigo empresa
     #3#1  = #1#1;   || Codigo trabajador
     #3#2  = #1#2;   || mes
     #3#3  = #1#3;   || tipo
     #3#66 = #0#5;   || a¤o
     |LEE 101#3=;
     estado = FSalida;
     |DDEFECTO #3;
     |PARA x = 0; |SI x [ 65; |HACIENDO x = x + 1;
          #3x = #1x;    || Pase de variables
     |SIGUE;
     #3#66 = #0#05;  || a¤o
     #3#67 = #25#87;  || codigo convenio
     #3#68 = #25#60;  || clave enfermedad
     #3#69 = #25#88;  || dias enf. a¤o
     #3#70 = #25#89;  || dias enf. actual
     #3#71 = #25#90;  || dias enf. cal. anual
     #3#72 = #25#91;  || dias acc. a¤o
     #3#73 = #25#92;  || dias acc. actual
     #3#74 = #25#93;  || dias huelga
     #3#75 = #25#94;  || dias absentismo
     #3#76 = #25#95;  || promedio enfer.
     #3#77 = #25#96;  || promedio acci.
     #3#78 = #25#45;  || tipo contrato
     #3#79 = #25#46;  || dias contrato
     #3#80 = #25#47;  || horas contrato
     |SI #25#45 ] 300; |Y #25#45 [ 399;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T"; |O #labtraba#42 = "P";
               || tiempo parcial
          |SINO;
               #3#80 = (#nomconca#162 / 7) ! 2;  || horas contrato
          |FINSI;
     |FINSI;
     #3#128 = #1#86;  || anticipos Paga Extra
     #3#131 = #1#89;  || anticipos 3 (P.Extra)
     |PARA x1 = 50; |SI x1 [ 54; |HACIENDO x1 = x1 + 1;   || dias dto. (origen)
          x2 = x1 + 5;   || acum. bases/dias (origen)
          x3 = x1 + 15;  || bases diferidas  (origen)
          y1 = x1 + 31;  || dias dto.        (destino)
          y2 = x1 + 39;  || acum. bases/dias (destino)
          y3 = x1 + 47;  || bases diferidas  (destino)
          #3y1 = #25x1;
          #3y2 = #25x2;
          #3y3 = #25x3;
     |SIGUE;
     |PARA x1 = 78; |SI x1 [ 80; |HACIENDO x1 = x1 + 1;   || dias dto. (origen)
          x2 = x1 + 3;   || acum. bases/dias (origen)
          x3 = x1 + 6;   || bases diferidas  (origen)
          y1 = x1 + 8;   || dias dto.        (destino)
          y2 = x1 + 16;  || acum. bases/dias (destino)
          y3 = x1 + 24;  || bases diferidas  (destino)
          #3y1 = #25x1;
          #3y2 = #25x2;
          #3y3 = #25x3;
     |SIGUE;
     #3#105 = #1#66;    || dias vacaciones
     #3#106 = #1#67;    || (%) retencion 2
     #3#107 = #1#68;    || (%) retencion 3
     #3#108 = #1#69;    || base irpf 2
     #3#109 = #1#70;    || base irpf 3
     #3#110 = #1#71;    || imp. retencion 2
     #3#111 = #1#72;    || imp. retencion 3
     #3#129 = #1#87;    || (%) retencion pagas
     #3#112 = #1#73;    || prest. enf. empresa
     #3#113 = #1#74;    || total bases
     #3#114 = #1#75;    || total retenciones
     #3#115 = #25#173;  || dias vacaciones a¤o (trabajador)
     #3#116 = prom_ac2; || promedio horas extras anterior
     #3#117 = #1#76;    || dto. pagas huelga
     #3#118 = #1#77;    || dto. pagas absentismo
     #3#119 = #1#78;    || dias desempleo mes
     #3#120 = #25#243;  || dias desempleo a¤o
     #3#121 = #1#79;    || base bonif. cc 2
     #3#122 = #1#80;    || base bonif. cp 2
     #3#123 = #1#81;    || cuota bonif. 2
     #3#124 = #1#82;    || % bonif. 1
     #3#125 = #1#83;    || % bonif. 2
     #3#126 = #1#84;    || base ILT bonif 1
     #3#127 = #1#85;    || base ILT bonif 2
     #3#130 = #1#88;    || bonif. mayores 60 a¤os, R.D.L. 16/2001
     #3#131 = #1#89;    || bonif. mater. agrarios,NO SE ESTA USANDO 17-12-02
     #3#132 = #1#90;    || dias laborables IT Regimen Carbon
     #3#133 = #1#91;    || dias permiso (sin retribucion, para bomberos)
     #3#138 = #1#96;    || bonif. Fomento contratacion indefinida RDL 5/2006

     || campos para recaidas:

     #3#134 = #1#92; #3#135 = #1#93; #3#136 = #1#94; #3#137 = #1#95;
     #3#139 = #1#97; #3#140 = #1#98; #3#141 = #1#99; #3#142 = #1#100;

     #3#143 = #1#101;     || bonif. > 55 a¤os textil
     #3#144 = #1#102;     || bonif. ayuda excendentes textil
     #3#145 = #1#103;     || indicador para el RED
     #3#146 = #1#104;     || embargos
     #3#147 = #1#105;     || absentismo
     #3#148 = #1#106;     || bonif. > 59 a¤os, 4 de antig
     #3#149 = #1#107;     || horas formacion subvencionadas
     #3#150 = #1#108;
     #3#151 = #1#109;
     #3#152 = #1#110;
     #3#153 = #1#111;
     #3#154 = #1#112;
     #3#155 = #1#113;
     #3#156 = #1#114;
     #3#157 = #1#115;
     #3#158 = #1#116;
     #3#159 = #1#117;
     #3#160 = #1#118;
     #3#161 = #1#119;
     #3#162 = #1#120;
     #3#163 = #1#121;
     #3#164 = #1#122;
     #3#165 = #1#123;
     #3#166 = #1#124;
     #3#167 = #1#125;
     #3#168 = #1#126;
     #3#169 = #1#127;
     #3#170 = #1#128;
     #3#171 = #1#129;
     #3#172 = #1#130;
     #3#173 = #1#131;
     #3#174 = #1#132;
     #3#175 = #1#133;
     #3#176 = #1#134;
     #3#177 = #1#135;
     #3#178 = #1#136;
     #3#179 = #1#137;
     #3#180 = #1#138;
     #3#181 = #1#139;
     #3#182 = #1#140;
     #3#183 = #1#141;
     #3#184 = #1#142;
     #3#185 = #1#143;
     #3#186 = #1#144;
     #3#188 = #1#146;
     #3#189 = #1#147;

     #3#190 = #1#148;
     #3#191 = #1#149;
     #3#192 = #1#150;
     #3#193 = #1#151;
     #3#194 = #1#152;
     #3#195 = #1#153;
     #3#196 = #1#154;
     #3#197 = #1#155;
     #3#198 = #1#156;
     #3#199 = #1#157;
     #3#200 = #1#158;
     #3#201 = #1#159;
     #3#202 = #1#160;
     #3#203 = #1#161;
     #3#204 = #1#162;
     #3#205 = #1#163;
     #3#206 = #1#164;
     #3#207 = #1#165;
     #3#208 = #1#166;
     #3#209 = #1#167;
     #3#210 = #1#168;
     #3#211 = #1#169;
     #3#212 = #1#170;
     #3#213 = #1#171;
     #3#214 = #1#172;

     || Campos SS Empresa desglosado:
     #3#215 = #1#173;
     #3#216 = #1#174;
     #3#217 = #1#175;
     #3#218 = #1#176;
     #3#219 = #1#177;
     #3#220 = #1#178;
     #3#221 = #1#179;
     #3#222 = #1#180;
     #3#223 = #1#181;
     |PARA nCampoMen = 182; |SI nCampoMen [ 198; |HACIENDO nCampoMen = nCampoMen + 1;
          nCampoHis = nCampoMen + 42;
          #3nCampoHis = #1nCampoMen;
     |SIGUE;
     fFecha = ~;
     #3#231 = fFecha;
     #3#241 = #1#199;

     |HAZ embargos;

     |BUCLE nomvarcb;
     |SI estado = 0;
          |GRABA 020#3a;
     |SINO;
          |GRABA 020#3n;
     |FINSI;
     |LIBERA #3;
     |CIERRA #3;

     |BUCLELIN 1NULL#3;  || borra historico lins. (si existe)

     |ABRE #4;
     |CIERRA #2;
     |BUCLELIN 0grabalin#1;                            || graba historico lins. y
     |ABRE #2;                                         ||/y borra calculos lins.
     |CIERRA #4;

     |BORRA 020#1a;                                    || borra calculos cabs.
     |SI FSalida = 0;    #50#9 = #50#9 + 1;  |FINSI;   || nro. de actualizaciones

     |LIBERA #1;

     |HAZ BuscaModulo;
     |SI swModulo = 000009; |O swModulo = 1;
          enEmpresa = #3#0;
          enTrabajador = #3#1;
          |HAZ ActualizaLabornet;
     |FINSI;
|FPRC;

*************************************************************************
    SUBRUTINAS DE LA ACTUALIZACION DEL HISTORICO
*************************************************************************

|PROCESO grabalin;      || Graba lineas del historico
    #4#0  = #2#0;   || Codigo empresa
    #4#1  = #2#1;   || Codigo trabajador
    #4#2  = #2#2;   || Mes
    #4#3  = #2#3;   || Tipo
    #4#4  = #2#4;   || Registro
    #4#12 = #0#5;   || A¤o
|LEE 101#4=;
    estado = FSalida;
|DDEFECTO #4;
|PARA x = 0; |SI x [ 11; |HACIENDO x = x + 1;
        #4x = #2x;    || Pase de variables
|SIGUE;
    #4#12 = #0#5;
|SI estado = 0;
    |GRABA 020#4a;
|SINO;
    |GRABA 020#4n;
|FINSI;
|LIBERA #4;

|BORRA 020#2a;   || Borra la linea de calculo
|LIBERA #2;
|FPRC;

|PROCESO fechabas;
    fecalf = #1#5;
|HAZ desglosa;
|SI mes = #1#2; |Y any = anyonum;
        diab = dia;
|SINO;
        diab = #1#7;
|FINSI;
                  diab = "0" + diab;  diab = diab % -102;
    mesb = #1#2;  mesb = "0" + #1#2;  mesb = mesb % -102;
    anyb = anyonum;
    fecha = diab + "." + mesb + "." + anyb;
|FPRC;

|PROCESO desglosa;     || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
|SI #0#5 < 80; anyonum = 2000 + #0#5;  |SINO; anyonum = 1900 + #0#5; |FINSI;
    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "AUTO";
          #0#0 = nEmpAUTO;
          #0#1 = nEmpAUTO;
          #0#2 = nTraAUTO;
          #0#3 = nTraAUTO;
          #0#4 = nMesAUTO;
          #0#5 = nAnyAUTO - 2000;
          #0#6 = "SI";
          |HAZ tipo3;
     |SINO;
          aParam2 = PARAMETRO;
          |QBF aParam2;

          |CLS;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |HAZ tipo3;
          |FINSI;
     |FINSI;
|FPRO;
