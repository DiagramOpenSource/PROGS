|| recibos mensuales por impresora (atrasos DESDE HISTORICO!!!)

|FICHEROS;
     nomareci #00;   || def de impresion
||    nomcalac #04;
||    nomcalal #05;
     nomhicca #04;
     nomhicli #05;
    nomcalat #40;   || parrilla de codigos (atrasos!!!)
    dsnetm00@ #150;    || parametros dsnetcom

     pdfimtmp #200;
     pdfdocca;
     pdfdocli;
     nomcalca;
     :/basica/def/agidanif #8;
     &bancosc@  #709;
|FIN;

|VARIABLES;
    &acum = 0;
    runnom = "nomareci";
    &v_estoy = 0;        || lleva numero de compatibilidad
    &v_para = 0;         || se trae el error
    &v_quien = "";       || lleva nombre usuario
    &v_que = "";         || lleva nombre programa
    &v_ultimo = 0;       || se trae el codigo

     aDirDes = "";
     aRutaDes = "";
     aRuta = "";
     aRutaDatos = "";
     nCanal = 0;
     &aArchivo = "";
     aCabecera = "";
     aTipoResumen = "";
     aTipoNomina = "";
     aEmpresa = "";
     aAnyoDesde = "";
     aAnyoHasta = "";
     aMesDesde = "";
     aMesHasta = "";
     aOrdenacion = "";
     aAnyo = "";
     aDireccion = "";
     aTrabajadorDesde = "";
     aTrabajadorHasta = "";
     nEmpresa = 0;
     nAnyo = 0;
     nMesDesde = 0;
     nMesHasta = 0;
     nOrdenacion = 0;
     nDireccion = 0;
     nTrabajadorDesde = 0;
     nTrabajadorHasta = 0;

     cParam         = "";
     cParte         = "";
     &cOrigen        = "";
     &cDestino       = "";
     cDirBase       = "";
     cUsuario       = "";
     cIp            = "";
     cDirUsu        = "";
     cNumUsu        = "";
     aAlfa1 = "";
     aTabla = "";
     aDir = "";
     &nErrorInf = 0;
     aSystem = "";
     aBaseBin = "";
     aDirOri = "";

     nLongitud = 0;
     aLongitud = "";
     &swDesdeWeb = 0;
     aTipoRecAtrasos  = "";
     nTipoRecAtrasos  = 0;
     &aParametro = "";

     para3 = 0;
     swCarga = 0;
     aID = "";
     &swCopia = 1;
     &nNroCopias = 0;
     nAscii = 0;
     aCaracter = "";
     aCaracterSal = "";
     aCadena = "";
     aCadenaSal = "";
     nPos = 0;
     nBusca = 0;
     nSwNumer = 0;
     aValor = "";
     aCampo = "";
     nTipo = 0;
     poblafir = "";
     causa = "";
     liquido = "";
     nDec = 0;
     aVar = "";
     nCampo = 0;
     nNume = 0;
     i = 0;
     nEnfer = 0;
     nAccid = 0;
     enCodBanco = 0;
     nDesc3 = 0;
     nDesc25 = 0;
     nAscen = 0;
     nNume1 = 0;
     fFecha = @;
     aAlfa2 = "";
     nNume2 = 0;
     nEdad = 0;
     nVar = 0;
     aLong = 0;
     nLong = 0;
     aMod = "";
     nPara = 0;
     nAlfa = 0;
     &swPDFMasivo = 0;
     &aProcedencia = "";
     &nContador = 0;
     &eaVengoDe = "nomareci";
|FIN;

|INCLUYE i_cuadr;
|INCLUYE i_sreci;
|INCLUYE i_pdfrec;

|PROCESO pintames; |TIPO 0;
    Campo = 7;
|HAZ pintames1;
|FPRC;

|DEFBUCLE nomsreci0;
 #4#1;
 ;
 #0#0, #0#2, #0#4, #0#5, #0#10;
 #0#1, #0#3, #0#4, #0#7, #0#10;
 ;
 NULL, proceso;
|FIN;

|DEFBUCLE nombres;
 #4#1;
 ;
 #0#0, #0#2, #0#4, #0#5, #0#10;
 #0#1, #0#3, #0#4, #0#7, #0#10;
 ;
 NULL, ordena, NULL, NULL, NULL, proceso;
 #2#0, #2#2, #2#1;
|FIN;

|DEFBUCLE areas;
 #4#1;
 ;
 #0#0, #0#2, #0#4, #0#5, #0#10;
 #0#1, #0#3, #0#4, #0#7, #0#10;
 ;
 NULL, ordena, NULL, NULL, NULL, proceso;
 #2#0, #2#62, #2#63, #2#1;
|FIN;

|DEFBUCLE centros;
 #4#1;
 ;
 #0#0, #0#2, #0#4, #0#5, #0#10;
 #0#1, #0#3, #0#4, #0#7, #0#10;
 ;
 NULL, ordena, NULL, NULL, NULL, proceso;
 #2#0, #2#77, #2#1;
|FIN;

|DEFBUCLE tc2;
 #4#1;
 ;
 #0#0, #0#2, #0#4, #0#5, #0#10;
 #0#1, #0#3, #0#4, #0#7, #0#10;
 ;
 NULL, ordena, NULL, NULL, NULL, proceso;
 #2#0, #0#64, #102#142, #2#75, #2#1, #4#2;
|FIN;

|PROCESO impre; |TIPO 3;
     c_informe = "nomyreci";
     |HAZ cuadres;
     |SI sw_cuadre = 0;
          |ABRE #1;
          |ABRE #2;
          |ABRE #3;
          |ABRE #6;
          |ABRE #35;
          |ABRE #100;
          |ABRE #102;
          |SI swDesdeWeb = 0; |Y #nomcontr#37 = "N";
               |IMPRE 0;
               |SI Impresora = "CrystalReport";
                    |INFOR "nomycrys";
               |SINO;
                    |INFOR "nomyreci";
               |FINSI;
          |FINSI;
          |SI FSalida = 0;
               seleccio = 0;
               |SI #0#21 = 0;
               |SI #0#63 = 1;    |BUCLE nomsreci0;   |FINSI;
               |SI #0#63 = 2;    |BUCLE nombres;     |FINSI;
               |SI #0#63 = 3;    |BUCLE areas;       |FINSI;
               |SI #0#63 = 4;    |BUCLE centros;     |FINSI;
               |SI #0#63 = 5;    |BUCLE tc2;         |FINSI;
          |SINO;
               |HAZ salteada;
          |FINSI;
          |SI seleccio = 0;
               |MENAV "    Seleccion vacia ...";
          |SINO;
               |SI #0#8 = 2;
                    |SI lineas = 1;
                         |SI #nomcontr#37 = "S";
                              swPDFMasivo = 1;
                              aProcedencia = "nomrecib";
                              |HAZ PreparaPDF;
                         |SINO;
                              nro_copias = #36#34; || carga numero de copias de recibo (ctrl. aplicacion)
                              |PARA nume1 = 1; |SI nume1 [ nro_copias; |HACIENDO nume1 = nume1 + 1;
                                   |HAZ comple_6;
                              |SIGUE;
                              |DDEFECTO #10;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |MENAV "    Proceso ABORTADO !!!";
     |FINSI;
     |SI swPDFMasivo = 1;
          |SUB_EJECUTA "pdfimpre";
     |SINO;
          ||SI Impresora = "CrystalReport";
               |FININF;
          ||FINSI;
          |FINIMP;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #6;
     |CIERRA #35;
     |CIERRA #100;
     |CIERRA #102;
|FINSI;
|FPRC;

|PROCESO comple_6;    || imprime y limpia
     ||SI Impresora ! "CrystalReport";
     ||     |INFOR "nomyreci";
     ||FINSI;
     |PRINT;
     |PIEINF;
     |SI swDesdeWeb ! 0;
          aAlfa = &12;
          |IMPRIME aAlfa;
     |FINSI;
     |SI Impresora ! "CrystalReport";
          ||FININF;
     |FINSI;
|FPRC;

|VARIABLES;
    salte_1 = 0;
    salte_2 = 0;
    mes_i = 0;
|FIN;

*************************************************************************
      RECOGE LA PARRILLA DEL CALCULO Y GESTIONA EL TIPO DE SELECCION
*************************************************************************

|PROCESO parrilla; |TIPO 7;
|ABRE #40;
|LEE 001#40p;
|SI FSalida ! 0;  |DDEFECTO #40;  |FINSI;
|PARA nume1 = 21; |SI nume1 [ 41; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + 21;
        #0nume1 = #40nume1;
        #0nume2 = #40nume2;
|SIGUE;
    #0#4 = #40#9 $ 100;  || a¤o
    #0#5 = #40#8;        || desde mes
    #0#7 = #40#10;       || hasta mes
|CIERRA #40;
|PINDA #0#0;
|FPRC;

|PROCESO seleccion; |TIPO 0;
|SI #0#21 = 0;
    |CAMPO_MODIFICA #0#0, 1, "S";
    |CAMPO_MODIFICA #0#1, 1, "S";
    |CAMPO_MODIFICA #0#2, 1, "S";
    |CAMPO_MODIFICA #0#3, 1, "S";
    |CAMPO_MODIFICA #0#63, 1, "S";
    |CAMPO_MODIFICA #0#22, 1, "N";
    |CAMPO_MODIFICA #0#23, 1, "N";
    |CAMPO_MODIFICA #0#24, 1, "N";
    |CAMPO_MODIFICA #0#25, 1, "N";
    |CAMPO_MODIFICA #0#26, 1, "N";
    |CAMPO_MODIFICA #0#27, 1, "N";
    |CAMPO_MODIFICA #0#28, 1, "N";
    |CAMPO_MODIFICA #0#29, 1, "N";
    |CAMPO_MODIFICA #0#30, 1, "N";
    |CAMPO_MODIFICA #0#31, 1, "N";
    |CAMPO_MODIFICA #0#32, 1, "N";
    |CAMPO_MODIFICA #0#33, 1, "N";
    |CAMPO_MODIFICA #0#34, 1, "N";
    |CAMPO_MODIFICA #0#35, 1, "N";
    |CAMPO_MODIFICA #0#36, 1, "N";
    |CAMPO_MODIFICA #0#37, 1, "N";
    |CAMPO_MODIFICA #0#38, 1, "N";
    |CAMPO_MODIFICA #0#39, 1, "N";
    |CAMPO_MODIFICA #0#40, 1, "N";
    |CAMPO_MODIFICA #0#41, 1, "N";
    |CAMPO_MODIFICA #0#42, 1, "N";
    |CAMPO_MODIFICA #0#43, 1, "N";
    |CAMPO_MODIFICA #0#44, 1, "N";
    |CAMPO_MODIFICA #0#45, 1, "N";
    |CAMPO_MODIFICA #0#46, 1, "N";
    |CAMPO_MODIFICA #0#47, 1, "N";
    |CAMPO_MODIFICA #0#48, 1, "N";
    |CAMPO_MODIFICA #0#49, 1, "N";
    |CAMPO_MODIFICA #0#50, 1, "N";
    |CAMPO_MODIFICA #0#51, 1, "N";
    |CAMPO_MODIFICA #0#52, 1, "N";
    |CAMPO_MODIFICA #0#53, 1, "N";
    |CAMPO_MODIFICA #0#54, 1, "N";
    |CAMPO_MODIFICA #0#55, 1, "N";
    |CAMPO_MODIFICA #0#56, 1, "N";
    |CAMPO_MODIFICA #0#57, 1, "N";
    |CAMPO_MODIFICA #0#58, 1, "N";
    |CAMPO_MODIFICA #0#59, 1, "N";
    |CAMPO_MODIFICA #0#60, 1, "N";
    |CAMPO_MODIFICA #0#61, 1, "N";
    |CAMPO_MODIFICA #0#62, 1, "N";
    |PARA nume1 = 21; |SI nume1 [ 62; |HACIENDO nume1 = nume1 + 1;
        #0nume1 = 0;
    |SIGUE;
    |PINDA #0#0;
|SINO;
    |CAMPO_MODIFICA #0#0, 1, "N";
    |CAMPO_MODIFICA #0#1, 1, "N";
    |CAMPO_MODIFICA #0#2, 1, "N";
    |CAMPO_MODIFICA #0#3, 1, "N";
    |CAMPO_MODIFICA #0#63, 1, "N";
    |CAMPO_MODIFICA #0#22, 1, "S";
    |CAMPO_MODIFICA #0#23, 1, "S";
    |CAMPO_MODIFICA #0#24, 1, "S";
    |CAMPO_MODIFICA #0#25, 1, "S";
    |CAMPO_MODIFICA #0#26, 1, "S";
    |CAMPO_MODIFICA #0#27, 1, "S";
    |CAMPO_MODIFICA #0#28, 1, "S";
    |CAMPO_MODIFICA #0#29, 1, "S";
    |CAMPO_MODIFICA #0#30, 1, "S";
    |CAMPO_MODIFICA #0#31, 1, "S";
    |CAMPO_MODIFICA #0#32, 1, "S";
    |CAMPO_MODIFICA #0#33, 1, "S";
    |CAMPO_MODIFICA #0#34, 1, "S";
    |CAMPO_MODIFICA #0#35, 1, "S";
    |CAMPO_MODIFICA #0#36, 1, "S";
    |CAMPO_MODIFICA #0#37, 1, "S";
    |CAMPO_MODIFICA #0#38, 1, "S";
    |CAMPO_MODIFICA #0#39, 1, "S";
    |CAMPO_MODIFICA #0#40, 1, "S";
    |CAMPO_MODIFICA #0#41, 1, "S";
    |CAMPO_MODIFICA #0#42, 1, "S";
    |CAMPO_MODIFICA #0#43, 1, "S";
    |CAMPO_MODIFICA #0#44, 1, "S";
    |CAMPO_MODIFICA #0#45, 1, "S";
    |CAMPO_MODIFICA #0#46, 1, "S";
    |CAMPO_MODIFICA #0#47, 1, "S";
    |CAMPO_MODIFICA #0#48, 1, "S";
    |CAMPO_MODIFICA #0#49, 1, "S";
    |CAMPO_MODIFICA #0#50, 1, "S";
    |CAMPO_MODIFICA #0#51, 1, "S";
    |CAMPO_MODIFICA #0#52, 1, "S";
    |CAMPO_MODIFICA #0#53, 1, "S";
    |CAMPO_MODIFICA #0#54, 1, "S";
    |CAMPO_MODIFICA #0#55, 1, "S";
    |CAMPO_MODIFICA #0#56, 1, "S";
    |CAMPO_MODIFICA #0#57, 1, "S";
    |CAMPO_MODIFICA #0#58, 1, "S";
    |CAMPO_MODIFICA #0#59, 1, "S";
    |CAMPO_MODIFICA #0#60, 1, "S";
    |CAMPO_MODIFICA #0#61, 1, "S";
    |CAMPO_MODIFICA #0#62, 1, "S";
|FINSI;
|FPRC;

|PROCESO salteada;
|ABRE #4;
|PARA salte_1 = 21; |SI salte_1 [ 41; |HACIENDO salte_1 = salte_1 + 1;
        salte_2 = salte_1 + 21;
    |PARA mes_i = #0#5; |SI mes_i [ #0#7; |HACIENDO mes_i = mes_i + 1;
            #4#0 = #0salte_1;     || empresa
            #4#1 = #0salte_2;     || trabajador
            #4#2 = mes_i;         || mes
            #4#3 = #0#10;             || tipo
            #4#66 = #0#4;         || a¤o
        |LEE 001#4=;
        |SI FSalida = 0;
            |HAZ proceso;
        |FINSI;
    |SIGUE;
|SIGUE;
|CIERRA #4;
|FPRC;

|PROCESO MiraTopeMes; |TIPO 0;
         nume1 = anyo $ 4;
     |SI nume1 = 0;
             bisiesto = 1;
     |SINO;
             bisiesto = 0;
     |FINSI;

     |SI #0#5 =  1;  p_mes = "ENERO     ";  topemes = 31;  |FINSI;
     |SI #0#5 =  2;  p_mes = "FEBRERO   ";  topemes = 28 + bisiesto;  |FINSI;
     |SI #0#5 =  3;  p_mes = "MARZO     ";  topemes = 31;  |FINSI;
     |SI #0#5 =  4;  p_mes = "ABRIL     ";  topemes = 30;  |FINSI;
     |SI #0#5 =  5;  p_mes = "MAYO      ";  topemes = 31;  |FINSI;
     |SI #0#5 =  6;  p_mes = "JUNIO     ";  topemes = 30;  |FINSI;
     |SI #0#5 =  7;  p_mes = "JULIO     ";  topemes = 31;  |FINSI;
     |SI #0#5 =  8;  p_mes = "AGOSTO    ";  topemes = 31;  |FINSI;
     |SI #0#5 =  9;  p_mes = "SEPTIEMBRE";  topemes = 30;  |FINSI;
     |SI #0#5 = 10;  p_mes = "OCTUBRE   ";  topemes = 31;  |FINSI;
     |SI #0#5 = 11;  p_mes = "NOVIEMBRE ";  topemes = 30;  |FINSI;
     |SI #0#5 = 12;  p_mes = "DICIEMBRE ";  topemes = 31;  |FINSI;
|FPRC;

|PROCESO FechaRecibi;
     |SI #0#4 < 80;
          anyo = #0#4 + 2000;
     |SINO;
          anyo = #0#4 + 1900;
     |FINSI;

     alfa1 = anyo;            || anyo
     |HAZ MiraTopeMes;
     alfa2 = topemes;         || dia

     alfa3 = #0#5;
     alfa3 = "00" + alfa3;
     alfa3 = alfa3 % -102;    || mes

     alfa1 = alfa2 + "." + alfa3 + "." + alfa1;      || fecha entera
     #0#6  = alfa1;
|FPRC;

|PROCESO defectoimp; |TIPO 7;
     #0#67 = #0#4;
     |PINTA #0#67;
|FPRC;
-------------------------------------------------------------------------------
                    ||   PROCESOS COMUNES

|PROCESO prepara_impresion;
     aDir = "/tmp/";
     Impresora = aDir + Usuario;
     |PINTA 2001, Usuario;
     |PINTA 2101, Impresora;
     |IMPRE -77;
     |PINTA 2201, FSalida;
     |SI FSalida ! 0;
          nErrorInf = 1;
     |FINSI;
     aAlfa1 = "chmod 777 " + Impresora;;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO traete_fichero;
     |FINIMP;
     cOrigen = aDir + Usuario;
     cDestino = aDirDes;
     |QBF cDestino;
     aArchivo = aArchivo - ".txt";
     cDestino = cDestino + aArchivo;
     |COPIA_FICHERO cOrigen, cDestino;
     |SI FSalida ! 0;
          nErrorInf = 0;
     |FINSI;
     aAlfa1 = "chmod 777 " + cDestino;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO ConviertePdf;
     |DBASS aBaseBin;  |QBF aBaseBin;
     aBaseBin = aBaseBin + "bin/topdf.sh ";

     aSystem = aBaseBin + cDestino;
     |SYSTEM aSystem;

     aSystem = "chmod 777 " + cDestino + ".pdf";
     |SYSTEM aSystem;

     |FBORRA cDestino;

     ||SI #0#6 = "S";  |HAZ AlaWeb;  |FINSI;
     ||SI #0#5 = "S";  |HAZ Correo;  |FINSI;

     ||FBORRA aPdf;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO LeeParam;
     |DBASS aRutaDes;
     |DBASS aRutaDatos;
     |QBF aRutaDes;
     |QBF aRutaDatos;
     aRutaDes = aRutaDes + "dsnetcom/def/dsnetm00.mas";
     |CARGA_DEF aRutaDes, dsnetm00@;
     |SI FSalida ! 0;
          |MENAV "    Error en CARGADEF: dsnetm00";
     |SINO;
          aRutaDatos = aRutaDatos + "dsnetcom/fich/";
          |PATH_DAT #150 aRutaDatos;
          |ABRE #150;
          |LEE 000#150p;
          |SI FSalida = 0;
               aDirDes = #150#7;
               aDirOri = aDirDes;
          |SINO;
               |MENAV "    Error de datos en fichero de configuracion dsnetm00";
          |FINSI;
          |CIERRA #150;
     |FINSI;
     |DESCARGA_DEF #dsnetm00@;
|FPRC;

|PROCESO LeeOrigen;

     aArchivo = PARAMETRO;
     |QBF aDirOri;
     aRuta = aDirOri + aArchivo;

     |XABRE "U", aRuta, nCanal;
     |SI FSalida ] 0;
          |XLEE nCanal, 100, aCabecera;
          |XLEE nCanal,   5, aTipoNomina;
          |XLEE nCanal,  10, aEmpresa;
          |XLEE nCanal,  10, aTrabajadorDesde;
          |XLEE nCanal,  10, aTrabajadorHasta;
          |XLEE nCanal,  10, aMesDesde;
          |XLEE nCanal,  10, aMesHasta;
          |XLEE nCanal,  10, aAnyo;
          |XLEE nCanal,   5, aOrdenacion;
          |XLEE nCanal,   5, aDireccion;
          |XLEE nCanal,   5, aTipoRecAtrasos;
     |FINSI;
     |XCIERRA nCanal;
     |QBF aCabecera;
     |QBF aTipoNomina;
     |QBF aEmpresa;
     |QBF aTrabajadorDesde;
     |QBF aTrabajadorHasta;
     |QBF aMesDesde;
     |QBF aMesHasta;
     |QBF aAnyo;
     |QBF aOrdenacion;
     |QBF aDireccion;
     |QBF aTipoRecAtrasos;
     nEmpresa = aEmpresa;
     nTrabajadorDesde = aTrabajadorDesde;
     nTrabajadorHasta = aTrabajadorHasta;
     nMesDesde = aMesDesde;
     nMesHasta = aMesHasta;
     nAnyo = aAnyo;
     nOrdenacion = aOrdenacion;
     nDireccion  = aDireccion;
     nTipoRecAtrasos  = aTipoRecAtrasos;
|FPRC;

|PROCESO PasaParametros;
     #0#0 = nEmpresa;
     #0#1 = nEmpresa;
     #0#2 = nTrabajadorDesde;
     #0#3 = nTrabajadorHasta;
     |SI nAnyo ] 2000;
          #0#4 = nAnyo - 2000;
     |SINO;
          #0#4 = nAnyo - 1900;
     |FINSI;
     #0#5 = nMesDesde;
     |HAZ FechaRecibi;
     #0#7 = nMesHasta;
     #0#8 = nTipoRecAtrasos;
     #0#9 = nDireccion;      || direccion a imprimir
     #0#10 = 5;          || tipo 5: atrasos
     #0#63 = nOrdenacion;
     #0#65 =  1;              || desde centro
     #0#66 = 99;              || hasta centro
     #0#67 = "EUROS  ";
|FPRC;

|PROGRAMA;
     |SI aParametro ! "";
          PARAMETRO = aParametro;
     |FINSI;
     aLongitud = PARAMETRO % 0;
     nLongitud = aLongitud;
     |SI nLongitud > 1;
          |HAZ LeeParam;
          |HAZ LeeOrigen;
          |HAZ PasaParametros;
          |HAZ prepara_impresion;
          swDesdeWeb = 1;
          |HAZ impre;
          |HAZ traete_fichero;
          |HAZ ConviertePdf;
     |SINO;
          |CLS;
          ||CABEZA "INFORME RESUMEN DE NOMINAS POR CENTROS";
          |PINPA #0#0;
          |PINDA #0#0;
          swDesdeWeb = 0;
          |HAZ control;
          |SI #nomcontr#37 = "S";
               |ATRI I;
               |PINTA 0641, "- IMPRESION PDF -";
               |ATRI 0;
          |FINSI;
          |ENDATOS #1#0;
     |FINSI;
|FPRO;

/****************************************************************************/
/*                 NECESARIO PARA COMPATIBILIDAD DE PROCEOSOS               */
/****************************************************************************/

|PROCESO conceptosFinMensu;

|FPRC;

|PROCESO conceptosFinHisto;

|FPRC;
