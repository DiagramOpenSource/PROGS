|FICHEROS;
     nomhuelg #0;

     nomtmp05 #10,MANTE;
     labtraba #2;
     labpadre;
     silcon06 #20;
     silcon13 #21;
     nomabsli;
     nomabsca;
     nomvarca;
     nomconca;
     nombotra;
     nomir003;
|FIN;

|VARIABLES;
   aAlfa  = "";
   aAlfa1  = "";
   aMarca = "";
   nCalc  = 0;
   nOpcion = 0;
   nNumTrab = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "RAC";
    Menu5 = " Revisar ";
    Menu6 = " Procesar trabajadores ";
    Menu7 = " Cancelar ";

     aFechaBaja = "";
     fFechaBaja = @;
     nFechaBaja = 0;

     aFechaLim = "";
     fFechaLim = @;
     nFechaLim = 0;
     swSigue = 0;
     red_ultimo = 0;
     aMovimiento = " ";
     &aFecha = "";
     nFecha = 0;
     fFecha = @;
     aFechaMov = "";
     fFechaHuelga = @;
     fFechaAlta = @;
     aFechaAlta = "";
     nMes = 0;
     nHorasMax = 0;
     nCoeficiente = 0;
     aValor = "";
     nBonif = 0;
     nAnyHuelga = 0;
     nMinus = 0;
|FIN;

|INCLUYE i_varglo;

|PROCESO AvisoParcial; |TIPO 7;
     |PUSHV 16071972;
     |ATRI R;
     |PINTA 1610, " ATENCION: se ha de introducir el porcentaje de la  jornada ";
     |PINTA 1710, " realmente trabajada,teniendo en cuenta la jornada habitual ";
     |PINTA 1810, " del trabajador en la empresa. Por ejemplo, para  un coefi- ";
     |PINTA 1910, " ciente 0,40 el campo debe rellenarse con 400               ";
     |ATRI 0;
|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO ActivaCampos;
     |SI #0#10 = "P";
     /*
          |CAMPO_VISUAL #0#5, 1, "N";
          |CAMPO_MODIFICA #0#5, 1, "N";
          |PINTA 1442, "                             ";

          #0#7 = "N";
          |CAMPO_VISUAL #0#7, 1, "N";
          |CAMPO_MODIFICA #0#7, 1, "N";
          |PINTA 1910, "                                                       ";

          |CAMPO_VISUAL #0#6, 1, "N";
          |CAMPO_MODIFICA #0#6, 1, "N";
          |PINTA 1610, "                                                         ";

          |CAMPO_VISUAL #0#9, 1, "N";
          |CAMPO_MODIFICA #0#9, 1, "N";
          |PINTA 1710, "                                                         ";
          |PINTA #0#9;
     */
          |CAMPO_VISUAL #0#11, 1, "S";
          |CAMPO_MODIFICA #0#11, 1, "S";
          |PINTA 1510, "Coeficiente huelga parcial .....................: 0,";
          |PINTA #0#11;

     |SINO;
/*
          |CAMPO_VISUAL #0#5, 1, "S";
          |CAMPO_MODIFICA #0#5, 1, "S";
          |PINTA 1442, "Fecha de fin ...:            ";
          |PINTA #0#5;

          |CAMPO_VISUAL #0#7, 1, "S";
          |CAMPO_MODIFICA #0#7, 1, "S";
          |PINTA 1910, "Crear incidencia de huelga en variaciones ......:      ";
          |PINTA #0#7;

          |CAMPO_VISUAL #0#6, 1, "S";
          |CAMPO_MODIFICA #0#6, 1, "S";
          |PINTA 1610, "Descontar de las pagas el d¡a de huelga ........:        ";
          |PINTA #0#6;

          |CAMPO_VISUAL #0#9, 1, "S";
          |CAMPO_MODIFICA #0#9, 1, "S";
          |PINTA 1710, "Parte decimal del d¡a de huelga ................:        ";
          |PINTA #0#9;
*/
          |CAMPO_VISUAL #0#11, 1, "N";
          |CAMPO_MODIFICA #0#11, 1, "N";
          |PINTA 1510, "                                                         ";
     |FINSI;
|FPRC;

|PROCESO Chequea;
     aAlfa = #0#4;
     |QBF aAlfa;
     |SI #0#8 = "S"; |Y aAlfa = "";
          |MENAV "    ATENCION. Es necesaria la fecha de alta para crear el movimiento AFI";
          #0#8 = "N";
          |PINTA #0#8;
          |ERROR;
     |FINSI;

     aAlfa = #0#5;
     |QBF aAlfa;
     |SI #0#12 = "S"; |Y aAlfa = "";
          |MENAV "    ATENCION. Es necesaria la fecha de baja para crear el movimiento AFI";
          #0#12 = "N";
          |PINTA #0#12;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Defectos;
     fFecha = ~;
     aFecha = fFecha;
     #0#4 = aFecha;
     #0#5 = aFecha;
|FPRC;

|PROCESO Fecha;
     aFecha = #0Campo;
     |HAZ CompFecha_plb;

     |SI Campo = 4;
          #0#5 = #0#4;
          |PINTA #0#5;
     |FINSI;

     aAlfa = #0#4; |QBF aAlfa;
     |SI aAlfa = "";
          #0#8 = "N";
     |SINO;
          #0#8 = "S";
     |FINSI;
     |PINTA #0#8;

     aAlfa = #0#5; |QBF aAlfa;
     |SI aAlfa = "";
          #0#12 = "N";
     |SINO;
          #0#12 = "S";
     |FINSI;
     |PINTA #0#12;
|FPRC;

|PROCESO Coeficiente;
     |CAMPO_MODIFICA #nomtmp05#8, 1, "S";
     |ENCAMPO #8#nomtmp05;
     |CAMPO_MODIFICA #nomtmp05#8, 1, "N";
     |GRABA 020#nomtmp05.a;
|FPRC;

|PROCESO ParteDecimal;
     |CAMPO_MODIFICA #nomtmp05#7, 1, "S";
     |ENCAMPO #7#nomtmp05;
     |CAMPO_MODIFICA #nomtmp05#7, 1, "N";
     |GRABA 020#nomtmp05.a;
|FPRC;

|PROCESO MarcaPaga;
     |SI #nomtmp05#4 = "S";
          #nomtmp05#4 = "N";
     |SINO;
          #nomtmp05#4 = "S";
     |FINSI;

     |PINTA #nomtmp05#4; |GRABA 020#nomtmp05.a;
     |ERROR;
     |PTEC 809;
|FPRC;

|PROCESO Marcalo; |TIPO 0;
     |SI #10Campo ! Contenido;     || se supone que he introducido un codigo
          #10#1 = 1;               || de empresa, para buscar
          |ACABA;                  || lo de #10#1 = 1 para que se vaya al primer trab.
     |FINSI;
     |SI #nomtmp05#5 = "**";
          #nomtmp05#5 = "  ";
     |SINO;
          #nomtmp05#5 = "**";
     |FINSI;

     |PINTA #nomtmp05#5; |GRABA 020#nomtmp05.a;
     |ERROR;
     |PTEC 809;
|FPRC;

|PROCESO MarcaDesmarca;
     #nomtmp05#5 = aMarca; |GRABA 020#nomtmp05.a;
|FPRC;

|DEFBUCLE MarcaDesmarca;
     #nomtmp05#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, MarcaDesmarca;
|FIN;

|PROCESO MiraMarca; |TIPO 11;
     |SI FSalida = 13; || Marca todo
          |SALVA_FICHA #nomtmp05;
          aMarca = "**"; |BUCLE MarcaDesmarca;
          |REPON_FICHA #nomtmp05;
          |PONCONTROL 23, "si";
     |FINSI;

     |SI FSalida = 14; || Desmarca todo
          |SALVA_FICHA #nomtmp05;
          aMarca = "  "; |BUCLE MarcaDesmarca;
          |REPON_FICHA #nomtmp05;
          |PONCONTROL 23, "si";
     |FINSI;

     |SI FSalida = 15; || Parte decimal
          |HAZ ParteDecimal;
     |FINSI;

     |SI FSalida = 16; || Descuento en pagas S/N
          |HAZ MarcaPaga;
     |FINSI;

     |SI FSalida = 17; || Coeficiente huelga parcial
          |HAZ Coeficiente;
     |FINSI;
|FPRC;

|PROCESO inf04;
     #nomtmp05#0 = 00001
     #nomtmp05#1 = 00001
|FPRC;

|PROCESO sup04;
     #nomtmp05#0 = 99999;
     #nomtmp05#1 = 99999;
|FPRC;

|PROCESO borralo1;
     |BORRA 020#21a;
     |LIBERA #21;
|FPRC;

|DEFBUCLE borralo;
     #21#2;
     14;
     #2#0, #2#1, 0;
     #2#0, #2#1, 0;
     be;
     NULL, borralo1;
|FIN;

|PROCESO BuscaDisca;
     nMinus = 0;

     |ABRE #nomir003;
     #nomir003#0 = #labtraba#7;         || nif
     #nomir003#40 = nAnyHuelga;              || ejercicio
     #nomir003#41 = #labtraba#0;        || empresa
     |LEE 000#nomir003.=;
     |SI FSalida = 0;
          |SI #nomir003#6 = "S";
               |SI #nomir003#7 = "1"; nMinus = 33; |FINSI;
               |SI #nomir003#7 = "2"; nMinus = 66; |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomir003;
|FPRC;

|PROCESO BuscaBonif;
     aValor = "";

     |ABRE #nombotra;
     #nombotra#0 = #labtraba#0;
     #nombotra#1 = #labtraba#1;
     #nombotra#2 = nBonif;
     |LEE 000#nombotra.=;
     |SI FSalida = 0;
          |SI #nombotra#4 [ fFechaHuelga; |Y fFechaHuelga [ #nombotra#5;
               aValor = "S";
          |FINSI;
     |FINSI;
     |CIERRA #nombotra;
|FPRC;

|PROCESO JornadaMaxima;
     nHorasMax = 40;
     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |SI #nomconca#162 ! 0;
               nHorasMax = #nomconca#162;
          |FINSI;
     |FINSI;
     |CIERRA #nomconca;
|FPRC;

|PROCESO BuscaJornada;
     nCoeficiente = 0;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |HAZ JornadaMaxima;
          nCoeficiente = #labtraba#234 / nHorasMax;
          nCoeficiente = (nCoeficiente * 1000) ! 0;
     |SINO;
          nCoeficiente = 0;
     |FINSI;
|FPRC;

|PROCESO movimiento;
     #labtraba#0 = #nomtmp05#0;
     #labtraba#1 = #nomtmp05#1;
     |LEE 000#labtraba.=;

     || esto es para borrar los no enviados del trabajador, solo la
     || primera pasada que si no me borra el primero
     |SI aMovimiento = "2";
          |BUCLE borralo;
     |FINSI;

     |LEE 000#21u;
     |SI FSalida ! 0;
          red_ultimo = 1;
     |SINO;
          red_ultimo = #21#0 + 1;
     |FINSI;

     |DDEFECTO #21;
     #21#0 = red_ultimo;
     |GRABA 020#21b;

     #21#1 = #nomtmp05#0;          || empresa
     #21#2 = #nomtmp05#1;          || trabajador
     #21#3 = "MCH";                || Comunicacion Huelga
                                        || la H la quito despues

     #21#5 = "";          || Fecha de inicio de Contrato
     #21#6 = " ";         || calif. per. horas
     #21#7 = 0;      || nro. horas contrato (A)
     #21#8 = 0;      || nro. horas empresa/convenio (B)

     |HAZ BuscaJornada;
     #21#12 = nCoeficiente;        || coeficiente TP

     #21#13 = aFechaMov;      || fecha INICIO O FIN HUELGA

     #21#14 = 0;         || nro. de lote
     #21#15 = 0;   || nro. minutos contrato (A)
     #21#16 = 0;   || nro. minutos empresa/convenio (B)
     #21#17 = "";
     #21#18 = "";
     #21#19 = "";
     #21#20 = "";                           || desempleado: no inscrito
     #21#21 = "";
     #21#22 = "";
     #21#23 = "";

     |HAZ BuscaDisca;
     #21#24 = nMinus;                        || grado minusvalia
     #21#25 = "";
     #21#30 = "";

     nBonif = 102;
     |HAZ BuscaBonif;
     #21#31 = aValor;

     #21#37 = aMovimiento;         || INICIO O FIN DE HUELGA

     #21#38 = "0";
     #21#40 = 0;     || A¤o Jornadas Reales
     #21#41 = 0;     || Mes Jornadas Reales
     #21#42 = " ";
     |SI #0#10 = "P";
          |SI aMovimiento = "3";
               #21#43 = #nomtmp05#8;
          |SINO;
               #21#43 = 0;
          |FINSI;
     |FINSI;
     #21#54 = 0;
     nBonif = 111;
     |HAZ BuscaBonif;
     #21#47 = aValor;

     |GRABA 020#21a;
     |LIBERA #21;

     nNumTrab = nNumTrab + 1;
|FPRC;

|PROCESO el_red;
          aFechaMov = #0#4;
          |SI aFechaMov ! ""; |Y #0#8 = "S";
               |SI #0#10 = "T";
                    aMovimiento = "2";  || movimiento de alta
               |FINSI;
               |SI #0#10 = "P";
                    aMovimiento = "3";  || movimiento de alta huelga PARCIAL
               |FINSI;
               |HAZ movimiento;
          |FINSI;

          aFechaMov = #0#5;
          |SI aFechaMov ! ""; |Y #0#12 = "S";
               aMovimiento = " ";            || movimeitno de fin de huelga
               fFecha = aFechaMov;
               nFecha = fFecha;
               nFecha = nFecha + 1;
               fFecha = nFecha;
               aFechaMov = fFecha;
               |HAZ movimiento;
          |FINSI;

          nNumTrab = nNumTrab - 1;      || si no lo cuento dos veces
|FPRC;

|DEFBUCLE el_red;
     #nomtmp05#1;
     5;
     00001, 00001, "**";
     99999, 99999, "**";
     ;
     NULL, el_red;
|FIN;

|PROCESO Lote;
     |ABRE #labtraba;
     |ABRE #21;

     nNumTrab = 0;
     |BUCLE el_red;

     |CIERRA #21;
     |CIERRA #labtraba;

     |SI nNumTrab > 0;
/*
          |SI #0#10 = "T"; |Y #0#7 = "S";
               aAlfa1 = nNumTrab;
               aAlfa = "    Se ha creado la incidencia de huelga en nómina para ";
               |SI nNumTrab = 1;
                    aAlfa = aAlfa + " el trabajador seleccionado."
               |SINO;
                    aAlfa = aAlfa + "los " + aAlfa1 + " trabajadores seleccionados."
               |FINSI;
               |MENAV aAlfa;

               aAlfa = "    Ya puede calcular las nóminas para que la incidencia ";
               aAlfa = aAlfa + "por huelga tome efecto.";
               |MENAV aAlfa;
          |FINSI;
*/
          |SI #0#8 = "S";
               aAlfa1 = nNumTrab;
               aAlfa = "    Se ha preparado la remesa de comunicación de huelga para ";
               |SI nNumTrab = 1;
                    aAlfa = aAlfa + " el trabajador seleccionado."
               |SINO;
                    aAlfa = aAlfa + "los " + aAlfa1 + " trabajadores seleccionados."
               |FINSI;
               |MENAV aAlfa;

               aAlfa = "    Puede crear el lote para el Sistema RED desde la opción ";
               aAlfa = aAlfa + "- Creación Lote AFI -";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaVar;
     nNumTrab = nNumTrab + 1;
     #labtraba#0 = #nomtmp05#0;
     #labtraba#1 = #nomtmp05#1;
     |LEE 000#labtraba.=;

     #nomabsca#0 = #nomtmp05#0;
     #nomabsca#1 = #nomtmp05#1;
     |LEE 101#nomabsca.=;
     |SI FSalida ! 0;
          #nomabsca#0 = #nomtmp05#0;
          #nomabsca#1 = #nomtmp05#1;
          #nomabsca#2 = 8;
          |SI #labtraba#47 ! 0;
               #nomabsca#2 = #labtraba#47;
          |FINSI;

          |GRABA 020#nomabsca.n;
          |LIBERA #nomabsca;
     |FINSI;

     #nomabsli#0 = #nomtmp05#0;
     #nomabsli#1 = #nomtmp05#1;
     fFecha = #0#4;
     #nomabsli#2 = fFecha;
     |LEE 101#nomabsli.=;
     |SI FSalida = 0;
          |BORRA 020#nomabsli.a;
     |FINSI;

     #nomabsli#0 = #nomtmp05#0;
     #nomabsli#1 = #nomtmp05#1;
     fFecha = #0#4;
     #nomabsli#2 = fFecha;

     || fecha de baja de incidencia de huelga
     aAlfa = #0#5;
     |QBF aAlfa;
     |SI aAlfa ! "";
          fFecha = aAlfa;
     |SINO;
          aAlfa = #0#4;
          aAlfa1 = (aAlfa % 402);
          nMes_gi = aAlfa1;
          aAlfa1 = (aAlfa % -104);
          nAny_gi = aAlfa1;
          |HAZ CargaVar_glo;
          fFecha = fFecFinMes_go;
     |FINSI;

     #nomabsli#3 = fFecha;
     #nomabsli#4 = "H";
     #nomabsli#5 = #nomtmp05#4;
     |SI #0#10 = "T";
          #nomabsli#6 = 0;
     |SINO;
          #nomabsli#6 = #nomabsca#2 * ((1000 - #nomtmp05#8) / 1000);
     |FINSI;
     #nomabsli#7 = #nomtmp05#7;

     |GRABA 020#nomabsli.n;
     |LIBERA #nomabsli;
|FPRC;

|DEFBUCLE CreaVar;
     #nomtmp05#1;
     5;
     00001, 00001, "**";
     99999, 99999, "**";
     ;
     NULL, CreaVar;
|FIN;

|PROCESO Variaciones;
     |ABRE #labtraba;
     |ABRE #nomabsca;
     |ABRE #nomabsli;

     nNumTrab = 0;
     |BUCLE CreaVar;

     |CIERRA #nomabsli;
     |CIERRA #nomabsca;
     |CIERRA #labtraba;

     |SI nNumTrab > 0;
          |SI #0#10 = "T"; |Y #0#7 = "S";
               aAlfa1 = nNumTrab;
               aAlfa = "    Se ha creado la incidencia de huelga en nómina para ";
               |SI nNumTrab = 1;
                    aAlfa = aAlfa + " el trabajador seleccionado."
               |SINO;
                    aAlfa = aAlfa + "los " + aAlfa1 + " trabajadores seleccionados."
               |FINSI;
               |MENAV aAlfa;

               aAlfa = "    Ya puede calcular las nóminas para que la incidencia ";
               aAlfa = aAlfa + "por huelga tome efecto.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Trabajadores;
     aFechaBaja = "";

     aAlfa = #0#4;
     aAlfa = aAlfa % 402;
     nMes = aAlfa;
     aAlfa = #0#4;
     aAlfa = aAlfa % -104;
     nAnyHuelga = aAlfa;

     aAlfa = #0#4;
     fFechaHuelga = aAlfa;

     aFechaAlta = #labtraba#36;
     |QBF aFechaAlta;
     fFechaAlta = aFechaAlta;

     #nomvarca#0 = #labtraba#0;
     #nomvarca#1 = #labtraba#1;
     #nomvarca#2 = nMes;
     #nomvarca#3 = 0;
     |LEE 000#nomvarca.=;
     |SI FSalida = 0;
          aFechaBaja = #nomvarca#16;
     |FINSI;
     |QBF aFechaBaja;

     |SI aFechaBaja = ""; |O aFechaBaja = "..........";
          aFechaBaja = #labtraba#37;
          |QBF aFechaBaja;
          fFechaBaja = aFechaBaja;
     |FINSI;

     |SI aFechaBaja ! ""; |Y aFechaBaja ! "..........";
          aFechaLim = aFechaBaja;
     |SINO;
          aFechaLim = "31.12.2099";
     |FINSI;

     fFechaLim = aFechaLim;

     swSigue = 1;
     |SI fFechaAlta [ fFechaHuelga; |Y fFechaHuelga [ fFechaLim;
          swSigue = 1;
     |SINO;
          swSigue = 0;
     |FINSI;

     |SI aFechaAlta = ""; |Y aFechaBaja = ""; |Y #labtraba#44 = "B";
          swSigue = 0;
     |FINSI;

     #20#0 = #labtraba#0;
     |LEE 000#20=;
     |SI FSalida ! 0;
          swSigue = 0;
     |FINSI;

     |SI swSigue = 1;
          |DDEFECTO #nomtmp05;
          #nomtmp05#0 = #labtraba#0;
          #nomtmp05#1 = #labtraba#1;
          #nomtmp05#2 = #labtraba#2;
          #nomtmp05#3 = #labtraba#45;
          #nomtmp05#4 = #0#6;
          #nomtmp05#5 = "**";
          #nomtmp05#6 = #labtraba#36;
          #nomtmp05#7 = #0#9;
          #nomtmp05#8 = #0#11;
          |GRABA 020#nomtmp05.n;
          nNumTrab = nNumTrab + 1;
     |FINSI;
|FPRC;

|DEFBUCLE Trabajadores;
     #labtraba#1;
     ;
     #nomhuelg#0, #nomhuelg#2;
     #nomhuelg#1, #nomhuelg#3;
     ;
     NULL, Trabajadores;
|FIN;


|PROGRAMA;
     |CLS;
     |CABEZA " ";

     |HAZ Defectos;
     |PINPA #0#0; |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = "05" + Usuario; |NOME_DAT #nomtmp05#aAlfa#;
          |DELINDEX #nomtmp05;
          |ABRE #nomvarca;
          |ABRE #nomtmp05;
          nNumTrab = 0;
          |ABRE #20;

          |CLS;
          |PINTA 1308, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿";
          |PINTA 1408, "³       Buscando trabajadores. Espere unos segundos ...        ³";
          |PINTA 1508, "³                                                              ³";
          |PINTA 1608, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";

          |BUCLE Trabajadores;
          |ET OtraVez;
          |ENTLINEAL #1#nomtmp05, -1, 4, 21, 1, inf04, sup04;
          |SI nNumTrab = 0;
               |CIERRA #nomvarca;
               |CIERRA #20;
               |CIERRA #nomtmp05;
               |DELINDEX #nomtmp05;
               |ACABA;
          |FINSI;

          |ET OtroMenu;
          |MENU Menu;
          nOpcion = FSalida;
          |SI nOpcion = 1; |VETE OtraVez;   |FINSI;
          |SI nOpcion = 2;
          nNumTrab = 0;
          |SI #0#7 = "S";
               |HAZ Variaciones;
          |FINSI;
          |SI #0#8 = "S";
               |HAZ Lote;
          |FINSI;
      |FINSI;
      |SI nOpcion = 3;
         aAlfa = "    N" + &191 + " Está seguro de salir sin aplicar los cambios ?";
         |CONFI aAlfa;
         |SI FSalida ! 0; |VETE OtraVez; |FINSI;
      |FINSI;
      |SI nOpcion < 1; |VETE OtroMenu; |FINSI;
      |CIERRA #nomvarca;
      |CIERRA #nomtmp05;   |DELINDEX #nomtmp05;
      |CIERRA #20;
     |FINSI;
|FPRO;
