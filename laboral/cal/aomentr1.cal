          PROCESO COMUN PARA 'aomentra' , 'aomentr2' y 'aopartes'
                             'aomagico' y aomentr3 ahora tambien
                             'aojentr5' y este tambien

|FICHEROS;
     gopartca@ #1;
     gopartll@ #2;
     gopartli@ #3;
     goptrbca@ #4;
     goptrbli@ #5;
     gopartia@ #6;
     gomantho@ #7;
     gomantl1@ #8;
     gopre001@ #9;
     gotrabaj@ #10;
     gocatcot@ #11;
     gocatcon@ #12;
     agifa019@ #19;
     gosubaux@ #20;
     agifa027@ #27;
     aomparam #100;
     aomcalec #101;
|FIN;

|VARIABLES;
     &eaEsMJ = "";       || Modulo 003774
     nHay = 0;
     &enSwCerti = 0;
     &eaCerti = "";
     aCerti = "";
     nError = 0;
     &enForma = 0;
     &efFecha = @;
     &enUni = 0;
     &enHora = 0;
     &enObra = 0;
     &eaObra = "";
     &enSubobra = 0;
     &enTraba = 0;
     &eaSerPre = "";
     &enNumPre = 0;
     &eaNivel = "";
     &eaCapitulo = "";
     &eaPartida = "";
     &eaDesParti = "";
     &enPrecioHora = 0;
     &enPrecioVenta = 0;
     &enSubcontrata = 0;
     &enPrecioAux = 0;
     &enImpoSS = 0;

     aTipoPres = "";
     nUni = 0;
     nTotCos = 0;
     nTotVen = 0;
     nHA = 0;
     nHE = 0;
     nHP = 0;
     nErr = 0;
     aAlfa = "";
     aPath = "";
     aFic = "";
     aEmp = "";
     aDef = "";
     aSerExp = "";
     nNumExp = 0;
     aSerPre = "";
     nNumPre = 0;
     &nLin = 0;
     aSerPar = "";
     nNumPar = 0;
     nPreV = 0;
     nPreC = 0;

     &enEmpresa = 0;
     aModulo = "";
     nTotHor = 0;
     aDiaLaboral = "";
     aA¤o = "";
     aDesde = "";
     aHasta = "";
     fFecha = @;
     nCampo = 0;
     i = 0;
     nNume = 0;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO EstaCerti;
     aCerti = "N";
     |SI aModulo = "aojentr5";
          #20#0 = #6#34;
          #20#1 = #6#4;
          #20#2 = #6#5;
          #20#3 = #6#6;
          #20#4 = #6#7;
          |LEE 000#20=;
          |SI FSalida = 0;
               aCerti = #20#6;
          |FINSI;
     |FINSI;
     |SI aCerti = "S";
          aAlfa = "0000Tabajador:" + #5#4 + " certificado, no actualiza gestión";
          ||MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO EsLaboral;
     aDiaLaboral = "S";

     aA¤o = #6#28 % -104;

     |ABRE #101;
     #101#0 = 1;
     #101#1 = aA¤o;
     |LEE 000#101=;
     |CIERRA #101;

     fFecha = #6#28 % A1;
     aAlfa = fFecha % 1102;
     |SI aAlfa = "Lu"; nCampo = 2; |FINSI;
     |SI aAlfa = "Ma"; nCampo = 3; |FINSI;
     |SI aAlfa = "Mi"; nCampo = 4; |FINSI;
     |SI aAlfa = "Ju"; nCampo = 5; |FINSI;
     |SI aAlfa = "Vi"; nCampo = 6; |FINSI;
     |SI aAlfa = "Sa"; nCampo = 7; |FINSI;
     |SI aAlfa = "Do"; nCampo = 8; |FINSI;
     |SI #101nCampo = 0; aDiaLaboral = "N"; |FINSI;
     aAlfa = (fFecha % 102) + (fFecha % 402);
     |PARA i = 9; |SI i [ 96; |HACIENDO i = i + 3;
          |SI #101i ! "    ";
               aDesde = #101i;
               nCampo = i + 1;
               aHasta = #101nCampo;
               nCampo = i + 2;
               |SI aAlfa ] aDesde; |Y aAlfa [ aHasta;
                    |SI #101nCampo = 0; aDiaLaboral = "N"; |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaAux;
     |SI aModulo ! "aojentr5"; |ACABA; |FINSI;

     |HAZ EsLaboral;

     |DDEFECTO #20;
     #20#0 = #6#34;
     #20#1 = #6#4;
     #20#2 = #6#5;
     #20#3 = #6#6;
     #20#4 = #6#7;
     |LEE 101#20=;
     |SI FSalida ! 0; |GRABA 020#20b; |FINSI;
     #20#5 = enSubcontrata;
     #20#6 = "N";
     #20#7 = #6#28;
     #20#8 = enPrecioAux;
     |SI aDiaLaboral = "S"; |Y enHora = 0;
          #20#9 = enImpoSS;
     |FINSI;
     #20#13 = enHora;
     #20#17 = enTraba;
     |GRABA 020#20a;
     |LIBERA #20;
|FPRC;

|PROCESO BorraAux;
     |SI aModulo ! "aojentr5"; |ACABA; |FINSI;

     #20#0 = #6#34;
     #20#1 = #6#4;
     #20#2 = #6#5;
     #20#3 = #6#6;
     #20#4 = #6#7;
     |BORRA 000#20c;
|FPRC;

|PROCESO BorraGes;
     |HAZ EstaCerti;
     |SI aCerti = "S"; |ACABA; |FINSI;

     |SELECT #1#6;
     |LEE 121#6=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nNume = #6#10;|| + nUni;
     |SI nNume = 0;
          |BORRA 020#6a;      ||**
     |FINSI;
     |HAZ BorraAux;

     nLin = #6#6;
     #6#7 = 1;
     |LEE 000#6];
     |SI FSalida = 0; |Y #6#34 = "T"; |Y #6#4 = aSerPar; |Y #6#5 = nNumPar;
               |Y #6#6 = nLin;
          |ACABA;
     |FINSI;
     |BORRA 020#5a;

     |SELECT #1#5;
     #5#3 = 1;
     |LEE 000#5];
     |SI FSalida = 0; |Y #5#20 = aSerPre; |Y #5#21 = nNumPre; |Y #5#2 = efFecha;
          |ACABA;
     |FINSI;
     |BORRA 020#4a;
     |BORRA 020#3a;

     |SELECT #1#3;
     #3#2 = 1;
     |LEE 000#3];
     |SI FSalida = 0; |Y #3#0 = aSerPre; |Y #3#1 = nNumPre;
          |ACABA;
     |FINSI;
     |BORRA 020#2a;

     |SELECT #1#2;
     #2#2 = 1;
     |LEE 000#2];
     |SI #2#0 = aSerExp; |Y #2#1 = nNumExp;
          |ACABA;
     |FINSI;
     |BORRA 020#1a;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO CalcuGopartia;
     #6#10 = #6#10 + nUni;

     #6#45 = #6#37;
     #6#46 = #6#38;
     #6#47 = #6#39;
     #6#48 = #6#40;

     #6#49 = #6#41;
     #6#50 = #6#42;
     #6#51 = #6#43;
     #6#52 = #6#44;

     #6#13 = #6#10 * #6#37;
     #6#13 = #6#13 < #6#38;
     #6#13 = #6#13 < #6#39;
     #6#13 = #6#13 < #6#40;
     #6#11 = #6#13 / #6#10;

     #6#14 = #6#10 * #6#41;
     #6#14 = #6#14 < #6#42;
     #6#14 = #6#14 < #6#43;
     #6#14 = #6#14 < #6#44;
     #6#12 = #6#14 / #6#10;

     #6#24 = #6#10 * #6#45;
     #6#24 = #6#24 < #6#46;
     #6#24 = #6#24 < #6#47;
     #6#24 = #6#24 < #6#48;
     #6#22 = #6#24 / #6#10;

     #6#25 = #6#10 * #6#49;
     #6#25 = #6#25 < #6#50;
     #6#25 = #6#25 < #6#51;
     #6#25 = #6#25 < #6#52;
     #6#23 = #6#25 / #6#10;
|FPRC;

|PROCESO Graba6MJ2; ||Caso es pecial para Marcos Jimenez
                    ||es igual, solo cambia que
                    ||graba un 2 en la linea del gopartia
     aCerti = "N";
     nUni = enUni * enForma;

     |DDEFECTO #6;
     |SELECT #2#6;
     #6#34 = "T";
     #6#4 = aSerPar;
     #6#5 = nNumPar;
     #6#6 = #5#3;
/*
MJ no tiene ni capitulo ni partida

     |SI eaNivel = "P"; |O eaNivel = "C";
          #6#33 = eaCapitulo;
     |FINSI;
     |SI eaNivel = "P";
          #6#8 = eaPartida;
     |FINSI;
*/
     nHay = 0;
     |LEE 000#6];
     |PARA; |SI FSalida = 0; |Y #6#34 = "T"; |Y #6#4 = aSerPar;
               |Y #6#5 = nNumPar; |Y #6#6 = #5#3; |HACIENDO;
          |SI #6#7 = 2;
               nHay = 1;
               |SAL;
          |FINSI;
          |LEE 000#6s;
     |SIGUE;

     |SI nHay = 1;
          |SELECT #1#6;
          |LEE 121#6=;
     |SINO;
          FSalida = 1;
     |FINSI;
     |SI FSalida = 0;
          |HAZ EstaCerti;
          |SI aCerti = "N"; |Y enSwCerti = 0;
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |SINO;
          |SI enForma = 1;
               |SELECT #1#6;
/*
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = 999;

               |LEE 000#6];
               |SI FSalida = 0;
                    |LEE 000#6a;
               |SINO;
                    |LEE 000#6a;
               |FINSI;
               |SI FSalida = 0; |Y #6#4 = aSerPar; |Y #6#5 = nNumPar; |Y #6#6 = #5#3;
                    nLin = #6#7 + 1;
               |SINO;
                    nLin = 1;
               |FINSI;
*/
               nLin = 2;      || 2 a pi¤on

               |DDEFECTO #6;
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = nLin;
               |GRABA 020#6b;

               #6#0 = aSerPre;
               #6#1 = nNumPre;
               #6#2 = aSerExp;
               #6#3 = nNumExp;

               #6#15 = #7#2;
               #6#16 = #7#8;
               #6#20 = #12#13; ||Articulo
               #6#21 = #7#6;
               #6#28 = #3#3;

               |DDEFECTO #19;
               #19#0 = #6#20;
               |LEE 000#19=;
               #6#30 = #19#1;

               #6#36 = #6#10;

               nPreV = 0; nPreC = 0;
               |SI #9#18 = "P";
                    nPreV = #11#4;                 ||PVP.
                    nPreC = #11#5;                 ||PVC.
               |FINSI;
               |SI #9#18 = "A";
                    nPreV = #11#6;                 ||PVP.
                    nPreC = #11#7;                 ||PVC.
               |FINSI;
               |SI #9#18 = "E";
                    nPreV = #11#8;                 ||PVP.
                    nPreC = #11#9;                 ||PVC.
               |FINSI;

               |SI enPrecioHora ! 0;
                    nPreC = enPrecioHora;
               |FINSI;
               |SI enPrecioVenta ! 0;
                    nPreV = enPrecioVenta;
               |FINSI;

               #6#37 = nPreV;
               #6#38 = 0;
               #6#39 = 0;
               #6#40 = 0;
               #6#41 = nPreC;
               #6#42 = 0;
               #6#43 = 0;
               #6#44 = 0;
               |SI eaNivel = "P";
                    #6#8 = eaPartida;
                    #6#9 = eaDesParti;
               |FINSI;
               |SI eaNivel = "P"; |O eaNivel = "C";
                    #6#33 = eaCapitulo;
               |FINSI;
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |FINSI;

/*
     |SI enPrecioHora = 0;
          nTotCos = nPreC * nUni;
     |SINO;
          nTotCos = enPrecioHora * nUni;
     |FINSI;

     |SI enPrecioVenta = 0;
          nTotVen = nPreV * nUni;
     |SINO;
          nTotVen = enPrecioVenta * nUni;
     |FINSI;
*/
     nTotCos = nPreC * nUni;
     nTotVen = nPreV * nUni;
|FPRC;

|PROCESO Graba6MJ1; ||Caso es pecial para Marcos Jimenez
                    ||es igual, solo cambia que
                    ||graba un 1 en la linea del gopartia
     aCerti = "N";
     nUni = enUni * enForma;

     |DDEFECTO #6;
     |SELECT #2#6;
     #6#34 = "T";
     #6#4 = aSerPar;
     #6#5 = nNumPar;
     #6#6 = #5#3;
/*
MJ no tiene ni capitulo ni partida

     |SI eaNivel = "P"; |O eaNivel = "C";
          #6#33 = eaCapitulo;
     |FINSI;
     |SI eaNivel = "P";
          #6#8 = eaPartida;
     |FINSI;
*/
     nHay = 0;
     |LEE 000#6];
     |PARA; |SI FSalida = 0; |Y #6#34 = "T"; |Y #6#4 = aSerPar;
               |Y #6#5 = nNumPar; |Y #6#6 = #5#3; |HACIENDO;
          |SI #6#7 = 1;
               nHay = 1;
               |SAL;
          |FINSI;
          |LEE 000#6s;
     |SIGUE;

     |SI nHay = 1;
          |SELECT #1#6;
          |LEE 121#6=;
     |SINO;
          FSalida = 1;
     |FINSI;
     |SI FSalida = 0;
          |HAZ EstaCerti;
          |SI aCerti = "N"; |Y enSwCerti = 0;
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |SINO;
          |SI enForma = 1;
               |SELECT #1#6;
/*
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = 999;

               |LEE 000#6];
               |SI FSalida = 0;
                    |LEE 000#6a;
               |SINO;
                    |LEE 000#6a;
               |FINSI;
               |SI FSalida = 0; |Y #6#4 = aSerPar; |Y #6#5 = nNumPar; |Y #6#6 = #5#3;
                    nLin = #6#7 + 1;
               |SINO;
                    nLin = 1;
               |FINSI;
*/
               nLin = 1;      || 1 a pi¤on

               |DDEFECTO #6;
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = nLin;
               |GRABA 020#6b;

               #6#0 = aSerPre;
               #6#1 = nNumPre;
               #6#2 = aSerExp;
               #6#3 = nNumExp;

               #6#15 = #7#2;
               #6#16 = #7#8;
               #6#20 = #12#13; ||Articulo
               #6#21 = #7#6;
               #6#28 = #3#3;

               |DDEFECTO #19;
               #19#0 = #6#20;
               |LEE 000#19=;
               #6#30 = #19#1;

               #6#36 = #6#10;

               nPreV = 0; nPreC = 0;
               |SI #9#18 = "P";
                    nPreV = #11#4;                 ||PVP.
                    nPreC = #11#5;                 ||PVC.
               |FINSI;
               |SI #9#18 = "A";
                    nPreV = #11#6;                 ||PVP.
                    nPreC = #11#7;                 ||PVC.
               |FINSI;
               |SI #9#18 = "E";
                    nPreV = #11#8;                 ||PVP.
                    nPreC = #11#9;                 ||PVC.
               |FINSI;

               |SI enPrecioHora ! 0;
                    nPreC = enPrecioHora;
               |FINSI;
               |SI enPrecioVenta ! 0;
                    nPreV = enPrecioVenta;
               |FINSI;

               #6#37 = nPreV;
               #6#38 = 0;
               #6#39 = 0;
               #6#40 = 0;
               #6#41 = nPreC;
               #6#42 = 0;
               #6#43 = 0;
               #6#44 = 0;
               |SI eaNivel = "P";
                    #6#8 = eaPartida;
                    #6#9 = eaDesParti;
               |FINSI;
               |SI eaNivel = "P"; |O eaNivel = "C";
                    #6#33 = eaCapitulo;
               |FINSI;
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |FINSI;

/*
     |SI enPrecioHora = 0;
          nTotCos = nPreC * nUni;
     |SINO;
          nTotCos = enPrecioHora * nUni;
     |FINSI;

     |SI enPrecioVenta = 0;
          nTotVen = nPreV * nUni;
     |SINO;
          nTotVen = enPrecioVenta * nUni;
     |FINSI;
*/
     nTotCos = nPreC * nUni;
     nTotVen = nPreV * nUni;
|FPRC;

|PROCESO Graba6;
     |SI eaEsMJ = "S";       || Modulo 003774
          |SI aModulo = "aojentr3"; |HAZ Graba6MJ1; |ACABA; |FINSI;
          |SI aModulo = "aojentr5"; |HAZ Graba6MJ2; |ACABA; |FINSI;
     |FINSI;

     aCerti = "N";
     nUni = enUni * enForma;

     |DDEFECTO #6;

     |SELECT #2#6;
     #6#34 = "T";
     #6#4 = aSerPar;
     #6#5 = nNumPar;
     #6#6 = #5#3;
     |SI eaNivel = "P"; |O eaNivel = "C";
          #6#33 = eaCapitulo;
     |FINSI;
     |SI eaNivel = "P";
          #6#8 = eaPartida;
     |FINSI;
     |LEE 101#6=;
     |SI FSalida = 0;
          |HAZ EstaCerti;
          |SI aCerti = "N";
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |SINO;
          |SI enForma = 1;
               |SELECT #1#6;
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = 999;

               |LEE 000#6];
               |SI FSalida = 0;
                    |LEE 000#6a;
               |SINO;
                    |LEE 000#6a;
               |FINSI;
               |SI FSalida = 0; |Y #6#4 = aSerPar; |Y #6#5 = nNumPar; |Y #6#6 = #5#3;
                    nLin = #6#7 + 1;
               |SINO;
                    nLin = 1;
               |FINSI;

               |DDEFECTO #6;
               #6#34 = "T";
               #6#4 = aSerPar;
               #6#5 = nNumPar;
               #6#6 = #5#3;
               #6#7 = nLin;
               |GRABA 020#6b;

               #6#0 = aSerPre;
               #6#1 = nNumPre;
               #6#2 = aSerExp;
               #6#3 = nNumExp;

               #6#15 = #7#2;
               #6#16 = #7#8;
               #6#20 = #12#13; ||Articulo
               #6#21 = #7#6;
               #6#28 = #3#3;

               |DDEFECTO #19;
               #19#0 = #6#20;
               |LEE 000#19=;
               #6#30 = #19#1;

               #6#36 = #6#10;

               nPreV = 0; nPreC = 0;
               |SI #9#18 = "P";
                    nPreV = #11#4;                 ||PVP.
                    nPreC = #11#5;                 ||PVC.
               |FINSI;
               |SI #9#18 = "A";
                    nPreV = #11#6;                 ||PVP.
                    nPreC = #11#7;                 ||PVC.
               |FINSI;
               |SI #9#18 = "E";
                    nPreV = #11#8;                 ||PVP.
                    nPreC = #11#9;                 ||PVC.
               |FINSI;

               |SI enPrecioHora ! 0;
                    nPreC = enPrecioHora;
               |FINSI;
               |SI enPrecioVenta ! 0;
                    nPreV = enPrecioVenta;
               |FINSI;

               #6#37 = nPreV;
               #6#38 = 0;
               #6#39 = 0;
               #6#40 = 0;
               #6#41 = nPreC;
               #6#42 = 0;
               #6#43 = 0;
               #6#44 = 0;
               |SI eaNivel = "P";
                    #6#8 = eaPartida;
                    #6#9 = eaDesParti;
               |FINSI;
               |SI eaNivel = "P"; |O eaNivel = "C";
                    #6#33 = eaCapitulo;
               |FINSI;
               |HAZ CalcuGopartia;
               |HAZ GrabaAux;
               |GRABA 020#6a;
               |LIBERA #6;
          |FINSI;
     |FINSI;

/*
     |SI enPrecioHora = 0;
          nTotCos = nPreC * nUni;
     |SINO;
          nTotCos = enPrecioHora * nUni;
     |FINSI;

     |SI enPrecioVenta = 0;
          nTotVen = nPreV * nUni;
     |SINO;
          nTotVen = enPrecioVenta * nUni;
     |FINSI;
*/
     nTotCos = nPreC * nUni;
     nTotVen = nPreV * nUni;
|FPRC;

|PROCESO Graba5;
     |SELECT #5#5;
     #5#20 = aSerPre;
     #5#21 = nNumPre;
     #5#2 = efFecha;
     #5#4 = #10#0;
     #5#26 = enHora;
     |LEE 000#5=;
     |SI FSalida ! 0; |Y enForma = 1;
          |SELECT #1#5;
          #5#20 = aSerPre;
          #5#21 = nNumPre;
          #5#2 = efFecha;
          #5#3 = 9999;
          |LEE 000#5];
          |SI FSalida = 0;
               |LEE 000#5a;
          |SINO;
               |LEE 000#5u;
          |FINSI;
          |SI FSalida = 0; |Y #5#20 = aSerPre; |Y #5#21 = nNumPre; |Y #5#2 = efFecha;
               nLin = #5#3 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |DDEFECTO #5;
          #5#20 = aSerPre;
          #5#21 = nNumPre;
          #5#2 = efFecha;
          #5#3 = nLin;
          #5#4 = #10#0;
          #5#5 = #10#1;
          #5#6 = #10#3;
          #5#7 = #10#25;
          #5#22 = #12#13;
          #5#23 = aSerPar;
          #5#24 = nNumPar;
          #5#26 = enHora;
          #5#27 = #11#3;
          #5#0 = aSerExp;
          #5#1 = nNumExp;
          |GRABA 020#5b;
     |FINSI;
     nError = FSalida;
|FPRC;

|PROCESO Graba4;
     |DDEFECTO #4;
     #4#0 = aSerExp;
     #4#1 = nNumExp;
     #4#2 = efFecha;
     #4#16 = aSerPre;
     #4#17 = nNumPre;
     |LEE 101#4=;
     |SI FSalida ! 0; |Y enForma = 1;
          |GRABA 020#4b;
     |FINSI;
     nError = FSalida;
     #4#3 = nNumPar;
     #4#7 = #7#2;
     #4#8 = #7#8;
     #4#14 = #7#6;
     #4#15 = aSerPar;
     #4#20 = #3#16;
|FPRC;

|PROCESO ContaParte;
     #27#0 = "partetrab";
     #27#2 = aSerExp;
     |LEE 101#27=;
     |SI FSalida = 0;
          #27#1 = #27#1 + 1;
          |GRABA 020#27a;
          |LIBERA #27;
     |SINO;
          #27#1 = 1;
          |GRABA 020#27n;
     |FINSI;
     aSerPar = #27#2;
     nNumPar = #27#1;
|FPRC;

|PROCESO Graba3;
     |SELECT #2#3;
     #3#0 = aSerPre;
     #3#1 = nNumPre;
     #3#3 = efFecha;
     |LEE 000#3=;
     |SI FSalida ! 0; |Y enForma = 1;
          |SELECT #1#3;
          #3#0 = aSerPre;
          #3#1 = nNumPre;
          #3#2 = 9999;
          |LEE 000#3];
          |SI FSalida = 0;
               |LEE 000#3a;
          |SINO;
               |LEE 000#3u;
          |FINSI;
          |SI FSalida = 0; |Y #3#0 = aSerPre; |Y #3#1 = nNumPre;
               nLin = #3#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |HAZ ContaParte;
          |DDEFECTO #3;
          #3#0 = aSerPre;
          #3#1 = nNumPre;
          #3#2 = nLin;
          #3#3 = efFecha;
          #3#4 = aSerPar;
          #3#5 = nNumPar;
          #3#14 = aSerExp;
          #3#15 = nNumExp;
          #3#16 = #9#18;
          |GRABA 020#3b;
     |SINO;
          aSerPar = #3#4;
          nNumPar = #3#5;
     |FINSI;
     nError = FSalida;
|FPRC;

|PROCESO Graba2;
     |SELECT #2#2;
     #2#0 = aSerExp;
     #2#1 = nNumExp;
     #2#4 = aSerPre;
     #2#5 = nNumPre;
     |LEE 000#2=;
     |SI FSalida ! 0; |Y enForma = 1;
          |SELECT #1#2;
          #2#0 = aSerExp;
          #2#1 = nNumExp;
          #2#2 = 9999;
          |LEE 000#2];
          |SI FSalida = 0;
               |LEE 000#2a;
          |SINO;
               |LEE 000#2u;
          |FINSI;
          |SI FSalida = 0; |Y #2#0 = aSerExp; |Y #2#1 = nNumExp;
               nLin = #2#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;

          |DDEFECTO #2;
          #2#0 = aSerExp;
          #2#1 = nNumExp;
          #2#2 = nLin;
          #2#3 = #9#4;
          #2#4 = aSerPre;
          #2#5 = nNumPre;
          #2#14 = aTipoPres;
          |GRABA 020#2b;
     |FINSI;
     nError = FSalida;
|FPRC;

|PROCESO Graba1;
     |DDEFECTO #1;
     #1#0 = aSerExp;
     #1#1 = nNumExp;
     |LEE 101#1=;
     |SI FSalida ! 0; |Y enForma = 1;
          #1#10 = #7#2;
          #1#11 = #7#6;
          #1#12 = #7#8;
          |GRABA 020#1b;
     |FINSI;
     nError = FSalida;
|FPRC;

|PROCESO BuscaPres;
     aSerPre = "";
     nNumPre = 0;
     aTipoPres = "";
     #8#0 = #7#0;
     #8#1 = #7#1;
     #8#2 = 1;
     |LEE 000#8];
     |SI FSalida = 0; |Y #8#0 = #7#0; |Y #8#1 = #7#1;
          aSerPre = #8#3;
          nNumPre = #8#4;
     |FINSI;

     |SI eaNivel = "C"; |O eaNivel = "P";
          aSerPre = eaSerPre;
          nNumPre = enNumPre;
     |FINSI;

     |DDEFECTO #9;
     #9#0 = aSerPre;
     #9#1 = nNumPre;
     |LEE 000#9=;
     aTipoPres = #9#18;
|FPRC;

|PROCESO GrabaGes;
     aAlfa = aModulo % 301;
     |SI aAlfa = "j";       || estoy llamando desde el modulo 003774
          aSerExp = eaObra;
     |SINO;                   || lo de siempre
          aSerExp = ("00000" + enObra) % -105;
     |FINSI;
     nNumExp = enSubobra;

     |DDEFECTO #10;
     #10#0 = enTraba;
     |LEE 000#10=;

     |DDEFECTO #11;
     #11#0 = #10#3;
     #11#1 = #10#2;
     #11#2 = enHora;
     |LEE 000#11=;

     |DDEFECTO #12;
     #12#0 = #10#3;
     #12#1 = #10#2;
     |LEE 000#12=;

     |DDEFECTO #7;
     #7#0 = aSerExp;
     #7#1 = nNumExp;
     |LEE 000#7=;

     |HAZ Graba1;
     |SI nError ! 0; |ACABA; |FINSI;
     |HAZ BuscaPres;
     |SI FSalida ! 0;
          aAlfa = "0000No existe Presupuesto. Expediente:" + aSerExp + "/"+ nNumExp;
          |MENAV aAlfa;
     |SINO;
          |HAZ Graba2;
          |SI nError ! 0; |ACABA; |FINSI;
          |HAZ Graba3;
          |SI nError ! 0; |ACABA; |FINSI;
          |HAZ Graba4;
          |SI nError ! 0; |ACABA; |FINSI;
          |HAZ Graba5;
          |SI nError ! 0; |ACABA; |FINSI;
          |HAZ Graba6;
          |SI nError ! 0; |ACABA; |FINSI;

          eaCerti = aCerti;
          |SI aCerti = "S"; |ACABA; |FINSI;
          |SI enSwCerti = 1; |ACABA; |FINSI;

          nHP = 0; nHA = 0; nHE = 0;
          |SI #9#18 = "P"; nHP = nUni; |FINSI;
          |SI #9#18 = "A"; nHA = nUni; |FINSI;
          |SI #9#18 = "E"; nHE = nUni; |FINSI;
          #5#8 = #5#8 + nHP;
          #5#9 = #5#9 + nHA;
          #5#10 = #5#10 + nHE;
          #5#11 = #5#8 + #5#9 + #5#10;
          || #5#12 = nPreV;
          || #5#13 = nPreC;

          |SI enPrecioVenta = 0;
               #5#12 = nPreV;
          |SINO;
               #5#12 = enPrecioVenta;
          |FINSI;
          |SI enPrecioHora = 0;
               #5#13 = nPreC;
          |SINO;
               #5#13 = enPrecioHora;
          |FINSI;

          ||para estos se asigna siempre este aunque sea 0
          |SI aModulo = "aojentr3"; |O aModulo = "aojentr5";
               #5#12 = enPrecioVenta;
               #5#13 = enPrecioHora;
          |FINSI;

          #5#16 = #5#11 * #5#12;
          #5#17 = #5#11 * #5#13;

          #4#4 = #4#4 + nHP;
          #4#5 = #4#5 + nHA;
          #4#6 = #4#6 + nHE;
          #4#9 = #4#4 + #4#5 + #4#6;
          #4#10 = #4#10 + nTotCos;
          #4#11 = #4#11 + nTotVen;
          #4#12 = #4#12 + nTotCos;
          #4#13 = #4#13 + nTotVen;

          #3#6 = #3#6 + nHP;
          #3#7 = #3#7 + nHA;
          #3#8 = #3#8 + nHE;
          #3#9 = #3#9 + nTotCos;
          #3#10 = #3#10 + nTotVen;
          #3#11 = #3#9;
          #3#12 = #3#10;
          #3#13 = #3#6 + #3#7 + #3#8;

          #2#6 = #2#6 + nHP;
          #2#7 = #2#7 + nHA;
          #2#8 = #2#8 + nHE;
          #2#9 = #2#9 + nTotCos;
          #2#10 = #2#10 + nTotVen;
          #2#11 = #2#9;
          #2#12 = #2#10;
          #2#13 = #2#6 + #2#7 + #2#8;

          #1#2 = #1#2 + nHP;
          #1#3 = #1#3 + nHA;
          #1#4 = #1#4 + nHE;
          nTotHor = #1#5 + nHP + nHA + nHE;
          #1#5 = nTotHor;
          #1#6 = #1#6 + nTotCos;
          #1#7 = #1#7 + nTotVen;
          #1#8 = #1#6;
          #1#9 = #1#7;
          |GRABA 020#1a;
          |GRABA 020#2a;
          |GRABA 020#3a;
          |GRABA 020#4a;
          |GRABA 020#5a;
     |FINSI;
|FPRC;

|PROCESO ExisteEmpresa;
     |MODULO aModulo;
     nErr = 1;
     |DBASS aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "/u/dsprofes/"
          aAlfa = "/u/dsempres/"
     |FINSI;
     aPath = #100#1; |QBF aPath;
     aPath = aAlfa + aPath;
     aFic = aPath + "/fich/";
     aDef = aPath + "/def/agifa041";
     |CARGA_DEF aDef, gopartca@;
     |SI FSalida = 0;
          |SI aModulo = "aomentr3"; |O aModulo = "aojentr3";
                    |O aModulo = "aojentr5";
               aEmp = enEmpresa;
               |QBF aEmp;
               aEmp = ("00000" + aEmp) % -105;
          |SINO;
               aEmp = ("00000" + #100#2) % -105;
          |FINSI;
          |PATH_DAT #1 aFic;
          |ABRE #1;
          #1#0 = aEmp;
          |LEE 000#1=;
          nErr = FSalida;
          |CIERRA #1;
          |DESCARGA_DEF #gopartca@;
     |FINSI;
     FSalida = nErr;
|FPRC;

|PROCESO ActGestion;
     |MODULO aModulo; |QBF aModulo;

     |ABRE #100; |LEE 000#100p; |CIERRA #100;
     |SI #100#3 = "N"; |ACABA; |FINSI;

     |HAZ ExisteEmpresa;
     |SI FSalida ! 0;
          |MENAV "0000ERROR en configuracion empresa gestion...";
          |ACABA;
     |FINSI;

     aDef = aPath + "/def/gopartca";
     |CARGA_DEF aDef, gopartca@;

     aDef = aPath + "/def/gopartll";
     |CARGA_DEF aDef, gopartll@;

     aDef = aPath + "/def/gopartli";
     |CARGA_DEF aDef, gopartli@;

     aDef = aPath + "/def/goptrbca";
     |CARGA_DEF aDef, goptrbca@;

     aDef = aPath + "/def/goptrbli";
     |CARGA_DEF aDef, goptrbli@;

     aDef = aPath + "/def/gopartia";
     |CARGA_DEF aDef, gopartia@;

     aDef = aPath + "/def/gomantho";
     |CARGA_DEF aDef, gomantho@;

     aDef = aPath + "/def/gomantl1";
     |CARGA_DEF aDef, gomantl1@;

     aDef = aPath + "/def/gopre001";
     |CARGA_DEF aDef, gopre001@;

     aDef = aPath + "/def/agifa027";
     |CARGA_DEF aDef, agifa027@;

     aDef = aPath + "/def/gotrabaj";
     |CARGA_DEF aDef, gotrabaj@;

     aDef = aPath + "/def/gocatcot";
     |CARGA_DEF aDef, gocatcot@;

     aDef = aPath + "/def/gocatcon";
     |CARGA_DEF aDef, gocatcon@;

     aDef = aPath + "/def/agifa019";
     |CARGA_DEF aDef, agifa019@;

     |SI aModulo = "aojentr5"; || solo para el modulo de Marcos Jimenez
          aDef = aPath + "/def/gosubaux";
          |CARGA_DEF aDef, gosubaux@;
     |FINSI;

     aFic = aPath + "/fich/" + aEmp + "/";
     |PATH_DAT #1 aFic;
     |PATH_DAT #2 aFic;
     |PATH_DAT #3 aFic;
     |PATH_DAT #4 aFic;
     |PATH_DAT #5 aFic;
     |PATH_DAT #6 aFic;
     |PATH_DAT #7 aFic;
     |PATH_DAT #8 aFic;
     |PATH_DAT #9 aFic;
     |PATH_DAT #10 aFic;
     |PATH_DAT #11 aFic;
     |PATH_DAT #12 aFic;
     |PATH_DAT #19 aFic;
     |SI aModulo = "aojentr5";
          |PATH_DAT #20 aFic;
     |FINSI;
     |PATH_DAT #27 aFic;

     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #5;
     |ABRE #6;
     |ABRE #7;
     |ABRE #8;
     |ABRE #9;
     |ABRE #27;
     |ABRE #10;
     |ABRE #11;
     |ABRE #12;
     |ABRE #19;
     |SI aModulo = "aojentr5";
          |ABRE #20;
     |FINSI;

     |SI enSwCerti = 0;
          nError = 0;
          |HAZ GrabaGes;
          |SI enForma < 0; |Y nNumPre > 0;
               |SI nError = 0;
                    |HAZ BorraGes;
               |FINSI;
          |FINSI;
     |SINO;
          eaCerti = "N";
          nError = 0;
          |HAZ GrabaGes;
     |FINSI;

     |SI aModulo = "aojentr5";
          |CIERRA #20;
     |FINSI;
     |CIERRA #19;
     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #6;
     |CIERRA #7;
     |CIERRA #8;
     |CIERRA #9;
     |CIERRA #27;
     |CIERRA #10;
     |CIERRA #11;
     |CIERRA #12;

     |SI aModulo = "aojentr5";  || solo para el modulo de Marcos Jimenez
          |DESCARGA_DEF #gosubaux@;
     |FINSI;

     |DESCARGA_DEF #agifa019@;
     |DESCARGA_DEF #gocatcon@;
     |DESCARGA_DEF #gocatcot@;
     |DESCARGA_DEF #gotrabaj@;
     |DESCARGA_DEF #agifa027@;
     |DESCARGA_DEF #gopre001@;
     |DESCARGA_DEF #gomantl1@;
     |DESCARGA_DEF #gomantho@;
     |DESCARGA_DEF #gopartia@;
     |DESCARGA_DEF #goptrbli@;
     |DESCARGA_DEF #goptrbca@;
     |DESCARGA_DEF #gopartli@;
     |DESCARGA_DEF #gopartll@;
     |DESCARGA_DEF #gopartca@;
|FPRC;
