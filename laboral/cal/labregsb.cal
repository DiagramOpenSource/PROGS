|FICHEROS;
    labregoc #41;   || registro contratos cabs.
    labregol #42;   || registro contratos lins.
    labregll #43;   || registro contratos lins.lins.
|FIN;

|VARIABLES;
    r_sw1 = 0;
    r_lin = 0;
    nLinea = 0;

    &r_emp = 0;
    &nTipoContrato = "";
    &nAnyoContrato = 0;
    &nMesContrato = 0;
    &nRegContrato = 0;
    &fFecContrato = @;
|FIN;

|PROCESO r_regis5;
|| ABDON
/*
|ABRE #42;
|DDEFECTO #42;
    #42#0 = #41#0;
    #42#1 = #41#1;
    #42#2 = #41#2;
    #42#3 = r_lin;
    #42#4 = nTipoContrato;
    #42#5 = 1;
    #42#6 = "N";
|GRABA 020#42n;
|CIERRA #42;
*/
|ABRE #labregll;
|SELECT #2#labregll;
#labregll#4 = nRegContrato;
|LEE 000#labregll.=;
|SI FSalida ! 0; |DDEFECTO #labregll; #labregll#0 = -1; |FINSI;
|SELECT #1#labregll;
|LEE 000#labregll.=;
|SI FSalida ! 0; |O #labregll#6 = "S";
   |ABRE #42;
   |DDEFECTO #42;
   #42#0 = #41#0;
   #42#1 = #41#1;
   #42#2 = #41#2;
   #42#3 = r_lin;
   |LEE 000#42=;
   |SI FSalida ! 0;
       #42#0 = #41#0;
       #42#1 = #41#1;
       #42#2 = #41#2;
       #42#3 = r_lin;
       #42#4 = nTipoContrato;
       #42#5 = 1;
       #42#6 = "N";
       |GRABA 020#42n;
   |FINSI;
   |CIERRA #42;

   |DDEFECTO #labregll;
   #labregll#0 = #labregoc#0;
   #labregll#1 = #labregoc#1;
   #labregll#2 = #labregoc#2;
   #labregll#3 = r_lin;
   #labregll#4 = nRegContrato;
   #labregll#5 = fFecContrato;
   |GRABA 020#labregll.n;
|FINSI;
|CIERRA #labregll;
|FPRC;

|PROCESO r_regis4;
    r_lin = #42#3;
|FPRC;

|| ABDON
|DEFBUCLE Lineas41;    || graba linea
#42#1;
;
#41#0, #41#1, #41#2, 00001;
#41#0, #41#1, #41#2, 99999;
;
NULL,r_regis4;
|FIN;

|PROCESO r_regis3;
|| ABDON
/*
|SI #42#6 = "N";
        #42#5 = #42#5 + 1;
    |GRABA 020#42a;
    r_sw1 = 1;
|FINSI;
|LIBERA #42;
*/
    |ABRE #labregll;
    |SELECT #2#labregll;
    #labregll#4 = nRegContrato;
    |LEE 000#labregll.=;
    |SI FSalida ! 0; |DDEFECTO #labregll; |FINSI;
    |SELECT #1#labregll;
    |LEE 000#labregll.=;
    |SI FSalida ! 0;
        #42#5 = #42#5 + 1;
        |GRABA 020#42a;

        |DDEFECTO #labregll;
        #labregll#0 = #labregol#0;
        #labregll#1 = #labregol#1;
        #labregll#2 = #labregol#2;
        #labregll#3 = #labregol#3;
        #labregll#4 = nRegContrato;
        #labregll#5 = fFecContrato;
        |GRABA 020#labregll.n;
        r_sw1 = 1;
    |SINO;
        #labregll#5 = fFecContrato;
        |GRABA 020#labregll.a;
    |FINSI;
    |CIERRA #labregll;
|LIBERA #42;
|FPRC;

|DEFBUCLE r_regis2;
 #42#2;
 ;
 #41#0, #41#1, #41#2, nTipoContrato;
 #41#0, #41#1, #41#2, nTipoContrato;
 be;
 NULL, r_regis3;
|FIN;

|PROGRAMA;
    |ABRE #41;
        #41#0 = r_emp;
        #41#1 = nAnyoContrato;
        #41#2 = nMesContrato;
    |LEE 000#41=;
    |SI FSalida ! 0;
        |GRABA 020#41n;            || graba la cabecera
    |FINSI;
|| ABDON
/*
        r_sw1 = 0;
    |BUCLE r_regis2;               || regraba linea
    |SI r_sw1 = 0;
            r_lin = 0;
        |BUCLELIN 2r_regis4#41;    || graba linea
            r_lin = r_lin + 1;
        |HAZ r_regis5;
    |FINSI;
    |CIERRA #41;
*/

    || Busco el contrato, puede estar facturado o no. Si esta facturado, debo
    ||   crear otra linea y darlo de alta para la nueva linea. Si no esta
    ||   facturado, cambio la fecha y chin pun.

    nLinea = 0;
    |ABRE #labregll;
    |SELECT #2#labregll;
    #labregll#4 = nRegContrato;
    |LEE 000#labregll.];
    |PARA; |SI FSalida = 0; |Y #labregll#4 = nRegContrato; |HACIENDO;
       nLinea = #labregll#3;
       |LEE 000#labregll.s;
    |SIGUE;

    |SI nLinea > 0;
       |SELECT #1#labregll;
       #labregll#0 = r_emp;
       #labregll#1 = nAnyoContrato;
       #labregll#2 = nMesContrato;
       #labregll#3 = nLinea;
       #labregll#4 = nRegContrato;
       |LEE 000#labregll.=;
       |SI FSalida = 0;
          #labregll#5 = fFecContrato;
          |GRABA 020#labregll.a;
       |FINSI;
       |CIERRA #labregll;
    |SINO;
       |BUCLE Lineas41;    || graba linea
       r_lin = r_lin + 1;

       |ABRE #42;
       |DDEFECTO #42;
       #42#0 = #41#0;
       #42#1 = #41#1;
       #42#2 = #41#2;
       #42#3 = r_lin;
       |LEE 000#42=;
       |SI FSalida ! 0;
           #42#0 = #41#0;
           #42#1 = #41#1;
           #42#2 = #41#2;
           #42#3 = r_lin;
           #42#4 = nTipoContrato;
           #42#5 = 1;
           #42#6 = "N";
           |GRABA 020#42n;
       |FINSI;
       |CIERRA #42;

       |DDEFECTO #labregll;
       #labregll#0 = #labregoc#0;
       #labregll#1 = #labregoc#1;
       #labregll#2 = #labregoc#2;
       #labregll#3 = r_lin;
       #labregll#4 = nRegContrato;
       #labregll#5 = fFecContrato;
       |GRABA 020#labregll.n;
    |FINSI;
|FPRO;
