|FICHEROS;
     aojentr3 #0;         || entrada horas II
     aojentr4 #1,MANTE;   || Este es el temporal
     aojentrh #3,MANTE;   ||  ''
     aojentr4@;           || Este es el real
     aojentrh@;           || ''
     aomasinc #4;
     aomasinl #5;

     labempre #10;        || empresas
     labtraba #11;        || trabajadores
     aomhoras #12;        || tipos de hora
     aomparam #13;
     aovi0001;
     aovi0011;
     aomcomen;

     agifa041@;
     gomantho@;
     gotrabaj@;
     gotrabal@;
     goptrcom@;
     gopartob@;
     gomantl1@;
     temp0001@ #500;

     aomj0002;
     aomj0003;
|FIN;

|VARIABLES;
     &eaEsMJ = "";       || Modulo 003774
     aDef1 = "";
     aPathBas = "";
     aPathDef = "";
     aPathDat = "";
     aSerPre = "";
     nNumPre = 0;
 {-1}aMenu = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "";
     aMenu4 = "RAC";
     aMenu5 = " Repasar ";
     aMenu6 = " Actualizar ";
     aMenu7 = " Cancelar ";
     nBuffer = 0;
     nPuntero = 0;
     nLineas = 0;
     nCalc = 0;
     nCol = 0;
     aSubProg = "";
     aAlfa = "";
     aDef = "";
     aEmp = "";
     aFic = "";
     aPath = "";
     aSerExp = "";
     nNumExp = 0;
     nSw = 0;
     aEstado = "";
     nError = 0;

     &enForma = 0;
     &efFecha = @;
     &enUni = 0;
     &enHora = 0;
     &enObra = 0;
     &eaObra = "";
     &enSubobra = 0;
     &enTraba = 0;
     &eaSerPre = "";
     &enNumPre = 0;
     &eaNivel = "";
     &eaCapitulo = "";
     &eaPartida = "";
     &eaDesParti = "";
     &enPrecioHora = 0;
     &enEmpresa = 0;
     &enPrecioVenta = 0;

    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;
    elsw1 = 0;
    elsw2 = 0;
    elsw3 = 0;
    elsw4 = 0;
    FEstado = 0;
    seleccio = 0;
    modo = 0;
    sw_rup = 0;

    fecha = @;
    mes = 0;
    any = 0;
    bisiesto = 0;
    topemes = 0;
    sw_enalta = 0;
    uno_nuevo = 0;
     aLon = "";
     nLon1 = 0;
     nLon2 = 0;
     &aTrabajador = "";
     &nUnidades = 0;
     aAlfa1 = "";
     nCate = 0;
     nTraba = 0;
     nModo = 0;
     &nLin = 0;
     nPos1 = 0;
     nPos2 = 0;
     fFecha = @;
|FIN;

|PROCESO BuscaPresu;
     |DBASS aPath;
     aPath = aPath + #13#1; |QBF aPath;
     aDef = aPath + "def/";
     aAlfa = aDef + "gomantl1";
     |CARGA_DEF aAlfa, gomantl1@;
     |SI FSalida = 0;
          aAlfa = aPath + "fich/";
          aAlfa = aAlfa + (("00000" + #0#7) % -105) + "/";
          |PATH_DAT #gomantl1@#aAlfa#;
          |ABRE #gomantl1@;
          #gomantl1@#0 = #0#0;
          #gomantl1@#1 = #0#1;
          #gomantl1@#2 = 1;
          |LEE 000#gomantl1@.];
          |PARA; |SI FSalida = 0; |Y #gomantl1@#0 = #0#0; |Y #gomantl1@#1 = #0#1;
                    |HACIENDO;
               eaSerPre = #gomantl1@#3;
               enNumPre = #gomantl1@#4;
               |SI #gomantl1@#10 = "C"; |SAL; |FINSI;
               |LEE 000#gomantl1@.s;
          |SIGUE;
          |CIERRA #gomantl1@;
          |DESCARGA_DEF #gomantl1@;
     |FINSI;
|FPRC;
____________________________________/
|PROCESO defecto;
    fech1 = ~;
    alfa1 = fech1;
    alfa2 = alfa1 % 402;     mes = alfa2;
    alfa2 = alfa1 % -104;    any = alfa2;

    nume1 = any $ 4;
|SI nume1 = 0;
        bisiesto = 1;
|SINO;
        bisiesto = 0;
|FINSI;

|SI mes =  1;  topemes = 31;             |FINSI;
|SI mes =  2;  topemes = 28 + bisiesto;  |FINSI;
|SI mes =  3;  topemes = 31;             |FINSI;
|SI mes =  4;  topemes = 30;             |FINSI;
|SI mes =  5;  topemes = 31;             |FINSI;
|SI mes =  6;  topemes = 30;             |FINSI;
|SI mes =  7;  topemes = 31;             |FINSI;
|SI mes =  8;  topemes = 31;             |FINSI;
|SI mes =  9;  topemes = 30;             |FINSI;
|SI mes = 10;  topemes = 31;             |FINSI;
|SI mes = 11;  topemes = 30;             |FINSI;
|SI mes = 12;  topemes = 31;             |FINSI;
|FPRC;

|PROCESO fechas;
|HAZ defecto;

    alfa1 = topemes; alfa1 = "00" + alfa1;   alfa1 = alfa1 % -102;
    alfa2 = mes;     alfa2 = "00" + alfa2;   alfa2 = alfa2 % -102;
    alfa3 = any;

    alfa4 = "01."       + alfa2 + "." + alfa3;  fech1 = alfa4; || desde fecha
    alfa4 = alfa1 + "." + alfa2 + "." + alfa3;  fech2 = alfa4; || hasta fecha

    #0#2 = fech1;  |PINTA #0#2;
    #0#3 = fech2;  |PINTA #0#3;
|FPRC;

|PROCESO min1;
    #1#1 = #0#0;              || obra
    #1#7 = #0#1;              || subobra
    #1#0 = #0#2;              || fecha
    #1#2 = #0#7;                 || empresa
    #1#3 = 1;                 || trabajador
    #1#4 = 0;                 || tipos de hora
|FPRC;

|PROCESO max1;
    #1#1 = #0#0;              || obra
    #1#7 = #0#1;              || subobra
    #1#0 = #0#2;              || fecha
    #1#2 = #0#7;             || empresa
    #1#3 = 99999;             || trabajador
    #1#4 = 99;                || tipos de hora
|FPRC;


|PROCESO PresDefecto;
     |SI #13#4 ! "E"; |ACABA; |FINSI;
     |DBASS aPath;
     aPathBas = aPath + #13#1; |QBF aPathBas;
     aPathDef = aPathBas + "def/";
     aPathDat = aPathBas + "fich/" + (("00000" + #0#7) % -105) + "/";

     aDef = aPathDef + "gomantl1"; |CARGA_DEF aDef, gomantl1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |PATH_DAT #gomantl1@#aPathDat#;

     |SI #1#4 = "E";
          |ABRE #gomantl1@;
          #gomantl1@#0 = #0#0;
          #gomantl1@#1 = #0#1;
          #gomantl1@#2 = 1;
          |LEE 000#gomantl1@.];
          |SI FSalida = 0; |Y #gomantl1@#0 = #0#0; |Y #gomantl1@#1 = #0#1;
               aSerPre = #gomantl1@#3;
               nNumPre = #gomantl1@#4;
          |SINO;
               |MENAV "0000Expediente sin presupuestos...";
               |ERROR;
          |FINSI;
          |CIERRA #gomantl1@;
     |FINSI;

     |DESCARGA_DEF #gomantl1@;
|FPRC;

____________________________________/
|PROCESO fecha7; |TIPO 7;
/*
    modo = (FEntrada / 100) ! 0;
|SI sw_enalta = 1;
    |PTEC 802;
    |PTEC 802;
    |PTEC 802;
    |PTEC 802;
|SINO;
    |SI uno_nuevo = 1;|Y #0#4 = 1;
            uno_nuevo = 0;
        |SI modo ! 1;
            |PTEC 809;
            |PTEC 806;
            |PTEC 50;
            |PTEC 49;
            |PTEC 49;
            |PTEC 51;
        |FINSI;
    |SINO;
        |SI modo = 1;
            |SI fecha ! "00.00.0000";
                    #1#0 = fecha;
            |SINO;
                    #1#0 = #0#3;
            |FINSI;
            |PINTA #1#0;
        |FINSI;
    |FINSI;
|FINSI;
*/
|FPRC;

|PROCESO traba7; |TIPO 7;
    modo = (FEntrada / 100) ! 0;
|SI uno_nuevo = 1;|Y #0#4 = 2;
        uno_nuevo = 0;
    |SI modo ! 1;
        |PTEC 809;
        |PTEC 806;
        |PTEC 57;
        |PTEC 57;
        |PTEC 57;
        |PTEC 57;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO arreglo; |TIPO 7;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1;
          sw_enalta = 1;
          #1#2 = #aojentr3#7;
     |FINSI;
|FPRC;

|PROCESO mas_arreglos; |TIPO 7;
    sw_enalta = 0;
|FPRC;

|PROCESO fecha0; |TIPO 0;
|HAZ pin_semana;
    modo = (FEntrada / 100) ! 0;
|SI FSalida = 0;|Y modo = 1;
    |SI #1#0 > #0#3;
        |MENAV "    Fecha fuera de seleccion ...";
        |ERROR;
    |SINO;
            fecha = #1#0;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO tipo13; |TIPO 13;
|HAZ pin_semana;
|HAZ pin_empre;
|HAZ pin_traba;
|HAZ pin_horas;
|FPRC;

|PROCESO pin_semana;
|PINTA 1404, "           ";
    fech1 = #1#0 % 1;
    alfa1 = fech1;
    alfa1 = alfa1 % 11;
|ATRI I;
|PINTA 1404, alfa1;
|ATRI 0;
|FPRC;

|PROCESO pin_empre; |TIPO 0;
     |DDEFECTO #10;
     |ABRE #10;
     #10#0 = #1#2;
     |LEE 000#10=;
     |CIERRA #10;

     |ATRI I;
     alfa1 = #10#2 % 131;
     |PINTA 1604, alfa1;
     |ATRI 0;
|FPRC;

|PROCESO pin_traba; |TIPO 0;
|DDEFECTO #11;
|ABRE #11;
    #11#0 = #1#2;
    #11#1 = #1#3;
|LEE 000#11=;
|CIERRA #11;
|ATRI I;  alfa1 = #11#2 % 131; |PINTA 1804, alfa1;     |ATRI 0;
aTrabajador = #11#2;
|FPRC;

|PROCESO pin_horas; |TIPO 0;
/*
|DDEFECTO #12;
|ABRE #12;
    #12#0 = #1#4;
|LEE 000#12=;
|CIERRA #12;
|ATRI I;  alfa1 = #12#2;       |PINTA 2202, alfa1;     |ATRI 0;
*/
|FPRC;

|PROCESO tipo11; |TIPO 11;
     |SI FSalida = 10;
          |HAZ TeclasFuncion;
          |ERROR;
     |FINSI;
     |SI FSalida = 13;
          |HAZ ConsumoMate;
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |HAZ GeneraAlbaran;
          |ERROR;
     |FINSI;
     |SI FSalida = 15;
          |HAZ GeneraFactura;
          |ERROR;
     |FINSI;
     |SI FSalida = 16;
          |HAZ Observaciones;
          |ERROR;
     |FINSI;
     |SI FSalida = 17;
          |HAZ ParteMaquina;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO tipo3; |TIPO 3;
    modo = (FEntrada / 100) ! 0;
    |SI modo = 1;
        uno_nuevo = 1;
    |FINSI;
|FPRC;

|PROCESO ActComen;
     #goptrcom@#0 = #aomcomen#0;        || ser. pre.
     #goptrcom@#1 = #aomcomen#1;        || num. pre.
     #goptrcom@#2 = #aomcomen#2;        || fecha
     #goptrcom@#3 = #3#18;        || linea parte
     #goptrcom@#4 = #aomcomen#5;        || linea comen.
     |LEE 101#goptrcom@.=;
     FEstado = FSalida;
     |SI FSalida = 0;
          #goptrcom@#5 = #aomcomen#6;
          |GRABA 101#goptrcom@.a;
     |SINO;
          #goptrcom@#0 = #aomcomen#0;
          #goptrcom@#1 = #aomcomen#1;
          #goptrcom@#2 = #aomcomen#2;
          #goptrcom@#3 = #3#18;
          #goptrcom@#4 = #aomcomen#5;
          #goptrcom@#5 = #aomcomen#6;
          |GRABA 020#goptrcom@.n;
     |FINSI;
|FPRC;

|DEFBUCLE ActComen;
     #aomcomen#1;
     ;
     #3#9, #3#10, #3#6, #3#2, #3#4, 001;
     #3#9, #3#10, #3#6, #3#2, #3#4, 999;
     be;
     NULL, ActComen;
|FIN;

|PROCESO BorraComen;
     |BORRA 020#goptrcom@.a;
|FPRC;

|DEFBUCLE BorraComen;
     #goptrcom@#1005;
     ;
     #3#9, #3#10, #3#6, #3#18, 001;
     #3#9, #3#10, #3#6, #3#18, 999;
     be;
     NULL, BorraComen;
|FIN;

|PROCESO Comentarios;
     |DBASS aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "/u/dsprofes/";
          aAlfa = "/u/dsempres/";
     |FINSI;
     aPath = aAlfa + #13#1; |QBF aPath;
     aDef = aPath + "/def/goptrcom";
     |CARGA_DEF aDef, goptrcom@;
     |SI FSalida = 0;
          aEmp = #aojentr3#7;
          aEmp = "00000" + aEmp;
          aEmp = aEmp % -105;
          aFic = aPath + "/fich/" + aEmp + "/";
          |PATH_DAT #goptrcom@#aFic#;
     |FINSI;

     |ABRE #goptrcom@;
     |BUCLE BorraComen;
     |BUCLE ActComen;
     |CIERRA #goptrcom@;
     |DESCARGA_DEF #goptrcom@;
|FPRC;

|PROCESO BuscaImporteMJ;
     || busca importe de dieta para el modulo de MARCOS JIMENEZ
     enPrecioHora = 0;
     enPrecioVenta = 0;

     |ABRE #aomj0002;
     #aomj0002#0 = #labtraba#87;
     #aomj0002#1 = #labtraba#17;
     |LEE 000#aomj0002.=;
     |SI FSalida = 0;
          |SI enHora = #aomj0002#10;
               enPrecioHora = #aomj0002#5;
               enPrecioVenta = #aomj0002#4;
          |FINSI;
          |SI enHora = #aomj0002#11;
               enPrecioHora = #aomj0002#9;
               enPrecioVenta = #aomj0002#8;
          |FINSI;
     |FINSI;
     |CIERRA #aomj0002;

     |ABRE #aomj0003;
     #aomj0003#0 = #labtraba#0;
     #aomj0003#1 = #labtraba#1;
     |LEE 000#aomj0003.=;
     |SI FSalida = 0;
          |SI enHora = #aomj0003#10;
               enPrecioHora = #aomj0003#5;
               enPrecioVenta = #aomj0003#4;
          |FINSI;
          |SI enHora = #aomj0003#11;
               enPrecioHora = #aomj0003#9;
               enPrecioVenta = #aomj0003#8;
          |FINSI;
     |FINSI;
     |CIERRA #aomj0003;
|FPRC;

|PROCESO BuscaImporte;
     || busca importe de hora de trabajo para el modulo de VIPEI
     enPrecioHora = 0;
     enPrecioVenta = 0;
     |ABRE #aovi0001;
     #aovi0001#0 = #labtraba#87;
     #aovi0001#1 = #labtraba#17;
     |LEE 000#aovi0001.=;
     |SI FSalida = 0;
          enPrecioHora = #aovi0001#101;
          enPrecioVenta = #aovi0001#122;
     |FINSI;
     |CIERRA #aovi0001;

     |ABRE #aovi0011;
     #aovi0011#0 = #labtraba#0;
     #aovi0011#1 = #labtraba#1;
     |LEE 000#aovi0011.=;
     |SI FSalida = 0;
          enPrecioHora = #aovi0011#101;
          enPrecioVenta = #aovi0011#122;
     |FINSI;
     |CIERRA #aovi0011;
|FPRC;

|PROCESO ActualizaGes;
     efFecha = #3#6;
     enUni = #3#17;
     ||enHora = 00;        || no se usa tipo de hora
     enHora = #3#19;        || YA se usa tipo de hora

     || para el modulo 3774 de nomina de Marcos Jimenez, si hay algo en tipo
     || de hora se indica si es media dieta o dieta entera, para todos
     || los demas se quedara el tipo 00

     enObra = #3#0;
     eaObra = #3#0;
     enSubobra = #3#1;
     enTraba = #3#4;
     eaSerPre = #3#9;
     enNumPre = #3#10;
     eaNivel = #13#4;
     eaCapitulo = #3#12;
     eaPartida = #3#15;
     eaDesParti = #3#16;
     enEmpresa = #aojentr3#7;

     |SI enHora ! 00;
          |HAZ BuscaImporteMJ;
     |SINO;
          |HAZ BuscaImporte;
     |FINSI;
     |HAZ ActGestion;

     |SI enForma = 1;
          #3#18 = nLin;
          |GRABA 020#3a;
          |HAZ Comentarios;
     |FINSI;
|FPRC;

|DEFBUCLE Actualizacion;
     #3#1;
     ;
     aAlfa, #1#7, #1#2, #1#3, #1#0, 001;
     aAlfa, #1#7, #1#2, #1#3, #1#0, 999;
     be;
     NULL, ActualizaGes;
|FIN;

|PROCESO Tipo2; |TIPO 2;
     #1#15 = #aojentr3#5;

     enForma = 0 +. 1;
     nModo = (FEntrada / 100) ! 0;

     |ABRE #13; |LEE 000#13p; |CIERRA #13;
     |HAZ CreaTraba;
     aAlfa = #1#1;

||     |BUCLE Actualizacion;
|FPRC;

|PROCESO ConsultaChequeo;
     nError = 1;
     enEmpresa = #aojentr3#7;
     |ABRE #13; |LEE 000#13p; |CIERRA #13;
     |HAZ ExisteEmpresa;
     |SI FSalida ! 0;
          |MENAV "0000ERROR en configuracion empresa gestion...";
     |SINO;
          || aSerExp = (("00000" + #0#0) % -105);
          aSerExp = #0#0;
          nNumExp = #0#1;
          |DBASS aAlfa;
          |QBF aAlfa;
          |SI aAlfa = "/u/dsprofes/";
               aAlfa = "/u/dsempres/";
          |FINSI;
          aPath = aAlfa + #13#1; |QBF aPath;
          || aEmp = ("00000" + #13#2) % -105;
          aEmp = ("00000" + #0#7) % -105;
          aDef = aPath + "/def/gomantho";
          |CARGA_DEF aDef, gomantho@;
          |SI FSalida = 0;
               aFic = aPath + "/fich/" + aEmp + "/";
               |PATH_DAT #gomantho@#aFic#;
               |ABRE #gomantho@;
               #gomantho@#0 = aSerExp;
               #gomantho@#1 = nNumExp;
               |SI nSw = 0;             || Chequeo
                    |LEE 000#gomantho@.=;
                    nError = FSalida;
                    aEstado = #gomantho@#9;
                    #0#5 = #gomantho@#29;
                    #0#6 = #gomantho@#3;
                    |PINTA #0#5;
                    |PINTA #0#6;
               |SINO;                   || Consulta
                    |LEE 000#gomantho@.];
                    |CONSULTA_CLAVE #1#gomantho@;
                    nError = FSalida;
                    |SI FSalida = 0;
                         #0#0 = #gomantho@#0;
                         #0#1 = #gomantho@#1;
                         aEstado = #gomantho@#9;
                         |PINTA #0#0;
                         |PINTA #0#1;
                         #0#5 = #gomantho@#29;
                         #0#6 = #gomantho@#3;
                         |PINTA #0#5;
                         |PINTA #0#6;
                    |FINSI;
               |FINSI;
               |CIERRA #gomantho@;
               |DESCARGA_DEF #gomantho@;
          |FINSI;
     |FINSI;
     FSalida = nError;
|FPRC;

|PROCESO Mensaje;
     |SI aEstado = "T";
          |MENAV "0000ERROR, Obra Terminada...";
          |ERROR;
     |SINO;
          |SI aEstado = "C";
               || OK
          |SINO;
               |SI aEstado = "E"; aEstado = "Espera"; |FINSI;
               |SI aEstado = "P"; aEstado = "Parada"; |FINSI;
               aAlfa = "0000ATENCION, Obra en estado: " + aEstado;
               |SI Campo = 1;
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Consulta; |TIPO 66;
     nSw = 1;
     |HAZ ConsultaChequeo;
     |SI FSalida ! 0;
          |ERROR;
     |SINO;
          |HAZ Mensaje;
     |FINSI;
|FPRC;

|PROCESO Chequeo; |TIPO 0;
     |SI Campo = 0; |Y FSalida = 1;
          |ERROR;                 || Tecla ESC
          |ACABA;
     |FINSI;

     nSw = 0;
     |HAZ ConsultaChequeo;
     |SI FSalida ! 0;
          |MENAV "0000ERROR, No existe Expediente (Obra)";
          |ERROR;
     |SINO;
          |HAZ Mensaje;
     |FINSI;
|FPRC;

|PROCESO Produccion;     || por si estamos en produccion hago el cambiazo
     aLon = aAlfa % 0;
     nLon1 = aLon;
     aAlfa1 = aAlfa - "dsprofes/";
     aLon = aAlfa1 % 0;
     nLon2 = aLon;
     |SI nLon1 ! nLon2;
          aAlfa = aAlfa1 + "dsempres/";
     |FINSI;
|FPRC;

|PROCESO ConsultaEmpresa;
     |SI nSw = 2; |ACABA; |FINSI;
     nError = 1;
     |ABRE #13; |LEE 000#13p; |CIERRA #13;
     ||HAZ ExisteEmpresa;
     ||SI FSalida ! 0;
     ||     |MENAV "0000ERROR en configuracion empresa gestion...";
     ||SINO;
          || aSerExp = (("00000" + #0#0) % -105);
          aSerExp = #0#0;
          nNumExp = #0#1;
          |DBASS aAlfa;
          |HAZ Produccion;

          aPath = aAlfa + #13#1; |QBF aPath;
          || aEmp = ("00000" + #13#2) % -105;
          aDef = aPath + "/def/agifa041";
          |CARGA_DEF aDef, agifa041@;
          |SI FSalida = 0;
               || aFic = aPath + "/fich/" + aEmp + "/";
               aFic = aPath + "/fich/"
               |PATH_DAT #agifa041@#aFic#;
               |ABRE #agifa041@;
               #agifa041@#0 = #0#7;
               || #gomantho@#1 = nNumExp;
               |SI nSw = 0;             || Chequeo
                    |LEE 000#agifa041@.=;
                    nError = FSalida;
                    || aEstado = #agifa041@#8;
                    |SI nError = 0;
                         #0#8 = #agifa041@#1;
                         |PINTA #0#8;
                    |FINSI;
               |SINO;                   || Consulta
                    |LEE 000#agifa041@.];
                    |CONSULTA_CLAVE #1#agifa041@;
                    nError = FSalida;
                    |SI FSalida = 0;
                         #0#7 = #agifa041@#0;
                         #0#8 = #agifa041@#1;
                         || aEstado = #gomantho@#9;
                         |PINTA #0#7;
                         |PINTA #0#8;
                         || #0#5 = #gomantho@#29;
                         || #0#6 = #gomantho@#3;
                         || PINTA #0#5;
                         || PINTA #0#6;
                    |FINSI;
               |FINSI;
               |CIERRA #agifa041@;
               |DESCARGA_DEF #agifa041@;
          |FINSI;
     ||FINSI;
     FSalida = nError;
     |SI FSalida ! 0;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Empresa; |TIPO 66;
     nSw = 1; || vengo la consulta
     |HAZ ConsultaEmpresa;
     |SI FSalida ! 0;
          |ERROR;
     |FINSI;
     nSw = 2; || para que no vuelva a entrar
|FPRC;

|PROCESO Inicia; |TIPO 7;
     nSw = 0;
     nError = 0;
|FPRC;

|PROCESO GrabaTraba;
     #gotrabaj@#1 = #11#2;
     #gotrabaj@#3 = #11#17;
     #gotrabaj@#25 = #11#18;
     #gotrabaj@#2 = #11#87;
     #gotrabaj@#4 = #11#3;
     #gotrabaj@#5 = #11#4;
     #gotrabaj@#6 = #11#5;
     #gotrabaj@#7 = #11#6;
     #gotrabaj@#8 = #11#8;
     #gotrabaj@#9 = #11#9;
     #gotrabaj@#10 = #11#76;
     #gotrabaj@#11 = #11#11;
     #gotrabaj@#12 = #11#7;
     #gotrabaj@#13 = #11#75;
     #gotrabaj@#14 = #11#19;
     #gotrabaj@#15 = #11#238;
     #gotrabaj@#16 = #11#244;
     #gotrabaj@#28 = "S";

     #gotrabal@#0 = #gotrabaj@#0;
     #gotrabal@#1 = 1;
     |LEE 101#gotrabal@.=;
     |SI FSalida ! 0;
          |GRABA 020#gotrabal@.b=;
          #gotrabal@#2 = #11#36;
          #gotrabal@#3 = #11#37;
          |GRABA 020#gotrabal@.a;
/*
     |SINO;
          |SI #0#12 = "S";
               #gotrabal@#2 = #11#36;
               #gotrabal@#3 = #11#37;
               |GRABA 020#gotrabal@.a;
          |FINSI;
*/
     |FINSI;
     |LIBERA #gotrabal@;

     |GRABA 020#gotrabaj@.a;
|FPRC;

|PROCESO CreaTraba;
     |ABRE #11;
     |DDEFECTO #11;
     #11#0 = #1#2; ||Emp
     #11#1 = #1#3; ||Tra
     |LEE 020#11=;

     nCate = #11#17;
     nTraba = #11#1;

     |ABRE #13; |LEE 000#13p; |CIERRA #13;
     |DBASS aAlfa;
     |HAZ Produccion;

     aPath = aAlfa + #13#1; |QBF aPath;
     aDef = aPath + "/def/gotrabaj";
     |CARGA_DEF aDef, gotrabaj@;
     |SI FSalida = 0;
          aEmp = #aojentr3#7;
          aEmp = "00000" + aEmp;
          aEmp = aEmp % -105;
          aFic = aPath + "/fich/" + aEmp + "/";
          |PATH_DAT #gotrabaj@#aFic#;
     |FINSI;

     aPath = aAlfa + #13#1; |QBF aPath;
     aDef = aPath + "/def/gotrabal";
     |CARGA_DEF aDef, gotrabal@;
     |SI FSalida = 0;
          aEmp = #aojentr3#7;
          aEmp = "00000" + aEmp;
          aEmp = aEmp % -105;
          aFic = aPath + "/fich/" + aEmp + "/";
          |PATH_DAT #gotrabal@#aFic#;
     |FINSI;

     |DDEFECTO #gotrabaj@;
     |ABRE #gotrabaj@;

     |DDEFECTO #gotrabal@;
     |ABRE #gotrabal@;

     #gotrabaj@#0 = nTraba;
     |LEE 101#gotrabaj@.=;

     |SI FSalida ! 0;
     /*
          |SI #0#12 = "S";
               |HAZ GrabaTraba;
               |SI FSalida = 0;
                    #10#6 = "ACTUALIZADO TRABAJADOR";
               |SINO;
                    #10#6 = "ERROR AL ACTUALIZAR TRABAJADOR";
                    enError = 1;
               |FINSI;
               nConta = nConta + 1;
               #10#7 = nConta;
               |GRABA 020#10n;
               nHay = 1;
          |SINO;
               |SI #gotrabaj@#3 ! nCate;
                    #10#6 = "ERROR CATEGORIA INCORRECTA";
                    nConta = nConta + 1;
                    #10#7 = nConta;
                    |GRABA 020#10n;
                    enError = 1;
                    nHay = 1;
               |FINSI;
               |SI #gotrabaj@#2 ! #11#87;
                    #10#6 = "ERROR CONVENIO INCORRECTO";
                    nConta = nConta + 1;
                    #10#7 = nConta;
                    |GRABA 020#10n;
                    enError = 1;
                    nHay = 1;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #0#12 = "S";
     */
               |GRABA 020#gotrabaj@.b;
               |HAZ GrabaTraba;
               |SI FSalida = 0;
                    |MENSA "    CREADO TRABAJADOR";
               |SINO;
                    |MENSA "    ERROR AL CREAR TRABAJADOR";
                    || enError = 1;
               |FINSI;
               || nConta = nConta + 1;
               || #10#7 = nConta;
               || GRABA 020#10n;
               || nHay = 1;
          /*
          |SINO;
               #10#6 = "NO EXISTE TRABAJADOR";
               nConta = nConta + 1;
               #10#7 = nConta;
               |GRABA 020#10n;
               enError = 1;
               nHay = 1;
          |FINSI;
     |FINSI;
     */
     |FINSI;
     |LIBERA #gotrabaj@;
     |CIERRA #11;

     |DESCARGA_DEF #gotrabal@;
     |DESCARGA_DEF #gotrabaj@;
|FPRC;

|PROCESO ConsultaTra; |TIPO 66;
     aAlfa = "SELECT labtraba.1,labtraba.2 FROM labtraba INTO tm" + Usuario;
     aAlfa = aAlfa + ".def WHERE 0 == " + #1#2 + " AND 44 == A";
     |SQL aAlfa;
          |SI FSalida ! 0;
               |MENAV "    No hay trabajadores en alta en la empresa";
               |ERROR;
               |ACABA;
          |FINSI;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
          |CARGA_DEF aAlfa , temp0001@;
          |SI FSalida = 0;
               aAlfa = "tm" + Usuario; |NOME_DAT #500 aAlfa;
               |ABRE #temp0001@;
               nModo = 2 + 4 + 8 + 16;
               nPos1 = 1203; nPos2 = 2338;
               |C_V #temp0001@#0, 1, "S";
               |C_V #temp0001@#1, 1, "S";
               |LINEAL_SIMPLE #1#temp0001@,nModo, nPos1, nPos2, NULL, NULL, NULL;
               |SI FSalida = 0;
                    #1#3 = #temp0001@#0;
                    |PINTA #1#3;
               |FINSI;
               |ERROR;
               |CIERRA #temp0001@;
               |DELINDEX #temp0001@;
               |DESCARGA_DEF #temp0001@;
          |FINSI;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
          |FBORRA aAlfa;
          |ACABA;
|FPRC;

|PROCESO CompTra;
     |ABRE #labtraba;
     #labtraba#0 = #1#2;
     #labtraba#1 = #1#3;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          |SI #labtraba#44 = "B";
               fFecha = #labtraba#37;
               |SI fFecha < #1#0;
                    |MENAV "    ATENCION: Trabajador en situación de BAJA";
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #labtraba;
|FPRC;

|PROCESO ConsumoMate;
     aSubProg = ":dscomer9/guerz079 agif0041 " + (("00000" + #0#7) % -105);
     aSubProg = aSubProg + ";" +  #0#0 + (("000000" + #0#1)%-106) + #1#0;
     |SUB_EJECUTA_NP aSubProg;
|FPRC;

|PROCESO GeneraAlbaran;
     aSubProg = ":dscomer9/guerz083 agif0041 " + (("00000" + #0#7) % -105);
     aSubProg = aSubProg + ";" +  #0#0 + (("000000" + #0#1)%-106) + #1#0;
     aSubProg = aSubProg + "000000";
     |SUB_EJECUTA_NP aSubProg;
|FPRC;

|PROCESO GeneraFactura;
     aSubProg = ":dscomer9/guerz084 agif0041 " + (("00000" + #0#7) % -105);
     aSubProg = aSubProg + ";" +  #0#0 + (("000000" + #0#1)%-106) + #1#0;
     aSubProg = aSubProg + "000000";
     |SUB_EJECUTA_NP aSubProg;
|FPRC;

|PROCESO ParteMaquina;
     aSubProg = ":dscomer9/guerz086 agif0041 " + (("00000" + #0#7) % -105);
     aSubProg = aSubProg + ";" +  #0#0 + (("000000" + #0#1)%-106) + #1#0;
     aSubProg = aSubProg + "000000";
     |SUB_EJECUTA_NP aSubProg;
|FPRC;

|PROCESO CogeLineas;
     aAlfa = #gopartob@#4;
     |AL_BUF nBuffer, nPuntero, aAlfa;
     nPuntero = nPuntero + 1;
     |BORRA 020#gopartob@.a;
|FPRC;

|DEFBUCLE CogeLineas;
     #gopartob@#1004;
     ;
     eaSerPre, enNumPre, #0#2, 1;
     eaSerPre, enNumPre, #0#2, 999;
     be;
     NULL, CogeLineas;
|FIN;

|PROCESO GrabaLineas;
     |PARA nCalc = 100; |SI nCalc ] 0; |HACIENDO nCalc = nCalc - 1;
          |DEL_BUF nBuffer, nCalc, aAlfa;
          |SI aAlfa ! ""; nLineas = nCalc; |SAL; |FINSI;
     |SIGUE;

     |ABRE #gopartob@;
     |PARA nCalc = 1; |SI nCalc [ nLineas; |HACIENDO nCalc = nCalc + 1;
          |DEL_BUF nBuffer, nCalc, aAlfa;
          |DDEFECTO #gopartob@;
          #gopartob@#0 = eaSerPre;
          #gopartob@#1 = enNumPre;
          #gopartob@#2 = #0#2;
          #gopartob@#3 = nCalc;
          #gopartob@#4 = aAlfa;
          |GRABA 020#gopartob@.n;
     |SIGUE;
     |CIERRA #gopartob@;
|FPRC;

|PROCESO Observaciones;
     |HAZ BuscaPresu;

     |DBASS aPath;
     aPath = aPath + #13#1; |QBF aPath;
     aDef = aPath + "def/";
     aAlfa = aDef + "gopartob";
     |CARGA_DEF aAlfa, gopartob@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     aAlfa = aPath + "fich/";
     aAlfa = aAlfa + (("00000" + #0#7) % -105) + "/";
     |PATH_DAT #gopartob@#aAlfa#;

     |PUSHV 0501 2380;
     |BLANCO 1201 2380;
     |BLANCO 1203 2374;
     |ATRI R; |PINTA 1104, " OBSERVACIONES "; |ATRI 0;
     |DIMENSIONA 200, nBuffer, 0;
     nPuntero = 1;
     |BUCLE CogeLineas;
     nModo = 100; nLin = 99; nCol = 90;
     |EDITA nBuffer, 1, 100, 1205, 2372, nModo, "", 0, nLin, nCol;
     |HAZ GrabaLineas;
     |FINDIM nBuffer;
     |POPV;

     |DESCARGA_DEF #gopartob@;
|FPRC;

|PROCESO TeclasFuncion;
     |VARIABLES; {20} aPopup = ""; |FINSI;
     aPopup1 = "-1";  || Si fuera -1 en la posicion
     aPopup2 = 5;
     aPopup3 = "<F5> Consumo de Materiales";
     aPopup4 = "<F6> Entrada Albaranes";
     aPopup5 = "<F7> Entrada de Facturas";
     aPopup6 = "<F8> Observaciones Partes Trabajo";
     aPopup7 = "<F9> Entrada Partes Maquinaria";
     IaPopup = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida = 1; FSalida = 13; |FINSI;
     |SI FSalida = 2; FSalida = 14; |FINSI;
     |SI FSalida = 3; FSalida = 15; |FINSI;
     |SI FSalida = 4; FSalida = 16; |FINSI;
     |SI FSalida = 5; FSalida = 17; |FINSI;
|FPRC;

|PROCESO ActuaGestion;
     |ABRE #11;
     |DDEFECTO #11;
     #11#0 = #1#2; ||Emp
     #11#1 = #1#3; ||Tra
     |LEE 000#11=;
     |CIERRA #11;

     |HAZ ActualizaGes;
|FPRC;

|PROCESO ActualizaL;
     |SALVA_DATOS #3;
     |REPON_DATOS #aojentrh@;
     enForma = 1;

     |HAZ ActuaGestion;
     #aojentrh@#18 = #3#18;
     |GRABA 020#aojentrh@.n;
|FPRC;

|DEFBUCLE ActualizaL;
     #3#1;
     ;
     || ser, expe, empre, traba, fecha, linea
     #1#1, #1#7, #1#2, #1#3, #1#0, 001;
     #1#1, #1#7, #1#2, #1#3, #1#0, 999;
     ;
     NULL, ActualizaL;
|FIN;

|PROCESO ActualizaC;
     |SALVA_DATOS #1;
     |REPON_DATOS #aojentr4@;
     |GRABA 020#aojentr4@.n;
     |BUCLE ActualizaL;
|FPRC;

|DEFBUCLE Actualiza;
     #1#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ActualizaC;
|FIN;

|PROCESO DesactualizaL;
     |SALVA_DATOS #aojentrh@;
     |REPON_DATOS #3;

     enForma = -1;
     |HAZ ActuaGestion;

     |BORRA 020#aojentrh@.a;
     |LIBERA #aojentrh@;
|FPRC;

|DEFBUCLE DesactualizaL;
     #aojentrh@#1006;
     ;
     #0#0, #0#1, #0#7, nTraba, #0#2, 001;
     #0#0, #0#1, #0#7, nTraba, #0#2, 999;
     be;
     NULL, DesactualizaL;
|FIN;

|PROCESO DesactualizaC;
     |SALVA_DATOS #aojentr4@;
     |REPON_DATOS #1;

     nTraba = #aojentr4@#3;
     |BUCLE DesactualizaL;
     |BORRA 020#aojentr4@.a;
     |LIBERA #aojentr4@;
|FPRC;

|DEFBUCLE Desactualiza;
     #aojentr4@#1006;
     ;
     #0#2, #0#7, 00001, #0#0, #0#1, 00;
     #0#2, #0#7, 99999, #0#0, #0#1, 99;
     be;
     NULL, DesactualizaC;
|FIN;

|PROCESO Actualizar;
     |BUCLE Desactualiza;

     |ABRE #aojentr4@;
     |ABRE #aojentrh@;
     |BUCLE Actualiza;
     |CIERRA #aojentr4@;
     |CIERRA #aojentrh@;
|FPRC;

|PROCESO CreaUnidades;
     |DDEFECTO #3;
     #3#0 = #1#1;    || serie expediente
     #3#1 = #1#7;    || nro expediente
     #3#2 = #1#2;    || empresa
     #3#4 = #1#3;    || trabajador
     #3#6 = #1#0;    || fecha
     #3#8 = 001;            || linea
     #3#9 = aSerPre;
     #3#10 = nNumPre;
     #3#17 = #0#9;
     |GRABA 020#3n;
|FPRC;

|PROCESO LlenaTraba;
     |SI #0#2 < #5#8; |O #0#2 > #5#9;
          |ACABA;
     |FINSI;

     #11#0 = #0#7;
     #11#1 = #5#6;
     |LEE 000#11=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #11#44 = "B";
          fFecha = #11#37;
          |SI fFecha < #0#2;
               |ACABA;             ||Trabajador Baja
          |FINSI;
     |FINSI;

     #1#0 = #0#2;              || fecha
     #1#2 = #0#7;             || empresa
     #1#3 = #5#6;             || trabajador
     #1#1 = #0#0;              || obra
     #1#7 = #0#1;              || subobra
     #1#4 = 99;                || tipos de hora
     |LEE 000#1=;
     |SI FSalida ! 0;
          #1#5 = #0#9;
          |GRABA 020#1n;
          |SI FSalida = 0; |Y #13#4 = "E";
               |HAZ CreaUnidades;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LlenaTraba;
     #4#1;
     ;
     #0#7, #0#0, #0#1, "     ", 000001;
     #0#7, #0#0, #0#1, "zzzzz", 999999;
     ;
     NULL, NULL, LlenaTraba;
|FIN;

|PROCESO LlenaTmp2;
     |SALVA_DATOS #aojentrh@;
     |REPON_DATOS #3;
     |GRABA 020#3n;
|FPRC;

|DEFBUCLE LlenaTmp2;
     #aojentrh@#1006;
     ; ||ser, expe, empre, traba, fecha, linea
     #0#0, #0#1, #0#7, 00001, #0#2, 001;
     #0#0, #0#1, #0#7, 99999, #0#2, 999;
     ;
     NULL, LlenaTmp2;
|FIN;

|PROCESO LlenaTmp1;
     |SALVA_DATOS #aojentr4@;
     |REPON_DATOS #1;
     |GRABA 020#1n;
|FPRC;

|DEFBUCLE LlenaTmp1;
     #aojentr4@#1006;
     ;
     #0#2, #0#7, 00001, #0#0, #0#1, 00;
     #0#2, #0#7, 99999, #0#0, #0#1, 99;
     ;
     NULL, LlenaTmp1;
|FIN;

|PROGRAMA;
     eaEsMJ = "S";
     |ABRE #13; |LEE 000#13p; |CIERRA #13;
     |CLS;
     |CABEZA "ENTRADA HORAS";
     |DDEFECTO #0;
     |PINPA #0#0;
     |PINDA #0#0;
     ||HAZ fechas;
     |ENTLINEAL #3#1, -4, 7, 22, 0, min1, max1;
     |ENDATOS #1#0;
     #0#3 = #0#2;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |HAZ Observaciones;
          |DDEF aDef1
          aAlfa = aDef1 + "aojentr4";
          |CARGA_DEF aAlfa, aojentr4@;
          |SI FSalida = 0;
               aAlfa = aDef1 + "aojentrh";
               |CARGA_DEF aAlfa, aojentrh@;
               |SI FSalida = 0;
                    fecha = "00.00.0000";
                    sw_enalta = 0;
                    |HAZ PresDefecto;
                    aAlfa = "0" + Usuario;
                    |NOME_DAT #1 aAlfa; |DELINDEX #1;
                    aAlfa = "1" + Usuario;
                    |NOME_DAT #3 aAlfa; |DELINDEX #3;
                    |ABRE #11;
                    |ABRE #1;
                    |ABRE #3;
                    |BUCLE LlenaTmp1;
                    |BUCLE LlenaTmp2;
                    |BUCLE LlenaTraba;
                    |CIERRA #3;
                    |CIERRA #11;
                    |CIERRA #1;
                    |PARA; |SI; |HACIENDO;
                         |ENTLINEAL #3#1, -4, 1, 22, 0, min1, max1;
                         |MENU aMenu;
                         |SI FSalida = 2; |HAZ Actualizar; |SAL; |FINSI;
                         |SI FSalida = 3; |SAL; |FINSI;
                    |SIGUE;
                    |DESCARGA_DEF #aojentrh@;
               |FINSI;
               |DESCARGA_DEF #aojentr4@;
          |FINSI;
          |ENDATOS #1#0;
          #0#3 = #0#2;
     |SIGUE;
|FPRO;
