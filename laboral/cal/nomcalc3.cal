|FICHEROS;                    || ATENCION, CUIDADO CON LOS PROCESOS QUE SE
     nomcalcu;                || VAYAN PASANDO AQUI PROCEDENTES DE LOS
     labtraba;                || INCLUYES. SI ALGUN PROCESO SE REALIZA DESDE
     nomcotem;                || EL NOMCALFJ O DESDE EL NOMCALIR, QUE COMPAR-
     nomconce;                || TEN ESTOS PROGRAMAS, HAY QUE COMPROBAR QUE
     nomhicca;                || FUNCIONEN BIEN (PROBLEMA TIQUET 000055.02642)
     nomabsli;
     labempre;
     nomhisit;
     nomcalca;
     nomcalli;
     nomcontr;
     nomconst;
     nomvarca;
     nomcatli #4;
     nomtrali #6;
     nomvarli #8;
     nomconca;
     nomconli;
     nompluri;
     nompluba;
     nomtraju;
     nomnotan;
     labclean;
     nomhortp;
     nomcal04;
     nomepitr;
     nomconax;
     nomconay;
     nomantca;
     labcentr;
     nomcenes;

     :integral/dsam0101 #101;      || Poblaciones
     labmunic;

     cretam00;
     nomhicca;
     nombonif;
     &copiadef@ #500;
     nomexsml;
     nomnotay;
     nomhorf2;
     gomdetjr;
     nomtrtmp #200;
     nomvarl1;
     nomfical;
     nomnorco;
|FIN;

|VARIABLES;
     &acum_10 = 0;
     &coba_1 = 0;
     &coba_2 = 0;
     &cobb_1 = 0;
     &cobb_2 = 0;
     &coba_3 = 0;
     &cobb_3 = 0;
     &coba_4 = 0;
     &cobb_4 = 0;
     &coba_5 = 0;
     &cobb_5 = 0;
     &base_5 = 0;
     &base_5cc = 0;
     &base_6 = 0;
     &base_7 = 0;
     aCErrorCot = "";         || todo correcto: constante encontrada
     fCFechaCot = @;          || primer dia de mes de calculo
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nBase = 0;
     nRemun = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nTramo = 0;
     &nume0 = 0;
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     nume5 = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     &denfe_0 = 0;
     &dreca_1 = 0; &dreca_2 = 0; &dreca_3 = 0; &dreca_4 = 0;
     &denfe_21 = 0; &denfe_22 = 0; &denfe_23 = 0; &denfe_24 = 0;
     &denfe_A = 0; &denfe_A0 = 0;
     &denfe_D = 0; &denfe_D0 = 0;
     &dacci_21 = 0; &dacci_22 = 0; &dacci_23 = 0; &dacci_24 = 0;
     &dacci_X0 = 0; &dacci_X2 = 0;
     dacci00 = 0; dacci02 = 0;
     &dacci_0;

     &concepto = 0;
     fFechaAnt = @;
     aFechaAnt = "";
     nDiaAnt = 0;
     nMesAnt = 0;
     nAnyAnt = 0;
     aDiaAnt = "";
     aMesAnt = "";
     aAnyAnt = "";
     aDia = "";
     aMes = "";
     aAny = "";
     aFecha = "";
     nAAAAMM_Ant = 0;
     nAAAAMM_Cal = 0;
     &nCoefEspecial = 0;
     &nMes = 0;
     &nElMes = 0;
     &nAny = 0;
     &nElAny = 0;
     &nTopemes = 0;
     nNroITs = 0;
     swITEnCurso = 0;
     nMesSegundaIT = 0;
     nMesTerceraIT = 0;
     nMesSinPlus = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     &fFechaDesde = @;
     &fFechaHasta = @;
     swHospital = 0;
     nMesMenosUno = 0;
     &dvalo_pro = 0;
     &htipo = 0;
     &swfuera = 0;
     &nIncid = 0;
     dia = 0;
     mes = 0;
     any = 0;
     fecalf = "";

     &fecbaj = "";
     &fecsis = @;
     &fecsys = @;
     &swcalindem = 0;
     &swcalvacac = 0;
     &aFechaFIN = "";
     &swEnFiniq = 0;
     fech1 = @;
     fech2 = @;
     fFechaReforma = @;
     &duni1_902 = 0;
     &duni2_902 = 0;
     &sw45y33 = 0;
     &indemni = 0;
     fFechaBaja = @;
     &swSigue = 0;
     &grupo = 0;
     &nDesem = 0;
     &nDiasCotERE = 0;
     &dcoti_0 = 0;
     nMaximoFor = 0;
     nBaseFor = 0;

     nCampoH = 0;
     swStop = 0;
     nMesB = 0;
     nAnyB = 0;
     nCampoT = 0;
     nCampoD = 0;
     nCampoTB = 0;
     nCampoHB = 0;
     nCampoDB = 0;
     swBajaInicial = 0;
     aMensaje = "";
     nCampoR = 0;
     nCampoRSN = 0;
     nCampoFR = 0;
     nFecha = 0;
     nDiaD = 0;
     nDiaH = 0;
     nDiaBusca = 0;
     &aDatosRec = "";
     &campos = 0;
     &anynum = 0;
     &mesnum = 0;
     &topemes = 0;
     fFecha = @;
     nDia = 0;

     nDiasCotAlta = 0;
     nDiasCotIT = 0;
     nHorasCotIT = 0;
     &coti_0 = 0;
     &coti_1 = 0;
     &coti_0_it = 0;
     &campomin = 0;
     &campomax = 0;
     &denfe_2 = 0;
     &dacci_2 = 0;
     &dmate_2 = 0;
     &swAjuste3 = 0;

     &aFechaAlta = "";
     fFechaAlta = @;
     nFechaAlta = 0;
     &aFechaBaja = "";
     nFechaBaja = 0;
     swFechaBlanco = 0;

     &nDias = 0;
     &nMeses = 0;
     &nAnys = 0;
     &dcofi_2 = 0;
     &runnom = "";

     &nConcepFV = 0;
     &nUnidFV = 0;
     &nImporFV = 0;
     &nTotFV = 0;
     &aDescripFV = "";
     &duni1_903 = 0;
     &vacacio = 0;
     &nMesesAlta = 0;

     &coti_0p = 0;
     &coti_1p = 0;
     &base_6p_com = 0;
     &base_7p_des = 0;
     &base_7p_fog = 0;
     &base_7p_fp= 0;
     &base_6p_com_tra = 0;
     &base_7p_des_tra = 0;
     &base_7p_fog_tra = 0;
     &base_7p_fp_tra = 0;
     &base_8 = 0;
     &base_F = 0;
     &zbase_F = 0;
     &zbase_A = 0;
     &base_A = 0;
     &base_AB = 0;
     &por2_cont = 0;
     &por2_dfpg = 0;
     FEstado = 0;
     &propo = 0;
     &dia_2 = 0;
     &dia_4 = 0;
     &dilt = 0;
     swMesCompleto = 0;
     denfe_no = 0;
     &prom_enf = 0;
     &prom_acc = 0;
     &prom_ac2 = 0;
     daccino = 0;
     dacci_no = 0;
     &por1_cont = 0;
     nBrutoEH = 0;
     &dto_con = 0;
     &dto_des = 0;
     &dto_dfp = 0;
     &bon_1 = 0;
     &bon_2 = 0;
     &swNoEntra = 0;
     &semana1 = 0;
     fech4 = @;
     &epig_ilt = 0;
     &epig_ims = 0;
     &base_E = 0;
     &dto_exc_emp = 0; &dto_exc_tra = 0;
     &tipo1 = "";        || mes que cumple a¤o (actual)
     &tipo2 = "";        || mes que cumple a¤o (siguiente)
     &tipo3 = "";        || trimestre que cumple a¤o (actual)
     &tipo4 = "";        || trimestre que cumple a¤o (siguiente)
     &tipo5 = "";        || semestre que cumple a¤o (actual)
     &tipo6 = "";        || semestre que cumple a¤o (siguiente)
     &tipo7 = "";        || a¤o que cumple a¤o (actual)
     &tipo8 = "";        || a¤o que cumple a¤o (siguiente)
     mesact = 0;
     anyact = 0;
     &nPropJub = 0;
     &tp = 0;
     &swApliMin = 0;
     &swajuen = 0;
     &swajuac = 0;
     nMinAlta = 0;
     nBaseAlta = 0;
     &dcofi_999 = 0;
     &nTopeMax = 0;
     &nTopeMin = 0;
     nMaxAlta = 0;
     &swApliMax = 0;

     nCuotaCC = 0;
     fFechaIniBon = @;
     fFechaFinBon = @;
     aFechaFinBon = "";
     fFechaCal = @;
     nDiasBon = 0;
     nNume = 0;
     &bon_0 = 0;
     &bon_3 = 0;
     &zbon_0 = 0;
     &zbon_3 = 0;
     &es_parcial = 0;
     &bisiesto = 0;
     &nCuantos = 0;
     nDifPromPluri = 0;
     nBaseTotal = 0;
     &swBuscaDupli = 0;

     nDiasMesTrab = 0;
     nCotAlta = 0;
     swAntFicha = 0;
     nEmp = 0;
     nTra = 0;
     aFechaBajaBusca = "";
     alfa5 = "";
     fech5 = @;
     fFechaBajaBusca = @;
     &nAnysIndem = 0;
     &aCCTopeadas = "";
     &aCPTopeadas = "";

     &ddese_2 = 0;
     &dia_3 = 0;
     &dalta_3 = 0;
     &dbaja_3 = 0;
     swAjusteDes = 0;

     &swNuevoAju = 0;
     &swAjusteIT = 0;
     &swAjusteIT2 = 0;
     &aTipoAjusteIT = "";
     &aTipoAjusteIT2 = "";
     &dias_v = 0;
     nDiaHastaIT = 0;
     nCampo4 = 0;

     || VARIABLES DEL NUEVO PROCESO DE CALCULO DE DIAS COTIZABLES

     nDiasPerNat = 0;
     nDiasPerCot = 0;

     nDiasAltaNat = 0;
     nDiasITNat = 0;
     nDiasEnfNat = 0;
     nDiasAccNat = 0;
     nDiasMatNat = 0;
     nDiasPatNat = 0;
     nDiasDesNat = 0;

     nDiasAltaCot = 0;
     nDiasITCot = 0;
     nDiasEnfCot = 0;
     nDiasAccCot = 0;
     nDiasMatCot = 0;
     nDiasPatCot = 0;
     nDiasDesCot = 0;

     nBaseCCAlta = 0; nBaseCPAlta = 0;
     nBaseCCIT = 0;   nBaseCPIT = 0;
     nBaseCCEnf = 0;  nBaseCPEnf = 0;
     nBaseCCAcc = 0;  nBaseCPAcc = 0;
     nBaseCCMat = 0;  nBaseCPMat = 0;
     nBaseCCPat = 0;  nBaseCPPat = 0;

     nDiasAjuste = 0;
     nDiasAjusteAlta = 0;
     nDiasAjusteIT = 0;
     nLinUltimaIT = 0;
     &aTipUltimaIT = "";
     swPerCompleto = 0;
     aAlfa3 = 0;
     fFechaIniPer = @;
     fFechaFinPer = @;
     aTipo = "";
     nCampo = 0;
     nDesde = 0;
     nHasta = 0;
     nCuotaCCDia = 0;
     nCuotaCCIT = 0;
     &nHorasRegTP = 0;
     &yaesta = 0;
     &sw79 = 0;
     &danti_0 = 0;
     &danti_1 = 0;
     &anyos = 0;
     &dvalo_101 = 0;
     &duni1_102 = 0;
     campo = 0;
     sigui = 0;
     elotro = 0;
     &enDiasAlta = 0;
     &enHorasTC2 = 0;
     &enHorasTeor = 0;
     &enHorasTP = 0;
     &enMes = 0;
     &enAny = 0;
     &aCCC = "";
     nBonif = 0;
     &aTipoOrigen = "";
     &swPrimera = 0;
     &nProvincia = 0;
     &nPoblacion = 0;
     &nAut = 0;
     &aCodPostal = "";
     &nCodPob = 0;
     &swbaja = 0;

     &base_9 = 0;
     &dacum_30 = 0;
     &por2_hor1 = 0;
     &dacum_31 = 0;
     &por2_hor2 = 0;
     &base_C = 0;
     &zbase_AB = 0;
     &zbase_C = 0;
     &base_D = 0;
     &base_G = 0;
     &nBonifFCI1 = 0;
     &nBonifFCI2 = 0;
     &nBonifERE = 0;
     &nBonifJuv = 0;
     &nBonifFormEmp = 0;
     &nBonifFormTra = 0;
     &swForm = 0;

     &nLimiteAnys = 0;
     difer_m = 0;
     ganti_m = 0;
     difer_a = 0;
     ganti_a = 0;
     ganti_d = 0;
     &fanti_d = 0;
     &fanti_m = 0;
     &fanti_a = 0;
     difer_d = 0;
     &nAcumRecMes1 = 0;
     &nAcumRecMes2 = 0;
     &nAcumRecMes3 = 0;
     &nAcumRecMes4 = 0;
     nAcum = 0;
     &camdes = 0;
     &camhas = 0;
     nCampoRec = 0;
     nCampoFechaRec = 0;
     aFechaITRec = "";
     nCampo5 = 0;
     &guarda = 0;
     nCampoRecSiNo = 0;
     &nDiasAcum = 0;
     aTipoBaja = "";
     &aFechaITInicial = "";
     &nEstoyEnAjuste = 0;

     &denfe_20 = 0;              || si ha estado enfermo
     &denfe_t = 0;
     &para1 = 0;

     &denfe_U0_H = 0;
     &denfe_T0_H = 0;
     &denfe_S0_H = 0;
     &denfe_R0_H = 0;
     &denfe_Z0_H = 0;
     &denfe_W0_H = 0;
     &denfe_Y0_H = 0;
     &denfe_X0_H = 0;
     &denfe_V0_H = 0;

     &denfe_Z_H = 0;
     &denfe_U_H = 0;
     &denfe_T_H = 0;
     &denfe_S_H = 0;
     &denfe_R_H = 0;

     &denfe_Y_H = 0;
     &denfe_X_H = 0;
     &denfe_W_H = 0;
     &denfe_V_H = 0;
     &aux_conv = 0;
     &dreca_0 = 0;

     denfe_NO = 0;

     nDesdeMes = 0;
     nHastaMes = 0;
     aFechaITAcum = "";
     aFechaITActual = "";
     swBajaEnCurso = 0;
     &nPorBon1 = 0;
     &nPorBon2 = 0;
     aFechaCongAnt = "";
     &swModulo = 0;
     aBase = "";
     aMas = "";
     aFich = "";
     aTipoCot = "";
     nJornada = 0;
     &swCambiaCot = 0;
     nDiff = 0;
     &nBaseIT2 = 0;

     &hcoti_0 = 0;
     nLimiteInf =0;
     nLimiteSup =0;

     &duni1_999 = 0;
     &duni2_998 = 0;
     &dunic_201 = 0; &dunic_202 = 0; &dunic_203 = 0; &dunic_204 = 0;
     &dunic_205 = 0; &dunic_206 = 0; &dunic_207 = 0; &dunic_208 = 0;

     nAnysBon = 0;
     nMesesBon = 0;
     swTramoBon = 0;
     aFechaCambioBon = "";
     fFechaCambioBon = @;
     aFechaIniBon = "";
     nDiasTramo1 = 0;
     nDiasTramo2 = 0;
     &nRecAy = 0;
     &nImporteComp = 0;
     nBoni500 = 0;
     &nHorasFor = 0;
     swMensual = 0;
     swDiario = 0;

     &dcont_2 = 0;
     &swControlIT = 0;
     &swAjuste3_C = 0;

     nHastaBonif = 0;
     &nVtoBonif = 0;
     &totalt = 0;
     &totact = 0;
     &totven = 0;
     &diaalt = 0;

     nCuotaTotal = 0;
     nCuotaTrab = 0;
     &nDiasInactividad = 0;
     &nCuotaEmpCC = 0; &nCuotaEmpDes = 0; &nCuotaEmpFog = 0; &nCuotaEmpFP = 0;
     nBaseBon500 = 0;
     swProp = 0;
     nIT = 0;
     &nHospi = 0;

     &aCalenConcep = "";
     &topemes1 = 0;
     &topemes2 = 0;            || calcula los dias laborables del mes
     &swmarca = "";
     &conser3 = 0;
     &conser4 = 0;
     &ajuste5 = 0;
     &ajuste6 = 0;
     &aFiestaAct = "";
     &nTFAct = 0;    || total dias de fiesta por Actividad en el mes
     &nDiaAct1 = 0;  &nDiaAct2 = 0;  &nDiaAct3 = 0;  &nDiaAct4 = 0;
     &nDiaAct5 = 0;  &nDiaAct6 = 0;  &nDiaAct7 = 0;  &nDiaAct8 = 0;
     dianum = 0;
     clavep = "";
     pesos = 0;
     diades = 0; diahas = 0; diafij = 0;
     mesdes = 0; meshas = 0; mesfij = 0;
     &mid = 0;
     mid_1 = 0; mid_2 = 0;
     &swConcep = 0;
     &dlabo_0 = 0;
     &dlabo_k = 0;
     &denfe_1 = 0;
     &dife3 = 0; &dife4 = 0; &dife5 = 0;

     nNume6 = 0; nNume7 = 0;
     &nDiasAltaInt = 0;

     nAnyRecaida = 0;
     nMesRecaida = 0;
     nDiaRecaida = 0;

     &nConceptoInd = 0;
     &swIndem = 0;
     swSolo33 = 0;

     &swFijoDisc = 0;

     nBaseHE = 0;
     nBaseCot = 0;
     nDiasCot = 0;
     nBuscaMeses = 0;
     i = 0;
     nAnyXX = 0;
     nDiasNatAlta = 0;
     &nBase946 = 0;
     &nBase947 = 0;
     nLineaIT = 0;
     nMesIniIT = 0;
     nAnyIniIT = 0;
     nMesBusca = 0;
     nAnyBusca = 0;

     nMesDe    = 0;
     nAnyDe    = 0;
     nQuinAc   = 0;
     nQuinVi   = 0;

     fFec1     = @;
     fFec2     = @;
     fFec3     = @;
     fvenci    = @;

     &doce = 0;
     &graba04 = 0
     &graba05 = 0
     &graba06 = 0
     &graba07 = 0
     &graba08 = 0
     &graba09 = 0
     &graba10 = 0
     &graba11 = 0
     &nHorasCEC = 0;

     &aNif = "";
     &nDiasAlta = 180;
     &swCumple = 0;
     &product = 0;
     &aDef = "";
|FIN;

|PROCESO buscarencia;
     fech1 = #labtraba#36;
     fech2 = #labtraba#37;
     alfa1 = #labtraba#37;
     |QBF alfa1;
     |SI alfa1 = "";
          mesnum = nElMes;
          anynum = nElAny;
          |HAZ ulti_dia;
          alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
          alfa2 = mesnum;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
          alfa3 = anynum;
          alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
          fech2 = alfa4;
     |FINSI;

     nume1 = fech1;
     nume2 = fech2;
     nume3 = nume2 - nume1;
     nDiasAlta = nDiasAlta + nume3;
|FPRC;

|DEFBUCLE buscarencia;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, buscarencia;
     #labtraba#36;
|FIN;

|PROCESO carencia;
     aNif = #labtraba#7;
     nDiasAlta = 0;
     |SALVA_FICHA #labtraba;
     |BUCLE buscarencia;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO BuscaBajas;
     swCumple = 0;
|FPRC;

|DEFBUCLE BuscaBajas;
     #nomhicca#1;
     31;
     #labtraba#0, #labtraba#1, nAny, nDesdeMes, 0,  1;
     #labtraba#0, #labtraba#1, nAny, nHastaMes, 0, 31;
     ;
     NULL, BuscaBajas;
|FIN;

|PROCESO RevisaPunto01;
     aNif = #labtraba#7;           || tiene que cumplir que lleve
     nDiasAlta = 0;                || seis meses de alta en la empresa:
     |SALVA_FICHA #labtraba;       || el bucle buscarencia para comprobar
     |BUCLE buscarencia;           || si lleva al menos 180 dias de antiguedad
     |REPON_FICHA #labtraba;
     |SI nDiasAlta < 180;
          swCumple = 0;
     |FINSI;
|FPRC;

|PROCESO RevisaNormas;
     |ABRE #nomnorco;
     |PARA nCampo = 231; |SI nCampo [ 235; |HACIENDO nCampo = nCampo + 1;
          |SI #nomconax#nCampo# ! 0;
               #nomnorco#0 = #nomconax#nCampo#;
               |LEE 000#nomnorco.=;
               |SI FSalida = 0;
                    |SI #nomnorco#2 = "S";
                         |HAZ RevisaPunto01;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #nomnorco;
|FPRC;

/****************************************************************************/
/*                  PROCESOS PARA EL CALCULO DE NOMINAS                     */
/*                DEL REGIMEN 0138: TRABAJADORES DEL HOGAR                  */
/****************************************************************************/

|PROCESO diasacc0_138;  || DESGLOSA LOS DIAS DE ENFERMEDAD
     dacci00 = 0;
     dacci02 = 0;
     daccino = 0;
     |PARA para1 = 1; |SI para1 [ 4; |HACIENDO para1 = para1 + 1;
          dacci_X0 = 0;
          dacci_X2 = 0;
          dacci_no = 0;

          |SI para1 = 1;  nume1 = dacci_21 + dacci_0;  |FINSI;
          |SI para1 = 2;  nume1 = dacci_22;            |FINSI;    || dias enfermo
          |SI para1 = 3;  nume1 = dacci_23;            |FINSI;
          |SI para1 = 4;  nume1 = dacci_24;            |FINSI;

          |SI nume1 ! 0;
               |SI nume1 ] 3;
                    dacci_X0 = 3;     nume1 = nume1 - 3;       || al  0%
               |SINO;
                    dacci_X0 = nume1; nume1 = 0;
               |FINSI;
               |SI nume1 ] 5;
                    dacci_X2 = 5;    nume1 = nume1 - 5;      || al 75% (empresario)
               |SINO;
                    dacci_X2 = nume1; nume1 = 0;
               |FINSI;
               |SI nume1 ] 1;
                    dacci_no = nume1;
               |SINO;
                    dacci_no = nume1;
                    nume1 = 0;
               |FINSI;

               |SI para1 = 1;  nume1 = dacci_21;            |FINSI;
               |SI para1 = 2;  nume1 = dacci_22;            |FINSI;    || dias enfermo
               |SI para1 = 3;  nume1 = dacci_23;            |FINSI;
               |SI para1 = 4;  nume1 = dacci_24;            |FINSI;

               |SI dacci_no > nume1;
                    dacci_X0 = 0;
                    dacci_X2 = 0;
               |SINO;
                    nume1 = nume1 - dacci_no;
               |FINSI;

               |SI dacci_X2 > nume1;
                    dacci_X0 = 0;
                    dacci_X2 = nume1;
               |SINO;
                    nume1 = nume1 - dacci_X2;
               |FINSI;
               |SI dacci_X0 > nume1;
                    dacci_X0 = nume1;
               |FINSI;

               dacci00 = dacci00 + dacci_X0;
               dacci02 = dacci02 + dacci_X2;
          |FINSI;
     |SIGUE;
     dacci_X0 = dacci00;
     dacci_X2 = dacci02;
|FPRC;

|PROCESO diasenf0_138;  || DESGLOSA LOS DIAS DE ENFERMEDAD
     |PARA para1 = 1; |SI para1 [ 4; |HACIENDO para1 = para1 + 1;
          denfe_A0 = 0;
          denfe_D0 = 0;
          denfe_no = 0;

          |SI para1 = 1;  nume1 = denfe_21 + denfe_0 + dreca_1;  |FINSI;
          |SI para1 = 2;  nume1 = denfe_22 + dreca_2;            |FINSI;    || dias enfermo
          |SI para1 = 3;  nume1 = denfe_23 + dreca_3;            |FINSI;
          |SI para1 = 4;  nume1 = denfe_24 + dreca_4;            |FINSI;

          |SI nume1 ! 0;
               |SI nume1 ] 3;
                    denfe_A0 = 3;     nume1 = nume1 - 3;       || al  0%
               |SINO;
                    denfe_A0 = nume1; nume1 = 0;
               |FINSI;
               |SI nume1 ] 5;
                    denfe_D0 = 5;    nume1 = nume1 - 5;      || al 60% (empresario)
               |SINO;
                    denfe_D0 = nume1; nume1 = 0;
               |FINSI;
               |SI nume1 ] 1;
                    denfe_no = nume1;
               |SINO;
                    denfe_no = nume1; nume1 = 0;
               |FINSI;

               |SI para1 = 1;  nume1 = denfe_21;            |FINSI;
               |SI para1 = 2;  nume1 = denfe_22;            |FINSI;    || dias enfermo
               |SI para1 = 3;  nume1 = denfe_23;            |FINSI;
               |SI para1 = 4;  nume1 = denfe_24;            |FINSI;

               |SI denfe_no > nume1;
                    denfe_A0 = 0;
                    denfe_D0 = 0;
               |SINO;
                    nume1 = nume1 - denfe_no;
               |FINSI;

               |SI denfe_D0 > nume1;
                    denfe_A0 = 0;
                    denfe_D0 = nume1;
               |SINO;
                    nume1 = nume1 - denfe_D0;
               |FINSI;
               |SI denfe_A0 > nume1;
                    denfe_A0 = nume1;
               |FINSI;

               denfe_A = denfe_A + denfe_A0;
               denfe_D = denfe_D + denfe_D0;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO LeeCotEmpHogar;
     alfa1 = "01";
     alfa2 = nElMes;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFechaCot = alfa4;         || primer dia de mes de calculo

     |ABRE #nomcotem;
     #nomcotem#0 = fCFechaCot;
     |LEE 000#nomcotem.];
     |SI FSalida = 0;
          |SI fCFechaCot ! #nomcotem#0;
               |LEE 000#nomcotem.a;
          |FINSI;
     |SINO;
          |LEE 000#nomcotem.u;
     |FINSI;
     |SI FSalida = 0;
          aCErrorCot = "";       || todo correcto: constante encontrada
     |SINO;
          aCErrorCot = "    ATENCION: No existe Tabla de Cotizaciones del Reg. Trab. Hogar para el periodo";
          aCErrorCot = aCErrorCot + " que se calcula";
          |MENAV aCErrorCot;
     |FINSI;
     |CIERRA #nomcotem;
|FPRC;

|PROCESO Base_138;
     |ABRE #nomcotem;

     |HAZ LeeCotEmpHogar;

     |PARA nTramo = 1; |SI nTramo [ 15; |HACIENDO nTramo = nTramo + 1;
          nCampo1 = ((nTramo - 1) * 3) + 1;
          nCampo2 = ((nTramo - 1) * 3) + 2;
          nCampo3 = ((nTramo - 1) * 3) + 3;

          nLimiteInf = #nomcotem#nCampo1# ! 2;
          nLimiteSup = #nomcotem#nCampo2# ! 2;
          nRemun = nRemun ! 2;

          |SI nLimiteInf [ nRemun; |Y nRemun [ nLimiteSup;
               nBase = #nomcotem#nCampo3#;
               |SI nBase = 9999.99;
                    nBase = nRemun;
               |FINSI;
               |SAL;
          |FINSI;
     |SIGUE;

     |CIERRA #nomcotem;
|FPRC;

|PROCESO calcotiz_138;
     |HAZ ExaminaIT;
     |SI swAjuste3 = 0; |O nEstoyEnAjuste ! 0;
          || si estoy en los procesos dentro del ajuste de nominas,
          || no tienes que volver a entrar, ya que si no, me cuentas
          || los dias muchas mas veces de las que tocan
     |SINO;
          |SI aTipUltimaIT = "E";
               |SI coba_1 ! 0; |O cobb_1 ! 0;
                    |SI coba_1 ! 0; coba_1 = coba_1 - (swAjuste3 * prom_enf); |FINSI;
                    |SI cobb_1 ! 0; cobb_1 = cobb_1 - (swAjuste3 * prom_enf); |FINSI;
               |FINSI;
          |FINSI;
          |SI aTipUltimaIT = "A";
               |SI coba_2 ! 0; |O cobb_2 ! 0;
                    |SI coba_2 ! 0; coba_2 = coba_2 - (swAjuste3 * prom_enf); |FINSI;
                    |SI cobb_2 ! 0; cobb_2 = cobb_2 - (swAjuste3 * prom_enf); |FINSI;
               |FINSI;
          |FINSI;
          |SI aTipUltimaIT = "M";
               |SI coba_4 ! 0; |O cobb_4 ! 0;
                    |SI coba_4 ! 0; coba_4 = coba_4 - (swAjuste3 * prom_enf); |FINSI;
                    |SI cobb_4 ! 0; cobb_4 = cobb_4 - (swAjuste3 * prom_enf); |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     nRemun = acum_10 + coba_1 + cobb_2 + coba_3 + coba_4;
     nRemun = nRemun + dvalo_pro;

     || nRemun es para hallar la base de cotizacion

     || ahora voy a ver lo que en verdad voy a cobrar

     nBrutoEH = acum_10;

     || le sumo la parte de base en IT por la que tengo prestaciones
     nBrutoEH = nBrutoEH + (prom_enf * denfe_D);
     nBrutoEH = nBrutoEH + (prom_enf * dacci_X2);

     || si no cobro nada, por estar el mes completo de IT, el trabajador
     || no debe pagar nada en concepto de cotizacion

     |SI nBrutoEH [ 0; |Y dilt ] dia_2;
          por1_cont = 0;
     |FINSI;

     |SI dcofi_2 < 1;
          || si no estoy de alta el mes completo, para saber por que base
          || tengo que cotizar, paso primero al importe que cobraria el mes
          || completo

          nRemun = nRemun / dcofi_2;
     |FINSI;

     nBase = 0;

     |SI nRemun > 0;
          |SI nBrutoEH > 0;        || no se cobra nada por estar todo el mes
               |HAZ Base_138;      || en IT, que la base salga a cero
          |FINSI;
     |FINSI;

     base_6 = nBase - coba_4;
     base_7 = nBase - cobb_4;

     || esto es para el caso de tener un trabajador que no esta todo el mes
     || de alta, en ese caso tengo que proporcionar la base que cotizaria si
     || estuviera de alta el mes completo a los dias en alta

     |SI dcofi_2 < 1;
          base_6 = nBase * dcofi_2;
          base_7 = nBase * dcofi_2;
     |FINSI;

     base_5 = cobb_1 + coba_2 + cobb_4;
|FPRC;

/****************************************************************************/
/*                  CALCULO DE LOS CONCEPTOS QUE SOLO SE                    */
/*          COBRAN A PARTIR DE CIERTO NUMERO DE MESES DE ANTIGUEDAD         */
/****************************************************************************/

|PROCESO nomabsli_Abs;
     |SI #nomabsli#4 = "A";
          nNroITs = nNroITs + 1
          |SI nNroITs = 2;
               nMesSegundaIT = nMes;
          |FINSI;
          |SI nNroITs = 3;
               nMesTerceraIT = nMes;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomabsli_Abs;
     #nomabsli#1;
     ;
     #labtraba#0, #labtraba#1, fFechaDesde;
     #labtraba#0, #labtraba#1, fFechaHasta;
     ;
     NULL, nomabsli_Abs;
|FIN;

|PROCESO CompHospital;
     swHospital = 0;
     |ABRE #nomhisit;
     #nomhisit#0 = #nomhicca#0;
     #nomhisit#1 = #nomhicca#1;
     #nomhisit#2 = #nomhicca#66 + 2000;
     #nomhisit#3 = #nomhicca#2;
     #nomhisit#8 = nCampo1 - 18;
     |LEE 000#nomhisit.=;
     |SI #nomhisit#71 = "S";
          swHospital = 1;
     |FINSI;
     |CIERRA #nomhisit;
|FPRC;

|PROCESO nomhicca_ITs;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nElAny - 2000;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |PARA nCampo1 = 19; |SI nCampo1 [ 22; |HACIENDO nCampo1 = nCampo1 + 1;
               nCampo2 = nCampo1 + 4;
               nCampo3 = nCampo1 + 8;
               |SI #nomhicca#nCampo3# = "E";
                    || habria que buscar si tiene hospitalizacion y si es asi no cuenta
                    || y tambien hay que tener en cuenta los absentismos

                    |SI #nomhicca#nCampo1# ! 0; |Y #nomhicca#nCampo2# ! 0;
                         |HAZ CompHospital;
                         |SI swHospital = 0;
                              nNroITs = nNroITs + 1;
                              |SI nNroITs = 2;
                                   nMesSegundaIT = #nomhicca#2;
                              |FINSI;
                              |SI nNroITs = 3;
                                   nMesTerceraIT = #nomhicca#2;
                              |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI #nomhicca#nCampo1# ! 0; |Y #nomhicca#nCampo2# = 0;
                         swITEnCurso = 1;
                    |FINSI;
                    |SI #nomhicca#nCampo1# = 0; |Y #nomhicca#nCampo2# ! 0;
                         |SI swITEnCurso = 1;
                              swITEnCurso = 0;
                              |HAZ CompHospital;
                              |SI swHospital = 0;
                                   nNroITs = nNroITs + 1;
                                   |SI nNroITs = 2;
                                        nMesSegundaIT = #nomhicca#2;
                                   |FINSI;
                                   |SI nNroITs = 3;
                                        nMesTerceraIT = #nomhicca#2;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO ITs;
     nNroITs = 0;
     swITEnCurso = 0;
     nMesSegundaIT = 0;
     nMesTerceraIT = 0;
     nMesSinPlus = 0;
     |ABRE #nomhicca;
     nMesMenosUno = nElMes - 1;
     |PARA nMes = 1; |SI nMes [ nMesMenosUno; |HACIENDO nMes = nMes + 1;
          |HAZ nomhicca_ITs;

          aMes = nMes; aMes = ("00" + aMes) % -102;
          aAny = nElAny;
          aFecha = "01" + "." + aMes + "." + aAny;
          fFechaDesde = aFecha;

          nMes = nMes;
          nAny = nElAny;
          |HAZ topemes_plb;

          aDia = nTopemes;
          aMes = nMes; aMes = ("00" + aMes) % -102;
          aAny = nElAny;
          aFecha = aDia + "." + aMes + "." + aAny;
          fFechaHasta = aFecha;

          |BUCLE nomabsli_Abs;
     |SIGUE;
     |CIERRA #nomhicca;

     |SI nNroITs = 2;
          nMesSinPlus = nMesSegundaIT + 1;
          |SI nElMes = nMesSinPlus;
               nCoefEspecial = 0;
          |FINSI;
     |FINSI;
     |SI nNroITs ] 3;
          |PARA nNume1 = 1; |SI nNume1 [ 4; |HACIENDO nNume1 = nNume1 + 1;
               nMesSinPlus = nMesTerceraIT + nNume1;
               |SI nElMes = nMesSinPlus;
                    nCoefEspecial = 0;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Antiguedad;
     || fecha de antiguedad del trabajador

     fFechaAnt = #labtraba#34;

     aMesAnt = #labtraba#34 % 402;
     nMesAnt = aMesAnt;
     aAnyAnt = #labtraba#34 % -104;
     nAnyAnt = aAnyAnt;

     nMesAnt = nMesAnt + #nomconce#2;
     |SI nMesAnt = 13;
          nMesAnt = 1;
          nAnyAnt = nAnyAnt + 1;
     |FINSI;
     |SI nMesAnt = 14;
          nMesAnt = 2;
          nAnyAnt = nAnyAnt + 1;
     |FINSI;

     aDia = #labtraba#34 % 102;
     nDiaAnt = aDia;

     nMes = nMesAnt;
     nAny = nAnyAnt;
     |HAZ topemes_plb;
     |SI nDiaAnt > nTopemes;
          nDiaAnt = 1;
          nMesAnt = nMesAnt + 1;
     |FINSI;

     aDia = nDiaAnt; aDia = ("00" + aDia) % -102;
     aMes = nMesAnt; aMes = ("00" + aMes) % -102;
     aAny = nAnyAnt;

     || ahora en aFechaAnt la fecha a partir de la cual puedo cobrar
     || el concepto

     aFechaAnt = aDia + "." + aMes + "." + aAny;

     || lo mismo en formato numerico AAAAMM

     aFecha = aAny + aMes;
     nAAAAMM_Ant = aFecha;

     || fecha calculo nomina en formato numerico AAAAMM
     aMes = nElMes; aMes = ("00" + aMes) % -102;
     aAny = nElAny;
     aFecha = aAny + aMes;
     nAAAAMM_Cal = aFecha;

     |SI nAAAAMM_Cal > nAAAAMM_Ant;
          nCoefEspecial = 1;
     |FINSI;
     |SI nAAAAMM_Cal < nAAAAMM_Ant;
          nCoefEspecial = 0;
     |FINSI;
     |SI nAAAAMM_Cal = nAAAAMM_Ant;
          nMes = nElMes;
          nAny = nElAny;
          |HAZ topemes_plb;

          |SI #labtraba#42 = "T"; |O #labtraba#42 = "D";
               nCoefEspecial = (nTopemes - nDiaAnt + 1) / nTopemes;
          |SINO;
               nCoefEspecial = (30 - nDiaAnt + 1) / nTopemes;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ConceptosEspeciales;
     nCoefEspecial = 1;

     |ABRE #nomconce;
     #nomconce#0 = #labtraba#87;
     #nomconce#1 = concepto;
     |LEE 000#nomconce.=;
     |SI FSalida = 0;
          || primero vemos que tenga dos meses de antiguedad
          |HAZ Antiguedad;
          |HAZ ITs;
     |FINSI;
     |CIERRA #nomconce;
|FPRC;

/**************** COMPROBACIONES ANTES DE CALCULAR **************************/

|PROCESO desglosa_fecha;    || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
     alfa1 = fecalf %  102;   dia = alfa1;
     alfa1 = fecalf %  402;   mes = alfa1;
     alfa1 = fecalf % -104;   any = alfa1;
     |SI alfa1 = "....";
          dia = 0;
          mes = 0;
          any = 0;
     |FINSI;
|FPRC;

|PROCESO chequea;  || chequea el trabajador este en periodo de alta
     swfuera = 0;
     |SI #labtraba#42 = "A"; |O #labtraba#42 = "B";
     |O #labtraba#42 = "E"; |O #labtraba#42 = "e";
          |SI runnom ! "nomcalfi";
               swfuera = 1;
          |FINSI;
     |FINSI;

     |SI swfuera = 0;
          fecalf = #labtraba#36;   || fecha de alta
          |HAZ desglosa_fecha;
          |SI any > nElAny; |O any = 0;
               swfuera = 1;
          |SINO;
               |SI mes > nElMes; |Y any = nElAny;
                    swfuera = 1;
               |FINSI;
          |FINSI;
          |SI swfuera = 0;
               fecalf = #labtraba#37;  || fecha de baja
               |HAZ desglosa_fecha;
               |SI any < nElAny; |Y any ! 0;
                    swfuera = 1;
               |SINO;
                    |SI mes < nElMes; |Y any = nElAny; |Y mes ! 0;
                         swfuera = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO chequea2;
     |ABRE #nomcalca;
     #nomcalca#0 = #labtraba#0;
     #nomcalca#1 = #labtraba#1;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          alfa2 = #nomcalca#5 % 402;
          alfa3 = #nomcalca#5 % -104;
          mes = alfa2;
          any = alfa3;
          |SI mes = nElMes; |Y any = nElAny;     || soy baja este mes y ya tengo
               swfuera = 1;   || pues no compruebo nada, si es baja no entra
                              || y ya esta
          |FINSI;
     |FINSI;
     |CIERRA #nomcalca;
|FPRC;

|PROCESO chequeaBloqueo;
     |ABRE #nomcalca;
     #nomcalca#0 = #labtraba#0;
     #nomcalca#1 = #labtraba#1;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          |SI #nomcalca#145 = "S";
               swfuera = 1;
               nIncid = 40;
               |HAZ graba_inc;
          |FINSI;
     |FINSI;
     |CIERRA #nomcalca;
|FPRC;

|PROCESO EpiTrab;
     |ABRE #nomepitr;
     #nomepitr#0 = #labtraba#0;
     #nomepitr#1 = #labtraba#1;
     #nomepitr#2 = #labtraba#32;
     |LEE 000#nomepitr.=;
     |SI FSalida = 0;
          epig_ilt = #nomepitr#3;
          epig_ims = #nomepitr#4;
     |FINSI;
     |CIERRA #nomepitr;
|FPRC;

|PROCESO poranti;
     yaesta = 0;
     |SI #nomconax#95 = 9;                || segun tipo de calculo de aux.convenios
          |PARA campo = 4;
          |SI campo [ 53; |Y yaesta = 0; |Y anyos ! 0;
          |HACIENDO campo = campo + 1;
               |SI campo = 14;  campo = 24;    |FINSI;
               |SI campo = 34;  campo = 44;    |FINSI;
               sigui = campo + 1;
               |SI sigui = 14;  sigui = 24;    |FINSI;
               |SI sigui = 34;  sigui = 44;    |FINSI;
               |SI anyos ] #nomantca#campo#; |Y anyos < #nomantca#sigui#;
                    yaesta = 1;
                    elotro = campo + 10;
                    danti_0 = #nomantca#elotro#;   || carga cantidad fija de antig./categ.
                    danti_1 = duni1_102;   || carga las unidades segun calculo
               |FINSI;
          |SIGUE;
          danti_0 = danti_0 * tp;    || proporciona los tiempo parcial
     |SINO;
          sw79 = 0;      || para indicar que he cogido el ultimo tramo
          |PARA campo=65;|SI campo[79;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
               sigui = campo + 1;
               |SI anyos ] #nomconax#campo#; |Y anyos < #nomconax#sigui#; |O campo = 79;
                    yaesta = 1;
                    |SI campo = 79; sw79 = 1; yaesta = 0; |FINSI;
                    elotro = campo + 15;
                    danti_0 = dvalo_101;   || carga con valor del 101
                    danti_1 = #nomconax#elotro#;   || carga con el porcentaje corresp.
               |FINSI;
          |SIGUE;

          |SI yaesta = 0;
               |ABRE #nomconay;
               #nomconay#0 = #nomconax#0;
               |LEE 000#nomconay.=;
               |SI FSalida = 0;
                    |PARA campo = 1; |SI campo [ 15; |Y yaesta = 0; |Y anyos ! 0; |HACIENDO campo = campo + 1;
                         |SI sw79 = 1; |Y #nomconay#campo# = 0;
                              |SAL;
                         |FINSI;
                         sigui = campo + 1;
                         |SI anyos ] #nomconay#campo#; |Y anyos < #nomconay#sigui#; |O campo = 15;
                              yaesta = 1;
                              elotro = campo + 15;
                              danti_0 = dvalo_101;    || carga con valor del 101
                              danti_1 = #nomconay#elotro#;   || carga con el porcentaje corresp.
                         |FINSI;
                    |SIGUE;
               |FINSI;
               |CIERRA #nomconay;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO historico;
     |SI aFechaFIN ! ""; || Sykes: theorical
          |ACABA;
     |FINSI;
     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;   || empresa
     #nomhicca#1 = #labtraba#1;   || trabajador
     nume1 = nElAny;   nume1 = nume1 $ 100;
     #nomhicca#66= nume1;  || a¤o
     #nomhicca#2 = nElMes;   || mes
     #nomhicca#3 = htipo;  || tipo
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          nIncid = 59;
          |HAZ graba_inc;
          /*
          alfa1 = "    Debera desactualizar a [";
          alfa1 = alfa1 + #nomhicca#0 + "." + #nomhicca#1 + "." + #nomhicca#66 + ".";
          alfa1 = alfa1 + #nomhicca#2 + "." + #nomhicca#3 + "] para poder calcularlo";
          |MENAV alfa1;
          */
          swfuera = 1;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

/************** AYUDA EN CASO DE TRABAJADOR EN FORMACION CON ERE ************/

|PROCESO ERE_Formacion;
     |SI nDiasCotERE [ 0;
          |ACABA;
     |FINSI;

     |SI grupo = 10;
          nBaseFor = #nomconst#33;
     |FINSI;
     |SI grupo = 11;
          nBaseFor = #nomconst#34;
     |FINSI;
     nDesem = (nBaseFor % 75) * nDiasCotERE;

     nMaximoFor = ((nBaseFor % 75) * 30) ! 2;

     nume2 = (base_6 ! 2) + (nDesem ! 2);
     |SI nume2 > nMaximoFor;
          nDesem = nDesem - 0.01;
     |FINSI;
|FPRC;

/********* SE BUSCA SI LA ENFERMEDAD ACTUAL PROVIENE DE UNA RECAIDA *********/

|PROCESO CuantosDiasIT;
     mesnum = #nomhicca#2;
     anynum = #nomhicca#66 + 2000;
     |HAZ ulti_dia;
     |SI nDesde = 0;
          nDesde = 1;
     |FINSI;
     |SI nHasta = 0;
          nHasta = topemes;
     |FINSI;
|FPRC;

|PROCESO FechaITInicial;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     #nomhicca#66 = nAny - 2000;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |PARA nCampoT = 27; |SI nCampoT [ 30; |HACIENDO nCampoT = nCampoT + 1;
               nCampoD = nCampoT - 8;
               nCampoFechaRec = nCampoT + 112;
               |SI nDia = #nomhicca#nCampoD#;
                    aFechaITInicial = #nomhicca#nCampoFechaRec#;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO BuscaReca;
     |ABRE #nomhicca;

     aDia = aFecha % 102; nDia = aDia;
     aMes = aFecha % 402; nMes = aMes;
     aAny = aFecha % -104; nAny = aAny;

     nAnyB = 0;
     nMesB = 0;

     aFechaITAcum = aFecha;
     |SI swSigue ! 3;
          || en swSigue = 3 ya se la fecha inicial
          aFechaITInicial = "";
          aFechaITActual = "";
          |HAZ FechaITInicial;
     |FINSI;
     |SI aFechaITInicial ! "";
          || ya tengo la fecha de la que proviene la recaida
          aDia = aFechaITInicial % 102; nDia = aDia;
          aMes = aFechaITInicial % 402; nMes = aMes;
          aAny = aFechaITInicial % -104; nAny = aAny;

          nAnyB = 0;
          nMesB = 0;
     |SINO;
          |CIERRA #nomhicca;
          |ACABA;
     |FINSI;

     |PARA nAny = nAny; |SI nAny [ nElAny; |HACIENDO nAny = nAny + 1;
          |SI nAny ! nElAny;
               nDesdeMes = nMes;
               nHastaMes = 12;
          |SINO;
               nDesdeMes = 1;
               nHastaMes = nElMes;
          |FINSI;
          |PARA nMes = nDesdeMes; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
               #nomhicca#0 = #labtraba#0;
               #nomhicca#1 = #labtraba#1;
               #nomhicca#2 = nMes;
               #nomhicca#3 = 0;
               #nomhicca#66 = nAny - 2000;
               |LEE 000#nomhicca.=;
               |SI FSalida = 0;
                    |PARA nCampoT = 27; |SI nCampoT [ 30; |HACIENDO nCampoT = nCampoT + 1;
                         |SI #nomhicca#nCampoT# = #nomvarca#nCampo1#;
                              nCampoD = nCampoT - 8;
                              nCampoH = nCampoT - 4;
                              nCampoRecSiNo = nCampoT + 107;
                              nCampoFechaRec = nCampoT + 112;

                              |SI nDia = #nomhicca#nCampoD#;
                              |Y nMes = #nomhicca#2;
                                   || esta es la IT INICIAL
                                   || a ver cuantos dias fueron

                                   nDesde = #nomhicca#nCampoD#;
                                   nHasta = #nomhicca#nCampoH#;
                                   |HAZ CuantosDiasIT;
                                   nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);

                                   aTipoBaja = #nomhicca#nCampoT#;

                                   alfa1 = #nomhicca#nCampoD#; |QBF alfa1; alfa1 = ("00" + alfa1) % -102;
                                   alfa2 = #nomhicca#2; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
                                   alfa3 = #nomhicca#66; |QBF alfa3; alfa3 = "20" + alfa3;
                                   aDatosRec = alfa1 + "." + alfa2 + "." + alfa3;

                                   |QBF aDatosRec;
                                   aDatosRec = " Inicio: " + aDatosRec;

                                   |SI #nomhicca#nCampoH# = 0;
                                        swBajaEnCurso = 1;
                                   |SINO;
                                        swBajaEnCurso = 0;
                                   |FINSI;
                              |SINO;
                                   alfa1 = #nomhicca#nCampoD#; |QBF alfa1; alfa1 = ("00" + alfa1) % -102;
                                   alfa2 = #nomhicca#2; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
                                   alfa3 = #nomhicca#66; |QBF alfa3; alfa3 = "20" + alfa3;
                                   aFechaITActual = alfa1 + "." + alfa2 + "." + alfa3;
                                   |SI aFechaITActual = #labtraba#125;
                                        || ojo, es la IT que estoy calculando
                                        || es recaida y aqui es cuando empezo
                                        || no tengo que sequier mirando entonces
                                        || porque los dias de esta IT me vienen en
                                        || el acumulado del mes anterior, no tengo
                                        || que contarlo como recaida

                                        |CIERRA #nomhicca;
                                        |ACABA;
                                   |FINSI;

                                   || compruebo todas la IT que hayan sido
                                   || recaida con la misma fecha inicial
                                   |SI #nomhicca#nCampoRecSiNo# = "S";
                                   |Y #nomhicca#nCampoFechaRec# = aFechaITInicial;
                                        nDesde = #nomhicca#nCampoD#;
                                        nHasta = #nomhicca#nCampoH#;
                                        nNume = nMes + 1;
                                        |SI nHasta = 0; |Y nNume = nHastaMes;
                                             || no me lo acumules, ya que es la IT
                                             || del mes anterior que continua en
                                             || este, los dias ya me vienen en
                                             || el campo acumulado del labtraba
                                        |SINO;
                                             |HAZ CuantosDiasIT;
                                             nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);
                                             aDatosRec = #nomhicca#nCampoFechaRec#;
                                             |QBF aDatosRec;
                                             aDatosRec = " Inicio: " + aDatosRec;
                                        |FINSI;
                                   |SINO;
                                        |SI #nomhicca#nCampoD# = 0; |Y swBajaEnCurso = 1;
                                             nDesde = #nomhicca#nCampoD#;
                                             nHasta = #nomhicca#nCampoH#;
                                             |HAZ CuantosDiasIT;
                                             nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);
                                             |SI #nomhicca#nCampoH# = 0;
                                                  swBajaEnCurso = 1;
                                             |SINO;
                                                  swBajaEnCurso = 0;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |SIGUE;
     |SIGUE;

     |CIERRA #nomhicca;
|FPRC;

|DEFBUCLE BuscaReca;
     #labtraba#7;
     ;
     aNif, nEmp, 00001;
     aNif, nEmp, 99999;
     ;
     NULL, BuscaReca;
|FIN;

|PROCESO RecaidaNomvarca;
     aAlfa = #nomvarca#nCampoR#;
     aAlfa = aAlfa % 402;
     nMesRecaida = aAlfa;
     aAlfa = #nomvarca#nCampoR#;
     aAlfa = aAlfa % -104;
     nAnyRecaida = aAlfa;

     |SI nMesRecaida = nElMes; |Y nAnyRecaida = nElAny;
          || parece ser una recaida de una enfermedad que ha empezado
          || este mismo mes

          aAlfa = #nomvarca#nCampoR#;
          aAlfa = aAlfa % 102;
          nDiaRecaida = aAlfa;

          |PARA nume1 = 4; |SI nume1 [ 8; |HACIENDO nume1 = nume1 + 1;
               nume2 = nume1 + 4;
               nume3 = nume1 + 8;
               |SI nDiaRecaida = #nomvarca#nume1#;
               || esta es la IT inicial de este mes
                    nDiasAcum = #nomvarca#nume2# - #nomvarca#nume1# + 1;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO ControlRec;
     swSigue = 0;
     nCampo1 = campos;
     nCampoD = nCampo1 - 8;
     nCampoH = nCampo1 - 4;
     nCampoR = nCampo1 + 27;
     nCampoRSN = nCampo1 + 23;

     |SI #nomvarca#nCampo1# = "E"; |Y #nomvarca#nCampoD# = 0; |Y #nomvarca#nCampoH# = 0;
     |Y #labtraba#89 ! 0;
          |SI #labtraba#123 = "S";
               swSigue = 1;
          |SINO;
               swSigue = 2;   || no tengo en el trabajador la "S" de que es una
                              || recaida, aun asi busco en el nomhisit por si acaso
          |FINSI;
     |FINSI;
     |SI #nomvarca#nCampo1# = "A"; |Y #nomvarca#nCampoD# = 0; |Y #nomvarca#nCampoH# = 0;
     |Y #labtraba#92 ! 0;
          |SI #labtraba#123 = "S";
               swSigue = 1;
          |SINO;
               swSigue = 2;   || no tengo en el trabajador la "S" de que es una
                              || recaida, aun asi busco en el nomhisit por si acaso
          |FINSI;
     |FINSI;
     aFecha = #labtraba#125;  || fecha de la que viene la IT que continua
     |QBF aFecha;
     |SI aFecha = "";
          swSigue = 0;
     |FINSI;

     || otro caso nuevo (laborbox 08.05.2018)
     |SI #nomvarca#nCampoD# ! 0; |O #nomvarca#nCampoH# ! 0; || con dia des-has
          |SI #nomvarca#nCampoRSN# = "S";    || recaida SI
          |Y #nomvarca#43 = 0;               || sin dias acum
                                             || puede venir de laborbox
               || voy a buscar por si fuera una recaida de una IT del mismo
               || mes
               |HAZ RecaidaNomvarca;
               |SI nDiasAcum = 0;
                    aFecha = #nomvarca#nCampoR#;
                    aFechaITInicial = #nomvarca#nCampoR#;

                    swSigue = 3;
               |SINO;
                    || la he encontrado en las variaciones del mes
                    aDatosRec = #nomvarca#nCampoR#;
                    |QBF aDatosRec;
                    aDatosRec = " Inicio: " + aDatosRec;
                    aFechaITInicial = #nomvarca#nCampoR#;

                    swSigue = 0;   || que no siga
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swSigue = 1; |O swSigue = 2; |O swSigue = 3;
          || vengo de recaida, voy a buscarla:

          swBajaInicial = 0;
          nDiasAcum = 0;

          || vamos a hacer una cosa, ya que tenemos guardada de la IT del mes anterior
          || los dias acum de recaida de la baja inicial, no me meto en mas lios,
          || si tengo la ficha me lo cojo del mes anterior y ya esta

          |ABRE #nomhisit;
          #nomhisit#0 = #labtraba#0;
          #nomhisit#1 = #labtraba#1;
          #nomhisit#2 = nElAny;
          #nomhisit#3 = nElMes - 1;
          |SI #nomhisit#3 = 0;
               #nomhisit#3 = 12;
               #nomhisit#2 = nElAny - 1;
          |FINSI;
          |PARA nIT = 1; |SI nIT [ 4; |HACIENDO nIT = nIT + 1;
               #nomhisit#8 = nIT;
               |LEE 000#nomhisit.=;
               |SI FSalida = 0;
                    |SI #nomhisit#6 = #nomvarca#nCampo1#;
                         |SI #nomhisit#10 = "S";
                              nDiasAcum = #nomhisit#11;
                              aDatosRec = #nomhisit#77;
                              |QBF aDatosRec;
                              aDatosRec = " Inicio: " + aDatosRec;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |CIERRA #nomhisit;

          |SI nDiasAcum = 0;
               |SI swSigue = 1; |O swSigue = 3;
                    || vaya por dios, no hemos encontrado nada, hay que hacer
                    || la paranoia del proceso de este bucle

                    aNif = #labtraba#7;
                    nCampo = nCampo - 23;

                    nEmp = #labtraba#0;
                    nTra = #labtraba#1;
                    |BUCLE BuscaReca;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO topes_tp_it_comunes;
     |SI denfe_2 > 0; |O dacci_2 > 0; |O dmate_2 > 0;
          || esto lo tendria que hacer para todos los meses, pero no me fio
          || lo dejo solo en febrero que es cuando ha salido el problema, en
          || febrero (28 o 29 dias), estando todo el mes de IT
          || en este caso no se carga swAjuste3, hay que hacer antes de esto
          || lo mismo que hace el PROCESO liquidados

          nume1 = (denfe_2 + dacci_2 + dmate_2);
          |SI nElMes = 2;
               |SI nume1 > dia_4;  nume1 = dia_4;  |FINSI;
               |SI nume1 = dia_2; |Y nume1 < dia_4;
                    |SI #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
                         nume1 = dia_4;
                    |FINSI;
               |FINSI;
          |FINSI;

          nDiasCotAlta = dcoti_0 - ddese_2 - nume1 + swAjuste3;
          nDiasCotIT = nume1 - swAjuste3;

          nDiasCotAlta = nDiasCotAlta * #labtraba#47;
          |SI 0 < nDiasCotAlta; |Y nDiasCotAlta < 0.5;
               nDiasCotAlta = 1;
          |SINO;
               nDiasCotAlta = nDiasCotAlta ! 0;
          |FINSI;
          |SI nHorasCEC ! 0; |Y #labtraba#129 ! "T";
               nDiasCotAlta = nHorasCEC;
          |FINSI;

          |SI prom_enf ! prom_acc;
               coti_0 = (#nomconst#campomin# * nDiasCotAlta) + base_5cc;
          |SINO;
               coti_0 = (#nomconst#campomin# * nDiasCotAlta) + base_5;
          |FINSI;

          || tenemos un problema cuando la base de cot. diaria por las horas
          || en IT es inferior al minimo por horas, debido a que la base
          || que tenemos es por DIAS (el promedio), asi que comprobamos el caso
/*
          || aqui estan los dias NATURALES, que son los que se tendran en
          || cuenta en cotizacion para los TP a partir de octubre 2015

          nDiasCotIT = (denfe_2 + dacci_2 + dmate_2);

          || ahora multiplico para sacar las HORAS que se van a cotizar en IT
          || no si es la 509 (minimo por dias)

          |SI #labtraba#248 ! 509;
               nHorasCotIT = nDiasCotIT * #labtraba#47;
          |FINSI;

          |SI 0 < nHorasCotIT; |Y nHorasCotIT < 0.5;
               nHorasCotIT = 1;
          |SINO;
               nHorasCotIT = nHorasCotIT ! 0;
          |FINSI;

          || esto es el minimo por horas que hay que cotizar en IT

          |SI #labtraba#248 = 509;
               campomin = 47 + grupo;
          |FINSI;
          nume1 = nHorasCotIT * #nomconst#campomin#;

          |SI base_5 < nume1;
               prom_enf = nume1 / nDiasCotIT;
               prom_acc = nume1 / nDiasCotIT;

               nDiff = nume1 - base_5;

               |HAZ ExaminaIT;

               coti_0 = coti_0 + nDiff;
               base_5 = base_5 + nDiff;
               |SI aTipUltimaIT = "E"; |O aTipUltimaIT = "A";
                    base_6 = base_6 + nDiff;
                    base_7 = base_7 + nDiff;
               |FINSI;
               |SI aTipUltimaIT = "M";
                    coba_4 = coba_4 + nDiff;
                    cobb_4 = cobb_4 + nDiff;
               |FINSI;
               aCCTopeadas = "m";
               aCPTopeadas = "m";
               swCambioProm = 1;
          |FINSI;
*/
     |FINSI;
|FPRC;

|PROCESO topes_tp_it_prof;
     |SI denfe_2 > 0; |O dacci_2 > 0; |O dmate_2 > 0;
          || Igual que en cont. comunes
          nume1 = (denfe_2 + dacci_2 + dmate_2);
          |SI nElMes = 2;
               |SI nume1 > dia_4;  nume1 = dia_4;  |FINSI;
               |SI nume1 = dia_2; |Y nume1 < dia_4;
                    |SI #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
                         nume1 = dia_4;
                    |FINSI;
               |FINSI;
          |FINSI;

          nDiasCotAlta = dcoti_0 - nume1 + swAjuste3;
          nDiasCotIT = nume1 - swAjuste3;

          nDiasCotAlta = nDiasCotAlta * #labtraba#47;
          |SI nHorasCEC ! 0;
               nDiasCotAlta = nHorasCEC;
          |FINSI;
          |SI 0 < nDiasCotAlta; |Y nDiasCotAlta < 0.5;
               nDiasCotAlta = 1;
          |SINO;
               nDiasCotAlta = nDiasCotAlta ! 0;
          |FINSI;

          coti_1 = (#nomconst#campomin# * nDiasCotAlta) + base_5;
     |FINSI;
|FPRC;

/*********** AVISA SI ESTA ACTIVADO EL "INFERIOR A 7 DIAS" Y SE *************/
/******************** CALCULAN MAS DE 7 DIAS DE ALTA ************************/

|PROCESO MasDeSiete;
     |SI runnom = "nomcalir"; |ACABA; |FINSI;
     swFechaBlanco = 0;

     aFechaAlta = #labtraba#36;
     fFechaAlta = aFechaAlta;
     nFechaAlta = fFechaAlta;

     aFechaBaja = #labtraba#37;
     |QBF aFechaBaja;

     || el nomvarca esta ya leido durante el calculo
     aAlfa = #nomvarca#16;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          aFechaBaja = aAlfa;
     |FINSI;

     |SI aFechaBaja = ""; |O aFechaBaja = "..........";
          nMes = nElMes;
          nAny = nElAny;
          |HAZ topemes_plb;
          aDia = nTopemes;
          aMes = nMes; aMes = ("00" + aMes) % -102;
          aAny = nElAny;
          aFechaBaja = aDia + "." + aMes + "." + aAny;
          swFechaBlanco = 1;
     |FINSI;

     fFechaBaja = aFechaBaja;
     nFechaBaja = fFechaBaja;

     nNume1 = nFechaBaja - nFechaAlta + 1;
     |SI nDiasAltaInt ! 0;
          nNume1 = nDiasAltaInt;
     |FINSI;
     |SI nNume1 > 7;
          |SI #labtraba#112 = "S";
               nIncid = 46;
               |HAZ graba_inc;
               nIncid = 47;
               |HAZ graba_inc;
          |FINSI;
     |FINSI;
|FPRC;

/********** DIAS TRABAJADOS DURANTE EL CONTRATO PARA INDEMNIZACION **********/

|PROCESO desglosa3;     || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
     alfa1 = fecalf %  102;   dia = alfa1;
     alfa1 = fecalf %  402;   mes = alfa1;
     alfa1 = fecalf % -104;   any = alfa1;
     |SI alfa1 = "....";
          dia = 0;
          mes = 0;
          any = 0;
     |FINSI;
|FPRC;

|PROCESO AvisoRedondeo;
     |SI swcalvacac = 1;      || al proceso dias_alta se accede tambien para
          |ACABA;             || el calculo de dias de vacaciones, aqui no
     |FINSI;                  || me interesa

     |SI aFechaFIN ! ""; || Sykes: theorical
          |ACABA;
     |FINSI;

     |AVISO;
     |PUSHV 09152166;
     |BLANCO 10162065;
     |CUADRO 10162065;
     |ATRI R;
     |PINTA 1118, "                A V I S O                     ";
     |ATRI 0;
     ||            1 2         3         4         5         6
     ||            8901234567890123456789012345678901234567890123
     |PINTA 1218, "Si se está calculando el finiquito"
     |ATRI I;
     |PINTA 1252, " por despido";
     |ATRI 0;
     |PINTA 1318, "(ya sea  improcedente o por causas objetivas),";
     |PINTA 1418, "se ha de redondear el período de tiempo traba-";
     |PINTA 1518, "jado ";
     |ATRI I;
     |PINTA 1523, "'prorrateándose por  meses completos  los";
     |PINTA 1618, "períodos  de tiempo inferiores  a un año' ";
     |ATRI 0;
     |PINTA 1660, "para";
     |PINTA 1718, "el cálculo  de la indemnización, según los ar-";
     |PINTA 1818, "tículos 53 y 56 del Estatuto de los Trabajado-";
     |PINTA 1918, "res.                                          ";
     |PAUSA;
     aAlfa = "    SPulse 'Si' si es una indemniz. ";
     aAlfa = aAlfa + "por despido (redondea a mes com- pleto) ";
     aAlfa = aAlfa + "o 'No' si es fin de contrato";
     |CONFI aAlfa;
     |SI FSalida = 0;
          swMesCompleto = 1;

          || se redondean a meses completos los periodos de tiempo inferiores
          || a un mes, es decir, con 2 meses y dos dias trabajados por ejemplo
          || se tienen en cuenta 3 meses
     |SINO;
          swMesCompleto = 0;

          || se calcula como toda la vida, se divide entre 365 el numero de
          || dias trabajados para saber los a¤os trabajados y punto
     |FINSI;
     |POPV;
|FPRC;

|PROCESO dias_alta;
     aFecha = #labtraba#36;          || en principio por fecha de alta como siempre
     |SI swcalindem = 1; |O swcalvacac = 1;
          alfa1 = #labtraba#34;     || fecha antiguedad
          alfa2 = #labtraba#36;     || fecha alta
          |QBF alfa1;
          |QBF alfa2;
          |SI alfa1 ! ""; |Y alfa2 ! ""; |Y alfa1 ! alfa2; |Y aFechaFIN = "";    || fecha alta distinta de fecha antiguedad
               |SI swcalindem = 1;
                    aAlfa = "    * Cálculo de INDEMNIZACIONES. "
               |FINSI;
               |SI swcalvacac = 1;
                    aAlfa = "    * Cálculo de VACACIONES. "
               |FINSI;
               aAlfa = aAlfa + "La fecha de antiguedad [" + alfa1;
               aAlfa = aAlfa + "] es distinta a la de alta [" + alfa2 + "].";
               |MENAV aAlfa;
               aAlfa = "    S" + &191 + "Desea usar la fecha de antiguedad para ";
               aAlfa = aAlfa + "el cálculo de días";
               |SI swcalindem = 1;
                    aAlfa = aAlfa + " en la indemnización?";
               |FINSI;
               |SI swcalvacac = 1;
                    aAlfa = aAlfa + " de vacaciones?";
               |FINSI;
               |CONFI aAlfa;
               |SI FSalida = 0;
                    aFecha = #labtraba#34;
               |FINSI;
          |FINSI;
          |SI aFechaFIN ! "";      || si esta cargada esta variable que viene
               aFecha = #labtraba#34;     || del calculo de finiq. desde el Theor. Liq.
          |FINSI;                  || de Sykes, siempre antiguedad
     |FINSI;

     fecsys = aFecha;         || fecha desde la que empezamos a contar dias
                              || la de alta o la de antiguedad segun se elija

     |SI swEnFiniq = 1;                 || si la fecha de alta es anterior al
          fech1 = aFecha;               || 1 de Enero del any que se calcula
          alfa1 = nElAny;               || el finiquito limito fecha de alta
          alfa1 = "01.01." + alfa1;     || al 1 de Enero del any de calculo
          fech2 = alfa1;
          |SI fech1 < fech2;
               fecsys = fech2;
               || nIncid = 7;
               || HAZ graba_inc;
          |SINO;
               fecsys = fech1;
          |FINSI;
     |FINSI;
     fecalf = fecsys;  |HAZ desglosa3;  nume1 = any;

     || por fin tengo fecsys, la fecha desde la que empiezo a contar dias

     || ahora fecsis, la fecha de fin de contrato, esta est  clara

     fecsis = fecbaj;  fecalf = fecsis;  |HAZ desglosa3;  nume2=any;

     || esto para pintarlo despues en el finiquito
     nAnysIndem = ((fecsis - fecsys + 1) / 365) ! 2;

     fFechaReforma = "11.02.2012";

     sw45y33 = 0;
     swSolo33 = 0;
     |SI indemni = 45;
     |Y swcalvacac = 0; || (no te metas en el dias_alta del calculo de vacac.)
          |SI fecsys [ fFechaReforma; |Y fecsis > fFechaReforma;
               || hago un primer calculo de 45 dias por a¤o trabajado hasta
               || la fecha de la reforma laboral
               fecsis = fFechaReforma;  fecalf = fecsis;  |HAZ desglosa3;  nume2=any;
               sw45y33 = 1;
          |SINO;
               || fecsis = fFechaReforma;
               fecalf = fecsis;  |HAZ desglosa3;  nume2=any;
               sw45y33 = 1;
               swSolo33 = 1;
               || solo tengo dias en la segunda parte, a partir del 12.02.2012
          |FINSI;
     |FINSI;

     |SI indemni = 45; |O indemni = 33; |O indemni = 20;
          swMesCompleto = 1;
     |SINO;
          || en los casos de 45, 33 y 30 es por meses completos, lo dice el ET
          || en el caso de 12 dias no es asi, no lo pregunto mas, lo dejo asi
          swMesCompleto = 0;
     |FINSI;
/*
     || no aviso mas de esto
     || 11.06.2018
     |SI indemni = 45; |O indemni = 33; |O indemni = 20;
          |HAZ AvisoRedondeo;
     |FINSI;
*/

/*
     || esto de los bisiestos lo quito, no tien mucho sentido, si voy a
     || dividir despues todos los dias entre 365 ya ves tu la tonteria
     || ademas de que el parametro del nomcontr dice claramente que es para
     || usarlo en el calculo de las pagas, no dice nada de finiquitos

     nume5 = 0;
     |SI nume1 [ 50; nume1 = nume1 + 2000; |FINSI;
     |PARA nume4 = nume1;|SI nume4 [ nume2; |HACIENDO nume4 = nume4 + 1;
          nume3 = nume4 $ 4;
          |SI any = nume4; |Y mes  > 2; nume3 = 1;                    |FINSI;
          |SI nElAny = nume4; |Y nElMes [ 2;  nume3 = 1;              |FINSI;
          |SI nume3 = 0; nume5 = nume5 + 1;     |FINSI;
     |SIGUE;
     nume0 = fecsis - fecsys;
     |SI nume5 ] nume0; nume5 = 0; |FINSI;
     nume0 = nume0 - nume5 + 1; || menos dias bisiestos + ambos inclusive
*/

     || SISTEMA ANTIGUO
     nume0 = fecsis - fecsys + 1;

     |SI sw45y33 = 1;
          || 45 dias por a¤o trabajado hasta el 11.02.2012

          duni1_902 = indemni;
          duni2_902 = (nume0 / 365) * indemni;

          || esto es la nueva manera de calcular los dias de indemnizacion
          || por meses, 16.12.2012, no es que sea nueva, es que no lo estabamos
          || haciendo como debiamos.

          |SI swMesCompleto = 1;
               |SI swSolo33 = 0;
                    aFechaAlta = fecsys;
                    aFechaBaja = fecsis;
                    |HAZ mesesAlta;
                    nMesesAlta = (nMesesAlta + 0.49) ! 0;
                    duni2_902 = (nMesesAlta / 12) * indemni;
               |SINO;
                    || si no, nada
                    || porque entonces es un caso de un trabajador que tiene
                    || en el 902 puestos 45 dias pero no fue alta antes del
                    || 12.02.2012
                    || va todo por 33 dias

                    || pongo a cero las unidades que llevara
                    duni2_902 = 0;
               |FINSI;
          |FINSI;

          || HASTA AQUI
          |SI duni2_902 < 720;
               || 33 dias por a¤o trabajado a partir del 12.02.2012
               || hasta un limite de 720 dias

               |SI swMesCompleto = 1;
                    |SI swSolo33 = 0;
                         || todo normal, finiquito de un trab. alta antes del
                         || 12.02.2012, con dias del alta antes y despues
                         || de esa p... fecha

                         nNume1 = fecsis;
                         nNume1 = nNume1 + 1;
                         fecsis = nNume1;
                         aFechaAlta = fecsis;
                         aFechaBaja = fecbaj;
                    |SINO;
                         || solo tiene que aplicar los 33 dias

                         fecsis = aFechaAlta;
                         nNume1 = fecsis;
                         || no sumo uno
                         fecsis = nNume1;
                         aFechaAlta = fecsis;
                         aFechaBaja = fecbaj;
                    |FINSI;

                    |HAZ mesesAlta;
                    nMesesAlta = (nMesesAlta + 0.49) ! 0;
                    duni2_902 = duni2_902 + ((nMesesAlta / 12) * 33);
                    || HASTA AQUI
               |SINO;
                    || SISTEMA ANTIGUO
                    fFechaBaja = fecbaj;          || fecbaj era alfa, mira tu
                    nume0 = fFechaBaja - fecsis;
                    nume0 = nume0 + 1;
                    duni2_902 = duni2_902 + (nume0 / 365) * 33;
               |FINSI;


               |SI duni2_902 > 720;
                    duni2_902 = 720;
               |FINSI;
          |SINO;
               |SI duni2_902 > 1260;
                    duni2_902 = 1260;
               |FINSI;
          |FINSI;
     |SINO;
          |SI swMesCompleto = 1;
               aFechaAlta = fecsys;
               aFechaBaja = fecsis;
               |HAZ mesesAlta;
               nMesesAlta = (nMesesAlta + 0.49) ! 0;
               duni2_902 = (nMesesAlta / 12) * indemni;
               duni1_902 = indemni;
               || para que tenga en cuenta el TOPE en CompruebaIndem en nomcalc1
               || HASTA AQUI
          |SINO;
               || SISTEMA ANTIGUO
               duni1_902 = indemni;
               duni2_902 = (nume0 / 365) * indemni;
          |FINSI;

          || despues se realiza el topeo, el el proceso CompruebaIndem
          || no se realiza si sw45y33 = 1;
     |FINSI;
     swcalindem = 0;
|FPRC;

|PROCESO BuscaConFV;
     |ABRE #4;
     #4#0 = #labtraba#87; #4#1 = #labtraba#17; #4#2 = concepto;
     |LEE 000#4=;
     |SI FSalida = 0;
          nImporFV = #4#4 / 30;
     |FINSI;
     |CIERRA #4;

     |ABRE #6;
     #6#0 = #labtraba#0;  #6#1 = #labtraba#1;  #6#2 = concepto;
     |LEE 000#6=;
     |SI FSalida = 0;
          nImporFV = #6#4 / 30;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #labtraba#0;  #8#1 = #labtraba#1;  #8#2 = nElMes;  #8#3 = 0;  #8#4 = concepto;
     |LEE 000#8=;
     |SI FSalida = 0;
          nImporFV = #8#6 / 30;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO calfinvac; || CALCULA EL FINIQUITO EN VACACIONES DEL CONVENIO
                    || DE LA CONSTRUCCION, SEGUN CONCEPTO INDICADO EN EL MISMO
     |SI runnom ! "nomcalfi";
          |ACABA;
     |FINSI;
     |SI #nomconca#148 ! 0;   || existe concepto
          nConcepFV = #nomconca#148;
          aDescripFV = #nomconca#149;
          |SI #labtraba#34 ! "..........";|Y #labtraba#34 ! "          ";      || fecha alta valida
               |SI fecbaj ! "..........";|Y fecbaj ! "          ";|| fecha baja valida
                    swEnFiniq = 1;
                    swcalindem = 1;
                    |HAZ dias_alta;
                    duni1_903 = vacacio;     || unidades finiquito vacaciones
                    nUnidFV = (nume0 / 365) * vacacio;
                    nUnidFV = nUnidFV - #labtraba#173;       || resta los disfrutados
                    swEnFiniq = 0;
                    swcalindem = 0;
               |FINSI;

               nTotFV = 0;
               |PARA nume1 = 152; |SI nume1 [ 156; |HACIENDO nume1 = nume1 + 1;
                    nImporFV = 0;
                    concepto = #nomconca#nume1#;
                    |SI concepto ! 102; |Y concepto ! 0;    || la antiguedad aparte
                         |HAZ BuscaConFV;
                    |FINSI;
                    nTotFV = nTotFV + nImporFV;
               |SIGUE;
               nImporFV = nTotFV;

               #nomcalli#0 = #labtraba#0;
               #nomcalli#1 = #labtraba#1;
               #nomcalli#2 = nElMes;
               #nomcalli#3 = 0;
               #nomcalli#4 = 102;
               |LEE 000#nomcalli.=;
               |SI FSalida = 0;
                    |SI #nomcalli#9 = 1;     || unidades = 1, mensual
                         nImporFV = nImporFV + (#nomcalli#10 / 30);
                    |SINO;
                         nImporFV = nImporFV + #nomcalli#10;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO diferenciaProm;
     || ya tengo la base en alta, ahora tengo que ver la base en IT
     || por la que he dejado de cotizar en la nomina "normal"

     || primero busco mes anterior
     || ¨en que periodo comenzo la IT?
     aAlfa = #labtraba#125;
     |QBF aAlfa;

     |ABRE #nomhicca;
     |SI aAlfa = "";     || se ve que ha empezado este mes
          #nomhicca#0 = #labtraba#0;
          #nomhicca#1 = #labtraba#1;
          #nomhicca#66 = nElAny - 2000;
          #nomhicca#2 = nElMes - 1;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=
     |SINO;
          aAlfa1 = aAlfa % 402;
          nNume1 = aAlfa1;
          aAlfa2 = aAlfa % -104;
          nNume2 = aAlfa2;

          #nomhicca#0 = #labtraba#0;
          #nomhicca#1 = #labtraba#1;
          #nomhicca#66 = nNume2 - 2000;
          #nomhicca#2 = nNume1 - 1;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=
     |FINSI;
     |SI FSalida = 0;
          nBaseTotal = #nomhicca#37 + #nomhicca#38;
     |FINSI;

     || promedio si no hubiera estado en pluriempleo
     nNume1 = nBaseTotal / 30; || por ejemplo, todos mensuales
     nNume1 = nNume1 ! 2;      || salgo del paso de momento

     || promedio utilizado en la nomina
     nNume2 = prom_enf;

     || dias cotizables de IT
     nNume3 = denfe_2 - swAjuste3;

     || base IT
     nDifPromPluri = nNume3 * (nNume1 - nNume2);
|FPRC;

|PROCESO BorraNompluba;
     |ABRE #nompluba;
     #nompluba#0 = #labtraba#0;
     #nompluba#1 = #labtraba#1;
     #nompluba#2 = nElAny;
     #nompluba#3 = nElMes;
     #nompluba#4 = 0;
     |LEE 101#nompluba.=;
     |SI FSalida = 0;
          |BORRA 020#nompluba.a;
     |FINSI;
     |LIBERA #nompluba;
     |CIERRA #nompluba;
|FPRC;

|PROCESO GrabaPluriempleo;
     |SI runnom = "nomcalir"; |ACABA; |FINSI;

     |ABRE #nompluba;
     #nompluba#0 = #labtraba#0;
     #nompluba#1 = #labtraba#1;
     #nompluba#2 = nElAny;
     #nompluba#3 = nElMes;
     #nompluba#4 = 0;
     |LEE 000#nompluba.=;
     FEstado = FSalida;

     #nompluba#5 = base_6p_com;
     #nompluba#6 = base_7p_des;
     #nompluba#7 = base_7p_fog;
     #nompluba#8 = base_7p_fp;

     |SI FEstado = 0;
          |GRABA 020#nompluba.a;
     |SINO;
          |GRABA 020#nompluba.n;
     |FINSI;

     |LIBERA #nompluba;
     |CIERRA #nompluba;
|FPRC;

|PROCESO CotizPluriTrab;
     dto_con = (base_6p_com_tra % bon_1); || cc
     dto_dfp = (base_7p_des_tra % #nomconst#13) ! 2; || desempleo
     dto_dfp = dto_dfp + ((base_7p_fp_tra % #nomconst#17) ! 2);  || fp
|FPRC;

|PROCESO CotizPluriCC;
      base_8 = base_8 + ((base_6p_com % por2_cont) ! 2); || cc
      nCuotaEmpCC = (base_6p_com % #nomconst#6) ! 2;
      |HAZ GrabaPluriempleo;
|FPRC;

|PROCESO CotizPluriCP;
     nCuotaEmpDes = (base_7p_des % #nomconst#12) ! 2; || desempleo
     base_8 = base_8 + nCuotaEmpDes;
     nCuotaEmpFog = (base_7p_fog % #nomconst#14) ! 2; || fogasa
     base_8 = base_8 + nCuotaEmpFog;
     nCuotaEmpFP = (base_7p_fp % #nomconst#16) ! 2;  || FP
     base_8 = base_8 + nCuotaEmpFP;
     |HAZ GrabaPluriempleo;
|FPRC;

|PROCESO PluriempleoCC;
     coti_0p = 0;
     coti_1p = 0;

     |SI runnom = "nomcalir"; |ACABA; |FINSI;

     |SI #labtraba#237 ! "S";
          |HAZ BorraNompluba;
          |ACABA;
     |FINSI;

     |SI base_6p_com ! 0; |Y #labtraba#97 ! 4;
          || para que no entre dos veces, si ya ha estado
          || en ajustes liquido tiene que entrar las veces que haga falta
          |ACABA;
     |FINSI;

     |ABRE #nompluri;
     #nompluri#0 = #labtraba#0;
     #nompluri#1 = #labtraba#1;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          nDifPromPluri = 0;
          |SI denfe_2 ! 0;
               || tengo IT, movida
               |HAZ diferenciaProm;
          |FINSI;

          || COMUNES

          |SI nTopeMax [ 30;
               nNume = nTopeMax;
          |SINO;
               nNume = 30;
          |FINSI;
          coti_0 = coti_0 / nNume; coti_1 = coti_1 / nNume;

          coti_0p = (coti_0 % #nompluri#3) ! 2; || minimo C.C.
          coti_1p = (coti_1 % #nompluri#3) ! 2; || maximo C.C.

          coti_0p = coti_0p * nNume;
          coti_1p = coti_1p * nNume;
          coti_0 = coti_0p; coti_1 = coti_1p;

          base_6p_com = base_6 + nDifPromPluri;

          |SI coti_0p ] base_6;
               base_6p_com = coti_0p;
               |SI denfe_2 ! 0; prom_enf = coti_0p / nNume; |FINSI;
          |FINSI;
          |SI coti_1p [ base_6;
               base_6p_com = coti_1p;
               |SI denfe_2 ! 0; prom_enf = coti_1p / nNume; |FINSI;
          |FINSI;

          base_6p_com_tra = base_6p_com;

          |HAZ ExaminaIT;

          |SI dmate_2 ! 0;
               |SI aTipUltimaIT = "M";
                    base_6p_com_tra = base_6p_com_tra - coba_4 + (swAjuste3 * prom_enf);
               |SINO;
                    base_6p_com_tra = base_6p_com_tra - coba_4;
               |FINSI;
               |SI base_6p_com_tra < 0;
                    base_6p_com_tra = 0;
               |FINSI;
          |FINSI;

          |SI #nompluri#3 ! 0;
          /*
               |Y propo = 0;
               || para que se pueda dejar a cero en el trabajador
               || si se quiere
          */
               propo = #nompluri#3;
          |FINSI;
     |SINO;
          |HAZ BorraNompluba;
     |FINSI;
     |CIERRA #nompluri;
|FPRC;

|PROCESO PluriempleoCP;
     coti_0p = 0;
     coti_1p = 0;

     |SI runnom = "nomcalir"; |ACABA; |FINSI;

     |SI #labtraba#237 ! "S";
          |ACABA;
     |FINSI;

     |SI base_7p_des ! 0; |O base_7p_fog ! 0; |O base_7p_fp ! 0;
          |SI #labtraba#97 ! 4;
               || para que no entre dos veces, si ya ha estado
               || en ajustes liquido tiene que entrar las veces que haga falta
               |ACABA;
          |FINSI;
     |FINSI;

     |ABRE #nompluri;
     #nompluri#0 = #labtraba#0;
     #nompluri#1 = #labtraba#1;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          nDifPromPluri = 0;
          |SI denfe_2 ! 0;
               || tengo IT, movida
               |HAZ diferenciaProm;
          |FINSI;

          || DESEMPLEO

          |SI nTopeMax [ 30;
               nNume = nTopeMax;
          |SINO;
               nNume = 30;
          |FINSI;
          coti_0 = coti_0 / nNume; coti_1 = coti_1 / nNume;

          coti_0p = (coti_0 % #nompluri#4) ! 2; || minimo C.C.
          coti_1p = (coti_1 % #nompluri#4) ! 2; || maximo C.C.

          coti_0p = coti_0p * nNume;
          coti_1p = coti_1p * nNume;
          coti_0 = coti_0 * nNume; coti_1 = coti_1 * nNume;

          base_7p_des = base_7 + nDifPromPluri;
          |SI base_7 ] coti_0p;
                base_7p_des = coti_0p;
          |FINSI;

          |SI base_7 [ coti_1p;
               base_7p_des = coti_1p;
          |FINSI;

          |SI #nompluri#4 ! 0;
               propo = #nompluri#4;
          |FINSI;

          || FOGASA

          |SI nTopeMax [ 30;
               nNume = nTopeMax;
          |SINO;
               nNume = 30;
          |FINSI;
          coti_0 = coti_0 / nNume; coti_1 = coti_1 / nNume;

          coti_0p = (coti_0 % #nompluri#5) ! 2; || minimo C.C.
          coti_1p = (coti_1 % #nompluri#5) ! 2; || maximo C.C.
          coti_0 = coti_0 * nNume; coti_1 = coti_1 * nNume;

          coti_0p = coti_0p * nNume;
          coti_1p = coti_1p * nNume;

          base_7p_fog = base_7 + nDifPromPluri;

          |SI base_7 ] coti_0p;
               base_7p_fog = coti_0p;
               |SI denfe_2 ! 0; prom_acc = coti_0p / nNume; |FINSI;
          |FINSI;

          |SI base_7 [ coti_1p;
               base_7p_fog = coti_1p;
               |SI denfe_2 ! 0; prom_acc = coti_1p / nNume; |FINSI;
          |FINSI;

          || FP

          |SI nTopeMax [ 30;
               nNume = nTopeMax;
          |SINO;
               nNume = 30;
          |FINSI;
          coti_0 = coti_0 / nNume; coti_1 = coti_1 / nNume;

          coti_0p = (coti_0 % #nompluri#6) ! 2; || minimo C.C.
          coti_1p = (coti_1 % #nompluri#6) ! 2; || maximo C.C.

          coti_0p = coti_0p * nNume;
          coti_1p = coti_1p * nNume;

          || aqui para que ya vuelvan calculados los nuevos topes
          coti_0 = coti_0p; coti_1 = coti_1p;

          base_7p_fp = base_7 + nDifPromPluri;

          |SI base_7 ] coti_0p;
                base_7p_fp = coti_0p;
          |FINSI;

          |SI base_7 [ coti_1p;
               base_7p_fp = coti_1p;
          |FINSI;
          |SI #nompluri#6 ! 0;
               propo = #nompluri#6;
          |FINSI;

          |HAZ ExaminaIT;

          base_7p_des_tra = base_7p_des;
          base_7p_fp_tra = base_7p_fp;
          base_7p_fog_tra = base_7p_fog;

          |SI dmate_2 ! 0;
               |SI aTipUltimaIT = "M";
                    base_7p_des_tra = base_7p_des - cobb_4 + (swAjuste3 * prom_enf);
                    base_7p_fp_tra = base_7p_fp - cobb_4 + (swAjuste3 * prom_enf);
                    base_7p_fog_tra = base_7p_fog - cobb_4 + (swAjuste3 * prom_enf);
               |SINO;
                    base_7p_des_tra = base_7p_des - cobb_4;
                    base_7p_fp_tra = base_7p_fp - cobb_4;
                    base_7p_fog_tra = base_7p_fog - cobb_4;
               |FINSI;
               |SI base_7p_des_tra < 0; base_7p_des_tra = 0; |FINSI;
               |SI base_7p_fp_tra < 0; base_7p_fp_tra = 0; |FINSI;
               |SI base_7p_fog_tra < 0; base_7p_fog_tra = 0; |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nompluri;
|FPRC;

/****************************************************************************/
/*************** OTROS PROCESOS QUE NO CABEN EN LOS incluyes ****************/
/****************************************************************************/

|PROCESO nomtraju;
     swNoEntra = 0;

     |ABRE #nomtraju;
     #nomtraju#0 = #labtraba#0;
     #nomtraju#1 = #labtraba#1;
     #nomtraju#2 = #nomcalli#4;
     |LEE 000#nomtraju.=;
     |SI FSalida = 0;
          swNoEntra = 1;
     |FINSI;

     |CIERRA #nomtraju;
|FPRC;

|PROCESO firstdia;           || calcula el dia de la semana del 01.01.XXXX
     alfa1 = nElAny;
     alfa1 = "01.01." + alfa1;
     fech4 = alfa1;
     fech4 = fech4 % 1;
     alfa1 = fech4 % 11;
     |QBF alfa1;
     |SI alfa1 = "Lunes";     semana1 = 2;   |FINSI;
     |SI alfa1 = "Martes";    semana1 = 3;   |FINSI;
     |SI alfa1 = "Miercoles"; semana1 = 4;   |FINSI;
     |SI alfa1 = "Jueves";    semana1 = 5;   |FINSI;
     |SI alfa1 = "Viernes";   semana1 = 6;   |FINSI;
     |SI alfa1 = "Sabado";    semana1 = 7;   |FINSI;
     |SI alfa1 = "Domingo";   semana1 = 8;   |FINSI;
|FPRC;

|PROCESO rellena;      || rellena de ceros campos numericos ('tipos')
    alfa1 = nume1;  alfa1 = "00" + nume1;  alfa1 = alfa1 % -102;
    alfa2 = nume2;
    nume1 = mesact;
    nume2 = anyact;

    alfa1 = alfa1 + "." + alfa2;
|FPRC;

|PROCESO tipos; |TIPO 0;      || construye fechas vencimiento para antiguedad
     mesact = nElMes;
     anyact = nElAny;
     aFechaCongAnt = "";
     |HAZ BuscaModulo;
     |SI swModulo = 002537; |O swModulo = 1;
          |HAZ CongelaAntiguedad;
          |QBF aFechaCongAnt;
          |SI aFechaCongAnt ! ".........."; |Y aFechaCongAnt ! "";
               aAlfa = aFechaCongAnt % 402;
               mesact = aAlfa;
               aAlfa = aFechaCongAnt % -104;
               anyact = aAlfa;
          |FINSI;
     |FINSI;

     nume1 = mesact;
     nume2 = anyact;
     |HAZ rellena;
     tipo1 = alfa1;                 || mes actual

     nume1 = nume1 - 1;
     |SI nume1 = 0;
          nume1 = 12;
          nume2 = nume2 - 1;
     |FINSI;
     |HAZ rellena;
     tipo2 = alfa1;                 || mes siguiente

     |SI mesact [  3;|Y mesact ] 1;  nume1 =  3;  |FINSI;
     |SI mesact [  6;|Y mesact ] 3;  nume1 =  6;  |FINSI;
     |SI mesact [  9;|Y mesact ] 6;  nume1 =  9;  |FINSI;
     |SI mesact [ 12;|Y mesact ] 9;  nume1 = 12;  |FINSI;
     |HAZ rellena;
     tipo3 = alfa1;                 || trimestre actual

     |SI mesact [  3;|Y mesact ] 1;  nume1 =  12;  nume2 = nume2 - 1;  |FINSI;
     |SI mesact [  6;|Y mesact ] 3;  nume1 =   3;                      |FINSI;
     |SI mesact [  9;|Y mesact ] 6;  nume1 =   6;                      |FINSI;
     |SI mesact [ 12;|Y mesact ] 9;  nume1 =   9;                      |FINSI;
     |HAZ rellena;
     tipo4 = alfa1;                 || trimestre siguiente

     |SI mesact [  6;|Y mesact ] 1;  nume1 =  6;  |FINSI;
     |SI mesact [ 12;|Y mesact ] 6;  nume1 = 12;  |FINSI;
     |HAZ rellena;
     tipo5 = alfa1;                  || semestre actual

     |SI mesact [  6;|Y mesact ] 1;  nume1 = 12;  nume2 = nume2 - 1;  |FINSI;
     |SI mesact [ 12;|Y mesact ] 6;  nume1 =  6;                      |FINSI;
     |HAZ rellena;
     tipo6 = alfa1;                  || semestre siguiente

     nume1 = 12;
     |HAZ rellena;
     tipo7 = alfa1;                  || a¤o actual

     nume1 = 12;
     nume2 = nume2 - 1;
     |HAZ rellena;
     tipo8 = alfa1;                  || a¤o siguiente
|FPRC;

|PROCESO AytoFuncNueATEP;
     |ABRE #nomnotan;
     #nomnotan#0 = #labtraba#0;
     #nomnotan#1 = #labtraba#77;
     |LEE 000#nomnotan.=;
     |SI FSalida = 0;
          epig_ilt = #nomnotan#4;
          epig_ims = #nomnotan#5;
     |FINSI;
     |CIERRA #nomnotan;
|FPRC;

|PROCESO AytoFuncNueExcl;
     |ABRE #nomnotan;
     #nomnotan#0 = #labtraba#0;
     #nomnotan#1 = #labtraba#77;
     |LEE 000#nomnotan.=;
     |SI FSalida = 0;
          dto_exc_emp = (((base_6 % por2_cont) ! 2) % #nomnotan#2) ! 2;
          dto_exc_tra = (((base_6 % por1_cont) ! 2) % #nomnotan#3) ! 2;

          base_E = base_E - dto_exc_emp;
          dto_con = dto_con - dto_exc_tra;
     |FINSI;
     |CIERRA #nomnotan;
|FPRC;

|PROCESO Varios1;
     |HAZ VerificaDatosIRPF;
     |SI #labtraba#42 = "H"; |HAZ VerificaAutonomo; |FINSI;
     |HAZ AytoFuncNueATEP;
|FPRC;

|PROCESO JubilacionParcial;
     swSigue = 0;
     |ABRE #labclean;
     #labclean#0 = "labtraba";
     #labclean#1 = 135;
     |LEE 000#labclean.=;
     |SI FSalida = 0;
          swSigue = 1;
     |FINSI;
     |CIERRA #labclean;

     |SI #labtraba#135 = "S"; |Y swSigue = 1;
          nPropJub = 50 + ((nElAny - 2013) * 5)
          nNume1 = base_6 - (base_5 - coba_4) - nImporteComp;
          nNume2 = base_7 - (base_5 - cobb_4) - nImporteComp;

          nNume1 = nNume1 / tp;
          nNume2 = nNume2 / tp;

          nNume1 = nNume1 + nImporteComp;
          nNume2 = nNume2 + nImporteComp;

          nNume1 = nNume1 % nPropJub;
          nNume2 = nNume2 % nPropJub;

          propo = nPropJub;

          base_6 = nNume1 + (base_5 - coba_4);
          base_7 = nNume2 + (base_5 - coba_4);

          nNume6 = base_6 + coba_4;     || base total Cot (inc. ctrol IT)
          nNume7 = base_7 + coba_4;

          nNume = #labtraba#220 % nPropJub;
          nNume = nNume * dcofi_2;
          |SI nNume6 < nNume;
               base_6 = nNume;
          |FINSI;
          |SI nNume7 < nNume;
               base_7 = nNume;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MaximosCP;
     swSigue = 1;   || para todo el mundo, de una vez, 06.02.2016

     |SI es_parcial = 1;      || de momento no para los trabajadores a tp
     |O #labtraba#42 = "I";          || irregulares (como artistas) no
          swSigue = 0;        || pero esto hay que hacerlo
     |FINSI;

     || solo cuando haya IT
     nDiasCotIT = denfe_2 + dacci_2 + dmate_2;
     nDiasCotIT = nDiasCotIT - swAjuste3;
     |SI nDiasCotIT [ 0;
          swSigue = 0;
     |FINSI;

     nNume = hcoti_0;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
           || en citricos me quedo con las jornadas
          nNume = dia_2 - swAjuste3;   || en hcoti_0, lo cual jode esta funcion
     |FINSI;

     |SI swSigue = 1;
          nMaxAlta = (#nomconst#campomax# * (nNume - nDiasCotIT)) ! 2;
          nBaseAlta = base_7 - base_5;
          |SI nMaxAlta < 0; nMaxAlta = 0; |FINSI;
          |SI nMaxAlta < nBaseAlta; |Y nBaseAlta > 0.05;
               swApliMax = 1;
               base_7 = nMaxAlta + base_5;   ||/se normaliza despues de comparar
               |SI #labtraba#42 ! "I";      swajuen = 1;   |FINSI;
               aCPTopeadas = "M";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MaximosCC;
     swSigue = 1;   || para todo el mundo, de una vez, 06.02.2016

     |SI es_parcial = 1;      || de momento no para los trabajadores a tp
     |O #labtraba#42 = "I";          || irregulares (como artistas) no
          swSigue = 0;        || pero esto hay que hacerlo
     |FINSI;

     || solo cuando haya IT
     nDiasCotIT = denfe_2 + dacci_2 + dmate_2;
     nDiasCotIT = nDiasCotIT - swAjuste3;
     |SI nDiasCotIT [ 0;
          swSigue = 0;
     |FINSI;

     nNume = hcoti_0;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          || en citricos me quedo con las jornadas
          nNume = dia_2 - swAjuste3;   || en hcoti_0, lo cual jode esta funcion
     |FINSI;

     |SI swSigue = 1;
          nMaxAlta = (#nomconst#campomax# * (nNume - nDiasCotIT)) ! 2;
          nBaseAlta = base_6 - base_5cc;
          |SI nMaxAlta < 0; nMaxAlta = 0; |FINSI;

          |SI nMaxAlta < nBaseAlta; |Y nBaseAlta > 0.05;
               swApliMax = 1;
               base_6 = nMaxAlta + base_5;   ||/se normaliza despues de comparar
               |SI #labtraba#42 ! "I";      swajuen = 1;   |FINSI;
               aCCTopeadas = "M";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MinimosCC;
     swSigue = 1;
     |SI es_parcial = 1;
     |O #labtraba#248 = 509;
     |O #labtraba#42 = "I";          || irregulares (como artistas) no
                              || de momento no para los trabajadores a tp
          swSigue = 0;        || pero esto hay que hacerlo
     |FINSI;
     |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
          swSigue = 0;
     |FINSI;

     coti_0 = coti_0 ! 2;
     base_6 = base_6 ! 2;
     nNume1 = denfe_2 + dacci_2 + dmate_2 - swAjuste3;
     |SI swSigue = 1; |Y nNume1 > 0;
          nNume2 = nTopeMin - nNume1;
          nMinAlta = (#nomconst#campomin# * nNume2) ! 2;
          nBaseAlta = base_6 - base_5;
          |SI nMinAlta < 0; nMinAlta = 0; |FINSI;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI nNume2 ! 0; |Y nBaseAlta = 0;
                    || es posible que haya citricos que no tengan nada en la
                    || base de alta, pero tengan que cotizar por esos dias
                    || dias cotizables sin jornada (que no son de inactividad)
                    || lo soluciono asi
                    nBaseAlta = 0.06;
               |FINSI;
          |FINSI;

          |SI nMinAlta > nBaseAlta; |Y nBaseAlta > 0.05;
               swApliMin = 1;
               base_6 = nMinAlta + base_5;   ||/se normaliza despues de comparar
               |SI #labtraba#42 ! "I";      swajuen = 1;   |FINSI;
               aCCTopeadas = "m";
          |FINSI;
     |SINO;
          |SI coti_0 > base_6;       || en los irregulares "I" la base minima
               swApliMin = 1;
               base_6 = coti_0;   ||/se normaliza despues de comparar
               |SI #labtraba#42 ! "I";      swajuen = 1;   |FINSI;
               aCCTopeadas = "m";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MinimosCP;
     swSigue = 1;
     |SI es_parcial = 1;
     |O swFijoDisc = 1;
     |O #labtraba#248 = 509;
     |O #labtraba#42 = "I";          || irregulares (como artistas) no
                              || de momento no para los trabajadores a tp
          swSigue = 0;        || pero esto hay que hacerlo
     |FINSI;
     |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
          swSigue = 0;
     |FINSI;

     nNume1 = denfe_2 + dacci_2 + dmate_2 - swAjuste3;
     |SI swSigue = 1; |Y nNume1 > 0;
          |SI #labtraba#42 = "D";       || diario, mas de un segmento por dia
               nTopeMin = hcoti_0;      || natural tengo que topear por dias
          |FINSI;                       || sin el maximo de 30
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #labtraba#33 ] 08;   || lo mismo para citricos
                    nTopeMin = hcoti_0;
               |FINSI;
               |SI nElMes = 2;
                    |SI nNume1 = 28; |O nNume1 = 29;
                         || febrero todo el mes de IT
                         nNume1 = 30;
                    |FINSI;
               |FINSI;
          |FINSI;
          nNume2 = nTopeMin - nNume1;
          nMinAlta = (#nomconst#campomin# * nNume2) ! 2;
          nBaseAlta = base_7  - base_5;
          |SI nMinAlta < 0; nMinAlta = 0; |FINSI;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI nNume2 ! 0; |Y nBaseAlta = 0;
                    || es posible que haya citricos que no tengan nada en la
                    || base de alta, pero tengan que cotizar por esos dias
                    || dias cotizables sin jornada (que no son de inactividad)
                    || lo soluciono asi
                    nBaseAlta = 0.06;
               |FINSI;
          |FINSI;

          |SI nMinAlta > nBaseAlta; |Y nBaseAlta > 0.05;
               base_7 = nMinAlta + base_5;
               |SI #labtraba#42 ! "I";      swajuac = 1;   |FINSI;
               aCPTopeadas = "m";
          |FINSI;
     |SINO;
          |SI base_7 < coti_1;           || en los irregulares "I" la base minima
               base_7 = coti_1;       ||/se normaliza despues de comparar
               |SI #labtraba#42 ! "I";      swajuac = 1;   |FINSI;
               aCPTopeadas = "m";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ExaminaIT;
     nDiasEnfNat = 0; nDiasEnfCot = 0;
     nDiasAccNat = 0; nDiasAccCot = 0;
     nDiasMatNat = 0; nDiasMatCot = 0;
     nDiasPatNat = 0; nDiasPatCot = 0;
     nDiasDesCot = 0; nDiasDesNat = 0;
     |PARA nCampo1 = 12; |SI nCampo1 [ 15; |HACIENDO nCampo1 = nCampo1 + 1;
          nCampo2 = nCampo1 - 8;
          nCampo3 = nCampo1 - 4;
          aTipo = #nomvarca#nCampo1#;
          |QBF aTipo;
          |SI aTipo ! "";
               nDesde = #nomvarca#nCampo2#;
               nHasta = #nomvarca#nCampo3#;

               |SI nDesde = 0; nDesde = 1; |FINSI;
               |SI nHasta = 0; nHasta = nTopemes; |FINSI;

               nNume = nHasta - nDesde + 1;

               |SI aTipo = "E";
                    nDiasEnfNat = nDiasEnfNat + nNume;
                    nDiasEnfCot = nDiasEnfNat;
               |FINSI;
               |SI aTipo = "A";
                    nDiasAccNat = nDiasAccNat + nNume;
                    nDiasAccCot = nDiasAccNat;
               |FINSI;
               |SI aTipo = "M";
                    nDiasMatNat = nDiasMatNat + nNume;
                    nDiasMatCot = nDiasMatNat;
               |FINSI;
               |SI aTipo = "P";
                    nDiasPatNat = nDiasPatNat + nNume;
                    nDiasPatCot = nDiasPatNat;
               |FINSI;
               |SI aTipo = "D";
                    nDiasDesNat = nDiasDesNat + nNume;
                    nDiasDesCot = nDiasDesNat;
               |FINSI;

               nLinUltimaIT = nCampo1 - 11;
               aTipUltimaIT = aTipo;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DiasPeriodo;
     aAlfa2 = nMes; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nAny;

     aAlfa1 = "01";
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaIniPer = aAlfa;

     |HAZ topemes_plb;
     aAlfa1 = nTopemes;
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaFinPer = aAlfa;

     aAlfa = #labtraba#36
     fFechaAlta = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaBaja = #labtraba#37;
     |SINO;
          fFechaBaja = "31.12.2999";
     |FINSI;

     aAlfa = #nomvarca#16;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaBaja = #nomvarca#16;
     |FINSI;

     swPerCompleto = 1;
     |SI fFechaAlta > fFechaIniPer;
          fFechaIniPer = fFechaAlta;
          swPerCompleto = 0;
     |FINSI;
     |SI fFechaBaja < fFechaFinPer;
          fFechaFinPer = fFechaBaja;
          swPerCompleto = 0;
     |FINSI;

     nDiasNatAlta = fFechaFinPer - fFechaIniPer + 1;
|FPRC;

|PROCESO Dias;
     || este proceso es un intento, al fin, de tener en variables los dias
     || tanto naturales como cotizables de alta y de cada tipo de IT
     || asi como las bases

     nDiasPerNat = 0;
     nDiasPerCot = 0;

     nDiasAltaNat = 0;
     nDiasITNat = 0;
     nDiasEnfNat = 0;
     nDiasAccNat = 0;
     nDiasMatNat = 0;
     nDiasPatNat = 0;

     nDiasAltaCot = 0;
     nDiasITCot = 0;
     nDiasEnfCot = 0;
     nDiasAccCot = 0;
     nDiasMatCot = 0;
     nDiasPatCot = 0;

     nBaseCCAlta = 0; nBaseCPAlta = 0;
     nBaseCCIT = 0;   nBaseCPIT = 0;
     nBaseCCEnf = 0;  nBaseCPEnf = 0;
     nBaseCCAcc = 0;  nBaseCPAcc = 0;
     nBaseCCMat = 0;  nBaseCPMat = 0;
     nBaseCCPat = 0;  nBaseCPPat = 0;

     nDiasAjuste = 0;
     nDiasAjusteAlta = 0;
     nDiasAjusteIT = 0;
     nLinUltimaIT = 0;
     aTipUltimaIT = "";
     swPerCompleto = 1;

     nMes = nElMes;
     nAny = nElAny;
     |HAZ DiasPeriodo;

     || Dias Naturales comprendidos en el Periodo
     nDiasPerNat = fFechaFinPer - fFechaIniPer + 1;
     nDiasPerCot = nDiasPerNat;    || de moemento cotizables = naturales

     |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
          |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5;
          |O nElMes = 7; |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
               |SI swPerCompleto = 1;
                    || ajuste (1 en mes de 31 dias, -2 febrero, -1 febrero 29 dias)
                    nDiasAjuste = nDiasPerNat - 30;

                    || ajusto ya los dias del periodo cotizables
                    nDiasPerCot = nDiasPerNat - nDiasAjuste;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ ExaminaIT;

     nDiasITNat = nDiasEnfNat + nDiasAccNat + nDiasMatNat + nDiasPatNat;
     nDiasAltaNat = nDiasPerNat - nDiasITNat;

     || de momento igualo cotizables a naturales, ahora vere los ajustes

     nDiasAltaCot = nDiasAltaNat;
     nDiasITCot = nDiasITNat;

     |SI nDiasITNat = 0;
          || si no hay IT, ajusto en los cotizables de alta, claro
          nDiasAltaCot = nDiasAltaCot - nDiasAjuste;
     |SINO;
          || si hay IT

          |SI #nomcontr#17 = 1; |O #nomcontr#17 = 3;
               || parametro a 1 o a 3, ajusto en los dias de IT
               nDiasITCot = nDiasITCot - nDiasAjuste;

               || me la guardo aqui, para quitarselo a la ultima IT
               nDiasAjusteIT = nDiasAjuste;
          |SINO;
               || parametro a 2, ajusto en los dias de alta
               nDiasAltaCot = nDiasAltaCot - nDiasAjuste;
          |FINSI;
     |FINSI;

     |SI aTipUltimaIT = "E";
          nDiasEnfCot = nDiasEnfCot - nDiasAjusteIT;
     |FINSI;
     |SI aTipUltimaIT = "A";
          nDiasAccCot = nDiasAccCot - nDiasAjusteIT;
     |FINSI;
     |SI aTipUltimaIT = "M";
          nDiasMatCot = nDiasMatCot - nDiasAjusteIT;
     |FINSI;
     |SI aTipUltimaIT = "P";
          nDiasPatCot = nDiasPatCot - nDiasAjusteIT;
     |FINSI;

     || AHORA A CALCULAR LAS BASE DE COTIZACION

     || ALTA

     nBaseCCAlta = base_6;
     nBaseCPAlta = base_7;

     || ENFERMEDAD

     nBaseCCEnf = nDiasEnfCot * prom_enf;
     nBaseCPEnf = nDiasEnfCot * prom_acc;

     || ACCIDENTE

     nBaseCCAcc = nDiasAccCot * prom_enf;
     nBaseCPAcc = nDiasAccCot * prom_acc;

     || MATERNIDAD

     nBaseCCMat = nDiasMatCot * prom_enf;
     nBaseCPMat = nDiasMatCot * prom_acc;

     || PATERNIDAD

     nBaseCCPat = nDiasPatCot * prom_enf;
     nBaseCPPat = nDiasPatCot * prom_acc;

     nBaseCCIT = nBaseCCEnf + nBaseCCAcc + nBaseCCMat + nBaseCCPat;
     nBaseCPIT = nBaseCPEnf + nBaseCPAcc + nBaseCPMat + nBaseCPPat;

     nBaseCCAlta = nBaseCCAlta - nBaseCCIT;
     nBaseCPAlta = nBaseCPAlta - nBaseCPIT;

     || (la maternidad no la quito, ya que no forma parte de base_6 ni base_7)
|FPRC;

|PROCESO CambioTramoBon;
     aAlfa = fFechaIniBon % -104;
     nNume = aAlfa;
     nNume = nNume + (#nombonif#14 / 12);
     aAlfa = nNume;
     aFechaCambioBon = (aFechaIniBon % 106) + aAlfa;
     fFechaCambioBon = aFechaCambioBon;
|FPRC;

|PROCESO TramoBon;
     |SI fFechaCambioBon > fFechaFinBon;
          || la fecha del cambio de tramo no es este mes
          swTramoBon = 1;
     |FINSI;

     |SI fFechaIniBon [ fFechaCambioBon;
     |Y fFechaCambioBon [ fFechaFinBon;
          || la fecha del cambio de tramo es este mes !!!
          swTramoBon = 12;
     |FINSI;

     |SI fFechaCambioBon [ fFechaIniBon;
          || estoy en el segundo tramo !!!
          swTramoBon = 2;
     |FINSI;
|FPRC;

|PROCESO calboni_taripla;
     nCuotaCC = 0;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |SI tp ] 0.75;
               nCuotaCC = 75;
          |FINSI;
          |SI tp ] 0.50; |Y tp < 0.75;
               nCuotaCC = 50;
          |FINSI;
          |SI tp < 0.50;
               nCuotaCC = 0;
          |FINSI;
     |SINO;
          nCuotaCC = 100;
     |FINSI;

     || dia_2 son los dias naturales en alta del mes
     || topemes los dias que tiene el mes, como siempre

     swTramoBon = 0;
     nMesesBon = 0;
     fFechaIniBon = #labtraba#40;
     aFechaIniBon = #labtraba#40;
     aFechaFinBon = #labtraba#41;
     |QBF aFechaFinBon;
     |SI aFechaFinBon ! ""; |Y aFechaFinBon ! "..........";
          aFechaFinBon = #labtraba#41;
          fFechaFinBon = aFechaFinBon;
     |SINO;
          |PARA nCampo = 14; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 1;
               nMesesBon = nMesesBon + #nombonif#nCampo#;
          |SIGUE;
          nAnysBon = nMesesBon / 12;
          aAlfa = aFechaIniBon % -104;
          nNume = aAlfa;
          nNume = nNume + nAnysBon;
          aAlfa = nNume;
          aFechaFinBon = (aFechaIniBon % 106) + aAlfa;
          fFechaFinBon = aFechaFinBon;
          nNume = fFechaFinBon;
          nNume = nNume - 1;
          fFechaFinBon = nNume;
     |FINSI;

     |SI #nombonif#15 ! 0;
          |HAZ CambioTramoBon;
     |FINSI;

     || comprobaciones
     alfa1 = "01";
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     |SI fFechaIniBon [ fFecha;
          fFechaIniBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaIniBon = fFechaIniBon;
          |FINSI;
     |FINSI;

     anynum = nAny;
     mesnum = nMes;
     |HAZ ulti_dia;

     alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     fFechaCal = fFecha;
     |SI fFechaFinBon ] fFecha;
          fFechaFinBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaFinBon = fFechaFinBon;
          |FINSI;
     |FINSI;
     aAlfa = #nomvarca#16;
     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          fFecha = aAlfa;
     |SINO;
          aAlfa = #labtraba#37;
          |SI aAlfa ! "          "; |Y aAlfa ! "..........";
               fFecha = aAlfa;
          |FINSI;
     |FINSI;

     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          |SI fFecha [ fFechaFinBon;
               fFechaFinBon = fFecha;
          |FINSI;
     |FINSI;

     fFechaAlta = #labtraba#36;         || esto para que si he copiado la
     |SI fFechaAlta ] fFechaIniBon;     || ficha del trabajador, la bonifica-
          fFechaIniBon = fFechaAlta;    || cion se aplique a partir de la fecha
     |FINSI;                            || de alta del trabajador, y no de la
                                        || de inicio de la bonif.

     || esto para saber en que tramo estoy
     swTramoBon = 0;
     |SI #nombonif#15 ! 0;
          |HAZ TramoBon;
     |FINSI;

     nume1 = fFechaIniBon;
     nume2 = fFechaFinBon;
     nDiasBon = nume2 - nume1 + 1;
     |SI nDiasBon [ 0;
          |ACABA;
     |FINSI;

     swSigue = 0;
     |SI nDiasBon < topemes;  || si no estoy de alta el mes completo
          swSigue = 1;        || tengo que proporcionar
     |FINSI;
     |SI nDiasBon = 30; |Y topemes = 31;
          || salvo en meses de 31 dias si estoy de alta 30 mensuales
          || y diarios 2884.2631
          |SI #nomcontr#18 ! 2;
               swSigue = 0;
          |SINO;
               || aunque tenga el "2" en el parametro, pero si es un mensual
               || en en mes de 31 dias con 30 de bonificacion, no tiene que
               || proporcionar, lo dejo asi 15.09.2015 - 779.622
               |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasMesTrab = 0;
     |SI nDiasBon < topemes;
     |Y #nomcontr#18 ! 2;     || no si el parametro esta a manual

                              || si no estoy de alta el mes completo
          |HAZ OtrasAltas;    || busco si tengo otro trabajador que me
     |FINSI;                  || complete el mes, para distribuir la bonif.

     |SI nDiasMesTrab > 0;
          swSigue = 0;    || no he de proporcionar de momento
     |FINSI;

     |SI nElMes = 2; |Y dbaja_3 = topemes;
          |SI nDiasBon < dcoti_0;
               nNume = dcoti_0 - nDiasBon;
               |SI nNume = 1; |O nNume = 2;
                    || mes de febrero normal o bisiesto
                    nDiasBon = nDiasBon + nNume;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swTramoBon = 12; |O swTramoBon = 2;
          swSigue = 1;
     |FINSI;

    |SI swSigue = 1;
          |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
               |SI #nomcontr#18 = 2;
               |Y dbaja_3 = topemes; || pq. si no estoy el mes completo de alta
                                     || el tipo "2" cuenta los dias reales
                    |SI nElMes = 1; |O nElMes = 3; |O nElMes = 5; |O nElMes = 7;
                    |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
                         nDiasBon = nDiasBon - 1;
                    |FINSI;
                    |SI nElMes = 2;
                         nDiasBon = nDiasBon + 2 - bisiesto;
                    |FINSI;
               |FINSI;
          |FINSI;

          nCuotaCC = (nCuotaCC / 30) ! 2;
          |SI nDiasBon > dcoti_0; |Y nCuantos > 1;
               nDiasBon = dcoti_0;
          |FINSI;

          |SI #labtraba#39 = 501; |O #labtraba#39 = 502;
               |SI nDiasBon ! dcoti_0;
                    nPorBon1 = nDiasBon;
               |FINSI;
          |FINSI;

          |SI swTramoBon = 12; |O swTramoBon = 2;
               |SI nDiasBon > dcoti_0;
                    nDiasBon = dcoti_0;
               |FINSI;
          |FINSI;
          |SI swTramoBon = 12;
               nNume1 = fFechaIniBon;
               nNume2 = fFechaCambioBon;
               nDiasTramo1 = nNume2 - nNume1;
               nDiasTramo2 = nDiasBon - nDiasTramo1;
               nDiasBon = nDiasTramo1;
               bon_0 = ((base_6 / dcoti_0) * nDiasBon) ! 2;
               bon_3 = bon_0
               nPorBon1 = nDiasTramo1;
          |FINSI;
          |SI swTramoBon = 2;
               nDiasTramo1 = 0;
               nDiasTramo2 = nDiasBon;
               nCuotaCC = 0;
          |FINSI;

          nCuotaCC = nCuotaCC * nDiasBon;

          |SI swTramoBon = 12; |Y nDiasBon = 30
               || eso es porque si la bonificacion acaba justo el dia 30
               || de un mes de 31 dias, al no estar el mes entero va y
               || intenta proporcionar, pero no tiene por qu al estar
               || los 30 primeros dias en el primer tramo. Si lo hace,
               || hace 30 * 3.33 = 99,90, en lugar de 100 euros
               || lo soluciono asi en principio 98.4004 trab 1115.10

               nCuotaCC = nCuotaCC ! 0;
          |FINSI;
     |SINO;
          nCuotaCC = nCuotaCC;

          nNume = nDiasMesTrab + nDiasBon;
          |SI nDiasMesTrab ! 0; |Y nNume = topemes;
               nCuotaCC = nCuotaCC - (nDiasMesTrab * ((nCuotaCC / 30) ! 2));
          |FINSI;
     |FINSI;

     |SI nCuotaCC ! 0;
          nBoni500 = ((bon_0 % #nomconst#6) ! 2) - nCuotaCC;

          || N U E V O
/*
          || no se por que me complique la vida con esto
          || paso

          |SI swTramoBon ! 12; |Y swTramoBon ! 2;
               |HAZ Dias;

               |SI base_5 ! 0;
                    nCuotaCCDia = ((nCuotaCC / 30) ! 2);
                    |SI nDiasAltaCot > 0; |Y nDiasITCot > 0;
                         nNume1 = ((nBaseCCAlta % #nomconst#6) ! 2) - (nDiasAltaCot * nCuotaCCDia);
                         nCuotaCCIT = nCuotaCC - (nDiasAltaCot * nCuotaCCDia);
                         nNume2 = ((nBaseCCIT % #nomconst#6) ! 2) - nCuotaCCIT;

                         nBoni500 = nNume1 + nNume2;
                    |SINO;
                         nBoni500 = ((bon_0 % #nomconst#6) ! 2) - nCuotaCC;
                    |FINSI;
               |FINSI;
          |FINSI;
*/
          base_A = nBoni500;
          base_AB = base_A;
          base_F = bon_0;
     |FINSI;
     |SI swTramoBon = 12; |O swTramoBon = 2;
          |SI swTramoBon = 12;
               base_F = nCuotaCC;

               || ahora el tramo 2:

               zbon_0 = (base_6 - bon_0);
               zbon_3 = zbon_0;
               nPorBon2 = nDiasTramo2;
               nNume = ((((zbon_0 % #nomconst#6) ! 2)) % 50) ! 2;
               zbase_F = nNume;
               zbase_A = zbase_F;
               zbase_AB = zbase_A;
          |FINSI;
          |SI swTramoBon = 2;
               zbon_0 = ((base_6 / dcoti_0) * nDiasBon) ! 2;
               zbon_3 = zbon_0;

               nNume = ((((zbon_0 % #nomconst#6) ! 2)) % 50) ! 2;
               zbase_F = nNume;
               nPorBon2 = nDiasTramo2;

               zbase_A = zbase_F;
               zbase_AB = zbase_A;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/*PROCESO QUE CREA UN AUXILIAR DE LAS FICHAS POR NIF ORDENADO POR FECHA ALTA*/
/****************************************************************************/

|PROCESO coptraba;
     aAlfa = #labtraba#36;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          #200#4 = #labtraba#36;   || fecha alta
     |SINO;
          #200#4 = "00.00.0000";
     |FINSI;
     #200#0 = #labtraba#0;    || empresa
     #200#1 = #labtraba#1;    || trabajador
     #200#2 = #labtraba#2;    || nombre
     #200#3 = #labtraba#7;    || nif
     #200#5 = #labtraba#37;   || fecha baja
     #200#20 = #labtraba#42;  || clave de cotizacion
     #200#21 = #labtraba#129; || situacion especial
     #200#22 = #labtraba#234; || jornada
     |GRABA 020#200n;
|FPRC;

|DEFBUCLE coptraba;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, coptraba;
|FIN;

|PROCESO HistoricoTrab;
     |SALVA_FICHA #labtraba;
     aAlfa = Usuario;  |QBF aAlfa;    aAlfa = aAlfa + "_nomtrnom";
     |NOME_DAT #200 aAlfa;         || tmp contador de trabajadores
     |DELINDEX #200;   || Se carga el temporal que pudiera existir
     |ABRE #200;
     aNif = #labtraba#7;
     |BUCLE coptraba;
     |CIERRA #200;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO GuardaLegalBon;
     |HAZ HistoricoTrab;
     |ABRE #200;
     |LEE 000#200u;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #200#21 ! "G";
               || es el primer trabajador que no tiene guarda legal
               || yendo atras en el tiempo asi que este es del que
               || tengo que coger la jornada

               nCuotaCC = #nombonif#39;
               |SI swTramoBon = 2;
                    nCuotaCC = #nombonif#40;
               |FINSI;
               |SI #200#20 = "X"; |O #200#20 = "T";
                    nCuotaCC = nCuotaCC * ((#200#22 / 40) ! 3);
                    nCuotaCC = nCuotaCC ! 2;
               |FINSI;
               |SAL;
          |FINSI;
          |LEE 000#200a;
     |SIGUE;
     |CIERRA #200;
     |DELINDEX #200;   || Se carga el temporal que pudiera existir
|FPRC;

/****************************************************************************/
/*** BONIFICACIONES DEL RDL 01/2015 - EXENCION DE 500 EUROS DE BASE DE CC ***/
/****************************************************************************/

|PROCESO calboni_500;
     |SI #labtraba#42 = "T"; |O #labtraba#42 = "D";
          swDiario = 1; swMensual = 0;
     |SINO;
          swDiario = 0; swMensual = 1;
     |FINSI;

     swSigue = 0;
     |SI nElAny ] 2015;
          |SI nElAny = 2015;
               |SI nElMes ] 5;
                    swSigue = 1;
               |FINSI;
          |SINO;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;
     nCuotaCC = #nombonif#39;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |SI tp ] 0.50;
               nNume = tp ! 3;
               nCuotaCC = nCuotaCC * nNume;
          |SINO;
               nCuotaCC = 0;
          |FINSI;
     |SINO;
          nCuotaCC = nCuotaCC;
     |FINSI;

     swTramoBon = 0;

     |SI #labtraba#129 = "G"; || guarda legal, bonif completa aunque sea TP
          |HAZ GuardaLegalBon;
     |FINSI;

     nMesesBon = 0;
     fFechaIniBon = #labtraba#40;
     aFechaIniBon = #labtraba#40;
     aFechaFinBon = #labtraba#41;
     |QBF aFechaFinBon;
     |SI aFechaFinBon ! ""; |Y aFechaFinBon ! "..........";
          aFechaFinBon = #labtraba#41;
          fFechaFinBon = aFechaFinBon;
     |SINO;
          |PARA nCampo = 14; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 1;
               nMesesBon = nMesesBon + #nombonif#nCampo#;
          |SIGUE;
          nAnysBon = nMesesBon / 12;
          aAlfa = aFechaIniBon % -104;
          nNume = aAlfa;
          nNume = nNume + nAnysBon;
          aAlfa = nNume;
          aFechaFinBon = (aFechaIniBon % 106) + aAlfa;
          fFechaFinBon = aFechaFinBon;
          nNume = fFechaFinBon;
          nNume = nNume - 1;
          fFechaFinBon = nNume;
     |FINSI;

     |SI #nombonif#15 ! 0;
          |HAZ CambioTramoBon;
     |FINSI;

     || hasta aqui

     || comprobaciones
     alfa1 = "01";
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     |SI fFechaIniBon [ fFecha;
          fFechaIniBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaIniBon = fFechaIniBon;
          |FINSI;
     |FINSI;

     anynum = nAny;
     mesnum = nMes;
     |HAZ ulti_dia;

     alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     fFechaCal = fFecha;
     |SI fFechaFinBon ] fFecha;
          fFechaFinBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaFinBon = fFechaFinBon;
          |FINSI;
     |FINSI;
     aAlfa = #nomvarca#16;
     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          fFecha = aAlfa;
     |SINO;
          aAlfa = #labtraba#37;
          |SI aAlfa ! "          "; |Y aAlfa ! "..........";
               fFecha = aAlfa;
          |FINSI;
     |FINSI;

     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          |SI fFecha [ fFechaFinBon;
               fFechaFinBon = fFecha;
          |FINSI;
     |FINSI;

     fFechaAlta = #labtraba#36;         || esto para que si he copiado la
     |SI fFechaAlta ] fFechaIniBon;     || ficha del trabajador, la bonifica-
          fFechaIniBon = fFechaAlta;    || cion se aplique a partir de la fecha
     |FINSI;                            || de alta del trabajador, y no de la
                                        || de inicio de la bonif.

     || esto para saber en que tramo estoy
     swTramoBon = 0;
     |SI #nombonif#15 ! 0;
          |HAZ TramoBon;
     |FINSI;

     nume1 = fFechaIniBon;
     nume2 = fFechaFinBon;
     nDiasBon = nume2 - nume1 + 1;
     |SI nDiasBon [ 0;
          |ACABA;
     |FINSI;

     swProp = 0;
     |SI nDiasBon < topemes;  || si no estoy de alta el mes completo
          swProp = 1;        || tengo que proporcionar
     |FINSI;
     |SI nDiasBon = 30; |Y topemes = 31;
          swProp = 0;
     |FINSI;

     nDiasMesTrab = 0;
     |SI nDiasBon < topemes;
                                   || si no estoy de alta el mes completo
               |HAZ OtrasAltas;    || busco si tengo otro trabajador que me
     |FINSI;

     |HAZ Dias;

     |SI fFechaIniBon [ fFechaIniPer; |Y fFechaFinBon ] fFechaFinPer;
          || sin duda, me bonifico todo el mes, pase lo que pase
          |SI nDiasBon < dcoti_0; |Y nElMes = 2; |Y swSigue = 1;
               || esto lo hago para que jamas, si tengo todos los dias bonificados
               || me bonifique menos dias de lo que toca
               || a ver, lo dejo de moemento solo para febrero, por si acaso
               || si hace falta otro mes, liberar

               nDiasBon = dcoti_0;
          |FINSI;
     |FINSI;

     |SI nDiasMesTrab > 0;
          swProp = 0;    || no he de proporcionar de momento
          || aunque no este de alta el mes completo
          || ya que he trabajado el mes completo entre las fichas que tenga
     |FINSI;


     swSigue = 0;
     |SI swTramoBon = 12; |O swTramoBon = 2;
          swSigue = 1;
     |FINSI;

     |SI swSigue = 1;
          |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
               |SI #nomcontr#18 = 2;
               |Y dbaja_3 = topemes; || pq. si no estoy el mes completo de alta
                                     || el tipo "2" cuenta los dias reales
                    |SI nElMes = 1; |O nElMes = 3; |O nElMes = 5; |O nElMes = 7;
                    |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
                         nDiasBon = nDiasBon - 1;
                    |FINSI;
                    |SI nElMes = 2;
                         nDiasBon = nDiasBon + 2 - bisiesto;
                    |FINSI;
               |FINSI;
          |FINSI;

          nCuotaCC = (nCuotaCC / 30) ! 2;
          |SI nDiasBon > dcoti_0; |Y nCuantos > 1;
               nDiasBon = dcoti_0;
          |FINSI;

          |SI #labtraba#39 = 501; |O #labtraba#39 = 502;
               |SI nDiasBon ! dcoti_0;
                    nPorBon1 = nDiasBon;
               |FINSI;
          |FINSI;

          |SI swTramoBon = 12; |O swTramoBon = 2;
               |SI nDiasBon > dcoti_0;
                    nDiasBon = dcoti_0;
               |FINSI;
          |FINSI;
          |SI swTramoBon = 12;
               nNume1 = fFechaIniBon;
               nNume2 = fFechaCambioBon;
               nDiasTramo1 = nNume2 - nNume1;
               nDiasTramo2 = nDiasBon - nDiasTramo1;
               nDiasBon = nDiasTramo1;

               nBaseBon500 = nCuotaCC * nDiasBon;
               nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;
          |FINSI;
          |SI swTramoBon = 2;
               nDiasTramo1 = 0;
               nDiasTramo2 = nDiasBon;
               nCuotaCC = 0;
          |FINSI;

          || nCuotaCC = nCuotaCC * nDiasBon;

          |SI swTramoBon = 12; |Y nDiasBon = 30
               || eso es porque si la bonificacion acaba justo el dia 30
               || de un mes de 31 dias, al no estar el mes entero va y
               || intenta proporcionar, pero no tiene por qu al estar
               || los 30 primeros dias en el primer tramo. Si lo hace,
               || hace 30 * 3.33 = 99,90, en lugar de 100 euros
               || lo soluciono asi en principio 98.4004 trab 1115.10

               nCuotaCC = nCuotaCC ! 0;
          |FINSI;
     |SINO;
          |SI swProp = 1;
               nBaseBon500 = nCuotaCC;
               nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;
               nCuotaCC = (nCuotaCC / 30);
               |SI nDiasBon > dcoti_0; |Y nCuantos > 1; |Y swCambiaCot = 0;
                    nDiasBon = dcoti_0;
               |FINSI;
               nCuotaCC = nCuotaCC * nDiasBon;
          |SINO;
               nBaseBon500 = nCuotaCC;

               nNume = nDiasMesTrab + nDiasBon;
               |SI nDiasMesTrab ! 0; |Y nNume = topemes;
                    nBaseBon500 = nBaseBon500 - (nDiasMesTrab * ((nBaseBon500 / 30) ! 2));
               |FINSI;
               nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;
          |FINSI;
     |FINSI;

     |SI nCuotaCC ! 0; |O swTramoBon = 2;
          bon_0 = nBaseBon500;
          base_A = nCuotaCC;
          base_AB = base_A;
          base_F = bon_0;
          |SI swTramoBon = 1; |Y swProp = 1;
               bon_0 = nBaseBon500 * (nDiasBon / dcoti_0);
          |FINSI;
          |SI swTramoBon = 12;
               nPorBon1 = nDiasTramo1;
               base_F = nCuotaCC;

               || ahora el tramo 2:
               nCuotaCC = #nombonif#40;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |SI tp ] 0.50;
                         nNume = tp ! 3;
                         nCuotaCC = nCuotaCC * nNume;
                    |SINO;
                         nCuotaCC = 0;
                    |FINSI;
               |FINSI;
               nCuotaCC = nCuotaCC / 30;

               nDiasBon = nDiasTramo2;
               nBaseBon500 = nCuotaCC * nDiasBon;
               nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;

               || zbon_0 = #nombonif#40 * (nDiasTramo2 / (nDiasTramo1 + nDiasTramo2));
               || zbon_0 = zbon_0 ! 2;
               zbon_0 = nBaseBon500;
               zbon_3 = zbon_0;
               nPorBon2 = nDiasTramo2;
               nNume = nCuotaCC;
               zbase_F = nNume;
               zbase_A = zbase_F;
               zbase_AB = zbase_A;
          |FINSI;
          |SI swTramoBon = 2;
               |SI nDiasBon > 0; nDiasBon = nDiasTramo2; |FINSI;
               nDiasBon = nDiasTramo2;

               nCuotaCC = #nombonif#40;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |SI tp ] 0.50;
                         nNume = tp ! 3;
                         nCuotaCC = nCuotaCC * nNume;
                    |SINO;
                         nCuotaCC = 0;
                    |FINSI;
               |FINSI;

               |SI #labtraba#129 = "G"; || guarda legal, bonif completa aunque sea TP
                    |HAZ GuardaLegalBon;
               |FINSI;

               |SI swProp = 1;
                    nCuotaCC = nCuotaCC / 30;
                    nBaseBon500 = nCuotaCC * nDiasBon;
                    nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;
                    zbon_0 = nBaseBon500;
               |SINO;
                    nCuotaCC = nCuotaCC;
                    nBaseBon500 = nCuotaCC;
                    nCuotaCC = (nBaseBon500 % #nomconst#6) ! 2;
                    zbon_0 = nBaseBon500;
               |FINSI;
               zbon_0 = zbon_0 ! 2;
               zbon_3 = zbon_0;
               nPorBon2 = nDiasTramo2;
               nNume = nCuotaCC;
               zbase_F = nNume;
               zbase_A = zbase_F;
               zbase_AB = zbase_A;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**** PROCESOS PARA BUSCAR OTRO TRABAJADOR DE ALTA EN EL MISMO MES **********/
/****************************************************************************/

|PROCESO BuscaTrabAnt;
     swAntFicha = 0;     || es la ficha anterior de este mismo trabajador

     |SI nEmp ! #labtraba#0;
          |ACABA;
     |FINSI;

     |SI nBonif ! #labtraba#39;    || evidentemente, tiene que tener la bonif.
                                   || tambien
          |ACABA;
     |FINSI;
     |SI aTipoCot ! #labtraba#42; |O nJornada ! #labtraba#234;
                    || tambien mismo tipo de cotizacion, si no, si cambia
                    || de TP a TC o al reves, se lia. De paso, tambien la misma jornada
          |ACABA;
     |FINSI;
     |SI nEmp ! #labtraba#0; |O nTra ! #labtraba#1;  || 1. no es trab. actual
          |SI aFechaBajaBusca = #labtraba#37;
               swAntFicha = 1;     || es la ficha en que el trabajador inicial
               fFechaBaja = aFechaBajaBusca;
          |FINSI;

          aAlfa = "";
          |ABRE #nomvarca;
          #nomvarca#0 = #labtraba#0;
          #nomvarca#1 = #labtraba#1;
          #nomvarca#2 = nElMes;
          #nomvarca#3 = 0;
          |LEE 000#nomvarca.=;
          |SI FSalida = 0;
               aAlfa = #nomvarca#16;
               |QBF aAlfa;
          |FINSI;
          |SI aAlfa ! ""; |Y aAlfa ! "..........";
               |SI aFechaBajaBusca = aAlfa;
                    swAntFicha = 1;     || es la ficha en que el trabajador inicial
                    fFechaBaja = aFechaBajaBusca;
               |FINSI;
          |FINSI;
          |CIERRA #nomvarca;
     |FINSI;

     |SI swAntFicha = 0;
          |ACABA;
     |FINSI;

     alfa1 = "01";
     alfa2 = nElMes;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech4 = alfa4;      || primer dia del mes que calculo

     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     alfa5 = nTopemes;
     alfa5 = alfa5 + "." + alfa2 + "." + alfa3;   || ultimo dia del mes que calculo
     fech5 = alfa5;

     fFechaAlta = #labtraba#36;
     |SI fFechaBaja ] fech4; |Y fFechaAlta [ fech5;
          || el trabajador tiene dias de alta durante el mes de calculo
     |SINO;
          || si no, no me interesa
          swAntFicha = 0;
     |FINSI;

     |SI swAntFicha = 1;     || es la ficha en que el trabajador inicial
          aFechaAlta = #labtraba#36;
          |QBF aFechaAlta;
          fFechaAlta = aFechaAlta;      || fecha alta trabajador encontrado
          |SI fFechaAlta > fech4;
               fech4 = fFechaAlta;
          |FINSI;
          nume4 = fech4;
          nume5 = fFechaBaja;
          nDiasMesTrab = (nume5 - nume4 + 1);
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTrabAnt;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaTrabAnt;
|FIN;

|PROCESO OtrasAltas;
     nDiasMesTrab = 0;

     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     aNif = #labtraba#7;
     fFechaAlta = #labtraba#36;
     nFechaAlta = fFechaAlta;
     nFechaAlta = nFechaAlta - 1;
     fFechaBajaBusca = nFechaAlta;
     aFechaBajaBusca = fFechaBajaBusca;
     nBonif = #labtraba#39;
     aTipoCot = #labtraba#42;
     nJornada = #labtraba#234;

     |SALVA_FICHA #labtraba;
     |SALVA_FICHA #nomvarca;

     |BUCLE BuscaTrabAnt;

     |REPON_FICHA #nomvarca;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO NuevoAjuste;
     |ABRE #cretam00; |LEE 000#cretam00.p; |CIERRA #cretam00;
     |SI #cretam00#1 ! "S";
          |ACABA;
     |FINSI;
     |SI swCambiaCot = 1;
          |ACABA;
     |FINSI;

     swNuevoAju = 0;
     |SI dalta_3 = 1; |Y dbaja_3 = topemes;
          |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
               |SI nElMes ! 4; |Y nElMes ! 6; |Y nElMes ! 9; |Y nElMes ! 11;
                    |SI nElMes ! 2;
                         swNuevoAju = 1;
                    |SINO;
                         swNuevoAju = -2 + bisiesto;
                    |FINSI;
                    swAjuste3 = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     dias_v = dias_v - swNuevoAju;
|FPRC;

|PROCESO BuscaMasDe4_2;
     |SI #500#6 ] nDiaHastaIT;
          |SI #500#6 > nDiaHastaIT;
               aTipoAjusteIT = #500#7;
               swAjusteIT = #500#5;     || me sirve esto como linea
               nDiaHastaIT = #500#6;
          |FINSI;
          |SI #500#6 = nDiaHastaIT;
               || dos ITs que acaban el mismo dia
               || solo puede ser un ERE a TP

               aTipoAjusteIT2 = #500#7;
               swAjusteIT2 = #500#5;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaMasDe4_2;
     #500#1006;
     ;
     #labtraba#0, #labtraba#1, nElMes, 0, 0000, 00;
     #labtraba#0, #labtraba#1, nElMes, 0, 0000, 31;
     ;
     NULL, BuscaMasDe4_2;
|FIN;

|PROCESO MasDe4_2;
     aDef = "nomvarcb";

     |HAZ carga_def_500;
     |BUCLE BuscaMasDe4_2;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO AjusteIT;
     || proceso para ver de que tramo de cotizacion del mes hago en ajuste
     || en los mensuales

     || de momento lo usare solo en los ERE si tenemos activado el CRETA

     swNuevoAju = 0;
     swAjusteIT = 0;
     swAjusteIT2 = 0;
     aTipoAjusteIT = "";
     aTipoAjusteIT2 = "";

     |ABRE #cretam00; |LEE 000#cretam00.p; |CIERRA #cretam00;
     |SI #cretam00#1 ! "S";
          |ACABA;
     |FINSI;

     |SI dalta_3 = 1; |Y dbaja_3 = topemes; |Y #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          swAjusteDes = 1;
     |FINSI;

     |SI swAjuste3 ! 0; |O swAjusteDes = 1;
          || tengo ajuste

          swAjusteIT = 0;
          nDiaHastaIT = 0;
          |PARA nCampo1 = 12; |SI nCampo1 [ 15; |HACIENDO nCampo1 = nCampo1 + 1;
               nCampo2 = nCampo1 - 8;
               nCampo3 = nCampo1 - 4;
               nCampo4 = nCampo1 + 35;

               aAlfa = #nomvarca#nCampo1#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    |SI #nomvarca#nCampo3# ] nDiaHastaIT;
                    |O #nomvarca#nCampo3# = 0;
                         |SI #nomvarca#nCampo3# > nDiaHastaIT;
                              aTipoAjusteIT = aAlfa;
                              swAjusteIT = nCampo1 - 11;
                              nDiaHastaIT = #nomvarca#nCampo3#;
                         |FINSI;
                         |SI #nomvarca#nCampo3# = nDiaHastaIT;
                              || dos ITs que acaban el mismo dia
                              || solo puede ser un ERE a TP

                              aTipoAjusteIT2 = aAlfa;
                              swAjusteIT2 = nCampo1 - 11;
                         |FINSI;
                         |SI #nomvarca#nCampo3# = 0;
                         |Y nDiaHastaIT = topemes;
                              || lo mismo
                              aTipoAjusteIT2 = aAlfa;
                              swAjusteIT2 = nCampo1 - 11;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |HAZ MasDe4_2;
     |FINSI;
|FPRC;

/****************************************************************************/

/****************************************************************************/
/***************  PROCESO PARA BUSCAR LAS HORAS A TIEMPO PARCIAL ************/
/****************************************************************************/

|PROCESO BuscaRegHoras;
     nHorasRegTP = nHorasRegTP + #nomcal04#6 + #nomcal04#7;
|FPRC;

|DEFBUCLE BuscaRegHoras;
     #nomcal04#1;
     ;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 01;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 31;
     ;
     NULL, BuscaRegHoras;
|FIN;

|PROCESO BuscaRegTP;
     enHorasTC2 = 0;
     enHorasTP = 0;
     enHorasTeor = 0;
     nHorasRegTP = 0;
     |SI #labtraba#42 = "P";
          |BUCLE BuscaRegHoras;

          #nomconli#0 = #labtraba#87;
          #nomconli#2 = 101;
          |LEE 000#nomconli.=;
          |SI FSalida = 0; |Y #nomconli#3 = "H";
               enMes = nElMes;
               enAny = nElAny;
               |HAZ CompAltaTrab_plb;

               |SI #labtraba#42 = "P";
                    |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5;
                    |O nElMes = 7;  |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
                         |SI enDiasAlta = topemes;
                              enDiasAlta = 30;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI nHorasRegTP = 0;
                    nIncid = 56;
                    |HAZ graba_inc;
               |FINSI;

               nNume = 0;
               |ABRE #nomhortp;
               #nomhortp#0 = #labtraba#0;
               #nomhortp#1 = #labtraba#1;
               |LEE 000#nomhortp.=;
               |SI FSalida = 0;
                    |PARA nCampo = 2; |SI nCampo [ 32; |HACIENDO nCampo = nCampo + 5;
                         enHorasTeor = enHorasTeor + #nomhortp#nCampo#;
                         |SI #nomhortp#nCampo# ! 0;
                              nNume = nNume + 1;
                         |FINSI;
                    |SIGUE;
                    enHorasTeor = enHorasTeor / nNume;
               |FINSI;
               |CIERRA #nomhortp;
/*
                    enHorasTC2 = (enHorasTP / nNume) ! 2;

                    |SI enHorasTP = 0;
                         enHorasTC2 = (nHorasRegTP / enDiasAlta) ! 2;
                         enHorasTP = enHorasTC2 * 5;
                    |FINSI;
               |SINO;
                    enHorasTC2 = (nHorasRegTP / enDiasAlta) ! 2;
                    enHorasTP = enHorasTC2 * 5;
               |FINSI;
               |CIERRA #nomhortp;
*/

               || nos basamos solo en las horas que tengamos en el Registro
               || de Horas a Tiempo Parcial

               enHorasTC2 = (nHorasRegTP / enDiasAlta);
               |SI enDiasAlta ] 7;
                    enHorasTP = enHorasTC2 * 7;
               |SINO;
                    enHorasTP = enHorasTC2 * 5;
               |FINSI;

               #labtraba#234 = enHorasTP;
               #labtraba#47 = enHorasTC2;
               |GRABA 020#labtraba.a;
               |LIBERA #labtraba;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PROCESO PARA BUSCAR EL CCC DEL CENTRO DEL TRAB. ************/
/****************************************************************************/

|PROCESO CCC;
     aCCC = #labempre#15;
     |QBF aCCC;

     |ABRE #labcentr;
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida = 0;
          aAlfa = #labcentr#10;
          |QBF aAlfa;
          |SI aAlfa ! "";
               aCCC = aAlfa;
          |FINSI;
     |FINSI;
     |CIERRA #labcentr;

     |SI #labtraba#45 = 421; |O #labtraba#45 = 422;
          |ABRE #nomcenes;
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = "87";
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aAlfa = #nomcenes#10;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;
               |FINSI;
          |SINO;
/*
               nIncid = 63;
               |HAZ graba_inc;
               nIncid = 64;
               |HAZ graba_inc;
*/
          |FINSI;
          |CIERRA #nomcenes;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA BUSCAR EL ORIGEN DEL CONTROL IT **************/
/****************************************************************************/

|PROCESO OrigenControlIT;
     aTipoOrigen = "";
     aAlfa = #nomvarca#51; |QBF aAlfa;
     |SI aAlfa = "";
          aAlfa = #labtraba#133; |QBF aAlfa;
     |FINSI;
     aAlfa = aAlfa % 101;
     |SI aAlfa = "E";
          aTipoOrigen = "E";
     |FINSI;
     |SI aAlfa = "A";
          aTipoOrigen = "A";
     |FINSI;
|FPRC;

|PROCESO PrimeraControlIT;
     swPrimera = 1;
     |SI aTipoOrigen = "E";
          aAlfa = #nomvarca#51 % 201;
          |SI aAlfa = " ";
               aAlfa = #labtraba#133 % 201;
          |FINSI;
     |FINSI;
     |SI aAlfa = "1"; swPrimera = 1; |FINSI;
     |SI aAlfa = "R"; swPrimera = 0; |FINSI;
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA BUSCAR EL CODIGO DE POBLACION ****************/
/****************************************************************************/

|PROCESO BuscaPob;
     nCodPob = #labmunic#1;
|FPRC;

|DEFBUCLE BuscaPob;
     #labmunic#4;
     ;
     aCodPostal;
     aCodPostal;
     ;
     NULL, BuscaPob;
|FIN;

|PROCESO Autonomia;
     #101#0 = nProvincia;
     #101#1 = nPoblacion;
     |LEE 000#101=;
     |SI FSalida = 0;
          nAut = #101#4;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA la ANTIGUEDAD CONVENIO SIDEROMETALURGIA ******/
/****************************************************************************/

|PROCESO AntigSidero;
     nLimiteAnys = 0;

     nMesDe = enMes + 1;
     nAnyDe = enAny;
     |SI nMesDe > 12;
         nMesDe = 1;
         nAnyDe = enAny + 1;
     |FINSI;

     aAlfa = "01." + (("00" + nMesDe) % -102) + "." + nAnyDe;
     fFec3 = aAlfa;
     nDias = fFec3;
     nDias = nDias - 1;

     fFec1 = #labtraba#34;
     fFec2 = "16.04.2014";
     fFec3 = nDias;

     nDias   = fFec3 - fFec1;
     nDias   = nDias - 1;
     nQuinAc = (nDias / 365) / 5;
     |SI nQuinAc [ 2;
         nQuinAc     = (nQuinAc - .50) ! 0;

         nLimiteAnys = nQuinAc * 5;
         |SI nLimiteAnys > 10;
             nLimiteAnys = 10;
         |FINSI;
     |SINO;
         nDias   = fFec2 - fFec1;
         nDias   = nDias - 1;
         nQuinVi = (nDias / 365) / 5;
         |SI nQuinVi > 2;
             nQuinAc     = (nQuinVi - .50) ! 0;
             nQuinAc     = nQuinAc + 1;
             nLimiteAnys = nQuinAc * 5;
         |SINO;
             nQuinAc     = (nQuinAc - .50) ! 0;
             nLimiteAnys = nQuinAc * 5;
             |SI nLimiteAnys > 10;
                 nLimiteAnys = 10;
             |FINSI;
         |FINSI;
     |FINSI;

/*
     |SI fanti_m < 7;
          ganti_d = 01;
          ganti_m = 01;
          ganti_a = 2014;
     |FINSI;
     |SI fanti_m > 6;
          ganti_d = 01;
          ganti_m = 01;
          ganti_a = 2015;
     |FINSI;

     difer_d = ganti_d - fanti_d;    || diferencia meses
     difer_m = ganti_m - fanti_m;    || diferencia meses
     difer_a = ganti_a - fanti_a;    || diferencia anyos

     ||SI difer_d < 0;  difer_m = difer_m - 1;  |FINSI;
     |SI difer_m < 0;  difer_a = difer_a - 1;  |FINSI;
     |SI difer_a < 0;  difer_a = 0;            |FINSI;

     || estos son los a¤os de antiguedad que tenia el 16 de abril de 2014
     || que es cuando empezo la nueva norma

     nNume = difer_a;

     swSigue = 0;

     |SI nNume < 10;
          swSigue = 1;
     |FINSI;
     |SI nNume = 10; |Y difer_m = 0;
          swSigue = 1;
     |FINSI;

     |SI swSigue = 1;
          nLimiteAnys = 10;
     |SINO;
          aAlfa = nNume;
          |QBF aAlfa;
          aAlfa1 = aAlfa % 101;
          aAlfa2 = aAlfa % 201;
          nNume1 = aAlfa1;
          nNume2 = aAlfa2;
          |SI nNume2 ] 5;
               nNume1 = nNume1 + 1;
               nNume2 = 0;
          |SINO;
               nNume1 = nNume1;
               nNume2 = 5;
          |FINSI;

          nLimiteAnys = (nNume1 * 10) + nNume2;
     |FINSI;
*/
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA GRABAR LA SS A CARGO DE LA EMPRESA ***********/
/****************************************************************************/

|PROCESO SS_Empresa;
     |SI #labtraba#45 = "085"; |O #labtraba#45 = "421"; |O #labtraba#45 = "422";
          |SI runnom = "nomcalfi";      || finiquitos formacion, no grabes
               |ACABA;                  || las cuotas SS empresa hasta que
          |FINSI;                       || no sepamos los dias
          #nomcalca#173 = #nomconst#82;      || Comunes
          |SI #labtraba#45 ! "422";
               |SI #labtraba#190 = "S";
                    #nomcalca#174 = #nomconst#90;      || Desempleo
               |FINSI;
               |SI nElAny = 2015;
                    #nomcalca#175 = 2.33;      || FOGASA
                    #nomcalca#176 = 1.13;      || FP
               |FINSI;
               |SI nElAny = 2016;
                    #nomcalca#175 = 2.35;      || FOGASA
                    #nomcalca#176 = 1.14;      || FP
               |FINSI;
               |SI nElAny = 2017;
                    #nomcalca#175 = 2.53;      || FOGASA
                    #nomcalca#176 = 1.24;      || FP
               |FINSI;
               |SI nElAny = 2018;
                    #nomcalca#175 = 2.64;      || FOGASA
                    #nomcalca#176 = 1.28;      || FP
               |FINSI;
               |SI nElAny ] 2019;
                    #nomcalca#175 = 3.23;      || FOGASA
                    #nomcalca#176 = 0;         || FP
               |FINSI;
          |FINSI;
          #nomcalca#177 = #nomconst#86 + #nomconst#87;      || AT + EP
          || #nomcalca#178 = ;      || LIBRE
          || Bonificaciones
          #nomcalca#180 = nBonifFormEmp + nBonifERE + nBonifJuv;
          #nomcalca#180 = #nomcalca#180 + base_AB;
     |SINO;
          || Comunes
          |SI base_6p_com = 0;
               nBase = (base_6 + coba_4 + coba_5 + nDesem);
          |SINO;
               nBase = (base_6p_com + nDesem);
          |FINSI;

          nCuotaTotal = (nBase % (por1_cont + por2_cont)) ! 2;
          nCuotaTrab = (nBase % por1_cont) ! 2;

          || #nomcalca#173 = nCuotaTotal - nCuotaTrab;
          #nomcalca#173 = nCuotaEmpCC;

          |SI #labtraba#112 = "S";
               |SI nElAny [ 2018;
                    #nomcalca#173 = #nomcalca#173 + (#nomcalca#173 % 36);
               |SINO;
                    #nomcalca#173 = #nomcalca#173 + (#nomcalca#173 % 40);
               |FINSI;
          |FINSI;

          |SI #nombonif#10 = 4;    || mayores de 65 a¤os
               #nomconst#12 = 0;
               #nomconst#14 = 0;
               #nomconst#16 = 0;
          |FINSI;

          || Desempleo
          |SI base_7p_des = 0;
               nBase = (base_7 + cobb_4 + cobb_5 + nDesem);
          |SINO;
               nBase = (base_7p_des + nDesem);
          |FINSI;
          nCuotaTotal = (nBase % (#nomconst#12 + #nomconst#13)) ! 2;
          nCuotaTrab = (nBase % #nomconst#13) ! 2;
          || #nomcalca#174 = nCuotaTotal - nCuotaTrab;
          #nomcalca#174 = nCuotaEmpDes;

          || FOGASA
          |SI base_7p_fog = 0;
               nBase = (base_7 + cobb_4 + cobb_5 + nDesem);
          |SINO;
               nBase = (base_7p_fog + nDesem);
          |FINSI;
          || #nomcalca#175 = (nBase % #nomconst#14) ! 2;
          #nomcalca#175 = nCuotaEmpFog;

          || FP
          |SI base_7p_fp = 0;
               nBase = (base_7 + cobb_4 + cobb_5 + nDesem);
          |SINO;
               nBase = (base_7p_fp + nDesem);
          |FINSI;
          nCuotaTotal = (nBase % (#nomconst#16 + #nomconst#17)) ! 2;
          nCuotaTrab = (nBase % #nomconst#17) ! 2;
          || #nomcalca#176 = nCuotaTotal - nCuotaTrab;
          #nomcalca#176 = nCuotaEmpFP;

          || AT + EP
          #nomcalca#177 = base_9;

          || #nomcalca#178 = ;      || LIBRE

          #nomcalca#179 = (dacum_30 % por2_hor1) + (dacum_31 % por2_hor2);  || Horas Extras
          || Bonificaciones
          #nomcalca#180 = (base_AB+base_C+zbase_AB+zbase_C+base_G);
          #nomcalca#180 = #nomcalca#180 + nBonifFCI1 + nBonifFCI2;
          #nomcalca#180 = #nomcalca#180 + nBonifERE + nBonifJuv;
          |SI #nombonif#10 = 4;    || mayores de 65 a¤os
               |SI #nomcalca#63 > 0;
                    || #nomcalca#180 = #nomcalca#180 - ((#nomcalca#43 % #nombonif#6) ! 2);
               |FINSI;
          |FINSI;

          |SI nElAny = 2014; |Y #nomcalca#61 = 0.27;        || Mayores 65
               #nomcalca#174 = 0;
               #nomcalca#175 = 0;
               #nomcalca#176 = 0;
          |FINSI;
          |SI nElAny = 2015; |Y #nomcalca#61 = 0.25;        || Mayores 65
               #nomcalca#174 = 0;
               #nomcalca#175 = 0;
               #nomcalca#176 = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MasDeUnaRecaida;
     |SI #nomvarca#campos# = "E"; |O #nomvarca#campos# = "A";
          |SI #nomvarca#camdes# ! 0;
               nCampoRec = campos + 23;
               nCampoFechaRec = campos + 27;
               || la fecha de la IT inicial de esta IT:
               aFechaITRec = #nomvarca#nCampoFechaRec#;

               |SI #nomvarca#nCampoRec# = "S";
                    |PARA nCampo1 = 12; |SI nCampo1 < campos; |HACIENDO nCampo1 = nCampo1 + 1;
                         |SI campos ! nCampo1;
                              nCampo2 = nCampo1 + 23;  || recaida S/N
                              nCampo3 = nCampo1 + 27;  || fecha IT inicial
                              nCampo4 = nCampo1 - 8;   || Desde IT
                              nCampo5 = nCampo1 - 4;   || Hasta IT
                              |SI #nomvarca#nCampo2# = "S";
                                   |SI #nomvarca#nCampo3# = aFechaITRec;
                                        nDesde = #nomvarca#nCampo4#;
                                        nHasta = #nomvarca#nCampo5#;
                                        nAcum = 0;
                                        |SI nDesde = 0;
                                             nDesde = 1;
                                             |SI #nomvarca#campos# = "E";
                                                  nAcum = #labtraba#89;
                                             |FINSI;
                                             |SI #nomvarca#campos# = "A";
                                                  nAcum = #labtraba#92;
                                             |FINSI;
                                        |FINSI;
                                        |SI nHasta = 0; nHasta = guarda;  |FINSI;
                                        |SI nDesde < dalta_3;  nDesde = dalta_3;  |FINSI;
                                        |SI nHasta > dbaja_3;  nHasta = dbaja_3;  |FINSI;

                                        nNume = (nHasta - nDesde + 1);
                                        |SI campos = 12;
                                             nAcumRecMes1 = nAcumRecMes1 + nNume + nAcum;
                                        |FINSI;
                                        |SI campos = 13;
                                             nAcumRecMes2 = nAcumRecMes2 + nNume + nAcum;
                                        |FINSI;
                                        |SI campos = 14;
                                             nAcumRecMes3 = nAcumRecMes3 + nNume + nAcum;
                                        |FINSI;
                                        |SI campos = 15;
                                             nAcumRecMes4 = nAcumRecMes4 + nNume + nAcum;
                                        |FINSI;
                                   |FINSI;
                              |SINO;
                                   || caso de ser una recaida de una IT que se venia
                                   || acumulando y ha acabado en este mismo mes
                                   |SI nCampo1 = 12;
                                        |SI #nomvarca#nCampo4# = 0; |Y #nomvarca#nCampo5# ! 0;
                                             |SI aFechaITRec = #labtraba#125;
                                                  |SI campos = 12;
                                                       nAcumRecMes1 = nAcumRecMes1 + #nomvarca#nCampo5#;
                                                  |FINSI;
                                                  |SI campos = 13;
                                                       nAcumRecMes2 = nAcumRecMes2 + #nomvarca#nCampo5#;
                                                  |FINSI;
                                                  |SI campos = 14;
                                                       nAcumRecMes3 = nAcumRecMes3 + #nomvarca#nCampo5#
                                                  |FINSI;
                                                  |SI campos = 15;
                                                       nAcumRecMes4 = nAcumRecMes4 + #nomvarca#nCampo5#
                                                  |FINSI;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO leetodo_cal3;    || LEE ANTIG./CATEG., AUX. CONVENIOS Y PTAS. BASE ANTIG.
     |ABRE #nomantca;
     |DDEFECTO #nomantca;
     #nomantca#0 = #labtraba#87;
     #nomantca#1 = #labtraba#17;
     |LEE 000#nomantca.=;                 || lee antiguedad/categoria
     |CIERRA #nomantca;

     |ABRE #nomconax;
     |DDEFECTO #nomconax;
     #nomconax#0 = #labtraba#87;
     |LEE 000#nomconax.=;                 || lee auxiliar de convenios
     aux_conv = FSalida;
     |CIERRA #nomconax;
|FPRC;

|PROCESO Paralelo;
     |HAZ OrigenControlIT;
     |SI dcont_2 > 0; |Y para1 = swControlIT; |Y #nomcontr#62 = "S";
     |Y aTipoOrigen = "E";
          |SI swAjuste3 ! 0; |Y swAjuste3_C ! 0; || libro de comentarios (7)
               denfe_20 = dcont_2 - swAjuste3;
          |SINO;
               denfe_20 = dcont_2 - swAjuste3 - swAjuste3_C;
          |FINSI;
          denfe_t = dcont_2;
          denfe_0 = 365;
          |SI #labtraba#60 = "C";
               denfe_0 = denfe_0 + #labtraba#89;
          |FINSI;
     |FINSI;
     |SI denfe_20 ! 0;              || si ha estado enfermo
          |HAZ leetodo_cal3;              || lee cada vez el auxiliar de convenios
          denfe_t = denfe_20;
          swPrimera = 1;
          |HAZ BuscaPE;
          |SI swPrimera = 1;
               |SI para1 ! 1;      || no va a ser la primera del a¤o si
                    |PARA nNume1 = 1; |SI nNume1 < para1; |HACIENDO nNume1 = nNume1 + 1;
                         campo = nNume1 + 11;
                         |SI #nomvarca#campo# = "E";
                              |SI nHospi = 0;
                                   |SI dreca_0 = 0; || no es la primera linea de enfermedad
                                        swPrimera = 0; || SALVO QUE HAYA RECAIDA
                                   |FINSI;
                              |FINSI;
                              |SI nHospi = 1;
                                   campo = nNume1 + 30
                                   |SI #nomvarca#campo# = "S";
                                        swPrimera = 0; || mismo mes, otra IT con Hosp
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
                    |SI #labtraba#89 ! 0; |Y #nomvarca#4 = 0;
                         aAlfa = #labtraba#125;   || si resulta que tengo
                         aAlfa = aAlfa % -104;    || dos IT, una que viene
                         nNume1 = aAlfa;           || del a¤o anterior y otra
                         |SI nNume1 ! nElAny;      || entonces la segunda es
                              swPrimera = 1;      || la primera del a¤o
                         |FINSI;                  || seguro
                    |FINSI;
               |FINSI;
          |FINSI;

               |SI dreca_0 > 0;
                    denfe_0 = denfe_0 + dreca_0;
               |FINSI;
               |SI para1 = 1;
                    denfe_t = denfe_t + denfe_0;   || suma dias enferm. actual
               |SINO;
                    denfe_t = denfe_t + dreca_0;   || suma dias recaida
               |FINSI;
               |SI swPrimera = 1;
                    |SI denfe_t > #nomconax#124; |Y #nomconax#124 ! 0;
                         denfe_U0_H = #nomconax#124 - #nomconax#123 + 1;
                    |SINO;
                         denfe_U0_H = denfe_t;
                    |FINSI;

                    |SI denfe_t > #nomconax#187; |Y #nomconax#187 ! 0;
                         denfe_T0_H = #nomconax#187 - #nomconax#186 + 1;
                    |SINO;
                         denfe_T0_H = denfe_t - denfe_U0_H;
                    |FINSI;

                    |SI denfe_t > #nomconax#214; |Y #nomconax#214 ! 0;
                         denfe_S0_H = #nomconax#214 - #nomconax#213 + 1;
                    |SINO;
                         denfe_S0_H = denfe_t - denfe_U0_H - denfe_T0_H;
                    |FINSI;

                    |SI denfe_t > #nomconax#223; |Y #nomconax#223 ! 0;
                         denfe_R0_H = #nomconax#223 - #nomconax#222 + 1;
                    |SINO;
                         denfe_R0_H = denfe_t - denfe_U0_H - denfe_T0_H - denfe_S0_H;
                    |FINSI;

                    denfe_Z0_H = denfe_U0_H + denfe_T0_H + denfe_S0_H + denfe_R0_H;
               |FINSI;
          |FINSI;

          |SI denfe_Z0_H ] #nomconax#132;  #nomconax#132 = denfe_Z0_H + 1;  |FINSI;
          |SI denfe_Z0_H < #nomconax#136;
               |SI denfe_t > #nomconax#136; |Y #nomconax#136 ! 0;
                    denfe_Y0_H = #nomconax#136 - #nomconax#132 + 1;
               |SINO;
                    denfe_Y0_H = denfe_t - (denfe_Z0_H);
               |FINSI;
          |FINSI;
          |SI denfe_Z0_H ] #nomconax#133;  #nomconax#133 = denfe_Z0_H + 1;  |FINSI;
          |SI denfe_Z0_H < #nomconax#137;
               |SI denfe_t > #nomconax#137; |Y #nomconax#137 ! 0;
                    denfe_X0_H = #nomconax#137 - #nomconax#133 + 1;
               |SINO;
                    denfe_X0_H = denfe_t - (denfe_Y0_H + denfe_Z0_H);
               |FINSI;
          |FINSI;
          |SI denfe_Z0_H ] #nomconax#134;  #nomconax#134 = denfe_Z0_H + 1;  |FINSI;
          |SI denfe_Z0_H < #nomconax#138;
               |SI denfe_t > #nomconax#138; |Y #nomconax#138 ! 0;
                    denfe_W0_H = #nomconax#138 - #nomconax#134 + 1;
               |SINO;
                    denfe_W0_H = denfe_t - (denfe_X0_H + denfe_Y0_H + denfe_Z0_H);
               |FINSI;
          |FINSI;
          |SI denfe_Z0_H ] #nomconax#135;  #nomconax#135 = denfe_Z0_H + 1;  |FINSI;
          |SI denfe_Z0_H < #nomconax#139;
               |SI denfe_t > #nomconax#139; |Y #nomconax#139 ! 0;
                    denfe_V0_H = #nomconax#139 - #nomconax#135 + 1;
               |SINO;
                    denfe_V0_H = denfe_t - (denfe_W0_H + denfe_X0_H + denfe_Y0_H + denfe_Z0_H);
               |FINSI;
          |FINSI;

          ||____________________________________/ QUITA DIAS MESES ANTERIORES
          ||SI para1 = 1;                      || (solo la primera vez)
               nume1 = denfe_20;
               nume2 = denfe_U0_H + denfe_T0_H + denfe_S0_H + denfe_R0_H;
               |SI nume2 > 0;
                    denfe_NO = denfe_t - nume2;
                    nume1 = nume1 - denfe_NO;
                    |SI nume1 < 0;
                         nume1 = 0;
                    |FINSI;
               |FINSI;

               ||SI swPrimera = 1;
               |SI nume2 > 0;
                    || si es 1ra. enfermedad

                    |SI denfe_R0_H > nume1;
                         denfe_U0_H = 0;
                         denfe_T0_H = 0;
                         denfe_S0_H = 0;
                         denfe_R0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_R0_H;
                    |FINSI;
                    |SI denfe_S0_H > nume1;
                         denfe_U0_H = 0;
                         denfe_T0_H = 0;
                         denfe_S0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_S0_H;
                    |FINSI;
                    |SI denfe_T0_H > nume1;
                         denfe_U0_H = 0;
                         denfe_T0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_T0_H;
                    |FINSI;
                    |SI denfe_U0_H > nume1;
                         denfe_U0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_U0_H;
                    |FINSI;
                    |SI dreca_0 > 0;
                         denfe_Z0_H = denfe_Z0_H - dreca_0;
                    |FINSI;
               |SINO;
                    nume2 = denfe_Y0_H + denfe_X0_H + denfe_W0_H + denfe_V0_H;
                    |SI nume2 > 0;
                         denfe_NO = denfe_t - nume2;
                         nume1 = nume1 - denfe_NO;
                         |SI nume1 < 0;
                              nume1 = 0;
                         |FINSI;
                    |FINSI;

                    |SI denfe_V0_H > nume1;
                         denfe_Z0_H = 0;

                         denfe_Y0_H = 0;
                         denfe_X0_H = 0;
                         denfe_W0_H = 0;
                         denfe_V0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_V0_H;
                    |FINSI;
                    |SI denfe_W0_H > nume1;
                         denfe_Z0_H = 0;

                         denfe_Y0_H = 0;
                         denfe_X0_H = 0;
                         denfe_W0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_W0_H;
                    |FINSI;
                    |SI denfe_X0_H > nume1;
                         denfe_Z0_H = 0;

                         denfe_Y0_H = 0;
                         denfe_X0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_X0_H;
                    |FINSI;
                    |SI denfe_Y0_H > nume1;
                         denfe_Z0_H = 0;

                         denfe_Y0_H = nume1;
                    |SINO;
                         nume1 = nume1 - denfe_Y0_H;
                    |FINSI;
                    |SI denfe_Z0_H > nume1;
                         denfe_Z0_H = nume1;
                    |FINSI;
               |FINSI;
          ||FINSI;

     denfe_Z_H = denfe_Z_H + denfe_Z0_H;
     denfe_U_H = denfe_U_H + denfe_U0_H;   || 1ra linea 1ra enfermedad
     denfe_T_H = denfe_T_H + denfe_T0_H;   || 2da linea 2da enfermedad
     denfe_S_H = denfe_S_H + denfe_S0_H;   || 3ra linea 3ra enfermedad
     denfe_R_H = denfe_R_H + denfe_R0_H;   || 4ta linea 4ta enfermedad

     denfe_Y_H = denfe_Y_H + denfe_Y0_H;
     denfe_X_H = denfe_X_H + denfe_X0_H;
     denfe_W_H = denfe_W_H + denfe_W0_H;
     denfe_V_H = denfe_V_H + denfe_V0_H;
|FPRC;

/****************************************************************************/
/* DE MOMENTO SOLO PARA EL MODULO DE CLINICA BENIDORM,CONGELACION ANTIGUEDAD*/
/****************************************************************************/

|PROCESO CongelaAntiguedad;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/cmsb0002.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         ||MENAV aAlfa;
         || no doy mensaje, no me fio
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;   || convenio
     |LEE 000#500=;
     |SI FSalida = 0;
          aFechaCongAnt = #500#1;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO Excep908;
     |ABRE #nomexsml;
     #nomexsml#0 = #labtraba#0;
     #nomexsml#1 = #labtraba#1;
     |LEE 000#nomexsml.=;
     |SI FSalida = 0;
          #nomcalli#5 = "V";
          #nomcalli#6 = "0";
     |FINSI;
     |CIERRA #nomexsml;
|FPRC;

|PROCESO TPXenIT;
     |HAZ ExaminaIT;     || asi se cual ha sido la ultima IT (aTipUltimaIT)

     |SI nElMes = 02;
          nNume = -2 + bisiesto;
     |SINO;
          nNume = 1;
     |FINSI;

     |SI aTipUltimaIT = "E";
          |SI #labtraba#138 = "N"; |Y #labtraba#241 = "N";
               || si es una IT de las que no cumple periodo de carencia tengo
               || que quitar de la base de maternidad, no de esta
               |SI nBaseIT2 ! 0;
                    coba_4 = coba_4 + (nBaseIT2 * nNume);
                    cobb_4 = cobb_4 + (nBaseIT2 * nNume);
               |SINO;
                    coba_4 = coba_4 + (prom_enf * nNume);
                    cobb_4 = cobb_4 + (prom_acc * nNume);
               |FINSI;
          |SINO;
               |SI nBaseIT2 ! 0;
                    coba_1 = coba_1 + (nBaseIT2 * nNume);
                    cobb_1 = cobb_1 + (nBaseIT2 * nNume);
               |SINO;
                    coba_1 = coba_1 + (prom_enf * nNume);
                    cobb_1 = cobb_1 + (prom_acc * nNume);
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aTipUltimaIT = "A";
          coba_2 = coba_2 + ((prom_acc + prom_ac2) * nNume);
          cobb_2 = cobb_2 + (prom_enf * nNume);
     |FINSI;
     |SI aTipUltimaIT = "M"; |O aTipUltimaIT = "P"; |O aTipUltimaIT = "R";
     |O aTipUltimaIT = "C";
          nNume1 = dcoti_0 + nNume;     || dias totales mes
          |SI dalta_3 ! 1;    || no soy alta desde el dia 1
          |Y nDiasMatNat = nNume1; || todos los dias que trabajo del mes en MAT
                                   || en este caso no hay que sumar el dia de
                                   || mas, porque ya cotizo toda la IT
               nNume = 0;
          |FINSI;

          |SI aTipUltimaIT = "M"; |O aTipUltimaIT = "P"; |O aTipUltimaIT = "R";
          |O aTipUltimaIT = "C";
               |SI nBaseIT2 ! 0;
                    coba_4 = coba_4 + (nBaseIT2 * nNume);
                    cobb_4 = cobb_4 + (nBaseIT2 * nNume);
               |SINO;
                    coba_4 = coba_4 + (prom_enf * nNume);
                    cobb_4 = cobb_4 + (prom_acc * nNume);
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Unid200c;
     |SI concepto = 201; duni1_999 = dunic_201; |FINSI;
     |SI concepto = 202; duni1_999 = dunic_202; |FINSI;
     |SI concepto = 203; duni1_999 = dunic_203; |FINSI;
     |SI concepto = 204; duni1_999 = dunic_204; |FINSI;
     |SI concepto = 205; duni1_999 = dunic_205; |FINSI;
     |SI concepto = 206; duni1_999 = dunic_206; |FINSI;
     |SI concepto = 207; duni1_999 = dunic_207; |FINSI;
     |SI concepto = 208; duni1_999 = dunic_208; |FINSI;
|FPRC;

|PROCESO Unid200_998;
     |SI concepto = 201; duni2_998 = dunic_201; |FINSI;
     |SI concepto = 202; duni2_998 = dunic_202; |FINSI;
     |SI concepto = 203; duni2_998 = dunic_203; |FINSI;
     |SI concepto = 204; duni2_998 = dunic_204; |FINSI;
     |SI concepto = 205; duni2_998 = dunic_205; |FINSI;
     |SI concepto = 206; duni2_998 = dunic_206; |FINSI;
     |SI concepto = 207; duni2_998 = dunic_207; |FINSI;
     |SI concepto = 208; duni2_998 = dunic_208; |FINSI;
|FPRC;

|PROCESO ss_ayunt;
     |SI #labtraba#42 = "L";|O #labtraba#42 = "N";
           nume1 = base_6 % (por2_cont + #nomconst#7 - nRecAy);
           nume1 = nume1 ! 2;
           nume1 = nume1 % (#nomnotay#2 + #nomnotay#3);
           base_E = base_E - nume1;
           base_E = base_E + (base_6 % #nomnotay#4);
     |FINSI;
|FPRC;

|PROCESO horasfor;
     nHorasFor = 0;

     |ABRE #nomhorf2;
     #nomhorf2#0 = #labtraba#0;
     #nomhorf2#1 = #labtraba#1;
     #nomhorf2#2 = nElAny;
     #nomhorf2#3 = nElMes;
     |LEE 000#nomhorf2.=;
     |SI FSalida = 0;
          nCampo = nElMes + 2;
          nHorasFor = #nomhorf2#nCampo#;
     |FINSI;
     |CIERRA #nomhorf2;
|FPRC;

|PROCESO ProcesosVarios;
     |HAZ MasDeSiete;
|FPRC;

|PROCESO VtoBonif;
     |PARA nHastaBonif = 14; |SI nHastaBonif [ 19;
                             |HACIENDO nHastaBonif = nHastaBonif + 1;
          nNume1 = (#nombonif#nHastaBonif# - (#nombonif#nHastaBonif# $ 12)) / 12;
          nNume2 = #nombonif#nHastaBonif# $ 12;
          nVtoBonif = totalt + (nNume1 * 100) + nNume2;
          aAlfa = nVtoBonif; aAlfa = aAlfa % -102; nume1 = aAlfa;
          |SI nume1 > 12;
               nVtoBonif = nVtoBonif - 12 + 100;
          |FINSI;
          |SI totact < nVtoBonif;
               totven = nVtoBonif;
               |SI nHastaBonif = 14;
                    nNume1 = 3;
               |SINO;
                    nNume1 = nHastaBonif + 5;
               |FINSI;
               nPorBon1 = #nombonif#nNume1#;         || se lleva el porcent. bonif. 1
               |SAL;
          |SINO;
               |SI totact = nVtoBonif;|Y diaalt ! 1;
                    totven = nVtoBonif;
                    |SI nHastaBonif = 14;
                         nNume1 = 3;
                    |SINO;
                         nNume1 = nHastaBonif + 5;
                    |FINSI;
                    nPorBon1 = #nombonif#nNume1#;         || se lleva el porcent. bonif. 1
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     nNume1 = nHastaBonif + 1;
     |SI nNume1 [ 19;
          |SI #nombonif#nNume1# ! 0;|Y #nombonif#nNume1# > #nombonif#nHastaBonif#;
               nNume2 = nNume1 + 5;
               nPorBon2 = #nombonif#nNume2#;         || se lleva el porcent. bonif. 2
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Jornadas;
     |ABRE #gomdetjr;
     #gomdetjr#0 = #labtraba#0;
     #gomdetjr#1 = #labtraba#1;
     #gomdetjr#2 = nElAny;
     #gomdetjr#3 = nElMes;
     |LEE 000#gomdetjr.=;

     |SI FSalida = 0;
          nMes = nElMes;
          nAny = nElAny;
          |HAZ DiasPeriodo;
          aAlfa = fFechaIniPer; aAlfa = aAlfa % 102; nDesde = aAlfa;
          aAlfa = fFechaFinPer; aAlfa = aAlfa % 102; nHasta = aAlfa;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               nDia = nCampo - 3;
               |SI nDesde [ nDia; |Y nDia [ nHasta;
                    |SI #gomdetjr#nCampo# = "D";
                         nDiasInactividad = nDiasInactividad + 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #gomdetjr;
|FPRC;

|PROCESO BuscaOtroF;
     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;
          |ACABA;
     |FINSI;
     |SI nEmp ! #labtraba#0;
          |ACABA;
     |FINSI;
     fFecha = #labtraba#36;
     |SI fFecha > fFechaAlta;
          |ACABA;
     |FINSI;
     |SALVA_FICHA #nomcalca;
     #nomcalca#0 = #labtraba#0;
     #nomcalca#1 = #labtraba#1;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          |SI swForm = 1;
               |SI #nomcalca#9 = 421; |O #nomcalca#9 = 422;
                    |SI #nomcalca#48 ! 0;    || si ya cotizo por cc
                    |O #nomcalca#143 ! 0;    || o estaban a cero por tener bonif
                         dto_con = 0;
                         dto_des = 0;
                         dto_dfp = 0;
                    |FINSI;
                    |SI #nomcalca#143 ! 0; nBonifFormEmp = 0; |FINSI;
                    |SI #nomcalca#144 ! 0; nBonifFormTra = 0; |FINSI;
               |FINSI;
          |FINSI;
          |SI swForm = 2;
               |SI #nomcalca#9 = 421; |O #nomcalca#9 = 422;
                    base_E = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |REPON_FICHA #nomcalca;
|FPRC;

|DEFBUCLE BuscaOtroForm;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaOtroF;
     #labtraba#36;
|FIN;

|PROCESO BuscaOtroForm;
     aNif = #labtraba#7;
     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     fFechaAlta = #labtraba#36;
     |SALVA_FICHA #labtraba;
     |BUCLE BuscaOtroForm;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO nomvarl1;
     ||HAZ convenio;
     ||SI convenio = 0;
          |DDEFECTO #nomcalli;
          ||HAZ recarga;

          #nomcalli#0 = #labtraba#0;   || codigo empresa
          #nomcalli#1 = #labtraba#1;   || codigo trabajador
          #nomcalli#2 = nElMes;   || mes
          #nomcalli#3 = 0;
          #nomcalli#4 = #nomvarl1#4;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;  |BORRA 020#nomcalli.a;  |FINSI;
          ||HAZ recarga;
          #nomcalli#04 = #nomvarl1#4;  || concepto
          |SI #nomvarl1#5 ! "          ";    #nomcalli#9 = #nomvarl1#5;  |FINSI;  || unid.
          |SI runnom = "nomcalfi"; |Y concepto = 125;
               |SI #nomcalli#9 [ 0; #nomcalli#9 = 0; |FINSI;
          |FINSI;
          |SI #nomvarl1#6 ! "            ";  #nomcalli#10 = #nomvarl1#6;  |FINSI;  || valor
          |GRABA 020#nomcalli.n;
     ||FINSI;
|FPRC;

|DEFBUCLE nomvarl1;
     #nomvarl1#1;
     ;
     #labtraba#0, #labtraba#1, nElMes, 2, 400;
     #labtraba#0, #labtraba#1, nElMes, 2, 499;
     ;
     NULL, nomvarl1;
|FIN;

|PROCESO VarFini;
     |BUCLE nomvarl1;
|FPRC;

/*************** PROCESOS PARA RECONSTRUIR EL CALENDARIO ********************/
/***************      PARA LOS NUEVOS CONCEPTOS "E"      ********************/

|PROCESO semana;      || calcula los pesos segun dia semana
     |PARA mesnum = 1; |SI mesnum [ 12; |HACIENDO mesnum = mesnum + 1;
          ||HAZ lib_0;
          |HAZ ulti_dia;
          alfa1 = "";
          |PARA dianum = 1; |SI dianum [ topemes; |HACIENDO dianum = dianum + 1;
               clavep = #500#semana1#;     || carga en 'clavep' el peso correspondiente
               alfa1 = alfa1 + clavep; || recarga 'alfa1' con el peso
               semana1 = semana1 + 1; || pasa el dia de la semana
               |SI semana1 = 9;
                    semana1 = 2;
               |FINSI;
          |SIGUE;
          |SI nElMes = mesnum;
               aCalenConcep = alfa1;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO fechas;      || calcula los pesos segun margenes de fechas
     |PARA campo = 9; |SI campo [ 96; |HACIENDO campo = campo + 3;
          |SI #nomfical#campo# ! "    ";
               nDesde = campo;
               nHasta = campo + 1;
               pesos = campo + 2;

               alfa1 = #nomfical#nDesde# % 102;    || separa el desde
               alfa2 = #nomfical#nDesde# % 302;
               diades = alfa1;
               mesdes = alfa2;

               alfa1 = #nomfical#nHasta# % 102;    || separa el hasta
               alfa2 = #nomfical#nHasta# % 302;
               diahas = alfa1;
               meshas = alfa2;

               |PARA mesact = mesdes; |SI mesact [ meshas; |Y mesact = nElMes; |HACIENDO mesact=mesact+1;
                    alfa1 = aCalenConcep;  || carga la variable mes del fichero
                    alfa2 = "";            || limpia la variable
                    mesnum = mesact;
                    ||HAZ lib_0;                   || calcula el tope del mes
                    |HAZ ulti_dia;                   || calcula el tope del mes

                    |SI mesact=mesdes;
                         topemes1=diades;
                    |SINO;
                         topemes1=1;
                    |FINSI;

                    |SI mesact=meshas;
                         topemes2=diahas;
                    |SINO;
                         topemes2=topemes;
                    |FINSI;

                    |PARA mid = 1; |SI mid [ topemes; |HACIENDO mid = mid + 1;
                         nume1 = (mid * 100) + 1;
                         clavep = alfa1 % nume1;
                         |SI mid ] topemes1; |Y mid [ topemes2;
                              clavep = #nomfical#pesos#;
                         |FINSI;
                         alfa2 = alfa2 + clavep;
                    |SIGUE;
                    aCalenConcep = alfa2;          || descarga la variable mes al fichero
               |SIGUE;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO diasfi;      || calcula los pesos segun dias fijos
     |PARA campo = 99; |SI campo [ 157; |HACIENDO campo = campo + 2;
          |SI #nomfical#campo# ! "    ";
               pesos = campo + 1;

               alfa1 = #nomfical#campo# % 102;    || separa el dia fijo
               alfa2 = #nomfical#campo# % 302;
               diafij = alfa1;
               mesfij = alfa2;

               mesnum = mesfij;
               |SI mesnum = nElMes;
                    |HAZ ulti_dia;

                    alfa1 = aCalenConcep;
                    alfa2 = "";
                    alfa3 = "";
                    mid_1 = 0;
                    mid_2 = 0;
                    |SI diafij ! 1;
                         mid_1 = 99 + diafij;
                         alfa2 = alfa1 % mid_1;
                    |FINSI;
                    |SI diafij ! topemes;
                         mid_2 = (diafij + 1);
                         alfa3 = alfa1 % mid_2;
                    |FINSI;
                    alfa1 = alfa2 + #nomfical#pesos# + alfa3;
                    aCalenConcep = alfa1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO reconstruye;
     |HAZ firstdia;
     |HAZ semana;        || contruyo calendario segun calendario concepto "E"
     |SI #500#9 = "S";
          |HAZ fechas;       || a¤ado dias de fiesta
          |HAZ diasfi;       || del calendario del trabajador (ya no)
     |FINSI;
|FPRC;

|PROCESO CalenConcep;               || crea el calendario segun concepto
     |ABRE #nomfical;               || lee el calendario
     |DDEFECTO #nomfical;
     #nomfical#0 = #labtraba#156;
     #nomfical#1 = nElAny;
     |LEE 000#nomfical.=;
     |CIERRA #nomfical;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomconl2.mas";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;          || convenio
     #500#1 = concepto;       || concepto
     |LEE 000#500.=;

     |HAZ reconstruye;

     topemes1 = 0;
     topemes2 = 0;            || calcula los dias laborables del mes
     swmarca = "A";
     conser3 = 0;
     conser4 = 0;
     dife3 = 0; dife4 = 0; dife5 = 0;
     ajuste5 = 0;
     ajuste6 = 0;
     aFiestaAct = "";
     nTFAct = 0;    || total dias de fiesta por Actividad en el mes
     nDiaAct1 = 0;  nDiaAct2 = 0;  nDiaAct3 = 0;  nDiaAct4 = 0;
     nDiaAct5 = 0;  nDiaAct6 = 0;  nDiaAct7 = 0;  nDiaAct8 = 0;
     |SI #500#9 = "S";
          |HAZ FiestaAct;         || fiesta de convenio tampoco entra
     |FINSI;

     |SI #nomcalli#5 = "E";
          swConcep = 1;
     |FINSI;
     |SI #nomcalli#5 = "L";
          swConcep = 2;
     |FINSI;

     |CIERRA #500;
     |DESCARGA_DEF #copiadef@;
|FPRC;
/****************************************************************************/

|PROCESO IntervalosAlta;
     nDiasAltaInt = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomintal.mas";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#0;
     #500#1 = #labtraba#1;
     #500#2 = nElAny;
     #500#3 = nElMes;
     |LEE 000#500=;
     |SI FSalida = 0;
          |PARA nCampo = 4; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 2;
               nCampo1 = nCampo + 1;
               |SI #500nCampo ! 0; |Y #500nCampo1 ! 0;
               |Y #500nCampo [ #500nCampo1;
                    nNume = #500nCampo1 - #500nCampo + 1;
                    nDiasAltaInt = nDiasAltaInt + nNume;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #500;
     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO Auxiliar;
     nDiasAltaInt = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomcalap.mas";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#0;
     #500#1 = #labtraba#1;
     #500#2 = nElAny;
     #500#3 = nElMes;
     #500#4 = 0;
     |LEE 000#500=;
     FEstado = FSalida;
     #500#5 = #labempre#25;
     aAlfa = "";
     |PARA nCampo = 113; |SI nCampo [ 120; |HACIENDO nCampo = nCampo + 1;
          aAlfa = aAlfa + #labtraba#nCampo#;
     |SIGUE;
     #500#6 = aAlfa;
     #500#7 = ~;
     |HORA aAlfa;
     #500#8 = aAlfa;
     aAlfa = Usuario % 810;
     #500#9 = aAlfa;

     |SI FEstado = 0;
          |GRABA 020#500a;
     |SINO;
          |GRABA 020#500n;
     |FINSI;
     |CIERRA #500;
     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO ConcIndAuto;
     |SI aFechaFIN ! ""; || Sykes, Theorical Liquidation
          |ACABA;
     |FINSI;

     |SI swIndem = 1;        || por convenio
          || tiene retencion IRPF (410)
          concepto = 410;
          || aun asi, preguntar
     |FINSI;
     |SI swIndem = 2;        || por concepto 902;
          ||SI duni1_902 = 20; |O duni1_902 = 33; |O duni1_902 = 45;
          |SI #nomvarca#46 = 93;
               || el caso que queda, 12 dias por a¤o sin limite de a¤os
               || en caso de extincion del contrato temporal
               || este es el unico que tiene retencion IRPF (410)
               concepto = 410;
          |SINO;
               || no tiene retencion IRPF (415)
               concepto = 415;
          |FINSI;
     |FINSI;

     nConceptoInd = concepto;
|FPRC;

|PROCESO BuscaHorasExt;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nAnyXX;     || a¤o
     #nomhicca#2 = nMes;     || mes
     #nomhicca#3 = 0;         || tipo
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          nBaseHE = nBaseHE + #nomhicca#41 + #nomhicca#42;
          nBaseCot = nBaseCot + #nomhicca#39;

          nAny = nAnyXX + 2000;
          |HAZ DiasPeriodo;
          nDiasCot = nDiasCot + nDiasNatAlta;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaHorasExt;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaHorasExt;
|FIN;

|PROCESO NuevoCalproac;
     |ABRE #nomhicca

     nBaseHE = 0;
     nBaseCot = 0;
     nDiasCot = 0;
     nBuscaMeses = 12;
     prom_ac2 = 0;

     |PARA i = 1; |SI i [ nBuscaMeses; |HACIENDO i = i + 1;
          nMes = nElMes - i;
          nAnyXX = nElAny - 2000;

          |SI nMes [ 0;
               nMes = 12 + nMes;
               nAnyXX = nAnyXX - 1;
          |FINSI;

          aNif = #labtraba#7;
          |SALVA_FICHA #labtraba;
          |BUCLE BuscaHorasExt;
          |REPON_FICHA #labtraba;
     |SIGUE;

     prom_ac2 = (nBaseHE / nDiasCot) ! 2;

     |CIERRA #nomhicca
|FPRC;

|PROCESO BasePrest_FHC;
     ||PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
          ||SI #nomvarca#nCampo# ! " ";
          |SI #nomvarca#campos# ! " ";
               || nLineaIT = nCampo - 11;
               || nCampo2 = nCampo - 8;
               nNume = #nomvarca#camdes#;
               |SI nNume = 0;
                    aAlfa = #labtraba#125;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         aMes = aAlfa % 402; nMesIniIT = aMes;
                         aAny = aAlfa % -104; nAnyIniIT = aAny;
                         nMesBusca = nMesIniIT;
                         nAnyBusca = nAnyIniIT;
                    |FINSI;
               |SINO;
                    nMesBusca = nElMes;
                    nAnyBusca = nElAny;
               |FINSI;

               nNume1 = 0; nNume2 = 0; nNume3 = 0;

               |PARA i = 1; |SI i [ nBuscaMeses; |HACIENDO i = i + 1;
                    nMesBusca = nMesBusca - 1;

                    |SI nMesBusca = 0;
                         nAnyBusca = nAnyBusca - 1;
                         nMesBusca = 12;
                    |FINSI;

                    |ABRE #nomhicca;
                    #nomhicca#0 = #labtraba#0;
                    #nomhicca#1 = #labtraba#1;
                    #nomhicca#66 = nAnyBusca - 2000;
                    #nomhicca#2 = nMesBusca;
                    #nomhicca#3 = 0;
                    |LEE 000#nomhicca.=;
                    |SI FSalida = 0;
                         nNume1 = nNume1 + #nomhicca#39
                         nNume2 = nNume2 + #nomhicca#40;
                         nNume3 = nNume3 + (#nomhicca#8 + #nomhicca#160);
                    |FINSI;
                    |CIERRA #nomhicca;
               |SIGUE;
               nBase946 = (nNume1 / nNume3) ! 2;
               nBase947 = (nNume2 / nNume3) ! 2;
          |FINSI;
     ||SIGUE;
|FPRC;

|PROCESO VariosBasesIT;
     |HAZ OrigenControlIT;
     || base para frutas, hortalizas y conservas vegetales
     |SI #nomcontr#81 = 2;
          |SI nBase946 = 0; |Y nBase947 = 0;
               |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
                    |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
                         nBuscaMeses = 3;
                    |SINO;
                         nBuscaMeses = 1;
                    |FINSI;
                    |HAZ BasePrest_FHC;
                    |SI nBase946 ! 0;
                         graba04 = 946;
                         graba05 = "V";
                         graba06 = 0;
                         graba07 = 0;
                         graba08 = "BR.PR.EN";
                         graba09 = 0;        || unidades
                         graba10 = nBase946; || valor
                         graba11 = 0;        || unidades calculo
                         |HAZ grabacon;
                    |FINSI;
                    |SI nBase947 ! 0;
                         graba04 = 947;
                         graba05 = "V";
                         graba06 = 0;
                         graba07 = 0;
                         graba08 = "BR.PR.AC";
                         graba09 = 0;        || unidades
                         graba10 = nBase947; || valor
                         graba11 = 0;        || unidades calculo
                         |HAZ grabacon;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;
