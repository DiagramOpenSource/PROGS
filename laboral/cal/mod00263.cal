|FICHEROS;
     mod00263 #0;

     mod00262;
     mod00264;

     mod00242;      || tipos de horas y precios
     mod00243;
     mod00244;
     mod00249;

     nomfical;
     labtraba;
     gomdetjr;
|FIN;

|VARIABLES;

     aParam = "";
     nEmp = 0;
     nTra = 0;
     nAny = 0;
     nMes = 0;
     nCampo = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aFecha = "";
     fFecha = @;
     fFechaBus = @;
     swHayHoras = 0;
     swHayHorasTrab = 0;
     aTipoHora = "";
     nPrecio = 0;
     nNroHoras = 0;
     nPrecioFes = 0;

     fDiaLet = @;
     aDiaLet = "";
     nDiaSem = 0;
     nCampoF = 0;
     nCampoF1 = 0;
     nCampoF2 = 0;
     nCampoF3 = 0;

     swFestivo = 0;
     aAlfa = "";
     nFechaNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     swSigue = 0;
     nCalendario = 0;

     nDia = 0;

     nHorasDia = 0;

     fDesdeFecha = @;
     fHastaFecha = @;
     nHoras = 0;
     nJornadas = 0;
     nColocadas = 0;
     swInactividad = 0;
     nTopeMes = 0;
     nNume = 0;
     fFechaAlta = @;
     fFechaBaja = @;
     nHorasColocadas = 0;
     nAntEmp = 0;
     nAntTra = 0;
     swPrimerDia = 0;
|FIN;

|PROCESO GrabaJornada;
     #gomdetjr#0 = #mod00264#0;
     #gomdetjr#1 = #mod00264#1;
     #gomdetjr#2 = #mod00263#4;
     #gomdetjr#3 = #mod00263#5;
     |LEE 101#gomdetjr.=;
     |SI FSalida = 0;
          |SI swInactividad = 1;
               nCampo = nDia + 3;
               |SI #gomdetjr#nCampo# = " ";
                    #gomdetjr#nCampo# = "D";
               |FINSI;
          |SINO;
               nCampo = #mod00264#2 + 3;
               #gomdetjr#nCampo# = "X";
          |FINSI;
          |GRABA 020#gomdetjr.a;
     |SINO;
          nCampo = #mod00264#2 + 3;
          |SI swInactividad = 1;
               nCampo = nDia + 3;
               #gomdetjr#nCampo# = "D";
          |SINO;
               nCampo = #mod00264#2 + 3;
               #gomdetjr#nCampo# = "X";
          |FINSI;
          |GRABA 020#gomdetjr.n;
     |FINSI;
     |LIBERA #gomdetjr;
|FPRC;

|PROCESO GrabaDia;
     || cabecera, si no existiera

     #mod00243#0 = #mod00264#0;
     #mod00243#1 = #mod00264#1;
     |LEE 101#mod00243.=;
     |SI FSalida ! 0;
          |GRABA 020#mod00243.n;
     |FINSI;
     |LIBERA #mod00243;

     || lineas, si existiera la borro

     #mod00244#0 = #mod00264#0;
     #mod00244#1 = #mod00264#1;
     #mod00244#2 = fFecha;
     #mod00244#3 = " ";

     #mod00242#0 = " ";
     |LEE 000#mod00242.=;

     #mod00244#4 = #mod00242#1;


     nNume = nHorasColocadas + nHorasDia;
     |SI nNume > nHoras;
          #mod00244#5 = nHoras - nHorasColocadas;
     |SINO;
          #mod00244#5 = nHorasDia;
     |FINSI;

     |SI #mod00242#6 ! 0;
          nPrecio = #mod00242#6;
     |SINO;
          nPrecio = #mod00242#2;
     |FINSI;

     |ABRE #mod00249;
     #mod00249#0 = #mod00264#0;
     #mod00249#1 = #mod00264#1;
     #mod00249#2 = " ";
     |LEE 000#mod00249.=;
     |SI FSalida = 0;
          |SI #mod00249#6 ! 0;
               nPrecio = #mod00249#6;
          |SINO;
               nPrecio = #mod00249#3;
          |FINSI;
     |FINSI;
     |CIERRA #mod00249;

     #mod00244#6 = nPrecio;
     #mod00244#7 = "I";

     |GRABA 020#mod00244.n;
     |LIBERA #mod00244;

     nColocadas = nColocadas + 1;
     nHorasColocadas = nHorasColocadas + #mod00244#5;
|FPRC;

|PROCESO BorradoCalJor;
     #gomdetjr#0 = #mod00264#0;
     #gomdetjr#1 = #mod00264#0;
     #gomdetjr#2 = #mod00263#4;
     #gomdetjr#3 = #mod00263#5;
     |LEE 101#gomdetjr.=;
     |SI FSalida = 0;
          |BORRA 020#gomdetjr.a;
     |FINSI;
     |LIBERA #gomdetjr;
|FPRC;

|PROCESO BorradoPrevio;
     |BORRA 020#mod00244.a;
     |LIBERA #mod00244;
|FPRC;

|DEFBUCLE BorradoPrevio;
     #mod00244#1;
     ;
     #mod00264#0, #mod00264#1, fDesdeFecha, " ";
     #mod00264#0, #mod00264#1, fHastaFecha, " ";
     be;
     NULL, BorradoPrevio;
|FIN;

|PROCESO topemes_C;
     nTopeMes = 31;
     |SI #0#5 = 4; |O #0#5 = 6; |O #0#5 = 9; |O #0#5 = 11;
          nTopeMes = 30;
     |FINSI;
     |SI #0#5 = 2;
          nNume = #0#4 $ 4;
          |SI nNume = 0;
               nTopeMes = 29;
          |SINO;
               nTopeMes = 28;
          |FINSI;
     |FINSI;
|FPRC;
/*
|PROCESO mod00264_C;
     #labtraba#0 = #mod00264#0;
     #labtraba#1 = #mod00264#1;
     |LEE 000#labtraba.=;

     aAlfa = #labtraba#36;
     fFechaAlta = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2099";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |SI #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
          |ACABA;
     |FINSI;

     |PARA nDia = 1; |SI nDia [ nTopeMes; |HACIENDO nDia = nDia + 1;
          aAlfa1 = nDia; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa2 = #0#5; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
          aAlfa3 = #0#4;
          aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
          fFecha = aAlfa;

          |SI fFechaAlta [ fFecha; |Y fFecha [ fFechaBaja;
               |HAZ Calendario;

               |SI swFestivo = 0;
                    swInactividad = 1;
                    |HAZ GrabaJornada;
                    swInactividad = 0;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE mod00264_C;
     #mod00264#1;
     ;
     #0#0, #0#2, #0#4, #0#5, 0;
     #0#1, #0#3, #0#4, #0#5, 0;
     ;
     NULL, mod00264_C;
|FIN;
*/
|PROCESO ColocaTotal;
     |SI nColocadas ! 0;
          |SALVA_FICHA #mod00264;
          |SELECT #1#mod00264;

          #mod00264#0 = nAntEmp;
          #mod00264#1 = nAntTra;
          #mod00264#5 = #0#4;
          #mod00264#6 = #0#5;
          #mod00264#2 = 00;
          |LEE 101#mod00264.=;
          #mod00264#7 = nColocadas;
          |GRABA 020#mod00264.a;
          |LIBERA #mod00264;

          |SELECT #2#mod00264;
          |REPON_FICHA #mod00264;
     |FINSI;
|FPRC;

|PROCESO mod00264;
     |SI #mod00264#2 = 00;
          || siempre sera el primero en leer, la linea de total de dias

          nHoras = #mod00264#4;
          nJornadas = nHoras / nHorasDia;
          nJornadas = (nJornadas - 0.49) ! 0;

          |SI nHoras > 0; |Y nJornadas = 0;
               || menos de una jornada, al menos pongo una
               nJornadas = 1;
          |FINSI;

          |SI nAntEmp ! #mod00264#0; |O nAntTra ! #mod00264#1;
               |HAZ ColocaTotal;
          |FINSI;

          nColocadas = 0;
          nHorasColocadas = 0;

          aAlfa1 = "01";
          aAlfa2 = #mod00263#5; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
          aAlfa3 = #mod00263#4;
          aFecha = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
          fDesdeFecha = aFecha;

          aAlfa1 = "31";
          aFecha = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
          fHastaFecha = aFecha;

          |BUCLE BorradoPrevio;
          ||HAZ BorradoCalJor;

          #mod00264#7 = nJornadas;
          |GRABA 020#mod00264.a;
          |LIBERA #mod00264;
     |SINO;
          |SI nColocadas < nJornadas;
               aAlfa1 = #mod00264#2; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
               aAlfa2 = #mod00263#5; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
               aAlfa3 = #mod00263#4;
               aFecha = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
               fFecha = aFecha;

               #labtraba#0 = #mod00264#0;
               #labtraba#1 = #mod00264#1;
               |LEE 000#labtraba.=;

               aAlfa = #labtraba#36;
               fFechaAlta = aAlfa;

               aAlfa = #labtraba#37;
               |QBF aAlfa;
               |SI aAlfa = ""; |O aAlfa = "..........";
                    fFechaBaja = "31.12.2099";
               |SINO;
                    fFechaBaja = aAlfa;
               |FINSI;

               |SI fFechaAlta [ fFecha; |Y fFecha [ fFechaBaja;
                    |HAZ GrabaDia;

                    #mod00264#7 = 1;
                    |GRABA 020#mod00264.a;
                    |LIBERA #mod00264;
               |FINSI;
          |FINSI;
     |FINSI;

     nAntEmp = #mod00264#0;
     nAntTra = #mod00264#1;
|FPRC;

|DEFBUCLE mod00264;
     #mod00264#2;
     ;
     #0#0, #0#2, #0#4, #0#5, 0, 0, 9999.99, 00;
     #0#1, #0#3, #0#4, #0#5, 0, 1, 0, 31;
     be;
     NULL, mod00264;
|FIN;

|PROCESO Calendario;
     swFestivo = 0;

     #nomfical#0 = #labtraba#156;
     #nomfical#1 = #0#4;
     |LEE 000#nomfical.=;

     fDiaLet = fFecha % 1;
     aDiaLet = fDiaLet;
     aDiaLet = aDiaLet % 1103;

     |SI aDiaLet = "Lun"; |Y #nomfical#2 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Mar"; |Y #nomfical#3 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Mie"; |Y #nomfical#4 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Jue"; |Y #nomfical#5 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Vie"; |Y #nomfical#6 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Sab"; |Y #nomfical#7 = 1; swFestivo = 1; |FINSI;
     |SI aDiaLet = "Dom"; |Y #nomfical#8 = 1; swFestivo = 1; |FINSI;

     aFecha = fFecha;
     aAlfa = (aFecha % 402) + (aFecha % 102);
     nFechaNume = aAlfa;

     |PARA nCampoF = 9; |SI nCampoF [ 96; |HACIENDO nCampoF = nCampoF + 3;
          nCampoF1 = nCampoF;
          nCampoF2 = nCampoF + 1;
          nCampoF3 = nCampoF + 2;

          aAlfa1 = #nomfical#nCampoF1#; |QBF aAlfa1;
          aAlfa2 = #nomfical#nCampoF2#; |QBF aAlfa2;
          nNume3 = #nomfical#nCampoF3#;
          |SI aAlfa1 ! ""; |Y aAlfa2 ! ""; |Y nNume3 = 1;
               aAlfa1 = (aAlfa1 % 302) + (aAlfa1 % 102);
               nNume1 = aAlfa1;
               aAlfa2 = (aAlfa2 % 302) + (aAlfa2 % 102);
               nNume2 = aAlfa2;
               |SI nNume1 [ nFechaNume; |Y nFechaNume [ nNume2;
                    swFestivo = 1;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     |SI swFestivo = 0;
          |PARA nCampoF = 99; |SI nCampoF [ 157; |HACIENDO nCampoF = nCampoF + 2;
               nCampoF1 = nCampoF;
               nCampoF3 = nCampoF + 1;

               aAlfa1 = #nomfical#nCampoF1#; |QBF aAlfa1;
               nNume3 = #nomfical#nCampoF3#;
               |SI aAlfa1 ! ""; |Y nNume3 = 1;
                    aAlfa1 = (aAlfa1 % 302) + (aAlfa1 % 102);
                    nNume1 = aAlfa1;
                    |SI nNume1 = nFechaNume;
                         swFestivo = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO mod00264_bor;
     |BORRA 020#mod00264.a;
     |LIBERA #mod00264;
|FPRC;

|DEFBUCLE mod00264_bor;
     #mod00264#1;
     ;
     #mod00262#0, #mod00262#1, #0#4, #0#5, 00;
     #mod00262#0, #mod00262#1, #0#4, #0#5, 31;
     be;
     NULL, mod00264_bor;
|FIN;

|PROCESO mod00262;
     |SI nAntEmp ! #mod00262#0; |O nAntTra ! #mod00262#1;
          || nuevo trabajador, borro todo
          |BUCLE mod00264_bor;
          swPrimerDia = 0;
     |FINSI;

     |DDEFECTO #mod00264;
     #mod00264#0 = #mod00262#0;
     #mod00264#1 = #mod00262#1;
     #mod00264#2 = #mod00262#4;

     aAlfa1 = #mod00262#4; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa2 = #mod00262#3; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = #mod00262#2;
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFecha = aAlfa;

     #labtraba#0 = #mod00262#0;
     #labtraba#1 = #mod00262#1;
     |LEE 000#labtraba.=;

     |HAZ Calendario;

     #mod00264#3 = swFestivo;
     #mod00264#4 = #mod00262#5;

     #mod00264#5 = #0#4;
     #mod00264#6 = #0#5;
     #mod00264#8 = #0#7;
     |SI swPrimerDia = 0;
         #mod00264#9 = 0;
         swPrimerDia = 1;
     |SINO;
         #mod00264#9 = 1;
     |FINSI;

     |GRABA 020#mod00264.n;
     |LIBERA #mod00264;

     || 00 - linea de totales

     #mod00264#0 = #mod00262#0;
     #mod00264#1 = #mod00262#1;
     #mod00264#2 = 00;
     #mod00264#5 = #0#4;
     #mod00264#6 = #0#5;
     |LEE 000#mod00264.=;
     |SI FSalida = 0;
          #mod00264#3 = 0;
          #mod00264#4 = #mod00264#4 + #mod00262#5;
          |GRABA 020#mod00264.a;
     |SINO;
          #mod00264#3 = 0;
          #mod00264#4 = #mod00262#5;
          #mod00264#8 = #0#7;
          |GRABA 020#mod00264.n;
     |FINSI;
     |LIBERA #mod00264;

     nAntEmp = #mod00264#0;
     nAntTra = #mod00264#1;
|FPRC;

|DEFBUCLE mod00262;
     #mod00262#1;
     ;
     #0#0, #0#2, #0#4, #0#5, 01;
     #0#0, #0#3, #0#4, #0#5, 31;
     ;
     NULL, mod00262;
|FIN;

|PROCESO Pase;
     nHoras = 0;

     ||aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_mod00264_" + aAlfa;
     ||NOME_DAT #mod00264#aAlfa#;
     ||DELINDEX #mod00264;

     |ABRE #mod00242;
     |ABRE #mod00243;
     |ABRE #mod00244;

     |ABRE #mod00264;
     |ABRE #labtraba;
     |ABRE #nomfical;
     |ABRE #gomdetjr;

     nHorasDia = #0#7;

     |BUCLE mod00262;
/*
     |DBASE aAlfa;
     aAlfa = aAlfa % 111;
     |SI aAlfa = "/u/dsprofes"; |O aAlfa = "/u/ccprofes";
          |CONSULTA_CLAVE #2#mod00264;
     |FINSI;
*/
     nAntEmp = 0;
     nAntTra = 0;
     |BUCLE mod00264;

     |HAZ ColocaTotal;
     ||HAZ topemes_C;
     ||BUCLE mod00264_C;

     |CIERRA #gomdetjr;
     |CIERRA #nomfical;
     |CIERRA #labtraba;
     ||CIERRA #mod00264;
     |CIERRA #mod00244;
     |CIERRA #mod00243;
     |CIERRA #mod00242;

     ||DELINDEX #mod00264;
|FPRC;

|PROGRAMA;
     |CLS;
     |CABEZA "Importacion Horas IDAL";
     |PINPA #0#0;
     |ABRE #0;
     |LEE 001#0p;
     |SI FSalida ! 0;
          |DDEFECTO #0;
          |GRABA 020#0n;
     |FINSI;
     |LEE 101#0=;
     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ Pase;
     |FINSI;

     |GRABA 020#0a;

     |LIBERA #0;
     |CIERRA #0;
|FPRO;
