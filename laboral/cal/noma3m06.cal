|FICHEROS;
     noma3m06 #0;
     noma3m07,MANTE;
     noma3m04;

     labtraba;
     nomtrali;
     nomconli;
     nom900de;
|FIN;

|VARIABLES;
     nModo2 = 0;
     nForma = 0;
     FEstado = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aMensa = "";
     aDescripcion = "";

     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;

     nDesdeConvenio = 0;
     nHastaConvenio = 0;
     swBoton = 0;
     nModo = 0;
|FIN;

|PROCESO borra_noma3m04;
     |BORRA 020#noma3m04.a;
     |LIBERA #noma3m04;
|FPRC;

|DEFBUCLE borra_noma3m04;
     #noma3m04#1;
     9;
     00001, 00001, 101, #0#0;
     99999, 99999, 999, #0#0;
     be;
     NULL, borra_noma3m04;
|FIN;

|PROCESO min;
     #noma3m04#9 = #0#0;
     #noma3m04#0 = 00001;
     #noma3m04#1 = 00001;
     #noma3m04#2 = 101;
|FPRC;

|PROCESO max;
     #noma3m04#9 = #0#0;
     #noma3m04#0 = 99999;
     #noma3m04#1 = 99999;
     #noma3m04#2 = 999;
|FPRC;

|PROCESO Pregunta; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 3;
          aAlfa = "    S¿Borrar los trabajadores con este Convenio de la tabla de exportación ";
          aAlfa = aAlfa + "de importes?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               |BUCLE borra_noma3m04;
          |FINSI;
          |ACABA;
     |FINSI;
     |SI FSalida = 1;
          aAlfa = "    S¿Desea recargar la tabla de exportación de importes por trabajador";
          aAlfa = aAlfa + " de este convenio?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               |BUCLE borra_noma3m04;

               |SALVA_FICHA #noma3m06;
               |HAZ GrabaTra;
               |REPON_FICHA #noma3m06;

               |ABRE #noma3m04;
               |CONSULTA_F_CLAVE #2#noma3m04, min, max;
               |CIERRA #noma3m04;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO noma3m07;
     || ahora por fin, para cada concepto de ese convenio, busco su importe
     || en importes por trabajador y si es correcto, lo grabo en el noma3m04

     #nomtrali#0 = #labtraba#0;
     #nomtrali#1 = #labtraba#1;
     #nomtrali#2 = #noma3m07#1;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0;
          |DDEFECTO #noma3m04;
          #noma3m04#0 = #nomtrali#0;
          #noma3m04#1 = #nomtrali#1;
          #noma3m04#2 = #nomtrali#2;
          |LEE 000#noma3m04.=;
          |SI FSalida ! 0;
               #noma3m04#0 = #nomtrali#0;
               #noma3m04#1 = #nomtrali#1;
               #noma3m04#2 = #nomtrali#2;
               #noma3m04#3 = #labtraba#2;
               #noma3m04#4 = #noma3m07#2;

               nNume1 = #nomtrali#3;
               nNume2 = #nomtrali#4;
               |SI nNume1 = 0; |Y nNume2 = 0;
                    |ACABA;
               |FINSI;

               |SI nNume1 = 0;
                    nNume1 = 1;
               |FINSI;

               nNume = nNume1 * nNume2;
               |SI nNume = 0;
                    |ACABA;
               |FINSI;

               #noma3m04#5 = nNume;

               #noma3m04#6 = #noma3m07#3;
               #noma3m04#7 = #noma3m07#4;

               #nomconli#0 = #labtraba#87;
               #nomconli#2 = #nomtrali#2;
               |LEE 000#nomconli.=;
               |SI FSalida = 0;
                    #noma3m04#8 = #nomconli#3;
               |FINSI;

               #noma3m04#9 = #labtraba#87;

               |GRABA 020#noma3m04.n;
               |LIBERA #noma3m04;
          |FINSI;
     |FINSI;
|FPRC;

|| segundo, a estos trabajadores les compruebo si en los conceptos del
|| noma3m07 tienen importes por trabajador

|DEFBUCLE noma3m07;
     #noma3m07#1;
     3;
     #noma3m06#0, 001, 001;
     #noma3m06#0, 999, 999;
     be;
     NULL, noma3m07;
|FIN;

|PROCESO ConceptosTra;
     |BUCLE noma3m07;
|FPRC;

|| primero busco trabajadores EN ALTA con este convenio

|DEFBUCLE RecargaTra;
     #labtraba#8;
     87;
     "A", 00001, 00001, #noma3m06#0;
     "A", 99999, 99999, #noma3m06#0;
     ;
     NULL, ConceptosTra;
|FIN;

|PROCESO noma3m06;
     |BUCLE RecargaTra;
|FPRC;

|DEFBUCLE noma3m06;
     #noma3m06#1;
     ;
     nDesdeConvenio;
     nHastaConvenio;
     ;
     NULL, noma3m06;
|FIN;

|PROCESO GrabaTra;
     || para la grabacion de los trabajadores

     || primero borro el fichero, ya que se cargara cada vez que
     || se entre en este proceso
     || solo si es desde el boton, que es desde donde se regraban todos

     |SI swBoton = 1;
          |DELINDEX #noma3m04;
     |FINSI;

     || ahora busco los convenios

     |ABRE #nomtrali;
     |ABRE #noma3m04;
     |ABRE #labtraba;
     |ABRE #nomconli;

     |SI swBoton = 1;
          nDesdeConvenio = 001;
          nHastaConvenio = 999;
     |SINO;
          nDesdeConvenio = #0#0;
          nHastaConvenio = #0#0;
     |FINSI;

     |BUCLE noma3m06;

     |CIERRA #nomconli;
     |CIERRA #labtraba;
     |CIERRA #noma3m04;
     |CIERRA #nomtrali;
|FPRC;

|PROCESO Tipo20; |TIPO 20;
     |SI FSalida = "OPCION";
          FSalida = "Recarga";
     |SINO;
          aAlfa = "    S¿Realizar la recarga de la tabla de exportación de importes ";
          aAlfa = aAlfa + "para los Convenios introducidos?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               swBoton = 1;
               |HAZ GrabaTra;
               swBoton = 0;

               |ABRE #noma3m04;
               |CONSULTA_CLAVE #1#noma3m04;
               |CIERRA #noma3m04;
          |FINSI;
     |FINSI;
|FPRC;

|| tercero, los que los importes por trabajador tengan valor
|| estos me los guardo en el noma3m07

|| con esto tengo en el noma3m07 la lista de conceptos de los que tengo
|| que grabar el lineal con los trabajadores con esos convenios y conceptos
|| en importes por trabajador

|PROCESO nomtrali;
     nNume1 = #nomtrali#3;
     nNume2 = #nomtrali#4;
     |SI nNume1 = 0; |Y nNume2 = 0;
          |ACABA;
     |SINO;
          #nomconli#0 = #labtraba#87;
          #nomconli#2 = #nomtrali#2;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               aDescripcion = #nomconli#6;
          |SINO;
               |SELECT #2#nom900de;
               #nom900de#1 = #nomtrali#2;
               |LEE 000#nom900de.=;
               |SI FSalida = 0;
                    aDescripcion = #nom900de#3;
               |SINO;
                    aDescripcion = "";
               |FINSI;
          |FINSI;

          |DDEFECTO #noma3m07;
          #noma3m07#0 = #labtraba#87
          #noma3m07#1 = #nomtrali#2;
          |LEE 000#noma3m07.=;
          |SI FSalida ! 0;
               #noma3m07#0 = #labtraba#87
               #noma3m07#1 = #nomtrali#2;
               #noma3m07#2 = aDescripcion;
               #noma3m07#3 = 000;
               #noma3m07#4 = "";
               |GRABA 020#noma3m07.n;
               |LIBERA #noma3m07;
          |FINSI;
     |FINSI;
|FPRC;

|| segundo, los que tengan importes por trabajador

|DEFBUCLE nomtrali;
     #nomtrali#1;
     ;
     #labtraba#0, #labtraba#1, 001;
     #labtraba#0, #labtraba#1, 999;
     be;
     NULL, nomtrali;
|FIN;

|PROCESO RecargaCon;
     |BUCLE nomtrali;
|FPRC;

|| primero busco trabajadores en alta con ese convenio

|DEFBUCLE RecargaCon;
     #labtraba#8;
     87;
     "A", 00001, 00001, #0#0;
     "A", 99999, 99999, #0#0;
     ;
     NULL, RecargaCon;
|FIN;

|PROCESO Recarga;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |ABRE #noma3m07;
          |ABRE #nomconli;
          |ABRE #nom900de;

          |BUCLE RecargaCon;

          |CIERRA #nom900de;
          |CIERRA #nomconli;
          |CIERRA #noma3m07;
     |FINSI;
|FPRC;
