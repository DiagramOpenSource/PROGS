|FICHEROS;
     nomz0020 #0;

     nomtmp20 #10,MANTE;

     labempre;
     labcentr;
     labtraba #2;

     silcon06 #20;
     silcon13 #21;

     nomcalca;
     nomhicca;
     nomvarca;
     nomvarcb;

     nomconca;
|FIN;

|VARIABLES;
   aAlfa  = "";
   aAlfa1  = "";
   aAlfa2  = "";
   aMarca = "";
   nCalc  = 0;
   nOpcion = 0;
   nNumTrab = 0;
   nNumMov = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "RPC";
    Menu5 = " Revisar ";
    Menu6 = " Preparar remesa";
    Menu7 = " Cancelar ";

     aFechaAlta = "";
     fFechaAlta = @;
     aFechaBaja = "";
     fFechaBaja = @;
     nFechaBaja = 0;
     fFecha = @;

     aFechaLim = "";
     fFechaLim = @;
     nFechaLim = 0;
     swSigue = 0;
     red_ultimo = 0;

     nEmp = 0;
     nTra = 0;

     swERE = 0;
     nCampo = 0;
     nCampo1 = 0;

     nDia = 0;
     &nTopemes = 0;
     &nMes = 0;
     &nAny = 0;
     nProp = 0;
     nTipo = 0;
     nDesde = 0;
     nHasta = 0;
     aDia = "";
     aMes = "";
     aAny = "";
     aFecha = "";
     aFuente = "";
     nAntTrab = 0;

     nCampoTip = 0;
     nCampoDes = 0;
     nCampoHas = 0;
     nCampoPro = 0;
     aTipo = "";
     nAnyXX = 0;

     swParcial = 0;
     nHorasSem = 0;
     nCoefTP = 0;
     nAnyCB = 0;
|FIN;

|PROCESO Calcula;
     |SI #nomtmp20#7 ! 0;
          #nomtmp20#3 = (#nomtmp20#8 * (#nomtmp20#7/1000)) ! 3;
     |SINO;
          #nomtmp20#3 = #nomtmp20#8;
     |FINSI;
     |PINTA #nomtmp20#3;
|FPRC;

|PROCESO Activa8; |TIPO 7;
     |SI #nomtmp20#5 = "V"; |O #nomtmp20#5 = "E"; |O #nomtmp20#5 = "R";
     |O #nomtmp20#5 = "Y";
          |CAMPO_MODIFICA #nomtmp20#8, 1, "N";
     |SINO;
          |CAMPO_MODIFICA #nomtmp20#8, 1, "S";
     |FINSI;
|FPRC;

|PROCESO AyudaTP; |TIPO 7;
     |PUSHV 06010780;
     |ATRI S;
     aAlfa = "³Si se trata de un contrato a TIEMPO PARCIAL, se  multiplicar  el coeficiente ³";
     |PINTA 0602, aAlfa;
     aAlfa = "³de tiempo parcial por el coeficiente de inactividad del ERTE.                ³";
     |PINTA 0702, aAlfa;
     |ATRI 0;
|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO Mensaje; |TIPO 7;
     |MENSA "    <ENTER> Modificar, <F5> Marcar/Desmarcar, <F6> Marcar todos, <F7> Ninguno";
|FPRC;

|PROCESO MarcaDesmarca;
     #nomtmp20#6 = aMarca; |GRABA 020#nomtmp20.a;
|FPRC;

|DEFBUCLE MarcaDesmarca;
     #nomtmp20#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, MarcaDesmarca;
|FIN;

|PROCESO MarcaUno; |TIPO 7;
     #nomtmp20#6 = "**";
     |PINTA #nomtmp20#6;
|FPRC;

|PROCESO Marcalo; |TIPO 11;
     |SI FSalida = 13;
          |SI #nomtmp20#6 = "**";
               #nomtmp20#6 = "  ";
          |SINO;
               #nomtmp20#6 = "**";
          |FINSI;

          |PINTA #nomtmp20#6;
          |GRABA 020#nomtmp20.a;
          |ERROR;
     |FINSI;
     |SI FSalida = 14; || Marca todo
          nEmp = #nomtmp20#0;
          nTra = #nomtmp20#1;

          aMarca = "**"; |BUCLE MarcaDesmarca;

          #nomtmp20#0 = nEmp;
          #nomtmp20#1 = nTra;
          |LEE 000#nomtmp20.=;

          |PONCONTROL 23, "si";
          |ERROR;
          |PTEC 809;
     |FINSI;

     |SI FSalida = 15; || Desmarca todo
          nEmp = #nomtmp20#0;
          nTra = #nomtmp20#1;

          aMarca = "  "; |BUCLE MarcaDesmarca;

          #nomtmp20#0 = nEmp;
          #nomtmp20#1 = nTra;
          |LEE 000#nomtmp20.=;

          |PONCONTROL 23, "si";
          |ERROR;
          |PTEC 809;
     |FINSI;
|FPRC;

|PROCESO inf04;
     #nomtmp20#0 = 00001
     #nomtmp20#1 = 00001
     #nomtmp20#4 = "01.01.2020";
|FPRC;

|PROCESO sup04;
     #nomtmp20#0 = 99999;
     #nomtmp20#1 = 99999;
     #nomtmp20#4 = "31.12.2099";
|FPRC;

|PROCESO borralo1;
     |BORRA 020#21a;
     |LIBERA #21;
|FPRC;

|DEFBUCLE borralo;
     #21#2;
     14;
     #2#0, #2#1, 0;
     #2#0, #2#1, 0;
     be;
     NULL, borralo1;
|FIN;

|PROCESO el_red;
          #labtraba#0 = #nomtmp20#0;
          #labtraba#1 = #nomtmp20#1;

          |LEE 000#labtraba.=;

          |ABRE #21;
          |LEE 000#21u;
          |SI FSalida ! 0;
               red_ultimo = 1;
          |SINO;
               red_ultimo = #21#0 + 1;
          |FINSI;
          |CIERRA #21;

          ||BUCLE borralo;

          |ABRE #21;
          |DDEFECTO #21;
          #21#0 = red_ultimo;
          |GRABA 020#21b;

          #21#1 = #nomtmp20#0;          || empresa
          #21#2 = #nomtmp20#1;          || trabajador
          #21#3 = "MIN";
          #21#13 = #nomtmp20#4;
          #21#37 = #nomtmp20#5;
          #21#43 = #nomtmp20#3;

          |GRABA 020#21a;
          |LIBERA #21;
          |CIERRA #21;

     nNumMov = nNumMov + 1;
     |SI nAntTrab ! #labtraba#1;
          nNumTrab = nNumTrab + 1;
     |FINSI;

     nAntTrab = #labtraba#1;

|FPRC;

|DEFBUCLE el_red;
     #nomtmp20#1;
     6;
     00001, 00001, "01.01.1900", "**";
     99999, 99999, "31.12.2099", "**";
     ;
     NULL, el_red;
|FIN;

|PROCESO Lote;
     |ABRE #labtraba;

     |BUCLE el_red;

     |CIERRA #labtraba;

     |SI nNumTrab > 0;
          aAlfa1 = nNumTrab;
          aAlfa2 = nNumMov;
          aAlfa = "    Se ha preparado la remesa: ";
          aAlfa = aAlfa + aAlfa1;
          |SI nNumTrab = 1;
               aAlfa = aAlfa + " trabajador y "
          |SINO;
               aAlfa = aAlfa + " trabajadores y "
          |FINSI;
          aAlfa = aAlfa + aAlfa2 + " movimientos de inicio/fin de inactividad";
          |MENAV aAlfa;

          aAlfa = "    Puede crear el lote desde la opción - Creación Lote ";
          aAlfa = aAlfa + "AFI - para el Sistema RED";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO TiempoParcial;
     swParcial = 0;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |SI 200 [ #labtraba#45; |Y #labtraba#45 [ 299;
               swParcial = 1;
          |FINSI;
          |SI 500 [ #labtraba#45; |Y #labtraba#45 [ 599;
               swParcial = 1;
          |FINSI;
          |SI swParcial = 1;
               nHorasSem = 40;
               |ABRE #nomconca;
               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nHorasSem = #nomconca#162;
               |FINSI;
               nCoefTP = #labtraba#234 / nHorasSem;
               nCoefTP = nCoefTP ! 3;
               #nomtmp20#7 = nCoefTP * 1000;
               |CIERRA #nomconca;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaLin;
     |DDEFECTO #nomtmp20;

     #nomtmp20#0 = #labtraba#0;
     #nomtmp20#1 = #labtraba#1;

     nMes = #0#4;
     nAny = #0#5;

     |SI nTipo = 0;      || movimiento de inactividad
          nDia = nDesde;
          aDia = nDia; |QBF aDia; aDia = ("00" + aDia) % -102;
          aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
          aAny = nAny;
          aFecha = aDia + "." + aMes + "." + aAny;
          fFecha = aFecha;
          #nomtmp20#4 = fFecha;
     |FINSI;
     |SI nTipo = 1;      || movimiento de fin de inactividad
          nDia = nHasta;
          |HAZ topemes_plb;

          |SI nHasta = nTopemes;
               nDia = 1;
               nMes = nMes + 1;
               |SI nMes = 13;
                    nMes = 1;
                    nAny = nAny + 1;
               |FINSI;
          |SINO;
               nDia = nDia + 1;
          |FINSI;

          aDia = nDia; |QBF aDia; aDia = ("00" + aDia) % -102;
          aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
          aAny = nAny;
          aFecha = aDia + "." + aMes + "." + aAny;
          fFecha = aFecha;
          #nomtmp20#4 = fFecha;
     |FINSI;

     |LEE 101#nomtmp20.=;

     |SI FSalida = 0;
          || ya existia, no estoy leyendo variaciones y ya habia leido
          || mensual, donde estaba calculada
          |ACABA;
     |FINSI;

     #nomtmp20#2 = #labtraba#2;
     #nomtmp20#3 = 0;
     #nomtmp20#5 = #0#2;
     #nomtmp20#6 = "**";

     |SI nProp ! 100;
          |SI #0#2 = "E"; |O #0#2 = "F";
               #nomtmp20#5 = "F";
          |FINSI;
          |SI #0#2 = "V"; |O #0#2 = "W";
               #nomtmp20#5 = "W";
          |FINSI;
          |SI #0#2 = "R"; |O #0#2 = "S";
               #nomtmp20#5 = "S";
          |FINSI;
          |SI #0#2 = "Y"; |O #0#2 = "U";
               #nomtmp20#5 = "U";
          |FINSI;
          nProp = (100 - nProp) ! 0;
     |FINSI;

     |SI nTipo = 0;      || movimiento de inactividad
          |HAZ TiempoParcial;

          |SI #nomtmp20#5 = "W"; |O #nomtmp20#5 = "F";
          |O #nomtmp20#5 = "S"; |O #nomtmp20#5 = "U";
               |SI nProp ! 0;
                    nProp = nProp * 10;
                    #nomtmp20#8 = nProp;
                    #nomtmp20#3 = nProp;

                    |SI swParcial = 1;
                          #nomtmp20#3 = nProp * nCoefTP;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nTipo = 1;      || movimiento de fin de inactividad
          #nomtmp20#5 = " ";
     |FINSI;

     |SI aFuente = "M"; #nomtmp20#9 = "MEN"; |FINSI;
     |SI aFuente = "H"; #nomtmp20#9 = "HIS"; |FINSI;
     |SI aFuente = "V"; #nomtmp20#9 = "VAR"; |FINSI;
     |SI aFuente = "W"; #nomtmp20#9 = "VA2"; |FINSI;

     |GRABA 020#nomtmp20.n;

     nNumTrab = nNumTrab + 1;
     |LIBERA #nomtmp20;
|FPRC;

|PROCESO Incidencia;
     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     nTipo = 0;     || inactividad
     |HAZ GrabaLin;
     nTipo = 1;     || fin de inactividad
     |HAZ GrabaLin;
|FPRC;

|PROCESO BuscaERE;
     |SI aFuente = "M";
          nEmp = #nomcalca#0;
          nTra = #nomcalca#1;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               nCampoTip = nCampo;
               aTipo = #nomcalca#nCampoTip#;
               |SI aTipo = "D";
                    nCampoDes = nCampo - 8;
                    nCampoHas = nCampo - 4;
                    nCampoPro = nCampo + 92;

                    nDesde = #nomcalca#nCampoDes#;
                    nHasta = #nomcalca#nCampoHas#;
                    nProp = #nomcalca#nCampoPro#;

                    |HAZ Incidencia;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI aFuente = "V";
          nEmp = #nomvarca#0;
          nTra = #nomvarca#1;
          |PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
               nCampoTip = nCampo;
               aTipo = #nomvarca#nCampoTip#;
               |SI aTipo = "D";
                    nCampoDes = nCampo - 8;
                    nCampoHas = nCampo - 4;
                    nCampoPro = nCampo + 35;

                    nDesde = #nomvarca#nCampoDes#;
                    nHasta = #nomvarca#nCampoHas#;
                    nProp = #nomvarca#nCampoPro#;

                    |HAZ Incidencia;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI aFuente = "H";
          nEmp = #nomhicca#0;
          nTra = #nomhicca#1;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               nCampoTip = nCampo;
               aTipo = #nomhicca#nCampoTip#;
               |SI aTipo = "D";
                    nCampoDes = nCampo - 8;
                    nCampoHas = nCampo - 4;
                    nCampoPro = nCampo + 134;

                    nDesde = #nomhicca#nCampoDes#;
                    nHasta = #nomhicca#nCampoHas#;
                    nProp = #nomhicca#nCampoPro#;

                    |HAZ Incidencia;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI aFuente = "W";
          nEmp = #nomvarcb#0;
          nTra = #nomvarcb#1;

          aTipo = #nomvarcb#7;
          |SI aTipo = "D";
               nDesde = #nomvarcb#5;
               nHasta = #nomvarcb#6#;
               nProp = #nomvarcb#11;

               |HAZ Incidencia;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomvarcb;
     #nomvarcb#1;
     ;
     #0#0, 00001, #0#4, 0, nAnyCB, 01;
     #0#0, 99999, #0#4, 0, nAnyCB, 31;
     ;
     NULL, BuscaERE;
|FIN;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #0#0, 00001, nAnyXX, #0#4, 0;
     #0#0, 99999, nAnyXX, #0#4, 0;
     ;
     NULL, BuscaERE;
|FIN;

|DEFBUCLE nomcalca;
     #nomcalca#1;
     ;
     #0#0, 00001, #0#4, 0;
     #0#0, 99999, #0#4, 0;
     ;
     NULL, BuscaERE;
|FIN;

|DEFBUCLE nomvarca;
     #nomvarca#1;
     ;
     #0#0, 00001, #0#4, 0;
     #0#0, 99999, #0#4, 0;
     ;
     NULL, BuscaERE;
|FIN;

|PROGRAMA;
     |CLS;
     |CABEZA " ";
     |ABRE #0;
     |LEE 001#0p;
     |SI FSalida ! 0;
          |DDEFECTO #0;
          |GRABA 020#0n;
     |FINSI;
     |LEE 101#0=;

     |PINPA #0#0; |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmp20_" + aAlfa;
          |DELINDEX #nomtmp20;
          |ABRE #nomtmp20;
          nNumTrab = 0;
          |ABRE #labempre;
          |ABRE #labcentr;
          |ABRE #labtraba;
          |ABRE #nomcalca;
          |ABRE #nomhicca;
          |ABRE #nomvarca;
          |ABRE #20;

          aFuente = "H";
          nAnyXX = #0#5 - 2000;
          |BUCLE nomhicca;

          nMes = #0#4;
          nAny = #0#5;
          aFuente = "M";
          |BUCLE nomcalca;

          aFuente = "V";
          |BUCLE nomvarca;

          aFuente = "W";
          nAnyCB = 0000;
          |BUCLE nomvarcb;
          nAnyCB = 2020;
          |BUCLE nomvarcb;

          |CIERRA #labempre;
          |CIERRA #labtraba;
          |CIERRA #labcentr;

          |CIERRA #nomvarca;
          |CIERRA #nomhicca;
          |CIERRA #nomcalca;

          |ET OtraVez;

          |ENTLINEAL #1#nomtmp20, -2, 2, 22, 1, inf04, sup04;
          |SI nNumTrab = 0;
              |CIERRA #20;
              |CIERRA #nomtmp20;
              |DELINDEX #nomtmp20;
              |ACABA;
          |FINSI;

          |ET OtroMenu;
          |MENU Menu;
          nOpcion = FSalida;
          |SI nOpcion = 1; |VETE OtraVez;   |FINSI;
          |SI nOpcion = 2;
               nNumTrab = 0;
               |HAZ Lote;
          |FINSI;
          |SI nOpcion = 3;
               aAlfa = "    S¿Está seguro de que desea salir sin preparar la remesa?";
               |CONFI aAlfa;
               |SI FSalida ! 0;
                    |VETE OtraVez;
               |FINSI;
          |FINSI;
          |SI nOpcion < 1; |VETE OtroMenu; |FINSI;
          |CIERRA #nomtmp20;   |DELINDEX #nomtmp20;
          |CIERRA #20;
     |FINSI;
     |SI FSalida = 0;
          |GRABA 020#0a;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;
