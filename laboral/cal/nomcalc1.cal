|FICHEROS;
     nomcalcu #0;             /*********************************************/
     labempre;                /*                                           */
     labtraba #2;             /*  NO CABEN MAS ARCHIVOS, USAR EL NOMCALC3  */
     nomhisit #101;           /*                                           */
     nomconax #14;            /*********************************************/
     nomvarca #7;
     nommauto;
     nomimpr1;                /*********************************************/
     nomimpr2;                /*  OJO, 7933 LINEAS A 26.06.2017            */
     nomcalca;                /*********************************************/
     nomcalli;
     nomcalal;
     nombonif;
     nomhicca;
     nomhicli;
     nomnorco;
     nomcontr;
     nomcatli #4;
     nomtrali #6;
     nomvarli #8;
     nomconli #10;
     nomembca;
     nomembli;
     nomabsli;
     nomcalfi;
     nomfical;
     labmunic;
     nomtrcal;
     nomfinli;
     nomconca;
     nomconst;
     nomir012;
     nomgirli;
     &copiadef@ #500;      || para hacer CARGA_DEF, que ya no caben mas ficheros
     copiade1@ #501;      || para hacer CARGA_DEF, que ya no caben mas ficheros
     nomhisi2;
     nomabsca;
     nomabsli;
     nomembcf;
     nombotra;
     nomboni3;
     nomred01;
     nomred02;
     nomred03;
     nomred04;
     nomcaldl;
     nompanta;
|FIN;

|VARIABLES;
     &runnom = "";
     &nPasoIT = 0;
     &aDef = "";
     &campos = 0;
     &topemes1 = 0;
     &topemes2 = 0;
     &dmate_0 = 0;
     &denfe_0 = 0;
     &dacci_0 = 0;
     &dacci_21 = 0;
     &dacci_22 = 0;
     &dacci_23 = 0;
     &dacci_24 = 0;
     &dacci_X0 = 0;
     &nume1 = 0;
     &para1 = 0;
     &prom_enf = 0;
     &prom_acc = 0;
     &prom_ac2 = 0;
     &nDiasAlta = 0;
     &nCarencia = 180;
     &denfe_A0 = 0;
     &denfe_B0 = 0;
     &denfe_C0 = 0;
     &denfe_D0 = 0;

     &denfe_XX = 0;
     &denfe_XXC = 0;
     &dacci_XX = 0;
     &dacci_XXC = 0;

     &denfe_Y1 = 0;
     &denfe_Y2 = 0;
     &denfe_Y1_H = 0;
     &denfe_Y2_H = 0;

     &denfe_U = 0; &denfe_S = 0; &denfe_T = 0; &denfe_R = 0;
     &denfe_X = 0; &denfe_Y = 0; &denfe_W = 0; &denfe_V = 0;
     &denfe_U_H = 0; &denfe_S_H = 0; &denfe_T_H = 0; &denfe_R_H = 0;
     &denfe_X_H = 0; &denfe_Y_H = 0; &denfe_W_H = 0; &denfe_V_H = 0;
     &dacci_z = 0; &dacci_Z = 0; &dacci_Y = 0; &dacci_y = 0;
     &dacci_z_H = 0; &dacci_Z_H = 0; &dacci_Y_H = 0; &dacci_y_H = 0;
     &dacci_ZC = 0; &dacci_ZC_H = 0; &dacci_YC = 0; &dacci_YC_H = 0;

     &denfe_U0 = 0; &denfe_U0_H = 0; &denfe_UC0 = 0;
     &denfe_S0 = 0; &denfe_S0_H = 0; &denfe_SC0 = 0;
     &denfe_T0 = 0; &denfe_T0_H = 0; &denfe_TC0 = 0;
     &denfe_R0 = 0; &denfe_R0_H = 0; &denfe_RC0 = 0;

     &denfe_Y0 = 0; &denfe_Y0_H = 0; &denfe_YC0 = 0;
     &denfe_X0 = 0; &denfe_X0_H = 0; &denfe_XC0 = 0;
     &denfe_W0 = 0; &denfe_W0_H = 0; &denfe_WC0 = 0;
     &denfe_V0 = 0; &denfe_V0_H = 0; &denfe_VC0 = 0;

     &dacci_z0 = 0; &dacci_z0_H = 0; &dacci_zC0 = 0;
     &dacci_Z0 = 0; &dacci_Z0_H = 0; &dacci_ZC0 = 0;
     &dacci_Y0 = 0; &dacci_Y0_H = 0; &dacci_YC0 = 0;
     &dacci_y0 = 0; &dacci_y0_H = 0; &dacci_yC0 = 0;

     &dacum_999 = 0;
     &denfe_3 = 0;
     &denfe_4 = 0;
     &dacci_3 = 0;
     &base_1 = 0;
     &base_2 = 0;
     &base_3 = 0;

     &campo1 = 0;
     &campo2 = 0;
     &campo3 = 0;
     &campo4 = 0;
     &swSegPasada = 0;

     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aMes = "";
     &nMes = 0;
     &nElMes = 0;
     aAny = "";
     &nAny = 0;
     &nElAny = 0;
     &nTopemes = 0;
     aDia = "";
     nDia = 0;
     FEstado = 0;
     &nIncid = 0;
     &nContLog = 0;
     &nNroErrores = 0;
     &swIniLog = 0;
     &aDesIncid = "";

     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     alfa5 = "";
     alfa6 = "";
     alfa7 = "";
     alfa8 = "";
     alfa9 = "";
     alfa10 = "";
     &nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     nume5 = 0;
     nume6 = 0;
     nume7 = 0;
     nume8 = 0;
     nume9 = 0;
     nume10 = 0;
     &anticom2 = 0;
     &anticom3 = 0;
     &swCalPror = 0;
     &swCalPaga = 0;
     &dvalo_pro = 0;
     &nPropPrac = 1;

     aFecha = "";
     fFecha = @;
     fFecha1 = @;
     fFecha2 = @;
     &aFechaAlta = "";
     fFechaAlta = @;
     &aFechaRef = "";
     &fecha_bon_16 = "";
     &nMesesBon16 = 0;
     &nAnyosBon16 = 0;
     &por_bon_16A = 0;
     &nPB16Calc = 0;
     &nPB16CalcA = 0;
     &por_bon_16 = 0;
     &por_bon_60 = 0;
     &bon_60 = 0;
     &bon_60A = 0;
     &aParam = "";
     &swNoMensa = 0;
     &base_6 = 0;
     &EURODB = 0;
     &nPrecioVar = 0;
     &concepto = 0;
     &porce = 0;
     &swConceptoOFF = 0;

     &swCumple = 0;
     &aNif = "";
     fech1 = @;
     fech2 = @;
     &mesnum = 0;
     &anynum = 0;
     &topemes = 0;
     &bisiesto = 0;
     &acum_53 = 0;
     &acum_54 = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nCampo = 0;
     nCampoD = 0;
     nCampoH = 0;
     numer = 0;
     nEdadParaBon = 0;
     nDiaCambioA60 = 0;
     nDiaCambioA59 = 0;
     &bon_55 = 0;
     aEPBon = "";

     aFabre = "";
     &ay_emp = 0;
     &ay_tra = 0;
     &ay_mes = 0;
     &ay_any = 0;
     &ay_ant = "";

     nConcepAju = 0;
     nTipoAjuste = 0;
     nImpoAjuste = 0;
     nSituaciAju = 0;
     aDescripAju = "";
     nImporteAju = 0;
     nImporteAju1 = 0;
     nImporteAju2 = 0;
     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     &nPaso = 0;
     &swCompAjuste = 0;
     &dcofi_999 = 0;
     &swDiosMio = 0;
     &swComp120 = 0;
     &nBaseIT2 = 0;
     &nBaseComp = 0;
     &nImporte_E = 0;
     &nDiasTeor_E = 0;
     &nDiasReal_E = 0;
     aMesAlta = "";
     aAnyAlta = "";
     nMesAlta = 0;
     nAnyAlta = 0;
     &nEmbargo = 0;
     aMas = "";
     aFich = "";
     aBase = "";
     &bon_59 = 0;
     &nAnysParaAnt = 0;
     &nVacMesAct = 0;
     &nVacRestoAny = 0;
     aFechaDesde = "";
     aFechaHasta = "";
     fFechaDesde = @;
     fFechaHasta = @;

     diff = 0;
     &guarda = 0;
     &swaju_des = 0;
     &swaju_hue = 0;
     &swaju_abs = 0;
     &swaju_acc = 0;
     &swaju_enf = 0;
     &swaju_mat = 0;
     &denfe_2 = 0;
     &denfe_21 = 0;
     &denfe_22 = 0;
     &denfe_23 = 0;
     &denfe_24 = 0;
     &ddese_2 = 0;
     &ddese_3 = 0;
     &dhuel_2 = 0;
     &dhuel_3 = 0;
     &dabse_2 = 0;
     &dacci_2 = 0;
     &dmate_2 = 0;
     fecha_ini_bon = @;
     any_ini_bon = 0;
     &nPresDia = 0;
     aTipo = "";
     &bruto_pag = 0;
     &swHistor = 0;
     &nDiasVac = 0;
     fFechaIni = @;
     &nDiasLabTra = 0;
     &nDiasLabAny = 0;
     nPos = 0;
     &aFechaBaja = "";
     nDesdeDia  = 0;
     nHastaDia  = 0;
     &aBaja1_Art = "";
     &aBaja2_Art = "";
     &aBaja3_Art = "";
     &aBaja4_Art = "";
     campo = 0;
     desde = 0;
     &hasta = 0;
     &mesco = 0;
     tipo = 0;
     prop = 0;
     aAlfa3 = "";
     aAlfa4 = "";
     &aTipoITAcum = "";
     &nDiasITAcum = 0;
     nEmp = 0;
     nTra = 0;

     fFechaBaja = @;
     fech4 = @;
     fech5 = @;
     &swSigue = 0;
     nDiaBaja = 0;
     nFecha = 0;
     aUnid = "";
     nUnidades = 0;
     nRango = 0;
     nImporInd = 0;
     nDConcepto = 0;
     nHConcepto = 0;
     nConcepto1 = 0;
     aPrecio = "";
     &swModulo = 0;
     nTImporInd = 0;
     &nMesesAlta = 0;
     swTengoDerecho = 0;
     fFechaAnt = @;
     aDiaAlta = "";
     nDiaAlta = 0;
     aDiaBaja = "";
     aMesBaja = "";
     nMesBaja = 0;
     aAnyBaja = "";
     nAnyBaja = 0;
     nPropAlta = 0;
     nNumDias = 0;
     nPorCada = 0;
     nFechaAlta = 0;
     nConceptos = 0;
     &nIRPF1 = 0;
     &nIRPF2 = 0;
     &nIRPF3 = 0;
     &duni1_902 = 0;
     &duni2_902 = 0;
     &dvalo_902 = 0;
     product = 0;
     &convenio = 0;
     nFechaBaja = 0;

     &nTotBru = 0;
     &aFechaFIN = "";
     fFechaFIN = @;
     &nTotInd = 0;
     &nDiasPago = 0;

     &graba04 = 0;
     &graba05 = "";
     &graba06 = 0;
     &graba07 = 0;
     &graba08 = "";
     &graba09 = 0;
     &graba10 = 0;
     &graba11 = 0;
     &swgracon = 0;
     &swcongra = 0;
     &unidades = 0;
     &fijo_1 = 0;
     &doce = 0;
     tempo1 = 0;
     tempo2 = 0;
     tempo3 = 0;
     tempo4 = 0;
     tempo5 = 0;

     &acum_40 = 0;
     &acum_401 = 0;
     &acum_402 = 0;
     &acum_403 = 0;
     &acum_41 = 0;
     &acum_60 = 0;
     &duni2_999 = 0;
     &dvalo_999 = 0;
     nDesde = 0;
     nHasta = 0;
     nDias = 0;
     nCampoDias = 0;
     nMeses = 0;
     &swContCont = 0;
     aFechaBajaAct = "";
     &nMesIRPF = 0;
     nFecha1 = 0;
     nFecha2 = 0;
     &aFeBajaReal = "";

     &nIngresos = 0;
     &nIngresosPag = 0;
     &nDeducc = 0;
     &nDeduccPag = 0;
     &nLiquidoNom = 0;
     &nLiquidoPag = 0;

     &bruto_rec = 0;                            || BRUTO
     &dto_con = 0;                 || cont. comunes.
     &deducss = 0;                 || cont. comunes.
     &dto_dfp = 0;            || cont. profesionales
     &dto_ho1 = 0;   || cont. horas
     &dto_ho2 = 0;   || cont. horas
     &antici1 = 0;  || anticipos
     &antici2 = 0;  || anticipos
     &antici4 = 0;  || anticipos
     &especie = 0;            || en especie
     &nAcumAbs = 0;           || absentismos
     &swbaja = 0;
     &acum2_200 = 0;
     &reten_1 = 0;
     &reten_2 = 0;
     &reten_11 = 0;
     &reten_12 = 0;
     &reten_13 = 0;
     &antici3 = 0;  || anticipos
     &reten_p = 0;
     nCuotaEmb = 0;
     nSMI = 0;
     nLiqEmb = 0;
     nLimite = 0;
     nLimite1 = 0;
     nLimite2 = 0;
     nPasada = 0;
     nPor = 0;
     &dalta_3 = 0;
     &dbaja_3 = 0;
     &dcoti_0 = 0;
     &dia_2 = 0;
     &dia_4 = 0;
     &nRetEstAnu = 0;
     &coba_1 = 0;
     &cobb_1 = 0;
     &cobb_2 = 0;
     &coba_2 = 0;
     &coba_4 = 0;
     &cobb_4 = 0;
     swExiste902 = 0;
     swExiste410 = 0;
     swExiste415 = 0;
     &nDesem = 0;
     swExiste = 0;
     nImporte = 0;
     nDiasMes = 0;
     nMesBusca = 0;
     nAnyBusca = 0;
     nTipo = 0;
     &histori = "";
     &histori2 = "";
     &histori3 = "";
     &nDiaCumple2 = 0;
     &swAjuste3 = 0;
     &swAjuste3_2 = 0;
     &swAjuste3_C = 0;
     &duni1_999 = 0;
     &divide = 0;
     &aTipoIT = "";
     &camhos = 0;
     &aHosp = "";
     &aReca = "";
     nDesdeAny = 0;
     nHastaAny = 0;
     &ajuste7 = 0;
     &mid = 0;
     &meslabo = "";
     aCon = "";
     &denfe_NO = 0;
     &denfe_Z0 = 0;
     &nDesEnf = 0; &nDesAcc = 0; &nDesMat = 0;
     &nDesPat = 0; &nDesRie = 0; &nDesCon = 0;
     &nBonifERE = 0;
     &nDiasBonifERE = 0;
     &base_A = 0;
     &nBonifFCI = 0;
     &nBonifFCI1 = 0;
     &nBonifFCI2 = 0;
     &nBonifFCI_T1 = 0;
     &nBonifFCI_T2 = 0;
     &tp = 0;
     &nBonifTex = 0;
     &nBonifTex1 = 0;
     &nBonifTex2 = 0;
     nEdad = 0;
     &nAjuste = 0;
     &stop = 0;
     &acum_10 = 0;
     &acum_11 = 0;
     &acum_50 = 0;
     &acum_99 = 0;
     &acum_991 = 0;
     &acum_992 = 0;
     &acum_993 = 0;
     &swParcheAjuIT = 0;
     &nBaseMesAntIT = 0;
     swNoEntra = 0;
     nAjuEmb = 0;
     aFecha1 = "";
     aFecha2 = "";
     nPuntero = 0;
     nDiasLab = 0;
     nDiasFes = 0;
     &nDiasDesCoef = 0;
     nMaxDiasAlta = 0;
     fech3 = @;
     fech6 = @;
     &swAjusteD = 0;
     &swAjusteDD = 0;
     fIniBon = @;
     aIniBon = "";
     fAny1Bon = @;
     fAny2Bon = @;
     swCambioBon = 0;
     nDiasBon_1 = 0;
     fFechaCal = @;
     fFechaIniBon = @;
     fFechaFinBon = @;
     nDiasBon = 0;
     &hcoti_0 = 0;
     &aIndTex = "";
     &nCodBonFom1 = 0;
     &nCodBonFom2 = 0;
     &nCodBonTex1 = 0;
     &nCodBonTex2 = 0;
     &swDupli = 0;
     &nCuantos = 0;
     &swPrimera = 0;
     aFechaIT = "";
     &nTrabDupli = 0;
     &nRemunMes = 0;
     &nRemunMesOri = 0;
     nRemunMesDia = 0;
     nRemunMayo = 0;
     nRemunMayoDia = 0;
     nDiasMayo = 0;
     &dcobr_0 = 0;
     nRemunMesAper = 0;
     nRemunMayoAper = 0;
     swPaso = 0;
     &nEl928 = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nCampo4 = 0;
     &dacum_30 = 0;
     &dacum_31 = 0;

     &nEstoyEnAjuste = 0;
     &swFuncRecorte = 0;
     &nNuevaAcum10 = 0;
     &nAjusteEBnor1 = 0;
     &nAjusteEBnor2 = 0;
     &nAjusteEBnor3 = 0;
     &nomtmpca = "";
     &nomtmpli = "";
     &nDiferPror = 0;
     &paga = 0;
     &nUnidYaPagadas = 0;
     &aFiestaAct = "";
     &nDiaAct1 = 0; &nDiaAct2 = 0; &nDiaAct3 = 0; &nDiaAct4 = 0;
     &nDiaAct5 = 0; &nDiaAct6 = 0; &nDiaAct7 = 0; &nDiaAct8 = 0;
     &nTFAct = 0;    || total dias de fiesta por Actividad en el mes
     any = 0;
     nProp = 0;
     swHijos = 0;
     nPara1 = 0;
     nPara2 = 0;
     nAnyRef = 0;
     nMesRef = 0;
     &nTotalPrecioVar = 0;
     &nPrecioVarMes = 0;
     &dacum_999_completo = 0;
     nBaseReal = 0;
     nBaseGrabada = 0;
     nDiferencia = 0;
     nRemunMesRefApli = 0;
     nDiasDesde = 0;
     nDiasTramo = 0;
     nRestoDias = 0;
     &nPresDiaEnf = 0;
     &nPresDiaAcc = 0;

     &aFecBajaBon = "";
     &nDiasBonBaja = 0;
     nAltaBonif = 0;
     nBajaBonif = 0;
     nBaja = 0;
     nInicioBaja = 0;
     nFinBaja = 0;
     nRemunMayoTeor = 0;
     nMesPaga = 0;
     nDiasPaga = 0;
     nImportePaga = 0;
     &fecbaj = "";
     &nPasoLog = 0;
     &nCanal = 0;

     nCampoDesde = 0;
     nCampoHasta = 0;
     nCampoTipo = 0;
     nCampoPorc = 0;
     sw100por100 = 0;
     nInembargable = 0;
     swPagasProrr = 0;
     nCampoPT = 0;
     &nDiasEnfBase2 = 0; &nDiasAccBase2 = 0; &nDiasMatBase2 = 0;
     &denfe_A_Base2 = 0; &denfe_B_Base2 = 0; &denfe_C_Base2 = 0; &denfe_D_Base2 = 0;
     &dacci_X2_Base2 = 0;
     &aTipoITBase2 = "";
     &nPromedio = 0;
     nPropProrr = 0;
     &denfe_U_Base2 = 0; &denfe_T_Base2 = 0;
     &denfe_S_Base2 = 0; &denfe_R_Base2 = 0;
     &denfe_Y_Base2 = 0; &denfe_X_Base2 = 0;
     &denfe_W_Base2 = 0; &denfe_V_Base2 = 0;
     nPromedioBase = 0;
     &swIndem = 0;
     &nConceptoInd = 0;
     swGastosACero = 0;
     nVeces = 0;
     nResto = 0;
     nAcumDias = 0;
     nAcumDiasSueltos = 0;
     nTotalDias = 0;
     nTotalDiasSueltos = 0;
     sw125acero = 0;
     &swAbsVacHue = 0;
     &swAgosto2012 = 0;
     nTotAju = 0;
     sw920 = 0;
     &swProrPaga = 0;
     &nImportePagaMes = 0;
     nConcPaga = 0;
     nFinConcPaga = 0;
     nContrato = 0;
     nDiasLey = 0;
     &dto_sol_tra = 0;
     fFechaIniNom = @;
     fFechaFinNom = @;
     nOtroLiquido = 0;
     aFechaIniNom = "";
     aFechaFinNom = "";
     nOtroEmbEmp = 0;
     nOtroEmbTra = 0;
     nLiquidoOtroNom = 0;
     nLiquidoOtroPag = 0;
     nEmbargoOtro = 0;
     &exce_smi = 0;
     &nArrAnyAnt = 0;
     swAjuCompFeb = 0;
     &nBonifJuv = 0;
     swAdadeAgrHor = 0;
     swAdadeCitrico = 0;
     nUnidadesCon = 0;
     nGuardaMeses = 0;
     nHoras = 0;
     aImporte = "";
     sw949 = 0;
     &dreca_1 = 0; &dreca_2 = 0; &dreca_3 = 0; &dreca_4 = 0;
     &enMes = 0;
     &enAny = 0;
     &enDiasAlta = 0;
     fFechaCambio = @;
     nFechaCambio = 0;
     aIniPer = "";
     aFinPer = "";
     fIniPer = @;
     fFinPer = @;
     aFechaCambio = "";
     nDiasAny1 = 0;
     nDiasAny2 = 0;
     &aVersion = "";
     aMenu = ""; aArchivo = ""; aLinea = "";
     &nDiasBonifJuv = 0;
     &nJornadasIT = 0;
     &nPreavisoAbo = 0;
     &nPreavisoDto = 0;
     &nVacDto = 0;
     aOcupadas = "";
     nPos965 = 0;
     aLon = ""; aLoc = "";
     nLon = 0; nLoc = 0;
     swOcupado = 0;
     swOtroPag = 0;
     &nHospi = 0;
     nEmbIntegro = 0;
     &swFijoDisc = 0;
     &nBase946 = 0; &nBase947 = 0;
     &nBaseDes2 = 0;
     &nPropDesTP = 0;
|FIN;

|PROCESO VacacVaria;
     sw125acero = 0;
     |ABRE #nomvarli;
     #nomvarli#0 = #labtraba#0;
     #nomvarli#1 = #labtraba#1;
     #nomvarli#2 = nElMes;
     #nomvarli#3 = 0;
     #nomvarli#4 = 125;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0;
          aAlfa = #nomvarli#5;
          |QBF aAlfa;
          |SI aAlfa ! "";
               nNume1 = #nomvarli#5;
               |SI nNume1 = 0;
                    sw125acero = 1;
               |FINSI;
               |SI runnom = "nomcalfi"; |Y nNume1 [ 0;
                    sw125acero = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomvarli;
|FPRC;

|PROCESO leedoce;
     |LIBERA #nomcalli;
     #nomcalli#0 = #2#0;
     #nomcalli#1 = #2#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = doce;
     |LEE 101#nomcalli.=;
|FPRC;

|PROCESO grabacon;        || GRABA O REGRABA LINEAS DE CALCULO SEGUN VARIABLES
     doce = graba04;
     |HAZ leedoce;
     FEstado = FSalida;
     |SI FEstado ! 0; |O swgracon = 1;    || switch para regrabar campos convenio
          #nomcalli#5 = graba05; || calculo alfa
          #nomcalli#06 = graba06; || calculo nume
          #nomcalli#07 = graba07; || situacion
          #nomcalli#08 = graba08; || descripcion
     |FINSI;
     |SI FEstado = 0; |Y swcongra = 1;    || switch para regrabar acumulando
          tempo1 = #nomcalli#10;  || valor anterior
          tempo2 = #nomcalli#11;  || unidades calculo anterior
          tempo3 = graba10; || valor actual
          tempo4 = graba11; || unidades calculo actual
          tempo5 = (tempo1 * tempo2) + (tempo3 * tempo4); || importe total
          graba10 = tempo5; || valor concepto nuevo
          graba11 = 1;      || unidades calculo concepto nuevo
     |FINSI;
     |SI FEstado = 0; |Y swcongra = 2;    || switch para regrabar SIN ACUMUILAR
          tempo1 = #nomcalli#9;
          tempo2 = #nomcalli#10;
          tempo3 = #nomcalli#11;
          |SI tempo1 ! 0; graba09 = tempo1; |FINSI;
          |SI tempo2 ! 0; graba10 = tempo2; |FINSI;
          |SI tempo3 ! 0; graba11 = tempo3; |FINSI;
          |SI doce = 125;
               |HAZ VacacVaria;
               |SI sw125acero = 1;
                    graba11 = 0;   || para permitir no pagar vacaciones desde
                                   || variaciones si lo creamos a cero
               |FINSI;
          |FINSI;
          |SI doce = 125; || vacaciones con dias desde variaciones
          |O doce = 410; |O doce = 415; || indemnizacion, mismo caso
               |SI tempo1 ! 0; |Y swExiste902 = 0;
                    || en caso de que exista el 902 no salia como debia
                    graba11 = tempo1;
               |FINSI;
          |FINSI;
     |FINSI;
     #nomcalli#09 = graba09;     || unidades
     #nomcalli#10 = graba10;     || valor
     #nomcalli#11 = graba11;     || unidades calculo
     |SI FEstado ! 0;
          |GRABA 020#nomcalli.n;
     |SINO;
          |GRABA 020#nomcalli.a;
     |FINSI;
     |LIBERA #nomcalli;
|FPRC;

|PROCESO convenio;     || comprueba si existe linea de convenio
     |DDEFECTO #10;
     convenio = 1;
     #10#00 = #2#87;
     #10#02 = concepto;

     |HAZ excepciones;
     |SI concepto < 901; |Y swConceptoOFF ! 0;
          |ACABA;
     |FINSI;

     |LEE 000#10=;
     |SI FSalida = 0;|O concepto ] 901; || los conceptos 9xx pasan aunque no esten
          convenio = 0;
          |SI concepto ] 901;
               |SI concepto = 901;  #10#6 = "N§ HORAS";  |FINSI;
               |SI concepto = 902;  #10#6 = "INDEMNI.";  |FINSI;
               |SI concepto = 903;
                    #10#6 = "CIT.JO.AL";
                    fijo_1 = unidades;       || dias cotizados citricos
               |FINSI;
               |SI concepto = 922;
                    #10#6 = "CIT.JO.IT";
                    nJornadasIT = unidades;
                |FINSI;
               |SI concepto = 904;  #10#6 = "VACACION";  |FINSI;
               |SI concepto = 905;  #10#6 = "HORAS TP";  |FINSI;
               |SI concepto = 906;  #10#6 = "ANTIC. 1";  |FINSI;
               |SI concepto = 907;  #10#6 = "ANTIC. 2";  |FINSI;
               |SI concepto = 908;  #10#6 = "ESPECIE ";  |FINSI;
               |SI concepto = 923;  #10#6 = "ESPECIE2";  |FINSI;
               |SI concepto = 924;  #10#6 = "ESPECIE3";  |FINSI;
               |SI concepto = 909;  #10#6 = "H.C.SEM.";  |FINSI;
               |SI concepto = 910;  #10#6 = "H.T.SEM.";  |FINSI;
               |SI concepto = 911;  #10#6 = "H.C.MES ";  |FINSI;
               |SI concepto = 912;  #10#6 = "H.T.MES ";  |FINSI;
               |SI concepto = 913;  #10#6 = "ALTA=CTO";  |FINSI;
               |SI concepto = 914;  #10#6 = "D.ALTA  ";  |FINSI;
               |SI concepto = 915;  #10#6 = "DIAS VAC";  |FINSI;
               |SI concepto = 916;  #10#6 = "DED.S.S.";  |FINSI;
               |SI concepto = 917;  #10#6 = "DIAS TC2";  |FINSI;
               |SI concepto = 918;  #10#6 = "HORASTC2";  |FINSI;
               |SI concepto = 919;  #10#6 = "BASEIRPF";  |FINSI;
               |SI concepto = 920;  #10#6 = "P.INDEM.";  |FINSI;
               |SI concepto = 921;  #10#6 = "ANTIC.PE";  |FINSI;
               |SI concepto = 925;  #10#6 = "MED.VAR.";  |FINSI;
               |SI concepto = 926;  #10#6 = "ANTIC. 3";  |FINSI;
               |SI concepto = 928;  #10#6 = "BASE REM";  |FINSI;
               |SI concepto = 945;  #10#6 = "BASE BON";  |FINSI;
               |SI concepto = 946;  #10#6 = "PROM.CC.";  |FINSI;
               |SI concepto = 947;  #10#6 = "PROM.CP.";  |FINSI;
               |SI concepto = 948;  #10#6 = "PR.DES.2";  |FINSI;
               |SI concepto = 961;  #10#6 = "HORAS TU";  |FINSI;
               |SI concepto = 965;  #10#6 = "PREAVISO";  |FINSI;
               |SI concepto > 928;
               |Y concepto ! 961; |Y concepto ! 945; |Y concepto ! 965;
               |Y concepto ! 946; |Y concepto ! 947; |Y concepto ! 948;
                    |SI concepto ] 951; |Y concepto [ 961;
                         || estos si, los nuevos anticipos
                         || y el 961 de horas de tutorias
                    |SINO;
                         convenio = 1;         || los no contemplados no los graba
                    |FINSI;
               |SINO;
                    |SI FSalida ! 0;
                         #10#3 = "V";
                         #10#4 = 0;
                         #10#5 = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO VacMesAct;
     alfa1 = #nomabsli#2;
     alfa3 = alfa1 % 402;     || mes fecha desde
     alfa1 = alfa1 % 102;     || dia fecha desde
     topemes1 = alfa1;

     alfa2 = #nomabsli#3;
     alfa4 = alfa2 % 402;     || mes fecha hasta
     alfa2 = alfa2 % 102;     || dia fecha hasta
     topemes2 = alfa2;

     |SI alfa3 ! alfa4;       || si el mes fin no es el mismo mes que el mes inicio
          topemes2 = topemes; || cojo como dia hasta el ultimo dia del mes
     |FINSI;

     |SI #nomabsli#6 = 0;
          nDiasVac = nDiasVac + (topemes2 - topemes1 + 1);
     |FINSI;
|FPRC;

|DEFBUCLE BuscaVac;
     #nomabsli#1;
     4;
     #labtraba#0, #labtraba#1, fFechaDesde, "V";
     #labtraba#0, #labtraba#1, fFechaHasta, "V";
     ;
     NULL, VacMesAct;
|FIN;

|PROCESO BuscaVac;
     nDiasVac = 0;
     nVacMesAct = 0;
     nVacRestoAny = 0;

     mesnum = nElMes;
     anynum = nElAny;

     alfa1 = "01";
     |HAZ ulti_dia;
     alfa2 = topemes;
     alfa3 = mesnum; alfa3 = "00" + mesnum; alfa3 = alfa3 % -102;
     alfa4 = anynum;
     aFechaDesde = alfa1 + "." + alfa3 + "." + alfa4;

     aFechaHasta = alfa2 + "." + alfa3 + "." + alfa4;
     fFechaDesde = aFechaDesde;
     fFechaHasta = aFechaHasta;
     nDiasVac = 0;
     nVacMesAct = 0;
     |BUCLE BuscaVac;
     nVacMesAct = nDiasVac;

     nNume = fFechaDesde;
     nNume = nNume - 1;
     fFechaHasta = nNume;

     aFechaDesde = #labtraba#34;
     fFechaDesde = aFechaDesde;
     aAlfa = nElAny;
     aAlfa = "01.01." + aAlfa;
     fFechaIni = aAlfa;
     |SI fFechaIni > fFechaDesde;
          fFechaDesde = fFechaIni;
     |FINSI;
     nDiasVac = 0;
     nVacRestoAny = 0;
     |BUCLE BuscaVac;
     nVacRestoAny = nDiasVac;
|FPRC;

|PROCESO excepciones;
     swConceptoOFF = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomexcli.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#0;    || empresa
     #500#1 = #labtraba#87;   || convenio
     #500#2 = concepto;       || concepto
     |LEE 000#500.=;
     |SI FSalida = 0; |Y #500#4 = "S";
          |SI #500#1 = #labtraba#87;
               swConceptoOFF = 1;
          |FINSI;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomexdli.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;   || convenio
     #500#1 = #labtraba#45;   || contrato
     #500#2 = concepto;       || concepto
     |LEE 000#500.=;
     |SI FSalida = 0; |Y #500#4 = "S";
          swConceptoOFF = 1;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO nomembcf;
     nNume = 0;

     #nomcalli#0 = #labtraba#0;
     #nomcalli#1 = #labtraba#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = #nomembcf#2;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nNume = ((#nomcalli#10 * #nomcalli#11) ! 2)
     |SINO;
          |SI #nomembcf#2 = 906; nNume = antici1; |FINSI;
          |SI #nomembcf#2 = 907; nNume = antici2; |FINSI;
          |SI #nomembcf#2 = 926; nNume = antici4; |FINSI;
          |SI #nomembcf#2 = 908; nNume = especie; |FINSI;
     |FINSI;
     |SI nNume ! 0;
          |SI #nomembcf#4 = "+";
               nAjuEmb = nAjuEmb + nNume;
          |FINSI;
          |SI #nomembcf#4 = "-";
               nAjuEmb = nAjuEmb - nNume;
          |FINSI;
          |SI #nomembcf#4 = "I";
               nAjuEmb = nAjuEmb - nNume;
               nEmbIntegro = nEmbIntegro + nNume;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomembcf;
     #nomembcf#1;
     ;
     #labtraba#0, #labtraba#1, 101;
     #labtraba#0, #labtraba#1, 999;
     ;
     NULL, nomembcf;
|FIN;

|PROCESO AjuEmb;
     nAjuEmb = 0;
     nEmbIntegro = 0;
     |BUCLE nomembcf;
|FPRC;

|PROCESO ExcepPagaProrr;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomexeli.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;   || convenio
     #500#1 = concepto;       || concepto
     |LEE 000#500.=;
     |SI FSalida = 0;
          swSigue = 0;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO PagasProrr;
     swPagasProrr = 0;

     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
               mesco = paga + 19;     || mes confeccion
               nCampoPT = paga + 112;
               swSigue = 0;
               |SI #nomconca#mesco# ! 0;     || mes confeccion paga que no sea cero
                    |SI #nomconca#mesco# = 99; |O #labtraba#nCampoPT# = "S";
                         swSigue = 1;
                         concepto = paga + 200;
                         |HAZ ExcepPagaProrr;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    swPagasProrr = swPagasProrr + 1;   || valor
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO OtroTrabEmb;
     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;
          |ACABA;   || soy yo mismo
     |FINSI;

     aFechaAlta = #labtraba#36; |QBF aFechaAlta;
     fFechaAlta = aFechaAlta;

     aFechaBaja = #labtraba#37; |QBF aFechaBaja;
     |SI aFechaBaja = ""; |O aFechaBaja = "..........";
          aFechaBaja = fFechaFinNom;
     |FINSI;
     fFechaBaja = aFechaBaja;

     |SI fFechaBaja < fFechaIniNom; |O fFechaAlta > fFechaFinNom;
          || no entra en este mes;
     |SINO;
          #nomembli#0 = #labtraba#0;
          #nomembli#1 = #labtraba#1;
          #nomembli#2 = nElAny;
          |LEE 000#nomembli.=;
          |SI FSalida = 0;
               |SI #nomembli#29 ! 0;
                    #labtraba#1 = nTra; || para que grabe la incidencia
                                        || en el que toca
                    nIncid = 53;
                    |HAZ graba_inc;
                    nIncid = 54;
                    |HAZ graba_inc;
                    nIncid = 55;
                    |HAZ graba_inc;

                    #labtraba#1 = #nomembli#1; || recupero el codigo

                    #nomcalca#0 = #labtraba#0;
                    #nomcalca#1 = #labtraba#1;
                    #nomcalca#2 = nElMes;
                    #nomcalca#3 = 0;
                    |LEE 000#nomcalca.=;
                    |SI FSalida = 0;
                         nOtroLiquido = #nomcalca#109 + #nomcalca#111# + #nomcalca#104;
                         nOtroEmbEmp = #labtraba#0;
                         nOtroEmbTra = #labtraba#1;
                         |SI #nomcalca#16 > 0;
                              swOtroPag = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE OtroTrabEmb;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, OtroTrabEmb;
|FIN;

|PROCESO OtroEmbargo;
     |SALVA_FICHA #labtraba;
     |SALVA_FICHA #nomcalca;
     |SALVA_FICHA #nomembca;
     |SALVA_FICHA #nomembli;

     aNif = #labtraba#7;

     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     aDia = nTopemes;

     aMes = nMes; aMes = ("00" + aMes) % -102;
     aAny = nAny;

     aFechaIniNom = "01." + aMes + "." + aAny;
     aFechaFinNom = aDia + "." + aMes + "." + aAny;

     fFechaIniNom = aFechaIniNom;
     fFechaFinNom = aFechaFinNom;

     nOtroEmbEmp = 0;
     nOtroEmbTra = 0;
     nOtroLiquido = 0;
     swOtroPag = 0;
     nEmp = #labtraba#0;
     nTra = #labtraba#1;

     |BUCLE OtroTrabEmb;

     |REPON_FICHA #nomembli;
     |REPON_FICHA #nomembca;
     |REPON_FICHA #nomcalca;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO RegrabaEmbargo;
     |SALVA_FICHA #nomcalca;
     #nomcalca#0 = nOtroEmbEmp;
     #nomcalca#1 = nOtroEmbTra;
     #nomcalca#2 = nElMes;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          #nomembli#0 = #2#0;
          #nomembli#1 = #2#1;
          #nomembli#2 = nAny;
          |LEE 000#nomembli.=;
          |SI #nomembli#29 < nCuotaEmb;
               nCuotaEmb = #nomembli#29;
          |FINSI;

          nLiquidoOtroNom = #nomcalca#46;               || bruto
          nLiquidoOtroNom = nLiquidoOtroNom - #nomcalca#48 - #nomcalca#49 - #nomcalca#50 - #nomcalca#51;
          nLiquidoOtroNom = nLiquidoOtroNom - #nomcalca#52 - #nomcalca#53 - #nomcalca#89 - #nomcalca#54;
          nLiquidoOtroNom = nLiquidoOtroNom - #nomcalca#105 - #nomcalca#75;

          nLiquidoOtroPag = #nomcalca#16 - #nomcalca#17 - #nomcalca#86;

          nEmbargoOtro = nCuotaEmb * (nOtroLiquido) / (nOtroLiquido + nLiquidoNom + nLiquidoPag + nAjuEmb);
          nEmbargoOtro = nEmbargoOtro ! 2;

          nCuotaEmb = nCuotaEmb - nEmbargoOtro;

          |SI #nomcalca#16 = 0;
               #nomcalca#104 = nEmbargoOtro;
               #nomcalca#109 = nLiquidoOtroNom - nEmbargoOtro;
               #nomcalca#113 = #nomcalca#109;
          |SINO;
               #nomcalca#104 = nEmbargoOtro;
               nNume1 = (nEmbargoOtro * (#nomcalca#46 / (#nomcalca#46 + #nomcalca#47))) ! 2
               #nomcalca#109 = nLiquidoOtroNom - nNume1;
               #nomcalca#111 = nLiquidoOtroPag - (nEmbargoOtro - nNume1);
               #nomcalca#113 = #nomcalca#109 + #nomcalca#111;
          |FINSI;
          |GRABA 020#nomcalca.a;
          |LIBERA #nomcalca;

          |REPON_FICHA #nomcalca;
     |FINSI;
|FPRC;

|PROCESO ImporteEmbargo;
     |HAZ AjuEmb;

     |SI #nomembca#4 = 1;     || cantidad fija
          nCuotaEmb = #nomembca#5;
     |FINSI;
     |SI #nomembca#4 = 2;     || % sobre el liquido
          nCuotaEmb = ((nLiquidoNom + nLiquidoPag + nAjuEmb) % #nomembca#5) ! 2;
     |FINSI;
     |SI #nomembca#4 ] 3;     || calculo automatico
          nSMI = #nomconst#89;   || Salario Minimo Interprofesional
          |SI #nomembca#4 = 3;     || calculo automatico
               nInembargable = nSMI;

               swPagasProrr = 0;
               nPropProrr = 0;
               |HAZ PagasProrr;
               |SI swPagasProrr ! 0;
                    |SI #nomcontr#64 = 2;
                         swPagasProrr = 2;
                    |FINSI;
                    nPropProrr = nInembargable * (swPagasProrr / 12);
                    nInembargable = nInembargable + nPropProrr;
               |FINSI;
               |SI nLiquidoPag > 0;
                    nInembargable = nInembargable + nSMI;
               |FINSI;
          |FINSI;
          |SI #nomembca#4 = 4;     || calculo automatico
               nSMI = #nomconst#89;   || Salario Minimo Interprofesional
               nInembargable = nSMI;

               swPagasProrr = 0;
               nPropProrr = 0;
               |HAZ PagasProrr;
               |SI swPagasProrr ! 0;
                    |SI #nomcontr#64 = 2;
                         swPagasProrr = 2;
                    |FINSI;
                    nPropProrr = nInembargable * (swPagasProrr / 12);
                    nInembargable = nInembargable + nPropProrr;
               |FINSI;

               |SI nLiquidoPag > 0;
                    nInembargable = nInembargable + nSMI;
               |FINSI;

               nInembargable = nInembargable * (1.5 + (#nomembca#7 * 0.3));
          |FINSI;
          |SI #nomembca#4 = 5; |O #nomcontr#64 = 3;
               || calculo automatico, no se tienen en cuenta pagas
               nInembargable = nSMI;
          |FINSI;

          nLiqEmb = nLiquidoNom + nLiquidoPag + nAjuEmb;    || liquido para calculo embargo
          |HAZ OtroEmbargo;
          nLiqEmb = nLiqEmb + nOtroLiquido;

          |SI nLiquidoPag = 0;
               || no tenia pagas este trabajador
               |SI swOtroPag = 1;
                    |SI #nomembca#4 = 5; |O #nomcontr#64 = 3;
                         || no tengo en cuentsa pagas
                    |SINO;
                         || si habia otro y el otro si que tenia pagas, hay que
                         || quitarle otro SMI
                         nInembargable = nInembargable + nSMI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |PARA nPasada = 1; |SI nPasada [ 10; |HACIENDO nPasada = nPasada + 1;
               |SI nPasada = 1; nPor = 30; |FINSI;
               |SI nPasada = 2; nPor = 50; |FINSI;
               |SI nPasada = 3; nPor = 60; |FINSI;
               |SI nPasada = 4; nPor = 75; |FINSI;
               |SI nPasada ] 5; nPor = 90; |FINSI;

               nLimite1 = nInembargable + (nSMI * (nPasada - 1));
               nLimite2 = nInembargable + (nSMI * nPasada);
               |SI nLiqEmb > nLimite1;
                    |SI nLiqEmb > nLimite2;
                         nNume1 = ((nLimite2 - nLimite1) % nPor) ! 2;
                         nCuotaEmb = nCuotaEmb + nNume1;
                    |SINO;
                         nNume1 = ((nLiqEmb - nLimite1) % nPor) ! 2;
                         nCuotaEmb = nCuotaEmb + nNume1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          nCuotaEmb = nCuotaEmb + nEmbIntegro;

          |SI nCuotaEmb ! 0; |Y nOtroEmbEmp ! 0; |Y nOtroEmbTra ! 0;
               |HAZ RegrabaEmbargo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO embargame;
     nCuotaEmb = 0;
     swSigue = 0;
     |HAZ ImporteEmbargo;
     #nomembli#0 = #2#0;
     #nomembli#1 = #2#1;
     #nomembli#2 = nElAny;      || nAny es el a¤o anterior si es Enero
     |LEE 000#nomembli.=;
     |SI FSalida = 0;
          |SI #nomembli#27 ! 0; |Y #nomembli#29 ! 0;
               || si hay datos
               swSigue = 1;
          |FINSI;
     |SINO;
          #nomembli#2 = nElAny - 1;      || nAny es el a¤o anterior si es Enero
          |LEE 000#nomembli.=;
          |SI FSalida = 0;
               |SI #nomembli#27 ! 0; |Y #nomembli#29 ! 0;
                    || si hay datos
                    swSigue = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          nEmbargo = nCuotaEmb;
          |SI #nomembli#29 < nEmbargo;
               nEmbargo = #nomembli#29;
          |FINSI;
          |SI bruto_pag = 0;
               nLiquidoNom = nLiquidoNom - nEmbargo;
          |SINO;
               nLiquidoNom = nLiquidoNom - ((nEmbargo * (bruto_rec / (bruto_rec + bruto_pag))) ! 2);
               nLiquidoPag = nLiquidoPag - (nEmbargo - ((nEmbargo * (bruto_rec / (bruto_rec + bruto_pag))) ! 2));
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO embargos;
     nEmbargo = 0;

     |SI runnom = "nomcalfi"; |O runnom = "nomcalir";
          |ACABA;
     |FINSI;

     |ABRE #nomembca;
     |ABRE #nomembli;
     #nomembca#0 = #2#0;
     #nomembca#1 = #2#1;
     |LEE 000#nomembca.=;
     |SI FSalida = 0;         || tengo embargo
          nMes = nElMes - 1;
          |SI nMes = 0;
               nMes = 12;
               nAny = nElAny - 1;
          |SINO;
               nAny = nElAny;
          |FINSI;
          |HAZ embargame;
     |FINSI;

     |CIERRA #nomembli;
     |CIERRA #nomembca;
|FPRC;

|PROCESO Liquido;
     nIngresos = 0;
     nDeducc = 0;
     nLiquidoNom = 0;

     nIngresosPag = 0;
     nDeduccPag = 0;
     nLiquidoPag = 0;
     nIngresos = bruto_rec;                            || BRUTO
     nDeducc = dto_con + deducss;                 || cont. comunes.
     nDeducc = nDeducc + dto_dfp;            || cont. profesionales
     nDeducc = nDeducc + dto_sol_tra;            || cont. profesionales
     nDeducc = nDeducc + dto_ho1 + dto_ho2;  || cont. horas
     nDeducc = nDeducc + antici1 + antici2 + antici4;  || anticipos
     nDeducc = nDeducc + especie;            || en especie
     nDeducc = nDeducc + nAcumAbs;           || absentismos
     nDeducc = nDeducc + reten_1;            || retenciones IRPF
     || preaviso y vacaciones a descontar
     nDeducc = nDeducc + ((-1) * nPreavisoDto) + ((-1) * nVacDto);

     nLiquidoNom = nIngresos - nDeducc;
     |SI nLiquidoNom < 0; |Y nPreavisoDto ! 0;
          nPreavisoDto = nPreavisoDto - nLiquidoNom;
          nLiquidoNom = 0;
     |FINSI;
     |SI nLiquidoNom < 0; |Y nVacDto ! 0;
          nVacDto = nVacDto - nLiquidoNom;
          nLiquidoNom = 0;
     |FINSI;

     nIngresosPag = 0;
     nDeduccPag = 0;

     nIngresosPag = nIngresosPag + acum2_200;  || si es baja este mes o la paga va
     nDeduccPag = nDeduccPag + reten_2;  ||/junto con el recibo, a¤ade paga
     nDeduccPag = nDeduccPag + antici3;  || y anticipo de pagas extras

     nLiquidoPag = nIngresosPag - nDeduccPag;
|FPRC;

|PROCESO CompMesAnt;
     |SALVA_FICHA #nomcalca;
     nMes = nElMes - 1;
     nAny = nElAny - 2000;
     |SI nMes = 0;
          nMes = 12;
          nAny = nAny - 1;
     |FINSI;

     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nAny;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida ! 0;
          #nomcalca#0 = #labtraba#0;
          #nomcalca#1 = #labtraba#1;
          #nomcalca#2 = nMes;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               nIncid = 24;
               |HAZ graba_inc;
          |SINO;
               aMes = nElMes; aMes = ("00" + aMes) % -102;
               aAny = nElAny;
               aFecha = "01"+ "." + aMes + "." + aAny;
               fFecha = aFecha;
               aFecha = #labtraba#36;
               aMesAlta = aFecha % 402;
               nMesAlta = aMesAlta;
               aAnyAlta = aFecha % -104;
               nAnyAlta = aAnyAlta;
               fFechaAlta = aFecha;
               |SI nMesAlta ! nElMes; |O nAnyAlta ! nElAny;
                    |SI fFechaAlta < fFecha;
                         nIncid = 25;
                         |HAZ graba_inc;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |REPON_FICHA #nomcalca;
|FPRC;

|PROCESO Pos965;
     |SI #nomcalli#11 ! 0; |Y #nomcalli#7 [ 22;
          aAlfa = #nomcalli#7; |QBF aAlfa; aAlfa = ("00" + aAlfa) % -102;
          aOcupadas = aOcupadas + aAlfa;
     |FINSI;
|FPRC;

|DEFBUCLE Pos965;
     #nomcalli#1;
     ;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 101;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 499;
     ;
     NULL, Pos965;
|FIN;

|PROCESO SituaPreaviso;
     #nomcalli#0 = #nomcalca#0;
     #nomcalli#1 = #nomcalca#1;
     #nomcalli#2 = #nomcalca#2;
     #nomcalli#3 = #nomcalca#3;
     #nomcalli#4 = 965;
     |LEE 101#nomcalli.=;
     |SI FSalida = 0; |Y #nomcalli#7 = 0;
          aOcupadas = "";
          |BUCLE Pos965;
          nPos965 = 0;
          aLon = aOcupadas % 0;
          nLon = aLon;
          |PARA nLoc = 1; |SI nLoc [ 22; |HACIENDO nLoc = nLoc + 1;
               aLoc = nLoc; |QBF aLoc; aLoc = ("00" + aLoc) % -102;
               swOcupado = 0;
               |PARA nPos = 1;
               |SI nPos [ nLon; |Y swOcupado = 0;
               |HACIENDO nPos = nPos + 2;
                    nNume = (nPos * 100) + 2;
                    aAlfa = aOcupadas % nNume;
                    |SI aAlfa = aLoc;
                         swOcupado = 1;
                         |SAL;
                    |FINSI;
               |SIGUE;
               |SI swOcupado = 0;
                    nPos965 = nLoc;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI nPos965 ! 0;
          #nomcalli#0 = #nomcalca#0;
          #nomcalli#1 = #nomcalca#1;
          #nomcalli#2 = #nomcalca#2;
          #nomcalli#3 = #nomcalca#3;
          #nomcalli#4 = 965;
          |LEE 101#nomcalli.=;
          |SI FSalida = 0;
               #nomcalli#7 = nPos965;
          |FINSI;
          |GRABA 020#nomcalli.a;
          |LIBERA #nomcalli;
     |FINSI;
|FPRC;

|PROCESO VariosFinal;
     |HAZ CompMesAnt;
     |HAZ Liquido;
     |HAZ embargos;
     nNume = nPreavisoAbo + nPreavisoDto;
     |SI nNume > 0;
          |HAZ SituaPreaviso;
     |FINSI;
|FPRC;

|PROCESO ayuntamientos;
     aFabre = "";
     |DIRECTORIO aFabre;
     aFabre = "rt  " + aFabre + "laboral/bin/noyprepa.tab";
     |FABRE aFabre;
     |SI FSalida ] 0;
          |FCIERRA FSalida;
          ay_emp = #2#0;
          ay_tra = #2#1;
          ay_mes = nElMes;
          ay_any = nElAny;
          ay_ant = #2#34;
          |SUB_EJECUTA "noyprepa";
     |FINSI;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
     bisiesto = 0;
     numer = anynum $ 4;
     |SI numer = 0;
          bisiesto = 1;
     |FINSI;
     topemes = 31;
     |SI mesnum= 2;
          topemes = 28 + bisiesto;
     |FINSI;
     |SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO autovarca;
     |ABRE #6;
     #6#0 = #2#0;
     #6#1 = #2#1;
     #6#2 = concepto;
     |LEE 000#6=;
     |SI FSalida = 0;
          nume1 = #6#3;
          |SI nume1 = 0;
               graba11 = 0;
          |FINSI;
     |FINSI;
     |CIERRA #6;
|FPRC;

|PROCESO ComplementoIT2;
     |SI denfe_U0 = 0; |Y denfe_T0 = 0; |Y denfe_S0 = 0; |Y denfe_R0 = 0;
     |Y denfe_Y0 = 0; |Y denfe_X0 = 0; |Y denfe_W0 = 0; |Y denfe_V0 = 0;
          |ACABA;
     |FINSI;
     |SI nBaseIT2 ! 0; |Y nDiasEnfBase2 ! 0; |Y para1 ] 2;
          denfe_U_Base2 = denfe_U0;
          denfe_T_Base2 = denfe_T0;
          denfe_S_Base2 = denfe_S0;
          denfe_R_Base2 = denfe_R0;

          denfe_V_Base2 = denfe_V0;
          denfe_Y_Base2 = denfe_Y0;
          denfe_X_Base2 = denfe_X0;
          denfe_W_Base2 = denfe_W0;
     |FINSI;
|FPRC;

|PROCESO calenfe_BaseIT2;
     || Ya tengo mis prom_enf y prom_acc

     concepto = 927;
     nBaseIT2 = 0;
     |HAZ Busca9XX;

     |SI nBaseIT2 ! 0; |Y dacci_X2_Base2 ! 0;
          base_3 = base_3 - ((((prom_acc+prom_ac2) * .75) ! 2) * dacci_X2_Base2);
          base_3 = base_3 + (((nBaseIT2 * .75) ! 2) * dacci_X2_Base2);
     |FINSI;
     || CALCULO DE PRESTACIONES POR IT
     |SI #labtraba#42 ! "L";
          |SI nBaseIT2 ! 0; |Y denfe_C_Base2 ! 0;
               base_1 = base_1 - (((prom_enf * .75) ! 2) * denfe_C_Base2); || enf. 75% (503)
               base_1 = base_1 + (((nBaseIT2 * .75) ! 2) * denfe_C_Base2); || enf. 75% (503)
          |FINSI;
          |SI nBaseIT2 ! 0; |Y denfe_B_Base2 ! 0;
               base_2 = base_2 - (((prom_enf * .60) ! 2) * denfe_B_Base2); || enf. 60% (503)
               base_2 = base_2 + (((nBaseIT2 * .60) ! 2) * denfe_B_Base2); || enf. 60% (503)
          |FINSI;

          |SI nBaseIT2 ! 0; |Y denfe_D_Base2 ! 0;
               denfe_4 = denfe_4 - (((prom_enf * .60) ! 2) * denfe_D_Base2); ||enf. emp. 60% (515)
               denfe_4 = denfe_4 + (((nBaseIT2 * .60) ! 2) * denfe_D_Base2); ||enf. emp. 60% (515)
          |FINSI;
     |FINSI;

     || CALCULO DE BASES POR ENFERMEDAD
     |SI nBaseIT2 ! 0; |Y nDiasEnfBase2 ! 0;
          coba_1 = coba_1 - (prom_enf * nDiasEnfBase2);
          cobb_1 = cobb_1 - (prom_acc * nDiasEnfBase2);

          coba_1 = coba_1 + (nBaseIT2 * nDiasEnfBase2);
          cobb_1 = cobb_1 + (nBaseIT2 * nDiasEnfBase2);
     |FINSI;

     || CALCULO DE BASES POR MATERNIDAD
     |SI nBaseIT2 ! 0; |Y nDiasMatBase2 ! 0;
          coba_4 = coba_4 - (prom_enf * nDiasMatBase2);
          cobb_4 = cobb_4 - (prom_acc * nDiasMatBase2);

          coba_4 = coba_4 + (nBaseIT2 * nDiasMatBase2);
          cobb_4 = cobb_4 + (nBaseIT2 * nDiasMatBase2);
     |FINSI;

     || CALCULO DE BASES POR ACCIDENTE
     |SI nBaseIT2 ! 0; |Y nDiasAccBase2 ! 0;
          coba_2 = coba_2 - ((prom_acc + prom_ac2) * nDiasAccBase2);
          cobb_2 = cobb_2 - (prom_enf * nDiasAccBase2);

          coba_2 = coba_2 + (nBaseIT2 * nDiasAccBase2);
          cobb_2 = cobb_2 + (nBaseIT2 * nDiasAccBase2);
     |FINSI;
|FPRC;

|PROCESO Busca9XX;
     |ABRE #4;
     #4#0 = #2#87; #4#1 = #2#17; #4#2 = concepto;
     |LEE 000#4=;
     |SI FSalida = 0;
          |SI concepto = 927; nBaseIT2 = #4#3; |FINSI;
     |FINSI;
     |CIERRA #4;

     |ABRE #6;
     #6#0 = #2#0; #6#1 = #2#1; #6#2 = concepto;
     |LEE 000#6=;
     |SI FSalida = 0;
          |SI concepto = 927; nBaseIT2 = #6#3; |FINSI;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0; #8#1 = #2#1; #8#2 = nElMes; #8#3 = 0; #8#4 = concepto;
     |LEE 000#8=;
     |SI FSalida = 0;
          |SI concepto = 927; nBaseIT2 = #8#5; |FINSI;
     |FINSI;
     |CIERRA #8;

     nBaseIT2 = nBaseIT2 ! 2;
|FPRC;

|PROCESO DiasBaseIT2;
     concepto = 927;
     nBaseIT2 = 0;
     |HAZ Busca9XX;
     |SI nBaseIT2 ! 0;
          nCampo = para1 + 11;
          aTipo = #nomvarca#nCampo#;
          nCampo = para1 + 3;
          nDesdeDia = #nomvarca#nCampo#;
          |SI nDesdeDia ! 0;
               |SI aTipo = "E";
                    denfe_A_Base2 = denfe_A_Base2 + denfe_A0;
                    denfe_B_Base2 = denfe_B_Base2 + denfe_B0;
                    denfe_C_Base2 = denfe_C_Base2 + denfe_C0;
                    denfe_D_Base2 = denfe_D_Base2 + denfe_D0;
               |FINSI;
               |SI aTipo = "A";
                    dacci_X2_Base2 = dacci_X2_Base2 + dacci_X0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BaseIT2;
     nDiasEnfBase2 = 0; nDiasAccBase2 = 0;
     nDiasMatBase2 = 0;
     concepto = 927;
     nBaseIT2 = 0;
     |HAZ Busca9XX;

     |SI nBaseIT2 ! 0;
          || lo grabo para que se quede en las lineas

          swgracon = 1;
          graba04 = 927;
          graba05 = "V";
          graba06 = 0;
          graba07 = 0;
          graba08 = "Base IT2";
          graba09 = 0;
          graba11 = 0;
          graba10 = nBaseIT2;
          |HAZ grabacon;

          || a ver a que dias de IT hay que aplicarle esta segunda base
          || de IT
          |PARA nume1 = 13; |SI nume1 [ 16; |HACIENDO nume1 = nume1 + 1;
               nume2 = nume1 - 8;    || desde
               nume3 = nume1 - 4;    || hasta
               |SI #nomvarca#nume1# = "E"; |O #nomvarca#nume1# = "A";
               |O #nomvarca#nume1# = "M";
               |O #nomvarca#nume1# = "P"; |O #nomvarca#nume1# = "R";
                    |SI #nomvarca#nume2# ! 0;
                         |SI #nomvarca#nume3# = 0;
                              mesnum = nElMes;           || si no hasta el ultimo dia
                              anynum = nElAny;         || del mes
                              |HAZ ulti_dia;
                              nHastaDia = topemes;
                         |SINO;
                              nHastaDia = #nomvarca#nume3#;
                         |FINSI;
                         |SI #nomvarca#nume1# = "E";
                              nDiasEnfBase2 = nDiasEnfBase2 + nHastaDia - #nomvarca#nume2# + 1;
                              aTipoITBase2 = "E";
                         |FINSI;
                         |SI #nomvarca#nume1# = "A";
                              nDiasAccBase2 = nDiasAccBase2 + nHastaDia - #nomvarca#nume2# + 1;
                              aTipoITBase2 = "A";
                         |FINSI;
                         |SI #nomvarca#nume1# = "M";
                              nDiasMatBase2 = nDiasMatBase2 + nHastaDia - #nomvarca#nume2# + 1;
                              aTipoITBase2 = "M";
                         |FINSI;
                         |SI #nomvarca#nume1# = "P";
                              nDiasMatBase2 = nDiasMatBase2 + nHastaDia - #nomvarca#nume2# + 1;
                              aTipoITBase2 = "P";
                         |FINSI;
                         |SI #nomvarca#nume1# = "R";
                              nDiasMatBase2 = nDiasMatBase2 + nHastaDia - #nomvarca#nume2# + 1;
                              aTipoITBase2 = "R";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO FechaITActual;
     |SI #labtraba#89 ! 0;    || la IT ha terminado este mes
          |PARA nume1 = 12; |SI nume1 [ 16; |HACIENDO nume1 = nume1 + 1;
               nume2 = nume1 - 8;    || desde
               nume3 = nume1 - 4;    || hasta
               |SI #nomvarca#nume1# = "E"; |O #nomvarca#nume1# = "M";
               |O #nomvarca#nume1# = "P"; |O #nomvarca#nume1# = "R";
                    |SI #nomvarca#nume2# = 0;
                         alfa1 = "01";
                         alfa2 = nElMes; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
                         nume4 = nElAny; alfa3 = nume4;
                         aFecha = alfa1 + "." + alfa2 + "." + alfa3;
                         fFecha = aFecha;
                         nFecha = fFecha;
                         nFecha = nFecha - #labtraba#89;
                         fFecha = nFecha;
                         aFecha = fFecha;
                         alfa1 = aFecha % 402;  || mes inicio IT
                         alfa2 = aFecha % -104; || any inicio IT
                         nMes = alfa1;
                         nAny = alfa2;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI #labtraba#92 ! 0;    || la IT ha terminado este mes
          |PARA nume1 = 12; |SI nume1 [ 16; |HACIENDO nume1 = nume1 + 1;
               nume2 = nume1 - 8;    || desde
               nume3 = nume1 - 4;    || hasta
               |SI #nomvarca#nume1# = "A";
                    |SI #nomvarca#nume2# = 0;
                         alfa1 = "01";
                         alfa2 = nElMes; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
                         nume4 = nElAny; alfa3 = nume4;
                         aFecha = alfa1 + "." + alfa2 + "." + alfa3;
                         fFecha = aFecha;
                         nFecha = fFecha;
                         nFecha = nFecha - #labtraba#92;
                         fFecha = nFecha;
                         aFecha = fFecha;
                         alfa1 = aFecha % 402;  || mes inicio IT
                         alfa2 = aFecha % -104; || any inicio IT
                         nMes = alfa1;
                         nAny = alfa2;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO PrecioVarEsteMes
     |SALVA_FICHA #nomcalli;
     nPrecioVarMes = 0;
     #nomcalli#0 = #labtraba#0;
     #nomcalli#1 = #labtraba#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = concepto;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nPrecioVarMes = #nomcalli#11 * #nomcalli#10;
     |FINSI;
     |REPON_FICHA #nomcalli;
|FPRC;

|PROCESO VarMesAnt;
     nMes = nElMes;
     nAny = nElAny;
     |HAZ FechaITActual;

     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nAny - 2000;
     #nomhicca#2 = nMes - 1;
     |SI #nomhicca#2 = 0;
          #nomhicca#66 = #nomhicca#66 - 1;
          #nomhicca#2 = 12;
     |FINSI;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |CIERRA #nomhicca;

     |ABRE #nomhicli;
     #nomhicli#0 = #labtraba#0;
     #nomhicli#1 = #labtraba#1;
     #nomhicli#12 = nAny - 2000;
     #nomhicli#2 = nMes - 1;
     |SI #nomhicli#2 = 0;
          #nomhicli#12 = #nomhicli#12 - 1;
          #nomhicli#2 = 12;
     |FINSI;
     #nomhicli#3 = 0;
     #nomhicli#4 = concepto;
     |LEE 000#nomhicli.=;
     |SI FSalida = 0;
          || nPrecioVar = #nomhicli#10 / #nomhicca#8;
          nPrecioVar = #nomhicli#10 * #nomhicli#11;
          |HAZ PrecioVarEsteMes;
     |FINSI;

     |CIERRA #nomhicli;
|FPRC;

|DEFBUCLE VarMesAnt;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, VarMesAnt;
|FIN;

|PROCESO BuscaMesAnt;
     aNif = #labtraba#7;
     |SALVA_FICHA #labtraba;
     |BUCLE VarMesAnt;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO BuscaHosp;           || esto sirve para buscar si una IT que tengo pendiente
     |ABRE #nomhisit;         || es con hospitaizacion

     nMes = nElMes - 1;
     nAny = nElAny;
     |SI nMes = 0;
          nMes = 12;
          nAny = nAny - 1;
     |FINSI;

     mesnum = nMes;
     anynum = nAny;
     |HAZ ulti_dia;

     aHosp = "N";
     aReca = " ";
     |PARA nume1 = 1; |SI nume1 [ 4; |HACIENDO nume1 = nume1 + 1;
          #nomhisit#0 = #labtraba#0;
          #nomhisit#1 = #labtraba#1;
          #nomhisit#2 = nAny;
          #nomhisit#3 = nMes;
          #nomhisit#8 = nume1;
          |LEE 000#nomhisit.=;
          |SI FSalida = 0;
               |SI aTipoIT = #nomhisit#6; |Y #nomhisit#5 = topemes;
                    |SI #nomhisit#71 = "S";
                         || arrastro hospitalizacion del mes anterior
                         aHosp = "S";
                    |FINSI;
                    |SI #nomhisit#10 = "X";
                         || accidente, recaida "X", es enf. profesional
                         aReca = "X";
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO BuscaHistIT;
     |ABRE #nomhisit;

     nMes = nElMes - 1;
     nAny = nElAny;
     |SI nMes = 0;
          nMes = 12;
          nAny = nAny - 1;
     |FINSI;

     mesnum = nMes;
     anynum = nAny;
     |HAZ ulti_dia;

     nBaseComp = 0;

     |PARA nume1 = 1; |SI nume1 [ 4; |HACIENDO nume1 = nume1 + 1;
          #nomhisit#0 = #labtraba#0;
          #nomhisit#1 = #labtraba#1;
          #nomhisit#2 = nAny;
          #nomhisit#3 = nMes;
          #nomhisit#8 = nume1;
          |LEE 000#nomhisit.=;
     |SIGUE;
     |CIERRA #nomhisit;
|FPRC;


|| BONIFICACIONES PARA MAYORES DE 60 A¤OS

|PROCESO parche_ulti_dia;
     || si cumple edad o antiguedad el untimo dia del mes siendo mensual
     || en un mes de 31 dias, lo dejamos para el mes que viene

     aAlfa1 = topemes;
     aAlfa2 = nElAny;
     aFecha1 = (("00" + aAlfa1) % -102) + "." + (("00" + aAlfa2) % -102);
     aFecha2 = fecha_bon_16 % 105;
     |SI #labtraba#42 = "M"; |Y topemes = 31; |Y aFecha1 = aFecha2;
          || mensual, mes de 31 dias, empiezo a aplicar bonif el 31
          || lo dejo para el mes siguiente
          fFecha = fecha_bon_16;
          nFecha = fFecha;
          nFecha = nFecha + 1;
          fFecha = nFecha;
          fecha_bon_16 = fFecha;
     |FINSI;
|FPRC;

|PROCESO por_bon_16;
     alfa1 = #2#11 % -104;        || anyo nacimiento
     alfa2 = #2#11 % -602;        || mes nacimiento
     alfa5 = #2#11 % 102;         || dia nacimiento
     alfa3 = aFechaRef % -104;        || anyo Fecha Referencia
     alfa4 = aFechaRef % -602;        || mes Fecha Referencia
     alfa6 = aFechaRef % 102;         || dia Fecha Referencia
     nume1 = alfa1;
     nume1 = alfa1 + nEdadParaBon;           || a¤o que cumple 60 a¤os
     alfa1 = nume1;
     nume3 = alfa3;                || a¤o que cumple 5 a¤os antiguedad
     nume3 = alfa3 + nAnysParaAnt;
     alfa3 = nume3;
     nume2 = alfa2;                || mes edad
     nume4 = alfa4;                || mes antiguedad
     nume5 = alfa5;                || dia edad
     nume6 = alfa6;                || dia antiguedad
     |SI nEdadParaBon = 59;
          fecha_ini_bon = "01.01.2001";
          any_ini_bon = 2001;
     |SINO;
          fecha_ini_bon = "01.01.2002";
          any_ini_bon = 2002;
     |FINSI;

     |SI nume1 > nume3;            || cuando cumple 60 (o 59) (o 55) a¤os
          |SI nume1 < any_ini_bon;
               fecha_bon_16 = fecha_ini_bon;
          |SINO;
               fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
          |FINSI;
     |FINSI;
     |SI nume1 < nume3;            || cuando cumple antiguedad
          |SI nume3 < any_ini_bon;
               fecha_bon_16 = fecha_ini_bon;
          |SINO;
               fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
          |FINSI;
     |FINSI;
     |SI nume1 = nume3;            || mismo a¤o: comprobamos meses
          |SI nume2 > nume4;            || cuando cumple 60 (o 55) a¤os
               |SI nume1 < any_ini_bon;
                    fecha_bon_16 = fecha_ini_bon;
               |SINO;
                    fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
               |FINSI;
          |FINSI;
          |SI nume2 < nume4;            || cuando cumple antiguedad
               |SI nume3 < any_ini_bon;
                    fecha_bon_16 = fecha_ini_bon;
               |SINO;
                    fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
               |FINSI;
          |FINSI;
          |SI nume2 = nume4;       || antiguedad y 60 (o 55) a¤os en = a¤o, =mes
               |SI nume5 > nume6;            || cuando cumple 60 (o 55) a¤os
                    |SI nume1 < any_ini_bon;
                         fecha_bon_16 = fecha_ini_bon;
                    |SINO;
                         fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;
                    |FINSI;
               |FINSI;
               |SI nume5 < nume6;            || cuando cumple antiguedad
                    |SI nume3 < any_ini_bon;
                         fecha_bon_16 = fecha_ini_bon;
                    |SINO;
                         fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
                    |FINSI;
               |FINSI;
               |SI nume5 = nume6;
                    fecha_bon_16 = alfa6 + "." + alfa4 + "." + alfa3;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ parche_ulti_dia;

     alfa7 = fecha_bon_16 % 402;
     nume7 = alfa7;                || mes en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % -104;
     nume8 = alfa7;                || anyo en que empieza a ser efectiva la bonif.
     nMesesBon16 = nElMes - nume7;
     nAnyosBon16 = nElAny - nume8;
     |SI nAnyosBon16 > 0;
          |SI nMesesBon16 < 0;
               nMesesBon16 = 12 + nMesesBon16;
               nAnyosBon16 = nAnyosBon16 - 1;
          |FINSI;
     |FINSI;
     |SI nAnyosBon16 ] 0;
          |SI nEdadParaBon = 59;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 40 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nEdadParaBon = 60;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 50 + (nAnyosBon16 * 10);
                    |SI nPB16Calc > 100;
                         nPB16Calc = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nEdadParaBon = 55;
               |SI nAnyosBon16 ! 0; |O nMesesBon16 ] 0;
                    nPB16Calc = 50;
               |FINSI;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI dalta_3 ! 1; |O dbaja_3 ! guarda;        || para sacar los dias reales en alta
          nume10 = dia_2;     || dias del mes reales
     |SINO;
          nume10 = dcoti_0;   || dias reales alta, dias alta: dias naturales
     |FINSI;

     nume10 = nume10 + ddese_2 + ddese_3;

     |SI nElMes = nume7; |Y nElAny ] nume8;      || si estoy calculando el mes q entra
          alfa7 = fecha_bon_16 % 102;        || en vigor la bonif. calcula el % correspondiente
          nume7 = alfa7;                     || segun la fecha inicio de bonif.
          |SI dalta_3 ] nume7;
               nume7 = 1;
          |FINSI;
          nume7 = nume10 - nume7 + 1;        || "guarda" se trae los dias del mes
          |SI nume7 < 0;
               nNume1 = alfa7;     || este dia entra en vigor el tramo nuevo
                                   || de bonificacion
               nNume2 = dbaja_3;   || este dia me doy de baja
               |SI nNume2 < nNume1;|| el mismo mes me doy de baja y cambio de
                    nume7 = 0;     || bonif, TODO debe ir a la primera bonif
               |SINO;              || ya que estoy de baja antes que entre
                                   || la segunda en vigor 11.06.2009
                    nume7 = nume10;|| ASI ME LO ENCONTRE y lo dejo para el
               |FINSI;             || resto de casos
          |FINSI;
          |SI nElAny > nume8;                  || si llevo ya mas de un a¤o de bonif
               nume9 = nElAny - nume8;         || este mes cambia el porcentaje a
               |SI nume9 [ 6;                || bonificar, hay que proporcionar
                    |SI dalta_3 ! 1; |Y dbaja_3 = guarda;
                         nume7 = nume10;
                    |FINSI;
                    por_bon_16A = nume10 - nume7;      || cada parte segun lo que
                    nPB16CalcA = nPB16Calc - 10;       || toque
               |SINO;
                    nume7 = nume10;
               |FINSI;
          |FINSI;
     |SINO;
          nume7 = nume10;                         || si es un mes posterior calcula el
                                                  || 100% ya que entra entera.
     |FINSI;

     |SI nPB16CalcA = 40; |Y nPB16Calc = 50;      || paso de una bonif a otra
          ||nDiaCumple2 = por_bon_16A + 1;          || dia que paso a la segunda
          nDiaCumple2 = nDiaCambioA60;
     |FINSI;

     || EXCEPCION gorda: resulta que llevaba un tiempo con la bonif de mayores
     || de 60 a¤os y ahora empieza a mitad de mes la de > 65 a¤os porque cumplo
     || los 65, solo debo aplicar la de > 60 por el tiempo y la base de la
     || bonif. hasta que empiezo a aplicar la otra

     |SI #nombonif#10 = 4;
          alfa9 = #labtraba#40;    || fecha en que comienza la bonif
          |QBF alfa9;
          |SI alfa9 ! ""; |Y alfa9 ! "..........";
               alfa9 = #labtraba#40 % 402;
               alfa10 = #labtraba#40 % -104;
               nume9 = alfa9;
               nume10 = alfa10;
               |SI nElMes = nume9; |Y nElAny = nume10;
                    alfa9 = #labtraba#40 % 102;
                    nume9 = alfa9;
                    nume7 = nume9 - 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI dalta_3 ! 1; |O dbaja_3 ! guarda;        || para sacar los dias reales en alta
          nume10 = dia_2;     || dias del mes reales
     |SINO;
          nume10 = dcoti_0;   || dias reales alta, dias alta: dias naturales
     |FINSI;
     nume10 = nume10 + ddese_2 + ddese_3;

     |SI por_bon_16A > 0;                    || tengo cambio de % de bonif.
          |SI swbaja = 1; |Y dalta_3 = 1;    || soy baja este mes (el dia 1 trabaj)
               nume10 = dcoti_0;             || dias que se trabajan en el mes
               nume7 = nume10 - por_bon_16A; || dias del 2do. tramo de bonif
               |SI nume7 < 0;
                    nume7 = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     por_bon_16 = (nume7 / nume10) * 100;
     |SI por_bon_16A > 0;
          por_bon_16A = 100 - por_bon_16;
     |FINSI;
|FPRC;

|PROCESO CompCambio60;
     alfa1 = #2#11 % -104;        || anyo nacimiento
     alfa2 = #2#11 % -602;        || mes nacimiento
     alfa5 = #2#11 % 102;         || dia nacimiento
     alfa3 = aFechaRef % -104;        || anyo Fecha Referencia
     alfa4 = aFechaRef % -602;        || mes Fecha Referencia
     alfa6 = aFechaRef % 102;         || dia Fecha Referencia
     nume1 = alfa1;
     nume1 = alfa1 + 60;           || a¤o que cumple 60 a¤os
     alfa1 = nume1;

     || nume3 = alfa3;                || a¤o que cumple 5 a¤os antiguedad
     || nume3 = alfa3 + 5;
     || alfa3 = nume3;

     nume2 = alfa2;                || mes edad
     || nume4 = alfa4;                || mes antiguedad
     nume5 = alfa5;                || dia edad
     || nume6 = alfa6;                || dia antiguedad

     || cuando cumple 60 (o 55) a¤os
     fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;

     alfa6 = fecha_bon_16 % 102;
     nume6 = alfa6;                || dia en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % 402;
     nume7 = alfa7;                || mes en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % -104;
     nume8 = alfa7;                || anyo en que empieza a ser efectiva la bonif.

     nMesesBon16 = nElMes - nume7;
     nAnyosBon16 = nElAny - nume8;

     |SI nAnyosBon16 ] 0; |Y nMesesBon16 ] 0;
          nPB16Calc = 50 + (nAnyosBon16 * 10);

          |SI nAnyosBon16 = 0; |Y nMesesBon16 = 0;
               |SI swAgosto2012 = 0;
                    alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
                    alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;

                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa1 = alfa1 + " cumple requisitos de bonificacion ";
                    alfa1 = alfa1 + " para mayores de 60 años.";
                    |MENAV alfa1;

                    alfa1 = "     Se comenzara a aplicar esta bonificacion ";
                    alfa1 = alfa1 + "a partir de este mes."
                    |MENAV alfa1;
               |FINSI;
               nDiaCambioA60 = nume6;
          |SINO;
               |SI #labtraba#212 = 3; |O #labtraba#212 = 5;
               |O #labtraba#212 = 13; |O #labtraba#212 = 15;
                    #labtraba#212 = 1;
               |FINSI;
               |SI #labtraba#212 = 4; |O #labtraba#212 = 6;
               |O #labtraba#212 = 14; |O #labtraba#212 = 16;
                    #labtraba#212 = 2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CompCambio59;
     alfa1 = #2#11 % -104;        || anyo nacimiento
     alfa2 = #2#11 % -602;        || mes nacimiento
     alfa5 = #2#11 % 102;         || dia nacimiento

     nNume = alfa1;
     nEdad = nElAny - nNume;
     nNume = alfa2;
     |SI nElMes < nNume;
          nEdad = nEdad - 1;
     |FINSI;

     alfa3 = aFechaRef % -104;        || anyo Fecha Referencia
     alfa4 = aFechaRef % -602;        || mes Fecha Referencia
     alfa6 = aFechaRef % 102;         || dia Fecha Referencia
     nume1 = alfa1;
     nume1 = alfa1 + 59;           || a¤o que cumple 60 a¤os
     alfa1 = nume1;

     || nume3 = alfa3;                || a¤o que cumple 5 a¤os antiguedad
     || nume3 = alfa3 + 5;
     || alfa3 = nume3;

     nume2 = alfa2;                || mes edad
     || nume4 = alfa4;                || mes antiguedad
     nume5 = alfa5;                || dia edad
     || nume6 = alfa6;                || dia antiguedad

     || cuando cumple 60 (o 55) a¤os
     fecha_bon_16 = alfa5 + "." + alfa2 + "." + alfa1;

     alfa6 = fecha_bon_16 % 102;
     nume6 = alfa6;                || dia en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % 402;
     nume7 = alfa7;                || mes en que empieza a ser efectiva la bonif.
     alfa7 = fecha_bon_16 % -104;
     nume8 = alfa7;                || anyo en que empieza a ser efectiva la bonif.

     nMesesBon16 = nElMes - nume7;
     nAnyosBon16 = nElAny - nume8;

     |SI nAnyosBon16 ] 0; |Y nMesesBon16 ] 0;
          nPB16Calc = 50 + (nAnyosBon16 * 10);

          |SI nAnyosBon16 = 0; |Y nMesesBon16 = 0;
               nDiaCambioA59 = nume6;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MensajesBon60;
     |SI nPB16Calc ! #2#211;
          |SI nPB16Calc > #2#211;
               alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
               alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;
               |SI #2#211 = 0;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa1 = alfa1 + " cumple requisitos de bonificacion ";
                    alfa1 = alfa1 + " para mayores de " + aEPBon + " años.";
                    |MENAV alfa1;
                    alfa1 = "     Desea comenzar a aplicar la bonificacion?";
                    |CONFI alfa1;
                    |SI FSalida ! 0;
                         nPB16Calc = 0
                         #2#211 = 0;
                    |FINSI;
               |SINO;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa2 = #2#211;         || lo que habia en labtraba
                    alfa3 = nPB16Calc;      || lo que he calculado
                    alfa1 = alfa1 + ". El porcentaje de bonif. para ";
                    alfa1 = alfa1 + "mayores de " + aEPBon + " años ";
                    |SI nEdadParaBon = 59; |O nEdadParaBon = 60;
                         alfa1 = alfa1 + "cambia del " + alfa2 + "% al " + alfa3 + "%.";
                    |SINO;
                         alfa1 = alfa1 + "debe ser por ley del 50%";
                    |FINSI;
                    |MENAV alfa1;
                    alfa1 = "    Se actualizara la ficha del trabajador.";
                    |MENAV alfa1;
                    #2#211 = nPB16Calc;
               |FINSI;
          |FINSI;
          |SI nPB16Calc < #2#211;
               alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
               alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;
               alfa4 = #2#211;
               |SI nPB16Calc = 0;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa1 = alfa1 + " NO cumple requisitos de bonificacion ";
                    alfa1 = alfa1 + " para mayores de " + aEPBon + " años.";
                    |MENAV alfa1;
                    alfa1 = "     Aun asi desea aplicar la bonificacion especificada en";
                    alfa1 = alfa1 + " la ficha del trabajador? (" + alfa4 + "%)";
                    |CONFI alfa1;
                    |SI FSalida = 0;
                         nPB16Calc = #2#211;
                         por_bon_16 = 100;
                    |SINO;
                         nPB16Calc = 0;
                         #2#211 = 0;
                    |FINSI;
               |SINO;
                    alfa1 = "    ATENCION: Trabajador " + alfa2 + "." + alfa3;
                    alfa2 = #2#211;         || lo que habia en labtraba
                    alfa3 = nPB16Calc;      || lo que he calculado
                    alfa1 = alfa1 + ". La bonificacion para ";
                    alfa1 = alfa1 + "mayores de " + aEPBon + " años de su ficha (" + alfa2 + "%)";
                    alfa1 = alfa1 + " es incorrecta.";
                    |MENAV alfa1;
                    alfa1 = "     Deberia aplicarse un " + alfa3 + "%.";
                    |SI nEdadParaBon = 59; |O nEdadParaBon = 60;
                         alfa1 = alfa1 + " Desea comenzar a ";
                         alfa1 = alfa1 + "aplicar el % correcto?";
                         |CONFI alfa1;
                         |SI FSalida ! 0;
                              nPB16Calc = #2#211;
                         |SINO;
                              #2#211 = nPB16Calc;
                         |FINSI;
                    |SINO;
                         alfa1 = "    Se actualizara la ficha del trabajador con el ";
                         alfa1 = alfa1 + "porcentaje legal correcto.";
                         |MENAV alfa1;
                         #2#211 = nPB16Calc;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboni60;      || BONIFICACION MAYORES 60 A¤OS RDL. 16/2001
     bon_59 = 0;
     bon_60 = 0;
     bon_60A = 0;
     nPB16Calc = 0;
     nPB16CalcA = 0;
     bon_55 = 0;

     || las pongo a cero aqui porque es posible que en la bonif. de mayores
     || de 59 me haga falta
     nBonifTex1 = 0;
     nBonifTex2 = 0;

     |SI nElAny ] 2014;
          |ACABA;
     |FINSI;

     alfa1 = #labtraba#11 % -104;        || anyo nacimiento
     alfa2 = #labtraba#11 % -602;        || mes nacimiento

     nNume = alfa1;
     nEdad = nElAny - nNume;
     nNume = alfa2;
     |SI nElMes < nNume;
          nEdad = nEdad - 1;
     |FINSI;

     |SI nElAny = 2013;
          swSigue = 0;
                                        || en diciembre de 2012 la tuvo,
          |ABRE #nomhicca;              || con lo que se la debe poder
          #nomhicca#0 = #labtraba#0;    || seguir aplicando hasta que
          #nomhicca#1 = #labtraba#1;    || acabe
          #nomhicca#66 = 12;
          #nomhicca#2 = 12;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=;
          FEstado = FSalida;
          |SI FSalida = 0;
               |SI #nomhicca#148 ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || inicia el derecho a la reduccion en 2013, que es cuando
          || cumplira 59 a¤os. A partir de 2013, solo se aplica a quie-
          || nes se la vinieran aplicando por haber cumplido 59 en 2012,
          || quienes cumplan en 2013 los 59, nada de nada

          || no haria falta con la condicion anterior, partiendo de swSigue = 0
          || pertampoco esta de mas

          alfa1 = #labtraba#11 % -104;    || anyo nacimiento
          nNume = alfa1;
          nNume1 = 2012 - nNume;          || edad con que acabo 2012
          |SI nNume1 = 58;
               swSigue = 0;
          |FINSI;

          || esto es por si ya sabemos que acabo el a¤o 2012 con 59 a¤os
          || pero resulta que el swSigue me venia a cero por no tener en
          || 2012 la nomina de diciembre

          |SI nNume1 = 59;
               |SI FEstado ! 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     nDiaCumple2 = 0;
     nume1 = nElAny;
     |SI nume1 > 2002;
           por_bon_60 = 22.18;
           |SI nume1 ] 2011;
                por_bon_60 = 22.14;
           |FINSI;
     |SINO;
           por_bon_60 = 22.30;
     |FINSI;
     |SI runnom = "nomcalir";      || no calcules bonificacion al regularizar
          |ACABA;
     |FINSI;

     |SI #2#212 = 9;               || = 9, no se calcula la bonificacion
          |ACABA;                  || se mete para familiares de agrarios
     |FINSI;                       || 25.08.2004

     |SI #2#212 = 2; |O #2#212 = 4; |O #2#212 = 6;
     |O #2#212 = 14; |O #2#212 = 16;
          aFechaRef = #2#36;       || fecha de referencia: fecha de Alta
     |SINO;
          |SI #2#212 = 11;
               aFechaRef = #2#132;      || nueva fecha de referencia para Asecor
          |SINO;
               aFechaRef = #2#34;       || fecha de referencia: fecha de Antiguedad
          |FINSI;
     |FINSI;

     alfa1 = #2#11; |QBF alfa1;    || compruebo que exista fecha nacimiento
     alfa2 = #2#34; |QBF alfa2;    || compruebo que exista fecha de antiguedad

     |SI alfa1 = ""; |O alfa1 = ".........."; |O alfa2 = ""; |O alfa2 = "..........";
          |SI alfa1 = ""; |O alfa1 = "..........";
               nIncid = 32;
               |HAZ graba_inc;
          |FINSI;

          |SI alfa2 = ""; |O alfa2 = "..........";
               nIncid = 33;
               |HAZ graba_inc;
          |FINSI;
          |ACABA;
     |FINSI;

     nEdadParaBon = 0;  || inicializo

     |SI #2#212 = 0; #2#212 = 1;   |FINSI;
     |SI #2#212 = 1; |O #2#212 = 2; |O #2#212 = 11;
          nume1 = #labtraba#45;
          |SI nume1 < 400;    || contrato indefinido
               nEdadParaBon = 59;  || a partir de los 59 a¤os
               nAnysParaAnt = 4;
          |SINO;
               nEdadParaBon = 60;  || a partir de los 60 a¤os
               nAnysParaAnt = 5;
          |FINSI;
     |SINO;
          nEdadParaBon = 55;
          |SI #2#212 = 3; |O #2#212 = 4; || bonificaciones del textil
               nAnysParaAnt = 5;
          |FINSI;
          |SI #2#212 = 5; |O #2#212 = 6; || bonificaciones del calzado
               nAnysParaAnt = 1;
          |FINSI;
          |SI #2#212 = 13; |O #2#212 = 14; || bonificaciones del juguete
               nAnysParaAnt = 3;
          |FINSI;
          |SI #2#212 = 15; |O #2#212 = 16; || bonificaciones del mueble
               nAnysParaAnt = 4;
          |FINSI;
     |FINSI;                  || a partir de los 55 a¤os

     aEPBon = nEdadParaBon;
     |QBF aEPBon;

     nDiaCambioA59 = 0;
     nDiaCambioA60 = 0;
     |SI nEdadParaBon = 55;   || compruebo si cambio de los 55 a los 60
          |HAZ CompCambio59;
          |HAZ CompCambio60;    || para pasar de 3-4 a 1-2
     |FINSI;

     |HAZ por_bon_16;

     |SI nPB16Calc ] 50;
          |SI nEdadParaBon = 55;
               aEPBon = "55";
          |SINO;
               aEPBon = "60";
          |FINSI;
     |FINSI;

     |SI swAgosto2012 = 1;
          |SI nPB16Calc = 40;
               |HAZ MensajesBon60;
          |SINO;
               || nada de nada
          |FINSI;
     |SINO;
          |HAZ MensajesBon60;
     |FINSI;

|| bon60 es lo que bonifico
|| base_6 es la base a bonificar
|| por_bon_60 es el porcentaje que dice la ley que se bonifica
|| nPB16Calc es el % que calculo segun el numero de a¤os que me corresponde
|| aplicar la bonif: 50% el primer a¤o y 10% mas cada a¤o a partir de ahi
|| por_bon_16 es la proporcion del mes a la que tengo que aplicar la bonif.

|| bon_60A, nPB16CalcA y por_bon_16A es lo analogo para cuando hay dos perio-
|| dos, en el periodo anterior

     || sector industrial incentivado
     |SI #2#212 = 3; |O #2#212 = 4; |O #2#212 = 5; |O #2#212 = 6;
     |O #2#212 = 13; |O #2#212 = 14; |O #2#212 = 15; |O #2#212 = 16;
          nPB16CalcA = 50;
          |SI nume9 = 0;                || si estoy en el primer a¤o que me toca la boni
               por_bon_16A = 0;         || toca la bonif., la primera parte
          |FINSI;                       || del mes sera cero (si es el mes que
     |FINSI;                            || empieza)

     bon_60A = base_6 + nDesem;
     |SI coba_4 > 0;
          bon_60A = bon_60A + (coba_4 - (swAjuste3 * prom_enf));
     |FINSI;
     bon_60A = (bon_60A % por_bon_60) % nPB16CalcA;
     bon_60A = (bon_60A % por_bon_16A) ! EURODB;

     |SI nPB16CalcA = 40;
          bon_59 = bon_60A;
          bon_60A = 0;
     |FINSI;

     bon_60 = base_6 + nDesem;
     |SI coba_4 > 0;
          bon_60 = bon_60 + (coba_4 - (swAjuste3 * prom_enf));
     |FINSI;
     bon_60 = (bon_60 % por_bon_60) % nPB16Calc;
     bon_60 = (bon_60 % por_bon_16) ! EURODB;

     |SI nPB16Calc = 40;
          bon_59 = bon_60;
          bon_60 = 0;
     |FINSI;

     bon_60 = bon_60 + bon_60A;
     #2#211 = nPB16Calc;
     || sector industrial incentivado
     |SI #2#212 = 3; |O #2#212 = 4; |O #2#212 = 5; |O #2#212 = 6;
     |O #2#212 = 13; |O #2#212 = 14; |O #2#212 = 15; |O #2#212 = 16;
          |SI bon_60 > 0;
               || en bon_60 viene la bonificacion, miro a ver donde toca
               |SI nDiaCambioA59 = 0; |Y nDiaCambioA60 = 0;
                    |SI nEdad < 59;
                         bon_55 = bon_60;
                         bon_59 = 0;
                         bon_60 = 0;
                    |FINSI;
                    |SI nEdad = 59;
                         bon_55 = 0;
                         bon_59 = bon_60;
                         bon_60 = 0;
                    |FINSI;
                    |SI nEdad ] 60;
                         bon_55 = 0;
                         bon_59 = 0;
                         bon_60 = bon_60;
                    |FINSI;
               |SINO;
                    |SI nDiaCambioA59 ! 0;
                         || putada: cambio de 55 a 59 a¤os
                         bon_55 = (((nDiaCambioA59 - 1) * bon_60) / nume10) ! 2;
                         bon_59 = (bon_60 - bon_55);
                         bon_60 = 0;
                    |FINSI;
                    |SI nDiaCambioA60 ! 0;
                         || putada: cambio de 59 a 60 a¤os
                         bon_59 = (((nDiaCambioA60 - 1) * bon_60) / nume10) ! 2;
                         bon_60 = (bon_60 - bon_59);
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI bon_59 > 0;
               nBonifTex1 = (bon_59 % 20) ! 2;
               bon_59 = bon_59 - nBonifTex1;
          |FINSI;
     |FINSI;

     |SI swAgosto2012 = 1;
          bon_55 = 0;
          bon_60 = 0;
          nBonifTex1 = 0;
     |FINSI;

     |SI runnom = "nomcalcu"; || en finiquitos no regrabes porcentaje
          |SI #2#246 = "S";   || parche por si se da "calajust"
               ||#2#98 = #2#98 - (antici1 + antici2 + antici3 + especie + antici4);
               #2#98 = #2#98 - (antici1 + antici2 + especie + antici4);
               |SI #2#97 = 4; |O #2#97 = 6;   || parchecito: le quito lo de especie
                    #2#98 = #2#98 + especie;  || para que no me incluya la especie
               |FINSI;                        || hasta despues del ajuste (fallaba
          |FINSI;
          |GRABA 020#2a;
          |SI #2#246 = "S";   || lo dejo como estaba
               || #2#98 = #2#98 + (antici1 + antici2 + antici3 + especie + antici4);
               #2#98 = #2#98 + (antici1 + antici2 + especie + antici4);
               |SI #2#97 = 4; |O #2#97 = 6;   || parchecito: le quito lo de especie
                    #2#98 = #2#98 - especie;  || para que no me incluya la especie
               |FINSI;                        || hasta despues del ajuste (fallaban
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DosPeriodos;
     aAlfa1 = "01";
     aAlfa2 = nElMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nElAny;
     aIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fIniPer = aIniPer;

     aAlfa1 = topemes;
     aAlfa2 = nElMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nElAny;
     aFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFinPer = aFinPer;

     aFechaAlta = #labtraba#36;
     |SI aFechaBaja = "";
          aFechaBaja = aFinPer;
     |FINSI;

     fFechaAlta = aFechaAlta;
     fFechaBaja = aFechaBaja;

     |SI fFechaAlta ] fIniPer;
          fIniPer = fFechaAlta;
     |FINSI;
     |SI fFechaBaja [ fFinPer;
          fFinPer = fFechaBaja;
     |FINSI;

     aFechaCambio = #labtraba#34;
     aAlfa = aFechaCambio % -104;
     nNume = aAlfa;
     nNume = nNume + 1;
     aAlfa = nNume;
     aFechaCambio = (aFechaCambio % 106) + aAlfa;
     fFechaCambio = aFechaCambio;
     nFechaCambio = fFechaCambio;

     nNume1 = fIniPer;
     nNume2 = fFinPer;

     |SI nNume1 > nFechaCambio; |O nNume2 < nFechaCambio;
          || NO ESTA COMPRENDIDO ENTRE ESTAS FECHAS
          |SI nNume1 > nFechaCambio;
               || la fecha de inicio de periodo es superior a la fecha en que
               || se cambia de a¤o (raro, pero asi es), los dias pertenecen
               || todos al a¤o 2
               nDiasAny2 = nNume2 - nNume1 + 1;
          |FINSI;
          |SI nNume2 < nFechaCambio;
               || la fecha de fin de periodo es anterior a la fecha en que se
               || cambiaba de a¤o, todos los dias perteneceran al a¤o 1
               nDiasAny1 = nNume2 - nNume1 + 1;
          |FINSI;
     |SINO;
          nDiasAny1 = nFechaCambio - nNume1
          nDiasAny2 = nNume2 - nFechaCambio + 1;
     |FINSI;
|FPRC;

|PROCESO EnPracticas;
     enMes = nElMes;
     enAny = nElAny;
     |HAZ CompAltaTrab_plb;

     swSigue = 0;
     nPropPrac = 1;
     |SI #2#45 = "420"; |O #2#45 = "520";
          swSigue = 1;
     |FINSI;
     |SI #2#45 = "421";
          swSigue = 1;
     |FINSI;

     |SI swSigue = 1;
          |SI #2#232 ! 0; |Y #2#233 ! 0; |Y #2#208 = "S";
               alfa1 = #2#34 % -104;         || anyo alta
               alfa2 = #2#34 % -602;         || mes alta
               alfa3 = #2#34 % 102;          || dia alta
               nume2 = alfa1;                || anyo alta
               nume3 = alfa2;                || mes alta
               nume1 = nElAny - nume2;
               nume4 = nElMes - nume3;
               nume5 = alfa3;                || dia alta

               aFechaBaja = #2#37;

               |ABRE #nomvarca;
               #nomvarca#0 = #labtraba#0;
               #nomvarca#1 = #labtraba#1;
               #nomvarca#2 = nElMes;
               #nomvarca#3 = 0;
               |LEE 000#nomvarca.=;
               |SI FSalida = 0;
                    aAlfa = #nomvarca#16;
                    |QBF aAlfa;
                    |SI aAlfa ! ""; |Y aAlfa ! "..........";
                         aFechaBaja = aAlfa;
                    |FINSI;
               |FINSI;
               |CIERRA #nomvarca;
               |QBF aFechaBaja;

               alfa1 = aFechaBaja % -104;         || anyo baja
               alfa2 = aFechaBaja % -602;         || mes baja
               alfa3 = aFechaBaja % 102;          || dia baja
               nume6 = alfa1;                || anyo baja
               nume7 = alfa2;                || mes baja
               nume8 = alfa3;                || dia baja

               |SI nume1 = 0;      || dif a¤o calculo y a¤o alta es cero
                    nPropPrac = #labtraba#232 / 100;
                    || estoy en el primer a¤o
               |FINSI;

               |SI nume1 = 1;      || puede ser que este en el primer a¤o,
                                   || en el segundo o en el mes de cambio
                    |SI nume4 < 0; || primer a¤o
                         nPropPrac = #labtraba#232 / 100;
                    |FINSI;
                    |SI nume4 = 0; || mes de cambio a¤o
                         nDiasAny1 = 0;
                         nDiasAny2 = 0;
                         |HAZ DosPeriodos;
                         nPropPrac = (nDiasAny1 / enDiasAlta) * (#labtraba#232 / 100);  || primer a¤o
                         nPropPrac = nPropPrac + (nDiasAny2 / enDiasAlta) * (#labtraba#233 / 100);  || segundo a¤o
                    |FINSI;
                    |SI nume4 > 0; || segundo a¤o
                         nPropPrac = #labtraba#233 / 100;
                    |FINSI;
               |FINSI;

               |SI nume1 = 2;      || segundo a¤o,
                    nPropPrac = #labtraba#233 / 100;  || entre 1 y 2 a¤os en alta
               |FINSI;

               |SI nume1 = 3;      || estoy en el a¤o que cumplo el tercer a¤o
                                   || puede ser que este antes de cumplirlo, en el mes
                                   || que cumplo tres o que ya los haya cumplido

                    |SI nume4 < 0; || aun no ha cumplido el tercer a¤o
                         nPropPrac = #labtraba#233 / 100;  || entre 2 y 3 a¤os en alta
                    |FINSI;
                    |SI nume4 = 0; || el mes que termino el tercer a¤o
                         nPropPrac = #labtraba#233 / 100;
                         || a la fuerza con el porcentaje del segundo y tercer a¤o,
                         || no puedo estar una parte en practicas del segundo a¤o
                         || y otra parte con proporcion 1 por llevar mas de dos
                         || a¤os ya que eso deberia estar en otro contrato
                    |FINSI;
                    |SI nume4 > 0; || mas de tres a¤os
                         nPropPrac = #labtraba#233 / 100; || mas de tres a¤os en alta
                         || en teoria imposible, no puedo estar mas de tres
                         || a¤os en practicas
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO recuperapagalin_FIN;
     |ABRE #nomimpr2;
     #nomimpr2#0 = #nomcalca#0;    || empresa
     #nomimpr2#1 = #nomcalca#1;    || trabajador
     #nomimpr2#2 = #nomcalca#2;    || mes
     #nomimpr2#3 = #nomcalca#3;    || tipo
     #nomimpr2#4 = nElAny;
     #nomimpr2#5 = paga + 200;    || concepto
     |LEE 101#nomimpr2.=;
     |SI FSalida = 0;
          nUnidYaPagadas = #nomimpr2#12;
     |FINSI;
     |CIERRA #nomimpr2;
|FPRC;

|PROCESO recuperapagalin;
     #nomcalli#0 = #nomimpr2#0;    || empresa
     #nomcalli#1 = #nomimpr2#1;    || trabajador
     #nomcalli#2 = #nomimpr2#2;    || mes
     #nomcalli#3 = #nomimpr2#3;    || tipo
     #nomcalli#4 = #nomimpr2#5;    || concepto
     |LEE 101#nomcalli.=;
     FEstado = FSalida;

     #nomcalli#5 = #nomimpr2#6;
     #nomcalli#6 = #nomimpr2#7;
     #nomcalli#7 = #nomimpr2#8;
     #nomcalli#8 = #nomimpr2#9;

     |SI nDiferPror = #nomcalli#4;
          || en este caso no tengo que cambiar la prorrata por la
          || que se guardo, consulta de dond viene la variable y el tiquet
          || 1485.269

          || en la variable nDiferPror me guardo el concepto de la paga que
          || cumple con esta condicion, si hubiera mas de una paga diferida
          || en el mes tendria un problema, pero de moemento lo dejo asi

          || ademas hay que quitar de la prorrata total la parte que corresponde
          || a esta paga porque esta prorrata si que hay que calcularla.
          || y antes en el proceso recuperapaga se ha sumado completa

          || 02.08.2016 esto estaba asi, pero resulta que no funcionaba
          || correctamente. De esta manera es lo que funciona
          || ver tiquet 2752.929

          || dvalo_pro = dvalo_pro - (#nomimpr2#10 * #nomimpr2#11);      || base prorrata
          dvalo_pro = dvalo_pro - (#nomcalli#9 * #nomcalli#10);      || base prorrata
          #nomcalli#9 = #nomimpr2#10;
     |SINO;
          #nomcalli#9 = #nomimpr2#10;
     |FINSI;
     #nomcalli#10 = #nomimpr2#11;
     #nomcalli#11 = #nomimpr2#12;
     |SI FEstado = 0;
          |GRABA 020#nomcalli.a;
     |SINO;
          |GRABA 020#nomcalli.n;
     |FINSI;
     |LIBERA #nomcalli;

     |SI swbaja = 1; |Y #labempre#39 ! 1;
               nIncid = 26;
               |HAZ graba_inc;
               nIncid = 27;
               |HAZ graba_inc;
     |FINSI;
|FPRC;

|PROCESO recuperapaga;
     |ABRE #nomimpr1;
     #nomimpr1#0 = #nomcalca#0;
     #nomimpr1#1 = #nomcalca#1;
     #nomimpr1#2 = #nomcalca#2;
     #nomimpr1#3 = #nomcalca#3;
     #nomimpr1#4 = nElAny;
     |LEE 000#nomimpr1.=;
     |SI FSalida = 0;
          acum2_200 = #nomimpr1#5;      || base pagas
          || bruto_pag = #nomimpr1#8;      || bruto pagas
          dvalo_pro = dvalo_pro + #nomimpr1#9;      || base prorrata
     |FINSI;
     |CIERRA #nomimpr1;

     |BUCLELIN 0recuperapagalin#nomimpr1;
|FPRC;

|PROCESO AvisaPagaErronea;
     || cuando estoy en la paga aviso si detecto que la paga esta grabada
     || pero el importe del mantenimiento es distinto al que esta grabado
     || de la paga que se emitio

     |ABRE #nomimpr1;
     #nomimpr1#0 = #labtraba#0;
     #nomimpr1#1 = #labtraba#1;
     #nomimpr1#2 = nElMes;
     #nomimpr1#3 = 0;
     #nomimpr1#4 = nElAny;
     |LEE 000#nomimpr1.=;
     |SI FSalida = 0;
          |SI nImportePagaMes ! #nomimpr1#5; || nImportepagaMes se lee en el
               |AVISO;                       || nomcalfj, antes de hacer los
               |PUSHV 05012380;              || NOME_DAT del nomcalca
               |PINPA #4#nompanta;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
     |CIERRA #nomimpr1;
|FPRC;

|PROCESO compruebapaga;
     || por defecto ni la prorrata ni la paga no se calcula
     || si compruebo que aun no esta emitida (mirando el nomimpr1)
     || entonces pongo swCalPror y swCalPaga a 1, para que SI que se emita

     |ABRE #nomimpr1;
     #nomimpr1#0 = #labtraba#0;
     #nomimpr1#1 = #labtraba#1;
     #nomimpr1#2 = nElMes;
     #nomimpr1#3 = 0;
     #nomimpr1#4 = nElAny;
     |LEE 000#nomimpr1.=;
     |SI FSalida ! 0;
          swCalPaga = 1
          swCalPror = 1
     |FINSI;
     |CIERRA #nomimpr1;
|FPRC;

/*** ESTO ES PARA BUSCAR SI TIENE PUESTO AVISO PARA QUE CONTROLE LA FECHA ***/
/*** EN QUE SE SUPONE QUE DEBERIA ACABAR LA MATERNIDAD **********************/

|PROCESO BuscaMater;
     || primero un controlcito que se ha llevado muvho tiempo poniendo un dia
     || mas de la cuenta, han de ser 111

     |SI #nommauto#6 = "M";
          fFecha1 = #nommauto#4;
          fFecha2 = #nommauto#5;
          nume1 = fFecha1;
          nume2 = fFecha2;
          nume3 = nume2 - nume1;
          |SI nume3 = 112;
               nume2 = nume2 - 1;
               fFecha2 = nume2;
               #nommauto#5 = fFecha2;
               |GRABA 020#nommauto.a;
          |FINSI;
     |FINSI;

     aAlfa = #nommauto#5;
     aMes = aAlfa % 402;
     nMes = aMes;
     aAny = aAlfa % -104;
     nAny = aAny;
     |SI nMes = nElMes; |Y nAny = nElAny;
          aDia = aAlfa % 102;
          nDia = aDia;
     |FINSI;
     aTipo = #nommauto#6;
|FPRC;

|DEFBUCLE BuscaMater;
     #nommauto#1;
     ;
     #2#0, #2#1, "01.01.1900", "M";
     #2#0, #2#1, "31.12.2999", "P";
     ;
     NULL, BuscaMater;
|FIN;

|PROCESO ControlMat;
     |SI runnom = "nomcalir";
          |ACABA;
     |FINSI;
     aTipo = "";

     |ABRE #7;
     #7#0 = #2#0;
     #7#1 = #2#1;
     #7#2 = nElMes;
     #7#3 = 0;
     |LEE 000#7=;
     FEstado = FSalida;
     nDia = 0;
     |BUCLE BuscaMater;
     |SI nDia ! 0;
          |SI FEstado ! 0;
               #7#0 = #2#0;
               #7#1 = #2#1;
               #7#2 = nElMes;
               #7#3 = 0;
               #7#4 = 0;
               #7#8 = nDia;
               #7#12 = aTipo;
               |GRABA 020#7n;
               |LIBERA #7;
               nIncid = 19;
               |HAZ graba_inc;
          |SINO;
               |PARA nume1 = 12; |SI nume1 [ 15; |HACIENDO nume1 = nume1 + 1;
                    nume2 = nume1 - 8;
                    nume3 = nume1 - 4;
                    |SI #7nume1 = aTipo;
                         |SI #7nume3 ! nDia;
                              nIncid = 20;
                              |HAZ graba_inc;
                              nIncid = 21;
                              |HAZ graba_inc;
                         |FINSI;
                         |SAL;
                    |FINSI;
                    |SI #7nume1 = " ";
                         #7nume1 = aTipo;
                         #7nume2 = 0;
                         #7nume3 = nDia;
                         |GRABA 020#7a;
                         |LIBERA #7;
                         nIncid = 19;
                         |HAZ graba_inc;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;
     |CIERRA #7;
|FPRC;


/************ PROCESO PARA GRABAR EL REGISTRO DE ITS ************************/

|PROCESO RegistroIT;
     |SI runnom = "nomcalfi"; |ACABA; |FINSI;
     |ABRE #14; |LEE 000#14=; |CIERRA #14;
     |SI nPasoIT = 1;
          |ABRE #101;

          |DDEFECTO #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = campos - 11;
          |GRABA 020#101c;

          #101#4 = topemes1;
          #101#5 = topemes2;
          #101#6 = #nomvarca#campos#;
          #101#7 = topemes2 - topemes1 + 1;
          #101#8 = campos - 11;

          || todo esto por los casos de Desempleo a TP con enfermedad
          swSigue = 0;
          |SI #101#6 = "E"; |Y #101#8 = 1; swSigue = 1; |FINSI;
          |SI #101#6 = "E"; |Y #101#8 = 2; |Y #nomvarca#12 = "D"; swSigue = 1; |FINSI;
          |SI #101#6 = "E"; |Y #101#8 = 3; |Y #nomvarca#13 = "D"; swSigue = 1; |FINSI;
          |SI #101#6 = "E"; |Y #101#8 = 4; |Y #nomvarca#14 = "D"; swSigue = 1; |FINSI;
          |SI swSigue = 1;
               #101#9 = denfe_0;
          |FINSI;
          |SI #101#6 = "C"; |Y #101#8 = 1;
               #101#9 = dmate_0;
          |FINSI;

          || todo esto por los casos de Desempleo a TP con accidente
          swSigue = 0;
          |SI #101#6 = "A"; |Y #101#8 = 1; swSigue = 1; |FINSI;
          |SI #101#6 = "A"; |Y #101#8 = 2; |Y #nomvarca#12 = "D"; swSigue = 1; |FINSI;
          |SI #101#6 = "A"; |Y #101#8 = 3; |Y #nomvarca#13 = "D"; swSigue = 1; |FINSI;
          |SI #101#6 = "A"; |Y #101#8 = 4; |Y #nomvarca#14 = "D"; swSigue = 1; |FINSI;
          |SI swSigue = 1;
               #101#9 = dacci_0;
               #101#18 = 1;
               #101#19 = 999;
               #101#20 = #101#7;
               #101#21 = 75;
               #101#22 = #101#12 * #101#20 * #101#21 / 100;
          |FINSI;

          nume1 = campos + 23;
          #101#10 = #7nume1;       || recaida S/N
          |SI #101#10 = "S";
               || dias acumulados IT original
               |SI campos = 12; #101#11 = dreca_1; |FINSI;
               |SI campos = 13; #101#11 = dreca_2; |FINSI;
               |SI campos = 14; #101#11 = dreca_3; |FINSI;
               |SI campos = 15; #101#11 = dreca_4; |FINSI;

               nume1 = campos + 27;
               #101#77 = #7nume1;      || fecha IT origen recaida
          |FINSI;

          nume1 = campos + 19;
          #101#71 = #7nume1;       || hospitalizacion S/N

          |SI #labtraba#43 = "S"; |O #labtraba#43 = "s";
               #101#79 = "S";
          |FINSI;

          |GRABA 020#101a;

          |LIBERA #101;
          |CIERRA #101;
     |FINSI;

     |SI nPasoIT = 2;
          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = para1;
          |LEE 101#101=;
          |SI FSalida = 0;
               |SI #101#6 = "E"; |O #101#6 = "M"; |O #101#6 = "C";
                    nPromedio = #2#95;    || promedio enfermedad (trabajador)
               |SINO;
                    nPromedio = #2#96;    || promedio enfermedad (trabajador)
               |FINSI;
               |SI #7#17 ! 0;
                    |SI #101#6 = "E"; |O #101#6 = "M";|O #101#6 = "C";
                         nPromedio = #7#17;
                    |FINSI;
                    |SI #101#6 = "A"; |O #101#6 = "R";
                         nPromedio = #7#18;
                    |FINSI;
               |FINSI;  || promedio enfermedad (variac.)
               |SI para1 ! 1;
                    |SI nBaseIT2 ! 0;
                         nPromedio = nBaseIT2;
                    |FINSI;
               |FINSI;
               |SI #labtraba#45 = 87; |O #labtraba#45 = 421; |O #labtraba#45 = 422;
                    |SI nElAny = 2013; |Y nElMes ] 11; nPromedio = #nomconst#33; |FINSI;
                    |SI nElAny ] 2014; nPromedio = #nomconst#33; |FINSI;
               |FINSI;
               nume1 = 11 + para1;
               |SI #7nume1 = "E"; |Y nBase946 ! 0; nPromedio = nBase946; |FINSI;
               |SI #7nume1 = "A"; |Y nBase947 ! 0; nPromedio = nBase947; |FINSI;

               |SI #7nume1 = "E";
                    |SI nPropDesTP ! 0; |Y nDesEnf ! 0;
                         nPromedio = nPromedio * ((100 - nPropDesTP) / 100);
                    |FINSI;
                    #101#12 = nPromedio;
                    #101#14 = #labtraba#241;
                    #101#15 = #labtraba#179;

                    #101#18 = 1;
                    #101#19 = 3;
                    #101#20 = denfe_A0;
                    #101#21 = 0;            || % a pagar
                    #101#22 = denfe_A0 * ((nPromedio % #101#21) ! 2);

                    #101#23 = 4;
                    #101#24 = 15;
                    #101#25 = denfe_D0;
                    #101#26 = 60;            || % a pagar
                    #101#27 = denfe_D0 * ((nPromedio % #101#26) ! 2);

                    #101#28 = 16;
                    #101#29 = 20;
                    #101#30 = denfe_B0;
                    #101#31 = 60;            || % a pagar
                    #101#32 = denfe_B0 * ((nPromedio % #101#31) ! 2);

                    #101#33 = 21;
                    #101#34 = 999;
                    #101#35 = denfe_C0;
                    #101#36 = 75;            || % a pagar
                    #101#37 = denfe_C0 * ((nPromedio % #101#36) ! 2);
               |FINSI;

               |SI #7nume1 = "A";
                    |SI nPropDesTP ! 0; |Y nDesAcc ! 0;
                         nPromedio = nPromedio * ((100 - nPropDesTP) / 100);
                    |FINSI;
                    #101#12 = nPromedio;
                    #101#18 = 1;
                    #101#19 = 999;
                    #101#20 = dacci_X0;
                    #101#21 = 75;            || % a pagar
                    #101#22 = dacci_X0 * ((nPromedio % #101#21) ! 2);
               |FINSI;

               |GRABA 020#101a;

               |LIBERA #101;
               |CIERRA #101;
          |FINSI;
     |FINSI;

     |SI nPasoIT = 3;
          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = para1;         || complemento todo junto, no por enfermedad
          |LEE 101#101=;      || porque no dispongo de los datos
          |SI FSalida = 0;    || en principio
               |SI nDiasAlta < nCarencia;
                    #101#16 = "El trabajador no cumple periodo de carencia";
               |FINSI;
               |SI #101#6 = "E";
                    denfe_Y1 = denfe_R0 + denfe_S0 + denfe_T0 + denfe_U0;
                    denfe_Y2 = denfe_V0 + denfe_W0 + denfe_X0 + denfe_Y0;
                    denfe_Y1_H = denfe_R0_H + denfe_S0_H + denfe_T0_H + denfe_U0_H;
                    denfe_Y2_H = denfe_V0_H + denfe_W0_H + denfe_X0_H + denfe_Y0_H;

                    |SI denfe_Y1 ! 0; |O denfe_Y2 ! 0; |O denfe_Y1_H ! 0; |O denfe_Y2_H ! 0;

                         denfe_XX = denfe_U0 + denfe_U0_H + denfe_Y0 + denfe_Y0_H;
                         |SI denfe_Y1 > 0;
                              campo1 = 39;        || campo del #101
                              campo2 = 2;         || campo del nomconax
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2 > 0;
                              campo1 = 39;        || campo del #101
                              campo2 = 11;         || campo del nomconax
                              campo3 = campo2 + 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0;
                              campo1 = 39;
                              campo2 = 123;
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0;
                              campo1 = 39;
                              campo2 = 132;
                              campo3 = campo2 + 4;
                         |FINSI;
                         #101campo1 = #14campo2;        || desde dia
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo3;        || hasta dia
                         |SI denfe_XX > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XX;            || numero de dias
                         |FINSI;

                         denfe_XX = denfe_T0 + denfe_T0_H + denfe_X0 + denfe_X0_H;
                         |SI denfe_Y1 > 0;
                              campo1 = 46;        || campo del #101
                              campo2 = 114;         || campo del nomconax
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2 > 0;
                              campo1 = 46;        || campo del #101
                              campo2 = 12;         || campo del nomconax
                              campo3 = campo2 + 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0;
                              campo1 = 46;
                              campo2 = 186;
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0;
                              campo1 = 46;
                              campo2 = 133;
                              campo3 = campo2 + 4;
                         |FINSI;
                         #101campo1 = #14campo2;        || desde dia
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo3;        || hasta dia
                         |SI denfe_XX > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XX;            || numero de dias
                         |FINSI;

                         denfe_XX = denfe_S0 + denfe_S0_H + denfe_W0 + denfe_W0_H;
                         |SI denfe_Y1 > 0;
                              campo1 = 53;        || campo del #101
                              campo2 = 195;         || campo del nomconax
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2 > 0;
                              campo1 = 53;        || campo del #101
                              campo2 = 13;         || campo del nomconax
                              campo3 = campo2 + 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0;
                              campo1 = 53;
                              campo2 = 213;
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0;
                              campo1 = 53;
                              campo2 = 134;
                              campo3 = campo2 + 4;
                         |FINSI;
                         #101campo1 = #14campo2;        || desde dia
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo3;        || hasta dia
                         |SI denfe_XX > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XX;            || numero de dias
                         |FINSI;

                         denfe_XX = denfe_R0 + denfe_R0_H + denfe_V0 + denfe_V0_H;
                         |SI denfe_Y1 > 0;
                              campo1 = 60;        || campo del #101
                              campo2 = 204;         || campo del nomconax
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2 > 0;
                              campo1 = 60;        || campo del #101
                              campo2 = 14;         || campo del nomconax
                              campo3 = campo2 + 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0;
                              campo1 = 60;
                              campo2 = 222;
                              campo3 = campo2 + 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0;
                              campo1 = 60;
                              campo2 = 135;
                              campo3 = campo2 + 4;
                         |FINSI;
                         #101campo1 = #14campo2;        || desde dia
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo3;        || hasta dia
                         |SI denfe_XX > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XX;            || numero de dias
                         |FINSI;
                    |FINSI;
                    |SI #labtraba#43 = "S"; |O #labtraba#43 = "s";
                         || no si es comp. auto
                    |SINO;
                         |SI swPrimera = 1;
                              #101#80 = "S";
                         |SINO;
                              #101#80 = "N";
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI #101#6 = "A";
                    campo1 = 39;        || campo del #101
                    campo2 = 47;       || campo del nomconax
                    #101campo1 = #14campo2;        || desde dia
                    campo1 = campo1 + 1; campo2 = campo2 + 2;
                    #101campo1 = #14campo2;        || hasta dia
                    dacci_XX = dacci_Z0 + dacci_Z0_H;
                    |SI dacci_XX > 0;
                         campo1 = campo1 + 1;
                         #101campo1 = dacci_XX;            || numero de dias
                    |FINSI;

                    campo1 = 46;        || campo del #101
                    campo2 = 48;       || campo del nomconax
                    #101campo1 = #14campo2;        || desde dia
                    campo1 = campo1 + 1; campo2 = campo2 + 2;
                    #101campo1 = #14campo2;        || hasta dia
                    dacci_XX = dacci_Y0 + dacci_Y0_H;
                    |SI dacci_XX > 0;
                         campo1 = campo1 + 1;
                         #101campo1 = dacci_XX;            || numero de dias
                    |FINSI;
               |FINSI;

               #101#67 = denfe_4;            || prestacion cargo empresa
               #101#68 = base_1 + base_2;    || prestacion carga S.S.
               #101#69 = denfe_4 + base_1 + base_2;    || total prestacion
               || #101#70 = #101#70 + #101campo1;            || complemento

               |GRABA 020#101a;

               |LIBERA #101;
               |CIERRA #101;
          |FINSI;
     |FINSI;

     |SI nPasoIT = 4;
          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = para1;     || complemento todo junto, no por enfermedad
          |LEE 101#101=;      || porque no dispongo de los datos
          |SI FSalida = 0;    || en principio
               |SI nDiasAlta < nCarencia;
                    #101#16 = "El trabajador no cumple periodo de carencia";
               |FINSI;
               |SI #101#6 = "E";
                    denfe_Y1 = denfe_R + denfe_S + denfe_T + denfe_U;
                    denfe_Y2 = denfe_V + denfe_W + denfe_X + denfe_Y;
                    denfe_Y1_H = denfe_R_H + denfe_S_H + denfe_T_H + denfe_U_H;
                    denfe_Y2_H = denfe_V_H + denfe_W_H + denfe_X_H + denfe_Y_H;
                    |SI denfe_Y1 > 0; |Y denfe_Y2 > 0;
                         || dos enfermedades, una la primera y otra la segunda
                         || cuando para1 = 1, asumo que es la primera, he de
                         || poner la variable esta a cero, que si no me coje
                         || la configuracion del comp. de la segunda en adelante
                         |SI para1 = 1;
                              denfe_Y2 = 0;
                         |FINSI;
                    |FINSI;
                    |SI denfe_Y1 > 0; |O denfe_Y2 > 0; |O denfe_Y1_H > 0; |O denfe_Y2_H > 0;
                         |SI denfe_Y1 > 0; |Y #101#71 = "N";
                              campo1 = 39;        || campo del #101
                              campo2 = 2;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2 > 0; |Y #101#71 = "N";
                              campo1 = 39;        || campo del #101
                              campo2 = 11;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0; |Y #101#71 = "S";
                              campo1 = 39;        || campo del #101
                              campo2 = 123;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0; |Y #101#71 = "S";
                              campo1 = 39;        || campo del #101
                              campo2 = 132;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;

                         campo1 = campo1 + 3;
                         #101campo1 = #14campo3;        || tipo Complemento
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo4;        || % a complementar
                         denfe_XXC = denfe_UC0 + denfe_YC0;
                         |SI denfe_XXC > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XXC;           || Prestacion tramo
                         |FINSI;

                         |SI denfe_Y1 > 0; |Y #101#71 = "N";
                              campo1 = 46;        || campo del #101
                              campo2 = 114;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2 > 0; |Y #101#71 = "N";
                              campo1 = 46;        || campo del #101
                              campo2 = 12;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0; |Y #101#71 = "S";
                              campo1 = 46;        || campo del #101
                              campo2 = 186;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0; |Y #101#71 = "S";
                              campo1 = 46;        || campo del #101
                              campo2 = 133;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         campo1 = campo1 + 3;
                         #101campo1 = #14campo3;        || tipo Complemento
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo4;        || % a complementar
                         denfe_XXC = denfe_TC0 + denfe_XC0;
                         |SI denfe_XXC > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XXC;           || Prestacion tramo
                         |FINSI;

                         |SI denfe_Y1 > 0; |Y #101#71 = "N";
                              campo1 = 53;        || campo del #101
                              campo2 = 195;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2 > 0; |Y #101#71 = "N";
                              campo1 = 53;        || campo del #101
                              campo2 = 13;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0; |Y #101#71 = "S";
                              campo1 = 53;        || campo del #101
                              campo2 = 213;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0; |Y #101#71 = "S";
                              campo1 = 53;        || campo del #101
                              campo2 = 134;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         campo1 = campo1 + 3;
                         #101campo1 = #14campo3;        || tipo Complemento
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo4;        || % a complementar
                         denfe_XXC = denfe_SC0 + denfe_WC0;
                         |SI denfe_XXC > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XXC;           || Prestacion tramo
                         |FINSI;

                         |SI denfe_Y1 > 0; |Y #101#71 = "N";
                              campo1 = 60;        || campo del #101
                              campo2 = 204;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2 > 0; |Y #101#71 = "N";
                              campo1 = 60;        || campo del #101
                              campo2 = 14;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                         |SI denfe_Y1_H > 0; |Y #101#71 = "S";
                              campo1 = 60;        || campo del #101
                              campo2 = 222;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y2_H > 0; |Y #101#71 = "S";
                              campo1 = 60;        || campo del #101
                              campo2 = 135;         || campo del nomconax
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;

                         campo1 = campo1 + 3;
                         #101campo1 = #14campo3;        || tipo Complemento
                         campo1 = campo1 + 1;
                         #101campo1 = #14campo4;        || % a complementar
                         denfe_XXC = denfe_RC0 + denfe_VC0;
                         |SI denfe_XXC > 0;
                              campo1 = campo1 + 1;
                              #101campo1 = denfe_XXC;           || Prestacion tramo
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI #101#6 = "A";
                    || PRIMERA LINEA ACCIDENTE

                    campo1 = 39;        || campo del #101

                    campo2 = 0;
                    nNume1 = dacci_ZC + dacci_YC;
                    nNume2 = dacci_ZC_H + dacci_YC_H;
                    |SI nNume1 ! 0;
                         campo2 = 47;         || campo del nomconax
                    |FINSI;
                    |SI nNume2 ! 0;
                         campo2 = 168;         || campo del nomconax
                    |FINSI;

                    campo1 = campo1 + 3; campo2 = campo2 + 6;
                    #101campo1 = #14campo2;        || tipo Complemento
                    campo1 = campo1 + 1; campo2 = campo2 - 2;
                    #101campo1 = #14campo2;        || % a complementar
                    dacci_XXC = dacci_ZC0;
                    |SI dacci_XXC > 0;
                         campo1 = campo1 + 1;
                         #101campo1 = dacci_XXC;           || Prestacion tramo
                    |FINSI;

                    || SEGUNDA LINEA ACCIDENTE

                    campo1 = 46;        || campo del #101

                    campo2 = 0;
                    nNume1 = dacci_ZC + dacci_YC;
                    nNume2 = dacci_ZC_H + dacci_YC_H;
                    |SI nNume1 ! 0;
                         campo2 = 48;         || campo del nomconax
                    |FINSI;
                    |SI nNume2 ! 0;
                         campo2 = 169;         || campo del nomconax
                    |FINSI;

                    campo1 = campo1 + 3; campo2 = campo2 + 6;
                    #101campo1 = #14campo2;        || tipo Complemento
                    campo1 = campo1 + 1; campo2 = campo2 - 2;
                    #101campo1 = #14campo2;        || % a complementar
                    dacci_XXC = dacci_YC0;
                    |SI dacci_XXC > 0;
                         campo1 = campo1 + 1;
                         #101campo1 = dacci_XXC;           || Prestacion tramo
                    |FINSI;
               |FINSI;

               |GRABA 020#101a;

               |LIBERA #101;
               |CIERRA #101;
          |FINSI;
     |FINSI;

     |SI nPasoIT ] 50; |Y nPasoIT [ 59;
          |ABRE #101;
          |PARA para1 = 1; |SI para1 [ 4; |HACIENDO para1 = para1 + 1;
               #101#0 = #labtraba#0;
               #101#1 = #labtraba#1;
               #101#2 = nElAny;
               #101#3 = nElMes;
               #101#8 = para1;         || complemento todo junto, no por enfermedad
               |LEE 101#101=;      || porque no dispongo de los datos
               |SI FSalida = 0;    || en principio
                    |SI nDiasAlta < nCarencia;
                         #101#16 = "El trabajador no cumple periodo de carencia";
                    |FINSI;
                    nPromedioBase = nPromedio;
                    campo3 = 0;
                    |SI nPasoIT = 51;
                         campo1 = 39;        || campo del #101
                         |SI denfe_U ! 0; |Y #101#71 = "N";
                              campo2 = 2;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                              |SI para1 ] 2; |Y denfe_U_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_Y ! 0; |Y #101#71 = "N";
                              campo2 = 11;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                              |SI para1 ] 2; |Y denfe_Y_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_U_H ! 0; |Y #101#71 = "S";
                              campo2 = 123;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_Y_H ! 0; |Y #101#71 = "S";
                              campo2 = 132;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                    |FINSI;
                    |SI nPasoIT = 52;
                         campo1 = 46;        || campo del #101
                         |SI denfe_T ! 0; |Y #101#71 = "N";
                              campo2 = 114;       || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                              |SI para1 ] 2; |Y denfe_T_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_X ! 0; |Y #101#71 = "N";
                              campo2 = 12;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                              |SI para1 ] 2; |Y denfe_X_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_T_H ! 0; |Y #101#71 = "S";
                              campo2 = 186;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_X_H ! 0; |Y #101#71 = "S";
                              campo2 = 133;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                    |FINSI;
                    |SI nPasoIT = 53;
                         campo1 = 53;        || campo del #101
                         |SI denfe_S ! 0; |Y #101#71 = "N";
                              campo2 = 195;       || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                              |SI para1 ] 2; |Y denfe_S_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_W ! 0; |Y #101#71 = "N";
                              campo2 = 13;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                              |SI para1 ] 2; |Y denfe_W_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_S_H ! 0; |Y #101#71 = "S";
                              campo2 = 213;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_W_H ! 0; |Y #101#71 = "S";
                              campo2 = 134;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                    |FINSI;
                    |SI nPasoIT = 54;
                         campo1 = 60;        || campo del #101
                         |SI denfe_R ! 0; |Y #101#71 = "N";
                              campo2 = 204;       || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                              |SI para1 ] 2; |Y denfe_R_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_V ! 0; |Y #101#71 = "N";
                              campo2 = 14;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                              |SI para1 ] 2; |Y denfe_V_Base2 > 0;
                                   nPromedioBase = nBaseIT2;
                              |FINSI;
                         |FINSI;
                         |SI denfe_R_H ! 0; |Y #101#71 = "S";
                              campo2 = 222;         || campo del nomconax
                              campo3 = campo2 + 3;
                              campo4 = campo3 - 1;
                         |FINSI;
                         |SI denfe_V_H ! 0; |Y #101#71 = "S";
                              campo2 = 135;
                              campo3 = campo2 + 12;
                              campo4 = campo3 - 4;
                         |FINSI;
                    |FINSI;
                    |SI nPasoIT = 56;
                         campo1 = 39;        || campo del #101
                         |SI dacci_Z ! 0;
                              campo2 = 47;       || campo del nomconax
                              campo3 = campo2 + 6;
                              campo4 = campo3 - 2;
                         |FINSI;
                         |SI dacci_Z_H ! 0;
                              campo2 = 168;       || campo del nomconax
                              campo3 = campo2 + 6;
                              campo4 = campo3 - 2;
                         |FINSI;
                    |FINSI;
                    |SI nPasoIT = 57;
                         campo1 = 46;        || campo del #101
                         |SI dacci_Y ! 0;
                              campo2 = 48;       || campo del nomconax
                              campo3 = campo2 + 6;
                              campo4 = campo3 - 2;
                         |FINSI;
                         |SI dacci_Y_H ! 0;
                              campo2 = 169;       || campo del nomconax
                              campo3 = campo2 + 6;
                              campo4 = campo3 - 2;
                         |FINSI;
                    |FINSI;

                    campo1 = campo1 + 2;
                    denfe_XX = #101campo1;            || numero de dias
                    campo1 = campo1 + 3;
                    denfe_XXC = #101campo1;           || Prestacion tramo
                    campo1 = campo1 + 1;
                    |SI #101#6 = "E"; |Y nDesEnf ! 0;
                         nPromedioBase = nPromedioBase * ((100 - nPropDesTP) / 100);
                    |FINSI;
                    |SI #101#6 = "A"; |Y nDesAcc ! 0;
                         nPromedioBase = nPromedioBase * ((100 - nPropDesTP) / 100);
                    |FINSI;
                    |SI #14campo3 = "P";
                         #101#38 = nPromedioBase;
                         #101campo1 = denfe_XX * ((nPromedioBase * (#14campo4/100)) ! 2); || Complemento tramo
                    |FINSI;
                    |SI #14campo3 = "C";
                         #101campo1 = dacum_999 * denfe_XX;  || Complemento tramo
                         #101#38 = dacum_999 / (porce / 100);
                    |FINSI;
                    |SI #14campo3 = "H";
                         #101campo1 = (dacum_999  * denfe_XX) - denfe_XXC;  || Complemento tramo
                         || si es negativo no, pero si es recaida si, para
                         || que se cumpla la continuidad
                         |SI #101campo1 < 0; |Y #101#10 = "N";
                              #101campo1 = 0;
                         |FINSI;
                         #101#38 = dacum_999 / (porce / 100);
                    |FINSI;

                    #101#67 = denfe_4;            || prestacion cargo empresa
                    #101#68 = base_1 + base_2 + base_3;    || prestacion cargo S.S.
                    #101#69 = denfe_4 + base_1 + base_2;    || total prestacion
                    || #101#70 = #101#70 + #101campo1;            || complemento
                    |SI #14campo3 = "H";
                         #101#70 = anticom2 + anticom3;     || complemento
                    |SINO;
                         #101#70 = denfe_3;                 || complemento
                    |FINSI;

                    |GRABA 020#101a;

                    |LIBERA #101;
               |FINSI;
          |SIGUE;
          |CIERRA #101;
     |FINSI;
     |SI nPasoIT = 90;
          || este paso es para guardar la diferencia de los conceptos "E"

          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          |PARA nNume = 1; |SI nNume [ 4; |HACIENDO nNume = nNume + 1;
               #101#8 = nNume;
               |LEE 101#101=;
               |SI FSalida = 0;
                    #101#73 = nDiasTeor_E;
                    #101#74 = nImporte_E;
                    #101#75 = nDiasReal_E;
                    #101#76 = nImporte_E;
                    |GRABA 020#101a;
                    |SAL;
               |FINSI;
          |SIGUE;
          |LIBERA #101;
          |CIERRA #101;
     |FINSI;
     |SI nPasoIT = 991;
          || en este paso simplemente grabo el posible ajuste en trabajadores
          || mensuales en meses de 30 dias con alguna IT para que el bruto
          || no sea superior a la base de cotizacion
          || esto es en teoria solo para los complementos tipo "P" que estan
          || configurados para complementar la base de cotizacion al 100%
          || pero en principio lo pongo para todos

          || en enfermedad

          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = 1;
          |LEE 101#101=;
          |SI FSalida = 0;
               #101#72 = (-1) * (swAjuste3_C * (nPresDiaEnf ! 2));
               |GRABA 020#101a;
          |FINSI;
          |LIBERA #101;
          |CIERRA #101;
     |FINSI;
     |SI nPasoIT = 992;
          || lo mismo en accidente

          |ABRE #101;
          #101#0 = #labtraba#0;
          #101#1 = #labtraba#1;
          #101#2 = nElAny;
          #101#3 = nElMes;
          #101#8 = 1;
          |LEE 101#101=;
          |SI FSalida = 0;
               #101#72 = (-1) * (swAjuste3_C * (nPresDiaAcc ! 2));
               |GRABA 020#101a;
          |FINSI;
          |LIBERA #101;
          |CIERRA #101;
     |FINSI;
|FPRC;

/***************** PROCESOS PARA COMPLEMENTAR AJUSTES ***********************/

|PROCESO BuscaHis;
     |ABRE #nomhicli;

     #nomhicli#0 = #labtraba#0;
     #nomhicli#1 = #labtraba#1;
     #nomhicli#3 = 0;
     #nomhicli#4 = 120;

     |PARA nNume1 = 1; |SI nNume1 [ 12; |HACIENDO nNume1 = nNume1 + 1;
          nMes = nElMes - nNume1;
          |SI nMes [ 0;
               nMes = 12 + nMes
               nAny = nElAny - 2001;
          |SINO;
               nAny = nElAny - 2000;
          |FINSI;
          #nomhicli#12 = nAny;
          #nomhicli#2 = nMes;

          |LEE 000#nomhicli.=;
          |SI FSalida = 0;
               |SI #nomhicli#10 ! 0;
                    nImporteAju2 = #nomhicli#10;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;

     |CIERRA #nomhicli;
|FPRC;

|PROCESO borralin;
     |BORRA 020#nomcalli.a;
|FPRC;

|PROCESO busca200;
     |SI #nomcalli#4 ] 200; |Y #nomcalli#4 [ 208; |Y #nomcalli#5 = "P";
          nImporteAju = nImporteAju2; || el calculado en hco.
     |FINSI;
|FPRC;

|PROCESO CompAjuste;
     || swDiosMio = 0     pasada primera: normal con ajuste
     || swDiosMio = 1     pasada segunda: para buscar el valor
     || swDiosMio = -1    pasada tercera: calculo final sin ajuste

     |SI swDiosMio = 1;
          swDiosMio = -1;
          |ACABA;
     |FINSI;
     |SI nPaso = 1;
          swCompAjuste = 0;
          |SI denfe_2 ! 0; |O dacci_2 ! 0;
               swCompAjuste = swCompAjuste + 1;
               || superado: tengo enfermedad o accidente
          |FINSI;

          |SI #labtraba#97 = 2; |O #labtraba#97 = 4;
               |SI #labtraba#182 ! "S";
                    || superado: tengo ajuste
                    swCompAjuste = swCompAjuste + 1;
               |FINSI;
          |FINSI;

          |ABRE #nomconax;
          #nomconax#0 = #labtraba#87;
          |LEE 000#nomconax.=;
          |SI FSalida = 0;
               || esto porque si no hay comp. no ha de hacer nada, lo miro
               || comprobando que no sean cero los % a complementar del convenio
               || esto esta un poco cojo, pero en principio es necesario
               || porque si hace el tema de complementar el 120 sin tener que
               || hacerlo, no sale correcto
               |SI denfe_2 ! 0;
                    nume1 = #nomconax#4 + #nomconax#116 + #nomconax#197 + #nomconax#206;
                    nume2 = denfe_U + denfe_S + denfe_T + denfe_R;
                    nume2 = nume2 + denfe_U_H + denfe_S_H + denfe_T_H + denfe_R_H;
                    |SI nume1 ! 0; |Y nume2 ! 0;
                         |SI #nomconax#5 = "H"; |O #nomconax#117 = "H";
                         |O #nomconax#198 = "H"; |O #nomconax#207 = "H";
                             swCompAjuste = swCompAjuste + 1;
                         |FINSI;
                    |FINSI;
                    nume1 = #nomconax#19 + #nomconax#20 + #nomconax#21 + #nomconax#22;
                    nume2 = denfe_Y + denfe_X + denfe_W + denfe_V;
                    |SI nume1 ! 0; |Y nume2 ! 0;
                         |SI #nomconax#23 = "H"; |O #nomconax#24 = "H";
                         |O #nomconax#25 = "H"; |O #nomconax#26 = "H";
                             swCompAjuste = swCompAjuste + 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI dacci_2 ! 0;
                    nume1 = #nomconax#51 + #nomconax#52;
                    |SI nume1 ! 0;
                         |SI #nomconax#53 = "H"; |O #nomconax#54 = "H";
                         |O #nomconax#53 = "C"; |O #nomconax#54 = "C";
                              swCompAjuste = swCompAjuste + 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #nomconax;

          |SI concepto = 120;      || para el resto de ajustes no esta
               #nomconli#0 = #labtraba#87;   || contemplado, en principio
               #nomconli#2 = 120;
               |LEE 000#nomconli.=;
               |SI FSalida = 0;
                    |SI #nomconli#10 = "S";
                         |SI swComp120 = 1;
                              swCompAjuste = swCompAjuste + 1;
                         |FINSI;

                         || superado: el 120 se complementa
                         nConcepAju = #labtraba#213;
                         |SI nConcepAju = 0;
                              nConcepAju = 120;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI swCompAjuste ] 4;
               swCompAjuste = 1;
          |SINO;
               swCompAjuste = 0;
          |FINSI;
     |FINSI;
     |SI nPaso = 2; |Y swCompAjuste = 1;
          || metodo burraco para saber cuanto tendria que haber valido el 120
          || ojo: calculo otra vez la nomina sin IT, a ver que pasa
          |SI swDiosMio = 0;
               swDiosMio = 1;
               |ACABA;
          |FINSI;
          #nomcalli#0 = #labtraba#0;
          #nomcalli#1 = #labtraba#1;
          #nomcalli#2 = nElMes;
          #nomcalli#3 = 0;
          #nomcalli#4 = 120;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;                        || el 101 para las unidades
               nImporteAju = #nomcalli#10;        || y despues sacar el valor correcto
          |FINSI;

          #nomconli#0 = #labtraba#87;
          #nomconli#2 = nConcepAju;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               nSituaciAju = #nomconli#5;
               aDescripAju = #nomconli#6;
          |FINSI;

          #nomcalca#0 = #2#0; || empresa
          #nomcalca#1 = #2#1; || trabajador
          #nomcalca#2 = nElMes; || mes
          #nomcalca#3 = 0;    || tipo
          |LEE 101#nomcalca.=;
          |BUCLELIN 0borralin#nomcalca;
          |BORRA 020#nomcalca.a;
          |LIBERA #nomcalca;

          |ABRE #nomvarca;
          #nomvarca#0 = #labtraba#0;
          #nomvarca#1 = #labtraba#1;
          #nomvarca#2 = nElMes;
          #nomvarca#3 = 0;
          |LEE 101#nomvarca.=;
          |SI FSalida ! 0;
               |GRABA 020#nomvarca.n;
          |FINSI;
          |LIBERA #nomvarca;
          |CIERRA #nomvarca;

          |ABRE #nomvarli;
          #nomvarli#0 = #labtraba#0;
          #nomvarli#1 = #labtraba#1;
          #nomvarli#2 = nElMes;
          #nomvarli#3 = 0;
          #nomvarli#4 = 120;
          |LEE 101#nomvarli.=;
          FEstado = FSalida;
          #nomvarli#5 = 1;
          #nomvarli#6 = nImporteAju;
          |SI FEstado = 0;
               |GRABA 020#nomvarli.a;
          |SINO;
               |GRABA 020#nomvarli.n;
          |FINSI;
          |LIBERA #nomvarli;
          |CIERRA #nomvarli;

          swSegPasada = 1;
     |FINSI;

     |SI nPaso = 3; |Y swCompAjuste = 1;
     |FINSI;

     |SI nPaso = 4; |Y swCompAjuste = 1;
          nTipoAjuste = #2#97;
          nImpoAjuste = #2#98;
          #2#97 = 0;
          #2#98 = 0;
     |FINSI;

     |SI nPaso = 5; |Y swCompAjuste = 1;
          #2#97 = nTipoAjuste;
          #2#98 = nImpoAjuste;

          |ABRE #nomvarli;
          #nomvarli#0 = #labtraba#0;
          #nomvarli#1 = #labtraba#1;
          #nomvarli#2 = nElMes;
          #nomvarli#3 = 0;
          #nomvarli#4 = 120;
          |LEE 101#nomvarli.=;
          |SI FSalida = 0;
               |BORRA 020#nomvarli.a;
          |FINSI;
          |LIBERA #nomvarli;
          |CIERRA #nomvarli;

          #nomcalli#0 = #labtraba#0;
          #nomcalli#1 = #labtraba#1;
          #nomcalli#2 = nElMes;
          #nomcalli#3 = 0;
          #nomcalli#4 = 120;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;                   || el 101 para las unidades
               #nomcalli#7 = nSituaciAju;
               #nomcalli#8 = aDescripAju;

               |GRABA 020#nomcalli.a;
               |LIBERA #nomcalli;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Histor;
     swHistor = 0;
     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = #nomcalfi#9 - 2000;
     #nomhicca#2 = #nomcalfi#8;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          swHistor = 1;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO dias_lab_any;
     nDiasLabAny = 0;

     |ABRE #nomtrcal;
     #nomtrcal#0 = #labtraba#156;
     #nomtrcal#13 = nElAny;
     |LEE 000#nomtrcal.=;
     |SI FSalida = 0;
          |PARA nMes = 1; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
               mesnum = nMes;
               anynum = nElAny;
               |HAZ ulti_dia;
               |PARA nDia = 1; |SI nDia [ topemes; |HACIENDO nDia = nDia + 1;
                    nPos = 001 + (nDia * 100);
                    aAlfa = #nomtrcal#nMes# % nPos;
                    |SI aAlfa = 0;
                         nDiasLabAny = nDiasLabAny + 1;
                    |FINSI;
               |SIGUE;
          |SIGUE;
     |FINSI;
     |CIERRA #nomtrcal;
|FPRC;

|PROCESO dias_lab_tra;
     nDiasLabTra = 0;

     |ABRE #nomtrcal;
     #nomtrcal#0 = #labtraba#156;
     #nomtrcal#13 = nElAny;
     |LEE 000#nomtrcal.=;

     |SI FSalida ! 0;
          aAlfa = "    ATENCION. No existe el calendario del trabajador: ";
          aAlfa1 = #labtraba#156; |QBF aAlfa1; aAlfa1 = ("000" + aAlfa1) % -103;
          aAlfa2 = nElAny;
          aAlfa = aAlfa + "Calendario: " + aAlfa1 + ". Año: " + aAlfa2;
          |MENAV aAlfa;
          aAlfa = "    Es necesario definir el calendario laboral para realizar el ";
          aAlfa = aAlfa + "cálculo de vacaciones según días laborables";
          |MENAV aAlfa;
     |FINSI;

     aAlfa = #labtraba#36;
     aAlfa1 = aAlfa % 102;
     aAlfa2 = aAlfa % 402;
     aAlfa3 = aAlfa % -104;
     nume1 = aAlfa1;     || dia alta
     nume2 = aAlfa2;     || mes alta
     nume5 = aAlfa3;

     aAlfa1 = aFechaBaja % 102;
     aAlfa2 = aFechaBaja % 402;
     nume3 = aAlfa1;     || dia baja
     nume4 = aAlfa2;     || mes baja

     |SI FSalida = 0;
          |SI nume5 = nElAny;           || si se dio de alta este a¤o
               nDesdeMes = nume2;       || desde el mes de alta
          |SINO;                        || si no
               nDesdeMes = 1;           || desde el mes 01
          |FINSI;

          nHastaMes = nume4;
          |PARA nMes = nDesdeMes; |SI nMes [ nHastaMes; |HACIENDO nMes = nMes + 1;
               |SI nume5 = nElAny;           || si se dio de alta este a¤o
                    |SI nMes = nDesdeMes;    || si estoy en el primer mes de alta
                         nDesdeDia = nume1;  || desde al dia que se dio de alta
                    |SINO;                   || en otro caso
                         nDesdeDia = 1;      || desde el dia 1
                    |FINSI;
               |SINO;
                    nDesdeDia = 1;
               |FINSI;
               |SI nMes = nHastaMes;         || si estoy en el mes de baja
                    nHastaDia = nume3;       || (el actual, claro), entonces
               |SINO;                        || hasta el dia de baja
                    mesnum = nMes;           || si no hasta el ultimo dia
                    anynum = nElAny;         || del mes
                    |HAZ ulti_dia;
                    nHastaDia = topemes;
               |FINSI;
               |PARA nDia = nDesdeDia; |SI nDia [ nHastaDia; |HACIENDO nDia = nDia + 1;
                    nPos = 001 + (nDia * 100);
                    aAlfa = #nomtrcal#nMes# % nPos;
                    |SI aAlfa = 0;
                         nDiasLabTra = nDiasLabTra + 1;
                    |FINSI;
               |SIGUE;
          |SIGUE;
     |FINSI;
     |CIERRA #nomtrcal;
|FPRC;

|PROCESO artistas3;
     #7campo = "E";
     |SI #7desde = 0;
          #7desde = 1;
     |FINSI;
     |SI #7hasta = 0;
          #7hasta = topemes;
     |FINSI;
     nume1 = #7hasta - #7desde + 1;
     dmate_2 = dmate_2 - nume1;
     denfe_2 = denfe_2 + nume1;
|FPRC;

|PROCESO artistas2;
     |PARA campo = 12; |SI campo [ 15; |HACIENDO campo = campo + 1;
          desde = campo - 8;
          hasta = campo - 4;
          |SI campo = 12; |Y aBaja1_Art = "E";
               |HAZ artistas3;
          |FINSI;
          |SI campo = 13; |Y aBaja2_Art = "E";
               |HAZ artistas3;
          |FINSI;
          |SI campo = 14; |Y aBaja3_Art = "E";
               |HAZ artistas3;
          |FINSI;
          |SI campo = 15; |Y aBaja4_Art = "E";
               |HAZ artistas3;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO buscaT2;
     || esto es para ver si continuo contrato

     |SI #labtraba#0 = nEmp; |Y #labtraba#1 > nTra;
          |SI aFechaBajaAct = "";
               |ABRE #nomvarca;
               #nomvarca#0 = nEmp;
               #nomvarca#1 = nTra;
               #nomvarca#2 = nMesIRPF;
               #nomvarca#3 = 0;
               |LEE 000#nomvarca.=;
               |SI FSalida = 0;
                    aFechaBajaAct = #nomvarca#16;
                    |QBF aFechaBajaAct;
               |FINSI;
               |CIERRA #nomvarca;
          |FINSI;
          |QBF aFechaBajaAct;
          |SI aFechaBajaAct ! "";
               fFecha1 = aFechaBajaAct; || fecha baja trabajador que calculo
               nFecha1 = fFecha1;

               fFecha2 = #labtraba#36;
               nFecha2 = fFecha2;

               nFecha1 = nFecha1 + 1;
               |SI nFecha1 = nFecha2;
                    swContCont = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO buscaT1;
     || este proceso es para buscar otras fichas de trabajador en el mismo mes
     || que esten de alta y esten calculadas

     || solo las posteriores al que calculo, podria dar problemas algun dia,
     || pero en principio se queda asi
     |SI #labtraba#1 ] nTra;
          |ACABA;
     |FINSI;

     aFechaBaja = #labtraba#37;
     |QBF aFechaBaja;
     |SI aFechaBaja ! "";
          nDiaBaja = 0;
          fFechaBaja = aFechaBaja;
          alfa1 = aFechaBaja % 102;
          nDiaBaja = alfa1;
     |FINSI;

     alfa1 = "01";
     alfa2 = nElMes;  alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech4 = alfa4;      || primer dia del mes que calculo

     alfa5 = "31." + alfa2 + "." + alfa3;   || ultimo dia del mes que calculo
     fech5 = alfa5;

     swSigue = 0;
     |SI fech4 [ fFechaBaja; |Y fFechaBaja [ fech5; || es baja en este mes
          swSigue = 1;
     |FINSI;

     |SI nEmp = #labtraba#0; |Y nTra = #labtraba#1;  || trabajador actual
          |SI aFechaBaja = ""; |O fFechaBaja ] fech5;
               fFechaBaja = fech5;
               swSigue = 1;
          |FINSI;
     |FINSI;

     |SI aCon = #labtraba#45; || si no cambio de contrato no tengo por que
          swSigue = 0;        || acumular esto, fallaba en maternidad a tp
     |FINSI;                  || 3462.330

     |SI swSigue = 1;
          || se que es baja este mes, ahora busco ficha en nomcalca
          || para buscar dias de IT acumulados

          #nomcalca#0 = #labtraba#0;
          #nomcalca#1 = #labtraba#1;
          #nomcalca#2 = nElMes;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
                    nCampoD = nCampo - 8;
                    nCampoH = nCampo - 4;
                    aAlfa = #nomcalca#nCampo#;
                    nNume1 = #nomcalca#nCampoD#;
                    nNume2 = #nomcalca#nCampoH#;
                    |SI aAlfa = #nomvarca#12; |Y nNume1 = #nomvarca#4;
                         || mismo tipo de IT, misma fecha de inicio, no hay
                         || que acumular porque "debe ser" un trabajador con
                         || dos fichas de alta, pero que van a la vez, pero no
                         || acaba una y despues otra, dos contratos simultaneos

                         aAlfa = " ";   || hago esto para que no entre
                    |FINSI;
                    |SI aAlfa ! " ";
                         |SI nNume2 = 0; |O nDiaBaja = nNume2;
                         || tengo una IT que he de acumular para el trabajador
                         || que estoy calculando
                              mesnum = nElMes;
                              anynum = nElAny;
                              |HAZ ulti_dia;
                              |SI nNume1 = 0;
                                   nNume1 = 1;
                                   |SI aAlfa = "A";    || accidente
                                        nDiasITAcum = #labtraba#92;
                                   |SINO;              || otra cosa
                                        nDiasITAcum = #labtraba#89;
                                   |FINSI;
                              |FINSI;
                              |SI nNume2 = 0;
                                   nNume2 = topemes;
                              |FINSI;
                              nNume = nNume2 - nNume1 + 1;

                              aTipoITAcum = aAlfa;
                              nDiasITAcum = nDiasITAcum + nNume;

                              |SAL;
                         |FINSI;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO buscaT;
     |SI runnom = "nomcalcu";
          |HAZ buscaT1;
     |FINSI;
     |SI runnom = "nomcalir";
          |HAZ buscaT2;
     |FINSI;
|FPRC;

|DEFBUCLE buscaT;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, buscaT;
|FIN;

|PROCESO BuscaTrab;
     nDiasITAcum = 0;

     swContCont = 0;          || continua contrato

     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     aNif = #labtraba#7;
     aCon = #labtraba#45;
     aFechaBajaAct = aFeBajaReal;
     |QBF aFechaBajaAct;

     |SALVA_FICHA #labtraba;
     |SALVA_FICHA #nomvarca;
     |SALVA_FICHA #nomcalca;

     |BUCLE buscaT;

     |REPON_FICHA #nomcalca;
     |REPON_FICHA #nomvarca;
     |REPON_FICHA #labtraba;
|FPRC;

/****************************************************************************/
/*               CALCULO DE INDEMNIZACIONES SEGUN CONVENIO                  */
/****************************************************************************/

|PROCESO Prop902;
     nDiasPago = nUnidades;

     nPorCada = 12;

     nUnidades = nMesesAlta / nPorCada;

     nUnidades = nUnidades * nDiasPago;
|FPRC;

|PROCESO Busca949;
     sw949 = 0;

     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 949;
     |LEE 000#6=;
     |SI FSalida = 0;
          aUnid = #6#3;
          |QBT aUnid;
          |SI aUnid ! "-1";
               nUnidades = aUnid;
          |FINSI;

          aImporte = #6#4;
          |QBT aImporte;
          |SI aImporte ! "-1";
               nImporInd = aImporte;
          |FINSI;

          sw949 = 1;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 949;
     |LEE 000#8=;
     |SI FSalida = 0;
          aUnid = #8#5;
          |QBT aUnid;
          |SI aUnid ! "-1";
               nUnidades = aUnid;
          |FINSI;

          aImporte = #8#6;
          |QBT aImporte;
          |SI aImporte ! "-1";
               nImporInd = aImporte;
          |FINSI;

          sw949 = 1;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO Busca902;
     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 902;
     |LEE 000#6=;
     |SI FSalida = 0;
          aUnid = #6#3;
          |QBT aUnid;
          nUnidades = aUnid;
          swExiste902 = 1;
          |HAZ Prop902;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 902;
     |LEE 000#8=;
     |SI FSalida = 0;
          aUnid = #8#5;
          |QBT aUnid;
          nUnidades = aUnid;
          swExiste902 = 1;
          |HAZ Prop902;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO Busca410_415;
     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 410;
     |LEE 000#6=;
     |SI FSalida = 0;
          swExiste410 = 1;
     |FINSI;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 415;
     |SI FSalida = 0;
          swExiste415 = 1;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 410;
     |LEE 000#8=;
     |SI FSalida = 0;
          swExiste410 = 1;
     |FINSI;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 415;
     |LEE 000#8=;
     |SI FSalida = 0;
          swExiste415 = 1;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO cuentadias;
     |PARA nMesPaga = nDesdeMes; |SI nMesPaga [ nHastaMes; |HACIENDO nMesPaga = nMesPaga + 1;
          |SI nMesPaga = 1; |O nMesPaga = 3; |O nMesPaga = 5; |O nMesPaga = 7;
          |O nMesPaga = 8; |O nMesPaga = 10; |O nMesPaga = 12;
               nDiasPaga = nDiasPaga + 31;
          |SINO;
               |SI nMesPaga = 2;
                    nDiasPaga = nDiasPaga + 28;
               |SINO;
                    nDiasPaga = nDiasPaga + 30;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Busca200Sykes;
     || probablemente esto para todo el mundo deberia ponerse, pero de momento
     || no me arriesgo

     nImportePaga = 0;
     nDesde = nRango - 197;
     nHasta = nRango - 189;
     nCampoDias = nRango - 165;
     nConcPaga = nRango - 149;
     nFinConcPaga = nConcPaga + 32;
     |PARA nCampo = nConcPaga; |SI nCampo [ nFinConcPaga; |HACIENDO nCampo = nCampo + 8;
          #nomcalli#0 = #labtraba#0;
          #nomcalli#1 = #labtraba#1;
          #nomcalli#2 = nElMes;
          #nomcalli#3 = 0;
          #nomcalli#4 = #nomconca#nCampo#;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;
               nImportePaga = nImportePaga + #nomcalli#10;
          |FINSI;
     |SIGUE;
     |SI nImportePaga = 0; || nada en mensual, tendre que buscar en Hco.
          |PARA nCampo = nConcPaga; |SI nCampo [ nFinConcPaga; |HACIENDO nCampo = nCampo + 8;
               #nomhicli#0 = #labtraba#0;
               #nomhicli#1 = #labtraba#1;
               #nomhicli#12 = nElAny - 2000;
               #nomhicli#2 = nElMes;
               #nomhicli#3 = 0;
               #nomhicli#4 = #nomconca#nCampo#;
               |LEE 000#nomhicli.=;
               |SI FSalida = 0;
                    nImportePaga = nImportePaga + #nomhicli#10;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #nomconca#nDesde# < #nomconca#nHasta#;
          nDesdeMes = #nomconca#nDesde#;
          nHastaMes = #nomconca#nHasta#;
          nMeses = nHastaMes - nDesdeMes + 1;

          nDiasPaga = 0;
          |HAZ cuentadias;
     |SINO;
          nDesdeMes = #nomconca#nDesde#;
          nHastaMes = 12;
          nMeses = nHastaMes - nDesdeMes + 1;
          nDiasPaga = 0;
          |HAZ cuentadias;

          nDesdeMes = 1;
          nHastaMes = #nomconca#nHasta#;
          nMeses = nMeses + (nHastaMes - nDesdeMes + 1);
          |HAZ cuentadias;
     |FINSI;
     |SI nMeses > 12;
          nMeses = 12;
     |FINSI;
     nDias = #nomconca#nCampoDias#;

     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          nImportePaga = nImportePaga / 30;
     |SINO;
          nMes = nElMes;
          nAny = nElAny;
          |HAZ topemes_plb;

          nImportePaga = nImportePaga / nTopemes;
     |FINSI;

     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          || nImporInd = nImporInd + ((nDias / nMeses * nImportePaga) / 30);
          nImporInd = nImporInd + ((nDias / 12 * nImportePaga) / 30);
     |SINO;
          nImporInd = nImporInd + ((nDias * nImportePaga) / nDiasPaga);
     |FINSI;

     |CIERRA #nomhicli;
|FPRC;

|PROCESO Busca200Mens;
     #nomcalli#0 = #labtraba#0;
     #nomcalli#1 = #labtraba#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = nRango;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nDesde = nRango - 197;
          nHasta = nRango - 189;
          nCampoDias = nRango - 165;
          |SI #nomconca#nDesde# < #nomconca#nHasta#;
               nDesdeMes = #nomconca#nDesde#;
               nHastaMes = #nomconca#nHasta#;
               nMeses = nHastaMes - nDesdeMes + 1;

               nDiasPaga = 0;
               |HAZ cuentadias;
          |SINO;
               nDesdeMes = #nomconca#nDesde#;
               nHastaMes = 12;
               nMeses = nHastaMes - nDesdeMes + 1;
               nDiasPaga = 0;
               |HAZ cuentadias;

               nDesdeMes = 1;
               nHastaMes = #nomconca#nHasta#;
               nMeses = nMeses + (nHastaMes - nDesdeMes + 1);
               |HAZ cuentadias;
          |FINSI;
          |SI nMeses > 12;
               nMeses = 12;
          |FINSI;
          nDias = #nomconca#nCampoDias#;

          |SI #nomcalli#10 > 1;    || si hay algun importe
               nImportePaga = #nomcalli#10;
               |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
                    nImporInd = nImporInd + ((nDias/nMeses * nImportePaga) / 30);
               |SINO;
                    nImporInd = nImporInd + ((nDias * nImportePaga) / nDiasPaga);
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO concepto200;
     |HAZ BuscaModulo;
     |SI swModulo = 3462;
          |HAZ Busca200Sykes;
     |SINO;
          |HAZ Busca200Mens;
     |FINSI;
|FPRC;

|PROCESO BuscaCon200;
     |SI concepto = 200;
          nDConcepto = 201;
          nHConcepto = 208;
          |PARA nRango = nDConcepto; |SI nRango [ nHConcepto; |HACIENDO nRango = nRango + 1;
               |HAZ concepto200;
          |SIGUE;
     |SINO;
          nRango = concepto;
          |HAZ concepto200;
     |FINSI;
|FPRC;

|PROCESO AntiguedadInd;
     #nomcalli#0 = #2#0;
     #nomcalli#1 = #2#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = 102;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nImporInd = nImporInd + (#nomcalli#10 * #nomcalli#11 / #nomcalca#8);
     |FINSI;
|FPRC;

|PROCESO PropUltMes;
     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     |SI nDiaBaja ! nTopemes;
          nMes = nMesBusca;
          nAny = nAnyBusca;
          |HAZ topemes_plb;
          nume3 = nTopemes - nDiaBaja;

          |SI nume3 < nDiasAlta;
               nume4 = nume3;
          |SINO;
               nume4 = nDiasAlta;
          |FINSI;
          nImporte = nume4 * nImporte / nDiasMes;
     |FINSI;
     |SI nImporte < 0;
          nImporte = 0;
     |FINSI;
|FPRC;

|PROCESO BuscaImpCalc;
     |SI nConcepto1 = 410; |O nConcepto1 = 415;   || no se va a tener
          |ACABA;             || no voy a tener en cuenta la propia indemnizacion
     |FINSI;                  || aunque estuviera el concepto en el convenio

     nMeses = #nomfinli#7;
     nAnyBusca = nElAny;
     |SI nMeses = 0;
          nMeses = 999;
     |FINSI;
     |PARA nMesBusca = nMesBaja; |SI nMeses ] 0; |HACIENDO nMesBusca = nMesBusca - 1;
          |SI nMesBusca = 0;
               nMesBusca = 12;
               nAnyBusca = nAnyBusca - 1;
          |FINSI;
          nImporte = 0
          swExiste = 0;
          |SI nMesBusca = nMesBaja; |Y nAnyBusca = nAnyBaja;
               || es el mes de la baja, busco mensual
               #nomcalli#0 = #labtraba#0;
               #nomcalli#1 = #labtraba#1;
               #nomcalli#2 = nMesBusca;
               #nomcalli#3 = 0;
               #nomcalli#4 = nConcepto1;
               |LEE 000#nomcalli.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    nUnidadesCon = nUnidadesCon + #nomcalli#11;
                    nImporte = (#nomcalli#11* #nomcalli#10);
                    nImporInd = nImporInd + nImporte;
               |FINSI;
               || tambien busco atrasos mensual
               #nomcalal#0 = #labtraba#0;
               #nomcalal#1 = #labtraba#1;
               #nomcalal#2 = nMesBusca;
               #nomcalal#3 = 0;
               #nomcalal#4 = nConcepto1;
               |LEE 000#nomcalal.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    nImporte = (#nomcalal#11* #nomcalal#10);
                    nImporInd = nImporInd + nImporte;
               |FINSI;
          |SINO;
               || es el otro mes anterior, busco historico

               #nomhicca#0 = #labtraba#0;
               #nomhicca#1 = #labtraba#1;
               #nomhicca#66 = nAnyBusca - 2000;
               #nomhicca#2 = nMesBusca;
               #nomhicca#3 = 0;
               |LEE 000#nomhicca.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    |PARA nTipo = 0; |SI nTipo [ 7; |HACIENDO nTipo = nTipo + 1;
                         |SI nTipo = 0; |O nTipo = 5; |O nTipo = 6; |O nTipo = 7;
                              #nomhicli#0 = #labtraba#0;
                              #nomhicli#1 = #labtraba#1;
                              #nomhicli#12 = nAnyBusca - 2000;
                              #nomhicli#2 = nMesBusca;
                              #nomhicli#3 = nTipo;
                              #nomhicli#4 = nConcepto1;
                              |LEE 000#nomhicli.=;
                              |SI FSalida = 0;
                                   nImporte = (#nomhicli#11* #nomhicli#10);
                                   |SI nTipo = 0;
                                        nUnidadesCon = nUnidadesCon + #nomhicli#11;
                                   |FINSI;
                                   |SI nMeses = 0;
                                        nDiasMes = #nomhicca#7;
                                        nDiasAlta = #nomhicca#8;
                                        |HAZ PropUltMes;
                                   |FINSI;
                                   nImporInd = nImporInd + nImporte;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;
          nMeses = nMeses - 1;
          |SI swExiste = 0;
               || No encuentro en un mes del trabajador, no sigo buscando
               swExiste = 1;
               |SAL;
          |FINSI;
      |SIGUE;
|FPRC;

|PROCESO BuscaImpMant;
     #nomconli#0 = #labtraba#87;
     #nomconli#2 = nConcepto1;
     |LEE 000#nomconli.=;

     |ABRE #nomcatli;
     #nomcatli#0 = #2#87; #nomcatli#1 = #2#17; #nomcatli#2 = nConcepto1;
     |LEE 000#nomcatli.=;
     |SI FSalida = 0;
          nImporInd = #nomcatli#4;
          aUnid = #nomcatli#3;
          |QBT aUnid;
          |SI aUnid = "1"; |Y #nomconli#3 ! "M";
               nImporInd = #nomcatli#4 / 30;
          |SINO;
               |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
               |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                    |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         nImporInd = #nomcatli#4 * #nomconli#14 / 30;
                    |SINO;
                         nImporInd = #nomcatli#4;
                    |FINSI;
               |SINO;
                    nImporInd = 0;
               |FINSI;
          |FINSI;
          |SI tp ! 0; |Y tp ! 1;
               nImporInd = nImporInd * tp;
               || aqui es el unico sitio donde tengo que multiplicar por
               || el coeficiente, ya que si lo cojo del importes por
               || trabajador o variaciones, ya se pone el importe reducido
          |FINSI;
          |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
               nImporInd = 0;
          |FINSI;
          |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                   || importe para calcular importe por hora
               nNume = #nomcatli#4;
               |SI nNume ! 0;
                    nImporInd = nNume;
               |FINSI;
          |FINSI;
          |SI nConcepto1 = 920;
               aAlfa = #nomcatli#3;
               nImporInd = aAlfa;
               sw920 = 1;
          |FINSI;
     |FINSI;
     |CIERRA #nomcatli;

     |ABRE #nomtrali;
     #nomtrali#0 = #2#0;  #nomtrali#1 = #2#1;  #nomtrali#2 = nConcepto1;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0;
          nImporInd = #nomtrali#4;
          aUnid = #nomtrali#3;
          |QBT aUnid;
          |SI aUnid = "1"; |Y #nomconli#3 ! "M";
               nImporInd = #nomtrali#4 / 30;
          |SINO;
               |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
               |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                    |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         nImporInd = #nomtrali#4 * #nomconli#14 / 30;
                    |SINO;
                         nImporInd = #nomtrali#4;
                    |FINSI;
               |SINO;
                    nImporInd = 0;
               |FINSI;
          |FINSI;
          |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
               nImporInd = 0;
          |FINSI;
          |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                   || importe para calcular importe por hora
               nNume = #nomtrali#4;
               |SI nNume ! 0;
                    nImporInd = nNume;
               |FINSI;
          |FINSI;
          |SI nConcepto1 = 920;
               aAlfa = #nomtrali#3;
               nImporInd = aAlfa;
               sw920 = 1;
          |FINSI;
     |FINSI;
     |CIERRA #nomtrali;

     |ABRE #nomvarli;
     #nomvarli#0 = #2#0;  #nomvarli#1 = #2#1;  #nomvarli#2 = nElMes;  #nomvarli#3 = 0;  #nomvarli#4 = nConcepto1;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0;
          aUnid = #nomvarli#5;
          aPrecio = #nomvarli#6;
          |QBT aUnid;
          |QBT aPrecio;
          |SI aUnid ! ""; |Y aPrecio ! "";
               nImporInd = #nomvarli#6 / 30;
               |SI aUnid = "1"; |Y #nomconli#3 ! "M";
                    nImporInd = #nomvarli#6 / 30;
               |SINO;
                    |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
                    |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                              nImporInd = #nomvarli#6 * #nomconli#14 / 30;
                         |SINO;
                              |SI #nomconli#3 = "V"; |O #nomconli#3 = "F";
                                   nImporInd = #nomvarli#5 * #nomconli#6 / 30;
                              |SINO;
                                   nImporInd = #nomvarli#6;
                              |FINSI;
                         |FINSI;
                    |SINO;
                         nImporInd = 0;
                    |FINSI;
               |FINSI;
               |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
                    nImporInd = 0;
               |FINSI;
               |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                        || importe para calcular importe por hora
                    nNume = #nomvarli#6;
                    |SI nNume ! 0;
                         nImporInd = nNume;
                    |FINSI;
               |FINSI;
               |SI nConcepto1 = 920;
                    aAlfa = #nomvarli#5;
                    nImporInd = aAlfa;
                    sw920 = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomvarli;

     |SI nImporInd < 0;
          nImporInd = 0;
     |FINSI;

     |HAZ BuscaModulo;
     |SI swModulo = 3462;    || para sykes, 39 horas semanales a pelo
          |SI #labtraba#234 ! 0;
               nImporInd = nImporInd * (#labtraba#234 / 39);
          |FINSI;
     |FINSI;
     |SI nConcepto1 = 102;
          |HAZ AntiguedadInd;
     |FINSI;
|FPRC;

|PROCESO BuscaConInd1;
     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 ! "P";
          || solo en caso de % y que ademas le digamos de cuantos meses
          || queremos cobrarlo

          |HAZ BuscaImpCalc;  || Busca importe por los mantenimientos
                              || mensual o historico
     |SINO;

          |HAZ BuscaImpMant;  || Busca importe por los mantenimientos
                              || convenio, trabajador, variaciones

     |FINSI;
|FPRC;

|PROCESO BuscaConInd;
     aAlfa = ("000" + concepto) % -102;
     |SI aAlfa ! "00";
         nConcepto1 = concepto;
         |HAZ BuscaConInd1;
     |SINO;
         nDConcepto = concepto + 1;
         nHConcepto = concepto + 99;
         nTImporInd = 0;

         |PARA nRango = nDConcepto; |SI nRango [ nHConcepto;  |HACIENDO nRango = nRango + 1;
               ||SI nRango ! 102;
               || no se porque hacia esto, incluyo antiguedad a partir de
               || 07.01.2013
                   nImporInd  = 0;
                   nConcepto1 = nRango;
                   |HAZ BuscaConInd1;
                   nTImporInd = nTImporInd + nImporInd;
               ||FINSI;
         |SIGUE;

         nImporInd = nTImporInd;
     |FINSI;
|FPRC;

|PROCESO BuscaIndem;
     nNume1 = nMesesAlta - (nMesesAlta ! 0);
     aAlfa = nNume1; |QBF aAlfa;
     |SI aAlfa = "0"; |O aAlfa = "-0";
          nMesesAlta = nMesesAlta ! 0;
     |FINSI;

     |SI #nomfinli#3 < nMesesAlta; |Y nMesesAlta [ #nomfinli#4;
          swTengoDerecho = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaIndem;
     #nomfinli#1;
     ;
     #labtraba#87, nume1, 01;
     #labtraba#87, nume1, 99;
     ;
     NULL, BuscaIndem;
|FIN;

|PROCESO BuscaConInd2;
     nImporInd = 0;
     concepto = #nomconli#2;
     |HAZ BuscaConInd;
     nTotInd = nTotInd + nImporInd;
|FPRC;

|DEFBUCLE ConceptosCat;
     #nomconli#1;
     ;
     #labtraba#87, 101;
     #labtraba#87, 999;
     ;
     NULL, BuscaConInd2;
|FIN;

|PROCESO acu_ctos_fin;
     |SI concepto = 410;
                          acum_40 = acum_40 + product;
          |SI #10#8 = 1;  acum_401 = acum_401 + product;  |FINSI;
          |SI #10#8 = 2;  acum_402 = acum_402 + product;  |FINSI;
          |SI #10#8 = 3;  acum_403 = acum_403 + product;  |FINSI;
          |SI runnom = "nomcalcu";
               bruto_rec = bruto_rec + product;
               acum_99 = acum_99 + product;   || total
               acum_991 = acum_991 + product;  || irpf 1
               || la indemnizacion la acumulo solo en el tipo 1 de IRPF
               || acum_992 = acum_992 + product;  || irpf 2
               || acum_993 = acum_993 + product;  || irpf 3

               reten_11 = acum_991 % nIRPF1;  || retencion IRPF 1
               reten_12 = acum_992 % nIRPF2;  || retencion IRPF 2
               reten_13 = acum_993 % nIRPF3;  || retencion IRPF 3
               reten_11 = reten_11 ! EURODB;
               reten_12 = reten_12 ! EURODB;
               reten_13 = reten_13 ! EURODB;
               reten_1 = reten_11 + reten_12 + reten_13;  || total retenciones
          |FINSI;
     |FINSI;

     |SI concepto = 415;
          |SI #10#8 ! 0;
               acum_41 = acum_41 + product;
               bruto_rec = bruto_rec + acum_41;
          |SINO;
               acum_60 = acum_60 + product;
               bruto_rec = bruto_rec + acum_60;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO mesesAlta;
     aDiaAlta = aFechaAlta % 102;
     aMesAlta = aFechaAlta % 402;
     aAnyAlta = aFechaAlta % -104;
     aDiaBaja = aFechaBaja % 102;
     aMesBaja = aFechaBaja % 402;
     aAnyBaja = aFechaBaja % -104;
     nDiaAlta = aDiaAlta;
     nMesAlta = aMesAlta;
     nAnyAlta = aAnyAlta;
     nDiaBaja = aDiaBaja;
     nMesBaja = aMesBaja;
     nAnyBaja = aAnyBaja;

     guarda = topemes;
     nDiasAlta = 0;
     nMesesAlta = 0;
     |PARA nAny = nAnyAlta; |SI nAny [ nAnyBaja; |HACIENDO nAny = nAny + 1;
          |PARA nMes = 1; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
               |SI nMes < nMesAlta; |Y nAny = nAnyAlta;
                    || todavia no
               |SINO;
                    |SI nAny = nAnyBaja; |Y nMes = nMesBaja;
                         |SAL;
                    |FINSI;
                    mesnum = nMes;
                    anynum = nAny;
                    |HAZ ulti_dia;
                    |SI nMesesAlta = 0;
                         |SI nDiaAlta ! 1;
                              || como en dias cotizables:
                              nPropAlta = (topemes - nDiaAlta + 1) / topemes;
                              nNumDias = (topemes - nDiaAlta + 1);
                         |SINO;
                              nPropAlta = 1;
                              nNumDias = topemes;
                         |FINSI;
                    |SINO;
                         nPropAlta = 1;
                         nNumDias = topemes;
                    |FINSI;
                    nMesesAlta = nMesesAlta + nPropAlta;
                    nDiasAlta = nDiasAlta + nNumDias;
               |FINSI;
          |SIGUE;
     |SIGUE;

     || el ultimo mes:

     mesnum = nMesBaja;
     |HAZ ulti_dia;
     |SI nDiaBaja ! topemes;
          || como en dias cotizables:
          |SI nMesAlta = nMesBaja; |Y nAnyAlta = nAnyBaja; || mismo mes alta y baja
              nPropAlta = (nDiaBaja - nDiaAlta + 1)/ topemes;
              nNumDias =  (nDiaBaja - nDiaAlta + 1);
          |SINO;
              nPropAlta = nDiaBaja / topemes;
              nNumDias =  nDiaBaja;
          |FINSI;
     |SINO;
          |SI nMesAlta = nMesBaja; |Y nAnyAlta = nAnyBaja; || mismo mes alta y baja
              nPropAlta = (nDiaBaja - nDiaAlta + 1)/ topemes;
              nNumDias =  (nDiaBaja - nDiaAlta + 1);
          |SINO;
               nPropAlta = 1;
               nNumDias = topemes;
          |FINSI;
     |FINSI;

     nMesesAlta = nMesesAlta + nPropAlta;
     nDiasAlta = nDiasAlta + nNumDias;
|FPRC;

|PROCESO DiasPago;
|| a ver, esta ley ya esta mas que caducada, todos los contratos temporales
|| a estas alturas (2018) son 12 dias por a¤o trabajado

/*
     |HAZ BuscaModulo;
     |SI aFechaFIN ! "";
          |ACABA;        || no hagas esto con el informe de Sykes
     |FINSI;
     |MODULO aAlfa;

     nContrato = #labtraba#45;
     |SI nContrato ] 400; |Y #nomfinli#6 = "D"; |Y #nomfinli#7 = 12;
          || para los contratos de duracion determinada, los dias de indem-
          || nizacion estan estipulados segun la fecha de alta

          aAlfa = #labtraba#36;
          aAlfa = aAlfa % -104;
          nAnyAlta = aAlfa;

          |SI nAnyAlta [ 2011; nDiasLey = 8; |FINSI;
          |SI nAnyAlta = 2012; nDiasLey = 9; |FINSI;
          |SI nAnyAlta = 2013; nDiasLey = 10; |FINSI;
          |SI nAnyAlta = 2014; nDiasLey = 11; |FINSI;
          |SI nAnyAlta ] 2015; nDiasLey = 12; |FINSI;
     |FINSI;

     |SI nDiasLey ! #nomfinli#5;
          |SI nDiasLey = 8;
               aAlfa2 = " ocho";
               aAlfa3 = "hasta el 31 de diciem-";
               aAlfa4 = "bre de 2011.";
          |FINSI;
          |SI nDiasLey = 9;
               aAlfa2 = "nueve";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2012.";
          |FINSI;
          |SI nDiasLey = 10;
               aAlfa2 = " diez";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2013.";
          |FINSI;
          |SI nDiasLey = 11;
               aAlfa2 = " once";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2014.";
          |FINSI;
          |SI nDiasLey = 12;
               aAlfa2 = " doce";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2015.";
          |FINSI;

          |PUSHV 05012380;
          |BLANCO 10102271;
          |AVISO;
          |PINPA #5#nompanta;
          |ATRI S;
          |PINTA 1664, aAlfa2;
          |PINTA 1847, aAlfa3;
          |PINTA 1913, aAlfa4;
          |ATRI 0;
          |PAUSA;

          aAlfa1 = #nomfinli#5;
          aAlfa2 = nDiasLey;

          aAlfa = "    S¿Desea aplicar la indemnización de " + aAlfa2;
          aAlfa = aAlfa + " días (según Ley) en lugar de " + aAlfa1;
          aAlfa = aAlfa + " días (según Convenio)?";
          |CONFI aAlfa;

          |SI FSalida = 0;
               nDiasPago = nDiasLey;
          |FINSI;

          |POPV;
     |FINSI;
*/
|FPRC;

|PROCESO AdadeAgrarios;
     swAdadeAgrHor = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/adade004.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;
     |LEE 000#500=;
     |SI FSalida = 0;
          swAdadeAgrHor = 1;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO AdadeCitricos;
     swAdadeCitrico = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/adade005.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#0;
     |LEE 000#500=;
     |SI FSalida = 0;
          swAdadeCitrico = 1;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO PreguntaIndem;
     |SI aFechaFIN ! ""; || Sykes, Theorical Liquidation
          |ACABA;
     |FINSI;

     aAlfa1 = #labtraba#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = #labtraba#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
     aAlfa = aAlfa1 + "." + aAlfa2;
     aAlfa3 = "";
     |SI swIndem = 1;        || por convenio
          aAlfa3 = "S";
     |FINSI;
     |SI swIndem = 2;        || por concepto 902;
          |SI duni1_902 = 20; |O duni1_902 = 33; |O duni1_902 = 45;
               aAlfa3 = "N";
          |SINO;
               aAlfa3 = "S";
          |FINSI;
     |FINSI;
     |SI aAlfa3 = "S";
          aAlfa = "    ATENCION: el trabajador " + aAlfa + " tiene indemnización ";
          aAlfa = aAlfa + "por fin de contrato.";
          |MENAV aAlfa;
          aAlfa = "    " + aAlfa3 + "¿Aplicar retención por IRPF en la indemnización?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               concepto = 410;     || con retencion IRPF
          |SINO;
               concepto = 415;     || sin retencion IRPF
          |FINSI;
          nConceptoInd = concepto;
     |FINSI;
|FPRC;

|PROCESO CalIndNUEVO;   || CALCULA LA INDEMNIZACION
     || lo primero es saber cuantos dias lleva esta persona de alta desde
     || su fecha de antiguedad (mas bien en meses)
     swSigue = 0;
     swIndem = 0;
     |SI runnom = "nomcalcu"; |Y #labempre#39 = 1; || desde nomina, finiquito junto mes
          |SI #2#36 ! ".........."; |Y #2#36 ! "          ";      || fecha alta valida
               |SI fecbaj ! ".........."; |Y fecbaj ! "          "; || fecha baja valida
                    aMesBaja = fecbaj % 402;
                    nMesBaja = aMesBaja;
                    aAnyBaja = fecbaj % -104;
                    nAnyBaja = aAnyBaja;
                    |SI nMesBaja = nElMes; |Y nAnyBaja = nElAny;
                         swSigue = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI runnom = "nomcalfi";
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
          aAlfa = #nomvarca#46;
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;
          || solo estos tres, consensuado con Rafa 21.01.2016
          |SI aAlfa ! "54"; |Y aAlfa ! "93"; |Y aAlfa ! "98";
               aAlfa = #labtraba#184;
               aAlfa = aAlfa % 102;
               |QBF aAlfa;
               |SI aAlfa ! "54"; |Y aAlfa ! "93"; |Y aAlfa ! "98";
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aFechaFIN ! ""; || Sykes, Theorical Liquidation
          swSigue = 1;
     |FINSI;

     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     || esto para saber si son los trabajadores agrarios del modulo de
     || adade, que van por horas y hay que calcularles el finiquito
     || a razon de las HORAS trabajadas y no los dias

     swAdadeAgrHor = 0;       || este es el switch

     swModulo = 0;
     |HAZ BuscaModulo;
     |SI swModulo = 2884; |O swModulo = 1;
          |HAZ AdadeAgrarios;
          |HAZ AdadeCitricos;
     |FINSI;

     |ABRE #nomhicca;
     |ABRE #nomhicli;
     |ABRE #nomcalal;

     fFechaAnt = #labtraba#34;     || la fecha de antiguedad
     fFechaAlta = #labtraba#36;     || la fecha de alta contrato
     fFechaBaja = #2#37;            || la fecha de baja
     |SI #7#16 ! "..........";|Y #7#16 ! "          ";
          fFechaBaja = #7#16;
     |FINSI;

     || aFechaAlta = fFechaAlta;
     aFechaAlta = fFechaAnt;
     aFechaBaja = fFechaBaja;

     |QBF aFechaAlta;
     |QBF aFechaBaja;

     |SI aFechaFIN ! "";
          |SI aFechaBaja ! ""; |Y fFechaBaja [ fFechaFIN;
               aFechaBaja = aFechaBaja;
          |SINO;
               aFechaBaja = aFechaFIN;
          |FINSI;
     |FINSI;

     |HAZ mesesAlta;

     |SI swAdadeAgrHor = 1;
          nGuardaMeses = #nomfinli#7;
          #nomfinli#7 = 0;
          nConcepto1 = 101;
          nUnidadesCon = 0;
          |HAZ BuscaImpCalc;
          #nomfinli#7 = nGuardaMeses;
          nHoras = nUnidadesCon;
     |FINSI;

     |SI swAdadeCitrico = 1;
          || lo dejo de momento, hasta que nos diga el como calcularlo
     |FINSI;

     topemes = guarda;

     || lo segundo: a ver si tengo derecho a indemnizacion por cese;
     swTengoDerecho = 0;
     nume1 = #labtraba#45;
     |BUCLE BuscaIndem;
     |SI swTengoDerecho ! 1;
          |ACABA;
     |FINSI;

     || tercero: a ver cuantos dias de indemnizacion tengo que pagar segun
     || el tiempo que se ha trabajado
     |SI #nomfinli#6 ! "%";
          nDiasPago = #nomfinli#5;
          |HAZ DiasPago;

          nPorCada = #nomfinli#7;
          |SI nPorCada ! 0;
               nUnidades = nMesesAlta / nPorCada;
          |SINO;
               nUnidades = 1;
          |FINSI;

          |SI #nomfinli#8 = "N";             || no proporciono
               nUnidades = (nUnidades - 0.49) ! 0;
          |FINSI;

          nUnidades = nUnidades * nDiasPago;
          |SI #nomfinli#6 = "M";
               nUnidades = nUnidades * 30;
          |FINSI;
     |SINO;
          || aqui si es por porcentaje
          nDiasPago = #nomfinli#5;
          |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";      || mensuales
               nUnidades = nDiasAlta;
          |SINO;                        || diarios
               nFechaAlta = fFechaAlta;
               nFechaBaja = fFechaBaja;
               nUnidades = nFechaBaja - nFechaAlta + 1;
          |FINSI;
     |FINSI;

     swExiste902 = 0;
     |HAZ Busca902;
     swExiste410 = 0;
     swExiste415 = 0;
     |HAZ Busca410_415;

     nTotAju = 0;
     nTotInd = 0;
     nConceptos = 0;

     |SI #labtraba#97 ! 0; |Y #nomfinli#8 ! "D";
          || si tengo ajuste y no es por importe cobrado claro
          || ahora hay que simular un ajuste, a ver como lo hacemos
          |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";    || mensuales
               |SI #labtraba#207 = "D";
                    nTotInd = #2#98;
               |SINO;
                    nTotInd = #2#98 / 30;
               |FINSI;
          |SINO;                                            || diarios
               |SI #labtraba#207 = "D";
                    nTotInd = #2#98;
               |SINO;
                    nTotInd = (#2#98 * 12) / 365;
               |FINSI;
          |FINSI;

          || vale, ahora tengo en nTotInd el importe diario que he de pagar
          |SI #labtraba#97 = 1; |O #labtraba#97 = 2; |O #labtraba#97 = 5;
               || bruto, se queda igual
          |SINO;
               || liquido, hago ajuste rapido, no tengo SS, solo IRPF:
               || nTotBru = nTotInd + ((nTotInd * nIRPF1) / 100);
               || aqui no, a¤ado el IRPF para que sea el importe liquido del ajuste
               || solo si le digo que la indemnizacion va CON IRPF
               || eso lo hago despues
               nTotInd = nTotInd;
          |FINSI;

          nTotAju = nTotInd;
     |FINSI;

     swSigue = 1;
     sw920 = 0;
     nTotInd = 0;
     |PARA nume1 = 9; |SI nume1 [ 14; |Y swSigue = 1; |HACIENDO nume1 = nume1 + 1;
          nImporInd = 0;
          concepto = #nomfinli#nume1#;
          |SI concepto ! 0;
               nConceptos = nConceptos + 1;
               ||SI concepto ! 102; |Y concepto ! 0;    || la antiguedad aparte
               || no se porque hacia esto, incluyo antiguedad a partir de
               || 07.01.2013
               |SI concepto ! 0;
                    |SI 200 [ concepto; |Y concepto [ 208; |Y #nomfinli#8 ! "D";
                         |ABRE #nomconca;
                         #nomconca#0 = #labtraba#87;
                         |LEE 000#nomconca.=;
                         |HAZ BuscaCon200;
                         |CIERRA #nomconca;
                    |SINO;
                         |HAZ BuscaConInd;
                    |FINSI;
               |FINSI;
               nTotInd = nTotInd + nImporInd;
          |FINSI;
     |SIGUE;

     |SI nConceptos = 0; |Y swSigue = 1;
          nTotInd = 0;

          |BUCLE ConceptosCat;
     |FINSI;

     nImporInd = nTotInd;

     |SI nTotAju ! 0; |Y sw920 = 0;
          || cojo el importe calculado del ajuste,
          || simpre que no exista el 920
          || en la lista de conceptos que entran en la indemnizacion
          nImporInd = nTotAju;
     |FINSI;

     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 = "D";
          || el importe de las salarios que cojo del historico de las nominas
          || del trabajador ya esta reducido en los tiempos parciales, no hay
          || que volver a aplicar coeficiente de tp en los casos de que la indem.
          || sea del tipo "el 7% de todo lo cobrado por el trabajador"
     |SINO;
          || el resto de casos si no es un ajuste, s¡

          |SI #labtraba#97 ! 0;
               || tiene ajuste
          |SINO;
               |SI tp ! 0; |Y tp ! 1;
                    || nImporInd = nTotInd * tp;
                    || lo tiene que hacer solo si el importe viene de
                    || importes por categorias, aqui NO se hace mas
                    || 12.06.2014
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #nomfinli#6 = "%";
          nImporInd = nImporInd % nDiasPago;
     |FINSI;

     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 = "D";
          nUnidades = 1;
     |FINSI;

     |SI swAdadeAgrHor = 1;
          nUnidades = nHoras * nDiasPago / 365;
          nImporInd = nTotInd;
     |FINSI;

     |SI swModulo = 2884; |O swModulo = 1;
          |HAZ Busca949;
     |FINSI;

     || Ya tengo las unidades a pagar y el importe, con lo que ya puedo
     || construir la indemnizacion

     swIndem = 1;        || por convenio
     ||SI #nomcontr#13 = "N";  concepto = 415;  |FINSI;     || sin IRPF
     ||SI #nomcontr#13 = "S";  concepto = 410;  |FINSI;     || con IRPF
     ||SI #nomcontr#13 = "A";  concepto = 410;  |FINSI;     || con IRPF

     || indemnizaciones de convenio, por fin de contrato, con IRPF
     concepto = 410;      || con IRPF
     ||SI #nomcontr#59 = "S"; |Y swExiste902 = 0;
     ||SI swExiste902 = 0;
          |HAZ PreguntaIndem;      || si existe el 902 ya he preguntado
     ||FINSI;                       || antes

     |SI #nomcontr#59 = "S"; |Y runnom = "nomcalcu";
          concepto = nConceptoInd;
     |FINSI;

     || ajustes a liquido, a¤ado IRPF si le digo que tiene retencion
     || para que de el liquido que ha de dar

     |SI #labtraba#97 = 3; |O #labtraba#97 = 4; |O #labtraba#97 = 6;
          |SI concepto = 410;
               nImporInd = nImporInd + ((nImporInd * nIRPF1) / 100);
          |FINSI;
     |FINSI;

     duni1_902 = 1;
     duni2_902 = nUnidades;
     dvalo_902 = nImporInd;
     product = dvalo_902 * duni2_902;
     product = product ! EURODB;

     |HAZ convenio;
     |SI convenio = 0;
          graba04 = concepto;
          graba09 = 1;
          graba10 = dvalo_902;
          graba11 = duni2_902;
          |SI product ! 0;
               ||HAZ CompruebaIndem;
               swgracon = 1;   || para que regrabe campos
               swcongra = 2;   || para que acumule si existe
               graba05 = #nomconli#3;
               graba06 = #nomconli#4;
               graba07 = #nomconli#5;
               graba08 = #nomconli#6;
               |HAZ grabacon;

               duni2_999 = #nomcalli#11;
               dvalo_999 = #nomcalli#10;
               product = duni2_999 * dvalo_999;
               product = product ! EURODB;

               swSigue = 1;
               |SI runnom = "nomcalcu"; |Y #labempre#39 = 1;
                    |SI swExiste902 = 1;
                    |O swExiste410 = 1; |O swExiste415 = 1;
                         || desde nomina, finiquito junto mes, con importe
                         || en 902 o 410 entonces NO, ya se acumula despues
                         || 415 lo mismo
                         swSigue = 0;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    |HAZ acu_ctos_fin;
               |FINSI;
          |FINSI;
     |SINO;
          alfa1 = "    Indemnizacion: concepto [" + concepto + "] no definido en convenio ...";
          |MENAV alfa1;
     |FINSI;

     |CIERRA #nomcalal;
     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO TotalizaDes;
     #nomhisi2#12 = dacum_999_completo;
     |GRABA 020#nomhisi2.a;
|FPRC;

|DEFBUCLE TotalizaDes;
     #nomhisi2#1;
     ;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 0, aTipoIT, 100;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 0, aTipoIT, 999;
     be;
     NULL, TotalizaDes;
|FIN;

|PROCESO TotalDesglose;
     |BUCLE TotalizaDes;
|FPRC;

|PROCESO BorraDesglose;
     |BORRA 020#nomhisi2.a;
|FPRC;

|DEFBUCLE BorraDesglose;
     #nomhisi2#1;
     ;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 0, "A", 100;
     #labtraba#0, #labtraba#1, nElAny, nElMes, 0, "E", 999;
     be;
     NULL, BorraDesglose;
|FIN;

|PROCESO LimpiaDesglose;
     |BUCLE BorraDesglose;
|FPRC;

|PROCESO DesgloseComp;
     |ABRE #nomhisi2;
     #nomhisi2#0 = #labtraba#0;
     #nomhisi2#1 = #labtraba#1;
     #nomhisi2#2 = nElAny;
     #nomhisi2#3 = nElMes;
     #nomhisi2#4 = 0;
     #nomhisi2#5 = aTipoIT;
     #nomhisi2#6 = concepto;
     |LEE 101#nomhisi2.=;
     FEstado = FSalida;
     |SI concepto ! 120; |Y duni1_999 ! 1;
          #nomhisi2#7 = (duni1_999 - dabse_2);
     |SINO;
          #nomhisi2#7 = (duni1_999 - (dabse_2 / divide));
     |FINSI;
     #nomhisi2#8 = dvalo_999;
     #nomhisi2#9 = #nomhisi2#7 * #nomhisi2#8;
     #nomhisi2#10 = divide;
     #nomhisi2#11 = #nomhisi2#9 / #nomhisi2#10;
     |SI FEstado = 0;
          |GRABA 020#nomhisi2.a;
     |SINO;
          |GRABA 020#nomhisi2.n;
     |FINSI;
     |CIERRA #nomhisi2;
|FPRC;

|| PROCESO PARA BUSCAR LA CANTIDAD BONIFICADA EN BONIFICACIONES PARA
|| BENEFICIARIOS DE PRESTACION DE DESEMPLEO, QUE TIENEN LIMITADO EL MAXIMO

|PROCESO BuscaBonif;
     nNume = nNume + #nomhicca#63;
|FPRC;

|DEFBUCLE BuscaBonif;
     #nomhicca#1;
     12;
     #labtraba#0, #labtraba#1, nDesdeAny, 01,  0, #nombonif#0;
     #labtraba#0, #labtraba#1, nHastaAny, 12, 99, #nombonif#0;
     ;
     NULL, BuscaBonif;
|FIN;

|PROCESO BuscaBonifNIF;
     |BUCLE BuscaBonif;
|FPRC;

|DEFBUCLE BuscaBonifNIF;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaBonifNIF;
|FIN;

|PROCESO LimiteBonif;
     nNume = 0;
     |SI #nombonif#26 = "S"; |Y #labtraba#217 ! 0;
          nDesdeAny = 09;
          nHastaAny = nElAny - 2000;
          aNif = #labtraba#7;
          |SALVA_FICHA #labtraba;
          |BUCLE BuscaBonifNIF;
          |REPON_FICHA #labtraba;
          nNume = #labtraba#217 - nNume;
          |SI nNume < 0;
               base_A = 0;
          |SINO;
               |SI nNume ] base_A;
                    base_A = base_A;
               |SINO;
                    base_A = nNume;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ERE_Par_Con;
     |SI swAbsVacHue = 1;
          |ACABA;
     |FINSI;
     |PARA campo = 12; |SI campo [ 15; |HACIENDO campo = campo + 1;
          desde = campo - 8;
          hasta = campo - 4;
          tipo = campo;
          prop = campo + 35;
          |SI #nomvarca#tipo# = "D";          || tengo ERE
               |SI #nomvarca#prop# ! 100; |Y #nomvarca#prop# ! 0;     || a TP
                    |PARA mid = #nomvarca#desde#;
                    |SI mid [ #nomvarca#hasta#;
                    |HACIENDO mid = mid + 1;
                         |SI #nomvarca#desde# [ mid; |Y mid [ #nomvarca#hasta#;
                              nume1 = (mid * 100) + 1;
                              alfa1 = meslabo % nume1;
                              |SI alfa1 = "0";
                                   ajuste7 = ajuste7 + (1 - (#nomvarca#prop# / 100));
                              |FINSI;
                              alfa2 = histori2 % nume1;
                              alfa3 = histori3 % nume1;
                              |SI alfa2 = "I"; |Y alfa3 = "d";
                                   || coindice desempleo y enfermedad
                                   nDesEnf = nDesEnf + 1;
                                   |SI alfa1 = "0";
                                        ajuste7 = ajuste7 - (1 - (#nomvarca#prop# / 100));
                                   |FINSI;
                              |FINSI;
                              |SI alfa2 = "J"; |Y alfa3 = "d";
                                   || coindice desempleo y accdidente
                                   nDesAcc = nDesAcc + 1;
                                   |SI alfa1 = "0";
                                        ajuste7 = ajuste7 - (1 - (#nomvarca#prop# / 100));
                                   |FINSI;
                              |FINSI;
                              |SI alfa2 = "M"; |Y alfa3 = "d";
                                   || coindice desempleo y mat/pat/rie/con
                                   nDesMat = nDesMat + 1;
                                   |SI alfa1 = "0";
                                        ajuste7 = ajuste7 - (1 - (#nomvarca#prop# / 100));
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO liquidados_c1;
     || necesario para que en meses de 31 dias en mensuales me bonifique
     || la base de 30 dias - 002752.00517. En meses de 28 dias tambien

     |SI nNume > dia_4;
          nNume = dia_4;
     |FINSI;
     |SI nNume = dia_2; |Y nNume < dia_4;
          |SI #labtraba#42 ! "C"; |O #labtraba#42 ! "F";
               nNume = dia_4;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboniERE;
|ACABA;
     |SI runnom = "nomcalfi";      || en finiquito no, hombre no
          |ACABA;
     |FINSI;
     nBonifERE = 0;
     nDiasBonifERE = 0;
     swSigue = 0;
     |SI nElAny ] 2009;
          |SI nElAny = 2009;
               |SI nElMes ] 5;
                    swSigue = 1;
               |FINSI;
          |SINO;
                swSigue = 1;
          |FINSI;
     |FINSI;
     |SI #labtraba#188 = "S"; |Y swSigue = 1;
          nNume = 240 - #labtraba#218;  || dias que puedo bonificar aun (maximo 240)
          |SI nNume < 0;           || si
               nNume = 0;
          |SINO;
               |SI nNume ] ddese_2;
                    nNume = ddese_2;
               |SINO;
                    nNume = nNume;
               |FINSI;
          |FINSI;
          |HAZ liquidados_c1;
          nDiasBonifERE = nNume;
          |SI #labtraba#45 ! "421";
               nBonifERE = ((nNume * #labtraba#242) ! 2) % #nomconst#6;
          |SINO;
               nBonifERE = #nomconst#82;
          |FINSI;
          |SI nElAny ] 2010;
               |SI nElAny = 2010; |Y nElMes < 6;
                    nBonifERE = (nBonifERE % 50) ! 2;
               |SINO;
                    |SI #labtraba#219 ! 0;
                         nBonifERE = (nBonifERE % #labtraba#219) ! 2;
                    |SINO;
                         nBonifERE = (nBonifERE % 50) ! 2;
                    |FINSI;
               |FINSI;
          |SINO;
               nBonifERE = (nBonifERE % 50) ! 2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PFETP;
     |SI #labtraba#129 = "G";
          |ACABA;
     |FINSI;
     |SI swDupli = 1;
          || primero esto para tener en cuenta los trabajadores con ficha
          || duplicada, a los que directamente le multiplico la bonif
          || por el coeficiente a tp porque tengo que considerarlo como si
          || estuvieran a tiempo completo
          |SI #labtraba#129 = "T";
               |SALVA_FICHA #labtraba;
               #labtraba#0 = #labtraba#0;
               #labtraba#1 = nTrabDupli;
               |LEE 000#labtraba.=;
               nNume1 = #labtraba#234 / #nomconca#162;
               |REPON_FICHA #labtraba;
               nBonifFCI = nBonifFCI - ((nBonifFCI * nNume1) ! 2);
          |SINO;
               nBonifFCI = (nBonifFCI * tp) ! 2;
          |FINSI;
          |ACABA;
     |FINSI;

     || aAlfa1 = #labtraba#36;
     aAlfa1 = #nombotra#4;
     aAlfa2 = "08.03.2009";
     fFecha1 = aAlfa1;
     fFecha2 = aAlfa2;
     |SI fFecha1 < fFecha2;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
               |SI #labtraba#234 > 0; |Y #labtraba#234 < 10;
                    nBonifFCI = nBonifFCI * 0.25;
                    nBonifFCI_T1 = nBonifFCI_T1 * 0.25;
                    nBonifFCI_T2 = nBonifFCI_T2 * 0.25;
               |FINSI;
               |SI #labtraba#234 ] 10; |Y #labtraba#234 < 20;
                    nBonifFCI = nBonifFCI * 0.50;
                    nBonifFCI_T1 = nBonifFCI_T1 * 0.50;
                    nBonifFCI_T2 = nBonifFCI_T2 * 0.50;
               |FINSI;
               |SI #labtraba#234 ] 20; |Y #labtraba#234 < 30;
                    nBonifFCI = nBonifFCI * 0.75;
                    nBonifFCI_T1 = nBonifFCI_T1 * 0.75;
                    nBonifFCI_T2 = nBonifFCI_T2 * 0.75;
               |FINSI;
               |SI #labtraba#234 ] 30;
                    nBonifFCI = nBonifFCI * 1;
                    nBonifFCI_T1 = nBonifFCI_T1 * 1;
                    nBonifFCI_T2 = nBonifFCI_T2 * 1;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
               nNume = 0;
               |SI #nombotra#2 = 161; |O #nombotra#2 = 164;
               |O #nombotra#2 = 169; |O #nombotra#2 = 170;
               |O #nombotra#2 = 119; |O #nombotra#2 = 120;
                    nNume = tp;
               |SINO;
                    |SI #nombotra#2 = 199;
                         |SI 0.50 [ tp; |Y tp < 0.75;
                              nNume = 0.50;
                         |FINSI;
                         |SI 0.75 [ tp;
                              nNume = 0.75;
                         |FINSI;
                    |SINO;
                         nNume = tp + 0.3;
                    |FINSI;
               |FINSI;
               |SI nNume > 1;
                    nNume = 1;
               |SINO;
                    nNume = nNume ! 3;
               |FINSI;
               nBonifFCI = nBonifFCI * nNume;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO parche_aju_IT;
     || esto es lo que cobrare al final, la variable stop mas prestaciones
     || y complementos

     || modificacion 22/06/2015, solo lo hago si tengo puesto Incluso IT SI
     || tiquet 002884.02971
     |SI #labtraba#182 ! "S";
          |ACABA;
     |FINSI;

     swParcheAjuIT = 0;
     nume1 = stop + acum_53 + acum_54 + denfe_3 + denfe_4 + dacci_3;
     |SI nume1 > nAjuste;     || si resulta que entre todo cobro mas de lo
                              || que realmente tengo que ajustar
          nume1 = nume1 - nAjuste;      || nume1 es la diferencia

          stop = stop - nume1;          || la diferencia la quitare del ajuste
          swParcheAjuIT = 1;
     |FINSI;
     |SI swDiosMio = -1; |Y nTotalPrecioVar ! 0; |Y #2#97 = 2;
          stop = stop - nTotalPrecioVar;
     |FINSI;
|FPRC;

|PROCESO BaseMesAntIT;
     nBaseMesAntIT = 0;
     aFecha = #labtraba#125;
     aAlfa = aFecha % 402;
     nMes = aAlfa;
     aAlfa = aFecha % -104;
     nAny = aAlfa;
     nAny = nAny - 2000;

     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nAny;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          nBaseMesAntIT = #nomhicca#36;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

/****************************************************************************/
/*       PROCESO PARA INICIAR LAS INCIDENCIAS EN EL IRPF DEL TRABAJADOR     */
/****************************************************************************/

|PROCESO nomgirli;
     |BORRA 020#nomgirli.a;
     |LIBERA 020#nomgirli;
|FPRC;

|DEFBUCLE nomgirli;
     #nomgirli#2;
     ;
     #labtraba#0, #labtraba#1, nElAny, nElMes;
     #labtraba#0, #labtraba#1, nElAny, nElMes;
     ;
     NULL, nomgirli;
|FIN;

|PROCESO IniciaInc;
     |DBASS aBase;
     |QBF aBase;
     aMenu = aBase + "laboral/laboral.men";
     aArchivo = aMenu;

     |XABRE "U", aArchivo, nCanal;
     |SI FSalida ] 0;
          |XLEE nCanal, 100, aLinea;
     |FINSI;
     |XCIERRA nCanal;

     aLinea = aLinea - "#:PI Nominas y S.Social ";
     aVersion = aLinea;

     |BUCLE nomgirli;
|FPRC;

/****************************************************************************/
/****** PROCESOS PARA MULTIPLICAR LOS DIAS DE ERE POR 1.25 SI PROCEDE *******/
/****************************************************************************/

|PROCESO carga_def_501_basica;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "basica/def/" + aDef + ".mas";
     aFich = aBase + "basica/fich/";

     |CARGA_DEF aMas, copiade1@;
     |PATH_DAT #copiade1@#aFich#;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO carga_def_501;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/" + aDef + ".mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiade1@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO carga_def_500;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/" + aDef + ".mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO AjusteDes;
     |SI dalta_3 = 1; |Y dbaja_3 = topemes; |Y #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y swAjusteDD = 0;
          |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5; |O nElMes = 7;
          |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
               |SI nElMes = 2;
                    nDias = nDias + 2 - bisiesto;
                    swAjusteDD = 2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MaxDiasAlta;
     nMaxDiasAlta = 0;

     alfa1 = "01";
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech1 = alfa4;      || PRIMER DIA DEL MES

     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     topemes = nTopemes;

     alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;
     fech2 = alfa4;      || ULTIMO DIA DEL MES

     alfa1 = #labtraba#36;
     fech3 = alfa1;      || DIA ALTA TRABAJADOR

     alfa1 = #labtraba#37;
     |QBF alfa1;
     |SI alfa1 ! ""; |Y alfa1 ! "..........";
          fech4 = alfa1;      || DIA BAJA TRABAJADOR
     |SINO;
          fech4 = fech2;
     |FINSI;

     |SI fech3 ] fech1;
          fech5 = fech3;
     |SINO;
          fech5 = fech1;
     |FINSI;

     |SI fech4 [ fech2;
          fech6 = fech4;
     |SINO;
          fech6 = fech2;
     |FINSI;

     nume1 = fech5;
     nume2 = fech6;

     nMaxDiasAlta = nume2 - nume1 + 1;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          |SI nMaxDiasAlta = 31;
               nMaxDiasAlta = 30;
          |FINSI;
          |SI nMes = 2;
               |SI nMaxDiasAlta = 28; |O nMaxDiasAlta = 29;
                    nMaxDiasAlta = 30;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DiasLab;
     |PARA nDia = nDesde; |SI nDia [ nHasta; |HACIENDO nDia = nDia + 1;
          nPuntero = (nDia * 100) + 1;
          aAlfa = meslabo % nPuntero;
          |SI aAlfa = "0";
               nDiasLab = nDiasLab + 1;
          |SINO;
               nDiasFes = nDiasFes + 1;
          |FINSI;
     |SIGUE;
|FPRC;

|| comentar proceso:
|PROCESO CuentaDiasERECoef;
     || recibo nDesde, nHasta y nProp
     nDias = nHasta - nDesde + 1;

     |SI nDias ] dia_2;       || si los dias de ERE son los mismos que los
          nTotalDias = dia_2; || dias del mes o mas, entonces estoy todo
                              || el mes en ERE, no calculo nada mas
          || si ademas hay ajuste por ser por ejemplo febrero, ya se sabe:
          nTotalDias = nTotalDias + swAjusteD;

     |FINSI;

     nAcumDias = 0;
     nAcumDiasSueltos = 0;
     nDiasLab = 0;
     nDiasFes = 0;
     || comprobar si TODOS son laborables
     |HAZ DiasLab;

     |SI nDiasLab [ 4;
          nDias = nDiasLab;
          nAcumDiasSueltos = nDias;
     |SINO;
          nVeces = nDias / 7;
          nResto = nDias $ 7;
          nVeces = (nVeces - (0.49)) ! 0;
          nAcumDias = (nVeces * 7);

          nDesde = nDesde + nAcumDias;
          nDiasLab = 0;
          nDiasFes = 0;
          |HAZ DiasLab;
          nAcumDiasSueltos = nDiasLab;
     |FINSI;

     nTotalDias = nTotalDias + nAcumDias;
     nTotalDiasSueltos = nTotalDiasSueltos + nAcumDiasSueltos;
|FPRC;

|PROCESO BuscaMasDe4;
     |SI #500#5 = 0; |Y #500#6 = 0;
          |ACABA;
     |FINSI;

     nDesde = #500#5;
     nHasta = #500#6;
     nProp = #500#11;

     |HAZ CuentaDiasERECoef;
|FPRC;

|DEFBUCLE BuscaMasDe4;
     #500#1006;
     ;
     #labtraba#0, #labtraba#1, nElMes, 0, nAnyBusca, 00;
     #labtraba#0, #labtraba#1, nElMes, 0, nAnyBusca, 31;
     ;
     NULL, BuscaMasDe4;
|FIN;

|PROCESO MasDe4;
     aDef = "nomvarcb";

     |HAZ carga_def_500;

     nAnyBusca = 0000;
     |BUCLE BuscaMasDe4;
     nAnyBusca = nElAny;
     |BUCLE BuscaMasDe4;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO DiasERECoef;
     nDiasDesCoef = 0;
     ddese_3 = 0;
     nTotalDias = 0;
     nTotalDiasSueltos = 0;

     |PARA nume1 = 12; |SI nume1 [ 15; |HACIENDO nume1 = nume1 + 1;
          nume2 = nume1 - 8;    || desde
          nume3 = nume1 - 4;    || hasta
          nume4 = nume1 + 35;   || Prop. TP.
          |SI #nomvarca#nume1# = "D";
               nDesde = #nomvarca#nume2#;
               nHasta = #nomvarca#nume3#;
               nProp = #nomvarca#nume4#;
               |HAZ CuentaDiasERECoef;
          |FINSI;
     |SIGUE;

     |HAZ MasDe4;

     |HAZ MaxDiasAlta;

     || descomentar linea:
     || nDiasDesCoef = nDiasDesCoef + nAcumDias;

     || comentar linea:
     nDiasDesCoef = nTotalDias + ((nTotalDiasSueltos * 1.25) ! 0);

     |SI nDiasDesCoef > nMaxDiasAlta;
          nDiasDesCoef = nMaxDiasAlta;
     |FINSI;
|FPRC;

/****************************************************************************/
/*PROCESOS PARA AJUSTAR DIAS DE IT EN MENSUALES EN MESES DE 31, 28 O 28 DIAS*/
/****************************************************************************/

|PROCESO AjusteAcc3_REV;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M"; |ACABA; |FINSI;
     |SI swAjuste3 = 0; |Y swAjuste3_2 ! 0; |Y swaju_acc = 1;
          |SI dacci_24 ! 0; dacci_24 = dacci_24 + swAjuste3_2; |ACABA; |FINSI;
          |SI dacci_23 ! 0; dacci_23 = dacci_23 + swAjuste3_2; |ACABA; |FINSI;
          |SI dacci_22 ! 0; dacci_22 = dacci_22 + swAjuste3_2; |ACABA; |FINSI;
          |SI dacci_21 ! 0; dacci_21 = dacci_21 + swAjuste3_2; |ACABA; |FINSI;
     |FINSI;
|FPRC;

|PROCESO AjusteEnf3_REV;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M"; |ACABA; |FINSI;
     |SI swAjuste3 ! 0; |Y dmate_2 = 0;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 + swAjuste3; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 + swAjuste3; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 + swAjuste3; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 + swAjuste3; |ACABA; |FINSI;
     |FINSI;
     |SI swAjuste3 = 0; |Y swAjuste3_C ! 0;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 + swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 + swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 + swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 + swAjuste3_C; |ACABA; |FINSI;
     |FINSI;
     |SI swAjuste3 = 0; |Y swAjuste3_2 ! 0; |Y swaju_enf = 1;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 + swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 + swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 + swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 + swAjuste3_2; |ACABA; |FINSI;
     |FINSI;
|FPRC;

|PROCESO AjusteEnf3_Pres;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M"; |ACABA; |FINSI;
     |SI swAjuste3 ! 0;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 - swAjuste3; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 - swAjuste3; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 - swAjuste3; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 - swAjuste3; |ACABA; |FINSI;
     |FINSI;
     |SI swAjuste3 = 0; |Y swAjuste3_C ! 0;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 - swAjuste3_C; |ACABA; |FINSI;
     |FINSI;
     |SI swAjuste3 = 0; |Y swAjuste3_2 ! 0; |Y swaju_enf = 1;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 - swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 - swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 - swAjuste3_2; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 - swAjuste3_2; |ACABA; |FINSI;
     |FINSI;
|FPRC;

|PROCESO AjusteEnf3_Comp;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M"; |ACABA; |FINSI;
     |SI swAjuste3_C ! 0;
          |SI denfe_24 ! 0; denfe_24 = denfe_24 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_23 ! 0; denfe_23 = denfe_23 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_22 ! 0; denfe_22 = denfe_22 - swAjuste3_C; |ACABA; |FINSI;
          |SI denfe_21 ! 0; denfe_21 = denfe_21 - swAjuste3_C; |ACABA; |FINSI;
     |FINSI;
|FPRC;

|PROCESO AjuCompFeb;
     || estoy en marzo, traigo arrastre de enfermedad de febrero, ajuste
     || automatico, y soy mensual

     swAjuCompFeb = 0;

     |SI #0#8 = 3; |Y #2#89 ! 0; |Y #2#60 = "E"; |Y #nomcontr#17 = 3;
     |Y #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          nNume1 = nElAny $ 4;
          |SI nNume1 ! 0;
               swAjuCompFeb = 2;
          |SINO;
               swAjuCompFeb = 1;        || bisiesto !!!
          |FINSI;
          |SI nArrAnyAnt = denfe_0;
               nArrAnyAnt = nArrAnyAnt + swAjuCompFeb;
          |FINSI;
          denfe_0 = denfe_0 + swAjuCompFeb;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************** BONIFICACIONES DE FOMENTO DE EMPLEO ***********************/
/****************************************************************************/

|PROCESO CompCambioImp;
     #nomboni3#0 = #nombotra#2;
     |LEE 000#nomboni3.=;
     |SI FSalida = 0;
          |SI swAgosto2012 = 1;
               |SI #nomboni3#5 = #nomboni3#6; |Y #nomboni3#6 > #nomboni3#7;
                    nNume1 = #nomboni3#7 + (#nomboni3#7 % 5);
                    nDiferencia = #nomboni3#5 - nNume1;
                    |SI -1 [ nDiferencia; |Y nDiferencia [ 1;
                         #nomboni3#5 = #nomboni3#7;
                         #nomboni3#6 = #nomboni3#7;
                         nBonifFCI = #nomboni3#7;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #nomboni3#5 ! #nomboni3#6; |O #nomboni3#6 ! #nomboni3#7;
               fIniBon = #nombotra#4;
               aIniBon = fIniBon;
               alfa1 = aIniBon % -104;
               nume1 = alfa1;
               nume1 = nume1 + 1;
               alfa1 = nume1;
               alfa1 = (aIniBon % 106) + alfa1;
               fAny1Bon = alfa1;

               alfa1 = aIniBon % -104;
               nume1 = alfa1;
               nume1 = nume1 + 2;
               alfa1 = nume1;
               alfa1 = (aIniBon % 106) + alfa1;
               fAny2Bon = alfa1;

               nBonifFCI_T1 = 0;
               swCambioBon = 1;    || por defecto estyo en el 1er a¤o
               nDiasBon_1 = 0;

               |SI fFechaCal < fAny1Bon;
                    swCambioBon = 1;    || se confirma: estoy en el 1er a¤o
                    #nombotra#6 = #nomboni3#2;
                    #nombotra#7 = #nomboni3#5;
                    nBonifFCI = #nomboni3#5;
                    |GRABA 020#nombotra.a;
               |FINSI;

              |SI fFechaCal ] fAny1Bon; |Y fFechaCal < fAny2Bon;
                    swCambioBon = 2;    || estoy en "a partir del 2do a¤o"
                    alfa1 = fAny1Bon;
                    alfa2 = alfa1 % 402;
                    alfa3 = alfa1 % -104;
                    nume2 = alfa2;
                    nume3 = alfa3;
                    |SI nElMes = nume2; |Y nElAny = nume3;
                         || estoy en el mes de cambio del 1ro al 2do a¤o
                         |SI #nomboni3#5 = #nomboni3#6;     || no proporciones nada
                              |ACABA;             || si el importe de un a¤o
                         |FINSI;                  || y el otro es el mismo
                         swCambioBon = 12;
                         alfa1 = alfa1 % 102;
                         nDiasBon_1 = alfa1; || a partir de este dia con la cantidad 2
                         nBonifFCI_T1 = #nomboni3#5;
                         nBonifFCI_T2 = #nomboni3#6;
                    |SINO;
                         swCambioBon = 2;
                         nBonifFCI = #nomboni3#6;
                         #nombotra#6 = nBonifFCI * 12;
                         #nombotra#7 = nBonifFCI;
                         |GRABA 020#nombotra.a;
                    |FINSI;
               |FINSI;
               |SI fFechaCal ] fAny2Bon;
                    || estoy en "a partir del 2do a¤o"
                    swCambioBon = 3;
                    alfa1 = fAny2Bon;
                    alfa2 = alfa1 % 402;
                    alfa3 = alfa1 % -104;
                    nume2 = alfa2;
                    nume3 = alfa3;
                    |SI nElMes = nume2; |Y nElAny = nume3;
                         || estoy en el mes de cambio del 2do al 3er a¤o
                         |SI #nomboni3#6 = #nomboni3#7;     || no proporciones nada
                              |ACABA;             || si el importe de un a¤o
                         |FINSI;                  || y el otro es el mismo
                         swCambioBon = 23;
                         alfa1 = alfa1 % 102;
                         nDiasBon_1 = alfa1; || a partir de este dia con la cantidad 2
                         nBonifFCI_T1 = #nomboni3#6;
                         nBonifFCI_T2 = #nomboni3#7;
                    |SINO;
                         swCambioBon = 3;
                         nBonifFCI = #nomboni3#7;
                         #nombotra#6 = nBonifFCI * 12;
                         #nombotra#7 = nBonifFCI;
                         |GRABA 020#nombotra.a;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calboniFCI;
     nBonifFCI = 0;
     nBonifTex = 0;
     nBonifJuv = 0;

     |SI #labtraba#121 ! "S"; |Y #labtraba#121 ! "T";
          |ACABA;
     |FINSI;

     |ABRE #nomboni3;

     |SI swAgosto2012 = 1;
          #nomboni3#0 = #nombotra#2;
          |LEE 000#nomboni3.=;
          |SI FSalida = 0;
               |SI #nomboni3#11 = "N";
                    |CIERRA #nomboni3;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     || dia_2 son los dias naturales en alta del mes
     || topemes los dias que tiene el mes, como siempre
     fFechaIniBon = #nombotra#4;
     fFechaFinBon = #nombotra#5;

     || comprobaciones
     alfa1 = "01";
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     |SI fFechaIniBon [ fFecha;
          fFechaIniBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaIniBon = fFechaIniBon;
          |FINSI;
     |FINSI;

     anynum = nAny;
     mesnum = nMes;
     |HAZ ulti_dia;

     alfa1 = topemes; alfa1 = "00" + alfa1; alfa1 = alfa1 % -102;
     alfa2 = nElMes; alfa2 = "00" + alfa2; alfa2 = alfa2 % -102;
     alfa3 = nElAny;
     aFecha = alfa1 + "." + alfa2 + "." + alfa3;
     fFecha = aFecha;
     fFechaCal = fFecha;
     |SI fFechaFinBon ] fFecha;
          fFechaFinBon = fFecha;
     |SINO;
          nMes = alfa2;
          nAny = alfa3;
          |SI nMes = nElMes; |Y nAny = nElAny;
               fFechaFinBon = fFechaFinBon;
          |FINSI;
     |FINSI;
     aAlfa = #nomvarca#16;
     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          fFecha = aAlfa;
     |SINO;
          aAlfa = #labtraba#37;
          |SI aAlfa ! "          "; |Y aAlfa ! "..........";
               fFecha = aAlfa;
          |FINSI;
     |FINSI;

     |SI aAlfa ! "          "; |Y aAlfa ! "..........";
          |SI fFecha [ fFechaFinBon;
               fFechaFinBon = fFecha;
          |FINSI;
     |FINSI;

     fFechaAlta = #labtraba#36;         || esto para que si he copiado la
     |SI fFechaAlta ] fFechaIniBon;     || ficha del trabajador, la bonifica-
          fFechaIniBon = fFechaAlta;    || cion se aplique a partir de la fecha
     |FINSI;                            || de alta del trabajador, y no de la
                                             || de inicio de la bonif.
     nume1 = fFechaIniBon;
     nume2 = fFechaFinBon;
     nDiasBon = nume2 - nume1 + 1;

     |SI nElMes ! 4; |Y nElMes ! 6; |Y nElMes ! 9; |Y nElMes ! 11; || mes de 31 0 28 dias
     |Y #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";   || citricos no topea con dias cot
          |SI nDiasBon > hcoti_0;       || dias a bonificar > dias cotizables
               nDiasBon = hcoti_0;      || provocado por no estar de alta el
                                        || mes completo
               nDiasBon = nDiasBon + ddese_2; || sumo dias de ERE, que entran
               || que en estos casos no se tendrian en cuenta
          |FINSI;
          |SI #labtraba#42 = "M"; |Y #labtraba#64 = "D"; |Y dcoti_0 < hcoti_0;
          |Y nDiasBon > 0;
               nDiasBon = dcoti_0; || excepcion para M-D que no estan de alta
                                   || el mes completo
               nDiasBon = nDiasBon + ddese_2; || sumo dias de ERE, que entran
               || que en estos casos no se tendrian en cuenta
          |FINSI;
          |SI nDiasBon < hcoti_0; || dias a bonificar < dias cotizables
               |SI nElMes = 2; |Y nCuantos > 1;
                    |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
                         nDiasBon = hcoti_0;
                    |FINSI;
               |FINSI;
               |SI nElMes = 2;
                    |SI dalta_3 ! 1; |O dbaja_3 ! topemes;
                         nNume1 = dbaja_3 - dalta_3 + 1;
                         |SI nNume1 = nDiasBon;
                              |SI hcoti_0 > nDiasBon;
                                   nDiasBon = hcoti_0;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI runnom = "nomcalfi"; |Y #nombotra#2 = 111;
               nDiasBon = 0;
               || atencion, la bonificacion de sustitucion de maternidad no
               || la debemos aplicar cuando calculamos finiquito ya que los
               || dias que ya tenga el trabajador suspendido no hay que bo-
               || nificarlos en ESA bonificacion
          |FINSI;
     |FINSI;
     |SI nElMes = 4; |O nElMes = 6; |O nElMes = 9; |O nElMes = 11;
          || meses de 30 dias, les tiene que quitar el dia de
          || huelga y no lo esta haciendo, porque el proceso anterior solo
          || esta para meses de 31 o 28, quizas lo ideal seria que fuera
          || para todos, pero siendo para huelga que no es un caso muy comun
          || de momento lo dejo aqui

          nDiasBon = nDiasBon - dhuel_2;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";   || citricos
          || nDiasBon = fijo_1 + denfe_2 + dmate_2 + dacci_2;
          || nDiasBon = nDiasBon + ddese_2; || sumo dias de ERE, que entran
          || que en estos casos no se tendrian en cuenta
     |FINSI;
     |SI nDiasBon [ 0;        || si por lo que sea me llegan negativos, cero
          nDiasBon = 0;
     |FINSI;
     |SI nDiasBon ] 30;       || si estoy en un mes de 31 dias y bonificado
          nDiasBon = 30;      || todo el mes, 30 ya que luego divido siempre
     |FINSI;                  || por 30
     |SI nDiasBon ] 28; |Y nElMes = 2;
          nDiasBon = 30;      || si estoy en febrero y bonificado todo el mes,
     |FINSI;                  || 30 porque divido por 30


     || asigno valor
     nBonifFCI = #nombotra#7;

     || compruebo importe para las del textil que cambian importes segun
     || el tiempo que lleven de alta

     nBonifFCI_T1 = 0;
     nBonifFCI_T2 = 0;
     swCambioBon = 0;    || por defecto estyo en el 1er a¤o

     |SI nDiasBon ! 0;
          |HAZ CompCambioImp;
          |HAZ PFETP;         || recorto si hay tiempo parcial
     |FINSI;

     || siempre asi, nDiasBon no puede ser > 30

     |SI nDiasBon < 30; |O swCambioBon ] 12;
          |SI swCambioBon [ 3;
               nBonifFCI = ((nBonifFCI / 30) ! 2) * nDiasBon ;
          |SINO;
               |SI nDiasBon_1 = 1; |Y nDiasBon = 30;
                    || si da la casualidad de que es el mes de cambio de tramo
                    || de importe de bonificacion y ademas cambia desde el dia 1
                    || no es necesario proporcionar, ya que se provocaria una diferencia
                    || innecesaria
                    nBonifFCI = nBonifFCI;
                    |SI swCambioBon = 12; |O swCambioBon = 23;
                         nBonifFCI = nBonifFCI_T2;
                    |FINSI;
               |SINO;
                    nBonifFCI = ((nBonifFCI_T1 / 30) ! 2) * (nDiasBon_1 - 1);
                    nBonifFCI = nBonifFCI + (((nBonifFCI_T2 / 30) ! 2) * (nDiasBon - nDiasBon_1 + 1));
               |FINSI;
          |FINSI;
     |FINSI;

     aIndTex = "";

     |SI nBonifFCI > 0; |Y #nombotra#2 ] 302; |Y #nombotra#2 [ 999;
          nBonifTex = nBonifTex + nBonifFCI;
          |SI #nombotra#2 ] 304;
               |SI swCambioBon = 1; aIndTex = "1"; |FINSI;
               |SI swCambioBon = 12; |O swCambioBon = 2; aIndTex = "2"; |FINSI;
               |SI swCambioBon = 23; |O swCambioBon = 3; aIndTex = "R"; |FINSI;
          |FINSI;
          nBonifFCI = 0;
     |FINSI;
     |CIERRA #nomboni3;

     |SI nBonifFCI > 0;
          |SI #nombotra#2 = 161; |O #nombotra#2 = 164;
               |SI swCambioBon = 1; aIndTex = "1"; |FINSI;
               |SI swCambioBon = 12; |O swCambioBon = 2; aIndTex = "2"; |FINSI;
               |SI swCambioBon = 23; |O swCambioBon = 3; aIndTex = "R"; |FINSI;
          |FINSI;
          |SI #nombotra#2 = 141; |O #nombotra#2 = 142;
               |SI swCambioBon = 1; aIndTex = "1"; |FINSI;
               |SI swCambioBon > 1; aIndTex = "R"; |FINSI;
          |FINSI;
     |FINSI;

     |SI nBonifFCI ! 0; |Y #nombotra#2 ! 199;
          |SI nBonifFCI1 = 0;
               nBonifFCI1 = nBonifFCI;
               nCodBonFom1 = #nombotra#2;
          |SINO;
               |SI nBonifFCI2 = 0;
                    nBonifFCI2 = nBonifFCI;
                    nCodBonFom2 = #nombotra#2;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nBonifTex ! 0;
          |SI nBonifTex1 = 0;
               nBonifTex1 = nBonifTex;
               nCodBonTex1 = #nombotra#2;
          |SINO;
               |SI nBonifTex2 = 0;
                    nBonifTex2 = nBonifTex;
                    nCodBonTex2 = #nombotra#2;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nBonifFCI ! 0;
          |SI #nombotra#2 = 199;
               nBonifJuv = nBonifFCI;
               nDiasBonifJuv = nDiasBon;
               nBonifFCI = 0;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE calboniFCI;
     #nombotra#1;
     ;
     #labtraba#0, #labtraba#1, 001;
     #labtraba#0, #labtraba#1, 999;
     ;
     NULL, calboniFCI;
|FIN;

|PROCESO calboniFomEmp;
     nBonifFCI1 = 0;
     nBonifFCI2 = 0;
     nCodBonFom1 = 0;
     nCodBonFom2 = 0;
     nCodBonTex1 = 0;
     nCodBonTex2 = 0;
     |BUCLE calboniFCI;
|FPRC;

|PROCESO BuscaPrimEnf;
     || si entro es que tengo enfermedad este mes
     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          nCampoD = nCampo - 8;
          nCampoH = nCampo - 4;
          aAlfa = #nomhicca#nCampo#;
          nNume1 = #nomcalca#nCampoD#;
          nNume2 = #nomcalca#nCampoH#;
          |SI aAlfa = "E";                   || busco la linea de enfermedad
               |SI #nomhicca#nCampoD# ! 0;   || si ha empezado este mes
                    aAlfa1 = #nomhicca#nCampoD#; aAlfa1 = ("00" + aAlfa1 ) % -102;
                    aAlfa2 = #nomhicca#2; aAlfa2 = ("00" + aAlfa2 ) % -102;
                    nNume3 = #nomhicca#66 + 2000;
                    aAlfa3 = nNume3;
                    aFechaIT = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
                    |SI aFechaIT ! #labtraba#125;
                         swPrimera = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI swPrimera = 0;
               |SAL;
          |FINSI;
     |SIGUE;
     |SI swPrimera = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaPrimEnf;
     #nomhicca#1;
     31;
     #labtraba#0, #labtraba#1, nAny, nDesdeMes, 0,  1;
     #labtraba#0, #labtraba#1, nAny, nHastaMes, 0, 31;
     ;
     NULL, BuscaPrimEnf;
|FIN;

|PROCESO PrimEnfPorNif;
     |BUCLE BuscaPrimEnf;
     |SI swPrimera = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE PrimEnfPorNif;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, PrimEnfPorNif;
|FIN;

|PROCESO BuscaPE;
     nDesdeMes = 1;
     nHastaMes = nElMes - 1;
     nAny = nElAny - 2000;
     aNif = #labtraba#7;
     |SALVA_FICHA #labtraba;
     |BUCLE PrimEnfPorNif;
     |REPON_FICHA #labtraba;
     |SI swPrimera = 1;
          nCampo = para1 + 3;
          |SI #labtraba#89 ! 0; |O #labtraba#92 ! 0; || vengo del mes anterior
               |SI #nomvarca#nCampo# = 0;
                    aAlfa = #labtraba#125;
                    aAlfa = aAlfa % -104;
                    nNume = aAlfa;
                    |SI nNume ! nElAny;
                         || vengo del a¤o anterior, voy a comprobar si fue la
                         || primera del a¤o anterior

                         nAny = nNume - 2000;
                         aAlfa = #labtraba#125;
                         aAlfa = aAlfa % 402;
                         nDesdeMes = 01;
                         nHastaMes = aAlfa;
                         nHastaMes = nHastaMes - 1;
                         |SALVA_FICHA #labtraba;
                         |BUCLE PrimEnfPorNif;
                         |REPON_FICHA #labtraba;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

/************ MAS PROCESOS QUE EN LA NOMINA NO ME CABEN *********************/
/************ ESTO ES LO DE BUSCAR LOS DIAS DE FIESTA DE CONVENIO ***********/

|PROCESO nomfiest;
     aFiestaAct = #501#2;
     |QBF aFiestaAct;
     alfa1 = aFiestaAct % -102;
     nume1 = alfa1;
     |SI nume1 ! nElMes;
          |ACABA;
     |FINSI;
     |SI aFiestaAct ! "";
          alfa1 = aFiestaAct % 102;
          |SI nDiaAct1 = 0;
               nDiaAct1 = alfa1;    || el dia de fiesta de la actividad
               nTFAct = nTFAct + 1;
          |SINO;
               |SI nDiaAct2 = 0;
                    nDiaAct2 = alfa1;    || el dia de fiesta de la actividad
                    nTFAct = nTFAct + 1;
               |SINO;
                    |SI nDiaAct3 = 0;
                         nDiaAct3 = alfa1;    || el dia de fiesta de la actividad
                         nTFAct = nTFAct + 1;
                    |SINO;
                         |SI nDiaAct4 = 0;
                              nDiaAct4 = alfa1;
                              nTFAct = nTFAct + 1;
                         |SINO;
                              |SI nDiaAct5 = 0;
                                   nDiaAct5 = alfa1;
                                   nTFAct = nTFAct + 1;
                              |SINO;
                                   |SI nDiaAct6 = 0;
                                        nDiaAct6 = alfa1;
                                        nTFAct = nTFAct + 1;
                                   |SINO;
                                        |SI nDiaAct7 = 0;
                                             nDiaAct7 = alfa1;
                                             nTFAct = nTFAct + 1;
                                        |SINO;
                                             |SI nDiaAct8 = 0;
                                                  nDiaAct8 = alfa1;
                                                  nTFAct = nTFAct + 1;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomfiest;
     #501#1003;
     ;
     #labtraba#87, any, "     ";
     #labtraba#87, any, "zzzzz";
     ;
     NULL, nomfiest;
|FIN;

|PROCESO FiestaAct;
          aFiestaAct = "";
          nTFAct = 0;    || total dias de fiesta por Actividad en el mes
          nDiaAct1 = 0;
          nDiaAct2 = 0;
          nDiaAct3 = 0;
          nDiaAct4 = 0;
          nDiaAct5 = 0;
          nDiaAct6 = 0;
          nDiaAct7 = 0;
          nDiaAct8 = 0;
          any = nElAny;

          aDef = "nomconfi";
          |HAZ carga_def_501;
          |BUCLE nomfiest;
          |DESCARGA_DEF #copiade1@;
|FPRC;

|PROCESO VerificaDatosIRPF;
     |SI #labtraba#247 = 138;
          |ACABA;
     |FINSI;
     |SI #labtraba#29 = 0;
          |ACABA;
     |FINSI;
     |SI aParam ! "NOMSICOS";
          aDef = "nomir003";
          |HAZ carga_def_500;
          aDef = "agidanif";
          |HAZ carga_def_501_basica;

          |ABRE #500;
          #500#0 = #labtraba#7;
          #500#40 = nElAny;
          #500#41 = #labtraba#0;
          |LEE 000#500=;
          |SI FSalida ! 0;
               |ABRE #501;
               #501#0 = #labtraba#7;
               #501#1 = 01;
               |LEE 000#501=;
               |SI FSalida ! 0;
                    || no hay datos en el agidanif, por lo que al regularizar
                    || no va a poder crear la ficha en los datos de IRPF del
                    || nomir003, ahora si que doy aviso

                    nIncid = 10;
                    |HAZ graba_inc;

                    || encima por no tener, no tiene ni fecha de nacimiento
                    || en la ficha del trabajador

                    aAlfa = #labtraba#11;
                    |QBF aAlfa;
                    |SI aAlfa = ""; |O aAlfa = "..........";
                         nIncid = 60;
                         |HAZ graba_inc;
                         nIncid = 61;
                         |HAZ graba_inc;
                    |FINSI;
               |FINSI;
               |CIERRA #501;
          |SINO;
               |SI #500#122 = "1";
                    || los datos se han creado por defecto, hasta que no entren
                    || a modificar el agidanif no se pondra el indicador a cero
                    nIncid = 10;
                    |HAZ graba_inc;
               |FINSI;

               |SI #500#3 ! "1"; |Y #500#3 ! "2"; |Y #500#3 ! "3";
                    #500#3 = "3";       || situacion familiar a cero o en
                    |GRABA 020#500.a;   || blanco
                    |LIBERA #500;

                    |ABRE #501;
                    #501#0 = #labtraba#7;
                    #501#1 = 01;
                    |LEE 101#501=;
                    |SI FSalida = 0;
                         #501#15 = 3;
                         |GRABA 020#501a;
                         |LIBERA #501;
                    |FINSI;
                    |CIERRA #501;

                    nIncid = 15;        || si la situacion familiar es cero
                    |HAZ graba_inc;     || que compruebe datos
                    nIncid = 16;        || paso automaticamente a "3"
                    |HAZ graba_inc;     || y aviso
               |FINSI;
               aAlfa = #500#4; |QBF aAlfa;
               |SI #500#3 = "2"; |Y aAlfa = "";       || situacion familiar 2
                    #500#3 = "3";       || sin NIF del conyuge
                    |GRABA 020#500.a;
                    |LIBERA #500;

                    |ABRE #501;
                    #501#0 = #labtraba#7;
                    #501#1 = 01;
                    |LEE 101#501=;
                    |SI FSalida = 0;
                         #501#15 = 3;
                         |GRABA 020#501a;
                         |LIBERA #501;
                    |FINSI;
                    |CIERRA #501;

                    nIncid = 34;
                    |HAZ graba_inc;
                    nIncid = 35;
                    |HAZ graba_inc;
               |FINSI;
               |SI #500#1 = 0; |O #500#1 > 85;
                    nIncid = 60;
                    |HAZ graba_inc;
                    nIncid = 61;
                    |HAZ graba_inc;
               |FINSI;
               swHijos = 0;
               |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
                    nEdad = nElAny - #500nPara1;
                    |SI #500nPara1 ! 0;
                         nPara2 = nPara1 + 10;    || grado minusvalia

                         || solo tienen reduccion menores de 25 a¤os o mayores c/minusv.
                         |SI nEdad < 25;
                         |O #500nPara2 = "1"; |O #500nPara2 = "2";
                             swHijos = 1;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |SI #500#3 = 1; |Y swHijos = 0;
                    #500#3 = "3";       || sin NIF del conyuge
                    |GRABA 020#500.a;
                    |LIBERA #500;

                    |ABRE #501;
                    #501#0 = #labtraba#7;
                    #501#1 = 01;
                    |LEE 101#501=;
                    |SI FSalida = 0;
                         #501#15 = 3;
                         |GRABA 020#501a;
                         |LIBERA #501;
                    |FINSI;
                    |CIERRA #501;

                    nIncid = 36;
                    |HAZ graba_inc;
                    nIncid = 37;
                    |HAZ graba_inc;
               |FINSI;

               |SI #500#5 = 0;
                    #500#5 = #labtraba#111;
                    #500#121 = #labtraba#130;
                    |GRABA 020#500.a;
                    |LIBERA #500;
               |FINSI;
          |FINSI;

          |CIERRA #500;
          |DESCARGA_DEF #copiade1@;
          |DESCARGA_DEF #copiadef@;
     |FINSI;

     nNume = #labtraba#45;
     |SI nNume ] 001; |Y nNume [ 399; |Y #labtraba#111 ! 1;
          nIncid = 51;
          |HAZ graba_inc;
          nIncid = 52;
          |HAZ graba_inc;
     |FINSI;
|FPRC;

|PROCESO VerificaAutonomo;
     |SI aParam ! "NOMSICOS";
          swGastosACero = 0;

          aDef = "nomir003";
          |HAZ carga_def_500;

          aDef = "nomauto2";
          |HAZ carga_def_501;

          |ABRE #500;
          #500#0 = #labtraba#7;
          #500#40 = nElAny;
          #500#41 = #labtraba#0;
          |LEE 000#500=;
          |SI FSalida = 0;
               |SI #500#11 = 0;
                    swGastosACero = 1;
               |SINO;
                    swGastosACero = 0;
               |FINSI;
          |FINSI;
          |CIERRA #500;

          |SI swGastosACero = 1;
               |ABRE #501;           || para buscar si es autonomo
               #501#0 = #labtraba#0;
               #501#1 = #labtraba#1;
               #501#2 = nElAny;
               |LEE 000#501=;
               |SI FSalida = 0;
                    |SI #501#32 = 0;
                         swGastosACero = 1;
                    |SINO;
                         swGastosACero = 0;
                    |FINSI;
               |FINSI;
               |CIERRA #501;
          |FINSI;
          |DESCARGA_DEF #copiade1@;
          |DESCARGA_DEF #copiadef@;

          |SI swGastosACero = 1;
               nIncid = 44;
               |HAZ graba_inc;
               nIncid = 45;
               |HAZ graba_inc;
          |FINSI;

          |SI nElAny ] 2013;
               aAlfa = #labtraba#37;
               |SI #nomvarca#16 ! ".........."; |Y #nomvarca#16 ! "          ";
                    aAlfa = #nomvarca#16;
               |FINSI;
               |SI aAlfa ! "..........";|Y aAlfa ! "          ";
                    aAlfa1 = aAlfa % 402; nNume1 = aAlfa1;
                    aAlfa2 = aAlfa % -104; nNume2 = aAlfa2;
                    |SI nNume1 = nElMes; |Y nNume2 = nElAny; |Y nElMes ! 12;
                         || si es baja este mes
                         nIncid = 48; |HAZ graba_inc;
                         nIncid = 49; |HAZ graba_inc;
                         nIncid = 50; |HAZ graba_inc;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CompBases;
     || este proceso lo ponemos para comprobar que las bases grabadas de
     || IRPF con coherentes (por el tema que ocurrio en diciembre de 2010)
     || si no lo es dare un aviso para que nos avisen

     nBaseReal = #nomcalca#14 +  #nomcalca#69 +  #nomcalca#70;
     nBaseReal = nBaseReal ! 2;
     nBaseGrabada = #nomcalca#74;
     nBaseGrabada = nBaseGrabada ! 2;
     nDiferencia = nBaseReal - nBaseGrabada;
     aAlfa = nDiferencia;
     |QBF aAlfa;
     |SI aAlfa = "-0";
          nDiferencia = 0;
     |FINSI;

     |SI nDiferencia ! 0;
          alfa2 = #2#0; alfa2 = "00000" + alfa2; alfa2 = alfa2 % -105;
          alfa3 = #2#1; alfa3 = "00000" + alfa3; alfa3 = alfa3 % -105;

          aAlfa = "    ATENCION. Se han detectado diferencias en las bases ";
          aAlfa = aAlfa + "de IRPF en el trabajador ";
          aAlfa = aAlfa + alfa2 + "." + alfa3;
          |MENAV aAlfa;
          aAlfa = "    Para evitar errores en el cálculo de IRPF, por ";
          aAlfa = aAlfa + "favor contacte con el departamento de atención al cliente";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

     nDesdeDiaC = 0;
     nHastaDiaC = 0;
     aTipoC = "";
     nPorcentajeC = 0;

|PROCESO LineaComp;
     sw100por100 = 0;
     nDiasTramo = #nomconax#nCampoHasta# - #nomconax#nCampoDesde# + 1;

     |SI #nomconax#nCampoDesde# ] 1; |Y #nomconax#nCampoDesde# [ 3;
          |SI #nomconax#nCampoTipo# = "P"; |Y #nomconax#nCampoPorc# = 100;
               sw100por100 = 1;
          |FINSI;
     |FINSI;

     |SI #nomconax#nCampoDesde# ] 4; |Y #nomconax#nCampoDesde# [ 20;
          |SI #nomconax#nCampoTipo# = "P"; |Y #nomconax#nCampoPorc# = 40;
               sw100por100 = 1;
          |FINSI;
     |FINSI;

     |SI #nomconax#nCampoDesde# ] 21; |Y #nomconax#nCampoDesde# [ 999;
          |SI #nomconax#nCampoTipo# = "P"; |Y #nomconax#nCampoPorc# = 25;
               sw100por100 = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MasComplemento;
     || 1ra. linea 1ra. enfermedad
     nRestoDias = denfe_T + denfe_S + denfe_R;
     nCampoDesde = 2; nCampoHasta = 3; nCampoTipo = 5; nCampoPorc = 4;
     |HAZ LineaComp;
     |SI denfe_U [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_U > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 2da. linea 1ra. enfermedad
     nRestoDias = denfe_S + denfe_R;
     nCampoDesde = 114; nCampoHasta = 115; nCampoTipo = 117; nCampoPorc = 116;
     |HAZ LineaComp;
     |SI denfe_T [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_T > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 3ra. linea 1ra. enfermedad
     nRestoDias = denfe_R;
     nCampoDesde = 195; nCampoHasta = 196; nCampoTipo = 198; nCampoPorc = 197;
     |HAZ LineaComp;
     |SI denfe_S [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_S > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 4ta. linea 1ra. enfermedad
     nCampoDesde = 204; nCampoHasta = 205; nCampoTipo = 207; nCampoPorc = 206;
     |HAZ LineaComp;
     |SI denfe_R [ nDiasTramo; |Y denfe_R > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 1ra. linea 2da. enfermedad
     nRestoDias = denfe_X + denfe_W + denfe_V;
     nCampoDesde = 11; nCampoHasta = 15; nCampoTipo = 23; nCampoPorc = 19;
     |HAZ LineaComp;
     |SI denfe_Y [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_Y > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 2da. linea 2da. enfermedad
     nRestoDias = denfe_W + denfe_V;
     nCampoDesde = 12; nCampoHasta = 16; nCampoTipo = 24; nCampoPorc = 20;
     |HAZ LineaComp;
     |SI denfe_X [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_X > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 3ra. linea 2da. enfermedad
     nRestoDias = denfe_V;
     nCampoDesde = 13; nCampoHasta = 17; nCampoTipo = 25; nCampoPorc = 21;
     |HAZ LineaComp;
     |SI denfe_W [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_W > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 4ta. linea 2da. enfermedad
     nDiasTramo = #nomconax#18 - #nomconax#14 + 1;
     nCampoDesde = 14; nCampoHasta = 18; nCampoTipo = 26; nCampoPorc = 22;
     |HAZ LineaComp;
     |SI denfe_V [ nDiasTramo; |Y denfe_V > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || CON HOSPITALIZACION

     || 1ra. linea 1ra. enfermedad
     nRestoDias = denfe_T_H + denfe_S_H + denfe_R_H;
     nCampoDesde = 123; nCampoHasta = 124; nCampoTipo = 126; nCampoPorc = 125;
     |HAZ LineaComp;
     |SI denfe_U_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_U_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 2da. linea 1ra. enfermedad
     nRestoDias = denfe_S_H + denfe_R_H;
     nCampoDesde = 186; nCampoHasta = 187; nCampoTipo = 189; nCampoPorc = 188;
     |HAZ LineaComp;
     |SI denfe_T_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_T_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 3ra. linea 1ra. enfermedad
     nRestoDias = denfe_R_H;
     nCampoDesde = 213; nCampoHasta = 214; nCampoTipo = 216; nCampoPorc = 215;
     |HAZ LineaComp;
     |SI denfe_S_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_S_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 4ta. linea 1ra. enfermedad
     nCampoDesde = 222; nCampoHasta = 223; nCampoTipo = 225; nCampoPorc = 224;
     |HAZ LineaComp;
     |SI denfe_R_H [ nDiasTramo; |Y denfe_R_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 1ra. linea 2da. enfermedad
     nRestoDias = denfe_X_H + denfe_W_H + denfe_V_H;
     nCampoDesde = 132; nCampoHasta = 136; nCampoTipo = 144; nCampoPorc = 140;
     |HAZ LineaComp;
     |SI denfe_Y_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_Y_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 2da. linea 2da. enfermedad
     nRestoDias = denfe_W_H + denfe_V_H;
     nCampoDesde = 133; nCampoHasta = 137; nCampoTipo = 145; nCampoPorc = 141;
     |HAZ LineaComp;
     |SI denfe_X_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_X_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 3ra. linea 2da. enfermedad
     nRestoDias = denfe_V_H;
     nCampoDesde = 134; nCampoHasta = 138; nCampoTipo = 146; nCampoPorc = 142;
     |HAZ LineaComp;
     |SI denfe_W_H [ nDiasTramo; |Y nRestoDias = 0; |Y denfe_W_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;

     || 4ta. linea 2da. enfermedad
     nDiasTramo = #nomconax#139 - #nomconax#135 + 1;
     nCampoDesde = 135; nCampoHasta = 139; nCampoTipo = 147; nCampoPorc = 143;
     |HAZ LineaComp;
     |SI denfe_V_H [ nDiasTramo; |Y denfe_V_H > 0;
          |SI sw100por100 = 1;
               swSigue = 3;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO el_caso_raro;
     nDiasBonBaja = 0;
                                   || dias bonif distinto a dias cotiz
                                   || o acaba o empieza bonificacion este me
     alfa1 = #2#40 % 402;          || comprueba si este mes comienza bonif
     alfa2 = #2#40 % -104;
     nume1 = alfa1;      || mes inicio bonif
     nume2 = alfa2;      || a¤o inicio bonif
     |SI nume1 = nElMes; |Y nume2 = nElAny;
          alfa1 = #2#40 % 102;
          nAltaBonif = alfa1;
          nBajaBonif = dcoti_0;
     |FINSI;

     aAlfa = aFecBajaBon;
     alfa1 = aAlfa % 402;     || si este mes NO comienza bonif. es porque
     alfa2 = aAlfa % -104;    || acaba, si no no deberia haber entrado
     nume1 = alfa1;      || mes fin bonif
     nume2 = alfa2;      || a¤o fin bonif
     |SI nume1 = nElMes; |Y nume2 = nElAny;
          alfa1 = aAlfa % 102;
          nAltaBonif = 1;
          nBajaBonif = alfa1;
     |FINSI;

     |SI nAltaBonif = 0; |Y nBajaBonif = 0;
          |ACABA;        || no deberia haber entrado
     |FINSI;

     |PARA nDia = dalta_3; |SI nDia [ dbaja_3; |HACIENDO nDia = nDia + 1;
          |PARA nBaja = 12; |SI nBaja [ 16; |HACIENDO nBaja = nBaja + 1;
               |SI #nomvarca#nBaja# = "E"; |O #nomvarca#nBaja# = "A"; |O #nomvarca#nBaja# = "M";
               |O #nomvarca#nBaja# = "P"; |O #nomvarca#nBaja# = "R"; |O #nomvarca#nBaja# = "C";
               ||SI #nomvarca#nBaja# = "M";
                    nume1 = nBaja - 8;  || dia desde baja
                    nume2 = nBaja - 4;  || dia hasta baja

                    alfa2 = nElMes; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
                    alfa3 = nElAny;

                    alfa1 = nDia; |QBF alfa1; alfa1 = ("00" + alfa1) % -102;
                    alfa1 = alfa1 + "." + alfa2 + "." + alfa3;
                    fech1 = alfa1;

                    nInicioBaja = #nomvarca#nume1#;
                    |SI nInicioBaja = 0; nInicioBaja = 1; |FINSI;
                    alfa1 = nInicioBaja; |QBF alfa1; alfa1 = ("00" + alfa1) % -102;
                    alfa1 = alfa1 + "." + alfa2 + "." + alfa3;
                    fech2 = alfa1;

                    nFinBaja = #nomvarca#nume2#;
                    |SI nFinBaja = 0; nFinBaja = dbaja_3; |FINSI;
                    alfa1 = nFinBaja; |QBF alfa1; alfa1 = ("00" + alfa1) % -102;
                    alfa1 = alfa1 + "." + alfa2 + "." + alfa3;
                    fech3 = alfa1;

                    fech4 = #2#40;
                    alfa1 = aFecBajaBon;
                    |QBF alfa1;
                    alfa4 = nElAny;
                    alfa1 = alfa1 + "." + alfa4;
                    fech5 = alfa1;

                    |SI fech1 ] fech2; |Y fech1 [ fech3;
                         |SI fech1 ] fech4; |Y fech1 [ fech5;
                              nDiasBonBaja = nDiasBonBaja + 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |SIGUE;
|FPRC;

|PROCESO Log;
     |SI nPasoLog = 1;   || INICIO LOG
          aAlfa = "C:\Lognomina.txt";
          |XABRE "CBW", aAlfa, nCanal;
     |FINSI;
     |SI nPasoLog ! 1; |Y nPasoLog ! 99;
          aAlfa = #labtraba#1; aAlfa = aAlfa + " - ";
          aAlfa1 = nPasoLog;
          aAlfa = aAlfa + nPasoLog + &13 + &10;
          |XGRABA nCanal, aAlfa;
     |FINSI;
     |SI nPasoLog = 99;   || FIN LOG
          |XCIERRA nCanal;
     |FINSI;
|FPRC;

|PROCESO AcumAbs;
     |SI #nomcontr#47 = "C"; |Y dabse_2 ! 0; |Y nAcumAbs ! 0;
          graba04 = 431;
          graba07 = 0;
          graba08 = "ABSENTISMO";
          graba10 = (-1) * nAcumAbs;
          graba09 = 1;
          graba11 = 1;
          |HAZ grabacon;

          acum_10 = acum_10 - nAcumAbs;
          acum_11 = acum_11 - nAcumAbs;
     |FINSI;
|FPRC;

|PROCESO RetenPaga;
     swCalPaga = 0;
     reten_p = nIRPF1;

     aDef = "nomimpr1";
     |HAZ carga_def_500;

     |ABRE #500;         || busca si tengo guardada la retenc. de P.Extra
     #500#0 = #2#0;      || empresa
     #500#1 = #2#1;      || trabajador
     #500#2 = nElMes;    || mes
     #500#3 = 0;         || tipo
     #500#4 = nElAny;    || a¤o
     |LEE 000#500=;
     |SI FSalida = 0; |Y #0#12 = "N";
          swCalPaga = 0; || NO RECALCULES %
          reten_p = #500#7;   || % retencion IRPF Pagas
          reten_2 = #500#6;   || cuota retencion IRPF Pagas
     |SINO;
          swCalPaga = 1; || RECALCULA %
          reten_p = nIRPF1;
          reten_2 = 0;   || cuota retencion IRPF Pagas
     |FINSI;
     |CIERRA #500;
     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO CompAgosto2012;
     swAgosto2012 = 0;
     |SI nElAny ] 2012;
          |SI nElAny > 2012; |O nElMes ] 8;
                swAgosto2012 = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaFiniqCero;
     |HAZ Busca949;
     |SI sw949 = 1;
          #nomcalca#3 = 2;
          |LEE 101#nomcalca.=;
          |SI FSalida = 0;
               |PDEFECTO #nomcalca, 11, 170;
               |GRABA 020#nomcalca.a;
          |SINO;
               |PDEFECTO #nomcalca, 11, 170;
               |GRABA 020#nomcalca.n;
          |FINSI;
          |LIBERA #nomcalca;
     |FINSI;
|FPRC;

|| *** PROCESOS PARA CONTROLAR LA BASE DE COTIZACION DE LOS FUNCIONARIOS ****
|| ** A PARTIR DEL MES DE JUNIO DE 2010 (HASTA DICIEMBRE 2010 DE MOMENTO) ***

|PROCESO BuscaBaseDiaria;
     |ABRE #nomred04;
     #nomred04#0 = #labtraba#0;
     #nomred04#1 = #labtraba#1;
     #nomred04#2 = nAnyRef;
     #nomred04#3 = nMesRef;
     |LEE 101#nomred04.=;
     |SI FSalida = 0;
          nRemunMayoDia = #nomred04#63;
          || nRemunMesRefApli = #nomred04#64;
          || remuneracion aplicada en el mes de referencia en verdad
          || lo comento, no lo usare de momento, ver comentario buscando
          || "475.1162"

          nRemunMayoTeor = #nomred04#19;
          || atencion, esto es nuevo, parece ser la solucion
          || si en diciembre use la remuneracion de Mayo, tengo que seguir
          || usando esa como base, ni quitar posibles nuevos aperiodicos
          || ni nada de nada
          || pero solo en este caso, si use la que salio real de la nomina
          || del mes tengo que volver a buscar y quitar aperiodicos si
          || hubiera alguno que no era en Diciembre
          || 475.1197 (que viene del 475.1162)
     |FINSI;
     |CIERRA #nomred04;
|FPRC;

|PROCESO RedFunc2010_Fin;
     |SI runnom = "nomcalfi"; |O runnom = "nomcalir";
          || no en finiquitos ni IRPF
          |ACABA;
     |FINSI;

     |ABRE #nomred04;
     #nomred04#0 = #labtraba#0;
     #nomred04#1 = #labtraba#1;
     #nomred04#2 = nElAny;
     #nomred04#3 = nElMes;
     |LEE 101#nomred04.=;
     |SI FSalida = 0;
          |ABRE #nomcalca;
          #nomcalca#0 = #labtraba#0;
          #nomcalca#1 = #labtraba#1;
          #nomcalca#2 = nElMes;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |CIERRA #nomcalca;

          #nomred04#12 = #nomcalca#37;
          #nomred04#13 = #nomcalca#38;
          #nomred04#14 = #nomcalca#39 + #nomcalca#117;
          #nomred04#61 = #nomcalca#62;
          #nomred04#66 = #nomcalca#41 + #nomcalca#42;  || base horas extras
          |GRABA 020#nomred04.a;
          |LIBERA #nomred04;
     |FINSI;
     |CIERRA #nomred04;
|FPRC;

|PROCESO DiasMesRef;
     |ABRE #nomcaldl;
     #nomcaldl#0 = #labtraba#0;
     #nomcaldl#1 = #labtraba#1;
     #nomcaldl#2 = nAnyRef;
     #nomcaldl#3 = nMesRef;
     #nomcaldl#4 = 0;
     #nomcaldl#5 = 011000;
     |LEE 000#nomcaldl.=;
     |SI FSalida = 0;
          nDiasMayo = #nomcaldl#8;
     |FINSI;

     #nomcaldl#5 = 111000;
     |LEE 000#nomcaldl.=;
     |SI FSalida = 0;
          nDiasMayo = nDiasMayo + #nomcaldl#8;
     |FINSI;

     #nomcaldl#5 = 211000;
     |LEE 000#nomcaldl.=;
     |SI FSalida = 0;
          nDiasMayo = nDiasMayo + #nomcaldl#8;
     |FINSI;

     |CIERRA #nomcaldl;
|FPRC;

|PROCESO nomred03;
     |SI swPaso = 1;
          #nomhicli#0 = #labtraba#0;
          #nomhicli#1 = #labtraba#1;
          #nomhicli#12 = nAnyRef - 2000;
          #nomhicli#2 = nMesRef;
          #nomhicli#3 = 0;
          #nomhicli#4 = #nomred03#1;
          |LEE 000#nomhicli.=;
          |SI FSalida = 0; |Y #nomhicli#11 > 0;
               nRemunMayoAper = nRemunMayoAper + (#nomhicli#11 * #nomhicli#10);
               nCampo1 = 20;
               |PARA nCampo1 = 20; |SI nCampo1 [ 37; |HACIENDO nCampo1 = nCampo1 + 4;
                    |SI #nomred04#nCampo1# = 0;
                         nCampo2 = nCampo1 + 1;
                         nCampo3 = nCampo1 + 2;
                         nCampo4 = nCampo1 + 3;
                         #nomred04#nCampo1# = #nomhicli#4;
                         #nomred04#nCampo2# = #nomhicli#11;
                         #nomred04#nCampo3# = #nomhicli#10;
                         #nomred04#nCampo4# = #nomhicli#11 * #nomhicli#10;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;
     |SI swPaso = 2;
          #nomcalli#0 = #labtraba#0;
          #nomcalli#1 = #labtraba#1;
          #nomcalli#2 = nElMes;
          #nomcalli#3 = 0;
          #nomcalli#4 = #nomred03#1;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0; |Y #nomcalli#11 > 0;
               nRemunMesAper = nRemunMesAper + (#nomcalli#11 * #nomcalli#10);
               |PARA nCampo1 = 40; |SI nCampo1 [ 57; |HACIENDO nCampo1 = nCampo1 + 4;
                    |SI #nomred04#nCampo1# = 0;
                         nCampo2 = nCampo1 + 1;
                         nCampo3 = nCampo1 + 2;
                         nCampo4 = nCampo1 + 3;
                         #nomred04#nCampo1# = #nomcalli#4;
                         #nomred04#nCampo2# = #nomcalli#11;
                         #nomred04#nCampo3# = #nomcalli#10;
                         #nomred04#nCampo4# = #nomcalli#11 * #nomcalli#10;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomred03;
     #nomred03#1;
     ;
     #labtraba#87, 001;
     #labtraba#87, 999;
     ;
     NULL, nomred03;
|FIN;

|PROCESO Aperiodicos;
     || cuando toque

     |ABRE #nomhicli;

     swPaso = 1;
     |BUCLE nomred03;

     |CIERRA #nomhicli;

     |SALVA_FICHA #nomcalli;

     swPaso = 2;
     |BUCLE nomred03;

     |REPON_FICHA #nomcalli;
|FPRC;

|PROCESO MesReferencia;
     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#66 = nAnyRef - 2000;
     #nomhicca#2 = nMesRef;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |SI nRemunMesRefApli ! 0;
               || para 2011, que me coja la cantidad que realmente formo
               || parte de la base de cotizacion en diciembre de 2010
               nRemunMayo = nRemunMesRefApli;
          |SINO;
               nRemunMayo = #nomhicca#37;
          |FINSI;

          #nomred04#4 = nRemunMayo;
          #nomred04#5 = #nomhicca#38;
          #nomred04#6 = #nomhicca#39 + #nomhicca#159;
          #nomred04#65 = #nomhicca#41 + #nomhicca#42;
          #nomred04#7 = nRemunMayo + #nomred04#65;
          #nomred04#60 = #nomhicca#62;
     |SINO;
          |SALVA_FICHA #nomcalca;

          #nomcalca#0 = #labtraba#0;
          #nomcalca#1 = #labtraba#1;
          #nomcalca#2 = nMesRef;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               nRemunMayo = #nomcalca#37;

               #nomred04#4 = nRemunMayo;
               #nomred04#5 = #nomcalca#38;
               #nomred04#6 = #nomcalca#39 + #nomcalca#117;
               #nomred04#65 = #nomcalca#41 + #nomcalca#42;
               #nomred04#7 = nRemunMayo + #nomred04#65;
               #nomred04#61 = #nomcalca#62;
          |FINSI;

          |REPON_FICHA #nomcalca;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO AvisaFun;
     aAlfa1 = #labtraba#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = #labtraba#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
     aAlfa = aAlfa1 + "." + aAlfa2;

     |PUSHV 05012380;
     |BLANCO 10012380;
     |PINPA #7#nompanta;
     |ATRI R;
     |PINTA 1427, aAlfa;
     |ATRI 0;
     |AVISO;
     |PAUSA;
|FPRC;

|PROCESO RedFunc2010;
     nRemunMes = 0;
     nRemunMayo = 0;
     nDiasMayo = 0;
     nRemunMesAper = 0;
     nRemunMayoAper = 0;
     nRemunMesDia = 0;
     nRemunMayoDia = 0;
     nRemunMayoTeor = 0;
     nRemunMesOri = 0;
     swFuncRecorte = 0;
     nNuevaAcum10 = 0;
     nRemunMesRefApli = 0;

     |SI runnom = "nomcalfi"; || no en finiquitos
          |ACABA;
     |FINSI;

     |SI #labtraba#97 = 4; |Y nEstoyEnAjuste = 0;    || solo entrara aqui en
          |ACABA;             || caso de que este en el ajuste, antes entra
     |FINSI;                  || una vez desde el calcotiz que no debe entrar
                              || si no, empieza mal el ajuste
     swSigue = 0;
     |SI nElAny = 2010; |Y nElMes ] 06;
          nAnyRef = 2010
          nMesRef = 5;
          swSigue = 1;
     |FINSI;
     |SI nElAny ] 2011;
          nAnyRef = 2010
          nMesRef = 12;
          swSigue = 1;
          |HAZ BuscaBaseDiaria;
     |FINSI;
     |SI swSigue = 1;
          |ABRE #nomred04;
          #nomred04#0 = #labtraba#0;
          #nomred04#1 = #labtraba#1;
          #nomred04#2 = nElAny;
          #nomred04#3 = nElMes;
          |LEE 101#nomred04.=;
          |SI FSalida = 0;
               |SI runnom ! "nomcalir";
               || en calculos/estimaciones de IRPF deja el registro como esta
               || por favor
                    |BORRA 020#nomred04.a;
               |FINSI;
          |FINSI;
          |DDEFECTO #nomred04;

          |ABRE #nomred01;
          #nomred01#0 = #labtraba#0;
          #nomred01#1 = #labtraba#1;
          |LEE 000#nomred01.=;
          |SI FSalida = 0;
               swFuncRecorte = 1;

               || PRIMERO BUSCO LA REMUNERACION DE MAYO DE 2010 Y LA DEL
               || MES QUE ESTOY CALCULANDO

               |HAZ MesReferencia;

               nRemunMes = acum_10 + exce_smi;

               #nomred04#0 = #labtraba#0;
               #nomred04#1 = #labtraba#1;
               #nomred04#2 = nElAny;
               #nomred04#3 = nElMes;

               || AHORA DEBERIA QUITAR TANTO DE LA DEL MES DE REFERENCIA
               || COMO LA DEL MES DE CALCULO LOS CONCEPTOS APERIODICOS

               |HAZ Aperiodicos;

               #nomred04#7 = nRemunMayo + #nomred04#65;
               nRemunMayo = nRemunMayo - nRemunMayoAper;
               #nomred04#8 = nRemunMayoAper;
               #nomred04#9 = nRemunMayo + #nomred04#65;

               nRemunMesOri = nRemunMes;
               #nomred04#66 = dacum_30 + dacum_31;
               #nomred04#15 = nRemunMes + #nomred04#66;
               nRemunMes = nRemunMes - nRemunMesAper;
               #nomred04#16 = nRemunMesAper;
               #nomred04#17 = nRemunMes + #nomred04#66;

               || EN TERCER LUGAR BUSCO LOS DIAS COTIZABLES DE ALTA EN MAYO
               || DE 2010 PARA QUEDARME CON UNA BASE DIARIA, LAS DEL MES LAS
               || OBTENGO DIVIDIENDOLA POR LOS DIAS COTIZABLES EN ALTA

               |HAZ DiasMesRef;

               ||SI nElAny [ 2010;
               || en un principio esto no lo iba a hacer para 2011, lo que ha-
               || cia era recoger la base sin aperiodicos directamente de
               || lo que habia grabado de diciembre del nomred04
               || pero se da el caso de que si un concepto NO fue aperiodico
               || en diciembre, y ahora si lo es, ese calculo no es valido

               || a ver, otra vez igual ... lo dejo para que coja esa base
               || siempre, la que hubiera guardada, pero esto volvera a estar
               || mal caso de que haya conceptos aperiodicos ahora que en Diciembre
               || no lo fueron, si esto es asi, volver a pensar en esto
               || lo que hago es comentar el SI para que no pase por aqui en el
               || 2011, 475.1162

                    |SI nRemunMayo ! 0; |Y nDiasMayo ! 0;

                         |SI nRemunMayoTeor ! nRemunMayoDia;
                              nRemunMayoDia = nRemunMayoDia;

                              || me quedo con la que tenia, no usa la que he
                              || calculado de nuevo por si hubiera conceptos
                              || que comienzan a ser aperiodicos
                              || ver comentario donde se carga nRemunMayoTeor
                         |SINO;
                              nRemunMayoDia = (nRemunMayo + #nomred04#65) / nDiasMayo;
                         |FINSI;

                    |FINSI;
               ||FINSI;

               |SI nEl928 ! 0;               || por si lo metia manual
                    nRemunMayoDia = nEl928;
               |FINSI;

               |SI nDiasMayo = 0; |Y nEl928 = 0; |Y dcobr_0 ! 0;
               |Y runnom ! "nomcalir";
                    |SI nElAny ] 2011; |Y nRemunMayoDia ! 0;

                         || no avises porque aunque no tenga dias en diciembre
                         || tendre la base guardada
                    |SINO;
                         |HAZ AvisaFun;
                    |FINSI;
               |FINSI;

               #nomred04#10 = nDiasMayo;
               #nomred04#11 = nRemunMayoDia;

               nRemunMesDia = (nRemunMes + #nomred04#66) / dcobr_0;

               #nomred04#18 = dcobr_0;
               #nomred04#62 = dcobr_0;
               #nomred04#19 = nRemunMesDia;

               |SI nRemunMayoDia > nRemunMesDia;
                    #nomred04#63 = nRemunMayoDia;
               |SINO;
                    #nomred04#63 = nRemunMesDia;
               |FINSI;

               #nomred04#64 = #nomred04#63 * #nomred04#62;

               |SI runnom ! "nomcalir";
                    || no grabar en calculo de IRPF claro

                    |GRABA 020#nomred04.n;
                    |LIBERA #nomred04;
               |FINSI;

               || POR ULTIMO MODIFICO LAS BASES SI ES NECESARIO

               |SI nRemunMesDia < nRemunMayoDia;
                    acum_10 = dcobr_0 * nRemunMayoDia;
                    acum_10 = acum_10 + nRemunMesAper - #nomred04#66;
                    |SI nEstoyEnAjuste = 4;
                         acum_10 = acum_10 - nAjusteEBnor1 - nAjusteEBnor2 - nAjusteEBnor3;
                    |FINSI;
                    nNuevaAcum10 = acum_10;  || me la guardo que en los ajustes
                                             || ME PUEDE HACER FALTA
               |FINSI;
          |FINSI;

          |CIERRA #nomred04;
          |CIERRA #nomred01;
     |FINSI;
|FPRC;

|PROCESO IniciaCosas;
     |HAZ IniciaInc;

     |SI runnom = "nomcalfi"; |ACABA; |FINSI;
     || a partir de aqui solo una vez

     |ABRE #101;
     #101#0 = #labtraba#0;
     #101#1 = #labtraba#1;
     #101#2 = nElAny;
     #101#3 = nElMes;
     |PARA nNume = 1; |SI nNume [ 4; |HACIENDO nNume = nNume + 1;
          #101#8 = nNume;
          |LEE 101#101=;
          |SI FSalida = 0;
               |BORRA 020#101a;
          |FINSI;
     |SIGUE;
     |CIERRA #101;
|FPRC;
