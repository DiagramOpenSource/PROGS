|FICHEROS;
     cretap01 #0;

     tsilco14,MANTE;      || tmp. parrilla empresas
     tsilco15,MANTE;      || tmp. parrilla trabajadores

     labempre #10;        || empresas
     labtraba;            || trabajadores
     labcentr #16;        || centros de trabajo
     nomcenes #17;        || centros de trabajo especiales

     nomcalca;            || calculos cabs. (proceso mensual)
     nomcalli;            || calculos lins. (proceso mensual)
     nomhicca;            || calculos cabs. (proceso historico)
     nomhicli;            || calculos lins. (proceso historico)
     nomcalac;            || calculos cabs. (proceso atrasos)
     nomcalal;            || calculos cabs. (proceso atrasos)
     silcon15 #25;        || regimenes centros
     nomcontr #36;        || control aplicacion

     nombotra;
     nomconca;
     nomhisit;
     nombofca;
     nombofli;

     cretam01;
     cretam02;
     cretam03;
     cretam04;
     cretam06;

     cretat04;
     gomdesjr;
     gomdetjr;

     nomboni3;
     nombonif;
     nompluri;
     nompluba;

     nomintal;
     nomparam;
     nomabsca;
     nomabsli;

     nomcot02;
     nomcot2x;
     nomconst;
|FIN;

|VARIABLES;
     fech1 = @;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nume1 = 0;
     nume2 = 0;
     enAny = 0;
     p_mes = 0;
     traba = 0;
     nMarcarT = 0;
     nMarcarE = 0;
     sw_parrilla = 0;
     aAviso = "";
     FEstado = 0;
     clave = "";
     sw_auxil = 0;
     linea = 0;
     aRegimen = "";
     aParam = "";
     aAlfa = "";
     aAlfa0 = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aLibre = "";
     aReser = "";
     for_fecha = "";
     for_hora = "";
     fichero = "";
     extension = "";
     indica = "";
     &nEmp = 0;
     &nTra = 0;
     any_hist = 0;
     tipo_bot = 0;
     tipo_top = 0;
     nElAny = 0;
     nElMes = 0;
     enDesCen = 0;
     enHasCen = 0;
     eaFuente = "";

     ajuste1 = "";
     ajuste2 = "";
     ajuste3 = "";
     alfa = "";
     error = 0;
     ind = 0;
     long = 0;
     posi = 0;
     digito = "";
     texto = "";
     mascara = "";
     i = 0;
     j = 0;
     nCampo = 0;
     &nTipo = 0;
     nTipoNominas = 0;
     descom = "";
     entero = "";
     decima = "";
     elsw1 = 0;
     para1 = 0;
     nNume = 0;
     cadena = "";
     swRepite = 0;
     &aCCC = "";
     nConcepto = 0;
     nConceptoRED = 0;
     nImporte = 0;
     nConvenio = 0;
     aIndicativo = "";
     aDescripcion = "";
     aTipoPaga = "";
     nUnidades = 0;
     nUnidadesCal = 0;
     nPrecio = 0;
     nBrutoMenosPrest = 0;
     nMesAtrasos = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nMesHist = 0;
     swSigue = 0;
     aAntNroAfil = "";
     aAntCCC = "";
     aAntCen = "";
     aAntCot = "";
     nNroEmpresas = 0;
     nNroTrabaj = 0;
     nAntEmp = 0;
     nBrutoTrab = 0;
     nPagasProrr = 0;

     &s_ori = "";
     &s_tat = 0;
     &s_ele = "";
     &s_any = 0;
     &s_mes = 0;
     &s_has = 0;
     &s_anyl = 0;
     &s_sel = "";
     &s_lotecra = 0;
     &s_fichcra = "";

     nNroTras = 0;
     nAntEmpCon = 0;
     nTotEmp = 0;
     nImporteFin = 0;

     aCadena = "";
     aCadenaSal = "";
     nEspacio = 0;
     aLon = "";
     nLon = 0;
     nBlancos = 0;
     nBlancosIzd = 0;
     nBlancosDer = 0;
     aBlancosIzd = "";
     aBlancosDer = "";

     &s_num = 0;
     &s_fich = "";
     topemes = 0;
     &nMes = 0;
     aDia = "";
     aMes = "";
     aAny = "";
     aFecha = "";
     fIniMes = @;
     fFinMes = @;
     fFechaIniMes = @;
     fFechaFinMes = @;
     nFechaIniMes = 0;
     nFechaFinMes = 0;
     aFechaIniMes = "";
     aFechaFinMes = "";
     fFechaAlta = @;
     fFechaBaja = @;
     nFechaAlta = 0;
     nFechaBaja = 0;
     nNume1 = 0;
     nNume2 = 0;
     nDias = 0;
     nDiasAlta = 0;
     &enLote = 0;
     &eaFich = "";
     &eaExt = "";
     swPosibleError = 0;
     nDesdeTra = 0;
     nHastaTra = 0;
     swHayAlguno = 0;
     &nAny = 0;
     nAnyXX = 0;
     nAnyLote = 0;
     aCentroNom = "":
     &fFechaIniPer = @;
     &fFechaFinPer = @;
     aFechaIniPer = "";
     aFechaFinPer = "";

     fFechaIniTramo = @;
     nFechaIniTramo = 0;
     aFechaIniTramo = "";
     fFechaFinTramo = @;
     nFechaFinTramo = 0;
     aFechaFinTramo = "";

     nBase = 0;
     nLinea = 0;
     aLinea = "";
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     aTipo = "";
     nDesde = 0;
     nHasta = 0;
     nCodTipo = 0;
     aDesTipo = "";
     swDesde = 0;
     swHasta = 0;
     aFechaBusca = "";
     fFechaBusca = @;
     aContrato = "";
     nGrupoCot = 0;
     nCategoria = 0;
     aOcupacion = "";
     nHoras = 0;
     &aNif = "";
     nVez = 0;
     nFechaIniPer = 0;
     nFechaFinPer = 0;
     nBonifMan = 0;
     nBonifFom = 0;
     aFechaIniBon = "";
     fFechaIniBon = @;
     aFechaFinBon = "";
     fFechaFinBon = @;
     swGraba = 0;
     swGrabado = 0;
     swPrest = 0;
     fFecha = @;
     nFecha = 0;
     nUltima = 0;
     &aNAFSS = "";
     nLineaAjuste = 0;
     nUltimoTramoAlta = 0;
     nUltimoTramoIT = 0;
     nCodTipoAnt = 0;
     nLineaAnt = 0;
     nDiasCot = 0;
     aFechaAlta = "";
     aFechaBaja = "";
     swMarca52 = 0;
     swRegrabado = 0;
     swHay = 0;

     nBaseCCAlta = 0;
     nBaseATEP_Alta = 0;
     nBaseCCIT = 0;
     nBaseATEP_IT = 0;
     nBaseEnfAcc = 0;
     nBaseMat = 0;
     nBasePat = 0;
     nBaseRie = 0;
     nBaseCon = 0;
     nBaseERE = 0;
     nBaseHorasFM = 0;
     nBaseHorasOtras = 0;
     nNumHorasComp = 0;
     aSituacion = "";
     nCodigo = 0;
     nUltimoCodigo = 0;

     nDiasEnf = 0;
     nDiasAcc = 0;
     nDiasMat = 0;
     nDiasPat = 0;
     nDiasRie = 0;
     nDiasCon = 0;
     nDiasHue = 0;
     nDiasERE = 0;
     nPropERE = 0;
     aUltimaIT = "";
     nAjuste = 0;
     nDiasCotAlta = 0;
     nDiasCotIT = 0;
     nPrestEnf = 0;
     nPrestAcc = 0;
     nBases = 0;
     nDiasTramo = 0;
     nDiasNatTramo = 0;
     nPropTramo = 0;
     swPrest52 = 0;
     swPrest53 = 0;
     nPromedioCC = 0;
     nPromedioATEP = 0;
     nBaseDiariaERE = 0;
     nDiasMesTrab = 0;
     nDiaIT = 0;
     nDiasAcumIT = 0;
     nDiasAcumEnf = 0;
     nDias60 = 0;
     nDias75 = 0;
     nHastaReal = 0;
     nIndicador = 0;
     nCodigoHoras = 0;
     swTopeMin = 0;
     nHorasTP = 0;
     nNumHorasFor = 0;
     aTipoHorasFor = "";
     nAcumHorasFor = 0;
     nAcumHorasComp = 0;

     nNumHorasTut = 0;
     nHorasTutTramo = 0;
     nBonifTut = 0;
     nAcumHorasTut = 0;

     swCuenta = 0;
     nTrabEmp = 0;
     nTotalTra = 0;
     aTotalTra = "";
     nNroTra = 0;
     nTotalEmp = 0;
     aTotalEmp = "";
     nNroEmp = 0;
     swFinPeriodo = 0;
     swUltimoDiaIT = 0;

     nDiasAltaNIF = 0;
     fFecha1 = @;
     fFecha2 = @;
     nFecha1 = 0;
     nFecha2 = 0;
     nNroCCCs = 0;
     nCodigoIniIT = 0;
     nCodigoFinIT = 0;

     nJornadas = 0;
     nJornadasIT = 0;
     nJornadasTramo = 0;
     nJornadasTramoIT = 0;
     nJornadasCalen = 0;
     nPrestManEnf = 0;
     nPrestManAcc = 0;

     swDiferente = 0;
     nMesAnt = 0;
     swIniPeriodo = 0;
     swTramoUnSoloDia = 0;
     nDiasRecaida = 0;
     swCentroFormacion = 0;

     nDesdeTipo = 0;
     nHastaTipo = 0;
     &nDiasVac1 = 0;
     &nDiasVac2 = 0;

     nDias99 = 0;  || para las L13
     nMes99 = 0;
     nAny99 = 0;

     nBonifFormCont = 0;
     swAsignada = 0;

     nDiaDesde = 0;
     nDiaHasta = 0;
     fFechaHastaTra = @;
     fFechaHastaPer = @;
     nDiaHastaMasUno = 0;

     nEmpAnt = 0;
     nTraAnt = 0;

     swAginom = 0;
     swIplabor2 = 0;
     nTraGuarda = 0;
     swTrabMatTP = 0;
     swTrabERETP = 0;
     swNoAnotesTramo = 0;
     nSegundaBaseIT = 0;
     nNroIT = 0;
     nBaseTotal = 0;

     nJornadas_A = 0;
     nJornadas_B = 0;
     nCampoA = 0;
     nCampoB = 0;
     nCampoAGR = 0;
     swITAgrJor = 0;
     swGrabaPrest = 0;
     nDiaIniPer = 0;
     nDiasTrab = 0;

     nHorasTPMant = 0;
     nHorasTPAcum = 0;
     nDiff = 0;
     nConstante = 0;
     swIntervalos = 0;
     fIniIntervalo = @;
     fFinIntervalo = @;
     aDiaIni = "";
     aDiaFin = "";
     nDiasMesInt = 0;
     swEncontrada = 0;
     swERETP = 0;
     nLin = 0;
     aAltaAfil = "";
     swM51 = 0;
     swBuscaM51 = 0;
     nContrato = 0;
     aClaveCot = "";
     swHuelgaParcial = 0;
     nHorasJor = 0;
     nBasePluriCC = 0;
     nBasePluriCP = 0;
     nDia = 0;
     swAltaIT = 0;
     swIniInactividad = 0;
     nDiasInactividad = 0;
     nBaseMinima = 0;
     nHorasCompTramo = 0;
     topemes99 = 0;
     nMes98 = 0;
     nAny98 = 0;
     nTramo99 = 0;
     nDiasVac3 = 0;
     nJorTraCal = 0;
     nDesdeTramo = 0;
     nHastaTramo = 0;
     swNoAjuste = 0;

     nDiasEREMes = 0;         || en estas variables voy a guardar, cuando
     nDiasCotAltaMes = 0;     || tengo ERE a TP junto con ENF, los dias REALES
     nDiasEnfMes = 0;         || sin proporcionar de ERE, Cot en alta y de enf
     nDiasIT = 0;
     nTotalBaseCC = 0;
     nTotalBaseATEP = 0;
     nDiferencia = 0;
     swHuelga = 0;
     swOtraIT = 0;
     swAlta = 0;
     nDiasCotAlta2 = 0;

     nCampoDes = 0;
     nCampoDes1 = 0;
     nDesdeCampo = 0;
     nHastaCampo = 0;
     swAparcao = 0;
     swBuscaCEC = 0;
     swHayCEC = 0;
     aTipoUnion = "";
     swUnoTC = 0;
     &fCFecha = @;
     &aCError = "";
     &nCConst = 0;

     nCoef = 0;
     nGrupo = 0;
     nCampoMin = 0;
     nMinimo = 0;
     swMin = 0;

     nTraOri = 0;

     nBaseCCNaf = 0;
     nBaseATEPNaf = 0;
     nDiasCotNaf = 0;
     nMinimoCC = 0;
     nMinimoCP = 0;
     nDiferenciaCC = 0;
     nDiferenciaCP = 0;
     nUltLinea = 0;

     swDia21 = 0;
|FIN;

/****************************************************************************/
/****************      PROCESOS DESDE LA PANTALLA   *************************/
/****************************************************************************/

|PROCESO MesHasta; |TIPO 7;
     |SI #0#4 < #0#1;
          #0#4 = #0#1;
          |PINTA #0#4;
     |FINSI;
|FPRC;

|PROCESO CompMesHasta;
     |SI #0#4 < #0#1;
          |MENAV "    ATENCION: el 'mes hasta' no puede ser mayor que el 'mes desde'";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Mensa18; |TIPO 7;
     |SI #0#3 = "M"; |O #0#3 = "H";
          |MENSA "    Introduzca el año de abono de las nominas";
     |FINSI;
     |SI #0#3 = "A";
          |MENSA "    Introduzca el año al que corresponden los atrasos.";
     |FINSI;
     |SI #0#3 = "T";
          |MENSA "    Introduzca el año donde se encuentran grabados los atrasos en el histórico";
     |FINSI;
|FPRC;

|PROCESO topemes99;     || halla el ultimo dia del mes para mes 99
     nume2 = 0;
     nume1 = nAny99 $ 4;    || a¤o historico
     |SI nume1 = 0;
          nume2 = 1;
     |FINSI;
     topemes99 = 31;
     |SI nMes99 = 2;
          topemes99 = 28 + nume2;
     |FINSI;
     |SI nMes99 = 4; |O nMes99 = 6; |O nMes99 = 9; |O nMes99 = 11;
          topemes99 = 30;
     |FINSI;
|FPRC;

|PROCESO topemes;     || halla el ultimo dia del mes
     nume2 = 0;
     nume1 = nAny $ 4;    || a¤o historico
     |SI nume1 = 0;
          nume2 = 1;
     |FINSI;
     topemes = 31;
     |SI nMes = 2;
          topemes = 28 + nume2;
     |FINSI;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO AyudaTipos; |TIPO 7;
     |PUSHV 08552380;
     |ATRI R;
     ||            5    6         7         8
     ||            56789012345678901234567890
     |PINTA 0855, "       - Opciones -       ";
     |PINTA 0955, "                          ";
     |PINTA 1055, "                          ";
     |PINTA 1155, "                          ";
     |PINTA 1255, "                          ";

     |SI #0#3 = "M"; |O #0#3 = "H";
          |PINTA 0955, " 00 :Normal               ";
          |PINTA 1055, " 02 :Finiquitos           ";
     |FINSI;
     |SI #0#3 = "A";
          |PINTA 0955, " 05 :Atrasos              ";
          |PINTA 1055, " 90 :Complementarias desde";
          |PINTA 1155, "     Atrasos              ";
     |FINSI;
     |SI #0#3 = "T";
          |PINTA 0955, "6-20:Atrasos Hist¢rico    ";
     |FINSI;
     |ATRI 0;
|FPRC;

|PROCESO Restaura; |TIPO 0;
     |POPV;
|FPRC;

|PROCESO defectoMesAny;
     fech1 = ~;
     alfa1 = fech1;
     alfa1 = alfa1 % 402;          || MES
     nume1 = alfa1;

     alfa2 = fech1;
     alfa2 = alfa2 % -104;
     nume2 = alfa2;                || A¥O

     |SI nume1 = 1;
         #0#0 = nume2 - 1;
         #0#1 = 12;
     |SINO;
         #0#0 = nume2;
         #0#1 = nume1 - 1;
     |FINSI;
     #0#6 = #0#0;
     #0#4 = #0#1;

     |PINTA #0#0;
     |PINTA #0#1;
     ||PINTA #0#6;
     ||PINTA #0#4;

     ||HAZ mirames;
|FPRC;

|PROCESO elAnyo; |TIPO 0;
     enAny = #0#0;
|FPRC;

|PROCESO mirames;
     |SI #0#3 ! "A";|Y #0#3 ! "T"; |Y #0#3 ! "C";
          fech1 = ~;
          alfa1 = fech1;
          alfa1 = alfa1 % 402;
          nume1 = alfa1;
          alfa2 = fech1;
          alfa2 = alfa2 % -104;
          nume2 = alfa2;

          |SI nume1 = 1;
              #0#1 = 12;
              #0#4 = 12;
          |SINO;
              #0#1 = nume1 - 2;
              #0#4 = nume1 - 2;
          |FINSI;

          |PINTA #0#1;
          |PINTA #0#4;
     |FINSI;
|FPRC;

|PROCESO pintames; |TIPO 0;
     |SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
     |SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
     |SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
     |SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
     |SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
     |SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
     |SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
     |SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
     |SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
     |SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
     |SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
     |SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
     |PINTA 0843, p_mes;
|FPRC;

|PROCESO AnyLote;
     |SI #0#3 = "M"; |O #0#3 = "H";
          #0#6 = #0#0;
     |FINSI;
|FPRC;

|PROCESO ValorCampos;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |SI #0#5 < 5;
               #0#5 = 5;
               |PINTA #0#5;
          |FINSI;
     |SINO;
          |SI #0#5 > 2;
               #0#5 = 0;
               |PINTA #0#5;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActivaCampos;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |CAMPO_MODIFICA #0#4, 1, "S";
          |CAMPO_VISUAL #0#4, 1, "S";
          |PINTA 1148, "-    ";
          |PINTA #0#4;
          |SI #0#3 = "A";
               |PINTA 1026, "A¤o .............:";
               #0#5 = 05;
               |PINTA #0#5;
          |SINO;
               |PINTA 1026, "A¤o Hist¢rico ...:";
               |CAMPO_MODIFICA #0#5, 1, "S";
          |FINSI;
          |PINTA 1224, "³ A¤o REAL atrasos.:          ³";
          |PINTA 1324, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
          |CAMPO_MODIFICA #0#6, 1, "S";
          #0#6 = #0#0;
          |PINTA #0#6;
     |SINO;
          |CAMPO_MODIFICA #0#4, 1, "N";
          |CAMPO_VISUAL #0#4, 1, "N";
          |PINTA 1148, "     ";

          |CAMPO_MODIFICA #0#5, 1, "S";

          |CAMPO_MODIFICA #0#6, 1, "N";
          #0#6 = #0#0;
          |PINTA 1026,   "A¤o .............:";
          |PINTA 1224, "³                             ³";
          |PINTA 1324, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
     |FINSI;
|FPRC;

|PROCESO PintaPantalla; |TIPO 7;
     |HAZ ActivaCampos;
|FPRC;

|PROCESO notipo;
     |SI #0#3 ! "A";
          |C_M #0#5, 1, "S";
          |SI #0#3 = "M";|O #0#3 = "H";    #0#5 = 0;     |FINSI;
          |SI #0#3 = "T";                   #0#5 = 5;     |FINSI;
          |PINTA #0#5;
     |SINO;
          |C_M #0#5, 1, "N";
          #0#5 = 5;
          |PINTA #0#5;
     |FINSI;
|FPRC;

|PROCESO cheq_tipo; |TIPO 0;
     swSigue = 0;
     |SI #0#5 = 0; |O #0#5 = 2; |O #0#5 = 90; |O #0#5 = 98;
          swSigue = 1;
     |FINSI;
     |SI 5 [ #0#5; |Y #0#5 [ 20;
          swSigue = 1;
     |FINSI;
     |SI #0#3 = "A"; |Y #0#5 ! 05; |Y #0#5 ! 90;
          swSigue = -1;
     |FINSI;
     |SI #0#3 ! "A"; |Y #0#5 = 90;
          swSigue = -2;
     |FINSI;
     |SI swSigue [ 0;
          |SI swSigue = 0;
               aAlfa = "    Tipo de nómina no permitido";
          |FINSI;
          |SI swSigue = -1;
               aAlfa = "    En nóminas desde el mensual de atrasos ";
               aAlfa = aAlfa + "sólo se permite el tipo 05 ó 90";
          |FINSI;
          |SI swSigue = -2;
               aAlfa = "    Las declaraciones complementarias sólo se ";
               aAlfa = aAlfa + "podrán obtener a partir de las nóminas del mensual de atrasos";
          |FINSI;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;

     |SI #0#3 = "M"; |O #0#3 = "H";
          |SI #0Campo ! 0; |Y #0Campo ! 2; |Y #0Campo ! 98;
               aAviso = "0000En Procesos Mensual o Histórico sólo se admiten "
               aAviso = aAviso + "los tipos 0, 2 y 98";
               |MENAV aAviso;
               |ERROR;
          |FINSI;
     |FINSI;
     |SI #0#3 = "T";
          |SI #0Campo < 5; |O #0Campo > 20;
               aAviso = "0000En Proceso Atrasos desde Histórico sólo se admiten "
               aAviso = aAviso + "los tipos del 5 al 20";
               |MENAV aAviso;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/******* PROCESOS PARA COMPROBAR SI EXISTEN TRABAJADORES EN LA SELECCION ****/
/************ QUE ESTOY HACIENDO CALCULADOS EN LOS MANTENIEMIENTOS **********/
/****************************************************************************/

/****************************************************************************/
/*********** PROCESOS PARA LA SELECCION DE EMPRESAS Y TRABAJADORES **********/
/****************************************************************************/

|PROCESO Repetir;
     swRepite = 0;
     |SI #0#3 = "R";
          |LEE 000#0p;
          |SI FSalida = 0;
               swRepite = 1;
               |PINDA #0#0;
               alfa1 = Usuario; |QBT alfa1;    alfa1 = ("t" + alfa1) % 108;
               alfa2 = Usuario; |QBT alfa2;    alfa2 = ("u" + alfa2) % 108;
               alfa3 = Usuario; |QBT alfa3;    alfa3 = ("v" + alfa2) % 108;
               |NOME_DAT #tsilco14#alfa1#;
               |NOME_DAT #tsilco15#alfa2#;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO comp;
     |SI eaFuente = "M"; nTra = #nomcalca#1; |FINSI;
     |SI eaFuente = "H"; nTra = #nomhicca#1; |FINSI;
     |SI eaFuente = "A"; nTra = #nomcalac#1; |FINSI;
     |SI eaFuente = "T"; nTra = #nomhicca#1; |FINSI;

     |ABRE #labtraba;
     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          |SI #labtraba#247 = 121; |O #labtraba#247 = 138;
          |O #labtraba#42 = "H";
               |CIERRA #labtraba;
               |ACABA;
          |FINSI;
     |FINSI;
     |CIERRA #labtraba;

     |SI nTipo ! 2;
          swHayAlguno = 1;
          |ERROR10;
     |FINSI;
     |SI nTipo = 2;
          |SI eaFuente = "M";
               |SI #nomcalca#39 ! 0;
                    swHayAlguno = 1;
                    |ERROR10;
               |FINSI;
          |FINSI;
          |SI eaFuente = "H";
               |SI #nomhicca#39 ! 0;
                    swHayAlguno = 1;
                    |ERROR10;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE comp_nomcalac;
     #nomcalac#1;
     ;
     nEmp, nDesdeTra, nDesdeMes, nTipo;
     nEmp, nHastaTra, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|DEFBUCLE comp_nomhicca;
     #nomhicca#1;
     ;
     nEmp, nDesdeTra, nAnyXX, nDesdeMes, nTipo;
     nEmp, nHastaTra, nAnyXX, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|DEFBUCLE comp_nomcalca;
     #nomcalca#1;
     ;
     nEmp, nDesdeTra, nDesdeMes, nTipo;
     nEmp, nHastaTra, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|PROCESO CargaEmp;
     swHayAlguno = 0;
     |SI eaFuente = "M";
          |BUCLE comp_nomcalca;
     |FINSI;
     |SI eaFuente = "H";
          |BUCLE comp_nomhicca;
     |FINSI;
     |SI eaFuente = "A";
          |BUCLE comp_nomcalac;
     |FINSI;
     |SI eaFuente = "T";
          |BUCLE comp_nomhicca;
     |FINSI;
|FPRC;

|PROCESO reenvio1;
     aAlfa = #labempre#0;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aAlfa = "    Consultando empresa " + aAlfa;
     |MENSA aAlfa;

     nDesdeMes = #0#1;
     |SI eaFuente = "M"; |O eaFuente = "H";
          nHastaMes = #0#1;
     |SINO;
          nHastaMes = #0#4;
     |FINSI;
     nAny = #0#0;
     nAnyXX = #0#0 - 2000;
     nTipo = #0#5;
     |SI #0#5 = 90; nTipo = 5; |FINSI;
     nDesdeTra = 00001;
     nHastaTra = 99999;

     swHayAlguno = 0;
     nEmp = #labempre#0;

     |HAZ CargaEmp;
     |SI swHayAlguno = 1;
          |DDEFECTO #tsilco14;
          #tsilco14#0 = #labempre#0;
          #tsilco14#1 = #labempre#2;
          #tsilco14#2 = " ";
          |GRABA 020#tsilco14.n;
          |LIBERA #tsilco14;
     |FINSI;

     |SI #0#5 = 90; nTipo = 90; |FINSI;
|FPRC;

|DEFBUCLE reenvio;
     #labempre#1;
     67;
         1, "S";
     99999, "S";
     ;
     NULL, reenvio1;
|FIN;

|PROCESO min14;
    #tsilco14#0 = 00001;
|FPRC;

|PROCESO max14;
    #tsilco14#0 = 99999;
|FPRC;

|PROCESO parrilla; |TIPO 0;
     |SI FSalida = 2;    || no si pulso la flecha arriba
          |ACABA;
     |FINSI;

     |SI #0#2 = "S";
          |ATRI P;   |MENSA "    Cargando seleccion ...";    |ATRI 0;
          alfa1 = Usuario; |QBT alfa1;    alfa1 = ("t" + alfa1) % 108;
          alfa2 = Usuario; |QBT alfa2;    alfa2 = ("u" + alfa2) % 108;
          alfa3 = Usuario; |QBT alfa3;    alfa3 = ("v" + alfa2) % 108;
          |NOME_DAT #tsilco14#alfa1#;
          |NOME_DAT #tsilco15#alfa2#;
          |DELINDEX #tsilco14;
          |DELINDEX #tsilco15;

          |ABRE #labempre;
          |ABRE #tsilco14;

          eaFuente = #0#3;
          |BUCLE reenvio;

          |CIERRA #labempre;
          |CIERRA #tsilco14;
          |ATRI R;
          |BLIN 4;
          |ATRI 0;
          sw_parrilla = 1;

          |PUSHV 0501 2380;
          |ENTLINEAL #1#tsilco14, 1, 4, 22, 1, min14, max14;
          |POPV;
     |FINSI;
|FPRC;


/****************************************************************************/
/******************* PROCESOS PARA LA GRABACION DE BASES ********************/
/****************************************************************************/

|PROCESO Elimina_ASR_HUE;
     |SI #cretam04#27 = "ASR";
          nDiasCotAlta = nDiasCotAlta - #cretam04#22;
          ||BORRA 020#cretam04.a;
          |LIBERA #cretam04;
     |FINSI;
     |SI #cretam04#27 = "HUE";
          ||BORRA 020#cretam04.a;
          |LIBERA #cretam04;
     |FINSI;
|FPRC;

|DEFBUCLE Elimina_ASR_HUE;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     be;
     NULL, Elimina_ASR_HUE;
|FIN;

|PROCESO GrabaBaseIT;
     swAltaIT = 1;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC"; |O #cretam04#27 = "MAT";
          |O #cretam04#27 = "PAT"; |O #cretam04#27 = "RIE"; |O #cretam04#27 = "CON";
               |SI nBaseCCIT = 0; |Y nBaseATEP_IT = 0;
                    || en atrasos, si no tengo base de IT es porque vengo de
                    || una IT del a¤o anterior o es una IT que se ha producido
                    || en ENERO, con lo que no hay variacion de base y no tengo
                    || que cotizar por ella
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #cretam04#27 = "ETP"; |O #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
          || el codigo de la base
          |SI swAginom = 1;
               |SI #cretam04#27 = "ETP";
               |Y swTrabERETP = 1;
               |Y #labtraba#1 = #cretam04#78;
                    || solo en aginom, trabajadores en ERE a TP, entra por aqui
                    || si el primer trabajador es el que tiene la parte de IT
                    nBases = 34;
                    nCodigoHoras = 62;
               |FINSI;
          |FINSI;
          |SI swIplabor2 = 1;
               |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
                    nBases = 34;
               |FINSI;
          |FINSI;
     |SINO;
          nBases = 30;
     |FINSI;
     |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
          || continuo por aqui sin reiniciar el codigo de horas
     |SINO;
          |SI swAginom = 1; |Y #cretam04#27 = "ETP";
               || en enom, en ETP tampoco
          |SINO;
               nCodigoHoras = 60;
          |FINSI;
     |FINSI;
     nDiasTramo = #cretam04#22;
     nNume1 = #cretam04#8;
     nNume2 = #cretam04#9;
     nDiasNatTramo = nNume2 - nNume1 + 1;
     |SI #cretam04#27 = "ENF"; nPropTramo = nDiasTramo / nDiasEnf; |FINSI;
     |SI #cretam04#27 = "ACC"; nPropTramo = nDiasTramo / nDiasAcc; |FINSI;
     |SI #cretam04#27 = "MAT"; |O #cretam04#27 = "MTP";
          nPropTramo = nDiasTramo / nDiasMat;
     |FINSI;
     |SI #cretam04#27 = "PAT"; |O #cretam04#27 = "PTP";
          nPropTramo = nDiasTramo / nDiasPat;
     |FINSI;
     |SI #cretam04#27 = "RIE"; nPropTramo = nDiasTramo / nDiasRie; |FINSI;
     |SI #cretam04#27 = "ERE"; nPropTramo = nDiasTramo / nDiasERE; |FINSI;
     |SI #cretam04#27 = "ETP";
          nDiasEREMes = (nDiasERE / (nPropERE / 100)) ! 0;
          nPropTramo = (nDiasTramo / nDiasEREMes);
     |FINSI;
     |SI #cretam04#27 = "CON"; nPropTramo = nDiasTramo / nDiasCon; |FINSI;
     swPrest = 0;
     swPrest52 = 0;
     swPrest53 = 0;
     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nCampo = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nCampo# = 102; |O #cretam04#nCampo# = 111;
                    |SI #labtraba#241 = "N";
                         || prestacion NO
                    |SINO;
                         swPrest = 1;
                    |FINSI;
               |FINSI;
               |SI #cretam04#nCampo# = 052;
                    swPrest52 = 1;
               |FINSI;
               |SI #cretam04#nCampo# = 053;
                    swPrest53 = 1;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          swPrest = 0;
          swPrest52 = 0;
          swPrest53 = 0;
     |FINSI;

     || primero el codigo de la base de CC en IT
     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
          #cretam04#nBases# = 500;
          |SI #cretam04#84 = 1;
               #cretam04#nBases# = 509;
          |FINSI;
          |SI #cretam04#27 = "ACC"; |Y #labtraba#42 = "A";
               || accidente siempre a la 509 en agrarios mensuales
               #cretam04#nBases# = 509;
          |FINSI;
          nBases = nBases + 1;
     |FINSI;
     |SI #cretam04#27 = "MAT";
     |O #cretam04#27 = "PAT"; |O #cretam04#27 = "RIE";
     |O #cretam04#27 = "ERE"; |O #cretam04#27 = "CON";
          #cretam04#nBases# = 509;
          nBases = nBases + 1;
     |FINSI;
     |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
          #cretam04#nBases# = 535;
          nBases = nBases + 1;
     |FINSI;
     |SI #cretam04#27 = "ETP";
          #cretam04#nBases# = 536;
          nBases = nBases + 1;
     |FINSI;

     nPromedioCC = #cretam04#81;
     nPromedioATEP = #cretam04#82;
     |SI nConstante = 515;
          nPromedioCC = 0;
     |FINSI;

     || ahora el importe de la base de CC en IT

     |SI #cretam04#27 = "ERE"; |O #cretam04#27 = "ETP";
          #cretam04#nBases# = nPropTramo * nBaseERE;
          nNume = #cretam04#nBases# ! 2;
          |SI nNume = 0;
               nNume = nBases - 1;
               #cretam04#nNume# = 0;
               || no me grabes una base a CERO
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "E";
               #cretam04#nBases# = (#cretam04#83 * nPromedioCC);
          |SINO;
               #cretam04#nBases# = (nDiasTramo * nPromedioCC);
               |SI #cretam04#88 ! 0;
                    #cretam04#nBases# = ((nDiasTramo * ((100 - nPropERE)/100)) * nPromedioCC);
               |FINSI;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |SI swTopeMin = 1;
                         nNume1 = (nDiasTramo * nPromedioCC) ! 2;
                         nNume2 =  nBaseCCIT ! 2;
                         nDiff = nNume1 - nNume2;
                         |SI -0.10 [ nDiff; |Y nDiff [ 0.10;
                              || tenemos un caso claro de tiempo parcial, con
                              || una IT que ha habido que topear en nomina
                              || por encima del promedio porque con este no
                              || se llegada a la minima, cotiza por la base
                              || minima de las horas, bueno esto es por aplacar una
                              || posible diferencia
                              #cretam04#nBases# = nNume2;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || esto es para pluriempleo, en caso de que la base de Maternidad
     || que me viene del mes anterior ya reducida por el pluriempleo
     || no coincida con aplicar el % de pluriempleo a los topes maximos
     || tengo que volver a calcular la base, es por el 1624.2523

     |SI nDiasCot = nDiasMat;
          nBasePluriCC = 0;
          nBasePluriCP = 0;
          |HAZ PluriempleoMat;
          |SI nBasePluriCC ! 0;
               nNume1 = nBasePluriCC / nDiasCot; || con todos los decimales
               nNume1 = (nDiasTramo * nNume1) ! 2;
               #cretam04#nBases# = nNume1;
          |FINSI;
     |FINSI;

     || si es cero no me grabes nada
     |SI #cretam04#nBases# = 0;
          nBases = nBases - 1;
          #cretam04#nBases# = 0;
     |SINO;
          nBases = nBases + 1;
     |FINSI;

     || ahora el codigo de la base de CP en IT

     #cretam04#nBases# = 603;
     |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
          #cretam04#nBases# = 635;
     |FINSI;
     |SI #cretam04#27 = "ETP";
          #cretam04#nBases# = 636;
     |FINSI;
     nBases = nBases + 1;

     || ahora el importe de la base de CP en IT

     #cretam04#nBases# = (nDiasTramo * nPromedioATEP);
     |SI #cretam04#27 = "ERE"; |O #cretam04#27 = "ETP";
          #cretam04#nBases# = nPropTramo * nBaseERE;
          nNume = #cretam04#nBases# ! 2;
          |SI nNume = 0;
               nNume = nBases - 1;
               #cretam04#nNume# = 0;
               || no me grabes una base a CERO
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "E";
               #cretam04#nBases# = (#cretam04#83 * nPromedioATEP);
          |SINO;
               #cretam04#nBases# = (nDiasTramo * nPromedioATEP);
               |SI #cretam04#88 ! 0;
                    #cretam04#nBases# = ((nDiasTramo * ((100 - nPropERE) / 100)) * nPromedioATEP);
               |FINSI;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |SI swTopeMin = 1;
                         nNume1 = (nDiasTramo * nPromedioATEP) ! 2;
                         nNume2 =  nBaseATEP_IT ! 2;
                         nDiff = nNume1 - nNume2;
                         |SI -0.10 [ nDiff; |Y nDiff [ 0.10;
                              || lo mismo que en CC
                              #cretam04#nBases# = nNume2;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |O #labtraba#42 = "D";
                    |SI swTopeMin = 1; |Y #labtraba#33 ] 08;
                    |Y #0#1 = 2;
                         || esto se basa en que en diarios
                         || si he tenido que topear a minimos la base de ATEP,
                         || no me vale ya el promedio para calcular los tramos
                         || he de coger la base de ATEP topeada a minimos
                         || que sera mayor que la de Comunes
                         || ejemplo Dany: 2884.3667, trab 6445.40016 y 6445.40046
                         || ejemplo 1185.900
                         #cretam04#nBases# = nPropTramo * nBaseATEP_IT;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || esto es para pluriempleo, en caso de que la base de Maternidad
     || que me viene del mes anterior ya reducida por el pluriempleo
     || no coincida con aplicar el % de pluriempleo a los topes maximos
     || tengo que volver a calcular la base, es por el 1624.2523

     |SI nDiasCot = nDiasMat;
          nBasePluriCC = 0;
          nBasePluriCP = 0;
          |HAZ PluriempleoMat;
          |SI nBasePluriCP ! 0;
               nNume1 = nBasePluriCP / nDiasCot; || con todos los decimales
               nNume1 = (nDiasTramo * nNume1) ! 2;
               #cretam04#nBases# = nNume1;
          |FINSI;
     |FINSI;

     || igual que las CC: en CP si es cero no me grabes nada
     |SI #cretam04#nBases# = 0;
          nBases = nBases - 1;
          #cretam04#nBases# = 0;
     |SINO;
          nBases = nBases + 1;
     |FINSI;

     |SI swAginom = 1;
          |SI #cretam04#27 = "ETP";
               #cretam04#nCodigoHoras# = 05;
               nCodigoHoras = nCodigoHoras + 1;
               #cretam04#nCodigoHoras# = ((#cretam04#80 / (#cretam04#80 + #cretam04#77)) * 100) ! 0;
               nCodigoHoras = nCodigoHoras + 1;
          |FINSI;
     |FINSI;

     |SI swPrest = 1;
          |SI #cretam04#27 = "ENF";
               #cretam04#nBases# = 563;
               nBases = nBases + 1;
               || ahora hay que saber en que dias estamos de la enfermedad para
               || saber si corresponde el 60% o el 75 % de la prestacion

               nNume2 = #cretam04#28 + nDiasNatTramo - 1;

               nDias60 = 0;
               nDias75 = 0;
               |PARA nNume1 = #cretam04#28; |SI nNume1 [ nNume2; |HACIENDO nNume1 = nNume1 + 1;
                    |SI 16 [ nNume1; |Y nNume1 [ 20;
                         nDias60 = nDias60 + 1;
                    |FINSI;
                    |SI nNume1 ] 21;
                         nDias75 = nDias75 + 1;
                    |FINSI;
               |SIGUE;

               #cretam04#nBases# = nDias60 * ((nPromedioCC % 60) ! 2);
               #cretam04#nBases# = #cretam04#nBases# + (nDias75 * ((nPromedioCC % 75) ! 2));

               || en caso de ERE a TP
               |SI #cretam04#88 ! 0;
                    #cretam04#nBases# = nDias60 * (((nPromedioCC % 60) % (100 - nPropERE)) ! 2);
                    #cretam04#nBases# = #cretam04#nBases# + (nDias75 * (((nPromedioCC % 75) % (100 - nPropERE)) ! 2));
               |FINSI;
               nBases = nBases + 1;
          |FINSI;
          |SI #cretam04#27 = "ACC";
               #cretam04#nBases# = 663;
               nBases = nBases + 1;

               #cretam04#nBases# = nDiasNatTramo * ((nPromedioATEP % 75) ! 2);
               nBases = nBases + 1;
          |FINSI;
     |FINSI;

     || esto para tramos en que estoy a la vez en ENF y ERE a TP

     |SI #cretam04#88 ! 0;
          nDiasEREMes = (nDiasERE / (nPropERE / 100)) ! 0;
          nPropTramo = (nDiasTramo / nDiasEREMes);
          #cretam04#nBases# = 536;
          nBases = nBases + 1;
          #cretam04#nBases# = nPropTramo * nBaseERE;
          nBases = nBases + 1;
          #cretam04#nBases# = 636;
          nBases = nBases + 1;
          #cretam04#nBases# = nPropTramo * nBaseERE;
          nBases = nBases + 1;
          #cretam04#nCodigoHoras# = 05;
          nCodigoHoras = nCodigoHoras + 1;
          #cretam04#nCodigoHoras# = nPropERE;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;
     |HAZ Pluriempleo;
|FPRC;

|PROCESO PluriempleoMat;
     |SI #0#5 ! 00;
          |ACABA;
     |FINSI;

     |ABRE #nompluri;
     |ABRE #nompluba;
     #nompluri#0 = #cretam04#0;
     #nompluri#1 = #cretam04#7;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          #nompluba#0 = #cretam04#0;
          #nompluba#1 = #cretam04#7;
          #nompluba#2 = #cretam04#1;
          #nompluba#3 = #cretam04#2;
          #nompluba#4 = 0;
          |LEE 000#nompluba.=;
          |SI FSalida = 0;
               nBasePluriCC = #nompluba#5;
               nBasePluriCP = #nompluba#6;
          |FINSI;
     |FINSI;
     |CIERRA #nompluba;
     |CIERRA #nompluri;
|FPRC;

|PROCESO Pluriempleo;
     |SI #0#5 ! 00;
          |ACABA;
     |FINSI;

     |ABRE #nompluri;
     |ABRE #nompluba;
     #nompluri#0 = #cretam04#0;
     #nompluri#1 = #cretam04#7;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          ||SI #nompluri#4 = 100; |O #nompluri#5 = 100; |O #nompluri#6 = 100;
          |SI #nompluri#4 ! #nompluri#3;
          |O #nompluri#5 ! #nompluri#3;
          |O #nompluri#6 ! #nompluri#3;
               #nompluba#0 = #cretam04#0;
               #nompluba#1 = #cretam04#7;
               #nompluba#2 = #cretam04#1;
               #nompluba#3 = #cretam04#2;
               #nompluba#4 = 0;
               |LEE 000#nompluba.=;
               |SI FSalida = 0;
                    |SI #nompluri#4 ! #nompluri#3; || DES distinto a CC
                    |Y nConstante ! 508; || no cotiza Des ni Fog
                         #cretam04#nBases# = 701;
                         nBases = nBases + 1;
                         |SI swAltaIT = 0;
                              nNume = #nompluba#6 - nBaseATEP_IT;
                         |SINO;
                              nNume = nBaseATEP_IT;
                         |FINSI;
                         #cretam04#nBases# = (nNume * nPropTramo) ! 2;
                         nBases = nBases + 1;
                    |FINSI;
                    |SI #nompluri#5 ! #nompluri#3; || FOG distinto a CC
                    |Y nConstante ! 508; || no cotiza Des ni Fog
                         #cretam04#nBases# = 702;
                         nBases = nBases + 1;
                         |SI swAltaIT = 0;
                              nNume = #nompluba#7 - nBaseATEP_IT;
                         |SINO;
                              nNume = nBaseATEP_IT;
                         |FINSI;
                         #cretam04#nBases# = (nNume * nPropTramo) ! 2;
                         nBases = nBases + 1;
                    |FINSI;
                    |SI #nompluri#6 ! #nompluri#3; || FP distinto a CC
                         #cretam04#nBases# = 703;
                         nBases = nBases + 1;
                         |SI swAltaIT = 0;
                              nNume = #nompluba#8 - nBaseATEP_IT;
                         |SINO;
                              nNume = nBaseATEP_IT;
                         |FINSI;
                         #cretam04#nBases# = (nNume * nPropTramo) ! 2;
                         nBases = nBases + 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nompluba;
     |CIERRA #nompluri;
|FPRC;

|PROCESO Minimos2016;
     |SI #labtraba#33 = 01; nBaseMinima = 35.58; |FINSI;
     |SI #labtraba#33 = 02; nBaseMinima = 29.51; |FINSI;
     |SI #labtraba#33 = 03; nBaseMinima = 25.67; |FINSI;
     |SI #labtraba#33 ] 04; nBaseMinima = 25.48; |FINSI;
|FPRC;

|PROCESO constante;
     alfa1 = "01";
     alfa2 = #cretam02#2;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #cretam02#1;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
|FPRC;

|PROCESO MinimosFinTP2;
     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |CIERRA #nomconca;

     |SI #nomconca#162 = 0;
          #nomconca#162 = 40;
     |FINSI;

     nCoef = (#labtraba#234 / #nomconca#162) ! 3;

     nCConst = #labtraba#248;
     |HAZ constante;
     nGrupo = #labtraba#33;
     nCampoMin = nGrupo + 23;

     nMinimoCC = (nDiasCotNaf * #nomconst#nCampoMin#) * nCoef;
     nMinimoCC = nMinimoCC ! 2;
     nMinimoCP = (nDiasCotNaf * #nomconst#23) * nCoef;
     nMinimoCP = nMinimoCP ! 2;
|FPRC;

|PROCESO MinimosFinTP;
     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |CIERRA #nomconca;

     |SI #nomconca#162 = 0;
          #nomconca#162 = 40;
     |FINSI;

     nCoef = (#labtraba#234 / #nomconca#162) ! 3;

     nCConst = #labtraba#248;
     |HAZ constante;
     nGrupo = #labtraba#33;
     nCampoMin = nGrupo + 23;

     |SI swMin = 1;
          nMinimo = (#cretam04#22 * #nomconst#nCampoMin#) * nCoef;
          nMinimo = nMinimo ! 2;
     |FINSI;
     |SI swMin = 2;
          nMinimo = (#cretam04#22 * #nomconst#23) * nCoef;
          nMinimo = nMinimo ! 2;
     |FINSI;
     |SI #cretam04#nBases# < nMinimo;
          #cretam04#nBases# = nMinimo;
     |FINSI;
|FPRC;

|PROCESO CompMinimoL13;
     nDiasCotNaf = nDiasCotNaf + #cretam04#22;
     |SI #cretam04#30 = 500;
          nBaseCCNaf = nBaseCCNaf + #cretam04#31;
     |FINSI;
     |SI #cretam04#32 = 601;
          nBaseATEPNaf = nBaseATEPNaf + #cretam04#33;
     |FINSI;
     nUltLinea = #cretam04#6;
|FPRC;

|DEFBUCLE CompMinimoL13;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, 00001;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, 99999;
     ;
     NULL, CompMinimoL13;
|FIN;

|PROCESO GrabaBaseAlta;
     swAltaIT = 0;
     nBases = 30;
     nCodigoHoras = 60;
     nPropTramo = #cretam04#22 / nDiasCotAlta;
     |SI #labtraba#42 = "E";
          nPropTramo = #cretam04#83 / nJornadas;
     |FINSI;
     |SI swIplabor2 = 1;
          |SI #cretam04#27 = "ETP";
               |SI nDiasEnfMes = 0;
                    nPropTramo = ((#cretam04#22 * (100 - nPropERE) / 100) / nDiasCotAlta) ! 2;

               |SINO;
                    || dias reales enf para eres a TP con Enf
                    nDiasCotAltaMes = (nDiasCot / ((100 - nPropERE) / 100)) ! 0;
                    nDiasCotAltaMes = nDiasCotAltaMes - nDiasEnfMes;
                    nPropTramo = (#cretam04#22 / nDiasCotAltaMes);
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "ALT"; |Y nPropERE ! 100;
               || este es un ERE a TP, que tiene dias de ERE a TP y ademas dias
               || de alta toda la jornada, en este caso para que las bases me
               || cuadren he de redondear a dos decimales
               || (cuidado con esto, puede ser necesario retocarlo 09.12.2015)

               nPropTramo = nPropTramo ! 2;
          |FINSI;
     |FINSI;

     |SI #cretam04#27 = "HTP";
          nPropTramo = (#cretam04#22 - (#cretam04#22 * #cretam04#87)) / nDiasCotAlta;
     |FINSI;

     || HORAS TIEMPO PARCIAL
     swSigue = 1;
     |SI swIplabor2 = 1;
     |Y #cretam04#27 = "ETP";
          || para que en caso de ERE a TP, en la parte de ETP
          || si ya era un trabajador a TP
          || no me ponga estas horas, solo las que me pone mas adelante
          swSigue = 0;
     |FINSI;

     |SI #cretam04#24 ! 0; |Y swSigue = 1;
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          swSigue = 0;
          |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
               swSigue = 1;
          |FINSI;
          |SI swAginom = 1; |Y #cretam04#27 = "ETP";
               swSigue = 1;
          |FINSI;
          |SI #cretam04#27 = "ALT"; |Y #0#3 = "A";
               || atrasos con ERE a TP en trab a TP
               || 4413.131
               #cretam04#24 = #cretam04#24 * (1 - (#cretam04#88 / 100));
          |FINSI;
          |SI swSigue = 1;
               #cretam04#nCodigoHoras# = #cretam04#77;
          |SINO;
               #cretam04#nCodigoHoras# = #cretam04#24;
               |SI #cretam04#27 = "HTP";
                    #cretam04#nCodigoHoras# = (1 - #cretam04#87) * #cretam04#24;
               |FINSI;
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;
     |SI #cretam04#24 = 0; |Y #cretam04#27 = "HTP";
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          nNume = ((1 - #cretam04#87) * 5.71) * #cretam04#22;
          |SI nNume < 1;
               nNume = 1;
          |FINSI;
          #cretam04#nCodigoHoras# = nNume;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;

     || HORAS COMPLEMENTARIAS
     nHorasCompTramo = 0;
     |SI nNumHorasComp ! 0;
          #cretam04#nCodigoHoras# = 02;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #cretam04#6 = nUltimoTramoAlta;
               #cretam04#nCodigoHoras# = nNumHorasComp - nAcumHorasComp;
               nNume = #cretam04#nCodigoHoras#;
          |SINO;
               nNume = nPropTramo * nNumHorasComp;
               nNume = (nNume - 0.49) ! 0;
               #cretam04#nCodigoHoras# = nNume;
          |FINSI;
          nAcumHorasComp = nAcumHorasComp + nNume;
          nHorasCompTramo = nNume;

          |SI nNume = 0;
               || 1 hora complementaria a repartir entre dos tramos
               || s¡, se ha dado el caso: 3923.1485
               || lo quito para que se grabe a cero
               nCodigoHoras = nCodigoHoras - 1;
               #cretam04#nCodigoHoras# = 00;
          |FINSI;
     |FINSI;

     || HORAS BONIFICADAS FORMACION
     |SI nNumHorasFor ! 0;
          |SI aTipoHorasFor = "D";
               #cretam04#nCodigoHoras# = 04;
          |SINO;
               #cretam04#nCodigoHoras# = 03;
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #cretam04#6 = nUltimoTramoAlta;
               #cretam04#nCodigoHoras# = nNumHorasFor - nAcumHorasFor;
          |SINO;
               nNume = nPropTramo * nNumHorasFor;
               nNume = (nNume - 0.49) ! 0;
               #cretam04#nCodigoHoras# = nNume;
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;
          nAcumHorasFor = nAcumHorasFor + nNume;
     |FINSI;

     || HORAS BONIFICADAS TUTORIAS
     nHorasTutTramo = 0;
     |SI nNumHorasTut ! 0;
          #cretam04#nCodigoHoras# = 06;

          nCodigoHoras = nCodigoHoras + 1;
          |SI #cretam04#6 = nUltimoTramoAlta;
               #cretam04#nCodigoHoras# = nNumHorasTut - nAcumHorasTut;
          |SINO;
               nNume = nPropTramo * nNumHorasTut;
               nNume = (nNume - 0.49) ! 0;
               #cretam04#nCodigoHoras# = nNume;
          |FINSI;
          nHorasTutTramo = #cretam04#nCodigoHoras#;
          nAcumHorasTut = nAcumHorasTut + nHorasTutTramo;
     |FINSI;

     || HORAS TRABAJADAS EN ERE PARCIAL
     swSigue = 0;
     |SI swIplabor2 = 1;
          |SI #cretam04#27 = "ETP"; |O swERETP = 1;
               /*
               |SI #0#3 = "A"; |O #0#3 = "T";
                    || en atrasos solo en este caso
                    |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
                         swSigue = 1;
                    |FINSI;
               |SINO;
                    || en no atrasos siempre
                    swSigue = 1;
               |FINSI;
               */
               || otra vez con lo mismo, 23.11.2017 3076.2042, le exigen
               || que lleven las horas los trabajadores
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               nNume = (#cretam04#22 * (100 - nPropERE) / 100) * #labtraba#47;
               #cretam04#nCodigoHoras# = (nNume ! 0);
          |SINO;
               |ABRE #nomconca;
               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |CIERRA #nomconca;

               nNume = (#cretam04#22 * (100 - nPropERE) / 100) * ((#nomconca#162 / 7) ! 2);
               #cretam04#nCodigoHoras# = (nNume ! 0);
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;

          |SI #0#3 ! "A"; |Y #0#3 ! "T";
               || an ATRASOS no se va a cotizar por ERE (se espera que nadie
               || use el 990), asi que este indicador no tiene que salir
               #cretam04#nCodigoHoras# = 05;
               nCodigoHoras = nCodigoHoras + 1;
               #cretam04#nCodigoHoras# = nPropERE;
               nCodigoHoras = nCodigoHoras + 1;
          |FINSI;
     |FINSI;

     |SI swAginom = 1; |Y #cretam04#27 = "ETP";
          || en aginom las loras trabajadas ya las he grabado antes

          #cretam04#nCodigoHoras# = 05;
          nCodigoHoras = nCodigoHoras + 1;
          #cretam04#nCodigoHoras# = ((#cretam04#80 / (#cretam04#80 + #cretam04#77)) * 100) ! 0;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;

     |SI nBaseCCAlta ! 0; |Y nPropTramo ! 0;
          #cretam04#nBases# = 500;
          |SI #labtraba#247 = 112;
               #cretam04#nBases# = 300;
          |FINSI;
          nBases = nBases + 1;
          #cretam04#nBases# = (nBaseCCAlta * nPropTramo) ! 2;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #0#0 = 2016; |Y #0#1 = 12;
                    |HAZ Minimos2016;
                    nNume = #cretam04#22 * nBaseMinima;
                    |SI #cretam04#nBases# < nNume;
                         #cretam04#nBases# = nNume;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nTipo = 2;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |O #labtraba#42 = "P";
                    swMin = 1;
                    |HAZ MinimosFinTP;
               |FINSI;
               nBaseCCNaf = nBaseCCNaf + #cretam04#nBases#;
               nDiasCotNaf = nDiasCotNaf + nDiasCotAlta;
          |FINSI;

          nTotalBaseCC = nTotalBaseCC + #cretam04#nBases#;
          aAlfa = #labempre#10; |QBF aAlfa;
          |SI aAlfa = "A30121404";
               nDiferencia = nTotalBaseCC - nBaseCCAlta;
               |SI -1.00 [ nDiferencia; |Y nDiferencia [ 1.00;
                    #cretam04#nBases# = #cretam04#nBases# - nDiferencia;
               |FINSI;
          |FINSI;

          nBases = nBases + 1;          || esto no lo quites
     |FINSI;

     |SI nBaseATEP_Alta ! 0; |Y nPropTramo ! 0;
     |Y #labtraba#247 ! 112;
          #cretam04#nBases# = 601;
          |SI swIplabor2 = 1;
               nNume = 248;
               |SI #labtraba#nNume# = 530;       || ayuntamientos, solo cotiza por CC e IT/IMS
                    #cretam04#nBases# = 611;
               |FINSI;
          |FINSI;

          nBases = nBases + 1;
          #cretam04#nBases# = (nBaseATEP_Alta * nPropTramo) ! 2;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #0#0 = 2016; |Y #0#1 = 12;
                    |HAZ Minimos2016;
                    nNume = #cretam04#22 * nBaseMinima;
                    |SI #cretam04#nBases# < nNume;
                         #cretam04#nBases# = nNume;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nTipo = 2;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |O #labtraba#42 = "P";
                    swMin = 2;
                    |HAZ MinimosFinTP;
               |FINSI;
               nBaseATEPNaf = nBaseATEPNaf + #cretam04#nBases#;
          |FINSI;

          nTotalBaseATEP = nTotalBaseATEP + #cretam04#nBases#;
          aAlfa = #labempre#10; |QBF aAlfa;
          |SI aAlfa = "A30121404";
               nDiferencia = nTotalBaseATEP - nBaseATEP_Alta;
               |SI -1.00 [ nDiferencia; |Y nDiferencia [ 1.00;
                    #cretam04#nBases# = #cretam04#nBases# - nDiferencia;
               |FINSI;
          |FINSI;

          nBases = nBases + 1;          || esto no lo quites
     |FINSI;

     |HAZ Pluriempleo;

     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
     |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
          nNume = nBaseHorasFM + nBaseHorasOtras;
          |SI nNume ! 0; |Y nHorasCompTramo ! 0;
               #cretam04#nBases# = 537;
               nBases = nBases + 1;
               #cretam04#nBases# = (nNume * nPropTramo) ! 2;
               |SI nHorasCompTramo = nNumHorasComp;
                    || si todas las horas complementarias estan en el mismo
                    || tramo, no hay que proporcionar la base, puede pasar
                    || si solo tenemos una hora o tenemos pocas horas y tramos
                    || con pocos dias
                    #cretam04#nBases# = (nNume * 1) ! 2;
               |FINSI;
               nBases = nBases + 1;
          |FINSI;
     |SINO;
          |SI nBaseHorasFM ! 0;
               #cretam04#nBases# = 501;
               nBases = nBases + 1;
               #cretam04#nBases# = (nBaseHorasFM * nPropTramo) ! 2;
               nBases = nBases + 1;
          |FINSI;
          |SI nBaseHorasOtras ! 0;
               #cretam04#nBases# = 502;
               nBases = nBases + 1;
               #cretam04#nBases# = (nBaseHorasOtras * nPropTramo) ! 2;
               nBases = nBases + 1;
          |FINSI;
     |FINSI;

     || BONIFICION TUTORIAS
     |SI nBonifTut ! 0;
          #cretam04#nBases# = 737;
          nBases = nBases + 1;

          #cretam04#nBases# = nHorasTutTramo * (nBonifTut / nNumHorasTut);
          nBases = nBases + 1;
     |FINSI;
|FPRC;

|PROCESO GrabaBase51;
     |SI nTipo = 90;
          |ACABA;
     |FINSI;

     |PARA nIndicador = 50; |SI nIndicador [ 58; |HACIENDO nIndicador = nIndicador + 1;
          |SI #cretam04#nIndicador# = 51;
               |SAL;
          |SINO;
               |SI #cretam04#nIndicador# = 00;
                    #cretam04#nIndicador# = 51;
                    nIndicador = nIndicador + 1;
                    #cretam04#nIndicador# = "M";
                    nIndicador = nIndicador + 1;
                    |SAL;
               |SINO;
                    nIndicador = nIndicador + 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaBase54;
     |SI nTipo = 90;
          |ACABA;
     |FINSI;

     |PARA nIndicador = 50; |SI nIndicador [ 58; |HACIENDO nIndicador = nIndicador + 1;
          |SI #cretam04#nIndicador# = 54;
               |SAL;
          |SINO;
               |SI #cretam04#nIndicador# = 00;
                    #cretam04#nIndicador# = 54;
                    nIndicador = nIndicador + 1;
                    #cretam04#nIndicador# = "1";
                    nIndicador = nIndicador + 1;
                    |SAL;
               |SINO;
                    nIndicador = nIndicador + 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaBases;
     || nDiasCot: dias cotizables
     || nDiasCotAlta: total dias cotizables en Alta
     || nDiasCotIT: total dias cotizables en IT

     || nBaseCCAlta: base CC en alta
     || nBaseATEP_Alta: base ATEP en Alta
     || nBaseEnfAcc: base de enf y acc
     || nBaseMat: base en Maternidad
     || nBasePat: base en Paternidad
     || nBaseRie: base en Riesgo durante en embarazo
     || nBaseCon: base en Control de IT
     || nBaseERE: base en ERE
     || nBaseHorasFM: base de horas extras fuerza mayor
     || nBaseHorasOtras: base de otras horas extras

     || TODOS ESTOS DIAS SON DIAS COTIZABLES
     || nDiasAlta: dias en alta
     || nDiasEnf: dias en enfermedad
     || nDiasAcc: dias en accidente
     || nDiasMat: dias en maternidad
     || nDiasPat: dias de paternidad
     || nDiasRie: dias en riesgo
     || nDiasCon: dias en control de IT
     || nDiasERE: dias en ERE

     || nPromedioCC: base diaria CC
     || nPromedioATEP: base diaria ATEP
     || nPrestEnf: prestaciones por enfermedad
     || nPrestAcc: prestaciones por accidente
     |SI swIntervalos = 1;
          nDiasCot = nDiasMesInt;
          nDiasCotAlta = nDiasMesInt;
     |FINSI;
     |SI #cretam04#27 = "ALT";
          |SI #cretam04#25 = "S";
               |HAZ GrabaBase51;
          |FINSI;
          |SI #0#3 = "A"; |O #0#3 = "T";
               |HAZ GrabaBase54;
          |FINSI;
          |HAZ GrabaBaseAlta;
     |SINO;
          |SI #cretam04#25 = "S";
               |HAZ GrabaBase51;
          |FINSI;
          |SI #0#3 = "A"; |O #0#3 = "T";
               |HAZ GrabaBase54;
          |FINSI;

          |SI swIplabor2 = 1;
               |SI #cretam04#27 = "ETP";
                    |HAZ GrabaBaseAlta;
               |FINSI;
          |FINSI;
          swSigue = 0;
          |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "PTP";
               |SI #labtraba#1 = #cretam04#75;
                    swSigue = 1;
                    || esto ocurre en el caso de que un trabajador de maternidad
                    || a tiempo parcial tenga como primer codigo el de baja
                    || y despues el de alta, en ese caso entrara por aqui
               |FINSI;
          |FINSI;
          |SI swAginom = 1; |Y #cretam04#27 = "ETP"; |Y #labtraba#1 = #cretam04#75;
               swSigue = 1;
               || esto ocurre en el caso de que un trabajador de ERE a TP
               || en ENOM tenga como primer codigo el de baja
               || y despues el de alta, en ese caso entrara por aqui
          |FINSI;
          |SI #cretam04#27 = "HTP";
               swSigue = 1;
          |FINSI;

          |SI swSigue = 1;
               || tengo que grabar bases en ALTA, entrando en situacion de IT
               || por maternidades y ERES a TP y huelgas a TP
               |HAZ GrabaBaseAlta;
          |SINO;
               || el caso general

               |SI #cretam04#27 ! "ASR"; |Y #cretam04#27 ! "INA";
               |Y #cretam04#27 ! "HUE";
                    |HAZ GrabaBaseIT;
               |FINSI;
          |FINSI;
     |FINSI;
     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|DEFBUCLE GrabaBases;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     ;
     NULL, GrabaBases;
|FIN;

|PROCESO Bases;
     |SI swTrabMatTP = 2;
          nTraOri = nTra;
          nTra = 0;
     |FINSI;
     |SI swTrabERETP = 2;
          nTraOri = nTra;
          nTra = 0;
     |FINSI;
     |SI #nomcalac#0 = 858; |Y #nomcalac#1 = 887;
          |SI #nomcalac#2 = 2;
               nTra = 887;
          |FINSI;
          |SI #nomcalac#2 = 3; |O #nomcalac#2 = 4;
               nTra = 886;
          |FINSI;
     |FINSI;
     nAcumHorasFor = 0;
     nAcumHorasTut = 0;
     nAcumHorasComp = 0;
     nTotalBaseCC = 0;
     nTotalBaseATEP = 0;

     |BUCLE Elimina_ASR_HUE;

     |BUCLE GrabaBases;

     || solo ADADE de momento, no me fio de esto
     swSigue = 0;
     |SALVA_FICHA #labempre;
     #labempre#0 = 6204;
     |LEE 000#labempre.=;
     |SI FSalida = 0; |Y #labempre#10 = "B45532132      ";
          swSigue = 1;
     |FINSI;
     |REPON_FICHA #labempre;

     |SI nTipo = 2;
     |Y swSigue = 1; || solo ADADE, de momento
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P";
               nBaseCCNaf = 0;
               nBaseATEPNaf = 0;
               nDiasCotNaf = 0;
               nMinimoCC = 0;
               nMinimoCP = 0;
               nDiferenciaCC = 0;
               nDiferenciaCP = 0;
               nUltLinea = 0;

               |BUCLE CompMinimoL13;
               |HAZ MinimosFinTP2;

               |SI nBaseCCNaf < nMinimoCC;
                    nDiferenciaCC = nMinimoCC - nBaseCCNaf;
               |FINSI;
               |SI nBaseATEPNaf < nMinimoCP;
                    nDiferenciaCP = nMinimoCP - nBaseATEPNaf;
               |FINSI;

               |SI nDiferenciaCC > 0; |O nDiferenciaCP > 0;
                    #cretam04#0 = nEmp;
                    #cretam04#1 = nAny;
                    #cretam04#2 = nMes;
                    #cretam04#3 = nTipo;
                    #cretam04#4 = aCCC;
                    #cretam04#5 = aNAFSS;
                    #cretam04#6 = nUltLinea;
                    |LEE 101#cretam04.=;
                    |SI FSalida = 0;
                         |SI #cretam04#30 = 500;
                              #cretam04#31 = #cretam04#31 + nDiferenciaCC;
                         |FINSI;
                         |SI #cretam04#32 = 601;
                              #cretam04#33 = #cretam04#33 + nDiferenciaCP;
                         |FINSI;
                         |GRABA 020#cretam04.a;
                    |FINSI;
                    |LIBERA #cretam04;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nTipo ] 5;
          |SI swTrabMatTP = 2; |O swTrabERETP = 2;
               || bueno, en teoria, en estos casos, se graba el codigo del
               || trabaajador a cero y segraban los dos trabajadores en
               || otros dos campos

               || el problema es que en atrasos no se esta haciendo asi
               || y se graba "uno de los dos" en el campo, asi que si lo busco
               || por el 00000 no se graba la parte de MAt o PAT a TP

               || lo logico seria ver por que, pero no me fio asi que hago
               || la busqueda ahora por el codigo

               nTra = nTraOri;
               |BUCLE GrabaBases;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaTramoAcum;
     fFecha = #nomcot02#8;
     nNume = fFecha;
     nNume = fFecha - 1;
     fFecha = nNume;     || aqui tengo ya el dia anterior al comienzo
                         || de tramo del trab nuevo, que tiene que ser igual
                         || al fia de fin del anterior

     |SI #cretam04#7 ! #nomcot02#7;     || tiene que ser otro codigo
     |Y #cretam04#9 = fFecha;
          || es este
          || me quedo con el dia de inicio (campo 6.LINEA) que es lo que
          || me falta de la clave
          nLinea = #cretam04#6;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTramoAcum;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     be;
     NULL, BuscaTramoAcum;
|FIN;

|PROCESO UneTramos;
     |SI aTipoUnion = "H"; |Y swUnoTC = 1;
          |PARA nCampoDes = nDesdeCampo;
          |SI nCampoDes [ nHastaCampo;
          |HACIENDO nCampoDes = nCampoDes + 2;
               nCampoDes1 = nCampoDes + 1;
               #cretam04#nCampoDes# = 0;
               #cretam04#nCampoDes1# = 0;
          |SIGUE;
          |ACABA;
     |FINSI;
     |PARA nCampo = nDesdeCampo; |SI nCampo [ nHastaCampo; |HACIENDO nCampo = nCampo + 2;
          nCampo1 = nCampo + 1;
          |SI #cretam04#nCampo# ! 0;
          |O aTipoUnion = "H";
          || cuando va a unir bases siempre comprueba antes que el tramo que
          || existia tuviera alguna base ya grabada, pero con las horas esto
          || no debe hacerlo porque puede que en un tramo tenga horas y en el
          || otro no, el tramo de union debe tenerlas
               nConcepto = #nomcot02#nCampo#;
               nBase = #nomcot02#nCampo1#;
               swAparcao = 0;
               |PARA nCampoDes = nDesdeCampo;
               |SI nCampoDes [ nHastaCampo; |Y swAparcao = 0;
               |HACIENDO nCampoDes = nCampoDes + 2;
                    nCampoDes1 = nCampoDes + 1;
                    |SI #cretam04#nCampoDes# = nConcepto;
                         #cretam04#nCampoDes1# = #cretam04#nCampoDes1# + nBase;
                         swAparcao = 1;
                    |SINO;
                         |SI #cretam04#nCampoDes# = 0; |Y swAparcao = 0;
                              #cretam04#nCampoDes# = nConcepto;
                              #cretam04#nCampoDes1# = nBase;
                              swAparcao = 1;
                         |FINSI;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO UneCodigo;
     aAlfa = #nomcot02#7;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aAlfa1 = #cretam04#85;
     |QBF aAlfa1;
     #cretam04#85 = aAlfa1 + aAlfa;
|FPRC;

|PROCESO nomcot02;
     |SI swBuscaCEC = 1;
          swHayCEC = 1;
          |ACABA;
     |FINSI;

     || lo primero es comprobar si el trabajador existe
     || no tiene que existir, ya que he borrado sus tramos en el bucle
     || borratramos antes de nada, con lo que si existe es porque tenemos
     || un caso de trabajador duplicado por algun motivo (mat/pat TP o
     || dos fichas con periodos coincidentes)

     || tambien esta el caso de un trabajador que tiene dos fichas, pero que
     || no tiene que hacer tramo

     || el primer caso, trabajador con dos fichas con periodos duplicados

     |DDEFECTO #cretam04;
     |PARA nCampo = 0; |SI nCampo [ 7; |HACIENDO nCampo = nCampo + 1;
          #cretam04#nCampo# = #nomcot02#nCampo#;
     |SIGUE;
     |LEE 101#cretam04.=;
     FEstado = FSalida;

     swSigue = 0;
     |SI FEstado = 0;
          || el trabajador ya existia, tengo que acumular si la base ya existia
          || caso de mat/pat a TP o de trab. con periodos coincidentes (total
          || de la nomina repartida en varias fichas)

          |HAZ UneCodigo;
          swSigue = 1;
     |FINSI;

     || otro caso es un cambio de codigo sin cambio de nada mas ni alta afiliacion
     || tengo que acumular tambien, para que solo haga un tramo

     aAlfa = "";
     |PARA nCampo = 11; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 2;
          aAlfa = aAlfa + #nomcot02#nCampo#;
     |SIGUE;
     |QBT aAlfa;
     |SI aAlfa = "CSA"
          || esta es justamente esa situacion, cambio de tramo por CSA
          || (Contrato Sin Afiliacion), que es un cambio de codigo sin nada mas
          || que cambie

          || ahora tengo que buscar el trabajador donde tengo que acumular
          || estas bases, tiene que haber sido baja el dia anterior

          nLinea = 0;
          |BUCLE BuscaTramoAcum;
          |SI nLinea ! 0;
               |DDEFECTO #cretam04;
               |PARA nCampo = 0; |SI nCampo [ 5; |HACIENDO nCampo = nCampo + 1;
                    #cretam04#nCampo# = #nomcot02#nCampo#;
               |SIGUE;
               #cretam04#6 = nLinea;
               |LEE 101#cretam04.=;
               |SI FSalida = 0;
                    || ya lo tengo, es este, modifico un par de cosas ademas
                    || de las bases

                    #cretam04#9 = #nomcot02#9;    || la fecha fin tramo
                    #cretam04#21 = #nomcot02#21;    || dia fin tramo
                    #cretam04#22 = #cretam04#22 + #nomcot02#22;  || dias tramo
                    #cretam04#24 = #cretam04#24 + #nomcot02#24;  || horas tp
                    #cretam04#71 = #nomcot02#71;  || dia fin periodo

                    || esto deberia hacerse en el proceso unecodigo
                    || el problema es que en estos casos, en el cretam04 se guarda
                    || en la clave el trabajador "1" y al recoger luego los calculos
                    || se guarda en el cretam3b el trabajador "2"

                    || para que no de diferencias hay que hacerlo asi, guardar
                    || en el campo 85 TODOS LOS trabajadores

                    aAlfa1 = #cretam04#7;
                    |QBF aAlfa1;
                    aAlfa1 = ("00000" + aAlfa1) % -105;

                    aAlfa2 = #nomcot02#7;
                    |QBF aAlfa2;
                    aAlfa2 = ("00000" + aAlfa2) % -105;

                    aAlfa = #cretam04#85;
                    |QBF aAlfa;
                    |SI aAlfa = "";
                         #cretam04#85 = aAlfa1 + aAlfa2;
                    |SINO;
                         #cretam04#85 = #cretam04#85 + aAlfa2;
                    |FINSI;

                    swSigue = 1;
                    ||HAZ UneCodigo;

                    FEstado = 0;   || para que me lo grabe despues como .a
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          || para las bases
          aTipoUnion = "B";
          nDesdeCampo = 30;
          nHastaCampo = 49;
          |HAZ UneTramos;

          || para las horas
          aTipoUnion = "H";
          nDesdeCampo = 60;
          nHastaCampo = 69;
          |HAZ UneTramos;
     |SINO;
          || el caso normal, simple traspaso de tramos

          |PARA nCampo = 8; |SI nCampo [ 88; |HACIENDO nCampo = nCampo + 1;
               |SI nCampo < 10; |O nCampo > 19;
                    #cretam04#nCampo# = #nomcot02#nCampo#;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #cretam04#23 = "S";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          #cretam04#25 = "S";
     |FINSI;

     |SI FEstado = 0;
          |GRABA 020#cretam04.a;
     |SINO;
          |GRABA 020#cretam04.n;
     |FINSI;
     |LIBERA #cretam04;

     || para comprobar si tengo algun contrato a TC
     || si es asi no tengo que poner horas en caso de varios contratos

     |SI #nomcot02#73 ] 100; |Y #nomcot02#73 [ 199;
          swUnoTC = 1;
     |FINSI;
     |SI #nomcot02#73 ] 300; |Y #nomcot02#73 [ 499;
          swUnoTC = 1;
     |FINSI;

     |SI swUnoTC = 1;
          || tambien puede ser un contrato a tiempo completo que cambie
          || a tiempo parcial, en este caso tiene que salir las horas en los
          || TP (o viceversa, si es viceversa ... ya lo veremos)

          |SI #nomcot02#73 ] 200; |Y #nomcot02#73 [ 299;
               swUnoTC = 0;
          |FINSI;
          |SI #nomcot02#73 ] 500; |Y #nomcot02#73 [ 599;
               swUnoTC = 0;
          |FINSI;
     |FINSI;

     || excepciones, posibilidad de un contrato 100 en que
     || tengan que salir las horas

     |SI #nomcot02#27 = "ETP"; |O #nomcot02#27 = "HTP";
     |O #labtraba#129 = "R"; |O #labtraba#129 = "T";
          swUnoTC = 0;
     |FINSI;

     || horrible, pero no puedo hacer otra cosa ahora mismo
     |SI #labtraba#7 = "47686280N   "; |Y #labtraba#1 = 4046;
     |Y nElMes = 4; |Y nElAny = 2020;
          swUnoTC = 0;
     |FINSI;
|FPRC;

|DEFBUCLE nomcot02;
     #nomcot02#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, 00001;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, 99999;
     be;
     NULL, nomcot02;
|FIN;

|PROCESO BorraTramos;
     |BORRA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|DEFBUCLE BorraTramos;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     be;
     NULL, BorraTramos;
|FIN;

|PROCESO CEC;
     |SI #0#0 ] 2018;
          swBuscaCEC = 1;
          swHayCEC = 0;
          |BUCLE nomcot02;
          |SI swHayCEC = 1;
               |BUCLE BorraTramos;
               swBuscaCEC = 0;
               swUnoTC = 0;
               |BUCLE nomcot02;
          |FINSI;
          swBuscaCEC = 0;
     |FINSI;

     |SI #0#0 = 2017;
          |ABRE #nomcot2x;
          #nomcot2x#0 = #labtraba#7;
          #nomcot2x#1 = aAny;
          #nomcot2x#2 = nMes;
          |LEE 000#nomcot2x.=;
          |SI FSalida = 0;
               |BUCLE BorraTramos;
               |BUCLE nomcot02;
          |FINSI;
          |CIERRA #nomcot2x;
     |FINSI;
|FPRC;

/****************************************************************************/
/******************* PROCESOS PARA LA CREACION DE TRAMS *********************/
/****************************************************************************/

|PROCESO control;
     |DDEFECTO #36; |ABRE #36; |LEE 000#36p;
     |CIERRA #36;

     |DDEFECTO #nomparam; |ABRE #nomparam; |LEE 000#nomparam.p;
     |CIERRA #nomparam;
|FPRC;

|PROCESO GrabaTramo52;
     #cretam04#6 = nLinea;
     |LEE 101#cretam04.=;

     #cretam04#8 = fFecha;
     #cretam04#9 = fFecha;
     swGraba = 0;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nCampo = ((nVez - 1) * 2) + 10;
          nCampo1 = nCampo + 1;
          |SI #cretam04#nCampo# = 102; |O #cretam04#nCampo# = 111;
               || tengo que hacer un tramo de UN dia con la prestacion
               || que es el dia que le he quitado a la enfermedad en
               || el ajuste mensual
               || sustituyo la 102 que hubiera por la 052
               || o la 111 por la 053

               |SI #cretam04#nCampo# = 102;
                    nCodTipo = 052;
                    aDesTipo = "PRES SC";
               |FINSI;
               |SI #cretam04#nCampo# = 111;
                    nCodTipo = 053;
                    aDesTipo = "PRES SC";
               |FINSI;
               #cretam04#nCampo# = nCodTipo;
               #cretam04#nCampo1# = aDesTipo;
               #cretam04#20 = nLinea;
               #cretam04#21 = nLinea;
               #cretam04#22 = 1;
               #cretam04#24 = 0;   || horas TP cotizables no hay en este dia
               #cretam04#26 = "S";
               |SI nCodTipo = 052;
                    #cretam04#27 = "ENF";
                    #cretam04#28 = #cretam04#28 + nDiasAcumIT;
               |FINSI;
               |SI nCodTipo = 053;
                    #cretam04#27 = "ACC";
               |FINSI;
               swGraba = nVez;
               |SAL;
          |FINSI;
     |SIGUE;

     swRegrabado = 0;
     |SI swGraba ] 1;
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nCampo = ((nVez - 1) * 2) + 10;
               nCampo1 = nCampo + 1;
               |SI #cretam04#nCampo# ! 102;
                    |SI #cretam04#nCampo# = 001; |O #cretam04#nCampo# = 999;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;
                    |SI #cretam04#nCampo# ] 100; |Y #cretam04#nCampo# [ 199;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;

                    |SI #cretam04#nCampo# = 052; |O #cretam04#nCampo# = 053;
                         |SI swRegrabado = 1;
                              #cretam04#nCampo# = 000;
                              #cretam04#nCampo1# = "";
                         |FINSI;
                    |FINSI;

                    |SI #cretam04#nCampo# = 000; |Y nVez [ swGraba;
                         #cretam04#nCampo# = nCodTipo;
                         #cretam04#nCampo1# = aDesTipo;
                         swGraba = 1;
                         swRegrabado = 1;
                    |FINSI;
               |SINO;
                    |SI swRegrabado = 1;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;
               |FINSI;
          |SIGUE;

          |SI #cretam04#25 = "S";
               || he grabado el tramo anteriormente por ser G8 - mensual
               |GRABA 020#cretam04.a;
          |SINO;
               |GRABA 020#cretam04.n;
          |FINSI;
     |FINSI;
     |LIBERA #cretam04;
|FPRC;

|PROCESO GrabaTramo51;
     #cretam04#6 = nLinea;
     /*
     || cambio sistema, las fechas no las cambio
     #cretam04#8 = fFecha;
     #cretam04#9 = fFecha;
     */
     |PARA nCampo = 10; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 2;
          |SI #cretam04#nCampo# = 000;
               nCampo1 = nCampo + 1
               #cretam04#nCampo# = 051;
               #cretam04#nCampo1# = "D-G8 SC";
               |SAL;
          |FINSI;
     |SIGUE;

     #cretam04#25 = "S";
     |SI nConstante = 515;
          #cretam04#25 = "N";
     |FINSI;
     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|PROCESO LeeLinAnt;
     swMarca52 = 0;
     |LEE 101#cretam04.a;
     |SI FSalida = 0;
     |Y #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
     |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;

          || primero busco si la linea anterior tenia prestacion

          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nNume = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nNume# = 102;
                    swMarca52 = 1;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI FSalida = 110;
          || si es la linea 1 del primer trabajador que se calcula
          || no ha de seguir
          |ACABA;
     |FINSI;

     || si resulta que si que la tenia, grabo en la linea siguiente
     || un concepto de prestacion para saberlo, asi sera mas facil hacer
     || el ajuste

     |LEE 101#cretam04.s;

     |SI swMarca52 = 1;
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nNume = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nNume# = 000; |Y #cretam04#nNume# ! 102;
                    #cretam04#nNume# = 102;
                    nNume1 = nNume + 1;
                    #cretam04#nNume1# = "PREST.";
                    |GRABA 020#cretam04.a;
                    |LIBERA 020#cretam04;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO AjusteLineaFeb;

|FPRC;

|PROCESO CamposMatERE_TP;
     || PARA MATERNIDAD
     |SI #labtraba#129 = "R";
          || mat. TP parte que se trabaja
          #cretam04#75 = #labtraba#1;
          #cretam04#77 = (#cretam04#22 * #labtraba#47) ! 0;
     |FINSI;
     |SI #labtraba#129 = "T";
          || mat. TP parte en IT
          #cretam04#78 = #labtraba#1;
          #cretam04#80 = (#cretam04#22 * #labtraba#47) ! 0;
     |FINSI;

     || PARA ERE
     |SI #labtraba#129 = "A";
          || ERE TP parte que se trabaja
          #cretam04#75 = #labtraba#1;
          #cretam04#77 = (#cretam04#22 * #labtraba#47) ! 0;
     |FINSI;
     |SI #labtraba#129 = "E";
          || ERE TP parte en IT
          #cretam04#78 = #labtraba#1;
          #cretam04#80 = (#cretam04#22 * #labtraba#47) ! 0;
     |FINSI;
|FPRC;

|PROCESO HorasFijosDisAtra;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
          |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
          |Y #labtraba#42 ! "X"; |Y #labtraba#42 ! "T";
          |Y #labtraba#42 ! "P";
               |ABRE #nomconca;
               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |CIERRA #nomconca;

               |SI #nomconca#162 = 0;
                    #nomconca#162 = 40;
               |FINSI;

               #labtraba#47 = (#nomconca#162 / 7) ! 2;
          |FINSI;
      |FINSI;
|FPRC;

|PROCESO AjusteLinea;
     nDiasAcumIT = 0;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nLineaAjuste;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          || me hace falta leer la linea anterior, ya que si vengo de una
          || prestacion, en los mensuales tengo que dejar el tramo del dia
          || que no cotiza pero si que cobra prestacion

          |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
               |HAZ LeeLinAnt;
          |FINSI;
          |SI #cretam04#8 = #cretam04#9;
               || es un tramo desde - hasta el mismo dia, lo tengo que borrar

               || cambio sistema

               #cretam04#72 = 1;
               || los dias cotizables los dejo ajustados
               #cretam04#22 = #cretam04#22 - nAjuste;
               |SI #cretam04#22 = 0;
                    #cretam04#24 = 0;
               |FINSI;
               |GRABA 020#cretam04.a;
               |LIBERA #cretam04;
          |SINO;
               || los dias cotizables los dejo ajustados
               #cretam04#22 = #cretam04#22 - nAjuste;
               || Horas tiempo parcial
               |SI #0#5 ! 02;
                    || horas en finiquitos no
                    swSigue = 0;
                    |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                    |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
                         swSigue = 1;
                    |FINSI;
                    |SI #labtraba#42 = "L"; |Y #labtraba#129 = "G"; |Y #labtraba#47 ! 0;
                         swSigue = 1;
                    |FINSI;
                    |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
                    |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
                         swSigue = 1;
                    |FINSI;
                    |SI #labtraba#42 = "A"; |Y #labtraba#129 = "R"; |Y #labtraba#47 ! 0;
                         swSigue = 1;
                    |FINSI;
                    |SI swSigue = 1;
                         |HAZ HorasFijosDisAtra;
                         nNume = #cretam04#22 * #labtraba#47;
                         |SI nNume > 0; |Y nNume < 0.49;
                              nNume = 1;     || una hora al menos
                         |FINSI;
                         |SI swTopeMin = 1;
                              nNume = nNume - 0.49;
                         |FINSI;
                         nNume = nNume ! 0;
                         |SI nNume = 0;      || repito: una hora al menos
                         |Y nHorasTPMant ! 0;
                              nNume = 1;
                         |FINSI;
                         #cretam04#24 = nNume;
                         |HAZ CamposMatERE_TP;
                    |FINSI;
               |FINSI;

               nDiasAcumIT = #cretam04#22;

               #cretam04#72 = 1;
               |GRABA 020#cretam04.a;
               |LIBERA #cretam04;
          |FINSI;

          || ahora el ajuste, primero compruebo los mensuales G8

          nLinea = nLineaAjuste
          |SI #cretam04#23 = "S";
          |Y topemes ! 30; |Y nDiasMesTrab = topemes;
               |HAZ GrabaTramo51;
          |FINSI;

          || y despues compruebo si tengo que grabar la linea de la prestacion
          || del dia de ajuste que no se cotiza

          || cambio sistema, esto se supone que no hay que hacerlo
          ||HAZ GrabaTramo52;
     |FINSI;
|FPRC;

|PROCESO CuentaDias;
     |SI #cretam04#27 ! "INA";
          nDias = nDias + #cretam04#22;
     |FINSI;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          |SI #cretam04#nNume# ! 000;
               |SI #cretam04#nNume# = 101; |O #cretam04#nNume# = 102;
               |O #cretam04#nNume# = 111;
               |O #cretam04#nNume# = 121; |O #cretam04#nNume# = 122;
               |O #cretam04#nNume# = 131; |O #cretam04#nNume# = 141;
               |O #cretam04#nNume# = 151; |O #cretam04#nNume# = 161;
               |O #cretam04#nNume# = 171;
               ||O #cretam04#nNume# = 191;
                    || inicio de IT
                    nUltimoTramoIT = #cretam04#6;
               |SINO;
                    swSigue = 0;

                    |SI #cretam04#nNume# = 001;
                         || alta desde inicio del periodo
                         swSigue = 1;
                    |FINSI;
                    |SI #cretam04#nNume# > 100; |Y #cretam04#nNume# < 199;
                         || fin de IT
                         swSigue = 1;
                    |FINSI;
                    |SI #cretam04#nNume# = 210; || busca comentario anterior
                                                || del 766.2272,
                         |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
                              swSigue = 1;
                         |FINSI;
                    |FINSI;

                    || cuidado con esto, esto se hizo por cierto çtiquet que
                    || provoco error en el ajuste de los mensuales con IT
/*
                    |SI #cretam04#nNume# = 001;
                         || alta desde inicio del periodo
                         |SI #cretam04#nNume# > 100; |Y #cretam04#nNume# < 199;
                              || fin de IT
                              swSigue = 1;
                         |FINSI;
                    |FINSI;
*/
                    |SI swSigue = 1;
                         nUltimoTramoAlta = #cretam04#6;

                         || esto por si en este tramo empiezo alta, y venia de
                         || enfermedad, en mensuales el tramo anterior es el ultimo
                         || en IT para ajustar

                         |SI #cretam04#nNume# = 109;
                         |O #cretam04#nNume# = 119; |O #cretam04#nNume# = 129;
                         |O #cretam04#nNume# = 139; |O #cretam04#nNume# = 149;
                         |O #cretam04#nNume# = 159; |O #cretam04#nNume# = 169;
                         |O #cretam04#nNume# = 179; |O #cretam04#nNume# = 199;
                         |O #cretam04#nNume# = 210;
                              nUltimoTramoIT = nLineaAnt;
                         |FINSI;
                    |SINO;
                         || inicio o fin de bonificaciones, indicadores de
                         || cambio de situacion

                         |SI nCodTipoAnt = 101; |O nCodTipoAnt = 102;
                         |O nCodTipoAnt = 111;
                         |O nCodTipoAnt = 121; |O nCodTipoAnt = 122;
                         |O nCodTipoAnt = 131; |O nCodTipoAnt = 141;
                         |O nCodTipoAnt = 151; |O nCodTipoAnt = 161;
                         |O nCodTipoAnt = 171;
                         ||O nCodTipoAnt = 191;
                              nUltimoTramoIT = #cretam04#6;
                         |SINO;
                              nUltimoTramoAlta = #cretam04#6;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || nLineaAnt = #cretam04#6;
               |SI nCodTipoAnt > 100; |Y nCodTipoAnt < 199;
                    aAlfa = nCodTipoAnt; |QBF aAlfa;
                    aAlfa = aAlfa % -101;
                    |SI aAlfa = 1; |Y #cretam04#nNume# = 40;
                         || el codigo anterior fue de inicio enfermedad
                         || y ademas le ha puesto lo de "Alta afiliacion SI"
                         || me quedo con que el tipo anterior fue el del inicio
                         || enfermedad ya que si no, al poner el 40, no lo
                         || toma en cuenta como el ultimo tramo de IT, cuando
                         || al iniciar tramo por bonificacion, si que lo es

                         || no actualizo nCodTipoAnt
                         || ejemplo tiquet 766.1712
                    |SINO;
                         nCodTipoAnt = #cretam04#nNume#;
                    |FINSI;
               |SINO;
                    nCodTipoAnt = #cretam04#nNume#;
               |FINSI;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     nLineaAnt = #cretam04#6;

     |SI #cretam04#86 = "A"; |Y aAntCot = "E";
          || cambio de agrario "E" a "A", no ajusto
          swNoAjuste = 1;
     |FINSI;

     || hasta que arreglemos esto
     |SI #cretam04#27 = "HUE"; |O #cretam04#27 = "HTP";
          swHuelga = 1;
     |FINSI;
     |SI #cretam04#27 = "ALT";
          swAlta = 1;
     |FINSI;
     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC"; |O #cretam04#27 = "MAT";
     |O #cretam04#27 = "PAT"; |O #cretam04#27 = "RIE";
     |O #cretam04#27 = "CON";
          swOtraIT = 1;
     |FINSI;

     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC"; |O #cretam04#27 = "MAT";
     |O #cretam04#27 = "PAT"; |O #cretam04#27 = "RIE";
          nDiasIT = nDiasIT + #cretam04#22;
     |FINSI;

     |SI #cretam04#86 = "M";
          |SI aAntCot = "X"; |Y nDiasIT ! 0;
               || cambio de TP a TC, si tiene IT durante el mes no ajusto
               || si no, si que hay que ajustar, ya que si paso de X-M a M-M
               || quiere decir que tengo que cotizar por 30 dias
               swNoAjuste = 1;
          |FINSI;
     |FINSI;

     aAntCot = #cretam04#86;

     |SI #cretam04#23 = "S";
     |Y topemes ! 30; |Y nDiasTrab = topemes;
     |Y nConstante ! 515;
          #cretam04#25 = "S";
          |GRABA 020#cretam04.a;
          |LIBERA #cretam04;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaDias;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, CuentaDias;
|FIN;

|PROCESO DiasAltaNIF;
     aAlfa = #labtraba#36;
     fFecha1 = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFecha2 = "31.12.2999";
     |SINO;
          fFecha2 = aAlfa;
     |FINSI;

     |SI fFecha2 < fFechaIniMes; |O fFecha1 > fFechaFinMes;
          || no ha estado de alta en el periodo que buscamos
     |SINO;
          nFecha1 = fFecha1;
          nFecha2 = fFecha2;

          |SI fFecha1 < fFechaIniMes;
               nFecha1 = nFechaIniMes;
          |FINSI;
          |SI fFecha2 > fFechaFinMes;
               nFecha2 = nFechaFinMes;
          |FINSI;
          nDiasAltaNIF = nDiasAltaNIF + (nFecha2 - nFecha1 + 1);

          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;

          |SI #labcentr#10 ! aAntCCC;
               nNroCCCs = nNroCCCs + 1;
          |FINSI;
          aAntCCC = #labcentr#10;
     |FINSI;
|FPRC;

|DEFBUCLE DiasAltaNIF;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, DiasAltaNIF;
|FIN;

|PROCESO AjusteMensual;
     nDias = 0;
     nUltimoTramoAlta = 0;
     nUltimoTramoIT = 0;
     nCodTipoAnt = 0;
     nLineaAnt = 0;
     nLineaAjuste = 0;
     swNoAjuste = 0;
     swHuelga = 0;
     swOtraIT = 0;
     swAlta = 0;
     aAntCot = "";
     nDiasIT = 0;

     |BUCLE CuentaDias;

     |SI swHuelga = 1; |Y swOtraIT = 0;
          || huelga sin otro tipo de IT, no ajusto, esto de momento
          || hasta que arreglemos los ajustes en huelga en nomina
          swNoAjuste = 1;
     |FINSI;
     |SI swHuelga = 1; |Y swOtraIT = 1; |Y swAlta = 1;
          nDiasCotAlta = nDiasCotAlta - 1;
     |FINSI;

     |SI #0#5 = 2;
          || ajustes en finiquitos no, evidentemente
          |ACABA;
     |FINSI;

     |SI swNoAjuste = 1;
          |ACABA;
     |FINSI;

     |SI nDias = topemes;
          |SI nUltimoTramoIT ! 0;
               |SI #labtraba#42 ! "X";
                    nLineaAjuste = nUltimoTramoIT;
               |SINO;
                    |ACABA;
                    || trabajadores X que esten el mes completo en alta
                    || con alguna IT, NO tienen ajuste
                    || en teoria aqui no deberia entrar, pero si tiene varios
                    || fichas, y la IT esta en una que no es la ultima, pues
                    || si que entra y cuenta un dia menos ya que ajusta
                    || ya que la variable que me dice si es un X-M que cotiza
                    || como diario del mantenimiento no me viene aqui cargada
                    || 4276.407
               |FINSI;
          |SINO;
               nLineaAjuste = nUltimoTramoAlta;
          |FINSI;
     |SINO;
          |SI fFechaIniMes [ fFechaAlta; |Y fFechaAlta [ fFechaFinMes;
               || alta este mes, de alta el mes completo entre todas sus fichas
               || estando en varios CCCs

               aNif = #labtraba#7;
               nDiasAltaNIF = 0;
               aAntCCC = "";
               nNroCCCs = 0;
               |SALVA_FICHA #labtraba;
               |BUCLE DiasAltaNIF;
               |REPON_FICHA #labtraba;

               |SI nDiasAltaNIF = topemes; |Y nNroCCCs > 1;
               ||SI nDias < 30; |Y nDiasCot < nDias;
                    || mensual, cotiza menos de 30 dias y menos de los dias
                    || que le corresponderian
                    || entonces asumo que el trabajador ha tenido otra
                    || ficha y que entre las dos han tenido 30 dias, pero que la
                    || otra estaba en otra empresa (cosas de Dany que inten-
                    || taremos controlar)

                    nLineaAjuste = nUltimoTramoAlta;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nDias = topemes;
          nAjuste = topemes - 30;
     |FINSI;
     |SI nElMes = 1; |O nElMes = 3; |O nElMes = 5;
     |O nElMes = 7; |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
          |HAZ AjusteLinea;
     |FINSI;
     |SI nElMes = 2;
          |HAZ AjusteLinea;
     |FINSI;
|FPRC;

|PROCESO labtraba;
     fFechaIniTramo = fFechaAlta;

     |SI aFechaBusca = #labtraba#37;

          nCodTipo = 000;
          aDesTipo = "";

          |QBF aAltaAfil;
          |SI aAltaAfil ! "";
               |SI aAltaAfil = "N";
                    || se fuerza a que NO se haga nuevo tramo
                    nCodTipo = 035;
                    aDesTipo = "S/T FORZ";
                    |HAZ GrabaTramo;
               |FINSI;
               |SI aAltaAfil = "S";
                    || me da igual el motivo, aunque no cambie nada
                    || se fuerza a que SI se haga nuevo tramo
                    nCodTipo = 040;
                    aDesTipo = "C/T FORZ";
                    #labtraba#45 = aContrato;     || para que no se grabe el antiguo
                                                  || en el grabatramo
                    |HAZ GrabaTramo;
               |FINSI;

               |ACABA;
          |FINSI;

          |SI aContrato ! #labtraba#45;
               nCodTipo = 005;
               #labtraba#45 = aContrato;     || para que no se grabe el antiguo
                                             || en el grabatramo
               aDesTipo = "CONTRATO";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nGrupoCot ! #labtraba#33;
               nCodTipo = 010;
               aDesTipo = "GRUPO COT";
               |HAZ GrabaTramo;
          |FINSI;
          aAlfa =
          |SI aOcupacion ! #labtraba#204;
               nCodTipo = 015;
               aDesTipo = "OCUPACION";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nHoras ! #labtraba#234;
               nCodTipo = 020;
               aDesTipo = "JORNADA";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nCategoria ! #labtraba#17;
               nCodTipo = 025;
               aDesTipo = "CATEGORIA";
               |HAZ GrabaTramo;
          |FINSI;

          |SI nCodTipo = 000;
               || ninguna causa aparente:
               || seran otros motivos que no requieren cambio de tramo
               nCodTipo = 030;
               aDesTipo = "OTROS S/T";
               |HAZ GrabaTramo;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, labtraba;
|FIN;

|PROCESO variaciones;
     aNif = #labtraba#7;
     |SI fFechaAlta > fFechaIniMes;
          || es porque he sido alta el dia 1 del periodo o despues, quiere
          || decir que puede que este mes haya sufrido alguna variacion
          || voy a buscar un trabajador que fuera baja el dia anterior
          || a la fecha de alta

          nNume = fFechaAlta;
          nNume = nNume - 1;
          fFechaBusca = nNume;
          aFechaBusca = fFechaBusca;

          aContrato = #labtraba#45;
          nGrupoCot = #labtraba#33;
          nCategoria = #labtraba#17;
          aOcupacion = #labtraba#204;
          nHoras = #labtraba#234;
          aAltaAfil = #labtraba#137;

          |SALVA_FICHA #labtraba;
          |BUCLE labtraba;
          |REPON_FICHA #labtraba;

          |SI nCodTipo ! 000;
               aAlfa = #labtraba#36;
               aAlfa = (aAlfa % 102)
               nLinea = aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cta_cotizacion;
     |DDEFECTO #labcentr;
     |ABRE #labcentr;
     swCentroFormacion = 0;
     aCCC = #labempre#13;          || cta.cot. de la empresa
     |SI #labtraba#45 = "085"; |O #labtraba#45 = "087"; |O #labtraba#45 = "097";
     |O #labtraba#45 = "421"; |O #labtraba#45 = "422";
          |DDEFECTO #nomcenes;
          |ABRE #nomcenes;
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = 87;
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aAlfa = #nomcenes#10;      || CCC del centro de trabajo especial
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;         || CCC del centro de trabajo especial
               |FINSI;

               aCentroNom = #nomcenes#2;
               swCentroFormacion = 1;

               || busco el caso de que el CCC del centro de formacion sea el
               || mismo que el de el centro, en este caso el trabajador va
               || en el centro "normal" y no de formacion

               #labcentr#0 = #labtraba#0;
               #labcentr#1 = #labtraba#77;
               |LEE 000#labcentr.=;
               |SI FSalida = 0;
                    aAlfa = #labcentr#10;      || cta.cot. centro de trabajo
                    |QBF aAlfa;
                    |SI aAlfa = aCCC;
                         aCentroNom = #labcentr#2;
                         swCentroFormacion = 0;
                    |FINSI;
               |FINSI;
          |SINO;
               #labcentr#0 = #labtraba#0;
               #labcentr#1 = #labtraba#77;
               |LEE 000#labcentr.=;
               |SI FSalida = 0;
                    aAlfa = #labcentr#10;
                    |QBF aAlfa;
                    |SI aAlfa ! "";
                         aCCC = aAlfa;
                    |FINSI;
                    aCentroNom = #labcentr#2;
               |FINSI;
          |FINSI;
          |CIERRA #nomcenes;
     |SINO;
          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
               aAlfa = #labcentr#10;      || cta.cot. centro de trabajo
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;
               |FINSI;
               aCentroNom = #labcentr#2;
          |FINSI;
     |FINSI;

     |QBF aCCC;
     |SI aCCC ! "";
          aCCC = ("00000000000" + aCCC) % -111;
     |FINSI;
     aAlfa = #labtraba#247;
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;
     |SI aCCC ! "";
          aCCC = aAlfa + aCCC;
     |FINSI;

     |CIERRA #labcentr;
|FPRC;

|PROCESO CodigoSituacion;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          nCodigo = #cretam04#nNume#;
          |SI nCodigo ! 000;
               nUltimoCodigo = #cretam04#nNume#;
          |FINSI;
          |SI nCodigo ] 100; |Y nCodigo [ 209;
               aAlfa = nCodigo;
               |QBF aAlfa;
               aAlfa = aAlfa % -101;
               |SI aAlfa = "1"; |O nCodigo = 102; |O nCodigo = 122;
                    || estoy en situacion especial

                    |SI nCodigo = 101; aSituacion = "ENF"; |FINSI;
                    |SI nCodigo = 102; aSituacion = "ENF"; |FINSI;
                    |SI nCodigo = 111; aSituacion = "ACC"; |FINSI;
                    |SI nCodigo = 121; aSituacion = "MAT"; |FINSI;
                    |SI nCodigo = 122; aSituacion = "MTP"; |FINSI;
                    |SI nCodigo = 131; aSituacion = "PAT"; |FINSI;
                    |SI nCodigo = 132; aSituacion = "PTP"; |FINSI;
                    |SI nCodigo = 141; aSituacion = "RIE"; |FINSI;
                    |SI nCodigo = 151; aSituacion = "ERE"; |FINSI;
                    |SI nCodigo = 161; aSituacion = "ETP"; |FINSI;
                    |SI nCodigo = 171; aSituacion = "CON"; |FINSI;
                    |SI nCodigo = 181; aSituacion = "ASR"; |FINSI;
                    |SI nCodigo = 191;
                         ||SI swHuelgaParcial = 0;
                         |SI #cretam04#87 ! 1; |Y #cretam04#87 ! 0;
                              aSituacion = "HTP";
                         |SINO;
                              aSituacion = "HUE";
                         |FINSI;
                    |FINSI;
                    |SI nCodigo = 201; aSituacion = "INA"; |FINSI;
                    |SAL;
                    nCodigoIniIT = nCodigo;
               |SINO;
                    aSituacion = "ALT";
                    nCodigoFinIT = nCodigo;
               |FINSI;
          |SINO;
               aSituacion = "ALT";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaSituacion;
     aSituacion = "";
     nCodigoIniIT = 0;
     nCodigoFinIT = 0;
     |HAZ CodigoSituacion;
     swSigue = 0;
     |SI nUltimoCodigo ] 400; |Y nUltimoCodigo [ 499;
          swSigue = 1;
          ||SI aSituacion = ""; |O aSituacion = "ALT";
          |SI nCodigoIniIT ! 0;
               swSigue = 1;
          |FINSI;
          |SI nCodigoFinIT ! 0;
          |Y fFechaBaja ! #cretam04#9; || 2884.3627 trab. em mat, baja el 19
                                        || y fin bonif el 18, se graba en el
                                        || mismo tramo la situacion 129 FIN MAT
                                        || y 409 FIN BON, con esto evito que
                                        || el ultimo tramo me lo cree con ALT
                                        || en lugar de con MAT
                                        || no me atrevo a quitar la condicion
                                        || de SI nCodigoFinIT ! 0;
               swSigue = 0;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          || esto es para que al poner la bonificacion se mantenga la situacion
          || del tramo anterior, pero puede ser que en este tramo inicie
          || situacion nueva, por ejemplo cuando acaba o empieza bonificacion
          || a la vez que empieza o acaba maternidad

          || solo me voy a buscar el codigo del tramo anterior si no tengo
          || situacion o tengo "ALT" que es lo mismo.

          |SALVA_FICHA #cretam04;
          |LEE 101#cretam04.a;
          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 = nTra;
          |Y FSalida = 0;
               |HAZ CodigoSituacion;
               |SI nUltimoCodigo ] 400; |Y nUltimoCodigo [ 499;
                    || esto es por el caso que que tenga una bonif que empieza
                    || y acaba durante una maternidad 1714.1015
                    |LEE 101#cretam04.a;
                    |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
                    |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
                    |Y #cretam04#7 = nTra;
                    |Y FSalida = 0;
                         |HAZ CodigoSituacion;
                    |FINSI;
               |FINSI;
          |FINSI;
          |REPON_FICHA #cretam04;
     |FINSI;
|FPRC;

|PROCESO Calendario;
     |ABRE #gomdetjr;
     #gomdetjr#0 = #cretam04#0;
     #gomdetjr#1 = #cretam04#7;
     #gomdetjr#2 = nAnyLote;
     #gomdetjr#3 = #cretam04#2;
     |LEE 000#gomdetjr.=;

     |SI FSalida = 0;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               nDia = nCampo - 3;
               |SI nDesde [ nDia; |Y nDia [ nHasta;
                    |SI #gomdetjr#nCampo# = "X";
                         nJornadasTramo = nJornadasTramo + 1;
                    |FINSI;
                    |SI #gomdetjr#nCampo# = "I";
                         nJornadasTramoIT = nJornadasTramoIT + 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #gomdetjr;
|FPRC;

|PROCESO GrabaUnionTramo;
     #cretam04#9 = fFecha;

     aFechaIniTramo = #cretam04#8;
     aFechaFinTramo = #cretam04#9;
     aAlfa = aFechaIniTramo % 102;
     #cretam04#20 = aAlfa;
     aAlfa = aFechaFinTramo % 102;
     #cretam04#21 = aAlfa;
     nFechaIniTramo = #cretam04#8;
     nFechaFinTramo = #cretam04#9;

     #cretam04#22 = nFechaFinTramo - nFechaIniTramo + 1;

     || Irregulares
     |SI #labtraba#42 = "I"; |O #labtraba#42 = "P";
          |SI swIntervalos = 0;
               || ojo en trabajadores que usan el nomintal no que se rompen
               #cretam04#22 = (nDiasCot * (#cretam04#22 / (nDiasMesTrab - nDiasHue))) ! 0;
               || esto no va a funcionar si hay IT, pero de momento lo dejare asi
          |FINSI;
     |FINSI;

     || Mensual grupo 8
     |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "D";
     |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
     |Y #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
          || no en los contratos a tiempo parcial
          || ni en los diarios claro

          || 10.02.2016 En los contratos a TP X-M SI QUE SE PONE tambien

          |SI #labtraba#45 ! "421"; |Y #labtraba#45 ! "422";
               || no en los contratos de formacion
               |SI #labtraba#33 ] 8;
                    #cretam04#23 = "S";
               |FINSI;
          |FINSI;
     |FINSI;

     || Horas tiempo parcial
     |SI #0#5 ! 02;
          || horas en finiquitos no
          swSigue = 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               swSigue = 1;
          |FINSI;
          |SI #labtraba#42 = "L"; |Y #labtraba#129 = "G"; |Y #labtraba#47 ! 0;
               swSigue = 1;
          |FINSI;
          |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
          |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               swSigue = 1;
          |FINSI;
          |SI #labtraba#42 = "A"; |Y #labtraba#129 = "R"; |Y #labtraba#47 ! 0;
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1;
               |HAZ HorasFijosDisAtra;
               nNume = #cretam04#22 * #labtraba#47;
               |SI swTopeMin = 1;
                    nNume = nNume - 0.49;
               |FINSI;
               |SI nNume > 0; |Y nNume < 0.49;
                    nNume = 1;     || una hora al menos
               |FINSI;
               nNume = nNume ! 0;
               #cretam04#24 = nNume;

               |SI swTopeMin = 1;
                    || ajustes para horas en los TP topeados
                    nHorasTPAcum = nHorasTPAcum + #cretam04#24;
                    nDiff = nHorasTPAcum - nHorasTPMant;
                    |SI -1 [ nDiff; |Y nDiff [ 1;
                         #cretam04#24 = #cretam04#24 - nDiff;
                    |FINSI;
               |FINSI;

               |HAZ CamposMatERE_TP;
          |FINSI;
     |FINSI;

     |HAZ GrabaSituacion;
     #cretam04#27 = aSituacion;
     |SI #labtraba#42 = "E";
          |SI #cretam04#27 = "ALT";
               nJornadasTramo = 0;
               nDesde = #cretam04#6;
               nHasta = #cretam04#21;
               |HAZ Calendario;
               #cretam04#83 = nJornadasTramo;
          |FINSI;
          |SI #cretam04#27 ! "ALT"; |Y #cretam04#27 ! "ENF";
               || porque la enfermedad ya se ha grabado antes
               nJornadasTramo = 0;
               nJornadasTramoIT = 0;
               nDesde = #cretam04#6;
               nHasta = #cretam04#21;
               |HAZ Calendario;
               #cretam04#83 = nJornadasTramoIT;
          |FINSI;
          |SI #0#5 = 2;
               || por salir del paso
               #cretam04#83 = nDiasVac1;
               nJornadas = nDiasVac1;
          |FINSI;
     |FINSI;

     || trabajadores mensuales con GC 08 en adelante, llevan el indicativo
     || 51-M siempre, en principio lo poniamos solo en el tramo donde se
     || realizaba el ajuste, ahora lo llevan siempre (solo en meses que NO
     || sean de 30 dias claro)

     |SI #cretam04#23 = "S";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
     |Y nConstante ! 515;
          #cretam04#25 = "S";
     |FINSI;

     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|PROCESO huelga_ultdia;
     |SI #nomabsli#3 = fFechaFinPer;
          swUltimoDiaIT = 1;
     |FINSI;
|FPRC;

|DEFBUCLE huelga_ultdia;
     #nomabsli#1;
     4;
     nEmp, nTra, fFechaIniMes, "H";
     nEmp, nTra, fFechaFinMes, "H";
     ;
     NULL, huelga_ultdia;
|FIN;

|PROCESO UltimoDiaIT;
     |SI #0#5 = 2;
          |ACABA;
     |FINSI;

     aAlfa = fFechaFinPer;
     aAlfa = aAlfa % 102;
     nNume = aAlfa;

     |SI #0#3 = "M";
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #nomcalca#nCampo#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo1 = nCampo - 4;
                    |SI #nomcalca#nCampo1# = 0; |O #nomcalca#nCampo1# = nNume;
                         swUltimoDiaIT = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #0#3 = "A";
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #nomcalac#nCampo#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo1 = nCampo - 4;
                    |SI #nomcalac#nCampo1# = 0; |O #nomcalac#nCampo1# = nNume;
                         swUltimoDiaIT = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #0#3 = "H"; |O #0#3 = "T";
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #nomhicca#nCampo#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo1 = nCampo - 4;
                    |SI #nomhicca#nCampo1# = 0; |O #nomhicca#nCampo1# = nNume;
                         swUltimoDiaIT = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |BUCLE huelga_ultdia;
|FPRC;

|PROCESO BuscaITPenultimoDia;
     || este proceso es para cubrir los casos tipo Del 1 al 30 IT y del
     || 31 al 31 ALTA, para que cree los dos tramos que tiene que crear
     || ya que en ese caso creo en el dia 31 la 999 y la 109

     || PERO SOLO si el ultimo dia realmente no estoy de IT porque en una
     || IT en que soy baja en la empresa el dia 14, si estoy los 14 dias
     || de IT, tambien creo la ultima linea con el dia 14 con la 999 y la 109
     || asi que en caso de ser IR el ultimo dia no tengo que hacer esto

     swUltimoDiaIT = 0;
     |HAZ UltimoDiaIT;

     swIniPeriodo = 0;
     swFinPeriodo = 0;

     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nCampo = ((nVez - 1) * 2) + 10;
          nCodigo = #cretam04#nCampo#;
          |SI nCodigo = 001;
               swIniPeriodo = 1;
          |FINSI;
          |SI nCodigo = 999;
               swFinPeriodo = 1;
          |FINSI;
          swSigue = 0;
          |SI nCodigo = 109; |O nCodigo = 119; |O nCodigo = 129;
          |O nCodigo = 139; |O nCodigo = 149; |O nCodigo = 159;
          |O nCodigo = 169; |O nCodigo = 179; |O nCodigo = 199;
          |O nCodigo = 209;
               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || esto es lo mismo pero para otro caso:
          || todo el mes de alta y el ultimo dia y el ultimo dia
          || empiezo IT
          |SI nCodigo = 101; |O nCodigo = 111; |O nCodigo = 121; |O nCodigo = 122;
          |O nCodigo = 131; |O nCodigo = 141; |O nCodigo = 151;
          |O nCodigo = 161; |O nCodigo = 171; |O nCodigo = 191;
               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 1;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || ultimo comienzo inactividad, citricos, no lo estabamos contemplando
          |SI nCodigo = 201;
               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || nuevo caso que hace que no haya que borrar el tramo
          || febrero, comienzo una IT o el tramo de prestaciones de una IT
          || el dia 28, me borraba el tramo al ser el ultimo porque pensaba
          || que no tenia que estar, no es correcto

          || 26.05.2015 Bueno asi estaba antes, pero es que no tiene que ser
          || solo en febrero. Si un mes cualquiera un trab. es baja el dia
          || 19 por ejemplo, y ese dia es el dia 16 de la IT (porque empezo
          || el 4 por ejemplo), no salia tampoco y tiene que salir ese ultimo
          || dia como tramo para la prestacion

          |SI nCodigo = 102;
               aAlfa = fFechaIniTramo;
               aAlfa = aAlfa % 102;
               nNume = aAlfa;

               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 1;
                    |||SI nMes = 2; |Y #cretam04#6 = nNume;
                    || quito lo del febrero
                    ||SI #cretam04#6 = nNume;
                    || esta condicion no entiendo por que esta, la quito
                    || por el tiquet 1243.3237
                         swSigue = 1;
                    ||FINSI;
               |FINSI;
          |FINSI;

          || tambien cuando tenemos fecha de fin de bonificacion el penultimo
          || dia, no solo con IT, que esto tambien provoca tramo nuevo
          || tambien para cmabio de tramo el ultimo dia

          |SI nCodigo = 409; |O nCodigo = 405; |O nCodigo = 419;
               aAlfa = fFechaIniTramo;
               aAlfa = aAlfa % 102;
               nNume = aAlfa;

               |SI swFinPeriodo = 1;
                    |SI #cretam04#6 = nNume;
                         swSigue = 1;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI swSigue = 1;
               swFinPeriodo = 2;
               fFecha = #cretam04#8;
               |HAZ GrabaUnionTramo;

               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;
               |SALVA_FICHA #cretam04;
               |LEE 101#cretam04.a;
               |SI FSalida = 0;
               |Y #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
               |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
                    |HAZ GrabaUnionTramo;
               |FINSI;

               || para que pase como ultimo dia del periodo anterior
               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;

               |REPON_FICHA #cretam04;

               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Tramo99;
     |SI nMes98 = 0;
          aAlfa1 = "01";
          aAlfa2 = nMes99; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
          aAlfa3 = nAny99;
          aFechaIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

          aAlfa1 = nDiasVac2; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
          aFechaFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

          #cretam04#8 = aFechaIniPer;
          #cretam04#9 = aFechaFinPer;

          #cretam04#10 = 001;
          #cretam04#11 = "INI PERIODO";
          #cretam04#12 = 999;
          #cretam04#13 = "FIN PERIODO";

          #cretam04#20 = 01;
          #cretam04#21 = nDiasVac2;
          #cretam04#22 = nDiasVac2;
          #cretam04#27 = "ALT";

          #cretam04#7 = #labtraba#1;
          #cretam04#29 = #labtraba#2;
          #cretam04#70 = aFechaIniPer;
          #cretam04#71 = aFechaFinPer;
          #cretam04#73 = nContrato;
          #cretam04#86 = aClaveCot;

          |GRABA 020#cretam04.n;
          |LIBERA #cretam04;
     |SINO;
          nDiasVac3 = nDiasVac2 - topemes99;
          |PARA nTramo99 = 1; |SI nTramo99 [ 2; |HACIENDO nTramo99 = nTramo99 + 1;
               |SI nTramo99 = 1;
                    aAlfa1 = "01";
                    aAlfa2 = nMes98; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                    aAlfa3 = nAny98;
                    aFechaIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

                    aAlfa1 = topemes99; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
                    aFechaFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
               |FINSI;
               |SI nTramo99 = 2;
                    aAlfa1 = "01";
                    aAlfa2 = nMes99; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                    aAlfa3 = nAny99;
                    aFechaIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

                    aAlfa1 = nDiasVac3; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
                    aFechaFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
               |FINSI;
               |SI nTramo99 = 1;
                    #cretam04#6 = 98;
               |FINSI;
               |SI nTramo99 = 2;
                    #cretam04#6 = 99;
               |FINSI;
               #cretam04#8 = aFechaIniPer;
               #cretam04#9 = aFechaFinPer;

               #cretam04#10 = 001;
               #cretam04#11 = "INI PERIODO";
               #cretam04#12 = 999;
               #cretam04#13 = "FIN PERIODO";

               #cretam04#20 = 01;
               |SI nTramo99 = 1;
                    #cretam04#21 = topemes99;
                    #cretam04#22 = topemes99;
               |FINSI;
               |SI nTramo99 = 2;
                    #cretam04#21 = nDiasVac3;
                    #cretam04#22 = nDiasVac3;
               |FINSI;
               #cretam04#27 = "ALT";

               #cretam04#7 = #labtraba#1;
               #cretam04#29 = #labtraba#2;
               #cretam04#70 = aFechaIniPer;
               #cretam04#71 = aFechaFinPer;
               #cretam04#73 = nContrato;
               #cretam04#86 = aClaveCot;

               |GRABA 020#cretam04.n;
               |LIBERA #cretam04;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO GrabaTramo99;
     |DDEFECTO #cretam04;
     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = 99;
     |LEE 101#cretam04.=;
     FEstado = FSalida;

     |SI FEstado = 0;    || existe
     |Y #cretam04#7 ! nTra;   || es el otro trabajador que habia grabado

          || es uno de esos casos de trabajador duplicado, borro el tramo
          || que existia para que no haya lio, en principio se quedara con
          || el ultimo y ya esta, el auxiliar cretam06 hara el resto

          |BORRA 020#cretam04.a;
          |DDEFECTO #cretam04;

          || vuelvo a cargar los valroes de la clave

          #cretam04#0 = nEmp; #cretam04#1 = nAny; #cretam04#2 = nMes;
          #cretam04#3 = nTipo; #cretam04#4 = aCCC; #cretam04#5 = aNAFSS;
          #cretam04#6 = 99;
     |FINSI;

     nMes99 = nMes + 1;
     |SI nMes99 = 13;
          nMes99 = 1;
          nAny99 = nAny + 1;
     |SINO;
          nAny99 = nAny;
     |FINSI;

     || en el caso de que tenga mas dias de vacaciones de los que caben en el
     || mes siguiente al de la liquidacion, uso nMes98 y nAny98 para los
     || dias del mes siguiente y nMes99 y nAny99 para el otro
     || consultar 5127.500, es raro pero se ha dado ya

     nMes98 = 0;
     nAny98 = 0;
     |HAZ topemes99;
     |SI nDiasVac2 > topemes99;
          nMes98 = nMes99;
          nAny98 = nAny99;

          nMes99 = nMes99 + 1;
          |SI nMes99 = 13;
               nMes99 = 1;
               nAny99 = nAny99 + 1;
          |SINO;
               nAny99 = nAny99;
          |FINSI;
     |FINSI;

     |HAZ Tramo99;
|FPRC;

|PROCESO UltimaLinea;
     nUltima = #cretam04#6;
|FPRC;

|DEFBUCLE UltimaLinea;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     ;
     NULL, UltimaLinea;
|FIN;

|PROCESO DosFichasSinRuptura;
     || lo primero es ver en cual se ha quedado ahora la ultima linea
     |BUCLE UltimaLinea;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nUltima;
     |LEE 101#cretam04.=;

     swSigue = 0;

     |PARA nCampo = 10; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 2;
          |SI #cretam04#nCampo# ! 000;
               |SI #cretam04#nCampo# = 025; |O #cretam04#nCampo# = 030;
               |O #cretam04#nCampo# = 035;
                    swSigue = 1;
               |SINO;
                    |SI #cretam04#nCampo# ! 001; |Y #cretam04#nCampo# ! 999;
                         swSigue = 0;
                         |SAL;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     |SI swSigue = 1;
          nEmp = #cretam04#0;
          nAny = #cretam04#1;
          nMes = #cretam04#2;
          nTipo = #cretam04#3;
          aCCC = #cretam04#4;
          aNAFSS = #cretam04#5;
          nDiaDesde = #cretam04#6;
          nDiaHasta = #cretam04#21;
          fFechaHastaTra = #cretam04#9;
          fFechaHastaPer = #cretam04#71;
          nDias = #cretam04#22;

          |DDEFECTO #cretat04;

          |PARA nCampo = 30; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 1;
               #cretat04#nCampo# = #cretam04#nCampo#;
          |SIGUE;

          |LEE 101#cretam04.a;

          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 ! nTra;
               || este es el tramo con el que lo tendre que unir
               nDiaHastaMasUno = #cretam04#21 + 1;
               |SI nDiaHastaMasUno = nDiaDesde;
                    || el dia desde del segundo trab (en el que se cambia la
                    || categoria) es igual que el dia hasta del primero
                    || entonces si que hago la union de los dos tramos
                    #cretam04#21 = nDiaHasta;
                    #cretam04#22 = #cretam04#22 + nDias;
                    #cretam04#9 = fFechaHastaTra;
                    #cretam04#71 = fFechaHastaPer;

                    aAlfa = nTra;
                    |QBF aAlfa;
                    aAlfa = ("00000" + aAlfa) % -105;
                    aAlfa1 = #cretam04#85;
                    |QBF aAlfa1;
                    #cretam04#85 = aAlfa1 + aAlfa;

                    || ahora tengo que sumar las bases del segundo a las del
                    || primero

                    |PARA nCampo1 = 30; |SI nCampo1 [ 49; |HACIENDO nCampo1 = nCampo1 + 2;
                         nCampo2 = nCampo1 + 1;
                         |SI #cretam04#nCampo1# = #cretat04#nCampo1#;
                              #cretam04#nCampo2# = #cretam04#nCampo2# + #cretat04#nCampo2#;
                         |FINSI;
                    |SIGUE;
                    |PARA nCampo1 = 60; |SI nCampo1 [ 69; |HACIENDO nCampo1 = nCampo1 + 2;
                         nCampo2 = nCampo1 + 1;
                         |SI #cretam04#nCampo1# = #cretat04#nCampo1#;
                              #cretam04#nCampo2# = #cretam04#nCampo2# + #cretat04#nCampo2#;
                         |FINSI;
                    |SIGUE;

                    |GRABA 020#cretam04.a;
                    |LIBERA #cretam04;

                    |LEE 020#cretam04.s;
                    |BORRA 020#cretam04.a;
                    |LIBERA #cretam04;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cretam04ERE;
     |SI #0#3 = "M"; |O #0#3 = "H";
     |O #0#3 = "A"; |O #0#3 = "T";
          |SI #cretam04#27 ! "ENF";
               || solo para ENF y ERE en principio

               || En atrasos no, en atrasos lo permito ya que quiero que entre
               || para cuando es ERE a TP (pero con la parte trabajada en ALTA
               || y no en ENF, bueno esto a ver como sale, es del 21.03.2017
               || 4413.131, para que salgan bien las horas en el tramo
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #cretam04#27 = "ENF";
          nDiasEnfMes = nDiasEnfMes + #cretam04#22;
     |FINSI;
     nDesdeTramo = #cretam04#20;
     nHastaTramo = #cretam04#21;

     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo - 8;
          nCampo2 = nCampo - 4;
          |SI #0#3 = "M";
               aTipo = #nomcalca#nCampo#; nDesde = #nomcalca#nCampo1#;
               nHasta = #nomcalca#nCampo2#;
          |FINSI;
          |SI #0#3 = "H"; |O #0#3 = "T";
               aTipo = #nomhicca#nCampo#; nDesde = #nomhicca#nCampo1#;
               nHasta = #nomhicca#nCampo2#;
          |FINSI;
          |SI #0#3 = "A";
               aTipo = #nomcalac#nCampo#; nDesde = #nomcalac#nCampo1#;
               nHasta = #nomcalac#nCampo2#;
          |FINSI;
          |SI aTipo = "D";
               |SI nDesdeTramo ] nDesde; |O nHastaTramo [ nHasta;
                    #cretam04#88 = nPropERE;
                    |GRABA 020#cretam04.a;
                    |LIBERA #cretam04;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE cretam04ERE;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     be;
     NULL, cretam04ERE;
|FIN;

|PROCESO EreTPEnf;
     nDiasEnfMes = 0;
     |BUCLE cretam04ERE;
|FPRC;

|PROCESO union;
     fFecha = "01.01.0000";
     nHorasTPAcum = 0;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nUltima;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          fFecha = #cretam04#9;
          nCodTipo = #cretam04#10;
          |SI fFecha = "01.01.0000";
               |HAZ BuscaITPenultimoDia;
               swTramoUnSoloDia = 0;
               |SI swIniPeriodo = 1; |Y swFinPeriodo = 1;
                    ||SI nUltima = 1; |O nUltima = topemes;
                         swTramoUnSoloDia = 1;    || esto es para detectar
                                                  || tramos de un solo dia
                    ||FINSI;
               |FINSI;
               |SI swFinPeriodo = 2;
                    || no hagas nada, ya esta hecho
               |SINO;
                    |SI swTramoUnSoloDia = 1;
                         || un solo dia de alta, no me lo borres
                         nFecha = #cretam04#8;
                         fFecha = nFecha;
                    |SINO;
                         fFecha = #cretam04#8;
                         |BORRA 020#cretam04.a;
                    |FINSI;
               |FINSI;
          |SINO;
               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;
          |FINSI;

          |LEE 101#cretam04.a;
          |SI swTramoUnSoloDia = 1;
               || un solo dia de alta en el mes, el dia 1
               || hago esto para que grabe resto de campos del unico tramo
               |SI FSalida = 0;
                    |LEE 101#cretam04.s;
               |SINO;
                    |SI FSalida = 110;              || por si era el primero de todos
                         |LEE 101#cretam04.p;
                    |FINSI;
               |FINSI;
          |FINSI;

          |PARA;
          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 = nTra;
          |Y FSalida = 0;
          |HACIENDO;
               |SI #cretam04#9 = "01.01.0000";
                    |SI swIntervalos = 1;
                         |SI #cretam04#10 ! 999;
                              |SI #cretam04#10 = 001; |Y #cretam04#12 = 999;
                                   || tramo de inicio-final es el mismo
                                   nFecha = #cretam04#8;
                                   fFecha = nFecha;
                              |FINSI;
                              || no hagas nada
                              |HAZ GrabaUnionTramo;
                              nFecha = #cretam04#8;
                              fFecha = nFecha;
                         |SINO;
                              nFecha = #cretam04#8;
                              fFecha = nFecha;
                              |BORRA 020#cretam04.a;
                              |LIBERA #cretam04;
                         |FINSI;
                    |SINO;
                         |HAZ GrabaUnionTramo;
                         nFecha = #cretam04#8;
                         nFecha = nFecha - 1;
                         fFecha = nFecha;
                    |FINSI;
               |FINSI;
               |LEE 101#cretam04.a;
          |SIGUE;
     |FINSI;

     |SI #0#5 = 2; |Y nDiasVac2 ! 0;
          |HAZ GrabaTramo99;
     |FINSI;

     |SI swIplabor2 = 1;
          |SI nDiasERE ! 0; |Y nPropERE ! 100;
               |HAZ EreTPEnf;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CodigoTiposEnf;
     nCodTipo = 000;
     aDesTipo = "";
     |SI aTipo = "E"; nCodTipo = 01; aDesTipo = "ENF"; |FINSI;
     |SI aTipo = "A"; nCodTipo = 11; aDesTipo = "ACC"; |FINSI;
     |SI aTipo = "M";
          |SI #labtraba#129 ! "T";
               nCodTipo = 21;
               aDesTipo = "MAT";
          |SINO;
               nCodTipo = 22;
               aDesTipo = "MTP";
          |FINSI;
     |FINSI;
     |SI aTipo = "P";
          |SI #labtraba#129 ! "T";
               nCodTipo = 31;
               aDesTipo = "PAT";
          |SINO;
               nCodTipo = 32;
               aDesTipo = "PTP";
          |FINSI;
     |FINSI;
     |SI aTipo = "R"; nCodTipo = 41; aDesTipo = "RIE"; |FINSI;
     |SI aTipo = "D";
          |SI swAginom = 1;
               |SI #labtraba#129 ! "E";
                    nCodTipo = 51;
                    aDesTipo = "ERE";
               |SINO;
                    nCodTipo = 61;
                    aDesTipo = "ETP";
               |FINSI;
          |SINO;
               |SI nPropERE = 100;
                    nCodTipo = 51;
                    aDesTipo = "ERE";
               |SINO;
                    nCodTipo = 61;
                    aDesTipo = "ETP";
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aTipo = "C"; nCodTipo = 71; aDesTipo = "CON"; |FINSI;
     |SI aTipo = "S"; nCodTipo = 81; aDesTipo = "ASR"; |FINSI;
     |SI aTipo = "H";
          nCodTipo = 91;
          |SI swHuelgaParcial = 0;
               aDesTipo = "HUE";
          |SINO;
               aDesTipo = "HTP";
          |FINSI;
     |FINSI;
     |SI swDesde = 1;
          nCodTipo = nCodTipo + 100;
          aDesTipo = "INI " + aDesTipo;
     |FINSI;
     |SI swHasta = 1;
          nCodTipo = nCodTipo + 108;
          aDesTipo = "FIN " + aDesTipo;
     |FINSI;
     |SI swPrest = 1;
          ||SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               nCodTipo = nCodTipo + 101;
               aDesTipo = "PREST. " + aDesTipo;
          ||FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaITAgrJor;
     swEncontrada = 0;
     nJornadas_A = 0;
     nJornadas_B = 0;
     |ABRE #gomdesjr;
     #gomdesjr#0 = #labtraba#0;
     #gomdesjr#1 = #labtraba#1;
     #gomdesjr#2 = #0#0;
     #gomdesjr#3 = nMes;
     #gomdesjr#4 = 00;
     |LEE 000#gomdesjr.=
     |SI FSalida = 0;
          nCampoAGR = ((nNroIT - 1) * 10) + 5;
          |SI aTipo = "E";
          |Y aTipo = #gomdesjr#nCampoAGR#;
               nCampoA = nCampoAGR + 5;
               nCampoB = nCampoAGR + 6;
               nJornadas_A = #gomdesjr#nCampoA#;
               nJornadas_B = #gomdesjr#nCampoB#;
               swEncontrada = 1;
          |FINSI;
     |FINSI;
     |SI swEncontrada ! 1;
          |SI aTipo = "E";
               swPrest = 0;
               nJornadas_A = nJornadasIT;
               nJornadas_B = 0;
          |SINO;
               || accidente o maternidad o ERE
               nJornadas_B = nJornadasIT;
               swPrest = 1;
          |FINSI;
     |FINSI;

     |CIERRA #gomdesjr;
|FPRC;

|PROCESO GrabaTramo;
     |SI nTipo = 2;
          |SI nDiasVac1 = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI swTrabMatTP = 2; |Y nCodTipo = 999;
          |ACABA;
     |FINSI;
     |SI swTrabERETP = 2; |Y nCodTipo = 999;
          |ACABA;
     |FINSI;
     |SI swAginom = 1;
          |SI swTrabERETP = 2; |Y nCodTipo = 169;
               |ACABA;
          |FINSI;
     |FINSI;

     |DDEFECTO #cretam04;

     aFechaIniTramo = fFechaIniTramo;
     aLinea = aFechaIniTramo % 102;
     nLinea = aLinea;

     swSigue = 0;
     aAlfa = nCodTipo; |QBF aAlfa; aAlfa = aAlfa % -101;
     |SI aAlfa = "9"; |Y nCodTipo ! 999;     || antes solo estaba asi
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          |SI nCodTipo = 210; || a raiz del 766.2272, combinacion de agrario
               swSigue = 1;   || mensual, tramo de cot. emp, sin prestaciones,
          |FINSI;             || sin esto, el dia de fin del ultimo tramo de
     |FINSI;                  || IT salia un dia antes
     |SI swSigue = 1;
          |SI nLinea ! topemes;
               nFechaIniTramo = fFechaIniTramo;
               nFechaIniTramo = nFechaIniTramo + 1;
               fFechaIniTramo = nFechaIniTramo;

               |SI fFechaIniTramo > fFechaFinPer;
                    || se da cuando tenemos una bonif que acaba el mismo
                    || dia que el trabajador es baja, no puedo hacer otro
                    || tramo

                    nFechaIniTramo = nFechaIniTramo - 1;
                    fFechaIniTramo = nFechaIniTramo;
               |FINSI;
          |FINSI;
     |FINSI;

     aFechaIniTramo = fFechaIniTramo;
     aLinea = aFechaIniTramo % 102;
     nLinea = aLinea;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nLinea;
     |LEE 101#cretam04.=;
     FEstado = FSalida;

     |SI FEstado = 0;    || existe
     |Y nCodTipo = 001;  || tramo inicial
     |Y #cretam04#7 ! nTra;   || es el otro trabajador que habia grabado
     |Y #cretam04#75 = 0;   || y no es mat/pat/ere a tp

          || es uno de esos casos de trabajador duplicado, borro el tramo
          || que existia para que no haya lio, en principio se quedara con
          || el ultimo y ya esta, el auxiliar cretam06 hara el resto

          |BORRA 020#cretam04.a;
          |DDEFECTO #cretam04;
          FEstado = 111;

          || vuelvo a cargar los valroes de la clave

          #cretam04#0 = nEmp; #cretam04#1 = nAny; #cretam04#2 = nMes;
          #cretam04#3 = nTipo; #cretam04#4 = aCCC; #cretam04#5 = aNAFSS;
          #cretam04#6 = nLinea;
     |FINSI;

     #cretam04#7 = nTra;
     #cretam04#8 = fFechaIniTramo;

     |SI #labtraba#129 = "T"; |O #labtraba#129 = "R";
          |SI #cretam04#75 ! 00000; |O #cretam04#78 ! 00000;
               || quiere decir que es un trabajador con Mat/Pat a TP, del que
               || ya he grabado el primero, este es el segundo, tiene un
               || tratamiento especial

               || primero le grabo el campo del codigo de trab y horas si lo
               || tenia vacio

               |HAZ CamposMatERE_TP;

               || grabo el codigo como 00000, queda marcado como una IT a TP
               #cretam04#7 = 00000;
               swTrabMatTP = 2;
          |SINO;
               swTrabMatTP = 1;
          |FINSI;
     |FINSI;

     || no hace falta comprobar el swAginom, esto solo puede pasar en aginom
     || ya que en iplabor2 no se pueden usar esos valores en el campo
     |SI #labtraba#129 = "A"; |O #labtraba#129 = "E";
          |SI #cretam04#75 ! 00000; |O #cretam04#78 ! 00000;
               || quiere decir que es un trabajador con ERE a TP, del que
               || ya he grabado el primero, este es el segundo, tiene un
               || tratamiento especial

               || primero le grabo el campo del codigo de trab y horas si lo
               || tenia vacio

               |HAZ CamposMatERE_TP; || el proceso es el mismo, Mat o ERE

               || grabo el codigo como 00000, queda marcado como una IT a TP
               #cretam04#7 = 00000;
               swTrabERETP = 2;
          |SINO;
               swTrabERETP = 1;
          |FINSI;
     |FINSI;

     swNoAnotesTramo = 0;
     |SI swTrabMatTP = 2;
          |SI nCodTipo = 001; |O nCodTipo = 999;
               swNoAnotesTramo = 1;
          |FINSI;
     |FINSI;
     |SI swTrabERETP = 2;
          |SI nCodTipo = 001; |O nCodTipo = 999;
               swNoAnotesTramo = 1;
          |FINSI;
     |FINSI;

     |PARA nVez = 1;
     |SI nVez [ 5; |Y swNoAnotesTramo = 0;
     |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          swGraba = 0;
          |SI #cretam04#nNume# = 000;
               swGraba = 1;
          |FINSI;
          |SI #cretam04#nNume# = 001;
               |SI nCodTipo ] 5; |Y nCodTipo [ 50; || es un cambio por
                    || swGraba = 1;                   || variacion de algo
                    || cambio sistema: no tengo por que cambiarlo !!
                    || ¨o no?
               |FINSI;
          |FINSI;
          |SI swGraba = 1;
               nNume1 = nNume + 1;
               #cretam04#nNume# = nCodTipo;
               #cretam04#nNume1# = aDesTipo;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI swPrest = 1;
          #cretam04#28 = nDiaIT;
     |FINSI;
     |SI nCodTipo = 101; |O nCodTipo = 102;
     |O nCodTipo = 111;
          |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
               #cretam04#84 = 1;
          |FINSI;
     |FINSI;
     |SI nCodTipo = 122;
          #cretam04#27 = "MTP";
     |FINSI;
     |SI nCodTipo = 132;
          #cretam04#27 = "PTP";
     |FINSI;
     |SI swAginom = 1;
          |SI nCodTipo = 161;
               #cretam04#27 = "ETP";
          |FINSI;
     |FINSI;
     #cretam04#29 = #labtraba#2;
     #cretam04#70 = fFechaIniPer;
     #cretam04#71 = fFechaFinPer;
     |SI swIntervalos = 1;
          #cretam04#70 = fIniIntervalo;
          #cretam04#71 = fFinIntervalo;
     |FINSI;
     #cretam04#73 = nContrato;
     #cretam04#81 = nPromedioCC;
     #cretam04#82 = nPromedioATEP;
     #cretam04#86 = aClaveCot;
     |SI nCodTipo = 191; |O nCodTipo = 191;
          |SI swHuelgaParcial = 1;
               #cretam04#87 = #nomabsli#6 / nHorasJor;
          |FINSI;
     |FINSI;
     |SI nSegundaBaseIT ! 0;
          |SI nNroIT > 1;
               #cretam04#81 = nSegundaBaseIT;
               #cretam04#82 = nSegundaBaseIT;
          |FINSI;
     |FINSI;
     |SI #labtraba#42 = "E"; |Y swITAgrJor ! 0;
          || solo en caso de IT
          || para los de las jornadas, grabo las jornadas a cotizar en el tramo
          || a cargo de la Emp y Tra y en el tramo a cargo de la Emp solo
          |HAZ BuscaITAgrJor;
          |SI swPrest = 0;
               || en agrarios siempre seran prestaciones a cero, pero me sirve
               || para identificar el tramo de los primeros 15 dias
               #cretam04#83 = nJornadas_A;
          |SINO;
               #cretam04#83 = nJornadas_B;
               #cretam04#84 = 1;
          |FINSI;
          |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
               #cretam04#83 = nJornadas_A + nJornadas_B;
          |FINSI;
     |FINSI;
     |SI #labtraba#42 = "A"; |Y swITAgrJor ! 0;
          |SI swPrest = 0;
          |SINO;
               #cretam04#84 = 1;
          |FINSI;
     |FINSI;

     |SI FEstado ! 0;
          |GRABA 020#cretam04.n;
     |SINO;
          |GRABA 020#cretam04.a;
     |FINSI;

     swGrabaPrest = 0;
     |SI nCodTipo = 405; |O nCodTipo = 415;
          || busco el anterior, por si estuviera de IT y tuviera prestacion
          |LEE 000#cretam04.=;
          |LEE 000#cretam04.a;
          |SI FSalida = 0;
          |Y #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
               |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
                    nNume = ((nVez - 1) * 2) + 10;
                    |SI #cretam04#nNume# = 102; |O #cretam04#nNume# = 111;
                         swGrabaPrest = #cretam04#nNume#;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |FINSI;
          |SI swGrabaPrest ! 0;
               |LEE 000#cretam04.s;
               |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
                    nNume = ((nVez - 1) * 2) + 10;
                    |SI #cretam04#nNume# = 000;
                         #cretam04#nNume# = swGrabaPrest;
                         |SAL;
                    |FINSI;
               |SIGUE;
               |GRABA 020#cretam04.a;
          |FINSI;
     |FINSI;

     |LIBERA #cretam04;
|FPRC;

|PROCESO BorraTramo;
     aFechaIniTramo = fFechaIniTramo;
     aLinea = aFechaIniTramo % 102;
     nLinea = aLinea;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nLinea;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          |BORRA 020#cretam04.a;
     |FINSI;
     |LIBERA #cretam04;
|FPRC;

|PROCESO busca_tramo;
     swHay = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE busca_tramo;
     #cretam04#1;
     ;
     #cretam03#0, #cretam03#1, #cretam03#2, #cretam03#3, #cretam03#4, #cretam03#5, 001;
     #cretam03#0, #cretam03#1, #cretam03#2, #cretam03#3, #cretam03#4, #cretam03#5, 999;
     ;
     NULL, busca_tramo;
|FIN;

|PROCESO limpia_NAFSS;
     swHay = 0;
     |BUCLE busca_tramo;
     |SI swHay = 0;
         |BORRA 020#cretam03.a;
         |LIBERA #cretam04;
     |FINSI;
|FPRC;

|DEFBUCLE limpia_NAFSS;
     #cretam03#1;
     ;
     nEmp, nAny, nMes, nTipo, "           ", "            ";
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, limpia_NAFSS;
|FIN;

|| BUCLE Y PROCESO PARA BORRAR LOS TRAMOS QUE EXISTIERAN DE UN TRABAJADOR
|| ANTES DE INICIAR LA GRABACION DE LOS TRAMOS NUEVOS

|PROCESO borra_tramos;
     |BORRA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|DEFBUCLE borra_tramos;
     #cretam04#2;
     ;
     nEmp, nAny, nMes, nTipo, "               ", aNAFSS, nTra;
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzzzzzz", aNAFSS, nTra;
     ;
     NULL, borra_tramos;
|FIN;

/****************************************************************************/
/*** PROCESOS PARA GRABAR LAS BONFICACIONES DE FORMACION CONTINA POR CCC ****/
/****************************************************************************/

|PROCESO nombofli;
     swAsignada = 0;

     #labcentr#0 = #nombofli#0;
     #labcentr#1 = #nombofli#4;
     |LEE 000#labcentr.=;
     |SI FSalida = 0; |Y #nombofli#6 ! "F";
          aAlfa = #labcentr#10;
          |QBF aAlfa;
          |SI aAlfa = "";;
               aAlfa = #labempre#13;
               |QBF aAlfa;
          |FINSI;

          aAlfa1 = aAlfa % -107;

          aAlfa = #cretam02#4;
          aAlfa2 = aAlfa % -107;

          |SI aAlfa1 = aAlfa2;
               || esto quiere decir que el centro al que le he asignado
               || la bonificacion de Formacion Continua de este tema,
               || tiene el mismo CCC del que estoy haciendo el lote, luego
               || es el momento de incluirla en el lote

               nBonifFormCont = nBonifFormCont + #nombofli#3;
               swAsignada = 1;
          |FINSI;
     |FINSI;

     || lo mismo para el nomcenes, si en el labcentr no
     || esta encontrada
     #nomcenes#0 = #nombofli#0;
     #nomcenes#13 = #nombofli#4;
     #nomcenes#1 = "87";
     |LEE 000#nomcenes.=;
     |SI FSalida = 0; |Y #nombofli#6 = "F";
          aAlfa = #nomcenes#10;
          |QBF aAlfa;
          aAlfa1 = aAlfa % -107;

          aAlfa = #cretam02#4;
          aAlfa2 = aAlfa % -107;

          |SI aAlfa1 = aAlfa2;
               || esto quiere decir que el centro al que le he asignado
               || la bonificacion de Formacion Continua de este tema,
               || tiene el mismo CCC del que estoy haciendo el lote, luego
               || es el moemento de incluirla en el lote

               nBonifFormCont = nBonifFormCont + #nombofli#3;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nombofli;
     #nombofli#1;
     ;
     #cretam02#0, #cretam02#1, #cretam02#2, 001, " ", "B";
     #cretam02#0, #cretam02#1, #cretam02#2, 999, "F", "P";
     ;
     NULL, nombofli;
|FIN;

|PROCESO BonifFormCont;
     || las bonificaciones de formacion continua van con el tipo de dato
     || C-763 a nivel de LIQUIDACION

     || primero compruebo si existe la bonif

     nBonifFormCont = 0;

     |SI #0#5 ! 00;
          |ACABA;
     |FINSI;

     |ABRE #nombofca;
     #nombofca#0 = #cretam02#0;
     #nombofca#1 = #cretam02#1;
     |LEE 000#nombofca.=;
     |SI FSalida = 0;
          || existe la cabecera, ahora hay que buscar si hay alguna linea
          || este mes, en un centro que tenga el CCC como el que estoy
          || grabando

          |BUCLE nombofli;
     |FINSI;
     |CIERRA #nombofca;
|FPRC;


|PROCESO cretam03;
     |DDEFECTO #cretam03;
     #cretam03#0 = nEmp;
     #cretam03#1 = nElAny;
     #cretam03#2 = nMes;
     #cretam03#3 = nTipo;
     #cretam03#4 = aCCC;
     #cretam03#5 = aNAFSS;
     |LEE 101#cretam03.=;
     FEstado = FSalida;

     #cretam03#6 = #labempre#2;
     #cretam03#7 = #labtraba#77;
     #cretam03#8 = aCentroNom;
     #cretam03#9 = #labtraba#2;
     #cretam03#10 = #labtraba#7;
     #cretam03#11 = #labtraba#1;

     |SI FEstado ! 0;
          |GRABA 020#cretam03.n;
     |SINO;
          |GRABA 020#cretam03.a;
     |FINSI;
     |LIBERA #cretam03;
|FPRC;

|PROCESO cretam02;
     |DDEFECTO #cretam02;
     #cretam02#0 = nEmp;
     #cretam02#1 = nElAny;
     #cretam02#2 = nMes;
     #cretam02#3 = nTipo;
     |HAZ cta_cotizacion;
     #cretam02#4 = aCCC;
     |LEE 101#cretam02.=;
     FEstado = FSalida;

     |SI swCentroFormacion = 1;
          #cretam02#11 = "S";
     |SINO;
          #cretam02#11 = "N";
     |FINSI;

     || si ya la he grabado no la grabo de nuevo
     |SI #0#5 = 00;
          |HAZ BonifFormCont;
          #cretam02#15 = nBonifFormCont;
     |FINSI;
     |SI #0#5 ] 05;
          #cretam02#19 = #0#6;
          #cretam02#17 = #0#1;
          #cretam02#18 = #0#4;
     |FINSI;

     |SI FEstado ! 0;
          #cretam02#5 = #labtraba#77;
          #cretam02#6 = aCentroNom;
          |GRABA 020#cretam02.n;
     |SINO;
          |SI #labtraba#77 ! #cretam02#5; |Y #cretam02#5 ! 00;
               #cretam02#5 = 00;
               #cretam02#6 = "Varios Centros";
          |FINSI;
          |GRABA 020#cretam02.a;
     |FINSI;
     |LIBERA #cretam02;

     || Ahora dentro del CCC doy de alta el Nro de Afiliacion del trabajador
     |HAZ cretam03;
|FPRC;

|PROCESO cretam01;
     |DDEFECTO #cretam01;
     #cretam01#0 = nEmp;
     #cretam01#1 = nElAny;
     #cretam01#2 = nMes;
     #cretam01#3 = nTipo;
     |LEE 101#cretam01.=;
     |SI FSalida ! 0;
          |GRABA 020#cretam01.n;
     |FINSI;
     |LIBERA #cretam01;

     || Ahora dentro de la empresa doy de alta el CCC del centro
     |HAZ cretam02;
|FPRC;

|PROCESO nombotraTramo;
     |ABRE #nomboni3;
     #nomboni3#0 = #nombotra#2;
     |LEE 000#nomboni3.=;
     |SI FSalida = 0;
          |SI #nomboni3#6 ! 0; |Y #nomboni3#5 ! #nomboni3#6;
               fFecha = #nombotra#4;
               aAlfa = fFecha;
               aAlfa1 = (aAlfa % -104);
               nNume = aAlfa1;
               nNume = nNume + 1;
               aAlfa1 = nNume;
               aAlfa = (aAlfa % 106) + aAlfa1;
               #nombotra#5 = aAlfa;

               |SI fFechaIniPer [ #nombotra#5; |Y #nombotra#5 [ fFechaFinPer;
                    fFechaIniTramo = #nombotra#5;
                    nCodTipo = 415;
                    aDesTipo = "CAM.BON.F.";
                    |HAZ GrabaTramo;
               |FINSI;
          |FINSI;
          |SI #nomboni3#7 ! 0; |Y #nomboni3#6 ! #nomboni3#7;
               fFecha = #nombotra#4;
               aAlfa = fFecha;
               aAlfa1 = (aAlfa % -104);
               nNume = aAlfa1;
               nNume = nNume + 2;
               aAlfa1 = nNume;
               aAlfa = (aAlfa % 106) + aAlfa1;
               #nombotra#5 = aAlfa;

               |SI fFechaIniPer [ #nombotra#5; |Y #nombotra#5 [ fFechaFinPer;
                    fFechaIniTramo = #nombotra#5;
                    nCodTipo = 415;
                    aDesTipo = "CAM.BON.F.";
                    |HAZ GrabaTramo;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomboni3;
|FPRC;

|PROCESO nombotra;
     |SI fFechaIniPer [ #nombotra#4; |Y #nombotra#4 [ fFechaFinPer;
          fFechaIniTramo = #nombotra#4;
          nCodTipo = 411;
          aDesTipo = "INI.BON.F.";
          |HAZ GrabaTramo;
     |FINSI;

     |SI fFechaIniPer [ #nombotra#5; |Y #nombotra#5 < fFechaFinPer;
          || uso el < y no el [ porque si no, si la bonif acaba el mismo
          || dia que el trabajador acaba contrato, me hace un tramo mas
          || 59.1209

          fFechaIniTramo = #nombotra#5;
          nCodTipo = 419;
          aDesTipo = "FIN.BON.F.";
          |HAZ GrabaTramo;
     |FINSI;

     |HAZ nombotraTramo;
|FPRC;

|DEFBUCLE nombotra;
    #nombotra#1;
    ;
    #labtraba#0, #labtraba#1, 001;
    #labtraba#0, #labtraba#1, 999;
    ;
    NULL, nombotra;
|FIN;

|PROCESO bonifTramo;
     |ABRE #nombonif;
     #nombonif#0 = #labtraba#39;
     |LEE 000#nombonif.=;
     |SI FSalida = 0;
          aFecha = #labtraba#40;
          fFecha = aFecha;
          aAlfa = fFecha;
          aAlfa1 = (aAlfa % -104);
          nNume = aAlfa1;
          |SI #nombonif#14 ! 000; |Y #nombonif#14 ! 999;
               nNume1 = #nombonif#14;
               nNume1 = nNume1 / 12;
               nNume = nNume + nNume1;

               aAlfa1 = nNume;
               aAlfa = (aAlfa % 106) + aAlfa1;

               fFecha1 = aAlfa;
               nNume = fFecha1;
               nNume = nNume - 1;
               fFechaFinBon = nNume;

               |SI #labtraba#41 ! "          "; |Y #labtraba#41 ! "..........";
                    fFecha2 = #labtraba#41;
                    |SI fFecha2 < fFecha1;
                         || se ha puesto una fecha fin de bonif. en el trab.
                         || inferior a la que seria la normal
                         fFechaFinBon = fFecha2;
                    |FINSI;
               |FINSI;

               |SI fFechaIniPer [ fFechaFinBon; |Y fFechaFinBon [ fFechaFinPer;
                    |SI #nombonif#15 ! 000; |Y #nombonif#15 ! 999;
                         nNume = fFechaFinBon;
                         nNume = nNume + 1;
                         fFechaIniTramo = nNume;
                         nCodTipo = 405;
                         aDesTipo = "CAM BONIF";
                         |HAZ GrabaTramo;
                    |SINO;
                         fFechaIniTramo = fFechaFinBon;
                         || resto un dia que despues en el 409 tiene que
                         || ir asi, porque se espera la fecha de fin como si
                         || se la hubieramos puesto al trabajador, no la
                         || de inicio del tramo
                         nCodTipo = 409;
                         aDesTipo = "FIN BONIF";
                         |HAZ GrabaTramo;
                    |FINSI;
               |FINSI;
          |FINSI;

          || ahora a ver si es fin de bonificacion del segundo Tramo

          |SI #nombonif#15 ! 000; |Y #nombonif#15 ! 999;
               aFecha = #labtraba#40;
               fFecha = aFecha;
               nNume = fFecha;
               nNume = nNume - 1;
               fFecha = nNume;
               aAlfa = fFecha;
               aAlfa1 = (aAlfa % -104);
               nNume = aAlfa1;
               nNume = aAlfa1;
               nNume = nNume + 3;  || bueno a pelo de momento, tres a¤os
               aAlfa1 = nNume;
               aAlfa = (aAlfa % 106) + aAlfa1;
               fFecha1 = aAlfa;
               fFechaFinBon = fFecha1;

               |SI #labtraba#41 ! "          "; |Y #labtraba#41 ! "..........";
                    fFecha2 = #labtraba#41;
                    |SI fFecha2 < fFecha1;
                         fFechaFinBon = fFecha2;
                    |FINSI;
               |FINSI;

               |SI fFechaIniPer [ fFechaFinBon; |Y fFechaFinBon < fFechaFinPer;
                    || uso el < y no el [ porque si no, si la bonif acaba el mismo
                    || dia que el trabajador acaba contrato, me hace un tramo mas
                    fFechaIniTramo = fFechaFinBon;
                    nCodTipo = 409;
                    aDesTipo = "FIN BONIF";
                    |HAZ GrabaTramo;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomboni3;
|FPRC;

|PROCESO bonificaciones;
     |SI nBonifMan ! 0;
          fFechaIniBon = #labtraba#40;
          |SI fFechaIniPer [ fFechaIniBon; |Y fFechaIniBon [ fFechaFinPer;
               fFechaIniTramo = fFechaIniBon;
               nCodTipo = 401;
               aDesTipo = "INI BONIF";
               |HAZ GrabaTramo;
          |FINSI;
          fFechaFinBon = #labtraba#41;
          |SI fFechaIniPer [ fFechaFinBon; |Y fFechaFinBon < fFechaFinPer;
               || uso el < y no el [ porque si no, si la bonif acaba el mismo
               || dia que el trabajador acaba contrato, me hace un tramo mas
               fFechaIniTramo = fFechaFinBon;
               nCodTipo = 409;
               aDesTipo = "FIN BONIF";
               |HAZ GrabaTramo;
          |FINSI;
     |FINSI;

     |SI #labtraba#39 = 501; |O #labtraba#39 = 502; |O #labtraba#39 = 505;
     |O #labtraba#39 = 506; |O #labtraba#39 = 507; |O #labtraba#39 = 508;
          |HAZ bonifTramo;
     |FINSI;

     |SI nBonifFom ! 0;
     |O #0#3 = "A"; |O #0#3 = "T"; || en atrasos no aplico esto, pero el tramo
                                   || ha de estar igual
          |BUCLE nombotra;
     |FINSI;
|FPRC;

|PROCESO Citricos;
     |ABRE #gomdetjr;
     #gomdetjr#0 = #labtraba#0;
     #gomdetjr#1 = #labtraba#1;
     #gomdetjr#2 = #0#0;
     #gomdetjr#3 = nMes;
     |LEE 000#gomdetjr.=;
     |SI FSalida = 0;
          swIniInactividad = 0;
          aAlfa = fFechaIniPer; aAlfa = aAlfa % 102; nDesde = aAlfa;
          aAlfa = fFechaFinPer; aAlfa = aAlfa % 102; nHasta = aAlfa;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               nDia = nCampo - 3;
               |SI nDesde [ nDia; |Y nDia [ nHasta;
                    |SI #gomdetjr#nCampo# = "D";
                         |SI swIniInactividad = 0;
                              || comienzo periodo de inactividad
                              aAlfa1 = nDia; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
                              aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                              aAlfa3 = #0#0;
                              aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
                              fFechaIniTramo = aAlfa;
                              nCodTipo = 201;
                              aDesTipo = "INI INACTIV";
                              |HAZ GrabaTramo;
                              swIniInactividad = 1;
                         |FINSI;
                    |FINSI;
                    |SI swIniInactividad = 1; |Y #gomdetjr#nCampo# ! "D";
                         || acabo periodo de inactividad
                         swIniInactividad = 0;
                         nNume = nDia - 1;
                         aAlfa1 = nNume; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
                         aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                         aAlfa3 = #0#0;
                         aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
                         fFechaIniTramo = aAlfa;
                         nCodTipo = 209;
                         aDesTipo = "FIN INACTIV";
                         |HAZ GrabaTramo;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #gomdetjr;
|FPRC;

|PROCESO BuscaRecaida;
     nDiasRecaida = 0;

     |ABRE #nomhisit;
     #nomhisit#0 = #labtraba#0;
     #nomhisit#1 = #labtraba#1;
     #nomhisit#2 = nElAny;
     #nomhisit#3 = nElMes;
     #nomhisit#8 = nCampo - 26;
     |LEE 000#nomhisit.=;
     |SI FSalida = 0;
          nDiasRecaida = #nomhisit#11;
     |FINSI;

     |CIERRA #nomhisit;
|FPRC;

|PROCESO RecaidaAginom;
     || esto por si hay recaida y se han manipulado los
     || dias de manera manual:
     || solo para la primera enfermedad o Acc, claro
     nDiasRecaida = 0;
     |SI nCampo = 27;
          |SI #0#3 = "M";
               |SI aTipo = "E"; nDiasRecaida = #labtraba#89; |FINSI;
               |SI aTipo = "A"; nDiasRecaida = #labtraba#92; |FINSI;
          |FINSI;
          |SI #0#3 = "H"; |O #0#3 = "T";
               |SI aTipo = "E"; nDiasRecaida = #nomhicca#70; |FINSI;
               |SI aTipo = "A"; nDiasRecaida = #nomhicca#73; |FINSI;
          |FINSI;
     |SINO;
          || si no es recaida, dias acumulados solo en la
          || primera enfermedad
          nDiasAcumEnf = 0;
     |FINSI;
|FPRC;

|PROCESO AgrariosIT_2Tramos;
     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || no en el caso de no-carencia
          |ACABA;
     |FINSI;

     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          || agrarios no tienen prestaciones, he de mirar a ver
          || si es una ENF de mas de 15 dias para saber si tengo
          || que hacer dos tramos
          nNume = nHasta - nDesde + 1;
          |SI nNroIT = 1;
               nNume = nNume + nDiasAcumEnf;
          |SINO;
               nNume = nNume + nDiasRecaida;
          |FINSI;
          |SI nNume > 15;
               swSigue = 1;
               swITAgrJor = 2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO nomabsli;
     nHorasJor = 0;
     swHuelgaParcial = 0;

     #nomabsca#0 = #nomabsli#0;
     #nomabsca#1 = #nomabsli#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;    || a la fuerza
          nHorasJor = #nomabsca#2;
     |FINSI;

     aAlfa = #nomabsli#2; aAlfa = aAlfa % 102; nDesde = aAlfa;
     aAlfa = #nomabsli#3; aAlfa = aAlfa % 102; nHasta = aAlfa;
     nHastaReal = nHasta;
     aTipo = "H";
     |SI nHorasJor ! #nomabsli#6; |Y #nomabsli#6 ! 0;
          swHuelgaParcial = 1;
     |FINSI;

     aAlfa1 = nDesde;
     |QBF aAlfa1;
     aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa = #nomabsli#2;

     swDesde = 1; swHasta = 0; swPrest = 0;
     fFechaIniTramo = aAlfa;
     |HAZ CodigoTiposEnf;
     |HAZ GrabaTramo;

     swDesde = 0; swHasta = 1; swPrest = 0;
     fFechaIniTramo = #nomabsli#3;
     |HAZ CodigoTiposEnf;
     |HAZ GrabaTramo;
|FPRC;

|DEFBUCLE nomabsli;
     #nomabsli#1;
     4;
     nEmp, nTra, fFechaIniMes, "H";
     nEmp, nTra, fFechaFinMes, "H";
     ;
     NULL, nomabsli;
|FIN;

|PROCESO Dia21_4;
     nNume1 = nHasta + nDiasAcumEnf;
     |SI nNume1 > 20;
          |SI nDiasAcumEnf [ 20;
               nNume = 20 - nDiasAcumEnf + 1;
          |SINO;
               nNume = 1;
          |FINSI;
          |SI nNume [ nHasta;
               aAlfa1 = nNume;
               |QBF aAlfa1;
               aAlfa1 = ("00" + aAlfa1) % -102;
               aAlfa = aAlfa1 + "." + aMes + "." + aAny;
               swDesde = 0; swHasta = 0; swPrest = 1;
               fFechaIniTramo = aAlfa;
               || dias de IT acumulados cuando empieza el tramo
               || con prestacion
               nDiaIT = nDiasAcumEnf + nNume;
               |HAZ CodigoTiposEnf;
               |HAZ GrabaTramo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Dia21_3;
     nNume = nHasta - nDesde + 1;
     nNume1 = nNume + nDiasRecaida;
     |SI nNume1 ] 20;
          aAlfa1 = nDesde;
          |QBF aAlfa1;
          aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa = aAlfa1 + "." + aMes + "." + aAny;
          nDiaIT = nDiasRecaida + 1;

          swDesde = 0; swHasta = 0; swPrest = 1;
          fFechaIniTramo = aAlfa;
          |HAZ CodigoTiposEnf;
          |HAZ GrabaTramo;
     |FINSI;
|FPRC;

|PROCESO Dia21_2;
     nNume = nHasta - nDesde + 1;
     nNume1 = nNume + nDiasRecaida;
     |SI nDiasRecaida < 21; |Y nNume1 ] 21;
          nNume = nDesde + 20 - nDiasRecaida;
          aAlfa1 = nNume;
          |QBF aAlfa1;
          aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa = aAlfa1 + "." + aMes + "." + aAny;
          swDesde = 0; swHasta = 0; swPrest = 1;
          nDiaIT = 21;
          fFechaIniTramo = aAlfa;
          |HAZ CodigoTiposEnf;
          |HAZ GrabaTramo;
     |FINSI;
|FPRC;

|PROCESO Dia21_1;
      nNume1 = nHasta - nDesde + 1 + nDiasAcumEnf;
      |SI nNume1 > 20;
           |SI nDiasAcumEnf [ 20;
                nNume = 20 - nDiasAcumEnf + nDesde;
           |SINO;
                nNume = nDesde;
           |FINSI;
           |SI nNume [ nHasta;
                aAlfa1 = nNume;
                |QBF aAlfa1;
                aAlfa1 = ("00" + aAlfa1) % -102;
                aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                swDesde = 0; swHasta = 0; swPrest = 1;
                fFechaIniTramo = aAlfa;
                || dias de IT acumulados cuando empieza el tramo
                || con prestacion
                nDiaIT = nDiasAcumEnf + nNume - nDesde + 1;
                |HAZ CodigoTiposEnf;
                |HAZ GrabaTramo;
           |FINSI;
      |FINSI;
|FPRC;

|PROCESO BuscaITs;
     nDiasAcumEnf = 0;
     nPrestManEnf = 0;
     nPrestManAcc = 0;

     |SI #0#5 = 02;
          |ACABA;
     |FINSI;
     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
     swITAgrJor = 0;     || lo saco aqui, estaba dentro del PARA, pero no es
                         || valido para casos como el tiquet 00024.00601
          nNroIT = nCampo - 26;
          nCampo1 = nCampo - 8;
          nCampo2 = nCampo - 4;
          |SI #0#3 = "M";
               aTipo = #nomcalca#nCampo#; nDesde = #nomcalca#nCampo1#;
               nHasta = #nomcalca#nCampo2#;
               nDiasAcumEnf = #labtraba#89;
               nPrestManEnf = #nomcalca#57;
               nPrestManAcc = #nomcalca#58;
               |SI swAginom = 1;
                    |HAZ RecaidaAginom;
               |SINO;
                    nCampo3 = nCampo + 65;
                    nDiasRecaida = 0;
                    |SI #nomcalca#nCampo3# = "S";
                         |HAZ BuscaRecaida;
                         |SI nDiasRecaida = 0;
                              nDiasRecaida = #nomcalca#101;
                         |FINSI;
                         |SI nDesde = 0;
                              nDiasAcumEnf = nDiasAcumEnf + nDiasRecaida;
                         |SINO;
                              nDiasAcumEnf = nDiasRecaida;
                         |FINSI;
                    |SINO;
                         |SI nNroIT ! 1;
                              || si no es recaida, dias acumulados solo en la
                              || primera enfermedad
                              nDiasAcumEnf = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#3 = "H"; |O #0#3 = "T";
               aTipo = #nomhicca#nCampo#; nDesde = #nomhicca#nCampo1#;
               nHasta = #nomhicca#nCampo2#;
               nDiasAcumEnf = #nomhicca#70;
               nPrestManEnf = #nomhicca#57;
               nPrestManAcc = #nomhicca#58;
               |SI #0#3 = "T";
                    || miro en el hco. del mes por si hubieran habido atrasos
                    || miro siempre, ya que es posible que ese acumulado, en atrasos
                    || no este muy correcto
                    |SALVA_FICHA #nomhicca;
                    #nomhicca#3 = 0;
                    #nomhicca#66 = nAnyLote - 2000;
                    |LEE 000#nomhicca.=;
                    |SI FSalida = 0;
                         nDiasAcumEnf = #nomhicca#70;
                    |FINSI;
                    |REPON_FICHA #nomhicca;
               |FINSI;

               |SI swAginom = 1;
                    |HAZ RecaidaAginom;
               |SINO;
                    nCampo3 = nCampo + 107;
                    nDiasRecaida = 0;
                    |SI #nomhicca#nCampo3# = "S";
                         |HAZ BuscaRecaida;
                         |SI nDiasRecaida = 0;
                              nDiasRecaida = #nomhicca#143;
                         |FINSI;
                         |SI nDesde = 0;
                              nDiasAcumEnf = nDiasAcumEnf + nDiasRecaida;
                         |SINO;
                              nDiasAcumEnf = nDiasRecaida;
                         |FINSI;
                    |SINO;
                         |SI nNroIT ! 1;
                              || si no es recaida, dias acumulados solo en la
                              || primera enfermedad
                              nDiasAcumEnf = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#3 = "A";
               aTipo = #nomcalac#nCampo#; nDesde = #nomcalac#nCampo1#;
               nHasta = #nomcalac#nCampo2#;
               nPrestManEnf = #nomcalac#57;
               nPrestManAcc = #nomcalac#58;

               |SI aTipo = "E";
                    |HAZ BuscaHis;
                    nDiasAcumEnf = #nomhicca#70;
               |FINSI;

               || recaidas en atrasos,
               nCampo3 = nCampo + 65;
               nDiasRecaida = 0;
               |SI #nomcalac#nCampo3# = "S";
                    |HAZ BuscaRecaida;
                    |SI nDesde = 0;
                         nDiasAcumEnf = nDiasAcumEnf + nDiasRecaida;
                    |SINO;
                         nDiasAcumEnf = nDiasRecaida;
                    |FINSI;
               |SINO;
                    |SI nNroIT ! 1;
                         || si no es recaida, dias acumulados solo en la
                         || primera enfermedad
                         nDiasAcumEnf = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
          |QBF aTipo;
          |SI aTipo ! ""; |Y aTipo ! "0"; |Y aTipo ! "V"; |Y aTipo ! "F";
          |Y aTipo ! "f";
               swDesde = 0;
               swHasta = 0;
               swPrest = 0;
               nDiaIT = 0;

               || TIPO DE IT: DESDE X HASTA X

               nHastaReal = nHasta;

               |SI nHasta = 0;
                    aAlfa = fFechaFinPer;
                    aAlfa = aAlfa % 102;
                    nHasta = aAlfa;
               |FINSI;

               |SI nDesde ! 0;
                    |SI #labtraba#42 = "E";
                         swITAgrJor = 1;
                         || esta variable la uso para grabar despues las jornadas
                    |FINSI;

                    aAlfa1 = nDesde;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa = aAlfa1 + "." + aMes + "." + aAny;

                    swDesde = 1; swHasta = 0; swPrest = 0;
                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;

                    || SI ES ENFERMEDAD GRABA LA PRESTACION

                    swSigue = 0;
                    |SI aTipo = "E"; |Y nPrestManEnf ! 0;
                         swSigue = 1;
                    |FINSI;

                    || este proceso es para poner el swSigue a 1 en caso de
                    || it de Agrarios por jornadas de mas de 15 dias
                    |SI aTipo = "E";
                         |HAZ AgrariosIT_2Tramos;
                    |FINSI;

                    |SI swSigue = 1;
                         |SI nDiasRecaida = 0;
                              || normal, sin recaida

                              |SI fFechaAlta = fFechaIniPer;
                                   aAlfa = fFechaAlta;
                                   aAlfa = aAlfa % 102;
                                   nDiaIniPer = aAlfa;
                                   |SI nDiaIniPer = nDesde;
                                        || nueva ficha cuyo primer dia de alta
                                        || es el principio de la IT, cumpruebo
                                        || dias acum
                                   |SINO;
                                        || si no puede ser un error, no me los
                                        || tengas en cuenta
                                        nDiasAcumEnf = 0;
                                   |FINSI;
                              |FINSI;

                              nNume1 = nHasta - nDesde + 1 + nDiasAcumEnf;
                              |SI nNume1 > 15;
                                   |SI nDiasAcumEnf [ 15;
                                        nNume = 15 - nDiasAcumEnf + nDesde;
                                   |SINO;
                                        nNume = nDesde;
                                   |FINSI;
                                   |SI nNume [ nHasta;
                                        aAlfa1 = nNume;
                                        |QBF aAlfa1;
                                        aAlfa1 = ("00" + aAlfa1) % -102;
                                        aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                        swDesde = 0; swHasta = 0; swPrest = 1;
                                        fFechaIniTramo = aAlfa;
                                        || dias de IT acumulados cuando empieza el tramo
                                        || con prestacion
                                        nDiaIT = nDiasAcumEnf + nNume - nDesde + 1;
                                        |HAZ CodigoTiposEnf;
                                        |HAZ GrabaTramo;
                                   |FINSI;
                              |FINSI;
                              |SI swDia21 = 1;
                                   |HAZ Dia21_1;
                              |FINSI;
                         |SINO;
                              || recaida, que sumados a los dias de la IT
                              || hace que durante esta IT se cumple el dia 16
                              || en que comienza la prestacion

                              nNume = nHasta - nDesde + 1;
                              nNume1 = nNume + nDiasRecaida;
                              |SI nDiasRecaida < 16; |Y nNume1 ] 16;
                                   nNume = nDesde + 15 - nDiasRecaida;
                                   aAlfa1 = nNume;
                                   |QBF aAlfa1;
                                   aAlfa1 = ("00" + aAlfa1) % -102;
                                   aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                   swDesde = 0; swHasta = 0; swPrest = 1;
                                   nDiaIT = 16;
                                   fFechaIniTramo = aAlfa;
                                   |HAZ CodigoTiposEnf;
                                   |HAZ GrabaTramo;
                                   |SI swDia21 = 1;
                                        |HAZ Dia21_2;
                                   |FINSI;
                              |SINO;
                                   || caso de que entre los dias de IT y los de
                                   || prestacion, llevamos mas de 16, con lo que
                                   || hay que meter la prestacion

                                   |SI nNume1 ] 15;
                                        aAlfa1 = nDesde;
                                        |QBF aAlfa1;
                                        aAlfa1 = ("00" + aAlfa1) % -102;
                                        aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                        nDiaIT = nDiasRecaida + 1;

                                        swDesde = 0; swHasta = 0; swPrest = 1;
                                        fFechaIniTramo = aAlfa;
                                        |HAZ CodigoTiposEnf;
                                        |HAZ GrabaTramo;
                                        |SI swDia21 = 1;
                                             |HAZ Dia21_3;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || TIPO DE IT: DESDE 0 HASTA X

               |SI nDesde = 0;
                    || regrabo el dia 1 para saber que venia de IT
                    aAlfa1 = 1;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa = aAlfa1 + "." + aMes + "." + aAny;

                    |SI #labtraba#42 = "E";
                         swITAgrJor = 1;
                         || esta variable la uso para grabar despues las jornadas
                    |FINSI;

                    swDesde = 1; swHasta = 0; swPrest = 0;
                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;

                    || EN ENFERMEDAD GRABO LA PRESTACION SI HAY

                    swSigue = 0;
                    |SI aTipo = "E"; |Y nPrestManEnf ! 0;
                         swSigue = 1;
                    |FINSI;

                    || este proceso es para poner el swSigue a 1 en caso de
                    || it de Agrarios por jornadas de mas de 15 dias
                    |SI aTipo = "E";
                         |HAZ AgrariosIT_2Tramos;
                    |FINSI;

                    |SI swSigue = 1;
                         || ahora si hay prestacion por enf grabo la prestacion

                         nNume1 = nHasta + nDiasAcumEnf;
                         |SI nNume1 > 15;
                              |SI nDiasAcumEnf [ 15;
                                   nNume = 15 - nDiasAcumEnf + 1;
                              |SINO;
                                   nNume = 1;
                              |FINSI;
                              |SI nNume [ nHasta;
                                   aAlfa1 = nNume;
                                   |QBF aAlfa1;
                                   aAlfa1 = ("00" + aAlfa1) % -102;
                                   aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                   swDesde = 0; swHasta = 0; swPrest = 1;
                                   fFechaIniTramo = aAlfa;
                                   || dias de IT acumulados cuando empieza el tramo
                                   || con prestacion
                                   nDiaIT = nDiasAcumEnf + nNume;
                                   |HAZ CodigoTiposEnf;
                                   |HAZ GrabaTramo;
                              |FINSI;
                         |FINSI;
                         |SI swDia21 = 1;
                              |HAZ Dia21_4;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || TIPO DE IT: HASTA X, PARA MARCAR EL FINAL DE LA IT
               |SI nHastaReal ! 0;
                    aAlfa1 = nHasta;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa2 = aMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                    aAlfa3 = aAny;
                    aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

                    |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
                         |SI swITAgrJor = 2; |Y swPrest = 1;
                              swPrest = 1;
                              || para que conserve el valor, si ya era una IT
                              || de agrarios de la 509
                         |SINO;
                              swPrest = 0;
                         |FINSI;
                    |SINO;
                         swPrest = 0;
                    |FINSI;

                    swDesde = 0; swHasta = 1;

                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;
               |FINSI;
          |FINSI;
     |SIGUE;
     nNroIT = 0;
     swITAgrJor = 0;

     || huelga en iplabor2
     |SI swIplabor2 = 1;
          |BUCLE nomabsli;
     |FINSI;
|FPRC;

|PROCESO ComparaMeses;
     #cretat04#0 = #cretam04#0;
     #cretat04#1 = #cretam04#1;
     #cretat04#2 = nMesAnt;
     #cretat04#3 = #cretam04#3;
     #cretat04#4 = #cretam04#4;
     #cretat04#5 = #cretam04#5;
     #cretat04#6 = #cretam04#6;
     |LEE 101#cretat04.=;
     |SI FSalida = 0;
          |PARA nCampo = 30;
          |SI nCampo [ 69; |Y swDiferente = 0;
          |HACIENDO nCampo = nCampo + 1;
               |SI #cretat04#nCampo# ! #cretam04#nCampo#;
                    swDiferente = 1;
                    |ERROR10;
               |FINSI;
          |SIGUE;
     |SINO;
          swDiferente = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE ComparaMeses;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, ComparaMeses;
|FIN;

|PROCESO GrabaMesAnt;
     #cretat04#0 = #cretam04#0;
     #cretat04#1 = #cretam04#1;
     #cretat04#2 = #cretam04#2;
     #cretat04#3 = #cretam04#3;
     #cretat04#4 = #cretam04#4;
     #cretat04#5 = #cretam04#5;
     #cretat04#6 = #cretam04#6;
     |LEE 101#cretat04.=;
     FEstado = FSalida;

     |PARA nCampo = 7; |SI nCampo [ 71; |HACIENDO nCampo = nCampo + 1;
          #cretat04#nCampo# = #cretam04#nCampo#;
     |SIGUE;

     |SI FEstado = 0;
          |GRABA 020#cretat04.a;
     |SINO;
          |GRABA 020#cretat04.n;
     |FINSI;
     |LIBERA #cretat04;
|FPRC;

|DEFBUCLE GrabaMesAnt;
     #cretam04#1;
     ;
     nEmp, nAny, nMesAnt, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMesAnt, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, GrabaMesAnt;
|FIN;

|PROCESO MesAnterior;
     |SI nMes = 1;
          |ACABA;
     |FINSI;

     nMesAnt = nMes - 1;

     |BUCLE GrabaMesAnt;

     swDiferente = 0;

     |BUCLE ComparaMeses;

     |SI swDiferente = 0;
          #cretam03#12 = "S";
     |SINO;
          #cretam03#12 = "N";
     |FINSI;
     |LEE 101#cretam03.=;     || vuelvo a leer que si no la ficha no esta leida

     |GRABA 020#cretam03.a;
     |LIBERA 020#cretam03;
|FPRC;

|PROCESO Fechas;
     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     |HAZ CambioCotTPMen;

     fFechaAlta = aFechaAlta;

     aNAFSS = #labtraba#75;
     |QBF aNAFSS;
     aAlfa1 = aNAFSS % 102;
     aAlfa2 = aNAFSS % 310;
     |QBF aAlfa2;
     aAlfa2 = ("0000000000" + aAlfa2) % -110;
     aNAFSS = aAlfa1 + aAlfa2;

     aAlfa = aFechaBaja;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2999";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |SI nTipo = 2;
          nFechaBaja = fFechaBaja;
          nFechaAlta = nFechaBaja + 1;
          fFechaAlta = nFechaAlta;

          nFechaBaja = fFechaAlta + nDiasVac1 - 1;
          fFechaBaja = nFechaBaja;
     |FINSI;

     nMes = nElMes;
     nAny = nAnyLote;
     |HAZ topemes;

     || nAnyLote es igual al #0#0 (nAny) o al a¤o de cotizacion de atrasos
     || en atrasos

     aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
     aAny = nAnyLote;

     aAlfa1 = topemes;
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaFinPer = aAlfa;

     fFechaFinMes = aAlfa;
     nFechaFinMes = fFechaFinMes;

     aAlfa1 = "01";
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaIniPer = aAlfa;

     fFechaIniMes = aAlfa;
     nFechaIniMes = fFechaIniMes;

     |SI fFechaAlta > fFechaIniPer;
          fFechaIniPer = fFechaAlta;
     |FINSI;

     |SI fFechaBaja < fFechaFinPer;
          fFechaFinPer = fFechaBaja;
     |FINSI;

     nNume1 = fFechaIniPer;
     nNume2 = fFechaFinPer;

     nDiasMesTrab = nNume2 - nNume1 + 1;
|FPRC;

|PROCESO BuscaHis;
     #nomhicca#0 = #nomcalac#0;
     #nomhicca#1 = #nomcalac#1;
     #nomhicca#2 = #nomcalac#2;
     #nomhicca#3 = 0;
     #nomhicca#66 = nAnyLote - 2000;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |SI #nomhicca#27 = "D"; |Y #nomhicca#161 ! 100;
               swERETP = 1;
               nPropERE = #nomhicca#161;
          |FINSI;
          |SI #nomhicca#28 = "D"; |Y #nomhicca#162 ! 100;
               swERETP = 1;
               nPropERE = #nomhicca#162;
          |FINSI;
          |SI #nomhicca#29 = "D"; |Y #nomhicca#163 ! 100;
               swERETP = 1;
               nPropERE = #nomhicca#163;
          |FINSI;
          |SI #nomhicca#30 = "D"; |Y #nomhicca#164 ! 100;
               swERETP = 1;
               nPropERE = #nomhicca#164;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CalendarioCit;
     |ABRE #gomdetjr;
     #gomdetjr#0 = nEmp;
     #gomdetjr#1 = nTra;
     #gomdetjr#2 = #0#0;
     #gomdetjr#3 = nMes;
     |LEE 000#gomdetjr.=;

     nJorTraCal = 0;
     nDiasInactividad = 0;

     |SI FSalida = 0;
          aAlfa = fFechaIniPer; aAlfa = aAlfa % 102; nDesde = aAlfa;
          aAlfa = fFechaFinPer; aAlfa = aAlfa % 102; nHasta = aAlfa;
          |PARA nCampo = 4; |SI nCampo [ 34; |HACIENDO nCampo = nCampo + 1;
               nDia = nCampo - 3;
               |SI nDesde [ nDia; |Y nDia [ nHasta;
                    |SI #gomdetjr#nCampo# = "D";
                         nDiasInactividad = nDiasInactividad + 1;
                    |FINSI;
                    |SI #gomdetjr#nCampo# = "X";
                         nJorTraCal = nJorTraCal + 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |CIERRA #gomdetjr;
|FPRC;

|PROCESO VarAtrasos;
     nBaseCCAlta = #nomcalac#39;  || para las L13
     nBaseTotal = #nomcalac#39 + #nomcalac#40 + #nomcalac#62;

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomcalac#3;
     |SI #0#5 = 90; nTipo = 90; |FINSI;
     aFechaAlta = #nomcalac#4;
     aFechaBaja = #nomcalac#5;

     nDiasVac1 = #nomcalac#171;
     nDiasVac2 = #nomcalac#172;
     nDiasVac3 = 0;

     |HAZ Fechas;

     nBonifMan = #nomcalac#63;
     nBonifFom = #nomcalac#96;
     |SI #nomcalac#170 ! 0;
          nBonifFom = #nomcalac#170;
     |FINSI;

     nDiasCot = #nomcalac#8;

     nDiasInactividad = 0;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          nDiasCot = nDiasMesTrab;

          nDiasInactividad = #nomcalac#118;

          |SI nDiasInactividad = 0;
               |HAZ CalendarioCit;
          |FINSI;

          |SI nDiasInactividad ! 0;
               nDiasMesTrab = nDiasMesTrab - nDiasInactividad;
               nDiasCot = nDiasMesTrab;
          |FINSI;
     |FINSI;

     nBaseHorasFM = 0;
     nBaseHorasOtras = 0;
     nPromedioCC = #nomcalac#35;
     nPromedioATEP = #nomcalac#36;
     nBaseDiariaERE = #nomcalac#127;
     nPrestEnf = #nomcalac#57;
     nPrestAcc = #nomcalac#58;
     nBaseCCAlta = #nomcalac#39;
     nBaseATEP_Alta = #nomcalac#40;
     |SI nTipo ! 2;
          nBaseEnfAcc = #nomcalac#62;
          nBaseEnfAcc = nBaseEnfAcc - #nomcalac#117 - #nomcalac#130;
          nBaseEnfAcc = nBaseEnfAcc - #nomcalac#132;
          nBaseCCAlta = nBaseCCAlta - nBaseEnfAcc;
          nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
          nBasePat = 0;
          nBaseMat = #nomcalac#117;
          |SI #nomcalac#139 ! 0;
               nBasePat = nBaseMat;
               nBaseMat = 0;
          |FINSI;
          nBaseRie = #nomcalac#130;
          nBaseCon = #nomcalac#132;
          nBaseERE = #nomcalac#128;
          |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               nBaseHorasFM = #nomcalac#41;
               nBaseHorasOtras = #nomcalac#42;
          |FINSI;
     |FINSI;

     nHorasTPMant = #nomcalac#11;
     nBaseCCIT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;
     nBaseATEP_IT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomcalli#0 = #nomcalac#0;
                    #nomcalli#1 = #nomcalac#1;
                    #nomcalli#2 = #nomcalac#2;
                    #nomcalli#3 = #nomcalac#3;
                    #nomcalli#4 = nConcepto;
                    |LEE 000#nomcalli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomcalli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;
     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalac#31;
     nDiasAcc = #nomcalac#32;
     nDiasMat = #nomcalac#65 - #nomcalac#139 - #nomcalac#129;
     nDiasPat = #nomcalac#139;
     nDiasRie = #nomcalac#129;
     nDiasCon = #nomcalac#131;
     nDiasHue = #nomcalac#33;
     nDiasERE = #nomcalac#78;
     nPropERE = 100;
     nJornadas = 0;
     nJornadasIT = 0;
     |SI #labtraba#42 = "E";
          nJornadas = #nomcalac#11;
          nJornadasIT = #nomcalac#55;
     |FINSI;

     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalac#nCampo# = "D";
                    nCampo1 = nCampo + 92;
                    nPropERE = #nomcalac#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI swAginom = 1;
          nPropERE = 100;
     |FINSI;

     swTopeMin = 0;
     |SI #nomcalac#168 = "m"; |O #nomcalac#169 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = nAnyLote;
     nMes = #nomcalac#2;
     |HAZ topemes;
     nAny = #0#0;

     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #labtraba#33 ] 08;
               swSigue = 0;
          |FINSI;
     |FINSI;

     |SI swSigue = 1; |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalac#nCampo# = "E"; |O #nomcalac#nCampo# = "A";
               |O #nomcalac#nCampo# = "M"; |O #nomcalac#nCampo# = "P";
               |O #nomcalac#nCampo# = "R"; |O #nomcalac#nCampo# = "C";
               |O #nomcalac#nCampo# = "D";
                    aUltimaIT = #nomcalac#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc;

     |SI nPromedioCC ! nPromedioATEP;
          |SI #labtraba#42 = "E";
               |SI nDiasMat = 0; |Y nDiasPat = 0; |Y nDiasRie = 0; |Y nDiasCon = 0;
                    || si es maternidad o pat o algo asi no he de restar de
                    || aqui, ojo cuando haya enf + mat por ejemplo no lo haria
                    || bien, entonces lo veremos
                    nBaseCCAlta = #nomcalac#39 - (nJornadasIT * nPromedioCC);
                    nBaseATEP_Alta = #nomcalac#40 - (nJornadasIT * nPromedioATEP);
               |FINSI;
          |SINO;
               nBaseCCAlta = #nomcalac#39 - (nDiasCotIT * nPromedioCC);
               nBaseATEP_Alta = #nomcalac#40 - (nDiasCotIT * nPromedioATEP);
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |O #labtraba#42 = "D";
               |SI swTopeMin = 1; |Y #labtraba#33 ] 08;
               |Y #0#1 = 2;
                    nNume1 = nBaseCCIT;
                    nNume2 = (nDiasCotIT * nPromedioCC);
                    |SI nNume1 ! nNume2;
                         nBaseCCAlta = #nomcalac#39 - (nDiasCotIT * nPromedioCC);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasCotIT + nDiasMat + nDiasPat + nDiasRie + nDiasCon;
     nDiasCotAlta = nDiasCot - nDiasCotIT;

     swERETP = 0;
     |SI nDiasERE ! 0;
          |HAZ BuscaHis;
     |FINSI;

     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || a la base en alta no hay que restar la base en IT, ya que al ser
          || prest. NO y Car. NO, el trabajador no cotiza

          nBaseCCAlta = #nomcalac#39;
          nBaseATEP_Alta = #nomcalac#40;
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomcalac#107;
     nNume = #nomcalac#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     |SI swIplabor2 = 1;
          nNume = 248;
          nConstante = #labtraba#nNume#;
     |FINSI;

     |SI nConstante = 515;
          nBaseCCAlta = 0;
          nBaseCCIT = 0;
     |FINSI;
|FPRC;

|PROCESO VarHistorico;
     nBaseCCAlta = #nomhicca#39;  || para las L13
     nBaseTotal = #nomhicca#39 + #nomhicca#62;

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomhicca#3;
     aFechaAlta = #nomhicca#4;
     aFechaBaja = #nomhicca#5;

     nDiasVac1 = #nomhicca#213;
     nDiasVac2 = #nomhicca#214;
     nDiasVac3 = 0;

     |HAZ Fechas;
     nBonifMan = #nomhicca#63;
     nBonifFom = #nomhicca#138;
     |SI #nomhicca#212 ! 0;
          nBonifFom = #nomhicca#212;
     |FINSI;
     swSigue = 0;
     |SI #nomhicca#3 ] 5;
          |SI #nomhicca#119 ! 0;
          || atrasos, ERE, problemas con el calculo de dias en alguna nomina
          || es un parche, quitarlo si molestara
               swSigue = 1;
          |FINSI;

          || atrasos, citricos
          || me aseguro de que los dias cot. sean los mismos que en historico
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               swSigue = 1;
          |FINSI;

          |SI swSigue = 1;
               nNume = 0;
               |SALVA_FICHA #nomhicca;
               #nomhicca#3 = 0;
               |LEE 000#nomhicca.=;
               |SI FSalida = 0;
                    nNume = #nomhicca#8;
               |FINSI;
               |REPON_FICHA #nomhicca;
               |SI nNume ! 0;
                    #nomhicca#8 = nNume;
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCot = #nomhicca#8;

     nDiasInactividad = 0;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          nDiasInactividad = #nomhicca#160;

          |SI nDiasInactividad = 0;
               |HAZ CalendarioCit;
          |FINSI;
          |SI nDiasInactividad ! 0;
               nDiasMesTrab = nDiasMesTrab - nDiasInactividad;
               nDiasCot = nDiasMesTrab;
          |FINSI;
     |FINSI;

     nPromedioCC = #nomhicca#35;
     nPromedioATEP = #nomhicca#36;
     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          nSegundaBaseIT = 0;
     |SINO;
          nSegundaBaseIT = #nomhicca#188;
     |FINSI;

     nBaseHorasFM = 0;
     nBaseHorasOtras = 0;

     nBaseDiariaERE = #nomhicca#169;
     nPrestEnf = #nomhicca#57;
     nPrestAcc = #nomhicca#58;
     nBaseCCAlta = #nomhicca#39;
     nBaseATEP_Alta = #nomhicca#40;
     |SI nTipo ! 2;
          nBaseEnfAcc = #nomhicca#62;
          nBaseEnfAcc = nBaseEnfAcc - #nomhicca#159 - #nomhicca#172;
          nBaseEnfAcc = nBaseEnfAcc - #nomhicca#174;
          nBaseCCAlta = nBaseCCAlta - nBaseEnfAcc;
          nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
          nBasePat = 0;
          nBaseMat = #nomhicca#159;
          |SI #nomhicca#181 ! 0;
               nBasePat = nBaseMat;
               nBaseMat = 0;
          |FINSI;
          nBaseRie = #nomhicca#172;
          nBaseCon = #nomhicca#174;
          nBaseERE = #nomhicca#170;
          |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               nBaseHorasFM = #nomhicca#41;
               nBaseHorasOtras = #nomhicca#42;
          |FINSI;
     |FINSI;

     nHorasTPMant = #nomhicca#11;
     nBaseCCIT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;
     nBaseATEP_IT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomhicli#0 = #nomhicca#0;
                    #nomhicli#1 = #nomhicca#1;
                    #nomhicli#12 = #nomhicca#66;
                    #nomhicli#2 = #nomhicca#2;
                    #nomhicli#3 = #nomhicca#3;
                    #nomhicli#4 = nConcepto;
                    |LEE 000#nomhicli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomhicli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomhicca#31;
     nDiasAcc = #nomhicca#32;
     nDiasMat = #nomhicca#65 - #nomhicca#181 - #nomhicca#171;
     nDiasPat = #nomhicca#181;
     nDiasRie = #nomhicca#171;
     nDiasCon = #nomhicca#173;
     nDiasHue = #nomhicca#33;
     nDiasERE = #nomhicca#119;
     nPropERE = 100;
     nJornadas = 0;
     nJornadasIT = 0;
     |SI #labtraba#42 = "E";
          nJornadas = #nomhicca#11;
          nJornadasIT = #nomhicca#55;
          nJorTraCal = 0;
          |HAZ CalendarioCit;      || para contar las jornadas trab. del calendario
          |SI nJorTraCal ! 0;
               nJornadas = nJorTraCal;
          |FINSI;
     |FINSI;
     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomhicca#nCampo# = "D";
                    nCampo1 = nCampo + 134;
                    nPropERE = #nomhicca#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI swAginom = 1;
          nPropERE = 100;
     |FINSI;

     swTopeMin = 0;
     |SI #nomhicca#210 = "m"; |O #nomhicca#211 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = nAnyLote;
     nMes = #nomhicca#2;
     |HAZ topemes;
     nAny = #0#0;
     nAjuste = 0;
     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #labtraba#33 ] 08;
               swSigue = 0;
          |FINSI;
     |FINSI;

     |SI swSigue = 1; |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomhicca#nCampo# = "E"; |O #nomhicca#nCampo# = "A";
               |O #nomhicca#nCampo# = "M"; |O #nomhicca#nCampo# = "P";
               |O #nomhicca#nCampo# = "R"; |O #nomhicca#nCampo# = "C";
               |O #nomhicca#nCampo# = "D";
                    aUltimaIT = #nomhicca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc;

     |SI nPromedioCC ! nPromedioATEP;
          |SI #labtraba#42 = "E";
               |SI nDiasMat = 0; |Y nDiasPat = 0; |Y nDiasRie = 0; |Y nDiasCon = 0;
                    || si es maternidad o pat o algo asi no he de restar de
                    || aqui, ojo cuando haya enf + mat por ejemplo no lo haria
                    || bien, entonces lo veremos
                    nBaseCCAlta = #nomhicca#39 - (nJornadasIT * nPromedioCC);
                    nBaseATEP_Alta = #nomhicca#40 - (nJornadasIT * nPromedioATEP);
               |FINSI;
          |SINO;
               nBaseCCAlta = #nomhicca#39 - (nDiasCotIT * nPromedioCC);
               nBaseATEP_Alta = #nomhicca#40 - (nDiasCotIT * nPromedioATEP);
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |O #labtraba#42 = "D";
               |SI swTopeMin = 1; |Y #labtraba#33 ] 08;
               |Y #0#1 = 2;
                    nNume1 = nBaseCCIT;
                    nNume2 = (nDiasCotIT * nPromedioCC);
                    |SI nNume1 ! nNume2;
                         nBaseCCAlta = #nomhicca#39 - (nDiasCotIT * nPromedioCC);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     nDiasCotIT = nDiasCotIT + nDiasMat + nDiasPat + nDiasRie + nDiasCon;
     nDiasCotAlta = nDiasCot - nDiasCotIT;

     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || a la base en alta no hay que restar la base en IT, ya que al ser
          || prest. NO y Car. NO, el trabajador no cotiza

          |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
               || menos en agrario, que sigue yendo todo junto
               || ¨sigue yendo todo junto?
               nBaseCCAlta = #nomhicca#39 - #nomhicca#121  + nBaseMat + nBasePat;
               nBaseATEP_Alta = #nomhicca#40 - #nomhicca#122  + nBaseMat + nBasePat;
          |SINO;
               nBaseCCAlta = #nomhicca#39;
               nBaseATEP_Alta = #nomhicca#40;
          |FINSI;
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomhicca#149;
     |SI #labtraba#45 ! 421;
          nNumHorasFor = 0;
     |FINSI;
     nNume = #nomhicca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     nNumHorasTut = #nomhicca#224;
     nBonifTut = #nomhicca#225;
     nConstante = #nomhicca#205;

     |SI nConstante = 515;
          nBaseCCAlta = 0;
          nBaseCCIT = 0;
     |FINSI;
|FPRC;

|PROCESO VarMensuales;
     nBaseCCAlta = #nomcalca#39;  || para las L13

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomcalca#3;
     aFechaAlta = #nomcalca#4;
     aFechaBaja = #nomcalca#5;

     nDiasVac1 = #nomcalca#171;
     nDiasVac2 = #nomcalca#172;
     nDiasVac3 = 0;

     |HAZ Fechas;

     nBonifMan = #nomcalca#63;
     nBonifFom = #nomcalca#96;
     |SI #nomcalca#170 ! 0;
          nBonifFom = #nomcalca#170;
     |FINSI;
     nDiasCot = #nomcalca#8;

     nDiasInactividad = 0;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          nDiasInactividad = #nomcalca#118;

          |SI nDiasInactividad = 0;
               |HAZ CalendarioCit;
          |FINSI;

          |SI nDiasInactividad ! 0;
               nDiasMesTrab = nDiasMesTrab - nDiasInactividad;
               nDiasCot = nDiasMesTrab;
          |FINSI;
     |FINSI;

     nPromedioCC = #nomcalca#35;
     nPromedioATEP = #nomcalca#36;
     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          nSegundaBaseIT = 0;
     |SINO;
          nSegundaBaseIT = #nomcalca#146;
     |FINSI;
     nBaseDiariaERE = #nomcalca#127;
     nPrestEnf = #nomcalca#57;
     nPrestAcc = #nomcalca#58;
     nBaseCCAlta = #nomcalca#39;
     nBaseATEP_Alta = #nomcalca#40;

     nBaseHorasFM = 0;
     nBaseHorasOtras = 0;

     |SI nTipo ! 2;
          nBaseEnfAcc = #nomcalca#62;
          nBaseEnfAcc = nBaseEnfAcc - #nomcalca#117 - #nomcalca#130;
          nBaseEnfAcc = nBaseEnfAcc - #nomcalca#132;
          nBaseCCAlta = nBaseCCAlta - nBaseEnfAcc;
          nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
          nBasePat = 0;
          nBaseMat = #nomcalca#117;
          |SI #nomcalca#139 ! 0;
               nBasePat = nBaseMat;
               nBaseMat = 0;
          |FINSI;
          nBaseRie = #nomcalca#130;
          nBaseCon = #nomcalca#132;
          nBaseERE = #nomcalca#128;
          |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
               nBaseHorasFM = #nomcalca#41;
               nBaseHorasOtras = #nomcalca#42;
          |FINSI;
     |FINSI;

     nHorasTPMant = #nomcalca#11;
     nBaseCCIT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;
     nBaseATEP_IT = nBaseEnfAcc + nBaseMat + nBasePat + nBaseRie + nBaseCon + nBaseERE;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomcalli#0 = #nomcalca#0;
                    #nomcalli#1 = #nomcalca#1;
                    #nomcalli#2 = #nomcalca#2;
                    #nomcalli#3 = #nomcalca#3;
                    #nomcalli#4 = nConcepto;
                    |LEE 000#nomcalli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomcalli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalca#31;
     nDiasAcc = #nomcalca#32;
     nDiasMat = #nomcalca#65 - #nomcalca#139 - #nomcalca#129;
     nDiasPat = #nomcalca#139;
     nDiasRie = #nomcalca#129;
     nDiasCon = #nomcalca#131;
     nDiasERE = #nomcalca#78;
     nDiasHue = #nomcalca#33;
     nPropERE = 100;
     nJornadas = 0;
     nJornadasIT = 0;
     |SI #labtraba#42 = "E";
          nJornadas = #nomcalca#11;
          nJornadasIT = #nomcalca#55;
          nJorTraCal = 0;
          |HAZ CalendarioCit;      || para contar las jornadas trab. del calendario
          |SI nJorTraCal ! 0;
               nJornadas = nJorTraCal;
          |FINSI;
     |FINSI;
     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalca#nCampo# = "D";
                    nCampo1 = nCampo + 92;
                    nPropERE = #nomcalca#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI swAginom = 1;
          nPropERE = 100;
     |FINSI;

     swTopeMin = 0;
     |SI #nomcalca#168 = "m"; |O #nomcalca#169 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = #0#0;
     nMes = #nomcalca#2;
     |HAZ topemes;

     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #labtraba#33 ] 08;
               swSigue = 0;
          |FINSI;
     |FINSI;

     |SI swSigue = 1; |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalca#nCampo# = "E"; |O #nomcalca#nCampo# = "A";
               |O #nomcalca#nCampo# = "M"; |O #nomcalca#nCampo# = "P";
               |O #nomcalca#nCampo# = "R"; |O #nomcalca#nCampo# = "C";
               |O #nomcalca#nCampo# = "D";
                    aUltimaIT = #nomcalca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc;
     |SI nPromedioCC ! nPromedioATEP;
          |SI #labtraba#42 = "E";
               |SI nDiasMat = 0; |Y nDiasPat = 0; |Y nDiasRie = 0; |Y nDiasCon = 0;
                    || si es maternidad o pat o algo asi no he de restar de
                    || aqui, ojo cuando haya enf + mat por ejemplo no lo haria
                    || bien, entonces lo veremos
                    nBaseCCAlta = #nomcalca#39 - (nJornadasIT * nPromedioCC);
                    nBaseATEP_Alta = #nomcalca#40 - (nJornadasIT * nPromedioATEP);
               |FINSI;
          |SINO;
               nBaseCCAlta = #nomcalca#39 - (nDiasCotIT * nPromedioCC);
               nBaseATEP_Alta = #nomcalca#40 - (nDiasCotIT * nPromedioATEP);
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |O #labtraba#42 = "D";
               |SI swTopeMin = 1; |Y #labtraba#33 ] 08;
               |Y #0#1 = 2;
                    nNume1 = nBaseCCIT;
                    nNume2 = (nDiasCotIT * nPromedioCC);
                    |SI nNume1 ! nNume2;
                         nBaseCCAlta = #nomcalca#39 - (nDiasCotIT * nPromedioCC);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     nDiasCotIT = nDiasCotIT + nDiasMat + nDiasPat + nDiasRie + nDiasCon;
     nDiasCotAlta = nDiasCot - nDiasCotIT;

     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || a la base en alta no hay que restar la base en IT, ya que al ser
          || prest. NO y Car. NO, el trabajador no cotiza
          |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
               || menos en agrario, que sigue yendo todo junto
               || ¨sigue yendo todo junto?
               nBaseCCAlta = #nomcalca#39 - #nomcalca#79 + nBaseMat + nBasePat;
               nBaseATEP_Alta = #nomcalca#40 - #nomcalca#80 + nBaseMat + nBasePat;
          |SINO;
               nBaseCCAlta = #nomcalca#39;
               nBaseATEP_Alta = #nomcalca#40;
          |FINSI;
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomcalca#107;
     |SI #labtraba#45 ! 421;
          nNumHorasFor = 0;
     |FINSI;
     nNume = #nomcalca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     nNumHorasTut = #nomcalca#182;
     nBonifTut = #nomcalca#183;
     nConstante = #nomcalca#163;

     |SI nConstante = 515;
          nBaseCCAlta = 0;
          nBaseCCIT = 0;
     |FINSI;
|FPRC;

|PROCESO CambioCotTPMen;
     || TODOS
     || las horas por dia a TP estan en el campo 80 del historico o en el
     || 47 de la ficha de trabajadores para el mensual !!!
     nNume = #labtraba#45;
     |SI #0#3 = "H";
          #labtraba#47 = #nomhicca#80;
     |SINO;
     |FINSI;
     |SI #0#3 = "M"; |Y #nomcalca#181 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
               #labtraba#42 = "T";
          |SINO;
               |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
               |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
                    #labtraba#42 = "D";
                    #labtraba#64 = "D";
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#3 = "H"; |O #0#3 = "T";
          |SI #nomhicca#223 = "S";
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
                    #labtraba#42 = "T";
               |SINO;
                    |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
                    |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
                         #labtraba#42 = "D";
                         #labtraba#64 = "D";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#3 = "A"; |Y #nomcalac#181 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
               #labtraba#42 = "T";
          |SINO;
               |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
               |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
                    #labtraba#42 = "D";
                    #labtraba#64 = "D";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO M51;
     || primero busco si algun tramo tiene M51
     |SI swBuscaM51 = 1;
          |SI #cretam04#25 = "S";
               swM51 = 1;
               |ERROR10;
          |FINSI;
     |FINSI;
     || segundo lo grabo en todos si lo tiene
     |SI swBuscaM51 = 2;
          |SI #cretam04#23 = "S";       || si no, imposible
               #cretam04#25 = "S";
               |HAZ GrabaBase51;
               |GRABA 020#cretam04.a;
               |LIBERA #cretam04;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE M51;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     be;
     NULL, M51;
|FIN;

|PROCESO CuentaDiasTrab2;
     |SI #cretam04#27 ! "INA"; |Y #cretam04#27 ! "HUE";
          |SI #cretam04#27 = "HTP";
               nDiasCotAlta2 = nDiasCotAlta2 + (#cretam04#22 - (#cretam04#22 * #cretam04#87));
               swHuelgaParcial = 1;
          |SINO;
               |SI #cretam04#27 = "ALT";
                    nDiasCotAlta2 = nDiasCotAlta2 + #cretam04#22;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaDiasTrab2;
     #cretam04#2;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, nTra;
     ;
     NULL, CuentaDiasTrab2;
|FIN;

|PROCESO CuentaDiasTrab;
     nDiasTrab = nDiasTrab + (#cretam04#21 - #cretam04#20 + 1);
|FPRC;

|DEFBUCLE CuentaDiasTrab;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, CuentaDiasTrab;
|FIN;

|PROCESO intervalos;
     |ABRE #nomintal;
     #nomintal#0 = nEmp;
     #nomintal#1 = nTra;
     #nomintal#2 = #0#0;
     #nomintal#3 = #0#1;
     |LEE 000#nomintal.=;
     |SI FSalida = 0;
          swIntervalos = 1;

          || borro los tramos de inicio y fin creados en base a la fecha
          || de alta, los que me serviran seran los del nomintal
          fFechaIniTramo = fFechaIniPer;
          |HAZ BorraTramo;
          fFechaIniTramo = fFechaFinPer;
          |HAZ BorraTramo;

          |PARA nCampo = 4; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 2;
               nCampo1 = nCampo + 1;
               |SI #nomintal#nCampo# ! 0;
                    aDiaIni = #nomintal#nCampo#;
                    |QBF aDiaIni;
                    aDiaIni = ("00" + aDiaIni) % -102;
                    aDiaFin = #nomintal#nCampo1#;
                    |QBF aDiaFin;
                    aDiaFin = ("00" + aDiaFin) % -102;
                    aMes = #nomintal#3;
                    |QBF aMes;
                    aMes = ("00" + aMes) % -102;
                    aAny = #nomintal#2;
                    aAlfa = aDiaIni + "." + aMes + "." + aAny;
                    fIniIntervalo = aAlfa;
                    aAlfa = aDiaFin + "." + aMes + "." + aAny;
                    fFinIntervalo = aAlfa;

                    fFechaIniTramo = fIniIntervalo;
                    nCodTipo = 001;
                    aDesTipo = "INI PERIODO";
                    |HAZ GrabaTramo;

                    fFechaIniTramo = fFinIntervalo;
                    nCodTipo = 999;
                    aDesTipo = "FIN PERIODO";
                    |HAZ GrabaTramo;

                    nDiasMesInt = nDiasMesInt + (#nomintal#nCampo1# - #nomintal#nCampo# + 1);
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #nomintal;
|FPRC;

|PROCESO generador;
     || PRIMERO: Cargo variables de calculo segun mensual, historico o atrasos
     |SI #0#3 = "M";
          nEmp = #nomcalca#0;
          nTra = #nomcalca#1;
          nElMes = #nomcalca#2;
          |HAZ VarMensuales;
     |FINSI;

     |SI #0#3 = "H"; |O #0#3 = "T";
          nEmp = #nomhicca#0;
          nTra = #nomhicca#1;
          nElMes = #nomhicca#2;
          |HAZ VarHistorico;
     |FINSI;

     |SI #0#3 = "A";
          nEmp = #nomcalac#0;
          nTra = #nomcalac#1;
          nElMes = #nomcalac#2;
          |HAZ VarAtrasos;
     |FINSI;

     |SI nElAny ] 2020;
          |SI nElAny = 2020; |Y nElMes ] 5;
               swDia21 = 1;
          |FINSI;
          |SI nElAny ] 2021;
               swDia21 = 1;
          |FINSI;
     |FINSI;

     || SEGUNDO comprobaciones a ver si el trabajador entra en la seleccion

     |SI #0#2 = "S";
          |SI #tsilco14#2 = "*";
               |SI #tsilco14#3 = "*";
                    #tsilco15#0 = nEmp;
                    #tsilco15#1 = nTra;
                    |LEE 000#tsilco15.=;
                    |SI FSalida = 0; |Y #tsilco15#7 = "*";
                         || continua
                    |SINO;
                         |ACABA;
                    |FINSI;
               |SINO;
                    || continua, no hay seleccion de trabajadores
               |FINSI;
          |SINO;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#5 = 2;
          |SI nBaseCCAlta = 0; |Y nDias99 = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#3 = "A"; |O #0#3 = "T";
          |SI nBaseTotal = 0;
               |ACABA;        || p. ej. atrasos de contratos de formacion, cobran
          |FINSI;             || pero no tienen que cotizar nada de nada
     |FINSI;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          |HAZ CambioCotTPMen;

          |SI #labtraba#247 = 121; |O #labtraba#247 = 138;
          |O #labtraba#42 = "H";
               |ACABA;
          |FINSI;

          nContrato = #labtraba#45;
          aClaveCot = #labtraba#42;
     |FINSI;

     nTrabEmp = nTrabEmp + 1;

     |SI swCuenta = 1;
          |SI nEmpAnt ! nEmp; |O nTraAnt ! nTra;
               nTotalTra = nTotalTra + 1;
          |FINSI;

          aAlfa = nTotalTra;
          |QBF aAlfa;
          aAlfa = ("    " + aAlfa) % -104;
          |ATRI R; |PINTA 2151, aAlfa; |ATRI 0;

          nEmpAnt = nEmp;
          nTraAnt = nTra;

          |ACABA;
     |SINO;
          |SI nEmpAnt ! nEmp; |O nTraAnt ! nTra;
               nNroTra = nNroTra + 1;
          |FINSI;
          aAlfa = nNroTra; |QBF aAlfa;
          aAlfa = "Trabajador " + aAlfa + " de " + aTotalTra;
          |ATRI R; |PINTA 2128, aAlfa; |ATRI 0;

          nEmpAnt = nEmp;
          nTraAnt = nTra;
     |FINSI;

     || AHORA EMPIEZO CON LA GENERACION DE LOS TRAMOS
     || Primero doy de alta la empresa en el fichero de tramos
     || si no existia
     |HAZ cretam01;

     || Borro los tramos que existieran de este NAFSS

     aNAFSS = #labtraba#75;
     |QBF aNAFSS;
     aAlfa1 = aNAFSS % 102;
     aAlfa2 = aNAFSS % 310;
     |QBF aAlfa2;
     aAlfa2 = ("0000000000" + aAlfa2) % -110;
     aNAFSS = aAlfa1 + aAlfa2;

     |BUCLE borra_tramos;

     |SI #labtraba#129 = "R"; |O #labtraba#129 = "T";
     |O #labtraba#129 = "A"; |O #labtraba#129 = "E";
          || en este caso las lineas van a quedar grabadas con el codigo 00000
          || primero se graba la del primer trabajador con su codigo y despues
          || se sobreescribe con los datos del otro con 00000
          || asi que he de borrar ademas del codigo del trabajador, el 00000
          nTraGuarda = nTra;

          nTra = 00000;

          aNAFSS = #labtraba#75;
          |QBF aNAFSS;
          aAlfa1 = aNAFSS % 102;
          aAlfa2 = aNAFSS % 310;
          |QBF aAlfa2;
          aAlfa2 = ("0000000000" + aAlfa2) % -110;
          aNAFSS = aAlfa1 + aAlfa2;

          |BUCLE borra_tramos;
          nTra = nTraGuarda;
     |FINSI;

     || Primero: fecha inicio y fin periodo

     swDesde = 0; swHasta = 0; swPrest = 0;

     swTrabMatTP = 0;
     swTrabERETP = 0;

     fFechaIniTramo = fFechaIniPer;
     nCodTipo = 001;
     aDesTipo = "INI PERIODO";
     |HAZ GrabaTramo;
     fFechaIniTramo = fFechaFinPer;
     nCodTipo = 999;
     aDesTipo = "FIN PERIODO";
     |HAZ GrabaTramo;

     || ahora busco el nomintal, que tiene los intervalos de alta/baja
     || de trabajadores que lo usen

     swIntervalos = 0;
     nDiasMesInt = 0;
     |HAZ intervalos;

     || Segundo: busco ITs
     |HAZ BuscaITs;

     || Tercero: busco variaciones para ver si el alta del trabajador ha sido
     || debida a alguna circunstancia que provoque cambio de tramo y hay que
     || poner el codigo

     |HAZ variaciones;

     || Cuarto: busco fechas de bonificaciones, inicio o fin
     |HAZ bonificaciones;

     || En ultimo lugar, hare la union de tramos

     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #0#5 = 0; |O #0#5 ] 5;
               |HAZ Citricos;
          |FINSI;
     |FINSI;

     || primero miro a ver cual es la ultima linea

     |BUCLE UltimaLinea;
     || Y ahora hago la union para crear los tramos

     |SELECT #1#cretam04;
     |HAZ union;

     || Paso siguiente: Ajuste Mensual
     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y #labtraba#42 ! "C"; |Y #labtraba#42 ! "F";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #labtraba#33 [ 07;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI #labtraba#42 = "D"; |Y #labtraba#64 = "M";
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
          |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5;
          |O nElMes = 7; |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
               || esto lo hago porque ecesito saber cuantos dias naturales se
               || han trabajado, asi si hay mas de una ficha, lo tengo y si
               || los trabajadores son mensuales, dentro del CuantaDiasTrab
               || del siguiente bucle, lo marco al final para que le ponga
               || el M-51. De otro modo no lo pone en los que son cambio
               || de contrato o de ficha por lo que sea siendo mensuales
               || lo tiene que poner en los dos, por cierto

               nDiasTrab = 0;
               |BUCLE CuentaDiasTrab;

               |HAZ AjusteMensual;
          |SINO;
               || tengo que hacerlo porque quiero saber cual es la ultima
               || linea de alta, y esto se cuenta en este bucle
               |BUCLE CuentaDias;
          |FINSI;
     |SINO;
          || tengo que hacerlo porque quiero saber cual es la ultima
          || linea de alta, y esto se cuenta en este bucle
          |BUCLE CuentaDias;
     |FINSI;

     nDiasCotAlta2 = 0;
     swHuelgaParcial = 0;
     |BUCLE CuentaDiasTrab2;
     aAlfa = #labempre#10; |QBF aAlfa;
     |SI aAlfa = "A30121404";       || milenium, ayuda a domicilio, huelga TP
          |SI swHuelgaParcial = 1;
               nDiasCotAlta = nDiasCotAlta2;
          |FINSI;
     |FINSI;
     || lo ultimo: grabacion de bases
     |HAZ Bases;

     swHayCEC = 0;
     |SI #0#5 = 00; |Y #0#0 ] 2017;               || tipo 0
     |Y #nomparam#3 = 0;                          || parametro desactivado
     |Y #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";|| agrarios no
     ||Y #labtraba#247 ! 0112;                     || artistas tampoco
     |Y swIplabor2 = 1;
          || solo tipo CERO !!!
          |HAZ CEC;
     |FINSI;

     || en caso de M51, he de ponerlo en todos los
     || tramos, si tiene varios trabajadores

     |SI swHayCEC = 0;
          swM51 = 0;    || inicializo
          swBuscaM51 = 1;    || primero busco si hay M51
          |BUCLE M51;
          |SI swM51 = 1;
               swBuscaM51 = 2;    || si encuentro alguno, lo grabo en todos
               |BUCLE M51;
          |FINSI;

          || no hay que hacer nada de esto en caso de que se haya hecho
          || por el calculo nuevo CEC, esto se hace en el BUCLE nomcot02

          || ATENCION, ESTA LA POSIBILIDAD DE QUE SE HAYA CAMBIADO DE TRABAJADOR
          || PERO NO HAYA QUE CREAR UN NUEVO TRAMO, POR QUE HAYA SIDO CAMBIO DE
          || CATEGORIA POR EJEMPLO
          |HAZ DosFichasSinRuptura;

          || busco si existe un codigo de trabajador en este periodo que empieza
          || tramo el mismo dia, se tratara de un trabajador que tiene dos
          || codigos de alta en el mismo periodo exactamente

          |SI nTipo = 00;
               || solo en tipo 0, el finiquito da problemas y no tiene mucho snetido
               |HAZ FichasDupli;   || esta en el cretapf1
          |FINSI;
     |FINSI;

     || una cosa mas, comprobar bases mes anterior para poner una marca de
     || que las bases son las mismas este mes

     |HAZ MesAnterior;
|FPRC;

|DEFBUCLE nomcalac;
     #nomcalac#1;
     ;
     #labempre#0,     1, nDesdeMes, nDesdeTipo;
     #labempre#0, 99999, nHastaMes, nHastaTipo;
     ;
     NULL, generador;
|FIN;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #labempre#0,     1, nAnyXX, nDesdeMes, nDesdeTipo;
     #labempre#0, 99999, nAnyXX, nHastaMes, nHastaTipo;
     ;
     NULL, generador;
|FIN;

|DEFBUCLE nomcalca;
     #nomcalca#1;
     ;
     #labempre#0,     1, #0#1, nHastaTipo;
     #labempre#0, 99999, #0#1, nDesdeTipo;
     ;
     NULL, generador;
|FIN;

|PROCESO carga_temporal;

     nDesdeTipo = #0#5;         || limites de tipo para el bucle
     nHastaTipo = #0#5;         || si es el RED, lo que vengan del DEF

     |SI #0#5 = 98;
          nHastaTipo = 0;
          nDesdeTipo = 0;
     |FINSI;

     |SI #0#5 = 90;
          nHastaTipo = 5;
          nDesdeTipo = 5;
     |FINSI;

     nDesdeMes = #0#1;
     |SI #0#3 = "A"; |O #0#3 = "T";
          nHastaMes = #0#4;
     |SINO;
          nHastaMes = nDesdeMes;
     |FINSI;

     || procesos de carga

     tipo_bot = #0#5; tipo_top = #0#5;
     nAnyXX = #0#0 - 2000;

     |SI #0#3 = "M";    |BUCLE nomcalca;     |FINSI;

     |SI #0#3 = "H";    |BUCLE nomhicca;     |FINSI;
     |SI #0#3 = "T";    |BUCLE nomhicca;     |FINSI;

     |SI #0#3 = "A";    |BUCLE nomcalac;     |FINSI;

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     |BUCLE limpia_NAFSS;
|FPRC;

|| PROCESOS PARA BORRAR SI EXISTIERAN, DENTRO DE LAS EMPRESAS CCCs SIN
|| NINGUN TRABAJADOR PORQUE SE HUBIERAN QUEDADO GRABADOS POR ERROR

|PROCESO limpia_CCC_2;
     swHayAlguno = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE limpia_CCC_2;
     #cretam03#1;
     ;
     #cretam02#0, #cretam02#1, #cretam02#2, #cretam02#3, #cretam02#4, "            ";
     #cretam02#0, #cretam02#1, #cretam02#2, #cretam02#3, #cretam02#4, "zzzzzzzzzzzz";
     ;
     NULL, limpia_CCC_2;
|FIN;

|PROCESO limpia_CCC;
     swHayAlguno = 0;
     |BUCLE limpia_CCC_2;
     |SI swHayAlguno = 0;
          |BORRA 020#cretam02.a;
          |LIBERA #cretam02;
     |FINSI;
|FPRC;

|DEFBUCLE limpia_CCC;
     #cretam02#1;
     ;
     nEmp, nAny, nMes, nTipo, "           ";
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzz";
     ;
     NULL, limpia_CCC;
|FIN;

|PROCESO empresas1;
     |SI #labempre#67 = "S";
          |DDEFECTO #tsilco14;
          #tsilco14#0 = #labempre#0;
          |LEE 000#tsilco14.=;
          |SI #0#2 = "S";
               |SI FSalida ! 0; |O #tsilco14#2 ! "*";
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI swCuenta = 1;
               nTotalEmp = nTotalEmp + 1;
               aAlfa = nTotalEmp;
               |QBF aAlfa;
               aAlfa = ("    " + aAlfa) % -104;
               ||ATRI R; |PINTA 2051, aAlfa; |ATRI 0;
          |SINO;
               nNroEmp = nNroEmp + 1;
               aAlfa = nNroEmp; |QBF aAlfa;
               aAlfa = "  Empresa " + aAlfa + " de " + aTotalEmp;
               || |ATRI R; |PINTA 2028, aAlfa; |ATRI 0;
          |FINSI;

          nTrabEmp = 0;
          |HAZ carga_temporal;
          |SI nTrabEmp = 0;
               |SI swCuenta = 1;
                    nTotalEmp = nTotalEmp - 1;
                    aAlfa = nTotalEmp;
                    |QBF aAlfa;
                    aAlfa = ("    " + aAlfa) % -104;
                    |ATRI R; |PINTA 2051, aAlfa; |ATRI 0;
               |SINO;
                    nNroEmp = nNroEmp - 1;
                    aAlfa = nNroEmp;
                    |QBF aAlfa;
                    aAlfa = "  Empresa " + aAlfa + " de " + aTotalEmp;
                    |ATRI R; |PINTA 2028, aAlfa; |ATRI 0;
               |FINSI;
          |SINO;
               |SI swCuenta ! 1;
                    |BUCLE limpia_CCC;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE empresas;
     #labempre#1;
     ;
     00001;
     99999;
     ;
     NULL, empresas1;
|FIN;

|PROCESO CargaTramos;
     |ATRI R;
     ||            1   2         3         4         5         6
     ||            56789012345678901234567890123456789012345678901234
     |PINTA 1715, "                                                  ";
     |PINTA 1815, " Realizando  recuento de  empresas y trabajadores ";
     |PINTA 1915, " ------------------------------------------------ ";
     |PINTA 2015, "           N£mero de empresas ...:                ";
     |PINTA 2115, "           N£mero de trabajadores:                ";
     |PINTA 2215, "                                                  ";
     |ATRI 0;

     swCuenta = 1;
     nTotalEmp = 0;
     nTotalTra = 0;

     |BUCLE empresas;
     aTotalEmp = nTotalEmp;
     aTotalTra = nTotalTra;
     |ATRI R;
     ||            1   2         3         4         5         6
     ||            56789012345678901234567890123456789012345678901234
     |PINTA 1715, "                                                  ";
     |PINTA 1815, " Procesando la generaci¢n de tramos de cotizaci¢n ";
     |PINTA 1915, " ------------------------------------------------ ";
     |PINTA 2015, "                                                  ";
     |PINTA 2115, "                                                  ";
     |PINTA 2215, "                                                  ";
     |ATRI 0;

     swCuenta = 0;
     |BUCLE empresas;
|FPRC;

|PROCESO Centra;
     aLon = aCadena % 0;
     nLon = aLon;
     nBlancos = nEspacio - nLon;
     nNume = nBlancos / 2;
     nBlancosIzd = nNume ! 0;
     nBlancosDer = nBlancos - nBlancosIzd;
     aBlancosIzd = " " * nBlancosIzd;
     aBlancosDer = nBlancosDer * " ";
     aCadenaSal = aBlancosIzd + aCadena + aBlancosDer;
|FPRC;

|PROCESO Mensaje;
     |ATRI R;
     |BLANCO 16142265;
     ||CUADRO 16142265;
               ||  1       2         3         4         5         6
               ||  234567890123456789012345678901234567890123456789012345678

     aLinea = "Se han generado los tramos pertenecientes a";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 1715, aCadenaSal;
     aLinea = "la liquidaci¢n solicitada. Se incluyen:"
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 1815, aCadenaSal;
     aAlfa = nTotalEmp; |QBF aAlfa;
     aLinea = aAlfa + " empresas";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 2015, aCadenaSal;
     aAlfa = nTotalTra; |QBF aAlfa;
     aLinea = aAlfa + " trabajadores";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 2115, aCadenaSal;
     |PINTA 2215, "                                                  ";

     |ATRI 0;
     |PAUSA;
|FPRC;

|PROCESO tipo3;
     |ABRE #labempre;
     |ABRE #labtraba;
     ||ABRE #tsilcon5;
     |ABRE #tsilco14;
     |ABRE #tsilco15;
     |ABRE #nomparam;

     |ABRE #labcentr;
     |ABRE #nomcenes;

     |ABRE #nomcalca;
     |ABRE #nomcalli;
     |ABRE #nomhicca;
     |ABRE #nomhicli;
     |ABRE #nomcalac;
     |ABRE #nomabsca;
     |ABRE #nomabsli;

     |ABRE #cretam01;
     |ABRE #cretam02;
     |ABRE #cretam03;
     |ABRE #cretam04;

     ||ABRE #tsilcon6;
     ||SELECT #2#tsilcon6;

     |HAZ control;

     |SI #0#3 = "M"; |O #0#3 = "H";
          |HAZ CargaTramos;
     |FINSI;

     |SI #0#3 = "A"; |O #0#3 = "T";
          |HAZ CargaTramos;
     |FINSI;

     ||CIERRA #tsilcon6;

     |CIERRA #cretam04;
     |CIERRA #cretam03;
     |CIERRA #cretam02;
     |CIERRA #cretam01;

     |CIERRA #nomabsli;
     |CIERRA #nomabsca;
     |CIERRA #nomcalac;
     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
     |CIERRA #nomcalli;
     |CIERRA #nomcalca;
     |CIERRA #nomcenes;

     |CIERRA #labcentr;
     |CIERRA #labempre;
     |CIERRA #labtraba;
     ||CIERRA #tsilcon5;
     |CIERRA #tsilco14;
     |CIERRA #tsilco15;
     |CIERRA #nomparam;

     |DBASS aAlfa; |QBF aAlfa;
     |SI aAlfa ! "/u/dsasesor/"; |Y aAlfa ! "/u/dsprofes/";
          |DELINDEX #tsilco14;      || parrilla empresas        se queda con la seleccion
          |DELINDEX #tsilco15;      || parrilla trabajadores    para volver a hacer el
     |FINSI;                                              || lote
|FPRC;

|PROCESO ElProceso;
     nElAny = #0#0;
     nElMes = #0#1;
     |SI 05 [ #0#5; |Y #0#5 [ 90;
          nAnyLote = #0#6;
     |SINO;
          nAnyLote = #0#0;
     |FINSI;

     enDesCen = 1;
     enHasCen = 999;
     eaFuente = #0#3;
     |HAZ tipo3;
|FPRC;

|PROCESO Version;
     |DBASE aAlfa;
     aAlfa1 = aAlfa - "aginom";
     |SI aAlfa ! aAlfa1;
          swAginom = 1;
     |SINO;
          swIplabor2 = 1;
     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ Version;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "";
          |CLS;
          |CABEZA "GENERACION LIQUIDACION CRETA";

          |ABRE #0;
          |LEE 000#0p;
          |SI FSalida ! 0;
               |DDEFECTO #0;
               |GRABA 020#0n;
          |FINSI;
          |LEE 101#0=;

          ||HAZ defectoMesAny;
          |HAZ ActivaCampos;
          ||HAZ notipo;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               alfa4 = Usuario; |QBT alfa4; alfa4 = ("w" + alfa4) % 108;
               |NOME_DAT #cretat04#alfa4#;
               |DELINDEX #cretat04;
               |ABRE #cretat04;

               |HAZ ElProceso;
               |SI nTotalEmp > 0; |Y nTotalTra > 0;
                    |HAZ Mensaje;
               |SINO;
                    aAlfa = "    No se han encontrado trabajadores para incluir ";
                    aAlfa = aAlfa + "en la liquidación del periodo solicitado";
                    |MENAV aAlfa;
               |FINSI;

               |CIERRA #cretat04;
          |FINSI;

          |GRABA 020#0a;
          |LIBERA #0;
          |CIERRA #0;
     |FINSI;
|FPRO;
