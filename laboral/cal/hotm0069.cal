|FICHEROS;
     hotm0069 #0;

     nomcalca #1;
     nomhicca #70;
     labtraba #2;
     labempre #3;

     hotm0011 #9;    || centros
     hotm0007 #4;    || areas (grupos)
     hotm0008 #5;    || secciones (subgrupos)
     hotm0009 #6;    || prorrata cabs. mensual
     hotm0010 #7;    || prorrata lins. mensual
     hotm0068 #8;    || temporal prorrata
     hotm0070 #100;    || temporal agrupado por categorias

     hotm0012 #10;    || prorrata cabs.  || por si no existe la mensual
     hotm0013 #11;    || prorrata lins.

     nomtmpca #50;
     nomconca;
     labcentr;
     nomauxi1;
     nomauxi2;
     nomcateg;

     hotm0060;
     hotm0061;
     hotm0062;
     hotm0072;
     hotm0073 #101;
|FIN;

|VARIABLES;
     nDesdeCentro=0;
     nHastaCentro=0;
     aDesdeArea="";
     aHastaArea="";
     aDesdeSeccion="";
     aHastaSeccion="";

     Comodin = "";

     i=0;
     j=0;
     nModo=0;
     fFecha=@;
     aCadena="";
     aAnyo="";
     aMes="";
     para1 = 0;
     nSalida = 0;
     nNume1=0;
     nNume2=0;
     &nMes = 0;
     nAnyo = 0;
     aAlfa = "";
     aFechaAlta = "";
     nDiaAlta = 0;
     nMesAlta = 0;
     nAnyAlta = 0;
     nMesMant = 0;
     aFechaBaja = "";
     nDiaBaja = 0;
     nMesBaja = 0;
     nAnyBaja = 0;
     &nAny = 0;
     nHoras = 0;
     &nTopemes = 0;
     swSigue = 0;
     nCampo = 0;

     aNombreArea = "";
     aNombreSeccion = "";
     aNombreCentro = "";
     aDato = "";
     aLinea = "";
     alfa2 = "";
     nCanal = 0;
     aFichero = "";
     aPath = "";
|FIN;

|VARIABLES;
    cabeza_tit = "RESUMEN NOMINAS MENSUAL - ";
    month = 0;
    mesos = 0;
    seleccio = 0;
    sw = 0;
    empresa = 0;
    aAlfa1="";

    ginf_enf = 0;
    ginf_pro = 0;
    ginf_hor = 0;
    ginf_dia = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_tan = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_exe = 0;

    sinf_enf = 0;
    sinf_pro = 0;
    sinf_hor = 0;
    sinf_dia = 0;
    sinf_sub = 0;
    sinf_bru = 0;
    sinf_dto = 0;
    sinf_tan = 0;
    sinf_ded = 0;
    sinf_dse = 0;
    sinf_liq = 0;
    sinf_sss = 0;
    sinf_exe = 0;

    cinf_enf = 0;
    cinf_pro = 0;
    cinf_hor = 0;
    cinf_dia = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_tan = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_exe = 0;
    tinf_tan = 0;
    nume1 = 0;
    nume2 = 0;
    fech1 = @;
    fech2 = @;
    fecsys = @;
    alfa1 = "";
    error0       = "     Proceso ABORTADO !!! ";
    informe = "hotm0070";
    &p_mes = " ";
    &swlin = 0;
    &varinf1 = "";
    &varinf2 = "";

    &inf_enf = 0;
    &inf_pro = 0;
    &inf_hor = 0;
    &inf_dia = 0;
    &inf_sub = 0;
    &inf_bru = 0;
    &inf_dto = 0;
    &inf_tan = 0;
    &inf_ded = 0;
    &inf_dse = 0;
    &inf_liq = 0;
    &inf_sss = 0;
    &inf_exe = 0;

    &pinf_enf = 0;
    &pinf_pro = 0;
    &pinf_hor = 0;
    &pinf_dia = 0;
    &pinf_sub = 0;
    &pinf_bru = 0;
    &pinf_dto = 0;
    &pinf_ded = 0;
    &pinf_dse = 0;
    &pinf_liq = 0;
    &pinf_sss = 0;
    &pinf_exe = 0;

    &tinf_enf = 0;
    &tinf_pro = 0;
    &tinf_hor = 0;
    &tinf_dia = 0;
    &tinf_sub = 0;
    &tinf_bru = 0;
    &tinf_dto = 0;
    &tinf_ded = 0;
    &tinf_dse = 0;
    &tinf_liq = 0;
    &tinf_sss = 0;
    &tinf_exe = 0;

    &fecha = @;
    &cabeza = "";
    gcentr="";
    grupo = "";
    subgr = "";
    campo1 = 0;
    campo2 = 0;
    campo3 = 0;
    campo4 = 0;
    campo5 = 0;
    campo6 = 0;
    campo7 = 0;
    campo8 = 0;
    campo9 = 0;
    campoa = 0;
    campob = 0;
    campoc = 0;
    ultimo = 0;
    centro="";
    area = "";
    secc = "";
    coef = 0;

    dia = 0;
    mes = 0;
    any = 0;
    swbaja = 0;
    fecalf = "";
    FEstado = 0;
    FEstado2 = 0;

     nAnyHis = 0;
     nAntEmp = 0;
     nAntTra = 0;
     nTipo = 0;
     nTipoDesde = 0;
     nTipoHasta = 0;
     nPos = 0;
     swError = 0;
|FIN;

|PROCESO Ruta;
     aAlfa = #0#56;
     |QBF aAlfa;
     aAlfa1 = aAlfa % -101;
     |SI aAlfa1 ! "\";
          aAlfa = aAlfa + "\";
     |FINSI;
     #0#56 = aAlfa;
     |PINTA #0#56;
|FPRC;

|PROCESO PintaGrupo;
     |SI nCampo = 48; nPos = 1740; |FINSI;
     |SI nCampo = 49; nPos = 1840; |FINSI;
     |SI nCampo = 50; nPos = 1940; |FINSI;
     |SI nCampo = 51; nPos = 2040; |FINSI;
     |SI nCampo = 52; nPos = 2140; |FINSI;

     |SI #0nCampo = 1; aAlfa = "Empresa    "; |FINSI;
     |SI #0nCampo = 2; aAlfa = "Establec.  "; |FINSI;
     |SI #0nCampo = 3; aAlfa = "Area       "; |FINSI;
     |SI #0nCampo = 4; aAlfa = "Departamto."; |FINSI;
     |SI #0nCampo = 5; aAlfa = "Categor¡a  "; |FINSI;
     |SI #0nCampo = 0; aAlfa = "Ninguna    "; |FINSI;

     |ATRI I;
     |PINTA nPos, aAlfa;
     |ATRI 0;
|FPRC;

|PROCESO CompruebaGrupo;
     nCampo = Campo;
     |HAZ PintaGrupo;

     |PARA nCampo = 48; |SI nCampo [ 52; |HACIENDO nCampo = nCampo + 1;
          |SI nCampo ! Campo; |Y #0nCampo ! 0;
               |SI #0nCampo = #0Campo;
                    |MENAV "    ATENCION: Ya se está agrupando por esta entidad";
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO PintaGrupoIni; |TIPO 7;
     |PARA nCampo = 48; |SI nCampo [ 52; |HACIENDO nCampo = nCampo + 1;
          |HAZ PintaGrupo;
     |SIGUE;
|FPRC;

|PROCESO AyudaGrupo; |TIPO 7;
     |PUSHV 11532380;
     |BLANCO 11532380;
     |CUADRO 11542379;

     |PINTA 1256, "Introduzca el orden en";
     |PINTA 1356, "que se  agrupar n  las";
     |PINTA 1456, "entidades por  las que";
     |PINTA 1556, "desee ordenar:        ";
     |PINTA 1656, "                      ";
     |PINTA 1756, "(1) Empresa           ";
     |PINTA 1856, "(2) Establecimiento   ";
     |PINTA 1956, "(3) Area              ";
     |PINTA 2056, "(4) Departamento      ";
     |PINTA 2156, "(5) Categor¡a         ";
     |PINTA 2256, "(0) Ninguna           ";

|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO MesLetra;
     |SI nMes = 1;  p_mes = "ENERO     ";  |FINSI;
     |SI nMes = 2;  p_mes = "FEBRERO   ";  |FINSI;
     |SI nMes = 3;  p_mes = "MARZO     ";  |FINSI;
     |SI nMes = 4;  p_mes = "ABRIL     ";  |FINSI;
     |SI nMes = 5;  p_mes = "MAYO      ";  |FINSI;
     |SI nMes = 6;  p_mes = "JUNIO     ";  |FINSI;
     |SI nMes = 7;  p_mes = "JULIO     ";  |FINSI;
     |SI nMes = 8;  p_mes = "AGOSTO    ";  |FINSI;
     |SI nMes = 9;  p_mes = "SEPTIEMBRE";  |FINSI;
     |SI nMes = 10; p_mes = "OCTUBRE   ";  |FINSI;
     |SI nMes = 11; p_mes = "NOVIEMBRE ";  |FINSI;
     |SI nMes = 12; p_mes = "DICIEMBRE ";  |FINSI;
|FPRC;

|PROCESO MesLetra2;
     |SI nMes = 1;  p_mes = "ENERO";  |FINSI;
     |SI nMes = 2;  p_mes = "FEBRERO";  |FINSI;
     |SI nMes = 3;  p_mes = "MARZO";  |FINSI;
     |SI nMes = 4;  p_mes = "ABRIL";  |FINSI;
     |SI nMes = 5;  p_mes = "MAYO";  |FINSI;
     |SI nMes = 6;  p_mes = "JUNIO";  |FINSI;
     |SI nMes = 7;  p_mes = "JULIO";  |FINSI;
     |SI nMes = 8;  p_mes = "AGOSTO";  |FINSI;
     |SI nMes = 9;  p_mes = "SEPTIEMBRE";  |FINSI;
     |SI nMes = 10; p_mes = "OCTUBRE";  |FINSI;
     |SI nMes = 11; p_mes = "NOVIEMBRE";  |FINSI;
     |SI nMes = 12; p_mes = "DICIEMBRE";  |FINSI;
|FPRC;

|PROCESO defectos; |TIPO 7;
     |HAZ pintames;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
     nMes = #0#3;
     |HAZ MesLetra;
     aAlfa = p_mes;

     |ATRI I;
     |PINTA 1341, aAlfa;
     |ATRI 0;
|FPRC;

*****************************************************************************
    LECTURA E IMPRESION
*****************************************************************************

|PROCESO errores;
     swError = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE errores;
     #101#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, errores;
|FIN;

|PROCESO Numero;
     aAlfa = aDato % -301;
     |SI aAlfa ! ".";
          aAlfa = aDato % -201;
          |SI aAlfa ! ".";
               aDato = aDato + ".00";
          |SINO;
               aDato = aDato + "0";
          |FINSI;
     |FINSI;
     |QBF aDato;
     aDato = ("          " + aDato) % -110;
|FPRC;

|PROCESO registros;
|| xxxxxxxxxxxxx
     aLinea = "";

     #hotm0060#0 = #100#0;
     |LEE 000#hotm0060.=;
     |SI FSalida = 0;
          aDato = #hotm0060#1; |QBF aDato; aDato = ("000" + aDato) % -103;
     |SINO;
          aDato = "XXX";
          || ERROR
     |FINSI;
     aLinea = aLinea + aDato + "#";

     #hotm0061#0 = #100#15;
     |LEE 000#hotm0061.=;
     |SI FSalida = 0;
          aDato = #hotm0061#1; |QBF aDato; aDato = ("00" + aDato) % -102;
     |SINO;
          aDato = "XX";
          || ERROR
     |FINSI;
     aLinea = aLinea + aDato + "#";

     #hotm0062#0 = #100#2;
     |LEE 000#hotm0062.=;
     |SI FSalida = 0;
          aDato = #hotm0062#1; |QBF aDato; aDato = ("00" + aDato) % -102;
     |SINO;
          aDato = "XX";
          || ERROR
     |FINSI;
     aLinea = aLinea + aDato + "#";

     aDato = #100#18;
     aLinea = aLinea + aDato + "#";

     alfa1 = #0#2;
     alfa2 = #0#3; |QBF alfa2; alfa2 = ("00" + alfa2) % -102;
     aDato = alfa1 + alfa2;
     aLinea = aLinea + aDato + "#";

     aDato = #100#10;
     |HAZ Numero;
     aLinea = aLinea + aDato + "#";

     aDato = #100#11;
     |HAZ Numero;
     aLinea = aLinea + aDato + "#";

     aLinea = aLinea + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|DEFBUCLE registros;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, registros;
|FIN;

|PROCESO GeneraFichero;
     |ABRE #hotm0060;
     |ABRE #hotm0061;
     |ABRE #hotm0062;

     aPath = #0#56;
     |QBF aPath;
     |RMKDIR aPath;
     aFichero = #0#57;
     |QBF aFichero;
     aPath = aPath + aFichero;

     |XABRE "CBW", aPath, nCanal;
     |BUCLE registros;
     |XCIERRA nCanal;

     |CIERRA #hotm0062;
     |CIERRA #hotm0061;
     |CIERRA #hotm0060;
|FPRC;

|PROCESO impresion;
     |PRINT;
|FPRC;

|DEFBUCLE impresion;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, impresion;
|FIN;

|PROCESO agrupar;
     |DDEFECTO #100;
     #100#0 = #8#0;
     #100#15 = #8#15;
     #100#2 = #8#2;
     #100#18 = #8#18;
     |LEE 101#100=;
     FEstado = FSalida;
     #100#7 = #100#7 + #8#7;
     #100#13 = #100#13 + #8#13;
     #100#5 = #100#5 + #8#5;
     #100#10 = #100#10 + ((#8#7 + #8#13 - #8#5) / #8#17);
     #100#11 = #100#11 + ((#8#7 + #8#13 - #8#5) / #8#16);

     |SI FEstado = 0;
          |GRABA 020#100a;
     |SINO;
          |GRABA 020#100n;
     |FINSI;
|FPRC;

|DEFBUCLE lee_temporal;
     #8#1;
     ;
     00001, #0#7, "  ", 00001;
     99999, #0#8, "zz", 99999;
     ;
     NULL, agrupar;
|FIN;

****************************************************************************
               GRABACION DEL TEMPORAL
****************************************************************************

|PROCESO limpieza;
|DDEFECTO #7;
    campo1 = 0;
    campo2 = 0;
    campo3 = 0;
    campo4 = 0;
    campo5 = 0;
    campo6 = 0;
    campo7 = 0;
    campo8 = 0;
    campo9 = 0;
    campoa = 0;
    campob = 0;
    campoc = 0;
    ultimo = 0;
|FPRC;

|PROCESO ultimo;
    ultimo = #7#4;
|FPRC;

|PROCESO ultimo2;
    ultimo = #11#2;
|FPRC;

|PROCESO graba;
     |DDEFECTO #8;
     |SI #0#45 = "N";         || agrupar empresas S/N
          |SI #0#43 = "M";
               #8#0 = #1#0;       || empresa (proc.mensual)
               #8#1 = #1#1;       || trabajador
          |SINO;
               #8#0 = #70#0;      || empresa (proc.historico)
               #8#1 = #70#1;      || trabajador
          |FINSI;
     |SINO;
          #8#0 = 1;                || siempre la misma empresa
          |SI #0#43 = "M";
               #8#1 = (#1#0 * 100000) + #1#1;       || trabajador
          |SINO;
               #8#1 = (#70#0 * 100000) + #70#1;     || trabajador
          |FINSI;
     |FINSI;

     #labempre#0 = #8#0;
     |LEE 020#labempre.=;

     #labtraba#0 = #8#0;
     #labtraba#1 = #8#1;
     |LEE 020#labtraba.=;

     #8#15 = centro;      || centro
     #8#2 = area;         || area
     #8#3 = secc;         || seccion
     |LEE 101#8=;
     FEstado = FSalida;

     #8#4 = coef;         || coeficiente

     |DDEFECTO #hotm0072;
     #hotm0072#0 = #labtraba#87;
     #hotm0072#1 = #labtraba#17;
     |LEE 000#hotm0072.=;
     FEstado2 = FSalida;
     aAlfa = #hotm0072#3;          || categoria EVOLOGY
     |QBF aAlfa;
     |SI aAlfa = ""; |O FEstado2 ! 0;
          #hotm0073#0 = #labtraba#0;
          #hotm0073#1 = #labtraba#1;
          |LEE 101#hotm0073.=;
          |SI FSalida ! 0;
               #hotm0073#0 = #labtraba#0;
               #hotm0073#1 = #labtraba#1;
               #hotm0073#2 = #labtraba#87;
               #hotm0073#3 = #labtraba#17;
               |GRABA 020#hotm0073.n;
          |FINSI;
          |LIBERA #hotm0073;
     |FINSI;

     || #8#18 = #labtraba#17;         || categoria
     #8#18 = #hotm0072#3;          || categoria EVOLOGY

     #nomcateg#0 = #labtraba#87;
     #nomcateg#1 = #labtraba#17;
     |LEE 000#nomcateg.=;
     #8#25 = #nomcateg#2;          || descripcion categoria

     #8#19 = #labempre#2;          || nombre empresa
     #8#20 = #labtraba#2;          || nombre trabajador
     #8#21 = #labtraba#7;          || DNI trabajador
     #8#22 = aNombreCentro;        || nombre centro
     #8#23 = aNombreArea;          || nombre area
     #8#24 = aNombreSeccion;       || nombre seccion

     |SI #7#4 ! ultimo;
          #8#5 = #8#5 + (inf_enf * #8#4);     || campo  1
          #8#6 = #8#6 + (inf_sub * #8#4);     || campo  2
          #8#7 = #8#7 + (inf_bru * #8#4);     || campo  3
          #8#8 = #8#8 + (inf_dto * #8#4);     || campo  4
          #8#9 = #8#9 + (inf_tan * #8#4);     || campo  5
          #8#10 = #8#10 + (inf_ded * #8#4);   || campo  6
          #8#11 = #8#11 + (inf_dse * #8#4);   || campo  7
          #8#12 = #8#12 + (inf_liq * #8#4);   || campo  8
          #8#13 = #8#13 + (inf_sss * #8#4);   || campo  9
          #8#14 = #8#14 + (inf_exe * #8#4);   || campo 10
          || #8#16 = #8#16 + (inf_pro * #8#4);   || campo 16 (prorrata)
          #8#16 = #8#16 + (inf_dia * #8#4);   || campo 16 (prorrata)
          #8#17 = #8#17 + (inf_hor * #8#4);   || campo 16 (horas)
          campo1 = campo1 + (inf_enf * #8#4);
          campo2 = campo2 + (inf_sub * #8#4);
          campo3 = campo3 + (inf_bru * #8#4);
          campo4 = campo4 + (inf_dto * #8#4);
          campo5 = campo5 + (inf_tan * #8#4);
          campo6 = campo6 + (inf_ded * #8#4);
          campo7 = campo7 + (inf_dse * #8#4);
          campo8 = campo8 + (inf_liq * #8#4);
          campo9 = campo9 + (inf_sss * #8#4);
          campoa = campoa + (inf_exe * #8#4);
          ||campob = campob + (inf_pro * #8#4); || (prorrata)
          campob = campob + (inf_dia * #8#4); || (prorrata)
          campoc = campoc + (inf_hor * #8#4); || (horas)
     |SINO;
          #8#5 = #8#5 + (inf_enf - campo1);   || campo  1
          #8#6 = #8#6 + (inf_sub - campo2);   || campo  2
          #8#7 = #8#7 + (inf_bru - campo3);   || campo  3
          #8#8 = #8#8 + (inf_dto - campo4);   || campo  4
          #8#9 = #8#9 + (inf_tan - campo5);   || campo  5
          #8#10 = #8#10 + (inf_ded - campo6);   || campo  6
          #8#11 = #8#11 + (inf_dse - campo7);   || campo  7
          #8#12 = #8#12 + (inf_liq - campo8);   || campo  8
          #8#13 = #8#13 + (inf_sss - campo9);   || campo  9
          #8#14 = #8#14 + (inf_exe - campoa);   || campo 10
          || #8#16 = #8#16 + (inf_pro - campob);   || campo 16 (prorrata)
          #8#16 = #8#16 + (inf_dia - campob);   || campo 16 (DIAS)
          #8#17 = #8#17 + (inf_hor - campoc);   || campo 17 (horas)
     |FINSI;
     |SI FEstado ! 0;
          |GRABA 020#8n;
     |SINO;
          |GRABA 020#8a;
     |FINSI;
     |LIBERA #8;
|FPRC;

|PROCESO prorrata;
     area = #7#7;
     secc = #7#9;
     centro = #7#5;
     coef = #7#11;
     aNombreArea = #7#8;
     aNombreSeccion = #7#10;
     aNombreCentro = #7#6;
     |HAZ graba;
|FPRC;

|PROCESO prorrata2;
     area = #11#5;
     secc = #11#7;
     centro = #11#3;
     coef = #11#9;
     aNombreArea = #11#6;
     aNombreSeccion = #11#8;
     aNombreCentro = #11#4;
     |HAZ graba;
|FPRC;

|PROCESO leetraba;
    swbaja = 0;
    |SI #0#43 = "M";
       fecalf = #1#5;
    |SINO;
       fecalf = #70#5;
    |FINSI;

    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;

|SI mes = #0#3; |Y any = #0#2;     swbaja = 1;    |FINSI;
|FPRC;

|PROCESO GrabaHistorico;
     |HAZ limpieza;
     |HAZ leetraba;
     |HAZ detalle;
     |ABRE #6;
     #6#0 = #70#0;
     #6#1 = #70#1;
     #6#2 = #0#2;  || a¤o
     #6#3 = #70#2;  || mes
     |LEE 001#6=;
     |SI FSalida = 0;
          |BUCLELIN 2ultimo#6;
          |BUCLELIN 2prorrata#6;
     |SINO;
          |ABRE #10;
          #10#0 = #70#0;
          #10#1 = #70#1;
          |LEE 001#10=;
          |SI FSalida = 0;
               |BUCLELIN 2ultimo2#10;
               |BUCLELIN 2prorrata2#10;
          |FINSI;
     |FINSI;
     |CIERRA #6;
|FPRC;

|PROCESO temporal;
     |ABRE #3;
     |DDEFECTO #3;
     |SI #0#43 = "M";
          #3#0 = #nomcalca#0;
     |SINO;
          #3#0 = #nomhicca#0;
     |FINSI;
     |LEE 020#3=;
     |CIERRA #3;

     |SI #3#36 = "N";   || si el switch de emision no es "N"
          |ACABA;
     |FINSI;

     |SI #0#43 = "M";
          #labtraba#0 = #1#0;
          #labtraba#1 = #1#1;
          |LEE 000#labtraba.=;

          |HAZ limpieza;
          |HAZ detalle;
          |ABRE #6;
          #6#0 = #1#0;
          #6#1 = #1#1;
          #6#2 = #0#2;  || a¤o
          #6#3 = #1#2;  || mes
          |LEE 001#6=;
          |SI FSalida = 0;
               |BUCLELIN 2ultimo#6;
               |BUCLELIN 2prorrata#6;
          |SINO;
               |ABRE #10;
               #10#0 = #1#0;
               #10#1 = #1#1;
               |LEE 001#10=;
               |SI FSalida = 0;
                    |BUCLELIN 2ultimo2#10;
                    |BUCLELIN 2prorrata2#10;
               |FINSI;
          |FINSI;
          |CIERRA #6;
     |FINSI;

     |SI #0#43 = "H";
          #labtraba#0 = #70#0;
          #labtraba#1 = #70#1;
          |LEE 000#labtraba.=;

          |HAZ GrabaHistorico;

     |FINSI;
|FPRC;

|PROCESO min;
     #8#0=0;
     #8#1=0;
     #8#2="  ";
     #8#3="  ";
     #8#15=0;
|FPRC;

|PROCESO max;
     #8#0=99999;
     #8#1=99999;
     #8#2="zz";
     #8#3="zz";
     #8#15=99;
|FPRC;

|DEFBUCLE Historico;
     #nomhicca#1;
     ;
     #0#0, #0#53, nAny, #0#3, 0;
     #0#1, #0#54, nAny, #0#3, 0;
     ;
     NULL, temporal;
|FIN;

|DEFBUCLE Mensual;
     #nomcalca#1;
     ;
     #0#0, #0#53, #0#3, 0;
     #0#1, #0#54, #0#3, 0;
     ;
     NULL, temporal;
|FIN;

|PROCESO imprime;
     ||Impresora = "CrystalReport";
     ||IMPRE -1;
     ||IMPRE 0;
     |SI FSalida = 0;
          fecha = #0#5;

          nMes = #0#3;
          |HAZ MesLetra2;
          aAlfa = p_mes;

          cabeza = cabeza_tit + aAlfa;
          |HAZ centra;
          alfa1 = Usuario; |QBT alfa1; alfa1 = ("c" + alfa1) % 108;
          |NOME_DAT #8 alfa1;
          |DELINDEX #8;
          |ABRE #1; |ABRE #70;
          ||INFOR informe;

          alfa1 = Usuario; |QBT alfa1; alfa1 = ("e" + alfa1) % 108;
          |NOME_DAT #101 alfa1;
          |DELINDEX #101;
          |ABRE #101;

          seleccio = 0;

          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #nomcateg;
          |ABRE #hotm0072;
          |ABRE #101;
          |ABRE #8;

          |SI #0#43 = "M";
               |BUCLE Mensual;
          |SINO;
               nAny = #0#2 - 2000;
               |BUCLE Historico;
          |FINSI;

          |CIERRA #8;
          |CIERRA #hotm0072;
          |CIERRA #nomcateg;
          |CIERRA #labtraba;
          |CIERRA #labempre;

          || IMPRESION

          alfa1 = Usuario; |QBT alfa1;    alfa1 = ("d" + alfa1) % 108;
          |NOME_DAT #100 alfa1;
          |DELINDEX #100;


          |ABRE #100;

          |BUCLE lee_temporal;
          |HAZ GeneraFichero;

          swError = 0;
          |BUCLE errores;
          |SI swError = 1;
               aAlfa = "    ATENCION. Existen trabajadores con categoría sin ";
               aAlfa = aAlfa + " equivalencia definida en Evology";
               |MENAV aAlfa;

               |CONSULTA_CLAVE #1#101;
          |FINSI;

          ||PIEINF;
          ||FININF;
          |DELINDEX #8;
          |CIERRA #70;
          |CIERRA #1;
          |CIERRA #100; |DELINDEX #100;
          |CIERRA #101; |DELINDEX #101;
     |SINO;
          |MENAV error0;
     |FINSI;
     |FINIMP;
|FPRC;

******************************************************************************
    CARGA DE VARIABLES
******************************************************************************

|PROCESO Horas;
     |SI #labtraba#42 = "T"; |O #labtraba#42 = "X";
          nHoras = (#labtraba#234) / 7 * 30;
     |SINO;
          |ABRE #nomconca;
          #nomconca#0 = #labtraba#87;
          |LEE 000#nomconca.=;
          |SI FSalida = 0;
               nHoras = #nomconca#162 / 7 * 30;
          |FINSI;
          |CIERRA #nomconca;
     |FINSI;
     |SI #0#43 = "M";
          aFechaAlta = #1#4;
          aFechaBaja = #1#5;
          nMesMant = #1#2;
     |SINO;
          aFechaAlta = #70#4;
          aFechaBaja = #70#5;
          nMesMant = #70#2;
     |FINSI;

     nDiaAlta = 1;
     |SI aFechaAlta ! "          "; |Y aFechaAlta ! "..........";
          aAlfa = aFechaAlta % 102;
          nDiaAlta = aAlfa;
          aAlfa = aFechaAlta % 402;
          nMesAlta = aAlfa;
          aAlfa = aFechaAlta % -104;
          nAnyAlta = aAlfa;
          |SI nMesAlta = nMesMant; |Y nAnyAlta = #0#2;
               nDiaAlta = nDiaAlta;
          |SINO;
               nDiaAlta = 1;
          |FINSI;
     |FINSI;

     nMes = #0#3;
     nAny = #0#2;
     |HAZ topemes_plb;
     nDiaBaja = nTopemes;
     |SI aFechaBaja ! "          "; |Y aFechaBaja ! "..........";
          aAlfa = aFechaBaja % 102;
          nDiaBaja = aAlfa;
          aAlfa = aFechaBaja % 402;
          nMesBaja = aAlfa;
          aAlfa = aFechaBaja % -104;
          nAnyBaja = aAlfa;
          |SI nMesBaja = nMesMant; |Y nAnyBaja = #0#2;
               nMes = nMesBaja;
               nAny = nAnyBaja;
               |HAZ topemes_plb;
               |SI #labtraba#42 = "T"; |O #labtraba#42 = "D";
                    nHoras = nHoras * ((nDiaBaja - nDiaAlta + 1) / nTopemes);
               |SINO;
                    nHoras = nHoras * ((nDiaBaja - nDiaAlta + 1) / 30);
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO detalle;
     |SI #0#43 = "M";
          inf_enf = #1#57 + #1#58;                       || prestaciones
          inf_pro = #1#38;                               || prorrata
          inf_sub = #1#46 - inf_enf + #1#45;             || coste trabajad.
          inf_bru = #1#46;                               || Importe bruto
          inf_dto = #1#38;                               || Importe prorrata
          inf_tan = #1#13; inf_tan = inf_tan ! 2;        || Porcentaje
          inf_ded = #1#75;                               || Deduccion IRPF
          inf_dse = #1#48 + #1#49 + #1#50 + #1#51;       || Deduccion S.S
          inf_liq = inf_bru -inf_ded -inf_dse;           || Liquido
          inf_sss = #1#45;                               || S.S CGO
          inf_exe = #1#18;                               || Base IRPF exenta

          nHoras = 0;
          |HAZ Horas;
          inf_hor = nHoras;
          inf_dia = (nDiaBaja - nDiaAlta + 1);    || dias
     |SINO;
          inf_enf = #70#57 + #70#58;                     || prestaciones
          inf_pro = #70#38;                              || prorrata
          inf_sub = #70#46 - inf_enf + #70#45;           || coste trabajad.
          inf_bru = #70#46;                              || Importe bruto
          inf_dto = #70#38;                              || Importe prorrata
          inf_tan = #70#13; inf_tan = inf_tan ! 2;       || Porcentaje
          inf_ded = #70#114;                             || Deduccion IRPF
          inf_dse = #70#48 + #70#49 + #70#50 + #70#51;   || Deduccion S.S
          inf_liq = (inf_bru -inf_ded -inf_dse);           || Liquido
          inf_sss = #70#45;                              || S.S CGO
          inf_exe = #70#18;                              || Base IRPF exenta
          nHoras = 0;
          |HAZ Horas;
          inf_hor = nHoras;                       || horas

          inf_dia = (nDiaBaja - nDiaAlta + 1);    || dias
     |FINSI;
|FPRC;

|PROCESO detalle_tmp;
    inf_enf = #8#05;                              || prestaciones
    inf_sub = #8#06;                              || coste trabajad.
    inf_bru = #8#07;                              || Importe bruto
    inf_dto = #8#08;                              || Importe prorrata
    inf_tan = #8#09;                              || Porcentaje
    inf_ded = #8#10;                              || Deduccion
    inf_dse = #8#11;                              || Deduccion S.S
    inf_liq = #8#12;                              || Liquido
    inf_sss = #8#13;                              || S.S CGO
    inf_exe = #8#14;                              || Base IRPF exenta
    ||inf_pro = #8#16;                              || prorrata
    inf_dia = #8#16;                              || dias
    inf_hor = #8#17;                              || horas
|FPRC;

|PROCESO grupos;
    ginf_enf = ginf_enf + inf_enf;       || Enfermedad
    || ginf_pro = ginf_pro + inf_pro;       || Prorrata
    ginf_dia = ginf_dia + inf_dia;       || Prorrata
    ginf_hor = ginf_hor + inf_hor;       || Horas
    ginf_sub = ginf_sub + inf_sub;       || Subnormalidad
    ginf_bru = ginf_bru + inf_bru;       || Importe bruto
    ginf_dto = ginf_dto + inf_dto;       || Importe prorrata
    ginf_tan = ginf_tan ! 2;             || Porcentaje
    ginf_ded = ginf_ded + inf_ded;       || Deduccion
    ginf_dse = ginf_dse + inf_dse;       || Deduccion S.S
    ginf_liq = ginf_liq + inf_liq;       || Liquido
    ginf_sss = ginf_sss + inf_sss;       || S.S CGO
    ginf_exe = ginf_exe + inf_exe;       || Base IRPF exenta
|FPRC;



|PROCESO subgr;
    sinf_enf = sinf_enf + inf_enf;       || Enfermedad
    || sinf_pro = sinf_pro + inf_pro;       || Prorrata
    sinf_dia = sinf_dia + inf_dia;       || Horas
    sinf_hor = sinf_hor + inf_hor;       || Horas
    sinf_sub = sinf_sub + inf_sub;       || Subnormalidad
    sinf_bru = sinf_bru + inf_bru;       || Importe bruto
    sinf_dto = sinf_dto + inf_dto;       || Importe prorrata
    sinf_tan = sinf_tan ! 2;             || Porcentaje
    sinf_ded = sinf_ded + inf_ded;       || Deduccion
    sinf_dse = sinf_dse + inf_dse;       || Deduccion S.S
    sinf_liq = sinf_liq + inf_liq;       || Liquido
    sinf_sss = sinf_sss + inf_sss;       || S.S CGO
    sinf_exe = sinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

|PROCESO centros;
    cinf_enf = cinf_enf + inf_enf;       || Enfermedad
    || cinf_pro = cinf_pro + inf_pro;       || Prorrata
    cinf_dia = cinf_dia + inf_dia;       || Dias
    cinf_hor = cinf_hor + inf_hor;       || Horas
    cinf_sub = cinf_sub + inf_sub;       || Subnormalidad
    cinf_bru = cinf_bru + inf_bru;       || Importe bruto
    cinf_dto = cinf_dto + inf_dto;       || Importe prorrata
    cinf_tan = cinf_tan ! 2;             || Porcentaje
    cinf_ded = cinf_ded + inf_ded;       || Deduccion
    cinf_dse = cinf_dse + inf_dse;       || Deduccion S.S
    cinf_liq = cinf_liq + inf_liq;       || Liquido
    cinf_sss = cinf_sss + inf_sss;       || S.S CGO
    cinf_exe = cinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

|PROCESO totales;
    tinf_enf = tinf_enf + inf_enf;       || Enfermedad
    || tinf_hor = tinf_hor + inf_hor;       || Horas
    tinf_dia = tinf_dia + inf_dia;       || Prorrata
    tinf_hor = tinf_hor + inf_hor;       || Horas
    tinf_sub = tinf_sub + inf_sub;       || Subnormalidad
    tinf_bru = tinf_bru + inf_bru;       || Importe bruto
    tinf_dto = tinf_dto + inf_dto;       || Importe prorrata
    tinf_tan = tinf_tan ! 2;             || Porcentaje
    tinf_ded = tinf_ded + inf_ded;       || Deduccion
    tinf_dse = tinf_dse + inf_dse;       || Deduccion S.S
    tinf_liq = tinf_liq + inf_liq;       || Liquido
    tinf_sss = tinf_sss + inf_sss;       || S.S CGO
    tinf_exe = tinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

******************************************************************************
    PASE DE VARIABLES
******************************************************************************

|PROCESO puecentros;
|ABRE #9;
    #9#0 = gcentr;
|LEE 001#9=;
|SI FSalida ! 0;  |DDEFECTO #9;  |FINSI;
|CIERRA #9;
    varinf1 = #9#1;
|QBF varinf1;
    varinf1 = varinf1 + "******************************";
    varinf1 = varinf1 % 133;
    pinf_enf = cinf_enf;
    ||pinf_pro = cinf_pro;
    pinf_dia = cinf_dia;
    pinf_hor = cinf_hor;
    pinf_sub = cinf_sub;
    pinf_bru = cinf_bru;
    pinf_dto = cinf_dto;
    pinf_ded = cinf_ded;
    pinf_dse = cinf_dse;
    pinf_liq = cinf_liq;
    pinf_sss = cinf_sss;
    pinf_exe = cinf_exe;
|FPRC;


|PROCESO puesubgrs;
|ABRE #5;
    #5#0 = gcentr;
    #5#1 = grupo;
    #5#2= subgr;
|LEE 001#5=;
|SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
|CIERRA #5;
    varinf1 = #5#3;
|QBF varinf1;
    varinf1 = varinf1 + "..............................";
    varinf1 = varinf1 % 133;
    pinf_enf = sinf_enf;
    || pinf_pro = sinf_pro;
    pinf_dia = sinf_dia;
    pinf_hor = sinf_hor;
    pinf_sub = sinf_sub;
    pinf_bru = sinf_bru;
    pinf_dto = sinf_dto;
    pinf_ded = sinf_ded;
    pinf_dse = sinf_dse;
    pinf_liq = sinf_liq;
    pinf_sss = sinf_sss;
    pinf_exe = sinf_exe;
|FPRC;

|PROCESO puegrupos;
|ABRE #4;
    #4#0 = gcentr;
    #4#1 = grupo;
|LEE 001#4=;
|SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;
|CIERRA #4;
    varinf1 = #4#2;
|QBF varinf1;
    varinf1 = varinf1 + "------------------------------";
    varinf1 = varinf1 % 133;
    pinf_enf = ginf_enf;
    || pinf_pro = ginf_pro;
    pinf_dia = ginf_dia;
    pinf_hor = ginf_hor;
    pinf_sub = ginf_sub;
    pinf_bru = ginf_bru;
    pinf_dto = ginf_dto;
    pinf_ded = ginf_ded;
    pinf_dse = ginf_dse;
    pinf_liq = ginf_liq;
    pinf_sss = ginf_sss;
    pinf_exe = ginf_exe;
|FPRC;

******************************************************************************
    LIMPIEZA DE VARIABLES
******************************************************************************
|PROCESO limpcentros;
    cinf_enf = 0;
    cinf_pro = 0;
    cinf_hor = 0;
    cinf_dia = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_exe = 0;
|FPRC;


|PROCESO limpgrupos;
    ginf_enf = 0;
    ginf_pro = 0;
    ginf_hor = 0;
    ginf_dia = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_exe = 0;
|FPRC;

|PROCESO limpsubgrs;
    sinf_enf = 0;
    sinf_pro = 0;
    sinf_hor = 0;
    sinf_dia = 0;
    sinf_sub = 0;
    sinf_bru = 0;
    sinf_dto = 0;
    sinf_ded = 0;
    sinf_dse = 0;
    sinf_liq = 0;
    sinf_sss = 0;
    sinf_exe = 0;
|FPRC;

|PROCESO limparcial;
    cinf_enf = 0;
    cinf_pro = 0;
    cinf_hor = 0;
    cinf_dia = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_exe = 0;
|FPRC;

|PROCESO limptotal;
    tinf_enf = 0;
    tinf_pro = 0;
    tinf_hor = 0;
    tinf_dia = 0;
    tinf_sub = 0;
    tinf_bru = 0;
    tinf_dto = 0;
    tinf_ded = 0;
    tinf_dse = 0;
    tinf_liq = 0;
    tinf_sss = 0;
    tinf_exe = 0;
|FPRC;

******************************************************************************
   RUTINAS
******************************************************************************

|PROCESO centra;         || CENTRA TITULO DEL INFORME
    alfa1 = cabeza % 0;
    nume1 = alfa1;
    nume2 = ((79 - nume1) / 2) - 0.5;
    nume2 = nume2 ! 0;
    alfa1 = " " * nume2;
    cabeza = alfa1 + cabeza;
|FPRC;

|PROCESO Selecc; |TIPO 0;
     |SI #0#6="R";
          |PARA i=7; |SI i[12; |HACIENDO i=i+1;
               |CAMPO_MODIFICA #0i,1,"S";
          |SIGUE;

          |PARA i=13; |SI i[42; |HACIENDO i=i+1;
               |CAMPO_MODIFICA #0i,1,"N";
          |SIGUE;
     |SINO;
          |PARA i=7; |SI i[12; |HACIENDO i=i+1;
               |CAMPO_MODIFICA #0i,1,"N";
          |SIGUE;

          |PARA i=13; |SI i[42; |HACIENDO i=i+1;
               |CAMPO_MODIFICA #0i,1,"S";
          |SIGUE;

     |FINSI;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0

     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;  |BORRA 020#0a;  |FINSI;
     |PINDA #0#0;
     |ENDATOS #1#0;

     |SI FSalida = 0;
          |HAZ imprime;
     |FINSI;

     |GRABA 000#0n;
     |CIERRA #0;
|FPRO;
