|FICHEROS;
     nomcalp1 #0;
     nomconca #1;
     labtraba #2;
     nomcontr #32;
     nomconli;
     nomhicca;
|FIN;

|VARIABLES;
    aalta = 0;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    any = 0;
    atope = 0;
    bisiesto = 0;
    con_ant = 0;
    confe = 0;
    d1 = 0;
    d2 = 0;
    d3 = 0;
    d4 = 0;
    d5 = 0;
    d6 = 0;
    d7 = 0;
    d8 = 0;
    d_mes = 0;
    dalta = 0;
    dd_1 = 0;
    dd_2 = 0;
    dd_3 = 0;
    dd_4 = 0;
    dd_5 = 0;
    dd_6 = 0;
    dd_7 = 0;
    dd_8 = 0;
    dedia = 0;
    des_tra = 0;
    dia = 0;
    dtope = 0;
    e1 = 0;
    e2 = 0;
    e3 = 0;
    e4 = 0;
    e5 = 0;
    e6 = 0;
    e7 = 0;
    e8 = 0;
    f1 = 0;
    f2 = 0;
    f3 = 0;
    f4 = 0;
    f5 = 0;
    f6 = 0;
    f7 = 0;
    f8 = 0;
    falta = 0;
    fecsys = @;
    ftope = 0;
    h1 = 0;
    h2 = 0;
    h3 = 0;
    h4 = 0;
    h5 = 0;
    h6 = 0;
    h7 = 0;
    h8 = 0;
    hadia = 0;
    has_tra = 0;
    hh_1 = 0;
    hh_2 = 0;
    hh_3 = 0;
    hh_4 = 0;
    hh_5 = 0;
    hh_6 = 0;
    hh_7 = 0;
    hh_8 = 0;
    malta = 0;
    medes = 0;
    mehas = 0;
    mes = 0;
    mtope = 0;
    nume0 = 0;
    nume1 = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    p_mes = "";
    paga = 0;
    periodo = 0;
    puntero = 0;
    tipop = "";
    tope = 0;
    topemes = 0;
    v_t = 0;
    vale_1 = 0;
    vale_2 = 0;
    vale_3 = 0;
    vale_4 = 0;
    vale_5 = 0;
    vale_6 = 0;
    vale_7 = 0;
    vale_8 = 0;
     pror_p = 0;
     nHuelga = 0;
     nAny = 0;
     nMes = 0;
     nDesem = 0;
     &nAntes1 = 0;
     &nAntes2 = 0;
     &nAntes3 = 0;
     &nAntes4 = 0;
     &nAntes5 = 0;
     &nDespues1 = 0;
     &nDespues2 = 0;
     &nDespues3 = 0;
     &nDespues4 = 0;
     &nDespues5 = 0;
     nPasada = 0;
     nAfectados = 0;
     aAlfa = "";
     nNume = 0;
|FIN;

**********************************************************************
    LLAMADAS DE CAMPOS
**********************************************************************

|PROCESO Tipo8; |TIPO 8;
     |DDEFECTO #32;
     |ABRE #32;
     |LEE 000#32p;
     |CIERRA #32;
|FPRC;

|PROCESO Tipo7; |TIPO 7;
     |HAZ defecto;
     |HAZ bisiesto;
     |HAZ mirames;
     |HAZ pintames;
|FPRC;

|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % -104;
    #0#9 = alfa1;
    |PINTA #0#9;
|FPRC;

|PROCESO mirames; |TIPO 7; ||CALCULA EL MES POR DEFECTO SEGUN FECHA SISTEMA
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % 402;
    #0#8 = alfa1;
    #0#8 = #0#8 - 1;
    |PINTA #0#8;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
|SI #0#8 =  1;  p_mes = "ENERO     ";  topemes = 31;             |FINSI;
|SI #0#8 =  2;  p_mes = "FEBRERO   ";  topemes = 28 + bisiesto;  |FINSI;
|SI #0#8 =  3;  p_mes = "MARZO     ";  topemes = 31;             |FINSI;
|SI #0#8 =  4;  p_mes = "ABRIL     ";  topemes = 30;             |FINSI;
|SI #0#8 =  5;  p_mes = "MAYO      ";  topemes = 31;             |FINSI;
|SI #0#8 =  6;  p_mes = "JUNIO     ";  topemes = 30;             |FINSI;
|SI #0#8 =  7;  p_mes = "JULIO     ";  topemes = 31;             |FINSI;
|SI #0#8 =  8;  p_mes = "AGOSTO    ";  topemes = 31;             |FINSI;
|SI #0#8 =  9;  p_mes = "SEPTIEMBRE";  topemes = 30;             |FINSI;
|SI #0#8 = 10;  p_mes = "OCTUBRE   ";  topemes = 31;             |FINSI;
|SI #0#8 = 11;  p_mes = "NOVIEMBRE ";  topemes = 30;             |FINSI;
|SI #0#8 = 12;  p_mes = "DICIEMBRE ";  topemes = 31;             |FINSI;
     |PINTA 1551, p_mes;
|FPRC;

|PROCESO bisiesto; |TIPO 0;
    nume1 = #0#9;
    nume1 = nume1 $ 4;
|SI nume1 = 0;|Y #32#9 = "S";
        bisiesto = 1;
|SINO;
        bisiesto = 0;
|FINSI;
|FPRC;

**********************************************************************
    PROCESO
**********************************************************************

|PROCESO bucle;
|HAZ bucle0;
|HAZ bucle1;
|HAZ bucle2;
|FPRC;

**********************************************************************

|PROCESO bucle0;
/*
|PINTA 2028, #2#87;
|PINTA 2045, #2#00;
|PINTA 2066, #2#01;
*/
|HAZ bucle01;
|FPRC;

|PROCESO bucle1;
|SI #2#87 ! con_ant;
        con_ant = #2#87;
    |HAZ bucle11;
|FINSI;
|FPRC;

|PROCESO bucle2;
     nAntes1 = 0; nAntes2 = 0; nAntes3 = 0; nAntes4 = 0; nAntes5 = 0;
     nDespues1 = 0; nDespues2 = 0; nDespues3 = 0; nDespues4 = 0; nDespues5 = 0;
     |PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
          |HAZ bucle21;
     |SIGUE;

     |SI nAntes1 ! 0; |O nAntes2 ! 0; |O nAntes3 ! 0; |O nAntes4 ! 0; |O nAntes5 ! 0;
          |SI nAntes1 ! nDespues1; |O nAntes2 ! nDespues2; |O nAntes3 ! nDespues3;
          |O nAntes4 ! nDespues4; |O nAntes5 ! nDespues5;
               nAfectados = nAfectados + 1;
               |SI nPasada = 1;
                    |PRINT;
               |FINSI;
               |SI nPasada = 2;
                    |GRABA 020#2a;
               |FINSI;
          |FINSI;
     |FINSI;

     |LIBERA #2;
|FPRC;

|DEFBUCLE nomcalp10;
#2#1;
87,17,44;
#0#0,#0#2,#0#4,#0#6,AA;
#0#1,#0#3,#0#5,#0#7,AA;
be;
NULL, NULL, NULL, NULL, NULL, bucle;
#2#87,#2#0,#2#1;
|FIN;

|PROCESO proceso; || inicio de proceso
|ABRE #1;
|BUCLE nomcalp10;
|CIERRA #1;
|FPRC;

**********************************************************************
    RUTINAS
**********************************************************************

|PROCESO bucle01;
    |SI #0#10=1;  || Fecha de alta
          alfa1 = #2#36 % 102;  dia = alfa1;
          alfa1 = #2#36 % 402;  mes = alfa1;
          alfa1 = #2#36 %-104;  any = alfa1;
    |SINO;        || Fecha de antiguedad
          alfa1 = #2#34 % 102;  dia = alfa1;
          alfa1 = #2#34 % 402;  mes = alfa1;
          alfa1 = #2#34 %-104;  any = alfa1;
    |FINSI;

    falta = (any  * 100) + mes;
    aalta =  any;
    malta =  mes;
    dalta =  dia;

    ftope = (#0#9 * 100) + #0#8;
    atope =  #0#9;
    mtope =  #0#8;
    dtope =  topemes;
|FPRC;

**********************************************************************

|PROCESO bucle11;
    #1#0 = #2#87;
|LEE 020#1=;
|SI FSalida = 0;
        vale_1=0;  vale_2=0;  vale_3=0;  vale_4=0;
        vale_5=0;  vale_6=0;  vale_7=0;  vale_8=0;
    |PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
        |HAZ bucle111;
        pror_p = paga + 112;   || prorrateo paga S/N (trabajador)
        |SI medes ! 0; |Y mehas ! 0; |Y confe ! 99; |Y tipop ! "P";
        |Y #labtraba#pror_p# ! "S";
            |HAZ bucle112;
            |HAZ bucle113;
        |FINSI;
    |SIGUE;
|FINSI;
|FPRC;

|PROCESO bucle111;
    puntero = paga + 3;      medes = #1puntero;
    puntero = puntero + 8;   mehas = #1puntero;
    puntero = puntero + 8;   confe = #1puntero;
    puntero = puntero + 8;   tipop = #1puntero;
    puntero = paga + 107;    dedia = #1puntero;
    puntero = paga + 115;    hadia = #1puntero;
|FPRC;

|PROCESO bucle112;
|SI mehas < #0#8;
    |SI medes ] mehas;
            des_tra = ( #0#9     *100) +medes;
            has_tra = ((#0#9 +1) *100) +mehas;
    |SINO;
            des_tra = ((#0#9 +1) *100) +medes;
            has_tra = ((#0#9 +1) *100) +mehas;
    |FINSI;
|SINO;
    |SI medes ] mehas;
            des_tra = ((#0#9 -1) *100) +medes;
            has_tra = ( #0#9     *100) +mehas;
    |SINO;
            des_tra = ( #0#9     *100) +medes;
            has_tra = ( #0#9     *100) +mehas;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO bucle113;
|SI paga=1; dd_1=des_tra; hh_1=has_tra; vale_1=1;
            d1=medes; h1=mehas; e1=dedia; f1=hadia;
|FINSI;
|SI paga=2; dd_2=des_tra; hh_2=has_tra; vale_2=1;
            d2=medes; h2=mehas; e2=dedia; f2=hadia;
|FINSI;
|SI paga=3; dd_3=des_tra; hh_3=has_tra; vale_3=1;
            d3=medes; h3=mehas; e3=dedia; f3=hadia;
|FINSI;
|SI paga=4; dd_4=des_tra; hh_4=has_tra; vale_4=1;
            d4=medes; h4=mehas; e4=dedia; f4=hadia;
|FINSI;
|SI paga=5; dd_5=des_tra; hh_5=has_tra; vale_5=1;
            d5=medes; h5=mehas; e5=dedia; f5=hadia;
|FINSI;
|SI paga=6; dd_6=des_tra; hh_6=has_tra; vale_6=1;
            d6=medes; h6=mehas; e6=dedia; f6=hadia;
|FINSI;
|SI paga=7; dd_7=des_tra; hh_7=has_tra; vale_7=1;
            d7=medes; h7=mehas; e7=dedia; f7=hadia;
|FINSI;
|SI paga=8; dd_8=des_tra; hh_8=has_tra; vale_8=1;
            d8=medes; h8=mehas; e8=dedia; f8=hadia;
|FINSI;
|FPRC;

**********************************************************************

|PROCESO bucle21;
|HAZ bucle211;
|SI v_t = 1;
    |HAZ bucle212;
|FINSI;
|FPRC;

|PROCESO bucle211;
|SI paga=1; des_tra=dd_1; has_tra=hh_1; v_t=vale_1;
            medes=d1; mehas=h1; dedia=e1; hadia=f1;
|FINSI;
|SI paga=2; des_tra=dd_2; has_tra=hh_2; v_t=vale_2;
            medes=d2; mehas=h2; dedia=e2; hadia=f2;
|FINSI;
|SI paga=3; des_tra=dd_3; has_tra=hh_3; v_t=vale_3;
            medes=d3; mehas=h3; dedia=e3; hadia=f3;
|FINSI;
|SI paga=4; des_tra=dd_4; has_tra=hh_4; v_t=vale_4;
            medes=d4; mehas=h4; dedia=e4; hadia=f4;
|FINSI;
|SI paga=5; des_tra=dd_5; has_tra=hh_5; v_t=vale_5;
            medes=d5; mehas=h5; dedia=e5; hadia=f5;
|FINSI;
|SI paga=6; des_tra=dd_6; has_tra=hh_6; v_t=vale_6;
            medes=d6; mehas=h6; dedia=e6; hadia=f6;
|FINSI;
|SI paga=7; des_tra=dd_7; has_tra=hh_7; v_t=vale_7;
            medes=d7; mehas=h7; dedia=e7; hadia=f7;
|FINSI;
|SI paga=8; des_tra=dd_8; has_tra=hh_8; v_t=vale_8;
            medes=d8; mehas=h8; dedia=e8; hadia=f8;
|FINSI;
|FPRC;

|PROCESO bucle212;
    periodo = 0;
|SI ftope ! has_tra;
    |SI has_tra<ftope;
            tope=has_tra;
    |SINO;
            tope=ftope;
    |FINSI;
    |PARA mes = des_tra; |SI mes [ has_tra; |HACIENDO mes = mes + 1;
            nume0=mes $ 100; nume0=mes-nume0; nume0=nume0/100;
            nume1=mes $ 100;
        |SI nume1>12;
                alfa1=mes; alfa1=alfa1%104; nume1=alfa1;
                nume1=nume1+1; mes=(nume1*100)+1;
                nume0=mes $ 100; nume0=mes-nume0; nume0=nume0/100;
                nume1=mes $ 100;
        |FINSI;
        |SI mes ] falta; |Y mes [ tope;
            |HAZ bucle213;
            |SI nume0 = aalta;|Y nume1 = malta;
                |SI nume1 ! medes; |Y nume1 ! mehas;
                        d_mes = (d_mes - dalta) + 1;
                |FINSI;
                |SI nume1 = medes;|Y nume1 ! mehas;
                    |SI dalta ] dedia;
                            d_mes = (d_mes - dalta) + 1;
                    |SINO;
                            d_mes = (d_mes - dedia) + 1;
                    |FINSI;
                |FINSI;
                |SI nume1 = mehas;|Y nume1 ! medes;
                    |SI dalta > hadia;
                            d_mes = 0;
                    |SINO;
                            d_mes = (hadia - dalta) + 1;
                    |FINSI;
                |FINSI;
                |SI nume1 = medes;|Y nume1 = mehas;
                    |SI dalta ] dedia;
                            d_mes = (d_mes - dalta) + 1;
                    |SINO;
                            d_mes = (d_mes - dedia) + 1;
                    |FINSI;
                |FINSI;
            |SINO;
                |SI nume1 = medes;|Y medes ! mehas;
                        d_mes = (d_mes - dedia) + 1;
                |FINSI;
                |SI nume1 = mehas;|Y medes ! mehas;
                        d_mes = hadia;
                |FINSI;
                |SI medes = mehas;|Y nume1 = medes;
                        nume4=mes    $100; nume4=    mes-nume4; nume4=nume4/100;
                        nume5=des_tra$100; nume5=des_tra-nume5; nume5=nume5/100;
                        nume6=has_tra$100; nume6=has_tra-nume6; nume6=nume6/100;
                    |SI nume4 = nume5;
                            d_mes = (d_mes - dedia) + 1;
                    |FINSI;
                    |SI nume4 = nume6;
                            d_mes = hadia;
                    |FINSI;
                |FINSI;
            |FINSI;
                periodo = periodo + d_mes;
        |FINSI;
    |SIGUE;
|SINO;
    |SI medes = mehas;
            nume3 = mehas;
        |HAZ bucle213;
            periodo = (d_mes - dedia) + 1;
    |FINSI;
|FINSI;
|HAZ bucle214;
|FPRC;

|PROCESO diaspaga;
     alfa1=mes; alfa1=alfa1%-102;  nume3=alfa1;
     |SI nume3 =  1;  d_mes = 31;             |FINSI;
     |SI nume3 =  2;  d_mes = 28 + bisiesto;  |FINSI;
     |SI nume3 =  3;  d_mes = 31;             |FINSI;
     |SI nume3 =  4;  d_mes = 30;             |FINSI;
     |SI nume3 =  5;  d_mes = 31;             |FINSI;
     |SI nume3 =  6;  d_mes = 30;             |FINSI;
     |SI nume3 =  7;  d_mes = 31;             |FINSI;
     |SI nume3 =  8;  d_mes = 31;             |FINSI;
     |SI nume3 =  9;  d_mes = 30;             |FINSI;
     |SI nume3 = 10;  d_mes = 31;             |FINSI;
     |SI nume3 = 11;  d_mes = 30;             |FINSI;
     |SI nume3 = 12;  d_mes = 31;             |FINSI;
|FPRC;

|PROCESO bucle213;
     |SI #2#42 = "D"; |O #2#42 = "T";
          |HAZ diaspaga;
     |SINO;
          |SI #2#42 = "M"; |Y #2#64 = "D";
               |HAZ diaspaga;
          |SINO;
               || Agrarios fijos con concepto 101 definido como "D", han de
               || tener acumulados los dias reales, como si fueran diarios
               |SI #2#42 = "A";
                    |ABRE #nomconli;
                    #nomconli#0 = #labtraba#87;
                    #nomconli#2 = 101;
                    |LEE 000#nomconli.=;
                    |SI FSalida = 0;
                         |SI #nomconli#3 = "D";
                              |HAZ diaspaga;
                         |SINO;
                              d_mes = 30;
                         |FINSI;
                    |SINO;
                         d_mes = 30;
                    |FINSI;
                    |CIERRA #nomconli;
               |SINO;
                    d_mes = 30;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO bucle214;
|SI paga [ 5;
        puntero = 54;
|SINO;
        puntero = 75;  || (80-5) !!!
|FINSI;
    puntero = puntero + paga;

     || ojo, aqui es donde voy a tener en cuenta la huelga
     nHuelga = 0;
     nDesem = 0;
     |PARA nMes = 1; |SI nMes [ #0#8; |HACIENDO nMes = nMes + 1;
          nAny = #0#9 - 2000;
          #nomhicca#0 = #labtraba#0;
          #nomhicca#1 = #labtraba#1;
          #nomhicca#66 = nAny;
          #nomhicca#2 = nMes;
          #nomhicca#3 = 0;
          |LEE 000#nomhicca.=;
          |SI FSalida = 0;
               || ojo, aunque tenga puesto descuento en pagas NO, voy a
               || descontar, ahi esta el problema que tuvo Asecor, que no
               || le estaba descontando bien

               || si tiene puesto que SI no pasa nada
               |SI #nomhicca#33 ! 0; |Y #nomhicca#117 = "N";
                    nHuelga = nHuelga + #nomhicca#33;
               |FINSI;
               |SI #nomhicca#119 ! 0;
                    nDesem = nDesem + #nomhicca#119;
               |FINSI;
          |FINSI;
     |SIGUE;
     /*
     || esto es demasiada poca cosa, voy a tener en cuenta el calculo
     || que se haya hecho en el historico quitando de verdad los dias
     || de huelga y de desempleo que haya habido

     |SI #2puntero > 0; |Y nHuelga = 1.40;
          || #2puntero = periodo - nHuelga;
          #2puntero = #2puntero - 1;
          || a pelo, le quito un dia por lo de Asecor
     |FINSI;
     */

     || ajusto solo los trabajadores que se han visto afectados por la huelga

     |SI #2puntero > 0; |Y nHuelga = 1.40; |Y periodo > 0;
          |SI paga = 1; nAntes1 = #2puntero; |FINSI;
          |SI paga = 2; nAntes2 = #2puntero; |FINSI;
          |SI paga = 3; nAntes3 = #2puntero; |FINSI;
          |SI paga = 4; nAntes4 = #2puntero; |FINSI;
          |SI paga = 5; nAntes5 = #2puntero; |FINSI;

          nNume = #2puntero - (periodo - nHuelga - nDesem);
          |SI -1.40 [ nNume; |Y nNume [ 1.40;
               #2puntero = periodo - nHuelga - nDesem;
          |FINSI;

          |SI paga = 1; nDespues1 = #2puntero; |FINSI;
          |SI paga = 2; nDespues2 = #2puntero; |FINSI;
          |SI paga = 3; nDespues3 = #2puntero; |FINSI;
          |SI paga = 4; nDespues4 = #2puntero; |FINSI;
          |SI paga = 5; nDespues5 = #2puntero; |FINSI;

          |SI nAntes1 = nDespues1; nAntes1 = 0; nDespues1 = 0; |FINSI;
          |SI nAntes2 = nDespues2; nAntes2 = 0; nDespues2 = 0; |FINSI;
          |SI nAntes3 = nDespues3; nAntes3 = 0; nDespues3 = 0; |FINSI;
          |SI nAntes4 = nDespues4; nAntes4 = 0; nDespues4 = 0; |FINSI;
          |SI nAntes5 = nDespues5; nAntes5 = 0; nDespues5 = 0; |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0; |Y #0#11 = "S";
          nPasada = 1;
          nAfectados = 0;
          |IMPRE 0;
          |SI FSalida = 0;
               |INFOR "nomcalp1";
               |ABRE #nomhicca;
               |HAZ proceso;
               |CIERRA #nomhicca;

               |SI nAfectados ! 0;
                    aAlfa = nAfectados;
                    aAlfa = "    Se encontraron " + aAlfa + " trabajadores afectados.";
                    |MENAV aAlfa;
               |SINO;
                    aAlfa = "    No se ha encontrado ningún trabajador afectado.";
                    |MENAV aAlfa;
               |FINSI;

               |PIEINF;
               |FININF;
               |FINIMP;

               |SI nAfectados ! 0;
                    aAlfa = "    N¿Desea modificar los días acumulados de paga según ";
                    aAlfa = aAlfa + "el listado obtenido?";
                    |CONFI aAlfa;
                    |SI FSalida = 0;
                         nPasada = 2;
                         nAfectados = 0;
                         |ABRE #nomhicca;
                         |HAZ proceso;
                         |CIERRA #nomhicca;

                         |SI nAfectados ! 0;
                              aAlfa = nAfectados;
                              aAlfa = "    Se han modificado los " + aAlfa + " trabajadores afectados.";
                              |MENAV aAlfa;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRO;
