|FICHEROS;
     nomcot01;
     nomcot02;
     nomcot03;
     nomcot04;

     nomcot23;
     nomcot24;
     nomcot25;
     nomcot26;

     labempre;
     labtraba;
     labcentr;
     nomcenes;

     nomconst;
     nombonif;
     nomboni3;
     nomvarca;
     nompluri;
     nomnotan;

     nomhicca;
     nompluba;

     nomtrtmp;
|FIN;

|VARIABLES;
     &nEmp = 0;
     &nTra = 0;
     &nElAny = 0;
     &nElMes = 0;
     &aCCCReg = "";
     aRegimen = "";
     &aNaf = "";
     &enTipo = 0;
     &enImpRem = 0;
     &enImpRemCC = 0;
     &enImpRemCP = 0;
     &enImpExt30 = 0;
     &enImpExt31 = 0;
     &base_5 = 0;
     &dcofi_2 = 0;

     &epig_ilt = 0;
     &epig_ims = 0;
     &prom_enf = 0;
     &prom_acc = 0;
     &prom_ac2 = 0;
     &swCambiaProm = 0;
     &horasex = 0;
     &nHorasTut = 0;
     &nBonifTut = 0;

     nBaseTramoCC = 0;
     nBaseTramoCP = 0;
     nBaseAcumCC = 0;
     nBaseAcumCP = 0;
     nDiasALT = 0;
     nDiferencia = 0;
     nBase = 0;
     nTipoTra = 0;
     nCuotaTra = 0;
     nTipoEmp = 0;
     nCuotaEmp = 0;
     nCuotaTot = 0;
     nAcumCuotaTra = 0;
     nAcumCuotaEmp = 0;
     nAcumCuotaTot = 0;

     nTotalCuotaTra = 0;
     nTotalCuotaEmp = 0;
     nTotalCuotaTot = 0;
     nCampo = 0;
     nCampo1 = 0;
     nDiasReales = 0;
     nDiasPrest1 = 0;
     nDiasPrest2 = 0;
     nNume = 0;
     swGraba = 0;

     nHorasForTra = 0;
     nHorasTutTra = 0;
     nHorasExtraTra = 0;
     nHorasFTAcum = 0;
     nHorasTTAcum = 0;
     nHorasExtraAcum = 0;
     nIndicador = 0;
     nHoras = 0;
     nCodigoHoras = 0;
     nUltimoTramoAlta = 0;
     nUltimoTramoIT = 0;

     swFormacion = 0;
     swCotizHoras = 0;
     swCuotasFor = 0;
     nCampoMax = 0;
     nCampoMin = 0;
     nCampoMinDia = 0;
     nConcepto = 0;

     nContrato = 0;
     nGrupoCot = 0;
     aClaveCot = "";
     nDiasTramo = 0;
     nHorasTramo = 0;
     nBaseMax = 0;
     nBaseMin = 0;

     nBaseITCC = 0;
     nBaseITCCAnt = 0;
     nBaseITATEP = 0;
     nBaseITATEPAnt = 0;
     &tp = 0;
     nCoefTP = 0;

     nPorBonif = 0;
     nFijBonif = 0;
     nExeBonif = 0;
     aTramoBon = "";
     nCampoBon = 0;
     nBonif = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     swSigue = 0;
     nBaseBon = 0;
     nBaseBonCC = 0;
     nBaseBonATEP = 0;
     nConceptoAnt = 0;
     nTotFijBonif = 0;
     nTotExeBonif = 0;
     nCuotaFija = 0;
     nCuotaBonCC = 0;
     nCuotaBonCCTra = 0;
     nCuotaBonATEP = 0;
     nNume0 = 0;
     nNume1 = 0;
     nNume2 = 0;
     nExento = 0;
     nBonFom = 0;
     nTotBonFom = 0;

     nImporteBonEmp = 0;
     nImporteBonTra = 0;
     nTipoBonEmp = 0;
     nTipoBonTra = 0;
     nBaseBonifica = 0;
     aDesBonif = "";
     nBaseExenta = 0;

     &nBaseIT2 = 0;

     nLineaIT = 0;
     nCampo2 = 0;
     nDesdeDia = 0;
     nHastaDia = 0;
     fFecha = @;
     aFecha = "";
     fFechaRenuncia = @;
     fFechaReincorp = @;

     nDiasBon = 0;
     nExeBonifDias = 0;
     nExeBonifBase = 0;

     nDiasIT = 0;
     nDiasCotMes = 0;
     nDiasNatMes = 0;
     nTope = 0;
     nRecortaCC = 0;
     nRecortaCPMax = 0;
     nRecortaCPMin = 0;
     &nImporteComp = 0;  || importe de los conceptos que no se proporciona
                         || el importe en tiempo parcial
     nPropJub = 0;
     nBaseExt30Tramo = 0;
     nBaseExt31Tramo = 0;
     nBaseAcumExt30 = 0;
     nBaseAcumExt31 = 0;

     nUltimaFicha = 0;
     nBasePreviaCC = 0;
     nBasePreviaCP = 0;

     nTramo = 0; nExceso = 0;
     nTramo1 = 0; nExceso1 = 0;
     nTramo2 = 0; nExceso2 = 0;
     nTramo3 = 0; nExceso3 = 0;
     nTramo4 = 0; nExceso4 = 0;
     nTramo5 = 0; nExceso5 = 0;
     nCon = 0;
     nPrestacion = 0;

     swPluriempleo = 0;
     nTopePlur = 0;
     swMayores65 = 0;

     &nMes = 0;
     &nAny = 0;
     &nTopemes = 0;

     nMesBase = 0;
     nAnyBase = 0;
     nMesIniIT = 0;
     nAnyIniIT = 0;
     nMesBusca = 0;
     nAnyBusca = 0;

     nBasePluCC = 0; nPromPluCC = 0;
     nBasePluCP = 0; nPromPluCP = 0;
     nBasePluDes = 0; nPromPluDes = 0;
     nBasePluFog = 0; nPromPluFog = 0;
     nBasePluFP = 0; nPromPluFP = 0;
     nDiasPlu = 0;
     nVez = 0;
     FEstado = 0;

     aSituacion = "";

     &swDiosMio = 0;
     &swSegPasada = 0;
     &runnom = "";

     nBonTP = 0;
     aNif = "";
     swParteEnAltaERETP = 0;
     nDiasTramoCot = 0;
     nDiasContados = 0;
     &nNroHorasExtra = 0;

     nAjustaBon = 0;
     nTotDiasBon = 0;
     nAcumNeg = 0;
     aAntTramoBon = "";
     nTramoBon = 0;

     nLinea = 0;
     aTramos = "";
     nPos = 0;
     aSeleccion = "";
     nUltimoTramo = 0;
     nBaseAcumCPTope = 0;
     nImporteHoraFor = 0;
     &swFijoDisc = 0;
     &nBase946 = 0;
     &nBase947 = 0;
     swEmpiezaMesAnt = 0;
     aMes = "";
     aAny = "";
     nNroTramos = 0;
     swNoSigas = 0;

     nPorExoCOVID19 = 0;
     swExoCOVID19 = 0;
     nCCExo = 0;
     nITExo = 0;
     nIMSExo = 0;
     nDesExo = 0;
     nFogExo = 0;
     nFPExo = 0;
     nBaseDes = 0;
     &nBaseDes2 = 0;
     &nUniDes2 = 0;

     nBaseBonCC_A = 0;
     nBaseBonATEP_A = 0;
     nCuotaBonCC_A = 0;
     nCuotaBonCCTra_A = 0;
     nCuotaBonATEP_A = 0;

     swTramoAlta = 0;
     swTramoERE = 0;
     nForPorExoCOVID = 0;
     nAcum5XX = 0;
     nAcum6XX = 0;
     nAcum7XX = 0;
     swTopes = 0;
|FIN;

/**************** PROCESOS PARA LA EXONERACION DE CUOTA POR EL COVID19 ******/

|PROCESO ExoCOVID03_Alta;
     nConcepto = #nomcot03#10;
     swGraba = 0;

     || Contingencias Comunes
     |SI nConcepto = 500; |O nConcepto = 509; |O nConcepto = 535;
     |O nConcepto = 501; |O nConcepto = 502;
     |O nConcepto = 594;
          nCCExo = nCCExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nCCExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 598;
          #nomcot03#16 = #nomcot03#16 - nCCExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo;
          swGraba = 1;
     |FINSI;

     || AT/EP
     |SI nConcepto = 601; |O nConcepto = 603; |O nConcepto = 634;
          nITExo = nITExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nITExo;
          #nomcot03#17 = #nomcot03#17 - nITExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 611; |O nConcepto = 613; |O nConcepto = 635;
          nIMSExo = nIMSExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nIMSExo;
          #nomcot03#17 = #nomcot03#17 - nIMSExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 698;
          #nomcot03#16 = #nomcot03#16 - nITExo - nIMSExo;
          #nomcot03#17 = #nomcot03#17 - nITExo - nIMSExo;
          swGraba = 1;
     |FINSI;

     || Desempleo
     |SI nConcepto = 701; |O nConcepto = 705; |O nConcepto = 708;
          nDesExo = nDesExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nDesExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 702; |O nConcepto = 706; |O nConcepto = 709;
          nFogExo = nFogExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nFogExo;
          #nomcot03#17 = #nomcot03#17 - nFogExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 703; |O nConcepto = 707; |O nConcepto = 710;
          nFPExo = nFPExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 798;
          #nomcot03#16 = #nomcot03#16 - nDesExo - nFogExo - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo - nFogExo - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 998;
          #nomcot03#16 = #nomcot03#16 - nCCExo - nITExo - nIMSExo;
          #nomcot03#16 = #nomcot03#16 - nDesExo - nFogExo - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo - nITExo - nIMSExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo - nFogExo - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI swGraba = 1;
          |GRABA 020#nomcot03.a;
          |LIBERA #nomcot03;
     |FINSI;
|FPRC;

|DEFBUCLE ExoCOVID03_Alta;
     #nomcot03#1;
     ;
     nEmp, nElAny, nElMes, #nomcot02#3, #nomcot02#4, #nomcot02#5, #nomcot02#6, #nomcot02#7, 500;
     nEmp, nElAny, nElMes, #nomcot02#3, #nomcot02#4, #nomcot02#5, #nomcot02#6, #nomcot02#7, 999;
     be;
     NULL, ExoCOVID03_Alta;
|FIN;

|PROCESO Exoneracion_Alta;
     nCCExo = 0;
     nITExo = 0;
     nIMSExo = 0;
     nDesExo = 0;
     nFogExo = 0;
     nFPExo = 0;

     swSigue = 0;
     nPorExoCOVID19 = 0;
     |SI nForPorExoCOVID ! 0;
          nPorExoCOVID19 = nForPorExoCOVID;
     |FINSI;

     aAlfa = #labtraba#189;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaReincorp = aAlfa;
          |SI #nomcot02#8 ] fFechaReincorp;
               swSigue = 1;
          |FINSI;
/*
          || ahora controlamos los casos en que la fecha de reincorporacion
          || sea anterior a la fecha de renuncia

          aAlfa = #labtraba#132;
          |QBF aAlfa;
          |SI aAlfa ! ""; |Y aAlfa ! "..........";     || existe fecha de renuncia
               fFechaRenuncia = aAlfa;
               |SI fFechaReincorp < fFechaRenuncia;    || reincorporacion anterior
                    |SI nElAny = 2020; |Y nElMes = 05;
                         |SI fFechaRenuncia ] "01.05.2020"; |Y fFechaRenuncia [ "31.05.2020";
                         |Y fFechaReincorp ] "01.05.2020"; |Y fFechaReincorp [ "31.05.2020";
                         || fecha reincorporacion anterior a la fecha de renuncia
                         || durante mayo
                              swSigue = 1;
                         |FINSI;
                    |FINSI;
                    |SI nElAny = 2020; |Y nElMes = 06;
                         || fecha reincorporacion anterior a la fecha de renuncia
                         || durante junio
                         || en junio, reincorporaciones de mayo tambien, claro
                         |SI fFechaRenuncia ] "01.06.2020"; |Y fFechaRenuncia [ "31.06.2020";
                         |Y fFechaReincorp ] "01.05.2020";
                              swSigue = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
*/
          |SI swSigue = 1;
               || tramo en ALTA comienza tras renuncia al ERTE FM
               || y tras la fecha de reincorporacion
               |SI nElMes = 5; |Y nElAny = 2020;       || en mayo
                    |SI #labtraba#144 = 1;
                         nPorExoCOVID19 = 85;          || < 50 trab.
                    |SINO;
                         nPorExoCOVID19 = 60;          || ] 50 trab.
                    |FINSI;
               |FINSI;
               |SI nElMes = 6; |Y nElAny = 2020;
                    |SI #labtraba#144 = 1;
                         nPorExoCOVID19 = 70;          || < 50 trab.
                    |SINO;
                         nPorExoCOVID19 = 45;          || ] 50 trab.
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nPorExoCOVID19 ! 0;
          |BUCLE ExoCOVID03_Alta;

          #nomcot02#101 = nPorExoCOVID19;
          |GRABA 020#nomcot02.a;
          |LIBERA #nomcot02;
     |FINSI;
|FPRC;

|PROCESO ExoCOVID03_ERTE;
     nConcepto = #nomcot03#10;
     swGraba = 0;
     |SI nConcepto = 509; |O nConcepto = 536; |O nConcepto = 596;
          nCCExo = nCCExo + (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nCCExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 598;
          #nomcot03#16 = #nomcot03#16 - nCCExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo;
          swGraba = 1;
     |FINSI;
     |SI #nomcot02#27 = "ERE";
          |SI nConcepto = 603;
               nITExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
               #nomcot03#16 = #nomcot03#16 - nITExo;
               #nomcot03#17 = #nomcot03#17 - nITExo;
               swGraba = 1;
          |FINSI;
     |FINSI;
     |SI #nomcot02#27 = "ETP";
          |SI nConcepto = 636;
               nITExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
               #nomcot03#16 = #nomcot03#16 - nITExo;
               #nomcot03#17 = #nomcot03#17 - nITExo;
               swGraba = 1;
          |FINSI;
     |FINSI;
     |SI #nomcot02#27 = "ERE";
          |SI nConcepto = 613;
               nIMSExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
               #nomcot03#16 = #nomcot03#16 - nIMSExo;
               #nomcot03#17 = #nomcot03#17 - nIMSExo;
               swGraba = 1;
          |FINSI;
     |FINSI;
     |SI #nomcot02#27 = "ETP";
          |SI nConcepto = 637;
               nIMSExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
               #nomcot03#16 = #nomcot03#16 - nIMSExo;
               #nomcot03#17 = #nomcot03#17 - nIMSExo;
               swGraba = 1;
          |FINSI;
     |FINSI;
     |SI nConcepto = 698;
          #nomcot03#16 = #nomcot03#16 - nITExo - nIMSExo;
          #nomcot03#17 = #nomcot03#17 - nITExo - nIMSExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 705; |O nConcepto = 711;
          nDesExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nDesExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 706; |O nConcepto = 712;
          nFogExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nFogExo;
          #nomcot03#17 = #nomcot03#17 - nFogExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 707; |O nConcepto = 713;
          nFPExo = (#nomcot03#16 % nPorExoCOVID19) ! 2;
          #nomcot03#16 = #nomcot03#16 - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 798;
          #nomcot03#16 = #nomcot03#16 - nDesExo - nFogExo - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo - nFogExo - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI nConcepto = 998;
          #nomcot03#16 = #nomcot03#16 - nCCExo - nITExo - nIMSExo;
          #nomcot03#16 = #nomcot03#16 - nDesExo - nFogExo - nFPExo;
          #nomcot03#17 = #nomcot03#17 - nCCExo - nITExo - nIMSExo;
          #nomcot03#17 = #nomcot03#17 - nDesExo - nFogExo - nFPExo;
          swGraba = 1;
     |FINSI;
     |SI swGraba = 1;
          |GRABA 020#nomcot03.a;
          |LIBERA #nomcot03;
     |FINSI;
|FPRC;

|DEFBUCLE ExoCOVID03_ERTE;
     #nomcot03#1;
     ;
     nEmp, nElAny, nElMes, #nomcot02#3, #nomcot02#4, #nomcot02#5, #nomcot02#6, #nomcot02#7, 500;
     nEmp, nElAny, nElMes, #nomcot02#3, #nomcot02#4, #nomcot02#5, #nomcot02#6, #nomcot02#7, 999;
     be;
     NULL, ExoCOVID03_ERTE;
|FIN;

|PROCESO Exoneracion_ERTE;
     nCCExo = 0;
     nITExo = 0;
     nIMSExo = 0;
     nDesExo = 0;
     nFogExo = 0;
     nFPExo = 0;

     nPorExoCOVID19 = #labtraba#219;
     swSigue = 0;

     aAlfa = #labtraba#132;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          fFechaRenuncia = aAlfa;
          |SI #nomcot02#8 ] fFechaRenuncia;
               swSigue = 1;
          |FINSI;

          aAlfa = #labtraba#189;
          |SI aAlfa ! ""; |Y aAlfa ! "..........";
               fFechaReincorp = aAlfa;
          |FINSI;
          || ahora controlamos los casos en que la fecha de reincorporacion
          || sea anterior a la fecha de renuncia

          |SI fFechaReincorp < fFechaRenuncia;    || reincorporacion anterior
          |Y #nomcot02#8 ] fFechaReincorp;
               |SI nElAny = 2020; |Y nElMes = 05;
                    |SI fFechaRenuncia ] "01.05.2020"; |Y fFechaRenuncia [ "31.05.2020";
                    |Y fFechaReincorp ] "01.05.2020"; |Y fFechaReincorp [ "31.05.2020";
                    || fecha reincorporacion anterior a la fecha de renuncia
                    || durante mayo
                         swSigue = 1;
                    |FINSI;
               |FINSI;
               |SI nElAny = 2020; |Y nElMes = 06;
                    || fecha reincorporacion anterior a la fecha de renuncia
                    || durante junio
                    || en junio, reincorporaciones de mayo tambien, claro
                    |SI fFechaRenuncia ] "01.06.2020"; |Y fFechaRenuncia [ "31.06.2020";
                    |Y fFechaReincorp ] "01.05.2020";
                         swSigue = 1;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI swSigue = 1;
               || tramo en ERTE comienza tras renuncia al ERTE FM
               || o antes, que tambien se puede
               |SI nElMes = 5; |Y nElAny = 2020;       || en mayo
                    |SI #labtraba#144 = 1;
                         nPorExoCOVID19 = 60;          || < 50 trab.
                    |SINO;
                         nPorExoCOVID19 = 45;          || ] 50 trab.
                    |FINSI;
               |FINSI;
               |SI nElMes = 6; |Y nElAny = 2020;
                    |SI #labtraba#144 = 1;
                         nPorExoCOVID19 = 45;          || < 50 trab.
                    |SINO;
                         nPorExoCOVID19 = 30;          || ] 50 trab.
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |BUCLE ExoCOVID03_ERTE;

     |SI nPorExoCOVID19 ! 0;;
          #nomcot02#99 = nPorExoCOVID19;
          |GRABA 020#nomcot02.a;
          |LIBERA #nomcot02;
     |FINSI;

     |SI swFormacion = 1;
          nForPorExoCOVID = nPorExoCOVID19;
     |FINSI;
|FPRC;

|PROCESO ExoCOVID02;
     nPorExoCOVID19 = 0
     swExoCOVID19 = 0;

     || exoneraciones COVID-19

     |SI #labtraba#188 = "S"; |O #labtraba#188 = "1"; |O #labtraba#188 = "A";
          || lo general, ahora veamos casos particulares
          swExoCOVID19 = 1;
     |FINSI;

     |HAZ ITnomvarca;    || a ver en que linea esta este tramo

     |SI nLineaIT ] 2;   || no esta en la primera linea
          || a ver si existe 948 con unidades
          |SI nUniDes2 ! 0;
               || si tengo unidades, indican el dia que empieza
               || el "segundo" ERE
               |SI nDesdeDia ] nUniDes2;
                    |SI #labtraba#188 = "2"; |O #labtraba#188 = "A";
                         || el "segundo" ERE esta exonerado
                         swExoCOVID19 = 1;
                    |SINO;
                         swExoCOVID19 = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swExoCOVID19 = 1;
          |SI #nomcot02#27 = "ERE"; |O #nomcot02#27 = "ETP";
               swTramoERE = 1;
               |HAZ Exoneracion_ERTE;

               |SI #nomcot02#27 = "ETP";
                    || ETP, para exoneracion de la parte que no es ERE
                    |HAZ Exoneracion_Alta;
               |FINSI;
          |SINO;
               || exoneraciones para la parte de ALTA
               swTramoAlta = 1;
               |HAZ Exoneracion_Alta;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE ExoCOVID02;
     #nomcot02#1;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, 00001;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, 99999;
     be;
     NULL, ExoCOVID02;
|FIN;

|PROCESO ExoneracionCOVID;
     |SI swFormacion = 1; |Y #labtraba#191 = "S";
          || no hay exoneracion si tengo ya las cuotas bonificadas
          |ACABA;
     |FINSI;

     swTramoAlta = 0;
     swTramoERE = 0;
     nForPorExoCOVID = 0;

     |BUCLE ExoCOVID02;

     |SI swTramoAlta = 1;
     |Y swTramoERE = 1;
     |Y nForPorExoCOVID ! 0;
          || trabajadores en formacion, un tramo SIN ERE
          || que es donde sale la cuota, y otro en ERE exonerado
          || vuelvo a calcular exoneracion para que exonere la parte de alta
          || tiquet 3923.2183
          |BUCLE ExoCOVID02;
     |FINSI;
|FPRC;

/****************************************************************************/

|| PROCESOS PARA QUE SI LA CUOTA TOTAL EMPRESA ES NEGATIVA, NO SE BONIFIQUE
|| MAS DE LO QUE SE PUEDA BONIIFCAR HASTA QUE QUEDE A CERO

|PROCESO nomcot04_res;
     ||SI #nomcot04#16 > nExceso;
          #nomcot04#16 = #nomcot04#16 - nExceso;
          #nomcot04#17 = #nomcot04#17 - nExceso;
          |GRABA 020#nomcot04.a;
          |LIBERA #nomcot04;
          |ERROR10;
     ||FINSI;
|FPRC;

|DEFBUCLE nomcot04_res;
     #nomcot04#1;
     ;
     #nomcot03#0, #nomcot03#1, #nomcot03#2, #nomcot03#3, #nomcot03#4, #nomcot03#5, #nomcot03#6, 001;
     #nomcot03#0, #nomcot03#1, #nomcot03#2, #nomcot03#3, #nomcot03#4, #nomcot03#5, #nomcot03#6, 999;
     be;
     NULL, nomcot04_res;
|FIN;

|PROCESO nomcot03_Resta;
     #nomcot03#0 = nEmp;
     #nomcot03#1 = nElAny;
     #nomcot03#2 = nElMes;
     #nomcot03#3 = enTipo;
     #nomcot03#4 = aCCCReg;
     #nomcot03#5 = aNaf;
     #nomcot03#6 = nLinea;
     #nomcot03#7 = nTra;
     #nomcot03#10 = nCon;
     |LEE 101#nomcot03.=;

     |SI FSalida = 0;
          |SI #nomcot03#16 < nAcumNeg;
               nExceso = #nomcot03#16;
               nAcumNeg = nAcumNeg - nExceso;
          |SINO;
               nExceso = nAcumNeg;
               nAcumNeg = 0;
          |FINSI;

          #nomcot03#16 = #nomcot03#16 - nExceso;
          #nomcot03#17 = #nomcot03#17 - nExceso;
          |GRABA 020#nomcot03.a;
          |LIBERA #nomcot03;

          |SI nCon = 571;
               #nomcot03#10 = 598;
          |SINO;
               #nomcot03#10 = 798;
          |FINSI;
          |LEE 101#nomcot03.=;

          |SI FSalida = 0;
               #nomcot03#16 = #nomcot03#16 + nExceso;
               #nomcot03#17 = #nomcot03#17 + nExceso;
               |GRABA 020#nomcot03.a;
               |LIBERA #nomcot03;
          |FINSI;

          #nomcot03#10 = 998;
          |LEE 101#nomcot03.=;
          |SI FSalida = 0;
               #nomcot03#16 = #nomcot03#16 + nExceso;
               #nomcot03#17 = #nomcot03#17 + nExceso;
               |GRABA 020#nomcot03.a;
               |LIBERA #nomcot03;
          |FINSI;

          || por ultimo en la bonificacion
          |BUCLE nomcot04_res;
     |FINSI;
|FPRC;

|PROCESO CompFormacion;
     swNoSigas = 0;
     |PARA nCampo = 0; |SI nCampo [ 7; |HACIENDO nCampo = nCampo + 1;
          #nomcot02#nCampo# = #nomcot03#nCampo#;
     |SIGUE;
     |LEE 000#nomcot02.=;
     |SI FSalida = 0;
          |SI #nomcot02#73 = 421; |O #nomcot02#73 = 422;
               swNoSigas = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO nomcot03_Con;
     |HAZ CompFormacion;
     |SI swNoSigas = 0;            || no tengo en cuenta los de formacion
            nPrestacion = nPrestacion + #nomcot03#16;
     |FINSI;
|FPRC;

|DEFBUCLE nomcot03_Con;
     #nomcot03#1;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, 00001, nCon;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, 99999, nCon;
     be;
     NULL, nomcot03_Con;
|FIN;

|PROCESO nomcot03_998;
     |HAZ CompFormacion;
     |SI swNoSigas = 0;            || no tengo en cuenta los de formacion
          aAlfa1 = #nomcot03#6;
          |QBF aAlfa1;
          aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa2 = #nomcot03#7;
          |QBF aAlfa2;
          aAlfa2 = ("00000" + aAlfa2) % -105;

          aTramos = aAlfa1 + aAlfa2 + aTramos;
          || formato: LLCCCCC, que es  Linea y CodTra

          nAcumNeg = nAcumNeg + ((-1) * #nomcot03#16);
     |FINSI;
|FPRC;

|DEFBUCLE nomcot03_998;
     #nomcot03#1;
     ;
     || nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, #labtraba#1, 998;
     || nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, #labtraba#1, 998;
     || esperemos que no pase, pero hay que tener en cuenta que pase por
     || mas de un trabajador
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, 00001, 998;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, 99999, 998;
     be;
     NULL, nomcot03_998;
|FIN;

|PROCESO CuotasNeg;
     || primero comprueba el liquido de totales por tramo

     nAcumNeg = 0;

     aTramos = "";
     |BUCLE nomcot03_998;

     nPrestacion = 0;
     nCon = 563;
     |BUCLE nomcot03_Con;
     nCon = 663;
     |BUCLE nomcot03_Con;

     || acumNeg la tengo ya en positivo
     nAcumNeg = nAcumNeg - nPrestacion;

     || nAcumNeg es la diferencia negativa (que yo me guardo en positivo)
     || que tengo en los tramos, si le quito la prestacion y sigue
     || dando positivo, es que me ha quedado cuota negativa, busco por
     || las bonificaciones que tenga, para restarles lo que haga falta y
     || no bonificarme mas de la cuenta, en principio, que la SS Empresa
     || no sea nunca inferior a cero (excluyo formacion claro)

     |SI nAcumNeg > 0;
          |PARA nPos = 1; |SI; |HACIENDO nPos = nPos + 7;
               nNume = (nPos * 100) + 7;
               aSeleccion = aTramos % nNume;
               |QBF aSeleccion;
               |SI aSeleccion ! "";
               |O nAcumNeg > 0;
                    aAlfa = aSeleccion % 102;
                    nLinea = aAlfa;
                    aAlfa = aSeleccion % 305;
                    nTra = aAlfa;

                    nCon = 571;
                    |HAZ nomcot03_Resta;

                    nCon = 760;
                    |HAZ nomcot03_Resta;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

/****************************************************************************/

|PROCESO ActualizaBase;
     |PARA nCampo = 30; |SI nCampo [ 49; |HACIENDO nCampo = nCampo + 2;
          nCampo1 = nCampo + 1;
          |SI #nomcot02#nCampo# = 000; |O #nomcot02#nCampo# = nConcepto;
               |SI #nomcot02#nCampo# = nConcepto;
                    || mismo concepto, se supone que voy a acumular a lo que
                    || ya existiera (cosa que no se por que tiene que hacerse
                    || y por que no se graba de nuevo siempre)
               |Y #nomcot02#nCampo1# = nBase;
                    || ojo, ademas es EL MISMO IMPORTE EN LA BASE
                    || esto puede ser un error de los del tiquet 1156.2213
                    || o 4333.1919
                    |ACABA;
               |FINSI;
               #nomcot02#nCampo# = nConcepto;
               #nomcot02#nCampo1# = #nomcot02#nCampo1# + nBase;
               |SI nConcepto = 563; |O nConcepto = 663;
                    #nomcot02#nCampo1# = #nomcot02#nCampo1# + nCuotaEmp;
               |FINSI;
               |SI swFormacion = 1; |Y nConcepto = 500;
                    || trabajador de formacion, cuando grabo la base de comunes
                    || lo marco como que en este he cotizado las cuotas
                    || asi si hay otro tramo de otra ficha, ya se que en ese
                    || no he de cotizar
                    #nomcot02#94 = 1;
               |FINSI;
               |GRABA 020#nomcot02.a;
               |LIBERA #nomcot02;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ActualizaHoras;
     |PARA nCampo = 60; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 2;
          nCampo1 = nCampo + 1;
          |SI #nomcot02#nCampo# = 000; |O #nomcot02#nCampo# = nCodigoHoras;
               |SI #nomcot02#nCampo# = nCodigoHoras;
                    || mismo concepto, se supone que voy a acumular a lo que
                    || ya existiera (cosa que no se por que tiene que hacerse
                    || y por que no se graba de nuevo siempre)
               |Y #nomcot02#nCampo1# = nHoras;
                    || ojo, ademas es EL MISMO IMPORTE EN LA BASE
                    || esto puede ser un error de los del tiquet 1156.2213
                    || o 4333.1919
                    |ACABA;
               |FINSI;
               #nomcot02#nCampo# = nCodigoHoras;
               #nomcot02#nCampo1# = #nomcot02#nCampo1# + nHoras;
               |GRABA 020#nomcot02.a;
               |LIBERA #nomcot02;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaConcepto;
     |DDEFECTO #nomcot03;
     |PARA nCampo = 0; |SI nCampo [ 9; |HACIENDO nCampo = nCampo + 1;
          #nomcot03#nCampo# = #nomcot02#nCampo#;
     |SIGUE;

     aAlfa = nCuotaTra; |QBF aAlfa; |SI aAlfa = "-0"; nCuotaTra = 0; |FINSI;
     aAlfa = nCuotaEmp; |QBF aAlfa; |SI aAlfa = "-0"; nCuotaEmp = 0; |FINSI;
     aAlfa = nCuotaTot; |QBF aAlfa; |SI aAlfa = "-0"; nCuotaTot = 0; |FINSI;

     #nomcot03#10 = nConcepto;

     |LEE 101#nomcot03.=;
     FEstado = FSalida;

     #nomcot03#11 = #nomcot26#1;
     #nomcot03#12 = nBase;
     #nomcot03#13 = nTipoTra;
     |SI swParteEnAltaERETP = 1;
          #nomcot03#14 = #nomcot03#14 + nCuotaTra;
     |SINO;
          #nomcot03#14 = nCuotaTra;
     |FINSI;
     #nomcot03#15 = nTipoEmp;
     |SI swParteEnAltaERETP = 1;
          #nomcot03#16 = #nomcot03#16 + nCuotaEmp;
     |SINO;
          #nomcot03#16 = nCuotaEmp;
     |FINSI;
     |SI swParteEnAltaERETP = 1;
          #nomcot03#17 = #nomcot03#17 + nCuotaTot;
     |SINO;
          #nomcot03#17 = nCuotaTot;
     |FINSI;

     |SI swParteEnAltaERETP = 1;
          |SI FEstado = 0;
               |GRABA 020#nomcot03.a;
          |SINO;
               |GRABA 020#nomcot03.n;
          |FINSI;
     |SINO;
          |GRABA 020#nomcot03.n;
     |FINSI;

     |LIBERA #nomcot03;
|FPRC;

|PROCESO GrabaBonifTramo;
     |DDEFECTO #nomcot04;
     |PARA nCampo = 0; |SI nCampo [ 9; |HACIENDO nCampo = nCampo + 1;
          #nomcot04#nCampo# = #nomcot02#nCampo#;
     |SIGUE;
     #nomcot04#10 = nBonif;
     |LEE 101#nomcot04.=;
     FEstado = FSalida;
     #nomcot04#11 = aDesBonif;
     #nomcot04#12 = nBaseBonifica;
     #nomcot04#13 = nTipoBonTra;
     #nomcot04#14 = nImporteBonTra;
     #nomcot04#15 = nTipoBonEmp;
     #nomcot04#16 = nImporteBonEmp;
     #nomcot04#17 = nImporteBonEmp + nImporteBonTra;
     |SI nBonif = 602;
          #nomcot04#18 = nHorasForTra;
     |FINSI;
     |SI nBonif = 603;
          #nomcot04#18 = nHorasTut;
     |FINSI;
     |SI #nombonif#10 = 7;
          || hay que acumular, que esta ya estara grabada
          || a ver, las tipo "7" la mitad van al 571 y la otra mitad al 760
          || esto hace que sean las unicas bonificaciones que habria que
          || grabarlas dos veces, es decir acumulando
          |LEE 101#nomcot04.=;
          |SI FSalida = 0;
               #nomcot04#16 = #nomcot04#16 + nImporteBonEmp;
               #nomcot04#17 = #nomcot04#17 + nImporteBonEmp;
               |GRABA 020#nomcot04.a;
          |SINO;
               |GRABA 020#nomcot04.n;
          |FINSI;
     |SINO;
          |SI FEstado = 0;
               |GRABA 020#nomcot04.a;
          |SINO;
               |GRABA 020#nomcot04.n;
          |FINSI;
     |FINSI;

     |LIBERA #nomcot04;
|FPRC;

|PROCESO BaseBonIT;
          |SI #nombonif#4 ! 0; |O nFijBonif ! 0; |O nExeBonif ! 0;
               nBase = #nomcot02#22 * nBaseITCC;
               nConcepto = 500;
               |SI #nomcot02#27 = "ETP";
                    || en el ERE a TP no se topea la base de IT por la que
                    || se bonifica
               |SINO;
                    swTopes = 2;
                    |HAZ Topes;
               |FINSI;
               nBaseBonCC = nBase;

               nNume1 = (nBaseBonCC % (#nomconst#6 + #nomconst#7)) ! 2;
               nNume2 = (nBaseBonCC % #nomconst#7) ! 2;
               nCuotaBonCC = nNume1 - nNume2;

               |SI #nombonif#10 = 4;
                    || mayores 65, la unica que no bonifica el 23.60
                    nCuotaBonCC = (nBaseBonCC % #nombonif#4) ! 2
               |FINSI;
          |FINSI;

          |SI #nombonif#6 ! 0;
               || mayores 65, la unica que bonifica CC Trab
               nBase = nBaseBon;
               nConcepto = 500;
               |SI #nomcot02#27 = "ETP";
                    || en el ERE a TP no se topea la base de IT por la que
                    || se bonifica
               |SINO;
                    swTopes = 2;
                    |HAZ Topes;
               |FINSI;
               nBaseBonCC = nBase;
               nNume1 = (nBaseBonCC % #nombonif#6) ! 2;
               nCuotaBonCCTra = nNume1;
          |FINSI;

          |SI #nombonif#5 ! 0;
               nBase = #nomcot02#22 * nBaseITATEP;
               nConcepto = 600;
               |SI #nomcot02#27 = "ETP";
                    || en el ERE a TP no se topea la base de IT por la que
                    || se bonifica
               |SINO;
                    swTopes = 2;
                    |HAZ Topes;
               |FINSI;
               nBaseBonATEP = nBase;

               || Repetido de la parte en alta, por no meter mas procesos

               || CUOTA TOTAL - CUOTA TRAB.

               || Desempleo
               nNume1 = (nBaseBonATEP % (#nomconst#12 + #nomconst#13)) ! 2;
               nNume2 = (nBaseBonATEP % #nomconst#13) ! 2;
               nCuotaBonATEP = nNume1 - nNume2;

               || FOGASA
               nNume1 = (nBaseBonATEP % #nomconst#14) ! 2;
               nCuotaBonATEP = nCuotaBonATEP + nNume1;

               || FP
               nNume1 = (nBaseBonATEP % (#nomconst#16 + #nomconst#17)) ! 2;
               nNume2 = (nBaseBonATEP % #nomconst#17) ! 2;
               nCuotaBonATEP = nCuotaBonATEP + (nNume1 - nNume2);
          |FINSI;
|FPRC;

|PROCESO BaseBonAlta;
          |SI #nombonif#4 ! 0; |O nFijBonif ! 0; |O nExeBonif ! 0;
               nBaseBon = nBaseTramoCC;
               nBase = nBaseBon;
               nConcepto = 500;
               swTopes = 1;
               |HAZ Topes;
               nBaseBonCC = nBase;
               nNume1 = (nBaseBonCC % (#nomconst#6 + #nomconst#7)) ! 2;
               nNume2 = (nBaseBonCC % #nomconst#7) ! 2;
               nCuotaBonCC = nNume1 - nNume2;
               |SI #nombonif#10 = 4;
                    || mayores 65, la unica que no bonifica el 23.60
                    nCuotaBonCC = (nBaseBonCC % #nombonif#4) ! 2
               |FINSI;
          |FINSI;
          |SI #nombonif#6 ! 0;
               || mayores 65, la unica que bonifica CC Trab
               nBase = nBaseBon;
               nConcepto = 500;
               swTopes = 1;
               |HAZ Topes;
               nBaseBonCC = nBase;
               nNume1 = (nBaseBonCC % #nombonif#6) ! 2;
               nCuotaBonCCTra = nNume1;
          |FINSI;
          |SI #nombonif#5 ! 0;
               nBaseBon = nBaseTramoCP;
               nBase = nBaseBon;
               nConcepto = 600;
               swTopes = 1;
               |HAZ Topes;

               nBaseBonATEP = nBase;

               || CUOTA TOTAL - CUOTA TRAB.

               || Desempleo
               nNume1 = (nBaseBonATEP % (#nomconst#12 + #nomconst#13)) ! 2;
               nNume2 = (nBaseBonATEP % #nomconst#13) ! 2;
               nCuotaBonATEP = nNume1 - nNume2;

               || FOGASA
               nNume1 = (nBaseBonATEP % #nomconst#14) ! 2;
               nCuotaBonATEP = nCuotaBonATEP + nNume1;

               || FP
               nNume1 = (nBaseBonATEP % (#nomconst#16 + #nomconst#17)) ! 2;
               nNume2 = (nBaseBonATEP % #nomconst#17) ! 2;
               nCuotaBonATEP = nCuotaBonATEP + (nNume1 - nNume2);

               || para las que solo bonifican desempleo (hijos aut.)

               |SI #nomconst#12 = #nombonif#5;
                    || Desempleo
                    nNume1 = (nBaseBonATEP % (#nomconst#12 + #nomconst#13)) ! 2;
                    nNume2 = (nBaseBonATEP % #nomconst#13) ! 2;
                    nCuotaBonATEP = nNume1 - nNume2;
               |FINSI;
          |FINSI;
|FPRC;

|PROCESO BasesCuotasBonif;
     nBaseBonCC = 0;
     nBaseBonATEP = 0;
     nCuotaBonCC = 0;
     nCuotaBonCCTra = 0;
     nCuotaBonATEP = 0;
     nConceptoAnt = nConcepto;

     |SI #nomcot02#27 = "ALT";
          |HAZ BaseBonAlta;
     |SINO;
          |SI #nomcot02#27 = "ETP";
               || en ERE a TP bonifico las dos partes, y como en el propio
               || tramo estan las dos partes, tengo que hacerlo asi, primero
               || la parte de alta y luego la de baja


               |SI swParteEnAltaERETP = 1;
                    || solo cuando calculo la parte en alta, si no se haria dos veces
                    |HAZ BaseBonAlta;
                    nBaseBonCC_A = nBaseBonCC;
                    nBaseBonATEP_A = nBaseBonATEP;
                    nCuotaBonCC_A = nCuotaBonCC;
                    nCuotaBonCCTra_A = nCuotaBonCCTra;
                    nCuotaBonATEP_A = nCuotaBonATEP;

                    nBaseBonCC = 0;
                    nBaseBonATEP = 0;
                    nCuotaBonCC = 0;
                    nCuotaBonCCTra = 0;
                    nCuotaBonATEP = 0;

                    |HAZ BaseBonIT;
                    nBaseBonCC = nBaseBonCC + nBaseBonCC_A;
                    nBaseBonATEP = nBaseBonATEP + nBaseBonATEP_A;
                    nCuotaBonCC = nCuotaBonCC + nCuotaBonCC_A;
                    nCuotaBonCCTra = nCuotaBonCCTra + nCuotaBonCCTra_A;
                    nCuotaBonATEP = nCuotaBonATEP + nCuotaBonATEP_A;
               |FINSI;
          |SINO;
               |HAZ BaseBonIT;
          |FINSI;
     |FINSI;

     || para terminar, dejo a cero nBase, para que no se pinte en los tramos
     || y el concepto como estaba, que para calcular los topes he tenido que
     || cambiarlo
     nBase = 0;
     nConcepto = nConceptoAnt;
|FPRC;

|PROCESO BonFormacion;
     nImporteBonEmp = 0;
     nImporteBonTra = 0;
     nBaseBonifica = 0;
     |SI swFormacion = 1; |Y #labtraba#191 = "S"; |Y nConcepto = 571;
          |SI swCuotasFor = 0;
               nCuotaEmp = #nomconst#82;
               |SI #labtraba#45 = 421;
                    nCuotaEmp = nCuotaEmp + #nomconst#84;   || 422 no
               |FINSI;
               nCuotaEmp = nCuotaEmp + #nomconst#86 + #nomconst#87;
               |SI #labtraba#190 = "S"; |Y #labtraba#45 = 421;
                    nCuotaEmp = nCuotaEmp + #nomconst#90;
               |FINSI;

               nCuotaTra = #nomconst#83;
               |SI #labtraba#45 = 421;
                    nCuotaTra = nCuotaTra + #nomconst#85;   || 422 no
               |FINSI;
               |SI #labtraba#190 = "S"; |Y #labtraba#45 = 421;
                    nCuotaTra = nCuotaTra + #nomconst#91;
               |FINSI;
               |SI #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT";
               |O #nomcot02#27 = "RIE"; |O #nomcot02#27 = "CON";
                    nCuotaTra = 0;
               |FINSI;
               |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC";
                    |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
                         nCuotaTra = 0;
                    |FINSI;
               |FINSI;

               nCuotaTot = nCuotaTra + nCuotaEmp;

               nBonif = 601;
               aDesBonif = "Bonificaci¢n Cuotas Formaci¢n";
               nImporteBonTra = nCuotaTra;
               nImporteBonEmp = nCuotaEmp;
               |HAZ GrabaBonifTramo;
          |FINSI;
          |SI swCuotasFor = 2;
               || solo para cotizar por la parte del trab. en caso de que
               || en otro tramo en IT sin carencia se haya cotizado por la
               || de la empresa
               nCuotaTra = #nomconst#83;
               |SI #labtraba#45 = 421;
                    nCuotaTra = nCuotaTra + #nomconst#85;   || 422 no
               |FINSI;
               |SI #labtraba#190 = "S"; |Y #labtraba#45 = 421;
                    nCuotaTra = nCuotaTra + #nomconst#91;
               |FINSI;
               |SI #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT";
               |O #nomcot02#27 = "RIE"; |O #nomcot02#27 = "CON";
                    nCuotaTra = 0;
               |FINSI;
               |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC";
                    |SI #labtraba#138 = "N"
                         nCuotaTra = 0;
                    |FINSI;
               |FINSI;

               nCuotaTot = nCuotaTra;
               nBonif = 601;
               aDesBonif = "Bonificaci¢n Cuotas Formaci¢n";
               nImporteBonTra = nCuotaTra;
               |HAZ GrabaBonifTramo;
          |FINSI;
     |FINSI;

     |SI swFormacion ! 0; |Y nConcepto = 760;
          |SI nHorasForTra ! 0;
               |SI nImporteHoraFor = 0;
                    nImporteHoraFor = 5;
               |FINSI;
               nNume = nHorasForTra * nImporteHoraFor;
               nCuotaEmp = nCuotaEmp + nNume;
               nCuotaTot = nCuotaTot + nNume;
               nBonif = 602
               aDesBonif = "Horas Formaci¢n";
               nImporteBonEmp = nNume;
               |HAZ GrabaBonifTramo;
          |FINSI;
          |SI nHorasTutTra ! 0;
               nNume = nHorasTutTra * (nBonifTut / nHorasTut);
               nCuotaEmp = nCuotaEmp + nNume;
               nCuotaTot = nCuotaTot + nNume;
               nBonif = 603;
               aDesBonif = "Horas Tutor¡a";
               nImporteBonEmp = nNume;
               |HAZ GrabaBonifTramo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BonifFomento;
     || en situacion de ERE a TP, si tengo bonif de fomento de empleo
     || tengo que entrar solo una vez aqui, si no me haria dos veces la
     || bonificacion, lo dejo para que entre solo en la parte en alta

     |SI #nomcot02#27 = "ETP";
          |SI swParteEnAltaERETP = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     nBonFom = 0;
     nImporteBonEmp = 0;
     nImporteBonTra = 0;
     nBaseBonifica = 0;
     aDesBonif = #nomboni3#1;
     |SI aTramoBon = "";
          |SI #nomboni3#5 ! 0;
               nBonFom = #nomboni3#5;
          |SINO;
               nBonFom = #nomboni3#2 / 12;
          |FINSI;
     |FINSI;
     |SI aTramoBon = "A";
          |SI #nomboni3#6 ! 0;
               nBonFom = #nomboni3#6;
          |SINO;
               nBonFom = #nomboni3#2 / 12;
          |FINSI;
     |FINSI;
     |SI aTramoBon = "B";
          |SI #nomboni3#7 ! 0;
               nBonFom = #nomboni3#7;
          |SINO;
               nBonFom = #nomboni3#2 / 12;
          |FINSI;
     |FINSI;

     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
     |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
          nNume = 0;
          |SI nBonif = 161; |O nBonif = 164;
          |O nBonif = 169; |O nBonif = 170;
          |O nBonif = 119; |O nBonif = 120;
               nNume = tp;
          |SINO;
               |SI nBonif = 199;
                    |SI 0.50 [ tp; |Y tp < 0.75;
                         nNume = 0.50;
                    |FINSI;
                    |SI 0.75 [ tp;
                         nNume = 0.75;
                    |FINSI;
               |SINO;
                    nNume = tp + 0.3;
               |FINSI;
          |FINSI;
          |SI nNume > 1;
               nNume = 1;
          |SINO;
               nNume = nNume ! 3;
          |FINSI;
          nBonFom = nBonFom * nNume;
     |FINSI;

     nNume = (nBonFom / 30) ! 2;
     nDiasBon = #nomcot02#22;
     nTotDiasBon = nTotDiasBon + nDiasBon;
     |HAZ BonifDiarios;

     nNume = nNume * nDiasBon;
     nTotBonFom = nTotBonFom + nNume;

     nDiferencia = nBonFom - nTotBonFom;
     |SI -0.50 [ nDiferencia; |Y nDiferencia [ 0.50;
          nNume = nNume + nDiferencia;
     |FINSI;

     aAntTramoBon = aTramoBon;
     nTramoBon = nTramoBon + 1;

     nNume = nNume ! 2;

     nCuotaEmp = nCuotaEmp + nNume;
     nCuotaTot = nCuotaTot + nNume;

     nImporteBonEmp = nNume;
     |HAZ GrabaBonifTramo;
|FPRC;

/****************************************************************************/
/*PROCESO QUE CREA UN AUXILIAR DE LAS FICHAS POR NIF ORDENADO POR FECHA ALTA*/
/****************************************************************************/

|PROCESO TmpTrab;
     aAlfa = #labtraba#36;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y aAlfa ! "..........";
          #nomtrtmp#4 = #labtraba#36;   || fecha alta
     |SINO;
          #nomtrtmp#4 = "00.00.0000";
     |FINSI;
     #nomtrtmp#0 = #labtraba#0;    || empresa
     #nomtrtmp#1 = #labtraba#1;    || trabajador
     #nomtrtmp#2 = #labtraba#2;    || nombre
     #nomtrtmp#3 = #labtraba#7;    || nif
     #nomtrtmp#5 = #labtraba#37;   || fecha baja
     #nomtrtmp#20 = #labtraba#42;  || clave de cotizacion
     #nomtrtmp#21 = #labtraba#129; || situacion especial
     #nomtrtmp#22 = #labtraba#234; || jornada
     |GRABA 020#nomtrtmp.n;
     |LIBERA #nomtrtmp;
|FPRC;

|DEFBUCLE TmpTrab;
     #labtraba#1;
     7;
     00001, 00001, aNif;
     99999, 99999, aNif;
     ;
     NULL, TmpTrab;
|FIN;

|PROCESO HistTrab;
     |SALVA_FICHA #labtraba;
     aAlfa = Usuario;  |QBF aAlfa;    aAlfa = aAlfa + "_nomtrtmp";
     |NOME_DAT #nomtrtmp#aAlfa#;         || tmp contador de trabajadores
     |DELINDEX #nomtrtmp;   || Se carga el temporal que pudiera existir
     |ABRE #nomtrtmp;
     aNif = #labtraba#7;
     |BUCLE TmpTrab;
     |CIERRA #nomtrtmp;
     |REPON_FICHA #labtraba;
|FPRC;

|PROCESO BonifGuardaLegal;
     |HAZ HistTrab;
     |ABRE #nomtrtmp;
     |LEE 000#nomtrtmp.u;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #nomtrtmp#21 ! "G";
               || es el primer trabajador que no tiene guarda legal
               || yendo atras en el tiempo asi que este es del que
               || tengo que coger la jornada

               |SI #nomtrtmp#20 = "X"; |O #nomtrtmp#20 = "T";
               |O #nomtrtmp#20 = "I"; |O #nomtrtmp#20 = "P";
                    nBonTP = ((#nomtrtmp#22 / 40) ! 3);
                    |SI nBonTP ] 0.50;
                         nExeBonif = nExeBonif * nBonTP;
                    |SINO;
                         nExeBonif = 0;
                    |FINSI;
               |FINSI;
               |SAL;
          |FINSI;
          |LEE 000#nomtrtmp.a;
     |SIGUE;
     |CIERRA #nomtrtmp;
     |DELINDEX #nomtrtmp;   || Se carga el temporal que pudiera existir
|FPRC;

/****************************************************************************/

|PROCESO BonifDiarios;
     || ajustes bonificacion diarios

     || si es cuando cambia de tramo de bonificacion, no hay que realizar
     || el ajuste (mirar tiquet 668.1855

     |SI nTramoBon ! 0;                 || tramo segundo o mas
     |Y aTramoBon ! aAntTramoBon;       || he cambiado de tramo
          |ACABA;
     |FINSI;

     nAjustaBon = 0;
     |SI nTotDiasBon = 31;
          || nunca mas de 30
          nAjustaBon = -1;
     |SINO;
          |SI nElMes = 2;
               |SI nTotDiasBon = 28; nAjustaBon = 2; |FINSI;
               |SI nTotDiasBon = 29; nAjustaBon = 1; |FINSI;
          |FINSI;
     |FINSI;
     nDiasBon = nDiasBon + nAjustaBon;
     nTotDiasBon = nTotDiasBon + nAjustaBon;
|FPRC;

|PROCESO BonifMant;
     nPorBonif = 0; nFijBonif = 0; nExeBonif = 0;
     nBaseBonifica = 0;
     nTipoBonEmp = 0;
     nTipoBonTra = 0;
     nImporteBonEmp = 0;
     nImporteBonTra = 0;
     aDesBonif = #nombonif#1;
     |SI aTramoBon = "";
          nPorBonif = #nombonif#3; nFijBonif = #nombonif#28; nExeBonif = #nombonif#39;
     |FINSI;
     |SI aTramoBon = "A";
          nPorBonif = #nombonif#20; nFijBonif = #nombonif#29; nExeBonif = #nombonif#40;
     |FINSI;
     |SI aTramoBon = "B";
          nPorBonif = #nombonif#21; nFijBonif = #nombonif#30; nExeBonif = #nombonif#41;
     |FINSI;
     |SI aTramoBon = "C";
          nPorBonif = #nombonif#22; nFijBonif = #nombonif#31; nExeBonif = #nombonif#42;
     |FINSI;
     |SI aTramoBon = "D";
          nPorBonif = #nombonif#23; nFijBonif = #nombonif#32; nExeBonif = #nombonif#43;
     |FINSI;
     |SI aTramoBon = "E";
          nPorBonif = #nombonif#24; nFijBonif = #nombonif#33; nExeBonif = #nombonif#44;
     |FINSI;

     || problema en las bonificaciones
     || necesito saber cual sera mi base de CC y de ATEP para calcular la
     || bonificacion, tengo que coger la remuneracion y aplicar los topes
     || tanto para CC como para ATEP en alta y en IT antes de calcular las
     || cuotas de bonificacion

     || para eso esta este proceso
     |HAZ BasesCuotasBonif;

     nCuotaEmp = 0;
     nCuotaTra = 0;

     || primero las bonificaciones "de siempre", un porcentaje, como la de
     || maternidad
     |SI nPorBonif ! 0;
          nNume = (nCuotaBonCC % nPorBonif) ! 2;
          nCuotaEmp = nNume;

          nNume = (nCuotaBonCCTra % nPorBonif) ! 2;
          nCuotaTra = nNume;

          nNume = (nCuotaBonATEP % nPorBonif) ! 2;
          nCuotaEmp = nCuotaEmp + nNume;

          |SI #nombonif#8 = "S";
               || para ATEP recalculo aqui la cuota
               nNume = (nBaseBonATEP % epig_ilt) ! 2;
               nNume = (nNume % nPorBonif) ! 2;
               nCuotaEmp = nCuotaEmp + nNume;
               nNume = (nBaseBonATEP % epig_ims) ! 2;
               nNume = (nNume % nPorBonif) ! 2;
               nCuotaEmp = nCuotaEmp + nNume;
          |FINSI;

          |SI #nombonif#10 = 7;
               |SI nConcepto = 571;
                    nCuotaEmp = ((nCuotaEmp / 2) + 0.0049) ! 2;
               |SINO;
                    nCuotaEmp = ((nCuotaEmp / 2) - 0.0049) ! 2;
               |FINSI;
          |FINSI;
          nBaseBonifica = nBaseBonCC;
          |SI nBaseBonCC = 0;      || solo bonifican desempleo (hijos aut)
               nBaseBonifica = nBaseBonATEP;
          |FINSI;
          nImporteBonEmp = nCuotaEmp;
          nImporteBonTra = nCuotaTra;
          |HAZ GrabaBonifTramo;
     |FINSI;

     || ahora las "tarifa plana" una cuota fija en ese tramo por CC
     |SI nFijBonif ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
               |SI tp ] 0.75;
                    nFijBonif = nFijBonif * 0.75;
               |FINSI;
               |SI tp ] 0.50; |Y tp < 0.75;
                    nFijBonif = nFijBonif * 0.50;
               |FINSI;
               |SI tp < 0.50;
                    nFijBonif = 0;
               |FINSI;
          |FINSI;

          nCuotaFija = (nFijBonif / 30) ! 2;
          nDiasBon = #nomcot02#22;

          |HAZ BonifDiarios;

          nCuotaFija = nCuotaFija * nDiasBon;

          nTotFijBonif = nTotFijBonif + nCuotaFija;
          nDiferencia = nFijBonif - nTotFijBonif;
          |SI -0.50 [ nDiferencia; |Y nDiferencia [ 0.50;
               nCuotaFija = nCuotaFija + nDiferencia;
               nTotDiasBon = nTotDiasBon + nDiasBon;
          |FINSI;

          nCuotaEmp = nCuotaBonCC - nCuotaFija;

          nBaseBonifica = nBaseBonCC;
          nImporteBonEmp = nCuotaEmp;
          |HAZ GrabaBonifTramo;
     |FINSI;

     |SI nExeBonif ! 0;
          |SI #labtraba#129 = "G";
               |HAZ BonifGuardaLegal;
          |SINO;
               |SI tp ] 0.50;
                    nExeBonif = nExeBonif * (tp ! 3);
               |SINO;
                    nExeBonif = 0;
               |FINSI;
          |FINSI;
          || solo para despues pinta la base en el lineal de bonif
          nBaseExenta = (nExeBonif / 30);    || sin decimales para ajustar mas
          nBaseExenta = nBaseExenta * #nomcot02#22;

          || la bonificacion si se esta de alta el mes completo
          nExento = (nExeBonif % #nomconst#6) ! 2;

          || la bonificacion POR DIA
          nExeBonif = (nExento / 30) ! 2;

          || acumulo los dias cotizables que voy bonificando
          nDiasBon = #nomcot02#22;
          nTotDiasBon = nTotDiasBon + nDiasBon;

          |HAZ BonifDiarios;

          nExeBonif = nExeBonif * nDiasBon;

          || acumulo la bonificacion que me voy practicando
          nTotExeBonif = nTotExeBonif + nExeBonif;

          nDiferencia = nExento - nTotExeBonif;
          |SI -0.50 [ nDiferencia; |Y nDiferencia [ 0.50;
               nExeBonif = nExeBonif + nDiferencia;
          |FINSI;
          nCuotaEmp = nExeBonif ! 2;

          aAntTramoBon = aTramoBon;
          nTramoBon = nTramoBon + 1;

          || nBaseBonifica = nBaseBonCC;
          nBaseBonifica = nBaseExenta;

          || acumulo la base por la que me voy bonificando
          nExeBonifBase = nExeBonifBase + nBaseExenta;

          nImporteBonEmp = nCuotaEmp;
          |HAZ GrabaBonifTramo;
     |FINSI;

     nCuotaTot = nCuotaEmp + nCuotaTra;
|FPRC;

|PROCESO Bonificacion;
     || Bonificaciones
     nImporteHoraFor = 0;
     |SI nConcepto = 571; |O nConcepto = 760;
          |PARA nCampoBon = 90; |SI nCampoBon [ 93; |HACIENDO nCampoBon = nCampoBon + 1;
               aAlfa = #nomcot02#nCampoBon#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aAlfa1 = aAlfa % 103;
                    aAlfa2 = aAlfa - aAlfa1;
                    nBonif = aAlfa1;
                    aTramoBon = aAlfa2;
                    |QBF aTramoBon;

                    || boniicaciones del mantenimiento de bonificaciones
                    swSigue = 0;
                    |SI nBonif ] 001; |Y nBonif [ 099; swSigue = 1; |FINSI;
                    |SI nBonif ] 500; |Y nBonif [ 599; swSigue = 1; |FINSI;
                    |SI swSigue = 1;
                         || del mantenimiento de bonificaciones
                         #nombonif#0 = nBonif;
                         |LEE 000#nombonif.=;
                         |SI FSalida = 0;
                              || lo dejamos de manera que siempre que se bonifique
                              || CP o ATEP, se considere tipo 2
                              |SI #nombonif#10 = 1;
                                   |SI #nombonif#5 ! 0; |O #nombonif#8 = "S";
                                        #nombonif#10 = 2;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 571;
                                   |SI #nombonif#10 = 1; |O #nombonif#10 = 4;
                                   |O #nombonif#10 = 6; |O #nombonif#10 = 7;
                                        swSigue = 2;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 760;
                                   |SI #nombonif#10 = 2;
                                   |O #nombonif#10 = 7;
                                        swSigue = 2;
                                   |FINSI;
                              |FINSI;
                              |SI #nombonif#11 = "S";
                                   nImporteHoraFor = #nombonif#12;
                              |SINO;
                                   |SI swSigue = 2;
                                        |HAZ BonifMant;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;

                    || bonificaciones de fomento de empleo
                    |SI nBonif ] 100; |Y nBonif [ 299;
                         #nomboni3#0 = nBonif;
                         |LEE 000#nomboni3.=;
                         |SI FSalida = 0;
                              ||SI nConcepto = 571;
                              |SI nConcepto = 760;
                                   |HAZ BonifFomento;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Prestaciones;
     |SI #labtraba#241 = "X";
          |ACABA;
     |FINSI;
     |SI nBase946 ! 0;
          nBaseITCCAnt = nBaseITCC;
          nBaseITCC = nBase946;
     |FINSI;
     |SI nBase947 ! 0;
          nBaseITATEPAnt = nBaseITATEP;
          nBaseITATEP = nBase947;
     |FINSI;
     || PRESTACIONES ENFERMEDAD
     |SI nConcepto = 563;
          swSigue = 0;
          |SI #nomcot02#27 = "ENF";
               |SI #nomcot02#89 = 2; |O #nomcot02#89 = 3;
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI #nomcot02#98 = "ENF";
          |Y swParteEnAltaERETP = 1;
               |SI #nomcot02#89 = 2; |O #nomcot02#89 = 3;
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |SI swSigue = 1;
               nDiasReales = #nomcot02#21 - #nomcot02#20 + 1;
               nDiasPrest1 = 0;
               nDiasPrest2 = 0;
               nNume = 21 - #nomcot02#28;
               |SI nNume > 0;
                    |SI nDiasReales ] nNume;
                         nDiasPrest1 = nNume;
                         nDiasPrest2 = nDiasReales - nNume;
                    |SINO;
                         nDiasPrest1 = nDiasReales;
                         nDiasPrest2 = 0;
                    |FINSI;
               |SINO;
                    nDiasPrest1 = 0;
                    nDiasPrest2 = nDiasReales;
               |FINSI;
               nCuotaEmp = ((nBaseITCC % 60) ! 2) * nDiasPrest1;
               nCuotaEmp = nCuotaEmp + ((nBaseITCC % 75) ! 2) * nDiasPrest2;
               nCuotaTot = nCuotaEmp;
          |FINSI;
     |FINSI;

     || PRESTACIONES ACCIDENTE
     |SI nConcepto = 663;
          swSigue = 0;
          |SI #nomcot02#27 = "ACC"; |Y #nomcot02#89 ! 9;
               swSigue = 1;
          |FINSI;
          |SI #nomcot02#98 = "ACC"; |Y #nomcot02#89 ! 9;
          |Y swParteEnAltaERETP = 1;
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1;
               nDiasReales = #nomcot02#21 - #nomcot02#20 + 1;
               nDiasPrest1 = nDiasReales;
               nCuotaEmp = ((nBaseITATEP % 75) ! 2) * nDiasPrest1;
               nCuotaTot = nCuotaEmp;
          |FINSI;
     |FINSI;

     |SI nBase946 ! 0;
          nBaseITCC = nBaseITCCAnt;
     |FINSI;
     |SI nBase947 ! 0;
          nBaseITATEP = nBaseITATEPAnt;
     |FINSI;
|FPRC;

|PROCESO Deducciones;
     |HAZ Prestaciones;
     |HAZ Bonificacion;
     |HAZ BonFormacion;
|FPRC;

|PROCESO MaximoERETP;
     |SI swTopes ! 0;
          || topes previos a la bonificacion de la parte de alta y de la de baja
          || no tengo en cuenta esto

          |ACABA;
     |FINSI;
     |SI nConcepto = 500; |O nConcepto = 536;
          nAcum5XX = nAcum5XX + (nBase ! 2);
     |FINSI;
     |SI nConcepto = 601; |O nConcepto = 636;
          nAcum6XX = nAcum6XX + (nBase ! 2);
     |FINSI;
     |SI nConcepto = 701; |O nConcepto = 711;
          nAcum7XX = nAcum7XX + (nBase ! 2);
     |FINSI;

     nNume = 30 * #nomconst#nCampoMax#;
     |SI nConcepto = 500; |O nConcepto = 536;
          |SI nAcum5XX > nNume;
|DEBUG;
               nNume = nAcum5XX - nNume;
               nBase = nBase - nNume;
          |FINSI;
     |FINSI;
     |SI nConcepto = 601; |O nConcepto = 611;
     |O nConcepto = 636; |O nConcepto = 637;
          |SI nAcum6XX > nNume;
|DEBUG;
               nNume = nAcum6XX - nNume;
               nBase = nBase - nNume;
          |FINSI;
     |FINSI;
     |SI nConcepto = 701; |O nConcepto = 702; |O nConcepto = 703;
     |O nConcepto = 711; |O nConcepto = 712; |O nConcepto = 713;
          |SI nAcum7XX > nNume;
|DEBUG;
               nNume = nAcum7XX - nNume;
               nBase = nBase - nNume;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Topes;
     |SI #nomcot02#27 = "ETP"; || para acabar, hoy no (05.02.2018)
          || la parte en ERE de los ERE a TP no se topea en principio
          || la parte en alta si que hay que topearlas

          |SI nConcepto = 536; |O nConcepto = 596;
          |O nConcepto = 636; |O nConcepto = 637;
          |O nConcepto = 711; |O nConcepto = 712; |O nConcepto = 713;
               |HAZ MaximoERETP;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #nomcot02#27 = "ETP";
          swCotizHoras = 1;
     |FINSI;
     |SI #nomcot02#27 = "HTP";
          |ACABA;
     |FINSI;
     nGrupoCot = #labtraba#33;
     aClaveCot = #labtraba#42;
     |SI aClaveCot = "D"; |Y #labtraba#64 = "M";
          aClaveCot = "M";
     |FINSI;
     |SI aClaveCot = "C"; |O aClaveCot = "F";
          |SI nGrupoCot ] 8;
               aClaveCot = "D";
          |FINSI;
     |FINSI;
     |SI #labtraba#45 = 421; |O #labtraba#45 = 422;
          aClaveCot = "M";
     |FINSI;

     nContrato = #labtraba#45;
     nDiasTramo = #nomcot02#22;
     nHorasTramo = #nomcot02#24;

     || LOS CAMPOS DEL nomconst
     nCampoMin = 0;
     nCampoMax = 0;
     |SI swCotizHoras = 1; |Y #nomconst#0 = 509;
          swCotizHoras = 0;
     |FINSI;
     |SI swCotizHoras = 0;
     |O #nomcot02#27 = "ASR";
          || TOPES TIEMPO COMPLETO
          |SI nConcepto [ 599;
               || CONTINGENCIAS COMUNES
               nCampoMax = nGrupoCot + 35;
               nCampoMin = nGrupoCot + 23;
               |SI #nomconst#0 = 509;
                    |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                         nCampoMin = nGrupoCot + 47;
                    |FINSI;
               |FINSI;
          |SINO;
               || ATEP
               nCampoMax = 20;
               nCampoMin = 23;
               |SI #nomconst#0 = 509;
                    |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                         nCampoMin = nGrupoCot + 47;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || TOPES TIEMPO PARCIAL
          |SI nConcepto [ 599;
               || CONTINGENCIAS COMUNES
               nCampoMax = nGrupoCot + 35;
               nCampoMin = nGrupoCot + 58;
               nCampoMinDia = nGrupoCot + 23;
          |SINO;
               || ATEP
               nCampoMax = 20;
               nCampoMin = 72;
               nCampoMinDia = 23;
          |FINSI;
          |SI swPluriempleo = 1;
               nGrupoCot = #nompluri#2;
               |SI nConcepto [ 599;
                    || CONTINGENCIAS COMUNES
                    nCampoMax = nGrupoCot + 35;
               |SINO;
                    || ATEP
                    nCampoMax = 20;
               |FINSI;
          |FINSI;
     |FINSI;

     || TIEMPO COMPLETO

     || MAXIMOS TIEMPO COMPLETO O TIEMPO PARCIAL
     |SI nCampoMax ! 0;
          || la base en ALTA

          nBaseMax = #nomconst#nCampoMax#;
          |SI #nomcot02#27 = "ETP";
               ||SI #labtraba#42 ! "X"; |Y #labtraba#42 ! "T";  || si va por horas, las horas
                    || solo pasa en la parte de alta de los ERE a TP, la parte en
                    || en ERE de momento no la estamos topeando
                    || tengo que buscar el coeficiente a TP segun la parte trab.

                    || si es "X" o "T" tambien, no se por que no tiene que hacerlo
                    || tiquet 3430.1673
                    |SI #nomcot02#88 ! 0;
                         nBaseMax = (nBaseMax % (100 - #nomcot02#88));
                         || nBaseMax = nBaseMax - 0.005;
                         || nBaseMax = nBaseMax ! 2;
                         || ni trunco ni redondeo, ya veremos
                    |FINSI;
               ||FINSI;
          |FINSI;
          |SI swPluriempleo = 1;
               nTopePlur = 100;
               |SI nConcepto [ 599; nTopePlur = #nompluri#3; |FINSI;
               |SI nConcepto ] 600; |Y nConcepto [ 699;
                    nTopePlur = #nompluri#3;
               |FINSI;
               |SI nConcepto = 701; |O nConcepto = 705; |O nConcepto = 708;
                    nTopePlur = #nompluri#4;
               |FINSI;
               |SI nConcepto = 702; |O nConcepto = 706; |O nConcepto = 709;
                    nTopePlur = #nompluri#5;
               |FINSI;
               |SI nConcepto = 703; |O nConcepto = 707; |O nConcepto = 710;
                    nTopePlur = #nompluri#6;
               |FINSI;
               || nBaseMax = (nBaseMax * (nTopePlur / 100)) ! 2;
               nBaseMax = (nBaseMax * (nTopePlur / 100));
               |SI #labtraba#129 = "R"; |O #labtraba#129 = "T";
                    nBaseMax = (nBaseMax * tp) ! 2;
               |FINSI;
          |FINSI;

          nBaseMax = (nDiasTramo * nBaseMax) ! 2;
          |SI nBase > nBaseMax;
               nBase = nBaseMax;
          |FINSI;

          swSigue = 0;
          |SI nConcepto ] 600; |Y nRecortaCPMax ! 0;
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1; |Y nUltimoTramo = #nomcot02#6;
               nNume = (nTopemes - 30) * #nomconst#nCampoMax#;
               |SI nNume < 0; nNume = (-1) * nNume; |FINSI;
               |SI nRecortaCPMax > nNume;
                    |SI nElMes = 2;
                         nBase = nBase + nNume;
                    |SINO;
                         nBase = nBase - nNume;
                    |FINSI;
               |SINO;
                    |SI nElMes = 2;
                         nBase = nBase + nRecortaCPMax;
                    |SINO;
                         nBase = nBase - nRecortaCPMax;
                    |FINSI;
               |FINSI;
          |FINSI;

          || la base en IT, si el promedio (nBaseITCC y nBaseITATEP)
          || tienen el promedio (prom_enf y prom_acc) es mayor que la
          || base maxima porque me vienieran mal los topeo ya, para
          || despues multiplicar por los dias  de IT correctos

          nBaseMax = #nomconst#nCampoMax#;
          |SI nConcepto [ 599;
               |SI nBaseITCC > nBaseMax;
                    nBaseITCC = nBaseMax;
               |FINSI;
          |SINO;
               |SI nBaseITATEP > nBaseMax;
                    nBaseITATEP = nBaseMax;
               |FINSI;
          |FINSI;

          || no se puede exceder del limite maximo de cotizacion de
          || contingencias, pase lo que pase, esto es importante para
          || el caso de los mensuales en IT todo el mes, que al cotizar por
          || dias naturales, en meses de 31 dias la podemos cagar
          || en principio lo pongo para pluriempleo que es donde me ha salido

          |SI swPluriempleo = 1;
               nBaseMax = #nomconst#nCampoMax#;
               nBaseMax = ((nBaseMax * 30) * (nTopePlur / 100)) ! 2;
               |SI nBase > nBaseMax;
                    nBase = nBaseMax;
                    |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC"; |O #nomcot02#27 = "CON";
                    |O #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT"; |O #nomcot02#27 = "RIE";
                         || solo en situacion de IT,
                         nBaseITCC = (nBase / nDiasTramo) ! 2;
                         nBaseITATEP = (nBase / nDiasTramo) ! 2;
                         |SI prom_enf ! nBaseITCC;
                              prom_enf = nBaseITCC;
                              swCambiaProm = 1;
                         |FINSI;
                         |SI prom_acc ! nBaseITATEP;
                              prom_acc = nBaseITATEP;
                              swCambiaProm = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     || MINIMOS TIEMPO COMPLETO
     |SI swCotizHoras = 0;
          |SI nCampoMin ! 0; |Y swPluriempleo = 0;
               || LA BASE EN ALTA

               nBaseMin = nDiasTramo * #nomconst#nCampoMin#;

               |SI #nomcot02#27 = "ETP"; |Y swParteEnAltaERETP = 1;
                    nNume = #nomconst#nCampoMin# * (((100 - #nomcot02#88) / 100) ! 2);
                    nBaseMin = nDiasTramo * nNume;
               |FINSI;

               |SI nBase < nBaseMin;
                    nBase = nBaseMin;
               |FINSI;
               swSigue = 0;
               |SI nConcepto ] 600; |Y nRecortaCPMin ! 0;
                    swSigue = 1;
               |FINSI;
               |SI nUltimoTramo = #nomcot02#6;
                    swSigue = swSigue + 1;
               |SINO;
                    |SI nDiasALT = 0; |Y nUltimoTramoIT = #nomcot02#6;
                         swSigue = swSigue + 1;
                    |FINSI;
               |FINSI;
               |SI swSigue = 2;
                    nNume = (nTopemes - 30) * #nomconst#nCampoMin#;
                    |SI nRecortaCPMin < 0; nRecortaCPMin = (-1) * nRecortaCPMin; |FINSI;
                    |SI nNume < 0; nNume = (-1) * nNume; |FINSI;
                    |SI nRecortaCPMin < nNume;
                         |SI nElMes = 2;
                              nBase = nBase + nRecortaCPMin;
                         |SINO;
                              nBase = nBase - nRecortaCPMin;
                         |FINSI;
                    |SINO;
                         |SI nElMes = 2;
                              nBase = nBase + nNume;
                         |SINO;
                              |SI nNroTramos = 1;
   || segun el tiquet 668.2029 esto deberia ser  para todos los casos, ya que
   || tenemos el problema de que si eres diario, y vas por el minimo, la base
   || de CP es de (30 * minimo). Pero si tienes varios tramos, es de (31 * min)
   || porque si no, no aplicaria bien los topes por tramos

   || de momento lo dejo asi que da miedito, pero de todos modos, lo suyo
   || es que este en todos los casos en que haya mas de un tramo, veremos febrero
                                   nBase = nBase - nNume;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || LA BASE EN IT
               || la base en IT, si el promedio (nBaseITCC y nBaseITATEP)
               || tienen el promedio (prom_enf y prom_acc) es menor que la
               || base minima porque me vienieran mal los topeo ya, para
               || despues multiplicar por los dias  de IT correctos

               |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC"; |O #nomcot02#27 = "CON";
               |O #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT"; |O #nomcot02#27 = "RIE";
                    nBaseMin = #nomconst#nCampoMin#;

                    |SI nConcepto [ 599;
                         |SI nBaseITCC < nBaseMin;
                              nBaseITCC = nBaseMin;
                              nBase = #nomcot02#22 * nBaseITCC;
                              prom_enf = nBaseITCC;
                              swCambiaProm = 1;
                         |FINSI;
                    |SINO;
                         |SI nBaseITATEP < nBaseMin;
                              nBaseITATEP = nBaseMin;
                              nBase = #nomcot02#22 * nBaseITATEP;
                              prom_acc = nBaseITATEP;
                              swCambiaProm = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || MINIMOS TIEMPO PARCIAL

     |SI #nomcot02#27 = "ETP";
     |Y #nomconst#0 ! 509;    || estos no, que aunque son TP, tienen los topes
                              || minimos por dias

          swCotizHoras = 1;   || para que la parte en alta, la topee a minimos
                              || como los casos de tiempo parcial, en caso de
                              || trabajadores a TC, con un ERE Parcial
     |FINSI;

     |SI swCotizHoras = 1; |Y swPluriempleo = 0;
          || MINIMOS

          |SI nCampoMin ! 0;
               || LA BASE EN ALTA
               nBaseMin = nHorasTramo * #nomconst#nCampoMin#;
               |SI nBase < nBaseMin;
                    nBase = nBaseMin;
               |FINSI;
               |SI #nomcot02#27 = "ASR";
                    nCoefTP = (tp ! 3)
                    nBase = (#nomcot02#22 * (#nomconst#nCampoMin# * nCoefTP)) ! 2;
                    |SI nConcepto ] 600;
                         swSigue = 0;
                         |SI #nomcot02#22 ] 31;
                              swSigue = 1;
                         |FINSI;
                         |SI nElMes = 2; |Y #nomcot02#22 = 28;
                              swSigue = 1;
                         |FINSI;
                         |SI swSigue = 1;
                              nBase = (30 * (#nomconst#nCampoMin# * nCoefTP)) ! 2;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || LA BASE EN IT
               || la base en IT, si el promedio (nBaseITCC y nBaseITATEP)
               || tienen el promedio (prom_enf y prom_acc) es menor que la
               || base minima porque me vienieran mal los topeo ya, para
               || despues multiplicar por los dias  de IT correctos

               |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC"; |O #nomcot02#27 = "CON";
               |O #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT"; |O #nomcot02#27 = "RIE";
                    nCoefTP = tp ! 3;
                    nBaseMin = #nomconst#nCampoMinDia#;
                    nBaseMin = (nBaseMin * nCoefTP) ! 2;
                    |SI nConcepto [ 599;
                         |SI nBaseITCC < nBaseMin;
                              nBaseITCC = nBaseMin;
                              nBase = #nomcot02#22 * nBaseITCC;
                              prom_enf = nBaseITCC;
                              swCambiaProm = 1;
                         |FINSI;
                    |SINO;
                         |SI nBaseITATEP < nBaseMin;
                              nBaseITATEP = nBaseMin;
                              nBase = #nomcot02#22 * nBaseITATEP;
                              prom_acc = nBaseITATEP;
                              swCambiaProm = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || para controlar que en ERE a TP, por culpa de los redondeos no
     || nos pasemos de la base maxima tiquet 1624.3015
     |HAZ MaximoERETP;
|FPRC;

|PROCESO VariacionPluri;
     |SI nConcepto = 701; |O nConcepto = 711;
          |SI #nompluri#3 ! #nompluri#4;
               #nomcot26#4 = "S";
          |FINSI;
     |FINSI;
     |SI nConcepto = 702; |O nConcepto = 712;
          |SI #nompluri#3 ! #nompluri#5;
               #nomcot26#4 = "S";
          |FINSI;
     |FINSI;
     |SI nConcepto = 703; |O nConcepto = 713;
          |SI #nompluri#3 ! #nompluri#6;
               #nomcot26#4 = "S";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AytoExcluido;
     |ABRE #nomnotan;
     #nomnotan#0 = #labtraba#0;
     #nomnotan#1 = #labtraba#77;
     |LEE 000#nomnotan.=;
     |SI FSalida = 0;
          nCuotaEmp = (nCuotaEmp - (nCuotaEmp % #nomnotan#2)) ! 2;
          nCuotaTra = (nCuotaTra - (nCuotaTra % #nomnotan#3)) ! 2;
          nCuotaTot = nCuotaEmp + nCuotaTra;
     |FINSI;
     |CIERRA #nomnotan;
|FPRC;

|PROCESO BaseCero;
     || frutas y hortalizas con base CERO en alta, asumo que son dias cotizables
     || que no se ha trabajado, lo resuelvo asi, para que coticen por el minimo

     |SI nConcepto ] 500; |Y nConcepto [ 599;
          |SI nBaseTramoCC = 0;
               nBaseTramoCC = 1;
          |FINSI;
     |SINO;
          |SI nBaseTramoCP = 0;
               nBaseTramoCP = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO nomcot24;
     nBase = 0;
     nTipoTra = 0;
     nCuotaTra = 0;
     nTipoEmp = 0;
     nCuotaEmp = 0;
     nCuotaTot = 0;
     #nomcot26#0 = #nomcot24#1;
     |LEE 000#nomcot26.=;
     |SI FSalida = 0;
          nConcepto = #nomcot26#0;
          |SI #nomconst#0 = 530;
               || ayuntamientos, solo cotiza IMS (611) y no IT (601)
               |SI nConcepto = 601;
                    |ACABA;
               |FINSI;
               |SI nConcepto = 611;
                    #nomcot26#4 = "S";
                    || tiene que ir al fichero de bases el 611
               |FINSI;
          |FINSI;
          |SI nConcepto = 531;          || contratos inferiores a 7 dias
               |SI #labtraba#112 ! "S";
                    |ACABA;
               |FINSI;
          |FINSI;

          || LA BASE
          |SI #nomcot02#27 = "ALT"; |O #nomcot02#27 = "HTP";
               |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
                    |HAZ BaseCero;
               |FINSI;
               |SI nConcepto ] 500; |Y nConcepto [ 599
                    |SI nConcepto ! 501; |Y nConcepto ! 502; |Y nConcepto ! 537;
                         nBase = nBaseTramoCC;
                    |SINO;
                         |SI #labtraba#42 ! "X"; |Y #labtraba#42 ! "T";
                              |SI nConcepto = 501;
                                   nBase = nBaseExt30Tramo;
                              |FINSI;
                              |SI nConcepto = 502;
                                   nBase = nBaseExt31Tramo;
                              |FINSI;
                         |SINO;
                              |SI nConcepto = 537;
                                   nBase = nBaseExt30Tramo + nBaseExt31Tramo;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    nBase = nBaseTramoCP;
               |FINSI;
          |SINO;
               |SI nConcepto [ 599;
                    nBase = #nomcot02#22 * nBaseITCC;
               |SINO;
                    nBase = #nomcot02#22 * nBaseITATEP;
               |FINSI;
               |SI swPluriempleo = 1;
                    || pluriemplo en IT, por aqui
                    |SI nConcepto [ 599;
                         nBase = #nomcot02#22 * nPromPluCC;
                    |SINO;
                         nBase = #nomcot02#22 * nPromPluDes;
                         |SI nConcepto = 701;
                              nBase = #nomcot02#22 * nPromPluDes;
                         |FINSI;
                         |SI nConcepto = 702;
                              nBase = #nomcot02#22 * nPromPluFog;
                         |FINSI;
                         |SI nConcepto = 703;
                              nBase = #nomcot02#22 * nPromPluFP;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          nBaseBon = nBase;
          |SI #nomcot26#5 = "-";
               nBase = 0;
          |FINSI;
          |SI nConcepto = 598; |O nConcepto = 698; |O nConcepto = 798;
          |O nConcepto = 998;
               nBase = 0;
          |FINSI;
          |SI #nomcot02#27 = "ETP";
               |SI swParteEnAltaERETP = 1;
                    |SI nConcepto = 536; |O nConcepto = 636; |O nConcepto = 637;
                    |O nConcepto = 596;
                    |O  nConcepto = 711; |O nConcepto = 712; |O nConcepto = 713;
                         || los conceptos de la parte de ERE a TP
                         nBase = 0;
                    |SINO;
                         nBase = 0;
                         |SI aSituacion = "ALT";
                              |SI nConcepto = 500; |O nConcepto = 594;
                                   nBase = nBaseTramoCC;
                              |SINO;
                                   |SI nConcepto = 601; |O nConcepto = 611;
                                   |O nConcepto = 701; |O nConcepto = 702; |O nConcepto = 703;
                                        nBase = nBaseTramoCP;
                                   |FINSI;
                                   |SI nConcepto = 603;
                                        nBase = 0;
                                   |FINSI;
                              |FINSI;
                         |SINO;
                              || ERE a TP, la parte que no es ERE
                              || en IT (ETP y ENF/ACC/MAT/PAT/CON/RIE)
                              |SI nConcepto = 500;
                                   |SI aSituacion = "ENF"; |O aSituacion = "ACC";
                                        nBase = nDiasTramo * nBaseITCC;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 509;
                                   |SI aSituacion = "MAT"; |O aSituacion = "PAT";
                                   |O aSituacion = "RIE"; |O aSituacion = "CON";
                                        nBase = nDiasTramo * nBaseITCC;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 601; |O nConcepto = 611;
                                   nBase = 0;
                              |FINSI;
                              |SI nConcepto = 603; |O nConcepto = 613;
                                   nBase = nDiasTramo * nBaseITATEP;
                              |FINSI;
                              |SI nConcepto = 701; |O nConcepto = 702; |O nConcepto = 703;
                                   |SI aSituacion = "ENF"; |O aSituacion = "ACC";
                                        nBase = nDiasTramo * nBaseITATEP;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 705; |O nConcepto = 706; |O nConcepto = 707;
                                   |SI aSituacion = "MAT"; |O aSituacion = "PAT";
                                   |O aSituacion = "RIE"; |O aSituacion = "CON";
                                        nBase = nDiasTramo * nBaseITATEP;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI nConcepto = 500;
                    |O nConcepto = 594;
                    |O nConcepto = 601; |O nConcepto = 603; |O nConcepto = 611;
                    |O nConcepto = 701; |O nConcepto = 702; |O nConcepto = 703;
                    |O nConcepto = 509;
                    |O nConcepto = 613;
                    |O  nConcepto = 705; |O nConcepto = 706; |O nConcepto = 707;
                         nBase = 0;
                    |FINSI;
               |FINSI;
          |FINSI;

          || MAXIMOS Y MINIMOS DE COTIZACION (TOPES)
          |SI nBase ! 0; |O #nomcot02#27 = "ASR";
               |SI nConcepto ! 501; |Y nConcepto ! 502;
               |Y nConcepto ! 537;
                    swTopes = 0;
                    |HAZ Topes;
               |FINSI;
          |FINSI;

          || EL TIPO DE COTIZACION (%)
          |SI #nomcot26#2 [ 255;
               nCampo = #nomcot26#2;
               |SI nCampo ! 0;
                    nTipoEmp = #nomconst#nCampo#;
               |FINSI;
               nCampo = #nomcot26#3;
               |SI nCampo ! 0;
                    nTipoTra = #nomconst#nCampo#;
               |FINSI;
          |SINO;
               nTipoTra = 0;
               |SI #nomcot26#2 = 601;
                    nTipoEmp = epig_ilt;
               |FINSI;
               |SI #nomcot26#2 = 611;
                    nTipoEmp = epig_ims;
               |FINSI;
          |FINSI;
          |SI #nomcot26#5 = "-"; |O swFormacion = 1;
               nTipoEmp = 0;
               nTipoTra = 0;
          |FINSI;
          |SI nConcepto = 537;
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
                    nTipoEmp = 0;
                    nTipoTra = 0;
               |FINSI;
          |FINSI;
          |SI swMayores65 = 1;
               |SI nConcepto ] 700; |Y nConcepto [ 799;
                    nTipoEmp = 0;
                    nTipoTra = 0;
               |FINSI;
          |FINSI;
          |SI nConcepto = 594; |O nConcepto = 596;
               |SI nTipoEmp = 0; |Y nTipoTra = 0;
                    nBase = 0;
               |FINSI;
          |FINSI;
          |SI nConcepto = 598; |O nConcepto = 698; |O nConcepto = 798;
          |O nConcepto = 998;
               nTipoEmp = 0;
               nTipoTra = 0;
          |FINSI;

          || LAS CUOTAS
          |SI nConcepto = 598; |O nConcepto = 698; |O nConcepto = 798;
          |O nConcepto = 998;
               |SI nConcepto = 598; |O nConcepto = 698; |O nConcepto = 798;
                    nCuotaTot = nAcumCuotaTot;
                    nCuotaEmp = nAcumCuotaEmp;
                    nCuotaTra = nAcumCuotaTra;

                    nAcumCuotaTra = 0; nAcumCuotaEmp = 0; nAcumCuotaTot = 0;
               |FINSI;
               |SI nConcepto = 998;
                    nCuotaTot = nTotalCuotaTot;
                    nCuotaEmp = nTotalCuotaEmp;
                    nCuotaTra = nTotalCuotaTra;
               |FINSI;
          |SINO;
               |SI swFormacion = 0;
                    nCuotaTot = (nBase % (nTipoEmp + nTipoTra)) ! 2;
                    nCuotaTra = (nBase % nTipoTra) ! 2;
                    nCuotaEmp = nCuotaTot - nCuotaTra;
                    |SI nConcepto = 531;
                         nBase = nCuotaEmp;
                         |SI nElAny [ 2018;
                              nTipoEmp = 36;
                         |SINO;
                              nTipoEmp = 40;
                         |FINSI;
                         nCuotaEmp = nCuotaEmp % nTipoEmp;
                         nCuotaEmp = nCuotaEmp ! 2;
                         nCuotaTra = 0;
                         nCuotaTot = nCuotaEmp;
                    |FINSI;
                    |SI nConcepto [ 590;
                         |HAZ AytoExcluido;
                    |FINSI;
               |SINO;
                    || formacion
                    |SI nConcepto = 531; |O nConcepto = 594;
                         nBase = 0;
                    |FINSI;
                    |SI swCuotasFor = 0;
                    |O swCuotasFor = 2;      || solo parte del trabajador
                         |SI nConcepto ] 700; |Y nConcepto [ 799;
                         |Y #labtraba#45 = 422;
                              nCuotaEmp = 0;
                              nCuotaTra = 0;
                              nCuotaTot = 0;
                         |SINO;
                              nCampo = #nomcot26#7;
                              |SI nCampo ! 0;
                                   nCuotaTra = #nomconst#nCampo#;
                              |FINSI;
                              nCampo = #nomcot26#6;
                              |SI nCampo ! 0;
                                   nCuotaEmp = #nomconst#nCampo#;
                                   |SI nCampo = 90; |Y #labtraba#190 = "N";
                                        nCuotaEmp = 0;
                                   |FINSI;
                                   |SI nCampo = 84;
                                        |SI nConcepto = 702;
                                        |O nConcepto = 706;
                                             |SI nElAny = 2017;
                                                  nCuotaEmp = nCuotaEmp - 1.24;
                                             |FINSI;
                                             |SI nElAny = 2018;
                                                  nCuotaEmp = nCuotaEmp - 1.28;
                                             |FINSI;
                                        |FINSI;
                                        |SI nConcepto = 703;
                                        |O nConcepto = 707;
                                             |SI nElAny = 2017;
                                                  nCuotaEmp = nCuotaEmp - 2.53;
                                             |FINSI;
                                             |SI nElAny = 2018;
                                                  nCuotaEmp = nCuotaEmp - 2.64;
                                             |FINSI;
                                             |SI nElAny ] 2019;
                                                  nCuotaEmp = 0;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                              |SI nConcepto = 701;
                                   |SI #labtraba#190 = "N";
                                        nCuotaEmp = 0;
                                        nCuotaTra = 0;
                                   |FINSI;
                              |FINSI;
                              |SI swCuotasFor = 2;
                                   nCuotaEmp = 0;
                              |FINSI;
                              nCuotaTot = nCuotaTra + nCuotaEmp;
                         |FINSI;
                    |SINO;
                         nCuotaTra = 0;
                         nCuotaEmp = 0;
                         nCuotaTot = 0;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI #nomcot26#5 = "-";
               nCuotaTot = 0;
               nCuotaTra = 0;
               nCuotaEmp = 0;
               nTipoTra = 0;
               nTipoEmp = 0;
               |HAZ Deducciones;
          |FINSI;

          |SI nConcepto ! 598; |Y nConcepto ! 698; |Y nConcepto ! 798;
               || acumulamos totales para conceptos que no sean totales

               |SI #nomcot26#5 = "-";
                    nCuotaTra = nCuotaTra * (-1);
                    nCuotaEmp = nCuotaEmp * (-1);
                    nCuotaTot = nCuotaTot * (-1);
               |FINSI;

               nAcumCuotaTot = nAcumCuotaTot + nCuotaTot;
               nAcumCuotaTra = nAcumCuotaTra + nCuotaTra;
               nAcumCuotaEmp = nAcumCuotaEmp + nCuotaEmp;

               nTotalCuotaTot = nTotalCuotaTot + nCuotaTot;
               nTotalCuotaTra = nTotalCuotaTra + nCuotaTra;
               nTotalCuotaEmp = nTotalCuotaEmp + nCuotaEmp;

               || lo vuelvo a poner positivo, para que se grabe positivo
               |SI #nomcot26#5 = "-";
                    nCuotaTra = nCuotaTra * (-1);
                    nCuotaEmp = nCuotaEmp * (-1);
                    nCuotaTot = nCuotaTot * (-1);
               |FINSI;
          |FINSI;
     |FINSI;

     swGraba = 0;
     |SI nConcepto = 598; |O nConcepto = 698; |O nConcepto = 798;
     |O nConcepto = 998;
          || totales
          |SI nCuotaTot ! 0;
               swGraba = 1;
          |SINO;
               |SI nCuotaEmp ! 0; |O nCuotaTra ! 0;
                    swGraba = 1;
                    || se ha dado el caso, aunque sea cero porque se anula una con otra
                    || datos Serna, mes 03/2020, trab 1179.21
               |FINSI;
          |FINSI;
          |SI nConcepto = 998;
               swGraba = 1;
          |FINSI;
     |FINSI;
     |SI nBase ! 0;
          || normales, con base
          swGraba = 1;
     |FINSI;
     |SI nBase = 0; |Y #nomcot26#5 = "-"; |Y nCuotaTot ! 0;
          || deducciones, sin base pero con cuota
          swGraba = 1;
     |FINSI;
     |SI nBase = 0; |Y swFormacion = 1; |Y nCuotaTot ! 0;
          || formacion, sin base pero con cuota
          swGraba = 1;
     |FINSI;
     |SI swGraba = 1;
          |HAZ GrabaConcepto;
          |SI swPluriempleo = 1;
               |HAZ VariacionPluri;
          |FINSI;
          |SI #labtraba#247 = 0112;
               || peculiaridades artistas
               |SI nConcepto = 500;
                    nConcepto = 300;
               |FINSI;
               |SI nConcepto ] 599;
                    |SI nConcepto ! 603;
                         || pago directo en IT
                         #nomcot26#4 = "N";
                    |FINSI;
                    |SI nConcepto = 705;
                         || pago directo en IT
                         #nomcot26#4 = "S";
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #nomcot26#4 = "S";
               |SI #nomcot02#27 ! "ASR";
                    || alta sin retribucion no tiene que tener base en los tramos
                    |HAZ ActualizaBase;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomcot24;
     #nomcot24#1;
     ;
     #nomcot23#0, 001;
     #nomcot23#0, 999;
     ;
     NULL, nomcot24;
|FIN;

|PROCESO HorasFormacion;
     |SI swFormacion = 1;
          |SI #nomcot02#27 = "ALT";
               |SI horasex ! 0;
                    |SI #nomcot02#6 = nUltimoTramoAlta;
                         nHorasForTra = horasex - nHorasFTAcum;
                    |SINO;
                         nHorasForTra = horasex * (#nomcot02#22 / nDiasALT);
                         nHorasForTra = (nHorasForTra - 0.49) ! 0;
                         nHorasFTAcum = nHorasFTAcum + nHorasForTra;
                    |FINSI;
               |FINSI;
               |SI nHorasTut ! 0;
                    |SI #nomcot02#6 = nUltimoTramoAlta;
                         nHorasTutTra = nHorasTut - nHorasTTAcum;
                    |SINO;
                         nHorasTutTra = nHorasTut * (#nomcot02#22 / nDiasALT);
                         nHorasTutTra = (nHorasTutTra - 0.49) ! 0;
                         nHorasTTAcum = nHorasTTAcum + nHorasTutTra;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO HorasComp;
     |SI #nomcot02#27 = "ALT";
          |SI #nomcot02#6 = nUltimoTramoAlta;
               nHorasExtraTra = nNroHorasExtra - nHorasExtraAcum;
          |SINO;
               nHorasExtraTra = nNroHorasExtra * (#nomcot02#22 / nDiasALT);
               nHorasExtraTra = (nHorasExtraTra - 0.49) ! 0;
               nHorasExtraAcum = nHorasExtraAcum + nHorasExtraTra;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaHoras;
     || horas de trabajadores a TP cotizables
     |SI #nomcot02#27 = "ETP";     || ere a TP
     |Y #nomcot02#88 ! 0;          || tiene que ser asi, es el porcentaje TP
     |Y swParteEnAltaERETP = 1;    || solo aqui, para que sea solo en la
                                   || pasada de la parte de ALTA (podia ser
                                   || la otra, daba igual)
          |ACABA;
     |FINSI;

     |SI #nomcot02#24 ! 0;
          nCodigoHoras = 01;
          nHoras = #nomcot02#24;
          |HAZ ActualizaHoras;
     |FINSI;

     || horas formativas bonificadas de trabajadores en formacion
     |SI nHorasExtraTra ! 0;
          nCodigoHoras = 02;
          nHoras = nHorasExtraTra;
          |HAZ ActualizaHoras;
     |FINSI;

     || horas formativas bonificadas de trabajadores en formacion
     |SI nHorasForTra ! 0;
          |SI nImporteHoraFor = 8;
               nCodigoHoras = 03;
          |SINO;
               nCodigoHoras = 04;
          |FINSI;
          nHoras = nHorasForTra;
          |HAZ ActualizaHoras;
     |FINSI;

     || horas tutorias bonificadas de trabajadores en formacion y cont. 422
     |SI nHorasTutTra ! 0;
          nCodigoHoras = 06;
          nHoras = nHorasTutTra;
          |HAZ ActualizaHoras;
          nConcepto = 737;
          nBase = nHorasTutTra * (nBonifTut / nHorasTut);
          |HAZ ActualizaBase;
     |FINSI;

     || porcentaje de ERE a TP
     |SI #nomcot02#88 ! 0;
          nCodigoHoras = 05;
          nHoras = #nomcot02#88;
          nHoras = nHoras ! 2;
          |HAZ ActualizaHoras;
     |FINSI;
|FPRC;

|PROCESO ITnomvarca;
     |PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
          |SI #nomvarca#nCampo# ! " ";
               nLineaIT = nCampo - 11;
               nCampo2 = nCampo - 8;
               nNume = #nomvarca#nCampo2#;
               |SI nNume = 0;
                    fFecha = #nomcot02#70;
                    aAlfa = fFecha;
                    aAlfa = aAlfa % 102;
                    nDesdeDia = aAlfa;
               |SINO;
                    nDesdeDia = nNume;
               |FINSI;

               nCampo2 = nCampo - 4;
               nNume = #nomvarca#nCampo2#;
               |SI nNume = 0;
                    fFecha = #nomcot02#71;
                    aAlfa = fFecha;
                    aAlfa = aAlfa % 102;
                    nHastaDia = aAlfa;
               |SINO;
                    nHastaDia = nNume;
               |FINSI;

               |SI #nomcot02#20 ] nDesdeDia; |Y #nomcot02#21 [ nHastaDia;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO BuscaBase;
     || primero historico
     |ABRE #nomhicca;
     #nomhicca#0 = nEmp;
     #nomhicca#1 = nTra;
     #nomhicca#66 = nAnyBusca - 2000;
     #nomhicca#2 = nMesBusca;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          || primero cojo los dias cotizables del historico
          |SI #labtraba#42 = "X";
               || mal, pero de momento paso
               |SI #nomhicca#7 = 31; |Y #nomhicca#8 = 30;
                    nDiasPlu = nDiasPlu + #nomhicca#7;
               |SINO;
                    |SI #nomhicca#7 = 28; |Y #nomhicca#8 = 30;
                         nDiasPlu = nDiasPlu + #nomhicca#7;
                    |SINO;
                         |SI #nomhicca#7 = 29; |Y #nomhicca#8 = 30;
                              nDiasPlu = nDiasPlu + #nomhicca#7;
                         |SINO;
                              nDiasPlu = nDiasPlu + #nomhicca#8;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               nDiasPlu = nDiasPlu + #nomhicca#8;
          |FINSI;
     |FINSI;

     || si el mes que anterior a la IT ya estaba de pluriempleo
     || busco en donde me guardo las bases para el pluriempleo

     |ABRE #nompluba;
     #nompluba#0 = nEmp;
     #nompluba#1 = nTra;
     #nompluba#2 = nAnyBusca;
     #nompluba#3 = nMesBusca;
     #nompluba#4 = 0;
     |LEE 000#nompluba.=;
     |SI FSalida = 0;
          || tal cual
          nBasePluCC = nBasePluCC + #nompluba#5;
          nBasePluCP = nBasePluCP + #nompluba#6;
          nBasePluDes = nBasePluDes + #nompluba#6;
          nBasePluFog = nBasePluFog + #nompluba#7;
          nBasePluFP = nBasePluFP + #nompluba#8;
     |SINO;
          || si no, al historico claro
          nNume = #nomhicca#39;
          nNume = nNume + #nomhicca#159 + #nomhicca#172 + #nomhicca#174;
          nBasePluCC = nBasePluCC + nNume;
          nNume = #nomhicca#40;
          nNume = nNume + #nomhicca#159 + #nomhicca#172 + #nomhicca#174;
          nBasePluCP = nBasePluCP + nNume;

          nBasePluDes = nBasePluCP;
          nBasePluFog = nBasePluCP;
          nBasePluFP = nBasePluCP;
     |FINSI;

     |CIERRA #nompluba;
|FPRC;

|PROCESO BasesPluriIT;
     || bases para pluriempleo
     || ahora vamos a intentar calcular las bases para el pluriempleo
     || en IT
     || en pluriempleo, las bases pueden ser diferentes para cada una de
     || las partidas, por lo que en principio, al promedio no le puedo
     || hacer mucho caso, volvemos a calcularlo a partir del mes anterior
     || al que comenzo la IT

     |SI #labtraba#89 ! 0; |O #labtraba#92 ! 0;
          || una IT que viene de un mes anterior
          aAlfa = #labtraba#125;
          |QBF aAlfa;
          |SI aAlfa ! "";
               aAlfa1 = aAlfa % 402; nMesIniIT = aAlfa1;
               aAlfa2 = aAlfa % -104; nAnyIniIT = aAlfa2;
          |SINO;
               || sin fecha de inicio de la IT ... habria que controlarlo
          |FINSI;
     |SINO;
          || comienza este mes
          nMesIniIT = nElMes;
          nAnyIniIT = nElAny;
     |FINSI;
     nMesBase = nMesIniIT - 1;
     |SI nMesBase = 0;
          nMesBase = 12;
          nAnyBase = nAnyIniIT - 1;
     |SINO;
          nAnyBase = nAnyIniIT;
     |FINSI;

     || ya tengo el periodo del que tengo que buscar la base, ahora la busco

     nVez = 1;
     |SI #labtraba#42 = "X";
          || tiempo parcial, tres meses a partir de este inclusive
          |PARA nMesBusca = nMesBase; |SI nVez [ 3;
          |HACIENDO nMesBusca = nMesBusca - 1;
               nAnyBusca = nAnyBase;
               |SI nMesBusca = 0;
                    nMesBusca = 12;
                    nAnyBusca = nAnyBase - 1;
               |FINSI;
               |HAZ BuscaBase;
               nVez = nVez + 1;
          |SIGUE;
     |SINO;
          nMesBusca = nMesBase;
          nAnyBusca = nAnyBase;
          |HAZ BuscaBase;
          || tiempo completo, este mismo mes
     |FINSI;

     nPromPluCC = (nBasePluCC / nDiasPlu) ! 2;
     nPromPluCP = (nBasePluCP / nDiasPlu) ! 2;
     nPromPluDes = (nBasePluDes / nDiasPlu) ! 2;
     nPromPluFog = (nBasePluFog / nDiasPlu) ! 2;
     nPromPluFP = (nBasePluFP / nDiasPlu) ! 2;

     |SI nPromPluCC = 0;
          nPromPluCC = prom_enf;
     |FINSI;
     |SI nPromPluCP = 0;
          nPromPluCP = prom_acc + prom_ac2;
     |FINSI;

     || cuidado con esto, si molesta quitarlo, es por si el promedio estuviera
     || forzado
     |SI nPromPluCC < prom_enf;
          nPromPluCC = prom_enf;
     |FINSI;
     |SI nPromPluCP < prom_acc;
          nPromPluCP = prom_acc;
          nPromPluDes = nPromPluCP;
          nPromPluFog = nPromPluCP;
          nPromPluFP = nPromPluCP;
     |FINSI;

     |SI nPromPluDes = 0;
          |SI #nompluri#3 ! #nompluri#4;
               nPromPluDes = nPromPluCP;
          |SINO;
               nPromPluDes = nPromPluCC;
          |FINSI;
     |FINSI;
     |SI nPromPluFog = 0;
          |SI #nompluri#3 ! #nompluri#5;
               nPromPluFog = nPromPluCP;
          |SINO;
               nPromPluFog = nPromPluCC;
          |FINSI;
     |FINSI;
     |SI nPromPluDes = 0;
          |SI #nompluri#3 ! #nompluri#6;
               nPromPluDes = nPromPluCP;
          |SINO;
               nPromPluDes = nPromPluCC;
          |FINSI;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO CotizTramos;
     aSituacion = #nomcot02#27;
     nDiasTramo = #nomcot02#22;
     swParteEnAltaERETP = 0;

     || si se trata de la parte en ALT
     || lo primero es sacar la proporcion de base de este tramo

     |ET CotiCoti;

     |SI swParteEnAltaERETP = 1;
          aSituacion = #nomcot02#98;
          |SI aSituacion = "ALT";
               || porque si la parte en alta del ERE a TP estoy en IT
               || no proporciono dias, proporciono despues la base
               nDiasTramo = (nDiasTramo * ((100 - #nomcot02#88) / 100)) ! 2;
          |FINSI;
     |FINSI;
     |SI aSituacion = "ALT"; |O aSituacion = "HTP";
          |SI aSituacion = "HTP";
               || la parte en alta de la huelga
               nDiasTramo = (nDiasTramo * ((100 - #nomcot02#87) / 100)) ! 2;
          |FINSI;

          || hay que distinguir la base de tramos de CC y de CP en alta
          || ya que si hay horas extras, la base de estas hay que sumarla
          || a la base CP
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
               enImpRemCC = enImpRem + enImpExt30 + enImpExt31 - nRecortaCC;
          |SINO;
               enImpRemCC = enImpRem - nRecortaCC;
          |FINSI;
          nBaseTramoCC = enImpRemCC * (nDiasTramo / nDiasALT);
          nBaseTramoCC = nBaseTramoCC ! 2;
          nBaseAcumCC = nBaseAcumCC + nBaseTramoCC;
          nDiferencia = nBaseAcumCC - enImpRemCC;
          |SI -0.05 [ nDiferencia; |Y nDiferencia [ 0.05;
               nBaseTramoCC = nBaseTramoCC - nDiferencia;
          |FINSI;

          enImpRemCP = enImpRem + enImpExt30 + enImpExt31;
          nBaseTramoCP = enImpRemCP * (nDiasTramo / nDiasALT);
          nBaseTramoCP = nBaseTramoCP ! 2;
          nBaseAcumCP = nBaseAcumCP + nBaseTramoCP;
          nDiferencia = nBaseAcumCP - enImpRemCP;
          |SI -0.05 [ nDiferencia; |Y nDiferencia [ 0.05;
               nBaseTramoCP = nBaseTramoCP - nDiferencia;
          |FINSI;

          nBaseExt30Tramo = enImpExt30 * (nDiasTramo / nDiasALT);
          nBaseExt30Tramo = nBaseExt30Tramo ! 2;
          nBaseAcumExt30 = nBaseAcumExt30 + nBaseExt30Tramo;
          nDiferencia = nBaseAcumExt30 - enImpExt30;
          |SI -0.05 [ nDiferencia; |Y nDiferencia [ 0.05;
               nBaseExt30Tramo = nBaseExt30Tramo - nDiferencia;
          |FINSI;

          nBaseExt31Tramo = enImpExt31 * (nDiasTramo / nDiasALT);
          nBaseExt31Tramo = nBaseExt31Tramo ! 2;
          nBaseAcumExt31 = nBaseAcumExt31 + nBaseExt31Tramo;
          nDiferencia = nBaseAcumExt31 - enImpExt31;
          |SI -0.05 [ nDiferencia; |Y nDiferencia [ 0.05;
               nBaseExt31Tramo = nBaseExt31Tramo - nDiferencia;
          |FINSI;
     |SINO;
          || si es una IT, la base la saco despues multiplicando dias por promedio
          || BASE EN IT

          prom_enf = prom_enf ! 2;
          prom_acc = prom_acc ! 2;

          nBaseITCC = prom_enf;
          nBaseITATEP = prom_acc + (prom_ac2 ! 2);

          |SI swParteEnAltaERETP = 1; |Y #nomcot02#27 = "ETP";
               |SI #nomcot02#98 = "ACC"; |O #nomcot02#98 = "CON";
               |O #nomcot02#98 = "ENF"; |O #nomcot02#98 = "MAT";
               |O #nomcot02#98 = "PAT"; |O #nomcot02#98 = "RIE";
               |O #nomcot02#98 = "MTP"; |O #nomcot02#98 = "PTP";
                    |SI #nomcot02#100 ! 0;
                         nBaseITCC = nBaseITCC * (#nomcot02#100 / 100);
                         nBaseITATEP = nBaseITATEP * (#nomcot02#100 / 100);
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI aSituacion = "ASR";
               nBaseITCC = 0;
               nBaseITATEP = 0;
          |FINSI;

          |SI aSituacion = "ERE"; |O aSituacion = "ETP";
               nBaseDes = #labtraba#242;
               |SI nBaseDes2 ! 0;
                    |HAZ ITnomvarca;
                    |SI nLineaIT ] 2;
                         nBaseDes = nBaseDes2;
                         |SI nUniDes2 ! 0;
                              || si tengo unidades, indican el dia que empieza
                              || el "segundo" ERE
                              |SI nDesdeDia ] nUniDes2;
                                   nBaseDes = nBaseDes2;    || confirmo
                              |SINO;
                                   nBaseDes = #labtraba#242; || vuelvo al prom. original
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
               nBaseITCC = nBaseDes ! 2;
               nBaseITATEP = nBaseDes ! 2;
               |SI aSituacion = "ETP";
                    nBaseITCC = nBaseITCC * (#nomcot02#88 / 100);
                    nBaseITATEP = nBaseITATEP * (#nomcot02#88 / 100);
               |FINSI;
          |FINSI;

          |SI nBaseIT2 ! 0;
               |HAZ ITnomvarca;
               |SI nLineaIT ] 2;
                    nBaseITCC = nBaseIT2;
                    nBaseITATEP = nBaseIT2;
               |FINSI;
          |FINSI;


          || ojo, recalculo de bases en pluriempleo en IT

          nBasePluCC = 0; nPromPluCC = 0;
          nBasePluCP = 0; nPromPluCP = 0;
          nBasePluDes = 0; nPromPluDes = 0;
          nBasePluFog = 0; nPromPluFog = 0;
          nBasePluFP = 0; nPromPluFP = 0;
          nDiasPlu = 0;

          |SI swPluriempleo = 1;
               |HAZ BasesPluriIT;
               |SI aSituacion = "ERE"; |O aSituacion = "ETP";
                    || paso de eso, me quedo con mi base de la cuarta pantalla
                    || del trabajador, en ERE o ETP
                    nPromPluCC = nBaseITCC;
                    nPromPluCP = nBaseITATEP;
                    nPromPluDes = nBaseITATEP;
                    nPromPluFog = nBaseITATEP;
                    nPromPluFP = nBaseITATEP;
               |FINSI;
          |FINSI;
     |FINSI;

     || Para los de Formacion, he de saber si tiene horas o no, para saber
     || si el tramo hay que pintarlo
     || solo se pintan los tramos CON horas, y las cuotas solo se aplican
     || en el primer tramo

     nHorasForTra = 0;
     nHorasTutTra = 0;
     nHorasExtraTra = 0;

     |HAZ HorasFormacion;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
     |O #labtraba#42 = "I"; |O #labtraba#42 = "P";
          |SI nNroHorasExtra ! 0;
               |HAZ HorasComp;
          |FINSI;
     |FINSI;

     || aqui por fin, segun la situacion y el tipo de cotizacion, recorro
     || los conceptos grabandolos
     #nomcot25#0 = #nomcot02#27;
     #nomcot25#4 = #nomcot02#89;
     |LEE 000#nomcot25.=;
     |SI FSalida = 0;
          #nomcot23#0 = #nomcot25#2;
          |LEE 000#nomcot23.=;
          |SI FSalida = 0;
               nAcumCuotaTra = 0; nAcumCuotaEmp = 0; nAcumCuotaTot = 0;
               nTotalCuotaTra = 0; nTotalCuotaEmp = 0; nTotalCuotaTot = 0;

               |BUCLE nomcot24;
          |FINSI;

          |SI swFormacion = 1;
          /*
               |SI nHorasForTra ! 0; |O nHorasTutTra ! 0;
                    |SI swCuotasFor = 0
                         || es el primer tramo en que he grabado ya las
                         || cuotas de formacion, ya no tengo que grabarlas
                         || mas para este trabajador

                         swCuotasFor = 1;
                    |FINSI;
               |FINSI;
          */
               || ojo, lo hacia solo si tenia horas, pero tiene que ser en
               || cualquier situacion en la que haya mas de un tramo, la cuota
               || solo en uno de ellos

               |SI swCuotasFor = 0;
                    swCuotasFor = 1;
                    |SI #nomcot02#27 = "ENF"; |O #nomcot02#27 = "ACC";
                         |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
                              || otro caso, IT sin carencia, ojo que en este
                              || tramo cargo las cuotas y bonif, pero no por
                              || la parte del trabajador, con el swCuotasFor
                              || a 2, indico que si hay otro tramo, tiene que
                              || aparecer la cotizacion del trabajador
                              swCuotasFor = 2;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || aqui grabo los campos de HORAS
     |HAZ GrabaHoras;

     |SI aSituacion = "ETP";
          |SI swParteEnAltaERETP = 0;
               swParteEnAltaERETP = 1;
               |VETE CotiCoti;     || la primera vez que lo uso en mi vida,
                                   || pero para el caso que es, no se me ocurre
                                   || nada mas util 06.02.2018
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CotizTramos;
     #nomcot02#3;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 01;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 31;
     be;
     NULL, CotizTramos;
|FIN;

|PROCESO BuscaTramosFor;
     |SI #nomcot02#73 = 421;
     |Y #nomcot02#94 = 1;
     |Y #labtraba#1 ! #nomcot02#7;

          || tengo otro tramo de otro trabajador que esta en situacion de ALTA
          || y ha cotizado este mes, no tengo que llevar otra vez las cuotas
          || solo las horas de est tramo

          swCuotasFor = 1;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTramosFor;
     #nomcot02#1;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, 00001;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, 99999;
     ;
     NULL, BuscaTramosFor;
|FIN;

|PROCESO BasePrevia;
     |SI #nomcot03#10 = 500; |O #nomcot03#10 = 509;
           nBasePreviaCC = nBasePreviaCC + #nomcot03#12;
     |FINSI;
     |SI #nomcot03#10 = 601; |O #nomcot03#10 = 603;
           nBasePreviaCP = nBasePreviaCP + #nomcot03#12;
     |FINSI;
     |SI #nomcot03#10 = 998;
          fFecha = #nomcot03#8; nNume1 = fFecha;
          fFecha = #nomcot03#9; nNume2 = fFecha;
          nNume = nNume2 - nNume1 + 1;
          nDiasContados = nDiasContados + nNume;
     |FINSI;
|FPRC;

|DEFBUCLE BasePrevia;
     #nomcot03#1;
     ;
     || nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 1, #labtraba#1, 000;
     || nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 99, #labtraba#1, 999;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 1, 00001, 000;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 99, 99999, 999;
     be;
     NULL, BasePrevia;
|FIN;

|PROCESO Jubilacion;
     |SI #labtraba#135 = "S";
          nPropJub = 50 + ((nElAny - 2013) * 5)
          nNume1 = enImpRem - nImporteComp;
          nNume1 = nNume1 / tp;
          nNume1 = nNume1 + nImporteComp;
          nNume1 = nNume1 % nPropJub;

          || hasta ahi seria el importe de la base (la remuneracion)
          || ahora a ver si esta por debajo del tope

          nNume1 = nNume1 + base_5; || sumo la base de IT (la que saliera por
                                    || el calculo antiguo, ahi va todo
          nNume2 = #labtraba#220 % nPropJub;
          nNume2 = nNume2 * dcofi_2; || nNume2 es lo minimo que habria que cotizar

          |SI nNume1 < nNume2;
               nNume1 = nNume2;
          |FINSI;
          nNume1 = nNume1 - base_5;

          enImpRem = nNume1;
     |FINSI;
|FPRC;

|PROCESO UltFicha;
     nNroTramos = nNroTramos + 1;
     nUltimaFicha = #nomcot02#7;
     |SI #nomcot02#27 = "ALT";
          || el ultimo tramo en alta de todos los codigos que intervienen
          || para el tema de los minimos CP en diarios
          nUltimoTramo = #nomcot02#6;
     |SINO;
          nUltimoTramoIT = #nomcot02#6;
     |FINSI;
|FPRC;

|DEFBUCLE UltFicha;
     #nomcot02#1;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 01, 00001;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, 31, 99999;
     ;
     NULL, UltFicha;
|FIN;

|PROCESO DiasALT;
     |SI #nomcot02#27 = "ALT"; |O #nomcot02#27 = "HTP";
          || el ultimo tramo en alta del codigo que se esta calculando
          |SI #nomcot02#27 = "ALT";
               nDiasALT = nDiasALT + #nomcot02#22;
               nUltimoTramoAlta = #nomcot02#6;
          |FINSI;
          |SI #nomcot02#27 = "HTP";
               nDiasALT = nDiasALT + (#nomcot02#22 % (100 - #nomcot02#87));
          |FINSI;
     |SINO;
          |SI #nomcot02#27 = "ACC"; |O #nomcot02#27 = "CON"; |O #nomcot02#27 = "ENF";
          |O #nomcot02#27 = "MAT"; |O #nomcot02#27 = "PAT"; |O #nomcot02#27 = "RIE";
          |O #nomcot02#27 = "MTP"; |O #nomcot02#27 = "PTP";
               nDiasIT = nDiasIT + #nomcot02#22;
          |FINSI;
          |SI #nomcot02#27 = "ETP";
               nNume = (#nomcot02#22 * ((100 - #nomcot02#88) / 100)) ! 2;
               |SI #nomcot02#98 = "ACC"; |O #nomcot02#98 = "CON"; |O #nomcot02#98 = "ENF";
               |O #nomcot02#98 = "MAT"; |O #nomcot02#98 = "PAT"; |O #nomcot02#98 = "RIE";
               |O #nomcot02#98 = "MTP"; |O #nomcot02#98 = "PTP";
                    nDiasIT = nDiasIT + #nomcot02#22;
               |SINO;
                    nDiasALT = nDiasALT + nNume;
               |FINSI;
          |FINSI;
     |FINSI;
     nDiasCotMes = #nomcot02#95;
     nDiasNatMes = #nomcot02#96;
|FPRC;

|DEFBUCLE DiasALT;
     #nomcot02#3;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 01;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 31;
     ;
     NULL, DiasALT;
|FIN;

|PROCESO Mayores65;
     |SI #labtraba#39 ! 0;
          #nombonif#0 = #labtraba#39;
          |LEE 000#nombonif.=;
          |SI FSalida = 0;
               |SI #nombonif#10 = 4;
                    swMayores65 = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Pluriempleo;
     |ABRE #nompluri;
     #nompluri#0 = #labtraba#0;
     #nompluri#1 = #labtraba#1;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          swPluriempleo = 1;
     |FINSI;
     |CIERRA #nompluri;
|FPRC;

|PROCESO Calculos;
     nBaseAcumCC = 0;
     nBaseAcumCP = 0;
     nBaseAcumExt30 = 0;
     nBaseAcumExt31 = 0;
     nHorasFTAcum = 0;
     nHorasTTAcum = 0;
     nHorasExtraAcum = 0;
     swFormacion = 0;
     swCuotasFor = 0
     swCotizHoras = 0;

     nTotFijBonif = 0;
     nTotExeBonif = 0;
     nExeBonifDias = 0;
     nExeBonifBase = 0;
     nTotDiasBon = 0;
     nTotBonFom = 0;
     aAntTramoBon = "";
     nTramoBon = 0;

     || nBaseITCC = prom_enf;
     || nBaseITATEP = prom_acc;

     || marco formacion y tiempos parciales
     swFormacion = 0;
     |SI #labtraba#45 = 421; |O #labtraba#45 = 422;
          swFormacion = 1;

          |BUCLE BuscaTramosFor;

          || si encuentro otro tramo en alta de otro trabajador de formacion
          || supongo que ya he cotizado las cuotas en ese trabajador
     |FINSI;

     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
     |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
          swCotizHoras = 1;
     |FINSI;
     |SI #labtraba#45 ] 300; |Y #labtraba#45 [ 399;
          swCotizHoras = 1;
     |FINSI;

     || previo, para saber los dias cotizables en alta y para saber cual es
     || el ultimo tramo en situacion ALT

     nDiasALT = 0;
     nDiasIT = 0;
     nUltimoTramoAlta = 0;
     nDiasCotMes = 0;
     nDiasNatMes = 0;
     |BUCLE DiasALT;

     || asi se que nUltTramo es el ultimo tramo que estoy en alta, donde
     || hare el ajuste si tengo que hacerlo de lo de los minimos en diarios

     nUltimaFicha = 0;
     nUltimoTramo = 0;
     nUltimoTramoIT = 0;
     nNroTramos = 0;
     |BUCLE UltFicha;

     || este proceso previo es necesario para los trabajadores diarios que
     || estan de alta 31 dias o 28 0 29 dias en febrero

     nRecortaCC = 0;
     nRecortaCPMax = 0;
     nRecortaCPMin = 0;

     swSigue = 0;
     |SI #labtraba#42 = "D";
          swSigue = 1;
     |FINSI;
     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          |SI #labtraba#33 ] 8;
               swSigue = 1;
          |FINSI;
     |FINSI;

     nAny = nElAny;
     nMes = nElMes;
     |HAZ topemes_plb;
     |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5;
     |O nElMes = 7;  |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
          swSigue = swSigue + 1;
     |FINSI;

     |SI swSigue = 2;
          || diarios, mes que no es de 30 dias
          || lo primero es saber de momento cuanta base llevo
          || tengo que comprobar si el total esta limitado por maximos o minimos
          || asi que sumo la remuneracion de la ficha actual a lo que ya
          || llevara acumulado
          nBasePreviaCC = 0;
          nBasePreviaCP = 0;
          nDiasContados = 0;
          |BUCLE BasePrevia;
          nNume = nDiasContados + nDiasALT;

          |SI nDiasCotMes = nDiasNatMes; |Y nDiasCotMes = nTopemes;
          |Y nNume = nTopemes;
               || todo el mes trabajado, mes natural de 31 dias
               || tengo que comprobar que no supere el tope general de bases
               || de cotizacion, que por cierto es 30 por el maximo de CC

               || todo esto sera para tenerse en cuenta despues, solo cuando
               || este en el ultimo tramo

               nBase = enImpRem + (nDiasIT * prom_enf) + nBasePreviaCC;
               nTope = 30 * #nomconst#36;
               |SI nBase > nTope;
                    nNume = nBase - nTope;
                    nRecortaCC = nNume;
               |FINSI;

               || tambien para CP
               || para maximos
               nBase = enImpRem + (nDiasIT * prom_acc) + nBasePreviaCP;
               nBase = nBase + enImpExt30 + enImpExt31;
               nTope = 30 * #nomconst#36;
               |SI nBase > nTope;
                    nNume = nBase - nTope;
                    nRecortaCPMax = nNume;
               |FINSI;
          |FINSI;

          || para minimos en el caso de bases inferiores al minimo
          || lo separo, para tener en cuenta tambien trabajadores en IT
          nNume = nDiasContados + nDiasALT + nDiasIT;
          |SI nDiasCotMes = nDiasNatMes; |Y nDiasCotMes = nTopemes;
          |Y nNume = nTopemes;
               || y para minimos
               || para el famoso caso de estar por debajo del minimo estando
               || todo el mes de 31 dias de alta, en el que hay que topear
               || la base de comunes por 31 dias y la prof. por 30, por el
               || rollo de que los topes de profes. no van por dia sino que
               || consisten en un importe maximo

               nBase = enImpRem + (nDiasIT * prom_acc) + nBasePreviaCP;
               nBase = nBase + enImpExt30 + enImpExt31;

               || para minimos

               |SI nElMes = 2;
               |O nNroTramos > 1;
                    || tambien si hay mas de un tramo, ya que en este caso el
                    || minimo por CP tiene que ir por los dias del tramo en los
                    || diarios siempre
                    nTope = 30 * #nomconst#23;
               |SINO;
                    nTope = nTopemes * #nomconst#23;
               |FINSI;

               |SI nBase [ nTope;
                    nNume = nBase - nTope;
                    nRecortaCPMin = nNume;
               |FINSI;

               || para maximos
               |SI nElMes = 2;
                    nTope = nTopemes * #nomconst#36;
               |SINO;
                    nTope = 30 * #nomconst#36;
               |FINSI;
               |SI nBase > nTope;
                    nNume = nBase - nTope;
                    nRecortaCPMax = nNume;
               |FINSI;
          |FINSI;
     |FINSI;

     swMayores65 = 0;
     |HAZ Mayores65;

     || jubilacion parcial
     |HAZ Jubilacion;

     || contratos de formacion, la cotizacion no tiene que ver con la
     || remuneracion, es fija siempre por dia, las pagas extras no me importan
     |SI swFormacion = 1;
          enImpRem = nDiasALT * #nomconst#23;
          enImpExt30 = 0;
          enImpExt31 = 0;
     |FINSI;

     swPluriempleo = 0;
     |SI #labtraba#237 = "S";
          |HAZ Pluriempleo;
     |FINSI;

     || por si hay menos de 1 hora
     |SI nNroHorasExtra ! 0;
          nNroHorasExtra = nNroHorasExtra - 0.5;
          nNroHorasExtra = nNroHorasExtra ! 0;
          |SI nNroHorasExtra = 0;
               nNroHorasExtra = 1;
          |FINSI;
     |FINSI;

     swParteEnAltaERETP = 0;

     nAcum5XX = 0;
     nAcum6XX = 0;
     nAcum7XX = 0;

     |BUCLE CotizTramos;      || el bucle CotizTramos recorre los TRAMOS
                              || y por cada uno de ellos, segun su situacion
                              || crea los conceptos necesarios
     |HAZ CuotasNeg;

     || exoneracion de cuotas en ERTEs por COVID19
     |HAZ ExoneracionCOVID;
|FPRC;

|PROCESO BorraPrevioCot;
     |BORRA 020#nomcot03.a;
     |LIBERA #nomcot03;
|FPRC;

|DEFBUCLE BorraPrevioCot;
     #nomcot03#2;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 01, 000;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 31, 999;
     be;
     NULL, BorraPrevioCot;
|FIN;

|PROCESO BorraPrevioBas;
     |PARA nCampo = 30; |SI nCampo [ 49; |HACIENDO nCampo = nCampo + 1;
          #nomcot02#nCampo# = 0;
     |SIGUE;
     |PARA nCampo = 60; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 1;
          #nomcot02#nCampo# = 0;
     |SIGUE;
     |GRABA 020#nomcot02.a;
     |LIBERA #nomcot02;
|FPRC;

|DEFBUCLE BorraPrevioBas;
     #nomcot02#3;
     ;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 01;
     nEmp, nElAny, nElMes, enTipo, aCCCReg, aNaf, #labtraba#1, 31;
     be;
     NULL, BorraPrevioBas;
|FIN;

|PROCESO BuscaCCC;
     |SI #labtraba#42 = "H"; |O #labtraba#247 = 0138;
          |ACABA;
     |FINSI;

     aCCCReg = "";
     nEmp = #labtraba#0;
     nTra = #labtraba#1;
     aAlfa = #labtraba#247;
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;
     aRegimen = aAlfa;

     |ABRE #labcentr;
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |CIERRA #labcentr;

     |SI #labtraba#45 = 421; |O #labtraba#45 = 422;
          |ABRE #nomcenes;
          #nomcenes#0 = nEmp;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = 87;
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aCCCReg = #nomcenes#10;
          |SINO;
               aCCCReg = #labcentr#10;
          |FINSI;
          |CIERRA #nomcenes;
     |SINO;
          aCCCReg = #labcentr#10;
     |FINSI;
     |QBF aCCCReg;
     |SI aCCCReg = "";
          aCCCReg = #labempre#13;
          |QBF aCCCReg;
     |FINSI;
     aCCCReg = aRegimen + aCCCReg;

     aNaf = #labtraba#75;
     |QBF aNaf;
     aAlfa1 = aNaf % 102;
     aAlfa2 = aNaf % 310;
     |QBF aAlfa2;
     aAlfa2 = ("0000000000" + aAlfa2) % -110;
     aNaf = aAlfa1 + aAlfa2;
|FPRC;

|PROCESO CotizacionTramos;
     |SI runnom = "nomcalfi";
          |ACABA;
     |FINSI;

     || no hace falta volver a abrir ficheros que ya vinieran abiertos

     |ABRE #nomcot01;
     |ABRE #nomcot02;
     |ABRE #nomcot03;
     |ABRE #nomcot04;

     |ABRE #nomcot23;
     |ABRE #nomcot24;
     |ABRE #nomcot25;
     |ABRE #nomcot26;

     |ABRE #nombonif;
     |ABRE #nomboni3;

     |HAZ BuscaCCC;

     |SI swCambiaProm = 1;
          || si es un caso de los de pluriempleo que he tenido que cambiar el
          || promedio, he de poner en los tramos las bases a cero, puesto que
          || ya venian grabadas, estos son los casos en que tengo que forzar
          || a ejecutar la nomina por segunda vez con los nuevos promedios

          || tambien en un en que haya tenido que cambiar el promedio por
          || (por ejemplo) cotizar por la base minima y venir del a¤o anterior
          || la IT, en la nomina de enero

          |BUCLE BorraPrevioBas;
          |BUCLE BorraPrevioCot;
          swCambiaProm = 0;
     |FINSI;

     |SI swDiosMio = -1; |Y swSegPasada = 1;
          |BUCLE BorraPrevioBas;
          |BUCLE BorraPrevioCot;
     |FINSI;

     || eso ya no se hace aqui, se hace en el primer paso, por lo de calcular
     || todas las fichas del mismo NAF juntas
     /*
     |BUCLE BorraPrevioCot;
     |BUCLE BorraPrevioBon;
     */
     |HAZ Calculos;

     |CIERRA #nomboni3;
     |CIERRA #nombonif;

     |CIERRA #nomcot26;
     |CIERRA #nomcot25;
     |CIERRA #nomcot24;
     |CIERRA #nomcot23;

     |CIERRA #nomcot04;
     |CIERRA #nomcot03;
     |CIERRA #nomcot02;
     |CIERRA #nomcot01;
|FPRC;
