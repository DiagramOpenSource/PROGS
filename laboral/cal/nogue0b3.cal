|FICHEROS;
     labcentr;
     nomauxi1;
     nomauxi2;
     nogue001 #30;
     nomxpara #32;
     nogue006 #60;
     nogue007 #70;
     nogue008 #80;
     nogue009 #90;
|FIN;

|VARIABLES;
     nCampo1 = 0;
     aRaizMacro = "";
     aNombreMacro = "";
     nLinea = 0;
     aValor = "";
     aHojaExcel = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     aDestinoTrab = "";
     aIPRemoto = "";
     aPath = "";
     {1}aVersion = "";
     aLongitud = "";
     nLongitud = 0;
     aPos = "";
     nPos = 0;
     nCaracter = 0;
     aCaracter = "";
     nCampo = 0;
     aHoja = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     nNume = 0;
     fFecha = @;
     nCol = 0;
     &enColumnas = 0;
     &enInforme = 0;
     &dmes = 0;
     &hmes = 0;
     &peri = 0;
     &linea = 0;
     aResultado = "";
     LETRAS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
     aLetra = "";
     nCold = 0;
     nResto = 0;
     nLetras = 0;
     i = 0;
|FIN;

|PROCESO SacaLetra; || Entrada<- nCol, Salida-> aLetra
     aLetra = "";
     nNume = nCol;
     aAlfa = LETRAS % A0;
     nLetras = aAlfa;
     |PARA; |SI nNume > 0; |HACIENDO;
          nResto = nNume $ nLetras;
          |SI nResto = 0;
               aAlfa = LETRAS % -101;
               aLetra = aAlfa + aLetra;
               nNume = nNume / nLetras - 1;
          |SINO;
               nPos = nResto * 100 + 1;
               aAlfa = LETRAS % nPos;
               aLetra = aAlfa + aLetra;
               nNume = nNume - nResto;
               nNume = nNume / nLetras;
          |FINSI;
     |SIGUE;

     aAlfa = aLetra % A0;
     |SI aAlfa ] 2; |Y aLetra > "IV";
          aAlfa = "0000ERROR. Se supera maximo celda IV, calculada:" + aLetra;
          |MENAV aAlfa;
          aLetra = "IV"; || El basico peta si es mayor
     |FINSI;
|FPRC;

|PROCESO ExtraePath;
     aPath     = aVersion1;
     aLongitud = aPath % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
           nCaracter = (nPos * 100) + 1;
           aCaracter = aPath % nCaracter;
           |SI aCaracter = ",";
               nPos = nLongitud - nPos;
               nPos = nPos + 100;
               nPos = (-1) * nPos;
               aPath = aPath % nPos;
               |SAL;
          |FINSI;
     |SIGUE;

     aPath = aPath - "[";
     aPath = aPath - "]";
     |QBF aPath;
|FPRC;

|PROCESO Lineas_Macro;
     aAlfa = "A" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "B" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "C" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "D" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "E" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "F" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "G" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
     aAlfa = "H" + nLinea + "," + aRaizMacro + aNombreMacro; |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;

     nCol = 9; || -> I
     |PARA i = 0; |SI i < enColumnas; |HACIENDO i = i + 1;
          |HAZ SacaLetra;
          aAlfa = aLetra + nLinea + "," + aRaizMacro + aNombreMacro;
          |ALFACALLDLL "agixl97.dll","ejecuta_celda", aAlfa;
          nCol = nCol + 1;
     |SIGUE;
|FPRC;

|PROCESO TotalesSUBRAYADO;
     || Subrayado

     aRaizMacro = "Módulo1.";
     aNombreMacro = "Subrayado";

     |HAZ Lineas_Macro;
|FPRC;

|PROCESO TotalesNEG;
     || totales en Negrita, las lineas del total

     aRaizMacro = "Módulo1.";
     aNombreMacro = "Negrita";

     |HAZ Lineas_Macro;
|FPRC;

|PROCESO TotalesGRISNEG;
     || totales en Gris y negrita, las lineas del total

     aRaizMacro = "Módulo1.";
     aNombreMacro = "Gris_Negrita";

     |HAZ Lineas_Macro;
|FPRC;

|PROCESO Cabecera;
     || linea 1 de la cabecera

     |ABRE #30;
     #30#0 = enInforme;
     |LEE 000#30=;
     |SI FSalida = 0;
          aValor = #30#2;
     |FINSI;
     |CIERRA #30;

     aAlfa = "A1, " + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa1 = dmes; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa2 = hmes; aAlfa2 = ("00" + aAlfa2) % -102;
     nNume = peri + 2000;
     aAlfa3 = nNume;
     aValor = "Periodo: " + aAlfa1 + "/" + aAlfa2 + " - " + aAlfa3;
     aAlfa = "D1, " + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     fFecha = ~;
     aValor = fFecha;
     aValor = "Fecha: " + aValor;
     aAlfa = "H1, " + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     nLinea = 1;
|FPRC;

|PROCESO Cabecera_Emp;
     || linea 3 de la cabecera

     nLinea = nLinea + 2;

     |HAZ TotalesGRISNEG;

     aAlfa1 = #32#0; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = #32#1;
     aValor = "EMPRESA: " + aAlfa1 + " - " + aAlfa2;
     aAlfa = "A" + nLinea + ", " + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     || linea 5 de la cabecera

     nLinea = nLinea + 2;

     |HAZ TotalesNEG;
     |HAZ TotalesSUBRAYADO;

     aValor = "Codigo";
     aAlfa = "A" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "Nombre Trabajador";
     aAlfa = "B" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "Periodo";
     aAlfa = "C" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "Horas";
     aAlfa = "D" + nLinea + ","  + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aValor = "NIF";
     aAlfa = "E" + nLinea + ","  + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "NAFSS";
     aAlfa = "F" + nLinea + ","  + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "Categoría";
     aAlfa = "G" + nLinea + ","  + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aValor = "Antigüedad";
     aAlfa = "H" + nLinea + ","  + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     nCol = 9; || -> I
     |PARA i = 100; |SI i [ 199; |HACIENDO i = i + 1;
          |HAZ SacaLetra;
          aAlfa = aLetra + nLinea + "," + #70i;
          |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          nCol = nCol + 1;
     |SIGUE;
|FPRC;

|PROCESO Linea_Excel;
     |SI linea = 0;
          nLinea = nLinea + 1;          || linea normal
     |SINO;
          nLinea = nLinea + 1;          || linea totales
     |FINSI;
|| xxxxxxxxxxx

     |SI linea = 0; nCampo = 6; |FINSI;
     |SI linea = 1; nCampo = 36; |FINSI;
     |SI linea = 2; nCampo = 66; |FINSI;
     |SI linea = 3; nCampo = 96; |FINSI;
     |SI linea = 4; nCampo = 186; |FINSI;

     |SI linea = 0;
          aValor = #32#2; aValor = ("00000" + aValor) % -105;
          aAlfa = "A" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "B" + nLinea + "," + #32#3; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "C" + nLinea + "," + #32#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "D" + nLinea + "," + #32#5; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "E" + nLinea + "," + #32#217; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "F" + nLinea + "," + #32#218; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "G" + nLinea + "," + #32#219; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
          aAlfa = "H" + nLinea + "," + #32#220; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nCol = 9; || -> I
          |PARA i = 0; |SI i < enColumnas; |HACIENDO i = i + 1;
               |HAZ SacaLetra;
               |SI #60i = 99999999;
                    nCampo = i + 100;
               |SINO;
                    nCampo = i;
               |FINSI;

               aAlfa = aLetra + nLinea + "," + #60nCampo;
               |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
               nCol = nCol + 1;
          |SIGUE;
     |FINSI;
     |SI linea = 1;
          |HAZ TotalesGRISNEG;
          aValor = "TOTAL EMPRESA:";
          aAlfa = "B" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nCol = 9; || -> I
          |PARA nCampo = 0; |SI nCampo < enColumnas; |HACIENDO nCampo = nCampo + 1;
               |HAZ SacaLetra;
               |SI #60nCampo ! 99999999;
                    aAlfa = aLetra + nLinea + "," + #80nCampo;
                    |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
               |FINSI;
               nCol = nCol + 1;
          |SIGUE;
     |FINSI;
     |SI linea = 2;
          |HAZ TotalesNEG;
          aValor = #labcentr#1;
          aValor = (("00" + aValor) % -102) + " - " + #labcentr#2;
          |QBF aValor;
          aValor = "TOTAL CENTRO: " + aValor;
          aAlfa = "B" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nCol = 9; || -> I
          |PARA nCampo = 0; |SI nCampo < enColumnas; |HACIENDO nCampo = nCampo + 1;
               |HAZ SacaLetra;
               |SI #60nCampo ! 99999999;
                    nCampo1 = nCampo + 100;
                    aAlfa = aLetra + nLinea + "," + #80nCampo1;
                    |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
               |FINSI;
               nCol = nCol + 1;
          |SIGUE;
     |FINSI;
     |SI linea = 3;
          |HAZ TotalesNEG;
          aValor = #nomauxi1#0;
          aValor = aValor + " - " + #nomauxi1#1;
          |QBF aValor;
          aValor = "TOTAL AREA: " + aValor;
          aAlfa = "B" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nCol = 9; || -> I
          |PARA nCampo = 0; |SI nCampo < enColumnas; |HACIENDO nCampo = nCampo + 1;
               |HAZ SacaLetra;
               |SI #60nCampo ! 99999999;
                    aAlfa = aLetra + nLinea + "," + #90nCampo;
                    |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
               |FINSI;
               nCol = nCol + 1;
          |SIGUE;
     |FINSI;
     |SI linea = 4;
          aValor = #nomauxi2#0;
          aValor = aValor + " - " + #nomauxi2#1;
          |QBF aValor;
          aValor = "TOTAL SECCION: " + aValor + " " + #nomauxi2#2;
          aAlfa = "B" + nLinea + "," + aValor; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nCol = 9; || -> I
          |PARA nCampo = 0; |SI nCampo < enColumnas; |HACIENDO nCampo = nCampo + 1;
               |HAZ SacaLetra;
               |SI #60nCampo ! 99999999;
                    nCampo1 = nCampo + 100;
                    aAlfa = aLetra + nLinea + "," + #90nCampo1;
                    |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
               |FINSI;
               nCol = nCol + 1;
          |SIGUE;
     |FINSI;


     |SI linea ! 0;
          nLinea = nLinea + 1;          || linea totales
     |FINSI;
|FPRC;

|PROCESO Excel_Inicio;
     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
          |MENAV "0000No se puede usar la DLL de Excel.";
          |ACABA;
     |FINSI;

     aHojaExcel = "informe_parametrizado.xls";

     |DBASE aBase;  |QBF aBase;
     aOrigen = aBase + "documentos/" + aHojaExcel;
     aDestinoTrab = "C:\DOCUMENTOS";         |RMKDIR aDestinoTrab;
     aDestino = aDestinoTrab + "\trabajo.xls";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |ALFACALLDLL "agixl97.dll", "carga_book", aDestino;

     aHoja = "Hoja1";
     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", aHoja;

     |HAZ Cabecera;
|FPRC;

|PROCESO Excel_Fin;
     aAlfa   = aDestinoTrab + "\" + aHojaExcel;
     |RFBORRA aAlfa;

     |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa;
     aResultado = aAlfa;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
     |DESCARGADLL "agixl97.dll";

     aDestino   = aDestinoTrab + "\trabajo.xls";
     |RFBORRA aDestino;
         aVersion1 = "Excel.Sheet";
         |ESPECIFICA "VERSION_PROGRAMA", aVersion;
         |HAZ ExtraePath;
         |SI aPath = "NO LOCALIZADO";
             |MENAV "    ATENCION. No se ha encontrado la hoja Excel.";
             |ACABA;
         |FINSI;

         |QBF aPath;

     ||aAlfa  = "cmd " + &34 + "/c START /WAIT " + aPath + " " + aAlfa + &34;
     aAlfa  = "cmd " + &34 + "/c START /WAIT " + aResultado + &34;
     |RSYSTEM aAlfa;
|FPRC;
