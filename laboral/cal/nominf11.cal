|FICHEROS;
     nominf11 #0;

     labempre;
     labtraba;

     nomhicca;
     nomir012;
     nomir013;
     nomir003;

     nomtmp15;
|FIN;

|VARIABLES;
     aAlfa = "";
     aNombre = "";
     aNombreEmp = "";
     aAntNIF = "";
     nAntAny = 0;
     nAntMes = 0;
     nAntViv = 0;

     swError = 0;
     swUnoSi = 0;

     swPrevio = 0;
|FIN;

|PROCESO Impresion;
     |PRINT;
|FPRC;

|DEFBUCLE Impresion;
     #nomtmp15#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impresion;
|FIN;

|PROCESO labtraba;
     #nomir003#0 = #labtraba#7;
     #nomir003#40 = 2019;
     #nomir003#41 = #labtraba#0;
     |LEE 000#nomir003.=;
     |SI FSalida = 0;
          |SI #nomir003#124 = "S";
          |O #nomir003#126 = "S";
               swPrevio = 1;

               #labempre#0 = #labtraba#0;
               |LEE 000#labempre.=;
               #nomtmp15#11 = #labtraba#0;
               #nomtmp15#12 = #labempre#2;
               #nomtmp15#13 = #labtraba#1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#2;
     44;
     #nomtmp15#0, "A";
     #nomtmp15#0, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO MarcaErrores;
||SI #nomtmp15#0 = "21467759L   "; |DEBUG; |FINSI;

     || busco primero si tengo o no alguna ficha en alta con este DNI en el
     || labtraba, ademas busco si en los datos de IRPF del nomir003 realmente
     || tengo la vivienda a SI

     || quitar esta comprobacion si se quiere que salgan TODOS, esten o no
     || de alta, todos los que hayan tenido algo extra¤o

     swPrevio = 0;
     |BUCLE labtraba;
     |SI swPrevio = 1;
          || adelante
     |SINO;
          |ACABA;
     |FINSI;

     |SI #0#0 = 13707;
     |Y #0#1 = 13707;
          swPrevio = 1;
     |FINSI;

     |SI aAntNIF = #nomtmp15#0;
     |Y nAntAny = #nomtmp15#1;
     |Y nAntViv = #nomtmp15#6;
          |BORRA 000#nomtmp15.a;
          |ACABA;
     |FINSI;

     swError = 0;
     |SI #nomtmp15#0 = aAntNIF;    || mismo NIF
          swError = 1;
     |SINO;
          swUnoSi = 0;             || reinicio el switch que me dice que ha habido
     |FINSI;                       || algun SI
     |SI #nomtmp15#6 = 1;          || al menos un SI
          swUnoSi = swUnoSi + 1;
     |FINSI;
     |SI nAntViv = 0; |Y #nomtmp15#6 = 1;         || anterior NO, siguiente SI
          swError = swError + 1;
     |FINSI;
     |SI swError = 2; |Y swUnoSi > 1;
          #nomtmp15#10 = 1;
          |GRABA 000#nomtmp15.a;
     |FINSI;

     aAntNIF = #nomtmp15#0;
     nAntAny = #nomtmp15#1;
     nAntMes = #nomtmp15#2;
     nAntViv = #nomtmp15#6;
|FPRC;

|DEFBUCLE MarcaErrores;
     #nomtmp15#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, MarcaErrores;
|FIN;

|PROCESO RegrabaTmp;
     |DDEFECTO #nomtmp15;
     #nomtmp15#0 = #nomir013#0;    || DNI
     #nomtmp15#1 = #nomir013#40;   || a¤o
     #nomtmp15#2 = #nomir013#120;  || mes
     #nomtmp15#3 = #nomir013#41;   || empresa
     #nomtmp15#4 = 00000;          || trabajador (00000)
     #nomtmp15#5 = aNombre;        || trabajador (nombre)
     #nomtmp15#7 = aNombreEmp;     || empresa (nombre)
     |SI #nomir013#124 = "S";
          #nomtmp15#6 = 1;
     |FINSI;
     |SI #nomir013#126 = "S";
          #nomtmp15#6 = 1;
     |FINSI;
     |SI #nomtmp15#6 = 1; #nomtmp15#8 = 1; |FINSI;
     |SI #nomtmp15#6 = 0; #nomtmp15#9 = 1; |FINSI;
     |LEE 101#nomtmp15.=;
     |SI FSalida ! 0;

          |GRABA 020#nomtmp15.n;
     |FINSI;
     |LIBERA #nomtmp15;
|FPRC;

|DEFBUCLE nomir013;
     #nomir013#1;
     ;
     #nomtmp15#0, #nomtmp15#3, #nomtmp15#1, 01;
     #nomtmp15#0, #nomtmp15#3, #nomtmp15#1, 12;
     ;
     NULL, RegrabaTmp;
|FIN;

|PROCESO nomtmp15;
||SI #nomtmp15#0 = "22146254Z   "; |DEBUG; |FINSI;
||SI #nomtmp15#0 = "74006062C   "; |DEBUG; |FINSI;
     aNombreEmp = #nomtmp15#7;
     aNombre = #nomtmp15#5;

     |SALVA_FICHA #nomtmp15;
     |BUCLE nomir013;
     |REPON_FICHA #nomtmp15;

     |BORRA 020#nomtmp15.a;
     |LIBERA #nomtmp15;
|FPRC;

|DEFBUCLE nomtmp15;
     #nomtmp15#1;
     ;
     "            ", 2011, 00, 00001, 00000;
     "zzzzzzzzzzzz", 2019, 00, 99999, 00000;
     be;
     NULL, nomtmp15;
|FIN;

|PROCESO nomir012;
     aAlfa = #nomir012#0;
     |QBT aAlfa;
     aAlfa = aAlfa % 106;

     #labempre#0 = #nomir012#1;
     |LEE 000#labempre.=;

     #labtraba#0 = #nomir012#1;
     #labtraba#1 = #nomir012#2;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0; |O aAlfa = "000000";
          |ACABA;
     |FINSI;

||SI #labtraba#7 = "22146254Z   "; |DEBUG; |FINSI;
||SI #labtraba#7 = "74006062C   "; |DEBUG; |FINSI;
     |DDEFECTO #nomtmp15;
     #nomtmp15#0 = #nomir012#0;    || DNI
     #nomtmp15#1 = #nomir012#3;    || a¤o
     #nomtmp15#2 = 00;             || mes
     #nomtmp15#3 = #nomir012#1;    || empresa
     #nomtmp15#4 = 00000;          || trabajador
     #nomtmp15#5 = #labtraba#2;    || trabajador
     #nomtmp15#7 = #labempre#2;    || empresa
     |LEE 101#nomtmp15.=;
     |SI FSalida ! 0;
          |GRABA 020#nomtmp15.n;
     |FINSI;
     |LIBERA #nomtmp15;
|FPRC;

|DEFBUCLE nomir012;
     #nomir012#1;
     100;
     #0#0, 00001, #0#2, 01, 1
     #0#1, 99999, #0#3, 12 ,99999;
     ;
     NULL, nomir012;
|FIN;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmp15_" + (aAlfa % 108);
          |NOME_DAT #nomtmp15#aAlfa#;
          |DELINDEX #nomtmp15;

          |ABRE #nomtmp15;
          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #nomir003;

          |BUCLE nomir012;
          |BUCLE nomtmp15;
          |BUCLE MarcaErrores;

          Impresora = "CrystalReport";
          |IMPRE -1;
          |INFOR "nominf11";

          |BUCLE Impresion;

          |PIEINF;
          |FININF;
          |FINIMP;

          |CIERRA #nomir003;
          |CIERRA #labempre;
          |CIERRA #labtraba;
          |CIERRA #nomtmp15;
     |FINSI;
|FPRO;
