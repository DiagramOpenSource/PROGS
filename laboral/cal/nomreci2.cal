||PROCESOS PARA LA IMPRESION DE LA NOMINA EN CRYSTAL REPORTS

|FICHEROS;
     nomrecib #0;                      /***********************************/
     nombanco;                         /*                                 */
     :/basica/def/agidanif #8;         /* ATENCION: NO CABEN MAS FICHEROS */
     &bancosc@  #709;                  /*      HAY QUE USAR CARGA_DEF     */
     labempre #1;                      /*                                 */
     labtraba #2;                      /***********************************/
     nomconst #3;
     labcentr #6;
     nomtrnom #10;
     nomdesam #100;
     nomconca #102;
     nomcontr;
     || nom400eu;
     nomcom02;      || (lineas del mant. comentarios)
     nomcom04;      || (mant. comentarios/mes)
     nomcom05;      || (comentarios particular trabajador)
     nomcom07;      || (comentario general para toto el mundo)
     nomgir00;
     nomgirli;
     nomgirco;
     nomir009;
     nomcuadr;
     nomnomin;
     nomcenes #35;
     nomtmpca #93;
     nomtmphc #95;
     || gomccchi;
     nomtrali;

     nomimpr1;
     nomcalca #4;
     nomhicca #11;
     nomareci;
     nompluba;
     nomabsca;
     nomabsli;
     nomcalli;
     nomhicli #12;
     nomconli;
     nomcalac;
     copiadef@ #500;
     copiade2@ #501;

     nomepigr;
     nomlinom;

     nomcont1;
     nomcont3;
     nomcatli;
     nomnotan;
     nomliitl;
|FIN;

|VARIABLES;
     &aSit_lab = "":
     &aSit_fam = "";
     &aGrado_minus  = "";
     &aNif_conyuge  = "";
     &aP1       = "";
     &aP11      = "";
     &aP2       = "";
     &aP21      = "";
     &aP1_del   = "";
     &aP11_del  = "";
     &aP2_del   = "";
     &aP21_del  = "";
     &aP1_al    = "";
     &aP11_al   = "";
     &aP2_al    = "";
     &aP21_al   = "";
     &aP1_mes   = "";
     &aP11_mes  = "";
     &aP2_mes   = "";
     &aP21_mes  = "";
     &nP1_mes   = 0;
     &nP11_mes  = 0;
     &nP2_mes   = 0;
     &nP21_mes  = 0;
     &aNume = "";

     aCampo = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     &aValor = "";
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     fFecha = @;

     &nEdad = 0;
     &nDesc3 = 0;
     &nDesc25 = 0;
     &nAscen = 0;
     &enCodBanco = 0;
     &nEnfer = 0;
     &nAccid = 0;
     i = 0;
     para1 = 0;
     para2 = 0;
     para3 = 0;
     nNume = 0;
     &concep = 0;
     &camdesc = 0;
     &topemes = 0;
     nLinea = 0;
     &nAny = 0;
     &nTipo = 0;
     aComen = "";
     aComen1 = "";
     aComen2 = "";
     aComen3 = "";
     aComen4 = "";
     aLinea = "";
     aNomSN = "";
     aPagSN = "";
     aAtrSN = "";
     aFinSN = "";
     &nMes = 0;

     &infctos = 0;
     &infptas = 0;
     &infdesc = "";
     &infunid = 0;
     &infunia = 0;
     &infvalo = 0;
     &infporc = 0;
     &retoded = "";
     &nEmbargo = 0;
     aMes = "";
     nCampo = 0;
     nCampo1 = 0;
     nCampo2 = 0;

     &swStop = 0;
     &nEmp = 0;
     &nTra = 0;
     aClave = "";
     aDesdeClave = "";
     aHastaClave = "";
     &nTraNoEmi = 0;
     &aParam = "";
     &aParam1 = "";
     &aParam2 = "";
     &swHayIncid = 0;
     swNoMas = 0;
     aDesde = "";
     aHasta = "";
     aEmp = "";
     aCen = "";
     aTra = "";
     aNomEmp = "";
     aNomTra = "";
     aDef = "";
     aCuadre = "";
     aOrigen = "";
     aDestino = "";
     swSigue = 0;
     &nEmpCuad = 0;
     &nOpcion = 0;
     nTipoNom = 0;
     nRegistro = 0;
     &nContador2 = 0;
     aHora = "";
     &nEmision = 0;
     nUltimo = 0;
     &nTopemes = 0;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     &domemp = "";
     &pobemp = "";
     &afili = "";
     nHoras = 0;
     nTotalHorasAbs = 0;
     nTotalDiasAbs = 0;
     fFechaDesde = @;
     fFechaHasta = @;
     &eaVengoDe = "nomareci";
     &swModulo = 0;
     aMas = "";
     aBase = "";
     aFich = "";
     &nCuadre = 0;
     &aImpresora = "";
     &swPasada = 0;
     &descri = "";
     &unidad = 0;
     &uniant = 0;
     &valor = 0;
     &nEpigConv = 0;
     &nElAny = 0;
     &nElMes = 0;

     {1}aContiene = "";
     aIP = "";
     &ninguno = 0;

     numer = 0;
     numerl = 0;
     &import = 0;
     &incluye = 0;

     nTotalAnt3 = 0;
     nTotal = 0;
     nConcepto = 0;
     swAnt95X = 0;

     desglo = "";
     dalfa1 = "";
     pantalla = 0;
     &swPDFMasivo = 0;
     &aProcedencia = "";
     c_informe = "";
     sw_cuadre = 0;
     FEstado = 0;
     seleccio = 0;
     &nEmpresa = 0;
     &nTrabajador = 0;
     swSigue2 = 0;
     nDiasNomina = 0;
     &swParamEmpresa = 0;
     &aTipoIT = "";
     aDescripcionIT = "";
     aGuardaValor = "";
     &nDiasIT = 0;
     aQueBusco = "";
     nHorasAHV = 0;
     nHorasTra = 0;
     nTotalAHV = 0;
     nPos = 0;
     &enSwSimulacion = 0;
     &eaFichSimBox = "";
     aPath = "";
     aDes = "";
     nHandle = 0;
     swFinBloque = 0;
     nNivel = 0;

     aTextoUtf8 = "";
     aCadena = "";
     aLen = "";
     nLen = 0;
     nCampos = 0;
     aCaracRaro = "";
     nValor = 0;

     swNumero = 0;
     aPunto = "";
     aLon = "";
     nLon = 0;
     swFormatea = 0;
     swNegativo = 0;
     swEnfProf = 0;

     nHorasFM = 0;
     nHorasNor = 0;
     nDiasERE = 0;

     nPorExoCOVID = 0;
     nBase = 0;
     nExoneracion = 0;
|FIN;

|PROCESO Centro
     |DDEFECTO #labcentr;
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;           || centro
     |SI FSalida ! 0;
          aAlfa1 = #labtraba#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aAlfa2 = #labtraba#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
          aAlfa3 = #labtraba#77; |QBF aAlfa3; aAlfa3 = ("00" + aAlfa3) % -102;
          aAlfa = "    ATENCION. Trabajador " + aAlfa1 + "." + aAlfa2 + ".";
          aAlfa = aAlfa + " El centro " + aAlfa3 + " no existe.";
          |QBF aAlfa;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO ultimodia1;
     |SI #nomcontr#19 = "S"; |Y #nomtrnom#para1# = "Accidente ";
          #10para2 = #10para2 - 1;

          || si estoy en el mes en que empiezo la baja y la he comenzado
          || el mismo dia de alta en la empresa, no puedo pintar que la IT
          || por accidente comience el dia antes

          aAlfa = #labtraba#36;
          aAlfa1 = aAlfa % 102; nNume1 = aAlfa1;
          aAlfa2 = aAlfa % 402; nNume2 = aAlfa2;
          aAlfa3 = aAlfa % -104; nNume3 = aAlfa3;
          nNume4 = #0#4 + 2000;
          |SI nNume2 = #0#5; |Y nNume3 = nNume4;
               |SI #10para2 < nNume1;
                    #10para2 = #10para2 + 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #10para2 = 0;
          #10para2 = 1;
     |FINSI;
     |SI #10para3 = 0;
          nMes = #0#5;
          nAny = #0#4 + 2000;
          |HAZ topemes_plb;
          #10para3 = nTopemes;
     |FINSI;
|FPRC;

|PROCESO DatosPersonalesCR;
     |SI #agidanif#2 = "TITULAR     ";

          aCampo = "sit_fam";      aValor = #agidanif#15;
          aSit_fam = aValor;

          aValor = #agidanif#17;
          |QBF aValor;
          |SI aValor ! "";
               aValor = aValor + "%";
          |FINSI;
          aCampo = "grado_minus";  aValor = #agidanif#17;
          aGrado_minus = aValor;

     |FINSI;
     |SI #agidanif#2 = "CONYUGE     ";
          aCampo = "nif_conyuge";  aValor = #agidanif#8;
          aNif_conyuge = aValor;
     |FINSI;
     |SI #agidanif#2 = "DESCENDIENTE";
          aAlfa1 = #agidanif#13;
          |QBF aAlfa1;
          aAlfa1 = aAlfa1 % -104;
          nNume1 = aAlfa1;              || El anyo de nacimiento
          fFecha = ~;
          aAlfa2 = fFecha;
          aAlfa2 = aAlfa2 % -104;
          nNume2 = aAlfa2;              || El anyo actual
          nEdad = nNume2 - nNume1;
          |SI nEdad < 3;
               nDesc3 = nDesc3 + 1;
          |FINSI;
          |SI nEdad ] 3; |Y nEdad < 25;
               nDesc25 = nDesc25 + 1;
          |FINSI;
     |FINSI;
     |SI #agidanif#2 = "ASCENDIENTE ";
          nAscen = nAscen + 1;
     |FINSI;
|FPRC;

|PROCESO BuscaBanco;
     enCodBanco = #labtraba#71;
     |HAZ LeeBancos;
     #nombanco#1 = #709#1;
|FPRC;

|DEFBUCLE agidanifCR;
     #agidanif#1;
     ;
     #10#12, 00;
     #10#12, 99;
     ;
     NULL, DatosPersonalesCR;
|FIN;

|PROCESO agidanifCR;
     aSit_lab = "":
     aSit_fam = "";
     aGrado_minus  = "";
     aNif_conyuge  = "";
     nDesc3 = 0;
     nDesc25 = 0;
     nAscen = 0;
     |BUCLE agidanifCR;

     || la situacion laboral del trabajador, se coge del labtraba a partir del
     || 2011, lo saco del bucle del agidanif

     aCampo = "sit_lab";
     ||aAlfa = #agidanif#36; |QBF aAlfa;
     aAlfa = #labtraba#111; |QBF aAlfa;
     aAlfa = "A" + aAlfa;
     aValor = aAlfa;
     aSit_lab = aValor;
|FPRC;

|PROCESO Formatea;
     aAlfa = aNume % -301;
     |SI aAlfa = ".";
          |ACABA;
     |FINSI;
     aAlfa = aNume % -201;
     |SI aAlfa = ".";
          aNume = aNume + "0";
          |ACABA;
     |FINSI;
     |SI aNume ! "0";
          aNume = aNume + ",00";
     |SINO;
          aNume = "";
     |FINSI;
|FPRC;

|PROCESO ColocaMat;
     || aValor es el tipo de IT

     nNume = #10para2;
     |SI nNume [ 0;
          nNume = 1;
     |FINSI;

     || aDesde es el dia de inicio de la IT
     || aHasta es el dia de fin de la IT
     aDesde = nNume;
     aHasta = #10para3;

     || esto que viene ahora lo hago para que la maternidad
     || salga donde haya hueco

     |QBF aP1;
     |SI aP1 = "";
          aP1 = aValor;
          aP1_del = aDesde;
          aP1_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP11;
     |SI aP11 = "";
          aP11 = aValor;
          aP11_del = aDesde;
          aP11_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP2;
     |SI aP2 = "";
          aP2 = aValor;
          aP2_del = aDesde;
          aP2_al = aHasta;
          |ACABA;
     |FINSI;

     |QBF aP21;
     |SI aP21 = "";
          aP21 = aValor;
          aP21_del = aDesde;
          aP21_al = aHasta;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO LeeNomabsli;
     nHoras = #nomabsli#6;

     nNume2 = #nomabsli#2;
     nNume3 = #nomabsli#3;
     nNume4 = nNume3 - nNume2 + 1;


     |SI nHoras ! 0;
          nTotalHorasAbs = nTotalHorasAbs + (nNume4 * nHoras);
     |SINO;
          nTotalDiasAbs = nTotalDiasAbs + nNume4;
     |FINSI;
|FPRC;

|DEFBUCLE LeeNomabsli;
     #nomabsli#1;
     4;
     #labtraba#0, #labtraba#1, fFechaDesde, aQueBusco;
     #labtraba#0, #labtraba#1, fFechaHasta, aQueBusco;
     ;
     NULL, LeeNomabsli;
|FIN;

|PROCESO AbsHueVac;
     nMes = #0#5;
     nAny = #0#4 + 2000;
     |HAZ topemes_plb;

     aAlfa1 = "01";
     aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nAny;

     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaDesde = aAlfa;

     aAlfa1 = nTopemes; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaHasta = aAlfa;

     nHorasTra = 0;
     |ABRE #nomabsca;
     #nomabsca#0 = #labtraba#0;
     #nomabsca#1 = #labtraba#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;
          nHorasTra = #labtraba#234 / 5;
     |FINSI;
     |CIERRA #nomabsca;

     nTotalDiasAbs = 0;
     nTotalHorasAbs = 0;
     |BUCLE LeeNomabsli;
|FPRC;

|PROCESO HorasAbsHueVac;
     nMes = #0#5;
     nAny = #0#4 + 2000;

     aAlfa1 = #10para2; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nAny;

     aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
     fFechaDesde = aAlfa;

     nHorasAHV = #nomabsli#6;
     |ABRE #nomabsli;
     #nomabsli#0 = #labtraba#0;
     #nomabsli#1 = #labtraba#1;
     #nomabsli#2 = fFechaDesde;
     |LEE 000#nomabsli.=;
     |SI FSalida = 0;
          nHorasAHV = #nomabsli#6;
     |FINSI;
     |CIERRA #nomabsli;
|FPRC;

|PROCESO LiteralIT;
     aDescripcionIT = "";

     |QBF aTipoIT;
     aTipoIT = aTipoIT + "  ";
     aTipoIT = aTipoIT % 102;

     |ABRE #nomliitl;
     aAlfa = #labtraba#136;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "ESP";
          aAlfa = "CAS";
     |FINSI;
     #nomliitl#0 = aAlfa;
     #nomliitl#1 = aTipoIT;
     swSigue = 0;
     |LEE 000#nomliitl.=;
     |SI FSalida = 0
          swSigue = 1;
     |SINO;
          #nomliitl#0 = "CAS";
          #nomliitl#1 = aTipoIT;
          |LEE 000#nomliitl.=;
          |SI FSalida = 0
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          aDescripcionIT = #nomliitl#2;
          aValor = aDescripcionIT;
          |QBF aValor;
     |FINSI;
     |CIERRA #nomliitl;
|FPRC;

|PROCESO TotalesAHV;
     nTotalAHV = 0;
     |HAZ AbsHueVac;

     |SI nTotalHorasAbs ! 0;
          nTotalAHV = nTotalHorasAbs;
     |FINSI;
     |SI nTotalDiasAbs ! 0;
          nTotalAHV = nTotalDiasAbs;
     |FINSI;
     |SI nTotalDiasAbs ! 0; |Y nTotalHorasAbs ! 0;
          |SI nHorasTra = 0;
               nHorasTra = 8;
          |FINSI;
          nTotalAHV = nTotalDiasAbs + ((nTotalHorasAbs / nHorasTra) ! 2);
     |FINSI;

     |SI nTotalAHV ! 0;
          aAlfa4 = nTotalAHV;
          |SI aQueBusco = "A"; aTipoIT = "F"; |FINSI;
          |SI aQueBusco = "H"; aTipoIT = "H"; |FINSI;
          |SI aQueBusco = "V"; aTipoIT = "V"; |FINSI;
          |HAZ LiteralIT;
          aAlfa4 = aValor + ": " + aAlfa4;
          |SI nTotalHorasAbs ! 0;
               |SI nTotalHorasAbs [ 1;
                    aTipoIT = "51"; |HAZ LiteralIT;
               |SINO;
                    aTipoIT = "52"; |HAZ LiteralIT;
               |FINSI;
          |SINO;
               |SI nTotalDiasAbs [ 1;
                    aTipoIT = "56"; |HAZ LiteralIT;
               |SINO;
                    aTipoIT = "57"; |HAZ LiteralIT;
               |FINSI;
          |FINSI;
          aAlfa4 = aAlfa4 + " " + aValor;

          aValor = aAlfa4;
          || esto que viene ahora lo hago para que el AHV
          || salga donde haya hueco
          |QBF aP1;
          |SI aP1 = "";
               aP1 = aValor;
               |SI #10#199 ! 0; |Y aQueBusco = "A";
                    aNume = #10#199;
                    |HAZ Formatea;
                    aValor = aNume;
                    aP1_mes = aValor;
               |FINSI;
               |ACABA;
          |FINSI;

          |QBF aP11;
          |SI aP11 ="";
               aP11 = aValor;
               |SI #10#199 ! 0; |Y aQueBusco = "A";
                    aNume = #10#199;
                    |HAZ Formatea;
                    aValor = aNume;
                    aP11_mes = aValor;
               |FINSI;
               |ACABA;
          |FINSI;

          |QBF aP2;
          |SI aP2 ="";
               aP2 = aValor;
               |SI #10#199 ! 0; |Y aQueBusco = "A";
                    aNume = #10#199;
                    |HAZ Formatea;
                    aValor = aNume;
                    aP2_mes = aValor;
               |FINSI;
               |ACABA;
          |FINSI;

          |QBF aP21;
          |SI aP21 ="";
               aP21 = aValor;
               |SI #10#199 ! 0; |Y aQueBusco = "A";
                    aNume = #10#199;
                    |HAZ Formatea;
                    aValor = aNume;
                    aP21_mes = aValor;
               |FINSI;
               |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EnfProf;
     swEnfProf = 0;
     nCampo1 = para1 - 159;
     |SI #0#67 = "M";
          nCampo2 = para1 - 94;
          |SI #nomcalca#nCampo2# = "X";
               swEnfProf = 1;
          |FINSI;
     |FINSI;
     |SI #0#67 = "H"; |O #0#67 = "T";
          nCampo2 = para1 - 52;
          |SI #nomhicca#nCampo2# = "X";
               swEnfProf = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CargaIndemnizaCR;
     |SI #0#67 = "A";
          |SI #nomcalac#103 = "S";
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #0#67 = "T";
          |SI #nomhicca#145 = "S";
               |ACABA;
          |FINSI;
     |FINSI;
     aP1       = "";
     aP11      = "";
     aP2       = "";
     aP21      = "";
     aP1_del   = "";
     aP11_del  = "";
     aP2_del   = "";
     aP21_del  = "";
     aP1_al    = "";
     aP11_al   = "";
     aP2_al    = "";
     aP21_al   = "";
     aP1_mes   = "";
     aP11_mes  = "";
     aP2_mes   = "";
     aP21_mes  = "";
     nEnfer = 0;
     nAccid = 0;
     nP1_mes   = 0;
     nP11_mes  = 0;
     nP2_mes   = 0;
     nP21_mes  = 0;
     |SI #0#67 = "A"; |Y #0#10 = 2;
          |SI #10#103 > 0;
               #10#186 = "Enfermedad";
          |SINO;
               #10#186 = "";
          |FINSI;
          |SI #10#104 > 0;
               #10#187 = "Accidente";
          |SINO;
               #10#187 = "";
          |FINSI;
     |FINSI;
     swNoMas = 0;
     |PARA i = 186; |SI i [ 189; |HACIENDO i = i + 1;
          para1 = i;
          para2 = i - 8;
          para3 = i - 4;
          |SI #10para1 = "Enfermedad";
               |HAZ ultimodia1;
               |SI nEnfer [ 1;
                    |SI nEnfer = 0;
                         aCampo = "prestacion1"; aValor = "Enfermedad";
                         aTipoIT = "E"; |HAZ LiteralIT;
                         aP1 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion1_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP1_del = aValor;
                              aCampo = "prestacion1_al";   aValor = #10para3;
                              aP1_al = aValor;
                         |FINSI;
                    |SINO;
                         aCampo = "prestacion11"; aValor = "Enfermedad";
                         aTipoIT = "E"; |HAZ LiteralIT;
                         aP11 = aValor;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion11_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP11_del = aValor;
                              aCampo = "prestacion11_al";   aValor = #10para3;
                              aP11_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
               nEnfer = nEnfer + 1;
          |FINSI;
          |SI #10para1 = "Accidente ";
               |HAZ ultimodia1;
               |SI nAccid [ 1;
                    |SI nAccid = 0;
                         aCampo = "prestacion2"; aValor = "Accidente ";
                         aTipoIT = "A"; |HAZ LiteralIT;
                         aP2 = aValor;
                         |HAZ EnfProf;
                         |SI swEnfProf = 1; aP2 = "Enfermedad profesional"; |FINSI;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion2_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP2_del = aValor;
                              aCampo = "prestacion2_al";   aValor = #10para3;
                              aP2_al = aValor;
                         |FINSI;
                    |SINO;
                         aCampo = "prestacion21"; aValor = "Accidente ";
                         aTipoIT = "A"; |HAZ LiteralIT;
                         aP21 = aValor;
                         |HAZ EnfProf;
                         |SI swEnfProf = 1; aP21 = "Enfermedad profesional"; |FINSI;
                         |SI #0#10 ! 2;
                              aCampo = "prestacion21_del";  nNume = #10para2;
                              |SI nNume [ 0;
                                   nNume = 1;
                              |FINSI;
                              aValor = nNume;
                              aP21_del = aValor;
                              aCampo = "prestacion21_al";   aValor = #10para3;
                              aP21_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
               nAccid = nAccid + 1;
          |FINSI;
          |SI #10para1 = "Maternidad"; |O #10para1 = "Paternidad";
          |O #10para1 = "Riesgo Emb"; |O #10para1 = "IT Cont.SS";
          |O #10para1 = "Perm.s/ret";
          |O #10para1 = "Desempleo ";
               |HAZ ultimodia1;
               aCampo = "prestacion2";
               aValor = #10para1;
               |SI #10para1 = "Maternidad"; aTipoIT = "M"; |HAZ LiteralIT; |FINSI;
               |SI #10para1 = "Paternidad"; aTipoIT = "P"; |HAZ LiteralIT; |FINSI;
               |SI #10para1 = "Riesgo Emb"; aTipoIT = "R"; |HAZ LiteralIT; |FINSI;
               |SI #10para1 = "IT Cont.SS"; aTipoIT = "C"; |HAZ LiteralIT; |FINSI;
               |SI #10para1 = "Perm.s/ret"; aTipoIT = "S"; |HAZ LiteralIT; |FINSI;
               |SI #10para1 = "Desempleo "; aTipoIT = "D"; |HAZ LiteralIT; |FINSI;

               |SI #0#10 ! 2;
                    |HAZ ColocaMat;
               |FINSI;
               |SI #10para1 ! "IT Cont.SS"; |Y para1 = 186;
                    nEnfer = nEnfer + 1;
                    || esto es porque si la primera linea de IT era una
                    || maternidad y la segunda una enfermedad, no salia la
                    || maternidad.
               |FINSI;
               |SI #10para1 = "IT Cont.SS";
                    nEnfer = nEnfer + 1;
               |FINSI;
          |FINSI;
          |SI #nomcontr#47 = "T";
               |SI #10para1 = "Absentismo"; |O #10para1 = "Vacaciones";
               |O #10para1 = "Huelga    ";
                    |SI #10para1 = "Absentismo";
                         aValor = "Absentismo";
                         aTipoIT = "F"; |HAZ LiteralIT;
                         aQueBusco = "A";
                    |FINSI;
                    |SI #10para1 = "Vacaciones";
                         aValor = "Vacaciones";
                         aTipoIT = "V"; |HAZ LiteralIT;
                         aQueBusco = "V";
                    |FINSI;
                    |SI #10para1 = "Huelga    ";
                         aValor = "Huelga";
                         aTipoIT = "H"; |HAZ LiteralIT;
                         aQueBusco = "H";
                    |FINSI;

                    aGuardaValor = aValor;
                    |HAZ HorasAbsHueVac;
                    |SI nHorasAHV ! 0;
                               || pinto horas
                          nNume = nHorasAHV;
                          aAlfa4 = nNume; |QBF aAlfa4;
                          |SI nNume [ 1;
                               aTipoIT = "51"; |HAZ LiteralIT;
                          |SINO;
                               aTipoIT = "52"; |HAZ LiteralIT;
                          |FINSI;

                          aAlfa = aGuardaValor + " (" + aAlfa4 + " " + aValor + ")";
                          aValor = aAlfa;
                    |SINO;
                          aValor = aGuardaValor;
                    |FINSI;
                    |SI para1 = 186;
                         aCampo = "prestacion1";
                         aP1 = aValor;
                    |FINSI;
                    |SI para1 = 187;
                         aCampo = "prestacion11";
                         aP11= aValor;
                    |FINSI;
                    |SI para1 = 188; |Y aP2 ! "";
                         para1 = 189;
                         || si ya habia algo, pasate a la siguiente
                    |FINSI;
                    |SI para1 = 188;
                         aCampo = "prestacion2";
                         aP2 = aValor;
                    |FINSI;
                    |SI para1 = 189;
                         aCampo = "prestacion21";
                         aP21 = aValor;
                    |FINSI;
                    |HAZ ultimodia1;

                    |SI #0#10 ! 2;
                         |SI para1 = 186;
                              aCampo = "prestacion1_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP1_del = aValor;
                              aCampo = "prestacion1_al";   aValor = #10para3;
                              aP1_al = aValor;
                         |FINSI;
                         |SI para1 = 187;
                              aCampo = "prestacion11_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP11_del = aValor;
                              aCampo = "prestacion11_al";   aValor = #10para3;
                              aP11_al = aValor;
                         |FINSI;
                         |SI para1 = 188;
                              aCampo = "prestacion2_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP2_del = aValor;
                              aCampo = "prestacion2_al";   aValor = #10para3;
                              aP2_al = aValor;
                         |FINSI;
                         |SI para1 = 189;
                              aCampo = "prestacion21_del";  nNume = #10para2;
                              |SI nNume [ 0; nNume = 1; |FINSI;
                              aValor = nNume;
                              aP21_del = aValor;
                              aCampo = "prestacion21_al";   aValor = #10para3;
                              aP21_al = aValor;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
     |SI nEnfer > 0;
          |SI nEnfer = 1;
               aCampo = "prestacion1_mes";  aValor = #10#103;
               aNume = aValor; |HAZ Formatea; aValor = aNume;
               aP1_mes = aValor;
          |SINO;
               |SI aP1 = "Enfermedad";
                    aCampo = "prestacion1_mes";  aValor = #10#103;
                    aNume = aValor; |HAZ Formatea; aValor = aNume;
                    aP1_mes = aValor;
               |SINO;
                    aCampo = "prestacion11_mes";  aValor = #10#103;
                    aNume = aValor; |HAZ Formatea; aValor = aNume;
                    aP11_mes = aValor;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nAccid > 0;
          |SI nAccid = 1;
               aCampo = "prestacion2_mes";  aValor = #10#104;
               aNume = aValor;
               |HAZ Formatea;
               aValor = aNume;
               aP2_mes = aValor;
          |SINO;
               |SI aP2 = "Accidente";
                    aCampo = "prestacion2_mes";  aValor = #10#104;
                    aNume = aValor; |HAZ Formatea; aValor = aNume;
                    aP2_mes = aValor;
               |SINO;
                    aCampo = "prestacion21_mes";  aValor = #10#104;
                    aNume = aValor; |HAZ Formatea; aValor = aNume;
                    aP21_mes = aValor;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #nomcontr#47 = "D"; |O #nomcontr#47 = "C";
          aQueBusco = "A";
          |HAZ TotalesAHV;

          aQueBusco = "H";
          |HAZ TotalesAHV;

          aQueBusco = "V";
          |HAZ TotalesAHV;
     |FINSI;

     |MODULO aAlfa;
     |SI aAlfa = "nomareci"; |Y #nomareci#8 = 2;
          aP1_del = "";
          aP1_al = "";
          aP11_del = "";
          aP11_al = "";
          aP2_del = "";
          aP2_al = "";
          aP21_del = "";
          aP21_al = "";
     |FINSI;
|FPRC;

|PROCESO ImpCrystal;     || procesos necesarios para impresion de la nomina
                         || en Crystal Reports
     |SI Impresora = "CrystalReport"; |O #0#69 = "P"; |O nOpcion = 2;
          |HAZ agidanifCR;       ||Datos personales para Crystal Reports
          |HAZ CargaIndemnizaCR;   ||Prestaciones e indemnizaciones Crystal Reports
          |HAZ BuscaBanco;
          |SI #0#9 = 2;
               #labempre#07 = #labcentr#07;
               #labempre#08 = #labcentr#08;
               #labempre#06 = #labcentr#06;
          |FINSI;
          ||HAZ c400;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomhorli.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |SI #nomconca#165 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
               #10#207 = #10#207;  || se queda con lo que tenia que haber
                                   || en el campo, las horas
               #10#207 = #10#207 - (nDiasIT * #labtraba#47);
          |SINO;
               |ABRE #500;
               #500#0 = #labtraba#0;
               #500#1 = #labtraba#1;
               #500#2 = #0#4 + 2000;
               #500#3 = #0#5;
               #500#4 = 0;
               |LEE 000#500=;
               |SI FSalida = 0;
                    #10#207 = #500#8;
               |FINSI;
               |CIERRA #500;
          |FINSI;
     |SINO;
          #10#207 = 0;
     |FINSI;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO CrystalDescComp;
     |SI Impresora = "CrystalReport"; |O nOpcion = 2;
          |SI concep = 511;
               aValor = "Comp. Enfermedad";
               aTipoIT = "ce"; |HAZ LiteralIT;
               #10camdesc = aValor;
          |FINSI;
          |SI concep = 512;
               aValor = "Comp. Accidente";
               aTipoIT = "ca"; |HAZ LiteralIT;
               #10camdesc = aValor;
          |FINSI;
          |SI concep = 513;
               aValor = "Comp. Maternidad";
               aTipoIT = "cm"; |HAZ LiteralIT;
               #10camdesc = aValor;
          |FINSI;
          |SI concep = 514;
               aValor = "Comp. ILT";
               aTipoIT = "ci"; |HAZ LiteralIT;
               #10camdesc = aValor;
          |FINSI;
          |SI concep = 515;
               aValor = "Enfermedad Empresa";
               aTipoIT = "ee"; |HAZ LiteralIT;
               #10camdesc = aValor;
          |FINSI;
          |SI #labtraba#247 = 138;
               |SI concep = 512;
                    aValor = "Prestaci¢n Acc. Empresa";
                    aTipoIT = "pa"; |HAZ LiteralIT;
                    #10camdesc = aValor;
               |FINSI;
               |SI concep = 515;
                    aValor = "Prestaci¢n Enf. Empresa";
                    aTipoIT = "pe"; |HAZ LiteralIT;
                    #10camdesc = aValor;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaCrystal;
     |ABRE #labempre;
     #labempre#0 = 00014;
     |LEE 000#labempre.=;
     aAlfa = #labempre#2;     || esto es una barbaridad para que si estoy
     |CIERRA #labempre;
     |QBF aAlfa;              || en Qualitas no me copie la nomina ya que no
     |SI aAlfa = "VICENTE NAVARRO CERDAN";
          |ACABA;             || funcionaba bien en FABRE por algun motivo que
     |FINSI;                  || esta por descubrir, cuando se resuelva quitare esto

     |DBASE aAlfa1;
     aAlfa1 = aAlfa1 + "def/nomycrys.rpt";
     aAlfa1 = "rb  " + aAlfa1;
     |FABRE aAlfa1;
     |SI FSalida < 0;
          |DBASE aAlfa1;
          aAlfa1 = aAlfa1 + "plantillas/nomycrys.r00";
          |DBASE aAlfa2;
          aAlfa2 = aAlfa2 + "def/nomycrys.rpt";
          |COPIA_FICHERO aAlfa1, aAlfa2;
     |FINSI;
     |FCIERRA aAlfa1;
|FPRC;

|PROCESO c400;
/*
     |ACABA;
     |SI #nomcontr#53 ! "S";
          |ACABA;
     |FINSI;
     |SI #0#67 ! "M"; |Y #0#67 ! "H";   || ni en atrasos ni en atrasos hist.
          |ACABA;
     |FINSI;

     |ABRE #nom400eu;

     #nom400eu#0 = #nomtrnom#1;
     #nom400eu#1 = #nomtrnom#2;
     #nom400eu#2 = 2008;
     #nom400eu#3 = #0#5;
     |LEE 000#nom400eu.=;
     |SI FSalida = 0;
          |SI #0#68 = "N";
               |SI #0#10 ! 2;
                    nNume = #nom400eu#10 + #nom400eu#27 + #nom400eu#33;
                    |SI #labempre#25 = 2;    || paga junto mes
                         nNume = nNume + #nom400eu#13;
                    |FINSI;
                    |SI #labempre#39 = 1;    || finiquito junto mes
                         nNume = nNume + #nom400eu#21;
                    |FINSI;
               |SINO;
                    nNume = #nom400eu#21;
               |FINSI;
          |FINSI;
          |SI #0#68 = "P";
               nNume = #nom400eu#13;
          |FINSI;
          |SI #0#68 = "F";
               nNume = #nom400eu#21;
          |FINSI;
          aAlfa = nNume;
          |QBF aAlfa;
          aAlfa = "Importe deducci¢n de retenci¢n IRPF: " + aAlfa + " euros.";
          #nomtrnom#200 = aAlfa;
          || aqui se construiria el comentario
     |FINSI;
     |CIERRA #nom400eu;
*/
|FPRC;


/********************** COMENTARIOS EN LA NOMINA ****************************/

|PROCESO CamposComen;
     || aqui contruyo comentario
     aComen1 = #nomtrnom#201; |QBF aComen1;
     aComen2 = #nomtrnom#202; |QBF aComen2;
     aComen3 = #nomtrnom#203; |QBF aComen3;
     aComen4 = #nomtrnom#204; |QBF aComen4;

     |SI aComen1 = ""; #nomtrnom#201 = aComen; |ACABA; |FINSI;
     |SI aComen2 = ""; #nomtrnom#202 = aComen; |ACABA; |FINSI;
     |SI aComen3 = ""; #nomtrnom#203 = aComen; |ACABA; |FINSI;
     |SI aComen4 = ""; #nomtrnom#204 = aComen; |ACABA; |FINSI;
|FPRC;

|PROCESO ConstruyeCom;
     |SI #nomcom04#11 ! "*"
          aLinea = #nomcom02#2;
     |SINO;
          aLinea = #nomcom05#5;
     |FINSI;
     |QBF aLinea;
     aComen = aComen + aLinea + " ";
|FPRC;

|DEFBUCLE LeeCom2;
     #nomcom05#1;
     ;
     #labtraba#0, nAny, nMes, #nomcom04#3, 001;
     #labtraba#0, nAny, nMes, #nomcom04#3, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|DEFBUCLE LeeCom;
     #nomcom02#1;
     ;
     #nomcom04#9, 001;
     #nomcom04#9, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|DEFBUCLE LeeComGen;
     #nomcom02#1;
     ;
     #nomcom07#9, 001;
     #nomcom07#9, 005;
     ;
     NULL, ConstruyeCom;
|FIN;

|PROCESO LeeCom;
     aComen = "";

     |SI nTipo = 0;
          aNomSN = #nomcom07#12;
          aPagSN = #nomcom07#13;
          aAtrSN = #nomcom07#14;
          aFinSN = #nomcom07#15;
     |SINO;
          aNomSN = #nomcom04#12;
          aPagSN = #nomcom04#13;
          aAtrSN = #nomcom04#14;
          aFinSN = #nomcom04#15;
     |FINSI;

     |SI #0#67 = "A"; |O #0#67 = "T";
          |SI aAtrSN ! "X";
               |ACABA;
          |FINSI;
     |SINO;
          |SI #0#68 = "N"; |Y aNomSN ! "X";
               |ACABA;
          |FINSI;
          |SI #0#68 = "P"; |Y aPagSN ! "X";
               |ACABA;
          |FINSI;
          |SI #0#68 = "F"; |Y aFinSN ! "X";
               |ACABA;
          |FINSI;
     |FINSI;

     |SI nTipo = 0;
          |BUCLE LeeComGen;
     |SINO;
          |SI #nomcom04#11 ! "*"
               |BUCLE LeeCom;
          |SINO;
               |BUCLE LeeCom2;
          |FINSI;
     |FINSI;

     |SI aComen ! "";
          |HAZ CamposComen;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaComTra;
     #nomcom04#1;
     4, 7;
     #labtraba#0, nAny, nMes, 001, nTipo, #labtraba#1;
     #labtraba#0, nAny, nMes, 999, nTipo, #labtraba#1;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComCat;
     #nomcom04#1;
     4, 5;
     #labtraba#0, nAny, nMes, 001, nTipo, #labtraba#17;
     #labtraba#0, nAny, nMes, 999, nTipo, #labtraba#17;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComEmp;
     #nomcom04#1;
     4;
     #labtraba#0, nAny, nMes, 001, nTipo;
     #labtraba#0, nAny, nMes, 999, nTipo;
     ;
     NULL, LeeCom;
|FIN;

|DEFBUCLE BuscaComGen;
     #nomcom07#1;
     ;
     nAny, nMes, 001;
     nAny, nMes, 999;
     ;
     NULL, LeeCom;
|FIN;

|PROCESO ComentMes;
     nAny = #0#4 + 2000;
     nLinea = 0;
     nTipo = 0;
     nMes = 0;
     |BUCLE BuscaComGen;
     nMes = #0#5;
     |BUCLE BuscaComGen;

     nTipo = 1;
     nMes = 0;
     |BUCLE BuscaComEmp;
     nMes = #0#5;
     |BUCLE BuscaComEmp;
/*
     nTipo = 2;
     nMes = 0;
     |BUCLE BuscaComCat;
     nMes = #0#5;
     |BUCLE BuscaComCat;
*/
     nTipo = 2;
     nMes = 0;
     |BUCLE BuscaComTra;
     nMes = #0#5;
     |BUCLE BuscaComTra;
|FPRC;

|PROCESO Comentarios;
     #nomtrnom#201 = "";
     #nomtrnom#202 = "";
     #nomtrnom#203 = "";
     #nomtrnom#204 = "";
     |HAZ ComentMes;
|FPRC;

|PROCESO PrintAntic;
     |ABRE #nomconli;
     |ABRE #nomdesam;

     ninguno = ninguno + 1;
     infctos = infctos + 1;
     infptas = nTotal;

     infdesc = "";
     #nomdesam#0 = #labtraba#87;
     #nomdesam#1 = nConcepto;
     |LEE 000#nomdesam.=;
     |SI FSalida = 0;
          infdesc = #nomdesam#2;
     |SINO;
          #nomconli#0 = #labtraba#87;
          #nomconli#2 = nConcepto;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               infdesc = #nomconli#6;
          |FINSI;
     |FINSI;

     infunid = 0;
     infunia = 0;
     infvalo = 0;
     infporc = 0;
     retoded = "D";
     |SI infptas ! 0; |PRINT; |FINSI;

     |CIERRA #nomdesam;
     |CIERRA #nomconli;
|FPRC;

|PROCESO His_95X;
     |ABRE #nomhicli;
     |PARA nConcepto = 951; |SI nConcepto [ 960; |HACIENDO nConcepto = nConcepto + 1;
          #nomhicli#0 = #nomhicca#0;
          #nomhicli#1 = #nomhicca#1;
          #nomhicli#2 = #nomhicca#2;
          #nomhicli#3 = #nomhicca#3;
          #nomhicli#12 = #nomhicca#66;
          #nomhicli#4 = nConcepto;
          |LEE 000#nomhicli.=;
          |SI FSalida = 0;
               nTotal = (#nomhicli#10 * #nomhicli#11) ! 2;
               |SI swAnt95X = 1;
                    nTotalAnt3 = nTotalAnt3 - nTotal;
               |FINSI;
               |SI swAnt95X = 2;
                    |HAZ PrintAntic;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #nomhicli;
|FPRC;

|PROCESO Men_95X;
     |ABRE #nomcalli;
     |PARA nConcepto = 951; |SI nConcepto [ 960; |HACIENDO nConcepto = nConcepto + 1;
          #nomcalli#0 = #nomcalca#0;
          #nomcalli#1 = #nomcalca#1;
          #nomcalli#2 = #nomcalca#2;
          #nomcalli#3 = #nomcalca#3;
          #nomcalli#4 = nConcepto;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;
               nTotal = (#nomcalli#10 * #nomcalli#11) ! 2;
               |SI swAnt95X = 1;
                    nTotalAnt3 = nTotalAnt3 - nTotal;
               |FINSI;
               |SI swAnt95X = 2;
                    |HAZ PrintAntic;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #nomcalli;
|FPRC;

|PROCESO Anticipos95X;
     nTotalAnt3 = #10#196;    || los anticipos 951-960 se guardan en el 196
     |SI nTotalAnt3 = 0;      || si esta a cero, nada que hacer
          |ACABA;
     |FINSI;
     |SI #0#67 = "M";
          |HAZ Men_95X;
     |FINSI;
     |SI #0#67 = "H";
          |HAZ His_95X;
     |FINSI;
|FPRC;

|PROCESO LineasDto;
     swSigue = 0;
     |SI #0#69 = "A";
          |SI Impresora = "CrystalReport"; |O nOpcion = 2;
               swSigue = 1;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          ninguno = ninguno + 1;
          infctos = 601;
          infptas = #10#116;
          || -PRESTACIONES SEG. SOCIAL
          aTipoIT = "61"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "R";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 602;
          infptas = #10#160;
          infdesc = #10#169; |QBF infdesc;
          |SI infdesc = "";
               || ANTICIPOS
               aTipoIT = "62"; |HAZ LiteralIT; infdesc = aValor;
          |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 603;
          infptas = #10#161;
          infdesc = #10#170; |QBF infdesc;
          |SI infdesc = "";
               || ANTICIPOS
               aTipoIT = "62"; |HAZ LiteralIT; infdesc = aValor;
          |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          || primero para descontar del campo 196
          swAnt95X = 1;
          |HAZ Anticipos95X;

          ninguno = ninguno + 1;
          infctos = 604;
          infptas = nTotalAnt3;
          infdesc = #10#197; |QBF infdesc;
          |SI infdesc = "";
               || ANTICIPOS
               aTipoIT = "62"; |HAZ LiteralIT; infdesc = aValor;
          |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 605;
          infptas = #10#140;
          infdesc = #10#171; |QBF infdesc;
          |SI infdesc = "";
               || "EN ESPECIE";
               aTipoIT = "63"; |HAZ LiteralIT; infdesc = aValor;
          |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          |SI #0#68 = "P";
               ninguno = ninguno + 1;
               infctos = 605;      || ant. paga extra los meto en el concepto
                                   || de la especie, que en pagas no hay
               infptas = #10#175;
               infdesc = #10#176; |QBF infdesc;
               |SI infdesc = "";
                    || "ANTICIPOS";
                    aTipoIT = "62"; |HAZ LiteralIT; infdesc = aValor;
               |FINSI;
               infunid = 0;
               infunia = 0;
               infvalo = 0;
               infporc = 0;
               retoded = "D";
               |SI infptas ! 0; |PRINT; |FINSI;
          |FINSI;

          ninguno = ninguno + 1;
          infctos = 606;
          infptas = nEmbargo;
          || "EMBARGOS";
          aTipoIT = "64"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          || despues para pintarlos en la nomina
          swAnt95X = 2;
          |HAZ Anticipos95X;

          ninguno = ninguno + 1;
          infctos = 641;
          infptas = #10#131;
          || "SEG. SOCIAL CONT. COMUNES";
          aTipoIT = "65"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#127;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 642;
          infptas = #10#164;
          |SI 1.90 [ #10#162; |Y #10#162 [ 2.10;
               || "COTIZACION DE SOLIDARIDAD";
               aTipoIT = "66"; |HAZ LiteralIT; infdesc = aValor;
          |SINO;
               |SI 0.90 [ #10#162; |Y #10#162 [ 1.10;
                    || "COTIZACION CONT. EXCLUIDAS";
                    aTipoIT = "67"; |HAZ LiteralIT; infdesc = aValor;
               |SINO;
                    || "COTIZACION DESEMPLEO";
                    aTipoIT = "68"; |HAZ LiteralIT; infdesc = aValor;
               |FINSI;
          |FINSI;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#162;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 643;
          infptas = #10#165;
          || "COTIZACION FORMACION";
          aTipoIT = "69"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#163;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 644;
          infptas = #10#138;
          || "RETENCION I.R.P.F.";
          aTipoIT = "70"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = #10#135;
          retoded = "D";
          ||SI infptas ! 0; |PRINT; |FINSI;
          |PRINT;

          ninguno = ninguno + 1;
          infctos = 645;
          infptas = #10#133;
          || "HORAS FUERZA MAYOR";
          aTipoIT = "71"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          ninguno = ninguno + 1;
          infctos = 646;
          infptas = #10#134;
          || "OTRAS HORAS EXTRAS";
          aTipoIT = "72"; |HAZ LiteralIT; infdesc = aValor;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI infptas ! 0; |PRINT; |FINSI;

          |HAZ CargaIndemnizaCR;   || Periodos de IT

          aMes = #0#5; |QBF aMes; aMes = ("00" + aMes) % -102;

          |QBF aP1;

          ninguno = ninguno + 1;
          infctos = 651;
          infptas = 0;
          infdesc = aP1 + " del " + aP1_del + "/" + aMes + " al " + aP1_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP1 ! ""; |PRINT; |FINSI;

          |QBF aP11;
          ninguno = ninguno + 1;
          infctos = 652;
          infptas = 0;
          infdesc = aP11 + " del " + aP11_del + "/" + aMes + " al " + aP11_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP11 ! ""; |PRINT; |FINSI;

          |QBF aP2;
          ninguno = ninguno + 1;
          infctos = 653;
          infptas = 0;
          infdesc = aP2 + " del " + aP2_del + "/" + aMes + " al " + aP2_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP2 ! ""; |PRINT; |FINSI;

          |QBF aP21;
          ninguno = ninguno + 1;
          infctos = 654;
          infptas = 0;
          infdesc = aP21 + " del " + aP21_del + "/" + aMes + " al " + aP21_al + "/" + aMes;
          infunid = 0;
          infunia = 0;
          infvalo = 0;
          infporc = 0;
          retoded = "D";
          |SI aP21 ! ""; |PRINT; |FINSI;

          infctos = 000;
          infdesc = "";
     |FINSI;
|FPRC;

|PROCESO Cotizaciones;
     swSigue = 0;
     |SI #0#69 = "A";
          |SI Impresora = "CrystalReport"; |O nOpcion = 2;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;

          |SI infctos < 400;
               infdesc = "*" + infdesc;
          |FINSI;
          |SI infctos ] 400; |Y infctos < 599;
               |ABRE #nomconli;
               #nomconli#0 = #labtraba#87;
               #nomconli#2 = infctos;
               |LEE 000#nomconli.=;
               |SI FSalida = 0; |Y #nomconli#11 = "S"; |Y #nomconli#12 = 7;
                    infdesc = "*" + infdesc;
               |SINO;
                    infdesc = "-" + infdesc;
               |FINSI;
               |CIERRA #nomconli;
          |FINSI;
          |SI infctos > 500;
               infunid = 0;
               infunia = 0;
               infvalo = 0;
               infporc = 0;
               |QBF infdesc;
               |SI infdesc = "-ENF.EMP.";
                    || "-PRESTACIONES EMPRESA";
                    aTipoIT = "73"; |HAZ LiteralIT; infdesc = aValor;
               |FINSI;
               |SI infdesc = "-COMP.ENF";
                    || "-COMPLEMENTO";
                    aTipoIT = "74"; |HAZ LiteralIT; infdesc = aValor;
               |FINSI;
          |FINSI;
     |FINSI;
     swSigue = 0;
     |SI infctos = 101; |Y #nomcont3#1 = "S";
          |ABRE #nomcatli;
          #nomcatli#0 = #labtraba#87;
          #nomcatli#1 = #labtraba#17;
          #nomcatli#2 = infctos;
          |LEE 000#nomcatli.=;
          |SI FSalida = 0;
               aAlfa = #nomcatli#3;
               |QBT aAlfa;
               |SI aAlfa = "1"; |Y infunid [ 1;
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |CIERRA #nomcatli;

          |ABRE #nomtrali;
          #nomtrali#0 = #labtraba#0;
          #nomtrali#1 = #labtraba#1;
          #nomtrali#2 = infctos;
          |LEE 000#nomtrali.=;
          |SI FSalida = 0;
               aAlfa = #nomtrali#3;
               |QBT aAlfa;
               |SI aAlfa = "1"; |Y infunid [ 1;
                    swSigue = 1;
               |FINSI;
          |FINSI;
          |CIERRA #nomcatli;
     |FINSI;

     |SI swSigue = 1;
          nDiasNomina = #10#19;
          || ojo, tener en cuenta ERE como mes no completo, si no salen mal
          || las unidades y el importe
          nDiasERE = 0;
          |SI #0#67 = "M"; nDiasERE = #nomcalca#78; |FINSI;
          |SI #0#67 = "H"; nDiasERE = #nomhicca#119; |FINSI;

          || si no esta de alta el mes completo
          |SI #10#14 ! 1; |O #10#16 ! topemes; |O nDiasERE ! 0;
               infvalo = ((infunid * infvalo) / nDiasNomina) ! 2;
               infunid = nDiasNomina;
               |ACABA;

               || si encima tiene IT ... pues ya veriamos
          |FINSI;

          swSigue2 = 0;
          |SI #0#67 = "M"; |Y #nomcalca#181 = "S";
               swSigue2 = 1;
          |FINSI;
          |SI #0#67 = "H"; |Y #nomhicca#223 = "S";
               swSigue2 = 1;
          |FINSI;
          |SI swSigue2 = 1;
               |SI #0#5 = 1; |O #0#5 = 3; |O #0#5 = 5; |O #0#5 = 7;
               |O #0#5 = 8; |O #0#5 = 10; |O #0#5 = 12;
                    nDiasNomina = nDiasNomina - 1;
               |FINSI;
               |SI #0#5 = 2;
                    nDiasNomina = nDiasNomina + 2;
               |FINSI;
          |FINSI;
          infvalo = (infvalo / nDiasNomina) ! 2;
          infunid = (nDiasNomina * infunid) ! 0;
     |FINSI;
|FPRC;

/******************* PROCESOS PARA QUE SALTE EL GESTOR **********************/
/************************ DE INCIDENCIAS DEL IRPF ***************************/

|PROCESO nomgir00;
     |SI aParam = "AUTO";
          |ACABA;
     |FINSI;

     aAlfa = Usuario;         |QBF aAlfa;
     aAlfa = "m" +  aAlfa;
     |NOME_DAT #nomgir00#aAlfa#;
     |DELINDEX #nomgir00;
     |ABRE #nomgir00;

     |PARA nCampo = 0; |SI nCampo [ 3; |HACIENDO nCampo = nCampo + 1;
          #nomgir00#nCampo# = #nomrecib#nCampo#;
     |SIGUE;
     #nomgir00#4 = 001;    || convenio
     #nomgir00#5 = 999;
     #nomgir00#6 = 001;    || categoria
     #nomgir00#7 = 999;
     #nomgir00#8 = #nomrecib#5;
     nNume = #nomrecib#4;
     nNume = nNume + 2000;
     #nomgir00#9 = nNume;
     #nomgir00#20 = 1;     || clave fija
     |PARA nCampo = 21; |SI nCampo [ 62; |HACIENDO nCampo = nCampo + 1;
          #nomgir00#nCampo# = #nomrecib#nCampo#;
     |SIGUE;
     |PARA nCampo = 63; |SI nCampo [ 70; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo + 7;
          #nomgir00#nCampo# = #nomrecib#nCampo1#;
     |SIGUE;
     |SI #0#69 = "P";
          |PARA nCampo = 23; |SI nCampo [ 70; |HACIENDO nCampo = nCampo + 1;
               #nomgir00#nCampo# = #nomrecib#nCampo#;
          |SIGUE;
          #nomgir00#21 = #nomrecib#11;
          #nomgir00#42 = #nomrecib#12;
     |FINSI;
     |GRABA 000#nomgir00.n;
     |CIERRA #nomgir00;

     |SUB_EJECUTA "nomgir00;nomrecib";
|FPRC;

|| PROCESO PARA BUSCAR SI EL TRABAJADOR TIENE INCIDENCIAS DE IRPF
|| PENDIENTES DE VALIDAR

|PROCESO nomgirli;
     |SI #nomgirli#9 = "N";
          swHayIncid = swHayIncid + 1;
     |FINSI;

     #nomir009#0 = nEmp;
     |LEE 000#nomir009.=;
     |SI FSalida = 0;
          |SI #nomir009#21 = 0;
               |ACABA;
          |FINSI;
     |SINO;
          |ACABA;
     |FINSI;

     |SI #0#68 = "N"; |Y #nomgirco#1 = "S";
          |SI #nomgirli#9 = "N";
               swStop = swStop + 1;
               swHayIncid = swHayIncid - 1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nomgirli;
     #nomgirli#1;
     ;
     nEmp, nAny, #0#5, aDesdeClave;
     nEmp, nAny, #0#5, aHastaClave;
     ;
     NULL, nomgirli;
|FIN;

|PROCESO IncidIRPF;
     swStop = 0;

     |DDEFECTO #nomgirco;
     |ABRE #nomgirco; |LEE 000#nomgirco.p;  |CIERRA #nomgirco;

     |DDEFECTO #nomir009;
     |ABRE #nomir009;

     nAny = #0#4;
     nAny = nAny + 2000;
     aClave = nTra;
     aClave = ("00000" + aClave) % -105;
     aDesdeClave = aClave + ".001";
     aHastaClave = aClave + ".999";
     |BUCLE nomgirli;

     |CIERRA #nomir009;
|FPRC;

|PROCESO AvisoIRPF;
     aParam2 = aParam2 % -102;
     |SI nTraNoEmi ! 0;
          aAlfa = nTraNoEmi;
          |SI nTraNoEmi = 1;
               aAlfa = "    ATENCION: No se ha impreso " + aAlfa + " nómina";
          |SINO;
               aAlfa = "    ATENCION: No se han impreso " + aAlfa + " nóminas";
          |FINSI;
          aAlfa = aAlfa + " por incidencias de nivel 2 en el IRPF. Pulse OK para ver el informe.";
          |MENAV aAlfa;

          nAny = #0#4 + 2000;
          |SUB_EJECUTA "nomgirin;nomrecib";
     |FINSI;
     |SI swHayIncid ! 0;
          |SI aParam2 = "PI";
               aAlfa = "    ATENCION: existen empresas con incidencias en el IRPF";
               aAlfa = aAlfa + " y el gestor de incid. está desactivado. Consulte: ";
               |MENAV aAlfa;

               aAlfa = "     Emisión de Recibos de Salarios / Emisión de Nóminas del Mes Actual / ";
               aAlfa = aAlfa + "Informe Incidencias IRPF";
               |MENAV aAlfa;
          |SINO;
               aAlfa = "    ATENCION: existen empresas con incidencias en el IRPF ";
               aAlfa = aAlfa + "y el gestor de incidencias está desactivado. ";
               |MENAV aAlfa;

               aAlfa = "Proceso Mensual / Informe Incidencias IRPF";
               aAlfa = "    Consulte la opción " + aAlfa + " para comprobarlas.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************** MENSAJE DE ENVIO AL DSARCHI *******************************/
/****************************************************************************/

|PROCESO Mensaje;
     aEmp = "                                             ";
     aCen = "                                             ";
     aTra = "                                             ";

     aAlfa = #nomtrnom#1;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aNomEmp = #nomtrnom#3;
     aNomEmp = aNomEmp % 126;
     aEmp = "Empresa: " + aAlfa + " - " + aNomEmp;
     aEmp = " " + aEmp + " ";

     aCen = " Archivando nóminas ... ";
     aCen = aCen + "                            ";
     aCen = aCen % 145;

     nTra = #nomtrnom#2;
     aAlfa = nTra;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     aNomTra = #nomtrnom#6;
     aNomTra = aNomTra % 126;
     aTra = "Trabaj.: " + aAlfa + " - " + aNomTra;
     aTra = " " + aTra + " ";

               ||  1 2        3         4         5          6
               ||  890123456789012345678901234567890123456789012
     |ATRI R;
     |PINTA 1318, "      - Procesando archivo de nóminas -      ";
     |PINTA 1418, aEmp;
     |PINTA 1518, aCen;
     |PINTA 1618, aTra;
     |ATRI 0;
|FPRC;

|PROCESO ConfCuadre;
     aCuadre = nCuadre;
     aCuadre = ("00" + aCuadre) % -102;
     |SI #0#69 ! "A";
          aCuadre = "nomycrys.d" + aCuadre;
     |SINO;
          aCuadre = "nomyabie.e" + aCuadre;
     |FINSI;

     |DDEF aDef;
     |QBF aDef;
     aOrigen = aDef + aCuadre;
     |SI #0#69 ! "A";
          aDestino = aDef + "nomycrys.inf";
     |SINO;
          aDestino = aDef + "nomyabie.inf";
     |FINSI;

     |COPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
          aAlfa = "    No se ha encontrado el cuadre " + aOrigen;
          |MENAV aAlfa;
          nEmpCuad = 0;
          |ACABA;
     |FINSI;

     aCuadre = nCuadre;
     aCuadre = ("00" + aCuadre) % -102;
     |SI #0#69 ! "A";
          aCuadre = "nomycrys.r" + aCuadre;
     |SINO;
          aCuadre = "nomyabie.r" + aCuadre;
     |FINSI;

     |DBASE aDef;
     |QBF aDef;
     aOrigen = aDef + "plantillas/" + aCuadre;
     |SI #0#69 ! "A";
          aDestino = aDef + "def/nomycrys.rpt";
     |SINO;
          aDestino = aDef + "def/nomyabie.rpt";
     |FINSI;

     |COPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
          aAlfa = "    No se ha encontrado el cuadre " + aOrigen;
          |MENAV aAlfa;
          nEmpCuad = 0;
     |FINSI;
|FPRC;

|PROCESO cuadre_emp;
     nEmpCuad = 0;
     |DDEF aDef;
     |QBF aDef;
     aDestino = aDef + "nomycrys.infcop";
     |FBORRA aDestino;
     aDestino = aDef + "nomycrys.rptcop";
     |FBORRA aDestino;

     |ABRE #nomcuadr; |LEE 000#nomcuadr.p; |CIERRA #nomcuadr;

     |ABRE #nomcuadr;
     |LEE 000#nomcuadr.p;
     aAlfa = #nomcuadr#6;
     |QBF aAlfa;
     |SI aAlfa ! "ABR2015";
          |SI #nomcuadr#4 = 32;
               #nomcuadr#4 = 82;
          |SINO;
               |SI #nomcuadr#4 ! 00; |Y #nomcuadr#4 ! 05;
                    #nomcuadr#4 = 00;
               |FINSI;
          |FINSI;
          #nomcuadr#6 = "ABR2015";
          |GRABA 020#nomcuadr.a;
          |LIBERA #nomcuadr;
     |FINSI;
     |CIERRA #nomcuadr;

     |SI #nomcuadr#4 = -1;
          nCuadre = #nomcuadr#4;
          |ACABA;
     |FINSI;
     |SI #0#69 ! "A";
          nCuadre = #nomcuadr#4;
     |SINO;
          nCuadre = #nomcuadr#5;
     |FINSI;
     |HAZ ConfCuadre;

     |SI nCuadre = 00; |O nCuadre = 01; |O nCuadre = 05;
     |O nCuadre = 15; |O nCuadre = 82;
          |ACABA;
     |FINSI;
     |SI #0#69 = "A";
          |SI nCuadre = 31;
               |ACABA;
          |FINSI;
     |FINSI;

     nEmpCuad = 0;

     swSigue = 1;
     |SI #0#21 = 0;
          |SI #0#0 ! #0#1;
               swSigue = 0;
          |SINO;
               nEmpCuad = #0#0;
          |FINSI;
     |SINO;
          nEmpCuad = #0#21;
          |PARA nCampo = 21; |SI nCampo [ 40; |HACIENDO nCampo = nCampo + 1;
               |SI nCampo = 27; nCampo = 28; |FINSI;
               |SI nCampo = 34; nCampo = 35; |FINSI;
               |PARA nCampo1 = nCampo; |SI nCampo1 [ 40; |HACIENDO nCampo1 = nCampo1 + 1;
                    |SI #0nCampo ! #0nCampo1; |Y #0nCampo ! 0; |Y #0nCampo1 ! 0;
                         swSigue = 0;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |SIGUE;
     |FINSI;

     |SI swSigue = 0;
          nEmpCuad = 0;
          |ACABA;
     |SINO;
          |ABRE #labempre;
          #labempre#0 = nEmpCuad;
          |LEE 000#labempre.=;
          |CIERRA #labempre;
     |FINSI;

     |ABRE #nomcuadr; |LEE 000#nomcuadr.p; |CIERRA #nomcuadr;

     |SI #nomcuadr#4 ! #labempre#132; |Y #labempre#132 ! -1;
          |DDEF aDef;
          |QBF aDef;
          aOrigen = aDef + "nomycrys.inf";
          aDestino = aDef + "nomycrys.infcop";
          |COPIA_FICHERO aOrigen, aDestino;
          aOrigen = aDef + "nomycrys.rpt";
          aDestino = aDef + "nomycrys.rptcop";
          |COPIA_FICHERO aOrigen, aDestino;

          nCuadre = #labempre#132;
          |HAZ ConfCuadre;
     |FINSI;
|FPRC;

|PROCESO recupera_cuadres;
     |SI nEmpCuad ! 0;
          |DDEF aDef;
          |QBF aDef;
          aOrigen = aDef + "nomycrys.infcop";
          aDestino = aDef + "nomycrys.inf";
          |COPIA_FICHERO aOrigen, aDestino;
          aOrigen = aDef + "nomycrys.rptcop";
          aDestino = aDef + "nomycrys.rpt";
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

/****************************************************************************/
/*                 GRABACION DEL REGISTRO DE NOMINAS IMPRESAS               */
/****************************************************************************/

|PROCESO IniciaRegistro;
     |ABRE #nomnomin;
     |SELECT #2#nomnomin;
     |LEE 000#nomnomin.u;
     |SI FSalida = 0;
          nEmision = #nomnomin#12;
     |SINO;
          nEmision = 0;
     |FINSI;
     nEmision = nEmision + 1;
     |CIERRA #nomnomin;
|FPRC;

|PROCESO ActualizaRegistro;
     #nomnomin#10 = aHora;
     #nomnomin#11 = nContador2;
     |GRABA 000#nomnomin.a;
|FPRC;

|DEFBUCLE ActualizaRegistro;
     #nomnomin#2;
     ;
     nEmision;
     nEmision;
     ;
     NULL, ActualizaRegistro;
|FIN;

|PROCESO TerminaRegistro;
     |HORA aHora;
     |BUCLE ActualizaRegistro;
|FPRC;

|PROCESO nomnomin;
     nUltimo = #nomnomin#5;
|FPRC;

|DEFBUCLE nomnomin;
     #nomnomin#1;
     ;
     #10#1, #10#2, #10#18, #0#5, nTipoNom, 01;
     #10#1, #10#2, #10#18, #0#5, nTipoNom, 99;
     ;
     NULL, nomnomin;
|FIN;

|PROCESO GuardaRegistro;
     |ABRE #nomnomin;
     |SELECT #1#nomnomin;

     |SI #0#68 = "N";
          nTipoNom = 0;       || nomina mes
     |FINSI;
     |SI #0#68 = "P";
          nTipoNom = 1;       || paga
     |FINSI;
     |SI #0#68 = "F"; |O #0#10 = 2;
          nTipoNom = 2;       || finiquito
     |FINSI;

     nUltimo = 0;
     |BUCLE nomnomin;    || busco el ultimo, simepre acabo igual
     nRegistro = nUltimo + 1;

     #nomnomin#0 = #10#1;     || empresa
     #nomnomin#1 = #10#2;     || trabajador
     #nomnomin#2 = #10#18;    || a¤o
     #nomnomin#3 = #0#5;      || mes
     #nomnomin#4 = nTipoNom;  || tipo nomina
     #nomnomin#5 = nRegistro; || contador

     #nomnomin#6 = #10#6;     || nombre trabajador
     aAlfa = Usuario % 0810;
     #nomnomin#7 = aAlfa;   || usuario

     fFecha = ~;
     #nomnomin#8 = fFecha;
     |HORA aHora;
     #nomnomin#9 = aHora;
     #nomnomin#10 = "XX:XX:XX";
     #nomnomin#11 = 99999;
     #nomnomin#12 = nEmision;
     |GRABA 020#nomnomin.n;
     |LIBERA #nomnomin;
     |CIERRA #nomnomin;
|FPRC;

|PROCESO EmbargoPaga;
     |ABRE #nomimpr1;

     #nomimpr1#0 = #labtraba#0;
     #nomimpr1#1 = #labtraba#1;
     #nomimpr1#2 = #0#5;
     #nomimpr1#3 = 0;
     #nomimpr1#4 = #0#4 + 2000;
     |LEE 000#nomimpr1.=;
     |SI FSalida = 0; |Y #nomimpr1#10 ! 0;
          |SI #0#68 = "N";    || nomina
               |SI #0#67 = "M"; |Y #nomcalca#16 = #nomimpr1#8;
                    || desde mensual
                    nEmbargo = #nomcalca#104 - #nomimpr1#10;
               |FINSI;

               |SI #0#67 = "H"; |Y #nomhicca#16 = #nomimpr1#8;
                    || desde historico
                    nEmbargo = #nomhicca#146 - #nomimpr1#10;
               |FINSI;
          |FINSI;
          |SI #0#68 = "P";    || nomina
               |SI #0#67 = "M"; |Y #nomtmpca#16 = #nomimpr1#8;
                    || desde mensual
                    nEmbargo = #nomimpr1#10;
               |FINSI;

               |SI #0#67 = "H"; |Y #nomtmphc#16 = #nomimpr1#8;
                    || desde historico
                    nEmbargo = #nomimpr1#10;
               |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #nomimpr1;
|FPRC;

|PROCESO Pluriempleo;
     |SI #0#68 = "F";    || no se muy bien que habria que hacer aqui
          |ACABA;        || pero desde luego no tiene sentido usar estas bases
     |FINSI;

     |ABRE #nompluba;
     #nompluba#0 = #nomtrnom#1;
     #nompluba#1 = #nomtrnom#2;
     #nompluba#2 = #0#4 + 2000;
     #nompluba#3 = #0#5;
     #nompluba#4 = 0;
     |LEE 000#nompluba.=;
     |SI FSalida = 0;
          |SI #0#67 = "M";
               nNume = #nomcalca#80;
          |FINSI;
          |SI #0#67 = "H";
               nNume = #nomhicca#121;
          |FINSI;
          || este nNume se le restaba a cada base, pero realmente no tiene
          || sentido ya que la base de cotizacion empresarial no tiene que
          || estar en esta parte incluida, no se porque tiene que quitarla
          || el problema ha salido en una nomina con control de IT, por si
          || resulta que no habia que quitar esto
/*
          #nomtrnom#124 = #nompluba#6 - nNume;
          #nomtrnom#206 = #nompluba#8 - nNume;
          #nomtrnom#225 = #nompluba#5 - nNume;
          #nomtrnom#226 = #nompluba#6 - nNume;
          #nomtrnom#227 = #nompluba#7 - nNume;
          #nomtrnom#228 = #nompluba#8 - nNume;
*/
          #nomtrnom#124 = #nompluba#6;
          #nomtrnom#206 = #nompluba#8;
          #nomtrnom#225 = #nompluba#5;
          #nomtrnom#226 = #nompluba#6;
          #nomtrnom#227 = #nompluba#7;
          #nomtrnom#228 = #nompluba#8;

          |SI #nomtrnom#124 < 0; #nomtrnom#124 = 0; |FINSI;
          |SI #nomtrnom#206 < 0; #nomtrnom#206 = 0; |FINSI;
          |SI #nomtrnom#225 < 0; #nomtrnom#225 = 0; |FINSI;
          |SI #nomtrnom#226 < 0; #nomtrnom#226 = 0; |FINSI;
          |SI #nomtrnom#227 < 0; #nomtrnom#227 = 0; |FINSI;
          |SI #nomtrnom#228 < 0; #nomtrnom#228 = 0; |FINSI;
     |FINSI;
     |CIERRA #nompluba;
|FPRC;

|PROCESO UnidadesConcepto;
     || esto solo en Malpesa de momento
     || conceptos 108 y 134

     |SI concep ! 108; |Y concep ! 134;
          |ACABA;
     |FINSI;

     swSigue = 0;

     nEmp = #labempre#0;

     #labempre#0 = 1;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          aAlfa = #labempre#10;
          |QBF aAlfa;
          |SI aAlfa = "A23016157";
               swSigue = 1;
          |FINSI;
     |FINSI;

     #labempre#0 = nEmp;
     |LEE 000#labempre.=;

     |SI swSigue = 1;
          |QBF descri;
          aAlfa1 = unidad; |QBF aAlfa; aAlfa2 = valor; |QBF aAlfa2;
          descri = descri + " (" + aAlfa1 + "u. x " + aAlfa2 + ")";
     |FINSI;
|FPRC;

/****************************************************************************/
/*************    PROCESOS PARA MOSTRAR EL RESUMEN DE HORAS    **************/
/****************************************************************************/

|PROCESO Horas;

|FPRC;

|PROCESO FuerzaFiniqSep;
     |HAZ BuscaModulo;

     |SI swModulo ! 2884; |Y swModulo ! 1;
          |ACABA;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/adade005.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labempre#0;
     |LEE 000#500=;
     |SI FSalida = 0;
          #labempre#39 = 3;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO HorasFormacion;
     nNume = 0;
     |SI #labtraba#45 = "421";
          |SI #0#67 = "M";
               nNume = #nomcalca#64;
          |FINSI;
          |SI #0#67 = "H";
               nNume = #nomhicca#64;
          |FINSI;
          |SI nNume ! 0;
               aAlfa = nNume;
               aAlfa = "HFB: " + aAlfa;
               #10#200 = aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/****     PROCESOS PARA PINTAR EN EL RECIBO LA CUOTA EXONERADA DE ERTE ******/
/****************************************************************************/

|PROCESO ExoAlta;
     |SI nConcepto = 500; |O nConcepto = 509; |O nConcepto = 535;
     |O nConcepto = 501; |O nConcepto = 502;
     |O nConcepto = 594;
     |O nConcepto = 601; |O nConcepto = 603; |O nConcepto = 634;
     |O nConcepto = 611; |O nConcepto = 613; |O nConcepto = 635;
     |O nConcepto = 701; |O nConcepto = 705; |O nConcepto = 708;
     |O nConcepto = 702; |O nConcepto = 706; |O nConcepto = 709;
     |O nConcepto = 703; |O nConcepto = 707; |O nConcepto = 710;
          nExoneracion = nExoneracion + ((((#501#12 % #501#15) ! 2) % #500#101) ! 2);
     |FINSI;
|FPRC;

|PROCESO ExoERE;
     |SI nConcepto = 509; |O nConcepto = 536; |O nConcepto = 596;
     |O nConcepto = 603; |O nConcepto = 636;
     |O nConcepto = 613; |O nConcepto = 637;
     |O nConcepto = 705; |O nConcepto = 711;
     |O nConcepto = 706; |O nConcepto = 712;
     |O nConcepto = 707; |O nConcepto = 713;
          nExoneracion = nExoneracion + ((((#501#12 % #501#15) ! 2) % #500#99) ! 2);
     |FINSI;
|FPRC;

|PROCESO nomcot03;
     || nBase = nBase + #501#12;
     nConcepto = #501#10;
     |SI #500#27 = "ERE";
          |HAZ ExoERE;
     |FINSI;
     |SI #500#27 = "ETP";
          |HAZ ExoERE;
          |HAZ ExoAlta;
     |FINSI;
     |SI #500#27 ! "ERE"; |Y #500#27 ! "ETP";
          |HAZ ExoAlta;
     |FINSI;
|FPRC;

|DEFBUCLE nomcot03;
     #501#1009;
     ;
     #labtraba#0, nElAny, #0#5, 0, aAlfa1, aAlfa3, #500#6, #labtraba#1, 500;
     #labtraba#0, nElAny, #0#5, 0, aAlfa2, aAlfa4, #500#6, #labtraba#1, 999;
     ;
     NULL, nomcot03;
|FIN;

|PROCESO nomcot02;
/*
     nPorExoCOVID = #500#99;
     |SI #500#27 = "ERE"; |Y nPorExoCOVID ! 0;
          nConcepto = 509;
          |BUCLE nomcot03;
     |FINSI;
     |SI #500#27 = "ETP"; |Y nPorExoCOVID ! 0;
          nConcepto = 536;
          |BUCLE nomcot03;
     |FINSI;
*/
     nPorExoCOVID = #500#99 + #500#101;
     |SI nPorExoCOVID ! 0;
          |BUCLE nomcot03;
     |FINSI;
|FPRC;

|DEFBUCLE nomcot02;
     #500#1008;
     ;
     #labtraba#0, nElAny, #0#5, 0, aAlfa1, aAlfa3, 01, #labtraba#1;
     #labtraba#0, nElAny, #0#5, 0, aAlfa2, aAlfa4, 31, #labtraba#1;
     ;
     NULL, nomcot02;
|FIN;

|PROCESO SistemaNuevo;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomcot02.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomcot03.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiade2@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     swSigue = 0;
     aAlfa1 = "               ";
     aAlfa2 = "zzzzzzzzzzzzzzz";
     aAlfa3 = "           ";
     aAlfa4 = "zzzzzzzzzzz";
     nBase = 0;
     nPorExoCOVID = 0;
     |BUCLE nomcot02;
     |SI nExoneracion ! 0;
          swSigue = 1;
          nNume1 = nBase;
          nNume2 = #labtraba#219;
     |FINSI;

     |DESCARGA_DEF #copiade2@;
     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO SistemaAntiguo;
     nNume1 = 0;
     nNume2 = #labtraba#219;
     |PARA i = 186; |SI i [ 189; |HACIENDO i = i + 1;
          |SI #nomtrnom#i# = "Desempleo "; |Y #labtraba#188 = "S";
               |SI #0#67 = "M";
                    nNume1 = #nomcalca#128;
                    swSigue = 1;
               |FINSI;
               |SI #0#67 = "H";
                    nNume1 = #nomhicca#170;
                    swSigue = 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ExoCOVID;
     nExoneracion = 0;
     swSigue = 0;

     |SI #labtraba#45 = 421; |O #labtraba#45 = 422;
          || formacion con cuotas exoneradas, no aplico exoneracion aunque haya
          |ACABA;
     |FINSI;

     |HAZ SistemaNuevo;
     |SI swSigue = 0;
          |HAZ SistemaAntiguo;
     |FINSI;
     |SI swSigue = 1;
          aAlfa1 = nNume1; |QBF aAlfa1;      || base ERTE
          aAlfa2 = nNume2; |QBF aAlfa2;      || % exoneracion
          nNume3 = (nNume1 % nNume2) ! 2;    || base exonerada
          aAlfa3 = nNume3; |QBF aAlfa3;
          |SI nExoneracion = 0;
               aAlfa = "(*) Aplicada la exoneraci¢n del " + aAlfa2 + "% de la cuota ";
               aAlfa = aAlfa + "empresarial, dependientes de la base en ERTE ";
               aAlfa = aAlfa + aAlfa3 + " euros.";
          |SINO;
               aAlfa = nExoneracion;
               aAlfa = "(*) Aplicada la exoneraci¢n de " + aAlfa + " euros sobre la cuota empresarial.";
          |FINSI;
          #nomtrnom#235 = aAlfa;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  CAMPOS DE SEGURIDAD SOCIAL A CARGO DE LA EMPRESA ***********/
/****************************************************************************/

|PROCESO SS_Empresa;
     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "nomareci";
          #0#67 = "T";
          || ya me viene al a¤o;
     |SINO;
          nElAny = #0#4 + 2000;
     |FINSI;

     nHorasFM = 0;
     nHorasNor = 0;

     |SI #0#67 = "M";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo - 35;
               #nomtrnom#nCampo# = #nomcalca#nCampo1#;
               |SI nCampo = 209;
                    |SI #nomcalca#164 ! 0; || cotizacion solidaridad
                         #nomtrnom#nCampo# = #nomcalca#164;
                    |FINSI;
               |FINSI;
          |SIGUE;

          nHorasFM = #nomcalca#41;
          nHorasNor = #nomcalca#42;
          |HAZ HorasFormacion;
          #nomtrnom#216 = #nomcalca#79;
          #nomtrnom#224 = #nomcalca#80;

          |SI Impresora ! "CrystalReport";
          |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomcalca#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomcalca#40;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#67 = "H"; |O #0#67 = "T";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo + 7;
               |SI #0#67 = "H";
                    #nomtrnom#nCampo# = #nomhicca#nCampo1#;
               |FINSI;
               |SI #0#67 = "T";
                    #nomtrnom#nCampo# = #nomtrnom#nCampo# + #nomhicca#nCampo1#;
               |FINSI;
               |SI nCampo = 209;
                    |SI #nomhicca#206 ! 0; || cotizacion solidaridad
                         |SI #0#67 = "H";
                              #nomtrnom#nCampo# = #nomhicca#206;
                         |FINSI;
                         |SI #0#67 = "T";
                              #nomtrnom#nCampo# = #nomtrnom#nCampo# + #nomhicca#206;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;

          nHorasFM = #nomhicca#41;
          nHorasNor = #nomhicca#42;

          |HAZ HorasFormacion;

          |SI #0#67 = "H";
               #nomtrnom#216 = #nomhicca#121;
               #nomtrnom#224 = #nomhicca#122;
          |FINSI;
          |SI #0#67 = "T";
               #nomtrnom#216 = #nomtrnom#216 + #nomhicca#121;
               #nomtrnom#224 = #nomtrnom#224 + #nomhicca#122;
          |FINSI;
          |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomhicca#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomhicca#40;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#67 = "A";
          |PARA nCampo = 208; |SI nCampo [ 215; |HACIENDO nCampo = nCampo + 1;
               nCampo1 = nCampo - 35;
               #nomtrnom#nCampo# = #nomtrnom#nCampo# + #nomcalac#nCampo1#;
          |SIGUE;
          |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
               |SI nOpcion = 0; |O nOpcion = 1;
                    || impresion en Word: hay que sumarle la cot. del trab.
                    || como en enom
                    #nomtrnom#216 = #nomtrnom#216 + #nomcalac#39;
                    #nomtrnom#224 = #nomtrnom#224 + #nomcalac#40;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI Impresora ! "CrystalReport"; |Y #0#69 ! "P";
          |SI nOpcion = 0; |O nOpcion = 1;
               || bonificaciones en negativo en word
               #nomtrnom#215 = #nomtrnom#215 * (-1);
          |FINSI;
     |FINSI;

     ||SI #labtraba#42 = "E"; |Y #labtraba#241 = "N"; |Y #labtraba#138 = "N";

     || el total:
     #nomtrnom#223 = #nomtrnom#208 + #nomtrnom#209 + #nomtrnom#210;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#211 + #nomtrnom#212;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#214;
     #nomtrnom#223 = #nomtrnom#223 + #nomtrnom#215; || (bonif en negativo)

     || los tipos:

     #nomtrnom#217 = #nomconst#6;  || cc
     |SI #labtraba#112 = "S";
          || compruebo el campo de contrato inferior a 7 dias igual a "S"
          |SI nElAny [ 2018;
               #nomtrnom#217 = #nomtrnom#217 * 1.36;
          |SINO;
               #nomtrnom#217 = #nomtrnom#217 * 1.40;
          |FINSI;
     |FINSI;
     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          |SI #labtraba#33 = 01;
               #nomtrnom#217 = 23.60;       || cc
          |FINSI;
     |FINSI;
     #nomtrnom#218 = #nomconst#12; || Des
     #nomtrnom#219 = #nomconst#14; || Fog
     #nomtrnom#220 = #nomconst#16; || FP

     |SI #nomconst#92 ! 0;
          #nomtrnom#218 = #nomconst#92; || Des
     |FINSI;
     |SI nHorasFM ! 0;
          #nomtrnom#222 = #nomconst#8;  || H.Ex. FM
     |FINSI;
     |SI nHorasNor ! 0;
          #nomtrnom#222 = #nomconst#10;  || H.Ex. Nor
     |FINSI;
     |MODULO aAlfa;
     |SI aAlfa = "nomareci";
          || ya me viene al a¤o;
     |SINO;
          nElAny = #0#4 + 2000;
     |FINSI;
     nElMes = 1;

     |HAZ ValoresITIMS;
     |HAZ VerifCNAE;

     |SI #labtraba#45 = 421; |Y nElAny = 2017;
          |SI #nomtrnom#210 = 2.35; #nomtrnom#210 = 2.53; |FINSI;
          |SI #nomtrnom#211 = 1.14; #nomtrnom#211 = 1.24; |FINSI;
     |FINSI;

     |ABRE #nomepigr;
     |DDEFECTO #nomepigr;
     #nomepigr#0  = nEpigConv;
     |LEE 000#nomepigr.=;            || lee epigrafe
     |SI FSalida = 0;
          #nomtrnom#221 = #nomepigr#1 + #nomepigr#2;   || ATEP
     |FINSI;
     |CIERRA #nomepigr;

     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "nomareci";
          #0#67 = "H";   || lo dejo como estaba, por si acaso
     |FINSI;

     |HAZ ExoCOVID;
|FPRC;

/****************************************************************************/
/**************  LITERALES DEL RECIBO, SEGUN IDIOMA   ***********************/
/****************************************************************************/

|PROCESO Literales;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aDestino = aContiene1; |QBF aDestino;

     |DFICB aOrigen; |QBF aOrigen;
     || aOrigen = aOrigen + "nomlinom.dbf";

     |SI #0#68 ! "F";
          aOrigen = aOrigen + "nomlinom.dbf";
          aDestino = aDestino + "crystal/literales.dbf";
     |SINO;
          aOrigen = aOrigen + "nomlifin.dbf";
          aDestino = aDestino + "crystal/literales.dbf";
     |FINSI;

     aIP = ""; |IP_REMOTO aIP;

     |SI aIP = "";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          |ENVIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

/****************************************************************************/
/**************  PARAMETROS DE RECIBO POR EMPRESA  **************************/
/****************************************************************************/

|PROCESO ParamEmpresa;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomcont2.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiade2@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |ABRE #nomcont1;
     |LEE 000#nomcont1.p;
     |SI FSalida ! 0;
          |DDEFECTO #nomcont1;
     |FINSI;
     |SI enSwSimulacion = 1; #nomcont1#8 = "S"; |FINSI;
     |CIERRA #nomcont1;

     |ABRE #501;
     #501#0 = #labempre#0;
     |LEE 000#501=;
     |SI FSalida = 0;
          |PARA nCampo = 1; |SI nCampo [ 16; |HACIENDO nCampo = nCampo + 1;
               #nomcont1#nCampo# = #501#nCampo#;
          |SIGUE;
          swParamEmpresa = 1;
          |SI enSwSimulacion = 1; #501#8 = "S"; |FINSI;
     |FINSI;
     |CIERRA #501;

     |DESCARGA_DEF #copiade2@;
|FPRC;

/****************************************************************************/
/************* PAGAS PRORRATEADAS EN REMUNERACION Y NO EN PRORRATA **********/
/****************************************************************************/

|PROCESO PagasProrr;
     |SI concep ] 201; |Y concep [ 208; |Y #0#10 = 0;
          |ABRE #nomconca;
          #nomconca#0 = #2#87;
          #nomconca#2 = concep;
          |LEE 000#nomconca.=;
          |SI FSalida ! 0;
               |CIERRA #nomconca;
               |ACABA;
          |FINSI;

          numer = concep - 200 + 19;
          numerl = concep - 88;
          |SI #0#68 = "N"; |Y incluye = 1;
               |SI #labtraba#numerl# = "S"; |O #nomconca#numer# = 99;
                    #10#119 = #10#119 + (import ! 2);
                    #10#120 = #10#120 - ((uniant * valor) ! 2);
                    /*
                    |SI -0.04 [ #10#120; |Y #10#120 [ 0.04;
                         #10#120 = 0;
                    |FINSI;
                    */
               |FINSI;
          |FINSI;
          |CIERRA #nomconca;
     |FINSI;
|FPRC;

|PROCESO ComentariosLabempre;
     #10#169 = "";
     #10#170 = "";
     #10#171 = "";
     #10#197 = "";
     #10#176 = "Anticipos P.Extra";

     |SI #10#160 ! 0;
          aAlfa = #nomhicca#227;
          |QBF aAlfa;
          |SI aAlfa = "";
               aAlfa = #labempre#61; |QBF aAlfa;
               |SI aAlfa = " nticipos"; aAlfa = "Anticipos"; |FINSI;
               #10#169 = aAlfa;
          |SINO;
               #10#169 = aAlfa;
          |FINSI;
     |FINSI;
     |SI #10#161 ! 0;
          aAlfa = #nomhicca#228;
          |QBF aAlfa;
          |SI aAlfa = "";
               aAlfa = #labempre#62; |QBF aAlfa;
               |SI aAlfa = " nticipos"; aAlfa = "Anticipos"; |FINSI;
               #10#170 = aAlfa;
          |SINO;
               #10#170 = aAlfa;
          |FINSI;
     |FINSI;
     |SI #10#196 ! 0;
          aAlfa = #nomhicca#229;
          |QBF aAlfa;
          |SI aAlfa = "";
               aAlfa = #labempre#63; |QBF aAlfa;
               |SI aAlfa = " nticipos"; aAlfa = "Anticipos"; |FINSI;
               #10#197 = aAlfa;
          |SINO;
               #10#197 = aAlfa;
          |FINSI;
     |FINSI;

     || para embargos
     || en el mismo campo que anticipos 3, si algun dia coincidieran ya veriamos
     |SI #0#69 ! "A"; || no en la abierta
          |SI #nomcalca#104 ! 0; |O #11#146 ! 0; |O #93#104 ! 0;    || tengo embargo
               #10#197 = "Embargos Salario"
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CC_Excluidas;
     |ABRE #nomnotan;
     #nomnotan#0 = #labtraba#0;
     #nomnotan#1 = #labtraba#77;
     |LEE 000#nomnotan.=;
     |SI FSalida = 0;
          |SI #0#67 = "M";    || desde mensual
               || parte del trabajador
               #10#124 = #4#48 + #4#167;      || base excluida
               #10#162 = #nomnotan#3;             || % exclusion
               #10#164 = (-1) * #4#167;      || cuota excluida
               #10#131 = #10#124;
               #10#206 = 0;

               || parte de la empresa
               #10#224 = 0;                   || que no aparezca base

               || uso la parte del pluriempleo, para ATEP
               #10#225 = #10#123;             || base (la de comunes p.ej.)
                                             || (si son distintas CC y CP, malo)
               || cuota excluida empresa
               #10#230 = #4#166;
          |FINSI;
          |SI #0#67 = "H";    || desde historico
               || parte del trabajador
               #10#124 = #11#48 + #11#209;      || base excluida
               #10#162 = #nomnotan#3;             || % exclusion
               #10#164 = (-1) * #11#209;      || cuota excluida
               #10#131 = #10#124;
               #10#206 = 0;

               || parte de la empresa
               #10#224 = 0;                   || que no aparezca base

               || uso la parte del pluriempleo, para ATEP
               #10#225 = #10#123;             || base (la de comunes p.ej.)
                                             || (si son distintas CC y CP, malo)
               || cuota excluida empresa
               #10#230 = #11#208;
          |FINSI;
     |FINSI;
     |CIERRA #nomnotan;

|FPRC;

|PROCESO Auxiliar;
     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/nomcalap.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = nEmp;
     #500#1 = nTra;
     #500#2 = #0#4 + 2000;
     #500#3 = #0#5;
     #500#4 = 0;
     |LEE 000#500=;
     |SI FSalida = 0;
          #labempre#25 = #500#5;
          nPos = 1;
          |PARA nCampo = 113; |SI nCampo [ 120; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #500#6;
               nPos = nPos + 100;
               #labtraba#nCampo# = aAlfa % nPos;
          |SIGUE;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

/****************************************************************************/
/*************      PROCESOS PARA GRABA EL JSON PARA LABORBOX    ************/
/****************************************************************************/

|PROCESO ConvierteUTF8;
     ||Se basa en los famosos quitararos

     ||e acentuada es \u00e9

     aAlfa = aTextoUtf8;
     |QBF aAlfa;

     aCadena = "";
     aLen    = aAlfa % 0;
     nLen    = aLen;
     |PARA nCampos = 1;  |SI nCampos [ nLen;  |HACIENDO nCampos = nCampos + 1;
          nPos       = (100 * nCampos) + 1;
          aCaracRaro = aAlfa % nPos;

          nValor = &aCaracRaro;

          |SI nValor > 127;
               aValor = "";
               |SI nValor = "164"; aValor = "\u00f1"; |FINSI;    || eny
               |SI nValor = "165"; aValor = "\u00d1"; |FINSI;    || ENYE
               |SI nValor = "209"; aValor = "\u00d1"; |FINSI;    || ENYE

               |SI nValor = "160"; aValor = "\u00e1"; |FINSI;    || a acento
               |SI nValor = "130"; aValor = "\u00e9"; |FINSI;    || e acento
               |SI nValor = "161"; aValor = "\u00ed"; |FINSI;    || i acento
               |SI nValor = "162"; aValor = "\u00f3"; |FINSI;    || o acento
               |SI nValor = "163"; aValor = "\u00fa"; |FINSI;    || u acento

               |SI nValor = "133"; aValor = "\u00e0"; |FINSI;    || a acento cerrado
               |SI nValor = "149"; aValor = "\u00f2"; |FINSI;    || o acento cerrado

               |SI nValor = "135"; aValor = "\u00e7"; |FINSI;    || c cedilla
               |SI nValor = "128"; aValor = "\u00c7"; |FINSI;    || C cedilla

               |SI nValor = "166"; aValor = "\u00aa"; |FINSI;    || ordinar femenino
               |SI nValor = "170"; aValor = "\u00aa"; |FINSI;    || ordinar femenino
               |SI nValor = "167"; aValor = "\u00ba"; |FINSI;    || ordinar maculino

               |SI nValor = "129"; aValor = "\u00fc"; |FINSI;    || u con dieresis
               |SI nValor = "154"; aValor = "\u00dc"; |FINSI;    || U con dieresis

               |SI nValor = "181"; aValor = "\u00c1"; |FINSI;    || A acento
               |SI nValor = "144"; aValor = "\u00c9"; |FINSI;    || E acento
               |SI nValor = "214"; aValor = "\u00cd"; |FINSI;    || I acento
               |SI nValor = "224"; aValor = "\u00d3"; |FINSI;    || O acento
               |SI nValor = "233"; aValor = "\u00da"; |FINSI;    || U acento

               |SI aValor = "";
                   aValor = "(" + nValor + ") ";
                   || aCadena = aCadena + aCaracRaro + aValor;
                   || De esta forma no petara, e incluso se puede controlar desde python.
                   aCadena = aCadena + aValor;
               |SINO;
                   aCadena = aCadena + aValor;
               |FINSI;
          |SINO;
               aCadena = aCadena + aCaracRaro;
          |FINSI;
     |SIGUE;
     aTextoUtf8 = aCadena;
|FPRC;

|PROCESO Formatea2;
     |SI swFormatea = 0;
          |ACABA;
     |FINSI;

     swNumero = 0;
     swNegativo = 0;
     aAlfa1 = aValor;
     |QBT aAlfa1;
     nNume1 = aAlfa1;
     aAlfa2 = nNume1
     |QBT aAlfa2;

     |SI aAlfa1 = aAlfa2;
          swNumero = 1;
          |SI aAlfa1 = "0"; |O aAlfa1 = "-0";
               swNumero = 0;
               aValor = "";
          |FINSI;
     |FINSI;

     |SI swNumero = 1;
          aAlfa = aValor % 101;
          |SI aAlfa = "-";
               swNegativo = 1;
               aValor = aValor - "-";
          |FINSI;

          aPunto = aValor % -201;
          |SI aPunto = "."; |O aPunto = ",";
               aValor = aValor + "0";
          |FINSI;
          aPunto = aValor % -301;
          |SI aPunto ! "."; |Y aPunto ! ",";
               aValor = aValor + ".00";
          |FINSI;
          aLon = aValor % 0;
          nLon = aLon;
          |SI nLon > 6;
               aAlfa1 = aValor % -106;
               aAlfa2 = aValor - aAlfa1;
               aValor = aAlfa2 + "." + aAlfa1;
          |FINSI;
     |FINSI;

     aAlfa1 = aValor % -101;
     |SI aAlfa1 = "%";
          swNumero = 2;  || porcentaje
          aValor = aValor - "%";
          aPunto = aValor % -201;
          |SI aPunto = "."; |O aPunto = ",";
               aValor = aValor + "0";
          |FINSI;
          aPunto = aValor % -301;
          |SI aPunto ! "."; |Y aPunto ! ",";
               aValor = aValor + ",00";
          |FINSI;
     |FINSI;

     aAlfa = aValor % -301;
     |SI aAlfa = ".";
          aLon = aValor % 0;
          nLon = aLon;
          nNume = 100 + (nLon - 3);
          aValor = (aValor % nNume) + "," + (aValor % -102);
     |FINSI;
     |SI swNumero = 2;
          aValor = aValor + "%";
     |FINSI;
     |SI swNegativo = 1;
          aValor = "-" + aValor;
     |FINSI;
|FPRC;

|PROCESO GrabaLinea;
     |QBF aValor;

     aTextoUtf8 = aCampo;
     |HAZ ConvierteUTF8;
     aCampo = aTextoUtf8;

     aTextoUtf8 = aValor;
     |HAZ ConvierteUTF8;
     aValor = aTextoUtf8;

     |HAZ Formatea2;

     |SI aLinea = "";
          aLinea = &34 + aCampo + &34 + ": ";
          aLinea = aLinea + &34 + aValor + &34;

          |SI swFinBloque = 0;
               aLinea = aLinea + ",";
          |FINSI;
     |FINSI;

     |SI nNivel = 0;
          aLinea = aLinea;
     |FINSI;
     |SI nNivel = 1;
          aLinea = &9 + aLinea;
     |FINSI;
     |SI nNivel = 2;
          aLinea = &9 + &9 + aLinea;
     |FINSI;
     |SI nNivel = 3;
          aLinea = &9 + &9 + &9 + aLinea;
     |FINSI;
     |SI nNivel = 4;
          aLinea = &9 + &9 + &9 + &9 + aLinea;
     |FINSI;
     |SI nNivel = 5;
          aLinea = &9 + &9 + &9 + &9 + &9 + aLinea;
     |FINSI;

     |XGRABA nHandle, aLinea;
     aLinea = "";
|FPRC;

|PROCESO DetalleJSON;
     swFormatea = 0;

     nNivel = 1;
     aLinea = &34 + "detalle" + &34 + ": [";
     |HAZ GrabaLinea;

     aLinea = "]";
     |HAZ GrabaLinea;

     nNivel = 0;
     aLinea = "}";
     |HAZ GrabaLinea;
|FPRC;

|PROCESO Variables;
     swFormatea = 0;
     aCampo = "GrupoCotiz"; aValor = #labtraba#33;
     |QBF aValor; aValor = ("00" + aValor) % -102;
     |HAZ GrabaLinea;

     swFormatea = 0;
     aCampo = "diasnomina"; aValor = #nomtrnom#19;
     |HAZ GrabaLinea;
     aCampo = "LiteralCC"; aValor = #nomlinom#36;
     |HAZ GrabaLinea;

     aCampo = "LiteralDesempleo";
     |SI 1.90 [ #nomtrnom#162; |Y #nomtrnom#162 [ 2.10;
          aValor = "Cotizaci¢n de solidaridad";
     |SINO;
          |SI 0.90 [ #nomtrnom#162; |Y #nomtrnom#162 [ 1.10;
               aValor = "Contingencias excluidas";
          |SINO;
               aValor = #nomlinom#37;
          |FINSI;
     |FINSI;
     |HAZ GrabaLinea;

     aCampo = "LiteralFP"; aValor = #nomlinom#38;
     |HAZ GrabaLinea;
     aCampo = "LiteralHorasNoEst"; aValor = #nomlinom#41;
     |HAZ GrabaLinea;

     aCampo = "LiteralDesempleoEmpresa";
     |SI 1.90 [ #nomtrnom#162; |Y #nomtrnom#162 [ 2.10;
          aValor = #nomlinom#73;
     |SINO;
          |SI 0.90 [ #nomtrnom#162; |Y #nomtrnom#162 [ 1.10;
               aValor = #nomlinom#74;
          |SINO;
               aValor = #nomlinom#63;
          |FINSI;
     |FINSI;
     |HAZ GrabaLinea;

     swFormatea = 1;

     aCampo = "BaseCC";
     nNume = #nomtrnom#123 + #nomtrnom#216;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TipoCC";
     nNume = #nomtrnom#217;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "BaseATEP";
     |SI #nomtrnom#225 = 0; |Y #nomtrnom#230 = 0;
          nNume = #nomtrnom#124 + #nomtrnom#224;
     |SINO;
          nNume = #nomtrnom#225 + #nomtrnom#224;
     |FINSI;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TipoATEP";
     nNume = #nomtrnom#221;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "BaseDesempleo";
     |SI #nomtrnom#226 = 0; |Y #nomtrnom#230 = 0;
          nNume = #nomtrnom#124 + #nomtrnom#224;
     |SINO;
          nNume = #nomtrnom#226 + #nomtrnom#224;
     |FINSI;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TipoDesempleo";
     nNume = #nomtrnom#218;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "BaseFP";
     |SI #nomtrnom#228 = 0; |Y #nomtrnom#230 = 0;
          nNume = #nomtrnom#124 + #nomtrnom#224;
     |SINO;
          nNume = #nomtrnom#228 + #nomtrnom#224;
     |FINSI;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TipoFP";
     nNume = #nomtrnom#220;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "BaseFOGASA";
     |SI #nomtrnom#227 = 0; |Y #nomtrnom#230 = 0;
          nNume = #nomtrnom#124 + #nomtrnom#224;
     |SINO;
          nNume = #nomtrnom#227 + #nomtrnom#224;
     |FINSI;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TipoFOGASA";
     nNume = #nomtrnom#219;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "TipoHoras";
     nNume = #nomtrnom#222;
     aValor = nNume; |QBF aValor; aValor = aValor + "%";
     |HAZ GrabaLinea;

     aCampo = "Bonificaciones";
     nNume = #nomtrnom#215 * (-1);
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "Excluidas";
     nNume = #nomtrnom#230;
     aValor = nNume;
     |HAZ GrabaLinea;

     aCampo = "TotalAportacionEmpresarial";
     nNume = #nomtrnom#208 + #nomtrnom#212 + #nomtrnom#209 + #nomtrnom#211;
     nNume = nNume + #nomtrnom#210 + #nomtrnom#216 - #nomtrnom#217;
     aValor = nNume;
     |HAZ GrabaLinea;
|FPRC;

|PROCESO OtrosCampos;
     || esto no son variables, son campos directamente

     swFormatea = 0;
     aCampo = "labtraba2d"; aValor = #labtraba#45;     || contrato
     |HAZ GrabaLinea;

     swFormatea = 1;

     aCampo = "bextras";
     |SI #nomtrnom#214 = 0;
          aValor = "";
     |SINO;
          nNume = #nomtrnom#125 + #nomtrnom#126;
          aValor = nNume;
     |FINSI;
     |HAZ GrabaLinea;

     aCampo = "birpf";
     nNume = #nomtrnom#153 + #nomtrnom#154 + #nomtrnom#155;
     aValor = nNume;
     |HAZ GrabaLinea;
|FPRC;

|PROCESO CabeceraJSON;
     swFinBloque = 0;

     swFormatea = 0;

     nNivel = 0;
     aLinea = "{";
     |HAZ GrabaLinea;

     nNivel = 1;
     aCampo = "nombre"; aValor = "Simulaci¢n de costes";
     |HAZ GrabaLinea;

     aLinea = &34 + "cabecera" + &34 + ": [";
     |HAZ GrabaLinea;

     nNivel = 2;
     aLinea = "{";
     |HAZ GrabaLinea;

     |PARA nCampo = 000; |SI nCampo [ 234; |HACIENDO nCampo = nCampo + 1;
          aAlfa = "nomtrnom";

          nNume = nCampo;
          nNume1 = ((nNume / 16) - 0.49);
          |SI nNume1 < 0;
               nNume1 = nNume1 * (-1);
          |FINSI;
          nNume1 = nNume1 ! 0;

          |SI nNume1 [ 9;
               aAlfa1 = nNume1;
          |SINO;
               |SI nNume1 = 10; aAlfa1 = "a"; |FINSI;
               |SI nNume1 = 11; aAlfa1 = "b"; |FINSI;
               |SI nNume1 = 12; aAlfa1 = "c"; |FINSI;
               |SI nNume1 = 13; aAlfa1 = "d"; |FINSI;
               |SI nNume1 = 14; aAlfa1 = "e"; |FINSI;
               |SI nNume1 = 15; aAlfa1 = "f"; |FINSI;
          |FINSI;

          nNume2 = (nNume $ 16);
          |SI nNume2 [ 9;
               aAlfa2 = nNume2;
          |SINO;
               |SI nNume2 = 10; aAlfa2 = "a"; |FINSI;
               |SI nNume2 = 11; aAlfa2 = "b"; |FINSI;
               |SI nNume2 = 12; aAlfa2 = "c"; |FINSI;
               |SI nNume2 = 13; aAlfa2 = "d"; |FINSI;
               |SI nNume2 = 14; aAlfa2 = "e"; |FINSI;
               |SI nNume2 = 15; aAlfa2 = "f"; |FINSI;
          |FINSI;

          aAlfa = aAlfa + aAlfa1 + aAlfa2;
          aCampo = aAlfa;

          aValor = #nomtrnom#nCampo#;

          |SI nCampo [ 19;
               swFormatea = 0;
          |SINO;
               swFormatea = 1;
          |FINSI;

          |HAZ GrabaLinea;
     |SIGUE;

     |HAZ Variables;
     |HAZ OtrosCampos;

     || por ultimo los literales

     swFormatea = 0;

     |PARA nCampo = 000; |SI nCampo [ 89; |HACIENDO nCampo = nCampo + 1;
          aAlfa = "nomlinom";
          aAlfa1 = nCampo; |QBF aAlfa1;
          aAlfa = "c" + aAlfa1;
          aCampo = aAlfa;

          aValor = #nomlinom#nCampo#;

          |SI nCampo = 89;
               swFinBloque = 1;
          |FINSI;
          |HAZ GrabaLinea;
     |SIGUE;


     nNivel = 2;
     aLinea = "}";
     |HAZ GrabaLinea;

     nNivel = 1;
     aLinea = "],";
     |HAZ GrabaLinea;
|FPRC;

|PROCESO GrabaDatos;
     |DFICE aPath;
     aDes = aPath + eaFichSimBox + ".json";
     |FBORRA aDes;
     |XABRE "A", aDes, nHandle;
     |SI FSalida ] 0;
          |ABRE #nomlinom;
          #nomlinom#0 = #labtraba#136;
          |LEE 000#nomlinom.=;
          |CIERRA #nomlinom;

          |HAZ CabeceraJSON;
          |HAZ DetalleJSON;
     |FINSI;
     |XCIERRA nHandle;
|FPRC;

/****************************************************************************/
/*********      PASO DE IMPORTES A LETRAS EN CATALAN     ********************/
/****************************************************************************/

|VARIABLES;
    &rlecan  = 0;
    rlemax  = 0;
    jkl     = 0;
    r1      = 0;
    r2      = 0;
    r3      = 0;
    r4      = 0;
    r5      = 0;
    r6      = 0;
    r7      = 0;
    r8      = 0;
    r9      = 0;
    aa      = 0;
    bb      = 0;
    jj      = 0;

    &rlsali  = "";
    rlsala  = "";
    rctraba = "";
    ra      = "";
    rc      = "";
    rd      = "";
    rf      = "";

    &rprim  = "";
    &rsegu  = "";
    &dia    = "";
    &mes    = "";
    &anyo   = "";

  {-1} fg   =  "";
/*
       fg1  =  "UNA ";
       fg2  =  "DUES "
       fg3  =  "TRES ";
       fg4  =  "QUA-TRE ";
       fg5  =  "CINC ";
       fg6  =  "SIS ";
       fg7  =  "SET ";
       fg8  =  "VUIT ";
       fg9  =  "NOU ";
       fg10 =  "DEU ";
       fg11 =  "ONZE ";
       fg12 =  "DOT-ZE ";
       fg13 =  "TRET-ZE ";
       fg14 =  "CA-TOR-ZE ";
       fg15 =  "QUIN-ZE ";
       fg16 =  "SET-ZE ";
       fg17 =  "DI-SSET ";
       fg18 =  "DI-VUIT ";
       fg19 =  "DI-NOU ";
       fg20 =  "VINT ";
       fg21 =  "TREN-TA ";
       fg22 =  "QUA-RAN-TA ";
       fg23 =  "CIN-QUAN-TA ";
       fg24 =  "SEI-XAN-TA ";
       fg25 =  "SE-TAN-TA ";
       fg26 =  "VUI-TAN-TA ";
       fg27 =  "NO-RAN-TA ";
       fg28 =  "CENT ";
       fg29 =  "CENT ";
       fg30 =  "DUES-CEN-TES ";
       fg31 =  "TRES-CEN-TES ";
       fg32 =  "QUA-TRE-CEN-TES ";
       fg33 =  "CINC-CEN-TES ";
       fg34 =  "SIS-CEN-TES ";
       fg35 =  "SET-CEN-TES ";
       fg36 =  "VUIT-CEN-TES ";
       fg37 =  "NOU-CEN-TES ";
       fg38 =  "VINT.I ";
       fg39 =  "MIL ";
       fg40 =  "MILIO  ";
       fg41 =  "MILIONS ";
       fg42 =  "PE-SSE-TA ";
       fg43 =  "PE-SSE-TES ";
*/
       fg1  =  "UN ";
       fg2  =  "DOS "
       fg3  =  "TRES ";
       fg4  =  "QUA-TRE ";
       fg5  =  "CINC ";
       fg6  =  "SIS ";
       fg7  =  "SET ";
       fg8  =  "VUIT ";
       fg9  =  "NOU ";
       fg10 =  "DEU ";
       fg11 =  "ONZE ";
       fg12 =  "DOT-ZE ";
       fg13 =  "TRET-ZE ";
       fg14 =  "CA-TOR-ZE ";
       fg15 =  "QUIN-ZE ";
       fg16 =  "SET-ZE ";
       fg17 =  "DI-SSET ";
       fg18 =  "DI-VUIT ";
       fg19 =  "DI-NOU ";
       fg20 =  "VINT ";
       fg21 =  "TREN-TA ";
       fg22 =  "QUA-RAN-TA ";
       fg23 =  "CIN-QUAN-TA ";
       fg24 =  "SEI-XAN-TA ";
       fg25 =  "SE-TAN-TA ";
       fg26 =  "VUI-TAN-TA ";
       fg27 =  "NO-RAN-TA ";
       fg28 =  "CENT ";
       fg29 =  "CENT ";
       fg30 =  "DUES-CEN-TS ";
       fg31 =  "TRES-CEN-TS ";
       fg32 =  "QUA-TRE-CEN-TS ";
       fg33 =  "CINC-CEN-TS ";
       fg34 =  "SIS-CEN-TS ";
       fg35 =  "SET-CEN-TS ";
       fg36 =  "VUIT-CEN-TS ";
       fg37 =  "NOU-CEN-TS ";
       fg38 =  "VINT.I ";
       fg39 =  "MIL ";
       fg40 =  "MILIO  ";
       fg41 =  "MILIONS ";
       fg42 =  "EUR-O ";
       fg43 =  "EUR-OS ";

       fg44 =  "CENTIM ";
       fg45 =  "CENTIMS ";
       fg46 =  "I ";
       fg47 =  "DE ";
       fg48 =  "AMB ";
       fg49 =  "$$// "
|FIN;

|PROCESO en1760;
     rctraba = rc % 101; r4 = rctraba;
     rctraba = rc % 201; r5 = rctraba;
     rctraba = rc % 301; r6 = rctraba;
     rctraba = rc % 202; r8 = rctraba;
     rctraba = rc % 103; r1 = rctraba;

     |SI r4 = 0; |VETE en1820; |FINSI;

     r2 = 28;
     |SI r1 = 100; r2 = 27; |FINSI;
     r2 = r2 + r4;
     |HAZ en1960;

     |ET en1820;
         |SI r5 > 2;  |VETE en1880; |FINSI;
         |SI r8 < 21; |VETE en1930; |FINSI;
         r2 = 38;     |HAZ en1960;
         r8 = r6;     |VETE en1930;

     |ET en1880;
         r2 = r5 + 18; |HAZ en1960;
         r8 = r6;

     |ET en1930;
         r2 = r8;
         |SI r2 ! 0; |HAZ en1960; |FINSI;
|FPRC;

|PROCESO en1960;
     Ifg     = fg1 <-;
     Ifg     = Ifg + r2 - 1;
     rd      = fg;
     rctraba = rd % 0;
     aa      = rctraba;
     |PARA r3 = 1; |SI r3 [ aa; |HACIENDO r3 = r3 + 1;
          bb = (100 * r3) + 1;
          ra = rd % bb;
          |SI ra = "-"; |O ra = " "; |VETE en2030; |FINSI;
          |SI ra = "."; ra = " "; |FINSI;
          rlsala = rlsali + ra;
          ra = ".";
          r9     = r9 + 1;
          rlsali = rlsala;
          |VETE en2090;

          |ET en2030;
          jj     = rlemax - 4;
          |SI jj > r9; |VETE en2090; |FINSI;
          rlsala = rlsali + ra;
          rlsali = rlsala
          r9     = 0;
          rlemax = 999;
          rprim  = rlsali;
          jkl    = 1;
          rlsali = "";
          |ET en2090;
          |SI ra = " "; r3 = 999; |FINSI;
     |SIGUE;

     r9     = r9 + 1;
     rlsala = rlsali + ra;
     rlsali = rlsala;
|FPRC;

|PROCESO lletres;
     || ======== RUTINA DE NUMEROS A LETRAS ===========
     || VARIABLE DE ENTRADA     RLECAN# = IMPORT(CENTIM)
     || =======  RLEMAX=longitud de le primera impresion.
     || ======= FG$(49,25) tabla de variables =============
     || === variables a dimensionar ===== RLSALI$(70),RLSALA$(70)********
     ||====== la linea de impresion segunda se devuelve en RLSALI$ preguntar===

     rlemax = 50;
     r9     = 0;
     jkl    = 0;
     rlsali = " ";
     rlsala = "";

     r7      = (rlecan * 100) + 100000000000;
     r1      = rlemax + 1000;
     rctraba = r7;
     rc      = rctraba % 211;
     rctraba = rc % 103;

     |SI rctraba = "000"; |VETE  en1560; |FINSI;

     fg1  = "UN ";
     fg2  = "DOS ";
     fg30 = "DOS-CENTS ";
     fg31 = "TRES-CENTS ";
     fg32 = "QUA-TRE-CENTS ";
     fg33 = "CINC-CENTS ";
     fg34 = "SIS-CENTS ";
     fg35 = "SET-CENTS ";
     fg36 = "VUIT-CENTS ";
     fg37 = "NOU-CENTS ";

     |HAZ en1760;

     r2 = 41;
     |SI r1 = 1; r2 = 40; |FINSI;

     |HAZ en1960;

     r2      = 47;
     rctraba = rc % 406;
     |SI rctraba = "000000"; |HAZ en1960; |FINSI;

     |ET en1560;
     rf      = rc % 408;
     rc      = rf;
     fg1     = "UNA ";
     fg2     = "DUES ";
     fg30    = "DUES-CEN-TES ";
     fg31    = "TRES-CEN-TES ";
     fg32    = "QUA-TRE-CEN-TES ";
     fg33    = "CINC-CEN-TES ";
     fg34    = "SIS-CEN-TES ";
     fg35    = "SET-CEN-TES ";
     fg36    = "VUIT-CEN-TES ";
     fg37    = "NOU-CEN-TES ";
     rctraba = rc % 103;
     |SI rctraba > "001"; |HAZ en1760; |FINSI;

     r2      = 39;
     rctraba = rc % 103;
     |SI rctraba ! "000"; |HAZ en1960; |FINSI;

     rf      = rc % 405;
     rc      = rf;
     rctraba = rc % 103;
     |SI rctraba ! "000"; |HAZ en1760; |FINSI;

     r2      = 42;
     |SI rlecan ! 1; r2 = 43; |FINSI;
     |HAZ en1960;

     rctraba = rc % 402;
     rf      = "0" + rctraba;
     rc      = rf;
     rctraba = rc % 103;
     |SI rctraba = "000"; |VETE en1730; |FINSI;
     r2      = 48;
     |HAZ en1960;

     fg1     = "UN ";
     |HAZ en1760;

     rctraba = rc % 302;
     r2      = 45;
     |SI rctraba = "01"; r2 = 44; |FINSI;
     |HAZ en1960;

     |ET en1730;
     |SI rlemax ! 999; rprim = rlsali; rlsali = " "; |FINSI;
     rsegu = rlsali;

     || RESULTADO FINAL
     rlsali = rprim + rsegu;
|FPRC;
