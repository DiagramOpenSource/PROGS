|FICHEROS;
     laborn1a;
     laborn0a;
     labort10;
     labtraba;
     labtrtra;

     labempre;
     laborn90;
     labcontr;
     nompmail;

     :integral/dsam0103;
|FIN;

|VARIABLES;
     nModo = 0;
     nPos1 = 0;
     nPos2 = 0;

     &eaDirDest  = "";
     &eaAsunto   = "";
     &eaTexto    = "";
     &eaFichero  = "";

     nContrato = 0;
     aAlfa = "";
     &nEmpExt = 0;
     &nTraExt = 0;
     &nTipoVar = 0;
     &nNuevoVal = 0;
     &aNuevoTra = "";
     &nNuevoAFI = 0;
     &nAntigVal = 0;
     &aNuevoVal1 = "";
     &nNuevoVal2 = 0;
     &nNuevoVal3 = 0;
     &nNuevoVal4 = 0;
     &nNuevaCat = 0;
     &aNombreCat = "";
     &nHorasTC2 = 0;
     &aClaveSal1 = "";
     &aClaveSal2 = "";
     &aAntigOcu = "";
     &aNuevaOcu = "";
     &aNuevaDesOcu = "";

     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     nNume1 = 0;
     aParam = "";
     &eaUsuario = "";
     &eaFecha = "";
     &efFecha = @;
     &eaHora = "";
     nCampo = 0;
     aHora = "";
     nEmp = 0;
     &eaEmpresa = "";
     &eaTrabajador = "";
     &eaAccion = "";

     nNume = 0;
     nHoras = 0;
     &enEmpresa = 0;

     nCampo1 = 0;
     nEmpresas = 0;
     nCodEmp = 0;
     aNomEmp = "";
     &nLabornet = 0;
     &eaOperacion = "";

     aEstadoOri = "";
     aUsuarioOri = "";
     fFechaOri = @;
     aHoraOri = "";
     aSiEsX   = "";

     &eaEstado = "";
     &eaParam = "";
     &enFSalida = 0;
     nAntes = 0;
     &eaQueEs            = "";
|FIN;

/********************* PROCESOS DESDE LA PANTALLA/CAMPOS ********************/

|PROCESO ConservaAntes; |TIPO 7;
     nAntes = #laborn1a#6;
     aAlfa1 = #laborn1a#9;
     aAlfa2 = #laborn1a#7;
     nNume1 = #laborn1a#10;
     aAlfa4 = #laborn1a#11;
|FPRC;

|PROCESO ConservaDespues; |TIPO 0;
     |SI nAntes = #laborn1a#Campo#; || no ha cambiado
     |Y #laborn1a#6 = 00000;  || y era cero
                              || recupera lo que tenia
          #laborn1a#9 = aAlfa1;
          #laborn1a#7 = aAlfa2;
          #laborn1a#10 = nNume1;
          #laborn1a#11 = aAlfa4;

          |PINTA #laborn1a#9;
          |PINTA #laborn1a#7;
          |PINTA #laborn1a#10;
          |PINTA #laborn1a#11;
     |FINSI;
|FPRC;

|PROCESO PorNIF;
     |SI #laborn1a#6 = 0;
          |ABRE #dsam0103;
          #dsam0103#0 = #laborn1a#7;
          |LEE 000#dsam0103.=;
          |SI FSalida = 0;
               #laborn1a#9 = #dsam0103#1;
               #laborn1a#10 = #dsam0103#4;
               #laborn1a#11 = #dsam0103#7;

               |PINTA #laborn1a#9;
               |PINTA #laborn1a#10;
               |PINTA #laborn1a#11;
          |FINSI;
          |CIERRA #dsam0103;
     |FINSI;
|FPRC;

|PROCESO ValidaTra;
     |SI #labtraba#44 = "B";
          |MENAV "    ATENCION: Trabajador en situación de baja";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO labtraba;
     |PARA nCampo = 0; |SI nCampo [ 253; |HACIENDO nCampo = nCampo + 1;
          #labtrtra#nCampo# = #labtraba#nCampo#;
     |SIGUE;
     |GRABA 020#labtrtra.n;
     |LIBERA #labtrtra;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44;
     #laborn1a#5, 00001, "A";
     #laborn1a#5, 99999, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO CargaTra;
     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |DELINDEX #labtrtra;
     |ABRE #labtrtra;
     |BUCLE labtraba;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO ConsultaTra; |TIPO 66;
     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |ABRE #labtrtra;
     |LEE 000#labtrtra.p;
     |CONSULTA_CLAVE #1#labtrtra;
     |SI FSalida = 0;
          #laborn1a#6 = #labtrtra#1;
          #laborn1a#9 = #labtrtra#2;
          #laborn1a#7 = #labtrtra#7;
     |FINSI;
     |PINTA #laborn1a#6;
     |PINTA #laborn1a#9;
     |PINTA #laborn1a#7;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO labempre19;
     nEmpresas = nEmpresas + 1;
     nCodEmp = #labempre#0;
     aNomEmp = #labempre#2;
|FPRC;

|DEFBUCLE labempre19;
     #labempre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, labempre19;
|FIN;

|PROCESO Empresas19; |TIPO 7;
     |ABRE #labempre;
     |BUCLE labempre19;
     |CIERRA #labempre;

     |SI nEmpresas = 1;
          || tengo una unica empresa que elegir

          #laborn1a#5 = nCodEmp;
          |CAMPO_MODIFICA #laborn1a#5, 1, "N";
          |PINTA #laborn1a#5;
          #laborn1a#8 = aNomEmp;
          |PINTA #laborn1a#8;
     |FINSI;
|FPRC;

/****************************************************************************/

|PROCESO Email;
     aAlfa = #laborn1a#5; |QBF aAlfa;
     eaEmpresa = ("00000" + aAlfa) % -105;
     eaEmpresa = eaEmpresa + " - " + #labempre#2;

     aAlfa = #laborn1a#6; |QBF aAlfa;
     eaTrabajador = ("00000" + aAlfa) % -105;
     eaTrabajador = eaTrabajador + " - " + #labtraba#2;

     eaAccion = "embargo";

     |HAZ ConsEmail;
|FPRC;

|PROCESO labempre;
     nEmpresas = nEmpresas + 1;
     nCodEmp = #labempre#0;
     aNomEmp = #labempre#2;
|FPRC;

|DEFBUCLE labempre;
     #labempre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, labempre;
|FIN;

|PROCESO Empresas; |TIPO 7;
     |ABRE #labempre;
     |BUCLE labempre;
     |CIERRA #labempre;

     |SI nEmpresas = 1;
          || tengo una unica empresa que elegir

          #laborn1a#5 = nCodEmp;
          |CAMPO_MODIFICA #laborn1a#5, 1, "N";
          |PINTA #laborn1a#5;
     |FINSI;
|FPRC;

|PROCESO Impresion;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |SI #labcontr#84 ! "S";
          |ACABA;
     |FINSI;

     |MENAV "    No está disponible el la impresión de este tipo de solicitud";
/*

     eaQueEs = "C";

     aAlfa = "*laborn10;X";
     aAlfa = aAlfa + "18";
     aAlfa = aAlfa + #laborn0a#0;
     aAlfa = aAlfa + #laborn0a#1;
     aAlfa1 = #laborn0a#3;
     aAlfa = aAlfa + aAlfa1;
     aAlfa = aAlfa + #laborn0a#4;
     aAlfa = aAlfa + "IMPRE";

     |MENSA "    Imprimiendo solicitud de corrección";
     |SUB_EJECUTA aAlfa;
*/
|FPRC;

|PROCESO Contador;
     |ABRE #laborn90;

     #laborn90#0 = #laborn0a#5;
     #laborn90#1 = 99999;

     |LEE 000#laborn90.];
     |SI FSalida = 0;
          |SI #laborn90#0 ! #laborn0a#5;
               |LEE 000#laborn90.a;
          |FINSI;
     |SINO;
          |LEE 000#laborn90.u;
     |FINSI;

     |SI FSalida = 0;
     |Y #laborn90#0 = #laborn0a#5;
          nNume = #laborn90#1;

          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn0a#5;
          #laborn90#1 = nNume + 1;

     |SINO;
          || es el primero de esta empresa !!!
          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn0a#5;
          #laborn90#1 = 1;
     |FINSI;

     #laborn90#2 = "R";
     #laborn90#3 = "Ret.Prof.";
     #laborn90#4 = #laborn0a#1;
     #laborn90#5 = #laborn0a#2;
     #laborn90#6 = #laborn0a#3;
     #laborn90#7 = #laborn0a#4;

     |GRABA 020#laborn90.n;

     #laborn0a#24 = #laborn90#1;

     |LIBERA #laborn90;
     |CIERRA #laborn90;
|FPRC;

|PROGRAMA;
     |CLS;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa1#;
     |FINSI;

     aParam = PARAMETRO;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ABRE #laborn0a;
          |SI aParam = "MODIF";
               #laborn0a#0 = "P";         || estado: pendiente, consulta/modificacion
          |FINSI;
          |SI aParam = "CONSUL";
               #laborn0a#0 = "A";         || estado: actualizado, solo consulta
          |FINSI;
          #laborn0a#1 = eaUsuario;
          #laborn0a#2 = "";
          #laborn0a#3 = eaFecha;
          #laborn0a#4 = eaHora;
          |LEE 101#laborn0a.=;

          |PARA nCampo = 0; |SI nCampo [ 28; |HACIENDO nCampo = nCampo + 1;
               #laborn1a#nCampo# = #laborn0a#nCampo#;
          |SIGUE;
          |PINPA #0#laborn1a;
          |PINDA #0#laborn1a;

          |ABRE #labtraba;
          #labtraba#0 = #laborn1a#5;
          #labtraba#1 = #laborn1a#6;
          |LEE 000#labtraba.=;
          |CIERRA #labtraba;

          |SI aParam = "MODIF";
               |ENDATOS #1#laborn1a;
          |FINSI;
          |SI aParam = "CONSUL";
               |PARA nCampo = 0; |SI nCampo [ 28; |HACIENDO nCampo = nCampo + 1;
                    #laborn1a#nCampo# = #laborn0a#nCampo#;
               |SIGUE;
               |PINDA #0#laborn1a;
               |PAUSA;
          |FINSI;
     |SINO;
          |CLS;
          |PINPA #0#laborn1a;
          |PINDA #0#laborn1a;
          |ENDATOS #1#laborn1a;
     |FINSI;

     |SI FSalida = 0; |Y aParam ! "CONSUL";
          |SI aParam = "MODIF";
               |PARA nCampo = 0; |SI nCampo [ 28; |HACIENDO nCampo = nCampo + 1;
                    #laborn0a#nCampo# = #laborn1a#nCampo#;
               |SIGUE;
               |GRABA 020#laborn0a.a;
          |SINO;
               |ABRE #laborn0a;
               #laborn0a#0 = "P";    || Estado: Pendiente
               #laborn0a#1 = Usuario % 0810;     || Usuario
               #laborn0a#2 = "";     || Perfiles, en principio no lo uso
               #laborn0a#3 = ~;      || Fecha
               |HORA aHora;
               #laborn0a#4 = aHora;  || Hora
               |PARA nCampo = 5; |SI nCampo [ 28; |HACIENDO nCampo = nCampo + 1;
                    #laborn0a#nCampo# = #laborn1a#nCampo#;
               |SIGUE;
               |HAZ Contador;
               |GRABA 020#laborn0a.n;

               |SI FSalida = 0;
                    |MENAV "    Se ha grabado correctamente la solicitud de Retenciones a Profesionales";
               |FINSI;
               |CIERRA #laborn0a;
/*
               |ABRE #nompmail; |LEE 000#nompmail.p; |CIERRA #nompmail;
               |SI #nompmail#11 = "S";
                    |HAZ Email;
               |FINSI;
*/
          |FINSI;

          |CIERRA #laborn0a;
     |FINSI;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa2#;
     |FINSI;
|FPRO;

|PROCESO Tipo80n18;  |TIPO 80;
     aSiEsX = PARAMETRO % 101;
     |SI aSiEsX = "X";
         eaOperacion = PARAMETRO % 201;
         eaEstado    = PARAMETRO % 301;
         eaUsuario   = PARAMETRO % 410;
         aAlfa       = PARAMETRO % 1410;  efFecha = aAlfa;
         eaHora      = PARAMETRO % 2408;
         eaParam     = PARAMETRO % 3210;  |QBF eaParam;
         aParam      = eaParam;
     |SINO;
         aParam = PARAMETRO;
     |FINSI;
|FPRC;
