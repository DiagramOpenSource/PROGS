|FICHEROS;
     cretai11 #0;

     cretat10;
     cretat15;

     cretam01;
     cretam02;
     cretam03;
     cretam04;

     labempre;
     labtraba;
     labcentr;
     nomcenes;

     nomcalca;
     nomhicca;
     nomcalac;

     cretam3a;
     cretam3b;
|FIN;

|VARIABLES;
     swCentroFormacion = 0;
     aCCC = "";

     aFuente = "";
     aAlfa = "";
     aCentroNom = "";

     nEmp = 0;
     nTra = 0;
     nTipo = 0;
     nNume = 0;

     nAny = 0;
     nCampo = 0;
     FEstado = 0;
     nRegistros = 0;
     aTipo = "";
     nTotal = 0;

     swCalculos = 0;
     nBaseCC = 0;
     &aImpresion = "";
     &nMargen = 0;

     nDesdeTipo = 0;
     nHastaTipo = 0;
     swHayAtrasos = 0
     nDesdeTipoAt = 0;
     nHastaTipoAt = 0;

     aNAFSS = "";
     swCalculosTra = 0;
     swTramos = 0;
     aAlfa1 = "";
     aAlfa2 = "";

     {1}aContiene = "";
     aIP = "";
     aDestino = "";
     aOrigen = "";
     aTemp = "";
     nCampo1 = 0;
     nCampo2 = 0;
     swSigue = 0;
|FIN;

|PROCESO AvisoTipos;
     |SI #0Campo = 01;
          aAlfa = "    ATENCION: con la selección 'Desde tipo 01'";
          aAlfa = aAlfa + " no se incluyen las liquidaciones L00";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO ValidaAny;
     |SI #0#2 < 2017;
          |DBASE aAlfa;
          aAlfa = aAlfa % 111;
          |SI aAlfa ! "/u/ccasesor"; |Y aAlfa ! "/u/ccprofes";
          |Y aAlfa ! "/u/dsprofes"; |Y aAlfa ! "/u/dsasesor";
               |MENAV "    El informe sólo puede acceder a los datos disponibles a partir de 2017";
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cta_cotizacion;
     swCentroFormacion = 0;
     aCCC = #labempre#13;          || cta.cot. de la empresa
     |SI #labtraba#45 = "085"; |O #labtraba#45 = "087"; |O #labtraba#45 = "097";
     |O #labtraba#45 = "421"; |O #labtraba#45 = "422";
          |DDEFECTO #nomcenes;
          |ABRE #nomcenes;
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = 87;
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aAlfa = #nomcenes#10;      || cta.cto. del centro de trabajo especial
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;         || cta.cto. del centro de trabajo especial
               |FINSI;
               aCentroNom = #nomcenes#2;
               swCentroFormacion = 1;
          |FINSI;
          |CIERRA #nomcenes;
     |SINO;
          |DDEFECTO #labcentr;
          |ABRE #labcentr;
          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
               aAlfa = #labcentr#10;      || cta.cot. centro de trabajo
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;
               |FINSI;
               aCentroNom = #labcentr#2;
          |FINSI;
          |CIERRA #labcentr;
     |FINSI;
     |QBF aCCC;
     |SI aCCC ! "";
          aCCC = ("00000000000" + aCCC) % -111;
     |FINSI;
     aAlfa = #labtraba#247;
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;
     |SI aCCC ! "";
          aCCC = aAlfa + aCCC;
     |FINSI;
|FPRC;

|PROCESO BuscaTramos;
     swTramos = 1;
|FPRC;

|DEFBUCLE BuscaTramos;
     #cretam04#1;
     ;
     #cretat10#0, #cretat10#1, #cretat10#2, #cretat10#3, #cretat10#4, aNAFSS, 01;
     #cretat10#0, #cretat10#1, #cretat10#2, #cretat10#3, #cretat10#4, aNAFSS, 99;
     ;
     NULL, BuscaTramos;
|FIN;

|PROCESO BuscaCalculosTra;
     swCalculosTra = 1;
|FPRC;

|DEFBUCLE BuscaCalculosTra;
     #cretam3b#1;
     ;
     #cretat10#0, #cretat10#1, #cretat10#2, #cretat10#3, #cretat10#4, aNAFSS, 01, #0#2, #0#3;
     #cretat10#0, #cretat10#1, #cretat10#2, #cretat10#3, #cretat10#4, aNAFSS, 31, #0#2, #0#3;
     ;
     NULL, BuscaCalculosTra;
|FIN;

|PROCESO BuscaCalculos;
     swCalculos = 0;

     #cretam3a#0 = #cretat10#0;
     #cretam3a#1 = #cretat10#1;
     #cretam3a#2 = #cretat10#2;
     #cretam3a#3 = #cretat10#3;
     #cretam3a#4 = #cretat10#4;
     |SI aFuente = "A";
          #cretam3a#135 = #cretat10#19;
     |FINSI;

     |LEE 000#cretam3a.=;
     |SI FSalida = 0;
          swCalculos = 1;
     |FINSI;
|FPRC;

|PROCESO graba;
     nBaseCC = 0;
     |SI aFuente = "M";
          nEmp = #nomcalca#0;
          nTra = #nomcalca#1;
          nTipo = #nomcalca#3;
          nNume = #nomcalca#48 + #nomcalca#49 + #nomcalca#50 + #nomcalca#51 + #nomcalca#165;
          nNume = nNume + #nomcalca#45;
          nNume = nNume - #nomcalca#57 - #nomcalca#58;
          nBaseCC = #nomcalca#39;
     |FINSI;
     |SI aFuente = "H";
          nEmp = #nomhicca#0;
          nTra = #nomhicca#1;
          nTipo = #nomhicca#3;
          nNume = #nomhicca#48 + #nomhicca#49 + #nomhicca#50 + #nomhicca#51 + #nomhicca#207;
          nNume = nNume + #nomhicca#45;
          nNume = nNume - #nomhicca#57 - #nomhicca#58;
          nBaseCC = #nomhicca#39;
     |FINSI;

     |SI nTipo ] 05; |Y nTipo [ 20;
          || atrasos se hace despues
          |ACABA;
     |FINSI;

     #labempre#0 = nEmp;
     |LEE 000#labempre.=;
     |SI #labempre#67 = "N";
          |ACABA;
     |FINSI;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     |SI #labtraba#42 = "H"; |O #labtraba#247 = 0138;
          |ACABA;
     |FINSI;

     |SI nTipo = 2; |Y nBaseCC = 0;
          |ACABA;
     |FINSI;

     |HAZ cta_cotizacion;

     |DDEFECTO #cretat10;

     #cretat10#0 = nEmp;
     #cretat10#1 = #0#2
     #cretat10#2 = #0#3;
     #cretat10#3 = nTipo;
     #cretat10#4 = aCCC;
     |LEE 101#cretat10.=;
     FEstado = FSalida;
     |SI #cretat10#7 ! "S";        || (venia un una F !!!)
          |HAZ BuscaCalculos;
          |SI swCalculos = 1;
               #cretat10#7 = "S";
               |PARA nCampo = 31; |SI nCampo [ 126; |HACIENDO nCampo = nCampo + 5;
                    |SI #cretam3a#nCampo# = 998;
                         nCampo1 = nCampo + 2;
                         nCampo2 = nCampo + 3;
                         #cretat10#28 = #cretam3a#nCampo1# + #cretam3a#nCampo2#;
                         |SAL;
                    |FINSI;
                    |SI #cretam3a#nCampo# = 000;
                         |SAL;
                    |FINSI;
               |SIGUE;
          |SINO;
               #cretat10#7 = "N";
          |FINSI;
     |FINSI;

     #cretat10#23 = #labempre#2;
     #cretat10#24 = #cretat10#24 + nNume;

     swCalculosTra = 0;
     swTramos = 0;
     aNAFSS = #labtraba#75;
     |QBF aNAFSS;

     |SI #cretat10#7 = "S";
          |BUCLE BuscaCalculosTra;
          |SI swCalculosTra = 0;
               || No se han encontrado los calculos del trabajador
               #cretat10#26 = #cretat10#26 + 1;
          |FINSI;
     |FINSI;

     |BUCLE BuscaTramos;
     |SI swTramos = 0;
          ||  No se han encontrado tramos del trabajador
          #cretat10#27 = #cretat10#27 + 1;
     |FINSI;

     |SI FEstado = 0;
          |GRABA 020#cretat10.a;
     |SINO;
          |GRABA 020#cretat10.n;
     |FINSI;
     |LIBERA #cretat10;

     swSigue = 0;
     |SI #cretat10#7 = "S";
          |SI swCalculosTra = 0;
               swSigue = 1;
          |FINSI;
     |FINSI;
     |SI swTramos = 0;
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
          |DDEFECTO #cretat15;
          #cretat15#0 = #cretat10#0;
          #cretat15#1 = #cretat10#1;
          #cretat15#2 = #cretat10#2;
          #cretat15#3 = #cretat10#3;
          #cretat15#4 = #cretat10#4;
          #cretat15#26 = #labtraba#1;
          |LEE 000#cretat15.=;
          FEstado = FSalida;

          #cretat15#24 = nNume;
          #cretat15#27 = #labtraba#2;
          #cretat15#28 = #labtraba#75;
          |SI swTramos = 0;
               #cretat15#30 = 1;
          |FINSI;
          |SI #cretat10#7 = "S"; |Y swCalculosTra = 0;
               #cretat15#31 = 1;
          |FINSI;

          |SI FEstado = 0;
               |GRABA 020#cretat15.a;
          |SINO;
               |GRABA 020#cretat15.n;
          |FINSI;

          |LIBERA #cretat15;
     |FINSI;

     |LIBERA #cretat10;
|FPRC;

|PROCESO acumula;
     nNume = 0;
     |SI aFuente = "T";
          nEmp = #nomhicca#0;
          nTra = #nomhicca#1;
          nNume = #nomhicca#48 + #nomhicca#49 + #nomhicca#50 + #nomhicca#51;
          nNume = nNume + #nomhicca#45;
          nNume = nNume - #nomhicca#57 - #nomhicca#58;

          swHayAtrasos = 1;
     |FINSI;
     |SI aFuente = "A";
          nEmp = #nomcalac#0;
          nTra = #nomcalac#1;
          nNume = #nomcalac#48 + #nomcalac#49 + #nomcalac#50 + #nomcalac#51;
          nNume = nNume + #nomcalac#45;
          nNume = nNume - #nomcalac#57 - #nomcalac#58;
     |FINSI;

     #labempre#0 = #cretat10#0;
     |LEE 000#labempre.=;
     |SI #labempre#67 = "N";
          |ACABA;
     |FINSI;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     |HAZ cta_cotizacion;

     |SI aCCC ! #cretat10#4;
          || solo los del CCC ojo
          |ACABA;
     |FINSI;

     |SI #labtraba#42 = "H"; |O #labtraba#247 = 0138;
          |ACABA;
     |FINSI;

     nTotal = nTotal + nNume;

     |HAZ BuscaCalculos;
     |SI swCalculos = 1;
          #cretat10#7 = "S";
          #cretat10#28 = #cretam3a#132;
     |SINO;
          #cretat10#7 = "N";
     |FINSI;

     #cretat10#23 = #labempre#2;
     #cretat10#24 = #cretat10#24 + nNume;

     |GRABA 020#cretat10.a;
     |LIBERA #cretat10;
|FPRC;

|DEFBUCLE nomcalac;
     #nomcalac#1;
     ;
     #cretat10#0, 00001, #cretat10#17, #cretat10#3;
     #cretat10#0, 99999, #cretat10#18, #cretat10#3;
     ;
     NULL, acumula;
|FIN;

|DEFBUCLE nomhicca_atrasos;
     #nomhicca#1;
     ;
     #cretat10#0, 00001, nAny, #cretat10#17, #cretat10#3;
     #cretat10#0, 99999, nAny, #cretat10#18, #cretat10#3;
     ;
     NULL, acumula;
|FIN;

|PROCESO busca_atrasos;
     nTotal = 0;
     nAny = #cretat10#21 - 2000;

     swHayAtrasos = 0;
     aFuente = "T";
     |BUCLE nomhicca_atrasos;
     |SI swHayAtrasos = 0;
          nAny = #cretat10#19 - 2000;
          |BUCLE nomhicca_atrasos;
     |FINSI;

     aFuente = "A";
     |BUCLE nomcalac;

     |GRABA 020#cretat10.a;
     |LIBERA #cretat10;
|FPRC;

|DEFBUCLE busca_atrasos;
     #cretat10#1;
     ;
     #0#0, #0#2, #0#3, 05, "           ";
     #0#1, #0#2, #0#3, 20, "zzzzzzzzzzz";
     be;
     NULL, busca_atrasos
|FIN;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #0#0, 00001, nAny, #0#3, nDesdeTipo;
     #0#1, 99999, nAny, #0#3, nHastaTipo;
     ;
     NULL, graba;
|FIN;

|DEFBUCLE nomcalca;
     #nomcalca#1;
     ;
     #0#0, 00001, #0#3, nDesdeTipo;
     #0#1, 99999, #0#3, nHastaTipo;
     ;
     NULL, graba;
|FIN;

|PROCESO cretam02_atrasos;
     #cretat10#0 = #cretam02#0;
     #cretat10#1 = #cretam02#21;
     #cretat10#2 = #cretam02#20;
     #cretat10#3 = #cretam02#3;
     #cretat10#4 = #cretam02#4;
     |LEE 101#cretat10.=;
     |SI FSalida ! 0;
          #cretat10#0 = #cretam02#0;
          #cretat10#1 = #cretam02#21;
          #cretat10#2 = #cretam02#20;
          #cretat10#3 = #cretam02#3;
          #cretat10#4 = #cretam02#4;

          |PARA nCampo = 5; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
               #cretat10#nCampo# = #cretam02#nCampo#;
          |SIGUE;

          #labempre#0 = #cretat10#0;
          |LEE 000#labempre.=;
          #cretat10#23 = #labempre#2;

          |GRABA 020#cretat10.n;
          |LIBERA #cretat10;
     |FINSI;
|FPRC;

|DEFBUCLE cretam02_atrasos;
     #cretam02#3;
     ;
     #0#0, #0#2, #0#3, nDesdeTipoAt, "           ";
     #0#1, #0#2, #0#3, nHastaTipoAt, "zzzzzzzzzzz";
     ;
     NULL, cretam02_atrasos;
|FIN;

|PROCESO cretam02;
     |SI #cretam02#3 ] 05; |Y #cretam02#3 [ 20;
          || atrasos se hace despues
          |ACABA;
     |FINSI;

     |PARA nCampo = 0; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
          #cretat10#nCampo# = #cretam02#nCampo#;
     |SIGUE;

     #labempre#0 = #cretat10#0;
     |LEE 000#labempre.=;
     #cretat10#23 = #labempre#2;

     |GRABA 020#cretat10.n;
     |LIBERA #cretat10;
|FPRC;

|DEFBUCLE cretam02;
     #cretam02#1;
     ;
     #0#0, #0#2, #0#3, nDesdeTipo, "           ";
     #0#1, #0#2, #0#3, nHastaTipo, "zzzzzzzzzzz";
     ;
     NULL, cretam02;
|FIN;

|PROCESO imprime;
     |SI nRegistros = 0;
          Impresora = "CrystalReport";
          |IMPRE -1;
          |INFOR "cretai11";
     |FINSI;
     |PRINT;
     nRegistros = nRegistros + 1;
|FPRC;

|DEFBUCLE cretat10;
     #cretat10#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, imprime;
|FIN;

|PROCESO Impresion;
     |BUCLE cretat10;
|FPRC;

|PROCESO Errores;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aDestino = aContiene1; |QBF aDestino;

     |DFICB aOrigen; |QBF aOrigen;

     aOrigen = aOrigen + "cretat15.dbf";
     || aOrigen = aOrigen + aTemp + ".dbf";
     aDestino = aDestino + "crystal/cretat15.dbf";

     aIP = ""; |IP_REMOTO aIP;

     |SI aIP = "";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          |ENVIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO BorraErrores;
     |RFBORRA aDestino;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;

     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;
          |BORRA 020#0a;
     |FINSI;

     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_cretat10_" + aAlfa;
          |NOME_DAT #cretat10#aAlfa#;
          |DELINDEX #cretat10;
          |ABRE #cretat10;
          |DELINDEX #cretat15;
          |ABRE #cretat15;

          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #cretam3a;
          |ABRE #cretam3b;
          |ABRE #cretam04;

          aImpresion = #0#7;
          nMargen = #0#8;
          nDesdeTipo = #0#5;
          nHastaTipo = #0#6;

          aTipo = "N";
          |BUCLE cretam02;

          nDesdeTipoAt = 00;
          nHastaTipoAt = 00;
          |SI nHastaTipo ] 05;
               nHastaTipoAt = nHastaTipo;
               |SI nDesdeTipo ] 05;
                    nDesdeTipoAt = nDesdeTipo;
               |SINO;
                    nDesdeTipoAt = 05;
               |FINSI;
          |FINSI;

          aTipo = "A";
          |BUCLE cretam02_atrasos;

          nAny = #0#2 - 2000;

          aFuente = "M";
          |BUCLE nomcalca;

          aFuente = "H";
          |BUCLE nomhicca;

          |BUCLE busca_atrasos;

          ||CONSULTA_CLAVE #1#cretat10;
          |HAZ Impresion;
          |HAZ Errores;

          |SI nRegistros ! 0;
               |PIEINF;
               |FININF;
               |FINIMP;
          |FINSI;

          |HAZ BorraErrores;

          |CIERRA #cretam04;
          |CIERRA #cretam3b;
          |CIERRA #cretam3a;
          |CIERRA #labtraba;
          |CIERRA #labempre;
          |CIERRA #cretat10;
          |CIERRA #cretat15;

          |DELINDEX #cretat10;
          |DELINDEX #cretat15;
     |FINSI;

     |GRABA 000#0n;
     |CIERRA #0;
|FPRO;
