|FICHEROS;
     nomz0019 #0;

     labempre;
     labtraba;
     nomhicca;
     nomhicli;
     nomconca;

     nomtmp19;

     :/modelos/def/dsm19001;
     :/modelos/def/dsm190li;
|FIN;

|VARIABLES;
     nExento = 0;
     FEstado = 0;
     nAnyXXDesde = 0;
     nAnyXXHasta = 0;

     nAnyDesde = 0;
     nAnyHasta = 0;

     nMes = 0;
     nAny = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nNumTrab = 0;

     aCol = "";
     aValor = "";
     nLinea = 0;
     nAntEmp = 0;
     aBase = "";
     aHojaExcel = "";
     aOrigen = "";
     aDestino = "";
     aDestinoTrab = "";
     aIPRemoto = "";
     aResultado = "";

     swParcial = 0;
     nHorasTPCon = 0;
     nHorasTPTra = 0;
     aAntNIF = "";
     nVoyPor = 0;
     aNif = "";
|FIN;

|PROCESO dsm19001;
     nExento = #dsm19001#16;
|FPRC;

|PROCESO dsm190li;
     nExento = #dsm190li#16;
|FPRC;

|DEFBUCLE dsm190li;
     #dsm190li#1;
     ;
     #nomtmp19#0, #nomtmp19#2, 00, 190, 00, 00, aNif, 0000, "L", "05", 0;
     #nomtmp19#0, #nomtmp19#2, 99, 190, 99, 99, aNif, 0000, "L", "05", 4;
     ;
     NULL, dsm190li;
|FIN;

|DEFBUCLE dsm19001;
     #dsm19001#1;
     ;
     #nomtmp19#0, #nomtmp19#2, 00, 190, 00, 00, aNif, 0000, "L", "05", 0;
     #nomtmp19#0, #nomtmp19#2, 99, 190, 99, 99, aNif, 0000, "L", "05", 4;
     ;
     NULL, dsm19001;
|FIN;

|PROCESO LoDel190;
     nExento = 0;
     aNif = #nomtmp19#4;
     |QBF aNif;
     aNif = (aNif + "            ") % 112;
     |SI #nomtmp19#2 [ 2015;
          |BUCLE dsm190li;
     |SINO;
          |BUCLE dsm19001;
     |FINSI;
|FPRC;

|PROCESO PonValor;
     aAlfa = aCol + nLinea + "," + aValor;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|PROCESO nomtmp19;
     |SI nAntEmp ! #nomtmp19#0;
          nLinea = nLinea + 2;
          aAlfa1 = #nomtmp19#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aValor = "EMPRESA: " + aAlfa1 + " " + #nomtmp19#10;
          aCol = "A";
          aAlfa = aCol + nLinea + "," + aValor;
          |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

          nLinea = nLinea + 2;
          aCol = "A"; aValor = "Trabajador"; |HAZ PonValor;
          aCol = "B"; aValor = "DNI"; |HAZ PonValor;
          aCol = "C"; aValor = "NAF"; |HAZ PonValor;

          aCol = "D"; aValor = "Contrato"; |HAZ PonValor;
          aCol = "E"; aValor = "Coeficiente"; |HAZ PonValor;

          aCol = "F"; aValor = "D¡as"; |HAZ PonValor;
          aCol = "G"; aValor = "Bruto"; |HAZ PonValor;
          aCol = "H"; aValor = "Exento 414"; |HAZ PonValor;
          aCol = "I";
          aCol = "J"; aValor = "Total d¡as"; |HAZ PonValor;
          aCol = "K"; aValor = "Total bruto"; |HAZ PonValor;
          aCol = "L"; aValor = "Total 414"; |HAZ PonValor;
          aCol = "M"; aValor = "Importe 190 (L05)"; |HAZ PonValor;
     |FINSI;

     |SI #nomtmp19#1 ! 99999;
          nLinea = nLinea + 1;
          aCol = "A";
          aAlfa1 = #nomtmp19#1; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aValor = aAlfa1 + " " + #nomtmp19#11;
          |HAZ PonValor;

          aCol = "B"; aValor = #nomtmp19#4; |HAZ PonValor;
          aCol = "C"; aValor = #nomtmp19#5; |HAZ PonValor;

          aCol = "D"; aValor = #nomtmp19#6; |HAZ PonValor;
          aCol = "E"; aValor = #nomtmp19#12; |HAZ PonValor;

          aCol = "F"; aValor = #nomtmp19#7; |HAZ PonValor;
          aCol = "G"; aValor = #nomtmp19#8; |HAZ PonValor;
          aCol = "H"; aValor = #nomtmp19#9; |HAZ PonValor;

          nVoyPor = nVoyPor + 1;
     |SINO;
          aCol = "J"; aValor = #nomtmp19#7; |HAZ PonValor;
          aCol = "K"; aValor = #nomtmp19#8; |HAZ PonValor;
          aCol = "L"; aValor = #nomtmp19#9; |HAZ PonValor;
          |HAZ LoDel190;
          aCol = "M"; aValor = nExento; |HAZ PonValor;
     |FINSI;

     nAntEmp = #nomtmp19#0;
     aAntNIF = #nomtmp19#4;

     aAlfa1 = nVoyPor; |QBF aAlfa1; aAlfa1 = ("    " + aAlfa1) % -104;
     aAlfa2 = nNumTrab; |QBF aAlfa2; aAlfa2 = ("    " + aAlfa2) % -104;
     aAlfa = "Registro " + aAlfa1 + " de " + aAlfa2;
     |PINTA 2228, aAlfa;
|FPRC;

|DEFBUCLE nomtmp19;
     #nomtmp19#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, nomtmp19;
|FIN;

|PROCESO informe;
     |PINTA 2124, "Realizando la exportaci¢n a EXCEL";

     nLinea = 1;
     aValor = "SALARIOS BRUTOS ANUALES Y EXENTOS";
     aCol = "A";
     aAlfa = aCol + nLinea + "," + aValor;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aCol = "A";
     nLinea = nLinea + 2;
     aAlfa1 = #0#4; aAlfa1 = ("00" + aAlfa1) % -102;
     aValor = "PERIODO: mes " + aAlfa1 + " a ";
     aAlfa1 = #0#6; aAlfa1 = ("00" + aAlfa1) % -102;
     aValor = aValor + aAlfa1 + " de ";
     aAlfa1 = #0#5;
     aValor = aValor + aAlfa1;
     aAlfa = aCol + nLinea + "," + aValor;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     nAntEmp = 0;

     |BUCLE nomtmp19;

     |PINTA 2224, "       Abriendo hoja EXCEL       ";
|FPRC;

|PROCESO Excel;
     |DBASE aBase;  |QBF aBase;
     aHojaExcel = "informe_brutos_nomina.xls";
     aOrigen = aBase + "documentos/" + aHojaExcel;
     aDestinoTrab = "C:\DOCUMENTOS\LABORAL\";
     |RMKDIR aDestinoTrab;
     aDestino = aDestinoTrab + aHojaExcel;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aOrigen = aDestinoTrab + aHojaExcel;
     aDestino = aDestinoTrab + "trabajo.xls";
     |RCOPIA_FICHERO aOrigen, aDestino;

     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
          |MENAV "0000No se puede usar la DLL de Excel.";
          |ACABA;
     |FINSI;

     |ALFACALLDLL "agixl97.dll", "carga_book", aDestino;

     aAlfa = aDestinoTrab + aHojaExcel;
     |RFBORRA aAlfa;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";

     |HAZ informe;

     aAlfa = aDestinoTrab + aHojaExcel;
     |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa;
     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";

     aAlfa = aDestinoTrab + "trabajo.xls";
     |RFBORRA aAlfa;

     aResultado = aAlfa;

     |DESCARGADLL "agixl97.dll";

     || aAlfa  = "cmd " + &34 + "/c START /WAIT " + aPath + " " + aAlfa + &34;
     || aAlfa  = "cmd " + &34 + "/c START /WAIT " + aResultado + &34;
     aAlfa = aDestinoTrab + aHojaExcel;
     aAlfa = "cmd " + &34 + "/c START " + aAlfa + &34;
     |RSYSTEM aAlfa;
|FPRC;

|PROCESO RestoCampos;
          #nomtmp19#3 = 00;                       || mes
          #nomtmp19#5 = #labtraba#75;
          #nomtmp19#10 = #labempre#2;
          #nomtmp19#11 = #labtraba#2;

          swParcial = 0;
/*
          |SI #nomhicca#9 ] 200; |Y #nomhicca#9 [ 299;
               swParcial = 1;
          |FINSI;
          |SI #nomhicca#9 ] 500; |Y #nomhicca#9 [ 599;
               swParcial = 1;
          |FINSI;
*/

          |SI #nomhicca#11 ! 0;
               swParcial = 1;
          |FINSI;

          nHorasTPCon = 40;
          nHorasTPTra = 40;

          |SI swParcial = 1;
               |SI #labtraba#234 ! 0;
                    nHorasTPTra = #labtraba#234;
               |FINSI;

               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nHorasTPCon = #nomconca#162;
               |FINSI;
          |FINSI;
          #nomtmp19#12 = nHorasTPTra / nHorasTPCon;

     #nomtmp19#7 = #nomtmp19#7 + #nomhicca#8;     || dias
     #nomtmp19#8 = #nomtmp19#8 + #nomhicca#46 + #nomhicca#47;    || bruto
     #nomtmp19#9 = #nomtmp19#9 + nExento;         || exento
|FPRC;

|PROCESO CamposClave;
     #nomtmp19#0 = #nomhicca#0;              || emp
     #nomtmp19#2 = #nomhicca#66 + 2000;      || a¤o
     #nomtmp19#4 = #labtraba#7;              || NIF
     #nomtmp19#6 = #nomhicca#9;              || contrato
     #nomtmp19#1 = #nomhicca#1;              || codigo
|FPRC;

|PROCESO nomhicca;
     |SI #0#8 [ #nomhicca#9; |Y #nomhicca#9 [ #0#9;
          || adelante
     |SINO;
          |ACABA;
     |FINSI;

     #labempre#0 = #nomhicca#0;
     |LEE 000#labempre.=;

     #labtraba#0 = #nomhicca#0;
     #labtraba#1 = #nomhicca#1;
     |LEE 000#labtraba.=;

     |DDEFECTO #nomtmp19;
     |HAZ CamposClave;
     |LEE 101#nomtmp19.=;
     FEstado = FSalida;

     nExento = 0;

     #nomhicli#0 = #nomhicca#0;
     #nomhicli#1 = #nomhicca#1;
     #nomhicli#12 = #nomhicca#66;
     #nomhicli#2 = #nomhicca#2;
     #nomhicli#3 = #nomhicca#3;
     #nomhicli#4 = 414;
     |LEE 000#nomhicli.=;
     |SI FSalida = 0;
          nExento = #nomhicli#11 * #nomhicli#10;
     |FINSI;
     |HAZ RestoCampos;

     |SI FEstado = 0;
          |GRABA 020#nomtmp19.a;
          |LIBERA #nomtmp19;
     |SINO;
          |HAZ CamposClave;

          |GRABA 020#nomtmp19.n;
          |LIBERA #nomtmp19;
          nNumTrab = nNumTrab + 1;
     |FINSI;

     || la linea 99999

     |DDEFECTO #nomtmp19;
     |HAZ CamposClave
     #nomtmp19#6 = 999;                      || contrato
     #nomtmp19#1 = 99999;                    || codigo totalizador trab.
     |LEE 101#nomtmp19.=;
     FEstado = FSalida;
     |HAZ RestoCampos;
     |SI FEstado = 0;
          |GRABA 020#nomtmp19.a;
     |SINO;
          |GRABA 020#nomtmp19.n;
     |FINSI;
     |LIBERA #nomtmp19;
|FPRC;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #0#0, #0#2, nAnyXXDesde, #0#4, 0;
     #0#1, #0#3, nAnyXXHasta, #0#6, 20;
     ;
     NULL, nomhicca;
|FIN;

|PROCESO Tipo3;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #nomhicca;
     |ABRE #nomhicli;

     aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmp19_" + aAlfa;
     |NOME_DAT #nomtmp19#aAlfa#;
     |DELINDEX #nomtmp19;
     |ABRE #nomtmp19;

     ||nDesdeMes = #0#4;
     ||nHastaMes = #0#6;

     #0#7 = #0#5;   || a¤o hasta
     #0#8 = 000;    || contrato desde
     #0#9 = 999;    || contrato hasta

     nAnyXXDesde = #0#5 - 2000;
     nAnyXXHasta = #0#7 - 2000;

     nMes = #0#5;
     nAny = #0#4;

/*
     nElMes = nMes;
     nElAny = nAny;

     |HAZ topemes_plb;

     aOrigen = "M";
     |BUCLE nomcalca;

     aOrigen = "H";
*/
     |BUCLE nomhicca;

     |SI nNumTrab ! 0;
          ||CONSULTA_CLAVE #2#nomtmp19;
          |HAZ Excel;
     |SINO;
          aAlfa = "    No se ha ncontrado ningún trabajador ";
          aAlfa = aAlfa + "para la selección realizada";
          |MENAV aAlfa;
     |FINSI;

     |CIERRA #nomtmp19;
     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
     |CIERRA #labtraba;
     |CIERRA #labempre;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;

     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;
          |BORRA 020#0a;
     |FINSI;

     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ Tipo3;
     |FINSI;
     |GRABA 020#0n;
     |CIERRA #0;
|FPRO;
