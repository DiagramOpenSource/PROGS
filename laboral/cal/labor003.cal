|FICHEROS;
     labor003 #0;
     labor004 #4;
     labor005 #5;
     labor007 #7;
     deforige@ #150;
     defdesti@ #151;
     gecom019@ #100;
     gecom011@ #101;
     gecom014@ #104;
     labempre;
     labtraba #500;

     cargadef@  #600;
     &afichdes@ #900;
     &refesql@  #901;
     :/basica/def/dsficher #800;
|FIN;

|VARIABLES;
     &eaDirDest  = "";
     &eaAsunto   = "";
     &eaTexto    = "";
     &eaFichero  = "";

     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aEmpresa = "";
     aRutaApl = "";
     aRutaDef = "";
     aRutaDefEmp = "";
     &aRutaFich = "";
     &aRutaFichEmp = "";
     aFichero = "";
     nCampo = 0;
     nNroCampos = 0;
     aTablaTemporal = "";
     aOrigen = "";
     aDestino = "";
     aGrupo = "";
     nGrupo = 0;
     FEstado = 0;
     nEmpresa = 0;
     nCamposClave = 0;
     aMensa = "";
     nModo = 0;

     nOpcion = 0;
     {-1}menu = "";
     menu1 = "2400";
     menu2 = "1";
     menu3 = "Opciones:";
     menu4 = "ARC";
     menu5 = "Aceptar seleccion";
     menu6 = "Revisar seleccion";
     menu7 = "Salir al menu";
     aHora = "";

     aFichSql = "";
     aDef = "";
     aSelect = "";
     aFrom = "";
     aInto = "";
     aWhere = "";
     nCampoCli = 0;
     nCampoDef = 0;
     &eaEjec = "";
     aBorrar = "";
     nTCampo = 0;
     aQueQuiero = "";
     aCampo = "";
     aAplica = "";
     aDDef = "";
     aHDef = "";
     aRutaFichBas = "";

     nFichero = 0;
     nFicheros = 0;
     &aParam = "";
     swSigue = 0;
     &nEmpExt = 0;
     nDesdeEmpresa = 0;
     nHastaEmpresa = 0;
     &eaVengoDe = "";
     aParam2 = "";
     aRuta = "";
     aLon = "";
     nLon = 0;
     nCaracter = 0;
     aCaracter = "";
     nPos = 0;
     aRutaOk = "";
     nCanal = 0;
     aPassword = "";
     &enCliente = 0;
     &eaNombre = "";
     aRutaEmp = "";
     nCliente = 0;
     nOrigen = 0;
     nNume = 0;
     nHandle = 0;
     nBytes = 0;
     nSize = 0;
     aClave = 0;
     swSoloConvenios = 0;
|FIN;

/************* PROCESOS PARA EL BORRADO DE labor004 y labor005 **************/

|PROCESO borra_007;
     |BORRA 020#labor007.a;
     |LIBERA #labor007;
|FPRC;

|DEFBUCLE borra_007;
     #labor007#1;
     ;
     nCliente, 0001;
     nCliente, 9999;
     be;
     NULL, borra_007;
|FIN;

|PROCESO borra_005;
     |BORRA 020#labor005.a;
     |LIBERA #labor005;
|FPRC;

|DEFBUCLE borra_005;
     #labor005#1;
     ;
     nCliente, 001;
     nCliente, 999;
     be;
     NULL, borra_005;
|FIN;

|PROCESO borra_004;
     |BORRA 020#labor004.a;
     |LIBERA #labor004;
|FPRC;

|DEFBUCLE borra_004;
     #labor004#1;
     ;
     nCliente, "        ";
     nCliente, "zzzzzzzz";
     be;
     NULL, borra_004;
|FIN;

|PROCESO Borrado; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 3;
          nCliente = #0#9;
          |BUCLE borra_004;
          |BUCLE borra_005;
     |FINSI;
|FPRC;

/**** PROCESOS PARA EL COPIADO DE labor004 y labor005 y labor007 ****/
/****                       DESDE OTRO CLIENTE                   ****/

|PROCESO copia_007;
     #labor007#0 = #0#9;
     |GRABA 020#labor007.n;
     |LIBERA #labor007;
|FPRC;

|DEFBUCLE copia_007;
     #labor007#1;
     ;
     nOrigen, 0001;
     nOrigen, 9999;
     be;
     NULL, copia_007;
|FIN;

|PROCESO copia_005;
     #labor005#0 = #0#9;
     |GRABA 020#labor005.n;
     |LIBERA #labor005;
|FPRC;

|DEFBUCLE copia_005;
     #labor005#1;
     ;
     nOrigen, 001;
     nOrigen, 999;
     be;
     NULL, copia_005;
|FIN;

|PROCESO copia_004;
     #labor004#0 = #0#9;
     |GRABA 020#labor004.n;
     |LIBERA #labor004;
|FPRC;

|DEFBUCLE copia_004;
     #labor004#1;
     ;
     nOrigen, "        ";
     nOrigen, "zzzzzzzz";
     be;
     NULL, copia_004;
|FIN;

|PROCESO Copiado_2;
     nCliente = #0#9;
     |BUCLE borra_004;
     |BUCLE borra_005;
     |BUCLE borra_007;

     |BUCLE copia_004;
     |BUCLE copia_005;
     |BUCLE copia_007;

     aAlfa = "    Se ha copiado la configuración de exclusión de tablas ";
     aAlfa = aAlfa + "del cliente " + aOrigen;
     |MENAV aAlfa;
|FPRC;

|PROCESO Copiado;
     |PUSHV 1010 2170;
     |BLANCO 16182160;
     ||            2     3         4         5
     ||            45678901234567890123456789012345678
     |PINTA 1721, "Copiar exclusiones desde el cliente";
     |PINTA 1821, "                                   ";
     |PINTA 1921, "al cliente                         ";
     aAlfa = #0#9;
     aAlfa = ("000" + aAlfa) % -103;
     aAlfa = aAlfa + " " + #0#10;
     aAlfa = aAlfa % 123;
     |ATRI I;
     |PINTA 1932, aAlfa;
     |ATRI 0;
     E_inf = "";
     E_sup = "3";
     aOrigen = 1821 ? 1;
     |SI FSalida ! 1; |Y FSalida ! 7;
          nOrigen = aOrigen;
          |SALVA_FICHA #0;

          #0#9 = nOrigen;
          |LEE 000#0=;
          |SI FSalida = 0;
               aAlfa = #0#10;
               aAlfa = aAlfa % 123;
               |ATRI I;
               |PINTA 1825, aAlfa;
               |ATRI 0;
               |CONFI "    S¿Continuar con la copia?";
               |SI FSalida = 0;
                    |REPON_FICHA #0;
                    |HAZ Copiado_2;
                    |POPV;
                    |ACABA;
               |FINSI;

          |SINO;
              |MENAV "     Cliente no encontrado";
              |REPON_FICHA #0;
              |POPV;
              |ACABA;
          |FINSI;
     |SINO;
         |MENAV "    Copia cancelada";
     |FINSI;
     |REPON_FICHA #0;
     |POPV;
|FPRC;

|PROCESO CompRuta;
     aRuta = #0#11;
     aRutaOk = "";
     |QBT aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nCaracter = 1; |SI nCaracter [ nLon; |HACIENDO nCaracter = nCaracter + 1;
          nPos = (nCaracter * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "\";
               aCaracter = "/";
          |FINSI;
          aRutaOk = aRutaOk + aCaracter;
     |SIGUE;
     |QBF aRutaOk;
     aAlfa = aRutaOk % -101;
     |SI aAlfa ! "/";
          aRutaOk = aRutaOk + "/";
     |FINSI;
     #0#11 = aRutaOk;
     |PINTA #0#11;

     aAlfa = aRutaOk + "laboral/fich/prueba.txt";|| grabo un ficherito chorra
     |XABRE "W", aAlfa, nCanal;        || para comprobar que ha ido
     |XCIERRA nCanal;                   || bien la creacion del
     |XABRE "E", aAlfa, nCanal;        || spoolpdf
     |SI FSalida ] 0;
          |FBORRA aAlfa;
     |SINO;
          aAlfa = "    ATENCION: No se ha encontrado la carpeta " + aRutaOk;
          aAlfa = aAlfa + "/laboral/fich";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
     |XCIERRA nCanal;
|FPRC;

|PROCESO Aviso;
     |SI aParam2 = "AUTO";
          |ACABA;
     |FINSI;
     |SI aParam = "NORMAL";
          |PUSHV 11201760;
          |BLANCO 11201760;
          |CUADRO 11201760;
          ||            2       3         4         5
          ||            2345678901234567890123456789012345678
          |PINTA 1222, "            - ATENCION -             ";
          |PINTA 1322, "Este proceso sincroniza  los datos de";
          |PINTA 1422, "las empresas  seleccionadas  desde la";
          |PINTA 1522, "la carpeta general (fich) a la carpe-";
          |PINTA 1622, "      ta propia de cada empresa.     ";
     |FINSI;
     |SI aParam = "PATRONES";
          |PUSHV 11201762;
          |BLANCO 11201762;
          |CUADRO 11201762;
          ||            2       3         4         5
          ||            234567890123456789012345678901234567890
          |PINTA 1222, "             - ATENCION -              ";
          |PINTA 1322, "Este proceso actualiza los datos de los";
          |PINTA 1422, "los ficheros que no dependen del código";
          |PINTA 1522, "de empresa desde la carpeta 'general' a";
          |PINTA 1622, "   la carpeta propia de cada cliente.  ";
     |FINSI;
     |SI aParam = "INVERSA";
          |PUSHV 11201762;
          |BLANCO 11201762;
          |CUADRO 11201762;
          ||            2       3         4         5
          ||            234567890123456789012345678901234567890
          |PINTA 1222, "             - ATENCION -              ";
          |PINTA 1322, "Este proceso actualiza los datos de las";
          |PINTA 1422, "  empresas seleccionadas a la carpeta  ";
          |PINTA 1522, "           general de datos.           ";
          |PINTA 1622, "                                       ";
     |FINSI;
     |PAUSA;
     |POPV;
|FPRC;

|PROCESO Mensa; |TIPO 7;
     |MENSA "    Pulse < F5 > para activar o desactivar la copia de la empresa seleccionada";
|FPRC;

|PROCESO Activa; |TIPO 0;
     |SI FSalida = 13;
          |SI #0#3 = "S";
               #0#3 = "N";
               |GRABA 020#0a;
          |SINO;
               #0#3 = "S";
               |GRABA 020#0a;
          |FINSI;
          |PONCONTROL 23, "si";
     |SINO;
          nModo = (FEntrada / 100) ! 0;
          |SI nModo = 1;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;
/*
|PROCESO ConEmpresa;
     || aPathDefFichero = aPathDestino + "laboral/def/";
     || aPathFicOrigen  = aPathOrigen  + "laboral/fich/";
     || aPathFicDestino = aPathDestino + "laboral/fich/";

     aAplica = "laboral";
     aDDef = "";
     aHDef = "zzzzzzzzzzzz";

     |BUCLE dsficher;
|FPRC;
*/
|PROCESO CargaRutas;
     |DBASE aRutaDef;
     |QBF aRutaDef;
     aRutaDef = aRutaDef + "def/";      || ruta def actual, para CARGA_DEF
     |DFICE aRutaFich;                  || ruta fich actual

     aRutaDefEmp = #0#11 + "laboral/def/";   || ruta def empresa
     aRutaFichEmp = #0#11 + "laboral/fich/"; || ruta fich empresa, para PATH_DAT
     |QBT aRutaDefEmp;
     |QBT aRutaFichEmp;
|FPRC;

|PROCESO BorradoPrevio;
     aFichSql = ("sql" + Usuario + "zzzzzzzz") % 108;
     aOrigen  = aDef;
     aDestino = aRutaDef + "dsborsql.mas";
     |COPIA_FICHERO aOrigen, aDestino;

     |CARGA_DEF aDestino, refesql@;
     |SI FSalida = 0;
          |PATH_DAT #901 aRutaFichEmp;       || origen: el "por empresa"
          |NOME_DAT #901 aFichSql;           || que es el que quiero borrar

          aSelect = "SELECT * ";
          aFrom   = "FROM "  + "dsborsql ";
          aInto   = "INTO "  + aFichSql + ".def ";
          aWhere  = "WHERE " + nCampoCli + " == " + aClave;
          eaEjec  =  aSelect + aFrom + aInto + aWhere;
          |SUB_EJECUTA_NP "labor002;BORRADO";

          |PATH_DAT #901 aRutaFich;     || origen: esta en el fich
          |ABRET #900;
          |ABRET #901;
          |LEE 040#901p;
          |PARA;  |SI FSalida = 0;  |HACIENDO;
               |PARA nCampoDef = 0;  |SI nCampoDef [ nTCampo;  |HACIENDO nCampoDef = nCampoDef + 1;
                    #900nCampoDef = #901nCampoDef;
               |SIGUE;
               #900nCampoCli = aClave;

               |LEE 101#900=;
               |SI FSalida = 0;
                    |BORRA 020#900a;
               |FINSI;

               |LIBERA #900;

               |LEE 000#901s;
          |SIGUE;
          |CIERRAT #900;
          |CIERRAT #901;

          |DELINDEX #901;

          |DESCARGA_DEF #refesql@;
     |FINSI;

     aBorrar  = aRutaDef + aFichSql  + ".mas";  |FBORRA aBorrar;
     aBorrar  = aRutaDef + "dsborsql.mas";      |FBORRA aBorrar;

     aOrigen  = aRutaDef + "dsborsq1.mas";
     aDestino = aRutaDef + "dsborsql.mas";

     |COPIA_FICHERO aOrigen, aDestino;
|FPRC;

|PROCESO PorSQL;
     aDef = aDef + ".mas";
     |HAZ BorradoPrevio;

     aFichSql = ("sql" + Usuario + "zzzzzzzz") % 108;
     aOrigen  = aDef;
     aDestino = aRutaDef + "dsborsql.mas";
     |COPIA_FICHERO aOrigen, aDestino;

     |CARGA_DEF aDestino, refesql@;
     |SI FSalida = 0;
          |PATH_DAT #901 aRutaFich;          || origen: el "general"
          |NOME_DAT #901 aFichSql;

          aSelect = "SELECT * ";
          aFrom   = "FROM "  + "dsborsql ";
          aInto   = "INTO "  + aFichSql + ".def ";
          aWhere  = "WHERE " + nCampoCli + " == " + aClave;
          eaEjec  =  aSelect + aFrom + aInto + aWhere;
          |SUB_EJECUTA_NP "labor002;ACHILIPUM";

          |PATH_DAT #901 aRutaFich;          || origen: el "general"
          |ABRET #900;
          |ABRET #901;
          |LEE 040#901p;
          |PARA;  |SI FSalida = 0;  |HACIENDO;
               |PARA nCampoDef = 0;  |SI nCampoDef [ nTCampo;  |HACIENDO nCampoDef = nCampoDef + 1;
                    #900nCampoDef = #901nCampoDef;
               |SIGUE;
               |GRABA 020#900n;
               |LIBERA #900;

               |LEE 000#901s;
          |SIGUE;
          |CIERRAT #900;
          |CIERRAT #901;

          |DELINDEX #901;

          |DESCARGA_DEF #refesql@;
     |FINSI;

     aBorrar  = aRutaDef + aFichSql  + ".mas";  |FBORRA aBorrar;
     aBorrar  = aRutaDef + "dsborsql.mas";      |FBORRA aBorrar;

     aOrigen  = aRutaDef + "dsborsq1.mas";
     aDestino = aRutaDef + "dsborsql.mas";

     |COPIA_FICHERO aOrigen, aDestino;

     |PULSATECLA;
|FPRC;

|PROCESO TrataFichero;
     aDef = aRutaDef + aFichero;
     |CARGA_DEF aDef, afichdes@;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     aQueQuiero = "|NC";
     aCampo     = #900#aQueQuiero#;
     nTCampo    = aCampo;
     nTCampo    = nTCampo - 1;

     |PATH_DAT #900 aRutaFichEmp;       || destino: el "por empresa"

     |HAZ PorSQL;

     |DESCARGA_DEF #afichdes@;
|FPRC;

|PROCESO PintaProgreso;
     nFichero = nFichero + 1;
     |SI aParam2 = "AUTO";
          |ACABA;
     |FINSI;
     aAlfa1 = nFichero;
     aAlfa2 = nFicheros;

     aAlfa = #800#1;
     |PINTA 1540, aAlfa;
     |SI swSoloConvenios = 1;
          aAlfa = aFichero;
          |PINTA 1540, aAlfa;
          aAlfa = #labor005#1;
          |QBF aAlfa;
          aAlfa = ("000" + aAlfa) % -103;
          aAlfa = "Conv. " + aAlfa;
          |PINTA 1640, aAlfa;
     |SINO;
          aAlfa = "             ";
          |PINTA 1640, aAlfa;
     |FINSI;

     |SI swSoloConvenios = 1;
          || nada;
     |SINO;
          |SI aParam ! "PATRONES"; |Y aParam ! "INVERSA";
               aAlfa = aAlfa1 + " de " + aAlfa2;
               |PINTA 1640, aAlfa;
          |SINO;
               |PINTA 1629, "                         ";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ProcedeAlFichero;
     |HAZ TrataFichero;

     |HAZ PintaProgreso;

     |SI #800#27 = "S";
         nCampoCli = #800#28;
         |HAZ TrataFichero;
     |FINSI;
|FPRC;

|PROCESO clausulas;
     |HAZ CargaRutas;
     nCampoCli = 1;
     aClave = #7#1;

     aFichero = "labclaus";
     |HAZ ProcedeAlFichero;
|FPRC;

|DEFBUCLE labor007;
     #labor007#1;
     ;
     #0#9, 0001;
     #0#9, 9999;
     ;
     NULL, clausulas;
|FIN;

|PROCESO convenios;
     |HAZ CargaRutas;
     nCampoCli = 0;
     aClave = #5#1;

     aFichero = "nomconca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcateg";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcatca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcatli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconax";
     |HAZ ProcedeAlFichero;

     aFichero = "nompagfe";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconfi";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfinca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfinli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconre";
     |HAZ ProcedeAlFichero;

     aFichero = "labdicoc";
     |HAZ ProcedeAlFichero;

     aFichero = "labdicol";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconay";
     |HAZ ProcedeAlFichero;

     aFichero = "nomconat";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantig";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcatac";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcatal";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfichi";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfilhi";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfinca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomfinli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomvart3";
     |HAZ ProcedeAlFichero;

     aFichero = "nomdesam";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantig";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantil";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantpc";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantpl";
     |HAZ ProcedeAlFichero;

     aFichero = "labproco";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcarca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcarli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcorca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomcorli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomlisco";
     |HAZ ProcedeAlFichero;

     aFichero = "nomexdca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomexdli";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantca";
     |HAZ ProcedeAlFichero;

     aFichero = "nomantli";
     |HAZ ProcedeAlFichero;
|FPRC;

|DEFBUCLE labor005;
     #labor005#1;
     ;
     #0#9, 001;
     #0#9, 999;
     ;
     NULL, convenios;
|FIN;

|PROCESO Exclusiones;
/*
     #labor004#0 = #0#9;
     #labor004#2 = aFichero;
     |LEE 000#labor004.=;
     |SI FSalida = 0;
*/
     aAlfa1 = #labor004#2;
     |QBF aAlfa1;
     aAlfa = aFichero - aAlfa1;
     aAlfa = aAlfa % 0;
     nNume = aAlfa;
     |SI nNume ! 8;
          |SI #labor004#4 = "S";
               |SI aFichero = "nomconca";
                    || aqui lo de los convenios
                    |BUCLE labor005;
                    swSigue = 0;
               |SINO;
                    swSigue = 0;
               |FINSI;
               |SI aFichero = "labclaus";
                    || aqui lo de las clausulas
                    |BUCLE labor007;
                    swSigue = 0;
               |SINO;
                    swSigue = 0;
               |FINSI;
          |FINSI;
          |SI aParam = "AUTO";
               |SI #labor004#5 = "M";
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aFichero = "nomconca"; |O aFichero = "nomconli"; |O aFichero = "nomcateg";
     |O aFichero = "nomcatca"; |O aFichero = "nomcatli"; |O aFichero = "nomconax";
     |O aFichero = "nompagfe"; |O aFichero = "nomconfi"; |O aFichero = "nomfinca";
     |O aFichero = "nomfinli"; |O aFichero = "nomcocop"; |O aFichero = "nomconre";
     |O aFichero = "labdicol"; |O aFichero = "nomconay"; |O aFichero = "nomconat";
     |O aFichero = "nomantig"; |O aFichero = "nomcatac"; |O aFichero = "nomcatal";
     |O aFichero = "nomfichi"; |O aFichero = "nomfilhi"; |O aFichero = "nomfinca";
     |O aFichero = "nomfinli"; |O aFichero = "labdicoc"; |O aFichero = "nomvart3";
     |O aFichero = "nomdesam"; |O aFichero = "nomantig"; |O aFichero = "nomantil";
     |O aFichero = "nomantca"; |O aFichero = "nomantli"; |O aFichero = "nomantpc";
     |O aFichero = "nomantpl"; |O aFichero = "labproco"; |O aFichero = "nomcarca";
     |O aFichero = "nomcarli"; |O aFichero = "nomexdca"; |O aFichero = "nomexdli";
     |O aFichero = "labclaus";
     |O aFichero = ""; |O aFichero = "";
          swSigue = 0;
     |FINSI;
|FPRC;

|DEFBUCLE Exclusiones;
     #labor004#1;
     ;
     #0#9, "        ";
     #0#9, "zzzzzzzz";
     ;
     NULL, Exclusiones;
|FIN;

|PROCESO Purga;
     aOrigen = aRutaFich + aFichero + ".dat";
     |XABRE "B", aOrigen, nHandle;
     |SI FSalida ] 0;
          nBytes = 0;
          |XPOSICION nHandle, nBytes, 2;
          |SI nBytes = 0;
               swSigue = 0;
          |FINSI;
     |SINO;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     aAlfa = aFichero % 101;
     |SI aAlfa = "."; |O aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
     |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7"; |O aAlfa = "8";
     |O aAlfa = "9"; |O aAlfa = "E"; |O aAlfa = "T"; |O aAlfa = "_";
     |O aAlfa = "U"; |O aAlfa = "X";
          swSigue = 0;
     |FINSI;

     aAlfa = aFichero % 102
     |SI aAlfa = "fo"; |O aAlfa = "f0"; |O aAlfa = "f1"; |O aAlfa = "fe";
     |O aAlfa = "g0"; |O aAlfa = "h1"; |O aAlfa = "i1";
     |O aAlfa = "l1"; |O aAlfa = "li";
     |O aAlfa = "n0"; |O aAlfa = "n1"; |O aAlfa = "nh"; |O aAlfa = "rr";
     |O aAlfa = "s0"; |O aAlfa = "s1"; |O aAlfa = "t0"; |O aAlfa = "t1";
     |O aAlfa = "tc"; |O aAlfa = "tl"; |O aAlfa = "tm"; |O aAlfa = "u0";
     |O aAlfa = "u1"; |O aAlfa = "x0"; |O aAlfa = "x1"; |O aAlfa = "y0";
     |O aAlfa = "y1"; |O aAlfa = "tf";
     |O aAlfa = "b0"; |O aAlfa = "b1";
     |O aAlfa = "c0"; |O aAlfa = "c1"; |O aAlfa = "c3"; |O aAlfa = "c4";
     |O aAlfa = "d0"; |O aAlfa = "d1"; |O aAlfa = "e0"; |O aAlfa = "e1";
     |O aAlfa = "m0"; |O aAlfa = "m1";
     |O aAlfa = "w0"; |O aAlfa = "w1"; |O aAlfa = "w3";
     |O aAlfa = "EP"; |O aAlfa = "ep";
          swSigue = 0;
     |FINSI;

     aAlfa = aFichero % 105;
     |SI aAlfa = "creta";
          swSigue = 0;
     |FINSI;

     |SI aFichero = "silcon02"; |O aFichero = "silcon03"; |O aFichero = "labcer06";
     |O aFichero = "silcon01"; |O aFichero = "nomcontr";
     |O aFichero = "labhisce"; |O aFichero = "nomgirco"; |O aFichero = "labhisto";
     |O aFichero = "labor001"; |O aFichero = "labor002"; |O aFichero = "labor003";
     |O aFichero = "labor004"; |O aFichero = "labor005"; |O aFichero = "laborn22";
     |O aFichero = "labpen01"; |O aFichero = "labpen02"; |O aFichero = "labpen03";
     |O aFichero = "labrecon"; |O aFichero = "labregtm"; |O aFichero = "labretmp";
     |O aFichero = "marin006"; |O aFichero = "marin007"; |O aFichero = "nomagicm";
     |O aFichero = "nomagicu"; |O aFichero = "nomagide"; |O aFichero = "nomagitm";
     |O aFichero = "nombanco"; |O aFichero = "nomcalat"; |O aFichero = "nomcalcu";
     |O aFichero = "nomcalf1"; |O aFichero = "nomcalfi"; |O aFichero = "nomcaltt";
     |O aFichero = "labor007";
          swSigue = 0;
     |FINSI;

     |SI aFichero = "nomcom01"; |O aFichero = "nomcom02"; |O aFichero = "nomauxi1";
     |O aFichero = "nomauxi2"; |O aFichero = "nomconta"; |O aFichero = "nomcontb";
     |O aFichero = "nomconta"; |O aFichero = "nomcuadr"; |O aFichero = "nomdator";
     |O aFichero = "nomgir00"; |O aFichero = "nomgirtm"; |O aFichero = "nomgrubc";
     |O aFichero = "nomgrubl"; |O aFichero = "nomgruec"; |O aFichero = "nomgruel";
     |O aFichero = "nomir999"; |O aFichero = "nomlogca"; |O aFichero = "nomlogli";
     |O aFichero = "nompmail"; |O aFichero = "nomtraen"; |O aFichero = "nomrentm";
     |O aFichero = "nomvenc2"; |O aFichero = "nomw0020"; |O aFichero = "pdfcontr";
     |O aFichero = "taiclaoc"; |O aFichero = "thitiaca"; |O aFichero = "silcon09";
          swSigue = 0;
     |FINSI;

     |SI aFichero = "labcontr";
          |DBASS aAlfa; |QBF aAlfa;
          aAlfa1 = #0#4; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aAlfa = aAlfa + "laboral/fich/" + aAlfa1 + "/" + aFichero + ".dat";
          |XABRE "B", aAlfa, nHandle;
          |SI FSalida = 0;
               |XPOSICION nHandle, nSize, 2;
               |SI nSize ! 0;
                    swSigue = 0;
               |FINSI;
          |FINSI;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO CopiaSinEmpresa2;
     #800#0 = "laboral ";
     #800#1 = aFichero + ".mas";
     |LEE 000#800=;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     aOrigen = aRutaFich + aFichero + ".dat";

     swSigue = 1;
     |HAZ Purga;

     |BUCLE Exclusiones;

     |SI swSigue = 0; |ACABA; |FINSI;

     |HAZ PintaProgreso;

     || cojo la ruta del geco

     aRutaFichEmp = #0#11;
     |QBF aRutaFichEmp;
     aRutaFichEmp = aRutaFichEmp + "laboral/fich/";

     aDestino = aRutaFichEmp + aFichero + ".dat";
     |COPIA_FICHERO aOrigen, aDestino;

     aOrigen = aRutaFich + aFichero + ".ddx";
     aDestino = aRutaFichEmp + aFichero + ".ddx";
     |COPIA_FICHERO aOrigen, aDestino;

     aOrigen = aRutaFich + aFichero + ".ixx";
     aDestino = aRutaFichEmp + aFichero + ".ixx";
     |COPIA_FICHERO aOrigen, aDestino;
|FPRC;

|PROCESO ElDir;
     aFichero = aRutaFich + "*.dat";
     |_PDIR aFichero;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aFichero = aFichero - ".dat";
          aFichero = aFichero % -108

          |HAZ CopiaSinEmpresa2;

          |_SDIR aFichero;
     |SIGUE;
|FPRC;

|PROCESO SoloConvenios;
     |BUCLE labor005;
|FPRC;

|PROCESO SinEmpresa;
     aAplica     = "laboral";
     |ABRE #labor004;
     |ABRE #labor005;
     |ABRE #labor007;

     |SI swSoloConvenios = 0;
          |HAZ ElDir;
     |SINO;
          |HAZ SoloConvenios;
     |FINSI;

     |CIERRA #labor007;
     |CIERRA #labor005;
     |CIERRA #labor004;
|FPRC;

|PROCESO ElContador;
     nFicheros = 0;
     aFichero = aRutaFich + "*.dat";
     |_PDIR aFichero;
     |PARA; |SI FSalida = 0; |HACIENDO;
          swSigue = 1;
          |HAZ Purga;
          |SI swSigue = 1;
               nFicheros = nFicheros + 1;
          |FINSI;
          |_SDIR aFichero;
     |SIGUE;
|FPRC;

|PROCESO CargaRutas2;
     aEmpresa = #0#4;
     |QBF aEmpresa;
     aEmpresa = ("00000" + aEmpresa) % -105;

     |DBASE aRutaDef;
     |QBF aRutaDef;
     aRutaDef = aRutaDef + "def/";      || ruta def actual, para CARGA_DEF

     || aRutaDef = aRutaDef + aFichero;    || con fichero, para CARGA_DEF

     |DFICE aRutaFich;                  || ruta fich actual

     aRutaFichEmp = aRutaFich + aEmpresa + "/"; || ruta fich empresa, para PATH_DAT

     |DBASS aRutaFichBas;
     |QBF aRutaFichBas;
     aRutaFichBas = aRutaFichBas + "basica/fich/"
|FPRC;

|PROCESO gecom014_001;
     eaDirDest = #gecom014@#6;
     |HAZ SendMail;
|FPRC;

|DEFBUCLE gecom014_001;
     #104#1003#;
     ;
     #labor003#0, 001, "          ";
     #labor003#0, 999, "zzzzzzzzzz";
     ;
     NULL, gecom014_001;
|FIN;

|PROCESO Email;
     || Emite correo electronico al usuario de que la empresa ha sido
     ||    sincronizada

     aAlfa = #labor003#10; |QBF aAlfa;
     eaTexto = &13 + &10 + "El administrador ha actualizado los ficheros patrones del cliente " + aAlfa; |QBF eaTexto;
     aAlfa = #labor003#11; |QBF aAlfa;
     eaTexto = eaTexto + ", carpeta " + aAlfa + ".";
     eaTexto = eaTexto + &13 + &10 + &13 + &10;
     eaTexto = eaTexto + " Actualizacion con fecha " + #labor003#6 + " a las " + #labor003#7 + &13 + &10;

     aAlfa = #labor003#10; |QBF aAlfa;
     eaAsunto  = "Actualizado cliente " + aAlfa + "."; |QBF eaAsunto;
     eaFichero = "";
     eaDirDest = "";

     || me quedo aqui, claro es que no se si tengo que hacer algo mas
     || no se donde tengo que mandar el correo, de hecho ¨tengo que mandar
     || el correo? De moemnto no hago este proceso hasta que me digan algo

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa % -109;
     |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
        aAlfa = "/u/dsmedida/gecochek/def/gecom014.mas";
     |SINO;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "gecochek/def/gecom014.mas";
     |FINSI;

     |CARGA_DEF aAlfa, gecom014@;
     |SI FSalida = 0;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa % -109;
        |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
           aAlfa = "/u/dsmedida/gecochek/fich/";
        |SINO;
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "/gecochek/fich/";
        |FINSI;

        |PATH_DAT #gecom014@#aAlfa#;
        |ABRE #gecom014@;
        |BUCLE gecom014_001;
        |CIERRA #gecom014@;
        |DESCARGA_DEF #gecom014@;
     |FINSI;
|FPRC;

|PROCESO Sincroniza;
     |HAZ CargaRutas2;

     |PATH_DAT #800 aRutaFichBas;
     |ABRE #800;    || el dsficher

     nEmpresa = #labor003#1;

     |SI aParam2 ! "AUTO";
          |PUSHV 11281754;
          |BLANCO 11281754;
          |CUADRO 11281754;
          ||            23         4         5
          ||            9012345678901234567890123
          |ATRI R;
          |PINTA 1229, "      PROCESANDO ...     ";
          |ATRI I;
          |PINTA 1429, " Cliente.:               ";
          |PINTA 1529, " Fichero.:               ";
          |PINTA 1629, " Progreso:               ";
          |ATRI 0;

          aAlfa = #0#10 % 114;
          |PINTA 1440, aAlfa;
     |FINSI;

     nFichero = 0;
     nFicheros = 0;

     |SI swSoloConvenios = 0;
          |HAZ ElContador;
     |FINSI;

     |SI aParam = "NORMAL"; |O aParam = "PATRONES";
          |HAZ SinEmpresa;
     |FINSI;

     |CIERRA #800;

     |POPV;

     #0#6 = ~;
     |HORA aHora;
     #0#7 = aHora;
     #0#8 = (Usuario % 810);
     |SI nEmpExt = 0;
          |GRABA 020#0a;

          ||HAZ Email;
     |FINSI;
|FPRC;

|DEFBUCLE labor003;
     #labor003#1;
     3;
     001, "S";
     999, "S";
     be;
     NULL, Sincroniza;
|FIN;

|PROCESO Sincronizacion;
     |BUCLE labor003;

     |SI nEmpExt = 0; |Y aParam2 ! "AUTO";
          aAlfa = "    Se ha realizado la copia de los ficheros patrones en las ";
          aAlfa = aAlfa + "carpetas seleccionadas";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO superior;
     #0#9 = 999;
|FPRC;

|PROCESO inferior;
     #0#9 = 001;
|FPRC;

|PROCESO graba;
     aGrupo = aRutaApl % -201;
     nGrupo  = aGrupo;
     |SI nGrupo = 0;
         nGrupo = 1;
     |FINSI;
     aAlfa = aRutaApl % -109;
     |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
          aGrupo = "1";
          nGrupo = 1
     |FINSI;

     #0#0 = #100#0;
     #0#1 = #100#1;
     |LEE 101#0=;
     FEstado = FSalida;

     #0#0 = #100#0;      || cliente
     #0#1 = #100#1;      || empresa laboral
     #0#2 = #100#2;      || nombre empresa
     #0#3 = "S";         || activado Si de momento

     #101#0 = #0#0;      || cliente
     |LEE 000#101=;
     |SI FSalida = 0;
          aAlfa = aGrupo + (("00" + #101#1) % -102) + "01";  || carpeta cliente (del fich)
          #0#4 = aAlfa;
          #0#5 = #101#2;    || nombre cliente gecochek
     |SINO;
          || error;
     |FINSI;

     |SI FEstado = 0;
          |GRABA 020#0a;
     |SINO;
          |GRABA 020#0n;
     |FINSI;
|FPRC;

|DEFBUCLE empresas;
     #100#1002;
     ;
     nDesdeEmpresa, 00001;
     nHastaEmpresa, 99999;
     ;
     NULL, graba;
|FIN;

|PROCESO CargaEmpresas;
     |ABRE #0;
     |DBASS aRutaApl;
     |QBF aRutaApl;
     aAlfa = aRutaApl % -109;
     |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
          aRutaDef = "/u/dsmedida/gecochek/def/gecom019";      || ruta def actual, para CARGA_DEF
          aRutaFich = "/u/dsmedida/gecochek/fich/";      || ruta def actual, para CARGA_DEF
     |SINO;
          |DBASS aRutaApl;
          aRutaDef = aRutaApl + "/gecochek/def/gecom019";      || ruta def actual, para CARGA_DEF
          aRutaFich = aRutaApl + "/gecochek/fich/";      || ruta def actual, para CARGA_DEF
     |FINSI;
     |CARGA_DEF aRutaDef, gecom019@;
     |PATH_DAT #100 aRutaFich;

     |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
          aRutaDef = "/u/dsmedida/gecochek/def/gecom011";      || ruta def actual, para CARGA_DEF
          aRutaFich = "/u/dsmedida/gecochek/fich/";      || ruta def actual, para CARGA_DEF
     |SINO;
          |DBASS aRutaApl;
          aRutaDef = aRutaApl + "/gecochek/def/gecom011";      || ruta def actual, para CARGA_DEF
          aRutaFich = aRutaApl + "/gecochek/fich/";      || ruta def actual, para CARGA_DEF
     |FINSI;
     |CARGA_DEF aRutaDef, gecom011@;
     |PATH_DAT #101 aRutaFich;

     |ABRE #101;
     |SI nEmpExt = 0;
          nDesdeEmpresa = 00001;
          nHastaEmpresa = 99999;
     |SINO;
          nDesdeEmpresa = nEmpExt;
          nHastaEmpresa = nEmpExt;
     |FINSI;

     |BUCLE empresas;
     |CIERRA #101;

     |DESCARGA_DEF #gecom019@;
     |DESCARGA_DEF #gecom011@;
     |CIERRA #0;
|FPRC;

|DEFBUCLE labor003_una;
     #labor003#1;
     ;
     nCliente;
     nCliente;
     be;
     NULL, Sincroniza;
|FIN;

|PROCESO SincUnaSola;
     || sincronizamos la empresa que se encuentre en la linea que la que
     || estemos, en la que hayamos pulsado el F7

     nCliente = #0#9;

     aAlfa1 = nCliente;
     aAlfa1 = ("000" + aAlfa1) % -103;

     aAlfa2 = #0#10;
     |QBF aAlfa2;
     aAlfa2 = aAlfa2 % 125;

     |SI swSoloConvenios = 1;
          aAlfa = "0000NSe copiarán a la carpeta del cliente los ";
          aAlfa = aAlfa + "Convenios seleccionados. ¿Continuar?";
     |SINO;
          aAlfa = "0000N¿Desea sincronizar al cliente seleccionado: ";
          aAlfa = aAlfa + aAlfa1 + " - " + aAlfa2 + "?";
     |FINSI;
     |CONFI aAlfa;
     |SI FSalida = 0;
          |BUCLE labor003_una;

          |SI swSoloConvenios = 1;
               aAlfa = "    Se ha realizado la copia de convenios al ";
               aAlfa = aAlfa + "cliente seleccionado.";
          |SINO;
               aAlfa = "    Se ha realizado la sincronización de los datos del ";
               aAlfa = aAlfa + "cliente seleccionado.";
          |FINSI;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Excep0; |TIPO 0;
     |SI FSalida = 13;
          enCliente = #0#9;
          eaNombre = #0#10;
          |SUB_EJECUTA "labor004";
          |ERROR;
     |FINSI;
     |SI FSalida = 14;
          |HAZ Copiado;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Excep11; |TIPO 11;
     swSoloConvenios = 0;
     |SI FSalida = 13;
          enCliente = #0#9;
          eaNombre = #0#10;
          |SUB_EJECUTA "labor004";
     |FINSI;
     |SI FSalida = 14;
          |HAZ Copiado;
     |FINSI;
     |SI FSalida = 15;
          |SALVA_FICHA #labor003;
          |HAZ SincUnaSola;
          |REPON_FICHA #labor003;
          |ERROR;
     |FINSI;
     |SI FSalida = 17;
          enCliente = #0#9;
          eaNombre = #0#10;
          |SUB_EJECUTA "labor004;CONVENIOS";
     |FINSI;
     |SI FSalida = 18;
          swSoloConvenios = 1;
          |SALVA_FICHA #labor003;
          |HAZ SincUnaSola;
          |REPON_FICHA #labor003;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Desactiva;
     #0#3 = "N";
     |GRABA 020#0a;
     |LIBERA #0;
|FPRC;

|DEFBUCLE Desactiva;
     #0#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Desactiva;
|FIN;

|PROGRAMA;
/*
     aParam = aParam % 106;
     |QBF aParam;
     aParam2 = PARAMETRO;
     aParam2 = aParam2 % 804;
     |QBF aParam2;

     |BUCLE Desactiva;   || inicialmente las pongo todas a "N" de lo que estaba
                         || grabado de la ultima vez, cuando despues compruebe
                         || que estan en el gecochek las activare
     |HAZ CargaEmpresas;

*/
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "AUTO";
          aParam2 = "AUTO";
          aParam = "PATRONES";
     |FINSI;
     |SI aParam2 = "AUTO";
          |HAZ Sincronizacion;
          |ACABA;
     |SINO;
          |CUADRO 1218 1565;
          |PINTA 1320, "Introduzca contrase¤a:";
          E_inf = "";
          E_sup = "20";
          aPassword = 1342 ? -1;
          |SI aPassword ! "<MYPASWD>     ";
          |Y aPassword ! "<MYPASWD>               ";
              |MENAV "     Permiso denegado.";
              |ACABA;
          |FINSI;

          aParam = "PATRONES";
          |PARA; |SI; |HACIENDO;
               |ENTLINEAL #1#0, -1, 1, 22, 1, inferior, superior;
               |ENTLINEAL #1#0, -1, 7, 22, 1, inferior, superior;
               |MENU menu;
               nOpcion = FSalida;
               |SI nOpcion = 1;
                    |HAZ Aviso;
                    aAlfa = "0000N¿Desea continuar con el proceso?";
                    |CONFI aAlfa;
                    |SI FSalida = 0;
                         |HAZ Sincronizacion;
                         nOpcion = 3;
                    |SINO;
                         nOpcion = 2;
                    |FINSI;
               |FINSI;
               |SI nOpcion = 2;
               |FINSI;
               |SI nOpcion = 3; |O nOpcion < 0;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRO;
