|FICHEROS;
     laborb03;        || este def
     laborb04,MANTE;        || lineas
     nomir003;

     :basica/agidanif;
     :/integral/def/dsam0103;

     laborn10;
|FIN;

|VARIABLES;
     &nLabornet  = 0;
     &enNumLinea = 0;
     &enEmpLabornet = 0;
     &enTraLabornet = 0;
     &enHorasSemana = 0;
     &eaTipoJornada = "";
     &eaPrimerDia = "";
     &eaUltimoDia = "";
     &eaSalario = "";
     &enDurMeses = 0;
     &enDurDias = 0;
     &eaFechaIni = "";
     &eaFechaFin = "";

     &nEmpExt    = 0;
     &nTraExt    = 0;
     &fFechaAlta = @;
     &aTipoContr = "";

     &eaDirDest  = "";
     &eaAsunto   = "";
     &eaTexto    = "";
     &eaFichero  = "";
     &eaNif      = "";

     aObser = ""; ||Variable para la recogida de observaciones
     nCampo         = 0;
     nCampo1        = 0;
     nCampo2        = 0;
     nCampo3        = 0;
     nCampo4        = 0;
     nCampo5        = 0;
     nCampo6        = 0;
     nCampo7        = 0;
     nCampo8        = 0;
     nRegis         = 0;
     nAscci         = 0;
     nHandle        = 0;
     nError         = 0;
     nLinea         = 0;
     nCalc          = 0;
     nAnyo          = 0;

     fFecha         = @;

     aParam     = "";
     aCampo         = "";
     aCaracter      = "";
     aWeb           = "";
     aAbre          = "";
     aAbreSmf       = "";
     aAlfa          = "";
     aBase          = "";
     aMas           = "";
     aFichLab       = "";
     aFichInt       = "";
     aFichBas       = "";
     aTecla         = "";
     &nSinPI        = 0;
     aCopialo1      = "";
     aCopialo2      = "";
     &aFlag         = "";
     &aTitulo       = "";

     &nEmp = 0;
     &nTra = 0;
     &aCons = "";
     &aImp = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aFecha = "";
     nNume = 0;
     swCopia = 0;
     nExiste = 0;
     nPan = 0;
     &eaUsuario = "";
     &eaFecha = @;
     &eaHora = "";
     aTipo = "";
     fec = "";
     aUsuarioD = "";
     aUsuarioH = "";
     aSiEsX    = "";
     FEstado   = 0;

     &eaVengoDe = "laborn01";
     &eaEmpresa = "";
     &eaObra = "";
     &eaContrato = "";

     &eaParam       = "";
     &enFSalida     = 0;
     &efFecha       = @;
     &enBorrado     = 0;
     &enActualizado = 0;
     &eaEstado      = "";
     &eaMotiv       = "";

     &enEmpresa = 0;
     &enTrabajador = 0;
     &enNuevoCodigo = 0;
     &enRegistroCont = 0;

     aMensa = "";
     eaID = "";
     &enID = 0;
     nEntrada = 0;
     aNif = "";

     nFinLin = 0;
     swTitular = 0;
     swCuenta = 0;
     nUltima = 0;
     nSuma = 0;
     nLin = 0;
|FIN;

/********************** PROCESOS DEL LABORB04 *******************************/

|PROCESO False;
     |SI #laborb04#nCampo# = "F";
          #laborb04#nCampo# = "N";
          |PINTA #laborb04#nCampo#;
     |FINSI;
|FPRC;

|PROCESO Color;
     nCampo2 = nCampo1 + nSuma;
     aAlfa1 = #laborb04#nCampo1#; |QBF aAlfa1;
     aAlfa2 = #laborb04#nCampo2#; |QBF aAlfa2;
     nNume = (nLin * 100) + 7;
     |SI nCampo1 = 76;
          nNume = (nLin * 100) + 15;
     |FINSI;
     |SI aAlfa1 ! aAlfa2;
          |ATRI S;
          |PINTA nNume, aAlfa;
          |ATRI 0;
     |SINO;
          |ATRI 0;
          |PINTA nNume, aAlfa;
          |ATRI 0;
     |FINSI;
|FPRC;

|PROCESO Previo; |TIPO 7;
     nCampo = 97; |HAZ False; nCampo = 40; |HAZ False;
     nCampo = 76; |HAZ False; nCampo = 19; |HAZ False;
     nCampo = 61; |HAZ False; nCampo = 4; |HAZ False;
     nCampo = 63; |HAZ False; nCampo = 6; |HAZ False;
     nCampo = 102; |HAZ False;

     |SI #laborb04#44 = "S"; |O #laborb04#45 = "S";
          #laborb04#45 = "S";
          |PINTA #laborb04#45;
     |FINSI;

     |ATRI S;

     |SI #laborb04#117 = "A"; |PINTA 0968, "    ALTA    "; |FINSI;
     |SI #laborb04#117 = "M"; |PINTA 0968, "MODIFICACION"; |FINSI;
     |SI #laborb04#117 = "B"; |PINTA 0968, "    BAJA    "; |FINSI;

     aAlfa = #laborb04#3;
     |QBF aAlfa;

     |SI aAlfa = "TITULAR";
          |PINTA 0968, "MODIFICACION";
          |PINTA 1068, " PERCEPTOR. ";
     |FINSI;
     |SI aAlfa = "DESCENDIENTE"; |PINTA 1068, "DESCENDIENTE"; |FINSI;
     |SI aAlfa = "ASCENDIENTE";  |PINTA 1068, "ASCENDIENTE."; |FINSI;

     |ATRI 0;

     nSuma = -57;
     nCampo1 = 71;  aAlfa = "Fecha Nacim.:"; nLin = 9; |HAZ Color;
     nCampo1 = 73;  aAlfa = "Sit.Familiar:"; nLin = 10; |HAZ Color;
     nCampo1 = 97;  aAlfa = "Mov.geogr f.:"; nLin = 11; |HAZ Color;
     nCampo1 = 75;  aAlfa = "Discap.";       nLin = 12; |HAZ Color;
     nCampo1 = 76;  aAlfa = "Mov.:";         nLin = 12; |HAZ Color;
     nCampo1 = 102; aAlfa = "Vivienda ...:"; nLin = 13; |HAZ Color;
     nCampo1 = 69;  aAlfa = "Nombre .....:"; nLin = 16; |HAZ Color;
     nCampo1 = 67;  aAlfa = "Apellido 1..:"; nLin = 17; |HAZ Color;
     nCampo1 = 68;  aAlfa = "Apellido 2..:"; nLin = 18; |HAZ Color;
     nCampo1 = 66;  aAlfa = "NIF ........:"; nLin = 19; |HAZ Color;
     nCampo1 = 99;  aAlfa = "A¤o adopci¢n:"; nLin = 20; |HAZ Color;
     nCampo1 = 61;  aAlfa = "Por entero .:"; nLin = 21; |HAZ Color;
     nCampo1 = 63;  aAlfa = "Convivencia.:"; nLin = 22; |HAZ Color;

     nSuma = -2;
     nCampo1 = 121; aAlfa = "Anual.Hijos.:"; nLin = 14; |HAZ Color;
     nCampo1 = 122; aAlfa = "Pensi¢n C¢n.:"; nLin = 15; |HAZ Color;
|FPRC;

/****************************************************************************/

|| Actualizar Datos ------------------------------------------------------

|PROCESO agidanif;
     |SI swCuenta = 1;
          nUltima = #agidanif#1;
     |SINO;
          |SI #laborb04#9 = #agidanif#8;
               nLinea = #agidanif#1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agidanif;
     #agidanif#1;
     ;
     #laborb04#2, 01;
     #laborb04#2, 99;
     ;
     NULL, agidanif;
|FIN;

|PROCESO laborb04;
     |SI swTitular = 1;
          || si he modificado el titular, termino, ya que es una solicitud
          || de modificación de datos del perceptor, aunque luego vengan
          || mas lineas

          |ACABA;
     |FINSI;

     aAlfa = #laborb04#3;
     |QBF aAlfa;
     |SI #laborb04#1 = 01; |Y aAlfa = "TITULAR";
          || modificacion de datos del titular
          swTitular = 1;
          #laborb04#117 = "M";
          nLinea = 01;
     |SINO;
          |SI #laborb04#117 = "A";
               || alta, de lo que sea
               nUltima = 00;
               nLinea = 00;
               swCuenta = 1;
               |BUCLE agidanif;
               nLinea = nUltima + 1;
          |SINO;
               || modificacion o baja de ascendiente o descendiente
               nLinea = 00;
               swCuenta = 0;
               |BUCLE agidanif;
          |FINSI;
     |FINSI;

     |SI nLinea = 00;
          aAlfa1 = #laborb04#3; |QBF aAlfa1;
          aAlfa2 = #laborb04#117; |QBF aAlfa2;
          aAlfa3 = #laborb04#9;
          |SI aAlfa1 = "TITULAR";
                aAlfa2 = " modificación ";
          |SINO;
                |SI aAlfa2 = "A"; aAlfa2 = " el alta."; |FINSI;
                |SI aAlfa2 = "M"; aAlfa2 = " la modificación."; |FINSI;
                |SI aAlfa2 = "B"; aAlfa2 = " la baja."; |FINSI;
          |FINSI;
          aAlfa = "    ATENCION. No se ha encontrado el " + aAlfa1 + " con NIF ";
          aAlfa = aAlfa + aAlfa3 + " para realizar " + aAlfa2;
          |MENAV aAlfa;
     |FINSI;

     #agidanif#0  = #laborb04#2;
     #agidanif#1  = nLinea;
     |LEE 101#agidanif.=;
     |SI FSalida ! 0;
         |DDEFECTO #agidanif;
         #agidanif#0  = #laborb04#2;
         #agidanif#1  = nLinea;
         |GRABA 020#agidanif.b;
     |FINSI;

     |SI #laborb04#117 = "B";
         |BORRA 020#agidanif.a;
     |FINSI;

     |SI #laborb04#117 = "A"; |O #laborb04#117 = "M";
         #agidanif#2  = #laborb04#3;
         #agidanif#3  = #laborb04#4;
         #agidanif#5  = #laborb04#6;
         #agidanif#8  = #laborb04#9;
         #agidanif#9  = #laborb04#10;
         #agidanif#10 = #laborb04#11;
         #agidanif#11 = #laborb04#12;
         #agidanif#12 = #laborb04#13;
         #agidanif#13 = #laborb04#14;
         #agidanif#15 = #laborb04#16;
         #agidanif#16 = #laborb04#17;
         #agidanif#17 = #laborb04#18;
         #agidanif#18 = #laborb04#19;
         #agidanif#23 = #laborb04#24;
         #agidanif#36 = #laborb04#37;
         #agidanif#39 = #laborb04#40;
         #agidanif#40 = #laborb04#41;
         #agidanif#41 = #laborb04#42;
         #agidanif#44 = #laborb04#45;
         #agidanif#58 = #laborb04#59;

         |SI #agidanif#2 = "ASCENDIENTE ";
             |SI #agidanif#3 = " ";
                 #agidanif#3 = "1";
             |FINSI;
         |FINSI;

          |GRABA 020#agidanif.a;
     |FINSI;

     |SI #laborb04#117 = "A";
         |SI #agidanif#8 ! "            ";
             #dsam0103#0 = #agidanif#8;
             |LEE 101#dsam0103.=;
             |SI FSalida ! 0;
                 |DDEFECTO #dsam0103;
                 #dsam0103#0 = #agidanif#8;
                 |GRABA 020#dsam0103.b;
             |FINSI;

             #dsam0103#1  = #agidanif#12;
             #dsam0103#14 = #agidanif#19;
             #dsam0103#9  = #agidanif#24;
             #dsam0103#2  = #agidanif#25;
             #dsam0103#3  = #agidanif#26;
             #dsam0103#16 = #agidanif#27;
             #dsam0103#10 = #agidanif#28;
             #dsam0103#11 = #agidanif#29;
             #dsam0103#4  = #agidanif#30;
             #dsam0103#5  = #agidanif#31;
             #dsam0103#6  = #agidanif#32;
             #dsam0103#7  = #agidanif#33;
             #dsam0103#8  = #agidanif#34;

             |GRABA 020#dsam0103.a;
             |LIBERA #dsam0103;
         |FINSI;
     |FINSI;
     |SI swTitular = 1;
         |ABRE #nomir003;              || Por decisi¢n de David se machaca
         #nomir003#0  = #laborb03#1;
         #nomir003#40 = nAnyo;
         #nomir003#41 = #laborb03#2;
         |LEE 101#nomir003.=;
         |SI FSalida ! 0;
             |DDEFECTO #nomir003;
             #nomir003#0  = #laborb03#1;
             #nomir003#40 = nAnyo;
             #nomir003#41 = #laborb03#2;
             |GRABA 020#nomir003.b;
         |FINSI;

         #nomir003#12 = #laborb04#119;
         #nomir003#13 = #laborb04#120;

         |GRABA 020#nomir003.a;
         |LIBERA #nomir003;
         |CIERRA #nomir003;
     |FINSI;

     |LIBERA #agidanif;
|FPRC;

|DEFBUCLE laborb04;
     #laborb04#1;
     ;
     #laborb03#0, 00;
     #laborb03#0, 99;
     be;
     NULL, laborb04;
|FIN;

|PROCESO ActualizaAgidanif;
     |ABRE #agidanif;
     |ABRE #dsam0103;
     swTitular = 0;
     |BUCLE laborb04;
     |CIERRA #dsam0103;
     |CIERRA #agidanif;

     eaNif = #laborb03#1;
     |SUB_EJECUTA ":basica/agidanif;DESDELABORBOX";
|FPRC;

|PROCESO Actualiza;
     |HAZ LeeFichaActual;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CONFI "0000S¿Confirma que desea actualizar la solicitud?";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ ActualizaAgidanif;

     #laborb03#4  = "A";
     #laborb03#9  = ~;
     |HORA aAlfa;
     #laborb03#10 = aAlfa;
     #laborb03#11 = Usuario % 0810;
     |GRABA 020#laborb03.a;
     |LIBERA #laborb03;

     |MENAV "    La ficha ha sido actualizada correctamente";

     |CLS;
|FPRC;

|PROCESO EsTitular;
     |ABRE #laborb04;
     #laborb04#0 = #laborb03#0;
     #laborb04#1 = 01;
     |LEE 000#laborb04.=;
     |SI FSalida = 0;
          aAlfa = #laborb04#3;
          |QBF aAlfa;
          |SI aAlfa = "TITULAR";
               swTitular = 1;
          |FINSI;
     |FINSI;
     |CIERRA #laborb04;
|FPRC;

|PROCESO inferior;
     #laborb04#0 = enID;
     #laborb04#1 = 01;
|FPRC;

|PROCESO superior;
     #laborb04#0 = enID;
     #laborb04#1 = nFinLin;
|FPRC;

|PROCESO Opciones; |TIPO 0;
     |SI enFSalida ! 0;
          FSalida = enFSalida;
     |FINSI;

     || consulta de datos introducidos
     |SI FSalida = 10;
          |HAZ EsTitular;
          |SI swTitular = 1;
               nFinLin = 1;
          |SINO;
               nFinLin = 99;
          |FINSI;

          enID = #laborb03#0;
          |SI aParam = "ADMIN";  || consulta el usuario los datos que
               enID = #laborb03#0;
               |ENTLINEAL #1#laborb04, 2, 2, 22, 1, inferior, superior;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |ACABA;
          |FINSI;
          |SI aParam = "HISTO";
               enID = #laborb03#0;
               |ENTLINEAL #1#laborb04, 1, 7, 22, 1, inferior, superior;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |PULSATECLA;
               |ACABA;
          |FINSI;                       || o ya actualizados, solo visualizar
          |ACABA;
     |FINSI;

     |SI FSalida = 11;
          |HAZ Actualiza;
          |ACABA;
     |FINSI;

     |SI FSalida = 12;
          enBorrado = 1;
          |HAZ LeeFichaActual;

          #laborb03#4  = "R";
          #laborb03#14 = eaMotiv;

          |GRABA 020#laborb03.a;
          |LIBERA #laborb03;
     |FINSI;
|FPRC;

|PROCESO LeeFichaActual;
     #laborb03#0 = enID;
     |LEE 101#laborb03.=;
|FPRC;

|PROGRAMA;
     |DBASS aBase;  |QBF aBase;

     |ABRE #laborb03;
     |SI aParam = "ADMIN";
          aTipo = "P";   || los pendientes de actualizar
     |FINSI;
     |SI aParam = "HISTO";
          aTipo = "A";   || consulta del historico, los ya actualizados
     |FINSI;

     |HAZ LeeFichaActual;
     |HAZ Opciones;
     |CIERRA #laborb03;
|FPRO;

|PROCESO Baja04;
     #laborb04#0 = #laborb03#0;
     #laborb04#1 = 0;
|FPRC;

|PROCESO Alta04;
     #laborb04#0 = #laborb03#0;
     #laborb04#1 = 99;
|FPRC;

|PROCESO Tipo80b03;  |TIPO 80;
     |SI PARAMETRO = "";  |ACABA;  |FINSI;

     fFecha = ~;
     aAlfa  = fFecha % -104;
     nAnyo  = aAlfa;

     aParam = PARAMETRO;
     |QBF aParam;

     |SI aParam = "MENULISTA";
          |ABRE #laborb03;
          |ABRE #laborb04;
          |PARA;  |SI FSalida = 0;  |HACIENDO;
               |CONSULTA_CLAVE #1#laborb03;
               |SI FSalida = 0;
                   |CONSULTA_F_CLAVE #1#laborb04, Baja04, Alta04;
                   FSalida = 0;
               |FINSI;
          |SIGUE;
          |CIERRA #laborb03;
          |CIERRA #laborb04;
          |ACABA;
     |FINSI;

|| LEER LA ID
     aAlfa     = PARAMETRO % 202;   enFSalida = aAlfa;
     eaID = PARAMETRO % 407;
     enID = eaID;
     eaParam = PARAMETRO % 1110;  |QBF eaParam;
     aParam = eaParam;
|FPRC;

|PROCESO Tipo90b03;  |TIPO 90;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |SUB_EJECUTA "|laborx00.tab";
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;
