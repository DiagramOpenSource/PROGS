|FICHEROS;
     sempasma #0;

     semtraba #2;
     semtrcon #3;
     semconce #4;

     labtraba #5;
     nomcatli #6;
     nomtrali #7;
     nomvarli #8;
     nomtrcal #9;
     nomtraca #10;

     semcalcb #10;
     semcalcl #11;
     semequiv #12;

     labempre #20;
     nomcones #21;
     nomconst #22;
     nomcontr #23;
     ||semvaria #24;
     nomconca #25;
     nomconli #26;
     nomcalli #27;
     nomvart3 #28;
     nomvarca #29;

     nomantca #113;      || antiguedades/categorias
     nomconax #114;      || auxiliar convenios

     sememrec #900;      || guardar seleccion para emisiones
     semcntcu;

     nomabsca;
     nomabsli;
|FIN;

|VARIABLES;
     TotalDev = 0;
     Valor = "";
     UnVal = "";
     Unidad = 0;

     duni1_101 = 0;
     duni2_101 = 0;
     dvalo_101 = 0;
     duni1_102 = 0;
     duni2_102 = 0;
     dvalo_102 = 0;
     duni1_103 = 0;
     duni2_103 = 0;
     dvalo_103 = 0;

     duni11_101 = 0;   || En caso de semana partida hay que separarlos
     duni21_101 = 0;
     dvalo1_101 = 0;
     duni11_102 = 0;   || En caso de semana partida hay que separarlos
     dvalo1_102 = 0;
     duni11_103 = 0;   || En caso de semana partida hay que separarlos
     dvalo1_103 = 0;

     ModoEntrada = 0;
     ant1 = 0;
     ant2 = 0;
     ant3 = 0;
     ant4 = 0;
     ant5 = 0;
     sem1 = 0;
     sem2 = 0;
     sem3 = 0;
     sem4 = 0;
     sem5 = 0;

     sdia = 0;
     smas = 0;
     sdife = 0;
     srest = 0;

     alfa1 = "";
     alfa2 = "";
     fech1 = @;
     fech2 = @;
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;

     Dia1 = 0;
     Mes1 = 0;
     Dia2 = 0;
     Mes2 = 0;
     Dia = "";
     Mes = "";
     DifDias = 0;
     DiasLabs = 0;
     DiasLabs1 = 0;
     DiasLabs2 = 0;
     Cont = 0;
     MesEsp = 0;
     Tipo = 0;

     Comodin  = "";
     Comodin1 = "";
     ComodNum  = 0;

     SwGraba = 0;
     reales = 0;
     nCuantos = 0;
     nPara1 = 0;
     nPara2 = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     nNume1 = 0;
     nNume2 = 0;
     fFech1 = @;
     fFech2 = @;
     nTopeMes = 0;
     nEmpresa = 0;
     nTrabaja = 0;
     &EURODB = 0;
     swNoEntra = 0;
     fFechaDesde = @;
     fFechaHasta = @;
     aFechaDesde = "";
     aFechaHasta = "";
     topemes11 = 0;
     topemes22 = 0;
|FIN;

|PROCESO GrabaAnticipos;
     |SI #semcalcb#1 = #0#1;  |ACABA;   |FINSI;

     |SI ant1 = 0;
          ant1 = #semcalcb#10;
          sem1 = #semcalcb#1;
     |SINO;
          |SI ant2 = 0;
               ant2 = #semcalcb#10;
               sem2 = #semcalcb#1;
          |SINO;
               |SI ant3 = 0;
                    ant3 = #semcalcb#10;
                    sem3 = #semcalcb#1;
               |SINO;
                    |SI ant4 = 0;
                         ant4 = #semcalcb#10;
                         sem4 = #semcalcb#1;
                    |SINO;
                         |SI ant5 = 0;
                              ant5 = #semcalcb#10;
                              sem5 = #semcalcb#1;
                         |SINO;
                              ant5 = ant5 + #semcalcb#10;
                              sem5 = 99;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE GrabaAnticipos;
     #semcalcb#1;
     ;
     #sempasma#0,  1, Mes1, #semtraba#0, #semtraba#1, 0;
     #sempasma#0, 99, Mes1, #semtraba#0, #semtraba#1, 0;
     ;
     NULL, GrabaAnticipos;
|FIN;

|PROCESO ElGrabaAnticipos;
     ant1 = 0; ant2 = 0; ant3 = 0; ant4 = 0; ant5 = 0;
     sem1 = 0; sem2 = 0; sem3 = 0; sem4 = 0; sem5 = 0;
     |DDEFECTO #semequiv;
     #semequiv#1 = #semtraba#0;
     #semequiv#2 = #semtraba#1;
     |LEE 000#semequiv.=;
     |SI #semequiv#4 ! "M";
          |BUCLE GrabaAnticipos;
     |FINSI;
|FPRC;

|PROCESO UltimoDia;
     nNume1 = #sempasma#0 $ 4;
     |SI nNume1 = 0;
          nNume1 = 1;
     |SINO;
          nNume1 = 0;
     |FINSI;
     |SI Mes1 = 1;  nTopeMes = 31;          |FINSI;
     |SI Mes1 = 2;  nTopeMes = 28 + nNume1; |FINSI;
     |SI Mes1 = 3;  nTopeMes = 31; |FINSI;
     |SI Mes1 = 4;  nTopeMes = 30; |FINSI;
     |SI Mes1 = 5;  nTopeMes = 31; |FINSI;
     |SI Mes1 = 6;  nTopeMes = 30; |FINSI;
     |SI Mes1 = 7;  nTopeMes = 31; |FINSI;
     |SI Mes1 = 8;  nTopeMes = 31; |FINSI;
     |SI Mes1 = 9;  nTopeMes = 30; |FINSI;
     |SI Mes1 = 10;  nTopeMes = 31; |FINSI;
     |SI Mes1 = 11;  nTopeMes = 30; |FINSI;
     |SI Mes1 = 12;  nTopeMes = 31; |FINSI;
|FPRC;

|PROCESO TomaUnidad;
     Unidad = 0;
     |SI DifDias ! 0;
          |SI #semconce#3 = "D";
               |SI MesEsp=Mes1;
                    Unidad=#semtraba#8;
               |SINO;
                    Unidad=#semtraba#9;
               |FINSI;
          |FINSI;
          |SI #semconce#3 = "H";
               #nomtrcal#0  = #labtraba#156;
               #nomtrcal#13 = #sempasma#0;
               |LEE 000#nomtrcal.=;
               |SI FSalida = 0;
                    |HAZ UltimoDia;
                    DiasLabs = 0;
                    DiasLabs1 = 0;
                    DiasLabs2 = 0;
                    Comodin = #nomtrcal#Mes1#;
                    |PARA Cont = Dia1; |SI Cont [ nTopeMes; |HACIENDO Cont = Cont + 1;
                         ComodNum = (Cont * 100) + 1;
                         Comodin1 = Comodin % ComodNum;
                         |SI Comodin1 = "0"; DiasLabs = DiasLabs + 1; |FINSI;
                         |SI Comodin1 = "0"; DiasLabs1 = DiasLabs1 + 1; |FINSI;
                    |SIGUE;
                    Comodin = #nomtrcal#Mes2#;
                    |PARA Cont = 1; |SI Cont [ Dia2; |HACIENDO Cont = Cont + 1;
                         ComodNum = (Cont * 100) + 1;
                         Comodin1 = Comodin % ComodNum;
                         |SI Comodin1 = "0"; DiasLabs = DiasLabs + 1; |FINSI;
                         |SI Comodin1 = "0"; DiasLabs2 = DiasLabs2 + 1; |FINSI;
                    |SIGUE;
               |FINSI;
               |SI #semconce#0 ! 109;|Y #semconce#0 ! 306;|Y #semconce#0 ! 307;
                    |SI #semtrcon#8 ! 0;|O #semtrcon#9 ! 0;
                         |SI MesEsp = Mes1;
                              Unidad = #semtrcon#8;
                         |SINO;
                              Unidad = #semtrcon#9;
                         |FINSI;
                    |SINO;
                         |SI MesEsp = Mes1;
                              Unidad = (DiasLabs1 * #semtrcon#4) / DiasLabs;
                         |SINO;
                              Unidad = (DiasLabs2 * #semtrcon#4) / DiasLabs;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI MesEsp = Mes1;       || los 109,306 y 307 no se reparten
                         Unidad = #semtrcon#4;
                    |SINO;
                         Unidad = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          Unidad = #semtrcon#4;
     |FINSI;
|FPRC;

|PROCESO TomaValor;
     Valor = "";
     UnVal = "";

     #labtraba#0 = #semtraba#0;
     #labtraba#1 = #semtraba#1;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0;    |ACABA;   |FINSI;

     #nomcatli#0 = #labtraba#87;
     #nomcatli#1 = #labtraba#17;
     #nomcatli#2 = #semtrcon#2;
     |LEE 000#nomcatli.=;
     |SI FSalida = 0;
          Comodin = #nomcatli#3; |QBF Comodin;
          |SI Comodin ! ""; UnVal = #nomcatli#3; |FINSI;
          Comodin = #nomcatli#4; |QBF Comodin;
          |SI Comodin ! ""; Valor = #nomcatli#4; |FINSI;
     |FINSI;

     #nomtrali#0 = #labtraba#0;
     #nomtrali#1 = #labtraba#1;
     #nomtrali#2 = #semtrcon#2;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0;
          Comodin = #nomtrali#3; |QBF Comodin;
          |SI Comodin ! ""; UnVal = #nomtrali#3; |FINSI;
          Comodin = #nomtrali#4; |QBF Comodin;
          |SI Comodin ! ""; Valor = #nomtrali#4; |FINSI;
     |FINSI;

     |SI #sempasma#8 = "S";
          #nomvarli#0 = #labtraba#0;
          #nomvarli#1 = #labtraba#1;
          #nomvarli#2 = #semcalcb#2;
          #nomvarli#3 = 0;
          #nomvarli#4 = #semtrcon#2;
          |LEE 000#nomvarli.=;
          |SI FSalida = 0;
               Comodin = #nomvarli#5; |QBF Comodin;
               |SI Comodin ! ""; UnVal = #nomvarli#5; |FINSI;
               Comodin = #nomvarli#6; |QBF Comodin;
               |SI Comodin ! ""; Valor = #nomvarli#6; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ConcepTrab;

     #semconce#0 = #semtrcon#2;
     |LEE 000#semconce.=;
     |SI FSalida ! 0;                   |ACABA;   |FINSI;

     #labtraba#0 = #semtraba#0;
     #labtraba#1 = #semtraba#1;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0;                   |ACABA;   |FINSI;

     |DDEFECTO #nomconli;
     #nomconli#0 = #labtraba#87;
     #nomconli#2 = #semtrcon#2;
     |LEE 000#nomconli.=;

     |SI #semtrcon#7 = "N";|Y Tipo = 0; |ACABA;   |FINSI;
     |SI #semtrcon#7 = "S";|Y Tipo = 1; |ACABA;   |FINSI;

     |SI #semtrcon#2 = 906;|O #semtrcon#2 = 971;|O #semtrcon#2 = 972;
                                                |O #semtrcon#2 = 973;
                                                |O #semtrcon#2 = 981;
                                                |O #semtrcon#2 = 982;
                                                |O #semtrcon#2 = 983;
                                                |O #semconce#3 = "G";
        || anticipos y especiales
          |SI DifDias ! 0;
               |SI Tipo = 0;|Y #semconce#0 ! 129;
                    Unidad = DifDias / 7;
               |SINO;
                    |SI MesEsp = Mes1;  Unidad = 1;    |FINSI;
                    |SI MesEsp = Mes2;  Unidad = 0;    |FINSI;
               |FINSI;
          |SINO;
               Unidad = 1;
          |FINSI;
          Valor = #semtrcon#4;
     |SINO;
          |HAZ TomaValor;
          |HAZ TomaUnidad;
          |SI #semtrcon#2 = 102;|O #semtrcon#2 = 103;
               Unidad = UnVal;
          |FINSI;
     |FINSI;

     |SI Tipo = 0;
          |DDEFECTO #nomvarca;
          #nomvarca#0 = #semcalcb#3;
          #nomvarca#1 = #semcalcb#4;
          #nomvarca#2 = MesEsp;
          #nomvarca#3 = 0;
          |LEE 000#nomvarca.=;
          |SI FSalida ! 0;
               |SI #sempasma#8 = "S";
                    |GRABA 020#nomvarca.n;
               |FINSI;
          |FINSI;

          |DDEFECTO #nomvarli;
          #nomvarli#0 = #semcalcb#3;
          #nomvarli#1 = #semcalcb#4;
          #nomvarli#2 = #semcalcb#2;
          #nomvarli#3 = 0;
          #nomvarli#4 = #semtrcon#2;
          |LEE 101#nomvarli.=;
          |SI FSalida ! 0;
               |SI #sempasma#8 = "S";
                    |GRABA 020#nomvarli.b;
               |FINSI;
          |FINSI;
          |SI #semtrcon#2 = 906;|O #semtrcon#2 = 971;|O #semtrcon#2 = 972;
                                                     |O #semtrcon#2 = 973;
                                                     |O #semtrcon#2 = 981;
                                                     |O #semtrcon#2 = 982;
                                                     |O #semtrcon#2 = 983;
                                                     |O #semconce#3 = "G";
               ComodNum = #nomvarli#6;
               ComodNum = ComodNum + (Unidad * Valor);
               Comodin = ("            " + ComodNum) % -112;
               #nomvarli#6 = Comodin;
               ComodNum = 1;
          |SINO;
               ComodNum = #nomvarli#5;
               |SI #semtrcon#2 ! 103;             || el plus (103) no se acumula
                    ComodNum = ComodNum + Unidad;
               |SINO;
                    ComodNum = Unidad;
               |FINSI;
          |FINSI;
          Comodin = ("          " + ComodNum) % -110;
          #nomvarli#5 = Comodin;

          |SI #sempasma#8 = "S";
               |GRABA 020#nomvarli.a;
          |FINSI;
          |LIBERA #nomvarli;
     |FINSI;

     |DDEFECTO #semcalcl;
     #semcalcl#0  = #semcalcb#0;
     #semcalcl#1  = #semcalcb#1;
     #semcalcl#2  = #semcalcb#2;
     #semcalcl#3  = #semcalcb#3;
     #semcalcl#4  = #semcalcb#4;
     #semcalcl#5  = #semcalcb#5;
     #semcalcl#6  = #semtrcon#2;
     |LEE 101#semcalcl.=;
     |SI FSalida ! 0;
          |GRABA 020#semcalcl.b;
     |FINSI;
     #semcalcl#7  = #semtrcon#3;
     #semcalcl#8  = #semconce#3;
     #semcalcl#9  = Unidad;
     #semcalcl#10 = Valor;
     #semcalcl#11 = #semcalcl#9 * #semcalcl#10;
     #semcalcl#12 = #semcalcl#9;
     #semcalcl#13 = #nomconli#3;
     #semcalcl#14 = #nomconli#4;
     |SI #semtrcon#2 = 101;
          duni1_101 = #semcalcl#9;
          duni2_101 = #semcalcl#9;
          dvalo_101 = Valor;
     |FINSI;
     |SI #semtrcon#2 = 102;
          duni1_102 = #semcalcl#9;
          duni2_102 = #semcalcl#9;
     |FINSI;
     |SI #semtrcon#2 = 103;
          duni1_103 = #semcalcl#9;
          duni2_103 = #semcalcl#9;
     |FINSI;
     SwGraba = 1;
     |GRABA 020#semcalcl.a;
     |LIBERA #semcalcl;

     TotalDev = TotalDev + #semcalcl#11;
|FPRC;

|DEFBUCLE ConcepTrab;
     #semtrcon#1;
     ;
     #semtraba#3, #semtraba#4, #semtraba#0, #semtraba#1,   1;
     #semtraba#3, #semtraba#4, #semtraba#0, #semtraba#1, 999;
     ;
     NULL, ConcepTrab;
|FIN;

|PROCESO BorraLineas;
     |DDEFECTO #semconce;
     #semconce#0 = #semcalcl#6;
     |LEE 000#semconce.=;

     #nomvarli#0 = #semcalcl#3;
     #nomvarli#1 = #semcalcl#4;
     #nomvarli#2 = #semcalcl#2;
     #nomvarli#3 = 0;
     #nomvarli#4 = #semcalcl#6;
     |LEE 101#nomvarli.=;
     |SI FSalida = 0;
          |SI #nomvarli#4 = 906;|O #nomvarli#4 = 971;|O #nomvarli#4 = 972;
                                                     |O #nomvarli#4 = 973;
                                                     |O #nomvarli#4 = 981;
                                                     |O #nomvarli#4 = 982;
                                                     |O #nomvarli#4 = 983;
                                                     |O #semconce#3 = "G";
               ComodNum = #nomvarli#6;
               ComodNum = ComodNum - #semcalcl#10;
               Comodin = ("            " + ComodNum) % -112;
               #nomvarli#6 = Comodin;
               ComodNum  = #nomvarli#6;
          |SINO;
               ComodNum = #nomvarli#5;
               ComodNum = ComodNum - #semcalcl#9;
               |SI #nomvarli#4 ! 103;   || el plus (103) no se acumula
                    Comodin = ("          " + ComodNum) % -110;
               |SINO;
                    Comodin = "";
               |FINSI;
               #nomvarli#5 = Comodin;
               ComodNum  = #nomvarli#5;
          |FINSI;
          |SI #sempasma#8 = "S";
               |SI ComodNum [ 0;
                    |BORRA 020#nomvarli.a;
               |SINO;
                    |GRABA 020#nomvarli.a;
               |FINSI;
          |FINSI;
     |FINSI;
     |LIBERA #nomvarli;

     #nomvarli#0 = #semcalcl#3;
     #nomvarli#1 = #semcalcl#4;
     #nomvarli#2 = #semcalcl#2;
     #nomvarli#3 = 0;
     #nomvarli#4 = 1;
     |LEE 000#nomvarli.];
     |SI FSalida ! 0; |O #nomvarli#0 ! #semcalcl#3; |O #nomvarli#1 ! #semcalcl#4;
                      |O #nomvarli#2 ! #semcalcl#2; |O #nomvarli#3 ! 0;
          |DDEFECTO #nomvarli;
          #nomvarli#0 = #semcalcl#3;
          #nomvarli#1 = #semcalcl#4;
          #nomvarli#2 = #semcalcl#2;
          #nomvarli#3 = 0;
          #nomvarli#4 = 999;
          |LEE 000#nomvarca.=;
          |SI FSalida ! 0;
               |SI #sempasma#8 = "S";
                    |GRABA 020#nomvarca.n;
               |FINSI;
          |FINSI;
     |FINSI;

     |BORRA 020#semcalcl.a;
     |LIBERA #semcalcl;
|FPRC;

|DEFBUCLE BorraLineas;
     #semcalcl#1;
     ;
     #semcalcb#0,#semcalcb#1,#semcalcb#2,#semcalcb#3,#semcalcb#4,#semcalcb#5,  1;
     #semcalcb#0,#semcalcb#1,#semcalcb#2,#semcalcb#3,#semcalcb#4,#semcalcb#5,999;
     be;
     NULL, BorraLineas;
|FIN;

|PROCESO GrabaCab;

      #semcalcb#0 = #semtraba#3;
      #semcalcb#1 = #semtraba#4;
      #semcalcb#2 = MesEsp;
      #semcalcb#3 = #semtraba#0;
      #semcalcb#4 = #semtraba#1;
      #semcalcb#5 = Tipo;
      |LEE 101#semcalcb.=;
      |SI FSalida = 0;
           |BUCLE BorraLineas;
           |BORRA 020#semcalcb.a;
      |FINSI;
      |LIBERA #semcalcb;

      |DDEFECTO #semcalcb;
      #semcalcb#0 = #semtraba#3;
      #semcalcb#1 = #semtraba#4;
      #semcalcb#2 = MesEsp;
      #semcalcb#3 = #semtraba#0;
      #semcalcb#4 = #semtraba#1;
      #semcalcb#5 = Tipo;

      TotalDev = 0;
      SwGraba = 0;
      |BUCLE ConcepTrab;
      |SI SwGraba = 1;
           #semcalcb#6 = TotalDev;
           |HAZ Calculos;
           |SI Tipo = 0;
                #semcalcb#11 = ant1;
                #semcalcb#12 = ant2;
                #semcalcb#13 = ant3;
                #semcalcb#14 = ant4;
                #semcalcb#15 = ant5;
                #semcalcb#21 = sem1;
                #semcalcb#22 = sem2;
                #semcalcb#23 = sem3;
                #semcalcb#24 = sem4;
                #semcalcb#25 = sem5;
           |FINSI;
           |GRABA 020#semcalcb.n;
           |SI #semcalcb#10 ! 0;
                nCuantos = nCuantos + 1;
           |FINSI;
      |FINSI;

      |SI DifDias ! 0; DifDias = 7 - DifDias; |FINSI;
|FPRC;

|PROCESO Graba_102;
     |DDEFECTO #semcalcl;
     #semcalcl#0 = #semtraba#3;
     #semcalcl#1 = #semtraba#4;
     #semcalcl#2 = MesEsp;
     #semcalcl#3 = #semtraba#0;
     #semcalcl#4 = #semtraba#1;
     #semcalcl#5 = Tipo;
     #semcalcl#6 = 102;
     |LEE 101#semcalcl.=;
     |SI FSalida ! 0;
          #semcalcl#0 = #semtraba#3;
          #semcalcl#1 = #semtraba#4;
          #semcalcl#2 = MesEsp;
          #semcalcl#3 = #semtraba#0;
          #semcalcl#4 = #semtraba#1;
          #semcalcl#5 = Tipo;
          #semcalcl#6 = 102;
          #semcalcl#7 = "ANTIGUEDAD";
          #semcalcl#8 = "A";
          |GRABA 020#semcalcl.b;
     |FINSI;
     #semcalcl#9  = duni1_102;
     #semcalcl#10 = dvalo_102;
     #semcalcl#11 = #semcalcl#9 * #semcalcl#10;
     #semcalcl#12 = duni2_102;
     |GRABA 020#semcalcl.a;
     |LIBERA #semcalcl;
     SwGraba = 1;
|FPRC;

|PROCESO Graba_103;
     |DDEFECTO #semcalcl;
     #semcalcl#0 = #semtraba#3;
     #semcalcl#1 = #semtraba#4;
     #semcalcl#2 = MesEsp;
     #semcalcl#3 = #semtraba#0;
     #semcalcl#4 = #semtraba#1;
     #semcalcl#5 = Tipo;
     #semcalcl#6 = 103;
     |LEE 101#semcalcl.=;
     |SI FSalida ! 0;
          #semcalcl#0 = #semtraba#3;
          #semcalcl#1 = #semtraba#4;
          #semcalcl#2 = MesEsp;
          #semcalcl#3 = #semtraba#0;
          #semcalcl#4 = #semtraba#1;
          #semcalcl#5 = Tipo;
          #semcalcl#6 = 103;
          #semcalcl#7 = "PLUS (%)  ";
          #semcalcl#8 = "A";
          |GRABA 020#semcalcl.b;
     |FINSI;
     #semcalcl#9  = duni1_103;
     #semcalcl#10 = dvalo_103;
     #semcalcl#11 = #semcalcl#9 * #semcalcl#10;
     #semcalcl#12 = duni2_103;
     |GRABA 020#semcalcl.a;
     |LIBERA #semcalcl;
     SwGraba = 1;
|FPRC;

|PROCESO Todo;
     |HAZ calleer;
     |SI #semequiv#4 ! "M";        || no hay 102, ni 103, ni pagas
          |SI #nomconca#2 = 3;
               |HAZ cal_103;
          |FINSI;
          |HAZ cal_102;
          |SI #nomconca#2 ! 3;
               |HAZ cal_103;
          |FINSI;
          |HAZ Prorrata;
     |FINSI;
     |HAZ RecuentaLineas;
|FPRC;

|PROCESO Rellena;
     |SI #semtraba#6 = "01.01.0001";|O #semtraba#7 = "01.01.0001";
          |HAZ deshas;
     |SINO;
          fech1 = #semtraba#6;
          fech2 = #semtraba#7;
          #0#6 = fech1;
          #0#7 = fech2;
          |HAZ IniSemana;
     |FINSI;

     |SI Mes1 ! Mes2;
          |HAZ ElGrabaAnticipos;

          MesEsp = Mes1; Tipo = 1; |HAZ GrabaCab; || difdias mes1
          MesEsp = Mes2; Tipo = 1; |HAZ GrabaCab; || difdias mes2

          duni1_101 = 0;
          duni2_101 = 0;
          dvalo_101 = 0;

          MesEsp = Mes1; Tipo = 0; |HAZ GrabaCab; || difdias mes1

          duni11_101 = duni1_101;
          duni21_101 = duni2_101;
          dvalo1_101 = dvalo_101;
          duni11_102 = duni1_102;
          dvalo1_102 = dvalo_102;
          duni11_103 = duni1_103;
          dvalo1_103 = dvalo_103;

          ant1 = 0;     sem1 = 0;
          ant2 = 0;     sem2 = 0;
          ant3 = 0;     sem3 = 0;
          ant4 = 0;     sem4 = 0;
          ant5 = 0;     sem5 = 0;
          duni1_101 = 0;
          duni2_101 = 0;

          MesEsp = Mes2; Tipo = 0; |HAZ GrabaCab; || difdias mes2
     |SINO;
          nNume1 = #0#7;      nNume1 = nNume1 + 1;     fFech1 = nNume1;
          aAlfa1 = fFech1;    aAlfa1 = aAlfa1 % 102;
          |SI aAlfa1 = "01";
               |HAZ ElGrabaAnticipos;
          |FINSI;

          MesEsp = Mes1; Tipo = 1; |HAZ GrabaCab;

          duni1_101 = 0;
          duni2_101 = 0;
          dvalo_101 = 0;

          MesEsp = Mes1; Tipo = 0; |HAZ GrabaCab;
     |FINSI;

     |SI Mes1 ! Mes2;
          MesEsp = Mes2;     |HAZ Todo; || difdias mes1

          duni1_101 = duni11_101;
          duni2_101 = duni21_101;
          dvalo_101 = dvalo1_101;
          duni1_102 = duni11_102;
          dvalo_102 = dvalo1_102;
          duni1_103 = duni11_103;
          dvalo_103 = dvalo1_103;

          MesEsp = Mes1;     |HAZ Todo; || difdias mes2
     |SINO;
          MesEsp = Mes1;     |HAZ Todo;
     |FINSI;
|FPRC;

|DEFBUCLE Rellena;
 #semtraba#1;
 ;
 #sempasma#0,#sempasma#1,#sempasma#2,#sempasma#4;
 #sempasma#0,#sempasma#1,#sempasma#3,#sempasma#5;
 ;
 NULL,Rellena;
|FIN;

|PROCESO Calculos;
     |SI Tipo = 0;
          #semcalcb#8 = #semcalcb#6 % #labtraba#30;
     |SINO;
          #semcalcb#8 = 0;
     |FINSI;
     #semcalcb#9 = #semcalcb#7 + #semcalcb#8;
     #semcalcb#10 = #semcalcb#6 - (#semcalcb#9 + #semcalcb#20);
|FPRC;

|PROCESO Parrilla7; |TIPO 7;
     |C_M #0#9, 1, "S";
|FPRC;

|PROCESO Parrilla0; |TIPO 0;
     |SI #0#9 = 0;
          |PDEFECTO #0, 9, 29;
          |PINDA #0#0;
          aAlfa1 = "N";
          aAlfa2 = "S";
     |SINO;
          aAlfa1 = "S";
          aAlfa2 = "N";
     |FINSI;
     |C_M #0#9, 1, aAlfa1;
     |C_M #0#10, 1, aAlfa1;
     |C_M #0#11, 1, aAlfa1;
     |C_M #0#12, 1, aAlfa1;
     |C_M #0#13, 1, aAlfa1;
     |C_M #0#14, 1, aAlfa1;
     |C_M #0#15, 1, aAlfa1;
     |C_M #0#16, 1, aAlfa1;
     |C_M #0#17, 1, aAlfa1;
     |C_M #0#18, 1, aAlfa1;
     |C_M #0#19, 1, aAlfa1;
     |C_M #0#20, 1, aAlfa1;
     |C_M #0#21, 1, aAlfa1;
     |C_M #0#22, 1, aAlfa1;
     |C_M #0#23, 1, aAlfa1;
     |C_M #0#24, 1, aAlfa1;
     |C_M #0#25, 1, aAlfa1;
     |C_M #0#26, 1, aAlfa1;
     |C_M #0#27, 1, aAlfa1;
     |C_M #0#28, 1, aAlfa1;

     |C_M #0#2, 1, aAlfa2;
     |C_M #0#3, 1, aAlfa2;
     |C_M #0#4, 1, aAlfa2;
     |C_M #0#5, 1, aAlfa2;
|FPRC;

|PROCESO Defecto; |TIPO 7;    || calcula el a¤o por defecto segun sistema
     fFech1 = ~;
     aAlfa1 = fFech1;
     aAlfa1 = aAlfa1 % -104;
     #0Campo = aAlfa1;
     |PINTA #0Campo;
|FPRC;

|PROCESO mirasem; |TIPO 7;
     alfa1 = #0#0;
     alfa1 = "01.01." + alfa1;
     fech1 = alfa1;            || primero saca el dia de la semana
     fech2 = fech1 % 1;        ||/que fue el uno de enero
     alfa1 = fech2 % 11;

     |SI alfa1 = "Lunes";     sdia=1; smas=1; |FINSI;
     |SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
     |SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
     |SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
     |SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
     |SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
     |SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

     alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
     fech1 = ~;                     ||/como fecha inicial de calculo
     alfa2 = fech1 % -104;
     alfa1 = alfa1 + ".01." + alfa2;
     fech1 = alfa1;
     nume1 = fech1;                 || calcula dias hasta primer lunes a¤o

     fech1 = ~;                     || calcula dias hasta fecha actual
     nume2 = fech1;

     sdife = nume2 - nume1;         || calcula la diferencia desde el primer
     |SI sdife ] 0;
          srest = sdife $ 7;           || lunes hasta la fecha actual,la redondea,
          sdife = sdife + (7 - srest); || la divide por 7 y le suma 1 por la
          #0Campo = (sdife / 7) + smas;|| primera semana (en su caso !!!)
     |SINO;
          #0Campo = 1;
     |FINSI;

     |ABRE #semcntcu;     |LEE 000#semcntcu.p;     |CIERRA #semcntcu;

     #0Campo = #0Campo - #semcntcu#3;
     |SI #0Campo = 0; #0Campo = 52; |FINSI;

     |PINTA #0Campo;
|FPRC;

|PROCESO deshas;             || calcula segun semana, desde dia hasta dia
     |ABRE #semcntcu;     |LEE 000#semcntcu.p;     |CIERRA #semcntcu;

     nume2 = (#0#1 + #semcntcu#3) - smas;
     nume2 = (nume2 * 7) + (sdia - 1);   || dias hasta
     nume1 = nume2 - 6;                  || dias desde

     nume3 = #0#0;
     nume3 = nume3 - 1;
     alfa1 = "31.12." + nume3;    || saca los dias que hay hasta el 31.12
     fech1 = alfa1;
     nume3 = fech1;

     nume1 = nume1 + nume3;
     fech1 = nume1;         || fecha desde
     #0#6 = fech1;

     nume2 = nume2 + nume3;
     fech2 = nume2;         || fecha hasta
     #0#7 = fech2;

     |HAZ IniSemana;
|FPRC;

|PROCESO IniSemana;
     Comodin = fech1;
     Dia = Comodin % 0102;
     Mes = Comodin % 0402;
     Dia1 = Dia;
     Mes1 = Mes;

     Comodin = fech2;
     Dia = Comodin % 0102;
     Mes = Comodin % 0402;
     Dia2 = Dia;
     Mes2 = Mes;

     reales = (fech2 - fech1) + 1;
     |SI Mes1 ! Mes2;
          DifDias = fech2 - fech1;
          DifDias = (DifDias - Dia2) + 1;
     |SINO;
          DifDias = 0;
     |FINSI;

     |HAZ tipos;
|FPRC;

|PROGRAMA;

     |CLS;
     |CABEZA "Pase a mantenimiento";
     |ABRE #0;
     |PINPA #0#0;
     |LEE 101#0p;
     |SI FSalida ! 0;    |GRABA 020#0b; |FINSI;
     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida < 0; |ACABA; |FINSI;

     |SI #0#30 = "S";
          |ABRE #sememrec;
          |LEE 101#sememrec.=;
          |SI FSalida ! 0;    |GRABA 020#sememrec.b;   |FINSI;
          |PARA nPara1 = 9; |SI nPara1 [ 28; |HACIENDO nPara1 = nPara1 + 1;
               nPara2 = nPara1 + 51;
               #sememrec#nPara2# = #0nPara1;
          |SIGUE;
          #sememrec#2 = #0#2;
          #sememrec#3 = #0#3;
          #sememrec#4 = #0#4;
          #sememrec#5 = #0#5;
          |GRABA 020#sememrec.a;
          |LIBERA #sememrec;
          |CIERRA #sememrec;
     |FINSI;

     |GRABA 020#0a;
     |LIBERA #0;
     |CIERRA #0;

     |ABRE #semcalcb;
     |ABRE #semcalcl;
     |ABRE #semconce;
     |ABRE #nomvarca;
     |ABRE #nomvarli;
     |ABRE #nomconli;
     |ABRE #nomconca;
     |ABRE #labtraba;
     |ABRE #semequiv;
     |SELECT #2#semequiv;
     |ABRE #nomcatli;
     |ABRE #nomtrali;
     |ABRE #nomvarli;
     |ABRE #nomtrcal;

     |SI #0#9 = 0;
          |BUCLE Rellena;
     |SINO;
          |ABRE #semtraba;
          |PARA nEmpresa = 9; |SI nEmpresa [ 18; |HACIENDO nEmpresa = nEmpresa + 1;
               nTrabaja = nEmpresa + 10;
               #semtraba#3 = #sempasma#0;
               #semtraba#4 = #sempasma#1;
               #semtraba#0 = #0nEmpresa;
               #semtraba#1 = #0nTrabaja;
               |LEE 000#semtraba.=;
               |SI FSalida = 0;|Y #sempasma#0 ! 0;|Y #sempasma#1 ! 0;
                    |HAZ Rellena;
               |FINSI;
          |SIGUE;
          |CIERRA #semtraba;
     |FINSI;

     |SI nCuantos = 0;
          |MENAV "0000Seleccion vacia.";
     |SINO;
          aAlfa1 = "0000Calculados [" + nCuantos + "] recibos.";
          |MENAV aAlfa1;
     |FINSI;

     |CIERRA #nomtrcal;
     |CIERRA #nomconca;
     |CIERRA #nomconli;
     |CIERRA #nomvarli;
     |CIERRA #nomvarca;
     |CIERRA #semcalcl;
     |CIERRA #semcalcb;
     |CIERRA #semconce;
     |CIERRA #labtraba;
     |CIERRA #semequiv;
     |CIERRA #nomcatli;
     |CIERRA #nomtrali;
     |CIERRA #nomvarli;
|FPRO;


||****************************************************************************
|| CALCULO PRORRATA
||****************************************************************************

|PROCESO Prorrata;
     |SI DifDias ! 0; DifDias = 7 - DifDias; |FINSI;
     |HAZ caldias;
     |HAZ calpror;
|FPRC;

|VARIABLES;
    FEstado = 0;
    act = 0;
    actc = 0;
    acu_auto = 0;
    acum1_200 = 0;
    acum2_200 = 0;
    acum_10 = 0;
    acum_11 = 0;
    acum_12 = 0;
    acum_13 = 0;
    acum_30 = 0;
    acum_301 = 0;
    acum_302 = 0;
    acum_303 = 0;
    acum_31 = 0;
    acum_311 = 0;
    acum_312 = 0;
    acum_313 = 0;
    acum_40 = 0;
    acum_401 = 0;
    acum_402 = 0;
    acum_403 = 0;
    acum_41 = 0;
    acum_50 = 0;
    acum_51 = 0;
    acum_52 = 0;
    acum_53 = 0;
    acum_54 = 0;
    acum_60 = 0;
    acum_90 = 0;
    acum_99 = 0;
    acum_991 = 0;
    acum_992 = 0;
    acum_993 = 0;
    acum_smi0 = 0;
    acum_smi1 = 0;
    acum_smi2 = 0;
    acum_smi3 = 0;
    acum_smi4 = 0;
    acum_smi5 = 0;
    acum_smi6 = 0;
    acumb = 0;
    ajus_1 = 0;
    ajus_2 = 0;
    ajus_p = 0;
    alfa3 = "";        || variable de trabajo
    alfa4 = "";        || variable de trabajo
    alfa5 = "";        || variable de trabajo
    alfa6 = "";        || variable de trabajo
    alfa7 = "";        || variable de trabajo
    alfa8 = "";        || variable de trabajo
    anti_41 = 0;
    antici1 = 0;
    antici2 = 0;
    anticom = 0;
    any = 0;           || calculo 'desglosa'
    anyo1 = 0;
    anyo2 = 0;
    anyact = 0;
    anyalt = 0;
    anynum = 0;
    anyos = 0;
    anyven = 0;
    auto1 = 0;
    auto2 = 0;
    auto3 = 0;
    aux_conv = 0;
    base_1 = 0;
    base_2 = 0;
    base_3 = 0;
    base_4 = 0;
    base_5 = 0;
    base_6 = 0;
    base_7 = 0;
    base_8 = 0;
    base_9 = 0;
    zbase_9 = 0;
    base_A = 0;
    zbase_A = 0;
    base_B = 0;
    zbase_B = 0;
    base_C = 0;
    zbase_C = 0;
    base_D = 0;
    base_E = 0;
    base_F = 0;
    zbase_F = 0;
    base_G = 0;
    bases = 0;
    bisiesto = 0;
    bon_0 = 0;
    zbon_0 = 0;
    &bon_1 = 0;          || exportable al 'nomcalfi'
    &bon_2 = 0;          || exportable al 'nomcalfi'
    bon_3 = 0;
    zbon_3 = 0;
    bon_5 = 0;
    zbon_5 = 0;
    bruto_aju = 0;
    bruto_pag = 0;
    bruto_rec = 0;
    cabecera = 0;      || switch para grabar o no cabeceras de calculos
    cale_val = 0;
    camdes = 0;
    camhas = 0;
    campo = 0;
    campomax = 0;
    campomin = 0;
    campos = 0;
    citri_c = 1;       || coef. citricos tipo C
    citri_f = 1;       || coef. citricos tipo F
    &coba_1 = 0;
    &cobb_1 = 0;
    &coba_2 = 0;
    &cobb_2 = 0;
    &coba_3 = 0;
    &cobb_3 = 0;
    &coba_4 = 0;
    &cobb_4 = 0;
    concep0 = 0;
    concep1 = 0;
    concep2 = 0;
    concepto = 0;      || variable de trabajo del campo 'concepto'
    conser1 = 0;
    conser2 = 0;
    convenio = 0;      || switch de error de existencia o no de linea convenio
    coti_0 = 0;
    coti_1 = 0;
    coti_2 = 0;
    dabse_k = 0;
    dabse_1 = 0;
    dabse_2 = 0;
    dabse_3 = 0;
    dacci_k = 0;
    dacci_0 = 0;
    dacci_1 = 0;
    dacci_2 = 0;
    dacci_3 = 0;
    dacci_Y = 0;
    dacci_Z = 0;
    dacci_t = 0;
    dacum_30 = 0;
    dacum_31 = 0;
    dacum_999 = 0;
    dacum_vac = 0;
    dalta_k = 0;
    dalta_1 = 0;
    dalta_2 = 0;
    dalta_3 = 0;
    danti_0 = 0;
    danti_1 = 0;
    dbaja_k = 0;
    dbaja_1 = 0;
    dbaja_2 = 0;
    dbaja_3 = 0;
    &dboni_1 = 0;
    &dboni_2 = 0;
    dcobr_0 = 0;
    dcofi_1 = 0;
    dcofi_2 = 0;
    dcofi_3 = 0;
    dcofi_4 = 0;
    dcofi_5 = 0;
    dcofi_6 = 0;
    dcofi_7 = 0;
    dcofi_201 = 0;
    dcofi_202 = 0;
    dcofi_203 = 0;
    dcofi_204 = 0;
    dcofi_205 = 0;
    dcofi_206 = 0;
    dcofi_207 = 0;
    dcofi_208 = 0;
    dcofi_209 = 0;
    dcofi_999 = 1;
    &dcoti_0 = 0;        || exportable al 'nomcalfi'
    ddese_k = 0;
    ddese_1 = 0;
    ddese_2 = 0;
    de1 = 0;
    de2 = 0;
    dedia = 0;
    dedia1 = 0;
    deducss = 0;
    denfe_k = 0;
    denfe_0 = 0;
    denfe_1 = 0;
    denfe_2 = 0;
    denfe_20 = 0;
    denfe_21 = 0;
    denfe_22 = 0;
    denfe_23 = 0;
    denfe_24 = 0;
    denfe_3 = 0;
    denfe_4 = 0;
    denfe_A = 0;
    denfe_B = 0;
    denfe_C = 0;
    denfe_D = 0;
    denfe_A0 = 0;
    denfe_B0 = 0;
    denfe_C0 = 0;
    denfe_D0 = 0;
    denfe_V = 0;
    denfe_W = 0;
    denfe_X = 0;
    denfe_Y = 0;
    denfe_Z = 0;
    denfe_V0 = 0;
    denfe_W0 = 0;
    denfe_X0 = 0;
    denfe_Y0 = 0;
    denfe_Z0 = 0;
    denfe_t = 0;
    des = 0;
    des1 = 0;
    des2 = 0;
    desc = 0;
    desde = 0;
    desde1 = 0;
    dhuel_k = 0;
    dhuel_1 = 0;
    dhuel_2 = 0;
    dhuel_3 = 0;
    dia = 0;
    dia_k = 0;
    dia_1 = 0;
    dia_2 = 0;
    dia_3 = 0;
    dia_4 = 0;
    diaalt = 0;
    diafest = 0;
    dialabo = 0;
    dias_dto = 0;
    dias_v = 0;
    diasp = 0;
    diast = 0;
    diastc2 = 0;
    diaven = 0;
    difer1 = 0;
    difer_a = 0;
    difer_m = 0;
    difere = 0;
    diff = 0;
    dilt = 0;
    divide = 0;
    dlabo_0 = 0;
    dlabi_0 = 0;
    dlabo_k = 0;
    dlabi_k = 0;
    dmate_k = 0;
    dmate_0 = 0;
    dmate_1 = 0;
    dmate_2 = 0;
    dmate_3 = 0;
    dmate_t = 0;
    dmate_Z = 0;
    dmate_Y = 0;
    doce = 0;
    dto_con = 0;
    dto_dfp = 0;
    dto_ho1 = 0;
    dto_ho2 = 0;
    dto_tot = 0;
    dtot = 0;
    duni1_200 = 0;
    duni1_902 = 0;
    duni1_903 = 0;
    duni1_999 = 0;
    duni2_200 = 0;
    duni2_902 = 0;
    duni2_903 = 0;
    duni2_998 = 0;
    duni2_999 = 0;
    duni3_200 = 0;
    dtodo_3 = 0;
    dvaca_1 = 0;
    dvaca_2 = 0;
    dvaca_k = 0;
    dvalo_200 = 0;
    dvalo_201 = 0;
    dvalo_202 = 0;
    dvalo_203 = 0;
    dvalo_204 = 0;
    dvalo_205 = 0;
    dvalo_206 = 0;
    dvalo_207 = 0;
    dvalo_208 = 0;
    dvalo_209 = 0;
    dvalo_902 = 0;
    dvalo_903 = 0;
    dvalo_999 = 0;
    dvalo_pag = 0;
    dvalo_pro = 0;
    elotro = 0;
    &es_aprendi = 0;
    &es_irregul = 0;
    &es_parcial = 0;
    &epig_ilt = 0;
    &epig_ims = 0;
    especie = 0;
    estevale = 0;
    exce_smi = 0;
    fanti_a = 0;
    fanti_m = 0;
    fecalf = "";       || calculo 'desglosa'
    fecbaj = "";       || calculo 'baja'
    fech3 = @;
    fecsis = @;        || variable fecha de trabajo
    fecsys = @;        || variable fecha de trabajo
    fijo_1 = 0;
    fvenci = "";       || fecha vencimiento antiguedad
    ganti_a = 0;
    ganti_m = 0;
    graba04 = 0;
    graba05 = "";
    graba06 = 0;
    graba07 = 0;
    graba08 = "";
    graba09 = 0;
    graba10 = 0;
    graba11 = 0;
    guarda_l = 0;
    gua_i = 0;
    &guarda = 0;
    &grupo = 0;               || exportable al 'nomcalfi'
    ha1 = 0;
    ha2 = 0;
    hadia = 0;
    hadia1 = 0;
    has = 0;
    has1 = 0;
    has2 = 0;
    hasc = 0;
    hasta = 0;
    hasta1 = 0;
    &hcobr_0 = 0;
    &hcoti_0 = 0;      || exportable al 'nomcalfi'
    hdias_0 = 0;
    histori = "";      || variable tabla indicando variaciones/trabajador
    horasex = 0;
    horastp = 0;
    horatc2 = 0;
    hbaja_2 = 0;
    hdese_2 = 0;
    hhuel_3 = 0;
    habse_3 = 0;
    hacci_2 = 0;
    henfe_2 = 0;
    hmate_2 = 0;
    idia_1 = 0;
    idia_3 = 0;
    idia_4 = 0;
    idia_6 = 0;
    indemni = 0;
    lin_1 = 0;
    lin_2 = 0;
    liq_aju = 0;
    liquido = 0;
    m_dias = 0;
    mas = 0;
    mensaje0 = "    Seleccion vacia ... ";
    mensaje1 = "ATENCION, PROCESO DETENIDO !!! Convenio ";
    mensaje2 = ", INEXISTENTE en fichero ";
    mes = 0;
    mesact = 0;
    mesalt = 0;
    mesco = 0;
    meslabo = "";      || mes del calendario laboral
    mesnum = 0;
    mespinta = "";     || variable de trabajo para pintar el mes
    mesven = 0;
    mid = 0;
    notaria = 0;
    nume0 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    nume7 = 0;
    numer = 0;
    p_mes = "";        || variable de trabajo para pintar mes literal
    paga = 0;
    pagavac = 0;
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    pcofi_2 = 0;
    pdia_0 = 0;
    pdia_1 = 0;
    pdia_2 = 0;
    pdia_3 = 0;
    pdia_4 = 0;
    pdia_6 = 0;
    pdia_a = 0;
    pdia_b = 0;
    pdia_c = 0;
    pdia_d = 0;
    pdia_e = 0;
    pdia_f = 0;
    pepulti = 0;
    perio = 0;
    por1_cont = 0;
    por1_dfpg = 0;
    por1_hor1 = 0;
    por1_hor2 = 0;
    por2_cont = 0;
    por2_dfpg = 0;
    por2_hor1 = 0;
    por2_hor2 = 0;
    porce = 0;
    porcp = 0;
    pp = 0;
    primera = 0;
    produc1 = 0;
    produc2 = 0;
    produc3 = 0;
    product = 0;
    prom_ac2 = 0;
    prom_acc = 0;
    prom_enf = 0;
    prom_ind = 0;
    &propo = 0;          || exportable al 'nomcalfi'
    puntero = 0;
    reten_1 = 0;
    reten_11 = 0;
    reten_12 = 0;
    reten_13 = 0;
    reten_2 = 0;
    rompe = 0;
    s_reajus = 0;
    &seleccio = 0;      || exportable al 'nomcalfi'
    sigui = 0;
    stop = 0;
    swDiferFiniq = 0;
    sw_bruaju = 0;
    &sw_mater = 0;
    swaju_abs = 0;
    swaju_acc = 0;
    swaju_des = 0;
    swaju_enf = 0;
    swaju_hue = 0;
    swaju_mat = 0;
    swaju_vac = 0;
    swajuac = 0;
    swajuen = 0;
    swalta = 0;
    swbaja = 0;
    swcongra = 0;
    swconst = 0;
    &swfuera = 0;
    swgracon = 0;
    swmarca = "";      || indicador de variaciones/trabajador
    swpaga = 0;
    swpro = 0;
    t_haz = 0;
    tempo1 = 0;
    tempo2 = 0;
    tempo3 = 0;
    tempo4 = 0;
    tempo5 = 0;
    tempor = 0;
    tipo_p = 0;
    &tipo1 = "";        || mes que cumple a¤o (actual)
    &tipo2 = "";        || mes que cumple a¤o (siguiente)
    &tipo3 = "";        || trimestre que cumple a¤o (actual)
    &tipo4 = "";        || trimestre que cumple a¤o (siguiente)
    &tipo5 = "";        || semestre que cumple a¤o (actual)
    &tipo6 = "";        || semestre que cumple a¤o (siguiente)
    &tipo7 = "";        || a¤o que cumple a¤o (actual)
    &tipo8 = "";        || a¤o que cumple a¤o (siguiente)
    &tipos = 0;
    &tipox = 0;
    topemes = 0;
    topemes1 = 0;
    topemes2 = 0;
    &topesmi = 0;
    totact = 0;
    totalt = 0;
    totven = 0;
    &tp = 0;             || exportable al 'nomcalfi'
    tp1 = 0;
    tp2 = 0;
    tp3 = 0;
    tpx = 0;
    tpz = 0;
    trabamen = "";
    unidades = 0;
    vacacio = 0;
    val_auto = 0;
    valorito = 0;
    vcobr_0 = 0;
    vcoti_0 = 0;
    vlabo_0 = 0;
    vlabo_k = 0;
    yaesta = 0;
    CodigoCons = 0;
    &nMes99 = 0;
    &nSwMes99 = 0;

     nHastaBonif = 0;
     nVtoBonif = 0;
     &nPorBon1 = 0;
     &nPorBon2 = 0;
     nQueBusca = 0;
     aFabre = "";
     &ay_emp = 0;
     &ay_tra = 0;
     &ay_mes = 0;
     &ay_any = 0;
     &ay_ant = "";
     nRecAy = 0;
     nEl36 = 0;

     RemunTot = 0;
     Prorrata = 0;
     nAnticipo = 0;
|FIN;

||****************************************************************************
|| CALCULO DIAS ILT
||****************************************************************************

|PROCESO calleer;
CodigoCons = 0;
|DDEFECTO #nomtraca;
|ABRE #nomtraca;
#nomtraca#0 = #semcalcb#3;
#nomtraca#1 = #semcalcb#4;
|LEE 000#nomtraca.=;
|SI FSalida = 0;|Y #nomtraca#3 ! 0;
     CodigoCons = #nomtraca#3;
|FINSI;
|CIERRA #nomtraca;

|DDEFECTO #labempre;
|ABRE #labempre;
#labempre#0 = #semcalcb#3;
|LEE 000#labempre.=;         || lee la empresa
|CIERRA #labempre;
|SI CodigoCons = 0;
     CodigoCons = #labempre#32;
|FINSI;

|DDEFECTO #labtraba;
#labtraba#0 = #semcalcb#3;
#labtraba#1 = #semcalcb#4;
|LEE 000#labtraba.=;         || lee el trabajador

|DDEFECTO #semequiv;
#semequiv#1 = #labtraba#0;
#semequiv#2 = #labtraba#1;
|LEE 000#semequiv.=;

|DDEFECTO #nomconca;
#nomconca#0 = #labtraba#87;
|LEE 000#nomconca.=;

|DDEFECTO #nomconax;
|ABRE #nomconax;
#nomconax#0 = #labtraba#87;
|LEE 000#nomconax.=;
|CIERRA #nomconax;

|DDEFECTO #nomantca;
|ABRE #nomantca;
#nomantca#0 = #labtraba#87;
#nomantca#0 = #labtraba#17;
|LEE 000#nomantca.=;
|CIERRA #nomantca;

es_aprendi = 0;
|SI #labtraba#45 = "087";|O #labtraba#45 = "097";|O #labtraba#45 = "085"; es_aprendi = 1; |FINSI;

|SI #labtraba#42 = "I";|O #labtraba#42 = "P"; es_irregul = 1; |FINSI;

|SI Mes1 = Mes2;
   guarda = (Dia2 - Dia1) + 1;
|SINO;
   |SI MesEsp = Mes1;
      guarda = DifDias;
   |SINO;
      guarda = DiasLabs - DifDias;
   |FINSI;
|FINSI;

/*
|DDEFECTO #nomvarca;
|ABRE #nomvarca;
    #nomvarca#0 = #semcalcb#3;
    #nomvarca#1 = #semcalcb#4;
    #nomvarca#2 = #semcalcb#1;
|LEE 000#nomvarca.=;
|SI FSalida ! 0;
   #nomvarca#16 = "          ";
|FINSI;
|CIERRA #nomvarca;
*/

|SI #nomtrcal#0 ! #labtraba#156; |O #nomtrcal#13 ! #sempasma#0;
        |DDEFECTO #nomtrcal;
        #nomtrcal#0  = #labtraba#156;
        #nomtrcal#13 = #sempasma#0;

        |LEE 000#nomtrcal.=;
        topemes1 = 0;
        topemes2 = 0;    || calcula los dias laborables del mes
        swmarca = "A";
        |HAZ calendar;
        conser1 = dialabo;    || guarda los dias laborables del mes
        conser2 = diafest;    || guarda los dias festivos del mes
|FINSI;

|SI es_aprendi = 1;|O #labtraba#45 = "064";|O #labtraba#45 = "065";
    |ABRE #nomcones;
    |DDEFECTO #nomcones;
        #nomcones#0 = #labempre#32;
    |LEE 000#nomcones.=;        || lee la cotizacion especial
    |SI FSalida ! 0;
            alfa1 = "    Constante Especial [" + #labempre#32 + "] inaccesible o inexistente ...";
        |MENAV alfa1;
    |FINSI;
    |CIERRA #nomcones;
|FINSI;

|ABRE #nomconst;
|DDEFECTO #nomconst;                || lee la constante (siempre)
    #nomconst#0 = CodigoCons;
|LEE 020#nomconst.=;
|CIERRA #nomconst;

    nRecAy = #nomconst#74;

    nEl36 = 36;
|SI #5#112 ! "S";   nEl36 = 0;     |FINSI;

    topesmi = (#nomconst#76 % 20) ! EURODB;
    por1_cont = #nomconst#07;                             || (%) contigen.(tra.)
    por1_hor1 = #nomconst#09;                             || (%) horas 1  (tra.)
    por1_hor2 = #nomconst#11;                             || (%) horas 2  (tra.)
    por1_dfpg = #nomconst#13 + #nomconst#15 + #nomconst#17 + #nomconst#19;  || (%) d+f+p+g  (tra.)
    por2_cont = #nomconst#06 + nRecAy;                    || (%) contigen.(emp.)
    por2_hor1 = #nomconst#08;                             || (%) horas 1  (emp.)
    por2_hor2 = #nomconst#10;                             || (%) horas 2  (emp.)
    por2_dfpg = #nomconst#12 + #nomconst#14 + #nomconst#16 + #nomconst#18;  || (%) d+f+p+g  (emp.)

|SI #labtraba#45 = "087";|O #labtraba#45 = "097";|O #labtraba#45 = "085";
        por1_hor1 = por1_hor1 + por1_dfpg;         || (%) horas 1 (aprend)
        por1_hor2 = por1_hor2 + por1_dfpg;         || (%) horas 2 (aprend)
|FINSI;
|SI #labtraba#45 = "064";        || temporales
        por1_cont = por1_cont * #nomcones#21;      || (%) contigen.(tra.)
        por2_cont = por2_cont * #nomcones#21;      || (%) contigen.(emp.)
|FINSI;
|SI #labtraba#45 = "065";        || indefinidos
        por1_cont = por1_cont * #nomcones#22;      || (%) contigen.(tra.)
        por2_cont = por2_cont * #nomcones#22;      || (%) contigen.(emp.)
|FINSI;
    por1_cont = por1_cont ! 2;
    por2_cont = por2_cont ! 2;

|DDEFECTO #nomcontr;
|ABRE #nomcontr;
|LEE 000#nomcontr.p;            || lee control de aplicacion
|CIERRA #nomcontr;
|FPRC;

|PROCESO diatodos;
    dia_4 = dia_3;

    hdias_0 = dia_4;
    hdese_2 = ddese_2;
    ||hhuel_3 = dhuel_3;
    hhuel_3 = dhuel_2;
    ||habse_3 = dabse_3;
    habse_3 = dabse_2;
    hacci_2 = dacci_2;
    henfe_2 = denfe_2;
    hmate_2 = dmate_2;

    dcobr_0=dia_4-(dalta_2+dbaja_2+dhuel_2+ddese_2+dabse_2+dacci_2+denfe_2+dmate_2);
    dcoti_0=dia_4-(dalta_2+dbaja_2+dhuel_2+ddese_2);
    dlabo_0=dia_1-(dalta_1+dbaja_1+dhuel_1+ddese_1+dabse_1+dacci_1+denfe_1+dmate_1);
    dlabi_0=dia_1-(dalta_1+dbaja_1+dhuel_1+ddese_1);
    dlabo_k=dia_k-(dalta_k+dbaja_k+dhuel_k+ddese_k+dabse_k+dacci_k+denfe_k+dmate_k);
    dlabi_k=dia_k-(dalta_k+dbaja_k+dhuel_k+ddese_k);

    vcobr_0=dcobr_0 - dvaca_2;     || resta los dias de vacaciones
    vcoti_0=dcoti_0 - dvaca_2;
    vlabo_0=dlabo_0 - dvaca_1;
    vlabo_k=dlabo_k - dvaca_k;

    hcobr_0=hdias_0-(dalta_2+hbaja_2+hhuel_3+hdese_2+habse_3+hacci_2+henfe_2+hmate_2);
    hcoti_0=hdias_0-(dalta_2+hbaja_2+hhuel_3+hdese_2);

|SI dcobr_0 < 0;  dcobr_0 = 0;  |FINSI;  || dias cobro
|SI dcoti_0 < 0;  dcoti_0 = 0;  |FINSI;  || dias cotizables
|SI dlabo_0 < 0;  dlabo_0 = 0;  |FINSI;  || dias laborables 1
|SI dlabi_0 < 0;  dlabi_0 = 0;  |FINSI;  || dias laborables 2
|SI dlabo_k < 0;  dlabo_k = 0;  |FINSI;  || dias festivos 1
|SI dlabi_k < 0;  dlabi_k = 0;  |FINSI;  || dias festivos 1
|SI vcobr_0 < 0;  vcobr_0 = 0;  |FINSI;  || dias cobro sin vaca.
|SI vcoti_0 < 0;  vcoti_0 = 0;  |FINSI;  || dias cotiz. sin vaca.
|SI vlabo_0 < 0;  vlabo_0 = 0;  |FINSI;  || dias labor. sin vaca.
|SI vlabo_k < 0;  vlabo_k = 0;  |FINSI;  || dias fest. sin vaca.
|SI hcobr_0 < 0;  hcobr_0 = 0;  |FINSI;  || dias cobro sin dec.
|SI hcoti_0 < 0;  hcoti_0 = 0;  |FINSI;  || dias cotiz. sin dec.

    dia_4 = dia_3;  || recupera dias cotizables

    dcofi_1 =dcobr_0 /dia_4;        || coeficiente para dias cobro
    dcofi_2 =dcoti_0 /dia_4;        || coeficiente para dias cotizables
    dcofi_3 =(dcobr_0+denfe_2+dmate_2) /dia_4;  || coefi. para no dto. enfermed.
|SI dcofi_3 > 1;  dcofi_3 = 1;  |FINSI;         || ajusta a 1
    dcofi_4 =(dcobr_0+dacci_2) /dia_4;          || coefi. no dto. acc.
|SI dcofi_4 > 1;  dcofi_4 = 1;  |FINSI;         || ajusta a 1
    dcofi_5 =vcobr_0 /dia_4;                    || coef. para vacac.=N1
|SI dcofi_5 < 0;  dcofi_5 = 0;  |FINSI;         || ajusta a 0
    dcofi_6 =dvaca_2 /dia_4;                    || coef. para vacac.=E1,E2
    dcofi_7 =vcoti_0 /dia_4;                    || coef. para vacac.=N2
|FPRC;

|PROCESO nomabsca;
     swNoEntra = 0;
     nNume1 = 8;

     |ABRE #nomabsca;
     #nomabsca#0 = #labtraba#0;
     #nomabsca#1 = #labtraba#1;
     |LEE 000#nomabsca.=;
     |SI FSalida = 0;
          nNume1 = #nomabsca#2;
          swNoEntra = 1;
     |FINSI;

     |CIERRA #nomabsca;
|FPRC;

|PROCESO Absentismos;
     alfa1 = #nomabsli#2;
     alfa1 = alfa1 % 102;
     topemes1 = alfa1;

     alfa2 = #nomabsli#3;
     alfa2 = alfa2 % 102;
     topemes2 = alfa2;

     |SI topemes1 = 0;  topemes1 = Dia1;  |FINSI;
     |SI topemes2 = 0;  topemes2 = Dia2;  |FINSI;

     |SI topemes1<dalta_3;    topemes1=dalta_3; |FINSI;
     |SI topemes2>dbaja_3;    topemes2=dbaja_3; |FINSI;

     |SI #nomabsli#4 = "A";
          swmarca = "K";
     |FINSI;
     |SI #nomabsli#4 = "V";
          swmarca = "A";
     |FINSI;
     |SI #nomabsli#4 = "H";
          swmarca = "B";
     |FINSI;
     |HAZ nomabsca;

     |HAZ calendar;

     |SI #nomabsli#6 = 0;
          dias_v = topemes2 - topemes1 + 1;
     |SINO;
          dias_v = (topemes2 - topemes1 + 1) * ((#nomabsli#6 / nNume1) ! 3);
     |FINSI;

     |SI swmarca = "K";
          swaju_abs = 1;
          |HAZ absent;
     |FINSI;
     |SI swmarca = "A";
          swaju_vac = 1;
          |HAZ vacaci;
     |FINSI;
     |SI swmarca = "B";
          swaju_hue = 1;
          |HAZ huelga;
     |FINSI;
|FPRC;

|DEFBUCLE AbsHueVac;
     #nomabsli#1;
     ;
     #labtraba#0, #labtraba#1, fFechaDesde;
     #labtraba#0, #labtraba#1, fFechaHasta;
     ;
     NULL, Absentismos;
|FIN;

|PROCESO AbsHueVacNUEVO;
     |HAZ UltimoDia;
     mesnum = MesEsp;
     anynum = #0#0;
     alfa1 = "01";
     alfa2 = nTopeMes;
     alfa3 = mesnum; alfa3 = "00" + mesnum; alfa3 = alfa3 % -102;
     alfa4 = anynum;
     aFechaDesde = alfa1 + "." + alfa3 + "." + alfa4;
     aFechaHasta = alfa2 + "." + alfa3 + "." + alfa4;
     fFechaDesde = aFechaDesde;
     fFechaHasta = aFechaHasta;

     |BUCLE AbsHueVac;
|FPRC;

|PROCESO caldias;        || CALCULA DIAS VARIOS
     |HAZ cerodias;           || inicializa variables

     dia_k = diafest;     || dias festivos del mes
     dia_1 = dialabo;     || dias laborables del mes
     |SI Mes1 ! Mes2;
          dia_2 = DifDias;
     |SINO;
          dia_2 = topemes;
     |FINSI;
     dia_3 = dia_2;       || dias cotizacion semanal

     swmarca = "B";
     |HAZ altas;              || calcula dias de alta (en su caso)
     |HAZ bajas;              || calcula dias de baja (en su caso)
     |SI #nomvarca#12 = " ";|Y #nomvarca#13 = " ";|Y #nomvarca#14 = " ";|Y #nomvarca#15 = " ";
          |SI #labtraba#89 ! 0;  #nomvarca#12 = #labtraba#60;  |FINSI;
          |SI #labtraba#92 ! 0;  #nomvarca#12 = "A";    |FINSI;
     |FINSI;

     |PARA campos = 12; |SI campos [ 15; |HACIENDO campos = campos + 1;
          |SI #nomvarca#campos# ! " ";
               camdes = campos - 8;  topemes1 = #nomvarca#camdes#;
               camhas = campos - 4;  topemes2 = #nomvarca#camhas#;

               |SI topemes1 = 0;  topemes1 = Dia1;  |FINSI;
               |SI topemes2 = 0;  topemes2 = Dia2;  |FINSI;

               |SI topemes1<dalta_3;  #nomvarca#camdes#=dalta_3;  topemes1=dalta_3; |FINSI;
               |SI topemes2>dbaja_3;  #nomvarca#camhas#=dbaja_3;  topemes2=dbaja_3; |FINSI;

               |SI #nomvarca#campos#="H";|O #nomvarca#campos#="D"; swmarca="B"; |FINSI; || baja
               |SI #nomvarca#campos#="A";                 swmarca="J"; |FINSI; || accidente
               |SI #nomvarca#campos#="F";                 swmarca="K"; |FINSI; || absentismo
               |SI #nomvarca#campos#="E";                 swmarca="I"; |FINSI; || enfermedad
               |SI #nomvarca#campos#="M";                 swmarca="M"; |FINSI; || maternidad
               |SI #nomvarca#campos#="V";                 swmarca="A"; |FINSI; || vacaciones

               |HAZ calendar;

               dias_v = (topemes2 - topemes1) + 1;

               |SI #nomvarca#campos# = "H";  |HAZ huelga;  |FINSI;  || calcula dias huelga
               |SI #nomvarca#campos# = "F";  |HAZ absent;  |FINSI;  || calcula dias absen.
               |SI #nomvarca#campos# = "f";  |HAZ absent;  |FINSI;  || calcula dias absen.
               |SI #nomvarca#campos# = "A";  |HAZ accide;  |FINSI;  || calcula dias accid.
               |SI #nomvarca#campos# = "E";  |HAZ enferm;  |FINSI;  || calcula dias enfer.
               |SI #nomvarca#campos# = "M";  |HAZ matern;  |FINSI;  || calcula dias mater.
               |SI #nomvarca#campos# = "V";  |HAZ vacaci;  |FINSI;  || calcula dias vacac.
               |SI #nomvarca#campos# = "D";  |HAZ desemp;  |FINSI;  || calcula dias desemp.
          |FINSI;
     |SIGUE;

     |HAZ AbsHueVacNUEVO;

     || variables paralelas para los mensuales diarios o diarios mensuales
     hbaja_2 = dbaja_2;
     ||hdese_2 = ddese_2;   hhuel_3 = dhuel_3;  habse_3 = dabse_3;
     hdese_2 = ddese_2;   hhuel_3 = dhuel_2;  habse_3 = dabse_3;
     hacci_2 = dacci_2;   henfe_2 = denfe_2;  hmate_2 = dmate_2;
     |HAZ diatodos;
|FPRC;

|PROCESO cerodias;     || INICIALIZA VARIABLES DEL CALCULO DE DIAS
    dalta_1 = 0;   dalta_2 = 0;   dalta_k = 0;
    dbaja_1 = 0;   dbaja_2 = 0;   dbaja_k = 0;
    dhuel_1 = 0;   dhuel_2 = 0;   dhuel_k = 0;   dhuel_3 = 0;
    ddese_1 = 0;   ddese_2 = 0;   ddese_k = 0;
    dabse_1 = 0;   dabse_2 = 0;   dabse_k = 0;   dabse_3 = 0;
    dacci_0 = 0;   dacci_1 = 0;   dacci_k = 0;   dacci_2 = 0;    dacci_3 = 0;
    denfe_0 = 0;   denfe_1 = 0;   denfe_k = 0;   denfe_2 = 0;
    denfe_21 = 0;  denfe_22 = 0;  denfe_23 = 0;  denfe_24 = 0;
    denfe_3 = 0;   denfe_4 = 0;
    denfe_A = 0;   denfe_B = 0;   denfe_C = 0;   denfe_D = 0;
    dmate_0 = 0;   dmate_1 = 0;   dmate_k = 0;   dmate_2 = 0;    dmate_3 = 0;
    dvaca_1 = 0;   dvaca_2 = 0;   dvaca_k = 0;
    dboni_1 = 0;   dboni_2 = 0;
    dtodo_3 = 0;
    topemes1 = 0;  topemes2 = 0;
    topemes = reales; ||guarda;   || restaura ultimo dia natural del mes
    dialabo = conser1;            || restaura dias laborables del mes
    diafest = conser2;            || restaura dias festivos del mes
    swaju_mat = 0;
    swaju_acc = 0;
    swaju_des = 0;
    swaju_enf = 0;
    swaju_hue = 0;
    swaju_abs = 0;
    swaju_vac = 0;
    histori = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";  || hay 31 as
    dacum_vac = 0;
    acum1_200 = 0;
    acum2_200 = 0;
    sw_mater = 0;
    guarda_l = 0;
|FPRC;

|PROCESO calendar;                 || CALCULA LOS DIAS LABORABLES

   |SI topemes1 = 0; topemes1 = 1; |FINSI;
   |SI topemes2 = 0; topemes2 = Dia2; |FINSI;

   |SI Mes1 ! Mes2;
      Comodin = #nomtrcal#Mes1#;
      |PARA Cont = Dia1; |SI Cont [ 31; |HACIENDO Cont = Cont + 1;
         ComodNum = (Cont * 100) + 1;
         Comodin1 = Comodin % ComodNum;
         |SI Comodin1 = "0";
            dialabo = dialabo + 1;
         |SINO;
            diafest = diafest + 1;
         |FINSI;
         |SI swmarca ! "A";                 || construye las variaciones en variab.
            alfa1 = histori % 0;  nume0 = alfa1;         || longitud
            nume1 = (100 + (mid - 1));                   || parte izquierda
            alfa1 = histori % nume1;
            nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
            alfa2 = histori % nume2;
            histori = alfa1 + swmarca + alfa2;           || une
         |FINSI;
      |SIGUE;

      Comodin = #nomtrcal#Mes2#;
      |PARA Cont = 1; |SI Cont [ Dia2; |HACIENDO Cont = Cont + 1;
         ComodNum = (Cont * 100) + 1;
         Comodin1 = Comodin % ComodNum;
         |SI Comodin1 = "0";
            dialabo = dialabo + 1;
         |SINO;
            diafest = diafest + 1;
         |FINSI;
         |SI swmarca ! "A";                 || construye las variaciones en variab.
            alfa1 = histori % 0;  nume0 = alfa1;         || longitud
            nume1 = (100 + (mid - 1));                   || parte izquierda
            alfa1 = histori % nume1;
            nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
            alfa2 = histori % nume2;
            histori = alfa1 + swmarca + alfa2;           || une
         |FINSI;
      |SIGUE;
   |SINO;
      Comodin = #nomtrcal#Mes1#;
      |PARA Cont = Dia1; |SI Cont [ Dia2; |HACIENDO Cont = Cont + 1;
         ComodNum = (Cont * 100) + 1;
         Comodin1 = Comodin % ComodNum;
         |SI Comodin1 = "0";
            dialabo = dialabo + 1;
         |SINO;
            diafest = diafest + 1;
         |FINSI;
         |SI swmarca ! "A";                 || construye las variaciones en variab.
            alfa1 = histori % 0;  nume0 = alfa1;         || longitud
            nume1 = (100 + (mid - 1));                   || parte izquierda
            alfa1 = histori % nume1;
            nume2 = (100 + (nume0 - mid)) * (-1);        || parte derecha
            alfa2 = histori % nume2;
            histori = alfa1 + swmarca + alfa2;           || une
         |FINSI;
      |SIGUE;
   |FINSI;
|FPRC;

|PROCESO altas;
    swalta = 0;
    fecalf = #labtraba#36;
    dalta_3 = 1;
|HAZ desglosa;

|SI dia ] Dia1; |Y dia [ Dia2; |Y any = #sempasma#0;     || si es alta esta semana
   |SI mes = Mes1; |O mes = Mes2;
        swalta = 1;
        topemes1 = 0;
        topemes2 = dia - 1;
        dialabo = 0;
        diafest = 0;
        |SI topemes2 ! 0;  |HAZ calendar;  |FINSI;  || por si es alta el dia 1
        dalta_k = diafest;         || dias festivos antes del alta
        dalta_1 = dialabo;         || dias laborables antes del alta
        dalta_2 = dia - 1;         || dias cotizables antes del alta
        dalta_3 = dia;             || dia que es alta
   |FINSI;
|FINSI;
|FPRC;

|PROCESO bajas;
    swbaja = 0;
    dbaja_3 = dia_2;
    fecbaj = #labtraba#37;
|SI #nomvarca#16 ! "..........";|Y #nomvarca#16 ! "          ";
        fecbaj = #nomvarca#16;
|FINSI;
    fecalf = fecbaj;
|HAZ desglosa;
|SI dia ] Dia1; |Y dia [ Dia2; |Y any = #sempasma#0;     || si es baja esta semana
   |SI mes = Mes1; |O mes = Mes2;
        swbaja = 1;
        topemes1 = dia + 1;
        topemes2 = 0;
        dialabo = 0;
        diafest = 0;
        |SI topemes1 [ guarda;  |HAZ calendar;  |FINSI;  || por si es final de mes
        dbaja_k = diafest;         || dias festivos despues de la baja
        dbaja_1 = dialabo;         || dias laborables despues de la baja
        dbaja_2 = dia_2 - dia;     || dias cotizables despues de la baja
        dbaja_3 = dia;             || dia hasta el que trabaja
   |FINSI;
|FINSI;
|FPRC;

|PROCESO desemp;
    ddese_k = ddese_k + diafest;   || dias festivos que esta en desemp.
    ddese_1 = ddese_1 + dialabo;   || dias laborables que esta en desemp.
|SI ddese_2 = 0;
        ddese_2 = #nomvarca#27 / 100;     || parte decimal
|FINSI;
    ddese_2 = ddese_2 + dias_v;    || dias desemp.
|FPRC;

|PROCESO accide;
    dacci_0 = #labtraba#92;
    dacci_k = dacci_k + diafest;     || dias festivos que esta accidentado
    dacci_1 = dacci_1 + dialabo;     || dias laborables que esta accidentado
    dacci_2 = dacci_2 + dias_v;      || dias cotizables que idem
|FPRC;

|PROCESO enferm;
|SI #labtraba#60 = "E";         || arrastra los meses anteriores si es misma clave
        denfe_0 = #labtraba#89;
|FINSI;
    denfe_k = denfe_k + diafest;     || dias festivos que esta enfermo
    denfe_1 = denfe_1 + dialabo;     || dias laborables que esta enfermo
    nume1 = topemes2 - topemes1 + 1;
|SI denfe_21 = 0;  denfe_21 = nume1;  nume1 = 0;  |FINSI;
|SI denfe_22 = 0;  denfe_22 = nume1;  nume1 = 0;  |FINSI;
|SI denfe_23 = 0;  denfe_23 = nume1;  nume1 = 0;  |FINSI;
|SI denfe_24 = 0;  denfe_24 = nume1;  nume1 = 0;  |FINSI;
    denfe_2 = denfe_2 + dias_v;      || dias cotizables que idem
|FPRC;

|PROCESO matern;
|SI #labtraba#60 = "M";         || arrastra los meses anteriores si es misma clave
        dmate_0 = #labtraba#89;
|FINSI;
    dmate_k = dmate_k + diafest;     || dias festivos que esta pariendo
    dmate_1 = dmate_1 + dialabo;     || dias laborables que esta pariendo
    dmate_2 = dmate_2 + dias_v;      || dias cotiz. que idem

    sw_mater = 0;
    m_dias = dmate_0 + dmate_2;

    alfa1 = topemes2;    alfa1 = "00" + alfa1;    alfa1 = alfa1 % -102;
    alfa2 = #semcalcb#2;        alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
    alfa3 = alfa1 + "." + alfa2 + "." + #sempasma#0;
    fech1 = alfa3;            nume1 = fech1;
    fech2 = "01.01.1995";     nume2 = fech2;
    nume3 = nume1 - nume2 + 1;

|SI m_dias [ nume3; sw_mater = 1;  |FINSI;
|SI #semcalcb#2 ] 6;  sw_mater = 1;  |FINSI;
|FPRC;
/*
|PROCESO vacaci;
    dvaca_k = dvaca_k + diafest;   || dias festivos de vacaci.
    dvaca_1 = dvaca_1 + dialabo;   || dias laborables de vacaci.
|SI dvaca_2 = 0;
        dvaca_2 = #nomvarca#24 / 100;     || parte decimal
|FINSI;
    dvaca_2 = dvaca_2 + dias_v;    || dias cotiz. de vacaci.
|FPRC;

|PROCESO absent;
    dabse_k = dabse_k + diafest;   || dias festivos que esta absento
    dabse_1 = dabse_1 + dialabo;   || dias laborables que esta absento
|SI dabse_2 = 0;
        dabse_2 = #nomvarca#23 / 100;     || parte decimal
|FINSI;
    dabse_2 = dabse_2 + dias_v;    || dias abs.
|SI #nomvarca#campos# = "F";
        dabse_3 = dabse_3 + dias_v;     || dias abs.(sin decim.para pagas)
|FINSI;
|FPRC;

|PROCESO huelga;
    dhuel_k = dhuel_k + diafest;   || dias festivos que esta en huelga
    dhuel_1 = dhuel_1 + dialabo;   || dias laborables que esta en huelga
|SI dhuel_2 = 0;
        dhuel_2 = #nomvarca#22 / 100;     || parte decimal
|FINSI;
    dhuel_2 = dhuel_2 + dias_v;    || dias huelga
    dhuel_3 = dhuel_3 + dias_v;    || dias huelga(sin decim.)
|FPRC;
*/

|PROCESO vacaci;
    dvaca_k = dvaca_k + diafest;   || dias festivos de vacaci.
    dvaca_1 = dvaca_1 + dialabo;   || dias laborables de vacaci.
|SI dvaca_2 = 0;
        dvaca_2 = #nomvarca#24 / 100;     || parte decimal
|FINSI;
    dvaca_2 = dvaca_2 + dias_v;    || dias cotiz. de vacaci.
|FPRC;

|PROCESO absent;
     dabse_k = dabse_k + diafest;   || dias festivos que esta absento
     dabse_1 = dabse_1 + dialabo;   || dias laborables que esta absento

     dabse_2 = dabse_2 + dias_v;    || dias absentismo
     |SI #nomabsli#5 = "S";
          dabse_3 = dabse_3 + dias_v;     || dias abs.(sin decim.para pagas)
          || #7#26 = "S";
     |FINSI;
|FPRC;

|PROCESO huelga;
    dhuel_k = dhuel_k + diafest;   || dias festivos que esta en huelga
    dhuel_1 = dhuel_1 + dialabo;   || dias laborables que esta en huelga
    dhuel_2 = dhuel_2 + dias_v;    || dias huelga
    dhuel_3 = dhuel_3 + dias_v;    || dias huelga(sin decim.)
|FPRC;


||****************************************************************************
||                        CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO calpror;

    dvalo_pro = 0;   || acumulador total prorratas
    dvalo_pag = 0;   || acumulador total pagas
|PARA paga = 1; |SI paga [ 8; |HACIENDO paga = paga + 1;
    |HAZ empieza;
    |SI #nomconca#diasp# ! 0;|O #nomconca#porcp# ! 0;
            nQueBusca = 1;
        |HAZ busca;
        |SI swpro = 1;
            |HAZ cal_cofi;           || calcula el valor del concepto 2xx
                                     || calcula coeficiente 2xx
            |HAZ cal_unid;           || calcula las unidades del 2xx
            |HAZ gracal_200;         || graba el concepto 2xx
        |SINO;
                duni1_200 = 0;
                duni2_200 = 0;
                dvalo_200 = 1;
            |HAZ gracal_200;         || graba el concepto 2xx (vacio)
        |FINSI;
    |FINSI;
|SIGUE;                              || pasa las pagas de 1 a 8
|FPRC;

||****************************************************************************
||                   RUTINAS PARA EL CALCULO DE LA PRORRATA
||****************************************************************************

|PROCESO busca;  || BUSCA SI HAY PRORRATA EN LA PAGA ACTUAL Y VA CONTANDO DIAS
    mas = 0;
    rompe = 0;
|SI #nomconca#hasta# = #nomconca#desde#; |Y #nomconca#dedia# > #nomconca#hadia#;  rompe = 1;  |FINSI;
|SI #nomconca#hasta# < #nomconca#desde#; |O rompe = 1;
        nume1 = #sempasma#0 - 1;
        des1  = #nomconca#desde#;   des2 =       1;
        has1  =      12;   has2 = #nomconca#hasta#;
        |SI #nomconca#desde# [ #semcalcb#2; ||  si ya ha empezado el ejer. actual
                mas = 1;          ||  ejemplo: desde=4, hasta=3, actual=4
        |FINSI;                   ||  empieza a contar en este a¤o !!!
|SINO;
        nume1 = #sempasma#0;
        des1 = #nomconca#desde#;   des2 =  0;
        has1 = #nomconca#hasta#;   has2 = -1;
|FINSI;
    anyo1 = nume1 + mas;
    anyo2 = #sempasma#0 + mas;

    des = (anyo1 * 100) + #nomconca#desde#;  || mes desde
    has = (anyo2 * 100) + #nomconca#hasta#;  || mes hasta
    act = (#sempasma#0 * 100) + #semcalcb#2;     || mes actual

|SI act ] des; |Y act [ has;       swpro = 1;     |FINSI;

|PARA pp = des1; |SI pp [ has1; |HACIENDO pp = pp + 1;
        anynum = anyo1;  |HAZ busca2;
|SIGUE;
|PARA pp = des2; |SI pp [ has2; |HACIENDO pp = pp + 1;
        anynum = anyo2;  |HAZ busca2;
|SIGUE;

    mesnum = #nomconca#hasta#;  anynum = anyo2;         |HAZ ulti_dia;

|SI #labtraba#64="D";|O #labtraba#64="T";  pepulti=topemes;  |SINO;  pepulti=30;  |FINSI;

|SI #nomconca#dedia# !       0;  nume6=#nomconca#dedia#-      1; |SINO;  nume6 = 0;   |FINSI;
|SI #nomconca#hadia# ! topemes;  nume7=pepulti-#nomconca#hadia#; |SINO;  nume7 = 0;   |FINSI;

    perio = perio - (nume6 + nume7);
|FPRC;

|PROCESO busca2;
    topemes = 30;        || si es mensual cuenta por 30 los meses
|SI #labtraba#64 = "D";|O #labtraba#64 = "T";
        mesnum = pp;
    |HAZ ulti_dia;
|FINSI;
    perio = perio + topemes;
|FPRC;

|PROCESO cal_cofi;
|SI #labtraba#tipo_p# = "V";
        concep1 = 51 + paga;      || calcula el 1er. campo de conceptos
        concep2 = concep1 + 32;   || calcula el ultimo campo de concep.
    |PARA campo = concep1; |SI campo [ concep2; |HACIENDO campo=campo+8;
        |SI #nomconca#campo# ! 0;
                                desc = #nomconca#campo#;  hasc = #nomconca#campo#;
            |SI #nomconca#campo# = 100;  desc = 101;      hasc = 199;     |FINSI;
            |SI #nomconca#campo# = 400;  desc = 401;      hasc = 420;     |FINSI;
            |PARA actc = desc; |SI actc [ hasc; |HACIENDO actc=actc+1;
                    concepto = actc;    || bucle para los 100 y 400
                |HAZ leeconcep; || lee y acumula conceptos paga
            |SIGUE;
        |FINSI;              || si el concepto no es cero
    |SIGUE;                  || pasa los conceptos
|SINO;
    |SI #labtraba#tipo_p# = "B";      || importe bruto
            dvalo_209 = #labtraba#ajus_p# / #nomconca#diasp#;
    |FINSI;
    |SI #labtraba#tipo_p# = "L";      || importe liquido
            dvalo_209 = ((#labtraba#ajus_p# * 100) / (100 - #labtraba#30)) / #nomconca#diasp#;
    |FINSI;
        dvalo_209 = dvalo_209 ! (2+EURODB);  || valor pagas
        dvalo_200 = dvalo_209;      || valor prorrata
|FINSI;

|| ***********

|SI #semcalcb#2 = #nomconca#desde#;|Y #nomconca#dedia# !      1;  estevale = 1;  |FINSI;
|SI #semcalcb#2 = #nomconca#hasta#;|Y #nomconca#hadia# ! guarda;  estevale = 1;  |FINSI;

|SI estevale = 1;
    |HAZ recuento;
    |SI #nomconli#4=1;         || dias trabajados
        dcofi_999=(pdia_a-(pdia_b+pdia_c+pdia_d+pdia_e+pdia_f))/pdia_a;
    |FINSI;
    |SI #nomconli#4=2;         || dias cotizados
        dcofi_999=(pdia_a-        pdia_c                      )/pdia_a;
    |FINSI;
|SINO;
    |HAZ diaspaga;
    |SI #nomconli#4=1; dcofi_999=hcobr_0 / hdias_0;  |FINSI; || dias trabajados
    |SI #nomconli#4=2; dcofi_999=hcoti_0 / hdias_0;  |FINSI; || dias cotizados
|FINSI;
|SI #nomconli#4 = 0;     dcofi_999 = 1;  |FINSI;   || sin descuento
|SI dcofi_999 < 0; dcofi_999 = 0;  |FINSI;

     ||ATENCION!!!
     dcofi_999 = 1;      || se supone que a final de mes se ajustara
|FPRC;

|PROCESO leeconcep;  || lee y acumula concepto para paga
    doce = concepto;
|HAZ leedoce;
|SI FSalida = 0;
        duni1_999 = #semcalcl#09;
        duni2_999 = #semcalcl#12;
        dvalo_999 = #semcalcl#10;

    |SI #nomconli#3="F";|Y duni1_999=0;|Y concepto!102; || si es calculo 'F' carga
            duni1_999 = 1;                         ||/las unidades con 1 !!!
    |FINSI;
    |SI concepto ] 201;|Y concepto [ 208;
         |MENAV "0000Pagas dentro de pagas no implementado ...";
    |FINSI;
    |HAZ cal_valo;   || va acumulando el valor de los 5
|FINSI;              || si el concepto existe en calculos
|FPRC;

|PROCESO el_divide;
||SI #semcalcl#13="D";                divide=dia_2;     |FINSI; || dias mes
||SI #semcalcl#13="M";                divide=dia_4;     |FINSI; || dias cotiz.
|SI #semcalcl#13="D";                divide=duni1_999;  |FINSI; || dias mes
|SI #semcalcl#13="M";                divide=duni1_999;  |FINSI; || dias cotiz.
|SI #semcalcl#13="L";|O #semcalcl#13="K";  divide=duni1_999; |FINSI; || dias lab./fes.
|SI #semcalcl#13="V";|O #semcalcl#13="F";|O #semcalcl#13="A";  divide=DifDias;  |FINSI; || fijos
|SI es_irregul = 1;|Y tpz ! 0;
    |DDEFECTO #nomvart3;
    |ABRE #nomvart3;                || si se carga con los dias de alta
        #nomvart3#0 = #labtraba#87;        ||/se divide por los mismos
        #nomvart3#1 = #semcalcl#6;
    |LEE 000#nomvart3.=;
    |SI #nomvart3#3 = "S";     divide = tpz;  |FINSI;
    |CIERRA #nomvart3;
|FINSI;
|FPRC;

|PROCESO cal_valo;   || CALCULA EL VALOR ACUMULADO DE LOS 5 CONCEPTOS POR PAGA
    product = duni1_999 * dvalo_999;
    product = product ! EURODB;
|SI #nomconca#tipos# = "N";  || si es tipo 'N' o 'P'
    |HAZ el_divide;
|SINO;
        divide = 100;
|FINSI;

|SI concepto ] 401; |Y concepto [ 420;       || valor prorratas
    |SI #nomconca#140 = "S";
            dvalo_200 = dvalo_200 + (product / divide);
    |FINSI;
|SINO;
        dvalo_200 = dvalo_200 + (product / divide);    || valor prorratas
|FINSI;

    dvalo_209 = dvalo_209 + (product / divide);        || valor pagas
|FPRC;

|PROCESO cal_unid;   || CALCULA LAS UNIDADES DEL CONCEPTO 2xx
    duni1_200 = (pdia_a * #nomconca#diasp# * dcofi_999) / perio;
    duni3_200 = (pdia_a * #nomconca#diasp# *         1) / perio;     || entero
|SI #nomconca#tipos# = "P";   || pagas porcentuales
        duni1_200 = #nomconca#porcp# * dcofi_999;
        duni3_200 = #nomconca#porcp# *         1;                    || entero
|FINSI;
    duni3_200 = duni3_200 ! 6;
    duni3_200 = duni3_200 / dia_4;
|SI #nomvarca#25 = "S";
        duni2_200 =          -(duni3_200 * dhuel_3);   || menos huelga
|FINSI;
|SI #nomvarca#26 = "S";
        duni2_200 = duni2_200-(duni3_200 * dabse_3);   || menos absent.
|FINSI;
    duni1_200 = duni1_200 ! 6;
    duni2_200 = duni2_200 ! 6;
    dvalo_200 = dvalo_200 ! (2+EURODB);
    dvalo_209 = dvalo_209 ! (2+EURODB);
    product = duni2_200 * dvalo_209;  product = product ! EURODB;
    acum1_200 = acum1_200 + product;
|FPRC;

|PROCESO gracal_200;    || GRABA EL CONCEPTO 2xx;

    swgracon = 1;       || para que grabe todos los campos
    swcongra = 0;       || para que no acumule si existe
    graba04 = concep0;
    graba05 = #nomconli#3;
    graba06 = #nomconli#4;
    graba07 = #nomconli#5;
    graba08 = #nomconli#6;
    graba09 = duni1_200;
    graba10 = dvalo_200;
    graba11 = duni2_200;
|SI duni1_200 ! 0; |O duni2_200 ! 0; |O dvalo_200 ! 0;
    |SI duni2_200 ! 0;
            graba05 = "P";
            graba06 = 0;      || dto. por huelga/absentismo
    |FINSI;
    |HAZ grabacon;
        product = dvalo_200 * duni1_200;
    |SI #nomconca#mesco# = 99;                 || cuando no son pagas 99 no
            product = product ! EURODB;    || redondea para lograr mayor exactitud
    |FINSI;
        dvalo_pro = dvalo_pro + product;     || total prorratas

        product = dvalo_209 * duni1_200;
    |SI #nomconca#mesco# = 99;                 || cuando no son pagas 99 no
            product = product ! EURODB;    || redondea para lograr mayor exactitud
    |FINSI;
        dvalo_pag = dvalo_pag + product;     || total pagas
|FINSI;
|FPRC;

|PROCESO grabacon;        || GRABA O REGRABA LINEAS DE CALCULO SEGUN VARIABLES
    doce = graba04;
    |DDEFECTO #semcalcl;
    #semcalcl#0 = #sempasma#0;
    #semcalcl#1 = #sempasma#1;
    #semcalcl#2 = MesEsp;
    #semcalcl#3 = #labtraba#0;
    #semcalcl#4 = #labtraba#1;
    #semcalcl#5 = 0;
    #semcalcl#6 = doce;
    |LEE 101#semcalcl.=;
    FEstado = FSalida;

    #semcalcl#7 = graba08;    || situacion
    #semcalcl#8 = "D";
    |SI FEstado = 0; |Y swcongra = 1;    || switch para regrabar acumulando
         tempo1 = #semcalcl#10;  || valor anterior
         tempo2 = #semcalcl#12;  || unidades calculo anterior
         tempo3 = graba10; || valor actual
         tempo4 = graba11; || unidades calculo actual
         tempo5 = (tempo1 * tempo2) + (tempo3 * tempo4); || importe total
         graba10 = tempo5; || valor concepto nuevo
         graba11 = 1;      || unidades calculo concepto nuevo
    |FINSI;
    #semcalcl#09 = graba09;     || unidades
    #semcalcl#10 = graba10;     || valor
    #semcalcl#12 = graba11;     || unidades calculo
    #semcalcl#11 = #semcalcl#12 * #semcalcl#10;
    |SI FEstado ! 0;
         |GRABA 020#semcalcl.n;
    |SINO;
         |GRABA 020#semcalcl.a;
    |FINSI;
    |LIBERA #semcalcl;
    SwGraba = 1;
|FPRC;

||****************************************************************************
||              RUTINAS COMUNES A PRORRATAS Y PAGAS
||****************************************************************************

|PROCESO recuento;
    de1 = 0;  ha1 = -1;  de2 = 0;  ha2 = -1;
|SI #semcalcb#2 = #nomconca#desde#;     de1 = #nomconca#dedia#;  ha1 =  guarda;  |FINSI;
|SI #semcalcb#2 = #nomconca#hasta#;     de1 =       1;  ha1 = #nomconca#hadia#;  |FINSI;
|SI #nomconca#desde# = #nomconca#hasta#;|Y #nomconca#dedia# [ #nomconca#hadia#;
        de1 = #nomconca#dedia#;  ha1 = #nomconca#hadia#;
|FINSI;
|SI #nomconca#desde# = #nomconca#hasta#;|Y #nomconca#dedia# > #nomconca#hadia#;
        de1 = #nomconca#dedia#;  ha1 =  guarda;
        de2 =       1;           ha2 = #nomconca#hadia#;
|FINSI;
|PARA mid = de1; |SI mid [ ha1; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_a = pdia_a + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_b = pdia_b + 1;  |FINSI;  || enf.
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_c = pdia_c + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_d = pdia_d + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_e = pdia_e + 1;  |FINSI;  || abs.
    |SI alfa1 = "M";                 pdia_f = pdia_f + 1;  |FINSI;  || mat.
|SIGUE;
|PARA mid = de2; |SI mid [ ha2; |HACIENDO mid = mid + 1;
        nume1 = (100 * mid) + 1;
        alfa1 = histori % nume1;
    |SI                mid [ dia_3;  pdia_0 = pdia_0 + 1;  |FINSI;  || alta
    |SI alfa1 = "I";                 pdia_1 = pdia_1 + 1;  |FINSI;  || enf.
    |SI alfa1 = "B";|Y mid [ dia_3;  pdia_2 = pdia_2 + 1;  |FINSI;  || baja
    |SI alfa1 = "J";                 pdia_3 = pdia_3 + 1;  |FINSI;  || accid.
    |SI alfa1 = "K";                 pdia_4 = pdia_4 + 1;  |FINSI;  || abs.
    |SI alfa1 = "M";                 pdia_6 = pdia_6 + 1;  |FINSI;  || mat.
|SIGUE;

    pdia_a = pdia_a + pdia_0;   || letras --> prorrata (contienen los de paga)
    pdia_b = pdia_b + pdia_1;   || numeros -> paga
    pdia_c = pdia_c + pdia_2;
    pdia_d = pdia_d + pdia_3;
    pdia_e = pdia_e + pdia_4;
    pdia_f = pdia_f + pdia_6;

|SI ha2 = -1;            || si la paga va en meses completos |O
    |O swpaga = 1;       || si es finiquito |O
    |O #nomconca#mesco# = 99;     || si es paga de confeccion 99:
        pdia_0 = pdia_a;
        pdia_1 = pdia_b;
        pdia_2 = pdia_c; || se paga lo mismo que se prorratea!
        pdia_3 = pdia_d;
        pdia_4 = pdia_e;
        pdia_6 = pdia_f;
|FINSI;
|FPRC;

|PROCESO empieza;         || SACA LAS VARIABLES DEL CONVENIO SEGUN PAGA
    duni1_999 = 0;
    duni2_999 = 0;
    dvalo_999 = 0;
    dvalo_200 = 0;
    dvalo_209 = 0;
    duni1_200 = 0;
    duni2_200 = 0;
    duni3_200 = 0;
    dias_dto = 0;
    swpro = 0;
    perio = 0;
    pdia_0 = 0; pdia_1 = 0; pdia_2 = 0; pdia_3 = 0; pdia_4 = 0; pdia_6 = 0;
    pdia_a = 0; pdia_b = 0; pdia_c = 0; pdia_d = 0; pdia_e = 0; pdia_f = 0;
    dcofi_999 = 1;
    estevale = 0;
    dedia = paga + 107;    || desde dia prorrata
    hadia = paga + 115;    || hasta dia prorrata
    desde = paga + 3;      || desde mes prorrata
    hasta = paga + 11;     || hasta mes prorrata
    dedia1 = paga + 123;   || desde dia ilt
    hadia1 = paga + 131;   || hasta dia ilt
    desde1 = paga + 91;    || desde mes ilt
    hasta1 = paga + 99;    || hasta mes ilt
    tipos = paga + 27;     || tipo de calculo
    diasp = paga + 35;     || dias
    porcp = paga + 43;     || porcentaje
    concep0 = paga + 200;  || concepto de paga
    mesco = paga + 19;     || mes confeccion
    tipo_p = paga + 156;   || tipo ajuste paga (trabajador)
    ajus_p = paga + 164;   || importe ajuste paga (trabajador)
|DDEFECTO #nomconli;
    #nomconli#0 = #nomconca#0;
    #nomconli#2 = concep0;
|LEE 000#nomconli.=;
|FPRC;

|PROCESO diaspaga;
|SI es_irregul = 1;|Y tpz ! 0;
        pdia_0 = tpz;
|SINO;
        pdia_0 = hdias_0;
|FINSI;
                                               pdia_a = pdia_0;
    pdia_1 = denfe_2;                          pdia_b = pdia_1;
    pdia_2 = dalta_2+dbaja_2+dhuel_2+ddese_2;  pdia_c = pdia_2;
    pdia_3 = dacci_2;                          pdia_d = pdia_3;
    pdia_4 = dabse_2;                          pdia_e = pdia_4;
    pdia_6 = dmate_2;                          pdia_f = pdia_6;
|FPRC;

||****************************************************************************
||                      SUBRUTINAS DEL CALCULO DE DIAS
||****************************************************************************

|PROCESO desglosa;     || DESGLOSA EN DIA, MES Y ANYO UNA FECHA DD.MM.AAAA
    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
    bisiesto = 0;
    numer = anynum $ 4;
|SI numer = 0;
        bisiesto = 1;
|FINSI;
    topemes = 31;
|SI mesnum= 2;
        topemes = 28 + bisiesto;
|FINSI;
|SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
        topemes = 30;
|FINSI;
|FPRC;

|PROCESO leedoce;
     #nomconli#0 = #nomconca#0;
     #nomconli#1 = doce;
     |LEE 000#nomconli.=;

     #semcalcl#0 = #sempasma#0;
     #semcalcl#1 = #sempasma#1;
     #semcalcl#2 = MesEsp;
     #semcalcl#3 = #labtraba#0;
     #semcalcl#4 = #labtraba#1;
     #semcalcl#5 = 0;
     #semcalcl#6 = doce;
     |LEE 000#semcalcl.=;
|FPRC;

|PROCESO Recuenta;
   SwGraba = 1;
   |SI #semcalcl#6 ] 100; |Y #semcalcl#6 [ 199; RemunTot = RemunTot + #semcalcl#11; |FINSI;
   |SI #semcalcl#6 ] 200; |Y #semcalcl#6 [ 299; Prorrata = Prorrata + (#semcalcl#9 * #semcalcl#10); |FINSI;
   |SI #semcalcl#6 ] 906; |Y #semcalcl#6 [ 906; nAnticipo = nAnticipo + #semcalcl#11; |FINSI;
   |SI #semcalcl#6 ] 971; |Y #semcalcl#6 [ 973; RemunTot = RemunTot + #semcalcl#11; |FINSI;
   |SI #semcalcl#6 ] 981; |Y #semcalcl#6 [ 983; RemunTot = RemunTot + #semcalcl#11; |FINSI;
|FPRC;

|DEFBUCLE Recuenta;
   #semcalcl#1;
   ;
   #semcalcb#0,#semcalcb#1,#semcalcb#2,#semcalcb#3,#semcalcb#4,#semcalcb#5,001;
   #semcalcb#0,#semcalcb#1,#semcalcb#2,#semcalcb#3,#semcalcb#4,#semcalcb#5,999;
   ;
   NULL,Recuenta;
|FIN;

|PROCESO RecuentaLineas;
   RemunTot = 0;
   Prorrata = 0;
   nAnticipo = 0;
   SwGraba = 0;

   #semcalcb#2 = MesEsp;
   |LEE 101#semcalcb.=;
   |SI FSalida = 0;
        |SI #semequiv#4 = "M";|Y #semcalcb#5 = 0;
             #labtraba#30 = 0;
             por1_cont = 0;
             por1_dfpg = 0;
        |FINSI;

        |BUCLE Recuenta;
        #semcalcb#6  = RemunTot;
        #semcalcb#16 = RemunTot;
        #semcalcb#17 = Prorrata;
        #semcalcb#18 = RemunTot + Prorrata;
        #semcalcb#19 = por1_cont + por1_dfpg;
        #semcalcb#7  = #semcalcb#18 % #semcalcb#19;
        #semcalcb#20 = nAnticipo;
        |HAZ Calculos;
        |SI SwGraba = 1; |GRABA 020#semcalcb.a; |FINSI;
   |FINSI;
   |LIBERA #semcalcb;
|FPRC;

||****************************************************************************
||                      SUBRUTINAS DE ANTIGUEDAD
||****************************************************************************

|PROCESO tipos;          || construye fechas vencimiento para antiguedad
    mesact = Mes1;       || mes de la fecha desde
    anyact = #0#0;
    nume1 = mesact;
    nume2 = anyact;
|HAZ zrellena;
    tipo1 = alfa1;                 || mes actual

    nume1 = nume1 - 1;
|SI nume1 = 0;
        nume1 = 12;
        nume2 = nume2 - 1;
|FINSI;
|HAZ zrellena;
    tipo2 = alfa1;                 || mes siguiente

|SI mesact [  3;|Y mesact ] 1;  nume1 =  3;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =  6;  |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =  9;  |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 = 12;  |FINSI;
|HAZ zrellena;
    tipo3 = alfa1;                 || trimestre actual

|SI mesact [  3;|Y mesact ] 1;  nume1 =  12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [  6;|Y mesact ] 3;  nume1 =   3;                      |FINSI;
|SI mesact [  9;|Y mesact ] 6;  nume1 =   6;                      |FINSI;
|SI mesact [ 12;|Y mesact ] 9;  nume1 =   9;                      |FINSI;
|HAZ zrellena;
    tipo4 = alfa1;                 || trimestre siguiente

|SI mesact [  6;|Y mesact ] 1;  nume1 =  6;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 = 12;  |FINSI;
|HAZ zrellena;
    tipo5 = alfa1;                  || semestre actual

|SI mesact [  6;|Y mesact ] 1;  nume1 = 12;  nume2 = nume2 - 1;  |FINSI;
|SI mesact [ 12;|Y mesact ] 6;  nume1 =  6;                      |FINSI;
|HAZ zrellena;
    tipo6 = alfa1;                  || semestre siguiente

    nume1 = 12;
|HAZ zrellena;
    tipo7 = alfa1;                  || a¤o actual

    nume1 = 12;
    nume2 = nume2 - 1;
|HAZ zrellena;
    tipo8 = alfa1;                  || a¤o siguiente
|FPRC;

|PROCESO zrellena;      || rellena de ceros campos numericos ('tipos')
    alfa1 = nume1;  alfa1 = "00" + nume1;  alfa1 = alfa1 % -102;
    alfa2 = nume2;
    nume1 = mesact;
    nume2 = anyact;

    alfa1 = alfa1 + "." + alfa2;
|FPRC;

|PROCESO cal_102;     || CALCULA LA ANTIGUEDAD
     concepto = 102;
     |HAZ convenio;
     |SI #nomconca#2 < 2;
          duni2_102 = duni1_102 * dcofi_999;
     |SINO;
          |HAZ anyanti;
          |HAZ poranti;
          duni1_102 = danti_1;
          duni2_102 = danti_1 * dcofi_999;
          |SI #nomconax#95 = 9;         || si es sobre antig./categ.
               dvalo_102 = danti_0;     || se inhibe la clave 3 !!!
          |SINO;
               dvalo_102 = (duni1_101 * danti_0) /100;
          |FINSI;
     |FINSI;
     duni2_102 = duni2_102 ! 6;
     dvalo_102 = dvalo_102 ! (2+EURODB);

     |HAZ Graba_102;
|FPRC;

|PROCESO poranti;  || halla el porcentaje o, en su caso, la cantidad, a aplicar
    yaesta = 0;
|SI #nomconax#95 = 9;                || segun tipo de calculo de aux.convenios
    |PARA campo=4;|SI campo[33;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
        |SI campo = 14;  campo = 24;    |FINSI;
            sigui = campo + 1;
        |SI sigui = 14;  sigui = 24;    |FINSI;
        |SI anyos ] #nomantca#campo#; |Y anyos < #nomantca#sigui#; |O campo = 33;
                yaesta = 1;
                elotro = campo + 10;
                danti_0 = #nomantca#elotro#;   || carga cantidad fija de antig./categ.
                danti_1 = duni1_102;   || carga las unidades segun calculo
        |FINSI;
    |SIGUE;
|SINO;
    |PARA campo=65;|SI campo[79;|Y yaesta=0;|Y anyos!0;|HACIENDO campo=campo+1;
            sigui = campo + 1;
        |SI anyos ] #nomconax#campo#; |Y anyos < #nomconax#sigui#; |O campo = 79;
                yaesta = 1;
                elotro = campo + 15;
                danti_0 = dvalo_101;   || carga con valor del 101
                danti_1 = #nomconax#elotro#;   || carga con el porcentaje corresp.
        |FINSI;
    |SIGUE;
|FINSI;
|FPRC;

|PROCESO anyanti;   || CALCULA LOS A¥OS DE ANTIGUEDAD
|SI #labtraba#239 = "F";
        tipox = #nomconax#95;            || tipo de calculo segun aux. convenios
    |SI #nomconax#95 = 9;
            tipox = #nomantca#3;         || tipo de calculo segun antig/categ.
    |FINSI;

        alfa2 = #labtraba#34  % 402;  fanti_m = alfa2;   || meses antiguedad
        alfa3 = #labtraba#34  % -104; fanti_a = alfa3;   || anyos antiguedad

    |SI tipox =  0;  fvenci = #labtraba#34;  |FINSI;     || saca vencimiento
    |SI tipox =  1;  fvenci = tipo1;  |FINSI;     ||/segun tipo
    |SI tipox =  2;  fvenci = tipo2;  |FINSI;
    |SI tipox =  3;  fvenci = tipo3;  |FINSI;
    |SI tipox =  4;  fvenci = tipo4;  |FINSI;
    |SI tipox =  5;  fvenci = tipo5;  |FINSI;
    |SI tipox =  6;  fvenci = tipo6;  |FINSI;
    |SI tipox =  7;  fvenci = tipo7;  |FINSI;
    |SI tipox =  8;  fvenci = tipo8;  |FINSI;
    |SI tipox = 10; |Y fanti_m < 7;
            fvenci = tipo7;
    |FINSI;
    |SI tipox = 10; |Y fanti_m > 6;
            fvenci = tipo8;
    |FINSI;

        alfa2 = fvenci % 102;  ganti_m = alfa2;   || meses vencimiento antiguedad
        alfa3 = fvenci % -104; ganti_a = alfa3;   || anyos vencimiento antiguedad

        difer_m = ganti_m - fanti_m;    || diferencia meses
        difer_a = ganti_a - fanti_a;    || diferencia anyos

    |SI difer_m < 0;  difer_a = difer_a - 1;  |FINSI;
    |SI difer_a < 0;  difer_a = 0;            |FINSI;

        anyos = difer_a;
|SINO;
        anyos = (#labtraba#240 - (#labtraba#240 $ 365)) / 365;
|FINSI;
|FPRC;

|PROCESO cal_103;       || CALCULA EL PLUS
     concepto = 103;
     |HAZ convenio;

     duni2_103 = duni1_103 * dcofi_999;
     |SI #nomconca#3 = 2;|O #nomconca#3 = 3;
          dvalo_103 = (duni1_101*dvalo_101) /100;    || 1% sal.base
     |FINSI;
     |SI #nomconca#3 = 3;
          dvalo_103 = dvalo_103 + ((duni1_102 *dvalo_102) /100);
     |FINSI;
     duni2_103 = duni2_103 ! 6;   || redondea unid. calculo
     dvalo_103 = dvalo_103 ! (2+EURODB);   || redondea valor

     |HAZ Graba_103;
|FPRC;

|PROCESO convenio;     || comprueba si existe linea de convenio
|DDEFECTO #nomconca;
#nomconca#0 = #labtraba#87;
|LEE 000#nomconca.=;

|DDEFECTO #nomconli;
    convenio = 1;
    #nomconli#00 = #labtraba#87;
    #nomconli#02 = concepto;
|LEE 000#nomconli.=;
|SI FSalida = 0;|O concepto ] 901; || los conceptos 9xx pasan aunque no esten
        convenio = 0;
    |SI concepto ] 901;
        |SI concepto = 901;  #nomconli#6 = "N§ HORAS";  |FINSI;
        |SI concepto = 902;  #nomconli#6 = "INDEMNI.";  |FINSI;
        |SI concepto = 903;
                #nomconli#6 = "CITRICOS";
                fijo_1 = unidades;       || dias cotizados citricos
        |FINSI;
        |SI concepto = 904;  #nomconli#6 = "VACACION";  |FINSI;
        |SI concepto = 905;  #nomconli#6 = "HORAS TP";  |FINSI;
        |SI concepto = 906;  #nomconli#6 = "ANTIC. 1";  |FINSI;
        |SI concepto = 907;  #nomconli#6 = "ANTIC. 2";  |FINSI;
        |SI concepto = 908;  #nomconli#6 = "ESPECIE ";  |FINSI;
        |SI concepto = 909;  #nomconli#6 = "H.C.SEM.";  |FINSI;
        |SI concepto = 910;  #nomconli#6 = "H.T.SEM.";  |FINSI;
        |SI concepto = 911;  #nomconli#6 = "H.C.MES ";  |FINSI;
        |SI concepto = 912;  #nomconli#6 = "H.T.MES ";  |FINSI;
        |SI concepto = 913;  #nomconli#6 = "ALTA=CTO";  |FINSI;
        |SI concepto = 914;  #nomconli#6 = "D.ALTA  ";  |FINSI;
        |SI concepto = 915;  #nomconli#6 = "DIAS VAC";  |FINSI;
        |SI concepto = 916;  #nomconli#6 = "DED.S.S.";  |FINSI;
        |SI concepto = 917;  #nomconli#6 = "DIAS TC2";  |FINSI;
        |SI concepto = 918;  #nomconli#6 = "HORASTC2";  |FINSI;
        |SI concepto = 919;  #nomconli#6 = "BASEIRPF";  |FINSI;
        |SI concepto = 920;  #nomconli#6 = "P.INDEM.";  |FINSI;
        |SI concepto > 920;
                convenio = 1;         || los no contemplados no los graba
        |SINO;
            |SI FSalida ! 0;
                    #nomconli#3 = "V";
                    #nomconli#4 = 0;
                    #nomconli#5 = 0;
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;
