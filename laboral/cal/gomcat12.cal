|FICHEROS;
     nomcalat #0;
     gomcot12;
     labtraba;
     nomconli;
     nombonif;
     nomepigr;
     nombonif;
     nomconst;
     nomcalac;
     nomcalcc;
     nomhicca;
     nomhicli;
     nomcontr;
|FIN;

|VARIABLES;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     &fCFechaCot = @;
     &aCErrorCot = "";

     aAlfa = "";
     &swMensual = 0;
     &base_5 = 0;
     &acum_10 = 0;
     &dvalo_pro = 0;
     &base_A = 0; &zbase_A = 0;
     &base_B = 0; &zbase_B = 0;
     &base_C = 0; &zbase_C = 0;
     &base_D = 0;
     &base_E = 0;
     &base_F = 0; &zbase_F = 0;
     &base_M = 0;
     &bbase_A = 0;
     &bbase_B = 0;
     &bbase_C = 0;
     &basemat_B = 0;
     &base_6 = 0;
     &base_7 = 0;
     &base_8 = 0;
     &base_77 = 0;
     &base_11 = 0;
     &acum_30 = 0;
     &acum_31 = 0;
     &dacum_30 = 0;
     &dacum_31 = 0;
     &por1_cont = 0;
     &por1_dfpg = 0;
     &por1_hor1 = 0;
     &por1_hor2 = 0;
     &por2_hor1 = 0;
     &por2_hor2 = 0;
     &dcont_2 = 0;
     &prom_enf = 0;
     &prom_acc = 0;
     &coba_1 = 0;
     &cobb_2 = 0;
     &coba_3 = 0;
     &coba_4 = 0;
     &cobb_4 = 0;
     nTopeMaxMen = 0;
     nTopeMaxJor = 0;
     nume1 = 0;
     nume2 = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     &denfe_2 = 0;
     &dacci_2 = 0;
     &dmate_2 = 0;
     &dabse_2 = 0;
     &swAjuste3 = 0;
     &swAjuste3_C = 0;
     &dcoti_0 = 0;
     &fijo_1 = 0;
     &fijo_1_red = 0;
     &jornadasIT = 0;
     &nReduccion = 0;
     &por2_cont = 0;
     nLimiteAltaMens = 0;
     nLimiteAltaJor = 0;
     nLimiteJor = 0;
     swTabla = 0;
     swFormula = 0;
     &swJornadas = 0;
     &nBasePorJornada = 0;
     &nBasePorJornada_red = 0;
     nGrupo = 0;
     nPar1 = 0;
     nPar2 = 0;
     nDiasCotIT = 0;
     &basemat_C = 0;

     &dboni_1 = 0;
     &horasex = 0;
     &por2_dfpg = 0;
     &sw_tope = 0;
     &nBaseATEP = 0;
     &nATEP_Alta = 0;
     &base_9 = 0;
     &epig_ilt = 0;
     &epig_ims = 0;
     &pilt_enf = 0;
     &pilt_ATEP = 0;
     &nATEP_IT = 0;
     &nPorBon1 = 0;
     &nPorBon2 = 0;
     &bon_0 = 0;
     &bon_3 = 0;
     &zbase_9 = 0;
     &jornadasEA = 0;
     &bbon_0 = 0;
     &bbon_3 = 0;
     &bbon_5 = 0;
     &dboni_2 = 0;
     &zbon_0 = 0;
     &zbon_3 = 0;
     &zbon_5 = 0;
     &bbase_F = 0;
     &cbon_3 = 0;
     &nBonifFCI = 0;
     &bon_59 = 0;
     &bon_60 = 0;
     &denfe_A = 0;
     &denfe_B = 0;
     &denfe_C = 0;
     &denfe_D = 0;
     &nDiasPagoSS = 0;
     &nBasePagoSS_CC = 0;
     &nBasePagoSS_CP = 0;
     &nJornPagoSS = 0;
     &nDiasPagoSS_SinMat = 0;
     &nJornPagoSS_SinMat = 0;
     &nBasePagoSS_CC_SinMat = 0;
     &nBasePagoSS_CP_SinMat = 0;
     &guarda = 0;
     &prom_ac2 = 0;
     &nBase = 0;
     &swBaseFija = 0;
     &lin_1 = 0;
     &lin_2 = 0;
     &dto_con = 0;
     &dto_dfp = 0;
     &dto_ho1 = 0;
     &dto_ho2 = 0;
     &dilt = 0;
     &bon_1 = 0;
     &bon_2 = 0;
     &bon_5 = 0;
     nTopeMin = 0;
     nCampo = 0;
     FEstado = 0;
     aTopeadaCC = "";
     aTopeadaCP = "";
     nTipoInicialCC = 0;
     aTipoReduccion = 0;

     &nBaseAlta = 0;
     &nBaseIT = 0;

     nRedCC_Alta = 0;
     nRedCC_IT = 0;
     nRedDes_Alta = 0;
     nRedDes_IT = 0;

     &nImporteRedCC_Alta = 0;
     &nImporteRedCC_IT = 0;
     &nImporteRedDes_Alta = 0;
     &nImporteRedDes_IT = 0;

     por2_cont_alta = 0;
     por2_des_alta = 0;

     nCuotaCC_Alta = 0;
     nCuotaCC_IT = 0;
     nCuotaDes_Alta = 0;
     nCuotaDes_IT = 0;
     nCuotaFPFog = 0;

     nTipoInicialCC_Alta = 0;
     nTipoInicialCC_IT = 0;
     nTipoInicialDes = 0;
     nBaseAltaDia = 0;
     nDiasAlta = 0;

     dias_tope = 0;
     nMax_cp = 0;
     nMin_cp = 0;
     &grupo = 0;
     &propo = 0;
     nRed_CC = 0;

     &denfe_cot = 0;
     &dacci_cot = 0;
     &dmate_cot = 0;
     &nRedCCEnf = 0;
     &nRedDesEnf = 0;
     &nRedCCMat = 0;
     &nRedDesMat = 0;
     &nRedCCAcc = 0;
     &nRedDesAcc = 0;
     &nRedCCEnfEmp = 0;
     &nRedDesEnfEmp = 0;
     &nBaseITDiaJorCC = 0;
     &nBaseITDiaJorDes = 0;
     swPrevio = 0;
     &prom_enf_previo = 0;
     &prom_acc_previo = 0;
     &dcobr_0 = 0;
     nDiasEnfPagoDir = 0;
     nNume = 0;
     nJornadasEnf = 0;
     nJornadasAcc = 0;
     nJornadasMat = 0;
     swHay93X = 0;
     nConcepto = 0;
     nDesdeAny = 0;
     nHastaAny = 0;
     aNif = "";
     &nDesem = 0;
     &nJornadasERE = 0;
     &ddese_2 = 0;
     &nBonifERE = 0;
     nDtoCCTra = 0;
     nDtoCPTra = 0;
     aModulo = "";
     jornadasIT_red = 0;
     nBaseIT_red = 0;

     nBaseATEP_red = 0;
     nATEP_IT_red = 0;
     nDifJor = 0;

     nLimite2013 = 0;
     &nElAny = 0;
     nDifCC2013 = 0;
     nDifCP2013 = 0;
     nCuotaCCAlta = 0;
     nLimMenG1 = 0;
     nLimMenResto = 0;

     &nJorITCotEmp = 0;
     &nJorITCotEmpTra = 0;

     &mes_x = 0;
     swHistorico = 0;
     &runnom = "nomcalat";
     nBaseJornadaHis = 0;
     nBaseHisCP = 0;
     &n400Cot = 0;
     &nDiasDescEnf = 0;
     &nDiasDescAcc = 0;
     &nDiasDescMat = 0;
     &nDescEnf_B = 0;
     &nDescEnf_C = 0;

     &prom_enf_real = 0;
     &prom_acc_real = 0;
|FIN;

|PROCESO DesgloseDias;
     denfe_cot = 0;
     dacci_cot = 0;
     dmate_cot = 0;
     nRedCCEnf = 0;
     nRedDesEnf = 0;
     nRedCCMat = 0;
     nRedDesMat = 0;
     nRedCCAcc = 0;
     nRedDesAcc = 0;
     nRedCCEnfEmp = 0;
     nRedDesEnfEmp = 0;
     nDiasEnfPagoDir = 0;

     |SI denfe_2 ! 0;
          denfe_cot = denfe_2 - swAjuste3;
     |FINSI;

     |SI dmate_2 ! 0;
          |SI denfe_cot ! 0;
               dmate_cot = dmate_2;
          |SINO;
               dmate_cot = dmate_2 - swAjuste3;
          |FINSI;
     |FINSI;

     |SI dacci_2 ! 0;
          |SI denfe_cot ! 0; |O dmate_cot ! 0;
               dacci_cot = dacci_2;
          |SINO;
               dacci_cot = dacci_2 - swAjuste3;
          |FINSI;
     |FINSI;

     |SI swMensual = 1;
          nBaseITDiaJorCC = (nBaseIT - nDesem) / (#nomcalcc#52 - ddese_2);
          nBaseITDiaJorDes = (nATEP_IT - nDesem) / (#nomcalcc#52 - ddese_2);
     |SINO;
          nBaseITDiaJorCC = (nBaseIT - nDesem) / (#nomcalcc#52 - nJornadasERE);
          nBaseITDiaJorDes = (nATEP_IT - nDesem) / (#nomcalcc#52 - nJornadasERE);
     |FINSI;

     |SI denfe_B ! 0; |O denfe_C ! 0;
          nDiasEnfPagoDir = denfe_B + denfe_C - swAjuste3;
     |FINSI;
     |SI nDiasEnfPagoDir < 0;
          nDiasEnfPagoDir = 0;
     |FINSI;

     |SI swMensual = 1;
          nRedCCEnf = (((denfe_cot - nDiasEnfPagoDir) * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
          nRedDesEnf = (((denfe_cot - nDiasEnfPagoDir) * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

          nRedCCMat = ((dmate_cot * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
          nRedDesMat = ((dmate_cot * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

          nRedCCMat = nRedCCMat + ((nDesem % nRedCC_IT) ! 2);
          || nRedDesMat = nRedDesMat + ((nDesem % nRedDes_IT) ! 2);

          nRedCCAcc = ((dacci_cot * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
          nRedDesAcc = ((dacci_cot * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

          nRedCCEnfEmp = ((nDiasEnfPagoDir * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
          nRedDesEnfEmp = ((nDiasEnfPagoDir * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
     |FINSI;
     |SI swJornadas = 1;
          || en caso de jornadas no desgloso, es un follon demasiado
          || grande, si nos viene algun trabajador con jornadas con
          || mas de un tipo de IT lo trataremos entonces

          |SI swHay93X ! 0;
               nNume = nJornadasEnf - (nJornPagoSS - nJornadasAcc - nJornadasMat);
               nRedCCEnf = ((nNume * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
               nRedDesEnf = ((nNume * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

               nRedCCMat = ((nJornadasMat * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
               nRedDesMat = ((nJornadasMat * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

               nRedCCAcc = ((nJornadasAcc * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
               nRedDesAcc = ((nJornadasAcc * nBaseITDiaJorDes) % nRedDes_IT) ! 2;

               nNume = nJornPagoSS - nJornadasAcc - nJornadasMat;
               nRedCCEnfEmp = ((nNume * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
               nRedDesEnfEmp = ((nNume * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
          |SINO;
               || ATENCION: esto esta muy mal, pero de moemento lo dejamos asi
               || con esto, cotiza todo la empresa, para un caso que
               || tenemos y la que hay que liar para hacerlo bien, lo dejamos
               || asi de moemento, saldra toda la IT en la BA21-BA22 y las
               || reducciones tambien

               nJornPagoSS = 0;

               nDifJor = jornadasIT - jornadasIT_red;
               |SI denfe_cot ! 0;
                    nRedCCEnf = (((jornadasIT - nJornPagoSS - nDifJor) * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
                    nRedDesEnf = (((jornadasIT - nJornPagoSS - nDifJor) * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
                    |SI nDifJor > 0; nDifJor = 0; |FINSI;
               |FINSI;
               |SI denfe_cot = 0; |Y dmate_cot ! 0;
                    nRedCCMat = (((jornadasIT - nDifJor) * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
                    nRedDesMat = (((jornadasIT - nDifJor) * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
                    |SI nDifJor > 0; nDifJor = 0; |FINSI;
               |FINSI;
               |SI nDesem ! 0;
                    nRedCCMat = nRedCCMat + ((nDesem % nRedCC_IT) ! 2);
                    || nRedDesMat = nRedDesMat + ((nDesem % nRedDes_IT) ! 2);
               |FINSI;
               |SI denfe_cot = 0; |Y dmate_cot = 0; |Y dacci_cot ! 0;
                    nRedCCAcc = (((jornadasIT - nDifJor) * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
                    nRedDesAcc = (((jornadasIT - nDifJor) * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
                    |SI nDifJor > 0; nDifJor = 0; |FINSI;
               |FINSI;
               |SI nDiasEnfPagoDir > 0;
                    nRedCCEnfEmp = (((nJornPagoSS - nDifJor) * nBaseITDiaJorCC) % nRedCC_IT) ! 2;
                    nRedDesEnfEmp = (((nJornPagoSS - nDifJor) * nBaseITDiaJorDes) % nRedDes_IT) ! 2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaCotiz;
     |MODULO aModulo; |QBF aModulo;
     |SI aModulo = "gomcalc1";
          |ACABA;
     |FINSI;

     |ABRE #nomcalcc;
     #nomcalcc#0 = #nomcalac#0;
     #nomcalcc#1 = #nomcalac#1;
     #nomcalcc#2 = #0#9;
     #nomcalcc#3 = mes_x;
     #nomcalcc#4 = #nomcalac#3;
     |LEE 101#nomcalcc.=;
     |SI FSalida = 0;
          |BORRA 020#nomcalcc.a;
     |FINSI;
     |DDEFECTO #nomcalcc;

     #nomcalcc#0 = #nomcalac#0;
     #nomcalcc#1 = #nomcalac#1;
     #nomcalcc#2 = #0#9;
     #nomcalcc#3 = mes_x;
     #nomcalcc#4 = #nomcalac#3;
     #nomcalcc#5 = #nomcalac#37;             || remuneracion
     #nomcalcc#6 = #nomcalac#38;             || prorrata
     #nomcalcc#7 = #nomcalac#37 + #nomcalac#38;   || remun + prorr
     #nomcalcc#8 = aTopeadaCC;
     #nomcalcc#57 = aTopeadaCP;
     #nomcalcc#50 = #labtraba#42;
     |SI swMensual = 1;
          #nomcalcc#9 = #nomcalac#8;
          |SI dcoti_0 ] 30; |Y nDiasCotIT = 0;
               #nomcalcc#17 = nLimiteAltaMens;
               #nomcalcc#48 = base_6;
               #nomcalcc#49 = base_6;
          |SINO;
               #nomcalcc#17 = nLimiteAltaMens;
               #nomcalcc#48 = nBaseAltaDia;
               #nomcalcc#49 = nBaseAltaDia;
          |FINSI;
          #nomcalcc#12 = nBaseAltaDia;
          #nomcalcc#51 = nDiasAlta;
          #nomcalcc#52 = nDiasCotIT + ddese_2;
     |SINO;
          #nomcalcc#9 = fijo_1 + jornadasIT;
          #nomcalcc#12 = nBasePorJornada;
          #nomcalcc#17 = nLimiteAltaJor;
          || #nomcalcc#48 = nBasePorJornada;
          || #nomcalcc#49 = nBasePorJornada;
          #nomcalcc#48 = nBasePorJornada_red;
          #nomcalcc#49 = nBasePorJornada_red;
          #nomcalcc#51 = fijo_1_red;
          #nomcalcc#52 = jornadasIT;
     |FINSI;

     #nomcalcc#10 = #nomcalac#39;             || base cc
     #nomcalcc#11 = #nomcalac#40;            || base cp
     #nomcalcc#15 = nReduccion;
     |SI #labtraba#33 = 01;
          #nomcalcc#14 = "fija";
     |SINO;
          |SI swTabla = 1;
               #nomcalcc#14 = "tabla";
          |FINSI;
          |SI swFormula = 1;
               #nomcalcc#14 = "f¢rmula";
          |FINSI;
     |FINSI;

     #nomcalcc#18 = 2.52;
     #nomcalcc#19 = 6.15;

     #nomcalcc#16 = por2_cont;
     #nomcalcc#20 = base_6 % #nomcalcc#16;   || cuota comunes
     #nomcalcc#21 = #nomconst#12;            || % desempleo
     #nomcalcc#22 = base_7 % #nomcalcc#21;   || cuota desempleo

     #nomcalcc#23 = #nomconst#14;            || % fogasa
     #nomcalcc#24 = (nATEP_Alta + nATEP_IT) % #nomcalcc#23;   || cuota fogasa
     #nomcalcc#25 = #nomconst#16;            || % FP
     #nomcalcc#26 = (nATEP_Alta + nATEP_IT) % #nomcalcc#25;   || cuota FP

     #nomcalcc#27 = epig_ilt;
     #nomcalcc#28 = ((nATEP_Alta % epig_ilt) ! 2) + ((nATEP_IT % epig_ilt) ! 2);
     #nomcalcc#29 = epig_ims;
     #nomcalcc#30 = ((nATEP_Alta % epig_ims) ! 2) + ((nATEP_IT % epig_ims) ! 2);

     #nomcalcc#32 = nBaseAlta;
     #nomcalcc#13 = por2_cont;
     #nomcalcc#20 = nCuotaCC_Alta;
     #nomcalcc#15 = nRedCC_Alta;
     #nomcalcc#42 = nImporteRedCC_Alta;
     #nomcalcc#45 = nCuotaCC_Alta - nImporteRedCC_Alta;
     #nomcalcc#21 = por2_des_alta;
     #nomcalcc#22 = nCuotaDes_Alta
     #nomcalcc#33 = nBaseIT;
     #nomcalcc#34 = por2_cont;
     #nomcalcc#39 = nCuotaCC_IT;
     #nomcalcc#36 = nRedCC_IT;
     #nomcalcc#43 = nImporteRedCC_IT;
     #nomcalcc#46 = nCuotaCC_IT - nImporteRedCC_IT;
     #nomcalcc#40 = por2_des_alta;
     #nomcalcc#41 = nCuotaDes_IT;
     #nomcalcc#37 = nRedDes_IT;
     #nomcalcc#44 = nImporteRedDes_IT
     #nomcalcc#47 = nCuotaDes_IT - nImporteRedDes_IT

     |HAZ DesgloseDias;

     #nomcalcc#53 = nATEP_Alta;
     #nomcalcc#54 = nATEP_IT;

     || SS EMPRESA INICIAL:
     #nomcalcc#31 = #nomcalcc#45 + #nomcalcc#22;
     #nomcalcc#31 = #nomcalcc#31 + #nomcalcc#46 + #nomcalcc#47;
     #nomcalcc#31 = #nomcalcc#31 + #nomcalcc#24 + #nomcalcc#26;
     #nomcalcc#31 = #nomcalcc#31 + #nomcalcc#28 + #nomcalcc#30;

     || BONIFICACIONES
     #nomcalcc#55 = #nomcalac#63 + #nomcalac#81 + #nomcalac#64 + #nomcalac#101;
     #nomcalcc#55 = #nomcalcc#55 + #nomcalac#106 + #nomcalac#88 + #nomcalac#96;
     #nomcalcc#55 = #nomcalcc#55 + #nomcalac#133 + #nomcalac#102 + #nomcalac#125;

     || SS TOTAL EMP - BONIFICACIONES
     #nomcalcc#56 = #nomcalcc#31 - #nomcalcc#55;

     |GRABA 020#nomcalcc.n;

     |LIBERA #nomcalcc;
     |CIERRA #nomcalcc;
|FPRC;

|PROCESO LeeTopesReduc;       || proceso para leer los topes y reducciones de
                              || contingencias comunes

     alfa1 = "01";
     alfa2 = mes_x;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #0#9;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     |MODULO aModulo; |QBF aModulo;
     fCFechaCot = alfa4;         || primer dia de mes de calculo
     aCErrorCot = "";            || inicializo errores
     |HAZ LeeRedMaxAgr;
     |SI aCErrorCot ! ""; |Y aModulo ! "gomcalc1";
          |MENAV aCErrorCot;
     |FINSI;
|FPRC;

|PROCESO reducciones12;
     || reducciones al tipo de cotizacion que se aplica para hallar la
     || cuota empresarial segun normativa del 2012

     || por2_cont es el % que teniamos, aplicamos reduccion

     nReduccion = 0;
     swTabla = 0;
     swFormula = 0;
     nLimiteAltaMens = 0;
     nLimiteAltaJor = 0;
     nDiasCotIT = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
     nDiasAlta = dcoti_0 - nDiasCotIT;
     nBaseAltaDia = nBaseAlta / nDiasAlta;

     |SI #labtraba#33 = 01;
          || para el grupo 01, de moemento a pelo
          por2_cont = 23.60;
          nTipoInicialCC = por2_cont;
          nReduccion = #gomcot12#1;
     |FINSI;
     |SI #labtraba#33 ] 02;
          |SI nDesem > 0;
               nBaseAlta = nBaseAlta + nDesem;
               nBaseAltaDia = nBaseAlta / (nDiasAlta + ddese_2);
          |FINSI;

          |SI swMensual = 1;
               || limite para trabajadores mensuales para saber si aplico
               || la tabla o la formula basa en la tabla tambien
               |SI dcoti_0 ] 30; |Y nDiasCotIT = 0;
                    nLimiteAltaMens = #gomcot12#12;
                    |SI nBaseAlta [ nLimiteAltaMens;
                         swTabla = 1;
                    |SINO;
                         swFormula = 1;
                    |FINSI;
               |SINO;
                    nLimiteAltaMens = #gomcot12#12 / 30;
                    |SI nBaseAltaDia [ nLimiteAltaMens;
                         swTabla = 1;
                    |SINO;
                         swFormula = 1;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI swJornadas = 1;
               nLimiteAltaJor = #gomcot12#13;
               || SI nBasePorJornada [ nLimiteAltaJor;
               |SI nBasePorJornada_red [ nLimiteAltaJor;
                    swTabla = 1;
               |SINO;
                    swFormula = 1;
               |FINSI;
          |FINSI;

          nGrupo = #labtraba#33;
          |SI swTabla = 1;
               nReduccion = #gomcot12#nGrupo#;
          |FINSI;
          |SI swFormula = 1;
               |SI swMensual = 1;
                    |SI dcoti_0 ] 30; |Y nDiasCotIT = 0;
                         nPar1 = (nBaseAlta - nLimiteAltaMens) / base_6;
                    |SINO;
                         nPar1 = (nBaseAltaDia - nLimiteAltaMens) / nBaseAltaDia;
                    |FINSI;
                    nPar2 = 6.15 / #gomcot12#nGrupo#;
                    nReduccion = #gomcot12#nGrupo# * (1 + (nPar1 * 2.52 * nPar2));
                    nReduccion = nReduccion ! 2;
               |FINSI;
               |SI swJornadas = 1;
                    || nPar1 = (nBasePorJornada - nLimiteAltaJor) / nBasePorJornada;
                    nPar1 = (nBasePorJornada_red - nLimiteAltaJor) / nBasePorJornada_red;
                    nPar2 = 6.15 / #gomcot12#nGrupo#;
                    nReduccion = #gomcot12#nGrupo# * (1 + (nPar1 * 2.52 * nPar2));
                    nReduccion = nReduccion ! 2;
               |FINSI;
          |FINSI;
          |SI nDesem > 0;
               nBaseAlta = nBaseAlta - nDesem;
               || para que se guarde la correcta
          |FINSI;
     |FINSI;

     || paso a variables finales

     nRedCC_Alta = nReduccion;
     nGrupo = #labtraba#33;
     nCampo = nGrupo + 15;
     nRedCC_IT = #gomcot12#nCampo#;
     |SI nDesem > 0;
          nRedCC_IT = nReduccion;
     |FINSI;
     nRedDes_Alta = 0;
     |SI #nomconst#12 = 0;
          nRedDes_IT = 0;
     |SINO;
          nRedDes_IT = #gomcot12#27;
     |FINSI;
|FPRC;

|PROCESO topes_CP_2013;
     nLimite2013 = 2161.50;
     |SI swJornadas = 1;
          |SI base_7 > nLimite2013;
               nDifCP2013 = base_7 - nLimite2013;
               base_7 = nLimite2013;
               nATEP_Alta = nATEP_Alta - nDifCP2013;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO topes_CC_2013;
     nLimite2013 = 2161.50;
     |SI swJornadas = 1;
          |SI base_6 > nLimite2013;
               nDifCC2013 = base_6 - nLimite2013;
               base_6 = nLimite2013;
               nBaseAlta = nBaseAlta - nDifCC2013;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO topes_CP_2012;
     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;
     |SI swHistorico = 0;     || si no hay datos en el historico
          |ACABA;             || no voy a controlar topes
     |FINSI;
     sw_tope = sw_tope + 1;        || en alta: sw_tope=1; en baja: sw_tope=2
     nDiasCotIT = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
     |SI nBaseATEP = 0;             || solo topeo si tengo algo en la base
          |SI dcoti_0 > 0; |Y dabse_2 > 0; |Y #nomcontr#2 = "S";
               || en casos de absentismo, si tengo puesto que lo haga por la base
               || minima, si que tengo que topear, aunque la base este a cero
               || se topea por la base minima
               || esto habria que hacerlo por dias, pero es una solucion
               || provisional
          |SINO;
               |ACABA;
          |FINSI;
     |FINSI;
     grupo = #labtraba#33;
     |SI #labtraba#42 = "E";         || eventuales calculan los topes por jornadas
          |SI sw_tope = 1;    || reales, no por dias trabajados
               dias_tope = fijo_1;
          |SINO;
               dias_tope = jornadasIT;
          |FINSI;
     |SINO;
          |SI sw_tope = 1;    || fijos calculas los topes por dias trabajados
               |SI nDiasCotIT > 0;
                    || dias_tope = dcoti_0 - nDiasCotIT;
                    dias_tope = dcoti_0;
               |SINO;
                    dias_tope = dcoti_0;
               |FINSI;
          |SINO;
               dias_tope = nDiasCotIT;
          |FINSI;
     |FINSI;
     |SI dias_tope > 30; dias_tope = 30; |FINSI;
     nMax_cp = #nomconst#20 * dias_tope;          || maximo CP

     nCampo = grupo + 23;                         || minimo CP
     nMin_cp = #nomconst#nCampo# * dias_tope;

     |SI swJornadas = 1;
          |SI fijo_1 ! fijo_1_red;
               || esto es porque tengo mas de 23 jornadas, recalculo el
               || maximo por jornada para no pasarme
               nMin_cp = nMin_cp * fijo_1_red / fijo_1;
               nMax_cp = nMax_cp * fijo_1_red / fijo_1;
          |FINSI;
     |FINSI;

||     nMin_cp = nMin_cp % propo;
||     nMax_cp = nMax_cp % propo;

     nBaseHisCP = 0;
     nBaseHisCP = (#nomhicca#40 - #nomhicca#62);
     nBaseATEP = nBaseATEP + nBaseHisCP;

     |SI nMax_cp [ nBaseATEP; |Y nMax_cp > 0;
          nBaseATEP = nMax_cp - nBaseHisCP;      || topeo maximo
          pilt_ATEP = #nomconst#20;
          aTopeadaCP = "M";
          || prom_acc = (nBaseATEP / dias_tope) ! 2;
     |SINO;
          nBaseATEP = nBaseATEP - nBaseHisCP;
     |FINSI;
     /*
     |SI nMin_cp ] nBaseATEP; |Y nMin_cp > 0;
          nBaseATEP = nMin_cp;      || topeo minimo
          pilt_ATEP = #nomconst#23;
          aTopeadaCP = "m";
          || prom_acc = (nBaseATEP / dias_tope) ! 2;
     |FINSI;
     */
     |SI swPrevio = 1;
          prom_acc_previo = (nBaseATEP / dias_tope) ! 2;
     |FINSI;
|FPRC;

|PROCESO topes_CC_2012;
     |SI swHistorico = 0;     || si no hay datos en el historico
          |ACABA;             || no voy a controlar topes
     |FINSI;

     nBasePorJornada_red = 0;

     nGrupo = #labtraba#33;
     nCampo = nGrupo + 23;
     nTopeMin = #nomconst#nCampo#;

     nTopeMaxMen = 0;
     nTopeMaxJor = 0;

     |SI swMensual = 1;
          nCampo = nGrupo + 35;
          nTopeMaxMen = #nomconst#nCampo# * 30;
     |FINSI;
     |SI swJornadas = 1;
          nCampo = nGrupo + 35;
          nTopeMaxJor = #nomconst#nCampo#;
     |FINSI;

     || nTopeMaxMen = #gomcot12#14;
     || nTopeMaxJor = #gomcot12#15;

     nDiasCotIT = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;

     || topeo la base de alta solo, la de IT no hace falta, me viene
     || por el promedio

     |SI swMensual = 1;
          base_6 = base_6 + #nomhicca#39;

          || nTopeMaxMen = nTopeMaxMen * ((dcoti_0 - nDiasCotIT) / 30);
          nTopeMaxMen = nTopeMaxMen * (dcoti_0 / 30);
          |SI base_6 > nTopeMaxMen;
               aTopeadaCC = "M";
               base_6 = nTopeMaxMen;
          |FINSI;
/*
          || a minimos no
          nTopeMin = nTopeMin * (dcoti_0 - nDiasCotIT);
          || nTopeMin = nTopeMin % propo;
          |SI base_6 < nTopeMin;
               aTopeadaCC = "m";
               base_6 = nTopeMin;
          |FINSI;
*/
          |SI swPrevio = 1;
               prom_enf_previo = (base_6 / (dcoti_0 - nDiasCotIT)) ! 2;
          |FINSI;

          base_6 = base_6 - #nomhicca#39;
     |FINSI;

     nBaseJornadaHis = 0;
     |SI swJornadas = 1;
          nBaseJornadaHis = (#nomhicca#39 - #nomhicca#62) / fijo_1;
          nBasePorJornada = (base_6 / fijo_1) + nBaseJornadaHis;
          nBasePorJornada = nBasePorJornada ! 2;

          |SI fijo_1 > fijo_1_red;
               || esto es porque tengo mas de 23 jornadas, recalculo el
               || maximo por jornada para no pasarme
               nTopeMaxJor = nTopeMaxJor * fijo_1_red / fijo_1;
          |FINSI;

          || nTopeMaxJor = nTopeMaxJor % propo;

          |SI nBasePorJornada > nTopeMaxJor;
               aTopeadaCC = "M";
               nBasePorJornada = nTopeMaxJor - nBaseJornadaHis;
               base_6 = fijo_1 * nBasePorJornada;
          |SINO;
               || si he topeado a maximos no puedo topear tambien a
               || minimos, asi me quedo con una variable, nBasePorJornada

               |SI fijo_1 > fijo_1_red;
                    || esto es porque tengo mas de 23 jornadas, recalculo el
                    || maximo por jornada para no pasarme
                    nTopeMin = nTopeMin * fijo_1_red / fijo_1;
               |FINSI;

/*
               ||a minimos no
               |SI nBasePorJornada < nTopeMin;
                    aTopeadaCC = "m";
                    nBasePorJornada = nTopeMin;
                    base_6 = fijo_1 * nTopeMin;
               |FINSI;
*/

          |FINSI;
          nNume1 = (fijo_1 + jornadasIT);
          |SI nNume1 < 23;
               nBasePorJornada_red = base_6 / fijo_1_red;
               |SI nDesem > 0;
                    nBasePorJornada_red = (base_6 + nDesem) / (fijo_1_red + nJornadasERE);
               |FINSI;
          |SINO;
               nBasePorJornada_red = (base_6 + coba_1 + cobb_2 + coba_3) / 23;
               |SI nDesem > 0;
                    nBasePorJornada_red = (base_6 + nDesem + coba_1 + cobb_2 + coba_3) / 23;
               |FINSI;
          |FINSI;
          nBasePorJornada_red = nBasePorJornada_red ! 2;

          |SI swPrevio = 1;
               prom_enf_previo = nBasePorJornada ! 2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LimiteJor12;
     |MODULO aModulo; |QBF aModulo;
     |SI aModulo = "gomcalc1";
          |ACABA;
     |FINSI;

     nLimiteJor = 0;

     nume1 = fijo_1 + jornadasIT;

     |SI #0#9 ] 2012;
          |SI nume1 > 23;
               nLimiteJor = 23;
          |FINSI;
     |FINSI;
/*
     |SI #0#9 ] 2012;
          || en los convenios con conceptos 101 que sean D1 o M1 no tienen
          || que limitar las jornadas a 23 en la introduccion ya que se cobra
          || segun las jornadas introducidas y se puede cobrar lo que se quiera
          || siempre que luego la nomina limite a 23

          |SALVA_FICHA #nomconli;
          #nomconli#0 = #labtraba#87;
          #nomconli#2 = 101;
          |LEE 000#nomconli.=;
          |SI FSalida = 0;
               |SI nume1 > 23;
                    |SI #nomconli#3 = "D"; |O #nomconli#3 = "M";
                         |SI #nomconli#4 = 1;
                              nLimiteJor = 23;
                              |ACABA;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |REPON_FICHA #nomconli;
     |FINSI;
*/
|FPRC;

|| PROCESO PARA BUSCAR LA CANTIDAD BONIFICADA EN BONIFICACIONES PARA
|| BENEFICIARIOS DE PRESTACION DE DESEMPLEO, QUE TIENEN LIMITADO EL MAXIMO

|PROCESO BuscaBonif12;
     nNume = nNume + #nomhicca#63;
|FPRC;

|DEFBUCLE BuscaBonif12;
     #nomhicca#1;
     12;
     #labtraba#0, #labtraba#1, nDesdeAny, 01, 00, #nombonif#0;
     #labtraba#0, #labtraba#1, nHastaAny, 12, 99, #nombonif#0;
     ;
     NULL, BuscaBonif12;
|FIN;

|PROCESO BuscaBonifNIF12;
     |BUCLE BuscaBonif12;
|FPRC;

|DEFBUCLE BuscaBonifNIF12;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, BuscaBonifNIF12;
|FIN;

|PROCESO LimiteBonif12;
     nNume = 0;
     |SI #nombonif#26 = "S"; |Y #labtraba#217 ! 0;
          nDesdeAny = 09;
          nHastaAny = #0#9 - 2000;
          aNif = #labtraba#7;
          |SALVA_FICHA #labtraba;
          |BUCLE BuscaBonifNIF12;
          |REPON_FICHA #labtraba;
          nNume = #labtraba#217 - nNume;
          |SI nNume < 0;
               base_A = 0;
          |SINO;
               |SI nNume ] base_A;
                    base_A = base_A;
               |SINO;
                    base_A = nNume;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO calssemp12_1;    || CALCULA S.S. A CGO. EMPRESA
     base_A = 0;  base_B = 0;  base_C = 0;  base_F = 0;
     bbase_A = 0;  bbase_B = 0;  bbase_C = 0;  base_M = 0;
     basemat_B = 0;  basemat_C = 0;
     base_D = 0;  base_E = 0;
     zbase_A = 0; zbase_B = 0; zbase_C = 0; zbase_F = 0;

     || la base_77 para el 2012 sera la misma que la de profesionales
     || base_77 = base_7;

     || pues de momento, segun la SS no sera asi
     || base_77 = acum_10 + coba_3 + dvalo_pro;  || base cont.profesionales

     || me viene calculada y topeada del calcotiz en nATEP_Alta y nATEP_IT

     base_11 = 0;

     nTipoInicialCC = 0;
     aTipoReduccion = 0;

     nImporteRedCC_Alta = 0;
     nImporteRedCC_IT = 0;
     nImporteRedDes_Alta = 0;
     nImporteRedDes_IT = 0;

     base_8 = (dacum_30 % por2_hor1) + (dacum_31 % por2_hor2); || h.ext.
     base_11 = dcont_2 * prom_enf;

     |SI #labtraba#39 ! 0; |Y dboni_1 ! 0; |Y #nombonif#11 = "S";
          base_D = horasex * #nombonif#12;      || cuota (2) bonif. horas formacion
     |FINSI;

     nTipoInicialCC_Alta = por2_cont;
     nTipoInicialCC_IT = por2_cont;
     nTipoInicialDes = #nomconst#12;

     |HAZ reducciones12;

     nImporteRedCC_Alta = (nBaseAlta % nRedCC_Alta) ! 2;
     || nImporteRedCC_IT = (nBaseIT % nRedCC_IT) ! 2;
     nImporteRedCC_IT = (nBaseIT_red % nRedCC_IT) ! 2;
     nImporteRedDes_Alta = 0;
     nImporteRedDes_IT = (nATEP_IT_red % nRedDes_IT) ! 2;
     || nImporteRedDes_IT = (nATEP_IT % nRedDes_IT) ! 2;

     por2_cont_alta = por2_cont - nRedCC_Alta;
     por2_des_alta = nTipoInicialDes;

     |SI #nombonif#10 = 4;
          por2_des_alta = 0;
          #nomconst#12 = 0;
          #nomconst#14 = 0;
          #nomconst#16 = 0;
     |FINSI;

/*   LIMITES 2013

     |SI nElAny ] 2013;
          nLimMenG1 = (279 * dcoti_0) / 30;
          |SI nDiasAlta ] 30;
               nLimMenResto = 55.21;
          |SINO;
               nLimMenResto = (1.84 * nDiasAlta);
          |FINSI;
          |SI grupo = 1;
               |SI swMensual = 1;
                    nCuotaCCAlta = (nBaseAlta % por2_cont) ! 2;
                    nNume = nCuotaCCAlta - nImporteRedCC_Alta;
                    |SI nNume > nLimMenG1;
                         nImporteRedCC_Alta = nImporteRedCC_Alta + (nNume - nLimMenG1);
                    |FINSI;
               |FINSI;
               |SI swJornadas = 1;
                    nCuotaCCAlta = (nBaseAlta % por2_cont) ! 2;
                    nNume1 = nCuotaCCAlta - nImporteRedCC_Alta;
                    |SI fijo_1_red ] 23;
                         nNume2 = 279;
                    |SINO;
                         nNume2 = 12.13 * fijo_1_red;
                    |FINSI;
                    |SI nNume1 > nNume2;
                         nImporteRedCC_Alta = nImporteRedCC_Alta + (nNume1 - nNume2);
                    |FINSI;
               |FINSI;
          |SINO;
               |SI swMensual = 1;
                    nCuotaCCAlta = (nBaseAlta % por2_cont) ! 2;
                    nNume = nCuotaCCAlta - nImporteRedCC_Alta;
                    |SI nNume < nLimMenResto;
                         nImporteRedCC_Alta = nImporteRedCC_Alta - (nLimMenResto - nNume);
                    |FINSI;
               |FINSI;
               |SI swJornadas = 1;
                    nCuotaCCAlta = (nBaseAlta % por2_cont) ! 2;
                    nNume1 = nCuotaCCAlta - nImporteRedCC_Alta;
                    nNume2 = 2.40 * fijo_1_red;
                    |SI nNume1 < nNume2;
                         nImporteRedCC_Alta = nImporteRedCC_Alta - (nNume2 - nNume1);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO calssemp12_2;    || CALCULA S.S. A CGO. EMPRESA
     nCuotaCC_Alta = (nBaseAlta % por2_cont) ! 2;
     nCuotaCC_IT = (nBaseIT % por2_cont) ! 2;

     || nCuotaDes_Alta = (nBaseAlta % por2_des_alta) ! 2;
     || nCuotaDes_IT = (nBaseIT % por2_des_alta) ! 2;

     nCuotaDes_Alta = (nATEP_Alta % por2_des_alta) ! 2;
     nCuotaDes_IT = (nATEP_IT % por2_des_alta) ! 2;

     nCuotaFPFog = (nATEP_Alta + nATEP_IT) % (#nomconst#14 + #nomconst#16);
     nCuotaFPFog = nCuotaFPFog ! 2;
/*
     nCuotaCC_Alta = nCuotaCC_Alta - nImporteRedCC_Alta;
     nCuotaCC_IT = nCuotaCC_IT - nImporteRedCC_IT;
     nCuotaDes_IT = nCuotaDes_IT - nImporteRedDes_IT;
*/

     base_8 = (nCuotaCC_Alta - nImporteRedCC_Alta);
     base_8 = base_8 + (nCuotaCC_IT - nImporteRedCC_IT);
     base_8 = base_8 + nCuotaDes_Alta;
     base_8 = base_8 + (nCuotaDes_IT - nImporteRedDes_IT);
     base_8 = base_8 + nCuotaFPFog;

     || bueno, a ver lo de topear la base de ATEP no me cuadra aqui, se supone
     || que haremos como en el regimen general y por ATEP se cotizara por la
     || misma base que la de profesionales

     || TAMBIEN, porque en los seguros sociales lo hacemos asi, hay que
     || hacerlo igual
     base_9 = (nATEP_Alta % epig_ilt) ! 2;
     base_9 = base_9 + (nATEP_Alta % epig_ims) ! 2;

     || parte en IT

     base_9 = base_9 + ((nATEP_IT % epig_ilt) ! 2);
     base_9 = base_9 + ((nATEP_IT % epig_ims) ! 2);

               || bonificacion sobre base jornadas reales en alta
     |SI #labtraba#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0; |Y #nombonif#10 ! 4;
          || base_A = ((bon_0 % #nombonif#4) ! 2) % nPorBon1; || cuota bonif. linea 1
          || cuota bonif. linea 1:
          base_A = ((bon_0 % #nombonif#4) ! 2) - nImporteRedCC_Alta - nImporteRedCC_IT;
          base_A = base_A % nPorBon1;
          base_A = base_A ! 2;

          || base_B = ((bon_3 % #nombonif#5) ! 2) % nPorBon1; || cuota bonif. linea 2
          || cuota bonif. linea 2:

          || si bonifico sobre todas las cont. profesionales, separo la bonif.
          || de desempleo de la de FP y FOGASA, para no reducir la base de estas
          |SI #nombonif#5 ! 0;
               nNume = #nomconst#12 + #nomconst#14 + #nomconst#16;
               |SI nNume = #nombonif#5;
                    base_B = (((bon_3 % #nomconst#12) ! 2) - nImporteRedDes_IT) % nPorBon1;
                    base_B = base_B + ((bon_3 % (#nomconst#14 + #nomconst#16) ! 2) % nPorBon1);
               |SINO;
                    || si no, todo junto
                    base_B = (((bon_3 % #nombonif#5) ! 2) - nImporteRedDes_IT) % nPorBon1;
               |FINSI;
          |FINSI;

          base_B = base_B ! 2;
          |HAZ LimiteBonif12;
          |SI #nombonif#08 = "S";
               || zbase_9 = (acum_10 + coba_3) % (epig_ilt + epig_ims);
               zbase_9 = bon_3 % (epig_ilt + epig_ims);
               zbase_9 = zbase_9 ! 2;
               base_C = zbase_9 % nPorBon1;      || cuota bonificada accidentes
               base_C = base_C ! 2;
          |FINSI;
     |FINSI;

     || bonificacion sobre base jornadas teoricas en baja

     jornadasEA = jornadasIT;

     |SI #labtraba#39 ! 0; |Y dboni_2 ! 0; |Y nPorBon2 ! 0;
          zbase_A = ((zbon_0 % #nombonif#4)!2) % nPorBon2; || cuota bonif. linea 1
          zbase_A = zbase_A ! 2;
          zbase_B = ((zbon_3 % #nombonif#5)!2) % nPorBon2; || cuota bonif. linea 2
          zbase_B = zbase_B ! 2;
          |SI #nombonif#08 = "S";
               zbase_9 = ((zbon_3 - zbon_5) % epig_ilt) ! 2;
               zbase_9 = zbase_9 + (((zbon_3 - zbon_5) % epig_ims) ! 2);
               zbase_9 = zbase_9 + ((zbon_5 % epig_ilt) ! 2);
               zbase_9 = zbase_9 + ((zbon_5 % epig_ims) ! 2);
               zbase_9 = zbase_9 ! 2;
               zbase_C = zbase_9 % nPorBon2;     || cuota bonificada accidentes
               zbase_C = zbase_C ! 2;
          |FINSI;
     |FINSI;
     |SI #nombonif#10 = 4;
          nNume1 = (por2_cont - nReduccion);                || bonif empresa
          nNume1 = nNume1 - ((nNume1 % 6.20) ! 2);

          nNume1 = #nombonif#4;

          base_A = bon_0 % nNume1;
          base_A = base_A ! 2;

          nNume2 = ((bon_0 % por2_cont) ! 2);     || limite comunes
          nNume2 = nNume2 - base_A;
          |SI nImporteRedCC_Alta > nNume2;
               base_8 = base_8 + nImporteRedCC_Alta;
               nImporteRedCC_Alta = nNume2;
               base_8 = base_8 - nImporteRedCC_Alta;
          |FINSI;
     |FINSI;

     || empresa las cuotas de la bonificacion de la parte de baja y maternidad

     base_F = base_A + base_B + base_C;       || cuota (1) bonif. en alta
     bbase_F = bbase_A + bbase_B + bbase_C;   || cuota (1) bonif. en baja
     base_F = base_F + bbase_F + base_M;
     zbase_F = zbase_A + zbase_B + zbase_C;   || cuota (2) bonif.

     || S.Social cargo empresa:

     base_E = base_8 + base_9;
     base_E = base_E - (base_A + base_B + base_C);
     base_E = base_E - (zbase_A + zbase_B + zbase_C + base_D); ||SS emp.
     base_E = base_E - (bbase_A + bbase_B + bbase_C + base_M); || quito a la SS.cgo.
     base_E = base_E + cbon_3;     || a¤ado desempleo en baja

     |SI base_E < 0;
         base_E = 0;     || por si acaso sale negativa
     |FINSI;


     || base_E = base_E - nRedFija;
     || |SI base_E < 0;
     ||      nRedFija = nRedFija + base_E;
     ||      base_E = 0;
     || |FINSI;
     |SI nBonifFCI > 0;
          base_E = base_E - nBonifFCI;
          |SI base_E < 0;
               nBonifFCI = nBonifFCI + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI bon_59 > 0;
          base_E = base_E - bon_59;
          |SI base_E < 0;
               bon_59 = bon_59 + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI bon_60 > 0;
          base_E = base_E - bon_60;
          |SI base_E < 0;
               bon_60 = bon_60 + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI nBonifERE > 0;
          base_E = base_E - nBonifERE;
          |SI base_E < 0;
               nBonifERE = nBonifERE + base_E;
               base_E = 0;
          |FINSI;
     |FINSI;
     |SI #nombonif#10 = 4;
          || parte bonificacion al trabajador, sumo en el campo cuota bonif
          || pero no tiene que restar de la SS a cgo. empresa, sino no saldrian
          || los resumenes luego como deben

          || nNume2 = por1_cont - ((por1_cont % 6.20) ! 2);    || bonif trabajador
          nNume2 = #nombonif#6;

          base_A = base_A + ((bon_0 % nNume2) ! 2);
          base_F = base_F + ((bon_0 % nNume2) ! 2);
     |FINSI;
|FPRC;

|PROCESO lee_nomhicca;
     swHistorico = 0;
     |ABRE #nomhicca;
     #nomhicca#0 = #labtraba#0;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#2 = mes_x;
     #nomhicca#3 = 0;
     #nomhicca#66 = #0#9 - 2000;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          swHistorico = 1;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO DesglosaJorIT;
     |HAZ lee_nomhicca;

     |ABRE #nomhicli;
     #nomhicli#0 = #labtraba#0;
     #nomhicli#1 = #labtraba#1;
     #nomhicli#2 = mes_x;
     #nomhicli#3 = 0;
     #nomhicli#12 = #0#9 - 2000;
     |PARA nConcepto = 931; |SI nConcepto [ 934; |HACIENDO nConcepto = nConcepto + 1;
          #nomhicli#4 = nConcepto;
          |LEE 000#nomhicli.=;
          |SI FSalida = 0;
               swHay93X = 1;
               nCampo = nConcepto - 904
               |SI #nomhicca#nCampo# = "E";
                    nJornadasEnf = nJornadasEnf + #nomhicli#9;
               |FINSI;
               |SI #nomhicca#nCampo# = "A";
                    nJornadasAcc = nJornadasAcc + #nomhicli#9;
               |FINSI;
               |SI #nomhicca#nCampo# = "M";
                    nJornadasMat = nJornadasMat + #nomhicli#9;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #nomhicli;
|FPRC;

|PROCESO calcotiz12;      || CALCULA BASE CON.COMUNES Y BASE D+F+P (AGRARIA*)
     |HAZ lee_nomhicca;
     dacum_30 = acum_30;
     dacum_31 = acum_31;

     nNume1 = (denfe_2 - nDiasDescEnf);
     nNume2 = (dacci_2 - nDiasDescAcc);
     nNume3 = (dmate_2 - nDiasDescMat);
     nNume = nNume1 + nNume2 + nNume3;
     |SI nNume [ 0;
          jornadasIT = 0;
          coba_1 = 0; cobb_2 = 0; coba_3 = 0; coba_4 = 0; cobb_4 = 0;
     |FINSI;

     base_5 = 0;
     nume1 = acum_10 + dvalo_pro + n400Cot;  || ctos. 100 + prorr.
     base_6 = nume1;               || base de cotizacion comunes
     base_7 = nume1;               || base de cotizacion profesionales
     base_7 = base_7 + dacum_30 + dacum_31;

     aTopeadaCC = "";
     aTopeadaCP = "";
     nBaseAlta = 0;
     nBaseIT = 0;
     nBaseIT_red = 0;
     nATEP_Alta = 0;
     nATEP_IT = 0;
     swPrevio = 0;
     nBaseATEP_red = 0;
     nATEP_IT_red = 0;
     pilt_ATEP = 0;
     prom_enf = prom_enf_real;
     prom_acc = prom_acc_real;

     fijo_1_red = fijo_1;          || aqui me guardare, si las jornadas en
                                   || alta son mas de 23, las 23 que son el
                                   || limite para el calculo de reducciones

     |HAZ LeeTopesReduc;           || proceso para leer los topes y reducciones

     |SI swJornadas = 1;
          |HAZ LimiteJor12;

          |SI nLimiteJor ! 0;
               || he limitado las jornadas porque me pasaba del limite
               || reparto entre las jornadas en alta y las en IT
|| migue
               |SI fijo_1 ] nLimiteJor;      || todas en alta, limito al maximo
                    fijo_1_red = nLimiteJor;
               |FINSI;
          |FINSI;
     |FINSI;

     || para calcular la base para el calculo de la
     || reduccion para los trabajadores por jornadas, se divide por 23
     || como maximo si hay mas de 23 jornadas en alta, pero si hay mas de 23
     || entre alta e IT, se divide (base alta + base IT) / (jorn. alta + jorn. IT)

     jornadasIT_red = jornadasIT;
     |HAZ topes_CC_2012;
     nBaseAlta = base_6;
     || ahora a¤ado la base en IT, igual para mensual que para jornadas
     pilt_ATEP = prom_acc_real;

     |SI mes_x = 1;      || en enero nunca cotizamos por las ITs
          nDiasDescEnf = denfe_2;
          nDescEnf_B = denfe_B;
          nDescEnf_C = denfe_C;
          nDiasDescAcc = dacci_2;
          nDiasDescMat = dmate_2;
     |FINSI;

     nNume1 = (denfe_2 - nDiasDescEnf);
     nNume2 = (dacci_2 - nDiasDescAcc);
     nNume3 = (dmate_2 - nDiasDescMat);
     nNume = nNume1 + nNume2 + nNume3;

     |SI nNume [ 0;
          || no me hagas ajuste si no hay dias en verdad de enf ni acc
          swAjuste3 = 0;
     |FINSI;
     nNume = nNume - swAjuste3;
     nume2 = nNume;

     |SI nume2 < 0; nume2 = 0; |FINSI;
     |SI #labtraba#42 ! "E";
          nume2 = nume2 * pilt_ATEP;
     |SINO;
          nume2 = jornadasIT * pilt_ATEP;
          || nBaseATEP_red = jornadasIT_red * pilt_ATEP;
     |FINSI;

     base_6 = base_6 + coba_1 + cobb_2 + coba_3 - (swAjuste3 * pilt_ATEP);

     |SI nElAny ] 2013;
          nDifCC2013 = 0;
          |HAZ topes_CC_2013;
     |FINSI;

     sw_tope = 0;
     base_7 = acum_10 + coba_3 + dvalo_pro + n400Cot;  || base cont.profesionales
     base_7 = base_7 + dacum_30 + dacum_31;
     nBaseATEP = base_7;
     |HAZ topes_CP_2012;
     base_7 = nBaseATEP;
     nATEP_Alta = base_7;

     || parte en IT
     || nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;

     nNume1 = (denfe_2 - nDiasDescEnf);
     nNume2 = (dacci_2 - nDiasDescAcc);
     nNume3 = (dmate_2 - nDiasDescMat);
     nNume = nNume1 + nNume2 + nNume3;
     |SI nNume > 0;
          nNume = nNume - swAjuste3;
          nNume = nNume - swAjuste3_C;  || horrible
     |FINSI;
     nume2 = nNume;

     |SI nume2 < 0; nume2 = 0; |FINSI;
     nume1 = dcoti_0 - nume2;

     pilt_ATEP = prom_acc_real;

     |SI #labtraba#42 ! "E";
          nBaseATEP = nume2 * pilt_ATEP;
     |SINO;
          nBaseATEP = jornadasIT * pilt_ATEP;
          nBaseATEP_red = jornadasIT_red * pilt_ATEP;
     |FINSI;

     || Esto es porque en atrasos no se cotiza en Enero por las ITs
     |SI mes_x ! 1;
          nATEP_IT = nBaseATEP;
          nATEP_IT_red = nBaseATEP;
          |SI swJornadas = 1;
               nATEP_IT_red = nBaseATEP_red;
          |FINSI;
     |FINSI;
     |SI nDesem ! 0;
          nBaseATEP = nBaseATEP + nDesem;
          nBaseATEP_red = nBaseATEP - nDesem;
          nATEP_IT = nBaseATEP;
          nATEP_IT_red = nBaseATEP_red;

          |SI nJornadasERE > 0;
               jornadasIT = jornadasIT + nJornadasERE;
               jornadasIT_red = jornadasIT_red + nJornadasERE;
          |FINSI;
     |FINSI;

     base_7 = nATEP_Alta + nATEP_IT - cobb_4 - nDesem;
     nBaseIT = coba_1 + cobb_2 + coba_3 + coba_4;

     |SI nElAny ] 2013;
          nDifCP2013 = 0;
          |HAZ topes_CP_2013;
     |FINSI;

     nBaseIT = nBaseIT + nDesem;
     nBaseIT_red = nBaseIT;
     |SI swJornadas = 1;
          nBaseIT_red = nBaseIT_red * jornadasIT_red / jornadasIT;
     |FINSI;
     nBaseIT_red = nBaseIT_red ! 2;

     jornadasIT_red = jornadasIT;
     nNume1 = fijo_1 + jornadasIT;

     || PARA HALLAR LA PARTE A CARGO DE LA SEG. SOCIAL
     || POR LA QUE NO HAY QUE COTIZAR POR CONT. PROF.

     nBasePagoSS_CC = 0;
     nBasePagoSS_CP = 0;
     nBasePagoSS_CC_SinMat = 0;
     nBasePagoSS_CP_SinMat = 0;
     nDiasPagoSS = 0;
     nDiasPagoSS_SinMat = 0;
     nJornPagoSS = 0;
     nJornPagoSS_SinMat = 0;
     |SI swMensual = 1;
          || base fija
          || esta es la base total que paga la SS, me ahra falta todo para el
          || lote despues
          nNume1 = denfe_B + denfe_C - nDescEnf_B - nDescEnf_C;
          nNume2 = dacci_2 - nDiasDescAcc;
          nNume3 = dmate_2 - nDiasDescMat;
          nDiasPagoSS = nNume1 + nNume2 + nNume3;
          |SI nDiasPagoSS [ 0;
               swAjuste3 = 0;
               swAjuste3_C = 0;
          |FINSI;
          nDiasPagoSS = (nDiasPagoSS - swAjuste3 - swAjuste3_C); || pago SS

          |SI mes_x = 2;
               || caso raro, febrero, el swAjuste3 no tiene que intervenir,
               || ya que en este caso estoy sumando dos dias (el 29 y el 30)
               || que no debo sumar ya que los dias de enfermedad no me
               || cubren los 15 primeros dias
               || si esto molesta, hacer la prueba de febrero, 7 dias de IT
               || mensual, por ejemplo
               nNume1 = swAjuste3 * (-1);
               |SI nDiasPagoSS = nNume1;
                    nDiasPagoSS = 0;
               |FINSI;
          |FINSI;

          |SI nDiasPagoSS < 0; nDiasPagoSS = 0; |FINSI;

          nBasePagoSS_CC = nDiasPagoSS * prom_enf;
          nBasePagoSS_CP = nDiasPagoSS * prom_acc;

          || pero tambien me hace falto lo mismo quitando la parte de matern.
          || que es lo que le tengo que descontar para que el trabajador no
          || cotice por ello

          nDiasPagoSS_SinMat = (denfe_B + denfe_C + dacci_2 - swAjuste3); || pago SS

          |SI mes_x = 2;
               || caso raro, febrero, el swAjuste3 no tiene que intervenir,
               || ya que en este caso estoy sumando dos dias (el 29 y el 30)
               || que no debo sumar ya que los dias de enfermedad no me
               || cubren los 15 primeros dias
               || si esto molesta, hacer la prueba de febrero, 7 dias de IT
               || mensual, por ejemplo
               nNume1 = swAjuste3 * (-1);
               |SI nDiasPagoSS_SinMat = nNume1;
                    nDiasPagoSS_SinMat = 0;
               |FINSI;
          |FINSI;

          |SI nDiasPagoSS_SinMat < 0; nDiasPagoSS_SinMat = 0; |FINSI;

          nBasePagoSS_CC_SinMat = nDiasPagoSS_SinMat * prom_enf;
          nBasePagoSS_CP_SinMat = nDiasPagoSS_SinMat * prom_acc;
     |SINO;
          || jornadas

          nume1 = (denfe_B + denfe_C + dacci_2 - swAjuste3);    || pago SS
          nume1 = nume1 + dmate_2;

          || solo maternidad o control IT SS
          || migue

          swHay93X = 0;
          nJornadasEnf = 0;
          nJornadasAcc = 0;
          nJornadasMat = 0;
          |HAZ DesglosaJorIT;

          |SI swHay93X = 0;
               |SI nume1 < 0; nume1 = 0; |FINSI;
               nDiasPagoSS = nume1;
               nume2 = denfe_D + denfe_A;         || pago empresario
               nume1 = jornadasIT * nume1 / (nume1 + nume2);   || parte de las jornadas en IT que
               nume1 = nume1 ! 0;                 || paga la Seg. Social
               |SI nJorITCotEmpTra ! 0; |O nJorITCotEmp ! 0;
                    || parte de las jornadas en IT por la que cotiza trabajador y
                    || y empresa, mediante el concepto 942
                    nume1 = nJorITCotEmp;
               |FINSI;
          |SINO;
               nume1 = (denfe_B + denfe_C - swAjuste3);    || pago SS
               nume2 = denfe_D + denfe_A;         || pago empresario
               nume1 = nJornadasEnf * nume1 / (nume1 + nume2);
               nume1 = nume1 + nJornadasAcc + nJornadasMat;
               nume1 = nume1 ! 0;
          |FINSI;

          nJornPagoSS = nume1;
          nBasePagoSS_CC = nJornPagoSS * prom_enf;   || base cotiz. CONT.PROF.
          nBasePagoSS_CP = nJornPagoSS * prom_acc;   || base cotiz. CONT.PROF.

          || ahora lo mismo pero sin los dias de Maternidad

          nume1 = (denfe_B + denfe_C + dacci_2 - swAjuste3);    || pago SS

          |SI swHay93X = 0;
               |SI nume1 < 0; nume1 = 0; |FINSI;
               nDiasPagoSS_SinMat = nume1;
               nume2 = denfe_D + denfe_A;         || pago empresario
               nume1 = jornadasIT * nume1 / (nume1 + nume2);   || parte de las jornadas en IT que
               nume1 = nume1 ! 0;                 || paga la Seg. Social
               |SI nJorITCotEmpTra ! 0; |O nJorITCotEmp ! 0;
                    || parte de las jornadas en IT por la que cotiza solo la
                    || empresa, mediante el con cepto 942
                    nume1 = nJorITCotEmp;
               |FINSI;
          |SINO;
               nume1 = (denfe_B + denfe_C - swAjuste3);    || pago SS
               nume2 = denfe_D + denfe_A;         || pago empresario
               nume1 = nJornadasEnf * nume1 / (nume1 + nume2);
               nume1 = nume1 + nJornadasAcc + nJornadasMat;
               nume1 = nume1 ! 0;
          |FINSI;

          nJornPagoSS_SinMat = nume1;
          nBasePagoSS_CC_SinMat = nJornPagoSS_SinMat * prom_enf;   || base cotiz. CONT.PROF.
          nBasePagoSS_CP_SinMat = nJornPagoSS_SinMat * prom_acc;   || base cotiz. CONT.PROF.

          || si en jornadas IT hay jornadas de mat y de enf ... mmm ... ya veremos
          || cuando pase

     |FINSI;

     || base_5 = coba_1 + cobb_2 + coba_3 + coba_4;   || base IT
     || se supone que los coba_X ya deberian venir ajustados, pero habria que
     || hacerlo en el nomcalat, y ahi no se va a tocar nada de moemento
     base_5 = nATEP_IT;

     || ¨es esto necesario para 2012?

     nume1 = denfe_2 + dmate_2 + dacci_2;
     |SI nume1 = 0; |Y #labtraba#33 = 01;
          || no tengo IT, pero se tiene que quedar grabada la base
          || del mes para el mes que viene, en los grupo 01 tambien claro
          || y no se estaba grabando por no estar cargando las variables
          || prom_enf ni prom_acc a no ser que hubiera algo del mes anterior
          || con IT

          nBase = base_6;
          |SI swBaseFija = 1;
               prom_enf = nBase / dcoti_0;
          |SINO;
               prom_enf = nBase / fijo_1;
          |FINSI;
          prom_enf = prom_enf ! 2;
          prom_acc = prom_enf;
     |FINSI;
|FPRC;

|PROCESO calboni112;       || CALCULA BASES BONIFICACION
     bon_0 = 0;           || base CC bonificacion (1)
     bon_3 = 0;           || base CP bonificacion (1)
     bon_5 = 0;           || base ILT bonificacion (1)
     bon_1 = por1_cont;   || (%) cont. comunes
     bon_2 = por1_dfpg;   || (%) D+F+P
     |SI #labtraba#39 ! 0; |Y dboni_1 ! 0; |Y nPorBon1 ! 0;
          lin_1 = #nombonif#6 % nPorBon1;
          lin_2 = #nombonif#7 % nPorBon1;
          bon_0 = base_6 + coba_4 + nDesem;
          bon_3 = base_7 + cobb_4 + nDesem;
          bon_5 = base_5;
          bon_1 = por1_cont - lin_1;
          bon_2 = por1_dfpg - lin_2;
          |SI #nombonif#9 = "S";
               bon_1 = bon_1 - #nomconst#5;
          |FINSI;
          |SI dboni_1 ! dcoti_0;    || dias bonificacion distintos a dias cotizacion
               nume1 = dboni_1 / (dboni_1 + dboni_2);
               bon_0 = bon_0 * nume1;
               bon_3 = bon_3 * nume1;
               bon_5 = bon_5 * nume1;
          |FINSI;
     |FINSI;

     dto_con = 0;                   || dto. CON.COM.  AGRARIA*
     dto_dfp = 0;                   || dto. CON.PRO.  AGRARIA*

     nDtoCCTra = #nomconst#7;
     nDtoCPTra = #nomconst#13 + #nomconst#17;

     |SI #nombonif#10 = 4;
          ||nDtoCCTra = (nDtoCCTra % 6.20) ! 2;
          nDtoCCTra = por1_cont - #nombonif#6;
          nDtoCPTra = 0;
          bon_1 = nDtoCCTra;
     |FINSI;

     |SI swBaseFija = 1;
          nume2 = (denfe_2 + dacci_2 + dmate_2) - swAjuste3;
          |SI dcoti_0 ! 30;   || no estoy de alta el mes completo
               nume1 = (dcoti_0 - nume2); || dias trabajados
          |SINO;
               |SI dilt > 0;  || estoy de alta el mes completo pero tengo IT
                    nume1 = (dcoti_0 - nume2); || dias trabajados
               |SINO;         || mes completo sin IT
                    nume1 = 30;
               |FINSI;
          |FINSI;

          nNume = base_6 - nBasePagoSS_CC_SinMat;
          |SI nNume > 0;
               dto_con = ((base_6 - nBasePagoSS_CC_SinMat) % nDtoCCTra) ! 2;          || cuota
          |FINSI;

          nNume = base_7 - nBasePagoSS_CP_SinMat;
          |SI nNume > 0;
               dto_dfp = ((base_7 - nBasePagoSS_CP_SinMat) % nDtoCPTra) ! 2;      || cuota
          |FINSI;
     |FINSI;

     |SI swJornadas = 1;
          nume1 = fijo_1;

          nNume = base_6 - nBasePagoSS_CC_SinMat;
          |SI nNume > 0;
               dto_con = ((base_6 - nBasePagoSS_CC_SinMat) % nDtoCCTra) ! 2;          || cuota
          |FINSI;

          nNume = base_7 - nBasePagoSS_CP_SinMat;
          |SI nNume > 0;
               dto_dfp = ((base_7 - nBasePagoSS_CP_SinMat) % nDtoCPTra) ! 2;      || cuota
          |FINSI;
     |FINSI;

     |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
          || se supone que extranjeros clave "e"
          dto_dfp = 0;
     |FINSI;

     dto_ho1 = dacum_30 % por1_hor1; dto_ho1 = dto_ho1 ! 2; || dto. horas 1
     dto_ho2 = dacum_31 % por1_hor2; dto_ho2 = dto_ho2 ! 2; || dto. horas 2
|FPRC;

/****************************************************************************/
/**************  PROCESOS PARA GRABAR LA SS A CARGO DE LA EMPRESA ***********/
/****************************************************************************/

|PROCESO SS_Empresa_Agr;
     #nomcalac#173 = nCuotaCC_Alta + nCuotaCC_IT;     || Comunes
     #nomcalac#174 = nCuotaDes_Alta + nCuotaDes_IT;   || Desempleo
     #nomcalac#175 = (nATEP_Alta + nATEP_IT) % #nomconst#14;      || FOGASA
     #nomcalac#176 = (nATEP_Alta + nATEP_IT) % #nomconst#16;      || FP
     #nomcalac#177 = base_9;      || AT + EP
     || #nomcalac#178 = ;      || LIBRE
     #nomcalac#179 = (dacum_30 % por2_hor1) + (dacum_31 % por2_hor2);  || Horas Extras
     || Bonificaciones
     #nomcalac#180 = base_A + base_B + base_C + zbase_A + zbase_B + zbase_C;
     #nomcalac#180 = #nomcalac#180 + nBonifFCI;
     #nomcalac#180 = #nomcalac#180 + nBonifERE;
     #nomcalac#180 = #nomcalac#180 + nImporteRedCC_Alta + nImporteRedCC_IT + nImporteRedDes_IT;
|FPRC;
