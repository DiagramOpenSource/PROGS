/*
|PROCESO EVENTOCRM;
     || como en el dsam0103 existe una llamada a este proceso y este proceso
     || esta en el plb de la integral tengo que tener aqui esto porque si no
     || casca

     || Eso era antes, ahora ... tachaaaan, tenemos accso a la gestion
     || documenal desde la nomina, flipa
     || 16.11.2009
|FPRC;
*/
|FICHEROS;
     ||agifa010  #112;     ||Proveedores, luego se convertira en #Fichero@#
     Referen@ #1000;
|FIN;

|VARIABLES;
     nAux = "";
     aAplica = "";
     nEmpresa = 0;
     aEmpresa = "";

     aRels  = "";
     aAlfa6 = "";

     nNumRels = 0;
     nCont    = 0;
     nCalc    = 0;
     nCalc1   = 0;
     nOpcion  = 0;

     aParametro = "";
     aAlfa = "";
     nSalida = 0;
     aPrograma = "";
     aBase = "";
     aPathDef = "";
     aPathFic = "";
     aQueQuiero = "";
     aNomDef = "";
     aMensaje = "";
     aFichRel = "";

     aAlfa5 = "";
     aClaves = "";
     aTCompo = "";
     nTCompo = 0;
     aTCompo2 = "";
     nTCompo2 = 0;
     {16}clave = 0;      ||Array de 16 elementos para la clave.
     nCompo = 0;
     nPosi = 0;
     aTCampos = "";
     nTCampos = 0;
     nCampo = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aClave = "";
     nNumCam = 0;
     aFicERP = "";
     aDSERP = "";

     &PRMNT_Def = "";
     &PRMNT_autoERP = "";
     aLong = "";
     nLong = 0;

     nNumCmps    = 0;
   {2}nPuntero   = 0;
     aSalida = "";

     nSwSaltaRel = 0;
|FIN;

|PROCESO &EVENTOGRID;
/*
     |PUSHV 0501 2480;
     |SUB_EJECUTA "zbrossa";
     |POPV;
     |ACABA;
*/

     |SI Campo = -1;
          ||aMensaje = "0000Esta opcion solo funciona estando dentro del campo.";
          ||MENAV aMensaje;
          nSwSaltaRel = 1;
     |SINO;
          nSwSaltaRel = 0;
     |FINSI;

     aSalida = FSalida;
     |QBF aSalida;
     |SI aSalida = "1771";
          aMensaje = "0000Esta opcion solo funciona estando dentro del campo. Codigo 1771";
          |MENAV aMensaje;
     |SINO;
          aSalida = aSalida % 104;
          |SI aSalida = "1771";
               FSalida = 4;
               |HAZ ControlGrid;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlGrid; |TIPO 77;
   nSalida = FSalida;
   |SI FSalida = 4;
     ||Primero miro si tengo instalado el dserp

     || a partir de ahora (13.10.2011) paso de controlar el dserp porque ya
     || no se instala con el GAD

     ||MODULO aPrograma;
     ||SI aPrograma ! "labtraba";

          |DBASS aFicERP;
          |QBF aFicERP;
          aDSERP = aFicERP + "dserp/def/dserpm01.mas";
          |XABRE "E", aDSERP, 0;
          |SI FSalida ! 0; |ACABA; |FINSI;
     ||FINSI;

/*
     ||Esto era necesario antes, cuando venia de un GRID, ahora ya no
     ||es necesario. No borrar, por si lo necesitamos en prox. versiones

     nCalc = -1;
     aAlfa = "|NC"; aAlfa = #Fichero@#aAlfa#;
     nNumCmps = aAlfa; nNumCmps = nNumCmps - 1;
     |PARA nCont = 0; |SI nCont [ nNumCmps; |HACIENDO nCont = nCont + 1;
        InPuntero = nPuntero1<-;
        |REFERENCIA_DEF nPuntero1, #Fichero@;
        nPuntero2 = nCont;
        |ESPECIFICA "CAMPOGRID", nPuntero;
        nCalc = FSalida; nCalc = nCalc + 1;
        |SI Campo = nCalc; |SAL; |FINSI;
     |SIGUE;
     |SI Campo = nCalc;
        nCampo = nCont;
     |SINO;
        nCampo = -1;
     |FINSI;
*/
     nCampo = Campo;

     |DBASE aBase;
     |QBF aBase;
     aPathDef = aBase + "def/";
     aQueQuiero = "|DEF";
     aNomDef = #Fichero@#aQueQuiero#;
     |QBF aNomDef;
     aNomDef = aNomDef - aPathDef;
     |QBF aNomDef;
     aNomDef = (aNomDef + "        ") % 108;
     |MODULO aPrograma;
     |QBF aPrograma;
     |DFICE aPathFic;
     |QBF aPathFic;

     |SI nSwSaltaRel = 0;
          aAlfa5 = "|NR"; aAlfa5 = #Fichero@#aAlfa5#;
          nNumRels = aAlfa5; nNumRels = nNumRels - 1;
          |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
             aAlfa5 = "|R" + (("000" + nCont) % -103);
             aAlfa5 = #Fichero@#aAlfa5#;
             aAlfa5 = aAlfa5 - "|";
             |SI FSalida ! 0;
                nCalc = ((FSalida / 100) ! 0) + 99;
                aFichRel = aAlfa5 % nCalc;
                nCalc = FSalida + 98;
                aAlfa5 = aAlfa5 % nCalc; aAlfa5 = aAlfa5 % 0499; aRels = aAlfa5;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6; nCalc = nCalc - 1;
                   |SI nCalc = nCampo; |SAL; |FINSI;
                |SIGUE;
                |SI nCalc = nCampo; |SAL; |FINSI;
             |FINSI;
          |SIGUE;
          |SI nCalc = nCampo;
             aAlfa5 = aPathDef + aAlfa5; |QBF aAlfa5;
             aAlfa5 = aAlfa5 + aFichRel + ".mas";
             |CARGA_DEF aAlfa5, Referen@;
             |SI FSalida = 0;
                |ENLAZA_PROCESO #Referen@#0,ControlGrid,77;
                |PATH_DAT #1000 aPathFic;
                |ABRE #Referen@;  aAlfa5 = "|K000";
                aAlfa5 = #Referen@#aAlfa5#; aAlfa5 = aAlfa5 % 0499;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6;
                   aAlfa6 = aRels % 0103; aRels = aRels % 0499;
                   nCalc1 = aAlfa6; nCalc1 = nCalc1 - 1;
                   #Referen@#nCalc# = #Fichero@#nCalc1#;
                |SIGUE;
                |LEE 000#Referen@.];
                |PUSHV 0501 2380;
                |PINPA #0#Referen@; |PINDA #0#Referen@;
                |PUSHV 0501 2380;
                |HAZ Relacionado;
                |POPV;
                |POPV;
                ||CONSULTA_CLAVE #1#Referen@;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |ACABA;
             |SINO;
                aAlfa5 = "    No encuentro el def a cargar. [" + aAlfa5 + "," + FSalida + "]";
                |MENAV aAlfa5;
             |FINSI;
          |FINSI;
     |FINSI;
     ||TODO CCC.
     nSwSaltaRel = 1;

     aAlfa5 = "|K000";
     aClaves = #Fichero@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Fichero@#nNumCam#;

          || resulta que luego en el dserp para mandarlo al dsarchi la clave
          || me la coge con campos de tama¤o 8, asi que lo formateo asi
          || y me quito de problemas 17.11.2009

          || no, ya no ahora me la coge con el tama¤o que tenga el campo
          || formateo empresa y trabajador a cinco digitos

          |SI aNomDef = "prev0002"; |Y nNumCam = 003;
               || vengo del modulo de prevencion de laboral, esto de formate-
               || arlo a 8 caracteres que no quedo excesivamente claro cuando
               || se hizo la llamada al dsarchi desde el labtraba aqui me putea
               || ya que el cuarto campo de la clave de una fecha, parcheo pues

               || no hagas nada
          |SINO;
               || aAlfa2 = ("00000000" + aAlfa2) % -108;
               aAlfa2 = ("00000" + aAlfa2) % -105;
          |FINSI;

          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica
/*
     ||Se usa en otro sitio tambien.
     ||Si lo de arriba no fa fino .. cambiarlo por esto.
     |DBASE aBase;
     |QBF aBase;
     |DBASS aBass;
     |QBF aBass;
     aAplica = aBase - aBass;
     aAplica = aAplica - "/";
     aAplica = aAplica - "\";
     |QBF aAplica;
*/
     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aNomDef + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm08;" + aParametro;

     |SI aNomDef = "prev0002"; |O aNomDef = "prev0101";
          || esto para que desde el modulo de prevencion solo me saque documentos
          PRMNT_autoERP = "AUTODOCS";
     |FINSI;
     |SUB_EJECUTA aAlfa;
     |SI nSwSaltaRel = 1;
          ||PTEC 807;
     |FINSI;
  |FINSI;
|FPRC;


|PROCESO Relacionado;
     aAlfa5 = "|K000";
     aClaves = #Referen@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Referen@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica
     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aFichRel + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm08;" + aParametro;

     |SUB_EJECUTA aAlfa;
     ||PTEC 807;
|FPRC;


|PROCESO &EVENTOPBX;

     |SI Campo = -1;
          nSwSaltaRel = 1;
     |SINO;
          nSwSaltaRel = 0;
     |FINSI;

     aSalida = FSalida;
     |QBF aSalida;
     |SI aSalida = "1771";
          aMensaje = "0000Esta opcion solo funciona estando dentro del campo. Codigo 1771";
          |MENAV aMensaje;
     |SINO;
          aSalida = aSalida % 104;
          |SI aSalida = "1771";
               |HAZ BotonPBX;
          |FINSI;
     |FINSI;

|FPRC;

|PROCESO BotonPBX;
     nCampo = Campo;

     |DBASS aFicERP;
     |QBF aFicERP;
     aDSERP = aFicERP + "dserp/def/dserpm01.mas";
     |XABRE "E", aDSERP, 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |DBASE aBase;
     |QBF aBase;
     aPathDef = aBase + "def/";
     aQueQuiero = "|DEF";
     aNomDef = #Fichero@#aQueQuiero#;
     |QBF aNomDef;
     aNomDef = aNomDef - aPathDef;
     |QBF aNomDef;
     aNomDef = (aNomDef + "        ") % 108;
     |MODULO aPrograma;
     |QBF aPrograma;
     |DFICE aPathFic;
     |QBF aPathFic;

     |SI nSwSaltaRel = 0;
          aAlfa5 = "|NR"; aAlfa5 = #Fichero@#aAlfa5#;
          nNumRels = aAlfa5; nNumRels = nNumRels - 1;
          |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
             aAlfa5 = "|R" + (("000" + nCont) % -103);
             aAlfa5 = #Fichero@#aAlfa5#;
             aAlfa5 = aAlfa5 - "|";
             |SI FSalida ! 0;
                nCalc = ((FSalida / 100) ! 0) + 99;
                aFichRel = aAlfa5 % nCalc;
                nCalc = FSalida + 98;
                aAlfa5 = aAlfa5 % nCalc; aAlfa5 = aAlfa5 % 0499; aRels = aAlfa5;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6; nCalc = nCalc - 1;
                   |SI nCalc = nCampo; |SAL; |FINSI;
                |SIGUE;
                |SI nCalc = nCampo; |SAL; |FINSI;
             |FINSI;
          |SIGUE;
          |SI nCalc = nCampo;
             aAlfa5 = aPathDef + aAlfa5; |QBF aAlfa5;
             aAlfa5 = aAlfa5 + aFichRel + ".mas";
             |CARGA_DEF aAlfa5, Referen@;
             |SI FSalida = 0;
                |ENLAZA_PROCESO #Referen@#0,ControlGrid,77;
                |PATH_DAT #1000 aPathFic;
                |ABRE #Referen@;  aAlfa5 = "|K000";
                aAlfa5 = #Referen@#aAlfa5#; aAlfa5 = aAlfa5 % 0499;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6;
                   aAlfa6 = aRels % 0103; aRels = aRels % 0499;
                   nCalc1 = aAlfa6; nCalc1 = nCalc1 - 1;
                   #Referen@#nCalc# = #Fichero@#nCalc1#;
                |SIGUE;
                |LEE 000#Referen@.];
                |PUSHV 0501 2380;
                |PINPA #0#Referen@; |PINDA #0#Referen@;
                |PUSHV 0501 2380;
                |HAZ RelacionadoPBX;
                |POPV;
                |POPV;
                ||CONSULTA_CLAVE #1#Referen@;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |ACABA;
             |SINO;
                aAlfa5 = "    No encuentro el def a cargar. [" + aAlfa5 + "," + FSalida + "]";
                |MENAV aAlfa5;
             |FINSI;
          |FINSI;
     |FINSI;

     aAlfa5 = "|K000";
     aClaves = #Fichero@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Fichero@#nNumCam#;

          ||SOLO SE UTILIZAN EN labempre y labtraba, y en estos casos
          ||son numericos de 5 caracteres, los relleno con ceros por la izquierda
          |SI aNomDef = "labempre"; |O aNomDef = "labtraba";
               nAux = aAlfa2;
               aAlfa2 = ("00000" + nAux) % -105;
          |FINSI;

          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica

     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aNomDef + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm11;" + aParametro;
     |SUB_EJECUTA aAlfa;

/*
     aFicheroDef = aNomDef;
     |HAZ ControlPBX;

*/
|FPRC;

|PROCESO RelacionadoPBX;
     aAlfa5 = "|K000";
     aClaves = #Referen@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Referen@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica
     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aFichRel + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm11;" + aParametro;
     |SUB_EJECUTA aAlfa;
/*
     aFicheroDef = aFichRel;
     |QBF aFicheroDef;
     |HAZ ControlPBX;
*/

|FPRC;

|PROCESO &EVENTOCRM;

     |SI Campo = -1;
          nSwSaltaRel = 1;
     |SINO;
          nSwSaltaRel = 0;
     |FINSI;

     aSalida = FSalida;
     |QBF aSalida;
     |SI aSalida = "1771";
          aMensaje = "0000Esta opcion solo funciona estando dentro del campo. Codigo 1771";
          |MENAV aMensaje;
     |SINO;
          aSalida = aSalida % 104;
          |SI aSalida = "1771";
               |HAZ BotonCrm;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BotonCrm;
     nCampo = Campo;

     |DBASS aFicERP;
     |QBF aFicERP;
     aDSERP = aFicERP + "dserp/def/dserpm01.mas";
     |XABRE "E", aDSERP, 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |DBASE aBase;
     |QBF aBase;
     aPathDef = aBase + "def/";
     aQueQuiero = "|DEF";
     aNomDef = #Fichero@#aQueQuiero#;
     |QBF aNomDef;
     aNomDef = aNomDef - aPathDef;
     |QBF aNomDef;
     aNomDef = (aNomDef + "        ") % 108;
     |MODULO aPrograma;
     |QBF aPrograma;
     |DFICE aPathFic;
     |QBF aPathFic;

     |SI nSwSaltaRel = 0;
          aAlfa5 = "|NR"; aAlfa5 = #Fichero@#aAlfa5#;
          nNumRels = aAlfa5; nNumRels = nNumRels - 1;
          |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
             aAlfa5 = "|R" + (("000" + nCont) % -103);
             aAlfa5 = #Fichero@#aAlfa5#;
             aAlfa5 = aAlfa5 - "|";
             |SI FSalida ! 0;
                nCalc = ((FSalida / 100) ! 0) + 99;
                aFichRel = aAlfa5 % nCalc;
                nCalc = FSalida + 98;
                aAlfa5 = aAlfa5 % nCalc; aAlfa5 = aAlfa5 % 0499; aRels = aAlfa5;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6; nCalc = nCalc - 1;
                   |SI nCalc = nCampo; |SAL; |FINSI;
                |SIGUE;
                |SI nCalc = nCampo; |SAL; |FINSI;
             |FINSI;
          |SIGUE;
          |SI nCalc = nCampo;
             aAlfa5 = aPathDef + aAlfa5; |QBF aAlfa5;
             aAlfa5 = aAlfa5 + aFichRel + ".mas";
             |CARGA_DEF aAlfa5, Referen@;
             |SI FSalida = 0;
                |ENLAZA_PROCESO #Referen@#0,ControlGrid,77;
                |PATH_DAT #1000 aPathFic;
                |ABRE #Referen@;  aAlfa5 = "|K000";
                aAlfa5 = #Referen@#aAlfa5#; aAlfa5 = aAlfa5 % 0499;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6;
                   aAlfa6 = aRels % 0103; aRels = aRels % 0499;
                   nCalc1 = aAlfa6; nCalc1 = nCalc1 - 1;
                   #Referen@#nCalc# = #Fichero@#nCalc1#;
                |SIGUE;
                |LEE 000#Referen@.];
                |PUSHV 0501 2380;
                |PINPA #0#Referen@; |PINDA #0#Referen@;
                |PUSHV 0501 2380;
                |HAZ RelacionadoCRM;
                |POPV;
                |POPV;
                ||CONSULTA_CLAVE #1#Referen@;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |ACABA;
             |SINO;
                aAlfa5 = "    No encuentro el def a cargar. [" + aAlfa5 + "," + FSalida + "]";
                |MENAV aAlfa5;
             |FINSI;
          |FINSI;
     |FINSI;

     aAlfa5 = "|K000";
     aClaves = #Fichero@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Fichero@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica

     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aNomDef + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm12;" + aParametro;
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO RelacionadoCRM;
     aAlfa5 = "|K000";
     aClaves = #Referen@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Referen@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica
     aAplica = (aAplica + "        ") % 108;

     ||nEmpresa = #48#0;
     ||Esto en la integral PETA.
     nEmpresa = 0;
     aEmpresa = ("00000" + nEmpresa) % -105;

     aParametro = aAplica + aEmpresa + aFichRel + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm12;" + aParametro;
     |SUB_EJECUTA aAlfa;
|FPRC;
