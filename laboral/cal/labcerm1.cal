|FICHEROS;
     labcerm0;
     labcerm1 #0;

     labtraba;
     &regisnif@ #712;
     :/basica/def/agidanif;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     &aCadena = "";
     &eaNom = "";
     &eaApel1 = "";
     &eaApel2 = "";
     &eaCodNif = "";
     aCodPos = "";
     nCampo = 0;

     swLeido = 0;
     aTipo = "";
     &eswNif = 0;
     &eaPrograma = "labcerm1";
     &enPintaLoc = 0;
     aAntLoc = "";


     || variables para el calculo de dig. cont. del NAFSS o de la letra del NIF
     &eaVarDni = "";
     &enCalcCif = 0;
     modo = 0;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nNume = 0;
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     aNAFSS = "";
     jg = 0;
     sitio = 0;
     corta = 0;
|FIN;

|PROCESO lee_agidanif;
     |SI #agidanif#2 = aTipo;
          swLeido = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE lee_agidanif;
     #agidanif#1;
     ;
     #labcerm1#10, 00;
     #labcerm1#10, 99;
     ;
     NULL, lee_agidanif;
|FIN;

|PROCESO agidanif;
     swLeido = 0;
     |BUCLE lee_agidanif;
|FPRC;

|PROCESO PrimerProgenitor; |TIPO 7;
     aAlfa = #labcerm1#10;
     |QBF aAlfa;
     |SI aAlfa ! "";
          |ACABA;
     |FINSI;

     |ABRE #labtraba;
     #labtraba#0 = #labcerm1#0;
     #labtraba#1 = #labcerm1#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          aCadena = #labtraba#2;
          |HAZ SeparaNom_plb;
          |QBF eaNom; |QBF eaApel1; |QBF eaApel2;
          #labcerm1#5 = eaNom;
          #labcerm1#3 = eaApel1;
          #labcerm1#4 = eaApel2;
          #labcerm1#6 = #labtraba#11;
          |SI #labtraba#252 = "V";
               #labcerm1#7 = "H";
          |SINO;
               #labcerm1#7 = #labtraba#252;
          |FINSI;
          aAlfa = #labtraba#75; |QBF aAlfa;
          aAlfa1 = aAlfa % 102;
          aAlfa2 = aAlfa % 310;
          #labcerm1#8 = aAlfa1;
          #labcerm1#9 = aAlfa2;
          #labcerm1#10 = #labtraba#7;
          #labcerm1#11 = #labtraba#244;
          aTipo = "TITULAR     ";
          |HAZ agidanif;
          |SI swLeido = 1;
               #labcerm1#12 = #agidanif#35;
          |FINSI;

          || domicilio
          eaCodNif = #labtraba#7;
          |HAZ LeeNifs;

          aAlfa = #712#9; |QBF aAlfa; aAlfa = aAlfa + " ";
          aAlfa = aAlfa + #712#2; |QBF aAlfa;
          #labcerm1#13 = aAlfa;
          #labcerm1#14 = #712#3;
          #labcerm1#15 = "";
          #labcerm1#16 = #712#16;
          #labcerm1#17 = #712#10;
          #labcerm1#18 = #712#11;
          aCodPos = (("00" + #712#4) % -102) + (("000" + #712#5) % -103);
          #labcerm1#19 = aCodPos;
          #labcerm1#20 = #712#6;
          #labcerm1#21 = #712#7;
          #labcerm1#22 = #712#13;
          |PARA nCampo = 3; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
               |PINTA #labcerm1#nCampo#;
          |SIGUE;
     |FINSI;
     |CIERRA #labtraba;
|FPRC;

|PROCESO SegundoProgenitor;
     #labcerm1#23 = #agidanif#9;
     #labcerm1#24 = #agidanif#10;
     #labcerm1#25 = #agidanif#11;
     #labcerm1#26 = #agidanif#13;
     #labcerm1#27 = "";
     |SI #labcerm1#7 = "H";
          #labcerm1#27 = "M";
     |FINSI;
     |SI #labcerm1#7 = "M";
          #labcerm1#27 = "H";
     |FINSI;
     #labcerm1#28 = "";
     #labcerm1#29 = "";
     #labcerm1#30 = #agidanif#8;
     #labcerm1#31 = #agidanif#34;
     #labcerm1#32 = #agidanif#35;

     aAlfa = #agidanif#24; |QBF aAlfa; aAlfa = aAlfa + " ";
     aAlfa = aAlfa + #agidanif#25; |QBF aAlfa;
     #labcerm1#33 = aAlfa;
     #labcerm1#34 = #agidanif#26;
     #labcerm1#35 = "";
     #labcerm1#36 = #agidanif#27;
     #labcerm1#37 = #agidanif#28;
     #labcerm1#38 = #agidanif#29;
     aCodPos = (("00" + #agidanif#30) % -102) + (("000" + #agidanif#31) % -103);
     #labcerm1#39 = aCodPos;
     #labcerm1#40 = #agidanif#32;
     #labcerm1#41 = #agidanif#33;

     |SI #agidanif#20 = "S";
          #labcerm1#42 = "ESPA¥A";
     |SINO;
          eaCodNif = #labcerm1#30;
          |HAZ LeeNifs;
          |SI eswNif = 0;
               #labcerm1#42 = #712#13;
          |SINO;
               #labcerm1#42 = "";
          |FINSI;
     |FINSI;
     |PARA nCampo = 23; |SI nCampo [ 42; |HACIENDO nCampo = nCampo + 1;
          |PINTA #labcerm1#nCampo#;
     |SIGUE;
|FPRC;

|PROCESO BuscaConyuge; |TIPO 7;
     swLeido = 0;
     aTipo = "CONYUGE     ";
     |HAZ agidanif;
     |SI swLeido = 1;
          aAlfa = #labcerm1#30;
          |QBF aAlfa;
          |SI aAlfa = "";
               aAlfa = "    ATENCION. Los datos del cónyuge existen en el registro ";
               aAlfa = aAlfa + "general de NIFs";
               |MENAV aAlfa;
               aAlfa = "    S¿Desea usar estos datos como los del segundo progenitor?";
               |CONFI aAlfa;
               |SI FSalida = 0;
                    |HAZ SegundoProgenitor;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Segundo;
     |SI FSalida = 13;
          swLeido = 0;
          aTipo = "CONYUGE     ";
          |HAZ agidanif;
          |SI swLeido = 1;
               aAlfa = "    ATENCION. Los datos del cónyuge existen en el registro ";
               aAlfa = aAlfa + "general de NIFs";
               |MENAV aAlfa;
               aAlfa = "    S¿Desea usar estos datos como los del segundo progenitor?";
               |CONFI aAlfa;
               |SI FSalida = 0;
                    |HAZ SegundoProgenitor;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PintaLoc1_m1; |TIPO 7;
     aAntLoc = #labcerm1#Campo#;
|FPRC;

|PROCESO PintaLoc2_m1;
     enPintaLoc = 0;
     |SI #labcerm1#Campo# ! aAntLoc;
          enPintaLoc = 1;
     |FINSI;
|FPRC;

|PROCESO NIF_m1;
     |SI FSalida = 10;
          eaVarDni = #0Campo;
          enCalcCif = 1;
          |HAZ CalculoDNI;
          #0Campo = eaVarDni;
          |PINTA #0Campo;
          |ERROR;
          |ACABA;
     |FINSI;

     eaVarDni = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;
     |SI Campo = 26;
          eaVarDni = (eaVarDni + "               ") % 115;
     |SINO;
          eaVarDni = (eaVarDni + "             ") % 112;
     |FINSI;
     |SI #0Campo ! eaVarDni;
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;
/*
     modo = (FEntrada / 100) ! 0;
     alfa1 = #0Campo;
     |QBT alfa1;

     |SI alfa1 = ""; |Y modo ! 4;
         |MENAV "    AVISO !!! Trabajador sin D.N.I. ...";
         |ERROR;
     |FINSI;
*/
|FPRC;

|PROCESO trunca2_m1;
     corta = 0;
     alfa1 = nume2;  alfa2 = alfa1 % 0;  nume3 = alfa2;
     |PARA jg = nume3; |SI jg ] 1;|Y corta = 0; |HACIENDO jg = jg - 1;
          sitio = (jg * 100) + 1;
          alfa2 = alfa1 % sitio;
          |SI alfa2 = ".";  corta = jg;  |FINSI;
     |SIGUE;
     |SI corta ! 0;
          sitio = 100 + corta - 1;
          alfa1 = alfa1 % sitio;
     |FINSI;
     nume3 = alfa1;
     nume1 = nume1 - (nume3 * 97);
|FPRC;

|PROCESO NAFSS_m1; |TIPO 0;
     nCampo = Campo - 1;
     aNAFSS = #0nCampo + #0Campo;
     |QBF aNAFSS;
     aAlfa = aNAFSS % 0;
     nNume = aAlfa;
     aAlfa = "    ATENCION. El número de afiliación a la Seg. Social ";
     aAlfa = aAlfa + "no puede exceder de 12 dígitos."
     |SI nNume > 12;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;

     |SI FSalida = 5;|O FSalida = 4;    |ACABA;   |FINSI;

     |SI FSalida = 9;
          alfa1 = aNAFSS;
          |QBF alfa1;

          aAlfa = alfa1 % 0;            || si mide mas de 10 digitos y me piden
          nNume = aAlfa;                || que calcule el digito de control
     |SI nNume > 10;               || quito el que me hubieran introducido
          alfa1 = alfa1 % 110;
          aNAFSS = alfa1;
     |FINSI;

        alfa2 = alfa1 % 102; alfa3 = alfa1 % -108;
        alfa4 = alfa3 % 101;
    |SI alfa4 = "0";
            alfa3 = alfa3 % 207;
            alfa1 = alfa2 + alfa3;
    |FINSI;
        nume1 = alfa1;
        nume2 = nume1 / 97;
    |HAZ trunca2_m1;
    |SI nume1 ] 0; |Y nume1 [ 99;
            alfa1 = aNAFSS;
        |QBF alfa1;
            alfa2 = nume1;
            alfa2 = "00" + alfa2;
            alfa2 = alfa2 % -102;
            alfa1 = alfa1 + alfa2;
            #0Campo = alfa1 % -110;
        |PINTA #0Campo;
    |FINSI;
|FINSI;
|FPRC;
