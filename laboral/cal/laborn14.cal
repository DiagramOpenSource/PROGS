|FICHEROS;
     laborn14 #0;
     laborn04;
     labempre;
     labtrtra;
     labtraba;
     nomcontr;
     nomconli;
     nomhicca;
     laborn90;
     labcontr;
     nompmail;

     temp0001@;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aParam = "";
     &eaUsuario = "";
     &eaFecha = "";
     &eaHora = "";
     nCampo = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo10 = 0;
     nCampo11 = 0;
     aHora = "";
     nEmp = 0;
     nTra = 0;
     fFecha = @;
     nNume = 0;
     bisiesto = 0;
     topemes = 0;
     nModo = 0;
     nPos1 = 0;
     nPos2 = 0;
     nCampoIT = 0;

     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     nume5 = 0;
     nume6 = 0;
     nDiasBaja = 0;
     aAlfa3 = "";
     swSigue = 0;
     swStop = 0;
     nDiasAcum = 0;
     nDesde = 0;
     nHasta = 0;
     nMesB = 0;
     nAny = 0;
     nAnyB = 0;
     nCampoTB = 0;
     nCampoHB = 0;
     nCampoFB = 0;
     nCampoDB = 0;
     aTipoBaja = "";
     aFecha = "";
     nCampoT = 0;
     nCampoD = 0;
     nCampoH = 0;
     aDia = "";
     nDia = 0;
     nMes = 0;
     aMes = "";
     aAny = "";
     swBajaInicial = 0;
     aMensaje = "";
     aNif = "";
     fec = "";
     sw = 0;
     dia1 = "";
     mes1 = "";
     any1 = "";
     dia = 0;
     mes = 0;
     any = 0;
     tope = 0;
     mod = 0;
     &eaEmpresa = "";
     &eaTrabajador = "";
     &eaAccion = "";

     nEmpresas = 0;
     nCodEmp = 0;
     aNomEmp = "";
     swLaborbox = 0;

     numer = 0;
     anynum = 0;
     mesnum = 0;
     nDiaRecaida = 0;
     nMesRecaida = 0;
     nAnyRecaida = 0;
     swBajaEnCurso = 0;
     fFechaHoy = @;
     nMesDesde = 0;
     nMesHasta = 0;
     nAnyHasta = 0;
     nCampoRecSiNo = 0;
     nCampoFechaRec = 0;
     nPan = 0;

     &eaQueEs            = "";
|FIN;

/****************** PROCESOS ADAPTADOS DEL NOMVARCA *************************/
/******************  PARA EL CALCULO DE LA RECAIDA  *************************/

|PROCESO ITMesActual;
     nume4 = (((Campo - 102) / 3) * 5) + 9;
     aAlfa1 = #laborn14#nume4#;        || tipo IT que estoy introduciendo
     aAlfa2 = #laborn14#Campo# % 102;
     nume5 = aAlfa2;          || dia inicio IT recaida
     aAlfa3 = #laborn14#Campo# % 402;
     nume6 = aAlfa3;          || mes inicio IT recaida
     nDiasBaja = 0;

     nume4 = Campo - 35;
     nume4 = (((Campo - 102) / 3) * 5) + 7;
     |PARA nume1 = 12; |SI nume1 < nume4; |HACIENDO nume1 = nume1 + 1;
          nume2 = nume1 + 1;
          nume3 = nume1 + 2;
          swSigue = 0;
          |SI #laborn14#nume3# = aAlfa1; |Y #laborn14#nume1# = nume1; |Y #laborn14#2 = nume6;
               swSigue = 1;
          |FINSI;
          |SI #laborn14#nume3# = aAlfa1; |Y #laborn14#nume1# = 0; |Y nDiasAcum ! 0;
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1;
               |SI #laborn14#nume1# = 0;
                    nDesde = 1;
               |SINO;
                    nDesde = #laborn14#nume1#;
               |FINSI;
               |SI #laborn14#nume2# = 0;
                    nHasta = topemes;
               |SINO;
                    nHasta = #laborn14#nume2#;
               |FINSI;
               nDiasBaja = nDiasBaja + (nHasta - nDesde);
               |SI #laborn14#nume1# = 0; |Y #laborn14#nume2# = 1;
               |SINO;
                    nDiasBaja = nDiasBaja + 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
     bisiesto = 0;
     numer = anynum $ 4;
     |SI numer = 0;
          bisiesto = 1;
     |FINSI;
     topemes = 31;
     |SI mesnum= 2;
          topemes = 28 + bisiesto;
     |FINSI;
     |SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO CuantosDias;
     mesnum = nMes;
     anynum = nAny + 2000;
     |HAZ ulti_dia;
     |SI nDesde = 0;
          nDesde = 1;
     |FINSI;
     |SI nHasta = 0;
          nHasta = topemes;
     |FINSI;
|FPRC;

|PROCESO BuscaReca;
     aFecha = #laborn14#Campo#;
     |QBF aFecha;
     |SI aFecha = "";
          |ACABA;
     |FINSI;

     |ABRE #nomhicca;
     aDia = aFecha % 102;
     nDiaRecaida = aDia;
     aMes = aFecha % 402;
     nMesRecaida = aMes;
     aAny = aFecha % -104;
     nAnyRecaida = aAny;
     nAnyB = 0;
     nMesB = 0;
     swBajaEnCurso = 0;

     fFechaHoy = ~;
     aAlfa = fFechaHoy;
     aAlfa = aAlfa % -104;

     nMesDesde = 0;
     nMesHasta = 0;
     nAnyHasta = aAlfa;

     |PARA nAny = nAnyRecaida; |SI nAny [ nAnyHasta; |HACIENDO nAny = nAny + 1;
          |SI nAny < nAnyHasta;       || una IT del a¤o anterior
               |SI nAny = nAnyRecaida;
                    nMesDesde = nMesRecaida;
                    nMesHasta = 12;
               |SINO;
                    nMesDesde = 1;
                    nMesHasta = 12;
               |FINSI;
          |SINO;
               |SI nAnyRecaida = nAnyHasta;
                    nMesDesde = nMesRecaida;
                    nMesHasta = #laborn14#7;
               |SINO;
                    nMesDesde = 1;
                    nMesHasta = #laborn14#7;
               |FINSI;
          |FINSI;

          |PARA nMes = nMesDesde; |SI nMes [ nMesHasta; |HACIENDO nMes = nMes + 1;
               #nomhicca#0 = #labtraba#0;
               #nomhicca#1 = #labtraba#1;
               #nomhicca#2 = nMes;
               #nomhicca#3 = 0;
               #nomhicca#66 = nAny - 2000;
               |LEE 000#nomhicca.=;
               |SI FSalida = 0;
                    |PARA nCampoT = 27; |SI nCampoT [ 30; |HACIENDO nCampoT = nCampoT + 1;
                         nCampo = (((Campo - 102) / 3) * 5) + 9;
                         |SI #nomhicca#nCampoT# = #laborn14#nCampo#;
                              || es el mismo tipo de IT

                              nCampoD = nCampoT - 8;
                              nCampoH = nCampoT - 4;
                              nCampoRecSiNo = nCampoT + 107;
                              nCampoFechaRec = nCampoT + 112;
                              |SI nDiaRecaida = #nomhicca#nCampoD#;
                              |Y nMesRecaida = #nomhicca#2;
                                   || esta es la IT INICIAL
                                   || a ver cuantos dias fueron
                                   nDesde = #nomhicca#nCampoD#;
                                   nHasta = #nomhicca#nCampoH#;
                                   |HAZ CuantosDias;
                                   nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);

                                   aTipoBaja = #nomhicca#nCampoT#;

                                   |SI #nomhicca#nCampoH# = 0;
                                        swBajaEnCurso = 1;
                                   |SINO;
                                        swBajaEnCurso = 0;
                                   |FINSI;
                              |SINO;
                                   || compruebo todas la IT que hayan sido
                                   || recaida con la misma fecha inicial
                                   |SI #nomhicca#nCampoRecSiNo# = "S";
                                   |Y #nomhicca#nCampoFechaRec# = aFecha;
                                        nDesde = #nomhicca#nCampoD#;
                                        nHasta = #nomhicca#nCampoH#;
                                        nNume = nMes + 1;
                                        |SI nNume = 13;
                                             nNume = 1;
                                        |FINSI;
                                        |SI nHasta = 0; |Y nNume = #0#2;
                                             || no me lo acumules, ya que es la IT
                                             || del mes anterior que continua en
                                             || este, los dias ya me vienen en
                                             || el campo acumulado del labtraba
                                        |SINO;
                                             |HAZ CuantosDias;
                                             nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);
                                        |FINSI;
                                   |SINO;
                                        |SI #nomhicca#nCampoD# = 0; |Y swBajaEnCurso = 1;
                                             nDesde = #nomhicca#nCampoD#;
                                             nHasta = #nomhicca#nCampoH#;
                                             |HAZ CuantosDias;
                                             nDiasAcum = nDiasAcum + (nHasta - nDesde + 1);
                                             |SI #nomhicca#nCampoH# = 0;
                                                  swBajaEnCurso = 1;
                                             |SINO;
                                                  swBajaEnCurso = 0;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |SIGUE;
     |SIGUE;
     |CIERRA #nomhicca;
|FPRC;

/*
|PROCESO BuscaReca;
     aFecha = #laborn14#Campo#;
     |QBF aFecha;
     |SI aFecha = "";
          |ACABA;
     |FINSI;
     |ABRE #nomhicca;
     aDia = #laborn14#Campo# % 102;
     nDia = aDia;
     aMes = #laborn14#Campo# % 402;
     nMes = aMes;
     aAny = #laborn14#Campo# % -104;
     nAny = aAny;
     nAnyB = 0;
     nMesB = 0;

     #nomhicca#0 = #laborn14#5;
     #nomhicca#1 = #labtraba#1;
     #nomhicca#2 = nMes;
     #nomhicca#3 = 0;
     #nomhicca#66 = nAny - 2000;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          |PARA nCampoT = 27; |SI nCampoT [ 30; |HACIENDO nCampoT = nCampoT + 1;
               |SI #nomhicca#nCampoT# = #laborn14#nCampo#;
                    nCampoD = nCampoT - 8;
                    nCampoH = nCampoT - 4;
                    |SI nDia = #nomhicca#nCampoD#;
                         |SI #nomhicca#nCampoT# = "E";
                              nDiasAcum = #nomhicca#31;
                         |FINSI;
                         |SI #nomhicca#nCampoT# = "A";
                              nDiasAcum = #nomhicca#32;
                         |FINSI;
                         aTipoBaja = #nomhicca#nCampoT#;
                         #laborn14#141 = #nomhicca#35;
                         #laborn14#142 = #nomhicca#36;
                         |PINTA #laborn14#141;
                         |PINTA #laborn14#142;
                         || busca cuanto dura la baja
                         |HAZ BuscaFinIT;
                         |SI swBajaInicial = 0;
                              swBajaInicial = 1;
                              aMensaje = "    Se tendrá en cuenta la base de";
                              aMensaje = aMensaje + " cotización y los días acumulados del proceso inicial";
                              aMensaje = aMensaje + " de baja";
                              |MENAV aMensaje;
                         |FINSI;
                         ||SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #nomhicca;
|FPRC;
*/
|DEFBUCLE BuscaReca;
     #labtraba#7;
     ;
     aNif, #laborn14#5, 00001;
     aNif, #laborn14#5, 99999;
     ;
     NULL, BuscaReca;
|FIN;

|PROCESO PromReca;
     nCampo = Campo;
     nCampo = nCampo - 1;
     |SI #laborn14#nCampo# = "S";
          |ABRE #labtraba;
          #labtraba#0 = #laborn14#5;
          #labtraba#1 = #laborn14#6;
          |LEE 000#labtraba.=;
          |SI FSalida = 0;
               ||nCampo = (((Campo - 102) / 3) * 5) + 9;
               aAlfa = #laborn14#Campo#;
               aAlfa = aAlfa % 402;
               nMesRecaida = aAlfa;

               |SI nMesRecaida = #0#7;
                    || parece ser una recaida de una enfermedad que ha empezado
                    || este mismo mes

                    || nCampo = (((Campo - 102) / 3) * 5) + 9;
                    aAlfa = #laborn14#Campo#;
                    aAlfa = aAlfa % 102;
                    nDiaRecaida = aAlfa;

                    |PARA nume1 = 14; |SI nume1 [ 29; |HACIENDO nume1 = nume1 + 5;
                         nume2 = nume1 - 2;  || IT desde dia
                         nume3 = nume1 - 1;  || IT hasta dia
                         |SI #laborn14#nume1# ! " "; |Y nDiaRecaida = #laborn14#nume2#;
                              || esta es la IT inicial de este mes
                              nDiasAcum = #0nume3 - #0nume2 + 1;
                         |FINSI;
                    |SIGUE;
               |SINO;
                    swBajaInicial = 0;
                    nDiasAcum = 0;
                    aNif = #labtraba#7;
                    nCampo = (((Campo - 102) / 3) * 5) + 9;
                    |BUCLE BuscaReca;
               |FINSI;

               |SI nDiasAcum > 0;
                    swBajaInicial = 1;
/*
                    aMensaje = "    Se tendrán en cuenta";
                    aMensaje = aMensaje + " los días acumulados del proceso inicial";
                    aMensaje = aMensaje + " de baja";
                    |MENAV aMensaje;
*/
                    #laborn14#143 = nDiasAcum;
                    |PINTA #laborn14#143;
               |SINO;
                    aMensaje = "    ATENCION: No se ha encontrado en el Historico ";
                    aMensaje = aMensaje + "el proceso inicial de baja en la fecha indicada";
                    |MENAV aMensaje;
                    #laborn14#141 = 0;
                    #laborn14#142 = 0;
                    #laborn14#143 = 0;
                    |PINTA #laborn14#141;
                    |PINTA #laborn14#142;
                    |PINTA #laborn14#143;
               |FINSI;
          |FINSI;
          |CIERRA #labtraba;
/*
|| lo de antes
          |ABRE #labtraba;
          #labtraba#0 = #laborn14#5;
          #labtraba#1 = #laborn14#6;
          |LEE 000#labtraba.=;
          |SI FSalida = 0;
               swBajaInicial = 0;
               nDiasAcum = 0;
               aNif = #labtraba#7;
               nCampo = (((Campo - 102) / 3) * 5) + 9;
               |BUCLE BuscaReca;
               |HAZ ITMesActual;
               |SI swBajaInicial = 0; |Y nDiasBaja = 0;
                    aMensaje = "    ATENCION: No se ha encontrado en el Historico ";
                    aMensaje = aMensaje + "el proceso inicial de baja en la fecha indicada";
                    |MENAV aMensaje;
                    #laborn14#141 = 0;
                    #laborn14#142 = 0;
                    #laborn14#143 = 0;
                    |PINTA #laborn14#141;
                    |PINTA #laborn14#142;
                    |PINTA #laborn14#143;
               |FINSI;
               #laborn14#143 = nDiasAcum + nDiasBaja;
               |PINTA #laborn14#143;
          |FINSI;
          |CIERRA #labtraba;
*/
     |FINSI;
|FPRC;

/******************** FIN PROCESOS CALCULO RECAIDAS *************************/

|PROCESO ComentAnt;
     |SI swLaborbox = 1; |ACABA; |FINSI;

     || comentario Anticipos - 1 -
     aAlfa = #labempre#61;
     |QBT aAlfa;
     |SI aAlfa = ""; |O aAlfa = "nticipos";
          #laborn14#133 = "Anticipos";
     |SINO;
          #laborn14#133 = #labempre#61;
     |FINSI;
     |PINTA #laborn14#133;

     || comentario Anticipos - 2 -
     aAlfa = #labempre#62;
     |QBT aAlfa;
     |SI aAlfa = ""; |O aAlfa = "nticipos";
          #laborn14#135 = "Anticipos";
     |SINO;
          #laborn14#135 = #labempre#62;
     |FINSI;
     |PINTA #laborn14#135;

     || comentario Anticipos - 3 -
     aAlfa = #labempre#63;
     |QBT aAlfa;
     |SI aAlfa = ""; |O aAlfa = "nticipos";
          #laborn14#137 = "Anticipos";
     |SINO;
          #laborn14#137 = #labempre#63;
     |FINSI;
     |PINTA #laborn14#137;
|FPRC;

|PROCESO verifec1; |TIPO 0;
     fec = #laborn14#Campo#;
     sw = 0;
     |QBF fec
     |SI fec ! "";
          dia1 = fec % A102;
          mes1 = fec % A402;
          any1 = fec % A704;
          dia = dia1; mes = mes1; any = any1;
          |SI dia ! 0; |Y mes ! 0; |Y any ! 0;
               |SI mes [ 12; |Y mes ] 1;
                    |SI mes = 1; |O mes = 3; |O mes = 5; |O mes = 7; |O mes = 8; |O mes = 10; |O mes = 12;
                         tope = 31;
                    |SINO;
                         |SI mes = 2;
                              mod = any $ 4;
                              |SI mod = 0;
                                   tope = 29;
                              |SINO;
                                   tope = 28;
                              |FINSI;
                         |SINO;
                              tope = 30;
                         |FINSI;
                    |FINSI;
                    |SI dia [ tope;
                         sw = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          sw = 1;
     |FINSI;
     |SI sw = 0;
          |MENAV " ATENCION: la fecha introducida no es válida";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO ActDesHos; |TIPO 7;
     nCampoIT = (((Campo - 100) / 3) * 5) + 9;
     nCampo = Campo;
     nCampo1 = nCampo + 1;
     nCampo2 = nCampo + 2;

     |SI #laborn14#nCampoIT# = "E"; |O #laborn14#nCampoIT# = "A";
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "S";
          |CAMPO_MODIFICA #laborn14#nCampo1#, 1, "S";
          |CAMPO_MODIFICA #laborn14#nCampo2#, 1, "S";
     |SINO;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "N";
          |CAMPO_MODIFICA #laborn14#nCampo1#, 1, "N";
          |CAMPO_MODIFICA #laborn14#nCampo2#, 1, "N";
          #laborn14#nCampo# = "N";
          #laborn14#nCampo1# = "N";
          #laborn14#nCampo2# = "";
          |PINTA #laborn14#nCampo#;
          |PINTA #laborn14#nCampo1#;
          |PINTA #laborn14#nCampo2#;
     |FINSI;
|FPRC;

|PROCESO ActDesFec; |TIPO 7;
      nCampo = Campo;
      nCampo1 = nCampo - 1;
      |SI #laborn14#nCampo1# = "S";
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "S";
      |SINO;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "N";
          #laborn14#nCampo# = "";
          |PINTA #laborn14#nCampo#;
      |FINSI;
|FPRC;

|PROCESO ActDesHor; |TIPO 7;
     nCampo1 = Campo - 2;
     |SI #laborn14#nCampo1# = "F"; |O #laborn14#nCampo1# = "V"; |O #laborn14#nCampo1# = "H";
          |CAMPO_MODIFICA #laborn14#Campo#, 1, "S";
     |SINO;
          |CAMPO_MODIFICA #laborn14#Campo#, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Comprueba; |TIPO 0;
     |SI #laborn14#Campo# = 0;
          nCampo = Campo + 2;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "N";
          nCampo = Campo + 3;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "N";
          |ACABA;
     |SINO;
          nCampo = Campo + 2;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "S";
          nCampo = Campo + 3;
          |CAMPO_MODIFICA #laborn14#nCampo#, 1, "S";
     |FINSI;
     nCampo1 = Campo + 1;
     |ABRE #nomconli;
     #nomconli#0 = #labtraba#87;
     #nomconli#2 = #laborn14#Campo#;
     |LEE 000#nomconli.=;
     |SI FSalida = 0;
          #laborn14#nCampo1# = #nomconli#6;
          |PINTA #laborn14#nCampo1#;
     |SINO;
          aAlfa = "    ATENCION: Concepto no Definido en convenio. Pulse F5 ";
          aAlfa = aAlfa + "para consultar.";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
     |CIERRA #nomconli;
|FPRC;

|PROCESO BuscaCon; |TIPO 0;
     |SI FSalida = 13;
          aAlfa = "SELECT nomconli.2,nomconli.6 FROM nomconli INTO tm" + Usuario;
          aAlfa = aAlfa + ".def WHERE 0 == " + #labtraba#87;
          |SQL aAlfa;
          |SI FSalida ! 0;
               |MENAV "    No hay definidos conceptos en el convenio";
               |ERROR;
               |ACABA;
          |FINSI;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
          |CARGA_DEF aAlfa , temp0001@;
          |SI FSalida = 0;
               aAlfa = "tm" + Usuario; |NOME_DAT #temp0001@#aAlfa#;
               |ABRE #temp0001@;
               nModo = 2 + 4 + 8 + 16;
               nPos1 = 1250; nPos2 = 2380;
               |C_V #temp0001@#0, 1, "S";
               |C_V #temp0001@#1, 1, "S";
               |LINEAL_SIMPLE #1#temp0001@,nModo, nPos1, nPos2, NULL, NULL, NULL;
               |SI FSalida = 0;
                    nCampo1 = Campo + 1;
                    #laborn14#Campo# = #temp0001@#0;
                    |PINTA #laborn14#Campo#;
                    #laborn14#nCampo1# = #temp0001@#1;
                    |PINTA #laborn14#nCampo1#;
               |SINO;
                    |ERROR;
               |FINSI;
               |CIERRA #temp0001@;
               |DELINDEX #temp0001@;
               |DESCARGA_DEF #temp0001@;
          |FINSI;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
          |FBORRA aAlfa;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO ActDesReca; |TIPO 7;
     |CAMPO_MODIFICA #laborn14#Campo#, 1, "N";
     |PARA nCampo = 104; |SI nCampo [ 131; |HACIENDO nCampo = nCampo + 3;
          |SI #laborn14#nCampo# = "S";
               |CAMPO_MODIFICA #laborn14#Campo#, 1, "S";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TopeMes;
     |SI #laborn14#Campo# > topemes;
          aAlfa1 = topemes;
          aAlfa = "    ATENCION: el día final de la incidencia supera el ";
          aAlfa = aAlfa + "tope del mes: " + aAlfa1;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
     nCampo1 = Campo - 1;
     |SI #laborn14#Campo# < #laborn14#nCampo1#; |Y #laborn14#Campo# ! 0;
          aAlfa = "ATENCION: el día final de la incidencia no puede ser ";
          aAlfa = aAlfa + "menos que el día de inicio";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Mayus;
     |SI #0Campo ! " ";
     |Y #0Campo ! "E"; |Y #0Campo ! "A"; |Y #0Campo ! "M"; |Y #0Campo ! "P";
     |Y #0Campo ! "R"; |Y #0Campo ! "C"; |Y #0Campo ! "D"; |Y #0Campo ! "H";
     |Y #0Campo ! "F"; |Y #0Campo ! "V"; |Y #0Campo ! "S";
          #0Campo = " ";
          |PINTA #0Campo;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo;
     nCampo1 = Campo - 2;
     nCampo2 = Campo - 1;
     |SI #laborn14#nCampo1# ! 0; |O #laborn14#nCampo2# ! 0;
          |SI #laborn14#Campo# = " ";
               aAlfa = "    ATENCION: ha de rellenar el tipo de incidencia";
               |MENAV aAlfa;
               |SI FSalida ! 2;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI Campo = 14;
          |SI #laborn14#8 ! " ";
               |SI #laborn14#Campo# ! #laborn14#8;
                    |SI #laborn14#Campo# ! " ";
                         aAlfa = "    ATENCION: la primera línea tiene que finalizar la ";
                         aAlfa = aAlfa + "incidencia acumulada antes de iniciar otra";
                         |MENAV aAlfa;
                         |SI FSalida ! 2;
                              |ERROR;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI #laborn14#nCampo1# ! 0;
                         #laborn14#nCampo1# = 0;
                         |PINTA #laborn14#nCampo1#;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PintaMes;
     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;
     bisiesto = 0;
     nNume = nAny $ 4;
     |SI nNume = 0;
          bisiesto = 1;
     |FINSI;

     |SI #laborn14#7 = 1;  aAlfa = "ENERO     "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 2;  aAlfa = "FEBRERO   "; topemes = 28 + bisiesto; |FINSI;
     |SI #laborn14#7 = 3;  aAlfa = "MARZO     "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 4;  aAlfa = "ABRIL     "; topemes = 30; |FINSI;
     |SI #laborn14#7 = 5;  aAlfa = "MAYO      "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 6;  aAlfa = "JUNIO     "; topemes = 30; |FINSI;
     |SI #laborn14#7 = 7;  aAlfa = "JULIO     "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 8;  aAlfa = "AGOSTO    "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 9;  aAlfa = "SEPTIEMBRE"; topemes = 30; |FINSI;
     |SI #laborn14#7 = 10; aAlfa = "OCTUBRE   "; topemes = 31; |FINSI;
     |SI #laborn14#7 = 11; aAlfa = "NOVIEMBRE "; topemes = 30; |FINSI;
     |SI #laborn14#7 = 12; aAlfa = "DICIEMBRE "; topemes = 31; |FINSI;

     |ATRI I;
     |PINTA 0923, aAlfa;
     |ATRI 0;
|FPRC;

|PROCESO labtraba;
     |PARA nCampo = 0; |SI nCampo [ 253; |HACIENDO nCampo = nCampo + 1;
          #labtrtra#nCampo# = #labtraba#nCampo#;
     |SIGUE;
     |GRABA 020#labtrtra.n;
     |LIBERA #labtrtra;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44;
     #laborn14#5, 00001, "A";
     #laborn14#5, 99999, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO CargaTra;
     |SI swLaborbox = 1; |ACABA; |FINSI;

     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |DELINDEX #labtrtra;
     |ABRE #labtrtra;
     |BUCLE labtraba;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO ConsultaTra; |TIPO 66;
     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |ABRE #labtrtra;
     |LEE 000#labtrtra.p;
     |CONSULTA_CLAVE #1#labtrtra;
     |SI FSalida = 0;
          #laborn14#Campo# = #labtrtra#1;
     |FINSI;
     |PINTA #laborn14#Campo#;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO Defectos; |TIPO 7;
     |SI aParam = "MODIF"; |ACABA; |FINSI;
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 402;
     #laborn14#7 = aAlfa;
     |PINTA #laborn14#7;
     aAlfa = fFecha;
     aAlfa = aAlfa % -104;
     nAny = aAlfa;
     #laborn14#102 = nAny;
     |PINTA #laborn14#102;
     |HAZ PintaMes;
|FPRC;

|PROCESO Arrastre;
     #laborn14#8 = "";
     #laborn14#9 = "";
     #laborn14#10 = 0;
     #laborn14#11 = "";
     |PINTA #laborn14#8;
     |PINTA #laborn14#9;
     |PINTA #laborn14#10;
     |PINTA #laborn14#11;


     |ABRE #labtraba;
     #labtraba#0 = #laborn14#5;
     #labtraba#1 = #laborn14#6;
     |LEE 000#labtraba.=;
     |SI #labtraba#89 ! 0;
          #laborn14#8 = #labtraba#60;
          #laborn14#10 = #labtraba#89;
          #laborn14#11 = #labtraba#125;
     |FINSI;
     |SI #labtraba#92 ! 0;
          #laborn14#8 = "A";
          #laborn14#10 = #labtraba#92;
          #laborn14#11 = #labtraba#125;
     |FINSI;
     nCampo = 8;
     |HAZ PintaInc1;

     |PINTA #laborn14#8;
     |PINTA #laborn14#9;
     |PINTA #laborn14#10;
     |PINTA #laborn14#11;

     |CIERRA #labtraba;
|FPRC;

|PROCESO DatosTra;
/*
     || esto lo quito, si la base de cotizacion se queda a cero que coja la
     || que tenga el trabajador y si me viene algo, entonces lo machacare

     |SI swLaborbox ! 1;
          #laborn14#141 = #labtraba#95;
          #laborn14#142 = #labtraba#96;
          |PINTA #laborn14#141;
          |PINTA #laborn14#142;
     |FINSI;
*/
|FPRC;

|PROCESO ValidaTra;
     |SI #labtraba#44 = "B";
          |MENAV "    ATENCION: Trabajador en situación de baja";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO PintaInc1;
     nCampo1 = nCampo;
     nCampo2 = nCampo1 + 1;
     |SI #laborn14#nCampo1# = " "; #laborn14#nCampo2# = ""; |FINSI;
     |SI #laborn14#nCampo1# = "E"; #laborn14#nCampo2# = "Enfermedad"; |FINSI;
     |SI #laborn14#nCampo1# = "A"; #laborn14#nCampo2# = "Accidente "; |FINSI;
     |SI #laborn14#nCampo1# = "M"; #laborn14#nCampo2# = "Maternidad"; |FINSI;
     |SI #laborn14#nCampo1# = "P"; #laborn14#nCampo2# = "Paternidad"; |FINSI;
     |SI #laborn14#nCampo1# = "R"; #laborn14#nCampo2# = "Rie.Embar."; |FINSI;
     |SI #laborn14#nCampo1# = "F"; #laborn14#nCampo2# = "Absentismo"; |FINSI;
     |SI #laborn14#nCampo1# = "V"; #laborn14#nCampo2# = "Vacaciones"; |FINSI;
     |SI #laborn14#nCampo1# = "H"; #laborn14#nCampo2# = "Huelga    "; |FINSI;
     |SI #laborn14#nCampo1# = "S"; #laborn14#nCampo2# = "Alta S/Ret"; |FINSI;
     |SI #laborn14#nCampo1# = "D"; #laborn14#nCampo2# = "Exp.Reg.Em"; |FINSI;
     |SI #laborn14#nCampo1# = "C"; #laborn14#nCampo2# = "Ctrl.IT.SS"; |FINSI;
     |PINTA #laborn14#nCampo2#;
|FPRC;

|PROCESO PintaInc;
     nCampo = Campo;
     |HAZ PintaInc1;
|FPRC;

|PROCESO Proceso;
     |CLS;
     |PINPA #0#laborn14;
     |PINDA #0#laborn14;

     |ENDATOS #1#laborn14;
|FPRC;

|PROCESO Email;
     aAlfa = #laborn14#5; |QBF aAlfa;
     eaEmpresa = ("00000" + aAlfa) % -105;
     eaEmpresa = eaEmpresa + " - " + #labempre#2;

     aAlfa = #laborn14#6; |QBF aAlfa;
     eaTrabajador = ("00000" + aAlfa) % -105;
     eaTrabajador = eaTrabajador + " - " + #labtraba#2;

     eaAccion = "incidencia";

     |HAZ ConsEmail;
|FPRC;

|PROCESO labempre;
     nEmpresas = nEmpresas + 1;
     nCodEmp = #labempre#0;
     aNomEmp = #labempre#2;
|FPRC;

|DEFBUCLE labempre;
     #labempre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, labempre;
|FIN;

|PROCESO Empresas; |TIPO 7;
     |SI swLaborbox = 1; |ACABA; |FINSI;

     |ABRE #labempre;
     |BUCLE labempre;
     |CIERRA #labempre;

     |SI nEmpresas = 1;
          || tengo una unica empresa que elegir

          #laborn14#5 = nCodEmp;
          |CAMPO_MODIFICA #laborn14#5, 1, "N";
          |PINTA #laborn14#5;
     |FINSI;
|FPRC;

|PROCESO Impresion;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |SI #labcontr#84 ! "S";
          |ACABA;
     |FINSI;

     eaQueEs = "C";

     aAlfa = "*laborn10;X";
     aAlfa = aAlfa + "14";
     aAlfa = aAlfa + #laborn04#0;
     aAlfa = aAlfa + #laborn04#1;
     aAlfa1 = #laborn04#3;
     aAlfa = aAlfa + aAlfa1;
     aAlfa = aAlfa + #laborn04#4;
     aAlfa = aAlfa + "IMPRE";

     |MENSA "    Imprimiendo solicitud de incidencia";
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO Contador;
     |ABRE #laborn90;

     #laborn90#0 = #laborn04#5;
     #laborn90#1 = 99999;

     |LEE 000#laborn90.];
     |SI FSalida = 0;
          |SI #laborn90#0 ! #laborn04#5;
               |LEE 000#laborn90.a;
          |FINSI;
     |SINO;
          |LEE 000#laborn90.u;
     |FINSI;

     |SI FSalida = 0;
     |Y #laborn90#0 = #laborn04#5;
          nNume = #laborn90#1;

          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn04#5;
          #laborn90#1 = nNume + 1;

     |SINO;
          || es el primero de esta empresa !!!
          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn04#5;
          #laborn90#1 = 1;
     |FINSI;

     #laborn90#2 = "I";
     #laborn90#3 = "Incidencia";
     #laborn90#4 = #laborn04#1;
     #laborn90#5 = #laborn04#2;
     #laborn90#6 = #laborn04#3;
     #laborn90#7 = #laborn04#4;

     |GRABA 020#laborn90.n;

     #laborn04#150 = #laborn90#1;

     |LIBERA #laborn90;
     |CIERRA #laborn90;
|FPRC;

|PROGRAMA;
     |CLS;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa1#;
     |FINSI;

     |QBF eaUsuario;
     aAlfa1 = eaUsuario % 105;
     |SI eaUsuario = "WEB";
     |O aAlfa1 = "NUBEA";
          swLaborbox = 1;
     |FINSI;

     aParam = PARAMETRO;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ABRE #laborn04;
          |SI aParam = "MODIF";
               #laborn04#0 = "P";         || estado: pendiente, consulta/modificacion
          |FINSI;
          |SI aParam = "CONSUL";
               #laborn04#0 = "A";         || estado: actualizado, solo consulta
          |FINSI;
          #laborn04#1 = eaUsuario;
          #laborn04#2 = "";
          #laborn04#3 = eaFecha;
          #laborn04#4 = eaHora;
          |LEE 101#laborn04.=;

          |PARA nCampo = 0; |SI nCampo [ 146; |HACIENDO nCampo = nCampo + 1;
               #laborn14#nCampo# = #laborn04#nCampo#;
               |SI nCampo = 12; |O nCampo = 13; |O nCampo = 17; |O nCampo = 18;
               |O nCampo = 22; |O nCampo = 23; |O nCampo = 27; |O nCampo = 28;
                    |SI #laborn14#nCampo# = -1;
                         #laborn14#nCampo# = 0;
                    |FINSI;
               |FINSI;
          |SIGUE;

          #laborn14#147 = #laborn04#150;
          #laborn14#148 = #laborn04#147;
          #laborn14#149 = #laborn04#148;
          #laborn14#150 = #laborn04#149;
          |PARA nCampo = 151; |SI nCampo [ 177; |HACIENDO nCampo = nCampo + 1;
               #laborn14#nCampo# = #laborn04#nCampo#;
               |SI nCampo = 177;
                    || nro colegiado en blanco
                    aAlfa = #laborn14#nCampo#;
                    |QBF aAlfa;

                    aAlfa1 = aAlfa % 102;
                    |SI aAlfa1 = "No";
                         aAlfa = "00" + (aAlfa % 308);
                    |FINSI;
                    aAlfa1 = aAlfa % 302;
                    |SI aAlfa1 = "No";
                         aAlfa = (aAlfa % 102) + "00" + (aAlfa % 506);
                    |FINSI;
                    aAlfa1 = aAlfa % 502;
                    |SI aAlfa1 = "No";
                         aAlfa = (aAlfa % 104) + "000000";
                    |FINSI;

                    #laborn14#nCampo# = aAlfa;
               |FINSI;
          |SIGUE;

          |PINPA #0#laborn14;
          |PINDA #0#laborn14;

          |CAMPO_MODIFICA #laborn14#5, 1, "N";
          |CAMPO_MODIFICA #laborn14#6, 1, "N";
          |CAMPO_MODIFICA #laborn14#7, 1, "N";
          |HAZ PintaMes;
          |HAZ Arrastre;
          |CAMPO_MODIFICA #laborn14#102, 1, "N";

          |PARA nCampo10 = 104; |SI nCampo10 [ 113; |HACIENDO nCampo10 = nCampo10 + 3;
               nCampo11 = nCampo10 + 1;
               aAlfa = #laborn14#nCampo11#;
               |QBF aAlfa;
               |SI #laborn14#nCampo10# = "S"; |Y aAlfa ! "";
                    |SI #laborn04#143 = 0;
                         Campo = nCampo11;
                         |HAZ PromReca;
                         #laborn04#143 = #laborn14#143;
                         |GRABA 020#laborn04.a;
                         |LIBERA #laborn04;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |ABRE #labtraba;
          #labtraba#0 = #laborn14#5;
          #labtraba#1 = #laborn14#6;
          |LEE 000#labtraba.=;
          |CIERRA #labtraba;

          |SI aParam = "MODIF";
              |ENDATOS #1#laborn14;
          |FINSI;

          |SI aParam = "CONSUL";
               nPan = 0;
               |PARA; |SI; |HACIENDO;
                    |PAUSA;
                    |BLANCO 11012380;
                    |SI FSalida = 1;
                         |SAL;
                    |FINSI;
                    |SI FSalida = 4;
                         nPan = nPan - 1;
                    |FINSI;
                    |SI FSalida = 5;
                         nPan = nPan + 1;
                    |FINSI;
                    |SI nPan [ 1;
                         |PINPA #0#laborn14; |PINDA #0#laborn14;
                         nPan = 1;
                    |FINSI;
                    |SI nPan = 2;
                         |PINPA #1#laborn14; |PINDA #1#laborn14;
                         nPan = 2;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |SINO;
          |HAZ Proceso;
     |FINSI;
     |SI FSalida = 0;
          |SI aParam = "MODIF";
               |PARA nCampo = 0; |SI nCampo [ 146; |HACIENDO nCampo = nCampo + 1;
                    #laborn04#nCampo# = #laborn14#nCampo#;
               |SIGUE;
               #laborn04#150 = #laborn14#147;
               #laborn04#147 = #laborn14#148;
               #laborn04#148 = #laborn14#149;
               #laborn04#149 = #laborn14#150;
               |PARA nCampo = 151; |SI nCampo [ 177; |HACIENDO nCampo = nCampo + 1;
                    #laborn04#nCampo# = #laborn14#nCampo#;
               |SIGUE;
               |GRABA 020#laborn04.a;
          |SINO;
               |ABRE #laborn04;
               #laborn04#0 = "P";    || Estado: Pendiente
               #laborn04#1 = Usuario % 0810;     || Usuario
               #laborn04#2 = "";     || Perfiles, en principio no lo uso
               #laborn04#3 = ~;      || Fecha
               |HORA aHora;
               #laborn04#4 = aHora;  || Hora
               |PARA nCampo = 5; |SI nCampo [ 146; |HACIENDO nCampo = nCampo + 1;
                    #laborn04#nCampo# = #laborn14#nCampo#;
               |SIGUE;
               |PARA nCampo = 151; |SI nCampo [ 177; |HACIENDO nCampo = nCampo + 1;
                    #laborn04#nCampo# = #laborn14#nCampo#;
               |SIGUE;
               |HAZ Contador;
               |GRABA 020#laborn04.n;

               |HAZ Impresion;

               |ABRE #nompmail; |LEE 000#nompmail.p; |CIERRA #nompmail;
               |SI #nompmail#11 = "S";
                    |HAZ Email;
               |FINSI;
          |FINSI;

          |CIERRA #laborn04;
     |FINSI;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa2#;
     |FINSI;
|FPRO;
