|FICHEROS;
     cretai01 #0;

     labempre;
     labtraba;
     nomcalca;
     nomhicca;
     nomcalac;

     cretam03;
     cretam04;
     cretam06;

     gomdesjr;

     nompluri;
     nompluba;

     nomcot26;
     nomcot28;
     cretat14;
|FIN;

|VARIABLES;
     fFecha = @;
     aAlfa = "";
     nNume = 0;

     &aMes = "";
     &aMesLetra = "";
     &nMes = 0;
     nAnyXX = 0;

     &aFuente = "";
     nBruto = 0;
     nDeducciones = 0;

     &nBaseCC_Alta = 0;
     &nBaseATEP_Alta = 0;
     nBaseEnfAcc = 0;
     &nBaseMat = 0;
     &nBasePat = 0;
     &nBaseRie = 0;
     &nBaseCon = 0;
     &nBaseERE = 0;
     &nBaseHorasFM = 0;
     &nBaseHorasOt = 0;
     nBaseHorasComp = 0;
     &aSituacion = "";
     nCodigo = 0;
     nUltimoCodigo = 0;
     nUltima = 0;
     nBaseCC_Alta_Tra = 0;
     nBaseATEP_Alta_Tra = 0;
     nBaseEnfAcc_Tra = 0;

     nDiasEnf = 0;
     nDiasAcc = 0;
     nDiasMat = 0;
     nDiasPat = 0;
     nDiasRie = 0;
     nDiasCon = 0;
     nDiasERE = 0;
     aUltimaIT = "";
     nAjuste = 0;
     nDiasCotAlta = 0;
     nDiasCotIT = 0;
     &nPrestEnf = 0;
     &nPrestAcc = 0;
     nDiasCot = 0;
     nPromedioCC = 0;
     nPromedioATEP = 0;
     nDiasAlta = 0;
     nAny = 0;
     topemes = 0;
     nDiasMesTrab = 0;
     nCampo = 0;
     nCampo1 = 0;
     &nBaseEnfCC = 0;
     &nBaseEnfAE = 0;
     &nBaseAccCC = 0;
     &nBaseAccAE = 0;
     aTipoHorasFor = "";
     nNumHorasFor = 0;
     nume1 = 0;
     nume2 = 0;
     nEmp = 0;
     nTra = 0;
     fFechaAlta = @;
     aFechaAlta = "";
     fFechaBaja = @;
     aFechaBaja = "";
     aNAFSS = "";
     aAny = "";
     aAlfa1 = "";
     aAlfa2 = "";
     fFechaIniPer = @;
     fFechaFinPer = @;
     nNume1 = 0;
     nNume2 = 0;

     nAntEmp = 0;
     nAntTra = 0;

     &nTraCC = 0;    &nTraATEP = 0;
     &nTraEnfCC = 0; &nTraEnfAE = 0;
     &nTraAccCC = 0; &nTraAccAE = 0;
     &nTraMatCC = 0; &nTraMatAE = 0;
     &nTraPatCC = 0; &nTraPatAE = 0;
     &nTraRieCC = 0; &nTraRieAE = 0;
     &nTraConCC = 0; &nTraConAE = 0;
     &nTraERECC = 0; &nTraEREAE = 0;

     &nTraHorFM = 0;
     &nTraHorOtr = 0;
     &nTraHorCom = 0;
     &nTraPreEnf = 0;
     &nTraPreAcc = 0;

     &nDiferente = 0;
     swHayRegistros = 0;

     &aDesdeMes = "";
     &aHastaMes = "";

     nCampoA = 0;
     nCampoB = 0;
     nCampoAGR = 0;
     aTipo = "";
     swTP = 0;

     swAginom = 0;
     swIplabor2 = 0;
     nLin = 0;
     aDesde = "";
     nVeces = 0;
     aOtros = "";
     nPosicion = 0;
     nCorta = 0;
     aOtroCod = "";
     nOtroCod = 0;
     swLocalizado = 0;
     nBaseCC_Alta_Prov = 0;
     nBaseEnfAcc_Prov = 0;
     swPluriempleo = 0;

     nImporteMan = 0;
     nImporteTra = 0;
     aEste = "";
     nPos = 0;
     nCaptura = 0;
     aCodigo = "";
     aTrabajadores = "";
     nCampo2 = 0;
     nConcepto = 0;
     swNoSigas = 0;
     swEntraPrevio = 0;
     swHayTramos = 0;
     aNaf = "";
     &swOtrasDif = 0;
     &nEmpNE = 0;
     &aTraNE = "";
     nTramosSinBases = 0;
     swSigue = 0;
|FIN;

|PROCESO MesesCabecera;
     nMes = #0#5;
     |HAZ MesLetra_plb;
     aDesdeMes = aMes;

     |SI #0#6 ] 5; |Y #0#6 [ 20;
          nMes = #0#11;
          |HAZ MesLetra_plb;
          aHastaMes = aMes;
     |FINSI;
|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO AyudaTipos; |TIPO 7;
     |PUSHV 10552380;
     |ATRI R;
     ||            5    6         7         8
     ||            56789012345678901234567890
     |PINTA 1055, "       - Opciones -       ";
     |PINTA 1155, " 00 :Normal               ";
     |PINTA 1255, " 02 :Finiquitos           ";
     |PINTA 1355, "5-20:Atrasos              ";
     |PINTA 1455, " 90 :Complementarias      ";
     |PINTA 1555, "                          ";
     |PINTA 1655, "                          ";
     |ATRI 0;
|FPRC;

|PROCESO Defectos;
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % -104;
     nNume = aAlfa;
     #0#4 = nNume;
     |PINTA #0#4;

     aAlfa = fFecha;
     aAlfa = aAlfa % 402;
     nNume = aAlfa;
     #0#5 = nNume;
     |PINTA #0#5;
     |HAZ Mes;
|FPRC;

|PROCESO Mes;
     |SI 5 [ #0#6; |Y #0#6 [ 20;
          || atrasos, no
     |SINO;
          nMes = #0#5;
          |HAZ MesLetra_plb;
          |ATRI I;
          |PINTA 1442, aMes;
          |ATRI 0;
     |FINSI;
|FPRC;

|PROCESO Activa11;
     |SI 5 [ #0#6; |Y #0#6 [ 20;
          |CAMPO_MODIFICA #0#11, 1, "S";
          |CAMPO_VISUAL #0#11, 1, "S";
          |PINTA 1442, "-         ³";
          |PINTA #0#11;
     |SINO;
          |CAMPO_MODIFICA #0#11, 1, "N";
          |CAMPO_VISUAL #0#11, 1, "N";
          |PINTA 1442, "          ³";
          |HAZ Mes;
     |FINSI;

     |SI 5 [ #0#6; |Y #0#6 [ 20;
          |SI Campo = 6; |Y Contenido ! #0#6;
               #0#11 = #0#5;
               |PINTA #0#11;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Activa8;
     |SI #0#7 = "D";
          |CAMPO_MODIFICA #0#8, 1, "N";
          |CAMPO_VISUAL #0#8, 1, "N";
          |PINTA 1724, "³                           ³";
          |PINTA 1824, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";
          |PINTA 1924, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
     |SINO;
          |CAMPO_MODIFICA #0#8, 1, "S";
          |CAMPO_VISUAL #0#8, 1, "S";
          |PINTA 1724, "³ Comparativo:              ³";
          |PINTA 1824, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";
          |PINTA 1924, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
          |PINTA #0#8;
     |FINSI;
|FPRC;

|PROCESO topemes;     || halla el ultimo dia del mes
     nume2 = 0;
     nume1 = nAny $ 4;    || a¤o historico
     |SI nume1 = 0;
          nume2 = 1;
     |FINSI;
     topemes = 31;
     |SI nMes = 2;
          topemes = 28 + nume2;
     |FINSI;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO IniVarMan;
     nBaseCC_Alta = 0;
     nBaseATEP_Alta = 0;
     nBaseEnfAcc = 0;
     nBaseMat = 0;
     nBasePat = 0;
     nBaseRie = 0;
     nBaseCon = 0;
     nBaseERE = 0;
     nBaseHorasFM = 0;
     nBaseHorasOt = 0;
     nBaseHorasComp = 0;
     aSituacion = "";
     nCodigo = 0;
     nUltimoCodigo = 0;
     nBaseCC_Alta_Tra = 0;
     nBaseATEP_Alta_Tra = 0;
     nBaseEnfAcc_Tra = 0;

     nDiasEnf = 0;
     nDiasAcc = 0;
     nDiasMat = 0;
     nDiasPat = 0;
     nDiasRie = 0;
     nDiasCon = 0;
     nDiasERE = 0;
     aUltimaIT = "";
     nAjuste = 0;
     nDiasCotAlta = 0;
     nDiasCotIT = 0;
     nPrestEnf = 0;
     nPrestAcc = 0;
     nDiasCot = 0;
     nPromedioCC = 0;
     nPromedioATEP = 0;
     nDiasAlta = 0;
     nAny = 0;
     topemes = 0;
     nDiasMesTrab = 0;
     nCampo = 0;
     nBaseEnfCC = 0;
     nBaseEnfAE = 0;
     nBaseAccCC = 0;
     nBaseAccAE = 0;
     aTipoHorasFor = "";
     nNumHorasFor = 0;
     nume1 = 0;
     nume2 = 0;
     nEmp = 0;
     nTra = 0;
     fFechaAlta = "01.01.0000";
     aFechaAlta = "";
     fFechaBaja = "01.01.0000";
     aFechaBaja = "";
     aNAFSS = "";
     aAny = "";
     aAlfa1 = "";
     fFechaIniPer = "01.01.0000";
     fFechaFinPer = "01.01.0000";
     nNume1 = 0;
     nNume2 = 0;
|FPRC;

|PROCESO BuscaITAgrJor;
     |ABRE #gomdesjr;
     #gomdesjr#0 = #labtraba#0;
     #gomdesjr#1 = #labtraba#1;
     #gomdesjr#2 = nAny;
     #gomdesjr#3 = nMes;
     #gomdesjr#4 = 00;
     |LEE 000#gomdesjr.=
     |SI FSalida = 0;
          nDiasEnf = 0;
          nDiasAcc = 0;
          nDiasMat = 0;
          nDiasPat = 0;
          nDiasRie = 0;
          nDiasCon = 0;
          nDiasERE = 0;
          |PARA nCampoAGR = 5; |SI nCampoAGR [ 35; |HACIENDO nCampoAGR = nCampoAGR + 10;
               nCampoA = nCampoAGR + 5;
               nCampoB = nCampoAGR + 6;
               aTipo = #gomdesjr#nCampoAGR#;
               |SI aTipo = "E";
                    nDiasEnf = nDiasEnf + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "A";
                    nDiasAcc = nDiasAcc + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "M";
                    nDiasMat = nDiasMat + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "P";
                    nDiasPat = nDiasPat + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "R";
                    nDiasRie = nDiasRie + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "C";
                    nDiasCon = nDiasCon + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
               |SI aTipo = "D";
                    nDiasERE = nDiasERE + #gomdesjr#nCampoA# + #gomdesjr#nCampoB#;
               |FINSI;
          |SIGUE;
     |SINO;
          nNume = 0;
          |SI aFuente = "Mensual"; nNume = #nomcalca#55; |FINSI;
          |SI aFuente = "Hist¢rico"; nNume = #nomhicca#55; |FINSI;
          |SI aFuente = "Atrasos"; nNume = #nomcalac#55; |FINSI;

          |SI nDiasEnf ! 0; nDiasEnf = nNume; |FINSI;
          |SI nDiasAcc ! 0; nDiasAcc = nNume; |FINSI;
          |SI nDiasMat ! 0; nDiasMat = nNume; |FINSI;
          |SI nDiasPat ! 0; nDiasPat = nNume; |FINSI;
          |SI nDiasRie ! 0; nDiasRie = nNume; |FINSI;
          |SI nDiasCon ! 0; nDiasCon = nNume; |FINSI;
          |SI nDiasERE ! 0; nDiasERE = nNume; |FINSI;
     |FINSI;
     |CIERRA #gomdesjr;
|FPRC;

|PROCESO Fechas;
     fFechaAlta = aFechaAlta;
     aNAFSS = #labtraba#75;
     |QBF aNAFSS;
     aAlfa1 = aNAFSS % 102;
     aAlfa2 = aNAFSS % 310;
     |QBF aAlfa2;
     aAlfa2 = ("0000000000" + aAlfa2) % -110;
     aNAFSS = aAlfa1 + aAlfa2;
     aAlfa = aFechaBaja;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2999";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |HAZ MesLetra_plb;
     aMesLetra = aMes;

     aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
     aAny = nAny;

     aAlfa1 = topemes;
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaFinPer = aAlfa;

     aAlfa1 = "01";
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaIniPer = aAlfa;

     |SI fFechaAlta > fFechaIniPer;
          fFechaIniPer = fFechaAlta;
     |FINSI;

     |SI fFechaBaja < fFechaFinPer;
          fFechaFinPer = fFechaBaja;
     |FINSI;

     nNume1 = fFechaIniPer;
     nNume2 = fFechaFinPer;

     nDiasMesTrab = nNume2 - nNume1 + 1;
|FPRC;

|PROCESO Pluriempleo;
     |ABRE #nompluri;
     #nompluri#0 = #labtraba#0;
     #nompluri#1 = #labtraba#1;
     |LEE 000#nompluri.=;
     |SI FSalida = 0;
          swPluriempleo = 1;
     |FINSI;
     |CIERRA #nompluri;

     |SI swPluriempleo = 1;
          |ABRE #nompluba;
          #nompluba#0 = #cretam04#0;
          #nompluba#1 = #cretam04#7;
          #nompluba#2 = #cretam04#1;
          #nompluba#3 = #cretam04#2;
          #nompluba#4 = 0;
          |LEE 000#nompluba.=;
          |SI FSalida = 0;
               || tal cual
               || eso no es correcto, pero no se me ocurre otra cosa y salvamos
               || este caso,
               |SI #nompluba#5 ! #nompluba#6;
                    #nomcalca#39 = #nompluba#6;
                    #nomhicca#39 = #nompluba#6;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Atrasos;
     aDesde = "A";

     #nomcalac#0 = #cretam04#0;
     #nomcalac#1 = #cretam04#7;
     #nomcalac#2 = #cretam04#2;
     #nomcalac#3 = #cretam04#3;
     |SI #cretam04#3 = 90;
          #nomcalac#3 = 05;
     |FINSI;

     |LEE 000#nomcalac.=;
     |SI FSalida ! 0;
          |ACABA;
     |FINSI;

     |SI #nomcalac#181 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
               #labtraba#42 = "T";
          |SINO;
               nNume = #labtraba#45;
               |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
                    #labtraba#42 = "D";
                    #labtraba#64 = "D";
               |FINSI;
          |FINSI;
     |FINSI;

     swLocalizado = 1;

     aFuente = "Atrasos";

     nAny = #0#4;
     nMes = #nomcalac#2;
     |HAZ topemes;

     aFechaAlta = #nomcalac#4;
     aFechaBaja = #nomcalac#5;

     |HAZ Fechas;

     |SI #nomcalac#3 = 2;    || finiquitos
          nDiasCot = #nomcalac#171 + #nomcalac#172;
     |SINO;
          nDiasCot = #nomcalac#8;
     |FINSI;
     nPromedioCC = #nomcalac#35;
     nPromedioATEP = #nomcalac#36;

     nBaseCC_Alta_Tra = nBaseCC_Alta_Tra + #nomcalac#39;
     nBaseATEP_Alta_Tra = nBaseATEP_Alta_Tra + #nomcalac#40;

     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra + #nomcalac#62;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomcalac#117 - #nomcalac#130;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomcalac#132;

     nBaseCC_Alta = (nBaseCC_Alta_Tra - nBaseEnfAcc_Tra);
     nBaseATEP_Alta = (nBaseATEP_Alta_Tra - nBaseEnfAcc_Tra);
     |SI #nomcalac#139 ! 0;
          nBasePat = nBasePat + #nomcalac#117;
     |SINO;
          nBaseMat = nBaseMat + #nomcalac#117;;
     |FINSI;
     nBaseRie = nBaseRie + #nomcalac#130;
     nBaseCon = nBaseCon + #nomcalac#132;
     |SI #labtraba#241 = "N";
          nBaseCon = 0;
     |FINSI;
     nBaseERE = nBaseERE + #nomcalac#128;
     |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
          |SI swTP = 0;
               nBaseHorasFM = nBaseHorasFM + #nomcalac#41;
               nBaseHorasOt = nBaseHorasOt + #nomcalac#42;
          |SINO;
               nBaseHorasComp = nBaseHorasComp + #nomcalac#41 + #nomcalac#42;
          |FINSI;
     |FINSI;

     nPrestEnf = nPrestEnf + #nomcalac#57;
     nPrestAcc = nPrestAcc + #nomcalac#58;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalac#31;
     nDiasAcc = #nomcalac#32;
     nDiasMat = #nomcalac#65;
     nDiasPat = #nomcalac#139;
     nDiasRie = #nomcalac#129;
     nDiasCon = #nomcalac#131;
     nDiasERE = #nomcalac#78;

     |SI #labtraba#42 = "E";
          |HAZ BuscaITAgrJor;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";

     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          swSigue = 1;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #labtraba#33 ] 08;
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalac#nCampo# = "E"; |O #nomcalac#nCampo# = "A";
               |O #nomcalac#nCampo# = "M"; |O #nomcalac#nCampo# = "P";
               |O #nomcalac#nCampo# = "R"; |O #nomcalac#nCampo# = "C";
               |O #nomcalac#nCampo# = "D";
                    aUltimaIT = #nomcalac#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D"; nDiasERE = nDiasERE - nAjuste; |FINSI;
          |FINSI;
     |FINSI;

     nBaseEnfCC = nBaseEnfCC + (nDiasEnf * nPromedioCC);
     nBaseEnfAE = nBaseEnfAE + (nDiasEnf * nPromedioATEP);
     nBaseAccCC = nBaseAccCC + (nDiasAcc * nPromedioATEP);
     nBaseAccAE = nBaseAccAE + (nDiasAcc * nPromedioATEP);

     nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
     nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

     nDiasCotAlta = nDiasCot - nDiasCotIT;

     || con el calculo nuevo ya no proceden ajustes en las bases de ningun
     || tipo

     |SI nDiasCotIT ! 0; |Y nPromedioCC ! nPromedioATEP;
          || la base CC se supone que esta bien calculada
          nBaseCC_Alta = nBaseCC_Alta - (#nomcalac#39 - nBaseEnfAcc_Prov);
          nBaseCC_Alta = nBaseCC_Alta + (#nomcalac#39 - (nDiasCotIT * nPromedioCC));

          || la que varia es la base ATEP alta
          || primero quito lo que le meti antes
          || nBaseATEP_Alta = nBaseATEP_Alta - (#nomcalac#40 - nBaseEnfAcc_Prov);
          || y ahora pongo la calculada con el nuevo promedio
          || nBaseATEP_Alta = nBaseATEP_Alta + (#nomcalac#40 - (nDiasCotIT * nPromedioATEP));
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomcalac#107;
     nNume = #nomcalac#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     |SI swIplabor2 = 1;
          nNume = 248;
          |SI #labtraba#nNume# = 515;
               nBaseCC_Alta = 0;
               nBaseEnfCC = 0;
               nBaseAccCC = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Historico;
     aDesde = "H";

     #nomhicca#0 = #cretam04#0;
     #nomhicca#1 = #cretam04#7;
     #nomhicca#66 = #cretam04#1 - 2000;
     #nomhicca#2 = #cretam04#2;
     #nomhicca#3 = #cretam04#3;
     |LEE 000#nomhicca.=;
     |SI FSalida ! 0;
          |ACABA;
     |FINSI;
     swLocalizado = 1;

     |SI #nomhicca#223 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
               #labtraba#42 = "T";
          |SINO;
               nNume = #labtraba#45;
               |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
                    #labtraba#42 = "D";
                    #labtraba#64 = "D";
               |FINSI;
          |FINSI;
     |FINSI;

     aFuente = "Hist¢rico";

     nAny = #0#4;
     nMes = #nomhicca#2;
     |HAZ topemes;

     aFechaAlta = #nomhicca#4;
     aFechaBaja = #nomhicca#5;

     |HAZ Fechas;

     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          nDiasMesTrab = #nomhicca#160;
     |FINSI;

     |SI #nomhicca#3 = 2;    || finiquitos
          nDiasCot = #nomhicca#213 + #nomhicca#214;
     |SINO;
          nDiasCot = #nomhicca#8;
     |FINSI;
     nPromedioCC = #nomhicca#35;
     nPromedioATEP = #nomhicca#36;
     nBaseCC_Alta_Tra = nBaseCC_Alta_Tra + #nomhicca#39;
     nBaseATEP_Alta_Tra = nBaseATEP_Alta_Tra + #nomhicca#40;

     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra + #nomhicca#62
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomhicca#159 - #nomhicca#172;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomhicca#174;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomhicca#240;

     || me puede hacer falta despues
     nBaseEnfAcc_Prov = #nomhicca#62 - #nomhicca#159 - #nomhicca#172 - #nomhicca#174;
     nBaseEnfAcc_Prov = nBaseEnfAcc_Prov - #nomhicca#240;
     nBaseCC_Alta_Prov = #nomhicca#39 - nBaseEnfAcc_Prov;

     nBaseCC_Alta = (nBaseCC_Alta_Tra - nBaseEnfAcc_Tra);
     nBaseATEP_Alta = (nBaseATEP_Alta_Tra - nBaseEnfAcc_Tra);

     || parche, por error en el calculo, hago esto por no tener que
     || desactualizar
     |SI nBaseEnfAcc_Tra < 0; |Y #nomhicca#174 ! 0;
          #nomhicca#174 = #nomhicca#174 + nBaseEnfAcc_Tra;
          nBaseEnfAcc_Tra = 0;
          nBaseCC_Alta = 0;
          nBaseATEP_Alta = 0;
     |FINSI;

     |SI #nomhicca#181 ! 0;
          nBasePat = nBasePat + #nomhicca#159;
     |SINO;
          nBaseMat = nBaseMat + #nomhicca#159
     |FINSI;
     nBaseRie = nBaseRie + #nomhicca#172;
     nBaseCon = nBaseCon + #nomhicca#174;
     |SI #labtraba#241 = "N";
          nBaseCon = 0;
     |FINSI;
     nBaseERE = nBaseERE + #nomhicca#170;
     |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
          |SI swTP = 0;
               nBaseHorasFM = nBaseHorasFM + #nomhicca#41;
               nBaseHorasOt = nBaseHorasOt + #nomhicca#42;
          |SINO;
               nBaseHorasComp = nBaseHorasComp + #nomhicca#41 + #nomhicca#42;
          |FINSI;
     |FINSI;

     nPrestEnf = nPrestEnf + #nomhicca#57;
     nPrestAcc = nPrestAcc + #nomhicca#58;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomhicca#31;
     nDiasAcc = #nomhicca#32;
     nDiasMat = #nomhicca#65;
     nDiasPat = #nomhicca#181;
     nDiasRie = #nomhicca#171;
     nDiasCon = #nomhicca#173;
     nDiasERE = #nomhicca#119;

     |SI #labtraba#42 = "E";
          |HAZ BuscaITAgrJor;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";

     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          swSigue = 1;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #labtraba#33 ] 08;
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomhicca#nCampo# = "E"; |O #nomhicca#nCampo# = "A";
               |O #nomhicca#nCampo# = "M"; |O #nomhicca#nCampo# = "P";
               |O #nomhicca#nCampo# = "R"; |O #nomhicca#nCampo# = "C";
               |O #nomhicca#nCampo# = "D";
                    aUltimaIT = #nomhicca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D"; nDiasERE = nDiasERE - nAjuste; |FINSI;
          |FINSI;
     |FINSI;

     |SI nBaseEnfAcc_Tra ! 0;
          || si esta base esta a cero, no hay base de IT, por mucho que haya
          || dias y promedio, esto para atrasos que vienen del a¤o anterior
          nBaseEnfCC = nBaseEnfCC + (nDiasEnf * nPromedioCC);
          nBaseEnfAE = nBaseEnfAE + (nDiasEnf * nPromedioATEP);
          nBaseAccCC = nBaseAccCC + (nDiasAcc * nPromedioCC);
          nBaseAccAE = nBaseAccAE + (nDiasAcc * nPromedioATEP);
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
     nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

     nDiasCotAlta = nDiasCot - nDiasCotIT;

     || con el calculo nuevo ya no proceden ajustes en las bases de ningun
     || tipo

     |SI nDiasCotIT ! 0; |Y nPromedioCC ! nPromedioATEP;
          || la base CC se supone que esta bien calculada
          nBaseCC_Alta = nBaseCC_Alta - (#nomhicca#39 - nBaseEnfAcc_Prov);
          nBaseCC_Alta = nBaseCC_Alta + (#nomhicca#39 - (nDiasCotIT * nPromedioCC));

          || la que varia es la base ATEP alta
          || primero quito lo que le meti antes
          || nBaseATEP_Alta = nBaseATEP_Alta - (#nomhicca#40 - nBaseEnfAcc_Prov);
          || y ahora pongo la calculada con el nuevo promedio
          || nBaseATEP_Alta = nBaseATEP_Alta + (#nomhicca#40 - (nDiasCotIT * nPromedioATEP));
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = nNumHorasFor + #nomhicca#149;
     nNume = #nomhicca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     |SI swIplabor2 = 1;
          nNume = 248;
          |SI #labtraba#nNume# = 515;
               nBaseCC_Alta = 0;
               nBaseEnfCC = 0;
               nBaseAccCC = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Mensual;
     #nomcalca#0 = #cretam04#0;
     #nomcalca#1 = #cretam04#7;
     #nomcalca#2 = #cretam04#2;
     #nomcalca#3 = #cretam04#3;
     |LEE 000#nomcalca.=;
     |SI FSalida ! 0;
          |ACABA;
     |FINSI;
     swLocalizado = 1;

     |SI #nomcalca#181 = "S";
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "P";
               #labtraba#42 = "T";
          |SINO;
               nNume = #labtraba#45;
               |SI #labtraba#42 = "M"; |Y nNume ] 300; |Y nNume [ 399;
                    #labtraba#42 = "D";
                    #labtraba#64 = "D";
               |FINSI;
          |FINSI;
     |FINSI;

     aFuente = "Mensual";

     nAny = #0#4;
     nMes = #nomcalca#2;
     |HAZ topemes;

     aFechaAlta = #nomcalca#4;
     aFechaBaja = #nomcalca#5;

     |HAZ Fechas;

     |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
          nDiasMesTrab = #nomcalca#118;
     |FINSI;

     |SI #nomcalca#3 = 2;    || finiquitos
          nDiasCot = #nomcalca#171 + #nomcalca#172;
     |SINO;
          nDiasCot = #nomcalca#8;
     |FINSI;
     nPromedioCC = #nomcalca#35;
     nPromedioATEP = #nomcalca#36;

     swPluriempleo = 0;
     |SI #labtraba#237 = "S";
          |HAZ Pluriempleo;
     |FINSI;

     nBaseCC_Alta_Tra = nBaseCC_Alta_Tra + #nomcalca#39;
     nBaseATEP_Alta_Tra = nBaseATEP_Alta_Tra + #nomcalca#40;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra + #nomcalca#62;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomcalca#117 - #nomcalca#130;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomcalca#132;
     nBaseEnfAcc_Tra = nBaseEnfAcc_Tra - #nomcalca#198;

     || me puede hacer falta despues
     nBaseEnfAcc_Prov = #nomcalca#62 - #nomcalca#117 - #nomcalca#130 - #nomcalca#132;
     nBaseEnfAcc_Prov = nBaseEnfAcc_Prov - #nomcalca#198;
     nBaseCC_Alta_Prov = #nomcalca#39 - nBaseEnfAcc_Prov;

     nBaseCC_Alta = (nBaseCC_Alta_Tra - nBaseEnfAcc_Tra);
     nBaseATEP_Alta = (nBaseATEP_Alta_Tra - nBaseEnfAcc_Tra);
     |SI #nomcalca#139 ! 0;
          nBasePat = nBasePat + #nomcalca#117;
     |SINO;
          nBaseMat = nBaseMat + #nomcalca#117;;
     |FINSI;
     nBaseRie = nBaseRie + #nomcalca#130;
     nBaseCon = nBaseCon + #nomcalca#132;
     |SI #labtraba#241 = "N";
          nBaseEnfAcc_Tra = nBaseEnfAcc_Tra + nBaseCon;
          nBaseCon = 0;
     |FINSI;
     nBaseERE = nBaseERE + #nomcalca#128;
     |SI #labtraba#42 ! "A"; |Y #labtraba#42 ! "E";
          |SI swTP = 0;
               nBaseHorasFM = nBaseHorasFM + #nomcalca#41;
               nBaseHorasOt = nBaseHorasOt + #nomcalca#42;
          |SINO;
               nBaseHorasComp = nBaseHorasComp + #nomcalca#41 + #nomcalca#42;
          |FINSI;
     |FINSI;

     nPrestEnf = nPrestEnf + #nomcalca#57;
     nPrestAcc = nPrestAcc + #nomcalca#58;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalca#31;
     nDiasAcc = #nomcalca#32;
     nDiasMat = #nomcalca#65;
     nDiasPat = #nomcalca#139;
     nDiasRie = #nomcalca#129;
     nDiasCon = #nomcalca#131;
     nDiasERE = #nomcalca#78;

     |SI #labtraba#42 = "E";
          |HAZ BuscaITAgrJor;
     |FINSI;

     || Ajuste Mensuales
     aUltimaIT = "";
     swSigue = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          swSigue = 1;
          |SI #labtraba#42 = "C"; |O #labtraba#42 = "F";
               |SI #labtraba#33 ] 08;
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalca#nCampo# = "E"; |O #nomcalca#nCampo# = "A";
               |O #nomcalca#nCampo# = "M"; |O #nomcalca#nCampo# = "P";
               |O #nomcalca#nCampo# = "R"; |O #nomcalca#nCampo# = "C";
               |O #nomcalca#nCampo# = "D";
                    aUltimaIT = #nomcalca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D"; nDiasERE = nDiasERE - nAjuste; |FINSI;
          |FINSI;
     |FINSI;

     |SI #labtraba#247 ! 0111;
     |Y #0#6 = 0;
          || con el calculo nuevo ya no proceden ajustes en las bases de
          || ningun tipo
          || solo tipo 0

          nBaseEnfCC = nBaseEnfCC + (nDiasEnf * nPromedioCC);
          nBaseEnfAE = nBaseEnfAE + (nDiasEnf * nPromedioATEP);
          nBaseAccCC = nBaseAccCC + (nDiasAcc * nPromedioATEP);
          nBaseAccAE = nBaseAccAE + (nDiasAcc * nPromedioATEP);

          nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
          nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

          nDiasCotAlta = nDiasCot - nDiasCotIT;
     |FINSI;

     |SI nDiasEnf ! 0; |Y nDiasAcc ! 0;
          nBaseEnfCC = nBaseEnfCC + (nDiasEnf * nPromedioCC);
          nBaseEnfAE = nBaseEnfAE + (nDiasEnf * nPromedioATEP);
          nBaseAccCC = nBaseAccCC + (nDiasAcc * nPromedioATEP);
          nBaseAccAE = nBaseAccAE + (nDiasAcc * nPromedioATEP);
     |SINO;
          |SI nDiasEnf ! 0;
               nBaseEnfCC = nBaseEnfAcc_Tra;
               nBaseEnfAE = nBaseEnfAcc_Tra;
          |FINSI;
          |SI nDiasAcc ! 0;
               nBaseAccCC = nBaseEnfAcc_Tra;
               nBaseAccAE = nBaseEnfAcc_Tra;
          |FINSI;
     |FINSI;

     |SI nDiasCotIT ! 0; |Y nPromedioCC ! nPromedioATEP;
          || la base CC se supone que esta bien calculada
          nBaseCC_Alta = nBaseCC_Alta - (#nomcalca#39 - nBaseEnfAcc_Prov);
          nBaseCC_Alta = nBaseCC_Alta + (#nomcalca#39 - (nDiasCotIT * nPromedioCC));

          || la que varia es la base ATEP alta
          || primero quito lo que le meti antes
          || nBaseATEP_Alta = nBaseATEP_Alta - (#nomcalca#40 - nBaseEnfAcc_Prov);
          || y ahora pongo la calculada con el nuevo promedio
          || nBaseATEP_Alta = nBaseATEP_Alta + (#nomcalca#40 - (nDiasCotIT * nPromedioATEP));
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = nNumHorasFor + #nomcalca#107;
     nNume = #nomcalca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;

     |SI swIplabor2 = 1;
          nNume = 248;
          |SI #labtraba#nNume# = 515;
               nBaseCC_Alta = 0;
               nBaseEnfCC = 0;
               nBaseAccCC = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AuxTrabDupli;
     |SI #cretam04#7 ! #cretam06#7;
          |SI nVeces > 1;
               |ACABA;
          |FINSI;
          nVeces = nVeces + 1;

          nTra = #cretam04#7;
          #cretam04#7 = #cretam06#7;

          |SI aDesde = "M";
               |SALVA_DATOS #nomcalca;
               |HAZ Mensual;
               |REPON_DATOS #nomcalca;
          |FINSI;

          |SI aDesde = "H";
               |SALVA_DATOS #nomhicca;
               |HAZ Historico;
               |REPON_DATOS #nomhicca;
          |FINSI;

          |SI aDesde = "A";
               |SALVA_DATOS #nomcalac;
               |HAZ Atrasos;
               |REPON_DATOS #nomcalac;
          |FINSI;

          #cretam04#7 = nTra;
     |FINSI;
|FPRC;

|DEFBUCLE AuxTrabDupli;
     #cretam06#1;
     ;
     nEmp, #cretam04#1, #cretam04#2, #cretam04#3, #cretam04#4, aNAFSS, nLin, 00001;
     nEmp, #cretam04#1, #cretam04#2, #cretam04#3, #cretam04#4, aNAFSS, nLin, 99999;
     ;
     NULL, AuxTrabDupli;
|FIN;

|PROCESO AcumulaTramo;
     |PARA nCampo = 30; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 2;
          nCampo1 = nCampo + 1;
          |SI #cretam04#27 = "ALT";
               |SI #cretam04#nCampo# = 500;
               |O #cretam04#nCampo# = 300;
                    nTraCC = nTraCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 601;
               ||O #cretam04#nCampo# = 611; |O #cretam04#nCampo# = 300;
               || la 611 aparece en ayuntamientos (nuevo ingreso) pero en los
               || calculos no se graba el campo (solo cotizan a ATEP)
                    nTraATEP = nTraATEP + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 501;
                    nTraHorFM = nTraHorFM + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 502;
                    nTraHorOtr = nTraHorOtr + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 537;
                    nTraHorCom = nTraHorCom + #cretam04#nCampo1#;
               |FINSI;
               || ojo, maternidad o paternidad, pueden ser los dos
               |SI #cretam04#nCampo# = 535;
                    nTraPatCC = nTraPatCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 635;
                    nTraPatAE = nTraPatAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "ENF";
               |SI #cretam04#nCampo# = 500; |O #cretam04#nCampo# = 509;
                    nTraEnfCC = nTraEnfCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraEnfAE = nTraEnfAE + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 563;
                    nTraPreEnf = nTraPreEnf + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "ACC";
               |SI #cretam04#nCampo# = 500;
                    nTraAccCC = nTraAccCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 509;
                    nTraAccCC = nTraAccCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraAccAE = nTraAccAE + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 663;
                    nTraPreAcc = nTraPreAcc + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "MAT";
               |SI #cretam04#nCampo# = 509;
                    nTraMatCC = nTraMatCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraMatAE = nTraMatAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "MTP"; |O #cretam04#27 = "HTP";
               |SI #cretam04#nCampo# = 500;
                    nTraCC = nTraCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 601;
                    nTraATEP = nTraATEP + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 535;
                    nTraMatCC = nTraMatCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 635;
                    nTraMatAE = nTraMatAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "PTP";
               |SI #cretam04#nCampo# = 535;
                    nTraPatCC = nTraPatCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 635;
                    nTraPatAE = nTraPatAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "PAT";
               |SI #cretam04#nCampo# = 509;
                    nTraPatCC = nTraPatCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraPatAE = nTraPatAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "RIE";
               |SI #cretam04#nCampo# = 509;
                    nTraRieCC = nTraRieCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraRieAE = nTraRieAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "CON";
               |SI #cretam04#nCampo# = 509;
                    nTraConCC = nTraConCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraConAE = nTraConAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "ERE";
               |SI #cretam04#nCampo# = 509;
                    nTraERECC = nTraERECC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 603;
                    nTraEREAE = nTraEREAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
          |SI #cretam04#27 = "ETP";
               |SI #cretam04#nCampo# = 500;
                    nTraCC = nTraCC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 601;
                    nTraATEP = nTraATEP + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 536;
                    nTraERECC = nTraERECC + #cretam04#nCampo1#;
               |FINSI;
               |SI #cretam04#nCampo# = 636;
                    nTraEREAE = nTraEREAE + #cretam04#nCampo1#;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO IniVarTramos;
     nTraCC = 0;    nTraATEP = 0;
     nTraEnfCC = 0; nTraEnfAE = 0;
     nTraAccCC = 0; nTraAccAE = 0;
     nTraMatCC = 0; nTraMatAE = 0;
     nTraPatCC = 0; nTraPatAE = 0;
     nTraRieCC = 0; nTraRieAE = 0;
     nTraConCC = 0; nTraConAE = 0;
     nTraERECC = 0; nTraEREAE = 0;

     nTraHorFM = 0;
     nTraHorOtr = 0;
     nTraHorCom = 0;
     nTraPreEnf = 0;
     nTraPreAcc = 0;
|FPRC;

|PROCESO Diferencias;
     nTraCC = nTraCC ! 2;
     nBaseCC_Alta = nBaseCC_Alta ! 2;
     nTraATEP = nTraATEP ! 2;
     nBaseATEP_Alta = nBaseATEP_Alta ! 2;
     nTraEnfCC = nTraEnfCC ! 2;
     nBaseEnfCC = nBaseEnfCC ! 2;
     nTraEnfAE = nTraEnfAE ! 2;
     nBaseEnfAE = nBaseEnfAE ! 2;
     nTraPreEnf = nTraPreEnf ! 2;
     nPrestEnf = nPrestEnf ! 2;
     nTraAccCC = nTraAccCC ! 2;
     nBaseAccCC = nBaseAccCC ! 2;
     nTraAccAE = nTraAccAE ! 2;
     nBaseAccAE = nBaseAccAE ! 2;
     nTraPreAcc = nTraPreAcc ! 2;
     nPrestAcc = nPrestAcc ! 2;
     nTraMatCC = nTraMatCC ! 2;
     nBaseMat = nBaseMat ! 2;
     nTraPatCC = nTraPatCC ! 2;
     nBasePat = nBasePat ! 2;
     nTraRieCC = nTraRieCC ! 2;
     nBaseRie = nBaseRie ! 2;
     nTraConCC = nTraConCC ! 2;
     nBaseCon = nBaseCon ! 2;
     nTraERECC = nTraERECC ! 2;
     nBaseERE = nBaseERE ! 2;
     nTraHorFM = nTraHorFM ! 2;
     nBaseHorasFM = nBaseHorasFM ! 2;
     nTraHorOtr = nTraHorOtr ! 2;
     nBaseHorasOt = nBaseHorasOt ! 2;

     nDiferente = 0;
     |SI nTraCC !  nBaseCC_Alta;
     |O nTraATEP ! nBaseATEP_Alta;
     |O nTraEnfCC ! nBaseEnfCC;
     |O nTraEnfAE ! nBaseEnfAE;
     |O nTraPreEnf ! nPrestEnf;
     |O nTraAccCC ! nBaseAccCC;
     |O nTraAccAE ! nBaseAccAE;
     |O nTraPreAcc ! nPrestAcc;
     |O nTraMatCC ! nBaseMat;
     |O nTraPatCC ! nBasePat;
     |O nTraRieCC ! nBaseRie;
     |O nTraConCC ! nBaseCon;
     |O nTraERECC ! nBaseERE;
     |O nTraHorFM ! nBaseHorasFM;
     |O nTraHorOtr ! nBaseHorasOt;
     |O nTraHorCom ! nBaseHorasComp;
          |SI nTraHorCom ! nBaseHorasComp;
               || si la diferencia esta en las horas complementarias,
               || como en el informe ya no me cabe mas, las meto en la variable
               || de "Otras Horas Extras" (las que no son de Fuerza Mayor)
               nTraHorOtr = nTraHorCom;
               nBaseHorasOt = nBaseHorasComp;
          |FINSI;
          nNume1 = nTraCC + nTraATEP + nTraEnfCC + nTraEnfAE + nTraPreEnf;
          nNume1 = nNume1 + nTraAccCC + nTraAccAE + nTraPreAcc + nTraMatCC;
          nNume1 = nNume1 +  nTraPatCC + nTraRieCC + nTraConCC + nTraERECC;
          nNume1 = nNume1 + nTraHorFM + nTraHorOtr;

          nNume2 = nBaseCC_Alta + nBaseATEP_Alta + nBaseEnfCC + nBaseEnfAE;
          nNume2 = nNume2 +  nPrestEnf + nBaseAccCC + nBaseAccAE + nPrestAcc;
          nNume2 = nNume2 +  nBaseMat + nBasePat + nBaseRie + nBaseCon;
          nNume2 = nNume2 +  nBaseERE + nBaseHorasFM + nBaseHorasOt;

          nNume = nNume1 - nNume2;
          |SI -0.04 [ nNume; |Y nNume [ 0.04;
               nDiferente = 0;     || admito hasta dos centimos de margen
                                   || por trabajador
          |SINO;
               nDiferente = 1;
          |FINSI;
     |FINSI;

     || si he entrado aqui (regimen general) es porque algo ha pasado
     || lo marco siempre como diferente

     swOtrasDif = 0;
     |SI #labtraba#247 = 0111; |Y #0#7 = "D"; |Y #0#6 = 00;
          |SI nDiferente = 0;
               nDiferente = 1;
               swOtrasDif = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO OtrosCodigos;
     aOtros = #cretam04#85;
     |QBF aOtros;
     |SI aOtros ! "";
          |PARA nPosicion = 1; |SI nPosicion < 30; |HACIENDO nPosicion = nPosicion + 5;
               nCorta = (nPosicion * 100) + 5;
               aOtroCod = aOtros % nCorta;
               |QBF aOtroCod;
               |SI aOtroCod ! "";
                    nOtroCod = aOtroCod;
                    #cretam04#7 = nOtroCod;
                    |SI aDesde = "M";
                         |HAZ Mensual;
                    |FINSI;
                    |SI aDesde = "H";
                         |HAZ Historico;
                    |FINSI;
                    |SI aDesde = "A";
                         |HAZ Atrasos;
                    |FINSI;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO cretam04;
     nDiferente = 0;
     #labempre#0 = #cretam04#0;
     |LEE 000#labempre.=;

     #labtraba#0 = #cretam04#0;
     #labtraba#1 = #cretam04#7;
     |LEE 000#labtraba.=;

     swTP = 0;
     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
     |O #labtraba#42 = "P"; |O #labtraba#42 = "I";
          swTP = 1;
     |FINSI;

     |HAZ AcumulaTramo;

     nEmp = #cretam04#0;
     aNAFSS = #cretam04#5;
     nLin = #cretam04#6;

     |SI #cretam04#7 ! nAntTra; |O #cretam04#0 ! nAntEmp;
          |SI #cretam04#7 ! 00000;
               aDesde = "M";
               swLocalizado = 0;
               |HAZ Mensual;
               |SI swLocalizado = 1;
                    |HAZ OtrosCodigos;
               |FINSI;

               nVeces = 0;
               |BUCLE AuxTrabDupli;

               aDesde = "H";
               swLocalizado = 0;
               |HAZ Historico;
               |SI swLocalizado = 1;
                    |HAZ OtrosCodigos;
               |FINSI;
               nVeces = 0;
               |BUCLE AuxTrabDupli;

               aDesde = "A";
               swLocalizado = 0;
               |HAZ Atrasos;
               |SI swLocalizado = 1;
                    |HAZ OtrosCodigos;
               |FINSI;
               nVeces = 0;
               |BUCLE AuxTrabDupli;
          |SINO;
               #cretam04#7 = #cretam04#75;
               |HAZ Mensual; |HAZ Historico; |HAZ Atrasos;
               #cretam04#7 = #cretam04#78;
               |HAZ Mensual; |HAZ Historico; |HAZ Atrasos;
          |FINSI;
     |FINSI;

     |SI #cretam04#6 = nUltima;
          |HAZ Diferencias;
     |FINSI;

     || esto para que al imprimir no saque nada si no hay ningun
     || trabajador para sacar

     |SI swHayRegistros = 0;
          swHayRegistros = 1;
          Impresora = "CrystalReport";
          |IMPRE -1;
          |INFOR "cretai01";

          |PRINT;
          swHayRegistros = 1;
     |SINO;
          |PRINT;
     |FINSI;

     nAntEmp = #cretam04#0;
     nAntTra = #cretam04#7;
|FPRC;

|DEFBUCLE cretam04;
     #cretam04#1;
     ;
     || #0#0, #0#4, #0#5, #0#6, "           ", #cretam03#5, 01;
     || #0#1, #0#4, #0#5, #0#6, "zzzzzzzzzzz", #cretam03#5, 31;
     #0#0, #0#4, #cretam03#2, #0#6, #cretam03#4, #cretam03#5, 01;
     #0#1, #0#4, #cretam03#2, #0#9, #cretam03#4, #cretam03#5, 99;
     ;
     NULL, cretam04;
|FIN;

|PROCESO cretam04_ult;
     nUltima = #cretam04#6;
|FPRC;

|DEFBUCLE cretam04_ult;
     #cretam04#1;
     ;
     || #0#0, #0#4, #0#5, #0#6, "           ", #cretam03#5, 01;
     || #0#1, #0#4, #0#5, #0#6, "zzzzzzzzzzz", #cretam03#5, 31;
     #0#0, #0#4, #cretam03#2, #0#9, #cretam03#4, #cretam03#5, 01;
     #0#1, #0#4, #cretam03#2, #0#9, #cretam03#4, #cretam03#5, 99;
     ;
     NULL, cretam04_ult;
|FIN;

|PROCESO cretat14;
     swNoSigas = 0;
     nEmpNE = #cretat14#1;
     aAlfa = #cretat14#2; |QBF aAlfa; aAlfa = ("00000" + aAlfa) % -105;
     |SI aTraNE = "";
          aTraNE = aAlfa;
     |SINO;
          aTraNE = aTraNE + " - " + aAlfa;
     |FINSI;
|FPRC;

|DEFBUCLE cretat14;
     #cretat14#1;
     ;
     #cretam03#5, #cretam03#0, 00000;
     #cretam03#5, #cretam03#0, 99999;
     ;
     NULL, cretat14;
|FIN;

|PROCESO cretam03;
     aTraNE = "";
     aAlfa = #cretam03#4;
     aAlfa = aAlfa % 104;
     |SI aAlfa = "0111";
     |Y #0#6 = 00; |Y #0#7 = "D";
          swNoSigas = 1;
          |BUCLE cretat14;
          |SI swNoSigas = 1;
               |ACABA;
          |FINSI;
     |FINSI;

     swEntraPrevio = 2;

     |HAZ IniVarTramos;
     |HAZ IniVarMan;
     || primero busco la ultima linea
     nUltima = 0;
     nAntEmp = 0;
     nAntTra = 0;
     |BUCLE cretam04_ult;

     |BUCLE cretam04;
|FPRC;

|DEFBUCLE cretam03;
     #cretam03#1;
     ;
     #0#0, #0#4, #0#5, #0#6, "           ", "            ";
     #0#1, #0#4, #0#11, #0#9, "zzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, cretam03;
|FIN;

/****************************************************************************/


|PROCESO cretam04_tramos2;
     aAlfa = #cretam04#85;
     |QBF aAlfa;
     nNume = aAlfa;
     |SI nNume = nTra;
          swHayTramos = 1;
     |FINSI;
|FPRC;

|DEFBUCLE cretam04_tramos2;
     #cretam04#1;
     7;
     nEmp, #0#4, nMes, 0, "                ", aNaf, 01, 00001;
     nEmp, #0#4, nMes, 0, "zzzzzzzzzzzzzzzz", aNaf, 99, 99999;
     ;
     NULL, cretam04_tramos2;
|FIN;

|PROCESO cretam04_tramos;
     swHayTramos = 1;

     |SI #cretam04#27 = "ALT"; |Y #cretam04#22 [ 1; |Y #cretam04#30 = 0;
          nTramosSinBases = nTramosSinBases + 1;
     |FINSI;
|FPRC;


|DEFBUCLE cretam04_tramos;
     #cretam04#1;
     7;
     nEmp, #0#4, nMes, 0, "                ", aNaf, 01, nTra;
     nEmp, #0#4, nMes, 0, "zzzzzzzzzzzzzzzz", aNaf, 99, nTra;
     ;
     NULL, cretam04_tramos;
|FIN;

|PROCESO nomhicca;
     nEmp = #nomhicca#0;
     nTra = #nomhicca#1;
     nMes = #nomhicca#2;

     aNaf = "";
     #labtraba#0 = #nomhicca#0;
     #labtraba#1 = #nomhicca#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          aNaf = #labtraba#75;
          |QBF aNaf;
          aAlfa = aNaf % 0;
          nNume = aAlfa;
          |SI nNume ! 12;
               aAlfa1 = (aNaf % 102);
               aAlfa2 = (aNaf % 310);
               |QBF aAlfa2;
               aAlfa2 = ("000000000" + aAlfa2) % -110;
               aNaf = aAlfa1 + aAlfa2;
          |FINSI;
     |FINSI;

     |SI #labtraba#42 = "H"; |O #labtraba#247 ! 0111;
          |ACABA;
     |FINSI;

     swHayTramos = 0;
     nTramosSinBases = 0;
     |BUCLE cretam04_tramos;
     |SI swHayTramos = 0;
          |BUCLE cretam04_tramos2;
     |FINSI;
     |SI nTramosSinBases ] 2;
          nTra = 00000;
     |FINSI;
     |SI swHayTramos = 0; |O nTramosSinBases ] 2;
          |DDEFECTO #cretat14;
          #cretat14#0 = aNaf;
          #cretat14#1 = nEmp;
          #cretat14#2 = nTra;
          |LEE 101#cretat14.=;
          |SI FSalida ! 0;
               #cretat14#0 = aNaf;
               #cretat14#1 = nEmp;
               #cretat14#2 = nTra;
               |GRABA 020#cretat14.n;
          |FINSI;
          |LIBERA #cretat14;
     |FINSI;
|FPRC;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #0#0, #0#2, nAnyXX, #0#5, 0;
     #0#1, #0#3, nAnyXX, #0#5, 0;
     ;
     NULL, nomhicca;
|FIN;

|PROCESO nomcalca;
     nEmp = #nomcalca#0;
     nTra = #nomcalca#1;
     nMes = #nomcalca#2;

     aNaf = "";
     #labtraba#0 = #nomcalca#0;
     #labtraba#1 = #nomcalca#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          aNaf = #labtraba#75;
          |QBF aNaf;
          aAlfa = aNaf % 0;
          nNume = aAlfa;
          |SI nNume ! 12;
               aAlfa1 = (aNaf % 102);
               aAlfa2 = (aNaf % 310);
               |QBF aAlfa2;
               aAlfa2 = ("000000000" + aAlfa2) % -110;
               aNaf = aAlfa1 + aAlfa2;
          |FINSI;
     |FINSI;

     |SI #labtraba#42 = "H"; |O #labtraba#247 ! 0111;
          |ACABA;
     |FINSI;

     swHayTramos = 0;
     nTramosSinBases = 0;
     |BUCLE cretam04_tramos;
     |SI swHayTramos = 0;
          |BUCLE cretam04_tramos2;
     |FINSI;
     |SI nTramosSinBases ] 2;
          nTra = 00000;
     |FINSI;
     |SI swHayTramos = 0; |O nTramosSinBases ] 2;
          #cretat14#0 = aNaf;
          #cretat14#1 = nEmp;
          #cretat14#2 = nTra;
          |LEE 101#cretat14.=;
          |SI FSalida ! 0;
               #cretat14#0 = aNaf;
               #cretat14#1 = nEmp;
               #cretat14#2 = nTra;
               |GRABA 020#cretat14.n;
          |FINSI;
          |LIBERA #cretat14;
     |FINSI;
|FPRC;

|DEFBUCLE nomcalca;
     #nomcalca#1;
     184;
     #0#0, #0#2, #0#5, 0, #0#4;
     #0#1, #0#3, #0#5, 0, #0#4;
     ;
     NULL, nomcalca;
|FIN;


|PROCESO Mantenimientos;
     #nomcalca#0 = #cretam03#0;
     #nomcalca#1 = nCodigo;
     #nomcalca#2 = #0#5;
     #nomcalca#3 = 0;
     |LEE 000#nomcalca.=;
     |SI FSalida = 0;
          nImporteMan = nImporteMan + #nomcalca#nCampo#
     |FINSI;

     #nomhicca#0 = #cretam03#0;
     #nomhicca#1 = nCodigo;
     #nomhicca#2 = #0#5;
     #nomhicca#66 = #0#4 - 2000;
     #nomhicca#3 = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          nImporteMan = nImporteMan + #nomhicca#nCampo#
     |FINSI;
|FPRC;

|PROCESO CreaCodigo;
     |PARA nPos = 1; |SI; |HACIENDO nPos = nPos + 5;
          nCaptura = (nPos * 100) + 5;
          aCodigo = aTrabajadores % nCaptura;
          |QBF aCodigo;
          |SI aCodigo = "";
               aTrabajadores = aTrabajadores + aEste;
               |SAL;
          |SINO;
               |SI aCodigo = aEste;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO cretam04_previo;
     #labtraba#0 = #cretam04#0;
     #labtraba#1 = #cretam04#7;
     |LEE 000#labtraba.=;

     |SI #cretam04#27 = "ASR";
          |ACABA;
     |FINSI;

     |SI #labtraba#241 = "N"; |Y #labtraba#138 = "N";
          || sin periodo de carencia, la parte de enfermedad va a la 603
          || esto no va en el campo, no hay que sumarla
          |SI nCampo = 40;
               |SI #nomcot28#4 = "ENF";
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
/*
     |SI #labtraba#248 = 530;
          |SI nCampo = 40;
               |SI nConcepto = 601; |Y #nomcot28#4 = "ALT";
                    nConcepto = 611;
               |FINSI;
          |FINSI;
     |FINSI;
*/
     nNume = #cretam04#7;
     aAlfa = nNume;
     |QBF aAlfa;
     aEste = ("00000" + aAlfa) % -105;
     |HAZ CreaCodigo;

     aAlfa = #cretam04#85;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aEste = ("00000" + aAlfa) % -105;
          |HAZ CreaCodigo;
     |FINSI;

     |PARA nCampo1 = 30; |SI nCampo1 [ 48; |HACIENDO nCampo1 = nCampo1 + 2;
          |SI #cretam04#nCampo1# ! 0;
               nCampo2 = nCampo1 + 1;
               |SI #cretam04#nCampo1# = nConcepto;
                    nImporteTra = nImporteTra + #cretam04#nCampo2#;
                    |SAL;
               |FINSI;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE cretam04_previo;
     #cretam04#1;
     27;
     #cretam03#0, #0#4, #cretam03#2, 0, #cretam03#4, #cretam03#5, 01, #nomcot28#4;
     #cretam03#0, #0#4, #cretam03#2, 0, #cretam03#4, #cretam03#5, 99, #nomcot28#4;
     ;
     NULL, cretam04_previo;
|FIN;

|PROCESO nomcot28;
     nConcepto = #nomcot28#2;
     |BUCLE cretam04_previo;
|FPRC;

|DEFBUCLE nomcot28;
     #nomcot28#1;
     ;
     nCampo, 01;
     nCampo, 99;
     ;
     NULL, nomcot28;
|FIN;

|PROCESO Campos;
     aTrabajadores = "";
     nImporteTra = 0;
     |BUCLE nomcot28;

     nImporteMan = 0;
     |PARA nPos = 1; |SI; |HACIENDO nPos = nPos + 5;
          nCaptura = (nPos * 100) + 5;
          aCodigo = aTrabajadores % nCaptura;
          |QBF aCodigo;
          |SI aCodigo = "";
               |SAL;
          |SINO;
               nCodigo = aCodigo;
               |HAZ Mantenimientos;
          |FINSI;
     |SIGUE;

     nImporteTra = nImporteTra ! 2;
     nImporteMan = nImporteMan ! 2;

     |SI nImporteTra ! nImporteMan;
          #cretat14#0 = #cretam03#5;
          #cretat14#1 = #cretam03#0;
          #cretat14#2 = nCodigo;
          |LEE 101#cretat14.=;
          |SI FSalida ! 0;
               #cretat14#0 = #cretam03#5;
               #cretat14#1 = #cretam03#0;
               #cretat14#2 = nCodigo;
               |GRABA 020#cretat14.n;
          |FINSI;
          |LIBERA #cretat14;
          swNoSigas = 1;
     |FINSI;
|FPRC;

|PROCESO cretam03_previo;
     swEntraPrevio = 1;

     aAlfa = #cretam03#4;
     aAlfa = aAlfa % 104;
     |SI aAlfa ! "0111";
          |ACABA;
     |FINSI;

     nCampo = 39; |HAZ Campos;
     nCampo = 40; |HAZ Campos;
     nCampo = 62; |HAZ Campos;
|FPRC;

|DEFBUCLE cretam03_previo;
     #cretam03#1;
     ;
     #0#0, #0#4, #0#5, #0#6, "           ", "            ";
     #0#1, #0#4, #0#11, #0#9, "zzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, cretam03_previo;
|FIN;

|PROCESO Previo;
     aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_cretat14_" + aAlfa;
     |NOME_DAT #cretat14#aAlfa#;
     |DELINDEX #cretat14;
     |ABRE #cretat14;

     |BUCLE cretam03_previo;
     |BUCLE nomcalca;
     |BUCLE nomhicca;

     ||CONSULTA_CLAVE #1#cretat14;

     |CIERRA #cretat14;
|FPRC;

/****************************************************************************/


|PROCESO Version;
     |DBASE aAlfa;
     aAlfa1 = aAlfa - "aginom";
     |SI aAlfa ! aAlfa1;
          swAginom = 1;
     |SINO;
          swIplabor2 = 1;
     |FINSI;
|FPRC;

|PROGRAMA;
     |CLS;

     |PINPA #0#0;

     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;
          |BORRA 020#0a;
     |SINO;
          |HAZ Defectos;
     |FINSI;

     |PINDA #0#0;

     |HAZ Mes;
     |HAZ Activa11;

     |HAZ Activa8;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ MesesCabecera;

          #0#9 = #0#6;

          |SI #0#6 = 00;
               #0#11 = #0#5;
          |FINSI;

          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #nomcalca;
          |ABRE #nomhicca;
          |ABRE #nomcalac;
          |ABRE #labtraba;

          nAnyXX = #0#4 - 2000;

          |SI #0#6 = 00; |Y #0#7 = "D";
               |HAZ Previo;
          |FINSI;

          |BUCLE cretam03;

          |SI swHayRegistros = 1;
               |PIEINF;
               |FININF;
               |FINIMP;
          |SINO;
               |SI swEntraPrevio = 0;
                    |MENAV "    No se han encontrado datos para la selección relizada";
               |SINO;
                    |MENAV "    No se han encontrado diferencias";
               |FINSI;
          |FINSI;

          |CIERRA #nomcalac;
          |CIERRA #nomhicca;
          |CIERRA #nomcalca;
          |CIERRA #labtraba;
          |CIERRA #labempre;
     |FINSI;

     |GRABA 000#0n;
     |CIERRA #0;
|FPRO;
