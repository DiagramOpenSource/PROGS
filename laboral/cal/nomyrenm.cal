|FICHEROS;
     nomyrenm;
     nomhicca #100;     || para nomina historica
     labtraba #150;
     labempre;
     labemphi;
     labempax;

     nomcalca;     || para nomina mensual
     nomcalac;
     nomcalcu;     || calculo mensual
     silcon15;
     nomconli;

     nomtraca;
     nomepigr;
     nomconst;
     nomgruec;
     nomgruel;
     labcentr;
     nomtmpre;
     nomyrtmp;
     nomystmp;
     nomtmprf;
     nomtmprg;
     nomauxi1;

     nomcalli;
     nomcalal;
     nomhicli;
     nomcontr;
     nombofli;
     nomimpr1;
     nomdesam;
     nomconca;
     nomcont3;

     nomw0024,MANTE;

     cretam00;
     cretam02;
     cretam35;      || conceptos DCL
     cretam37;      || comceptos RLC

     nomcot03;      || calculos cotizacion

     dsnetm00@;     || parametros dsnetcom
|FIN;

|VARIABLES;
     nModoRepeticion = 0;
     &nTipoD = 0;
     &nTipoH = 0;
     &nPara = 0;

     nBaseERE = 0;
     nCuotaERE = 0;
     nConstante = 0;
    &p_mes1 = 0;
    &p_mes2 = 0;
    prestac = 0;
    mesos = 0;
    perlomens = 0;
    mesa = "";
    mesb = "";
    &month=0;

    hay_algo = 0;
    &resumen = "";
    desde_mes = 0;
    hasta_mes = 0;
    x_tipo = 0;
    x_centro = 0;
    y_centro = 0;

    error0       = "     Proceso ABORTADO !!! ";
    &informe = "nomyrweb";          || el informe de siempre
    informeweb = "nomyrweb";
    informecrys = "nomyrenm";      || el informe para Crystal
                                   || antes de hacerlo mediante el nomtmpre
    informeexcel = "nomyrexc";      || el informe para Excel
    informecrys2 = "nomyren2";      || el informe para Crystal
    informecrys3 = "nomyren3";     || el informe para Crystal
                                   || con descuentos desglosados
    informecrys4 = "nomyren4";     || el informe para Crystal
                                   || desglosado por mes para cada trabajador
    seleccio = 0;
    sw = 0;

    grupo = " ";
    trabaja = 0;
    centro = 0;
    empresa = 0;

    ginf_enf = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_tan = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_bon = 0;
    ginf_pro = 0;
    ginf_exe = 0;
    cinf_enf = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_tan = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_bon = 0;
    cinf_pro = 0;
    cinf_exe = 0;
    tinf_tan = 0;

    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;

    &p_mes = " ";
    &ano = 0;
    &swlin = 0;
    &varinf1 = "";
    &varinf2 = "";
    &fecha = @;
    &cabeza = "";
    tip = "";
    ames = "";
    mes = 0;

    &inf_enf = 0;
    &inf_sub = 0;
    &inf_bru = 0;
    &inf_dto = 0;
    &inf_tan = 0;
    &inf_ded = 0;
    &inf_dse = 0;
    &inf_liq = 0;
    &inf_sss = 0;
    &inf_bon = 0;
    &inf_for = 0;
    &inf_pro = 0;
    &inf_exe = 0;
    &inf_tip = 0;
    &inf_prest_enf_emp = 0;
    &inf_prest_enf_ss = 0;
    &inf_comp_enf = 0;
    &inf_prest_acc_ss = 0;
    &inf_comp_acc = 0;
    &inf_dias = 0;

    &pinf_enf = 0;
    &pinf_sub = 0;
    &pinf_bru = 0;
    &pinf_dto = 0;
    &pinf_ded = 0;
    &pinf_dse = 0;
    &pinf_liq = 0;
    &pinf_sss = 0;
    &pinf_bon = 0;
    &pinf_pro = 0;
    &pinf_exe = 0;

    &tinf_tc1 = 0;
    &tinf_tc1re = 0;
    &tinf_enf = 0;
    &tinf_sub = 0;
    &tinf_bru = 0;
    &tinf_dto = 0;
    &tinf_ded = 0;
    &tinf_dse = 0;
    &tinf_liq = 0;
    &tinf_sss = 0;
    &tinf_bon = 0;
    &tinf_pro = 0;
    &tinf_exe = 0;


    g_empresa = 0;
    g_centro = 0;
    g_grupo = "";
    g_trabaja = 0;

    dia = 0;
    zmes = 0;
    any = 0;
    swbaja = 0;
    fecalf = "";
    &aAunno = "";

     aDirDes = "";
     aRutaDes = "";
     aRuta = "";
     aRutaDatos = "";
     nCanal = 0;
     aArchivo = "";
     aCabecera = "";
     aTipoResumen = "";
     aTipoNomina = "";
     aEmpresa = "";
     aAnyoDesde = "";
     aAnyoHasta = "";
     aMesDesde = "";
     aMesHasta = "";
     aOrdenacion = "";
     nEmpresa = 0;
     nCentro  = 0;
     nAnyoDesde = 0;
     nAnyoHasta = 0;
     nMesDesde = 0;
     nMesHasta = 0;
     nOrdenacion = 0;
     nCampo19    = 0;
     nCampo23    = 0;
     swMensaje   = 0;

     cParam         = "";
     cParte         = "";
     &cOrigen        = "";
     &cDestino       = "";
     cDirBase       = "";
     cUsuario       = "";
     cIp            = "";
     cDirUsu        = "";
     cNumUsu        = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nAny = 0;
     nMes = 0;
     aTabla = "";
     aDir = "";
     &nErrorInf = 0;
     aSystem = "";
     aBaseBin = "";
     aDirOri = "";
     swDesdeWeb = 0;
     &aParametro = "";
     swAgrarios = 0;
     nCenAgrario = 0;
     nCenGeneral = 0;
     &fCFecha = @;
     &nCConst = 0;
     &aCError = "";
     nTipo = 0;
     nTipoAnt = 0;

     &nEmpAUTO = 0;
     &nTraAUTO = 0;
     &nMesAUTO = 0;
     &nAnyAUTO = 0;
     nDesdeTra = 0;
     nHastaTra = 0;
     aParam = "";
     &nNumTrabEmp = 0;
     &nNumTrabCen = 0;

     nCampo = 0;
     nCampoG = 0;
     nDesdeEmp = 0;
     nHastaEmp = 0;
     nDesdeCen = 0;
     nHastaCen = 0;
     nGrupo = 0;
     FEstado = 0;
     FEstado2 = 0;
     FEstadoC = 0;
     &nOrdenEmp = 0;
     &nOrdenTra = 0;
     &aRupAreas = "";
     &aNomPag = "";


     &enTipoInf = 0;
     &swPagasSN = 0;
     &eaFuente = "";
     &enDesdeMes = 0;
     &enHastaMes = 0;
     &enAny = 0;
     &enCuadre = 0;
    inf_ant1 = 0;
    inf_ant2 = 0;
    inf_ant3 = 0;
    inf_antp = 0;
    inf_emb = 0;
    imp_paga = 0;
    inf_esp = 0;
     swCrystal = 0;
     enWeb = 0;
     &swModulo = 0;

     inf_cere = 0;    || complemento 30% en ERE para modulo Qualitas
     inf_ssere = 0;   || seg. social en ERE
     nCompERE = 0;
     swHayAlgo = 0;
     &enTipoEmi = 0;
     &nUnoTipo2 = 0;
     &nCentroTipo2 = 0;
     swErrorImp = 0;

     &nRegistro = 0;
     &fFechaEmision = @;
     &aHoraEmision = "";
     nHandle = 0;
     aOrigen = "";
     aDestino = "";
     aRutaFich = "";
     aRutaDestino = "";
     &swDesglose = 0;
     swPaga = 0;
     nAnyTmp = 0;
     &nHastaAny = 0;
     nRegimen = 0;

     {-1}aMenu   = "";
         aMenu1  = "1530";
         aMenu2  = "1";
         aMenu3  = "7";
         aMenu4  = "Emitir                         ";
         aMenu5  = "-------------------------------";
         aMenu6  = "Archivar por empresas          ";
         aMenu7  = "Emitir y archivar por empresas ";
         aMenu8  = "-------------------------------";
         aMenu9  = "Archivar por centros           ";
         aMenu10 = "Emitir y archivar por centros  ";

     &nOpcion = 0;
     nOpcionOri = 0;
     &nArchi = 0;
     &eaVengoDe = "";
     &enSwDesde9 = 1;
     &enSwMeteGrupoSubTipo = 0;
     &swErrorDSArchi = 0;
     &eaInforme = "";
     swSigue = 0;
     aEmp = "";
     aCen = "";
     aTra = "";
     aNomEmp = "";
     &enSwFiniq = 0;
     nEmbargoPaga = 0;
     nEmbargo = 0;
     nDesdeEmpSel = 0;
     nHastaEmpSel = 0;
     nConcepto = 0;
     aDescripcion = "";
     nUnidades = 0;
     nValor = 0;
     nImporteCon = 0;
     aTipoConcepto = "";
     &aTotalGrupo = "";

     nEmpAct = 0;
     nCenAct = 0;
     aAreAct = "";
     nAnyAct = 0;
     nMesAct = 0;
     nTipAct = 0;
     aNifAct = "";
     nTraAct = 0;

     nAnyCretaDesde = 0;
     nAnyCretaHasta = 0;
     nMesCretaDesde = 0;
     nMesCretaHasta = 0;

     nAnyAux = 0;
     nMesAux = 0;

     &aFuenteTotal = "";

     import = 0;
     concep = 0;
     numer = 0;
     numerl = 0;
     nImporteTC1 = 0;
     swHayCreta = 0;
     swCretaLeido = 0;
     hay_algo_tc1H = 0;
     swLiqCreta = 0;
     swMora = 0;
     nRecargo = 0;
     nNume = 0;
     aFic  = "";


     &swAtrasosHis = 0;
     &swAtrasos = 0;
     &enTipoAt = 0;
     inf_basecc = 0;
     inf_basecp = 0;
     inf_hasehe_fm = 0;
     inf_basehe_nor = 0;
     inf_baseirpf = 0;
     inf_baseirpfes = 0;
     inf_baseirpfpa = 0;
     inf_dtoirpfpa = 0;
     inf_dtoirpfes = 0;
     inf_dtoirpfdi = 0;
     &swArchivaExcel = 0;
     &nTipoOriD = 0;
     &nTipoOriH = 0;

     &enPorEmp  = 0;
     &enPorCen  = 0;
     &enCen     = 0;
     &eaCen     = "";
     nTotalEmpresas = 0;
     nTotalCentros = 0;
     swCuenta = 0;
     swYaConfirmado = 0;
     nFinimp = 0;
     aFich = "";
     nPorDes = 0;
     nPorFP = 0;
     nCuotaDes = 0;
     nCuotaFP = 0;

     || campos aplazamiento

     || A. DEUDA NO APLAZABLE
     || 1. aportacion trabajador
     inf_cc_tra = 0;
     inf_he_tra = 0;
     inf_des_tra = 0;
     inf_fp_tra = 0;

     || 2. cuotas atep
     inf_atep = 0;

     || 3. suma 1 + 2
     inf_suma_12 = 0;

     || 4. prestaciones pago delegado
     inf_pres_cp = 0;

     || 5. diferencia 3 - 4
     inf_dif_34 = 0;

     || 7. total no aplazable
     inf_tot_noaplaz = 0;

     || B. DEUDA APLAZABLE
     || 1. cuotas
     inf_cc_emp = 0;
     inf_he_emp = 0;
     inf_des_emp = 0;
     inf_fog_emp = 0;
     inf_fp_emp = 0;

     || 2. total cuotas
     inf_tot_cuota_emp = 0;

     || 3. deducciones
     inf_pres_cc = 0;
     inf_bonred_emp = 0;

     || 4. total deducciones
     inf_totded_emp = 0;

     || 5. diferencia aplazable
     inf_dif_aplaz = 0;

     || 8. total aplazable 5
     inf_tot_aplaz = 0;

     || C. TOTAL DEUDA
     inf_tot_deuda = 0;
     nSuma12 = 0;
     nCuotaEmp = 0;
|FIN;

|INCLUYE i_yreno;

|PROCESO constante;
     alfa1 = "01";
     alfa2 = #nomyrenm#2;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     nume3 = 2000 + #nomyrenm#5;
     alfa3 = nume3;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
|FPRC;

|PROCESO ElPRINT;
     |SI #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 03; |Y #nomyrenm#30 ! 04; |Y informe ! "nomyren2";
     |Y #nomyrenm#30 ! 10;
     |Y #nomyrenm#30 ! 11;
     |Y #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
     |Y #nomyrenm#30 ! 55;
          |PRINT;
     |FINSI;
|FPRC;

|PROCESO Descripcion;
     #nomdesam#0 = #labtraba#87;
     #nomdesam#1 = nConcepto;
     |LEE 000#nomdesam.=;
     |SI FSalida = 0;
          aAlfa = #nomdesam#2;
          |QBF aAlfa;
          |SI aAlfa ! "";
               aDescripcion = #nomdesam#2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaConcepto;
     swSigue = 0;
     |SI nConcepto [ 199; |O nConcepto ] 300;
          swSigue = 1;
     |FINSI;
     |SI nConcepto ] 200; |Y nConcepto [ 299;
          || pagas incluidas
          |SI aNomPag       = "P";  swSigue = 1;  |FINSI;
          |SI swPagasSN     = 2;    swSigue = 1;  |FINSI;
          |SI aTipoConcepto = "P";  swSigue = 1;  |FINSI;
          |SI inf_tip       = 2;    swSigue = 1;  |FINSI;
          |SI enCuadre = 50;    swSigue = 1;  |FINSI;
     |FINSI;

     |SI -0.01 [ nImporteCon; |Y nImporteCon [ 0.01;
         swSigue = 0;
     |FINSI;

     |SI swSigue = 0;  |ACABA;  |FINSI;
     |DDEFECTO #nomtmprf;
     #nomtmprf#0  = #labtraba#0;    || codigo empresa
     #nomtmprf#2  = #labtraba#77;   || codigo centro
     |HAZ AreaConceptos;
     #nomtmprf#1  = #labtraba#1;    || codigo trabajador
     #nomtmprf#41 = nAnyTmp;
     #nomtmprf#19 = nCampo19;
     #nomtmprf#23 = nCampo23;
     #nomtmprf#7  = nConcepto;
     |LEE 101#nomtmprf.=;
     |SI FSalida ! 0;
         |DDEFECTO #nomtmprf;
         #nomtmprf#0  = #labtraba#0;    || codigo empresa
         #nomtmprf#2  = #labtraba#77;   || codigo centro
         |HAZ AreaConceptos;
         #nomtmprf#1  = #labtraba#1;    || codigo trabajador
         #nomtmprf#41 = nAnyTmp;
         #nomtmprf#19 = nCampo19;
         #nomtmprf#23 = nCampo23;
         #nomtmprf#7  = nConcepto;
         |GRABA 020#nomtmprf.b;
     |FINSI;

     |HAZ Descripcion;
     #nomtmprf#8 = aDescripcion;
     #nomtmprf#9 = #nomtmprf#9 + nUnidades;
     #nomtmprf#10 = nValor;
     #nomtmprf#11 = #nomtmprf#11 + nImporteCon;
     |SI nConcepto ] 200; |Y nConcepto [ 299;
          #nomtmprf#45  = aTipoConcepto;
     |FINSI;
     |GRABA 020#nomtmprf.a;
     |LIBERA #nomtmprf;


     swSigue = 1;

     |SI #nomtmprf#7 = 908; |O #nomtmprf#7 = 923; |O #nomtmprf#7 = 924;
          swSigue = 0;
     |FINSI;

     |SI swSigue = 1;
          #nomtmprg#0 = #nomtmprf#0;
          #nomtmprg#1 = #nomtmprf#7;
          |LEE 101#nomtmprg.=;
          |SI FSalida ! 0;
               #nomtmprg#0 = #nomtmprf#0;
               #nomtmprg#1 = #nomtmprf#7;
               #nomtmprg#2 = #nomtmprf#8;
               |GRABA 020#nomtmprg.n;
          |FINSI;
          |LIBERA 020#nomtmprg;
     |FINSI;
|FPRC;

|PROCESO PrepConceptos;
     nCampo19 = month;                   || atrasos refundidos

     ||SI #nomyrenm#17 = 2; |Y #nomyrenm#14 = "A";     || atrasos por meses
     |SI #nomyrenm#14 = "A"; |O swAtrasosHis = 1; || atrasos
     |O #nomyrenm#14 = "H";
          nCampo19 = #nomyrenm#9;
     |FINSI;

     nCampo23 = inf_tip;
     |SI swPaga = 1;
         nCampo23 = 1;
     |FINSI;

     |SI #nomyrenm#14 = "M";
          nConcepto     = #nomcalli#4;
          nUnidades     = #nomcalli#11;
          nValor        = #nomcalli#10;
          nImporteCon   = #nomcalli#11 * #nomcalli#10;
          aDescripcion  = #nomcalli#8;
          aTipoConcepto = #nomcalli#5;
     |FINSI;

     |SI #nomyrenm#14 = "H";
          nConcepto     = #nomhicli#4;
          nUnidades     = #nomhicli#11;
          nValor        = #nomhicli#10;
          nImporteCon   = #nomhicli#11 * #nomhicli#10;
          aDescripcion  = #nomhicli#8;
          aTipoConcepto = #nomhicli#5;
     |FINSI;

     |SI #nomyrenm#14 = "A";
          nConcepto     = #nomcalal#4;
          nUnidades     = #nomcalal#11;
          nValor        = #nomcalal#10;
          nImporteCon   = #nomcalal#11 * #nomcalal#10;
          aDescripcion  = #nomcalal#8;
          aTipoConcepto = #nomcalal#5;
     |FINSI;

     |HAZ GrabaConcepto;
|FPRC;

|DEFBUCLE nomcalal;
     #nomcalal#1;
     ;
     #nomcalac#0, #nomcalac#1, #nomcalac#2, #nomcalac#3, 101;
     #nomcalac#0, #nomcalac#1, #nomcalac#2, #nomcalac#3, 999;
     ;
     NULL, PrepConceptos;
|FIN;

|DEFBUCLE nomhicli;
     #nomhicli#1;
     ;
     #nomhicca#0, #nomhicca#1, #nomhicca#66, #nomhicca#2, #nomhicca#3, 101;
     #nomhicca#0, #nomhicca#1, #nomhicca#66, #nomhicca#2, #nomhicca#3, 999;
     ;
     NULL, PrepConceptos;
|FIN;

|DEFBUCLE nomcalli;
     #nomcalli#1;
     ;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 101;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 999;
     ;
     NULL, PrepConceptos;
|FIN;

|PROCESO nomconli;
     nConcepto     = #nomconli#2;

     |SI nConcepto = 116; |O nConcepto = 117; |O nConcepto = 118;
          |ACABA;
     |FINSI;

     #nomtmprf#0  = #labtraba#0;    || codigo empresa
     #nomtmprf#2  = #labtraba#77;   || codigo centro
     |HAZ AreaConceptos;
     || ...    #nomtmprf#21 = #labtraba#62;             || area
     #nomtmprf#1  = #labtraba#1;    || codigo trabajador
     #nomtmprf#41 = nAnyTmp;
     #nomtmprf#19 = nCampo19;
     #nomtmprf#23 = nCampo23;
     #nomtmprf#7  = #nomconli#2;
     |LEE 101#nomtmprf.=;
     |SI FSalida ! 0;
         |DDEFECTO #nomtmprf;
         #nomtmprf#0  = #labtraba#0;    || codigo empresa
         #nomtmprf#2  = #labtraba#77;   || codigo centro
         |HAZ AreaConceptos;
         || ... #nomtmprf#21 = #labtraba#62;             || area
         #nomtmprf#1  = #labtraba#1;    || codigo trabajador
         #nomtmprf#41 = nAnyTmp;
         #nomtmprf#19 = nCampo19;
         #nomtmprf#23 = nCampo23;
         #nomtmprf#7  = #nomconli#2;
         |GRABA 020#nomtmprf.b;
     |SINO;
          |SI #nomyrenm#14 = "A"; |O swAtrasosHis = 1;
          |O #nomyrenm#14 = "H";
               || en atrasos tiene que acumular por MES, no tiene que borrar
               || cada mes de cada concepto, si existe, lo conservo
               || en historico tambien
               |LIBERA #nomtmprf;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #nomconli#2 = 431;
          aDescripcion = "ABSENTISMO";
     |SINO;
          aDescripcion = #nomconli#6;
          |HAZ Descripcion;
     |FINSI;

     #nomtmprf#8  = aDescripcion;
     #nomtmprf#9  = 0;
     #nomtmprf#10 = 0;
     #nomtmprf#11 = 0;
     |GRABA 020#nomtmprf.a;
     |LIBERA #nomtmprf;
|FPRC;

|DEFBUCLE nomconli;
     #nomconli#1;
     ;
     #labtraba#87,   0;
     #labtraba#87, 999;
     ;
     NULL, nomconli;
|FIN;

|PROCESO CreaConceptosCero;
     nCampo19 = month;                   || atrasos refundidos

     |SI #nomyrenm#14 = "A"; |O swAtrasosHis = 1; || atrasos, solo un mes
     |O #nomyrenm#14 = "H";
         nCampo19 = #nomyrenm#9;
     |FINSI;

     nCampo23 = inf_tip;
     |SI swPaga = 1;
         nCampo23 = 1;
     |FINSI;

     |BUCLE nomconli;

     #nomconli#2 = 431;
     #nomconli#6 = "ABSENTISMO";
     |HAZ nomconli;
|FPRC;

|PROCESO DesgloseConceptosXML;
     |ABRE #nomdesam;
     |SALVA_FICHA #labtraba;

     |SI #nomyrenm#14 = "M";
          #labtraba#0 = #nomcalca#0;
          #labtraba#1 = #nomcalca#1;
          |LEE 000#labtraba.=;

          |HAZ CreaConceptosCero;

          |BUCLE nomcalli;
     |FINSI;

     |SI #nomyrenm#14 = "H";
          #labtraba#0 = #nomhicca#0;
          #labtraba#1 = #nomhicca#1;
          |LEE 000#labtraba.=;

          |HAZ CreaConceptosCero;

          |BUCLE nomhicli;
     |FINSI;

     |SI #nomyrenm#14 = "A";
          #labtraba#0 = #nomcalac#0;
          #labtraba#1 = #nomcalac#1;
          |LEE 000#labtraba.=;

          |HAZ CreaConceptosCero;

          |BUCLE nomcalal;
     |FINSI;
     |REPON_FICHA #labtraba;
     |CIERRA #nomdesam;
|FPRC;

|PROCESO ERE;
     |SI #nomyrenm#4 ! 0;
          |ACABA;
     |FINSI;
     |SI #nomyrenm#14 = "M";
          |SI #nomcalca#3 ! 0;               || solo tipo 0
               |ACABA;
          |FINSI;
          nume1 = #nomcalca#128;
     |FINSI;
     |SI #nomyrenm#14 = "H";
          |SI #nomhicca#3 ! 0;               || solo tipo 0
               |ACABA;
          |FINSI;
          nume1 = #nomhicca#170;

          #labtraba#0 = #nomhicca#0;
          #labtraba#1 = #nomhicca#1;
          |LEE 000#labtraba.=;
     |FINSI;


     nBaseERE = 0;
     nCuotaERE = 0;
     nCompERE = 0;
     |SI nume1 > 0;
          |ABRE #nomtraca;
          |ABRE #nomepigr;
          |ABRE #nomconst;

          nCConst = #labtraba#248;
          |HAZ constante;

          #nomepigr#0 = 126;
          |LEE 000#nomepigr.=;

          nBaseERE = nume1;
          nCuotaERE = (nBaseERE % #nomconst#6) ! 2;
          nCuotaERE = nCuotaERE + ((nBaseERE % #nomconst#12) ! 2);
          nCuotaERE = nCuotaERE + ((nBaseERE % #nomconst#14) ! 2);
          nCuotaERE = nCuotaERE + ((nBaseERE % #nomconst#16) ! 2);
          nCuotaERE = nCuotaERE + ((nBaseERE % (#nomepigr#1 + #nomepigr#2)) ! 2);

          |CIERRA #nomconst;
          |CIERRA #nomepigr;
          |CIERRA #nomtraca;
     |FINSI;

     || ahora para lo del modulo de Qualitas, busco el importe del concepto
     || 404 si es el convenio 327
     |SI #nomyrenm#14 = "M"; |Y #labtraba#87 = 327;
          |ABRE #nomcalli;
          #nomcalli#0 = #nomcalca#0;
          #nomcalli#1 = #nomcalca#1;
          #nomcalli#2 = #nomcalca#2;
          #nomcalli#3 = #nomcalca#3;
          #nomcalli#4 = 404;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;
               nCompERE = (#nomcalli#10 * #nomcalli#11) ! 2;
          |FINSI;
          |CIERRA #nomcalli;
     |FINSI;
     |SI #nomyrenm#14 = "H"; |Y #labtraba#87 = 327;
          |ABRE #nomhicli;
          #nomhicli#0 = #nomhicca#0;
          #nomhicli#1 = #nomhicca#1;
          #nomhicli#2 = #nomhicca#2;
          #nomhicli#3 = #nomhicca#3;
          #nomhicli#12 = #nomhicca#66;
          #nomhicli#4 = 404;
          |LEE 000#nomhicli.=;
          |SI FSalida = 0;
               nCompERE = (#nomhicli#10 * #nomhicli#11) ! 2;
          |FINSI;
          |CIERRA #nomhicli;
     |FINSI;
|FPRC;
____________________________________/ IMPORTE TC1
____________________________________/ PASE DE VARIABLES
|PROCESO puecentro;
    pinf_enf = cinf_enf;
    pinf_sub = cinf_sub;
    pinf_bru = cinf_bru;
    pinf_dto = cinf_dto;
    pinf_ded = cinf_ded;
    pinf_dse = cinf_dse;
    pinf_liq = cinf_liq;
    pinf_sss = cinf_sss;
    pinf_bon = cinf_bon;
    pinf_pro = cinf_pro;
    pinf_exe = cinf_exe;
|FPRC;

|PROCESO puegrupos;
    pinf_enf = ginf_enf;
    pinf_sub = ginf_sub;
    pinf_bru = ginf_bru;
    pinf_dto = ginf_dto;
    pinf_ded = ginf_ded;
    pinf_dse = ginf_dse;
    pinf_liq = ginf_liq;
    pinf_sss = ginf_sss;
    pinf_bon = ginf_bon;
    pinf_pro = ginf_pro;
    pinf_exe = ginf_exe;
|FPRC;
____________________________________/ LIMPIEZA DE VARIABLES
|PROCESO limpdetalleH;
    inf_enf = 0;
    inf_sub = 0;
    inf_bru = 0;
    inf_dto = 0;
    inf_ded = 0;
    inf_dse = 0;
    inf_liq = 0;
    inf_sss = 0;
    inf_bon = 0;
    inf_for = 0;
    inf_pro = 0;
    inf_exe = 0;
    inf_prest_enf_emp = 0;
    inf_prest_enf_ss = 0;
    inf_comp_enf = 0;
    inf_prest_acc_ss = 0;
    inf_comp_acc = 0;
    inf_dias = 0;
     inf_basecc = 0;
     inf_basecp = 0;
     inf_hasehe_fm = 0;
     inf_basehe_nor = 0;
     inf_baseirpf = 0;
     inf_baseirpfes = 0;
     inf_baseirpfpa = 0;
     inf_dtoirpfpa = 0;
     inf_dtoirpfes = 0;
     inf_dtoirpfdi = 0;

    inf_ant1 = 0;
    inf_ant2 = 0;
    inf_ant3 = 0;
    inf_antp = 0;
    inf_emb = 0;
    inf_esp = 0;
    inf_cere = 0;    || complemento 30% en ERE para modulo Qualitas
    inf_ssere = 0;   || seg. social en ERE
    imp_paga = 0;

     || campos aplazamiento

     || A. DEUDA NO APLAZABLE
     || 1. aportacion trabajador
     inf_cc_tra = 0;
     inf_he_tra = 0;
     inf_des_tra = 0;
     inf_fp_tra = 0;

     || 2. cuotas atep
     inf_atep = 0;

     || 3. suma 1 + 2
     inf_suma_12 = 0;

     || 4. prestaciones pago delegado
     inf_pres_cp = 0;

     || 5. diferencia 3 - 4
     inf_dif_34 = 0;

     || 7. total no aplazable
     inf_tot_noaplaz = 0;

     || B. DEUDA APLAZABLE
     || 1. cuotas
     inf_cc_emp = 0;
     inf_he_emp = 0;
     inf_des_emp = 0;
     inf_fog_emp = 0;
     inf_fp_emp = 0;

     || 2. total cuotas
     inf_tot_cuota_emp = 0;

     || 3. deducciones
     inf_pres_cc = 0;
     inf_bonred_emp = 0;

     || 4. total deducciones
     inf_totded_emp = 0;

     || 5. diferencia aplazable
     inf_dif_aplaz = 0;

     || 8. total aplazable 5
     inf_tot_aplaz = 0;

     || C. TOTAL DEUDA
     inf_tot_deuda = 0;
|FPRC;

|PROCESO limpgrupos;
    ginf_enf = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_bon = 0;
    ginf_pro = 0;
    ginf_exe = 0;
|FPRC;

|PROCESO limparcial;
    cinf_enf = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_bon = 0;
    cinf_pro = 0;
    cinf_exe = 0;
|FPRC;

|PROCESO limptotal;
    tinf_enf = 0;
    tinf_sub = 0;
    tinf_bru = 0;
    tinf_dto = 0;
    tinf_ded = 0;
    tinf_dse = 0;
    tinf_liq = 0;
    tinf_sss = 0;
    tinf_bon = 0;
    tinf_pro = 0;
    tinf_exe = 0;
    tinf_tc1 = 0;
    aFuenteTotal = "";
    tinf_tc1re = 0;
|FPRC;

|PROCESO silcon15;
     swAgrarios = 1;
|FPRC;

|DEFBUCLE silcon15;           || este bucle mira si algun centro de los
     #silcon15#1;             || que pedimos el resumen es agario mirando
     2;                       || si en el silcon15 existe alguno con el
     empresa, #nomyrenm#11, nRegimen;        || regimen igual al 613
     empresa, #nomyrenm#12, nRegimen;
     ;
     NULL, silcon15;
|FIN;

/****************************************************************************/
/************* PAGAS PRORRATEADAS EN REMUNERACION Y NO EN PRORRATA **********/
/****************************************************************************/

|PROCESO PagasProrr;
     import = 0;
     |SI #nomyrenm#14 = "M";
          concep = #nomcalli#4;
          import = (#nomcalli#9 * #nomcalli#10) ! 2;
     |FINSI;
     |SI #nomyrenm#14 = "H";
          concep = #nomhicli#4;
          import = (#nomhicli#9 * #nomhicli#10) ! 2;
     |FINSI;
     |SI #nomyrenm#14 = "A";
          concep = #nomcalal#4;
          import = (#nomcalal#9 * #nomcalal#10) ! 2;
     |FINSI;
     |SI concep ] 201; |Y concep [ 208;
          |ABRE #nomconca;
          #nomconca#0 = #labtraba#87;
          |LEE 000#nomconca.=;
          |SI FSalida ! 0;
               |CIERRA #nomconca;
               |ACABA;
          |FINSI;

          numer = concep - 200 + 19;
          numerl = concep - 88;
          |SI #labtraba#numerl# = "S"; |O #nomconca#numer# = 99;
               inf_pro = inf_pro - import;
          |FINSI;
          |CIERRA #nomconca;
     |FINSI;
|FPRC;

|DEFBUCLE PagasProrrAtr;
     #nomcalal#1;
     ;
     #nomcalal#0, #nomcalal#1, #nomcalal#2, #nomcalal#3, 101;
     #nomcalal#0, #nomcalal#1, #nomcalal#2, #nomcalal#3, 999;
     ;
     NULL, PagasProrr;
|FIN;

|DEFBUCLE PagasProrrHis;
     #nomhicli#1;
     ;
     #nomhicca#0, #nomhicca#1, #nomhicca#66, #nomhicca#2, #nomhicca#3, 101;
     #nomhicca#0, #nomhicca#1, #nomhicca#66, #nomhicca#2, #nomhicca#3, 999;
     ;
     NULL, PagasProrr;
|FIN;

|DEFBUCLE PagasProrrMen;
     #nomcalli#1;
     ;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 201;
     #nomcalca#0, #nomcalca#1, #nomcalca#2, #nomcalca#3, 208;
     ;
     NULL, PagasProrr;
|FIN;

/****************************************************************************/

/**************************************************/
/*             PROCESO HISTORICO                  */
/**************************************************/

|PROCESO RecargoRLC;
     |ABRE #cretam37;
     #cretam37#0 = #cretam02#0;
     #cretam37#1 = #cretam02#1;
     #cretam37#2 = #cretam02#2;
     #cretam37#3 = #cretam02#3;
     #cretam37#4 = #cretam02#4;
     #cretam37#5 = 000;
     |LEE 000#cretam37.=;
     |SI FSalida = 0;
          aAlfa = #cretam37#6;
          |QBF aAlfa;
          aAlfa = aAlfa % 107;
          |SI aAlfa = "RECARGO"; |Y #cretam37#8 ! 0;
               swMora = 1;
               nRecargo = #cretam37#8;
          |FINSI;
     |FINSI;
     |CIERRA #cretam37;
|FPRC;

|PROCESO RecargoDCL;
     |ABRE #cretam35;
     #cretam35#0 = #cretam02#0;
     #cretam35#1 = #cretam02#1;
     #cretam35#2 = #cretam02#2;
     #cretam35#3 = #cretam02#3;
     #cretam35#4 = #cretam02#4;
     #cretam35#5 = 000;
     |LEE 000#cretam35.=;
     |SI FSalida = 0;
          aAlfa = #cretam35#6;
          |QBF aAlfa;
          aAlfa = aAlfa % 107;
          |SI aAlfa = "RECARGO"; |Y #cretam35#8 ! 0;
               swMora = 1;
               nRecargo = #cretam35#8;
          |FINSI;
     |FINSI;
     |CIERRA #cretam35;
|FPRC;

|PROCESO leyendo_creta;
     swMora = 0;
     nRecargo = 0;

     nMesAux = #cretam02#2;
     nAnyAux = #cretam02#1;
     |SI nAnyAux [ #cretam00#10;
          |SI nAnyAux < #cretam00#10;
               |ACABA;
          |SINO;
               |SI nMesAux < #cretam00#9;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     swCretaLeido = 1;

     hay_algo = 1;
     tinf_tc1re = tinf_tc1re + #cretam02#16;
     swHayCreta = 1;
     |SI #cretam02#22 = "B";
          aFuenteTotal = "(Borrador)";
          |HAZ RecargoDCL;
     |FINSI;
     |SI #cretam02#22 = "C";
          aFuenteTotal = "(Consolidado)";
          |HAZ RecargoRLC;
     |FINSI;

     |SI nTipo ] 05; |Y nTipo [ 20;
          || atrasos, leelo solo una vez, que el importe del siltra
          || me lo guardo en todos los meses que comprenden los atrasos
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE lee_creta;
     #cretam02#1;
     ;
     empresa, nAnyCretaDesde, nMesCretaDesde, nTipo, "               ";
     empresa, nAnyCretaHasta, nMesCretaHasta, nTipo, "zzzzzzzzzzzzzzz";
     ;
     NULL, leyendo_creta;
|FIN;

|PROCESO CuentaCenHis;
     |SI #labemphi#50 = "A";
          nCenAgrario = nCenAgrario + 1;
     |SINO;
          nCenGeneral = nCenGeneral + 1;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaCenHis;                 || este bucle es para saber si tengo
     #labemphi#1;                             || grabado algun centro agrario en
     ;                                  || los auxiliares tc1, con lo cual
     empresa, 001,  #nomyrenm#5, #nomyrenm#2,  0;      || ya se que aunque NO
     empresa, 999, #nomyrenm#10, #nomyrenm#9, 19;
     ;
     NULL, CuentaCenHis;
|FIN;

|PROCESO BuscaLiqCreta;
     nMesAux = #cretam02#2;
     nAnyAux = #cretam02#1;
     |SI nAnyAux [ #cretam00#10;
          |SI nAnyAux < #cretam00#10;
               |ACABA;
          |SINO;
               |SI nMesAux < #cretam00#9;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     swLiqCreta = 1;
|FPRC;

|DEFBUCLE BuscaLiqCreta;
     #cretam02#1;
     ;
     #labemphi#0, nAnyCretaDesde, nMesCretaDesde, nTipo, "               ";
     #labemphi#0, nAnyCretaHasta, nMesCretaHasta, nTipo, "zzzzzzzzzzzzzzz";
     ;
     NULL, BuscaLiqCreta;
|FIN;

|PROCESO leyendo_tc1H;
     swLiqCreta = 0;
     nAnyCretaDesde = #labemphi#16 + 2000;
     nAnyCretaHasta = #labemphi#16 + 2000;
     nMesCretaDesde = #labemphi#1;
     nMesCretaHasta = #labemphi#1;
     nTipo = #labemphi#2;
     |SI nTipo = 8; |O nTipo = 9;
          nTipo = 0;
     |FINSI;

     |BUCLE BuscaLiqCreta;

     |SI swLiqCreta = 1;
          |ACABA;
     |FINSI;

     |SI #nomyrenm#4 = 0;|O #nomyrenm#4 = 2;
          |SI #labemphi#50 = "A"; |Y #labemphi#18 = 99; |Y swAgrarios = 0;
          |Y nCenAgrario > 0; |Y nCenGeneral > 0;
               |ACABA;
          |SINO;
               |SI #labemphi#2 =  0;|O #labemphi#2 =  8;|O #labemphi#2 =  9;
               |O #labemphi#2 = 10;|O #labemphi#2 = 18;|O #labemphi#2 = 19;
               |O #labemphi#2 =  2;
                    hay_algo = 1;
                    hay_algo_tc1H = 1;
                    tinf_tc1re = tinf_tc1re + #labemphi#20;
                    nImporteTC1 = #labemphi#20;
               |FINSI;
          |FINSI;
      |FINSI;
      |SI #nomyrenm#4 ] 5;
          |SI #labemphi#2 =  5;|O #labemphi#2 =  6;|O #labemphi#2 =  7;
          |O #labemphi#2 = 15;|O #labemphi#2 = 16;|O #labemphi#2 = 17;
               hay_algo = 1;
               hay_algo_tc1H = 1;
               tinf_tc1re = tinf_tc1re + #labemphi#20;
               nImporteTC1 = #labemphi#20;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE lee_tc1H;
 #labemphi#1;
 ;
 empresa, x_centro,  #nomyrenm#5, #nomyrenm#2, nTipo;
 empresa, y_centro, #nomyrenm#10, #nomyrenm#9, nTipo;
 ;
 NULL, leyendo_tc1H;
|FIN;

|PROCESO Aux_tc1H;
     nImporteTC1 = 0;

     |BUCLE lee_tc1H;

     |SI #cretam00#8 = "R"; |Y #labempre#67 = "S";
     |Y swCretaLeido = 0;
          nAnyCretaDesde = #nomyrenm#5 + 2000;
          nAnyCretaHasta = #nomyrenm#10 + 2000;
          nMesCretaDesde = #nomyrenm#2;
          nMesCretaHasta = #nomyrenm#9;
          |SI nTipo ] 05; |Y #nomhicca#213 = 1;
               nTipoAnt = nTipo;
               nTipo = 90;
          |FINSI;
          |BUCLE lee_creta;
          |SI nTipo = 90;
               nTipo = nTipoAnt;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tc1H;
     swMora = 0;
     nRecargo = 0;
     aFuenteTotal = "";
     |SI #nomyrenm#4 = 1;
          |ACABA;
     |FINSI;

     |SI nTipoD = 0; |Y nTipoH = 2;
          |SI #nomyrenm#4 = 2;
               aFuenteTotal = "";
               tinf_tc1re = 0;
          |FINSI;
     |FINSI;

     hay_algo = 0;
     hay_algo_tc1H = 0;
     resumen = #nomyrenm#7;
     tinf_tc1 = (tinf_sss + tinf_dse) - tinf_enf;    || aproximado
     aAunno = "";
     nCenAgrario = 0;
     nCenAgrario = 0;

     x_centro = 99;
     y_centro = 99;
     swAgrarios = 0;
     |SI #cretam00#8 = "R"; |Y #labempre#67 = "S";
          || no entres aqui en creta
     |SINO;
          nRegimen = 613;
          |BUCLE silcon15;
          nRegimen = 163;
          |BUCLE silcon15;
     |FINSI;
     |BUCLE CuentaCenHis;
     nTipo = #nomyrenm#4;
     swCretaLeido = 0;
     |HAZ Aux_tc1H;
/*
     || 20.05.2019
     || ya est  bien de buscar el tipo 8 o 9, esto era de los tiempos del
     || labempax y el labemphi, y ahora provoca que si hay atrasos con tipo 8
     || o 9, cuando sacar resumen mensual coge ese importe, se acabo

     |SI #nomyrenm#4 = 0;
          nTipo = 8;               || solo en el tipo 0
          |HAZ Aux_tc1H;           || leeme tambien formacion y practicas
          nTipo = 9;
          |HAZ Aux_tc1H;
          nTipo = #nomyrenm#4;
     |FINSI;
*/
     |SI hay_algo_tc1H = 0; |O swAgrarios = 1;
          x_centro = #nomyrenm#11;
          y_centro = #nomyrenm#12;
          |SI y_centro = 99; |O y_centro = 999;
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               nTipo = #nomyrenm#4;
               |HAZ Aux_tc1H;

               x_centro =  100;
               y_centro =  999;
               |HAZ Aux_tc1H;
          |FINSI;
/*
          || no busco mas tipo 8 o 9, esto era de cuando el labempax-labemphi

          |SI #nomyrenm#4 = 0;
               nTipo = 8;               || solo en el tipo 0
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               |HAZ Aux_tc1H;           || leeme tambien formacion y practicas
               x_centro =  100;       || asi para que no vuelva a entrar en
               y_centro =  999;          || el 99
               |HAZ Aux_tc1H;           || leeme tambien formacion y practicas

               nTipo = 9;
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               |HAZ Aux_tc1H;
               x_centro =  100;       || asi para que no vuelva a entrar en
               y_centro =  999;          || el 99
               |HAZ Aux_tc1H;           || leeme tambien formacion y practicas
               nTipo = #nomyrenm#4;
          |FINSI;
*/
          |SI hay_algo = 0;
               tinf_tc1re = tinf_tc1;
               aAunno = "- TC1 no calculado";
          |SINO;
               aAunno = "";
          |FINSI;
    |SINO;
          aAunno = "";
    |FINSI;
    |HAZ grabatot;
|FPRC;

____________________________________/ CARGA DE VARIABLES
|PROCESO PagasH_Desglosada;
     |SI #nomhicca#47 ! 0;
          swPaga = 1;
          |HAZ limpdetalleH;
          inf_bru = inf_bru + #nomhicca#47;              || Importe bruto
          |SI inf_tan ! #nomhicca#129;
               inf_tan = 0;                       || Porcentaje
          |FINSI;
          inf_dto = inf_dto + #nomhicca#128;                             || Anticipos P.E.
          |SI #nomhicca#146 ! 0;
               |SI #nomhicca#47 ! 0;
                    nEmbargoPaga = 0;
                    nAnyTmp = #nomhicca#66 + 2000;
                    month = #nomhicca#2;
                    |HAZ EmbargoPaga;
                    |SI nEmbargoPaga ! 0;
                         inf_dto = inf_dto + nEmbargoPaga;
                    |SINO;
                         inf_dto = inf_dto + (#nomhicca#146 - ((#nomhicca#146 * (#nomhicca#46 / (#nomhicca#46 + #nomhicca#47))) ! 2));
                    |FINSI;
               |FINSI;
          |FINSI;

          inf_sub = inf_sub + #nomhicca#47;              || Importe bruto paga
          inf_ded = inf_ded + #nomhicca#17;                              || Deduccion
          inf_liq = inf_bru - inf_ded - inf_dto;
          nAnyTmp = #nomhicca#66 + 2000;
          |HAZ grabatmp;
          swPaga = 0;
     |FINSI;
|FPRC;

|PROCESO pagasH;
     |SI swPagasSN = 2;          || pagas incluidas
     |O enCuadre = 50;
     |O enCuadre = 52;
          inf_bru = inf_bru + #nomhicca#47;              || Importe bruto
          |SI inf_tan ! #nomhicca#129;
               inf_tan = 0;                       || Porcentaje
          |FINSI;
          inf_dto = inf_dto + #nomhicca#128;                             || Anticipos P.E.
          inf_sub = inf_sub + #nomhicca#47;              || Importe bruto paga
          inf_ded = inf_ded + #nomhicca#17;                              || Deduccion
          |SI #nomhicca#146 ! 0;
               |SI #nomhicca#47 ! 0;
                    nEmbargoPaga = 0;
                    nAnyTmp = #nomhicca#66 + 2000;
                    month = #nomhicca#2;
                    |HAZ EmbargoPaga;
                    |SI nEmbargoPaga ! 0;
                         nEmbargo = nEmbargo + nEmbargoPaga;
                    |SINO;
                         nEmbargo = nEmbargo + (#nomhicca#146 - ((#nomhicca#146 * (#nomhicca#46 / (#nomhicca#46 + #nomhicca#47))) ! 2));
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DeduccionesH;
     inf_dto = inf_dto + (#nomhicca#52+#nomhicca#53+#nomhicca#54+#nomhicca#131);      || dtos.varios
     |SI #nomhicca#241 < 0; inf_dto = inf_dto - #nomhicca#241; |FINSI;    || preaviso
     inf_dto = inf_dto + #nomhicca#242;                            || vacaciones

     nEmbargo = 0;
     |SI #nomhicca#146 ! 0;
          |SI #nomhicca#47 = 0;
               nEmbargo = #nomhicca#146;
          |SINO;
               nEmbargoPaga = 0;
               nAnyTmp = #nomhicca#66 + 2000;
               month = #nomhicca#2;
               |HAZ EmbargoPaga;
               |SI nEmbargoPaga ! 0;
                    nEmbargo = (#nomhicca#146 - nEmbargoPaga);
               |SINO;
                    nEmbargo = ((#nomhicca#146 * (#nomhicca#46 / (#nomhicca#46 + #nomhicca#47))) ! 2);
               |FINSI;
          |FINSI;
     |FINSI;

     inf_tan = #nomhicca#13;                                            || (%)IRPF 1
     inf_ded = inf_ded + #nomhicca#114;                                 || ret. IRPF
     inf_dse = inf_dse + (#nomhicca#48+#nomhicca#49+#nomhicca#50+#nomhicca#51+#nomhicca#207);            || deduc.S.S.
|FPRC;

|PROCESO DesFP;
     |ABRE #nomconst;

     nPorDes = 0;
     nPorFP = 0;
     nCuotaDes = 0;
     nCuotaFP = 0;

     |SI #nomyrenm#14 = "M";
          nCConst = #nomcalca#163;
     |FINSI;
     |SI #nomyrenm#14 = "H";
          nCConst = #nomhicca#205;
     |FINSI;

     |HAZ constante;

     nPorDes = #nomconst#13;
     nPorFP = #nomconst#17;

     |SI #nomyrenm#14 = "M";
          |SI #nomcalca#49 ! 0;
               |SI nPorDes ! 0;
                    nCuotaDes = (#nomcalca#40 % nPorDes) ! 2;
               |FINSI;
               |SI nPorFP ! 0;
                    nCuotaFP = (#nomcalca#40 % nPorFP) ! 2;
               |FINSI;
               |SI #labtraba#190 = "S"; |Y #nomcalca#142 ! 0;
                    nCuotaDes = #nomcalca#142;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #nomyrenm#14 = "H";
          |SI #nomhicca#49 ! 0;
               |SI nPorDes ! 0;
                    nCuotaDes = (#nomhicca#40 % nPorDes) ! 2;
               |FINSI;
               |SI nPorFP ! 0;
                    nCuotaFP = (#nomhicca#40 % nPorFP) ! 2;
               |FINSI;
               |SI #labtraba#190 = "S"; |Y #nomhicca#184 ! 0;
                    nCuotaDes = #nomhicca#184;
               |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #nomconst;
|FPRC;

|PROCESO detalleH;
     |SI swDesglose = 1;
          |HAZ limpdetalleH;
     |FINSI;

     inf_enf = inf_enf + (#nomhicca#57+#nomhicca#58);                         || prestacion
     inf_sub = inf_sub + (#nomhicca#46+#nomhicca#45-#nomhicca#57-#nomhicca#58);            || coste
     inf_bru = inf_bru + #nomhicca#46;                                  || bruto

     |SI enCuadre ! 52
          |HAZ DeduccionesH;
     |FINSI;
     |HAZ pagasH;
     inf_dto = inf_dto + nEmbargo;

    inf_sss = inf_sss + #nomhicca#45;                                  || S.S.empr.
    inf_bon = inf_bon + #nomhicca#63 + #nomhicca#64 + #nomhicca#123 + #nomhicca#130 + #nomhicca#138;   || bonif
    inf_bon = inf_bon + #nomhicca#143 + #nomhicca#144 + #nomhicca#148 + #nomhicca#167 + #nomhicca#175;
    inf_bon = inf_bon + #nomhicca#185 + #nomhicca#186 + #nomhicca#212 + #nomhicca#225;
    inf_for = inf_for + #nomhicca#64 + #nomhicca#225;
    inf_exe = inf_exe + #nomhicca#18;                                  || IRPF exen.
    inf_tip = #nomhicca#3;
    inf_ant1 = inf_ant1 + #nomhicca#52;
    inf_ant2 = inf_ant2 + #nomhicca#53;
    inf_ant3 = inf_ant3 + #nomhicca#131;
    inf_antp = inf_antp + #nomhicca#128;
    inf_emb = inf_emb + nEmbargo;
    inf_esp = inf_esp + #nomhicca#54;

    imp_paga = imp_paga + #nomhicca#47;

    inf_prest_enf_ss = inf_prest_enf_ss + #nomhicca#57;
    inf_prest_enf_emp = inf_prest_enf_emp + #nomhicca#112;
    inf_comp_enf = inf_comp_enf + #nomhicca#59;
    inf_prest_acc_ss = inf_prest_acc_ss + #nomhicca#58;
    inf_comp_acc = inf_comp_acc + #nomhicca#60;
    inf_dias = inf_dias + #nomhicca#8;

     |SI #nomyrenm#30 = 4;                               || cuadre 04 para Qualitas
          |HAZ ERE;
          inf_cere = inf_cere + nCompERE;
          inf_ssere = inf_ssere + nCuotaERE;
     |FINSI;

     nAnyTmp = #nomhicca#66 + 2000;
     month = #nomhicca#2;
     |SI swDesglose = 1;
          month = #nomhicca#2;
          nAnyTmp = #nomhicca#66 + 2000;
     |FINSI;

     |SI #nomyrenm#30 = 10;        || desglose conceptos para XML ADADE
     |O #nomyrenm#30 ] 50;         || y para AYESA - PLUSGESTIONA !!
          |HAZ DesgloseConceptosXML;
     |FINSI;

     inf_liq = inf_bru -inf_dto -inf_ded -inf_dse;               || liquido
     inf_pro = inf_pro + #nomhicca#38;   || prorrata
     ||SI #nomcont3#2 = "S";
          || para todos
          |SALVA_FICHA #labtraba;
          #labtraba#0 = #nomhicca#0; #labtraba#1 = #nomhicca#1; |LEE 000#labtraba.=;
          |BUCLE PagasProrrHis;
          |REPON_FICHA #labtraba;
     ||FINSI;

    inf_basecc = inf_basecc + #nomhicca#39 + #nomhicca#121;
    inf_basecp = inf_basecp + #nomhicca#40 + #nomhicca#122;
    inf_hasehe_fm = inf_hasehe_fm + #nomhicca#41;
    inf_basehe_nor = inf_basehe_nor + #nomhicca#42;
    inf_baseirpf = inf_baseirpf + #nomhicca#14;
    inf_baseirpfpa = inf_baseirpfpa + #nomhicca#16;
    inf_dtoirpfpa = inf_dtoirpfpa + #nomhicca#17;
    inf_baseirpfes = inf_baseirpfes + #nomhicca#108 + #nomhicca#109;
    inf_dtoirpfes = inf_dtoirpfes + #nomhicca#110 + #nomhicca#111;
    inf_dtoirpfdi = inf_dtoirpfdi + #nomhicca#15 + #nomhicca#17;

     || campos aplazamiento

     || A. DEUDA NO APLAZABLE
     || 1. aportacion trabajador
     inf_cc_tra = inf_cc_tra + #nomhicca#48;
     inf_he_tra = inf_he_tra + #nomhicca#50 + #nomhicca#51;
     |HAZ DesFP;
     inf_des_tra = inf_des_tra + nCuotaDes;
     inf_fp_tra = inf_fp_tra + nCuotaFP;

     || 2. cuotas atep
     inf_atep = inf_atep + #nomhicca#219 + #nomhicca#220;

     || 3. suma 1 + 2
     nSuma12 = #nomhicca#48 + #nomhicca#50 + #nomhicca#51;
     nSuma12 = nSuma12 + nCuotaDes + nCuotaFP;
     nSuma12 = nSuma12 + #nomhicca#219 + #nomhicca#220;

     inf_suma_12 = inf_suma_12 + nSuma12;

     || 4. prestaciones pago delegado
     inf_pres_cp = inf_pres_cp + #nomhicca#58;

     || 5. diferencia 3 - 4
     inf_dif_34 = inf_dif_34 + nSuma12 - #nomhicca#58;

     || 7. total no aplazable
     inf_tot_noaplaz = inf_tot_noaplaz + (nSuma12 - #nomhicca#58);

     || B. DEUDA APLAZABLE
     || 1. cuotas
     inf_cc_emp = inf_cc_emp + #nomhicca#215;
     inf_he_emp = inf_he_emp + #nomhicca#221;
     inf_des_emp = inf_des_emp + #nomhicca#216;
     inf_fog_emp = inf_fog_emp + #nomhicca#217;
     inf_fp_emp = inf_fp_emp + #nomhicca#218;

     || 2. total cuotas
     nCuotaEmp = #nomhicca#215 + #nomhicca#221;
     nCuotaEmp = nCuotaEmp + #nomhicca#216 + #nomhicca#217 + #nomhicca#218;
     inf_tot_cuota_emp = inf_tot_cuota_emp + nCuotaEmp;

     || 3. deducciones
     inf_pres_cc = inf_pres_cc + #nomhicca#57;
     inf_bonred_emp = inf_bonred_emp + #nomhicca#222;

     || 4. total deducciones
     inf_totded_emp = inf_totded_emp + #nomhicca#57 + #nomhicca#222;

     || 5. diferencia aplazable
     inf_dif_aplaz = inf_dif_aplaz + nCuotaEmp - #nomhicca#57 - #nomhicca#222;

     || 8. total aplazable 5
     inf_tot_aplaz = inf_tot_aplaz + nCuotaEmp - #nomhicca#57 - #nomhicca#222;

     || C. TOTAL DEUDA
     inf_tot_deuda = inf_tot_deuda + nSuma12 - #nomhicca#58 - #nomhicca#222;
     inf_tot_deuda = inf_tot_deuda + nCuotaEmp - #nomhicca#57 - #nomhicca#222;

     || fin campos aplazamiento

     |SI enCuadre = 51;
          inf_dtoirpfdi = inf_dtoirpfdi - #nomhicca#17;
     |FINSI;

     nAnyTmp = #nomhicca#66 + 2000;
     month = #nomhicca#2;
     |SI swDesglose = 1;
          month = #nomhicca#2;
          nAnyTmp = #nomhicca#66 + 2000;
          |HAZ grabatmp;
          |HAZ PagasH_Desglosada;
     |FINSI;
|FPRC;

|PROCESO PagasHgrupos;
     |SI swPagasSN = 2;
          ginf_bru = ginf_bru + #nomhicca#47;              || Importe bruto
          ginf_sub = ginf_sub + #nomhicca#47;              || Importe bruto
          ginf_dto = ginf_dto + #nomhicca#128;             || Anticipos P.E.
          ginf_ded = ginf_ded + #nomhicca#17;              || Deduccion
     |FINSI;
|FPRC;

|PROCESO gruposH;
    ginf_enf = ginf_enf + (#nomhicca#57+#nomhicca#58);             || prestacion
    ginf_sub = ginf_sub + (#nomhicca#46+#nomhicca#45-#nomhicca#57-#nomhicca#58);        || coste
    ginf_bru = ginf_bru + #nomhicca#46;                                 || bruto
    ginf_dto = ginf_dto + (#nomhicca#52+#nomhicca#53+#nomhicca#54+#nomhicca#131+nEmbargo);     || dtos.varios
    |SI #nomhicca#241 < 0; ginf_dto = ginf_dto - #nomhicca#241; |FINSI;    || preaviso
    ginf_dto = ginf_dto + #nomhicca#242;                            || vacaciones
    ginf_ded = ginf_ded + #nomhicca#114;                                || ret. IRPF
    |HAZ PagasHgrupos;
    ginf_dse = ginf_dse + (#nomhicca#48+#nomhicca#49+#nomhicca#50+#nomhicca#51+#nomhicca#207);           || deduc.S.S.
    ginf_bon = ginf_bon + #nomhicca#63 + #nomhicca#64 + #nomhicca#123 + #nomhicca#130 + #nomhicca#138;   || bonif
    ginf_bon = ginf_bon + #nomhicca#143 + #nomhicca#144 + #nomhicca#148 + #nomhicca#167;   || bonif
    ginf_bon = ginf_bon + #nomhicca#185 + #nomhicca#186 + #nomhicca#212;            || bonif

    ginf_sss = ginf_sss + #nomhicca#45;                      || S.S.empr.
    ginf_exe = ginf_exe + #nomhicca#18;                                 || IRPF exen.

    ginf_liq = ginf_bru - ginf_dto - ginf_ded - ginf_dse;        || liquido
    ginf_pro = ginf_pro + #nomhicca#38;   || prorrata
|FPRC;

|PROCESO PagasHcentros;
     |SI swPagasSN = 2;
          cinf_bru = cinf_bru + #nomhicca#47;              || Importe bruto
          cinf_sub = cinf_sub + #nomhicca#47;              || Importe bruto
          cinf_dto = cinf_dto + #nomhicca#128;             || Anticipos P.E.
          cinf_ded = cinf_ded + #nomhicca#17;              || Deduccion
     |FINSI;
|FPRC;

|PROCESO centrosH;
    cinf_enf = cinf_enf + (#nomhicca#57+#nomhicca#58);             || prestacion
    cinf_sub = cinf_sub + (#nomhicca#46+#nomhicca#45-#nomhicca#57-#nomhicca#58);        || coste
    cinf_bru = cinf_bru + #nomhicca#46;                                 || bruto
    cinf_dto = cinf_dto + (#nomhicca#52+#nomhicca#53+#nomhicca#54+#nomhicca#131+nEmbargo);     || dtos.varios
    |SI #nomhicca#241 < 0; cinf_dto = cinf_dto - #nomhicca#241; |FINSI;    || preaviso
    cinf_dto = cinf_dto + #nomhicca#242;                           || vacaciones
    cinf_ded = cinf_ded + #nomhicca#114;                                || ret. IRPF
    |HAZ PagasHcentros;
    cinf_dse = cinf_dse + (#nomhicca#48+#nomhicca#49+#nomhicca#50+#nomhicca#51+#nomhicca#207);           || deduc.S.S.
    cinf_bon = cinf_bon + #nomhicca#63 + #nomhicca#64 + #nomhicca#123 + #nomhicca#130 + #nomhicca#138; || bonif
    cinf_bon = cinf_bon + #nomhicca#143 + #nomhicca#144 + #nomhicca#148 + #nomhicca#167;   || bonif
    cinf_bon = cinf_bon + #nomhicca#185 + #nomhicca#186 + #nomhicca#212;            || bonif
    cinf_sss = cinf_sss + #nomhicca#45;                      || S.S.empr.
    cinf_exe = cinf_exe + #nomhicca#18;                                 || IRPF exen.

    cinf_liq = cinf_bru - cinf_dto - cinf_ded - cinf_dse;        || liquido
    cinf_pro = cinf_pro + #nomhicca#38; || prorrata
|FPRC;

|PROCESO &totalesH;
    tinf_enf = tinf_enf + inf_enf;
    tinf_sub = tinf_sub + inf_sub;
    tinf_bru = tinf_bru + inf_bru;
    tinf_dto = tinf_dto + inf_dto;
    tinf_ded = tinf_ded + inf_ded;
    tinf_dse = tinf_dse + inf_dse;
    tinf_sss = tinf_sss + inf_sss;
    tinf_bon = tinf_bon + inf_bon;
    tinf_pro = tinf_pro + inf_pro;
    tinf_exe = tinf_exe + inf_exe;

    tinf_liq = tinf_bru - tinf_dto - tinf_ded - tinf_dse;
|FPRC;

|PROCESO rup_empreH;
     |SI swDesglose = 1; |ACABA; |FINSI;
    swlin = 2;
    #labempre#0 = g_empresa;
|LEE 020#labempre.=;
    FSalida = "PAGINA";
|HAZ ElPRINT;
|HAZ limptotal;
    empresa = g_empresa;
    swlin = 0;
|FPRC;

|PROCESO rup_centrH;
     |SI swDesglose = 1; |ACABA; |FINSI;
|HAZ lee_centro;
    swlin = 1;
    varinf1 = "Centro: " + #4#1 + "/" + #4#2;
|HAZ puecentro;
|SI nNumTrabCen > 0;
     |HAZ ElPRINT;
|FINSI;
|HAZ limparcial;
    centro = g_centro;
    swlin = 0;
|FPRC;

|PROCESO rup_areasH;
     |SI swDesglose = 1; |ACABA; |FINSI;
|SI #nomyrenm#6 = "S";
    |HAZ lee_area;
        swlin = 1;
        varinf1 = "Area: " + #5#0 + "/" + #5#1;
    |HAZ puegrupos;
    |HAZ ElPRINT;
    |HAZ limpgrupos;
        grupo = g_grupo;
        swlin = 0;
|FINSI;
|FPRC;

|PROCESO rup_trabaH;
     |SI swDesglose = 1; |ACABA; |FINSI;
     #labempre#0 = empresa;
     |LEE 000#labempre.=;
     |SI FSalida = 0;
          #labtraba#0 = empresa;
          #labtraba#1 = trabaja;
          |LEE 000#labtraba.=;
          |SI FSalida = 0;
               swlin = 0;
               nNumTrabEmp = nNumTrabEmp + 1;
               nNumTrabCen = nNumTrabCen + 1;
               |HAZ ElPRINT;
               |HAZ grabatmp;
               |HAZ limpdetalleH;
               swlin = 0;
          |FINSI;
     |FINSI;
     trabaja = g_trabaja;
|FPRC;

|PROCESO imprimirH;
     |SI #nomhicca#66 = #nomyrenm#5;
          |SI #nomhicca#2 < #nomyrenm#2;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #nomhicca#66 = #nomyrenm#10;
          |SI #nomhicca#2 > #nomyrenm#9;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI swDesglose = 1;
          |SI #nomhicca#3 = 1;
               |ACABA;
          |FINSI;
     |FINSI;

     |DDEFECTO #labempre;
     #labempre#0 = #nomhicca#0;
     |LEE 000#labempre.=;                       || lee la empresa
     |SI FSalida = 0;|Y #labempre#36 ! "N";    || si resumen impreso SI
          #labtraba#0 = #nomhicca#0;
          #labtraba#1 = #nomhicca#1;
          |LEE 000#labtraba.=;                   || lee el trabajador
          |SI FSalida = 0;
               g_empresa = #labtraba#0;
               g_trabaja = #labtraba#1;      || se guardan porque en la impresion
               g_centro = #labtraba#77;      || se lee el trabajador
               g_grupo = #labtraba#62;
               |SI sw = 0;
                    empresa = #labtraba#0;
                    trabaja = #labtraba#1;
                    centro = #labtraba#77;
                    grupo = #labtraba#62;
                    sw = 1;
               |FINSI;
               |SI empresa ! g_empresa;             || ruptura por empresa
                    |HAZ rup_trabaH;
                    |HAZ rup_areasH;
                    |HAZ rup_centrH;
                    |HAZ rup_empreH;
                    nNumTrabEmp = 0;
                    nNumTrabCen = 0;
               |SINO;
                    |SI centro ! g_centro;           || ruptura por centro
                         |HAZ rup_trabaH;
                         |HAZ rup_areasH;
                         |HAZ rup_centrH;
                         nNumTrabCen = 0;
                    |SINO;
                         |SI grupo ! g_grupo;|Y #nomyrenm#6 = "S";     || ruptura por areas
                              |HAZ rup_trabaH;
                              |HAZ rup_areasH;
                         |SINO;
                              |SI trabaja ! g_trabaja;
                                   |HAZ rup_trabaH;      || ruptura por trabajador
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |HAZ notarias;        || lee (%) notarias
               |HAZ detalleH;         || acumula por trabajador
               |HAZ gruposH;          || acumula por areas
               |HAZ centrosH;         || acumula por centros
               ||HAZ totales;         || acumula por empresa
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO lee_traba;
     |DDEFECTO #labtraba;
     #labtraba#0 = #nomhicca#0;
     #labtraba#1 = #nomhicca#1;
     |LEE 000#labtraba.=;
     |SI #labtraba#77 < nDesdeCen; |O #labtraba#77 > nHastaCen;
          |ERROR;
     |SINO;
          swbaja = 0;
          fecalf = #nomhicca#5;

          alfa1 = fecalf %  102;   dia = alfa1;
          alfa1 = fecalf %  402;   zmes = alfa1;
          alfa1 = fecalf % -102;   any = alfa1;
          |SI alfa1 = "....";
               dia = 0;
               zmes = 0;
               any = 0;
          |FINSI;

          |SI any ] #nomyrenm#5;|Y any [ #nomyrenm#10;
               |SI zmes ] #nomyrenm#2;|Y zmes [ #nomyrenm#9;
                    swbaja = 1;
               |FINSI;
          |FINSI;

          |SI swDesglose = 1;
               |SI #labtraba#44 = "B";
                    swbaja = 1;
               |FINSI;
          |FINSI;

          |SI #nomyrenm#13 ! "T";
               |SI #nomyrenm#13 = "A";|Y swbaja = 1;   |ERROR;  |FINSI;
               |SI #nomyrenm#13 = "B";|Y swbaja = 0;   |ERROR;  |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE area_si1;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#62,#150#1,#100#66,#100#2,#100#3;
|FIN;

|DEFBUCLE area_no1;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#1,#100#66,#100#2,#100#3;
|FIN;

|DEFBUCLE area_si2;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#62,#150#2,#150#1,#100#66,#100#2,#100#3;
|FIN;

|DEFBUCLE area_no2;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#2,#150#1,#100#66,#100#2,#100#3;
|FIN;

|DEFBUCLE area_si3;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#62,#150#31,#150#1,#100#66,#100#2,#100#3;
|FIN;

|DEFBUCLE area_no3;
#nomhicca#1;
;
nDesdeEmp, nDesdeTra,  #nomyrenm#5, 01, #nomyrenm#4;
nHastaEmp, nHastaTra, #nomyrenm#10, 12, #nomyrenm#4;
;
NULL, lee_traba, NULL, NULL, NULL, imprimirH;
#150#0,#150#77,#150#31,#150#1,#100#66,#100#2,#100#3;
|FIN;

|PROCESO centra;         || CENTRA TITULO DEL INFORME
    alfa1 = cabeza % 0;
    nume1 = alfa1;
    nume2 = ((79 - nume1) / 2) - 0.5;
    nume2 = nume2 ! 0;
    alfa1 = " " * nume2;
    cabeza = alfa1 + cabeza;
|FPRC;

|PROCESO el_mes;
|SI mes = 1;   ames = "ENE";  |FINSI;
|SI mes = 2;   ames = "FEB";  |FINSI;
|SI mes = 3;   ames = "MAR";  |FINSI;
|SI mes = 4;   ames = "ABR";  |FINSI;
|SI mes = 5;   ames = "MAY";  |FINSI;
|SI mes = 6;   ames = "JUN";  |FINSI;
|SI mes = 7;   ames = "JUL";  |FINSI;
|SI mes = 8;   ames = "AGO";  |FINSI;
|SI mes = 9;   ames = "SEP";  |FINSI;
|SI mes = 10;  ames = "OCT";  |FINSI;
|SI mes = 11;  ames = "NOV";  |FINSI;
|SI mes = 12;  ames = "DIC";  |FINSI;
|FPRC;

|PROCESO lite_periodoH;
    mes = #nomyrenm#2;     |HAZ el_mes;
    |SI #nomyrenm#5 > 50;
         nume1 = 1900 + #nomyrenm#5;
    |SINO;
         nume1 = 2000 + #nomyrenm#5;
    |FINSI;
    p_mes = ames + "-" + nume1;

    mes = #nomyrenm#9;     |HAZ el_mes;
    |SI #nomyrenm#10 > 50;
         nume1 = 1900 + #nomyrenm#10;
    |SINO;
         nume1 = 2000 + #nomyrenm#10;
    |FINSI;
    p_mes = p_mes + "/" + ames + "-" + nume1;
|FPRC;

|PROCESO ElCuadre;
     swArchivaExcel = 0;
     swErrorImp     = 0;
     enPorEmp       = 1;
     enPorCen       = 0;
     nFinimp        = 0;

     |SI #nomyrenm#4 = nTipoD; |O nTipoD = nTipoH;
          |SI #nomyrenm#30 = 10;
               || excel
               nOpcion = 1;
          |SINO;
               || aqui preguntamos si DsArchi si o no
               eaVengoDe = "nomyrenm";

               nArchi = 0;
               |HAZ MiraSiArchiva;

               |SI swDesglose = 1; || desglosado tampoco a DSArchi
                    nArchi = 0;
               |FINSI;

               |SI nArchi ! 1;
                    || no tengo dsarchi, sigo como siempre
                    nOpcion = 1;
               |SINO;
                    || tengo dsarchi, presento menu

                    enPorEmp = 0;
                    enPorCen = 0;
                    nOpcion = 0;
                    |PARA;  |SI;  |HACIENDO;
                         |MENUG aMenu;
                         nOpcion = FSalida;
                         nOpcionOri = nOpcion;

                         |SI nOpcion = 1;  nOpcion = 1;  enPorEmp = 1;  |SAL;  |FINSI;

                         |SI nOpcion = 3;  nOpcion = 2;  enPorEmp = 1;  |SAL;  |FINSI;
                         |SI nOpcion = 4;  nOpcion = 3;  enPorEmp = 1;  |SAL;  |FINSI;

                         |SI nOpcion = 6;  nOpcion = 2;  enPorCen = 1;  |SAL;  |FINSI;
                         |SI nOpcion = 7;  nOpcion = 3;  enPorCen = 1;  |SAL;  |FINSI;

                         |SI nOpcion = 0;
                              |ACABA;
                         |FINSI;
                    |SIGUE;
               |FINSI;

               |SI nOpcion = 1;
                    |SI #nomyrenm#30 = 02; |O #nomyrenm#30 ] 50;
                         |SI #nomyrenm#0 ! #nomyrenm#1;
                              aAlfa = "    ATENCION: La emisión en EXCEL de varias empresas abrirá ";
                              aAlfa = aAlfa + " sucesiva- mente una hoja EXCEL por empresa. ";
                              |MENAV aAlfa;
                              aAlfa = "    Una selección que incluya muchas empresas puede suponer ";
                              aAlfa = aAlfa + " excesivo tiempo y recursos del sistema.";
                              |MENAV aAlfa;
                              aAlfa = "    N¿Está seguro de que desea continuar?";
                              |CONFI aAlfa;
                              |SI FSalida ! 0;
                                   swErrorImp = 1;
                                   |ACABA;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI nOpcion = 2;
                    |SI enCuadre ] 50; |O enCuadre = 02;
                         swArchivaExcel = 1;
                         nOpcion = 1;
                         || lo tiene que hacer igual, y al final imprimir
                    |FINSI;
               |FINSI;

               |SI nOpcion ! 1;
                    swSigue = 1;
               |FINSI;

               |SI nOpcion ! 1; |Y swSigue = 0;
                    |ACABA;
               |FINSI;

               |SI nOpcion = 1; |O nOpcion = 3;
                    |SI #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
                    |Y #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 55;
                         |SI swDesglose = 1;
                              Impresora = "CrystalReport";
                              |IMPRE -1;
                         |SINO;
                              |IMPRE 0;
                         |FINSI;
                         |SI FSalida ! 0;
                             nOpcion = 0;
                             |ACABA;
                         |FINSI;

                         nFinimp = 1;
                    |FINSI;
               |FINSI;

               |SI nOpcion = 2;
                    Impresora = "CrystalReport";
               |FINSI;

               |SI Impresora = "CrystalReport";
                    swCrystal = 1;
                    |SI #nomyrenm#30 = 03;
                         informe = informecrys3;
                    |SINO;
                         informe = informecrys2;
                    |FINSI;
                    |SI swDesglose = 1;
                         informe = informecrys4;
                    |FINSI;
               |SINO;
                    |SI #nomyrenm#30 = 0;
                         informe = informe;
                    |FINSI;
                    |SI #nomyrenm#30 = 1;
                         informe = informeexcel;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Historico;
     |SI PARAMETRO ! "H";
          |HAZ prepara_impresion;
     |FINSI;

     |SI nOpcion ! 1;
          FSalida = 0;
     |FINSI;

     |SI FSalida = 0;
          |SI #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 04; |Y #nomyrenm#30 ! 10; |Y enWeb = 0;
          |Y #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
          |Y #nomyrenm#30 ! 55;
               |SI nOpcion = 1; |O nOpcion = 3;
                    |INFOR informe;
               |FINSI;
          |FINSI;
          ano = #nomyrenm#5;
          |SI #nomyrenm#4 = 0; tip = "MENSUAL - ";   |FINSI;
          |SI #nomyrenm#4 = 2; tip = "FINIQUITO - "; |FINSI;
          |SI #nomyrenm#4 ] 5; tip = "ATRASOS - ";   |FINSI;
          fecha = #nomyrenm#3;
          |HAZ lite_periodoH;
          cabeza = "RESUMEN HISTORICO NOMINAS " + tip + p_mes;
          |HAZ centra;
          |ABRE #labtraba;
          |ABRE #labempre;
          |SI PARAMETRO = "H";
               |SI #nomyrenm#4 = nTipoD; |O nTipoD = nTipoH;
                    |SI #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 04; |Y #nomyrenm#30 ! 10;
                    |Y #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
                    |Y #nomyrenm#30 ! 55;
                         |SI nOpcion = 1; |O nOpcion = 3;
                              |INFOR informe;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |INFOR informeweb;
          |FINSI;
          nNumTrabEmp = 0;
          nNumTrabCen = 0;
          seleccio = 0;
          trabaja = 0;
          g_trabaja = 0;

          nDesdeEmp = nEmpresa;
          nHastaEmp = nEmpresa;

          nDesdeCen = #nomyrenm#11;
          nHastaCen = #nomyrenm#12;
          |SI enPorCen = 1;
              nDesdeCen = nCentro;
              nHastaCen = nCentro;
          |FINSI;

          |HAZ ResHistorico;

          |HAZ rup_trabaH;
          |HAZ rup_areasH;
          |HAZ rup_centrH;
          |HAZ tc1H;

          |CIERRA #labtraba;
          |CIERRA #labempre;
     |SINO;
         |MENAV "    Proceso abortado ...";
     |FINSI;
|FPRC;

/**************************************************/
/* PROCESO HISTORICO */
/**************************************************/

|PROCESO BuscaHis;
     aAlfa1 = #nomhicca#0; aAlfa1 = "00000" + aAlfa1; aAlfa1 = aAlfa1 % -105;
     aAlfa2 = #nomhicca#1; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
     aAlfa = aAlfa1 + "." + aAlfa2;
     aAlfa = "    ATENCION: el trabajador " + aAlfa + " tiene su nomina actualizada ";
     aAlfa = aAlfa + "en el historico.";
     |MENAV aAlfa;
     swMensaje = 1;
|FPRC;

|DEFBUCLE BuscaHis;
     #nomhicca#1;
     ;
     #nomyrenm#0, nDesdeTra, nAny, nMes, 0;
     #nomyrenm#1, nHastaTra, nAny, nMes, 0;
     ;
     NULL, BuscaHis;
|FINSI;

|PROCESO CompHis;
     |SI aParam = "AUTO";
          |ACABA;
     |FINSI;
     |SI swHayAlgo = 0;
          |ACABA;
     |FINSI;
     nAny = #nomyrenm#16 - 2000;
     nMes = #nomyrenm#15;
     swMensaje = 0;
     |BUCLE BuscaHis;
     |SI swMensaje = 1;
          aAlfa = "    Los datos del informe mensual de la/s empresa/s";
          aAlfa = aAlfa + " mencionadas pueden estar incompletos";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO imprimirM;
     |DDEFECTO #labempre;
     #labempre#0 = #labtraba#0;
     |LEE 020#labempre.=;

     |SI #labempre#36 ! "N";   || si el switch de emision no es "N"
          #nomcalca#0 = #labtraba#0;   || Empresa
          #nomcalca#1 = #labtraba#1;   || Trabajador
          #nomcalca#2 = #nomyrenm#15;  || Mes
          #nomcalca#3 = #nomyrenm#4;   || Tipo
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;

               |HAZ leetraba;
               |SI #nomyrenm#13 ! "T";
                    |SI #nomyrenm#13 = "A";|Y swbaja = 1;   |ACABA;   |FINSI;
                    |SI #nomyrenm#13 = "B";|Y swbaja = 0;   |ACABA;   |FINSI;
               |FINSI;

               |SI sw = 0;
                    seleccio = 1;
                    empresa = #labtraba#0;
                    centro = #labtraba#77;
                    grupo = #labtraba#62;
                    sw = 1;
               |FINSI;
               |SI empresa ! #labtraba#0;                    || ruptura por empresa
                    |HAZ rup_areasM;
                    |HAZ rup_centrM;
                    |HAZ rup_empreM;
                    nNumTrabEmp = 0;
                    nNumTrabCen = 0;
               |SINO;
                    |SI centro ! #labtraba#77;                        || ruptura por centro
                         |HAZ rup_areasM;
                         |HAZ rup_centrM;
                         nNumTrabCen = 0;
                    |SINO;
                         |SI grupo ! #labtraba#62;                     || ruptura por areas
                              |HAZ rup_areasM;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |HAZ notarias;
               nAnyTmp = #nomyrenm#16;
               |HAZ detalleM;
               |HAZ grabatmp;

               nNumTrabEmp = nNumTrabEmp + 1;
               nNumTrabCen = nNumTrabCen + 1;
               |HAZ ElPRINT;

               |HAZ gruposM;
               |HAZ centrosM;
               ||HAZ totalesM;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CuentaCenMen;
     |SI #labempax#50 = "A";
          nCenAgrario = nCenAgrario + 1;
     |SINO;
          nCenGeneral = nCenGeneral + 1;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaCenMen;                 || este bucle es para saber si tengo
     #labempax#1;                             || grabado algun centro agrario en
     ;                                  || los auxiliares tc1, con lo cual
     empresa, 001,  #nomyrenm#2,  0;            || ya se que aunque NO
     empresa, 999,  #nomyrenm#9, 19;
     ;
     NULL, CuentaCenMen;
|FIN;

|PROCESO leyendo_tc1M;
     |SI x_tipo = 5; |Y #labemphi#2 ! 5;  |ACABA;  |FINSI;
     |SI x_tipo = 0; |Y #labemphi#2 = 5;  |ACABA;  |FINSI;

    || Veamos: si es un centro agrario, si es el 99 (el unico que puede ser)
    || si NO he pedido ningun centro agrario en la seleccion y tengo centros
    || de los dos tipos en la misma empresa (solo Federico) NO sumes
    |SI #labempax#50 = "A"; |Y #labempax#18 = 99; |Y swAgrarios = 0; |Y nCenAgrario > 0;
    |Y nCenGeneral > 0;
          |ACABA;
    |SINO;
        hay_algo = 1;
        tinf_tc1re = tinf_tc1re + #labempax#20;
        nImporteTC1 = #labempax#20;
    |FINSI;
|FPRC;

|DEFBUCLE lee_tc1M;
 #labempax#1;
 ;
 empresa, x_centro, desde_mes, nTipo;
 empresa, y_centro, hasta_mes, nTipo;
 ;
 NULL, leyendo_tc1M;
|FIN;

|PROCESO Aux_tc1M;
     nImporteTC1 = 0;

     |BUCLE lee_tc1M;

     |SI #cretam00#8 = "R"; |Y #labempre#67 = "S";
          nAnyCretaDesde = #nomyrenm#16;
          nAnyCretaHasta = #nomyrenm#16;
          nMesCretaDesde = #nomyrenm#15;
          nMesCretaHasta = #nomyrenm#15;
          swHayCreta = 0;
          |BUCLE lee_creta;
          |SI swHayCreta = 1;
               tinf_tc1re = tinf_tc1re - nImporteTC1;  || por si hubiera importe en
                                                       || el auxiliar
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tc1M;
     swMora = 0;
     nRecargo = 0;
     aFuenteTotal = "";
     |SI #nomyrenm#4 = 1;
          |ACABA;
     |FINSI;
     tinf_tc1 = 0;
     hay_algo = 0;
     nCenAgrario = 0;
     nCenGeneral = 0;
     resumen = #nomyrenm#7;
     x_tipo = 0;
     desde_mes = #nomyrenm#15;
     hasta_mes = #nomyrenm#15;

     tinf_tc1 = (tinf_sss + tinf_dse) - tinf_enf;    || aproximado
     aAunno = "";

     x_centro = 99;
     y_centro = 99;
     swAgrarios = 0;
     |SI #cretam00#8 = "R"; |Y #labempre#67 = "S";
          || no entres aqui en creta
     |SINO;
          nRegimen = 613;
          |BUCLE silcon15;
          nRegimen = 163;
          |BUCLE silcon15;
     |FINSI;
     |BUCLE CuentaCenMen;
     nTipo = #nomyrenm#4;
     |HAZ Aux_tc1M;
/*
     || no busco mas tipo 8 o 9, esto era de cuando el labempax-labemphi
     |SI #nomyrenm#4 = 0;
          nTipo = 8;               || solo en el tipo 0
          |HAZ Aux_tc1M;           || leeme tambien formacion y practicas
          nTipo = 9;
          |HAZ Aux_tc1M;
          nTipo = #nomyrenm#4;
     |FINSI;
*/
     |SI hay_algo = 0; |O swAgrarios = 1;
          x_centro = #nomyrenm#11;
          y_centro = #nomyrenm#12;
          |SI y_centro = 99; |O y_centro = 999;
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               nTipo = #nomyrenm#4;
               |HAZ Aux_tc1M;

               x_centro =  100;
               y_centro =  999;
               |HAZ Aux_tc1M;
          |FINSI;

/*
          || no busco mas tipo 8 o 9, esto era de cuando el labempax-labemphi
          |SI #nomyrenm#4 = 0;
               nTipo = 8;               || solo en el tipo 0
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               |HAZ Aux_tc1M;           || leeme tambien formacion y practicas
               x_centro =  100;       || asi para que no vuelva a entrar en
               y_centro =  999;          || el 99
               |HAZ Aux_tc1M;           || leeme tambien formacion y practicas

               nTipo = 9;
               x_centro =  #nomyrenm#11;       || asi para que no vuelva a entrar en
               y_centro =  98;          || el 99
               |HAZ Aux_tc1M;
               x_centro =  100;       || asi para que no vuelva a entrar en
               y_centro =  999;          || el 99
               |HAZ Aux_tc1M;           || leeme tambien formacion y practicas

               nTipo = #nomyrenm#4;
          |FINSI;
*/
          |SI hay_algo = 0;
               ||tinf_tc1=(tinf_sss+tinf_dse)-tinf_enf;
               tinf_tc1re = tinf_tc1;
               aAunno = "- TC1 no calculado";
          |SINO;
               aAunno = "";
          |FINSI;
     |SINO;
          aAunno = "";  || TC1 calculado, importe real el del labempax
     |FINSI;
     |HAZ grabatot;
|FPRC;

|PROCESO leetraba;
    swbaja = 0;
    fecalf = #nomcalca#5;

    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;

|SI mes = #nomyrenm#15; |Y any = #nomyrenm#16;    swbaja = 1;    |FINSI;
|FPRC;

|PROCESO rup_empreM;
    swlin = 2;
    FSalida = "PAGINA";
|HAZ ElPRINT;
|HAZ limptotal;
    empresa = #labtraba#0;
    swlin = 0;
|FPRC;

|PROCESO rup_centrM;
     |HAZ lee_centro;
     swlin = 1;
     varinf1 = "Centro: " + #4#1 + "/" + #4#2;
     |HAZ puecentro;
     |SI nNumTrabCen > 0;
          |HAZ ElPRINT;
     |FINSI;
     |HAZ limparcial;
     centro = #labtraba#77;
     swlin = 0;
|FPRC;

|PROCESO rup_areasM;
|SI #nomyrenm#6 = "S";
    |HAZ lee_area;
        swlin = 1;
        varinf1 = "Area: " + #5#0 + "/" + #5#1;
    |HAZ puegrupos;
    |HAZ ElPRINT;
    |HAZ limpgrupos;
        grupo = #labtraba#62;
        swlin = 0;
|FINSI;
|FPRC;

|DEFBUCLE nomyreno0;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#1;
|FIN;

|DEFBUCLE nomyreno1;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#1;
|FIN;

|DEFBUCLE nomyreno2;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#2, #labtraba#1;
|FIN;

|DEFBUCLE nomyreno3;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#2, #labtraba#1;
|FIN;

|DEFBUCLE nomyreno4;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#31, #labtraba#1;
|FIN;

|DEFBUCLE nomyreno5;
 #labtraba#1;
 77;
 nDesdeEmp, nDesdeTra, nDesdeCen;
 nHastaEmp, nHastaTra, nHastaCen;
 ;
 NULL, NULL, NULL, NULL, NULL, imprimirM;
 #labtraba#0, #labtraba#77, #labtraba#31, #labtraba#1;
|FIN;

|PROCESO PagasM;
     |SI swPagasSN = 2;              || pagas incluidas
     |O enCuadre = 50;
     |O enCuadre = 52;
          inf_bru = inf_bru + #nomcalca#47;         || Importe bruto Pagas
          |SI inf_tan ! #nomcalca#87;               || % irpf solo lo pinto si es igual
               inf_tan = 0;                  || que el de la nomina
          |FINSI;
          |SI enCuadre = 52;
               inf_ded = #nomcalca#17;              || retencion pagas
          |SINO;
               inf_ded = inf_ded + #nomcalca#17;         || retencion pagas
          |FINSI;
          inf_dto = inf_dto + #nomcalca#86;         || anticipo pagas extras
          inf_sub = inf_sub + #nomcalca#47;
          |SI #nomcalca#104 ! 0;                    || embargos
               |SI #nomcalca#47 ! 0;
                    nEmbargoPaga = 0;
                    |HAZ EmbargoPaga;
                    |SI nEmbargoPaga ! 0;
                         nEmbargo = nEmbargo + nEmbargoPaga;
                    |SINO;
                         nEmbargo = nEmbargo + (#nomcalca#104 - ((#nomcalca#104 * (#nomcalca#46 / (#nomcalca#46 + #nomcalca#47))) ! 2));
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DeduccionesM;
     inf_dto = #nomcalca#52 + #nomcalca#53 + #nomcalca#54 + #nomcalca#89; || Dto.varios
     |SI #nomcalca#199 < 0; inf_dto = inf_dto - #nomcalca#199; |FINSI;    || preaviso
     inf_dto = inf_dto + #nomcalca#200;                            || vacaciones

     nEmbargo = 0;
     |SI #nomcalca#104 ! 0;
          |SI #nomcalca#47 = 0;
               nEmbargo = #nomcalca#104;
          |SINO;
               nEmbargoPaga = 0;
               |HAZ EmbargoPaga;
               |SI nEmbargoPaga ! 0;
                    nEmbargo = (#nomcalca#104 - nEmbargoPaga);
               |SINO;
                    nEmbargo = ((#nomcalca#104 * (#nomcalca#46 / (#nomcalca#46 + #nomcalca#47))) ! 2);
               |FINSI;
          |FINSI;
     |FINSI;

    inf_tan = #nomcalca#13; inf_tan = inf_tan ! 2;       || Porcentaje
    inf_ded = #nomcalca#75;                              || Deduccion
    inf_dse = #nomcalca#48 + #nomcalca#49 + #nomcalca#50 + #nomcalca#51 + #nomcalca#165;    || Deduccion S.S
|FPRC;

|PROCESO detalleM;
     inf_enf = #nomcalca#57 + #nomcalca#58;      || prestaciones
     inf_sub = #nomcalca#46 - inf_enf + #nomcalca#45;         || coste trabajad.
     inf_bru = #nomcalca#46; || Importe bruto
     |SI enCuadre ! 52;
          |HAZ DeduccionesM;
     |FINSI;
     |HAZ PagasM;
     inf_dto = inf_dto + nEmbargo;

    inf_liq = inf_bru -inf_dto -inf_ded -inf_dse; || Liquido
    inf_bon = #nomcalca#63 + #nomcalca#81 + #nomcalca#88 + #nomcalca#64 + #nomcalca#96;   || bonif
    inf_bon = inf_bon + #nomcalca#101 + #nomcalca#102 + #nomcalca#106 + #nomcalca#125 + #nomcalca#133;
    inf_bon = inf_bon + #nomcalca#143 + #nomcalca#144 + #nomcalca#170 + #nomcalca#183;
    inf_for = #nomcalca#64 + #nomcalca#183;
    inf_sss = #nomcalca#45;                  || S.S CGO
    inf_exe = #nomcalca#18;                              || Base IRPF exenta

    inf_ant1 = #nomcalca#52;
    inf_ant2 = #nomcalca#53;
    inf_ant3 = #nomcalca#89;
    inf_antp = #nomcalca#86;
    inf_emb = nEmbargo;
    inf_esp = #nomcalca#54;

    inf_tip = #nomcalca#3;
    inf_pro = #nomcalca#38;   || prorrata
    ||SI #nomcont3#2 = "S";
          || para todos
          |SALVA_FICHA #labtraba;
          #labtraba#0 = #nomcalca#0; #labtraba#1 = #nomcalca#1; |LEE 000#labtraba.=;
          |BUCLE PagasProrrMen;
          |REPON_FICHA #labtraba;
    ||FINSI;
    inf_prest_enf_ss = #nomcalca#57;
    inf_prest_enf_emp = #nomcalca#73;
    inf_comp_enf = #nomcalca#59;
    inf_prest_acc_ss = #nomcalca#58;
    inf_comp_acc = #nomcalca#60;
    inf_dias = #nomcalca#8;

    inf_basecc = #nomcalca#39 + #nomcalca#79;
    inf_basecp = #nomcalca#40 + #nomcalca#80;
    inf_hasehe_fm = #nomcalca#41;
    inf_basehe_nor = #nomcalca#42;
    inf_baseirpf = #nomcalca#14;
    inf_baseirpfpa = #nomcalca#16;
    inf_dtoirpfpa = #nomcalca#17;
    inf_baseirpfes = #nomcalca#69 + #nomcalca#70;
    inf_dtoirpfes = #nomcalca#71 + #nomcalca#72;
    inf_dtoirpfdi = #nomcalca#15 + #nomcalca#17;


     || campos aplazamiento

     || A. DEUDA NO APLAZABLE
     || 1. aportacion trabajador
     inf_cc_tra = #nomcalca#48;
     inf_he_tra = #nomcalca#50 + #nomcalca#51;
     |HAZ DesFP;
     inf_des_tra = nCuotaDes;
     inf_fp_tra = nCuotaFP;

     || 2. cuotas atep
     inf_atep = #nomcalca#177 + #nomcalca#178;

     || 3. suma 1 + 2
     inf_suma_12 = inf_cc_tra + inf_he_tra + inf_des_tra + inf_fp_tra;
     inf_suma_12 = inf_suma_12 + inf_atep;

     || 4. prestaciones pago delegado
     inf_pres_cp = #nomcalca#58;

     || 5. diferencia 3 - 4
     inf_dif_34 = inf_suma_12 - inf_pres_cp;

     || 7. total no aplazable
     inf_tot_noaplaz = inf_dif_34;

     || B. DEUDA APLAZABLE
     || 1. cuotas
     inf_cc_emp = #nomcalca#173;
     inf_he_emp = #nomcalca#179;
     inf_des_emp = #nomcalca#174;
     inf_fog_emp = #nomcalca#175
     inf_fp_emp = #nomcalca#176;

     || 2. total cuotas
     inf_tot_cuota_emp = inf_cc_emp + inf_he_emp + inf_des_emp;
     inf_tot_cuota_emp = inf_tot_cuota_emp + inf_fog_emp + inf_fp_emp;

     || 3. deducciones
     inf_pres_cc = #nomcalca#57;
     inf_bonred_emp = #nomcalca#180;

     || 4. total deducciones
     inf_totded_emp = inf_pres_cc + inf_bonred_emp;

     || 5. diferencia aplazable
     inf_dif_aplaz = inf_tot_cuota_emp - inf_totded_emp;

     || 8. total aplazable 5
     inf_tot_aplaz = inf_dif_aplaz;

     || C. TOTAL DEUDA
     inf_tot_deuda = inf_tot_noaplaz + inf_tot_aplaz;

    |SI enCuadre = 51;
         inf_dtoirpfdi = inf_dtoirpfdi - #nomcalca#17;
    |FINSI;

     |SI #nomyrenm#30 = 4;                               || cuadre 04 para Qualitas
          |HAZ ERE;
          inf_cere = nCompERE;
          inf_ssere = nCuotaERE;
     |FINSI;

     |SI #nomyrenm#30 = 10;        || delglose conceptos para XML ADADE
     |O #nomyrenm#30 ] 50;         || y para AYESA - PLUSGESTIONA !!
          |HAZ DesgloseConceptosXML;
     |FINSI;
|FPRC;

|PROCESO FormacionContinua2;
     #nomtmpre#42 = #nomtmpre#42 + #nombofli#3;

     nNume = 0;
     |SI #nombofli#5 = "B"; nNume = 1; |FINSI;
     |SI #nombofli#5 = "P"; nNume = 2; |FINSI;

     |SI #nomtmpre#71 = 0;
          #nomtmpre#71 = nNume;
     |SINO;
          |SI #nomtmpre#71 = #nombofli#5;
               || NADA
          |SINO;
               #nomtmpre#71 = 3;
          |FINSI;
     |FINSI;

     |GRABA 020#nomtmpre.a;
     |LIBERA #nomtmpre;
|FPRC;

|DEFBUCLE FormacionContinua2;
     #nombofli#1;
     ;
     #nomtmpre#0, nume1, #nomyrenm#2, 001, " ", "B";
     #nomtmpre#0, nume2, #nomyrenm#9, 999, "F", "P";
     ;
     NULL, FormacionContinua2;
|FIN;

|PROCESO FormacionContinua;
     #nomtmpre#42 = #nomtmpre#42 + #nombofli#3;

     nNume = 0;
     |SI #nombofli#5 = "B"; nNume = 1; |FINSI;
     |SI #nombofli#5 = "P"; nNume = 2; |FINSI;

     |SI #nomtmpre#71 = 0;
          #nomtmpre#71 = nNume;
     |SINO;
          |SI #nomtmpre#71 = #nombofli#5;
               || NADA
          |SINO;
               #nomtmpre#71 = 3;
          |FINSI;
     |FINSI;
     |GRABA 020#nomtmpre.a;
     |LIBERA #nomtmpre;
|FPRC;

|DEFBUCLE FormacionContinua;
     #nombofli#1;
     ;
     #nomtmpre#0, #nomtmpre#41, #nomtmpre#19, 001, " ", "B";
     #nomtmpre#0, #nomtmpre#41, #nomtmpre#19, 999, "F", "P";
     ;
     NULL, FormacionContinua;
|FIN;

|PROCESO grabatot;
     |SI nTipo = 1; |ACABA; |FINSI;
     |SI hay_algo = 0; |Y nTipo = 2;    || si no, si pongo del tipo 0 al 2 y
          |ACABA;                       || no hay nada en el tipo 2 me sale
     |FINSI;                            || el total a cero
     #nomtmpre#0 = empresa;    || codigo empresa
     #nomtmpre#1 = 1;    || codigo trabajador
     #nomtmpre#2 = 1;   || codigo centro
     |SI #nomyrenm#17 = 2; |Y #nomyrenm#14 = "A";     || atrasos por meses
          #nomtmpre#19 = 1;         || atrasos refundidos
     |SINO;
          #nomtmpre#19 = month;
     |FINSI;
     #nomtmpre#21 = ""; || area
     #nomtmpre#23 = nTipo;
     |SI #nomtmpre#23 = 2;
          #nomtmpre#1 = nUnoTipo2;
          #nomtmpre#2 = nCentroTipo2;
          |LEE 101#nomtmpre.=;
     |SINO;
          |LEE 101#nomtmpre.];
     |FINSI;
     |SI FSalida = 0;
          #nomtmpre#20 = tinf_tc1re;
          #nomtmpre#54 = aFuenteTotal;
          #nomtmpre#55 = swMora;
          #nomtmpre#56 = nRecargo;
          |SI aAunno ! "";
               #nomtmpre#20 = -1;
          |FINSI;
          #nomtmpre#33 = tinf_tc1;
          |GRABA 020#nomtmpre.a;
          |SI nTipo = 0;
               |SI #nomyrenm#14 = "M";
                    |BUCLE FormacionContinua;
               |FINSI;
               |SI #nomyrenm#14 = "H";
                    nume1 = #nomyrenm#5 + 2000;
                    nume2 = #nomyrenm#10 + 2000;
                    |BUCLE FormacionContinua2;
               |FINSI;
          |FINSI;
          |LIBERA #nomtmpre;
     |FINSI;
     |SI #nomtmpre#23 = 2; |Y enCuadre ! 02; |Y enCuadre ! 10;
          nUnoTipo2 = 0;
          nCentroTipo2 = 0;
     |FINSI;
|FPRC;

|PROCESO AreaConceptos;
     #nomtmprf#21 = "";
     #nomtmprf#22 = "";
     |SI #nomyrenm#6 = "S";
          #nomauxi1#0 = #labtraba#62;
          |LEE 000#nomauxi1.=;
          |SI FSalida = 0;
               #nomtmprf#21 = #nomauxi1#0;
               #nomtmprf#22 = #nomauxi1#1;
          |FINSI;

          aAlfa = #nomtmprf#21;
          |QBF aAlfa;
          |SI aAlfa = "";
               #nomtmprf#21 = "    ";
          |FINSI;

          aAlfa = #nomtmprf#22;
          |QBF aAlfa;
          |SI aAlfa = ""; |Y #nomtmprf#21 = "    ";
               #nomtmprf#22 = "Sin  rea asignada";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Area;
     #nomtmpre#21 = "";
     #nomtmpre#22 = "";
     |SI #nomyrenm#6 = "S";
          #nomauxi1#0 = #labtraba#62;
          |LEE 000#nomauxi1.=;
          |SI FSalida = 0;
               #nomtmpre#21 = #nomauxi1#0;
               #nomtmpre#22 = #nomauxi1#1;
          |FINSI;

          aAlfa = #nomtmpre#21;
          |QBF aAlfa;
          |SI aAlfa = "";
               #nomtmpre#21 = "    ";
          |FINSI;

          aAlfa = #nomtmpre#22;
          |QBF aAlfa;
          |SI aAlfa = ""; |Y #nomtmpre#21 = "    ";
               #nomtmpre#22 = "Sin  rea asignada";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EmbargoPaga;
     nEmbargoPaga = 0;

     |ABRE #nomimpr1;

     |SI PARAMETRO = "M";
          #nomimpr1#0 = #nomcalca#0;
          #nomimpr1#1 = #nomcalca#1;
     |FINSI;
     |SI PARAMETRO = "H";
          #nomimpr1#0 = #nomhicca#0;
          #nomimpr1#1 = #nomhicca#1;
     |FINSI;
     #nomimpr1#2 = month;
     #nomimpr1#3 = 0;
     #nomimpr1#4 = nAnyTmp;
     |LEE 000#nomimpr1.=;
     |SI FSalida = 0; |Y #nomimpr1#10 ! 0;
          nEmbargoPaga = #nomimpr1#10;
     |FINSI;

     |CIERRA #nomimpr1;
|FPRC;

|PROCESO BuscaPorNif;
     nTraAct = #nomtmpre#1;
|FPRC;

|DEFBUCLE BuscaPorNif;
     #nomtmpre#1;
     3;
     nEmpAct, nCenAct, aAreAct, 00001, nAnyAct, nMesAct, nTipAct, aNifAct;
     nEmpAct, nCenAct, aAreAct, 99999, nAnyAct, nMesAct, nTipAct, aNifAct;
     ;
     NULL, BuscaPorNif;
|FIN;

|PROCESO Agrupa;
     nEmpAct = #labtraba#0;
     nCenAct = #labtraba#77;
     aAreAct = "";
     nAnyAct = nAnyTmp;
     |SI #nomyrenm#17 = 2; |Y #nomyrenm#14 = "A";     || atrasos por meses
          nMesAct = 1;         || atrasos refundidos
     |SINO;
          nMesAct = month;
     |FINSI;
     nTipAct = inf_tip;
     aNifAct = #labtraba#7;
     aNifAct = aNifAct % 109;

     nTraAct = 0;

     |BUCLE BuscaPorNif;
|FPRC;

|PROCESO ValoresClave;
     #nomtmpre#0 = #labtraba#0;    || codigo empresa
     #nomtmpre#1 = #labtraba#1;    || codigo trabajador
     #nomtmpre#2 = #labtraba#77;   || codigo centro
     |SI #nomyrenm#17 = 2; |Y #nomyrenm#14 = "A";     || atrasos por meses
          #nomtmpre#19 = 1;         || atrasos refundidos
     |SINO;
          #nomtmpre#19 = month;
     |FINSI;
     #nomtmpre#23 = inf_tip;
     |SI swPaga = 1;
          #nomtmpre#23 = 1;
     |FINSI;
     #nomtmpre#41 = nAnyTmp;

     |HAZ Area;
|FPRC;

|PROCESO grabatmp;
     #nomw0024#0 = #labtraba#0;
     #nomw0024#1 = #labtraba#77;
     |LEE 000#nomw0024.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     |SI enCuadre = 52;
     |Y inf_baseirpfpa = 0;
          |ACABA;
     |FINSI;

     |SI inf_tip = 1;
          |ACABA;
     |FINSI;

     swHayAlgo = 1;
     |DDEFECTO #nomtmpre;
     |HAZ ValoresClave;

     |LEE 101#nomtmpre.=;
     FEstado2 = FSalida;

     |SI #labempre#66 = 1;
          |SI #nomyrenm#30 = 02; |O #nomyrenm#30 ] 50;
               || la agrupacion por NIF aqui solo en excel, si es Crystal
               || se hace en el propio Crystal, mucho mejor
               |HAZ Agrupa;
               |SI nTraAct ! 0;
                    #nomtmpre#1 = nTraAct;
                    |LEE 101#nomtmpre.=;

                    #nomtmpre#53 = "N";

                    FEstado2 = 0;
               |SINO;
                    |DDEFECTO #nomtmpre;

                    |HAZ ValoresClave;
               |FINSI;
          |FINSI;
     |FINSI;

     #nomtmpre#3 = #labtraba#7;    || NIF

     #labempre#0 = #labtraba#0;
     |LEE 000#labempre.=;
     #nomtmpre#4 = #labempre#2;    || nombre empresa
     #nomtmpre#43 = #labempre#13;  || ccc empresa

     #nomtmpre#5 = #labtraba#2;    || nombre trabajador
     |SI #nomyrenm#32 = 2; |Y inf_tip = 2;
          aAlfa = #nomtmpre#5;
          |QBF aAlfa;
          aAlfa = aAlfa + " (F)";
          #nomtmpre#5 = aAlfa;
     |FINSI;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     #nomtmpre#6 = #labcentr#2;    || nombre centro
     aAlfa = #labcentr#10;  || CCC centro
     |QBF aAlfa;
     |SI aAlfa = "";
          aAlfa = #labempre#13;  || CCC centro
     |FINSI;
     #nomtmpre#44 = aAlfa;

     |HAZ Area;

     nCampo = 6;
     || prestaciones    - Campo 7
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_enf;
     || coste trabajad. - Campo 8
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_sub;
     || Importe bruto   - Campo 9
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_bru;
     || Dto.varios      - Campo 10
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_dto;
     || Porcentaje      - Campo 11
     nCampo = nCampo + 1; #nomtmpre#nCampo# = inf_tan;
     || Deduccion       - Campo 12
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_ded;
     || notaria         - Campo 13
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + ded_not;
     || Deduccion S.S   - Campo 14
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_dse;
     || Liquido         - Campo 15
     nCampo = nCampo + 1;
     |SI enCuadre = 52;
          #nomtmpre#nCampo# = #nomtmpre#nCampo# + (inf_baseirpfpa - inf_dtoirpfpa - inf_antp - inf_emb);
     |SINO;
          #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_liq;
     |FINSI;
     || bonif           - Campo 16
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_bon;
     || S.S CGO         - Campo 17
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_sss;
     || Base IRPF exenta- Campo 18
     nCampo = nCampo + 1; #nomtmpre#nCampo# = #nomtmpre#nCampo# + inf_exe;

     #nomtmpre#23 = inf_tip;       || tipo de nomina
     |SI swPaga = 1;
          #nomtmpre#23 = 1;
     |FINSI;

     |SI enCuadre = 52;
          #nomtmpre#58 = #nomtmpre#58 + (inf_baseirpfpa);
     |SINO;
          #nomtmpre#58 = #nomtmpre#58 + (inf_bru + inf_sss - inf_enf);
     |FINSI;

     #nomtmpre#51 = #nomtmpre#51 + inf_dias;    || dias en alta
     #nomtmpre#24 = #nomtmpre#24 + inf_ant1;    || anticipos 1
     #nomtmpre#25 = #nomtmpre#25 + inf_ant2;    || anticipos 2
     #nomtmpre#26 = #nomtmpre#26 + inf_ant3;    || anticipos 3
     #nomtmpre#57 = #nomtmpre#57 + inf_ant1 + inf_ant2 + inf_ant3; || total anticipos
     #nomtmpre#28 = #nomtmpre#28 + inf_esp;    || especie
     #nomtmpre#29 = #nomtmpre#29 + inf_emb;   || embargo

     |SI swPagasSN = 2;      || pagas incluidas
     |O enCuadre = 50;
     |O enCuadre = 52;
          #nomtmpre#27 = #nomtmpre#27 + inf_antp;    || anticipos Paga Extra
          #nomtmpre#57 = #nomtmpre#57 + inf_antp;
     |FINSI;

     || PRESTACIONES Y COMPLEMENTOS PARA XML

     #nomtmpre#46 = #nomtmpre#46 + inf_prest_enf_ss;
     #nomtmpre#47 = #nomtmpre#47 + inf_prest_enf_emp;
     #nomtmpre#48 = #nomtmpre#48 + inf_comp_enf;
     #nomtmpre#49 = #nomtmpre#49 + inf_prest_acc_ss;
     #nomtmpre#50 = #nomtmpre#50 + inf_comp_acc;

     #nomtmpre#30 = #labempre#61;  || Comentario Anticipo 1
     #nomtmpre#31 = #labempre#62;  || Comentario Anticipo 2
     #nomtmpre#32 = #nomtmpre#32 + inf_pro;  || prorrata pagas

     #nomtmpre#34 = #nomtmpre#34 + inf_cere;
     #nomtmpre#35 = #nomtmpre#35 + inf_ssere;

     #nomtmpre#36 = #labtraba#36;         || fecha de alta
     #nomtmpre#37 = #labtraba#31;         || numero de referencia
     #nomtmpre#41 = nAnyTmp;
     #nomtmpre#45 = #nomtmpre#45 + inf_for;
     #nomtmpre#52 = #labempre#66;

     #nomtmpre#59 = #nomtmpre#59 + inf_basecc;         || Base CC
     #nomtmpre#60 = #nomtmpre#60 + inf_basecp;         || BAse ATEP
     #nomtmpre#61 = #nomtmpre#61 + inf_hasehe_fm;        || BASE HE 1
     #nomtmpre#62 = #nomtmpre#62 + inf_basehe_nor;        || Base HE 2
     #nomtmpre#63 = #nomtmpre#63 + inf_baseirpf;       || Base IRPF
     |SI swPagasSN = 2;           || pagas incluidas
     |O enCuadre = 50;
     |O enCuadre = 52;
          #nomtmpre#63 = #nomtmpre#63 + inf_baseirpfpa;     || Base IRPF Pagas
     |FINSI;
     #nomtmpre#64 = #nomtmpre#64 + inf_baseirpfes;          || BAse IRPF Especie
     #nomtmpre#65 = #nomtmpre#65 + inf_dto + inf_dse + inf_ded;  || Total a deducir
     #nomtmpre#66 = #labtraba#45;
     #nomtmpre#67 = #nomtmpre#67 + inf_baseirpfpa;       || Base IRPF pagas
     #nomtmpre#68 = #nomtmpre#68 + inf_dtoirpfpa;        || Dto. IRPF pagas
     #nomtmpre#69 = #nomtmpre#69 + inf_dtoirpfes;        || Dto. IRPF Especie
     #nomtmpre#70 = #nomtmpre#70 + inf_dtoirpfdi;        || Dto. IRPF Dineraria (normal)

     || cuotas aplazamiento


     || campos aplazamiento

     || A. DEUDA NO APLAZABLE
     || 1. aportacion trabajador
     #nomtmpre#72 = #nomtmpre#72 + inf_cc_tra;
     #nomtmpre#73 = #nomtmpre#73 + inf_he_tra;
     #nomtmpre#74 = #nomtmpre#74 + inf_des_tra;
     #nomtmpre#75 = #nomtmpre#75 + inf_fp_tra;

     || 2. cuotas atep
     #nomtmpre#76 = #nomtmpre#76 + inf_atep;

     || 3. suma 1 + 2
     #nomtmpre#77 = #nomtmpre#77 + inf_suma_12;

     || 4. prestaciones pago delegado
     #nomtmpre#78 = #nomtmpre#78 + inf_pres_cp;

     || 5. diferencia 3 - 4
     #nomtmpre#79 = #nomtmpre#79 + inf_dif_34;

     || 7. total no aplazable
     #nomtmpre#80 = #nomtmpre#80 + inf_tot_noaplaz;

     || B. DEUDA APLAZABLE
     || 1. cuotas
     #nomtmpre#81 = #nomtmpre#81 + inf_cc_emp;
     #nomtmpre#82 = #nomtmpre#82 + inf_he_emp;
     #nomtmpre#83 = #nomtmpre#83 + inf_des_emp;
     #nomtmpre#84 = #nomtmpre#84 + inf_fog_emp;
     #nomtmpre#85 = #nomtmpre#85 + inf_fp_emp;

     || 2. total cuotas
     #nomtmpre#86 = #nomtmpre#86 + inf_tot_cuota_emp;

     || 3. deducciones
     #nomtmpre#87 = #nomtmpre#87 + inf_pres_cc;
     #nomtmpre#88 = #nomtmpre#88 + inf_bonred_emp;

     || 4. total deducciones
     #nomtmpre#89 = #nomtmpre#89 + inf_totded_emp;

     || 5. diferencia aplazable
     #nomtmpre#90 = #nomtmpre#90 + inf_dif_aplaz;

     || 8. total aplazable 5
     #nomtmpre#91 = #nomtmpre#91 + inf_tot_aplaz;

     || C. TOTAL DEUDA
     #nomtmpre#92 = #nomtmpre#92 + inf_tot_deuda;

     |SI FEstado2 = 0;
          |GRABA 020#nomtmpre.a;
     |SINO;
          #nomtmpre#0 = #labtraba#0;    || codigo empresa
          #nomtmpre#1 = #labtraba#1;    || codigo trabajador
          #nomtmpre#2 = #labtraba#77;   || codigo centro
          #nomtmpre#19 = month;
          #nomtmpre#23 = inf_tip;
          |SI swPaga = 1;
               #nomtmpre#23 = 1;
          |FINSI;
          |HAZ Area;
          #nomtmpre#41 = nAnyTmp;

          |GRABA 020#nomtmpre.n;
     |FINSI;
     |SI #nomtmpre#23 = 2;              || me lo guardo para luego
          nUnoTipo2 = #nomtmpre#1;      || saber donde meter los totales
          nCentroTipo2 = #nomtmpre#2;
     |FINSI;                       || si es finiquito
     |LIBERA #nomtmpre;
|FPRC;

|PROCESO gruposM;
    ginf_enf = ginf_enf + inf_enf;       || Enfermedad
    ginf_sub = ginf_sub + inf_sub;       || Subnormalidad
    ginf_bru = ginf_bru + inf_bru;       || Importe bruto
    ginf_dto = ginf_dto + inf_dto;       || Dto.varios
    ginf_tan = ginf_tan ! 2;             || Porcentaje
    ginf_ded = ginf_ded + inf_ded;       || Deduccion
    ginf_dse = ginf_dse + inf_dse;       || Deduccion S.S
    ginf_liq = ginf_liq + inf_liq;       || Liquido
    ginf_bon = ginf_bon + inf_bon;       || S.S CGO
    ginf_sss = ginf_sss + inf_sss;       || S.S CGO
    ginf_exe = ginf_exe + inf_exe;       || Base IRPF exenta
    ginf_pro = ginf_pro + inf_pro;       || prorrata
|FPRC;

|PROCESO centrosM;
    cinf_enf = cinf_enf + inf_enf;       || Enfermedad
    cinf_sub = cinf_sub + inf_sub;       || Subnormalidad
    cinf_bru = cinf_bru + inf_bru;       || Importe bruto
    cinf_dto = cinf_dto + inf_dto;       || Dto.varios
    cinf_tan = cinf_tan ! 2;             || Porcentaje
    cinf_ded = cinf_ded + inf_ded;       || Deduccion
    cinf_dse = cinf_dse + inf_dse;       || Deduccion S.S
    cinf_liq = cinf_liq + inf_liq;       || Liquido
    cinf_bon = cinf_bon + inf_bon;       || S.S CGO
    cinf_sss = cinf_sss + inf_sss;       || S.S CGO
    cinf_exe = cinf_exe + inf_exe;       || Base IRPF exenta
    cinf_pro = cinf_pro + inf_pro;       || prorrata
|FPRC;

|PROCESO &totalesM;
    tinf_enf = tinf_enf + inf_enf;       || Enfermedad
    tinf_sub = tinf_sub + inf_sub;       || Subnormalidad
    tinf_bru = tinf_bru + inf_bru;       || Importe bruto
    tinf_dto = tinf_dto + inf_dto;       || Dto.varios
    tinf_tan = tinf_tan ! 2;             || Porcentaje
    tinf_ded = tinf_ded + inf_ded;       || Deduccion
    tinf_dse = tinf_dse + inf_dse;       || Deduccion S.S
    tinf_liq = tinf_liq + inf_liq;       || Liquido
    tinf_bon = tinf_bon + inf_bon;       || S.S CGO
    tinf_sss = tinf_sss + inf_sss;       || S.S CGO
    tinf_exe = tinf_exe + inf_exe;       || Base IRPF exenta
    tinf_pro = tinf_pro + inf_pro;       || Prorrata
|FPRC;

|DEFBUCLE nomyreat0;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#1;
|FIN;

|DEFBUCLE nomyreat1;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#1;
|FIN;

|DEFBUCLE nomyreat2;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#2, #labtraba#1;
|FIN;

|DEFBUCLE nomyreat3;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#2, #labtraba#1;
|FIN;

|DEFBUCLE nomyreat4;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#62, #labtraba#31, #labtraba#1;
|FIN;

|DEFBUCLE nomyreat5;
     #labtraba#1;
     77;
     nDesdeEmp, nDesdeTra, nDesdeCen;
     nHastaEmp, nHastaTra, nHastaCen;
     ;
     NULL, NULL, NULL, NULL, NULL, imprimirA;
     #labtraba#0, #labtraba#77, #labtraba#31, #labtraba#1;
|FIN;

|PROCESO ResAtrasos;
     |SI #nomcontr#78 = "S";
          nDesdeTra = #nomyrenm#34;
          nHastaTra = #nomyrenm#35;
     |SINO;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #nomyrenm#8 = 1;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreat0;    |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreat1;    |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 2;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreat2;    |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreat3;    |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 3;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreat4;    |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreat5;    |FINSI;
     |FINSI;
|FPRC;

|PROCESO ResHistorico;
     |SI swDesglose = 1; |O #nomcontr#78 = "S";
          nDesdeTra = #nomyrenm#34;
          nHastaTra = #nomyrenm#35;
     |SINO;
          nDesdeTra = 00001;
          nHastaTra = 99999;
     |FINSI;
     |SI #nomyrenm#8 = 1;
          |SI #nomyrenm#6 = "S";  |BUCLE area_si1;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE area_no1;  |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 2;
          |SI #nomyrenm#6 = "S";  |BUCLE area_si2;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE area_no2;  |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 3;
          |SI #nomyrenm#6 = "S";  |BUCLE area_si3;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE area_no3;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO ResMensual;
     |SI aParam = "AUTO";
          nDesdeTra = nTraAUTO;
          nHastaTra = nTraAUTO;
     |SINO;
          |SI #nomcontr#78 = "S";
               nDesdeTra = #nomyrenm#34;
               nHastaTra = #nomyrenm#35;
          |SINO;
               nDesdeTra = 1;
               nHastaTra = 99999;
          |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 1;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreno0;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreno1;  |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 2;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreno2;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreno3;  |FINSI;
     |FINSI;
     |SI #nomyrenm#8 = 3;
          |SI #nomyrenm#6 = "S";  |BUCLE nomyreno4;  |FINSI;
          |SI #nomyrenm#6 = "N";  |BUCLE nomyreno5;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO Mensual;
     fecha = #nomyrenm#3;
     month = #nomyrenm#15;
     ano = #nomyrenm#5;
     |HAZ namemes;
     alfa1 = #nomyrenm#16;
     |SI #nomyrenm#4 = 0; tip = "MENSUAL - ";   |FINSI;
     |SI #nomyrenm#4 = 2; tip = "FINIQUITO - "; |FINSI;
     |SI #nomyrenm#4 ] 5; tip = "ATRASOS - ";   |FINSI;
     cabeza = "RESUMEN NOMINAS " + tip + p_mes;
     |QBF cabeza;
     cabeza = cabeza + " " + alfa1;
     |HAZ centra;
     |ABRE #nomcalca;
     |ABRE #labempre;
     seleccio = 0;
     nNumTrabEmp = 0;
     nNumTrabCen = 0;

     nDesdeEmp = nEmpresa;
     nHastaEmp = nEmpresa;

     nDesdeCen = #nomyrenm#11;
     nHastaCen = #nomyrenm#12;
     |SI enPorCen = 1;
         nDesdeCen = nCentro;
         nHastaCen = nCentro;
     |FINSI;

     |HAZ ResMensual;

     |HAZ rup_areasM;
     |HAZ rup_centrM;
     |HAZ tc1M;

     |CIERRA #nomcalca;
     |CIERRA #labempre;
|FPRC;

/**************************************************/
/* PROCESO ATRASOS */
/**************************************************/

|PROCESO leetrabaA;
    swbaja = 0;
    fecalf = #nomcalac#5;

    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -104;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;

|SI any = #nomyrenm#16;
    |SI mes ] #nomyrenm#2; |Y mes [ #nomyrenm#9;      swbaja = 1;    |FINSI;
|FINSI;
|FPRC;

|PROCESO imprimirA;
     |DDEFECTO #labempre;
     #labempre#0 = #labtraba#0;
     |LEE 020#labempre.=;
     |SI #labempre#36 = "N";  || si el switch de impresion no es "N"
          |ACABA;
     |FINSI;
     |SI #nomyrenm#17 = 2;
          |HAZ bufaloA;
          |PARA mesos = #nomyrenm#2; |SI mesos [ #nomyrenm#9; |HACIENDO mesos = mesos + 1;
               #nomcalac#0 = #labtraba#0;   || Empresa
               #nomcalac#1 = #labtraba#1;   || Trabajador
               #nomcalac#2 = mesos;  || Mes
               #nomcalac#3 = 5;      || Tipo
               |LEE 000#nomcalac.=;
               |SI FSalida = 0;

                    |HAZ leetrabaA;
                    |SI #nomyrenm#13 ! "T";
                         |SI #nomyrenm#13 = "A";|Y swbaja = 1;    |ACABA;   |FINSI;
                         |SI #nomyrenm#13 = "B";|Y swbaja = 0;    |ACABA;   |FINSI;
                    |FINSI;

                    perlomens = 1;
                    |HAZ notarias;
                    |HAZ cabecer1A;
                    |HAZ cabecer4A;

                    |SI #nomyrenm#30 = 10;        || delglose conceptos para XML ADADE
                    |O #nomyrenm#30 ] 50;         || y para AYESA - PLUSGESTIONA !!
                         nAnyTmp = #nomyrenm#16;
                         |HAZ DesgloseConceptosXML;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |SI perlomens = 1;
               nNumTrabEmp = nNumTrabEmp + 1;
               nNumTrabCen = nNumTrabCen + 1;
               nAnyTmp = #nomyrenm#16;
               |HAZ grabatmp;
               |HAZ ElPRINT;
               |HAZ cabecer3A;
          |FINSI;
     |SINO;
          #nomcalac#0 = #labtraba#0;   || Empresa
          #nomcalac#1 = #labtraba#1;   || Trabajador
          #nomcalac#2 = month;  || Mes
          #nomcalac#3 = 5;      || Tipo
          |LEE 040#nomcalac.=;
          |SI FSalida = 0;

               |HAZ leetrabaA;
               |SI #nomyrenm#13 ! "T";
                    |SI #nomyrenm#13 = "A";|Y swbaja = 1;    |ACABA;   |FINSI;
                    |SI #nomyrenm#13 = "B";|Y swbaja = 0;    |ACABA;   |FINSI;
               |FINSI;

               |HAZ notarias;
               |HAZ cabecer1A;
               |HAZ cabecer2A;
               nNumTrabEmp = nNumTrabEmp + 1;
               nNumTrabCen = nNumTrabCen + 1;
               nAnyTmp = #nomyrenm#16;
               |HAZ grabatmp;
               |HAZ ElPRINT;
               |HAZ cabecer3A;

               |SI #nomyrenm#30 = 10;        || delglose conceptos para XML ADADE
               |O #nomyrenm#30 ] 50;         || y para AYESA - PLUSGESTIONA !!
                    |HAZ DesgloseConceptosXML;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO el_informeA;
     nDesdeEmp = nEmpresa;
     nHastaEmp = nEmpresa;

     nDesdeCen = #nomyrenm#11;
     nHastaCen = #nomyrenm#12;
     |SI enPorCen = 1;
         nDesdeCen = nCentro;
         nHastaCen = nCentro;
     |FINSI;

     |HAZ ResAtrasos;

     |HAZ rup_areasA;
     |HAZ rup_centrA;
     |HAZ tc1A;

     |SI #nomyrenm#4 = nTipoH; |O nTipoD = nTipoH;
          |SI #nomyrenm#30 = 02; |O #nomyrenm#30 = 03; |O #nomyrenm#30 = 04; |O #nomyrenm#30 = 10;
          |O #nomyrenm#30 ] 50;
          |O informe = "nomyren2"; |O informe = "nomyren4";

               |SI #nomyrenm#17 = 1;

               |FINSI;
          |SINO;
               |PIEINF;
               |FININF;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cabecer1A;
|SI sw = 0;
        seleccio = 1;
        empresa = #labtraba#0;
        grupo = #labtraba#62;
        centro = #labtraba#77;
        sw = 1;
|FINSI;
|SI empresa ! #labtraba#0;                    || ruptura por empresa
    |HAZ rup_areasA;
    |HAZ rup_centrA;
    |HAZ rup_empreA;
    nNumTrabEmp = 0;
    nNumTrabCen = 0;
|SINO;
    |SI centro ! #labtraba#77;                           || ruptura por centro
        |HAZ rup_areasA;
        |HAZ rup_centrA;
        nNumTrabCen = 0;
    |SINO;
        |SI grupo ! #labtraba#62;                        || ruptura por areas
            |HAZ rup_areasA;
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO rup_empreA;
    swlin = 2;
    FSalida = "PAGINA";
|HAZ ElPRINT;
|HAZ limptotal;
    empresa = #labtraba#0;
    swlin = 0;
|FPRC;

|PROCESO rup_centrA;
|HAZ lee_centro;
    swlin = 1;
    varinf1 = "Centro: " + #4#1 + "/" + #4#2;
|HAZ puecentro;
|SI nNumTrabCen > 0;
     |HAZ ElPRINT;
|FINSI;
|HAZ limparcial;
    centro = #labtraba#77;
    swlin = 0;
|FPRC;

|PROCESO rup_areasA;
|SI #nomyrenm#6 = "S";
    |HAZ lee_area;
        swlin = 1;
        varinf1 = "Area: " + #5#0 + "/" + #5#1;
    |HAZ puegrupos;
    |HAZ ElPRINT;
    |HAZ limpgrupos;
        grupo = #labtraba#62;
        swlin = 0;
|FINSI;
|FPRC;

|PROCESO cabecer2A;
    inf_enf = #nomcalac#57 + #nomcalac#58;      || Prestaciones
    inf_sub = #nomcalac#46 - inf_enf + #nomcalac#45;            || Coste trabajador
    inf_bru = #nomcalac#46;                              || Importe bruto
    inf_dto = #nomcalac#52 + #nomcalac#53 + #nomcalac#54 + #nomcalac#89;      || Dto.varios
    inf_tan = #nomcalac#13; inf_tan = inf_tan ! 2;       || Porcentaje
    inf_ded = #nomcalac#75;                              || Deduccion
    || ded_not = (#nomcalac#48 < notaria) ! 2;
    || inf_dse = ded_not + #nomcalac#49 + #nomcalac#50 + #nomcalac#51;    || Deduccion S.S
    inf_dse = #nomcalac#48 + #nomcalac#49 + #nomcalac#50 + #nomcalac#51;    || Deduccion S.S
    inf_liq = inf_bru -inf_dto -inf_ded -inf_dse; || Liquido
    inf_bon = #nomcalac#63 + #nomcalac#81 + #nomcalac#88 + #nomcalac#64 + #nomcalac#106;      || bonif
    inf_sss = #nomcalac#45;                              || S.S CGO
    inf_exe = #nomcalac#18;                              || Base IRPF exenta
    inf_tip = #nomcalac#3;
    inf_pro = #nomcalac#38;                              || prorrata
    inf_basecc = #nomcalac#39 + #nomcalac#79;
    inf_basecp = #nomcalac#40 + #nomcalac#80;
    inf_hasehe_fm = #nomcalac#41;
    inf_basehe_nor = #nomcalac#42;
    inf_baseirpf = #nomcalac#14;
    inf_baseirpfpa = #nomcalac#16;
    inf_dtoirpfpa = #nomcalac#17;
    inf_baseirpfes = #nomcalac#69 + #nomcalac#70;
    inf_dtoirpfes = #nomcalac#71 + #nomcalac#72;
    inf_dtoirpfdi = #nomcalac#15 + #nomcalac#17;
    |SI enCuadre = 51;
         inf_dtoirpfdi = inf_dtoirpfdi - #nomcalac#17;
    |FINSI;

    ||SI #nomcont3#2 = "S";
          || para todos
          |SALVA_FICHA #labtraba;
          #labtraba#0 = #nomcalac#0; #labtraba#1 = #nomcalac#1; |LEE 000#labtraba.=;
          |BUCLE PagasProrrAtr;
          |REPON_FICHA #labtraba;
    ||FINSI;
|FPRC;

|PROCESO cabecer3A;
    ginf_enf = ginf_enf + inf_enf;       || Enfermedad
    ginf_sub = ginf_sub + inf_sub;       || Subnormalidad
    ginf_bru = ginf_bru + inf_bru;       || Importe bruto
    ginf_dto = ginf_dto + inf_dto;       || Dto.varios
    ginf_tan = ginf_tan ! 2;             || Porcentaje
    ginf_ded = ginf_ded + inf_ded;       || Deduccion
    ginf_dse = ginf_dse + inf_dse;       || Deduccion S.S
    ginf_liq = ginf_liq + inf_liq;       || Liquido
    ginf_bon = ginf_bon + inf_bon;       || S.S CGO
    ginf_sss = ginf_sss + inf_sss;       || S.S CGO
    ginf_exe = ginf_exe + inf_exe;       || Base IRPF exenta
    ginf_pro = ginf_pro + inf_pro;       || Prorrata

    cinf_enf = cinf_enf + inf_enf;       || Enfermedad
    cinf_sub = cinf_sub + inf_sub;       || Subnormalidad
    cinf_bru = cinf_bru + inf_bru;       || Importe bruto
    cinf_dto = cinf_dto + inf_dto;       || Dto.varios
    cinf_tan = cinf_tan ! 2;             || Porcentaje
    cinf_ded = cinf_ded + inf_ded;       || Deduccion
    cinf_dse = cinf_dse + inf_dse;       || Deduccion S.S
    cinf_liq = cinf_liq + inf_liq;       || Liquido
    cinf_bon = cinf_bon + inf_bon;       || S.S CGO
    cinf_sss = cinf_sss + inf_sss;       || S.S CGO
    cinf_exe = cinf_exe + inf_exe;       || Base IRPF exenta
    cinf_pro = cinf_pro + inf_pro;       || prorrata

|FPRC;

|PROCESO cabecer4A;
    inf_enf = inf_enf + #nomcalac#57 + #nomcalac#58;      || Prestaciones
    prestac = #nomcalac#57 + #nomcalac#58;                || Prestaciones
    inf_sub = inf_sub + (#nomcalac#46 - prestac + #nomcalac#45);          || Coste trabaj.
    inf_bru = inf_bru + #nomcalac#46;                              || Importe bruto
    inf_dto = inf_dto + #nomcalac#52 + #nomcalac#53 + #nomcalac#54;              || Dto.varios
    inf_tan = #nomcalac#13; inf_tan = inf_tan ! 2;                 || Porcentaje
    inf_ded = inf_ded + #nomcalac#75;                              || Deduccion
    || ded_not = (#nomcalac#48 < notaria) ! 2;
    || inf_dse = inf_dse + ded_not + #nomcalac#49 + #nomcalac#50 + #nomcalac#51;    || Deduccion S.S
    inf_dse = inf_dse + #nomcalac#48 + #nomcalac#49 + #nomcalac#50 + #nomcalac#51;    || Deduccion S.S
    inf_liq = inf_bru -inf_dto -inf_ded -inf_dse;           || Liquido
    inf_bon = inf_bon + #nomcalac#63 + #nomcalac#81 + #nomcalac#88 + #nomcalac#64 + #nomcalac#106;      || bonif
    inf_sss = inf_sss + #nomcalac#45;                              || S.S CGO
    inf_exe = inf_exe + #nomcalac#18;                              || Base IRPF exe.

    inf_prest_enf_ss = inf_prest_enf_ss + #nomcalac#57;
    inf_prest_enf_emp = inf_prest_enf_emp + #nomcalac#73;
    inf_comp_enf = inf_comp_enf + #nomcalac#59;
    inf_prest_acc_ss = inf_prest_acc_ss + #nomcalac#58;
    inf_comp_acc = inf_comp_acc + #nomcalac#60;
    inf_dias = inf_dias + #nomcalac#8;

    inf_tip = #nomcalac#3;
    inf_pro = inf_pro + #nomcalac#38;                              || bonif
     ||SI #nomcont3#2 = "S";
          || para todos
          |SALVA_FICHA #labtraba;
          #labtraba#0 = #nomcalac#0; #labtraba#1 = #nomcalac#1; |LEE 000#labtraba.=;
          |BUCLE PagasProrrAtr;
          |REPON_FICHA #labtraba;
     ||FINSI;
    inf_basecc = inf_basecc + #nomcalac#39 + #nomcalac#79;
    inf_basecp = inf_basecp + #nomcalac#40 + #nomcalac#80;
    inf_hasehe_fm = inf_hasehe_fm + #nomcalac#41;
    inf_basehe_nor = inf_basehe_nor + #nomcalac#42;
    inf_baseirpf = inf_baseirpf + #nomcalac#14;
    inf_baseirpfpa = inf_baseirpfpa + #nomcalac#16;
    inf_dtoirpfpa = inf_dtoirpfpa + #nomcalac#17;
    inf_baseirpfes = inf_baseirpfes + #nomcalac#69 + #nomcalac#70;
    inf_dtoirpfes = inf_dtoirpfes + #nomcalac#71 + #nomcalac#72;
    inf_dtoirpfdi = inf_dtoirpfdi + #nomcalac#15 + #nomcalac#17;
    |SI enCuadre = 51;
         inf_dtoirpfdi = inf_dtoirpfdi - #nomcalac#17;
    |FINSI;
|FPRC;

|PROCESO &totales;
    tinf_enf = tinf_enf + inf_enf;        || Enfermedad
    tinf_sub = tinf_sub + inf_sub;        || Subnormalidad
    tinf_bru = tinf_bru + inf_bru;        || Importe bruto
    tinf_dto = tinf_dto + inf_dto;        || Dto.varios
    tinf_tan = tinf_tan ! 2;              || Porcentaje
    tinf_ded = tinf_ded + inf_ded;        || Deduccion
    tinf_dse = tinf_dse + inf_dse;        || Deduccion S.S
    tinf_liq = tinf_liq + inf_liq;        || Liquido
    tinf_bon = tinf_bon + inf_bon;        || Bonif
    tinf_sss = tinf_sss + inf_sss;        || S.S CGO
    tinf_exe = tinf_exe + inf_exe;        || Base IRPF exenta
    tinf_pro = tinf_pro + inf_pro;        || Prorrata
|FPRC;

|PROCESO leyendo_tc1A;
|SI x_tipo = 5; |Y #labempax#2 ! 5;  |ACABA;  |FINSI;
|SI x_tipo = 0; |Y #labempax#2 = 5;  |ACABA;  |FINSI;
    hay_algo = 1;
    tinf_tc1re = tinf_tc1re + #labempax#20;
|FPRC;

|DEFBUCLE lee_tc1A;
 #labempax#1;
 ;
 empresa, x_centro, desde_mes, nTipo;
 empresa, y_centro, hasta_mes, nTipo;
 ;
 NULL, leyendo_tc1A;
|FIN;

|PROCESO Aux_tc1A;
     nImporteTC1 = 0;

     |BUCLE lee_tc1A;

     |SI #cretam00#8 = "R"; |Y #labempre#67 = "S";
          nAnyCretaDesde = #nomyrenm#16;
          nAnyCretaHasta = #nomyrenm#16;
          nMesCretaDesde = desde_mes;
          nMesCretaHasta = hasta_mes;
          swHayCreta = 0;

          |SI #nomcalac#171# = 1; nTipo = 90; |FINSI;
          |BUCLE lee_creta;
          nTipo = 5;
          |SI swHayCreta = 1;
               tinf_tc1re = tinf_tc1re - nImporteTC1;  || por si hubiera importe en
                                                       || el auxiliar
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tc1A;
     swMora = 0;
     nRecargo = 0;
     tinf_tc1 = 0;
     aFuenteTotal = "";
     tinf_tc1re = 0;
     hay_algo = 0;

     resumen = #nomyrenm#7;
     x_tipo = 5;
     |SI #nomyrenm#17 = 2;
          desde_mes = #nomyrenm#2;      || refundidos
          hasta_mes = #nomyrenm#9;
     |SINO;
          desde_mes = month;     || separados
          hasta_mes = month;
     |FINSI;

     tinf_tc1 = (tinf_sss + tinf_dse) - tinf_enf;    || aproximado
     aAunno = "";

     x_centro = 99;
     y_centro = 99;
     nTipo = #nomyrenm#4;

     |HAZ Aux_tc1A;
     |SI hay_algo = 0;
          x_centro =  1;
          y_centro = 98;
          nTipo = #nomyrenm#4;
          |HAZ Aux_tc1A;
          |SI hay_algo = 0;
               ||tinf_tc1=(tinf_sss+tinf_dse)-tinf_enf;
               tinf_tc1re = tinf_tc1;
          |SINO;
               aAunno = "";
          |FINSI;
     |FINSI;
    |HAZ grabatot;
|FPRC;

|PROCESO bufaloA;
    inf_enf = 0;
    inf_sub = 0;
    inf_bru = 0;
    inf_dto = 0;
    inf_tan = 0;
    inf_ded = 0;
    inf_dse = 0;
    inf_liq = 0;
    inf_sss = 0;
    inf_bon = 0;
    inf_for = 0;
    inf_pro = 0;
    inf_exe = 0;
    perlomens = 0;
    swlin = 0;
    inf_prest_enf_emp = 0;
    inf_prest_enf_ss = 0;
    inf_comp_enf = 0;
    inf_prest_acc_ss = 0;
    inf_comp_acc = 0;
    inf_dias = 0;
     inf_basecc = 0;
     inf_basecp = 0;
     inf_hasehe_fm = 0;
     inf_basehe_nor = 0;
     inf_baseirpf = 0;
     inf_baseirpfes = 0;
     inf_dtoirpfes = 0;
     inf_dtoirpfdi = 0;
     inf_baseirpfpa = 0;
     inf_dtoirpfpa = 0;
|FPRC;

|PROCESO namemes;
|SI month =  1;  p_mes = "ENERO     ";  |FINSI;
|SI month =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI month =  3;  p_mes = "MARZO     ";  |FINSI;
|SI month =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI month =  5;  p_mes = "MAYO      ";  |FINSI;
|SI month =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI month =  7;  p_mes = "JULIO     ";  |FINSI;
|SI month =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI month =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI month = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI month = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI month = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|FPRC;

|PROCESO Atrasos;
          fecha = #nomyrenm#3;
          |ABRE #nomcalac;
          |ABRE #labempre;
          |SI #nomyrenm#17 = 2;
               month = #nomyrenm#2;     |HAZ namemes;  mesa = p_mes;
               month = #nomyrenm#9;     |HAZ namemes;  mesb = p_mes;
               aAlfa = #nomyrenm#16;
               cabeza = "RESUMEN NOMINAS ATRASOS - " + mesa + "/" + mesb;
               cabeza = cabeza + " (" + aAlfa + ")";
               |HAZ centra;
               p_mes1 = #nomyrenm#2;
               p_mes2 = #nomyrenm#9;
               seleccio = 0;
               sw = 0;
               |HAZ el_informeA;
          |SINO;
               |PARA month = #nomyrenm#2; |SI month [ #nomyrenm#9; |HACIENDO month = month + 1;
                    |HAZ namemes;
                    aAlfa = #nomyrenm#16;
                    cabeza = "RESUMEN NOMINAS ATRASOS - " + p_mes;
                    cabeza = cabeza + " (" + aAlfa + ")";
                    |HAZ centra;
                    p_mes1 = month;
                    p_mes2 = month;
                    seleccio = 0;
                    sw = 0;
                    |HAZ limptotal;
                    |HAZ limparcial;
                    |HAZ bufaloA;
                    |HAZ el_informeA;
               |SIGUE;
          |FINSI;
          |CIERRA #nomcalac;
          |CIERRA #labempre;

          |SI #nomyrenm#30 = 02; |O #nomyrenm#30 = 04; |O #nomyrenm#30 ] 50;
               |SI #nomyrenm#17 = 1;
                    |HAZ ElInforme;
               |FINSI;
          |FINSI;
|FPRC;

-------------------------------------------------------------------------------
                    ||   PROCESOS COMUNES

|PROCESO prepara_impresion;
     aDir = "/tmp/";
     Impresora = aDir + Usuario;
     |PINTA 2001, Usuario;
     |PINTA 2101, Impresora;
     |IMPRE -77;
     |PINTA 2201, FSalida;
     |SI FSalida ! 0;
          nErrorInf = 1;
     |FINSI;
     aAlfa1 = "chmod 777 " + Impresora;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO traete_fichero;
     |FINIMP;
     cOrigen = aDir + Usuario;
     cDestino = aDirDes;
     |QBF cDestino;
     aArchivo = aArchivo - ".txt";
     cDestino = cDestino + aArchivo;
     |COPIA_FICHERO cOrigen, cDestino;
     |SI FSalida ! 0;
          nErrorInf = 0;
     |FINSI;
     aAlfa1 = "chmod 777 " + cDestino;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO ConviertePdf;
     |DBASS aBaseBin;  |QBF aBaseBin;
     aBaseBin = aBaseBin + "bin/topdf.sh ";

     aSystem = aBaseBin + cDestino;
     |SYSTEM aSystem;

     aSystem = "chmod 777 " + cDestino + ".pdf";
     |SYSTEM aSystem;

     |FBORRA cDestino;

     ||SI #nomyrenm#6 = "S";  |HAZ AlaWeb;  |FINSI;
     ||SI #nomyrenm#5 = "S";  |HAZ Correo;  |FINSI;

     ||FBORRA aPdf;
|FPRC;
-------------------------------------------------------------------------------

|PROCESO borra_dbfs;
     |DFICE aRutaFich;
     |QBF aRutaFich;

     aAlfa = aRutaFich + "reg_res/*.dbf";
     |_PDIR aAlfa;
     nNume = 0;
     |SI FSalida = 0;
          |PARA; |SI FSalida = 0; |Y nNume [ 100; |HACIENDO;
               nNume = nNume + 1;
               aAlfa1 = aAlfa;
               |FBORRA aAlfa1;
               |_SDIR aAlfa;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO graba_dbfs2;
     aAlfa = nRegistro ; |QBF aAlfa;
     aAlfa = ("0000000" + aAlfa) % -107;
     aDestino = aAlfa + "_";
     aAlfa = fFechaEmision; |QBF aAlfa;
     aAlfa = (aAlfa % 102) + (aAlfa % 402) + (aAlfa % -104);
     aDestino = aDestino + aAlfa;
     aAlfa = aHoraEmision; |QBF aAlfa;
     aAlfa = (aAlfa % 102) + (aAlfa % 402) + (aAlfa % 702);
     aDestino = aDestino + "_" + aAlfa;
     |SI aOrigen = "c:\ds\crystal\cabecera.dbf";
     |O aOrigen = "c:\dspi\crystal\cabecera.dbf";
          aDestino = aDestino + "_cab.dbf";
     |SINO;
          aDestino = aDestino + "_det.dbf";
     |FINSI;
     aDestino = aRutaDestino + "/" + aDestino;

     |RECIBE_FICHERO aOrigen, aDestino;
|FPRC;

|PROCESO graba_dbfs;
     |DFICE aRutaFich;
     |QBF aRutaFich;
     aRutaDestino = aRutaFich + "reg_res";
     |RMKDIR aRutaDestino;

     aAlfa = "c:\ds\crystal\cabecera.dbf";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          aOrigen = aAlfa;
     |SINO;
          aAlfa = "c:\dspi\crystal\cabecera.dbf";
          |XABRE "CE", aAlfa, nHandle;
          |SI FSalida ] 0;
               aOrigen = aAlfa;
          |FINSI;
     |FINSI;
     |QBF aOrigen;

     |HAZ graba_dbfs2;

     aAlfa = "c:\ds\crystal\detalle.dbf";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          aOrigen = aAlfa;
     |SINO;
          aAlfa = "c:\dspi\crystal\detalle.dbf";
          |XABRE "CE", aAlfa, nHandle;
          |SI FSalida ] 0;
               aOrigen = aAlfa;
          |FINSI;
     |FINSI;
     |QBF aOrigen;

     |HAZ graba_dbfs2;
|FPRC;

|PROCESO ResumenEmpresa;
     |SI swCuenta = 1;
          nTotalEmpresas = nTotalEmpresas + 1;
          |ACABA;
     |FINSI;
     |SI nOpcion = 2;
         |SI enCuadre ! 50; |Y enCuadre ! 51; |Y enCuadre ! 52;
          |Y enCuadre ! 02; |Y enCuadre ! 55;
             alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
             |NOME_DAT #nomtmpre#alfa1#;  |DELINDEX #nomtmpre;
             alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
             |NOME_DAT #nomtmprf#alfa1#;  |DELINDEX #nomtmprf;

             |ABRE #nomtmprf;
             |ABRE #nomtmpre;
             |ABRE #labcentr;
             |ABRE #nomauxi1;

             swHayAlgo = 0;
         |FINSI;
     |FINSI;

     nEmpresa     = #nomyrtmp#0;
     aFuenteTotal = "";
     tinf_tc1re = 0;

     |PARA nPara = nTipoD; |SI nPara [ nTipoH; |HACIENDO nPara = nPara + 1;
          #nomyrenm#4 = nPara;
          |SI #nomyrenm#14 = "M"; |O #nomyrenm#14 = "A";
               aFuenteTotal = "";
               tinf_tc1re = 0;     || en mensual si, no se por que en hco no
               |SI 0 [ nPara; |Y nPara [ 2;
                    |HAZ Mensual;
               |FINSI;
               |SI 5 [ nPara; |Y nPara [ 9;
                    |HAZ Atrasos;
               |FINSI;
          |FINSI;

          |SI #nomyrenm#14 = "H";
               |HAZ Historico;
          |FINSI;
     |SIGUE;

     |SI nOpcion = 2;
         |SI enCuadre ! 50; |Y enCuadre ! 51; |Y enCuadre ! 52;
          |Y enCuadre ! 02; |Y enCuadre ! 55;
             |SI swHayAlgo = 1;
                  eaInforme = informe;
                  |HAZ IMPREArchi;
                  |INFOR informe;

                  |HAZ ElInforme;

                  |PIEINF;
                  |FININF;

                  |HAZ Mensaje;           || mensaje de envio al dsarchi
                  |HAZ Archivando;
              |FINSI;

              |CIERRA #nomauxi1;
              |CIERRA #labcentr;
              |CIERRA #nomtmpre;  |DELINDEX #nomtmpre;
              |CIERRA #nomtmprf;  |DELINDEX #nomtmprf;
              |CIERRA #nomtmprg;  |DELINDEX #nomtmprg;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE ResumenEmpresa;
     #nomyrtmp#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ResumenEmpresa;
|FIN;

|PROCESO ResumenCentro;
     |SI swCuenta = 1;
          nTotalCentros = nTotalCentros + 1;
          |ACABA;
     |FINSI;
     |SI nOpcion = 2;
         |SI enCuadre ! 50; |Y enCuadre ! 51; |Y enCuadre ! 52;
          |Y enCuadre ! 02; |Y enCuadre ! 55;
             alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
             |NOME_DAT #nomtmpre#alfa1#;  |DELINDEX #nomtmpre;

             alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
             |NOME_DAT #nomtmprf#alfa1#;  |DELINDEX #nomtmprf;

             |ABRE #nomtmprf;
             |ABRE #nomtmpre;
             |ABRE #labcentr;
             |ABRE #nomauxi1;

             swHayAlgo = 0;
         |FINSI;
     |FINSI;

     nEmpresa     = #nomystmp#0;
     nCentro      = #nomystmp#1;
     aFuenteTotal = "";
     tinf_tc1re = 0;

     |PARA nPara = nTipoD; |SI nPara [ nTipoH; |HACIENDO nPara = nPara + 1;
          #nomyrenm#4 = nPara;
          |SI #nomyrenm#14 = "M"; |O #nomyrenm#14 = "A";
               aFuenteTotal = "";
               tinf_tc1re = 0;     || en mensual si, no se por que en hco no
               |SI 0 [ nPara; |Y nPara [ 2;
                    |HAZ Mensual;
               |FINSI;
               |SI 5 [ nPara; |Y nPara [ 9;
                    |HAZ Atrasos;
               |FINSI;
          |FINSI;

          |SI #nomyrenm#14 = "H";
               |HAZ Historico;
          |FINSI;
     |SIGUE;

     |SI nOpcion = 2;
         |SI enCuadre ! 50; |Y enCuadre ! 51; |Y enCuadre ! 52;
          |Y enCuadre ! 02; |Y enCuadre ! 55;
              |SI swHayAlgo = 1;
                  eaInforme = informe;
                  |HAZ IMPREArchi;
                  |INFOR informe;

                  |HAZ ElInforme;

                  |PIEINF;
                  |FININF;

                  enCen = #nomystmp#1;
                  eaCen = #nomystmp#2;

                  |HAZ Mensaje;           || mensaje de envio al dsarchi
                  |HAZ Archivando;
              |FINSI;

              |CIERRA #nomauxi1;
              |CIERRA #labcentr;
              |CIERRA #nomtmpre;  |DELINDEX #nomtmpre;
              |CIERRA #nomtmprf;  |DELINDEX #nomtmprf;
              |CIERRA #nomtmprg;  |DELINDEX #nomtmprg;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE ResumenCentro;
     #nomystmp#1;
     ;
     00000, #nomyrenm#11;
     99999, #nomyrenm#12;
     ;
     NULL, ResumenCentro;
|FIN;

|PROCESO TmpAtrasos;
     #nomyrtmp#0 = #nomcalac#0;
     |LEE 000#nomyrtmp.=;
     |SI FSalida ! 0;
         |GRABA 000#nomyrtmp.n;
     |FINSI;

     |SI enPorCen = 1;
         #labtraba#0 = #nomcalac#0;
         #labtraba#1 = #nomcalac#1;
         |LEE 000#labtraba.=;

         |SI #labtraba#77 < #nomyrenm#11;  |ACABA;  |FINSI;
         |SI #labtraba#77 > #nomyrenm#12;  |ACABA;  |FINSI;

         #nomw0024#0 = #labtraba#0;
         #nomw0024#1 = #labtraba#77;
         |LEE 000#nomw0024.=;
         |SI FSalida = 0;
             |ACABA;
         |FINSI;

         #labcentr#0 = #labtraba#0;
         #labcentr#1 = #labtraba#77;
         |LEE 000#labcentr.=;

         #nomystmp#0 = #labtraba#0;
         #nomystmp#1 = #labtraba#77;
         |LEE 000#nomystmp.=;
         |SI FSalida ! 0;
             #nomystmp#2 = #labcentr#2;
             |GRABA 000#nomystmp.n;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TmpAtrasos;
     #nomcalac#1;
     ;
     nDesdeEmpSel, 00001, #nomyrenm#2, 5;
     nHastaEmpSel, 99999, #nomyrenm#9, 5;
     ;
     NULL, TmpAtrasos;
|FIN;

|PROCESO TmpHistorico;
     |SI #nomhicca#66 = #nomyrenm#5;
          |SI #nomhicca#2 < #nomyrenm#2;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #nomhicca#66 = #nomyrenm#10;
          |SI #nomhicca#2 > #nomyrenm#9;
               |ACABA;
          |FINSI;
     |FINSI;

     #nomyrtmp#0 = #nomhicca#0;
     |LEE 000#nomyrtmp.=;
     |SI FSalida ! 0;
         |GRABA 000#nomyrtmp.n;
     |FINSI;

     |SI enPorCen = 1;
         #labtraba#0 = #nomhicca#0;
         #labtraba#1 = #nomhicca#1;
         |LEE 000#labtraba.=;

         |SI #labtraba#77 < #nomyrenm#11;  |ACABA;  |FINSI;
         |SI #labtraba#77 > #nomyrenm#12;  |ACABA;  |FINSI;

         #nomw0024#0 = #labtraba#0;
         #nomw0024#1 = #labtraba#77;
         |LEE 000#nomw0024.=;
         |SI FSalida = 0;
             |ACABA;
         |FINSI;

         #labcentr#0 = #labtraba#0;
         #labcentr#1 = #labtraba#77;
         |LEE 000#labcentr.=;

         #nomystmp#0 = #labtraba#0;
         #nomystmp#1 = #labtraba#77;
         |LEE 000#nomystmp.=;
         |SI FSalida ! 0;
             #nomystmp#2 = #labcentr#2;
             |GRABA 000#nomystmp.n;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TmpHistorico;
     #nomhicca#1;
     ;
     nDesdeEmpSel, 00001, #nomyrenm#5,  01, #nomyrenm#4;
     nHastaEmpSel, 99999, #nomyrenm#10, 12, #nomyrenm#19;
     ;
     NULL, TmpHistorico;
|FIN;

|PROCESO TmpMensual;
     #nomyrtmp#0 = #nomcalca#0;
     |LEE 000#nomyrtmp.=;
     |SI FSalida ! 0;
         |GRABA 000#nomyrtmp.n;
     |FINSI;

     |SI enPorCen = 1;
         #labtraba#0 = #nomcalca#0;
         #labtraba#1 = #nomcalca#1;
         |LEE 000#labtraba.=;

         |SI #labtraba#77 < #nomyrenm#11;  |ACABA;  |FINSI;
         |SI #labtraba#77 > #nomyrenm#12;  |ACABA;  |FINSI;

         #nomw0024#0 = #labtraba#0;
         #nomw0024#1 = #labtraba#77;
         |LEE 000#nomw0024.=;
         |SI FSalida = 0;
             |ACABA;
         |FINSI;

         #labcentr#0 = #labtraba#0;
         #labcentr#1 = #labtraba#77;
         |LEE 000#labcentr.=;

         #nomystmp#0 = #labtraba#0;
         #nomystmp#1 = #labtraba#77;
         |LEE 000#nomystmp.=;
         |SI FSalida ! 0;
             #nomystmp#2 = #labcentr#2;
             |GRABA 000#nomystmp.n;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TmpMensual;
     #nomcalca#1;
     ;
     nDesdeEmpSel, 00001, #nomyrenm#15, #nomyrenm#4;
     nHastaEmpSel, 99999, #nomyrenm#15, #nomyrenm#19;
     ;
     NULL, TmpMensual;
|FIN;

|PROCESO TmpGrupo;
     nDesdeEmpSel = #nomgruel#1; nHastaEmpSel = #nomgruel#1;

     |SI #nomyrenm#14 = "M";
          |BUCLE TmpMensual;
     |FINSI;

     |SI #nomyrenm#14 = "H";
          |BUCLE TmpHistorico;
     |FINSI;

     |SI #nomyrenm#14 = "A";
          |BUCLE TmpAtrasos;
     |FINSI;
|FPRC;

|DEFBUCLE TmpGrupo;
     #nomgruel#1;
     ;
     nGrupo, 00001;
     nGrupo, 99999;
     ;
     NULL, TmpGrupo;
|FIN;

|PROCESO CargaTmpEmp;
     |ABRET #labtraba;
     |ABRET #labcentr;
     |SI #nomyrenm#21 ! 0;
          |PARA nCampoG = 21; |SI nCampoG [ 28; |HACIENDO nCampoG = nCampoG + 1;
               |SI #nomyrenm#nCampoG# ! 0;
                    nGrupo = #nomyrenm#nCampoG#;
                    |ABRE #nomgruec;
                    #nomgruec#0 = nGrupo;
                    |LEE 000#nomgruec.=;
                    aTotalGrupo = #nomgruec#2;
                    |BUCLE TmpGrupo;
                    |CIERRA #nomgruec;
               |FINSI;
          |SIGUE;
     |SINO;
          nDesdeEmpSel = #nomyrenm#0; nHastaEmpSel = #nomyrenm#1;

          |SI #nomyrenm#14 = "M";
               |BUCLE TmpMensual;
          |FINSI;

          |SI #nomyrenm#14 = "H";
               |BUCLE TmpHistorico;
          |FINSI;

          |SI #nomyrenm#14 = "A";
               |BUCLE TmpAtrasos;
          |FINSI;
     |FINSI;

     |CIERRAT #labtraba;
     |CIERRAT #labcentr;
|FPRC;

|PROCESO temporales;
     || temporal para guardar las empresa de las que hay datos para resumenes

     aFic = "nomyrtmp" + Usuario;
     |NOME_DAT #nomyrtmp#aFic#;  |DELINDEX #nomyrtmp;
     |ABRE #nomyrtmp;

     aFic = "nomystmp" + Usuario;
     |NOME_DAT #nomystmp#aFic#;  |DELINDEX #nomystmp;
     |ABRE #nomystmp;

     aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmprg_" + aAlfa;
     |NOME_DAT #nomtmprg#aAlfa#;  |DELINDEX #nomtmprg;

     |ABRE #nomtmprg;

     |HAZ CargaTmpEmp;
|FPRC;

|PROCESO Proceso;
     |SI swDesglose = 1;
         |SI #nomyrenm#4 = 0; |Y #nomyrenm#19 = 0;
              #nomyrenm#4 = 0;
              #nomyrenm#19 = 1;
              nTipoD = 0;
              nTipoH = 1;
         |FINSI;
     |FINSI;

     informe   = "nomyrweb";          || el informe de siempre
     aRupAreas = #nomyrenm#6;
     resumen   = #nomyrenm#7;
     nOrdenEmp = #nomyrenm#31;
     nOrdenTra = #nomyrenm#8;
     nTipoD    = #nomyrenm#4;
     nTipoH    = #nomyrenm#19;
     nTipoOriD = #nomyrenm#4;
     nTipoOriH = #nomyrenm#19;
     aNomPag   = "N";

     swAtrasosHis = 0;
     |SI #nomyrenm#14 = "H"; |Y nTipoD ] 6;
          swAtrasosHis = 1;
          enTipoAt     = nTipoD;
     |FINSI;

     |SI #nomyrenm#14 = "A";
         |SI #nomyrenm#30 = 10; |Y #nomyrenm#17 = 1;
             aAlfa = "    En la impresión de resúmenes de atrasos en XML "
             aAlfa = aAlfa + "no se desglosa por meses, se emitirán refundidos";
             |MENAV aAlfa;
             #nomyrenm#17 = 2;
         |FINSI;
     |FINSI;

     enTipoInf = #nomyrenm#17;
     |SI #nomyrenm#14 = "A";
         swPagasSN = 1;
         swAtrasos = 1;
         enTipoAt = nTipoD;
     |FINSI;

     eaFuente   = #nomyrenm#14;
     enDesdeMes = #nomyrenm#2;
     enHastaMes = #nomyrenm#9;

     |SI #nomyrenm#14 = "H";
         enAny = #nomyrenm#5 + 2000;
     |SINO;
         enAny = #nomyrenm#16;
     |FINSI;

     |SI #nomyrenm#14 = "M";
         enDesdeMes = #nomyrenm#15;
     |FINSI;

     enCuadre  = #nomyrenm#30;
     swCrystal = 0;

     |SI #nomyrenm#4 = 0; |Y #nomyrenm#19 = 2;
         enTipoEmi = #nomyrenm#32;
     |SINO;
         enTipoEmi = 1;
     |FINSI;

     nHastaAny = #nomyrenm#10 + 2000;
     |SI #nomyrenm#4 = 2; |Y #nomyrenm#19 = 2;
         enSwFiniq = 1;
     |FINSI;
     swHayAlgo = 0;

     |SI nModoRepeticion = 1;
         Impresora = "CrystalReport";
         swCrystal = 1;

         |SI #nomyrenm#30 = 03;
             informe = informecrys3;
         |SINO;
             informe = informecrys2;
         |FINSI;

         |SI swDesglose = 1;
             informe = informecrys4;
         |FINSI;

         nOpcion = 2;
     |SINO;
         |HAZ ElCuadre;
         |SI nOpcion = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     |HAZ temporales;

     |SI nOpcion = 1; |O nOpcion = 3;
         alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
         |NOME_DAT #nomtmpre#alfa1#;  |DELINDEX #nomtmpre;
         |ABRE #nomtmpre;
         |ABRE #labcentr;
         |ABRE #nomauxi1;

          alfa1 = Usuario;  |QBF alfa1;
          alfa1 = "Y" + alfa1;
          |NOME_DAT #nomtmprf#alfa1#;
          |DELINDEX #nomtmprf;
          |ABRE #nomtmprf;
     |FINSI;

     swSigue = 1;
     |SI nOpcion = 2; |Y swSigue = 0;
         |ACABA;
     |FINSI;

     |SI FSalida = 0; |Y swErrorImp = 0;
         |SI #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 04; |Y #nomyrenm#30 ! 10;
         |Y #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
         |Y #nomyrenm#30 ! 55;
                                          || en excel no hay |INFOR que valga
            |SI nOpcion = 1; |O nOpcion = 3;     || importante, el INFOR lo hago despues
                |INFOR informe;     || si es para el dsarchi
            |FINSI;
         |FINSI;

         |SI nOpcion = 2;
             |SI enCuadre ] 50; |O enCuadre = 02;
                 alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
                 |NOME_DAT #nomtmpre#alfa1#;  |DELINDEX #nomtmpre;
                 alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
                 |NOME_DAT #nomtmprf#alfa1#;  |DELINDEX #nomtmprf;

                 |ABRE #nomtmprf;
                 |ABRE #nomtmpre;
                 |ABRE #labcentr;
                 |ABRE #nomauxi1;

                 swHayAlgo = 0;
              |FINSI;
         |FINSI;

          |SI enPorEmp = 1;
               |SI nOpcion = 2;
                    nTotalEmpresas = 0;
                    swCuenta = 1;
                    |BUCLE ResumenEmpresa;
                    |SI nTotalEmpresas > 25;
                         aAlfa = nTotalEmpresas;
                         |QBF aAlfa;
                         aAlfa = "    SATENCION. Se archivarán los resúmenes de un total de " + aAlfa;
                         aAlfa = aAlfa + " empresas. ¿Desea continuar?";
                         |CONFI aAlfa;
                         |SI FSalida ! 0;
                              |ACABA;
                         |SINO;
                              swYaConfirmado = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI nOpcionOri = 4; |Y nOpcion = 2;
               |Y swYaConfirmado = 0;
                    || emision y archivado, segunda pasada para archivar
                    aAlfa = "    S¿Desea continuar con el archivado del/los resúmenes emitidos?";
                    |CONFI aAlfa;
                    |SI FSalida ! 0;
                         |ACABA;
                    |FINSI;
               |FINSI;

               swCuenta = 0;
               |BUCLE ResumenEmpresa;
          |FINSI;

          |SI enPorCen = 1;
               |SI nOpcion = 2;
                    nTotalCentros = 0;
                    swCuenta = 1;
                    |BUCLE ResumenCentro;
                    |SI nTotalCentros > 25;
                         aAlfa = nTotalCentros;
                         |QBF aAlfa;
                         aAlfa = "    SATENCION. Se archivarán los resúmenes de un total de " + aAlfa;
                         aAlfa = aAlfa + " centros. ¿Desea continuar?";
                         |CONFI aAlfa;
                         |SI FSalida ! 0;
                              |ACABA;
                         |SINO;
                              swYaConfirmado = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI nOpcionOri = 7; |Y nOpcion = 2;
               |Y swYaConfirmado = 0;
                    || emision y archivado, segunda pasada para archivar
                    aAlfa = "    S¿Desea continuar con el archivado del/los resúmenes emitidos?";
                    |CONFI aAlfa;
                    |SI FSalida ! 0;
                         |ACABA;
                    |FINSI;
               |FINSI;

               swCuenta = 0;
               |BUCLE ResumenCentro;
         |FINSI;

         |SI nOpcion = 2;
             |SI swHayAlgo = 1;
                 aAlfa = ":dsarchi/dpntz001;CLI";
                 |SUB_EJECUTA aAlfa;
             |FINSI;
         |FINSI;

          |SI aParam = "M";
               |HAZ CompHis;
          |FINSI;

          |SI swHayAlgo = 1;
               |SI enCuadre ] 50; |O enCuadre = 02;
                    |HAZ ElInforme;
                    |SI swArchivaExcel = 1;  |Y swHayAlgo = 1;
                        aAlfa = ":dsarchi/dpntz001;CLI";
                        |SUB_EJECUTA aAlfa;
                    |FINSI;
               |SINO;
                    |SI nOpcion = 1; |O nOpcion = 3;
                         |HAZ ElInforme;
                    |FINSI;

                    |SI #nomyrenm#30 ! 02; |Y #nomyrenm#30 ! 04; |Y #nomyrenm#30 ! 10;
                    |Y #nomyrenm#30 ! 11;
                    |Y #nomyrenm#30 ! 50; |Y #nomyrenm#30 ! 51; |Y #nomyrenm#30 ! 52;
                    |Y #nomyrenm#30 ! 55;
                         |PIEINF;
                                        || al reves, lo que voy a hacer es ir borrando

                         |HAZ borra_dbfs;

                         |FININF;
                         |SI nFinimp = 1;
                              |FINIMP;
                              nFinimp = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               aAlfa = "    No se han encontrado datos para la generación de ";
               aAlfa = aAlfa + "resúmenes de nóminas";
               |MENAV aAlfa;
               |SI nFinimp = 1; |Y swHayAlgo = 0;
                    |FININF;
               |FINSI;
          |FINSI;
     |SINO;
          |MENAV error0;
     |FINSI;

     |SI nOpcion = 2;
          |SI enCuadre ] 50; |O enCuadre = 02;
               |CIERRA #nomauxi1;
               |CIERRA #labcentr;
               |CIERRA #nomtmpre;  |DELINDEX #nomtmpre;
               |CIERRA #nomtmprf;  |DELINDEX #nomtmprf;
               |CIERRA #nomtmprg;  |DELINDEX #nomtmprg;
          |FINSI;
     |FINSI;

     |SI nFinimp = 1;
         |FINIMP;
         nFinimp = 0;
     |FINSI;

     |CIERRA #nomauxi1;
     |CIERRA #labcentr;
     |CIERRA #nomtmpre;
     |CIERRA #nomyrtmp;
     |CIERRA #nomystmp;
     |CIERRA #nomtmprf;

     |DELINDEX #nomtmpre;
     |DELINDEX #nomyrtmp;
     |DELINDEX #nomystmp;
     |DELINDEX #nomtmprf;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     |HAZ Proceso;

     nModoRepeticion = 0;
     |SI nOpcion = 3;
         nOpcion = 2;
         |SI enCuadre ] 50; |O enCuadre = 02;
             swArchivaExcel = 1;
         |FINSI;

         nModoRepeticion = 1;
         #nomyrenm#4  = nTipoD;
         #nomyrenm#19 = nTipoH;

         |HAZ Proceso;
     |FINSI;

     |SI swHayAlgo = 1; |Y nOpcion = 2;
         aAlfa = "    Se han enviado al archivo documental los resúmenes generados";
         |MENAV aAlfa;
     |FINSI;

     #nomyrenm#4  = nTipoD;
     #nomyrenm#19 = nTipoH;
|FPRC;

|PROCESO LeeParam;
     |DBASS aRutaDes;
     |DBASS aRutaDatos;
     |QBF aRutaDes;
     |QBF aRutaDatos;
     aRutaDes = aRutaDes + "dsnetcom/def/dsnetm00.mas";
     |CARGA_DEF aRutaDes, dsnetm00@;
     |SI FSalida ! 0;
          |MENAV "    Error en CARGADEF: dsnetm00";
     |SINO;
          aRutaDatos = aRutaDatos + "dsnetcom/fich/";
          |PATH_DAT #dsnetm00@#aRutaDatos#;
          |ABRE #dsnetm00@;
          |LEE 000#dsnetm00@.p;
          |SI FSalida = 0;
               aDirDes = #dsnetm00@#7;
               aDirOri = aDirDes;
          |SINO;
               |MENAV "    Error de datos en fichero de configuracion dsnetm00";
          |FINSI;
          |CIERRA #dsnetm00@;
          |DESCARGA_DEF #dsnetm00@;
     |FINSI;
|FPRC;

|PROCESO LeeOrigen;
     aArchivo = PARAMETRO;
     |QBF aDirOri;
     aRuta = aDirOri + aArchivo;

     |XABRE "U", aRuta, nCanal;
     |SI FSalida ] 0;
          |XLEE nCanal, 100, aCabecera;
          |XLEE nCanal,   5, aTipoResumen;
          |XLEE nCanal,   5, aTipoNomina;
          |XLEE nCanal,  10, aEmpresa;
          |XLEE nCanal,  10, aAnyoDesde;
          |XLEE nCanal,  10, aAnyoHasta;
          |XLEE nCanal,  10, aMesDesde;
          |XLEE nCanal,  10, aMesHasta;
          |XLEE nCanal,   5, aOrdenacion;
     |FINSI;
     |XCIERRA nCanal;
     |QBF aCabecera;
     |QBF aTipoResumen;
     |QBF aTipoNomina;
     |QBF aEmpresa;
     |QBF aAnyoDesde;
     |QBF aAnyoHasta;
     |QBF aMesDesde;
     |QBF aMesHasta;
     |QBF aOrdenacion;

     nEmpresa    = aEmpresa;
     nAnyoDesde  = aAnyoDesde;
     nAnyoHasta  = aAnyoHasta;
     nMesDesde   = aMesDesde;
     nMesHasta   = aMesHasta;
     nOrdenacion = aOrdenacion;
|FPRC;

|PROCESO PasaParametros;
     #nomyrenm#0 = nEmpresa;
     #nomyrenm#1 = nEmpresa;
     #nomyrenm#2 = nMesDesde;
     #nomyrenm#3 = ~;
     |SI aTipoNomina = "M";
          #nomyrenm#4 = 0;
     |FINSI;
     |SI aTipoNomina = "A";
          #nomyrenm#4 = 5;
     |FINSI;
     |SI aTipoNomina = "F";
          #nomyrenm#4 = 2;
     |FINSI;
     |SI nAnyoDesde ] 2000;
          #nomyrenm#5 = nAnyoDesde - 2000;
     |SINO;
          #nomyrenm#5 = nAnyoDesde - 1900;
     |FINSI;
     #nomyrenm#6 = "N";
     #nomyrenm#7 = "S";
     #nomyrenm#8 = nOrdenacion;
     #nomyrenm#9 = nMesHasta;
     |SI nAnyoHasta ] 2000;
          #nomyrenm#10 = nAnyoHasta - 2000;
     |SINO;
          #nomyrenm#10 = nAnyoHasta - 1900;
     |FINSI;
     #nomyrenm#11 = 01;
     #nomyrenm#12 = 99;
     #nomyrenm#13 = "T";
     #nomyrenm#14 = "H";
     #nomyrenm#18 = "EUROS  ";
|FPRC;

|PROCESO Activa37; |TIPO 7;
     |SI #nomyrenm#36 = "S";
          |CAMPO_MODIFICA #nomyrenm#37, 1, "S";
     |SINO;
          #nomyrenm#37 = "";
          |PINTA #nomyrenm#37;
          |CAMPO_MODIFICA #nomyrenm#37, 1, "N";
     |FINSI;
|FPRC;

|PROCESO ActivaTipo; |TIPO 7;
     |SI #nomyrenm#14 = "A";
          |CAMPO_MODIFICA #nomyrenm#Campo#, 1, "N";
     |SINO;
          |CAMPO_MODIFICA #nomyrenm#Campo#, 1, "S";
     |FINSI;
|FPRC;

|PROCESO Mensa; |TIPO 7;
     |SI #nomyrenm#14 = "M";
          aAlfa = "    Desde tipo de nomina a emitir: (0) mensual; (2) finiquito";
     |SINO;
          aAlfa = "    Desde tipo de nomina a emitir: (0) mensual; (2) finiquito; (5 - 20) atrasos";
     |FINSI;
     |MENSA aAlfa;
|FPRC;

|PROCESO VerifTipo; |TIPO 0;
     |SI #nomyrenm#14 = "M";
          |SI #nomyrenm#Campo# > 2;
               aAlfa = "    Desde el proceso mensual solo se emiten resúmenes de nóminas del mes ";
               aAlfa = aAlfa + "y finiquitos.";
               |MENAV aAlfa;
               aAlfa = "    Los resúmenes de atrasos, se emitirán desde el proceso atrasos.";
               |MENAV aAlfa;

               |SI Campo = 4;
                    #nomyrenm#Campo# = 0;
                    |PINTA #nomyrenm#Campo#;
               |FINSI;

               |SI Campo = 19;
                    #nomyrenm#Campo# = #nomyrenm#4;
                    |PINTA #nomyrenm#Campo#;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Activa32; |TIPO 7;
     |SI #nomyrenm#4 = 0; |Y #nomyrenm#19 = 2; |Y swDesglose = 0;
          |CAMPO_MODIFICA #nomyrenm#32, 1, "S";
          |CAMPO_VISUAL #nomyrenm#32, 1, "S";
          |PINTA 1847, " Tipo Emisi¢n:   ³";
          |PINTA #nomyrenm#32;
     |SINO;
          |CAMPO_MODIFICA #nomyrenm#32, 1, "N";
          |CAMPO_VISUAL #nomyrenm#32, 1, "N";
          |PINTA 1847, "                 ³";
     |FINSI;
|FPRC;

|PROCESO ConsultaGrupos; |TIPO 66;
     |ABRE #nomgruec;
     |CONSULTA_CLAVE #1#nomgruec;
     |SI FSalida = 0;
          #nomyrenm#Campo# = #nomgruec#0;
          |PINTA #nomyrenm#Campo#;
     |FINSI;
     |CIERRA #nomgruec;
|FPRC;

|PROCESO Ayuda; |TIPO 7;
     |SI swDesglose = 0; |Y #nomyrenm#8 ! 3;
          |PUSHV 09422380;
          |ATRI R;
          ||            4      5         6         7
          ||            3456789012345678901234567890123456789
          |PINTA 0943, "         - Crystal Reports -          ";
          |PINTA 1043, " 00. Normal                           ";
          |PINTA 1143, " 03. Descuento Desglosado (3 col.)    ";
          |PINTA 1243, "               - EXCEL -              ";
          |PINTA 1343, " 02. Excel                            ";
          |PINTA 1443, " 50. Conceptos de n¢mina y pagas inc. ";
          |PINTA 1543, " 51. Con conceptos, sin pagas         ";
          |PINTA 1643, " 52. Resumen de Pagas                 ";
          |PINTA 1743, " 55. Cuotas solicitud aplazamientos   ";
          |PINTA 1843, "          - Otras emisiones -         ";
          |PINTA 1943, " 10. Fichero XML                      ";
     |SINO;
          |SI swDesglose ! 0;
               |PUSHV 10421380;
               |ATRI R;
               ||            4      5         6         7
               ||            3456789012345678901234567890123456789
               |PINTA 1043, "       - Opciones de emisi¢n -        ";
               |PINTA 1143, " 00. Normal (Crystal Reports)         ";
               |PINTA 1243, " 11. Excel                            ";
               |PINTA 1343, "                                      ";
          |FINSI;
          |SI #nomyrenm#8 = 3;
               |PUSHV 10422080;
               |ATRI R;
               ||            4      5         6         7
               ||            3456789012345678901234567890123456789
               |PINTA 1043, "         - Crystal Reports -          ";
               |PINTA 1143, " 00. Normal                           ";
               |PINTA 1243, " 03. Descuento Desglosado (3 col.)    ";
               |PINTA 1343, "               - EXCEL -              ";
               |PINTA 1443, " 02. Excel                            ";
               |PINTA 1543, "          - Otras emisiones -         ";
               |PINTA 1643, " 10. Fichero XML                      ";
               |PINTA 1743, "                                      ";
          |FINSI;
     |FINSI;
     |ATRI 0;
|FPRC;

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO PorGrupos;
     nCampoG = Campo;
     |SI #nomyrenm#nCampoG# = 00000;
          aAlfa = "N";
     |SINO;
          aAlfa = "S";
     |FINSI;
     |PARA nCampoG = nCampoG + 1; |SI nCampoG [ 28; |HACIENDO nCampoG = nCampoG + 1;
          |CAMPO_MODIFICA #nomyrenm#nCampoG#, 1, aAlfa;
          |SI aAlfa = "N";
               #nomyrenm#nCampoG# = 0;
               |PINTA #nomyrenm#nCampoG#;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Cuadre; |TIPO 0;
     |SI #nomyrenm#30 = 11;
          |SI #nomyrenm#0 ! #nomyrenm#1; |Y FSalida ! 2;
               aAlfa = "    ATENCION: en la emisión en EXCEL por trab. sólo se puede seleccionar ";
               aAlfa = aAlfa + " una empresa";
               |MENAV aAlfa;
               |ERROR;
          |FINSI;
     |FINSI;
     |SI #nomyrenm#30 = 4;
     |Y swModulo ! 2647; |Y swModulo ! 1;
          |ERROR;
     |FINSI;
     |SI #nomyrenm#8 = 3;
          |SI #nomyrenm#30 = 50; |O #nomyrenm#30 = 51; |O #nomyrenm#30 = 52;
               aAlfa = "    ATENCION: la ordenación por nro. de referencia no permite la emisión en ";
               aAlfa = aAlfa + "Excel con conceptos.";
               |MENAV aAlfa;
               |ERROR;
          |FINSI;
     |FINSI;
     |SI swDesglose = 1;
          |SI #nomyrenm#30 ! 00; |Y #nomyrenm#30 ! 11;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PParametro; |TIPO 7;
     |SI PARAMETRO="M"; |O PARAMETRO="H"; |O PARAMETRO="A";
          |CAMPO_MODIFICA #nomyrenm#14,1,"N";
          #nomyrenm#14=PARAMETRO;
     |FINSI;
|FPRC;

|PROCESO Baja24;
     #nomw0024#0 = #nomyrenm#0;
     #nomw0024#1 = 1;
|FPRC;

|PROCESO Alta24;
     #nomw0024#0 = #nomyrenm#0;
     #nomw0024#1 = 999;
|FPRC;

|PROCESO T0C12;  |TIPO 0;
     |SI FSalida ! 10;
         |ACABA;
     |FINSI;

     |SI #nomyrenm#0 ! #nomyrenm#1;
         |ACABA;
     |FINSI;

     |PUSHV 0829 2380;
     |BLANCO 0829 2380

     |ENTLINEAL #1#nomw0024, 1, 2, 21, 1, Baja24, Alta24;

     |POPV;
|FPRC;

____________________________________/ CALCULOS PANTALLA

|PROCESO FuenteDatos; |TIPO 0;
     |SI #nomyrenm#14="M";
          alfa1="MENSUAL  ";
          |CAMPO_VISUAL #nomyrenm#2,1,"N";
          |CAMPO_VISUAL #nomyrenm#9,1,"N";
          |CAMPO_VISUAL #nomyrenm#5,1,"N";
          |CAMPO_VISUAL #nomyrenm#10,1,"N";
          |CAMPO_MODIFICA #nomyrenm#17,1,"N";
          |CAMPO_VISUAL #nomyrenm#17,1,"N";

          |CAMPO_VISUAL #nomyrenm#15,1,"S";
          |CAMPO_VISUAL #nomyrenm#16,1,"S";

          |CAMPO_POSICION #nomyrenm#2,1,1349;
          |CAMPO_POSICION #nomyrenm#9,1,1357;
          |CAMPO_POSICION #nomyrenm#16,1,1229;
          |CAMPO_POSICION #nomyrenm#15,1,1242;

          |PINTA 1217,"A¤o ......:       Mes .:     ";
          |PINTA 1317,"                             ";
          |PINTA 1717,"                                     ";
          |PINTA #nomyrenm#15;
          |PINTA #nomyrenm#16;

          #nomyrenm#2 = 0;
          #nomyrenm#9 = 0;
     |FINSI;

     |SI #nomyrenm#14="H";
          alfa1="HISTORICO";
          |CAMPO_VISUAL #nomyrenm#2,1,"S";
          |CAMPO_VISUAL #nomyrenm#9,1,"S";
          |CAMPO_VISUAL #nomyrenm#5,1,"S";
          |CAMPO_VISUAL #nomyrenm#10,1,"S";

          |CAMPO_VISUAL #nomyrenm#15,1,"N";
          |CAMPO_VISUAL #nomyrenm#16,1,"N";
          |CAMPO_MODIFICA #nomyrenm#17,1,"N";
          |CAMPO_VISUAL #nomyrenm#17,1,"N";
          ||CAMPO_MODIFICA #nomyrenm#33,1,"S";
          ||CAMPO_VISUAL #nomyrenm#33,1,"S";
          ||CAMPO_POSICION #nomyrenm#33, 1, 1740;

          |CAMPO_POSICION #nomyrenm#16,1,1243;
          |CAMPO_POSICION #nomyrenm#15,1,1260;

          |PINTA 1447,"ÄÄÄ";
          ||PINTA 1717,"Incluir Pagas (1/2)..:               ";
          |PINTA 1717,"                                     ";
          |PINTA #nomyrenm#2;
          |PINTA #nomyrenm#9;
          |PINTA #nomyrenm#5;
          |PINTA #nomyrenm#10;
     |FINSI;

     |SI #nomyrenm#14="A";
          alfa1="ATRASOS  ";
          |CAMPO_VISUAL #nomyrenm#2,1,"S";
          |CAMPO_VISUAL #nomyrenm#9,1,"S";
          |CAMPO_VISUAL #nomyrenm#5,1,"N";
          |CAMPO_VISUAL #nomyrenm#10,1,"N";
          ||CAMPO_VISUAL #nomyrenm#33,1,"N";
          ||CAMPO_MODIFICA #nomyrenm#33,1,"N";

          |CAMPO_VISUAL #nomyrenm#15,1,"N";
          |CAMPO_VISUAL #nomyrenm#16,1,"S";

          |CAMPO_POSICION #nomyrenm#2,1,1235;
          |CAMPO_POSICION #nomyrenm#9,1,1242;
          |CAMPO_POSICION #nomyrenm#16,1,1335;
          |CAMPO_POSICION #nomyrenm#15,1,1260;
          |CAMPO_POSICION #nomyrenm#17,1,1740;

          ||CAMPO_MODIFICA #nomyrenm#4,1,"N";

          |PINTA 1217,"Meses ........:";
          |PINTA 1317,"A¤o ..........:";
          |PINTA 1338,"       ";
          |PINTA 1717,"Tipo de resumen .....:       ";
          |PINTA #nomyrenm#2;
          |PINTA #nomyrenm#9;
          |PINTA #nomyrenm#16;
          #nomyrenm#4 = 5;
          #nomyrenm#19 = 5;
          |PINTA #nomyrenm#4;
          |PINTA #nomyrenm#19;
          |PINTA #nomyrenm#17;
     |FINSI;

     |PINTA 0753,alfa1;
     |PINTA #nomyrenm#14;

     |SI swDesglose = 1; |O #nomcontr#78 = "S";
          |PINTA 1415, "³ Trabajadores ..:               ³               ³";
          |PINTA 1515, "ÃÄRuptura por  reas ...:   ÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
          |CAMPO_MODIFICA #nomyrenm#34, 1, "S";
          |CAMPO_VISUAL #nomyrenm#34, 1, "S";
          |PINTA #nomyrenm#34;
          |CAMPO_MODIFICA #nomyrenm#35, 1, "S";
          |CAMPO_POSICION #nomyrenm#35, 1, 1442;
          |CAMPO_VISUAL #nomyrenm#35, 1, "S";
          |PINTA #nomyrenm#35;
          |PINTA #nomyrenm#6;
     |SINO;
          || migue: descomentar o comentar

          |CAMPO_MODIFICA #nomyrenm#34, 1, "N";
          |CAMPO_VISUAL #nomyrenm#34, 1, "N";
          |CAMPO_MODIFICA #nomyrenm#35, 1, "N";
          |CAMPO_POSICION #nomyrenm#35, 1, 1442;
          |CAMPO_VISUAL #nomyrenm#35, 1, "N";
          |PINTA 1415, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
     |FINSI;

|FPRC;

|PROCESO defectos; |TIPO 7;
     |SI swDesglose = 1;
          |HAZ Activa32;
     |FINSI;
     |SI #nomyrenm#4 = 0; |Y #nomyrenm#19 = 1;
          #nomyrenm#4 = 0;
          #nomyrenm#19 = 0;
          |PINTA #nomyrenm#4;
          |PINTA #nomyrenm#19;
     |FINSI;
|FPRC;

|PROCESO Borrador;
     |_PDIR aAlfa;
     |SI FSalida = 0;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aAlfa1 = aAlfa;
               |FBORRA aAlfa1;
               |_SDIR aAlfa;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO BorraTemporales;
     || esto es para evitar el error ese de la estructura del temporal
     || que no es valida que pasa en algunos clientes algunas veces y que
     || no sabemos de donde sale, no me complico la vida y borro los
     || temporales que intervienen a mano y ya esta

     |DBASS aAlfa;
     |QBF aAlfa;

     |DFICE aFich;

     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
     aAlfa = aFich + alfa1 + "*"; |HAZ Borrador;
     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
     aAlfa = aFich + alfa1 + "*"; |HAZ Borrador;
     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Z" + alfa1;
     aAlfa = aFich + alfa1 + "*"; |HAZ Borrador;
|FPRC;

|PROGRAMA;
     aAlfa = PARAMETRO;
     |QBF aAlfa;
     aAlfa = aAlfa % -103;

     |SI aAlfa = "N+P";
          swPagasSN = 2;      || nomina y paga todo junto
          PARAMETRO = PARAMETRO - "N+P";
     |SINO;
          swPagasSN = 1;      || lo de siempre, solo nomina
     |FINSI;

     |SI aAlfa = "DES";
          swDesglose = 1;     || con importes desglosados por trabajador
          PARAMETRO = PARAMETRO - "DES";
     |SINO;
          swDesglose = 0;
     |FINSI;

     aParam = PARAMETRO;
     |QBF aParam;
     |CLS;
     |CABEZA "INFORME RESUMEN DE NOMINAS POR CENTROS";
     |PINPA #0#nomyrenm;

     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;

     |SI swPagasSN = 2;
          |ATRI R;
          |PINTA 0514, " INFORME RESUMEN DE NOMINAS POR CENTROS (PAGAS INC.)"
          |ATRI 0;
     |FINSI;

     |SI swDesglose = 1;
          |ATRI R;
          |PINTA 0514, " INFORME DE COSTES HISTORICO POR TRABAJADOR/PERIODO"
          |ATRI 0;
     |FINSI;

     |ABRE #cretam00; |DDEFECTO #cretam00; |LEE 000#cretam00.p; |CIERRA #cretam00;
     |ABRE #nomcont3; |DDEFECTO #nomcont3; |LEE 000#nomcont3.p; |CIERRA #nomcont3;

     |ABRE #nomyrenm;
     |DDEFECTO #nomyrenm;
     |LEE 000#nomyrenm.p;
     FEstado = FSalida;

     |PINDA #0#nomyrenm;

     enWeb = 0;
     |SI PARAMETRO ! "M"; |Y PARAMETRO ! "H"; |Y PARAMETRO ! "A"; |Y PARAMETRO ! ""; |Y aParam ! "AUTO";
          enWeb = 1;
     |FINSI;
     |SI enWeb = 1;
          |HAZ LeeParam;
          |HAZ LeeOrigen;
          |HAZ PasaParametros;
          |ABRE #nomtmpre;
          |SI aTipoResumen = "P";             || para resumen de pagas
               aParametro = PARAMETRO;
               |SUB_EJECUTA "nomyrpac";
               |ACABA;
          |FINSI;

          |HAZ Historico;
          |HAZ traete_fichero;
          |HAZ ConviertePdf;
          |CIERRA #nomtmpre;
     |SINO;
          |SI aParam = "AUTO";
               alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
               |NOME_DAT #nomtmpre#alfa1#;
               |DELINDEX #nomtmpre;
               |ABRE #nomtmpre;
               |ABRE #labcentr;
               |ABRE #nomauxi1;

               #nomyrenm#0 = nEmpAUTO;
               #nomyrenm#1 = nEmpAUTO;
               #nomyrenm#2 = nMesAUTO;
               #nomyrenm#3 = ~;
               #nomyrenm#4 = 0;
               fech1 = ~;
               alfa1 = fech1;
               alfa1 = alfa1 % -104;
               #nomyrenm#5 = alfa1;
               #nomyrenm#6 = "N";
               #nomyrenm#7 = "N";
               #nomyrenm#8 = 1;
               #nomyrenm#9 = nMesAUTO;
               #nomyrenm#10 = nAnyoHasta - 2000;
               #nomyrenm#11 = 01;
               #nomyrenm#12 = 99;
               #nomyrenm#13 = "T";
               #nomyrenm#14 = "M";
               #nomyrenm#15 = nMesAUTO;
               #nomyrenm#18 = "EUROS  ";
               #nomyrenm#30 = 00;

               enAny = #nomyrenm#5;
               eaFuente = #nomyrenm#14;
               enCuadre = 0;            || solo en crystal
               informe = "nomyren2";

               Impresora = "CrystalReport";
               |IMPRE -1;
               |INFOR informe;

               nEmpresa = nEmpAUTO;

               |HAZ Mensual;

               |SI swHayAlgo = 1;
                    |HAZ ElInforme;
               |SINO;
                    aAlfa = "    No se han encontrado datos para la generación de ";
                    aAlfa = aAlfa + "resúmenes de nóminas";
                    |MENAV aAlfa;
               |FINSI;

               |PIEINF;
               |FININF;
               |FINIMP;

               |CIERRA #nomauxi1;
               |CIERRA #labcentr;
               |CIERRA #nomtmpre;
               |DELINDEX #nomtmpre;
          |SINO;
               #nomyrenm#3 = ~;
               |HAZ BuscaModulo;
               |PINTA #nomyrenm#3;
               |SI aParam = "A";
                    |HAZ Activa32;
               |FINSI;
               |ENDATOS #1#nomyrenm;
               #nomyrenm#4 = nTipoOriD;
               #nomyrenm#19 = nTipoOriH;
               |SI FEstado = 0;
                    |GRABA 020#nomyrenm.a;
               |SINO;
                    |GRABA 020#nomyrenm.n;
               |FINSI;
               |CIERRA #nomyrenm;
          |FINSI;
     |FINSI;
|FPRO;

|PROCESO T80yrenm;  |TIPO 80;
     |HAZ BorraTemporales;

     enSwDesde9 = 1;
     enCen      = 0;
     aFic       = "nomw0024" + Usuario;
     |NOME_DAT #nomw0024#aFic#;

     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
     |NOME_DAT #nomtmpre#alfa1#;
     |ABRE #nomtmpre;  |CIERRA #nomtmpre;  |DELINDEX #nomtmpre;

     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
     |NOME_DAT #nomtmprf#alfa1#;
     |ABRE #nomtmprf;  |CIERRA #nomtmprf;  |DELINDEX #nomtmprf;

     aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmprg_" + aAlfa;
     |NOME_DAT #nomtmprg#aAlfa#;
     |ABRE #nomtmprg;  |CIERRA #nomtmprg;  |DELINDEX #nomtmprg;
     |DELINDEX #nomtmprg;

     |ABRE #nomw0024;  |CIERRA #nomw0024;  |DELINDEX #nomw0024;

     |ABRET #nomw0024;
|FPRC;

|PROCESO T90yrenm;  |TIPO 90;
     |CIERRAT #nomw0024;  |DELINDEX #nomw0024;

     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "X" + alfa1;
     |NOME_DAT #nomtmpre#alfa1#;  |DELINDEX #nomtmpre;

     alfa1 = Usuario;  |QBF alfa1;  alfa1 = "Y" + alfa1;
     |NOME_DAT #nomtmprf#alfa1#;  |DELINDEX #nomtmprf;

     aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmprg_" + aAlfa;
     |NOME_DAT #nomtmprg#aAlfa#;  |DELINDEX #nomtmprg;
|FPRC;
