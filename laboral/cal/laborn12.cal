|FICHEROS;
     laborn12;
     laborn02;
     labort05;
     labempre;

     nomvarca;
     nomvarli;
     labtraba;
     labtrtra;
     motibaja;

     laborn90;
     labcontr;
     nompmail;

     mod00262;
     nomcont1;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aParam = "";
     &eaUsuario = "";
     &eaFecha = "";
     &eaHora = "";
     nCampo = 0;
     aHora = "";
     nEmp = 0;
     nTra = 0;

     &eaDirDest  = "";
     &eaAsunto   = "";
     &eaTexto    = "";
     &eaFichero  = "";
     &eaEmpresa = "";
     &eaTrabajador = "";
     &eaAccion = "";

     nEmpresas = 0;
     nCodEmp = 0;
     aNomEmp = "";
     nNume = 0;

     FEstado = 0;
     enBoton1 = 0;
     aTipo = "";
     aFecha = "";

     nMes = 0;
     nAny = 0;
     nTopeMes = 0;
     nDia = 0;
     aMes = "";
     nCampoD = 0;
     nCampoH = 0;
     nDesde = 0;
     nHasta = 0;
     swError1 = 0;
     nJornadas = 0;
     fFecha = @;

     &eaQueEs            = "";
|FIN;

|PROCESO TopeMes;
     nTopeMes = 31;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          nTopeMes = 30;
     |FINSI;
     |SI nMes = 2;
          nNume = nAny $ 4;
          |SI nNume = 0;
               nTopeMes = 29;
          |SINO;
               nTopeMes = 28;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TipoIT;
     |SI aTipo = "E"; aTipo = "Enfermedad"; |FINSI;
     |SI aTipo = "A"; aTipo = "Accidente "; |FINSI;
     |SI aTipo = "C"; aTipo = "Control IT"; |FINSI;
     |SI aTipo = "M"; aTipo = "Maternidad"; |FINSI;
     |SI aTipo = "P"; aTipo = "Paternidad"; |FINSI;
     |SI aTipo = "R"; aTipo = "Riesgo Emb"; |FINSI;
|FPRC;

|PROCESO Estado_1; |TIPO 14;
     aTipo = "";
     aFecha = "";
     swError1 = 0;

     |ABRE #labtraba;

     #labtraba#0 = #laborn12#5;
     #labtraba#1 = #laborn12#6;
     |LEE 000#labtraba.=;

     |SI #labtraba#89 ! 0;
          aTipo = #labtraba#60;
          |HAZ TipoIT;
          aFecha = #labtraba#125;
     |FINSI;
     |SI #labtraba#92 ! 0;
          aTipo = "Accidente";
          aFecha = #labtraba#125;
     |FINSI;
     |SI aTipo ! "";
          |ATRI R;
          aAlfa = " ATENCION. Trabajador en IT ";
          |PINTA 1450, aAlfa;
          aAlfa = " " + aTipo + " desde " + aFecha + " ";
          |PINTA 1550, aAlfa;
          |ATRI I;
     |SINO;
          aAlfa = "                            ";
          |ATRI 0;
          |PINTA 1450, aAlfa;
          |PINTA 1550, aAlfa;
          |ATRI I;
     |FINSI;

     |CIERRA #labtraba;
|FPRC;

|PROCESO Estado_2; |TIPO 14;
     |SI swError1 = 0;
          aAlfa = "                             ";
          |ATRI 0;
          |PINTA 1450, aAlfa;
          |PINTA 1550, aAlfa;
          |ATRI I;
     |FINSI;

     |ABRE #nomvarca;
     #nomvarca#0 = #laborn12#5;
     #nomvarca#1 = #laborn12#6;
     aAlfa = #laborn12#8; aAlfa = aAlfa % 102; nDia = aAlfa;
     aAlfa = #laborn12#8; aAlfa = aAlfa % 402; nMes = aAlfa;
     aMes = aAlfa;
     aAlfa = #laborn12#8; aAlfa = aAlfa % -104; nAny = aAlfa;
     #nomvarca#2 = nMes;
     #nomvarca#3 = 0;
     |LEE 000#nomvarca.=;
     |SI FSalida = 0;
          |PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
               |SI #nomvarca#nCampo# ! " ";
                    nCampoD = nCampo - 8;
                    nCampoH = nCampo - 4;
                    nDesde = #nomvarca#nCampoD#;
                    |SI nDesde = 0;
                         nDesde = 1;
                    |FINSI;
                    nHasta = #nomvarca#nCampoH#;
                    |SI nHasta = 0;
                         |HAZ TopeMes;
                         nHasta = nTopeMes;
                    |FINSI;
                    |SI nDesde [ nDia; |Y nDia [ nHasta;
                         aTipo = #nomvarca#nCampo#;
                         |HAZ TipoIT;
                         aAlfa = "                             ";
                         |ATRI 0;
                         |PINTA 1450, aAlfa;
                         |PINTA 1550, aAlfa;
                         |ATRI I;

                         |ATRI R;
                         aAlfa = " ATENCION. Trabajador en IT ";
                         |PINTA 1450, aAlfa;
                         aAlfa = " " + aTipo + ". Variac. mes " + aMes + " ";
                         |PINTA 1550, aAlfa;
                         |ATRI I;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #nomvarca;
|FPRC;

|PROCESO DatosAdicionales;
     |PARA nCampo = 0; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
          #labort05#nCampo# = #laborn12#nCampo#;
     |SIGUE;

     |PUSHV 05012380;
     |PINPA #0#labort05;
     |PINDA #0#labort05

     |SI aParam = "MODIF"; |O aParam = "";
          |ENDATOS #1#labort05;
          |SI FEstado = 0;
               |PARA nCampo = 0; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
                    #laborn12#nCampo# = #labort05#nCampo#;
               |SIGUE;
          |FINSI;
     |SINO;
          |PAUSA;
     |FINSI;

     |POPV;
|FPRC;

|PROCESO Boton1_Fin;
     aAlfa = eaUsuario; |QBF aAlfa;
     aAlfa1 = eaUsuario % 105;
     |SI aAlfa ! "WEB"; |Y aAlfa1 ! "NUBEA";
          |ACABA;
     |FINSI;

     |FIN_CONTROL_WINDOWS enBoton1;
|FPRC;

|PROCESO Boton1;
     aAlfa = eaUsuario; |QBF aAlfa;
     aAlfa1 = eaUsuario % 105;
     |SI aAlfa ! "WEB"; |Y aAlfa1 ! "NUBEA";
          |ACABA;
     |FINSI;

     |CONTROL_SIMPLE 0, "BOTON,F5 - Datos Adicionales", 0965, 0979, DatosAdicionales;
     enBoton1 = FSalida;
     |ESTADO_CONTROL enBoton1, "ENABLE";
|FPRC;

|PROCESO labtraba;
     |PARA nCampo = 0; |SI nCampo [ 253; |HACIENDO nCampo = nCampo + 1;
          #labtrtra#nCampo# = #labtraba#nCampo#;
     |SIGUE;
     |GRABA 020#labtrtra.n;
     |LIBERA #labtrtra;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44;
     #laborn12#5, 00001, "A";
     #laborn12#5, 99999, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO Defectos;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ACABA;
     |FINSI;

     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |DELINDEX #labtrtra;
     |ABRE #labtrtra;
     |BUCLE labtraba;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO Refresca; |TIPO 7;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          #laborn12#7 = #laborn02#7;
          #laborn12#16 = #laborn02#16;
          |PINTA #laborn12#7;
          |PINTA #laborn12#16;
     |FINSI;
|FPRC;

|PROCESO mod00262;
     nJornadas = nJornadas + 1;
|FPRC;

|DEFBUCLE mod00262;
     #mod00262#1;
     ;
     #laborn12#5, #laborn12#6, nAny, nMes, 01;
     #laborn12#5, #laborn12#6, nAny, nMes, 31;
     ;
     NULL, mod00262;
|FIN;

|PROCESO Agrario;
     |ABRE #nomcont1; |LEE 000#nomcont1.p; |CIERRA #nomcont1;
     |SI #nomcont1#9 ! 006554;
          |ACABA;
     |FINSI;
     fFecha = #laborn12#8;
     aFecha = fFecha;
     aAlfa = aFecha % 402;
     nMes = aAlfa;
     aAlfa = aFecha % -104;
     nAny = aAlfa;
     nJornadas = 0;
     |BUCLE mod00262;

     #laborn12#17 = nJornadas;
     |PINTA #laborn12#17;

     |ABRE #nomvarli;
     #nomvarli#0 = #laborn12#5;
     #nomvarli#1 = #laborn12#6;
     #nomvarli#2 = nMes;
     #nomvarli#3 = 0;
     #nomvarli#4 = 922;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0;
          #laborn12#18 = #nomvarli#5;
          |PINTA #laborn12#18;
     |FINSI;
     |CIERRA #nomvarli;
|FPRC;

|PROCESO Pantalla;
     |ABRE #labtraba;
     #labtraba#0 = #laborn12#5;
     #labtraba#1 = #laborn12#6;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          |SI #labtraba#42 = "A"; |O #labtraba#42 = "E"; |O #labtraba#42 = "e";
               |CAMPO_MODIFICA #laborn12#17, 1, "S";
               |CAMPO_VISUAL #laborn12#17, 1, "S";
               |PINTA 1601, "³Jornadas en alta ....:                               ";
               |PINTA #laborn12#17;
               |CAMPO_MODIFICA #laborn12#18, 1, "S";
               |CAMPO_VISUAL #laborn12#18, 1, "S";
               |PINTA 1701, "³Jornadas en IT ......:                               ";
               |PINTA #laborn12#18;
          |SINO;
               |CAMPO_MODIFICA #laborn12#17, 1, "N";
               |CAMPO_VISUAL #laborn12#17, 1, "N";
               |PINTA 1601, "³                                                     ";
               |PINTA #laborn12#17;
               |CAMPO_MODIFICA #laborn12#18, 1, "N";
               |CAMPO_VISUAL #laborn12#18, 1, "N";
               |PINTA 1701, "³                                                     ";
               |PINTA #laborn12#18;
          |FINSI;
     |FINSI;
     |CIERRA #labtraba;
|FPRC;

|PROCESO Chequea08; |TIPO 0;
     aAlfa = #laborn12#Campo#;
     aAlfa = aAlfa % 102;
     |SI aAlfa = "08"; |O aAlfa = "09"; |O aAlfa = "10";
     |O aAlfa = "11"; |O aAlfa = "12";
          aAlfa = "    Los códigos 08, 09, 10, 11 y 12 son internos para variaciones. ";
          aAlfa = aAlfa + "No son válidos para bajas de trabajadores";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO MotivoBaja; |TIPO 66;
     |ABRE #motibaja;
     |CONSULTA_CLAVE #1#motibaja;
     |SI FSalida = 0;
          aAlfa1 = #motibaja#0; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
          aAlfa2 = #motibaja#1;
          aAlfa = aAlfa1 + " - " + aAlfa2;
          #laborn12#Campo# = aAlfa;
          |PINTA #laborn12#Campo#;
     |FINSI;
     |CIERRA #motibaja;
|FPRC;

|PROCESO ConsultaTra; |TIPO 66;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ACABA;
     |FINSI;

     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "T" + aAlfa;
     |NOME_DAT #labtrtra#aAlfa#;
     |ABRE #labtrtra;
     |LEE 000#labtrtra.p;
     |CONSULTA_CLAVE #1#labtrtra;
     |SI FSalida = 0;
          #laborn12#Campo# = #labtrtra#1;
     |FINSI;
     |PINTA #laborn12#Campo#;
     #laborn12#16 = #labtrtra#2;
     |PINTA #laborn12#16;
     #laborn12#7 = #labtrtra#7;
     |PINTA #laborn12#7;
     |CIERRA #labtrtra;
|FPRC;

|PROCESO Proceso;
     |CLS;
     |PINPA #0#laborn12;
     |PINDA #0#laborn12;
     |HAZ Boton1;

     |ENDATOS #1#laborn12;

     |HAZ Boton1_Fin;
|FPRC;

|PROCESO Email;
     aAlfa = #laborn12#5; |QBF aAlfa;
     eaEmpresa = ("00000" + aAlfa) % -105;
     eaEmpresa = eaEmpresa + " - " + #laborn12#15;

     aAlfa = #laborn12#6; |QBF aAlfa;
     eaTrabajador = ("00000" + aAlfa) % -105;
     eaTrabajador = eaTrabajador + " - " + #laborn12#16;

     eaAccion = "baja";

     |HAZ ConsEmail;
|FPRC;

|PROCESO labempre;
     nEmpresas = nEmpresas + 1;
     nCodEmp = #labempre#0;
     aNomEmp = #labempre#2;
|FPRC;

|DEFBUCLE labempre;
     #labempre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, labempre;
|FIN;

|PROCESO Empresas; |TIPO 7;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ACABA;
     |FINSI;

     |ABRE #labempre;
     |BUCLE labempre;
     |CIERRA #labempre;

     |SI nEmpresas = 1;
          || tengo una unica empresa que elegir

          #laborn12#5 = nCodEmp;
          #laborn12#15 = aNomEmp;
          |CAMPO_MODIFICA #laborn12#5, 1, "N";
          |CAMPO_MODIFICA #laborn12#15, 1, "N";
          |PINTA #laborn12#5;
          |PINTA #laborn12#15;
     |FINSI;
|FPRC;

|PROCESO Impresion;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |SI #labcontr#84 ! "S";
          |ACABA;
     |FINSI;

     eaQueEs = "C";

     aAlfa = "*laborn10;X";
     aAlfa = aAlfa + "12";
     aAlfa = aAlfa + #laborn02#0;
     aAlfa = aAlfa + #laborn02#1;
     aAlfa1 = #laborn02#3;
     aAlfa = aAlfa + aAlfa1;
     aAlfa = aAlfa + #laborn02#4;
     aAlfa = aAlfa + "IMPRE";

     |MENSA "    Imprimiendo solicitud de baja";
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO Contador;
     |ABRE #laborn90;

     #laborn90#0 = #laborn02#5;
     #laborn90#1 = 99999;

     |LEE 000#laborn90.];
     |SI FSalida = 0;
          |SI #laborn90#0 ! #laborn02#5;
               |LEE 000#laborn90.a;
          |FINSI;
     |SINO;
          |LEE 000#laborn90.u;
     |FINSI;

     |SI FSalida = 0;
     |Y #laborn90#0 = #laborn02#5;
          nNume = #laborn90#1;

          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn02#5;
          #laborn90#1 = nNume + 1;

     |SINO;
          || es el primero de esta empresa !!!
          |DDEFECTO #laborn90;
          #laborn90#0 = #laborn02#5;
          #laborn90#1 = 1;
     |FINSI;

     #laborn90#2 = "B";
     #laborn90#3 = "Baja";
     #laborn90#4 = #laborn02#1;
     #laborn90#5 = #laborn02#2;
     #laborn90#6 = #laborn02#3;
     #laborn90#7 = #laborn02#4;

     |GRABA 020#laborn90.n;

     #laborn02#23 = #laborn90#1;

     |LIBERA #laborn90;
     |CIERRA #laborn90;
|FPRC;

|PROGRAMA;
     |CLS;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa1#;
     |FINSI;

     aParam = PARAMETRO;
     |SI aParam = "MODIF"; |O aParam = "CONSUL";
          |ABRE #laborn02;
          |SI aParam = "MODIF";
               #laborn02#0 = "P";         || estado: pendiente, consulta/modificacion
          |FINSI;
          |SI aParam = "CONSUL";
               #laborn02#0 = "A";         || estado: actualizado, solo consulta
          |FINSI;
          #laborn02#1 = eaUsuario;
          #laborn02#2 = "";
          #laborn02#3 = eaFecha;
          #laborn02#4 = eaHora;
          |LEE 101#laborn02.=;

          |PARA nCampo = 0; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
               #laborn12#nCampo# = #laborn02#nCampo#;
          |SIGUE;
          #laborn12#19 = #laborn02#23;
          #laborn12#20 = #laborn02#19;
          #laborn12#21 = #laborn02#20;
          #laborn12#22 = #laborn02#21;
          #laborn12#23 = #laborn02#22;
          |PARA nCampo = 24; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
               #laborn12#nCampo# = #laborn02#nCampo#;
          |SIGUE;

          |PINPA #0#laborn12;
          |PINDA #0#laborn12;
          |HAZ Boton1;
          |CAMPO_MODIFICA #laborn12#5, 1, "N";
          |CAMPO_MODIFICA #laborn12#6, 1, "N";
          |CAMPO_MODIFICA #laborn12#7, 1, "N";

          |ABRE #labtraba;
          #labtraba#0 = #laborn12#5;
          #labtraba#1 = #laborn12#6;
          |LEE 000#labtraba.=;
          |CIERRA #labtraba;

          |SI aParam = "MODIF"; |Y #laborn12#6 = 00000;
               || baja automatica sin alta confirmada
               aParam = "CONSUL";
          |FINSI;
          |SI aParam = "MODIF";
               |ENDATOS #1#laborn12;
          |FINSI;
          |SI aParam = "CONSUL";
               |SI #laborn12#6 = 00000;
                    |ATRI R;
                    |PINTA 1445, "BAJA GENERADA DESDE MOVIM. ALTA";
                    |ATRI S;
                    |PINTA 1545, "DEBERA  PROCESAR  EL ALTA ANTES";
                    |PINTA 1645, "DE MODIFICAR/ACTUALIZAR LA BAJA";
                    |ATRI 0;
               |FINSI;
               |PAUSA;
          |FINSI;
          |HAZ Boton1_Fin;
     |SINO;
          |HAZ Proceso;
     |FINSI;
     |SI FSalida = 0;
          |SI aParam = "MODIF";
               |PARA nCampo = 0; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
                    #laborn02#nCampo# = #laborn12#nCampo#;
               |SIGUE;

               #laborn02#19 = #laborn12#20;
               #laborn02#20 = #laborn12#21;
               #laborn02#21 = #laborn12#22;
               #laborn02#22 = #laborn12#23;

               |PARA nCampo = 24; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
                    #laborn02#nCampo# = #laborn12#nCampo#;
               |SIGUE;
               |GRABA 020#laborn02.a;
          |SINO;
               |SI aParam = "CONSUL";
                    |ACABA;
               |FINSI;

               |ABRE #laborn02;
               #laborn02#0 = "P";    || Estado: Pendiente
               #laborn02#1 = Usuario % 0810;     || Usuario
               #laborn02#2 = "";     || Perfiles, en principio no lo uso
               #laborn02#3 = ~;      || Fecha
               |HORA aHora;
               #laborn02#4 = aHora;  || Hora
               |PARA nCampo = 5; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
                    #laborn02#nCampo# = #laborn12#nCampo#;
               |SIGUE;
               |HAZ Contador;

               #laborn02#19 = #laborn12#20;
               #laborn02#20 = #laborn12#21;
               #laborn02#21 = #laborn12#22;
               #laborn02#22 = #laborn12#23;

               |PARA nCampo = 24; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
                    #laborn02#nCampo# = #laborn12#nCampo#;
               |SIGUE;

               |GRABA 020#laborn02.n;

               |MENAV "    La solicitud de baja ha sido grabada";
               |HAZ Impresion;

               |ABRE #nompmail; |LEE 000#nompmail.p; |CIERRA #nompmail;
               |SI #nompmail#11 = "S";
                    |HAZ Email;
               |FINSI;
          |FINSI;

          |CIERRA #laborn02;
     |FINSI;

     |DFICE aAlfa1;
     |DFICB aAlfa2;

     |SI aAlfa1 ! aAlfa2;
          |PATH_DAT #labempre#aAlfa2#;
     |FINSI;
|FPRO;
