|FICHEROS;
 nomz0002 #0;
 labempre #1;
 labtraba #2;

 nomhicca #10;
 nomhicli #11;
 nomconli #12;
 nomhiatr #15;
 labbasec #20;
 labbasel #21;

 nomw0017 #917,MANTE;
 nomw017@ #117;
 nomw0019 #919;
|FIN;

|VARIABLES;
 aAlfa    = "";
 aAlfa1   = "";
 aAlfa2   = "";
 aAlfa3   = "";
 nNume1   = 0;
 nNume2   = 0;
 aFichero = "";
 fFecsys  = @;
 nSalir   = 0;
 fLaFecha = @;
 fLaFeBaj = @;
 fLaFeAlt = @;
 nTrabaja = 0;
 nSwGraba = 0;
 nInkey   = 0;
 nUltTrab = 0;
 nNoTipo1 = 0;
 nCTrab   = 0;
 nSwExis  = 0;
 aMensa   = "";
 nModo    = 0;
 aDirInicio = "";
 aMas       = "";
 nAtrasos   = 0;
 nEjercicio = 0;
 nEjerAt    = 0;
 nMes = 0;
 aNIF = "";
 aNom = "";

 nLinea     = 0;
 nAnyo      = 0;
 aDias      = "";
 aFecha     = "";
 fDFecha    = @;
 fHFecha    = @;
 fFecha     = @;
 nMensa     = 0;
|FIN;

|CALCULO Elmes; |TIPO 0;
 #0#4 = "";
 |SI #0#2 =  1; #0#4 = "ENERO     "; |FINSI;
 |SI #0#2 =  2; #0#4 = "FEBRERO   "; |FINSI;
 |SI #0#2 =  3; #0#4 = "MARZO     "; |FINSI;
 |SI #0#2 =  4; #0#4 = "ABRIL     "; |FINSI;
 |SI #0#2 =  5; #0#4 = "MAYO      "; |FINSI;
 |SI #0#2 =  6; #0#4 = "JUNIO     "; |FINSI;
 |SI #0#2 =  7; #0#4 = "JULIO     "; |FINSI;
 |SI #0#2 =  8; #0#4 = "AGOSTO    "; |FINSI;
 |SI #0#2 =  9; #0#4 = "SEPTIEMBRE"; |FINSI;
 |SI #0#2 = 10; #0#4 = "OCTUBRE   "; |FINSI;
 |SI #0#2 = 11; #0#4 = "NOVIEMBRE "; |FINSI;
 |SI #0#2 = 12; #0#4 = "DICIEMBRE "; |FINSI;
 |PINTA #0#4;
|FCAL;

|| --------------------PROCESOS DEL w0017 ------------------------
|PROCESO ElTrabaja; |TIPO 6;
 nModo = (FEntrada / 100) ! 0;
 |SI nModo ! 1;  |ACABA; |FINSI;

 nTrabaja = #917#3;
 |HAZ LeeElTrab;
 |SI nSwExis = 1;
     |MENAV aMensa;
     |ERROR;
 |SINO;
     #917#4 = #2#2;  || nombre
     #917#5 = #2#7;  || dni
     #917#6 = #2#36; || fecha alta
     #917#7 = #2#37; || fecha baja
     #917#71 = #2#87; || Convenio
     |PINTA #917#4; |PINTA #917#5;
     |PINTA #917#6; |PINTA #917#7;
     |PINTA #917#71;
 |FINSI;
|FPRC;

|RUTINA ClauB117;
 #117#0 = #0#0;
 #117#3 = 1;
 #117#4 = "";
|FRUT;

|RUTINA ClauA117;
 #117#0 = #0#0;
 #117#3 = 99999;
 #117#4 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
|FRUT;

|PROCESO Modifico; |TIPO 11;
 nInkey = FSalida;
 |SI nInkey = 10;
     |ABRE #117;
     #117#0 = #917#0;
     #117#3 = #917#3;
     #117#4 = #917#4;
     |CONSULTA_F_CLAVE #2#117, ClauB117, ClauA117;
     |CIERRA #117;
     #917#3 = #117#3;
     |PTEC 802;
     |ERROR;
 |FINSI;
|FPRC;

|PROCESO eltotnif;  |TIPO 3;
    nMes = #917#2;
    aNom = #917#4;
    aNIF = #917#5;
  |HAZ ActTotalNIF;
|FPRC;


|PROCESO laFuncion; |TIPO 0;
 nInkey = FSalida;
 aAlfa1 = "S"; aAlfa2 = "N";
 |SI FSalida = 10;
     aAlfa1 = "N"; aAlfa2 = "S";
 |FINSI;
 |PARA nNume1 = 8; |SI nNume1 [ 20; |HACIENDO nNume1 = nNume1 + 1;
       |C_M #917nNume1,1,aAlfa1;
 |SIGUE;
 |PARA nNume1 = 23; |SI nNume1 [ 31; |HACIENDO nNume1 = nNume1 + 1;
       |C_M #917nNume1,1,aAlfa2;
 |SIGUE;
 |C_M #917#9,1,"S";
 |C_M #917#47,1,aAlfa1;
 |C_M #917#48,1,aAlfa1;
 |C_M #917#49,1,aAlfa1;
 |C_M #917#50,1,aAlfa1;
 |C_M #917#60,1,aAlfa1;
 |C_M #917#63,1,aAlfa1;
 |C_M #917#64,1,aAlfa1;
 |C_M #917#70,1,aAlfa1;

 |C_M #917#51,1,aAlfa2;
 |C_M #917#52,1,aAlfa2;
 |C_M #917#53,1,aAlfa2;
 |C_M #917#54,1,aAlfa2;
 |C_M #917#61,1,aAlfa2;
 |C_M #917#65,1,aAlfa2;
 |C_M #917#66,1,aAlfa2;
|FPRC;


|PROCESO irpf; |TIPO 0;
 |C_M #917Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 nNume2 = Contenido;
 |SI nNume2 ! #917Campo;
     |SI Campo = 8;  |O Campo = 9;  #917#10 = #917#9  % #917#8;  |PINTA #917#10; |FINSI;
     |SI Campo = 11; |O Campo = 12; #917#13 = #917#12 % #917#11; |PINTA #917#13; |FINSI;
     |SI Campo = 14; |O Campo = 15; #917#16 = #917#15 % #917#14; |PINTA #917#16; |FINSI;
     |SI Campo = 17; |O Campo = 18; #917#19 = #917#18 % #917#17; |PINTA #917#19; |FINSI;
 |FINSI;
|FPRC;

|PROCESO sumoirpf; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  #917#21 = #917#9  + #917#12 + #917#15; |PINTA #917#21;
  #917#22 = #917#10 + #917#13 + #917#16; |PINTA #917#22;

  |SI aAlfa1 = "S"; |HAZ eltotal2; |FINSI;
|FPRC;

|PROCESO eltotal2;
     #917#23 = #917#34 + #917#9;  |PINTA #917#23;
     #917#24 = #917#35 + #917#10; |PINTA #917#24;
     #917#25 = #917#36 + #917#12; |PINTA #917#25;
     #917#26 = #917#37 + #917#13; |PINTA #917#26;
     #917#27 = #917#38 + #917#15; |PINTA #917#27;
     #917#28 = #917#39 + #917#16; |PINTA #917#28;
     #917#29 = #917#40 + #917#18; |PINTA #917#29;
     #917#30 = #917#41 + #917#19; |PINTA #917#30;
     #917#31 = #917#42 + #917#20; |PINTA #917#31;

     #917#32 = #917#23 + #917#25 + #917#27;  |PINTA #917#32;
     #917#33 = #917#24 + #917#26 + #917#28;  |PINTA #917#33;
|FPRC;

|PROCESO irpf2; |TIPO 0;
 |C_M #917Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 nNume2 = Contenido;
 |SI nNume2 ! #917Campo;
     |SI Campo = 23; #917#24 = #917#23 % #917#8;  |PINTA #917#24; |FINSI;
     |SI Campo = 25; #917#26 = #917#25 % #917#11; |PINTA #917#26; |FINSI;
     |SI Campo = 27; #917#28 = #917#27 % #917#14; |PINTA #917#28; |FINSI;
     |SI Campo = 29; #917#30 = #917#29 % #917#17; |PINTA #917#30; |FINSI;
 |FINSI;
|FPRC;

|PROCESO sumoirpf2; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  #917#32 = #917#23 + #917#25 + #917#27;  |PINTA #917#32;
  #917#33 = #917#24 + #917#26 + #917#28;  |PINTA #917#33;

  |SI aAlfa1 = "S"; |HAZ eltotal1; |FINSI;
|FPRC;

|PROCESO eltotal1;
     #917#9  = #917#23 - #917#34; |PINTA #917#9;
     #917#10 = #917#24 - #917#35; |PINTA #917#10;
     #917#12 = #917#25 - #917#36; |PINTA #917#12;
     #917#13 = #917#26 - #917#37; |PINTA #917#13;
     #917#15 = #917#27 - #917#38; |PINTA #917#15;
     #917#16 = #917#28 - #917#39; |PINTA #917#16;
     #917#18 = #917#29 - #917#40; |PINTA #917#18;
     #917#19 = #917#30 - #917#41; |PINTA #917#19;
     #917#20 = #917#31 - #917#42; |PINTA #917#20;

     #917#21 = #917#9  + #917#12 + #917#15; |PINTA #917#21;
     #917#22 = #917#10 + #917#13 + #917#16; |PINTA #917#22;
|FPRC;

|PROCESO sumoSS; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  |SI aAlfa1 = "S";
      #917#51 = #917#55 + #917#47; |PINTA #917#51;
      #917#52 = #917#56 + #917#48; |PINTA #917#52;
      #917#53 = #917#57 + #917#49; |PINTA #917#53;
      #917#54 = #917#58 + #917#50; |PINTA #917#54;
      #917#65 = #917#67 + #917#63; |PINTA #917#65;
      #917#66 = #917#68 + #917#64; |PINTA #917#66;
  |FINSI;
|FPRC;

|PROCESO sumoSS2; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  |SI aAlfa1 = "S";
      #917#47 = #917#51 - #917#55; |PINTA #917#47;
      #917#48 = #917#52 - #917#56; |PINTA #917#48;
      #917#49 = #917#53 - #917#57; |PINTA #917#49;
      #917#50 = #917#54 - #917#58; |PINTA #917#50;
      #917#63 = #917#65 - #917#67; |PINTA #917#63;
      #917#64 = #917#66 - #917#68; |PINTA #917#64;
  |FINSI;
|FPRC;

|PROCESO sumoPX; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  |SI aAlfa1 = "S";
      #917#61 = #917#62 + #917#60; |PINTA #917#61;
  |FINSI;
|FPRC;

|PROCESO sumoPX2; |TIPO 0;
  |C_M #917Campo,0,aAlfa1;

  |SI aAlfa1 = "S";
      #917#60 = #917#61 - #917#62; |PINTA #917#60;
  |FINSI;
|FPRC;

|PROCESO AntesCon; |TIPO 7;
  |C_M #917#70,0,aAlfa1; |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |SI #917#20 = 0;
      |C_M #917#70,1,"N"; #917#70 = 0; |PINTA #917#70;
  |SINO;
      |SI #917#70 = 0;
          #917#70 = 411;
          |ABRE #12;
          #12#0 = #917#71;
          #12#2 = 410;
          |LEE 001#12];
          |SI FSalida = 0; |Y #12#0 = #917#71; |Y #12#2 ] 400; |Y #12#2 [ 499;
              #917#70 = #12#2;
          |FINSI;
          |CIERRA #12;
          |PINTA #917#70;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO AntesCon1; |TIPO 0;
  |C_M #917#20,0,aAlfa1; |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |C_M #917#70,1,"S";
  |SI #917#20 = 0;
      |C_M #917#70,1,"N"; #917#70 = 0; |PINTA #917#70;
  |FINSI;
|FPRC;

|PROCESO AntesCon2; |TIPO 0;
  |C_M #917#31,0,aAlfa1; |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |SI #917#20 = 0;
      #917#70 = 0; |PINTA #917#70;
  |SINO;
      |SI #917#70 = 0;
          |C_M #917#70,1,"S";
          |ENCAMPO #70#917;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO inf12;
 #12#0 = #917#71;
 #12#2 = 400;
|FPRC;

|PROCESO sup12;
 #12#0 = #917#71;
 #12#2 = 499;
|FPRC;

|PROCESO DesCon; |TIPO 0;
  nInkey = FSalida;
  |C_M #917#70,0,aAlfa1;
  |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |ABRE #12;
  |SI nInkey = 10;
      #12#0 = #917#71;
      #12#2 = #917#70;
      |CONSULTA_F_CLAVE #1#12, inf12, sup12;
      #917#70 = #12#2; |PINTA #917#70;
  |FINSI;

  nMensa = 0;
  |SI #917#70 = 0;
       aMensa = "    NNo ha informado Numero de Concepto";
       nMensa = 1;
  |SINO;
      |DDEFECTO #12;
      #12#0 = #917#71;
      #12#2 = #917#70;
      |LEE 001#12=;
      |SI FSalida ! 0;
          aMensa = "    NNo existe Concepto en el Convenio. ";
          nMensa = 1;
      |SINO;
          |SI #917#70 < 400; |O #917#70 > 499;
              aMensa = "    NNo es un concepto 400. ";
              nMensa = 1;
          |FINSI;
      |FINSI;
  |FINSI;
  |CIERRA  #12;
  |SI nMensa = 1;
      aMensa = aMensa + " Continuar ";
      |CONFI aMensa;
      |SI FSalida ! 0;
          |ERROR;
      |FINSI;
  |FINSI;
|FPRC;

|| ---------------------------------------------------------------

|CALCULO elTipo12; |TIPO 12;
  nInkey = FSalida;
  |SI nInkey = 1; nSalir = 1; |FINSI;
|FCAL;

|RUTINA ClaveBaja17;
      #917#0 = #0#0;
      #917#1 = #0#1;
      #917#2 = #0#2;
      #917#3 = 1;
|FRUT;

|RUTINA ClaveAlta17;
      #917#0 = #0#0;
      #917#1 = #0#1;
      #917#2 = #0#2;
      #917#3 = 99999;
|FRUT;

|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO BuscaConcepto;
 #917#70 = #11#4;
|FPRC;

|DEFBUCLE BuscaConcepto;
 #11#1;
 ;
 #10#0, #10#1, #10#66, #10#2, #10#3, 400;
 #10#0, #10#1, #10#66, #10#2, #10#3, 499;
 ;
 NULL, BuscaConcepto;
|FIN;

|PROCESO LeeTrabaj;

 aAlfa1 = #2#37; |QBF aAlfa1;
 |SI aAlfa1 ! "";
     fLaFeBaj = #2#37;
     |SI fLaFeBaj < fLaFecha;
         |ACABA;
     |FINSI;
 |FINSI;
 aAlfa1 = #2#36; |QBF aAlfa1;
 |SI aAlfa1 ! "";
     fLaFeAlt = #2#36;
     |SI fLaFeAlt > fHFecha;
         |ACABA;
     |FINSI;
 |FINSI;

 nTrabaja = #2#1;

 |DDEFECTO #917;
 #917#0 = #0#0;
 #917#1 = #0#1;
 #917#2 = #0#2;
 #917#3 = #2#1;
 |LEE 001#917=;
 |SI FSalida ! 0;
     |HAZ AltaAux;
 |FINSI;
|FPRC;

|DEFBUCLE LeeTrabaj;
 #2#1;
 ;
 #0#0, 00001;
 #0#0, 99999;
 e;
 NULL, LeeTrabaj;
|FIN;

|PROCESO LeeElTrab;
 nSwExis = 0;

 |ABRE #2;
 |DDEFECTO #2;
 #2#0 = #0#0;
 #2#1 = nTrabaja;
 |LEE 001#2=;
 |SI FSalida ! 0;
     nSwExis = 1;
     aMensa   = "    Error. No existe trabajador ...";
 |SINO;
     fLaFeBaj = #2#37;
     aAlfa1   = #2#37; |QBF aAlfa1;
     |SI aAlfa1 ! ""; |Y fLaFeBaj < fLaFecha;
         nSwExis = 1;
         aMensa   = "    Error. Trabajador no Activo ...";
     |FINSI;
     fLaFeAlt = #2#36;
     aAlfa1 = #2#36; |QBF aAlfa1;
     |SI aAlfa1 ! ""; |Y fLaFeAlt > fHFecha;
         nSwExis = 1;
         aMensa   = "    Error. Trabajador no Activo ...";
     |FINSI;
 |FINSI;
 |CIERRA #2;
|FPRC;

|PROCESO BuscaDias;
     fFecha = #21#3;
     |SI fFecha ] fDFecha;  |Y fFecha [ fHFecha;
         #917#69 = #917#69 + #21#4;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaDias;
     #21#1;
     ;
     #0#0, #917#3, 001;
     #0#0, #917#3, 999;
     e;
     NULL, BuscaDias;
|FIN;

|PROCESO AltaAux;
   |DDEFECTO #917;
   #917#0 = #0#0;
   #917#1 = #0#1;
   #917#2 = #0#2;
   #917#3 = nTrabaja;
   #917#4 = #2#2;  || nombre
   #917#5 = #2#7;  || dni
   #917#6 = #2#36; || fecha alta
   #917#7 = #2#37; || fecha baja
   #917#71 = #2#87; || convenio
   #917#69 = 00;
   |BUCLE BuscaDias;
   |GRABA 020#917c;
   |SI nUltTrab < nTrabaja;
       nUltTrab = nTrabaja;
   |FINSI;
|FPRC;

|PROCESO LeeHistorico;
 |SI nUltTrab = 0;  nCTrab = #10#1; |FINSI;
 |SI nCTrab ! #10#1; nNoTipo1 = 0; nCTrab = #10#1; |FINSI;

 nTrabaja = #10#1;

 |DDEFECTO #917;
 #917#0 = #0#0;
 #917#1 = #0#1;
 #917#2 = #0#2;
 #917#3 = nTrabaja;
 |LEE 001#917=;
 |SI FSalida ! 0;
     |HAZ LeeElTrab;
     |HAZ AltaAux;
      #917#59 = #0#4;
 |FINSI;
 |SI #10#3 = 1;
     #917#8  = #10#13;  || % 1
     #917#9  = #10#14;  || base 1
     #917#10 = #10#15;  || cuota ret 1
     #917#11 = #10#106; || % 2
     #917#12 = #10#108; || base 2
     #917#13 = #10#110; || cuota ret 2
     #917#14 = #10#107; || % 3
     #917#15 = #10#109; || base 3
     #917#16 = #10#111; || cuota ret 3
     #917#17 = #10#129; || % paga
     #917#18 = #10#16;  || base paga
     #917#19 = #10#17;  || cuota ret paga
     #917#20 = #10#18;  || base exenta

     #917#47 = #10#48;  || S.S comunes
     #917#48 = #10#49;  || S.S profes.
     #917#49 = #10#50;  || S.S h.extra1
     #917#50 = #10#51;  || S.S h.extra2

     #917#60 = #10#38;  || Prorrata Extras
     #917#63 = #10#39;  || CC
     #917#64 = #10#40;  || CP
     nNoTipo1 = 1;
     |SI #10#18 ! 0;
         |BUCLE BuscaConcepto;
     |FINSI;
  |SINO;
     #917#34 = #917#34 + #10#14;  || base 1
     #917#35 = #917#35 + #10#15;  || cuota ret 1
     #917#36 = #917#36 + #10#108; || base 2
     #917#37 = #917#37 + #10#110; || cuota ret 2
     #917#38 = #917#38 + #10#109; || base 3
     #917#39 = #917#39 + #10#111; || cuota ret 3
     #917#40 = #917#40 + #10#16;  || base paga
     #917#41 = #917#41 + #10#17;  || cuota ret paga
     #917#42 = #917#42 + #10#18;  || base exenta

     #917#55 = #917#55 + #10#48;  || S.S comunes
     #917#56 = #917#56 + #10#49;  || S.S profes.
     #917#57 = #917#57 + #10#50;  || S.S h.extra1
     #917#58 = #917#58 + #10#51;  || S.S h.extra2

     #917#62 = #917#62 + #10#38;  || Prorrata Extras
     #917#67 = #917#67 + #10#39;  || CC
     #917#68 = #917#68 + #10#40;  || CP
  |FINSI;

  #917#23 = #917#23 + #10#14;  || base 1
  #917#24 = #917#24 + #10#15;  || cuota ret 1
  #917#25 = #917#25 + #10#108; || base 2
  #917#26 = #917#26 + #10#110; || cuota ret 2
  #917#27 = #917#27 + #10#109; || base 3
  #917#28 = #917#28 + #10#111; || cuota ret 3
  #917#29 = #917#29 + #10#16;  || base paga
  #917#30 = #917#30 + #10#17;  || cuota ret paga
  #917#31 = #917#31 + #10#18;  || base exenta
  #917#51 = #917#51 + #10#48;  || S.S comunes
  #917#52 = #917#52 + #10#49;  || S.S profes.
  #917#53 = #917#53 + #10#50;  || S.S h.extra1
  #917#54 = #917#54 + #10#51;  || S.S h.extra2
  #917#61 = #917#61 + #10#38;  || Prorrata Extras
  #917#65 = #917#65 + #10#39;  || CC
  #917#66 = #917#66 + #10#40;  || CP

  |SI #917#43 = 0; |Y #10#13 ! 0;  #917#43 = #10#13;  |FINSI;
  |SI #917#44 = 0; |Y #10#106 ! 0; #917#44 = #10#106; |FINSI;
  |SI #917#45 = 0; |Y #10#107 ! 0; #917#45 = #10#107; |FINSI;
  |SI #917#46 = 0; |Y #10#129 ! 0; #917#46 = #10#129; |FINSI;

  #917#21 = #917#9  + #917#12 + #917#15;
  #917#22 = #917#10 + #917#13 + #917#16;

  #917#32 = #917#23 + #917#25 + #917#27;
  #917#33 = #917#24 + #917#26 + #917#28;

  |SI nNoTipo1 = 0;
      |SI #917#8  = 0; #917#8  = #917#43; |FINSI;
      |SI #917#11 = 0; #917#11 = #917#44; |FINSI;
      |SI #917#14 = 0; #917#14 = #917#45; |FINSI;
      |SI #917#17 = 0; #917#17 = #917#46; |FINSI;
  |FINSI;
  |GRABA 020#917a;
  |LIBERA #917;

  nMes = #917#2;
  aNom = #917#4;
  aNIF = #917#5;
  |HAZ LosDnis;
|FPRC;

|PROCESO LosDnis;
 |DDEFECTO #919;
 #919#0 = #0#0;
 #919#1 = #0#1;
 #919#2 = #0#2;
 #919#5 = aNIF;
 |LEE 001#919=;
 |SI FSalida ! 0;
     #919#0 = #0#0;
     #919#1 = #0#1;
     #919#2 = #0#2;
     #919#4 = aNom;
     #919#5 = aNIF;
     |GRABA 020#919b;
 |FINSI;

  #919#06 = #919#06 + #10#14;  || base 1
  #919#07 = #919#07 + #10#15;  || cuota ret 1
  #919#08 = #919#08 + #10#108; || base 2
  #919#09 = #919#09 + #10#110; || cuota ret 2
  #919#10 = #919#10 + #10#109; || base 3
  #919#11 = #919#11 + #10#111; || cuota ret 3

  #919#15 = #919#6 + #919#8 + #919#10;
  #919#16 = #919#7 + #919#9 + #919#11;

  #919#12 = #919#12 + #10#16;  || base paga
  #919#13 = #919#13 + #10#17;  || cuota ret paga
  #919#14 = #919#14 + #10#18;  || base exenta

  #919#17 = #919#17 + #10#48;  || S.S comunes
  #919#18 = #919#18 + #10#49;  || S.S profes.
  #919#19 = #919#19 + #10#50;  || S.S h.extra1
  #919#20 = #919#20 + #10#51;  || S.S h.extra2
  #919#21 = #919#21 + #10#38;  || Prorrata Extras

  |GRABA 020#919a;
  |LIBERA #919;
|FPRC;

|DEFBUCLE LeeHistorico;
 #10#1;
 ;
 #0#0, 00001, #0#1, #0#2, 0;
 #0#0, 99999, #0#1, #0#2, 4;
 e;
 NULL, LeeHistorico;
|FIN;

|| ///////////////////////////////////////////////////////////////////
|DEFBUCLE LeeHistoricoA;
     #10#1;
     ;
     #15#0, 00001, nEjerAt, 01, #15#2;
     #15#0, 99999, nEjerAt, 12, #15#2;
     ;
     NULL, LeeHistorico;
|FIN;

|PROCESO LeeHisAtraso;
     |SI #15#4 = 0;  |ACABA;  |FINSI;

     |SI #15#4 ! #0#2;  |ACABA;  |FINSI;

     aAlfa   = #15#3;
     aAlfa   = aAlfa % -102;
     nEjerAt = aAlfa;
     |BUCLE LeeHistoricoA;
|FPRC;

|DEFBUCLE LeeHisAtraso;
     #15#1;
     ;
     #0#0, nEjercicio, 5, 0000;
     #0#0, nEjercicio, 20, 9999;
     ;
     NULL, LeeHisAtraso;
|FIN;

|| ................................................
|| ................................................
|| ................................................

|PROCESO ActNIFResto;
 #117#23 = #919#6;   #117#34 =  #117#23 - #117#9;
 #117#24 = #919#7;   #117#35 =  #117#24 - #117#10;
 #117#25 = #919#8;   #117#36 =  #117#25 - #117#12;
 #117#26 = #919#9;   #117#37 =  #117#26 - #117#13;
 #117#27 = #919#10;  #117#38 =  #117#27 - #117#15;
 #117#28 = #919#11;  #117#39 =  #117#28 - #117#16;
 #117#29 = #919#12;  #117#40 =  #117#29 - #117#18;
 #117#30 = #919#13;  #117#41 =  #117#30 - #117#19;
 #117#31 = #919#14;  #117#42 =  #117#31 - #117#20;
 #117#32 = #919#15;
 #117#33 = #919#16;

 #117#51 = #919#17;  #117#55 = #117#51 - #117#47;
 #117#52 = #919#18;  #117#56 = #117#52 - #117#48;
 #117#53 = #919#19;  #117#57 = #117#53 - #117#49;
 #117#54 = #919#20;  #117#58 = #117#54 - #117#50;

 #117#61 = #919#21;  #117#62 =  #117#61 - #117#60;
 |GRABA 020#117a;
 |LIBERA #117;
|FPRC;

|DEFBUCLE ActNIFResto;
 #117#1004;
 5;
 #0#0, #0#1, #919#2, 00001, #919#5;
 #0#0, #0#1, #919#2, 99999, #919#5;
 ;
 NULL, ActNIFResto;
|FIN;

|PROCESO ActTotalNIF;

 |ABRE #919;
 |DDEFECTO #919;
 #919#0 = #0#0;
 #919#1 = #0#1;
 #919#2 = nMes;
 #919#5 = aNIF;
 |LEE 001#919=;
 |SI FSalida ! 0;
     #919#0 = #0#0;
     #919#1 = #0#1;
     #919#2 = nMes;
     #919#4 = aNom;
     #919#5 = aNIF;
     |GRABA 020#919b;
 |FINSI;

 #919#6  = #917#23;
 #919#7  = #917#24;
 #919#8  = #917#25;
 #919#9  = #917#26;
 #919#10 = #917#27;
 #919#11 = #917#28;
 #919#12 = #917#29;
 #919#13 = #917#30;
 #919#14 = #917#31;
 #919#15 = #917#32;
 #919#16 = #917#33;

 #919#17 = #917#51;
 #919#18 = #917#52;
 #919#19 = #917#53;
 #919#20 = #917#54;
 #919#21 = #917#61;

 |GRABA 020#919a;
 |LIBERA #919;
 |CIERRA #919;

 |BUCLE ActNIFResto;
|FPRC;

|PROCESO ActNIF;
 |BUCLE ActNIFResto;
|FPRC;

|DEFBUCLE ActNIF;
 #919#1;
 ;
 #0#0, #0#1, "            ", #0#2;
 #0#0, #0#1, "zzzzzzzzzzzz", #0#2;
 ;
 NULL, ActNIF;
|FIN;

||****************************
|CALCULO Ajustar; |TIPO 3;

     |SI nSalir = 1; |ACABA; |FINSI;

     |ABRE #917; |CIERRA #917; |DELINDEX #917;
     |ABRE #919; |CIERRA #919; |DELINDEX #919;

     nEjercicio = 1900 + #0#1;
     |SI #0#1 < 80;
         nEjercicio = 2000 + #0#1;
     |FINSI;
     aAlfa2 = nEjercicio;
     aAlfa1 = #0#2; |QBF aAlfa1;
     aAlfa1 = ( "00" + aAlfa1) % -102;
     aAlfa3 = "01." + aAlfa1 + "." + aAlfa2;
     fLaFecha = aAlfa3;

     nAnyo = nEjercicio;
     fDFecha  = fLaFecha;
     nMes   = #0#2; |HAZ CalFecha; fHFecha  = aFecha;

     nNoTipo1 = 0;
     nUltTrab = 0;
     nCTrab   = 0;
     |ABRE #917;
     |ABRE #919;

     nAtrasos = 0; |BUCLE LeeHistorico;
     nAtrasos = 1; |BUCLE LeeHisAtraso;

     |BUCLE LeeTrabaj;
     |CIERRA #919;
     |CIERRA #917;

     |SI nUltTrab ! 0;
         |BUCLE ActNIF;

         |ENTLINEAL #1#917, -4, 2, 22, 0, ClaveBaja17, ClaveAlta17;
         |CONFI "    SIntroduccion Correcta S/N ";
         |SI FSalida = 0;
             |HAZ Actualizacion;
         |FINSI;
     |SINO;
         |MENAV "    ESTA EMPRESA NO TIENE TRABAJADORES ";
     |FINSI;
     |DELINDEX #917;
     |DELINDEX #919;
|FCAL;


|PROGRAMA;
 |CLS;
 |PINPA #0#0;
 |CABEZA "Ajustes acum. IRPF hist.nominas";

 |DBASE aDirInicio;
 aMas  = aDirInicio + "def/nomw0017";
 |CARGA_DEF aMas, nomw017@;
 |SI FSalida ! 0;
     |MENAV "    Error Cargado Fichero de Nominas. Proceso Interrumpido";
     |ACABA;
 |FINSI;

 aFichero = ("z1" + Usuario + "zzzzzzzz") % 108;
 |NOME_DAT #917 aFichero;
 |NOME_DAT #117 aFichero;

 aFichero = ("z2" + Usuario + "zzzzzzzz") % 108;
 |NOME_DAT #919 aFichero;

 |DDEFECTO #0;
 fFecsys = ~;
 aAlfa1 = fFecsys;
 aAlfa2 = aAlfa1 % -102;
 aAlfa3 = aAlfa1 % 402;
 #0#1   = aAlfa2;
 #0#2   = aAlfa3;
 |HAZ Elmes;

 nSalir = 0;
 |PARA; |SI  nSalir = 0; |HACIENDO;
        nSalir = 0;
        |PINPA #0#0;
        |PINDA #0#0;
        |ENDATOS #1#0;
        |SI FSalida ! 0; nSalir = 1; |FINSI;
 |SIGUE;

 |DESCARGA_DEF #117;
|FPRO;

|| **********************************************************************
|PROCESO GrabaNuevo;
     nSwGraba = 0;
     |PARA nNume1 = 9; |SI nNume1 [ 20; |HACIENDO nNume1 = nNume1 + 1;
           |SI #917nNume1 ! 0;
               |SI nNume1 ! 11; |Y nNume1 ! 14; |Y nNume1 ! 17;
                   nSwGraba = 1; |SAL;
               |FINSI;
           |FINSI;
     |SIGUE;
     |SI #917#47 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#48 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#49 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#50 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#60 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#63 ! 0; nSwGraba = 1; |FINSI;
     |SI #917#64 ! 0; nSwGraba = 1; |FINSI;

     |SI nSwGraba = 0; |VETE LasBases; |FINSI;

     |DDEFECTO #10;
     #10#0  = #917#0;  || empresa
     #10#1  = #917#3;  || codigo trabajador
     #10#66 = #917#1;  || A¤o
     #10#2  = #917#2;  || mes
     #10#3  = 1;       || tipo
     #10#4  = #917#6;
     #10#5  = #917#7;
     #10#6  = #917#6;

     #10#13  = #917#8;
     #10#14  = #917#9;
     #10#15  = #917#10;
     #10#106 = #917#11;
     #10#108 = #917#12;
     #10#110 = #917#13;
     #10#107 = #917#14;
     #10#109 = #917#15;
     #10#111 = #917#16;
     #10#129 = #917#17;
     #10#16  = #917#18;
     #10#17  = #917#19;
     #10#18  = #917#20;
     #10#113 = #10#14 + #10#108 + #10#109;   || total bases
     #10#114 = #10#15 + #10#110 + #10#111;   || total retenciones

     #10#48 = #917#47;
     #10#49 = #917#48;
     #10#50 = #917#49;
     #10#51 = #917#50;
     #10#38 = #917#60;
     #10#39 = #917#63;
     #10#40 = #917#64;

     |GRABA 020#10n;
     |LIBERA #10;

     |ABRE #11;
     |DDEFECTO #11;
     #11#0 = #10#0;
     #11#1 = #10#1;
     #11#2 = #10#2;
     #11#3 = #10#3;
     #11#4 = 101;
     #11#5 = "F";
     #11#6 = 1;
     #11#12 = #10#66;
     |GRABA 020#11n;
     |LIBERA #11;
     |SI #917#20 ! 0; |Y #917#70 ! 0;
         |ABRE #12;
         |DDEFECTO #12;
         #12#0 = #917#71;
         #12#2 = #917#70;
         |LEE 001#12=;
         |SI FSalida ! 0; #12#3 = "F"; |FINSI;
         |CIERRA  #12;
         #11#0 = #10#0;
         #11#1 = #10#1;
         #11#2 = #10#2;
         #11#3 = #10#3;
         #11#4 = #917#70;
         #11#5 = #12#3;
         #11#6 = #12#4;
         #11#7 = #12#5;
         #11#9 = 1;
         #11#11 = 1;
         #11#10 = #917#20;
         #11#12 = #10#66;
         |GRABA 020#11n;
         |LIBERA #11;
     |FINSI;
     |CIERRA #11;

|ET LasBases;
     #21#0 = #917#0;
     #21#1 = #917#3;
     #21#2 = 9999;
     |LEE 000#21];
     |SI FSalida ] 0; |Y FSalida ! 110;
          |LEE 000#21a;
     |SINO;
          |LEE 000#21u;       || si FSalida = 110 es el ultimo
     |FINSI;                  || migue

     nLinea = 1;
     |SI FSalida = 0;  |Y  #21#0 = #917#0;  |Y  #21#1 = #917#3;
         nLinea = #21#2 + 1;
     |FINSI;

     |SI #917#2 = 01;  aDias = "31";  |FINSI;
     |SI #917#2 = 03;  aDias = "31";  |FINSI;
     |SI #917#2 = 04;  aDias = "30";  |FINSI;
     |SI #917#2 = 05;  aDias = "31";  |FINSI;
     |SI #917#2 = 06;  aDias = "30";  |FINSI;
     |SI #917#2 = 07;  aDias = "31";  |FINSI;
     |SI #917#2 = 08;  aDias = "31";  |FINSI;
     |SI #917#2 = 09;  aDias = "30";  |FINSI;
     |SI #917#2 = 10;  aDias = "31";  |FINSI;
     |SI #917#2 = 11;  aDias = "30";  |FINSI;
     |SI #917#2 = 12;  aDias = "31";  |FINSI;
     |SI #917#2 = 02;
         aDias = "28";

         |SI nAnyo = 2000;  |O nAnyo = 2004;  |O nAnyo = 2008;
          |O nAnyo = 2012;  |O nAnyo = 2016;  |O nAnyo = 2020;
          |O nAnyo = 2024;  |O nAnyo = 2028;  |O nAnyo = 2032;
             aDias = "29";
         |FINSI;
     |FINSI;

     |ABRE #2;
     #2#0 = #917#0;
     #2#1 = #917#3;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     aFecha = aDias + "." + (("00" + #917#2) % -102) + "." + nAnyo;

     |DDEFECTO #21;
     #21#0  = #917#0;       || Empresa
     #21#1  = #917#3;       || Trabajador
     #21#2  = nLinea;      || Linea
     #21#3  = aFecha;      || Fecha
     #21#4  = #917#69;     ||  #2#46;       || Dias cotizados
     #21#5  = #2#234;
     #21#6  = #2#45;
     #21#7  = #917#65;
     #21#8  = #917#66;
     #21#9  = "TRASPASO MANUAL";
     |GRABA 020#21n;
     |LIBERA #21;

     #20#0 = #917#0;
     #20#1 = #917#3;
     |LEE 101#20=;
     |SI FSalida ! 0;
         |DDEFECTO #20;
         #20#0 = #917#0;
         #20#1 = #917#3;
         |GRABA 020#20n;
     |FINSI;
     |LIBERA #20;
|FPRC;

|DEFBUCLE LeeElAux;
 #917#1;
 ;
 #0#0, #0#1, #0#2, 00001;
 #0#0, #0#1, #0#2, 99999;
 ;
 NULL, GrabaNuevo;
|FIN;

|PROCESO LosBorro11;
  |BORRA 020#11a;
  |LIBERA #11;
|FPRC;

|DEFBUCLE LosBorro11;
 #11#1;
 ;
 #10#0, #10#1, #10#66, #10#2, #10#3, 001;
 #10#0, #10#1, #10#66, #10#2, #10#3, 999;
 be;
 NULL, LosBorro11;
|FIN;

|PROCESO LosBorro;
 |BUCLE LosBorro11;
 |BORRA 020#10a;
 |LIBERA #10;
|FPRC;

|DEFBUCLE LosBorro;
 #10#1;
 ;
 #0#0, 00001, #0#1, #0#2, 1;
 #0#0, 99999, #0#1, #0#2, 1;
 be;
 NULL, LosBorro;
|FIN;

|PROCESO labbasel;
     fFecha = #21#3;

     |SI fFecha ] fDFecha;  |Y fFecha [ fHFecha;
         |BORRA 020#21a;
     |FINSI;
     |LIBERA #21;
|FPRC;

|DEFBUCLE labbasel;
     #21#1;
     ;
     #0#0, 00001, 001;
     #0#0, 99999, 999;
     be;
     NULL, labbasel;
|FIN;

|PROCESO Actualizacion;
     |SI #0#1 [ 80;
         nAnyo = 2000 + #0#1;
     |SINO;
         nAnyo = 1900 + #0#1;
     |FINSI;

     aAlfa1 = #0#2; aAlfa1 = ("00" + aAlfa1) % -102;
     aAlfa  = "01." + aAlfa1 + "." + nAnyo;   fDFecha  = aAlfa;
     nMes   = #0#2; |HAZ CalFecha;            fHFecha  = aFecha;

     |BUCLE LosBorro;
     |BUCLE labbasel;

     |ABRE #10;
     |ABRE #20;
     |ABRE #21;
     |BUCLE LeeElAux;
     |CIERRA #10;
     |CIERRA #20;
     |CIERRA #21;
|FPRC;

|PROCESO CalFecha;
     aFecha = "";
     |SI nMes = 01;  aDias = "31";  |FINSI;
     |SI nMes = 03;  aDias = "31";  |FINSI;
     |SI nMes = 04;  aDias = "30";  |FINSI;
     |SI nMes = 05;  aDias = "31";  |FINSI;
     |SI nMes = 06;  aDias = "30";  |FINSI;
     |SI nMes = 07;  aDias = "31";  |FINSI;
     |SI nMes = 08;  aDias = "31";  |FINSI;
     |SI nMes = 09;  aDias = "30";  |FINSI;
     |SI nMes = 10;  aDias = "31";  |FINSI;
     |SI nMes = 11;  aDias = "30";  |FINSI;
     |SI nMes = 12;  aDias = "31";  |FINSI;
     |SI nMes = 02;
         aDias = "28";

         |SI nAnyo = 2000;  |O nAnyo = 2004;  |O nAnyo = 2008;
          |O nAnyo = 2012;  |O nAnyo = 2016;  |O nAnyo = 2020;
          |O nAnyo = 2024;  |O nAnyo = 2028;  |O nAnyo = 2032;
             aDias = "29";
         |FINSI;
     |FINSI;

     aFecha = aDias + "." + (("00" + nMes) % -102) + "." + nAnyo;
|FPRC;
