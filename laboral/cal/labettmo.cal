|FICHEROS;
     labettmo #0;
     labettmh;
     labettnu;

     nomtmp14 #10,MANTE;
     labtraba #2;
     labcentr;
|FIN;

|VARIABLES;
   aAlfa  = "";
   aAlfa1  = "";
   aAlfa2  = "";
   aMarca = "";
   nCalc  = 0;
   nOpcion = 0;
   nNumTrab = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "VS";
    Menu5 = " Volver al lineal ";
    Menu6 = " Salir ";
    || Menu6 = " Confirmar";
    || Menu7 = " Cancelar ";

     aFechaBaja = "";
     fFechaBaja = @;
     nFechaBaja = 0;
     fFecha = @;

     aFechaLim = "";
     fFechaLim = @;
     nFechaLim = 0;
     swSigue = 0;
     red_ultimo = 0;

     nEmp = 0;
     nTra = 0;
     nCampo = 0;
     aDesdeCon = "";
     aHastaCon = "";

     nModo = 0;
     &enCesionCentro = 0;
     &efCesionFecha = @;
     &eaCesionTipo = "";
     aParam = "";
     swHay = 0;
|FIN;

|PROCESO Tipo5; |TIPO 5;
     |LINEAS_BI_ATRI #nomtmp14#10, I, D, -1;
|FPRC;

|PROCESO Envio;
     |SI #nomtmp14#10 = 1;
          aAlfa = "    SEl cambio de centro ya se ha enviado ¿Desea volver a realizar el envío?";
          |CONFI aAlfa;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;

     aAlfa = #nomtmp14#6;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "000";
          |MENAV "    Es necesario indicar el centro destino";
          |ACABA;
     |FINSI;

     swSigue = 1;
     |SI #nomtmp14#11 = "M"; |O #nomtmp14#11 = "E";
          aAlfa = #nomtmp14#8;
          |SI aAlfa = "";
               swSigue = 0;
          |FINSI;
          |SI aAlfa = "01.01.0000";
               swSigue = 0;
          |FINSI;
          |SI swSigue = 0;
               aAlfa = "    En movimientos de modificación o eliminación es necesario ";
               aAlfa = aAlfa + "indicar la fecha del movimiento";
               |MENAV aAlfa;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          |CONFI "    S¿Desea realizar el envío de este movimiento?";
          |SI FSalida = 0;
               aAlfa1 = #nomtmp14#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
               aAlfa2 = #nomtmp14#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
               enCesionCentro = #nomtmp14#6;
               efCesionFecha = #nomtmp14#8;
               eaCesionTipo = #nomtmp14#11;
               aAlfa = "labnct07;"+ "38" + aAlfa1 + aAlfa2;
               |SUB_EJECUTA aAlfa;
               |CONFI "    ¿Se ha registrado el movimiento correctamente?";
               |SI FSalida = 0;
                    |HAZ GrabaHis;
                    #nomtmp14#10 = 1;
                    |GRABA 020#nomtmp14.a;
                    |PONCONTROL 23, "si";
                    |PTEC 809;
                    || lo grabas
               |FINSI;
          |FINSI;
     |FINSI;
/*
     |MENAV "    Cucu";
     nModo = (FEntrada / 100) ! 0;
     aAlfa = nModo;
     |QBF aAlfa;
     nModo = FSalida;
     aAlfa1 = nModo;
     aAlfa = aAlfa  + " " + aAlfa1;
     |QBF aAlfa;
     |MENAV aAlfa;
*/
|FPRC;

|PROCESO EnvioTecla;
     |SI FSalida = 13;
          |HAZ Envio;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Activa8;
     |SI #nomtmp14#11 = "A";
          |CAMPO_MODIFICA #nomtmp14#8, 1, "N";
          #nomtmp14#8 = "01.01.0000";
          |PINTA #nomtmp14#8;
          ||HAZ Envio;
     |SINO;
          |CAMPO_MODIFICA #nomtmp14#8, 1, "S";
          |SI #nomtmp14#8 = "01.01.0000";
               #nomtmp14#8 = ~;
               |PINTA #nomtmp14#8;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Mensaje; |TIPO 7;
     ||MENSA "    <INTRO> Marcar/Desmarcar, <F5> Todos, <F6> Ninguno";
|FPRC;

|PROCESO MarcaDesmarca;
     #nomtmp14#6 = aMarca; |GRABA 020#nomtmp14.a;
|FPRC;

|DEFBUCLE MarcaDesmarca;
     #nomtmp14#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, MarcaDesmarca;
|FIN;

|PROCESO Marcalo; |TIPO 0;
/*
     || marca automatica al entrar
     |SI FSalida = 0; |O FSalida = 13;
          |SI #nomtmp14#9 = "**";
               #nomtmp14#9 = "  ";
          |SINO;
               #nomtmp14#9 = "**";
          |FINSI;

          |PINTA #nomtmp14#9;
          |GRABA 020#nomtmp14.a;
     |FINSI;
*/

/*
     |SI FSalida = 13; || Marca todo
          nEmp = #nomtmp14#0;
          nTra = #nomtmp14#1;

          aMarca = "**"; |BUCLE MarcaDesmarca;

          #nomtmp14#0 = nEmp;
          #nomtmp14#1 = nTra;
          |LEE 000#nomtmp14.=;

          |PONCONTROL 23, "si";
     |FINSI;

     |SI FSalida = 14; || Desmarca todo
          nEmp = #nomtmp14#0;
          nTra = #nomtmp14#1;

          aMarca = "  "; |BUCLE MarcaDesmarca;

          #nomtmp14#0 = nEmp;
          #nomtmp14#1 = nTra;
          |LEE 000#nomtmp14.=;

          |PONCONTROL 23, "si";
     |FINSI;
*/
|FPRC;

|PROCESO mincen;
     #labcentr#0 = #nomtmp14#0;
     #labcentr#1 = 001;
|FPRC;

|PROCESO maxcen;
     #labcentr#0 = #nomtmp14#0;
     #labcentr#1 = 999;
|FPRC;

|PROCESO CentroCon; |TIPO 66;
     |ABRE #labcentr;
     |CONSULTA_F_CLAVE #1#labcentr, mincen, maxcen;
     |SI FSalida = 0;
          #nomtmp14#6 = #labcentr#1;
          #nomtmp14#7 = #labcentr#2;
          |PINTA #nomtmp14#6;
          |PINTA #nomtmp14#7;
          || #nomtmp14#8 = ~;
          || PINTA #nomtmp14#8;
     |FINSI;
     |CIERRA #labcentr;
|FPRC;

|PROCESO DefectoFecha; |TIPO 7;
     |SI #nomtmp14#11 = "M"; |O #nomtmp14#11 = "E";
          |SI #nomtmp14#8 = "01.01.0000";
               #nomtmp14#8 = ~;
               |PINTA #nomtmp14#8;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CentroNum;
     aAlfa = #nomtmp14#6;
     |QBF aAlfa;
     aAlfa = ("000" + aAlfa) % -103;
     #nomtmp14#6 = aAlfa;
     |PINTA #nomtmp14#6;

     |SI aAlfa = "000";
          #nomtmp14#6 = "";
          #nomtmp14#7 = "";
          #nomtmp14#8 = "01.01.0000";
          |PINTA #nomtmp14#6;
          |PINTA #nomtmp14#7;
          |PINTA #nomtmp14#8;

          |PTEC 806;
     |SINO;
          |ABRE #labcentr;
          #labcentr#0 = #nomtmp14#0;
          #labcentr#1 = #nomtmp14#6;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
               #nomtmp14#7 = #labcentr#2;
               |PINTA #nomtmp14#7;
               ||#nomtmp14#8 = ~;
               || PINTA #nomtmp14#8;
          |SINO;
               #nomtmp14#6 = "";
               #nomtmp14#7 = "";
               #nomtmp14#8 = "01.01.0000";
               |PINTA #nomtmp14#6;
               |PINTA #nomtmp14#7;
               |PINTA #nomtmp14#8;
               |MENAV "    No existe el centro especificado";
               |ERROR;
          |FINSI;
          |CIERRA #labcentr;
     |FINSI;
|FPRC;

|PROCESO CentroComp;
/*
     |SI #nomtmp14#4 = #nomtmp14#6;
          |MENAV "    El centro origen no puede ser igual al centro destino";
          #nomtmp14#6 = "";
          #nomtmp14#7 = "";
          #nomtmp14#8 = "01.01.0000";
          |PINTA #nomtmp14#6;
          |PINTA #nomtmp14#7;
          |PINTA #nomtmp14#8;

          |ERROR;
     |FINSI;
*/
|FPRC;

|PROCESO GrabaHis;

     |ABRE #labettmh;
     #labettmh#0 = #nomtmp14#0;
     #labettmh#1 = #nomtmp14#1;
     #labettmh#8 = #nomtmp14#8;
     |LEE 000#labettmh.=;
     |SI FSalida = 0;
          |BORRA 020#labettmh.a;
          |LIBERA #labettmh;
     |FINSI;

     |PARA nCampo = 0; |SI nCampo [ 12; |HACIENDO nCampo = nCampo + 1;
          #labettmh#nCampo# = #nomtmp14#nCampo#;
     |SIGUE;
     |SI #labettmh#11 = "A";
          #labettmh#8 = ~;
     |FINSI;
     #labettmh#9 = "";

     |GRABA 020#labettmh.n;

     |LIBERA #labettmh;
     |CIERRA #labettmh;

     |SI aParam = "nubea";
          |ABRE #labettnu;
          #labettnu#11 = #nomtmp14#12;
          |LEE 000#labettnu.=;
          |SI FSalida = 0;
               #labettnu#10 = "A";
               |GRABA 020#labettnu.a;
               |LIBERA #labettnu;
          |FINSI;
          |CIERRA #labettnu;
     |FINSI;

     nNumTrab = nNumTrab + 1;
|FPRC;

/*
|DEFBUCLE nomtmp14;
     #nomtmp14#1;
     9;
     00001, 00001, "**";
     99999, 99999, "**";
     ;
     NULL, GrabaHis;
|FIN;
*/

|PROCESO Proceso;
/*
     |ABRE #labtraba;
     |ABRE #labettmh;

     |BUCLE nomtmp14;

     |CIERRA #labettmh;
     |CIERRA #labtraba;

     |SI nNumTrab > 0;
          aAlfa1 = nNumTrab;
          aAlfa = "    Se ha registrado el cambio de centro para "
          aAlfa = aAlfa + aAlfa1 + " trabajadores."
          |MENAV aAlfa;

          aAlfa = "    Ahora te toca crear el XML para conectaSS";
          |MENAV aAlfa;
     |FINSI;
*/
|FPRC;

|PROCESO inferior;
     #nomtmp14#0 = 00001;
     #nomtmp14#1 = 00001;
     #nomtmp14#10 = "N";
|FPRC;

|PROCESO superior;
     #nomtmp14#0 = 99999;
     #nomtmp14#1 = 99999;
     #nomtmp14#10 = "N";
|FPRC;

|PROCESO Trabajadores;
/*
     aFechaBaja = #labtraba#37;
     fFechaBaja = aFechaBaja;
     nFechaBaja = fFechaBaja;
     |QBF aFechaBaja;

     aFechaLim = "31.12.2017";
     fFechaLim = aFechaLim;
     nFechaLim = fFechaLim;

     |SI aFechaBaja ! ""; |Y aFechaBaja ! "..........";
          |SI nFechaBaja [ nFechaLim;
               |ACABA;
          |FINSI;
     |FINSI;
*/
     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;

     swSigue = 1;
     fFecha = ~;

     |SI swSigue = 1;
          |DDEFECTO #nomtmp14;
          #nomtmp14#0 = #labtraba#0;
          #nomtmp14#1 = #labtraba#1;
          #nomtmp14#2 = #labtraba#2;
          #nomtmp14#3 = #labtraba#45;
          #nomtmp14#4 = #labtraba#77;
          #nomtmp14#5 = #labcentr#2;
          #nomtmp14#6 = "";
          #nomtmp14#7 = "";
          #nomtmp14#8 = "01.01.0000";
          #nomtmp14#9 = "";
          |GRABA 020#nomtmp14.n;
          nNumTrab = nNumTrab + 1;

          |LIBERA #nomtmp14;
          swHay = 1;
     |FINSI;
|FPRC;

|DEFBUCLE Trabajadores;
     #labtraba#8;
     45, 77;
     "A", #0#0, #0#4, aDesdeCon, #0#2;
     "A", #0#1, #0#5, aHastaCon, #0#3;
     ;
     NULL, Trabajadores;
|FIN;

|PROCESO labettnu;
     |PARA nCampo = 0; |SI nCampo [ 8; |HACIENDO nCampo = nCampo + 1;
          #nomtmp14#nCampo# = #labettnu#nCampo#;
     |SIGUE;
     #nomtmp14#11 = #labettnu#9;

     #labtraba#0 = #nomtmp14#0;
     #labtraba#1 = #nomtmp14#1;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          #nomtmp14#2 = #labtraba#2; || nombre, por si acaso
          #nomtmp14#3 = #labtraba#45; || contrato
          #nomtmp14#12 = #labettnu#11; || id nubea, ES LA CLAVE
          |GRABA 020#nomtmp14.n;
          |LIBERA #nomtmp14;

          swHay = 1;
     |SINO;
          aAlfa1 = #labettnu#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aAlfa2 = #labettnu#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
          aAlfa = "    ATENCION. No se ha encontrado el trabajador " + aAlfa1 + "." + aAlfa2;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|DEFBUCLE labettnu;
     #labettnu#2;
     ;
     0000001, "P";
     9999999, "P";
     ;
     NULL, labettnu;
|FIN;

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;

     |CLS;
     |CABEZA " ";

     |ABRE #labtraba;
     |ABRE #labcentr;

     |SI aParam = "nubea";
          || no pintas la pantalla ni pides datos
          FSalida = 0;
     |SINO;
          |PINPA #0#0; |PINDA #0#0;
          |ENDATOS #1#0;
     |FINSI;
     |SI FSalida = 0;
          aAlfa = "tm_nomtmp14_" + Usuario; |NOME_DAT #nomtmp14#aAlfa#;
          |DELINDEX #nomtmp14;
          |ABRE #nomtmp14;
          nNumTrab = 0;
          aDesdeCon = #0#6;
          aHastaCon = #0#7;

          |SI aParam = "nubea";
               swHay = 0;
               |BUCLE labettnu;
               |SI swHay = 0;
                    |MENAV "    No se han encontrado movimientos pendientes";
               |FINSI;
          |SINO;
               swHay = 0;
               |BUCLE Trabajadores;
               |SI swHay = 0;
                    |MENAV "    No se han encontrado trabajadores con la selección realizada";
               |FINSI;
          |FINSI;


          |PARA; |SI swHay = 1; |HACIENDO;
               |ENTLINEAL #1#nomtmp14, -1, 2, 21, 1, inferior, superior;

               |ENTLINEAL #1#nomtmp14, -1, 7, 21, 1, inferior, superior;
               |MENU Menu;
               nOpcion = FSalida;
               |SI nOpcion = 1;
                    || vuelta al lineal
               |FINSI;
               |SI nOpcion = 2;
                    nNumTrab = 0;
                    ||HAZ Proceso;
                    |SAL;
               |FINSI;
               |SI nOpcion = 3;
                         |SAL;
                    /*
                    aAlfa = "    S" + &191 + "Está seguro de salir sin aplicar los cambios?";
                    |CONFI aAlfa;
                    |SI FSalida = 0;
                         |SAL;
                    |FINSI;
                    */
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #nomtmp14;
     |DELINDEX #nomtmp14;

     |CIERRA #labcentr;
     |CIERRA #labtraba;
|FPRO;
