|FICHEROS;
     dsmoc131 #0;
     dsmod131 #131;
     dsmom001 #11;
     dsmom004 #4;
     dsmom008 #8;
     dsmom017 #17;
     dsmom093 #93;

     :/basica/def/agicen14 #114;
     dsmod131@ #1131;

     espejo1@ #100;
     espejo2@ #101;
     espejo3@ #102;
     espejo4@ #104;

     :/contagen/def/cacuenta #800;
     :/contagen/def/camaasil #801;

     dsmom022  #922;   ||Cuentas  de Retencion
|FIN;

|VARIABLES;
     nSwEsta        = 0;
     nPer           = 0;
     nCampo         = 0;

     aPathModelo    = "";
     aDef           = "";
     aAlfa          = "";
     aBase          = "";
     aMas           = "";
     aFichero       = "";

     fDFecha        = @;
     fHFecha        = @;

     nGEmpresa      = 0;
     nGEjer         = 0;
     nGPeriodo      = 0;
     nGModelo       = 0;
     nGComplem      = 0;
     nGActividad    = 0;
     nParaBorra     = 0;
     nEl33          = 0;
     nHComple       = 0;
     nHPer          = 0;

     nSwRetencion   = 0;
     nCtRetencion   = 0;
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa3         = "";
     fFechaIni      = @;
     fFechaFin      = @;
     nHasta         = 0;
     nTrim          = 0;
     nAntes1        = 0;
     nSumaCtas      = 0;
     aUno           = "";
     aDos           = "";
     nNume1         = 0;
     nNume2         = 0;
     nNume3         = 0;
     nNume4         = 0;
     nDepar         = 0;

     nSumaD         = 0;
     nSwNeg         = 0;
     nHay           = 0;
     aAplica        = "";
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;

|| \\\\\\ Grabacion del Registro de Emision ///////

|PROCESO CargaEpis;
     |SI #131#6 = "    ";  |Y #131#7 = 0;  |Y #131#9 = 0;
         #131#6 = #0#6;
         #131#7 = #0#9;
         #131#8 = #0#10;
         #131#9 = #0#11;
         |ACABA;
     |FINSI;

     |SI #131#10 = "    ";  |Y #131#11 = 0;  |Y #131#13 = 0;
         #131#10 = #0#6;
         #131#11 = #0#9;
         #131#12 = #0#10;
         #131#13 = #0#11;
         |ACABA;
     |FINSI;

     |SI #131#14 = "    ";  |Y #131#15 = 0;  |Y #131#17 = 0;
         #131#14 = #0#6;
         #131#15 = #0#9;
         #131#16 = #0#10;
         #131#17 = #0#11;
         |ACABA;
     |FINSI;

     |SI #131#18 = "    ";  |Y #131#19 = 0;  |Y #131#21 = 0;
         #131#18 = #0#6;
         #131#19 = #0#9;
         #131#20 = #0#10;
         #131#21 = #0#11;
         |ACABA;
     |FINSI;

     |SI #131#22 = "    ";  |Y #131#23 = 0;  |Y #131#25 = 0;
         #131#22 = #0#6;
         #131#23 = #0#9;
         #131#24 = #0#10;
         #131#25 = #0#11;
         |ACABA;
     |FINSI;

     #131#22 = "";
     #131#23 = #131#23 + #0#9;
     #131#24 = 0;
     #131#25 = #131#25 + #0#11;
|FPRC;

|PROCESO dsmod131;

     |SI #1131#33 < 0; nSwNeg = 1; |FINSI;

     |SI #1131#33 ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1131#38;

     |SI #1131#33 < 0;
         #131#39 = #131#39 + -#1131#33;
     |SINO;
         #131#39 = #131#39 - #1131#38;
         |SI #131#39 [ 0; nSwNeg = 0; #131#39 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsmod131;
     #1131#1006;
     ;
     #131#0, #131#1,     3, #131#3,  0, #131#5;
     #131#0, #131#1, nHPer, #131#3, 99, #131#5;
     ;
     NULL, dsmod131;
|FIN;

|PROCESO CapturaNegativos;
     |SI #131#38 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsmod131.mas";
     |CARGA_DEF aMas, dsmod131@;

     |ABRE #dsmod131@;
     nSwNeg   = 0;
     nSumaD   = 0;
     #131#39  = 0;
     nHPer    = #131#2 - 3;
     |PARA nNume4 = 3; |SI nNume4 [ nHPer; |HACIENDO nNume4 = nNume4 + 3;
           |DDEFECTO #1131;
           #1131#0 = #131#0;
           #1131#1 = #131#1;
           #1131#2 = nNume4;
           #1131#3 = #131#3;
           #1131#4 = 99;
           #1131#5 = #131#5;
           |LEE 040#1131];
           |SI FSalida = 0;
               |LEE 040#1131a;
           |SINO;
               |LEE 040#1131u;
           |FINSI;
           |SI FSalida = 0; |Y #1131#0 = #131#0;|Y #1131#1 = #131#1;
                       |Y #1131#2 = nNume4; |Y #1131#3 = #131#3;
               |HAZ dsmod131;
           |FINSI;
     |SIGUE;

     |SI #131#39 > #131#38;  #131#39 = #131#38;  |FINSI;
     |CIERRA #dsmod131@;
     |DESCARGA_DEF #dsmod131@;
|FPRC;

|PROCESO dsmod131_2;
     |SI #1131#33 > 0;
         #131#41 = #131#41 + #1131#33;
     |FINSI;
|FPRC;

|DEFBUCLE dsmod131_2;
     #1131#1006;
     ;
     #131#0, #131#1, #131#2, #131#3,        0, #131#5;
     #131#0, #131#1, #131#2, #131#3, nHComple, #131#5;
     ;
     NULL, dsmod131_2;
|FIN;

|PROCESO CapturaOtros131;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsmod131.mas";
     |CARGA_DEF aMas, dsmod131@;

     nHComple = #131#4 - 1;
     #131#41  = 0;

     |BUCLE dsmod131_2;

     |DESCARGA_DEF #dsmod131@;
|FPRC;

|PROCESO GrabaModelo;
     #8#0 = #0#0;
     #8#1 = #0#1;
     #8#2 = #0#2;
     #8#3 = #0#3;
     #8#4 = #0#4;
     #8#5 = #0#5;
     |LEE 040#8=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |SI #8#9 = "S";   |ACABA;  |FINSI;

     #131#0 = #0#0;
     #131#1 = #0#1;
     #131#2 = #0#2;
     #131#3 = #0#3;
     #131#4 = #0#4;
     #131#5 = 0;
     |LEE 101#131=;
     |SI FSalida ! 0;
         |DDEFECTO #131;
         #131#0 = #0#0;
         #131#1 = #0#1;
         #131#2 = #0#2;
         #131#3 = #0#3;
         #131#4 = #0#4;
         #131#5 = 0;
         |GRABA 020#131b;
     |FINSI;

     |SI #0#8 = "N";
         |HAZ CargaEpis;
     |FINSI;

     |HAZ LeeAplica131;
     #131#42 = 0;
     |SI #131#1 = 2008; |Y aAplica ! "N";
         |SI #131#2 = 6;   #131#42 = 200;  |FINSI;
         |SI #131#2 = 9;   #131#42 = 100;  |FINSI;
         |SI #131#2 = 12;  #131#42 = 100;  |FINSI;
     |FINSI;

     |SI #0#8 = "S";
         #131#29 = #131#29 + #0#13;
         #131#30 = #131#29 % 2;
     |FINSI;

     |SI #0#8 = "1";
         #131#34 = #131#34 + #0#13;
         #131#35 = #131#34 % 2;
     |FINSI;

     #131#26 = #131#9  + #131#13 + #131#17 + #131#21 + #131#25;
     #131#27 = #131#27 + #0#12;
     #131#31 = #131#31 + #0#15;

     |SI #131#1 [ 2006;
         #131#28 = #131#26 - #131#27;
         |SI #131#28 < 0;  #131#28 = 0;  |FINSI;

         #131#32 = #131#30 - #131#31;
         |SI #131#32 < 0;  #131#32 = 0;  |FINSI;

         #131#36 = #131#26 + #131#35 + #131#30;
         #131#37 = #131#27 + #131#31;
         #131#38 = #131#28 - #131#32;
         #131#33 = #131#28 - #131#32;
     |SINO;
         #131#36 = #131#26 + #131#35 + #131#30;
         #131#37 = #131#27 + #131#31;
         #131#38 = #131#36 - #131#37 - #131#42;
         #131#39 = 0;
         |SI #131#2 ! 3;
             |HAZ CapturaNegativos;
         |FINSI;

         #131#40 = #131#38 - #131#39;

         nEl33 = #131#40;
         |SI #131#4 > 0;
             |HAZ CapturaOtros131;
             nEl33 = nEl33 - #131#41;
             |SI nEl33 < 0;
                 |MENAV "    RECUERDE. Si el resultado NO es a INGRESAR, NO procede declaracion complementaria";
             |FINSI;
         |FINSI;

         #131#33 = #131#40 - #131#41;
     |FINSI;

     |GRABA 020#131a;
     |LIBERA #131;

     #8#0 = #0#0;
     #8#1 = #0#1;
     #8#2 = #0#2;
     #8#3 = #0#3;
     #8#4 = #0#4;
     #8#5 = 0;
     |LEE 101#8=;
     |SI FSalida ! 0;
         #8#0 = #0#0;
         #8#1 = #0#1;
         #8#2 = #0#2;
         #8#3 = #0#3;
         #8#4 = #0#4;
         #8#5 = 0;
         |GRABA 020#8b;
     |FINSI;

     #8#11 = "EXISTENTE";
     |GRABA 020#8a;
     |LIBERA #8;
|FPRC;

|DEFBUCLE dsmoc131;
    #0#1;
    ;
    enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01;
    enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 99;
    ;
    NULL, GrabaModelo;
|FIN;

|PROCESO GrabaRegistro0;
     |ABRE #131;
     #131#0 = enEmpresa;
     #131#1 = enEjer;
     #131#2 = enPeriodo;
     #131#3 = enModelo;
     #131#4 = enComplem;
     #131#5 = 0;
     |BORRA 040#131c;
     |LIBERA #131;

     |ABRE #8;
     #8#0 = enEmpresa;
     #8#1 = enEjer;
     #8#2 = enPeriodo;
     #8#3 = enModelo;
     #8#4 = enComplem;
     #8#5 = 0;
     |LEE 101#8=;
     |SI FSalida ! 0;
         |DDEFECTO #8;
         #8#0 = enEmpresa;
         #8#1 = enEjer;
         #8#2 = enPeriodo;
         #8#3 = enModelo;
         #8#4 = enComplem;
         #8#5 = 0;
         |GRABA 020#8b;
     |FINSI;

     #8#11 = "SIN DATOS ";
     |GRABA 020#8a;
     |LIBERA #8;

     |BUCLE dsmoc131;
     |CIERRA #131;
     |CIERRA #8;
|FPRC;

|| \\\\\\ Grabacion del Registro del Comunero ///////

|PROCESO ChequeaSituaC;
     |SI #101#5 = 0;
         |ABRE #131;
         #131#0 = #101#0;
         #131#1 = #101#1;
         #131#2 = #101#2;
         #131#3 = #101#3;
         #131#4 = #101#4;
         #131#5 = 0;
         |LEE 040#131=;
         |SI FSalida ! 0;  enExistencia = 1;  |FINSI;
         |CIERRA #131;

         enResultado = #131#33;
     |FINSI;

     |SI #101#5 ! 0;
         |ABRE #100;
         #100#0 = #101#0;
         #100#1 = #101#1;
         #100#2 = #101#2;
         #100#3 = #101#3;
         #100#4 = #101#4;
         #100#5 = #101#5;
         |LEE 040#100=;
         |SI FSalida ! 0;  enExistencia = 1;  |DDEFECTO #100;  |FINSI;
         |CIERRA #100;
     |FINSI;

     |SI #101#5 = 0;  |Y enExistencia = 1;
         #4#17 = "SIN DATOS";
         #4#7  = " ";
         #4#15 = 0;
         |ERROR10;
     |FINSI;

     |SI #101#5 ! 0;  |Y enExistencia = 1;
         #4#17 = "PARCIALES";
         #4#7  = "X";
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE espejo2;
     #101#1006;
     ;
     #4#0, #4#1, #4#2, #4#3, #4#4, 00;
     #4#0, #4#1, #4#2, #4#3, #4#4, 98;
     ;
     NULL, ChequeaSituaC;
|FIN;

|PROCESO MiraMadre;
     #104#0 = #102#0;                      ||Esto es para que no vuelva a
     #104#1 = #102#1;                      ||pasar el mismo cumunero varias
     #104#2 = #102#2;                      ||veces.
     |LEE 000#104=;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     |DDEFECTO #104;
     #104#0 = #102#0;
     #104#1 = #102#1;
     #104#2 = #102#2;
     |GRABA 020#104n;
     |LIBERA #104;

     |SI #102#8 = "01.01.0000";  #102#8 = fDFecha;  |FINSI;
     |SI #102#9 = "01.01.0000";  #102#9 = fHFecha;  |FINSI;

     |SI #102#8 > fHFecha;  |ACABA;  |FINSI;
     |SI #102#9 < fDFecha;  |ACABA;  |FINSI;

     #0#0 = #102#0;
     #0#1 = nGEjer;
     #0#2 = nGPeriodo;
     #0#3 = nGModelo;
     #0#4 = nGComplem;
     #0#5 = #102#1;
     |LEE 040#0=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |ABRE #101;
     #101#0 = #102#3;
     #101#1 = #0#1;
     #101#2 = #0#2;
     #101#3 = #0#3;
     #101#4 = #0#4;
     #101#5 = #102#4;
     |LEE 101#101=;
     |SI FSalida ! 0;
         aAlfa = "     Planing de Comuneros Incompleto, Revise los Datos. Comunero " + #102#3  +  " Madre " + #102#0;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI enTipoEntrada = 3; |O enTipoEntrada = 97;  ||Baja del Modelo
         #100#0 = #102#3;
         #100#1 = #0#1;
         #100#2 = #0#2;
         #100#3 = #0#3;
         #100#4 = #0#4;
         #100#5 = #102#4;
         |LEE 040#100=;
         |SI FSalida ! 0;
             #101#11 = "SIN DATOS ";
             |GRABA 020#101a;
             |LIBERA #101;

             enEmpresa = #100#0;
             enEjer    = #100#1;
             enPeriodo = #100#2;
             enModelo  = #100#3;
             enComplem = #100#4;

             |SALVA_FICHA #0;
             |HAZ GrabaRegistro0;
             |REPON_FICHA #0;

             |ABRE #4;
             #4#0 = #100#0;
             #4#1 = #100#1;
             #4#2 = #100#2;
             #4#3 = #100#3;
             #4#4 = #100#4;
             |LEE 101#4=;
             |SI FSalida ! 0;
                 |DDEFECTO #4;
                 #4#0 = #100#0;
                 #4#1 = #100#1;
                 #4#2 = #100#2;
                 #4#3 = #100#3;
                 #4#4 = #100#4;
                 |GRABA 020#4b;
             |FINSI;

             enResultado  = 0;
             enExistencia = 0;
             |BUCLE espejo2;
             |SI enExistencia = 0;
                 #4#17 = "COMPLETADO";
                 #4#7  = "X";
             |FINSI;
             #4#15 = enResultado;
             |GRABA 020#4a;
             |LIBERA #4;
             |CIERRA #4;

             enEmpresa = #0#0;
             enEjer    = #0#1;
             enPeriodo = #0#2;
             enModelo  = #0#3;
             enComplem = #0#4;

             |ACABA;
         |FINSI;
     |FINSI;

     #100#0 = #102#3;
     #100#1 = #0#1;
     #100#2 = #0#2;
     #100#3 = #0#3;
     #100#4 = #0#4;
     #100#5 = #102#4;
     |LEE 101#100=;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0 = #102#3;
         #100#1 = #0#1;
         #100#2 = #0#2;
         #100#3 = #0#3;
         #100#4 = #0#4;
         #100#5 = #102#4;
         |GRABA 020#100b;
     |FINSI;

     #100#6  = #0#6;
     #100#7  = #0#7;
     #100#8  = #0#8;
     #100#10 = #0#10;

     |PARA nCampo = 9;  |SI nCampo [ 15;  |HACIENDO nCampo = nCampo + 1;
           |SI nCampo ! 10;
               #100nCampo = #100nCampo + (#0nCampo % #102#7);
           |FINSI;
     |SIGUE;

     |GRABA 020#100a;
     |LIBERA #100;

     #101#11 = "COMPLETADO";
     |GRABA 020#101a;
     |LIBERA #101;

     enEmpresa = #100#0;
     enEjer    = #100#1;
     enPeriodo = #100#2;
     enModelo  = #100#3;
     enComplem = #100#4;

     |SALVA_FICHA #0;
     |HAZ GrabaRegistro0;
     |REPON_FICHA #0;

     |CIERRA #101;

     |ABRE #4;
     #4#0 = #100#0;
     #4#1 = #100#1;
     #4#2 = #100#2;
     #4#3 = #100#3;
     #4#4 = #100#4;
     |LEE 101#4=;
     |SI FSalida ! 0;
         |DDEFECTO #4;
         #4#0 = #100#0;
         #4#1 = #100#1;
         #4#2 = #100#2;
         #4#3 = #100#3;
         #4#4 = #100#4;
         |GRABA 020#4b;
     |FINSI;

     enResultado  = 0;
     enExistencia = 0;
     |BUCLE espejo2;
     |SI enExistencia = 0;
         #4#17 = "COMPLETADO";
         #4#7  = "X";
     |FINSI;
     #4#15 = enResultado;
     |GRABA 020#4a;
     |LIBERA #4;
     |CIERRA #4;

     enEmpresa = #0#0;
     enEjer    = #0#1;
     enPeriodo = #0#2;
     enModelo  = #0#3;
     enComplem = #0#4;
|FPRC;

|DEFBUCLE espejo3;
     #102#2002;
     ;
     #11#3, #11#4;
     #11#3, #11#4;
     ;
     NULL, MiraMadre;
|FIN;

|PROCESO MiraComunero;
     #100#0 = #11#3;
     #100#1 = #0#1;
     #100#2 = #0#2;
     #100#3 = #0#3;
     #100#4 = #0#4;
     #100#5 = #11#4;
     |LEE 101#100=;
     |SI FSalida = 0;
         |BORRA 020#100a;
     |FINSI;

     |BUCLE espejo3;  || Mira si hay mas Empresas Madre
|FPRC;

|DEFBUCLE dsmom001;
     #11#1;
     ;
     #0#0, #0#5, 0001;
     #0#0, #0#5, 9999;
     ;
     NULL, MiraComunero;
|FIN;

|PROCESO TrataRegistroC;
     nGEmpresa     = #0#0;
     nGEjer        = #0#1;
     nGPeriodo     = #0#2;
     nGModelo      = #0#3;
     nGComplem     = #0#4;
     nGActividad   = #0#5;

     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/" + eaNomDef + ".mas";
     |CARGA_DEF aDef, espejo1@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + eaNomDef;
         |MENAV aAlfa;
         |ERROR;
     |FINSI;

     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/" + "dsmom008.mas";
     |CARGA_DEF aDef, espejo2@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def dsmom008";
         |MENAV aAlfa;
         |ERROR;
     |FINSI;

     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/" + "dsmom001.mas";
     |CARGA_DEF aDef, espejo3@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def dsmom001";
         |MENAV aAlfa;
         |ERROR;
     |FINSI;

     |CARGA_DEF aDef, espejo4@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def dsmom001";
         |MENAV aAlfa;
         |ERROR;
     |FINSI;

     aFichero = ("01" + Usuario + "zzzzzzzz") % 108;  |NOME_DAT #104 aFichero;

     |SI #0#2 = 3;   aAlfa = "01.01." + #0#1;  |FINSI;
     |SI #0#2 = 6;   aAlfa = "01.04." + #0#1;  |FINSI;
     |SI #0#2 = 9;   aAlfa = "01.07." + #0#1;  |FINSI;
     |SI #0#2 = 12;  aAlfa = "01.10." + #0#1;  |FINSI;

     fDFecha = aAlfa;

     |SI #0#2 = 3;   aAlfa = "31.03." + #0#1;  |FINSI;
     |SI #0#2 = 6;   aAlfa = "30.06." + #0#1;  |FINSI;
     |SI #0#2 = 9;   aAlfa = "30.09." + #0#1;  |FINSI;
     |SI #0#2 = 12;  aAlfa = "31.12." + #0#1;  |FINSI;

     fHFecha = aAlfa;

     |ABRE #100;
     |ABRE #104;
     |BUCLE dsmom001;
     |CIERRA #100;
     |CIERRA #104;

     |DELINDEX #104;

     |DESCARGA_DEF #espejo4@;
     |DESCARGA_DEF #espejo3@;
     |DESCARGA_DEF #espejo2@;
     |DESCARGA_DEF #espejo1@;

     #0#0 = nGEmpresa;
     #0#1 = nGEjer;
     #0#2 = nGPeriodo;
     #0#3 = nGModelo;
     #0#4 = nGComplem;
     #0#5 = nGActividad;
     |LEE 101#0=;
|FPRC;

|PROCESO BajaModelo;
     |HAZ TrataRegistroC;

     |BORRA 020#0a;
     |LIBERA #0;

     |ABRE #8;
     #8#0 = #0#0;
     #8#1 = #0#1;
     #8#2 = #0#2;
     #8#3 = #0#3;
     #8#4 = #0#4;
     #8#5 = #0#5;
     |LEE 101#8=;
     |SI FSalida ! 0;
         #8#0 = #0#0;
         #8#1 = #0#1;
         #8#2 = #0#2;
         #8#3 = #0#3;
         #8#4 = #0#4;
         #8#5 = #0#5;
         |GRABA 020#8b;
     |FINSI;

     #8#11 = "SIN DATOS ";
     |GRABA 020#8a;
     |LIBERA #8;
     |CIERRA #8;

     enEmpresa = #0#0;
     enEjer    = #0#1;
     enPeriodo = #0#2;
     enModelo  = #0#3;
     enComplem = #0#4;

     |HAZ GrabaRegistro0;
|FPRC;

|DEFBUCLE dsmoc131B;
     #0#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, enActividad;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, enActividad;
     be;
     NULL, BajaModelo;
|FIN;

|PROCESO Modificas;  |TIPO 0;
     |SI enModi131 = 1;  |ACABA;  |FINSI;

     |C_M #0#9,  1, "S";
     |C_M #0#10, 1, "S";
     |C_M #0#12, 1, "S";
     |C_M #0#13, 1, "S";
     |C_M #0#15, 1, "S";

     |SI #0#8 = "N";
         |C_M #0#8,  1, "N";
         |C_M #0#13, 1, "N";  #0#13 = 0;
         |C_M #0#15, 1, "N";  #0#15 = 0;
     |SINO;
         |C_M #0#8,  1, "S";
         |C_M #0#9,  1, "N";  #0#9  = 0;
         |C_M #0#10, 1, "N";  #0#10 = 0;
         |C_M #0#12, 1, "N";  #0#12 = 0;
     |FINSI;
|FPRC;

|PROCESO Totales;
     #0#11 = #0#9  % #0#10;
     #0#14 = #0#13 % 2;

     |PINTA #0#9;
     |PINTA #0#10;
     |PINTA #0#11;
     |PINTA #0#12;
     |PINTA #0#13;
     |PINTA #0#14;
     |PINTA #0#15;
|FPRC;

|PROCESO Tipo12moc131;  |TIPO 12;
|FPRC;

|| Nuevo Proceso para recoger Retenciones desde Contabilidad
|PROCESO AReten131; |TIPO 7;
 |SI swerror = 0;
     |MENSA "    Pulse <F5> Recoger Datos Contabilidad";
 |FINSI;
|FPRC;

|PROCESO CalCtas;
 |SI nSwRetencion = 1;  |Y #801#0 = 0;
     |ACABA;
 |FINSI;

 nDepar = #801#21;
 |SI nDepar = 0;  nDepar = 1;   |FINSI;
 |SI nDepar ! enActividad; |ACABA; |FINSI;

 nNume3 = 1;
|| |SI #114#2 = "I";
||     |SI #801#8 = "D"; nNume3 = -1; |FINSI;
|| |SINO;
||     |SI #801#8 = "H"; nNume3 = -1; |FINSI;
|| |FINSI;
 |SI nSwRetencion = 1;
     nNume3 = 1; |SI #801#8 = "H"; #801#9 = 0; |FINSI;
 |FINSI;
 nNume2 = ((#801#9 * nNume3) / enConversor) ! EURODBMOD;
 nSumaCtas = nSumaCtas + nNume2;
|FPRC;

|DEFBUCLE LeeApuntes;
  #801#3;
  ;
  aUno, fFechaIni, 000001, 0001;
  aDos, fFechaFin, 999999, 9999;
  e;
  NULL, CalCtas;
|FIN;

|PROCESO DatosContables;
     nSumaCtas = 0;
     aUno = #922#0;
     aDos = #922#0;
     |BUCLE LeeApuntes;
     |SI #922#3 = "-";
         nCtRetencion = nCtRetencion - nSumaCtas;
     |SINO;
         nCtRetencion = nCtRetencion + nSumaCtas;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom022;
     #922#1;
     ;
     "            ";
     "zzzzzzzzzzzz";
     ;
     NULL, DatosContables;
|FIN;

|PROCESO DReten131; |TIPO 0;
 |C_M #0Campo, 0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI FSalida = 13; |Y swerror = 0;
     nSwRetencion = 1;
     nNume1 = Campo;
     nCtRetencion = 0;
     |BUCLE dsmom022;
     |HAZ RecogeAnterior;
     #0Campo = nCtRetencion;
     |PINTA #0Campo;
     nSwRetencion = 0;

     aAlfa1 = "    Importe Retenciones del Trimestre recogidas de Contabilidad: " + nCtRetencion + " euros";
     |MENAV aAlfa1;
 |FINSI;
|FPRC;

|PROCESO RecogeAnterior;
     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/" + eaNomDef + ".mas";
     |CARGA_DEF aDef, espejo1@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + eaNomDef;
         |MENAV aAlfa;
         |ERROR;
     |FINSI;
     nHasta  = #0#2 - 3;
     nAntes1 = 0;
     |ABRE #100;
     |PARA nTrim = 3;  |SI nTrim [ nHasta;  |HACIENDO nTrim = nTrim + 3;
           #100#0 = #0#0;
           #100#1 = #0#1;
           #100#2 = nTrim;
           #100#3 = #0#3;
           #100#4 = #0#4;
           #100#5 = #0#5;
           |LEE 101#100=;
           |SI FSalida ! 0;  |DDEFECTO #100;  |FINSI;

           nAntes1 = nAntes1 + #100nNume1;
     |SIGUE;
     |CIERRA #100;
     nCtRetencion = nCtRetencion - nAntes1;

     |DESCARGA_DEF #espejo1@;
|FPRC;

||////////////////////////////////////////////////////////////////
|PROCESO ChequeaGraba;
     |SI #0#9  = 0; |Y  #0#11 = 0; |Y  #0#13 = 0;  |Y #0#14 = 0;
         |ABRE #17;
         #17#0 = #0#0;
         #17#1 = #0#1;
         #17#2 = #0#4;
         #17#3 = #0#5;
         |LEE 040#17=;
         |SI FSalida ! 0;  |DDEFECTO #17;  |FINSI;
         |CIERRA #17;

         nParaBorra = 0;
         |SI #0#2 = 3;  |Y #17#15 = 0; nParaBorra = 1;  |FINSI;
         |SI #0#2 = 6;  |Y #17#16 = 0; nParaBorra = 1;  |FINSI;
         |SI #0#2 = 9;  |Y #17#17 = 0; nParaBorra = 1;  |FINSI;
         |SI #0#2 = 12; |Y #17#18 = 0; nParaBorra = 1;  |FINSI;
         |SI nParaBorra = 1;
            |CONFI "0000NEl Importe es igual a Cero, desea Impreso SIN Actividad ";
            |SI FSalida = 0;
                |GRABA 020#0a;
                |ACABA;
            |FINSI;
         |FINSI;

         |SI #0#2 = 3;  |Y #17#15 = 0;
             enEntrada = 0;
             |BORRA 020#0a;
             |ACABA;
         |FINSI;

         |SI #0#2 = 6;  |Y #17#16 = 0;
             enEntrada = 0;
             |BORRA 020#0a;
             |ACABA;
         |FINSI;

         |SI #0#2 = 9;  |Y #17#17 = 0;
             enEntrada = 0;
             |BORRA 020#0a;
             |ACABA;
         |FINSI;

         |SI #0#2 = 12; |Y #17#18 = 0;
             enEntrada = 0;
             |BORRA 020#0a;
             |ACABA;
         |FINSI;

     |FINSI;

     |GRABA 020#0a;
|FPRC;

|PROCESO PathContab131; || Proceso  para Recoger los Datos Contables
  swerror    =  0;
  enPerConta = -1;      || No sabemos el Periodo Contable
  enSwSinMen = 1;
  |HAZ SituaContagen;
  |SI swerror = 1;
      || ... |MENAV "    Error. No existen Datos Contables de esta Empresa ";
      |ACABA;
  |FINSI;
  |HAZ EnConversor;
  aAlfa1 = enEjer;
  |SI enPeriodo = 3;  aAlfa2 = "01.01."; aAlfa3 = "31.03."; |FINSI;
  |SI enPeriodo = 6;  aAlfa2 = "01.01."; aAlfa3 = "30.06."; |FINSI;
  |SI enPeriodo = 9;  aAlfa2 = "01.01."; aAlfa3 = "30.09."; |FINSI;
  |SI enPeriodo = 12; aAlfa2 = "01.01."; aAlfa3 = "31.12."; |FINSI;

  aAlfa2 = aAlfa2 + aAlfa1; fFechaIni = aAlfa2;
  aAlfa3 = aAlfa3 + aAlfa1; fFechaFin = aAlfa3;

  |PATH_DAT #800 aPathConta;
  |PATH_DAT #801 aPathConta;
|FPRC;

|PROCESO AltaModelo;
     |SI enModi131 = 1;
         |ABRE #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = enActividad;
         |LEE 040#0=;
         |SI FSalida ! 0;
             enEntrada = 0;
             |MENAV "     El Modulo no existe, no puedo introducir retenciones.";
             |CIERRA #0;
             |ACABA;
         |FINSI;
         |CIERRA #0;
     |FINSI;

     nSwEsta   = 0;
     enEntrada = 1;

     |ABRE #0;
     #0#0 = enEmpresa;
     #0#1 = enEjer;
     #0#2 = enPeriodo;
     #0#3 = enModelo;
     #0#4 = enComplem;
     #0#5 = enActividad;
     |LEE 101#0=;
     |SI FSalida ! 0;
         |DDEFECTO #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = enActividad;
         nSwEsta = 1;

         |GRABA 020#0b;
     |FINSI;

     |ABRE #114;
     #114#0 = enEmpresa;
     #114#1 = enActividad;
     |LEE 040#114=;
     |SI FSalida ! 0;  |DDEFECTO #114;  |FINSI;
     |CIERRA #114;

     |C_M #0#8, 1, "N";
     |SI enActividad = 99;
         |C_M #0#8, 1, "S";
     |FINSI;

     #0#6  = #114#3;
     #0#7  = #114#4;
     #0#8  = "N";

     |SI #114#9 = 100;
         |C_M #0#8, 1, "S";
         #0#8 = "S";
     |FINSI;

     |SI #114#9 = 6;  |O #114#9 = 7;  |O #114#9 = 11;  |O #114#9 = 12;
         |C_M #0#8, 1, "S";
         #0#8 = "S";
     |FINSI;

     |C_M #0#9,  1, "S";
     |C_M #0#10, 1, "S";
     |C_M #0#13, 1, "S";
     |C_M #0#12, 1, "S";
     |C_M #0#15, 1, "S";
     |SI enModi131 = 1;
         |SI #0#8 ! "N";
             |C_M #0#8,  1, "S";
             |C_M #0#12, 1, "N";
         |SINO;
             |C_M #0#8,  1, "N";
             |C_M #0#15, 1, "N";
         |FINSI;
         |C_M #0#9,  1, "N";
         |C_M #0#10, 1, "N";
         |C_M #0#13, 1, "N";
     |FINSI;

     |PINPA #0#0;
     |PINDA #0#0;
     |HAZ PintaDatos;

     |HAZ PathContab131;

     |ENDATOS #1#0;
     |SI FSalida = 0;
         |HAZ ChequeaGraba;
     |SINO;
         |SI nSwEsta = 1;
             enEntrada = 0;
             |BORRA 020#0a;
         |FINSI;
     |FINSI;
     |LIBERA #0;

     |ABRE #8;
     #8#0 = enEmpresa;
     #8#1 = enEjer;
     #8#2 = enPeriodo;
     #8#3 = enModelo;
     #8#4 = enComplem;
     #8#5 = enActividad;
     |LEE 101#8=;
     |SI FSalida ! 0;
         |DDEFECTO #8;
         #8#0 = enEmpresa;
         #8#1 = enEjer;
         #8#2 = enPeriodo;
         #8#3 = enModelo;
         #8#4 = enComplem;
         #8#5 = enActividad;
         |GRABA 020#8b;
     |FINSI;

     #8#11 = "SIN DATOS ";
     |GRABA 020#8a;
     |LIBERA #8;
     |CIERRA #8;

     |SI eaComunidad = "S";
         |HAZ TrataRegistroC;
         |LIBERA #0;
         |CIERRA #0;
     |SINO;
         |CIERRA #0;

         enEmpresa = #0#0;
         enEjer    = #0#1;
         enPeriodo = #0#2;
         enModelo  = #0#3;
         enComplem = #0#4;
         |HAZ GrabaRegistro0;
     |FINSI;
|FPRC;

|PROCESO DesdeElModulo;
     |ABRE #8;
     #8#0 = enEmpresa;
     #8#1 = enEjer;
     #8#2 = enPeriodo;
     #8#3 = enModelo;
     #8#4 = enComplem;
     #8#5 = enActividad;
     |LEE 040#8=;
     |SI FSalida ! 0;  |DDEFECTO #8;  |FINSI;
     |CIERRA #8;

     eaComunidad = #8#9;

     |ABRE #0;
     #0#0 = enEmpresa;
     #0#1 = enEjer;
     #0#2 = enPeriodo;
     #0#3 = enModelo;
     #0#4 = enComplem;
     #0#5 = enActividad;
     |LEE 040#0=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI eaComunidad = "S";
         |HAZ TrataRegistroC;
         |LIBERA #0;
         |CIERRA #0;
     |SINO;
         |CIERRA #0;

         enEmpresa = #0#0;
         enEjer    = #0#1;
         enPeriodo = #0#2;
         enModelo  = #0#3;
         enComplem = #0#4;
         |HAZ GrabaRegistro0;
     |FINSI;

     enEmpresa   = #0#0;
     enEjer      = #0#1;
     enPeriodo   = #0#2;
     enModelo    = #0#3;
     enComplem   = #0#4;
     enActividad = #0#5;
|FPRC;

|| /////////////////////////////////////////////////////////////////////////
|PROCESO LeeAplica131;
 aAplica = "S";
 |ABRE #93;
 #93#0 = #131#3;
 #93#1 = #131#1;
 #93#2 = #131#0;
 |LEE 041#93=;
 |SI FSalida = 0;
     aAplica = #93#4;
 |FINSI;
 |CIERRA #93;
|FPRC;
|| /////////////////////////////////////////////////////////////////////////

|PROCESO deduc400_e;
 |HAZ LeeAplica131;
 |SI aAplica ! "N";
     |SI #131#2 ] 4; |Y #131#2 [ 12;
         |SI #131#42 = 0; nHay = 1; |FINSI;
     |FINSI;
     |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE deduc400_e;
 #131#1;
 ;
 00001, 2008, 04, enModelo, 00, 00;
 99999, 2008, 99, enModelo, 99, 99;
 e;
 NULL, deduc400_e;
|FIN;


|PROGRAMA;
|| \\\\\\ Actualizar Modelo art.80 (400 euros deduccion) ////////
    |SI enTipoEntrada = 4; |O enTipoEntrada = 1;
        nHay = 0;
        |BUCLE deduc400_e;
        |SI nHay = 1;
            |CONFI "    SRecalcular ahora Modelos por Minoracion art. 80";
            |SI FSalida = 0;
                |SUB_EJECUTA_NP "dsmoz095;131";
             |FINSI;
        |FINSI;
    |FINSI;

     eaNoVisu = "";
     eaNomDef = "dsmoc131";

|| \\\\\\ Consulta del Modelo ////////

     |SI enTipoEntrada = 4;              || Consulta del Modelo
         |HAZ SacaPantallas;
         |ACABA;
     |FINSI;

|| \\\\\\ Baja del Modelo ////////

     |SI enTipoEntrada = 3;              ||Baja del Modelo
         |BUCLE dsmoc131B;
         |ACABA;
     |FINSI;

|| \\\\\\ Baja del Modelo desde el Modulo ////////

     |SI enTipoEntrada = 97;              ||Baja del Modelo
         |BUCLE dsmoc131B;
         |ACABA;
     |FINSI;

|| \\\\\\ Alta o Modificacion del Modelo ////////

     |SI enTipoEntrada = 1;              || Alta del Modelo
         |CABEZA "Modelo Trabajo 131";
         |HAZ AltaModelo;
     |FINSI;

|| \\\\\\ Grabacion del Modelo desde el Exterior

     |SI enTipoEntrada = 98;
         |HAZ DesdeElModulo;
     |FINSI;

|| \\\\\\ Comprobacion Existencia del Modelo

     |SI enTipoEntrada = 99;              || Existencia del Modelo ????
         |ABRE #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = enActividad;
         |LEE 040#0=;
         |SI FSalida ! 0;  enExistencia = 1;  |FINSI;
         |CIERRA #0;
     |FINSI;
|FPRO;
