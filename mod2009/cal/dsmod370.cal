|FICHEROS;
     dsmod370 #0;
     dsmom027 #27;
     dsmom028 #28;
     dsmom029 #29;
     dsmom047 #47;
     dsmociva #1;
     dsmoc310 #2;
     dsmom004 #4;
     dsmocivp #165;

     dsmom109 #109;

     dsmod300 #300;
     dsmod310 #310;
     dsmod320 #320;
     dsmod330 #330;
     dsmod332 #332;
|FIN;

|VARIABLES;
     nCampo1     = 0;
     nCampo2     = 0;
     nCampo3     = 0;
     nCampo11    = 0;
     nCampo22    = 0;
     nCampo33    = 0;
     nEjerAnt    = 0;
     nSwAcum     = 0;
     nDesde      = 0;
     nHasta      = 0;
     nContador   = 0;
     nAnyo       = 0;
     nPer        = 0;
     nTipo       = 0;

     nBaseMas    = 0;
     nCuotaMas   = 0;
     nPro        = 0;
|FIN;

|INCLUYE i_variar;

|PROCESO LeeOtrosMod;

         nEjerAnt = 0;

         |ABRE #300;
         #300#0 = enEmpresa;
         #300#1 = nAnyo;
         #300#2 = nPer;
         #300#3 = 300;
         #300#4 = enComplem;
         #300#5 = 0;
         |LEE 040#300=;
         |SI FSalida ! 0;  |DDEFECTO #300;  |FINSI;
         |CIERRA #300;
         nEjerAnt = #300#63;

         |ABRE #320;
         #320#0 = enEmpresa;
         #320#1 = nAnyo;
         #320#2 = nPer;
         #320#3 = 320;
         #320#4 = enComplem;
         #320#5 = 0;
         |LEE 040#320=;
         |SI FSalida ! 0;  |DDEFECTO #320;  |FINSI;
         |CIERRA #320;
         nEjerAnt = nEjerAnt + #320#65;

         |ABRE #330;
         #330#0 = enEmpresa;
         #330#1 = nAnyo;
         #330#2 = nPer;
         #330#3 = 330;
         #330#4 = enComplem;
         #330#5 = 0;
         |LEE 040#330=;
         |SI FSalida ! 0;  |DDEFECTO #330;  |FINSI;
         |CIERRA #330;
         nEjerAnt = nEjerAnt + #330#67;

         |ABRE #332;
         #332#0 = enEmpresa;
         #332#1 = nAnyo;
         #332#2 = nPer;
         #332#3 = 332;
         #332#4 = enComplem;
         #332#5 = 0;
         |LEE 040#332=;
         |SI FSalida ! 0;  |DDEFECTO #332;  |FINSI;
         |CIERRA #332;
         nEjerAnt = nEjerAnt + #332#67;

         |ABRE #310;
         #310#0 = enEmpresa;
         #310#1 = nAnyo;
         #310#2 = nPer;
         #310#3 = 310;
         #310#4 = enComplem;
         #310#5 = 0;
         |LEE 040#310=;
         |SI FSalida ! 0;  |DDEFECTO #310;  |FINSI;
         |CIERRA #310;
         nEjerAnt = nEjerAnt + #310#38;
|FPRC;

|PROCESO RecogeAnter;

     nEjerAnt = 0;
     |ABRE #4;
     #4#0 = enEmpresa;
     #4#3 = enModelo;
     #4#4 = enComplem;
     |SI enPeriodo = 3;
         nAnyo = enEjer - 1;
         nPer  = 12;
     |SINO;
         nAnyo = enEjer;
         nPer  = enPeriodo - 3;
     |FINSI;

     |DDEFECTO #0;
     #0#0 = enEmpresa;
     #0#1 = nAnyo;
     #0#2 = nPer;
     #0#3 = enModelo;
     #0#4 = enComplem;
     #0#5 = 0;
     |LEE 001#0=;
     |SI FSalida = 0;
         nEjerAnt = #0#84;
     |SINO;
         |HAZ LeeOtrosMod;
     |FINSI;

     |CIERRA #4;

     |ABRE #47;
     #47#0 = enEmpresa;
     #47#1 = enEjer;
     #47#2 = enPeriodo;
     #47#3 = enModelo;
     #47#4 = enComplem;
     #47#5 = 0;
     |LEE 040#47=;
     |SI FSalida ! 0;  |DDEFECTO #47;  |FINSI;
     |CIERRA #47;

     |ABRE #28;
     #28#0 = enEmpresa;
     #28#1 = enEjer;
     #28#2 = enPeriodo;
     #28#3 = enModelo;
     #28#4 = enComplem;
     #28#5 = 0;
     |LEE 040#28=;
     |SI FSalida ! 0;  |DDEFECTO #28;  |FINSI;
     |CIERRA #28;

     |SI #28#7 = "N";  |ACABA;  |FINSI;

     nEjerAnt = nEjerAnt - #28#6;
     |SI nEjerAnt < 0;  nEjerAnt = 0;  |FINSI;
|FPRC;

|| ///////// Modelo 370 \\\\\\\\\\\\

|PROCESO GrabaDevengado370;
     |SI #1nCampo3 = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #0nCampo22 = #1nCampo2;
               #0nCampo11 = #0nCampo11 + #1nCampo1;
               #0nCampo33 = #0nCampo33 + #1nCampo3;
               nSwAcum = 1;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #0nCampo22 = 0;
                   #0nCampo11 = #1nCampo1;
                   #0nCampo22 = #1nCampo2;
                   #0nCampo33 = #1nCampo3;
                   nSwAcum = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #0nCampo11 = #0nCampo11 + #1nCampo1;
         #0nCampo22 = -1;
         #0nCampo33 = #0nCampo33 + #1nCampo3;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible370;
     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #0nDesde = #0nDesde - (#1#14 + #1#17 + #1#20 + #1#23);
         #0nHasta = #0nHasta - (#1#16 + #1#19 + #1#22 + #1#25);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 46;  |Y nDesde ! 48;
         |SI nHasta ! -1;
             #0nDesde = #0nDesde + ((#1#14 + #1#17 + #1#20 + #1#23) % nProrrata) + nBaseMas;
             #0nHasta = #0nHasta + ((#1#16 + #1#19 + #1#22 + #1#25) % nProrrata) + nCuotaMas;
         |SINO;
             #0nDesde = #0nDesde + ((#1#16 + #1#19 + #1#22 + #1#25) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #0nDesde = #0nDesde + (#1#14 + #1#17 + #1#20 + #1#23);
         #0nHasta = #0nHasta + (#1#16 + #1#19 + #1#22 + #1#25);
     |FINSI;
|FPRC;

|PROCESO GrabaParte1;
     enExistencia = 1;
     nDesde       = 0;
     nHasta       = 0;

     |SI #1#6 = 1;  |Y #1#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #1#6 = 1;  |Y #1#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #1#6 = 1;  |Y #1#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #1#6 = 1;  |Y #1#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #1#6 = 1;  |Y #1#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #1#6 = 1;  |Y #1#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #1#6 = 1;  |Y #1#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #1#6 = 1;  |Y #1#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #1nCampo1 ! 0;  |O #1nCampo2 ! 0;  |O #1nCampo3 ! 0;
                   |HAZ GrabaDevengado370;
               |FINSI;
         |SIGUE;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #0nCampo1 = -1;  #0nCampo1 = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #1#6 = 2;  |Y #1#7 = 1;   nDesde = 34;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 2;   nDesde = 36;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 3;   nDesde = 40;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 4;   nDesde = 42;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 5;   nDesde = 46;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 6;   nDesde = 48;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 7;   nDesde = 52;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 9;   nDesde = 54;  nHasta = -1;  |FINSI;
     |SI #1#6 = 2;  |Y #1#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible370;
     |FINSI;

     |SI #1#6 = 3;  |Y #1#7 = 9;
         #0#83 = #0#83 + #1#12;
     |FINSI;
|FPRC;

|PROCESO LeeRestoPror;

 |ABRE #165;
 #165#0 = #1#0;
 #165#1 = #1#1;
 #165#2 = #1#2;
 #165#3 = #1#3;
 #165#4 = #1#4;
 #165#5 = #1#5;
 #165#6 = #1#6;
 #165#7 = #1#7;
 |LEE 001#165=;
 |SI FSalida = 0;
     nBaseMas  = #165#10 + #165#13 + #165#16 + #165#19;
     nCuotaMas = #165#12 + #165#15 + #165#18 + #165#21;
 |FINSI;
 |CIERRA #165;
|FPRC;

|PROCESO GrabaModParte1;

     enImpIvaSop = 0;
     enImpIvaSub = 0;
     enIvaSopDed = 0;
     nBaseMas  = 0;
     nCuotaMas = 0;

     |SI #1#6 = 2;
         |SI #1#7 ! 5; |Y #1#7 ! 6;
             |HAZ LeeRestoPror;
             |SI #1#7 ! 10; |Y #1#7 ! 11; |Y #1#7 ! 12;
                 enIvaSopDed = (#1#16 + #1#19 + #1#22 + #1#25) % nProrrata + nCuotaMas;
             |FINSI;
         |FINSI;
         |SI #1#7 = 10;
             enImpIvaSop = #1#13 + nCuotaMas;
         |FINSI;
         |SI #1#7 = 11;
             enImpIvaSub = #1#13;
             enIvaSopDed = - (#1#16 + #1#19 + #1#22 + #1#25);
         |FINSI;
         |SI #1#7 = 12; |ACABA; |FINSI;
     |FINSI;

     |SI #1#12 = 0;  |Y #1#13 = 0;  |Y nCuotaMas = 0; |ACABA;  |FINSI;

     |SI #1#6 = 5;  |Y #1#7 = 6;  |Y nEjerAnt = 0;
         nEjerAnt = #1#12;
     |FINSI;

     |HAZ GrabaParte1;
     |SI enImpIvaSop ! 0; |O enImpIvaSub ! 0; |O enIvaSopDed ! 0;
         |SI enEjer < enEjerPro; |HAZ Grabarm029; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsmociva;
     #1#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01, 0,  0;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 99, 9, 99;
     be;
     NULL, GrabaModParte1;
|FIN;

|PROCESO GrabaModParte2;
     enExistencia = 1;
     #0#72 = #0#72 + #2#10;
     #0#73 = #0#73 + #2#11;
     #0#74 = #0#74 + #2#12;

     #0#76 = #0#76 + #2#13;
     #0#77 = #0#77 + #2#14;

     #0#83 = #0#83 + #2#15;

     |SI #2#16 ! 0;  nEjerAnt = #2#16;  |FINSI;

     |SI #2#8 = "N";
         |SI #0#57 = "    ";  |Y #0#58 = 0;
             #0#57 = #2#6;
             #0#58 = #2#9;
             |ACABA;
         |FINSI;

         |SI #0#59 = "    ";  |Y #0#60 = 0;
             #0#59 = #2#6;
             #0#60 = #2#9;
             |ACABA;
         |FINSI;

         |SI #0#61 = "    ";  |Y #0#62 = 0;
             #0#61 = #2#6;
             #0#62 = #2#9;
             |ACABA;
         |FINSI;

         #0#61 = "";
         #0#62 = #0#62 + #2#9;
     |FINSI;

     |SI #2#8 = "S";
         |SI #0#63 = "                                        ";  |Y #0#64 = 0;
             #0#63 = #2#7;
             #0#64 = #2#9;
             |ACABA;
         |FINSI;

         |SI #0#65 = "                                        ";  |Y #0#66 = 0;
             #0#65 = #2#7;
             #0#66 = #2#9;
             |ACABA;
         |FINSI;

         |SI #0#67 = "                                        ";  |Y #0#68 = 0;
             #0#67 = #2#7;
             #0#68 = #2#9;
             |ACABA;
         |FINSI;

         #0#67 = "";
         #0#68 = #0#68 + #2#9;
     |FINSI;
|FPRC;

|DEFBUCLE dsmoc310;
     #2#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 99;
     be;
     NULL, GrabaModParte2;
|FIN;

|PROCESO IngreRealizados;
     #4#0 = #2#0;
     #4#1 = #2#1;
     #4#2 = #2#2;
     #4#3 = #2#3;
     #4#4 = #2#4;
     |LEE 040#4=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #0#70 = #0#70 + #2#9;
|FPRC;

|DEFBUCLE dsmoc310R;
     #2#1;
     ;
     enEmpresa, enEjer, 3, 000, enComplem, 01;
     enEmpresa, enEjer, 9, 999, enComplem, 99;
     be;
     NULL, IngreRealizados;
|FIN;

|PROCESO Totales370;
     #0#87 = nPro;
     #0#88 = eaProrrat;

     #0#33 = #0#8  + #0#11 + #0#14 + #0#17 + #0#20 + #0#23 + #0#26 + #0#29 + #0#32;

|| aplicar nueva Prorrata
     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #0#35 = #0#35 - (enImpProrrata - enImpProrrat8);
          |SINO;
              #0#35 = #0#35 - enImpProrrat1;
              #0#37 = #0#37 - enImpProrrat2;
              #0#41 = #0#41 - enImpProrrat3;
              #0#43 = #0#43 - enImpProrrat4;
              #0#47 = #0#47 - enImpProrrat5;
              #0#49 = #0#49 - enImpProrrat6;
              #0#53 = #0#53 - enImpProrrat7;
          |FINSI;
     |FINSI;
|| ....
|| Regularizacion Manual
     #0#35 = #0#35 - #47#6;
     #0#37 = #0#37 - #47#7;
     #0#41 = #0#41 - #47#8;
     #0#43 = #0#43 - #47#9;
     #0#47 = #0#47 - #47#10;
     #0#49 = #0#49 - #47#11;
     #0#53 = #0#53 - #47#12;
|| ....
     #0#38 = #0#34 + #0#36;
     #0#39 = #0#35 + #0#37;
     #0#44 = #0#40 + #0#42;
     #0#45 = #0#41 + #0#43;
     #0#50 = #0#46 + #0#48;
     #0#51 = #0#47 + #0#49;
     #0#55 = #0#39 + #0#45 + #0#51 + #0#53 + #0#54;
     #0#56 = #0#33 - #0#55;

     |SI #0#2 = 12;
         #0#70 = 0;
         |ABRE #4;
         |BUCLE dsmoc310R;
         |CIERRA #4;
     |FINSI;

     |SI enEjer ] enEjerPro;
          #0#76 = #0#76 - enImpProrrat8;
     |FINSI;

     #0#69 = #0#58 + #0#60 + #0#62 + #0#64 + #0#66 + #0#68;
     #0#71 = #0#69 - #0#70;
     #0#75 = #0#71 + #0#72 + #0#73 + #0#74;
     #0#78 = #0#76 + #0#77;
     #0#79 = #0#75 - #0#78;

     #0#80 = #0#56 + #0#79;
     #0#82 = #0#80 - #0#81;

     |SI #0#82 > 0;
         #0#86 = #0#82;
         #0#84 = 0;
         #0#85 = 0;
     |SINO;
         |SI #0#2 = 12;
             |HAZ UltimoPeriodo;
             |SI eaUltimoPer = "COMPENSAR";
                 #0#84 = -#0#82;
                 #0#85 = 0;
                 #0#86 = 0;
             |SINO;
                 #0#85 = -#0#82;
                 #0#84 = 0;
                 #0#86 = 0;
             |FINSI;
         |SINO;
             #0#84 = -#0#82;
             #0#85 = 0;
             #0#86 = 0;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Modelo370;
     |HAZ eLeeLaProrrata;
     nPro = nProrrata;
     |SI enEjer ] enEjerPro;  nProrrata = 100; |FINSI;

     |ABRE #0;

     #0#0 = enEmpresa;
     #0#1 = enEjer;
     #0#2 = enPeriodo;
     #0#3 = enModelo;
     #0#4 = enComplem;
     #0#5 = 0;
     |LEE 101#0=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;
         |DDEFECTO #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = 0;

         #0#81 = nEjerAnt;
         |GRABA 020#0b;
     |FINSI;

     nEjerAnt  = #0#81;
     nContador = 0;

     enExistencia = 0;
     |BUCLE dsmociva;
     |BUCLE dsmoc310;

     |SI enExistencia = 0;
         |BORRA 020#0a;
         |LIBERA #0;
         |ACABA;
     |FINSI;

     #0#81 = nEjerAnt;

     |HAZ Totales370;

     |GRABA 020#0a;
     |LIBERA #0;

     |CIERRA #0;

     enExistencia = 1;
|FPRC;

|PROGRAMA;
    |HAZ LeeCtrlProrr;
    eaNomDef = "dsmod370";

|| \\\\\\ Consulta del Modelo ////////

     |SI enTipoEntrada = 4;              || Consulta del Modelo
         |CABEZA "Modelo 370";
         |HAZ SacaPantallas;
         |ACABA;
     |FINSI;

|| \\\\\\ Alta del Modelo ////////

     |SI enTipoEntrada = 98;  |O enTipoEntrada = 91;             || Alta del Modelo
         |ABRE #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = 0;
         |LEE 101#0=;
         |SI FSalida = 0;
             |BORRA 020#0a;
             |LIBERA #0;
         |FINSI;
         |CIERRA #0;

         enExistencia = 0;
         |HAZ Modelo370;
         |ACABA;
     |FINSI;

|| \\\\\\ Comprobacion Existencia del Modelo

     |SI enTipoEntrada = 99;              || Existencia del Modelo ????
         |ABRE #0;
         #0#0 = enEmpresa;
         #0#1 = enEjer;
         #0#2 = enPeriodo;
         #0#3 = enModelo;
         #0#4 = enComplem;
         #0#5 = enActividad;
         |LEE 040#0=;
         |SI FSalida ! 0;  enExistencia = 1;  |DDEFECTO #0; |FINSI;
         |CIERRA #0;

         |SI enActividad = 0;  enResultado = #0#82;  |FINSI;
     |FINSI;
|FPRO;
