f|FICHEROS;
    dsmoz056 #0;

    dsmom041 #41;
    dsmom042 #42;

    dsmow030 #900;
|FIN;

|VARIABLES;
  nDEmpresa   = 0;
  nHEmpresa   = 0;
  nDActividad = 0;
  nHActividad = 0;
  nCampo      = 0;

  &nCamSel    = 18;
  &nCamTip    = 31;

  ele1        = "";
  ele2        = "";
  nnum1       = 0;
  nnum2       = 0;

  aAlfa1      = "";
  aAlfa2      = "";
  nNume1      = 0;
  nNume2      = 0;
  nPara1      = 0;

  fFechaIni   = @;
  fFechaFin   = @;
  fFechaFinP  = @;

  fFecha      = @;
  informe     = "dsmoz056";
  nSwOp       = 0;
  nSwError    = 0;
  aDTipo      = "";
  aHTipo      = "";

  sw          = 0;
  nLaEmpresa  = 0;
  swBueno     = 0;
  &enError    = 0;
  &eaError    = "";
  &eaRecup    = "";
  &eaTitulo   = "";
  &enAnyI     = 0;

  nSwPost     = 0;
  nDEjer      = 0;
  nHEjer      = 0;
  nDAny       = 0;
  nHAny       = 0;

  nAnyV       = 0;
  nAnyA       = 0;
  nAnyUlA     = 0;

  nImporte    = 0;
  nRestof     = 0;
  nRestoc     = 0;
  nRestC      = 0;
  nRestF      = 0;
  nAcumC      = 0;
  nAcumF      = 0;

  aT          = "";
  nSwCambia   = 0;
  afiscal     = 0;
  acontab     = 0;
  nCamLin    = 0;
  fFechaD    = @;
  aSiCont    = "";
  fPrimLinea = @;
  nPrimLinea = 0;
  &enDatos   = 0;

  nEstado    = 0;
  nAnterior  = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_selcon;
|INCLUYE i_numamo;
|INCLUYE i_calamo;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #0#4 = enEmpresa; |PINTA #0#4;
         #0#5 = enEmpresa; |PINTA #0#5;

         |C_M #0#4, 1, "N";
         |C_M #0#5, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla;
     |SI #0#4 = 0;
         #0#4 = 0;  |PINTA #0#4;
         #0#5 = 0;  |PINTA #0#5;  |C_M #0#5, 1, "N";
         |PARA nCampo = 6;  |SI nCampo [ 17;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#4, 1, "S";
             |C_M #0#5, 1, "S";
         |FINSI;

         |PARA nCampo = 6;  |SI nCampo [ 17;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 17;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 17;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO numamo; |TIPO 0;
   x_alfa1 = #0Campo;
   |HAZ x_punto;
   #0Campo = x_alfa1;
   |PINTA #0Campo;
|FCAL;

|CALCULO defecto; |TIPO 7;
 fFecha = ~;
 aAlfa1 = fFecha;
 aAlfa1 = aAlfa1 % -104;
 #0#36 = aAlfa1;
 |PINTA #0#36;
|FCAL;

|| /////////////////////////// Procesos \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO CalLineas;

  nPrimLinea = nPrimLinea + 1;
  nRestC = importe - nAcumC;
  nRestF = importe - nAcumF;

  |ABRE #42;
  |DDEFECTO #42;
  #42#0 = #41#0;
  #42#1 = #41#1;
  #42#2 = #41#2;
  #42#3 = #41#3;
  #42#4 = nPrimLinea;
  |LEE 040#42=;
  nEstado = FSalida;
  #42#0 = #41#0;
  #42#1 = #41#1;
  #42#2 = #41#2;
  #42#3 = #41#3;
  #42#4 = nPrimLinea;

  fFechaAmor = efFecTope;
  nAnyAmor   = nAnyA;
  |SI nRestC ! 0;
      nCamLin = 11;
      nImpAmor = 0;
      aT = "C";
      eaTipoA = #41#19;
      enTP100 = #41#20;
      enAnys  = #41#23;
      nRest   = nRestC;
      |HAZ Calculo;
      #42nCamLin = nImpAmor;
  |FINSI;

  |SI nRestF ! 0;
      nCamLin    = 7;
      nImpAmor   = 0;
      aT = "F";
      eaTipoA = #41#13;
      enTP100 = #41#14;
      enAnys  = #41#17;
      nRest   = nRestF;
      |HAZ Calculo;
      #42nCamLin = nImpAmor;
  |FINSI;

  |SI #42#7 ! 0; |O #42#11 ! 0;
      #42#5 = nAnyA; aAlfa1 = #42#5;
      #42#6 = "A";
      #42#8 = "S";
      #42#9 = fFechaAmor;
      #42#10 = "AMORTIZACION EJERCICIO " + aAlfa1;
      #42#12 = nAnterior;
      #42#13 = #42#11 - #42#7;
      |SI nEstado = 0; |GRABA 020#42a; |FINSI;
      |SI nEstado ! 0; |GRABA 020#42n; |FINSI;
      nSwCambia   = 1;
      eaRecup     = "SI";
  |FINSI;
  |LIBERA #42;
  |CIERRA #42;

  |SI aT = "F"; nRestof = nRestof - #42#7;  |FINSI;
  |SI aT = "C"; nRestoc = nRestoc - #42#11; |FINSI;
|FPRC;


|PROCESO VerLineas;
   |SI #42#6 = "A";
       |SI #42#9 < fFechaD;
           nAcumF = nAcumF + #42#7;
           nAcumC = nAcumC + #42#11;
           |SI #42#9 ] ultFechaA;
               ultFechaA = #42#9;
               aUltLinea = "A";
           |FINSI;
           |SI #42#5 < nAnyFin;
               enAcumFiscal = enAcumFiscal + #42#7;
           |FINSI;
           nAnterior  = #42#12;
       |FINSI;
       |SI #42#9 > fFechaD;
           nSwPost = 1;
           |ERROR10;
       |FINSI;
   |FINSI;
   nPrimLinea = #42#4;
|FPRC;

|DEFBUCLE VerLineas;
   #42#1;
   ;
   #41#0, #41#2, #41#3, 001;
   #41#0, #41#2, #41#3, 999;
   e;
   NULL, VerLineas;
|FIN;

|PROCESO Registra;

  aAlfa1 = nAnyA;
  aAlfa1 = "31.12."+ aAlfa1;
  efFecTope = aAlfa1;

  cfecha  = #41#9;
  importe = #41#10;
  vfecha  = #41#26;

 enCodOpe = #41#36;
 fFinPago = #41#37;
 enMulFis = #41#39;
 aAlfa1   = fFinPago;
 aAlfa1   = aAlfa1 % -104;
 nAnyFin  = aAlfa1;
 enAcumFiscal = 0;
 fFechaD = efFecTope;

  nSwPost    = 0;
  ultFechaA  = cfecha;
  aUltLinea  = "C";
  nAcumC     = 0;
  nRestC     = 0;
  nAcumF     = 0;
  nRestF     = 0;
  nPrimLinea = 0;
  nAnterior  = 97;
  |BUCLE VerLineas;
  |SI nPrimLinea ! 0;
      |SI nSwPost = 0; |Y #0#37 = "S";
          |HAZ CalLineas;
      |FINSI;
  |FINSI;
|FPRC;

|| *********************************************************************
|PROCESO L_Amortiza;
   sw = 1;
   |SI nSwOp = 0;
       |ERROR10;
       |ACABA;
   |FINSI;

   |SI nSwOp = 1;
       |SI #42#6 = "A";
           afiscal = (afiscal + #42#7) ! EURODBMOD;
           acontab = (acontab + #42#11) ! EURODBMOD;
           |SI ultFechaA < #42#9; nAnyUlA = #42#5; ultFechaA = #42#9; |FINSI;
      |FINSI;
      |SI #42#6 = "V"; vfecha = #42#9; |FINSI;
  |FINSI;

  |SI nSwOp = 2;
     nRestof = (nRestof - #42#7) ! EURODBMOD;
     nRestoc = (nRestoc - #42#11) ! EURODBMOD;
     |SI nRestof < 0; nRestof = 0; |FINSI;
     |SI nRestoc < 0; nRestoc = 0; |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE RLineas;
   #42#1;
   6,5;
   #41#0, #41#2, #41#3, 000, aDTipo, nDAny;
   #41#0, #41#2, #41#3, 999, aHTipo, nHAny;
   ;
   NULL, L_Amortiza;
|FIN;

|PROCESO GrabaCab;
   importe = #41#10;
   vfecha  = #41#26;
   nNume1  = #41#16;
   nNume2  = #41#22;
   sw      = 0;
   nSwOp   = 1;
   afiscal = 0;
   acontab = 0;
   ultFechaA = "01.01.0000";
   aDTipo = "A"; nDAny = 1900;
   aHTipo = "Z"; nHAny = 2999;
   |BUCLE RLineas;
   |SI sw = 1;
       #41#15 = afiscal;
       #41#16 = importe - afiscal; |SI #41#16 < 0; #41#16 = 0; |FINSI;
       #41#21 = acontab;
       #41#22 = importe - acontab; |SI #41#22 < 0; #41#22 = 0; |FINSI;
       |SI #41#26 > "01.01.1900";
           #41#16 = nNume1;
           #41#22 = nNume2;

           || |SI ultFechaA ] #41#26; || no lo dejamos a cero
              || #41#16 = 0;
              || #41#22 = 0;
           || |FINSI;
       |FINSI;
       |GRABA 020#41a;
   |FINSI;
|FPRC;

|PROCESO C_Amortiza;

   |SI nLaEmpresa ! #41#0;
       |SI nLaEmpresa ! -1;
           |SI enError ! 0; |PIEINF; |FINSI;
       |FINSI;
       enError    = 0;
       nLaEmpresa = #41#0;
       enEmpresa  = #41#0;
       swBueno    = 0;
       |HAZ LaSelEmpresa;
       |SI enSwSelEmp = 1; swBueno = 1;  |FINSI;
       |SI enDatos = 1;
            enActividad = 0;
            |HAZ DatosEmpr_w30;
       |FINSI;
   |FINSI;
   |SI swBueno = 1; |ACABA; |FINSI;

|| .... .... .... .... .... .... Proceso por cada elemento
   nSwCambia = 0;
   nAnyV     = 0;
   nAnyUlA   = 0;
   eaError   = "";
   nSwError  = 0;
   #0#3 = #41#0; |PINTA #0#3;
   #0#1 = #41#2; |PINTA #0#1;
   #0#2 = #41#3; |PINTA #0#2;

   vfecha    = #41#26;
   nImporte  = #41#10;
   afiscal   = 0;
   acontab   = 0;
   nRestof   = #41#10;
   nRestoc   = #41#10;

   fFechaIni = #41#27;  || Fecha de compra, inicio comprobacion
   fFechaFin = fFechaFinP;
   |SI vfecha > "01.01.0001";
       aAlfa1 = vfecha;
       aAlfa1 = aAlfa1 % -104;
       nAnyV  = aAlfa1;
       |SI vfecha < fFechaFinP; fFechaFin = vfecha; |FINSI;
   |FINSI;

   sw     = 0;
   nSwOp  = 0;
   aDTipo = "C"; nDAny  = 1900;
   aHTipo = "C"; nHAny  = 2999;
   |BUCLE RLineas;
   |SI sw = 0;
       eaError = "NO EXISTE LINEA DE COMPRA DEL ELEMENTO";
       eaRecup = "NO";
       |PRINT;
       nSwError = 1;
   |FINSI;

   |SI #41#35 = "N";
       |SI #41#9 < #41#27; |Y #41#9 > "01.01.0001";
           eaError = "FECHA INICIO DEL BIEN INFERIOR A LA FECHA COMPRA";
           eaRecup = "NO";
           |PRINT;
           nSwError = 1;
       |FINSI;
       |SI #41#9 < "01.01.0001";
           eaError = "NO INFORMADA LA FECHA INICIO DEL BIEN";
           eaRecup = "NO";
           |PRINT;
           nSwError = 1;
       |FINSI;
       |SI #41#9 > "01.01.0001";
           fFechaIni = #41#9;
       |FINSI;
   |SINO;
       sw       = 0;
       nSwOp    = 0;
       aDTipo   = "A"; nDAny = 1900;
       aHTipo   = "A"; nHAny = 2999;
       |BUCLE RLineas;
       |SI sw = 1;
           eaError = "HAY LINEAS DE AMORTIZACION Y EL ELEMENTO ESTA EN CURSO";
           eaRecup = "NO";
           |PRINT;
           nSwError = 1;
       |FINSI;
   |FINSI;

   sw      = 0;
   nSwOp   = 1;
   ultFechaA = "01.01.0000";
   aDTipo = "A"; nDAny = 1900;
   aHTipo = "A"; nHAny = 2999;
   |BUCLE RLineas;

   |SI #41#40 = "I";
       |SI #41#16 ! 0; |O #41#22 ! 0;
           |SI nAnyV = 0;
               eaError = "ELEMENTO AMORTIZABLE INACTIVO PERO CON VALOR RESIDUAL ";
               eaRecup = "NO";
               |PRINT;
               nSwError = 1;
           |FINSI;
       |FINSI;
   |FINSI;

   aAlfa1 = fFechaIni; aAlfa1 = aAlfa1 % -104; nDEjer = aAlfa1;
   aAlfa2 = fFechaFin; aAlfa2 = aAlfa2 % -104; nHEjer = aAlfa2;

   |SI #41#35 = "N";

       |PARA nPara1 = nDEjer; |SI nPara1 [ nHEjer; |HACIENDO nPara1 = nPara1 + 1;

             |SI #41#40 = "I";
                 |SI nPara1 > nAnyUlA;
                     |VETE AlSigue;
                 |FINSI;
             |FINSI;

             |SI nRestof ! 0; |O nRestoc ! 0;
                 nSwOp  = 2;
                 sw     = 0;
                 aDTipo = "A"; nDAny  = nPara1;
                 aHTipo = "A"; nHAny  = nPara1;
                 |BUCLE RLineas;
                 |SI sw = 0;
                     aAlfa1  = nPara1;
                     eaRecup = "NO";
                     eaError = "NO EXISTE LINEA DE AMORTIZACION DEL A力 " + aAlfa1;
                     |SI nPara1 = nAnyV;
                         eaError = "NO EXISTE LINEA DE AMORTIZACION DEL A力 " + aAlfa1 + ", A力 DE LA VENTA";
                     |FINSI;
                     nSwError = 1;
                     nAnyA = nPara1;
                     |HAZ Registra;
                     |SI nSwPost = 1;
                         eaError = eaError + ", PERO SI DE A力S POSTERIORES";
                     |FINSI;
                     |PRINT;
                 |FINSI;

             |SINO;

                 nSwOp  = 0;
                 sw     = 0;
                 aDTipo = "A"; nDAny  = nPara1;
                 aHTipo = "A"; nHAny  = nPara1;
                 |BUCLE RLineas;
                 |SI sw = 1;
                     aAlfa1   = nPara1;
                     eaRecup  = "NO";
                     eaError  = "EXISTE LINEA DE AMORTIZACION DEL A力 " + aAlfa1 + ", Y EL ELEMENTO YA ESTA AMORTIZADO";
                     nSwError = 1;
                     |PRINT;
                 |FINSI;

             |FINSI;
             |ET AlSigue;
       |SIGUE;

   |FINSI;

   |SI vfecha > "01.01.0001";
       |SI #41#16 ! 0; eaError = "ELEMENTO VENDIDO, PERO TIENE AUN VALOR RESIDUAL EN AMORTIZACION FISCAL";   |FINSI;
       |SI #41#22 ! 0; eaError = "ELEMENTO VENDIDO, PERO TIENE AUN VALOR RESIDUAL EN AMORTIZACION CONTABLE"; |FINSI;
       |SI #41#16 ! 0; |Y #41#22 ! 0;
           eaError = "ELEMENTO VENDIDO, PERO TIENE AUN VALOR RESIDUAL";
       |FINSI;
       eaRecup = "NO";
       |SI #41#16 ! 0; |O #41#22 ! 0;
           |PRINT;
           nSwError = 1;
       |FINSI;
       nSwOp  = 0;
       sw     = 0;
       aDTipo = "V"; nDAny = nAnyV;
       aHTipo = "V"; nHAny = nAnyV;
       |BUCLE RLineas;
       |SI sw = 0;
           eaError = "NO EXISTE LINEA DE VENTA DEL ELEMENTO";
           eaRecup = "NO";
           |PRINT;
           nSwError = 1;
       |FINSI;
   |FINSI;

   |SI nSwCambia = 1;
       |HAZ GrabaCab;
   |FINSI;
   |LIBERA #41;
   |SI nSwError = 1;
       enError = enError + 1;
   |FINSI;
|FPRC;

|DEFBUCLE dsmoz056;
   #41#1;
   1;
   nDEmpresa, ele1, nnum1, nDActividad;
   nHEmpresa, ele2, nnum2, nHActividad;
   e;
   NULL, C_Amortiza;
|FIN;


|CALCULO Tipo3;  |TIPO 3;
  eaTitulo   = #0#38;
  efFechaI   = #0#39;
  enAnyI     = #0#36;

  |HAZ LeeEURODBMOD;
  nT600 = 100000;
  |SI EURODBMOD = 2;
      nT600 = (nT600 / 166.386) ! EURODBMOD;
  |FINSI;

   aAlfa1    = #0#36;
   aAlfa1    = "31.12." + aAlfa1;
   fFechaFinP  = aAlfa1;
   nDActividad = 00;
   nHActividad = 99;
   ele1  = #0#32;
   ele2  = #0#33;
   nnum1 = #0#34;
   nnum2 = #0#35;

   |IMPRE 0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |INFOR informe;
   |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;


   |SI #0#4 ! 0;
       nDEmpresa = #0#4;
       nHEmpresa = #0#5;
       nLaEmpresa = -1;
       swBueno = 0;
       |BUCLE dsmoz056;
       |SI enError ! 0; |PIEINF; |FINSI;
   |SINO;
       |PARA nCampo = 6; |SI nCampo [ 17;  |HACIENDO nCampo = nCampo + 1;
             |SI #0nCampo ! 0;
                 nDEmpresa = #0nCampo;
                 nHEmpresa = #0nCampo;
                 nLaEmpresa = -1;
                 swBueno = 0;
                 |BUCLE dsmoz056;
                 |SI enError ! 0; |PIEINF; |FINSI;
             |FINSI;
       |SIGUE;
   |FINSI;

   |FININF;
   |FINIMP;
|FCAL;
