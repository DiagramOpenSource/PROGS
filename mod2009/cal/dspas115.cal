|FICHEROS;
     dsmozpas #0;
     dsmom002 #2;
     dsmom004 #4;
     dsmom008 #8;
     dsmom030 #30;
     dsmoc115 #100;

     :/contagen/def/canempre #101;
     :/contagen/def/camaniva #102;
     :/contagen/def/caivalin #103;
     :/contagen/def/caivaasi #104;

     dsmow013 #999,MANTE;
     espejo1@ #1300;
|FIN;

|VARIABLES;
     aTodoCero="";
     aNombreTrabajador="";
     aCadena="";
     nMesLugar=0;
     nSalida=0;
     fFechaCamaniva=@;
     nImporteBaseI=0;
     nPorcentaje=0;
     nImporteRetencion=0;
     aEspecie="";
     aDni="";
     aDn="            ";
     aHn="zzzzzzzzzzzz";

     aAlfa          = "";
     aPathModelo    = "";
     aDef           = "";
     aTipo          = "";

     nEjer          = 0;
     nDPeriodo      = 0;
     nHPeriodo      = 0;
     nCampo1        = 0;
     nCampo11       = 0;
     nCampo2        = 0;
     nCampo22       = 0;
     nCampo3        = 0;
     nCampo33       = 0;
     nSwEsta        = 0;
     nGrupo         = 0;
     nSubGrupo      = 0;
     nDepar         = 0;
     nBaseImpo      = 0;
     nPorce         = 0;
     nCuota         = 0;
     nPeriodo       = 0;
     nModelo        = 0;
     nSwPasa        = 0;
     nDComplem      = 0;
     nHComplem      = 0;
     nAnyo          = 0;
     nCampo         = 0;
|FIN;

|INCLUYE i_variar;

|PROCESO MiraCampos115;
     aTodoCero="S";
     |PARA nCampo1 = 8;  |SI nCampo1 [ 25;  |HACIENDO nCampo1 = nCampo1 + 1;
          |SI #100nCampo1!0;
               aTodoCero="N";
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Grabadsmoc115;
     |DDEFECTO #100;
     #100#0 = enEmpresa;
     #100#1 = enEjer;
     #100#2 = enPeriodo;
     #100#3 = enModelo;
     #100#4 = enComplem;
     #100#5 = enActividad;
     #100#6 = aDni;
     #100#7 = 0;
     |LEE 000#100=;
     nSalida=FSalida;

     |SI #104#46 ! "T";
          |SI aEspecie="N";
               #100#8=#100#8+nImporteBaseI;
               #100#10=#100#10+nImporteRetencion;
               nPorcentaje=(#100#10/#100#8)*100;
               #100#9=nPorcentaje;
          |SINO;
               #100#11=#100#11+nImporteBaseI;
               #100#13=#100#13+nImporteRetencion;
               nPorcentaje=(#100#13/#100#11)*100;
               #100#12=nPorcentaje;
          |FINSI;
     |SINO;
          |SI aEspecie="N";
               |SI nMesLugar=1;|O nMesLugar=4; |O nMesLugar=7; |O nMesLugar=10;
                    #100#8=#100#8+nImporteBaseI;
                    #100#10=#100#10+nImporteRetencion;
                    nPorcentaje=(#100#10/#100#8)*100;
                    #100#9=nPorcentaje;
               |FINSI;
               |SI nMesLugar=2;|O nMesLugar=5; |O nMesLugar=8; |O nMesLugar=11;
                    #100#14=#100#14+nImporteBaseI;
                    #100#16=#100#16+nImporteRetencion;
                    nPorcentaje=(#100#16/#100#14)*100;
                    #100#15=nPorcentaje;
               |FINSI;
               |SI nMesLugar=3;|O nMesLugar=6; |O nMesLugar=9; |O nMesLugar=12;
                    #100#20=#100#20+nImporteBaseI;
                    #100#22=#100#22+nImporteRetencion;
                    nPorcentaje=(#100#22/#100#20)*100;
                    #100#21=nPorcentaje;
               |FINSI;
          |SINO;
               |SI nMesLugar=1;|O nMesLugar=4; |O nMesLugar=7; |O nMesLugar=10;
                    #100#11=#100#11+nImporteBaseI;
                    #100#13=#100#13+nImporteRetencion;
                    nPorcentaje=(#100#13/#100#11)*100;
                    #100#12=nPorcentaje;
               |FINSI;
               |SI nMesLugar=2;|O nMesLugar=5; |O nMesLugar=8; |O nMesLugar=11;
                    #100#17=#100#17+nImporteBaseI;
                    #100#19=#100#19+nImporteRetencion;
                    nPorcentaje=(#100#19/#100#17)*100;
                    #100#18=nPorcentaje;
               |FINSI;
               |SI nMesLugar=3;|O nMesLugar=6; |O nMesLugar=9; |O nMesLugar=12;
                    #100#23=#100#23+nImporteBaseI;
                    #100#25=#100#25+nImporteRetencion;
                    nPorcentaje=(#100#25/#100#23)*100;
                    #100#24=nPorcentaje;
               |FINSI;
          |FINSI;
     |FINSI;

     #100#26=aNombreTrabajador;

     |SI nSalida=0;
          |GRABA 020#100a;
     |SINO;
          |GRABA 020#100n;
     |FINSI;
|FPRC;

|PROCESO LeeLinea115;
     #30#0=#103#18;
     |LEE 000#30=;
     |SI FSalida!0; |ACABA; |FINSI;

     |SI #30#5  ! "S";  |ACABA;  |FINSI;
     |SI #30#38 ! 180;  |ACABA;  |FINSI;

     aDni              = #102#14;
     aNombreTrabajador = #102#13;

     nImporteBaseI     = (#103#20 / enConversor) ! EURODBMOD;
     nPorcentaje       = #103#21;
     nImporteRetencion = (#103#22 / enConversor) ! EURODBMOD;

     fFechaCamaniva    = #102#8;
     aCadena           = fFechaCamaniva % 402;
     nMesLugar         = aCadena;

     aEspecie          = #103#26;

     |SI nImporteBaseI ! 0; |O nImporteRetencion ! 0;
          |HAZ Grabadsmoc115;
     |FINSI;
|FPRC;


|DEFBUCLE caivalin115;
     #103#1;
     ;
     #102#0, #102#1, 01;
     #102#0, #102#1, 99;
     ;
     NULL, LeeLinea115;
|FIN;

|PROCESO LeeCabecera115;
     |BUCLE caivalin115;
     |LIBERA #102;
|FPRC;

|DEFBUCLE camaniva115;
     #102#1;
     5;
     00, 0000000000, nDPeriodo;
     99, 9999999999, nHPeriodo;
     be;
     NULL, LeeCabecera115;
|FIN;

|PROCESO Compensa115;
     #100#0 = #1300#0;
     #100#1 = #1300#1;
     #100#2 = #999#3;
     #100#3 = #1300#3;
     #100#4 = #999#9;
     #100#5 = #1300#5;
     #100#6 = #1300#6;
     #100#7 = #1300#7;
     |LEE 101#100=;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0 = #1300#0;
         #100#1 = #1300#1;
         #100#2 = #999#3;
         #100#3 = #1300#3;
         #100#4 = #999#9;
         #100#5 = #1300#5;
         #100#6 = #1300#6;
         #100#7 = #1300#7;
         |GRABA 020#100b;
     |FINSI;

     #100#8=#100#8-#1300#8;
     #100#10=#100#10-#1300#10;
     nPorcentaje=(#100#10/#100#8)*100;
     #100#9=nPorcentaje;

     #100#11=#100#11-#1300#11;
     #100#13=#100#13-#1300#13;
     nPorcentaje=(#100#13/#100#11)*100;
     #100#12=nPorcentaje;

     #100#14=#100#14-#1300#14;
     #100#16=#100#16-#1300#16;
     nPorcentaje=(#100#16/#100#14)*100;
     #100#15=nPorcentaje;

     #100#17=#100#17-#1300#17;
     #100#19=#100#19-#1300#19;
     nPorcentaje=(#100#19/#100#17)*100;
     #100#18=nPorcentaje;

     #100#20=#100#20-#1300#20;
     #100#22=#100#22-#1300#22;
     nPorcentaje=(#100#22/#100#20)*100;
     #100#21=nPorcentaje;

     #100#23=#100#23-#1300#23;
     #100#25=#100#25-#1300#25;
     nPorcentaje=(#100#25/#100#23)*100;
     #100#24=nPorcentaje;

     |GRABA 020#100a;
     |LIBERA #100;

     |HAZ MiraCampos115;  || mira si son todos = 0 o no
     |SI aTodoCero="S";
         |BORRA 020#100a;
     |FINSI;
|FPRC;

|DEFBUCLE Bdsmoc115;
     #1300#1008;
     ;
     #999#0, #999#2, nPeriodo, 115, nDComplem, #999#1, aDn, 0;
     #999#0, #999#2, nPeriodo, 115, nHComplem, #999#1, aHn, 9999;
     ;
     NULL, Compensa115;
|FIN;

|PROCESO Anterior115;
     |PARA nCampo = 0;  |SI nCampo [ 27;  |HACIENDO nCampo = nCampo + 1;
           #100nCampo = #1300nCampo;
     |SIGUE;
     #100#1 = #999#2;
     #100#2 = #999#3;

     |SI #999#1 = 99;
         |PARA nCampo = 8;  |SI nCampo [ 25;  |HACIENDO nCampo = nCampo + 1;
               #100nCampo = 0;
         |SIGUE;
         #100#27 = 0;
     |FINSI;

     |GRABA 020#100n;
     |LIBERA #100;
|FPRC;

|DEFBUCLE dsmoc115A;
     #1300#1008;
     ;
     #999#0, nAnyo, nPeriodo, 115, nDComplem, #999#1, aDn, 0;
     #999#0, nAnyo, nPeriodo, 115, nHComplem, #999#1, aHn, 9999;
     ;
     NULL, Anterior115;
|FIN;

|PROCESO dsmom002_115;
     |ERROR10;
|FPRC;

|DEFBUCLE dsmom002_115;
     #2#1;
     ;
     #999#0,  1, 115;
     #999#0, 98, 115;
     ;
     NULL, dsmom002_115;
|FIN;

|PROCESO PaseAnterior115;
     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/dsmoc115.mas";
     |CARGA_DEF aDef, espejo1@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |BUCLE dsmom002_115;

     |SI FSalida ! 0;  |O #2#0 ! #999#0;  |O #2#2 ! 115;
         |DDEFECTO #2;
     |FINSI;

     nAnyo = #999#2;
     |SI #2#7 = "TRIMESTRAL";
         |SI #999#3 = 3;
             nAnyo = #999#2 - 1;
             nPeriodo = 12;
         |SINO;
             nPeriodo = #999#3 - 3;
         |FINSI;
     |SINO;
         |SI #999#3 = 1;
             nAnyo = #999#2 - 1;
             nPeriodo = 12;
         |SINO;
             nPeriodo = #999#3 - 1;
         |FINSI;
     |FINSI;

     |ABRE #100;
     |BUCLE dsmoc115A;
     |CIERRA #100;

     |DESCARGA_DEF #espejo1@;

     enEmpresa     = #999#0;
     enEjer        = #999#2;
     enPeriodo     = #999#3;
     enModelo      = #999#7;
     enComplem     = #999#9;
     enActividad   = #999#1;
     enTipoEntrada = 98;
     eaNombreAct   = #999#6;
     |SUB_EJECUTA_NP "dsmoc115";

     |ABRE #4;
     #4#0 = #999#0;
     #4#1 = #999#2;
     #4#2 = #999#3;
     #4#3 = #999#7;
     #4#4 = #999#9;
     |LEE 101#4=;
     |SI FSalida = 0;
         |HAZ ChequeaSituacion;  || Esta en el PLB
         #4#9 = " ";
         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO Pase115;
     || borrar dsmoc115 y dsmod115

     |DDEFECTO #8;
     |ABRE #8;
     #8#0 = #999#0;
     #8#1 = #999#2;
     #8#2 = #999#3;
     #8#3 = #999#7;
     #8#4 = #999#9;
     #8#5 = #999#1;
     |LEE 101#8=;
     |SI FSalida = 0;
         #8#11 = "SIN DATOS";
         |GRABA 020#8a;

         enEmpresa     = #8#0;
         enEjer        = #8#1;
         enPeriodo     = #8#2;
         enModelo      = #8#3;
         enComplem     = #8#4;
         enActividad   = #8#5;
         enTipoEntrada = 97;
         |SUB_EJECUTA_NP "dsmoc115";
     |FINSI;
     |LIBERA #8;
     |CIERRA #8;

     |SI enAnterior = 1;         || Recogida de un Periodo Anterior
         |HAZ PaseAnterior115;

         |ACABA;
     |FINSI;

     enEmpresa = #999#0;
     enEjer      = #999#2;
     enSwOpPar   = 0;
     |HAZ SituaEmpresa;
     |SI enSwPartido = 0;
         aAlfa = #999#2;
         aAlfa = aAlfa % -102;
         nEjer = aAlfa;

         |ABRE #101;
         |SELECT #4#101;
         #101#2  = #999#0;
         #101#26 = nEjer;
         |LEE 040#101=;
         |SI FSalida ! 0;  |CIERRA #101;  |ACABA;   |FINSI;
         |CIERRA #101;

          |DBASS aPathConta;   |QBT aPathConta;
          aPathConta = aPathConta + "contagen/fich/" + (("00000" + #101#2) % -105) + #101#3 + "/";

          enEmpresa  = #101#2;
          enPerConta = #101#3;
          eaLaMonEmp = #101#28;
      |SINO;
          enPerConta = enPeriodoPar;
          eaLaMonEmp = "E";
      |FINSI;
      |HAZ EnConversor;


     |PATH_DAT #102 aPathConta;
     |PATH_DAT #103 aPathConta;
     |PATH_DAT #104 aPathConta;

     |ABRE #104;
     |LEE 040#104p;
     |SI FSalida ! 0;  |DDEFECTO #104;  |FINSI;
     aMulDep = #104#132;
     |CIERRA #104;

     |SI #104#46 = "T";
         |SI #0#1 = 1;   nDPeriodo = 1;  nHPeriodo = 1;   |FINSI;
         |SI #0#1 = 2;   nDPeriodo = 1;  nHPeriodo = 1;   |FINSI;
         |SI #0#1 = 3;   nDPeriodo = 1;  nHPeriodo = 1;   |FINSI;
         |SI #0#1 = 4;   nDPeriodo = 1;  nHPeriodo = 2;   |FINSI;
         |SI #0#1 = 5;   nDPeriodo = 1;  nHPeriodo = 2;   |FINSI;
         |SI #0#1 = 6;   nDPeriodo = 1;  nHPeriodo = 2;   |FINSI;
         |SI #0#1 = 7;   nDPeriodo = 1;  nHPeriodo = 3;   |FINSI;
         |SI #0#1 = 8;   nDPeriodo = 1;  nHPeriodo = 3;   |FINSI;
         |SI #0#1 = 9;   nDPeriodo = 1;  nHPeriodo = 3;   |FINSI;
         |SI #0#1 = 10;  nDPeriodo = 1;  nHPeriodo = 4;   |FINSI;
         |SI #0#1 = 11;  nDPeriodo = 1;  nHPeriodo = 4;   |FINSI;
         |SI #0#1 = 12;  nDPeriodo = 1;  nHPeriodo = 4;   |FINSI;
     |SINO;
         |SI #0#1 = 1;   nDPeriodo = 1;  nHPeriodo = 1;   |FINSI;
         |SI #0#1 = 2;   nDPeriodo = 1;  nHPeriodo = 2;   |FINSI;
         |SI #0#1 = 3;   nDPeriodo = 1;  nHPeriodo = 3;   |FINSI;
         |SI #0#1 = 4;   nDPeriodo = 1;  nHPeriodo = 4;   |FINSI;
         |SI #0#1 = 5;   nDPeriodo = 1;  nHPeriodo = 5;   |FINSI;
         |SI #0#1 = 6;   nDPeriodo = 1;  nHPeriodo = 6;   |FINSI;
         |SI #0#1 = 7;   nDPeriodo = 1;  nHPeriodo = 7;   |FINSI;
         |SI #0#1 = 8;   nDPeriodo = 1;  nHPeriodo = 8;   |FINSI;
         |SI #0#1 = 9;   nDPeriodo = 1;  nHPeriodo = 9;   |FINSI;
         |SI #0#1 = 10;  nDPeriodo = 1;  nHPeriodo = 10;  |FINSI;
         |SI #0#1 = 11;  nDPeriodo = 1;  nHPeriodo = 11;  |FINSI;
         |SI #0#1 = 12;  nDPeriodo = 1;  nHPeriodo = 12;  |FINSI;
     |FINSI;

     |ABRE #30;
     |ABRE #100;
     |BUCLE camaniva115;
     |CIERRA #30;

     |SI enSwPartido = 1;
         enSwOpPar   = 2;
         |HAZ FinalPartido;
     |FINSI;

     |SI #999#3 ! 1;
         |DBASE aPathModelo;  |QBT aPathModelo;
         aDef = aPathModelo + "def/dsmoc115.mas";
         |CARGA_DEF aDef, espejo1@;
         |SI FSalida = 0;
             nDComplem = 0;
             nHComplem = enComplem;
             |PARA nPeriodo = 1;  |SI nPeriodo < #999#3;  |HACIENDO nPeriodo = nPeriodo + 1;
                   |BUCLE Bdsmoc115;
             |SIGUE;
             |SI #999#9 ! 0;
                 nDComplem = 0;
                 nHComplem = enComplem - 1;
                 nPeriodo  = #999#3;
                 |BUCLE Bdsmoc115;
             |FINSI;
         |FINSI;
         |DESCARGA_DEF #espejo1@;
     |FINSI;
     |CIERRA #100;

     enEmpresa     = #999#0;
     enEjer        = #999#2;
     enPeriodo     = #999#3;
     enModelo      = #999#7;
     enComplem     = #999#9;
     enActividad   = #999#1;
     enTipoEntrada = 98;
     eaNombreAct   = #999#6;
     |SUB_EJECUTA_NP "dsmoc115";

     |ABRE #4;
     #4#0 = #999#0;
     #4#1 = #999#2;
     #4#2 = #999#3;
     #4#3 = #999#7;
     #4#4 = #999#9;
     |LEE 101#4=;
     |SI FSalida = 0;
         |HAZ ChequeaSituacion;  || Esta en el PLB

         #4#9 = " ";
         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;
     |CIERRA #4;
|FPRC;
