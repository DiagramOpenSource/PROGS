|FICHEROS;
     dsmoy058 #0;
     dsmom002 #2;
     dsmoc110 #110;

     :/basica/def/agifigen   #300;
     dsmow019 #100;
|FIN;

|VARIABLES;
     nCampo            = 0;
     nDEmpresa         = 0;
     nHEmpresa         = 0;
     nEjer             = 0;
     nEmpresa          = 0;
     nDPerio           = 0;
     nDPeriodo         = 0;
     nHPeriodo         = 0;
     nMesLugar         = 0;
     nPeriodo          = 0;
     nHay              = 0;

     aFichero          = "";
     aEjer             = "";
     aPeriodicidad     = "";

     fFecha            = @;
     nNume1            = 0;
     nNume2            = 0;
     nNume3            = 0;
     nNume4            = 0;
     nAlgo             = 0;
     nBase             = 0;
     nIrpf             = 0;
     nTp100            = 0;
     nCambiar1         = 0;
     nCambiar2         = 0;

     &aNumEmp          = "";
     &aNomEmp          = "";
     &nSwLinea         = 0;

     nExism002         = 0;
     fFecIni           = @;
     fFecFin           = @;

     aAlfa             = "";
     aAlfa1            = "";
     aAlfa2            = "";
     aAlfa3            = "";

     informe = "dsmoy058";
|FIN;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\
|PROCESO Periodo;
     nCampo = Campo + 1;
     #0nCampo = "          ";
     |SI #0Campo = 1;   #0nCampo = "ENERO     ";  |FINSI;
     |SI #0Campo = 2;   #0nCampo = "FEBRERO   ";  |FINSI;
     |SI #0Campo = 3;   #0nCampo = "MARZO     ";  |FINSI;
     |SI #0Campo = 4;   #0nCampo = "ABRIL     ";  |FINSI;
     |SI #0Campo = 5;   #0nCampo = "MAYO      ";  |FINSI;
     |SI #0Campo = 6;   #0nCampo = "JUNIO     ";  |FINSI;
     |SI #0Campo = 7;   #0nCampo = "JULIO     ";  |FINSI;
     |SI #0Campo = 8;   #0nCampo = "AGOSTO    ";  |FINSI;
     |SI #0Campo = 9;   #0nCampo = "SEPTIEMBRE";  |FINSI;
     |SI #0Campo = 10;  #0nCampo = "OCTUBRE   ";  |FINSI;
     |SI #0Campo = 11;  #0nCampo = "NOVIEMBRE ";  |FINSI;
     |SI #0Campo = 12;  #0nCampo = "DICIEMBRE ";  |FINSI;

     |SI #0nCampo = "          ";
         |MENAV "     Periodo Incorrecto.";
         |ERROR;
     |FINSI;

     |PINTA #0nCampo;

     |SI Campo = 0;
         fFecha = ~;
         aAlfa  = fFecha % -104;
         #0#2   = aAlfa;
         #0#2   = #0#2 - 1;
         |PINTA #0#2;
     |FINSI;
|FPRC;

|PROCESO Parrilla;
     |SI #0#3 = 0;
         #0#3 = 0;  |PINTA #0#3;
         #0#4 = 0;  |PINTA #0#4;  |C_M #0#4, 1, "N";
         |PARA nCampo = 5;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #0#3, 1, "S";
         |C_M #0#4, 1, "S";

         |PARA nCampo = 5;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|| /////////////////////// PROCESOS DE TRABAJO \\\\\\\\\\\\\\\\\\\\
|PROCESO SumaBaseN;
     |SI aPeriodicidad = "T";
         |SI #110#2 = 3;
             #100#45 = #100#45 + #110#10 + #110#12;  || Base
             #100#46 = #100#46 + #110#15 + #110#17;
             #100#47 = #100#47 + #110#20 + #110#22;

             #100#58 = #100#58 + #110#11 + (#110#13 + #110#14);
             #100#59 = #100#59 + #110#16 + (#110#18 + #110#19);
             #100#60 = #100#60 + #110#21 + (#110#23 + #110#24);
         |FINSI;

         |SI #110#2 = 6;
             #100#48 = #100#48 + #110#10 + #110#12;
             #100#49 = #100#49 + #110#15 + #110#17;
             #100#50 = #100#50 + #110#20 + #110#22;

             #100#61 = #100#61 + #110#11 + (#110#13 + #110#14);
             #100#62 = #100#62 + #110#16 + (#110#18 + #110#19);
             #100#63 = #100#63 + #110#21 + (#110#23 + #110#24);
         |FINSI;

         |SI #110#2 = 9;
             #100#51 = #100#51 + #110#10 + #110#12;
             #100#52 = #100#52 + #110#15 + #110#17;
             #100#53 = #100#53 + #110#20 + #110#22;

             #100#64 = #100#64 + #110#11 + (#110#13 + #110#14);
             #100#65 = #100#65 + #110#16 + (#110#18 + #110#19);
             #100#66 = #100#66 + #110#21 + (#110#23 + #110#24);
         |FINSI;

         |SI #110#2 = 12;
             #100#54 = #100#54 + #110#10 + #110#12;
             #100#55 = #100#55 + #110#15 + #110#17;
             #100#56 = #100#56 + #110#20 + #110#22;

             #100#67 = #100#67 + #110#11 + (#110#13 + #110#14);
             #100#68 = #100#68 + #110#16 + (#110#18 + #110#19);
             #100#69 = #100#69 + #110#21 + (#110#23 + #110#24);
         |FINSI;

         #100#57 = 0;
         |PARA nCampo = 45;  |SI nCampo [ 56;  |HACIENDO nCampo = nCampo + 1;
               #100#57 = #100#57 + #100nCampo;
         |SIGUE;

         #100#70 = 0;
         |PARA nCampo = 58;  |SI nCampo [ 69;  |HACIENDO nCampo = nCampo + 1;
               #100#70 = #100#70 + #100nCampo;
         |SIGUE;
     |SINO;
         nMesLugar = 44 + #110#2;
         #100nMesLugar = #100nMesLugar + #110#10 + #110#12 + #110#15 + #110#17 + #110#20 + #110#22;
         #100#57       = #100#57       + #110#10 + #110#12 + #110#15 + #110#17 + #110#20 + #110#22;

         nMesLugar = 57 + #110#2;
         #100nMesLugar = #100nMesLugar + #110#11 + (#110#13 + #110#14);
         #100nMesLugar = #100nMesLugar + #110#16 + (#110#18 + #110#19);
         #100nMesLugar = #100nMesLugar + #110#21 + (#110#22 + #110#24);

         #100#70       = #100#70       + #110#11 + (#110#13 + #110#14);
         #100#70       = #100#70       + #110#16 + (#110#18 + #110#19);
         #100#70       = #100#70       + #110#21 + (#110#22 + #110#24);
     |FINSI;
|FPRC;

|PROCESO MiraEmp;
     |ABRE #300;
     |DDEFECTO #300;
     #300#0 = #110#0;
     |LEE 040#300=;
     |CIERRA #300;
     #100#71 = #300#1;
|FPRC;

|PROCESO Graba110;

     nExism002 = 0;
     |SI #110#5 ! 99;
         |ABRE #2;
         |SELECT #1#2;
         #2#0 = #110#0;
         #2#1 = #110#5;
         #2#2 = 110;
         |LEE 040#2=;
         |SI FSalida ! 0;  |DDEFECTO #2; nExism002 = 1; |FINSI;
         |CIERRA #2;
     |SINO;
         |ABRE #2;
         |SELECT #2#2;
         #2#0 = #110#0;
         #2#2 = 110;
         #2#1 = 1;
         |LEE 040#2];
         |SI FSalida ! 0;    |DDEFECTO #2; nExism002 = 1; |FINSI;
         |SI #2#0 ! #110#0;  |DDEFECTO #2; nExism002 = 1; |FINSI;
         |SI #2#2 ! 110;     |DDEFECTO #2; nExism002 = 1; |FINSI;
         |CIERRA #2;
     |FINSI;

     #100#0     = #110#0;
     #100#1     = #110#6;
     #100#2     = #110#7;
     #100#3     = #110#8;
     #100#4     = #110#9;
     |LEE 001#100=;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0     = #110#0;
         #100#1     = #110#6;
         #100#2     = #110#7;
         #100#3     = #110#8;
         #100#4     = #110#9;
         #100#5     = #110#29;
         |HAZ MiraEmp;
         |GRABA 020#100c;
     |FINSI;

     aPeriodicidad = "T";
     |SI #2#7 = "MENSUAL   ";  aPeriodicidad = "M";  |FINSI;

     |SI aPeriodicidad = "T";
         |SI #0#0 = 1;   nPeriodo = 3;   |FINSI;
         |SI #0#0 = 2;   nPeriodo = 3;   |FINSI;
         |SI #0#0 = 3;   nPeriodo = 3;   |FINSI;
         |SI #0#0 = 4;   nPeriodo = 6;   |FINSI;
         |SI #0#0 = 5;   nPeriodo = 6;   |FINSI;
         |SI #0#0 = 6;   nPeriodo = 6;   |FINSI;
         |SI #0#0 = 7;   nPeriodo = 9;   |FINSI;
         |SI #0#0 = 8;   nPeriodo = 9;   |FINSI;
         |SI #0#0 = 9;   nPeriodo = 9;   |FINSI;
         |SI #0#0 = 10;  nPeriodo = 12;  |FINSI;
         |SI #0#0 = 11;  nPeriodo = 12;  |FINSI;
         |SI #0#0 = 12;  nPeriodo = 12;  |FINSI;
     |SINO;
         nPeriodo = #0#0;
     |FINSI;

     |SI #110#2 < #0#26;     |ACABA;  |FINSI;
     |SI #110#2 > nPeriodo;  |ACABA;  |FINSI;

     |HAZ SumaBaseN;
     |GRABA 020#100a;
     |LIBERA #100;
|FPRC;

|DEFBUCLE dsmoc110;
     #110#1;
     ;
     #0#3, #0#2, 01, 110, 00, 01, #0#17, 0000, #0#19, #0#20;
     #0#4, #0#2, 12, 110, 99, 99, #0#18, 9999, #0#19, #0#20;
     ;
     NULL, Graba110;
|FIN;


|| ... ... ... ... ... ... ... ... Proceso para Imprimir Auxiliar
|PROCESO Imprime;

     |SI nEmpresa ! #100#0;  |Y nEmpresa ! 0;
         |SI nHay ! 0; |PIEINF; |FINSI;
         nHay  = 0;
     |FINSI;

     nEmpresa = #100#0;
     aNumEmp  = nEmpresa; |QBF aNumEmp;
     aNumEmp  = ("00000" + aNumEmp) % -105;
     aNomEmp  = #100#71;

     nDPerio = nDPeriodo;
     |SI aPeriodicidad = "T";
         |SI nDPeriodo [ 3;                   nDPerio = 1; |FINSI;
         |SI nDPeriodo > 3; |Y nDPeriodo [ 6; nDPerio = 4; |FINSI;
         |SI nDPeriodo > 6; |Y nDPeriodo [ 9; nDPerio = 7; |FINSI;
         |SI nDPeriodo > 9;                   nDPerio = 10;|FINSI;
     |FINSI;
     nSwLinea  = 0;
     |PDEFECTO #0, 28, 38;
     |PARA nNume1 = nDPerio; |SI nNume1 [ nHPeriodo; |HACIENDO nNume1 = nNume1 + 1;
           nNume2 = 44 + nNume1; nBase = #100nNume2; || Base
           nNume3 = 57 + nNume1; nIrpf = #100nNume3; || Retencion
           |SI #0#21 = "S";
               #0#32 = #0#32 + nBase;
               #0#33 = #0#33 + nIrpf;
           |SINO;
               |HAZ Literal;
               #0#31  = aAlfa1;
               |HAZ Calcular;
               |SI #0#28 ! 0; |O #0#30 ! 0;
                   |PRINT; nHay = 1; nSwLinea = 1;
               |FINSI;
               #0#32 = #0#32 + nBase;
               #0#33 = #0#33 + nIrpf;
           |FINSI;
    |SIGUE;
    |SI #0#21 = "S";
        #0#31 = "TOTAL EJERCICIO";
        nBase = #0#32;
        nIrpf = #0#33;
        |HAZ Calcular;
        |SI #0#28 ! 0; |O #0#30 ! 0;
            |PRINT; nHay = 1;
        |FINSI;
    |SINO;
        |SI nSwLinea = 1; nSwLinea = 2; |PRINT; nHay = 1; |FINSI;
    |FINSI;
|FPRC;

|DEFBUCLE dsmow019_pornom;
     #100#1;
     ;
     00000, "            ", 0000, " ", "  ";
     99999, "zzzzzzzzzzzz", 9999, "z", "zz";
     ;
     NULL, NULL, NULL, NULL, NULL, Imprime;
     #100#0, #100#5, #100#99, #100#72;
|FIN;

|DEFBUCLE dsmow019_pornif;
     #100#1;
     ;
     00000, "            ", 0000, " ", "  ";
     99999, "zzzzzzzzzzzz", 9999, "z", "zz";
     ;
     NULL, Imprime;
|FIN;

|PROCESO Calcular;

   #0#28 = nBase;
   #0#30 = nIrpf;
   nTp100 = ((nIrpf * 100) / nBase) ! 2;
   #0#29  = nTp100;
   #0#37  = (#0#29 + 0.45) ! 0;

   #0#34 = "NO";
   #0#35 = "NO";

   nCambiar1 = 0;
   #0#36     = #0#30 - ((#0#28 % 1) ! 2);
   |SI #0#36 < 0;  #0#36   = -#0#36;  |FINSI;
   |SI #0#36 = 0.01;  nCambiar1 = 1;    |FINSI;
   |SI #0#36 = 0;     nCambiar1 = 1;    |FINSI;

   nCambiar2 = 0;
   #0#36    = #0#30 - ((#0#28 % 1) ! 2);
   |SI #0#36 [ 1;  nCambiar2 = 1;    |FINSI;

   |SI nCambiar1 = 1; #0#34 = "SI"; |FINSI;
   |SI nCambiar2 = 1; #0#35 = "SI"; |FINSI;
|FPRC;

|PROCESO Literal;
     aAlfa1 = "";
     |SI nNume1 = 1;   aAlfa1 = "ENERO     ";  |FINSI;
     |SI nNume1 = 2;   aAlfa1 = "FEBRERO   ";  |FINSI;
     |SI nNume1 = 3;   aAlfa1 = "MARZO     ";  |FINSI;
     |SI nNume1 = 4;   aAlfa1 = "ABRIL     ";  |FINSI;
     |SI nNume1 = 5;   aAlfa1 = "MAYO      ";  |FINSI;
     |SI nNume1 = 6;   aAlfa1 = "JUNIO     ";  |FINSI;
     |SI nNume1 = 7;   aAlfa1 = "JULIO     ";  |FINSI;
     |SI nNume1 = 8;   aAlfa1 = "AGOSTO    ";  |FINSI;
     |SI nNume1 = 9;   aAlfa1 = "SEPTIEMBRE";  |FINSI;
     |SI nNume1 = 10;  aAlfa1 = "OCTUBRE   ";  |FINSI;
     |SI nNume1 = 11;  aAlfa1 = "NOVIEMBRE ";  |FINSI;
     |SI nNume1 = 12;  aAlfa1 = "DICIEMBRE ";  |FINSI;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     || |MENAV "0000 Recuerde seleccionar el papel de la impresora en Horizontal";

     |IMPRE 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR informe;
     |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;

     aFichero = ("58" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #100 aFichero;
     |ABRE #100;  |CIERRA #100;  |DELINDEX #100;

     nDPeriodo = #0#26;
     nHPeriodo = #0#0;
     aEjer     = #0#2;
     aEjer     = aEjer % -102;
     nEjer     = aEjer;

     aAlfa1 = #0#2;
     aAlfa2 = #0#26; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa1 = "01."+ aAlfa2 + "." + aAlfa1; fFecIni = aAlfa1;

     aAlfa1 = #0#2;
     aAlfa2 = #0#0; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = "31.";
     |SI #0#0 = 4; |O #0#0 = 6; |O #0##0 = 9; #0#0 = 11;  aAlfa3 = "30.";  |FINSI;
     |SI #0#0 = 2;
         aAlfa3 = "28."; nNume1 = #0#2 / 4; nNume2 = (#0#2/4) ! 0;
         |SI nNume1 = nNume2; aAlfa3 = "29."; |FINSI;
     |FINSI;
     aAlfa1 = aAlfa3 + aAlfa2 + "." + aAlfa1; fFecFin = aAlfa1;

     |ABRE #100;
     |SI #0#3 ! 0;
         |BUCLE dsmoc110;
     |SINO;
         |PARA nCampo = 5;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               |SI #0nCampo ! 0;
                   #0#3 = #0nCampo;
                   #0#4 = #0nCampo;
                   |BUCLE dsmoc110;
               |FINSI;
         |SIGUE;
     |FINSI;
     |CIERRA #100;

     nEmpresa = 0;

     |SI #0#22 = 1; |BUCLE dsmow019_pornif; |FINSI;
     |SI #0#22 = 2; |BUCLE dsmow019_pornom; |FINSI;

     |SI nEmpresa ! 0; |Y nHay ! 0;  |PIEINF;  |FINSI;
     |FININF;
     |FINIMP;

     |DELINDEX #100;
|FPRC;
