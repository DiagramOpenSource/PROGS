|FICHEROS;
     Referen@ #1000;
|FIN;

|VARIABLES;
     &enDesdeGrid = 0;
     aGuarda = "";

     aAplica = "";
     nEmpresa = 0;
     aEmpresa = "";

     aRels  = "";
     aAlfa6 = "";

     nNumRels = 0;
     nCont    = 0;
     nCalc    = 0;
     nCalc1   = 0;
     nOpcion  = 0;

     aParametro = "";
     aAlfa = "";
     nSalida = 0;
     aPrograma = "";
     aBase = "";
     aPathDef = "";
     aPathFic = "";
     aQueQuiero = "";
     aNomDef = "";
     aMensaje = "";
     aFichRel = "";

     aAlfa5 = "";
     aClaves = "";
     aTCompo = "";
     nTCompo = 0;
     aTCompo2 = "";
     nTCompo2 = 0;
     {16}clave = 0;      ||Array de 16 elementos para la clave.
     nCompo = 0;
     nPosi = 0;
     aTCampos = "";
     nTCampos = 0;
     nCampo = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aClave = "";
     nNumCam = 0;
     aFicERP = "";
     aFicDsarchi = "";
     aDSERP = "";

     &PRMNT_Def = "";
     aLong = "";
     nLong = 0;

     nNumCmps    = 0;
   {2}nPuntero   = 0;
     aSalida = "";

     nSwSaltaRel = 0;
|FIN;

|PROCESO &EVENTOGRID;
     |SI Campo = -1;
          ||aMensaje = "0000Esta opcion solo funciona estando dentro del campo.";
          ||MENAV aMensaje;
          nSwSaltaRel = 1;
     |SINO;
          nSwSaltaRel = 0;
     |FINSI;

     ||No controlamos las relaciones.
     nSwSaltaRel = 1;

     aSalida = FSalida;
     |QBF aSalida;
     |SI aSalida = "1771";
          aMensaje = "0000Esta opcion solo funciona estando dentro del campo. Codigo 1771";
          |MENAV aMensaje;
     |SINO;
          aSalida = aSalida % 104;
          |SI aSalida = "1771";
               |HAZ BotonD;
/*
               FSalida = 4;
               |HAZ ControlGridPLB;
*/
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlGridPLB; |TIPO 77;
   enDesdeGrid = 1;
   nSalida = FSalida;
   |SI FSalida = 4;
     ||Primero miro si tengo instalado el dserp

     |DBASS aFicERP;
     |QBF aFicERP;
     aDSERP = aFicERP + "dserp/def/dserpm01.mas";
     |XABRE "E", aDSERP, 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nCampo = Campo;

     |DBASE aBase;
     |QBF aBase;
     aPathDef = aBase + "def/";
     aQueQuiero = "|DEF";
     aNomDef = #Fichero@#aQueQuiero#;
     |QBF aNomDef;
     aNomDef = aNomDef - aPathDef;
     |QBF aNomDef;
     aNomDef = (aNomDef + "        ") % 108;
     |MODULO aPrograma;
     |QBF aPrograma;
     |DFICE aPathFic;
     |QBF aPathFic;

     |SI nSwSaltaRel = 0;
          aAlfa5 = "|NR"; aAlfa5 = #Fichero@#aAlfa5#;
          nNumRels = aAlfa5; nNumRels = nNumRels - 1;
          |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
             aAlfa5 = "|R" + (("000" + nCont) % -103);
             aAlfa5 = #Fichero@#aAlfa5#;
             aAlfa5 = aAlfa5 - "|";
             |SI FSalida ! 0;
                nCalc = ((FSalida / 100) ! 0) + 99;
                aFichRel = aAlfa5 % nCalc;
                nCalc = FSalida + 98;
                aAlfa5 = aAlfa5 % nCalc; aAlfa5 = aAlfa5 % 0499; aRels = aAlfa5;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6; nCalc = nCalc - 1;
                   |SI nCalc = nCampo; |SAL; |FINSI;
                |SIGUE;
                |SI nCalc = nCampo; |SAL; |FINSI;
             |FINSI;
          |SIGUE;
          |SI nCalc = nCampo;
             aAlfa5 = aPathDef + aAlfa5; |QBF aAlfa5;
             aAlfa5 = aAlfa5 + aFichRel + ".mas";
             |CARGA_DEF aAlfa5, Referen@;
             |SI FSalida = 0;
                |ENLAZA_PROCESO #Referen@#0,ControlGridPLB,77;
                |PATH_DAT #1000 aPathFic;
                |ABRE #Referen@;  aAlfa5 = "|K000";
                aAlfa5 = #Referen@#aAlfa5#; aAlfa5 = aAlfa5 % 0499;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6;
                   aAlfa6 = aRels % 0103; aRels = aRels % 0499;
                   nCalc1 = aAlfa6; nCalc1 = nCalc1 - 1;
                   #Referen@#nCalc# = #Fichero@#nCalc1#;
                |SIGUE;
                |LEE 000#Referen@.];
                |PUSHV 0501 2380;
                |PINPA #0#Referen@; |PINDA #0#Referen@;
                |PUSHV 0501 2380;
                |HAZ Relacionado;
                |POPV;
                |POPV;
                ||CONSULTA_CLAVE #1#Referen@;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |ACABA;
             |SINO;
                aAlfa5 = "    No encuentro el def a cargar. [" + aAlfa5 + "," + FSalida + "]";
                |MENAV aAlfa5;
             |FINSI;
          |FINSI;
     |FINSI;

     aAlfa5 = "|K000";
     aClaves = #Fichero@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Fichero@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica

     aParametro = aAplica + aNomDef + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm08;" + aParametro;

     |SUB_EJECUTA aAlfa;
     |SI nSwSaltaRel = 1;
          ||PTEC 807;
     |FINSI;
  |FINSI;
|FPRC;


|PROCESO Relacionado;
     aAlfa5 = "|K000";
     aClaves = #Referen@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Referen@#nNumCam#;
          aClave = aClave + aAlfa2;
     |SIGUE;

     ||aMensaje = "0000Clave: " + aClave;

     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica
     aAplica = (aAplica + "        ") % 108;

     aParametro = aAplica + aEmpresa + aFichRel + aClave + aPathDef + "@" + aPathFic;
     aAlfa      = ":dserp/dserpm08;" + aParametro;

     |SUB_EJECUTA aAlfa;
     ||PTEC 807;
|FPRC;

|PROCESO BotonD;

     aMensaje = "0000BotonD";
||     |MENAV aMensaje;

     |DBASS aFicDsarchi;
     |QBF aFicDsarchi;
     aDSERP = aFicDsarchi + "dsarchi/def/dsarm001.mas";
     |XABRE "E", aDSERP, 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nCampo = Campo;

     |DBASE aBase;
     |QBF aBase;
     aPathDef = aBase + "def/";
     aQueQuiero = "|DEF";
     aNomDef = #Fichero@#aQueQuiero#;
     |QBF aNomDef;
     aNomDef = aNomDef - aPathDef;
     |QBF aNomDef;
     aNomDef = (aNomDef + "        ") % 108;
     |MODULO aPrograma;
     |QBF aPrograma;
     |DFICE aPathFic;
     |QBF aPathFic;

     |SI nSwSaltaRel = 0;
          aAlfa5 = "|NR"; aAlfa5 = #Fichero@#aAlfa5#;
          nNumRels = aAlfa5; nNumRels = nNumRels - 1;
          |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
             aAlfa5 = "|R" + (("000" + nCont) % -103);
             aAlfa5 = #Fichero@#aAlfa5#;
             aAlfa5 = aAlfa5 - "|";
             |SI FSalida ! 0;
                nCalc = ((FSalida / 100) ! 0) + 99;
                aFichRel = aAlfa5 % nCalc;
                nCalc = FSalida + 98;
                aAlfa5 = aAlfa5 % nCalc; aAlfa5 = aAlfa5 % 0499; aRels = aAlfa5;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6; nCalc = nCalc - 1;
                   |SI nCalc = nCampo; |SAL; |FINSI;
                |SIGUE;
                |SI nCalc = nCampo; |SAL; |FINSI;
             |FINSI;
          |SIGUE;
          |SI nCalc = nCampo;
             aAlfa5 = aPathDef + aAlfa5; |QBF aAlfa5;
             aAlfa5 = aAlfa5 + aFichRel + ".mas";
             |CARGA_DEF aAlfa5, Referen@;
             |SI FSalida = 0;
                |ENLAZA_PROCESO #Referen@#0,ControlGridPLB,77;
                |PATH_DAT #1000 aPathFic;
                |ABRE #Referen@;  aAlfa5 = "|K000";
                aAlfa5 = #Referen@#aAlfa5#; aAlfa5 = aAlfa5 % 0499;
                |PARA; |SI aAlfa5 ! ""; |HACIENDO;
                   aAlfa6 = aAlfa5 % 0103; aAlfa5 = aAlfa5 % 0499;
                   nCalc = aAlfa6;
                   aAlfa6 = aRels % 0103; aRels = aRels % 0499;
                   nCalc1 = aAlfa6; nCalc1 = nCalc1 - 1;
                   #Referen@#nCalc# = #Fichero@#nCalc1#;
                |SIGUE;
                |LEE 000#Referen@.];
                |PUSHV 0501 2380;
                |PINPA #0#Referen@; |PINDA #0#Referen@;
                |PUSHV 0501 2380;
                |HAZ Relacionado;
                |POPV;
                |POPV;
                ||CONSULTA_CLAVE #1#Referen@;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |ACABA;
             |SINO;
                aAlfa5 = "    No encuentro el def a cargar. [" + aAlfa5 + "," + FSalida + "]";
                |MENAV aAlfa5;
             |FINSI;
          |FINSI;
     |FINSI;

     aAlfa5 = "|K000";
     aClaves = #Fichero@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     aClave = "";
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;
          aAlfa2 = #Fichero@#nNumCam#;
          |SI aNomDef = "dsmom041"; |O aNomDef = "dsmom042";
               |SI nCompo = 1;
                    aAlfa2 = "";
               |FINSI;
               |SI nCompo = 2;
                    aGuarda = aAlfa2;
                    aAlfa2 = "";
               |FINSI;
               |SI nCompo = 3;          ||Primero el Numero y Luego Codigo Elemento
                    aAlfa2 = ("00" + aAlfa2) % -102;
                    aAlfa2 = aAlfa2 + aGuarda;
                    aGuarda = "";
               |FINSI;
               |SI nCompo > 3; |Y aNomDef = "dsmom042";
                    aAlfa2 = "";
               |FINSI;
          |FINSI;
          aClave = aClave + aAlfa2;
     |SIGUE;

/*
     ||aMensaje = "0000Clave: " + aClave;
     aAlfa = (aClave + "                                                                                                    ") % 199;
     aClave = aAlfa;
     aAlfa = (aClave + "                                                                                                    ") % 10001;
     aClave = aClave + aAlfa;
*/

     ||Tengo que a¤adir antes .. el nombre de la aplicacion y numero de empresa
     |NOMAP aAplica;
     |QBF aAplica

     aParametro = "ADCONTD" + "000000" + aNomDef + aClave;
     aAlfa = "|:dsarchi/dsarm005;" + aParametro;
     |SUB_EJECUTA aAlfa;
     |ACABA;

     |SI nSwSaltaRel = 1;
          ||PTEC 807;
     |FINSI;
|FPRC;


|PROCESO EVENTOCRM;
|FPRC;
