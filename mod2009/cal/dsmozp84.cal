|FICHEROS;
     dsmozp84 #0;

     dsmom002 #2;
     dsmom004 #4;
     dsmom008 #8;

     dsmom080 #80;
     dsmom081 #81;
     dsmom082 #82;
     dsmom083 #83;

     dsmom107 #107;
     dsmom109 #109;
     dsmociva #300;

     dsmow086 #982,MANTE;
     dsmow087 #983,MANTE;

     dsmom030 #30;

     :/contagen/def/canempre #101;
     :/contagen/def/camaniva #102;
     :/contagen/def/caivalin #103;
     :/contagen/def/caivaasi #104;

     :/basica/def/agifigen #1000;
     :/basica/def/agicen14 #1014;
|FIN;

|VARIABLES;
     &eaPathBasica = "";
     aBase       = "";
     aPathModelo = "";
     aDef        = "";
     &aFichw82   = "";
     aFichero    = "";
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";
     nNume1      = 0;
     nNume2      = 0;
     nPara1      = 0;
     nPara2      = 0;
     fFecha      = @;

     nModp81       = 0;
     nCampo        = 0;
     nDEmpresa     = 0;
     nHEmpresa     = 0;
     enGraba       = 0;
     nBaseImpo     = 0;
     nCuota        = 0;
     nDPeriodo     = 0;
     nHPeriodo     = 0;
     nEjer         = 0;

     nSwConPro   = 0;
     fFecIni     = @;
     fFecFin     = @;

     nSwContab   = 0;
     nSw         = 0;
     nReg109     = 0;
     nNumAct     = 0;
     nDepar      = 0;

     nSwSi       = 0;
     nIvaComun   = 0;
     nBuscoMod   = 0;
     nSwMod      = 0;
     aDComun     = "";
     aHComun     = "";
     nVentaSuI   = 0;
     nSwOpe82    = 0;
     &nSwOpe83   = 0;
     nIvaSop     = 0;
     nIvaSub     = 0;
     nIvaSop1    = 0;
     nIvaSop2    = 0;
     nIvaSop3    = 0;
     nIvaSop4    = 0;
     nIvaSop5    = 0;
     nIvaSop6    = 0;
     nIvaSop7    = 0;
     nIvaSop8    = 0;

     aTipo       = "";
     aLit        = "";
     nActivMas   = 0;
     aCNAE       = "";
     &aTipoPr    = "";
     &nTp100     = 0;
     &nAny       = 0;
     aParam      = "";
     nTodo       = 0;
|FIN;

|INCLUYE i_variar;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\

|PROCESO despuesejer; |TIPO 0;
|FPRC;

|PROCESO Ejercicio;  |TIPO 7;
     fFecha = ~;
     aAlfa  = fFecha % -104;
     #0#0   = aAlfa;
     |PINTA #0#0;
     aAlfa  = fFecha % 402;
     nNume1 = aAlfa;
     #0#15 = 12;
     |SI nNume1 ] 3; |Y nNume1 [ 5;  #0#15 = 3;  |FINSI;
     |SI nNume1 ] 6; |Y nNume1 [ 8;  #0#15 = 6;  |FINSI;
     |SI nNume1 ] 9; |Y nNume1 [ 11; #0#15 = 9;  |FINSI;
     |PINTA #0#15;
|FPRC;

|PROCESO Periodo;
     |HAZ NomPeriodo;
     |SI #0#16 = "          ";
         |MENAV "     Periodo Incorrecto.";
         |ERROR;
     |FINSI;

     |PINTA #0#15;
     |PINTA #0#16;
|FPRC;

|PROCESO NomPeriodo;
     #0#16 = "          ";
     |SI #0#15 = 1;   #0#16 = "ENERO     ";  |FINSI;
     |SI #0#15 = 2;   #0#16 = "FEBRERO   ";  |FINSI;
     |SI #0#15 = 3;   #0#16 = "MARZO     ";  |FINSI;
     |SI #0#15 = 4;   #0#16 = "ABRIL     ";  |FINSI;
     |SI #0#15 = 5;   #0#16 = "MAYO      ";  |FINSI;
     |SI #0#15 = 6;   #0#16 = "JUNIO     ";  |FINSI;
     |SI #0#15 = 7;   #0#16 = "JULIO     ";  |FINSI;
     |SI #0#15 = 8;   #0#16 = "AGOSTO    ";  |FINSI;
     |SI #0#15 = 9;   #0#16 = "SEPTIEMBRE";  |FINSI;
     |SI #0#15 = 10;  #0#16 = "OCTUBRE   ";  |FINSI;
     |SI #0#15 = 11;  #0#16 = "NOVIEMBRE ";  |FINSI;
     |SI #0#15 = 12;  #0#16 = "DICIEMBRE ";  |FINSI;
     |SI #0#15 = 99;  #0#16 = "ANUAL     ";  |FINSI;
|FPRC;

|PROCESO Parrilla;
     |SI #0#1 = 0;
         #0#1 = 0;  |PINTA #0#1;
         #0#2 = 0;  |PINTA #0#2;  |C_M #0#2, 1, "N";
         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#1, 1, "S";
             |C_M #0#2, 1, "S";
         |FINSI;

         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;
||*****************************************************************************
|PROCESO LeeElModelo;
 |SI #2#8 > "01.01.0000";
     |SI #2#8 > fFecFin;  |ACABA;  |FINSI;
 |FINSI;
 |SI #2#9 > "01.01.0000";
     |SI #2#9 < fFecIni;  |ACABA;  |FINSI;
 |FINSI;

 nModp81 = #2#2;

 |SI nBuscoMod = 1;
     |SI nModp81 = 300; |O nModp81 = 320; |O nModp81 = 330; |O nModp81 = 332;
          |O nModp81 = 370;
            nSwMod = 1;
            |ERROR10;
     |FINSI;
     |ACABA;
 |FINSI;
|FPRC;

|DEFBUCLE LeeElModelo;
  #2#1;
  ;
  enEmpresa, enActividad, 300;
  enEmpresa, enActividad, 371;
  ;
  NULL, LeeElModelo;
|FIN;

|| ========================================================================
|| ============= Primera Parte, ver que empresas tiene que aplicar Prorrata
|| ========================================================================
|| ................. Grabo registro por Empresa
|PROCESO GraboAx82;
    #982#0  = #0#0;
    #982#1  = enEmpresa;
    #982#2  = #1000#1;
    |SI enPeriodo = 12;
        #982#3  = #80#4;
        #982#4  = #80#5;
        #982#5  = #80#32;
    |SINO;
        #982#3  = #80#2;
        #982#4  = #80#3;
        #982#5  = #80#31;
    |FINSI;
    #982#6  = #1000#13;
    #982#17 = nNumAct;
    #982#32 = #0#15;
    #982#33 = #0#16;
    #982#7  = #82#61;
    #982#8  = #82#30;  ||aplicado S/N

    #982#10 = #82#3;
    #982#11 = #82#5;
    #982#12 = #82#6;
    #982#13 = #82#8;
    #982#14 = #82#31;
    #982#15 = #82#39;
    |SI #982#3 ! "E"; |Y #982#4 = 100; |Y #982#13 = 0;
        #982#36 = "N";
    |FINSI;
    |SI #982#12 ! 0; #982#36 = "S"; |FINSI;
    |GRABA 000#982n;
    enGraba = 1;
|FPRC;

|| ... Grabo Registro por Empresa-Actividad
|PROCESO GraboAux83;
    nSwSi = 0;
    |ABRE #83;
    |DDEFECTO #83;
    #83#0 = enEmpresa;
    #83#1 = #0#0;
    #83#2 = nDepar;
    #83#3 = #0#15;
    |LEE 001#83=;
    |SI FSalida = 0;

        |DDEFECTO #983;
        #983#0 = #0#0;
        #983#1 = enEmpresa;
        #983#2 = nDepar;
        |LEE 001#983=;
        |SI FSalida ! 0;
            |DDEFECTO #983;
            #983#0 = #0#0;
            #983#1 = enEmpresa;
            #983#2 = nDepar;
            #983#3 = #1014#4;   ||Nombre actividad
            #983#4 = #1014#20;  || cnae
            #983#5 = #1014#3;   || epigrafe
            #983#6 = #1014#7;   || iva
            #983#7 = #1014#8;
            |SI nDepar = 99;
                #983#3 = "IVA DEDUCIBLE OPERACIONES COMUNES ";
                #983#4 = "";
                #983#5 = "";
                #983#6 = "";
                #983#7 = "";
            |FINSI;
            #983#8  = #1000#87;
            #983#9  = #1000#88;
            #983#10 = #1014#9;
            #983#11 = #1014#10;
            #983#12 = #1014#16;
            #983#13 = #1014#17;
            |SI #1014#5 > "01.01.0000"; #983#14 = #1014#5; |FINSI;
            |SI #1014#6 > "01.01.0000"; #983#15 = #1014#6; |FINSI;
            #983#16 = #1014#15;

            #983#17 = #83#9;
            #983#18 = #83#4;
            #983#19 = #83#5;
            #983#20 = #83#6;
            #983#21 = #83#31;
            #983#22 = #83#39;
            #983#23 = #83#7;
            |GRABA 020#983c;
            |SI #983#17 ! 0; |O #983#18 ! 0; |O #983#20 ! 0;
                #982#36 = "S";
            |FINSI;
         |FINSI;
    |FINSI;
    |CIERRA #83;
|FPRC;


|PROCESO PrimerFiltro;  || Mas de una Actividad
 |SI #1014#5 > "01.01.0000";
     |SI #1014#5 > fFecFin;  |ACABA;  |FINSI;
 |FINSI;
 |SI #1014#6 > "01.01.0000";
     |SI #1014#6 < fFecIni;  |ACABA; |FINSI; || Baja
 |FINSI;
||  |SI #1014#14 = "S"; |ACABA; |FINSI;  || dia 08.06.2005 comunero

 nDepar = #1014#1;
 |HAZ GraboAux83;
 nNumAct = nNumAct + 1;
|FPRC;

|DEFBUCLE LeeActividades;
 #1014#1;
 ;
 enEmpresa, 01;
 enEmpresa, 99;
 ;
 NULL, PrimerFiltro;
|FIN;

|| ..........................................
|PROCESO FicherosConta;
     #982#37 = -1;
     |ABRE #101;
     |SELECT #4#101;
     #101#2  = enEmpresa;
     #101#26 = nEjer;
     |LEE 040#101=;
     |SI FSalida = 0;
          #982#37 = #101#3;
     |FINSI;
     |SELECT #1#101;
     |CIERRA #101;
|FPRC;

|PROCESO MirarFiltros;

     enEmpresa = #1000#0;

     nSwSi = 0;     ||Lee Calculo de Prorrata
     |ABRE #80;
     #80#0 = enEmpresa;
     #80#1 = #0#0;
     |LEE 001#80=;
     |SI FSalida = 0;
         nSwSi = 1;
     |FINSI;
     |CIERRA #80;

     |ABRE #82;
     |DDEFECTO #82;
     #82#0 = enEmpresa;
     #82#1 = #0#0;
     #82#2 = #0#15;
     |LEE 001#82=;
     |CIERRA #82;

     |SI nSwSi = 1;
         nNumAct = 0;
         |DDEFECTO #982;
         #982#36 = "N";
         |ABRE #983;
         |BUCLE LeeActividades;   || Graba Actividades
         nDepar = 99; |HAZ GraboAux83;
         |CIERRA #983;

         |HAZ FicherosConta

         |HAZ GraboAx82;
     |FINSI;
|FPRC;

|DEFBUCLE agifigen;
 #1000#1;
 ;
 nDEmpresa;
 nHEmpresa;
 ;
 NULL, MirarFiltros;
|FIN;

|| ========================================================================
|PROCESO Sup180;
 #982#0 = #0#0;
 #982#1 = 0;
 #982#36 = "S";
|FPRC;

|PROCESO Inf180;
 #982#0 = #0#0;
 #982#1 = 99999;
 #982#36 = "S";
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
    aAlfa     = #0#0;
    aAlfa     = aAlfa % -102;
    nEjer     = aAlfa;       || ejercicio contable de canempre
    enEjer    = #0#0;
    enPeriodo = #0#15;

     aAlfa1 = #0#0;
     aAlfa1 = "01.01." + aAlfa1; fFecIni = aAlfa1;
     aAlfa1 = #0#0;
     aAlfa1 = "31.12." + aAlfa1; fFecFin = aAlfa1;

     |ABRE #982;
     |SI #0#1 ! 0;
         nDEmpresa = #0#1;
         nHEmpresa = #0#2;
         |BUCLE agifigen;
     |SINO;
         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               nDEmpresa = #0nCampo;
               nHEmpresa = #0nCampo;
               |BUCLE agifigen;
         |SIGUE;
     |FINSI;
     |CIERRA #982;

     |SI enGraba = 1;
         |PINPA #0#982;
         |SI enPeriodo = 12;
             |ATRI S; |PINTA 1221, "Acumulados total de Ejercicio "; |ATRI 0;
         |FINSI;
         |ENTLINEAL #2#982, -3, 4, 22, 0, Sup180, Inf180;
     |SINO;
         |MENAV "    Seleccion Vacia ... ";
     |FINSI;
|FPRC;


|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;

     |SI aParam = "";
         |HAZ LeeCtrlProrr;
         |SI enSwProrr = 2;
             |ACABA;   || .. acaba cuando no hay prorrata
         |FINSI;
     |FINSI;

     aFichw82 = ("86w" + Usuario) % 108;
     |NOME_DAT #982 aFichw82;
     aFichero = ("87w" + Usuario) % 108;
     |NOME_DAT #983 aFichero;

     |DELINDEX #982;
     |DELINDEX #983;

     |SI enEmpresa ! 0;
         |DDEFECTO #0;
         #0#0  = enEjer;
         #0#1  = enEmpresa;
         #0#2  = enEmpresa;
         #0#15 = enPeriodo;
         |HAZ NomPeriodo;
         |HAZ Tipo3;
     |SINO;
         |MANTE #0;
     |FINSI;

     |DELINDEX #982;
     |DELINDEX #983;

|FPRO;

|| **************************************************************************
