|FICHEROS;
   dsmoz041 #0;
   dsmom040 #40,MANTE;
   dsmom041 #41,MANTE;
   dsmom042 #42,MANTE;
   dsmom044 #44;
   dsmom045 #45;
   dsmom046 #46,MANTE;

   dsmom107 #107;

   :/contagen/def/cacuenta #300;
   :/contagen/def/caivaasi #304;
   :/contagen/def/cacuebal #305;
   :/contagen/def/caparbal #306;
   :/contagen/def/caparexp #307;
   :/contagen/def/caagrupa #308;
   :/contagen/def/caepigra #309;
   :/contagen/def/cafanta1 #310;
   :/contagen/def/caclipro #311;
   :/contagen/def/camoauxc #312;
   :/contagen/def/anm00001 #313;
   :/contagen/def/anm00007 #314;
   :/contagen/def/anm00014 #324;
   :/contagen/def/anm00015 #325;
   :/contagen/def/cafinanc #360;
   :/contagen/def/cafinanl #361;

   :/basica/def/agicen14 #114;
   :/basica/def/agifigen #1000;

   imagen41@ #441;
|FIN;

|VARIABLES;
  &nAmordef   = 0;
  &nAmorpro   = 0;

  &eaDElem  = "";
  &eaHElem  = "";
  &enDNEle  = 0;
  &enHNEle  = 0;
  inkey     = 0;
  aAlfa1    = "";
  aAlfa2    = "";
  nFactor   = 0;
  nPorceMin = 0;
  nPorceMax = 0;
  nSwSal    = 0;
  nSwEsta   = 0;
  swModulo  = 0;
  nContenido   = "";
  fFecha       = @;
  fFechaUso    = @;
  fFechaVenta  = @;
  fPriVenta    = @;
  fFinVenta    = @;
  fPriCompra   = @;
  fFinCompra   = @;
  aAlfa        = "";
  nVAnyo       = 0;
  nDAnyo       = 0;
  nHAnyo       = 0;

   esalta    = 0;
   esaltaL   = 0;
   &sw_lin   = 0;
   &errconta = 0;
   &entrada  = 1;
   alfa1     = "";
   alfa2     = "";
   alfa3     = "";
   alfa4     = "";
   nume1     = 0;
   nume2     = 0;
   nume3     = 0;
   nume4     = 0;

   men1 = "2402Cantidad Negativa de Amort. Fiscal";
   men2 = "2443Cantidad Negativa de Amort. Contable";
   men3 = "2402Cantidad Negativa de Amort. Fiscal       Cantidad Negativa de Amort. Contable";
   men  = "";
   any = "";
   fiac = "  ";
   guarda = "  ";
   relleno = "                                       ";
   aponer = "  ";

   import = 0;
   import1 = 0;
   traba = @;
   elcon = 0;

   &aComVen = "";
   &enSwBien = 0;
   &aCamp1 = "";
   &nCamp2 = 0;
   &fCamp3 = @;
   &nCamp4 = 0;
   &nCamp5 = 0;
   &aCamp6 = "";
   &nCamp7 = 0;
   &aCamp8 = "";
   &nCamp9 = 0;
   ModoEntrLin = 0;
   nSwError = 0;

   nLaImpor  = 0;
   nTantoPor = 0;
   nTan      = 0;
   nAlta     = 0;
   nColor    = 0;
   nSwOpera  = 0;

   &eaGrAna    = "";
   &enQueAna   = 0;
   &nSwGrupo   = 0;
   &snFilBa    = "";
   nErGrupo    = 0;
   nGrupo      = 0;
   aCtaAcum    = "";
   nEj         = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;  || Variables de Contabilidad
|INCLUYE i_numamo;  || Calculo del Codigo del Elemento de Amortizacion


**************************************************************************
|RUTINA ClaveBaja42;
     #42#0 = enEmpresa;
     #42#2 = #41#2;
     #42#3 = #41#3;
     #42#4 = 001;
|FRUT;

|RUTINA ClaveAlta42;
     #42#0 = enEmpresa;
     #42#2 = #41#2;
     #42#3 = #41#3;
     #42#4 = 999;
|FRUT;

**************************************************************************
LLAMADAS DESDE Amortizaciones Cabecera
**************************************************************************
                            || .... Desde Campo Elemento
|CALCULO tracodi; |TIPO 0;
   |C_M #41#3,1,"S";
   esalta = (FEntrada / 100) ! 0;

   |C_M #41#27, 1, "S"; || fecha compra
   |C_M #41#35, 1, "S"; || en curso
   |C_M #41#9 , 1, "S"; || fecha inicio bien
   |SI esalta = 1;
       sw_lin = 0;
       |CAMPO_MODIFICA #41#10 , 1 , "S";  || Importe
   |SINO;
       |CAMPO_MODIFICA #41#10 , 1 , "N";
       sw_lin = 1;
       |SI #41#15 ! 0; |O #41#21 ! 0;
           |C_M #41#27, 1,"N";
           |C_M #41#35, 1,"N";
           |C_M #41#9,  1,"N";
       |FINSI;
   |FINSI;

   |SI esalta ! 1;  |ACABA;  |FINSI;

   alfa1 = #41#2; |QBF alfa1; |SI alfa1 = ""; |ERROR; |ACABA; |FINSI;

   |HAZ BuscaNumero;

   #41#27 = ~;
   #41#26 = "01.01.0000";
   #41#9  = "01.01.0000";

   |PINDA #0#41;
   |HAZ PresentaLinea;
|FCAL;

|PROCESO BuscaNumero;

  |CAMPO_MODIFICA #41#3, 1, "S";
  #41#0 = enEmpresa;
  #41#2 = alfa1;
  #41#3 = 00;
  |LEE 011#41=
  |SI FSalida ! 0;
      |DDEFECTO #41;
      |CAMPO_MODIFICA #41#3, 1, "N";
      #41#0 = enEmpresa;
      #41#2 = alfa1;
      #41#3 = 0;
  |SINO;
      |PARA nume1 = 1;  |SI nume1 [ 99;  |HACIENDO nume1 = nume1 + 1;
            #41#0 = enEmpresa;
            #41#2 = alfa1;
            #41#3 = nume1;
            |LEE 001#41=;
            |SI FSalida ! 0;
                #41#9  = "01.01.0000";
                #41#10 = 0;
                #41#15 = 0;
                #41#16 = 0;
                #41#21 = 0;
                #41#22 = 0;
                #41#26 = "01.01.0000";
                #41#27 = "01.01.0000";
                |SAL;
           |FINSI;
        |SIGUE;
        |SI nume1 = 100; |ERROR; |FINSI;
    |FINSI;
|FPRC;

|PROCESO LinGrupo;
     |BORRA 140#325a;
     |LIBERA #325;
|FPRC;

|DEFBUCLE LinGrupo;
     #325#1;
     ;
     #324#0, #324#1, #324#2, 000;
     #324#0, #324#1, #324#2, 999;
     be;
     NULL, LinGrupo;
|FIN;

|PROCESO BorraLineas46;
     |BORRA 140#46a;
     |LIBERA #46;
|FPRC;

|DEFBUCLE dsmom046;
     #46#1;
     ;
     #41#0, #41#2, #41#3, 00;
     #41#0, #41#2, #41#3, 99;
     be;
     NULL, BorraLineas46;
|FIN;

|PROCESO BorraLineas;
     |BORRA 140#42a;
     |LIBERA #42;
|FPRC;

|DEFBUCLE dsmom042;
     #42#1;
     ;
     #41#0, #41#2, #41#3, 000;
     #41#0, #41#2, #41#3, 999;
     be;
     NULL, BorraLineas;
|FIN;

|CALCULO Tipo2_1;  |TIPO 2;
     esalta  = (FEntrada / 100) ! 0;
     |SI esalta ! 3;  |ACABA;  |FINSI;

     |ABRE #44;
     #44#0 = #41#0;
     #44#2 = #41#2;
     #44#3 = #41#3;
     |LEE 041#44=;
     |SI FSalida = 0;
         |BORRA 020#44a;
     |FINSI;
     |CIERRA #44;

     |ABRE #45;
     #45#0 = #41#0;
     #45#2 = #41#2;
     #45#3 = #41#3;
     |LEE 041#45=;
     |SI FSalida = 0;
         |BORRA 020#45a;
     |FINSI;
     |CIERRA #45;

     |BUCLE dsmom042;
     |BUCLE dsmom046;

     aAlfa1 = #41#34; aAlfa1 = aAlfa1 % 103;
     |SI aAlfa1 = "GRU";
         |ABRE #324;
         #324#0 = #41#0;
         #324#1 = #41#2;
         #324#2 = #41#3;
         |LEE 101#324=;
         |SI FSalida = 0;
             |BUCLE LinGrupo;
             |BORRA 020#324a;
         |FINSI;
         |LIBERA #324;
         |CIERRA #324;
     |FINSI;
|FCAL;

|CALCULO elTipo3; |TIPO 3;
    esalta  = (FEntrada / 100) ! 0;
    |SI esalta = 1; #41#26 = "01.01.0000";|FINSI;
    #41#32 = #1000#1; ||A todas las cabeceras Nombre empresa
    #41#33 = #114#4;  ||                   Actividad

    nSwSal = 0;
    |SI esalta = 1;
        |HAZ CalculaCompra; ||Linea de Compra
        |HAZ CalculaAmort;
        |PINTA #41#15; |PINTA #41#16;
        |PINTA #41#21; |PINTA #41#22;
    |FINSI;

    |ENTLINEAL #1#42, -4, 2, 22, 1, ClaveBaja42, ClaveAlta42;
    |LIBERA #41;
|FCAL;


|CALCULO PresentaLinea;  |TIPO 7;
     ModoEntrLin = (FEntrada / 100) ! 0;
     |SI ModoEntrLin > 1; |HAZ ColorAct; |FINSI;
     nSwSal = 1;
     |HAZ TextoAI;
     |SI enSwAna = 0; |HAZ TextoCtaA; |FINSI;
     |ENTLINEAL #1#42, -4, 7, 22, 0, ClaveBaja42, ClaveAlta42;
|FCAL;

|CALCULO numamo; |TIPO 6;
   x_entra = entrada;
   x_alfa1 = #41Campo;
  |QBF x_alfa1; |SI x_alfa1 = ""; |ERROR; |ACABA; |FINSI;

   x_alfa1 = #41Campo;
   |HAZ x_punto;
   #41Campo = x_alfa1;
   |PINTA #41Campo;
|FCAL;

|PROCESO inf441;
 #441#0 = enEmpresa;
 #441#4 = "";
|FPRC;

|PROCESO sup441;
 #441#0 = enEmpresa;
 #441#4 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
|FPRC;

|CALCULO T11; |TIPO 11;
  inkey = FSalida;
  |SI inkey = 12;
      enEmpresa = #41#0;
      eaDElem   = #41#2;
      eaHElem   = #41#2;
      enDNEle   = #41#3;
      enHNEle   = #41#3;
      |SUB_EJECUTA_NP "dsmoy041";
      |ERROR;
  |FINSI;

  |SI inkey = 10;
      enEmpresa  = #41#0;
      |DBASE aAlfa1; |QBF aAlfa1;
      aAlfa2 = aAlfa1 + "def/dsmom041.mas";
      |CARGA_DEF aAlfa2, imagen41@;
      |SI FSalida = 0;
          |ABRE #441;
          #441#0 = #41#0;
          #441#2 = #41#2;
          #441#3 = #41#3;
          #441#4 = #41#4;
          |CONSULTA_F_CLAVE #2#441,inf441,sup441;
          #41#0 = #441#0;
          #41#2 = #441#2;
          #41#3 = #441#3;
          |CIERRA #441;
          |DESCARGA_DEF #imagen41@;
          |PTEC 802;
      |FINSI;
  |FINSI;
|FCAL;

|PROCESO TextoAI; |TIPO 0;
 aAlfa1 = "INACTIVO";
 |SI #41#40 = "A";
     aAlfa1 = "ACTIVO  ";
 |FINSI;
 |ATRI P; |PINTA 0967, aAlfa1; |ATRI 0;
|FPRC;

|PROCESO TextoCtaA;
 nGrupo = #41#18;
 |HAZ VeoGrupo;
 #0#4 = aCtaAcum;
 |PINTA #0#4;
|FPRC;
|| -\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|| ************************ Actividades y Reparto
|PROCESO Tip2m046; |TIPO 2;
 nume2 = 0 +.1;
 nTantoPor = nTantoPor +. #46#5;
 |SI #46#5 > nTan; |Y nume2 = 1;
     nTan     = #46#5;
     nLaImpor = #46#1;
 |FINSI;
 #0#3 = nTantoPor;
 |ATRI P; |PINTA 0873, #0#3; |ATRI 0;
|FPRC;

|PROCESO Tip11m046; |TIPO 11;
 inkey = FSalida;
 eOpDep = 0;
 |SI inkey = 10;
     eOpDep = 1;
     |HAZ LActividad;
     eOpDep = 0;
 |FINSI;
|FPRC;

|PROCESO Tip0m046; |TIPO 0;
 eOpDep = 0;
 enActividad = #46#1;
 |HAZ LActividad;
 |SI eswLect = 1;
     |MENAV "      Actividad Inexistente";
     |ERROR;
 |SINO;
      #46#1 = enActividad; |PINTA #46#1;
      #46#4 = eaNombreAct; |PINTA #46#4;
      |SI efActFin > "01.01.1900"; |Y snFilBa ! "N";
          aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
          |CONFI aAlfa1;
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
      |SI eaEsCom = "S";
          |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Elementos ? ";
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO Leem046;
 |SI nSwOpera = 0;
     enActividad = #46#1;
     |HAZ LActividad;
     |SI eswLect = 1;
         |BORRA 020#46a;
     |SINO;
         nTantoPor = nTantoPor + #46#5;
         |SI #46#5 > nTan;
             nTan     = #46#5;
             nLaImpor = #46#1;
          |FINSI;
     |FINSI;
 |FINSI;
 |SI nSwOpera = 1;
     nColor = nColor + 1;
     |SI nColor > 1; |ERROR10; |FINSI;
 |FINSI;
 |SI nSwOpera = 2;
     |SI nColor = 0; nLaImpor = #46#1;    |FINSI;
     |SI #46#1 = #41#1; nLaImpor = #46#1; |FINSI;
     nColor   = 1;
 |FINSI;
|FPRC;

|DEFBUCLE Leem046;
 #46#1;
 ;
 #41#0, #41#2, #41#3, 00;
 #41#0, #41#2, #41#3, 99;
 ;
 NULL, Leem046;
|FIN;

|PROCESO ElPrimero;
 nAlta = 0;
 |ABRE #46;
 #46#0 = #41#0;
 #46#2 = #41#2;
 #46#3 = #41#3;
 #46#1 = 0;
 |LEE 041#46];
 |SI FSalida ! 0;
     nAlta = 1;
 |SINO;
    |SI #46#0 ! #41#0; |O #46#2 ! #41#2; |O #46#3 ! #41#3;
        nAlta = 1;
    |FINSI;
 |FINSI;
 |SI nAlta = 1;
    |DDEFECTO #46;
    #46#0 = #41#0;
    #46#2 = #41#2;
    #46#3 = #41#3;
    enActividad = #41#1;
    |HAZ LActividad;
    |SI eswLect = 0;
        #46#1 = #41#1;
        #46#4 = eaNombreAct;
        #46#5 = 100;
        |GRABA 020#46n;
    |FINSI;
 |FINSI;
 |CIERRA #46;
 nTantoPor = 0;
 nTan      = 0;
 nLaImpor  = #41#1;
 nSwOpera = 0; |BUCLE Leem046;
|FPRC;

|PROCESO ComprueboRep;
 nTantoPor = 0;
 nTan      = 0;
 nLaImpor  = #41#1;
 nSwOpera = 0; |BUCLE Leem046;

 |SI nTantoPor ! 100;
     |MENAV "    Error, no ha repartido el 100 % de los importes";
 |FINSI;
|FPRC;

|RUTINA ClaveBaja46;
 #46#0 = #41#0;
 #46#1 = 01;
 #46#2 = #41#2;
 #46#3 = #41#3;
|FRUT;

|RUTINA ClaveAlta46;
 #46#0 = #41#0;
 #46#1 = 99;
 #46#2 = #41#2;
 #46#3 = #41#3;
|FRUT;

|PROCESO RepartoAct;
 nLaImpor = #41#1;
 |HAZ ElPrimero;
 |PUSHV 08241880;
 |PINPA #0#46;
 #0#3 = nTantoPor;
 |ATRI P; |PINTA 0873, #0#3; |ATRI 0;
 |ENTLINEAL #1#46, -4, 2, 16, 0, ClaveBaja46, ClaveAlta46;
 |HAZ ComprueboRep;
 |POPV;
 #41#1 = nLaImpor; |PINTA #41#1;
|FPRC;

|PROCESO MiroReparto;
 nColor   = 0;
 nLaImpor = #41#1;
 nSwOpera = 2; |BUCLE Leem046;
 |SI nColor = 1;
     |CAMPO_ATRIBUTO #41#1, S,0,0;
     |SI #41#1 ! nLaImpor;
         |MENAV "    Error. Existe reparto entre Actividades y esta no esta Incluida";
     |FINSI;
 |SINO;
     |CAMPO_ATRIBUTO #41#1, D,0,0;
 |FINSI;
 #41#1 = nLaImpor; |PINTA #41#1;
|FPRC;


|CALCULO LeeLaActividad; |TIPO 0;
  inkey = FSalida;

  |SI inkey = 11;
      |HAZ RepartoAct;
      |ERROR;
      |ACABA;
  |FINSI;

  |HAZ MiroReparto;

  eOpDep = 0;
  |SI inkey = 10; eOpDep = 1; |FINSI;
  enActividad = #41#1;
  |HAZ LActividad;
  eOpDep = 0;
  |SI eswLect = 1;
      |MENAV "      Actividad Inexistente";
      |ERROR;
  |SINO;
      #41#1  = enActividad; |PINTA #41#1;
      #41#33 = eaNombreAct; |PINTA #41#33;
      |SI efActFin > "01.01.1900"; |Y snFilBa ! "N";
          aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
          |CONFI aAlfa1;
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
      |SI eaEsCom = "S";
          |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Elementos ? ";
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;

      swModulo = 0;
      |SI enTipoTribut  = 5; |O enTipoTribut  = 10;
          swModulo = 1;
      |FINSI;
      |SI enTipoTribut = 6; |O enTipoTribut = 7; |O enTipoTribut = 11; |O enTipoTribut = 12;
          swModulo = 1;   ||Agricolas  (Paco 30.05.2001)
          |SI enTipoIva = 9; |Y enTipoTribut = 7;
              swModulo = 2;  || adade lugo 28.05.2003
          |FINSI;
      |FINSI;
  |FINSI;
|FCAL;

|PROCESO ColorAct;
 nColor = 0;
 nSwOpera = 1; |BUCLE Leem046;
 |SI nColor > 0;
     |CAMPO_ATRIBUTO #41#1, S,0,0;
 |SINO;
     |CAMPO_ATRIBUTO #41#1, D,0,0;
 |FINSI;
 |PINTA #41#1;
|FPRC;

|| -//////////////////////////////////////////////////////
|PROCESO VeoGrupo;
 nErGrupo = 0;
 |ABRE #40;
 |DDEFECTO #40;
 #40#0 = enEmpresa;
 #40#2 = nGrupo;
 |LEE 000#40=;
 |SI FSalida ! 0; nErGrupo = 1; |FINSI;
 |CIERRA #40;

 |SI Campo ! 38;
     aCtaAcum = ""; nEj = 2007;
     |SI #41#27 > "01.01.0000";
          aAlfa1 = #41#27; aAlfa1 = aAlfa1 % -104;
          nEj = aAlfa1;
     |FINSI;
     aCtaAcum = #40#12;
     || ... |SI nEj < 2008; aCtaAcum = #40#5; |FINSI;
     |SI aCtaAcum = "            "; aCtaAcum = #40#5; |FINSI;
 |FINSI;
|FPRC;

|CALCULO LeeGrupo; |TIPO 0;
 |C_M #41Campo, 0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI Campo = 38;
     |SI #41Campo = 0; |ACABA; |FINSI;
 |FINSI;

 nGrupo = #41Campo;
 |HAZ VeoGrupo;
 |SI nErGrupo ! 0;
     |MENAV "    No existe Grupo de Amortizacion ";
     |ERROR;
 |FINSI;
 #41#0 = enEmpresa;
 |SI Campo = 18; |Y enSwAna = 0;
     #0#4 = aCtaAcum; |PINTA #0#4;
 |FINSI;
|FCAL;

|CALCULO tracod1; |TIPO 0; || Desde Campo Descripcion
   inkey = FSalida;
   esalta = (FEntrada / 100) ! 0;
   |SI esalta ! 1;  |Y #41#26 > "01.01.0000";
       |MENAV "     Atencion! El elemento esta vendido";
   |FINSI;
|FCAL;

|CALCULO Prueba; |TIPO 0;

 |SI inkey = 10; |Y swModulo ! 0;  || adade 28.05 swModulo = 1
     |SALVA_DATOS #41;
     fFecha = ~; aAlfa1 = fFecha;
     aAlfa1 = "31.12." + (aAlfa1 % -104);
     fFechaAmor  = aAlfa1;
     |HAZ CalAmorModulo;
     |PUSHV  12401666;
     |CUADRO 12401665;
     |ATRI R;
     |PINTA 1341, "Amortizacion Modulo      ";
     |PINTA 1441, " Provisional:            ";
     |PINTA 1541, " Definitiva :            ";
     #41#15 = nAmorpro;
     #41#21 = nAmordef;
     |PINTA 1455, #41#15;
     |PINTA 1555, #41#21;
     |ATRI 0;
     |PAUSA;
     |POPV;
     |REPON_DATOS #41;
 |FINSI;
|FCAL;

|CALCULO cuenta1; |TIPO 6;   || Desde Campo Cuenta
     emCta = 1;        || Dar mensajes de error

     eaCuenta = #41Campo;
     salidas  = FSalida;
     |HAZ FiltraPuntos;
     #41Campo = eaCuenta;
     |PINTA #41Campo;

     |HAZ SacaNivel;
     nume1 = Campo + 1;
     #41nume1 = enNivel;
|FCAL;

|CALCULO refresca1; |TIPO 0;
   emCta = 0;        || Dar mensajes de error
   eaCuenta = #41Campo;
   |HAZ LeeCuenta;
   |SI eswCta = 1;
        |ERROR;
        |CONFI "    SError.! No existe Cuenta. Desea darla de alta ";
        |SI FSalida = 0;
            |SUB_EJECUTA_NP "dsmoz030";
            #41Campo = eaCuenta;
            |PINTA #41Campo;
        |FINSI;
   |SINO;
        |SI eswCta = 2;
            |MENAV "0000Esta Cuenta NO tiene Pase Directo.";
            |ERROR;
        |FINSI;
   |FINSI;
|FCAL;

|CALCULO comp;
   alfa3 = #41#1; |QBF alfa3;
   alfa3 = ("00" + alfa3) % -102;
   |ABRE #camoauxc;
   #camoauxc#0 = #41#5;
   #camoauxc#1 = #41#6;
   #camoauxc#6 = alfa3;
   |LEE 001#camoauxc.=;
   |SI FSalida = 0;
      |MENAV "0000Esta Cuenta YA existe en el Desglose";
      |ERROR;
   |FINSI;
   |CIERRA #camoauxc;
|FCAL;


                        || Desde Campo Proveedor
|CALCULO ConsuPro;
|FCAL;

                        || Desde Campo Importe Compra
|CALCULO noimporte;
   |SI #41Campo = 0;
      |MENAV "      El importe debe ser diferente de CERO.";
      |ERROR;
      |ACABA;
   |FINSI;
|FCAL;

                        || Desde Campo Nuevo / Usado
|CALCULO NuevoUsado;
  nFactor = 1;
  |SI #41Campo = "U";  nFactor = 2;  |FINSI;

  |SI swModulo ! 0;   || adade 28.05 swModulo = 1
     |SI #41#29 = 0;
         |SI #41#28 = 0;  #41#29 = 100;           |FINSI;
         |SI #41#28 = 1;  #41#29 = 5  * nFactor;  |FINSI;
         |SI #41#28 = 2;  #41#29 = 40 * nFactor;  |FINSI;
         |SI #41#28 = 3;  #41#29 = 25 * nFactor;  |FINSI;
         |SI #41#28 = 4;  #41#29 = 15 * nFactor;  |FINSI;
         |SI #41#28 = 5;  #41#29 = 22 * nFactor;  |FINSI;
         |SI #41#28 = 6;  #41#29 = 10 * nFactor;  |FINSI;
         |SI #41#28 = 7;  #41#29 = 5  * nFactor;  |FINSI;
         |SI #41#28 = 8;  #41#29 = 3  * nFactor;  |FINSI;
     |FINSI;

     |SI #41#30 = 0;
         |SI #41#28 = 0;  #41#30 = 100;              |FINSI;
         |SI #41#28 = 1;  #41#30 =  2.5  * nFactor;  |FINSI;
         |SI #41#28 = 2;  #41#30 = 20    * nFactor;  |FINSI;
         |SI #41#28 = 3;  #41#30 = 12.5  * nFactor;  |FINSI;
         |SI #41#28 = 4;  #41#30 = 10    * nFactor;  |FINSI;
         |SI #41#28 = 5;  #41#30 = 12.5  * nFactor;  |FINSI;
         |SI #41#28 = 6;  #41#30 =  5.88 * nFactor;  |FINSI;
         |SI #41#28 = 7;  #41#30 =  2.22 * nFactor;  |FINSI;
         |SI #41#28 = 8;  #41#30 =  1.25 * nFactor;  |FINSI;
    |FINSI;

    |SI #41#31 = 0; #41#31 = #41#30;  |FINSI;

    |PINTA #41#29;
    |PINTA #41#30;
    |PINTA #41#31;
 |FINSI;
|FCAL;

                        || Desde Campo Tipo Amortizacion Fiscal y Contable
|CALCULO tipamo7; |TIPO 7;

 ModoEntrLin = (FEntrada / 100) ! 0;
 |SI swModulo ! 0; |Y ModoEntrLin = 1;
     #41#13 = "N";    |PINTA #41#13;
     #41#14 = #41#30; |PINTA #41#14;

     #41#19 = "N";    |PINTA #41#19;
     #41#20 = #41#30; |PINTA #41#20;
 |FINSI;

 |C_M #41#13, 1, "S";
 |C_M #41#14, 1, "S";
 |C_M #41#17, 1, "S";
 |SI swModulo = 1;
     |C_M #41#13, 1, "N";
     |C_M #41#14, 1, "N"; #41#14 = 0; |PINTA #41#14;
     |C_M #41#17, 1, "N";
 |FINSI;
|FCAL;

|CALCULO Ellim; |TIPO 7;
 |SI #41#13 = "F"; |Y #41#36 ! 0;
     |C_M #41#39,1,"S";
 |SINO;
     |C_M #41#39,1,"N";
 |FINSI;
|FCAL;

|CALCULO ElsAnys; |TIPO 0;
 inkey = FSalida;
 |C_M #41Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;
 |SI inkey = 2; |ACABA; |FINSI;

 |SI #41Campo = 0;
     |MENAV "    Introduzca el datos de los A¤os ";
     |ERROR;
 |FINSI;
|FCAL;

|CALCULO tipamo; |TIPO 0;
   |SI Campo = 13;
       |SI #41Campo = "F"; |Y #41#36 = 0;
           |MENAV "    Error. Este Elemento no se paga por Operacion de Leasing.";
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI #41#11 = "U"; |Y #41Campo ! "N";
      |MENAV "     En un Bien Usado NO se admite este tipo de Amortizacion";
      |ERROR;
      |ACABA;
   |FINSI;

   nume1 = Campo + 4;
   |SI #41Campo = "N";
       #41nume1 = 0;
       |CAMPO_MODIFICA #41nume1, 1, "N";
       |PINTA #41nume1;
   |SINO;
       |CAMPO_MODIFICA #41nume1, 1, "S";
   |FINSI;

   ModoEntrLin = (FEntrada / 100) ! 0;
   |SI swModulo = 1; |Y Campo = 19; |Y ModoEntrLin = 1;
       #41#13 = #41#19; |PINTA #41#13;
       #41#14 = #41#20; |PINTA #41#14;
       #41#17 = #41#23; |PINTA #41#17;
   |FINSI;

   |SI swModulo = 2; |Y Campo = 13; |Y ModoEntrLin = 1;
       #41#19 = #41#13; |PINTA #41#19;
       #41#20 = #41#14; |PINTA #41#20;
       #41#23 = #41#17; |PINTA #41#23;
   |FINSI;
|FCAL;

||--------------------------------------------------------
                        || Desde Campo Fecha Venta
|CALCULO fechave; |TIPO 0;
   esalta = (FEntrada / 100 ) ! 0;
   |SI esalta = 1;
       #41#26 = "01.01.0000"; |PINTA #41#26;
   |FINSI;
   |C_M #41#40,1,"S";
   |SI #41#26 > "01.01.1900";
       #41#40 = "I"; |PINTA #41#40; |C_M #41#40,1,"N";
       |HAZ TextoAI;
   |FINSI;
|FCAL;

|CALCULO EnCurso0; |TIPO 0;
   |C_M #41#35, 0,aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   |C_M #41#9,1, "S";
   |SI #41#35 = "S";
       #41#9 = "01.01.0000"; |PINTA #41#9; |C_M #41#9,1, "N";
   |FINSI;
|FCAL;

|CALCULO FInicio7;  |TIPO 7;
     |SI #41Campo [ "01.01.1900"; |Y #41#35 = "N";
         #41Campo = #41#27; |PINTA #41Campo;
     |FINSI;
|FCAL;

|CALCULO FInicio0;  |TIPO 0;
     |SI #41#9 < #41#27; |Y #41#35 = "N";
         |C_M #41#9,1,"S";
         |MENAV "    La Fecha Inicio debe ser igual o mayor a la de Compra";
         |ERROR;
     |FINSI;
|FCAL;


|| ------------------------------------------------------
|RUTINA inf360;
   #360#0 = enEmpresa;
   #360#1 = 00001;
|FRUT;

|RUTINA sup360;
   #360#0 = enEmpresa;
   #360#1 = 99999;
|FRUT;

|CALCULO LeeFinanciacion; |TIPO 0;
 inkey = FSalida;
 |SI enSwAna = 1;
     |C_V #360#47,1,"S"; |C_A #360#36,1,14;
     |C_V #360#48,1,"S"; |C_A #360#12,1,14;
     |C_V #360#49,1,"S"; |C_A #360#13,1,14;
     |C_V #360#50,1,"S"; |C_A #360#14,1,14;
     |C_V #360#51,1,"S"; |C_A #360#15,1,14;
     |C_V #360#52,1,"S"; |C_A #360#42,1,14;
     |C_V #360#53,1,"S"; |C_A #360#16,1,14;
 |FINSI;

 |SI inkey = 10;
     |ABRE #360;
     #360#1 = #41Campo;
     |CONSULTA_F_CLAVE #1#360,inf360,sup360;
     #41Campo = #360#1; |PINTA #41Campo;
     |CIERRA #360;
     |ERROR;
     |ACABA;
 |FINSI;

 |SI inkey = 11;
     |HAZ ConsulOpera;
     |ERROR;
     |ACABA;
 |FINSI;

 |SI #41#36 = 0;
     #41#37 = "01.01.0000";|PINTA #41#37; |C_M #41#37,1,"N";
     #41#38 = 0000;        |PINTA #41#38; |C_M #41#38,1,"N";
 |SINO;

     |C_M #41#37,1,"S";
     |C_M #41#38,1,"S";

     |ABRE #360;
     nSwError = 0;
     #360#0 = enEmpresa;
     #360#1 = #41#36;
     |LEE 001#360=;
     |SI FSalida ! 0;
         nSwError = 1;
         |MENAV "    No existe Operacion Financiera";
     |SINO;
         aAlfa1= #360#44; |QBF aAlfa1;
         |SI aAlfa1 ! "";
             |SI #360#44 ! #41#2; |O #360#45 ! #41#3;
                 nSwError = 1;
                 |MENAV "    Error.La Operacion Financiera esta asignada a otro Elemento ";
             |FINSI;
         |FINSI;
     |FINSI;
     |SI nSwError = 1;
         |ERROR;
     |SINO;
          #41#37 = #360#46; |PINTA #41#37;
     |FINSI;
     |CIERRA #360;
 |FINSI;
|FCAL;

|CALCULO EldefGrupo; |TIPO 7;
 esalta = (FEntrada / 100 ) ! 0;
 |C_M #41Campo,0,aAlfa1;

 |SI esalta = 1; |Y aAlfa1 = "S";
     #41Campo = #41#18; |PINTA #41Campo;
 |FINSI;
|FCAL;

                        || Desde Campo Tipo Modelo
|CALCULO TModulo7; |TIPO 7;
  |SI swModulo = 0;
      |C_M #41#28,1,"N"; #41#28 = 0; |PINTA #41#28;
      |C_M #41#29,1,"N"; #41#29 = 0; |PINTA #41#29;
      |C_M #41#30,1,"N"; #41#30 = 0; |PINTA #41#30;
      |C_M #41#31,1,"N"; #41#31 = 0; |PINTA #41#31;
  |SINO;
     |C_M #41#28,1,"S";
     |C_M #41#29,1,"S";
     |C_M #41#30,1,"S";
     |C_M #41#31,1,"S";

     |PUSHV 1605 2474;
     |||D_CUADRO 1406, 2374;
     |ATRI R;
     |PINTA 1607, " -0- Inmovilizado material nuevos  100% mismo a¤o y menor 601,02   ";
     |PINTA 1707, " -1- Edificios y otras construcciones  (Del  2,5%  al  5%) 40 a¤os ";
     |PINTA 1807, " -2- Utiles, herramientas, equipos.    (Del 20  %  al 40%)  5 a¤os ";
     |PINTA 1907, " -3- Elementos de transportes y resto  (Del 12,5%  al 25%)  8 a¤os ";
     |PINTA 2007, " -4- Inmovilizado inmaterial           (Del 10  %  al 15%) 10 a¤os ";
   || PINTA 2007, " ----------------------------------------------------------------- ";
     |PINTA 2107, " -5- Vacuno, porcino, ovino y caprino  (Del 12,5%  al 22%)  8 a¤os ";
     |PINTA 2207, " -6- Equino y frutales no citricos     (Del  5,88% al 10%) 17 a¤os ";
     |PINTA 2307, " -7- Frutales citricos y vi¤edos       (Del  2,22% al  5%) 45 a¤os ";
     |PINTA 2407, " -8- Olivar                            (Del  1,25% al  3%) 80 a¤os ";

     |ATRI r;
   |FINSI;
|FCAL;

|CALCULO TModulo0;  |TIPO 0;
     inkey = FSalida;
     |C_M #41Campo,0,aAlfa1;
     |SI aAlfa1 = "N"; |ACABA; |FINSI;

     |POPV;

     ModoEntrLin = (FEntrada / 100) ! 0;
     nContenido = Contenido;
     |SI nContenido ! #41Campo;
         #41#29  = 0;
         #41#30  = 0;
         #41#31  = 0;
         |HAZ NuevoUsado;
     |FINSI;

     |SI #41Campo = 5;
         |C_M #41#29, 1, "N";
         |C_M #41#30, 1, "N";
         |C_M #41#31, 1, "N";
     |FINSI;

     |SI #41Campo = 0;
         |SI #41#10 > nT600; |Y ModoEntrLin = 1;
             |CONFI "    NElegido Tipo 0 y el Importe de Compra es superior al Limite. Continuar ?";
             |SI FSalida ! 0;
                 |ERROR;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI inkey = 10;    |HAZ Prueba;  |ERROR; |FINSI;
|FCAL;

                        || Desde Campo Porcentaje Modulos
|CALCULO FiltroPorce;  |TIPO 0;
     |C_M #41Campo,0,alfa1;
     |SI alfa1 = "N"; |ACABA; |FINSI;

     |SI #41#11 = "N"; nFactor = 1;  |FINSI;
     |SI #41#11 = "U"; nFactor = 2;  |FINSI;

     |SI #41#28 = 0;
           nPorceMin = 100;
           nPorceMax = 100;
     |FINSI;

     |SI #41#28 = 1;
           nPorceMin = 2.5 * nFactor;
           nPorceMax = 5   * nFactor;
     |FINSI;

     |SI #41#28 = 2;
           nPorceMin = 20  * nFactor;
           nPorceMax = 40  * nFactor;
     |FINSI;

     |SI #41#28 = 3;
           nPorceMin = 12.5 * nFactor;
           nPorceMax = 25   * nFactor;
     |FINSI;

     |SI #41#28 = 4;
           nPorceMin = 10   * nFactor;
           nPorceMax = 15   * nFactor;
     |FINSI;

     |SI #41#28 = 5;
           nPorceMin = 12.5 * nFactor;
           nPorceMax = 22   * nFactor;
     |FINSI;

     |SI #41#28 = 6;
           nPorceMin = 5.88  * nFactor;
           nPorceMax = 10    * nFactor;
     |FINSI;

     |SI #41#28 = 7;
           nPorceMin = 2.22 * nFactor;
           nPorceMax = 5    * nFactor;
     |FINSI;

     |SI #41#28 = 8;
           nPorceMin = 1.25 * nFactor;
           nPorceMax = 3    * nFactor;
     |FINSI;

     |SI #41Campo < nPorceMin;  |O #41Campo > nPorceMax;
         |MENAV "        Porcentaje fuera de limites.";
         |ERROR;
     |FINSI;
|FCAL;

|| ***************************************************************************
||   Calculos de las Lineas de Amortizacion
|CALCULO Ptec816; |TIPO 7;
 |PTEC 816;
|FCAL;

|CALCULO SalgoYa;  |TIPO 7;
     |SI nSwSal = 1;  |PTEC 807;  |FINSI;
|FCAL;

|CALCULO Tipo2_2;  |TIPO 2;

 ||  |SI elcon = 1; elcon = 0; |ACABA; |FINSI;
   esaltaL = (FEntrada / 100) ! 0;
   |SI #42#6 = "A";
       #41#15 = #41#15 +. #42#7;
       #41#21 = #41#21 +. #42#11;
       #41#16 = #41#16 -. #42#7;
       #41#22 = #41#22 -. #42#11;
       |SI #41#26 ! "01.01.0000";
           |SI #42#9 ] #41#26;
               #41#16 = 0;
               #41#22 = 0;
           |FINSI;
       |FINSI;
    |FINSI;

    |SI esaltaL = 3;
        |SI #42#6 ! "C"; |Y #42#9 ] #41#26;
            #41#16 = #41#10 - #41#15;
            #41#22 = #41#10 - #41#21;
        |FINSI;
    |FINSI;

    |SI #42#6 = "C";
        #41#10 = #41#10 +. #42#7;
        #41#16 = #41#16 +. #42#7;
        #41#22 = #41#22 +. #42#7;
    |FINSI;
    |PINTA #41#27;
    |PINTA #41#9;
    |PINTA #41#10;
    |PINTA #41#26;
    |PINTA #41#15;
    |PINTA #41#16;
    |PINTA #41#21;
    |PINTA #41#22;
|FCAL;

|CALCULO baja; |TIPO 1;
   |SI esalta = 3; |ACABA; |FINSI;

   esaltaL = (FEntrada / 100) ! 0;
   elcon = 0;
   |SI #42#4 = 1; |Y esaltaL = 3;
      |MENAV "0000*** NO PUEDE DAR DE BAJA ESTA LINEA ***";
      |ERROR;
      elcon = 1;
      |ACABA;
   |FINSI;

   |SI #42#8 = "S";
      |AVISO;
      |CONFI "2400N** Linea Contabilizada **. Continuar (S/N) ";
      |SI FSalida ! 0;
         |ERROR;
         elcon = 1;
         |ACABA;
      |FINSI;
   |FINSI;

   |SI #42#6 = "V";
       #41#26 = "01.01.0000"; |PINTA #41#26;
       #41#40 = "A";          |PINTA #41#40;
       |HAZ TextoAI;
   |FINSI;

|FCAL;

|CALCULO fecven; |TIPO 3;
   |BLIN 24;
   |SI #42#6 = "V";
       #41#26 = #42#9; |PINTA #41#26;
       #41#40 = "I";   |PINTA #41#40;
       |HAZ TextoAI;
   |FINSI;

   |SI #42#6 = "C";
       |SI #42#4 = 1;
           #41#27 = #42#9; |PINTA #41#27;
           |SI #41#27 > #41#9; |Y #41#35 = "N";
               #41#9 = #41#27; |PINTA #41#9;
           |FINSI;
           #42#11 = #42#7; |PINTA #42#11;
       |SINO;
           |SI #41#35 = "N";
               |SI #41#9 < #42#9; #41#9 = #42#9; |PINTA #42#9; |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

|FCAL;

|CALCULO lin_imp; |TIPO 0;
   esaltaL = (FEntrada / 100) ! 0;
   |SI esaltaL = 1;
      |SI #41#16 = 0; |Y #41#22 = 0;
         |SI #41#26 > "01.01.0000";
            |MENAV "0000Amortizacion Finalizada y Elemento VENDIDO;";
            |ERROR;
         |SINO;
            |MENAV "0000Amortizacion Finalizada. Solo se puede Vender";
            #42#6 = "V";
            |PINTA #42#6;
         |FINSI;
      |FINSI;
   |FINSI;
|FCAL;

             || *** IMPORTES DE LA AMORTIZACION
|CALCULO impor; |TIPO 0;
   |SI #42#6 = "V";
       #42#11 = #42#7;
       |PINTA #42#11;
       |ACABA;
   |FINSI;
   |SI #42#6 = "C";
      #42#11 = #42#7;
      |PINTA #42#11;
      |ACABA;
   |FINSI;

   |SI #42#7 = 0;  |Y #41#16 ! 0;
      |MENAV "0000********* El Importe debe ser Diferente de CERO *********";
      ||  |ERROR;
      |ACABA;
   |FINSI;


   import1 = (#41#15 + #42#7) ! EURODBMOD;
   import  = (#41#10 - import1) ! EURODBMOD;
   |SI #41#10 > 0;
      |SI import < 0;
         |MENAV "0000****La Amortizacion Fiscal supera el importe de la compra";
         |ERROR;
         |ACABA;
      |FINSI;
   |SINO;
      |SI import > 0;
         |MENAV "0000****La Amortizacion Fiscal supera el importe de la compra";
         |ERROR;
         |ACABA;
      |FINSI;
   |FINSI;
   |HAZ ladif;
|FCAL;

|CALCULO ladif; |TIPO 7;
   #42#13 = #42#11 -  #42#7;
   |PINTA #42#13;
|FCAL;

|CALCULO vert7; |TIPO 7;
 |SI #42#6 ! "A";
     |SI #41#36 = 0;
         |MENSA "    <F3> consultar Factura de Compra o Venta / <F4> Asignar factura ";
     |SINO;
         |MENSA "    <F3> consultar Operacion Financiera";
     |FINSI;
 |SINO;
     |MENSA "    ";
 |FINSI;
|FCAL;

|CALCULO lacons_Linea; |TIPO 11;
 inkey = FSalida;
 |SI inkey = 11; |O inkey = 12;
     |HAZ laconsulta;
     |ERROR;
 |FINSI;
|FCAL;

|CALCULO laconsulta; |TIPO 0;
 inkey = FSalida;
 |SI #42#6 = "A"; |ACABA; |FINSI;

 |SI #41#36 = 0; |O #42#6 = "V";
     |HAZ ConsulFactura;
 |SINO;
     |SI inkey = 11;
         |HAZ ConsulOpera;
     |FINSI;
 |FINSI;
|FCAL;

|PROCESO ConsulFactura;
 |SI inkey  = 11; |O inkey = 12;
     aComVen = #42#6; ||Compra o venta

     enEmpresa   = #41#0;
     enActividad = #41#1;
     enEjer      = #42#5;
     eaElemento  = #41#2;
     enElemeNum  = #41#3;
     aCamp1      = #41#4;
     nCamp2      = #42#4;  || linea
     fCamp3      = #42#9;
     nCamp4      = #42#7;
     nCamp5      = #42#12;
     aCamp6      = #42#10;
     nCamp7      = #42#14;
     aCamp8      = #42#15;
     nCamp9      = #42#16;
     enSwBien = 0;
     |SI inkey = 11; enSwBien = -1; |FINSI;

     |SUB_EJECUTA_NP "dsmoz038";
     |SI enSwBien = 1;
         #42#14 = nCamp7;
         #42#15 = aCamp8;
         #42#16 = nCamp9;
         |ERROR;
     |FINSI;
 |FINSI;
|FPRC;

|RUTINA ClaveBaja361;
 #361#0 = #360#0;
 #361#1 = #360#1;
 #361#2 = 001;
|FRUT;

|RUTINA ClaveAlta361;
 #361#0 = #360#0;
 #361#1 = #360#1;
 #361#2 = 999;
|FRUT;


|PROCESO ConsulOpera;
   |ABRE #360;
   #360#0 = enEmpresa;
   #360#1 = #41#36;
   |LEE 001#360=;
   |SI FSalida ! 0;
       |MENAV "    No existe Operacion Financiera";
       |CIERRA #360;
       |ACABA;
   |FINSI;

   |PUSHV 0501 2380;
   |PINPA #0#360;
   |PINDA #0#360;
   |ENTLINEAL #1#361, -3, 4, 22, 1, ClaveBaja361, ClaveAlta361
   |CIERRA #360;
   |CLS;
   |POPV;
|FPRC;

|CALCULO impor1; |TIPO 0;
   |SI #42#6 ! "A"; |ACABA;  |FINSI;

   |SI #42#11 = 0;  |Y #41#22 ! 0;
      |MENAV "0000********* El Importe debe ser Diferente de CERO *********";
      ||  |ERROR;
      |ACABA;
   |FINSI;


   import1 = (#41#21 + #42#11) ! EURODBMOD;
    import = (#41#10 - import1) ! EURODBMOD;

   |SI #41#10 > 0;
      |SI import < 0;
         |MENAV "0000****La Amortizacion Contable supera el importe de la compra";
         |ERROR;
         |ACABA;
      |FINSI;
   |SINO;
      |SI import > 0;
         |MENAV "0000****La Amortizacion Contable supera el importe de la compra";
         |ERROR;
         |ACABA;
      |FINSI;
   |FINSI;
   |HAZ ladif;
|FCAL;

|CALCULO cal_any; |TIPO 0;
   traba = #42#9;
   any = traba % 704;
   #42#5 = any;
|FCAL;

|CALCULO elTipoLinea; |TIPO 0;
   esaltaL = (FEntrada / 100) ! 0;
   |SI esaltaL = 1; |Y #42Campo = "C";
      |SI #41#15 ! 0;  |O #41#21 ! 0;
         |MENAV "0000Opcion de Compra NO permitida, se esta Amortizando";
         |ERROR;
         |ACABA;
      |FINSI;
   |FINSI;

   |SI #42#4 = 1; |Y #42Campo ! "C";
      |ERROR;
      |ACABA;
   |FINSI;

   |SI #42Campo = "V";  |Y #41#26 > "01.01.0000";
      |MENAV "0000El elemento ya ha sido Vendido";
      |ERROR;
      |ACABA;
   |FINSI;

   |SI #42Campo = "V";  |O #42Campo = "C";
      #42#11 = 0;
      |CAMPO_MODIFICA #42#11, 1, "N";
      |PINTA #42#11;
   |SINO;
      |CAMPO_MODIFICA #42#11, 1, "S";
   |FINSI;
|FCAL;
|| **********************************************************************

|PROCESO EntraAlaLinea;  |TIPO 5;

  |SI enModo = 7;
      |SALVA_DATOS #41;
      #41#0 = enEmpresa;
      #41#2 = "        ";
      #41#3 = 00;
      |LEE 000#41];
      |SI FSalida ! 0; |O #41#0 ! enEmpresa;
          |DDEFECTO #41;
      |FINSI;
      |PINDA #0#41;
      |REPON_DATOS #41;
  |FINSI;

  |SI enModo ! 2; |ACABA; |FINSI;

  |HAZ LaConta;

  || Lee Empresa
    |ABRE #1000;
    #1000#0 = enEmpresa;
    |LEE 041#1000=;
    |SI FSalida ! 0;
        |MENAV "     Empresa Inexistente";
        |CIERRA #1000;
        |ACABA;
    |FINSI;
    #41#32 = #1000#1;
    enTpEm = #1000#87;

    |CIERRA #1000;
    |HAZ Analitica;
|FPRC;

|| ***************************************************************************
|PROCESO LaConta;
  |SI #41#27 > "01.01.0000";
      aAlfa1 = #41#27; aAlfa1 = aAlfa1 % -104;
      enEjer = aAlfa1;
  |FINSI;
  enConcreto = 1;
  enPerConta = -1;
  enSwSinMen = 1;
  |HAZ SituaContagen;
  enConcreto = 0;
  |SI swerror = 1;
     |HAZ SituaMaestra;
     |SI swerror = 1;
          |MENAV "    Atencion, no existe Contabilidad ni de esta Empresa ni de Empresa Maestra";
          errconta = 1;
          |PTEC 807;
          |ACABA;
     |FINSI;
  |FINSI;
  |PATH_DAT #300 #aPathConta#; |PATH_PAN #300 #aPathPanConta#;
  |PATH_DAT #304 #aPathConta#; |PATH_PAN #304 #aPathPanConta#;
  |PATH_DAT #305 #aPathConta#; |PATH_PAN #305 #aPathPanConta#;
  |PATH_DAT #306 #aPathConta#; |PATH_PAN #306 #aPathPanConta#;
  |PATH_DAT #307 #aPathConta#; |PATH_PAN #307 #aPathPanConta#;
  |PATH_DAT #308 #aPathConta#; |PATH_PAN #308 #aPathPanConta#;
  |PATH_DAT #309 #aPathConta#; |PATH_PAN #309 #aPathPanConta#;
  |PATH_DAT #310 #aPathConta#; |PATH_PAN #310 #aPathPanConta#;
  |PATH_DAT #311 #aPathConta#; |PATH_PAN #311 #aPathPanConta#;
  |PATH_DAT #312 #aPathConta#; |PATH_PAN #312 #aPathPanConta#;
  |PATH_DAT #313 #aPathConta#; |PATH_PAN #313 #aPathPanConta#;
  |PATH_DAT #314 #aPathConta#; |PATH_PAN #314 #aPathPanConta#;
  |ABRE #304;
  |DDEFECTO #304;
  |LEE 001#304p;
  |CIERRA #304;
  snFilBa = #304#119;
  enConcreto = 0;
|FPRC;

|| ***************************************************************************
|PROCESO CalculaAmort;

  |SI #41#21 ! 0;  |O #41#15 ! 0; |ACABA;  |FINSI;

  |SI #41#9 [ "01.01.1900"; |ACABA; |FINSI;
  |SI #41#35 = "S"; |ACABA; |FINSI;
  |SI #41#40 = "I"; |ACABA; |FINSI;

  fFechaUso   = #41#9;
  fFechaVenta = #41#26;
  aAlfa  = "31.12." + (fFechaUso % -104);     fFinCompra = aAlfa;
  aAlfa  = "01.01." + (fFechaUso % -104);     fPriCompra = aAlfa;

  aAlfa  = fFechaVenta % -104;                nVAnyo    = aAlfa;
  aAlfa  = "01.01." + (fFechaVenta % -104);   fPriVenta = aAlfa;
  aAlfa  = "31.12." + (fFechaVenta % -104);   fFinVenta = aAlfa;

  |SI fPriVenta < fFechaUso;                  fPriVenta = fFechaUso;  |FINSI;

  aAlfa       = fFechaUso % -104;
  nDAnyo      = aAlfa;
  fFecha      = ~;
  aAlfa       = fFecha % -104;
  nHAnyo      = aAlfa;
  nHAnyo      = nHAnyo - 1;

  |PARA nAnyAmor = nDAnyo;  |SI nAnyAmor [ nHAnyo;  |HACIENDO nAnyAmor = nAnyAmor + 1;
        |SI nAnyAmor > nVAnyo;  |Y nVAnyo ! 0;  |SAL;  |FINSI;

           enEmpresa   = #41#0;
           enActividad = #41#1;
           eaElemento  = #41#2;
           enElemeNum  = #41#3;
           aAlfa       = nAnyAmor;
           aAlfa       = "31.12."+ aAlfa;
           |SI nAnyAmor = nVAnyo; |Y nVAnyo ! 0; |Y #107#18 = "S";
               aAlfa = #41#26;
           |FINSI;
           fFechaAmor =  aAlfa;
           nLineaAmor = 0;
           nConcpAmor = 97;
           aConcpAmor = "AMORTIZACION A¤O: " + nAnyAmor;

           |HAZ CalculaAmor;
           |SI swAmBuena = 0;
               eSWGrabar = 0;
               nLineaAmor = ultlin + 1;
               |HAZ GrabaAmor;
               |SI #42#7 ! 0; |O #42#11 ! 0;
                   #41#0 = enEmpresa
                   #41#1 = enActividad
                   #41#2 = eaElemento
                   #41#3 = enElemeNum
                   |LEE 110#41=;
                   |PINDA #0#41;
               |FINSI;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CalculaCompra;
   || ........ ......    el PROCESO prim_lin
   |SI sw_lin = 0;
      |ABRE #42;
      sw_lin = 1;
      #42#0 = #41#0;
      #42#1 = #41#1;
      #42#2 = #41#2;
      #42#3 = #41#3;
      #42#4 = 1;
      any = #41#27 % 704;
      #42#5 = any;
      #42#6 = "C";
      #42#7 = #41#10;
      #42#8 = "S";
      #42#9 = #41#27;
      #42#10 = "COMPRA ";
      #42#11 = #41#10;
      #42#12 = 1;
      #42#13 = 0;
      #42#14 = 0;
      #42#15 = "";
      #42#16 = 0;
      #42#17 = "N";
      |SI #41#36 ! 0;
          #42#10 = "COMPRA POR LEASING";
          #42#16 = #41#36;
          #42#17 = "S";
      |FINSI;
      |GRABA 021#42n;
      #41#16 = #41#10; |PINTA #41#16;
      #41#22 = #41#10; |PINTA #41#22;
      |CIERRA #42;
   |FINSI;
|FPRC;


**************************************************************************
LLAMADAS DESDE CUENTAS
**************************************************************************
|CALCULO cuenGrupo; |TIPO 7;
  |SI enSwAna = 1;
      |C_V #dsmom040#09,1,"S";
      |C_M #dsmom040#09,1,"S";
      |ATRI P; |PINTA 0934, "Cuenta Analitica: "; |ATRI 0;
  |SINO;
      |C_V #dsmom040#09,1,"N";
      |C_M #dsmom040#09,1,"N";
      |PINTA 0934, "                  ";
  |FINSI;

  |C_M #40#3, 1,"S"; |C_M #40#5, 1,"S";
  |C_M #40#10,1,"S"; |C_M #40#12,1,"S";
  |SI enEjer < 2008;
      |C_M #40#10,1,"N";
      |C_M #40#12,1,"N";
  |SINO;
      |C_M #40#3,1,"N";
      |C_M #40#5,1,"N";
  |FINSI;
|FCAL;

|CALCULO cuentag; |TIPO 6;
     |C_M #40Campo, 0, aAlfa1;
     |SI aAlfa1 = "N"; |ACABA; |FINSI;
     emCta = 1;        || Dar mensajes de error

     eaCuenta = #dsmom040#Campo#;
     salidas  = FSalida;
     |HAZ FiltraPuntos;
     #dsmom040#Campo# = eaCuenta;
     |PINTA #dsmom040#Campo#;

     |HAZ SacaNivel;
     nume1 = Campo + 1;
     #dsmom040#nume1# = enNivel;
|FCAL;

|CALCULO refrescag; |TIPO 0;
   |C_M #40Campo, 0, aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   emCta = 0;        || no Dar mensajes de error
   eaCuenta = #dsmom040#Campo#;
   |HAZ LeeCuenta;
   |SI eswCta = 1;
        |ERROR;
        |CONFI "    SError.! No existe Cuenta. Desea darla de alta ";
        |SI FSalida = 0;
            |SUB_EJECUTA_NP "dsmoz030";
            #dsmom040#Campo# = eaCuenta;
            |PINTA #dsmom040#Campo#;
        |FINSI;
   |SINO;
        |SI eswCta = 2;
            |MENAV "0000Esta Cuenta NO tiene Pase Directo.";
            |ERROR;
        |FINSI;
   |FINSI;
|FCAL;

|PROCESO cuenta08; |TIPO 7;
|FPRC;

|PROCESO elTipo3g; |TIPO 3;
    #dsmom040#8 = #1000#1; ||A todas las Lineas Nombre empresa
|FPRC;
|| ============================================================

|PROCESO EntraAlaLineag;  |TIPO 5;
|FPRC;


|CALCULO AntesAnaG; |TIPO 7;
|FCAL;
|CALCULO anactaG; |TIPO 0;
|FCAL;

|RUTINA inf2;
   #dsmom040#0 = enEmpresa;
   #dsmom040#2 = 0001;
|FRUT;

|RUTINA sup2;
   #dsmom040#0 = enEmpresa;
   #dsmom040#2 = 9999;
|FRUT;

|CALCULO ElsGrups; |TIPO 6;
   |SI FSalida = 10;
      |ABRE #40;
      #40#2 = #41Campo;
      |CONSULTA_F_CLAVE #1#40,inf2,sup2;
      #41Campo = #40#2; |PINTA #41Campo;
      |ERROR;
      |CIERRA #40;
   |FINSI;
   |SI Campo = 38;
       |SI #41#38 = 0;
           |ABRE #40;
           #40#0 = #41#0;
           #40#2 = 0;
           |LEE 041#40=;
           |SI FSalida ! 0;
               |DDEFECTO #40;
               #40#0 = #41#0;
               #40#2 = 0;
               |GRABA 020#40n;
           |FINSI;
           |CIERRA #40;
       |FINSI;
   |FINSI;
|FCAL;

|| ----- Cuentas analiticas
|CALCULO AntesAna; |TIPO 7;
 ModoEntrLin = (FEntrada / 100) ! 0;
 |SI enSwAna = 1;
     |SI ModoEntrLin = 1;
         #41#34 = #dsmom040#9;
         |PINTA #41#34;
     |FINSI;
     eaCuenta = #41#5;
     |HAZ LeeTablaAna;
     |SI swRelac = 0;
         #41#34 = eaCtaAna;
         |C_M #41#34,1,eaAnaMod;
     |SINO;
         || .. |SI ModoEntrLin = 1; #41#34 = ""; |FINSI;
         |SI eaPAna = "S";
             |C_M #41#34,1,"N";
         |SINO;
             |C_M #41#34,1,"S";
         |FINSI;
     |FINSI;
     |PINTA #41#34;
 |FINSI;
|FCAL;

|CALCULO anacta; |TIPO 0;
  inkey = FSalida;
  |SI enSwAna = 0; |ACABA; |FINSI;

    salidas = FSalida; |HAZ FPuntosAna;
    eOpAna = 0; || 1 = Consulta pantalla
    |SI inkey = 10; eOpAna = 1;  |FINSI;
    eaCtaAna = #41#34;
    |HAZ LeeCtaAna;
    |SI eswLect = 1;
        |CONFI "    SError.! No existe Cuenta. Desea darla de alta ";
        |SI FSalida = 0;
            |SUB_EJECUTA_NP "dsmoz035";
        |FINSI;
        #41#34 = eaCtaAna;
        |PINTA #41#34;
        |ERROR;
    |SINO;
        #41#34 = eaCtaAna;
        |PINTA #41#34;

        enQueAna = 5; ||comprobacion
        |SI inkey = 11; enQueAna = 0; |FINSI; ||Consulta
        |SI inkey = 12; enQueAna = 1; |FINSI; ||Modificacion
        |SI inkey = 13; enQueAna = 2; |FINSI; ||Recalculo
        |HAZ GrupoAna;
   |FINSI;
|FCAL;

|PROCESO GrupoAna;

  |SI eaGAna = "S"; |ACABA; |FINSI; ||No existe reparto especifico

  nSwGrupo = 0;
  enEmpresa  = #41#0;
  eaElemento = #41#2;
  enElemeNum = #41#3;
  eaElemeNom = #41#4;
  enElemeCom = #41#10;
  eaGrAna    = #41#34;

  alfa1 = enEmpresa;  |QBF alfa1; alfa1 = ("00000" + alfa1) % -105;
  alfa2 = enPerConta; |QBF alfa2; alfa2 = ("0"     + alfa2) % -101;
  alfa3 = ":contagen/anm00014 canempr1 " + alfa1 + alfa2;
  |PUSHV 0622 2380;
  |SUB_EJECUTA_NP alfa3;
  |SI nSwGrupo = 1;
      |ERROR;
  |FINSI;
  |POPV;
|FPRC;
