|FICHEROS;
   dsmoz093 #0;

   dsmom057 #57;

   dsmom059 #59,MANTE;

   dsmow053 #53,MANTE;

   :/contagen/def/caw00098 #901,MANTE;

   referen@ #1000;
|FIN;

|VARIABLES;
  &nBoton2 = 0;

  &swUno  = 0;
  &enAnyO = 0;
  &enAnyD = 0;

  aTexto = "";

  nDTipo = 0;
  nHTipo = 9;
  aTipo = "";
  enEjercicio = 0;
  aF2     = "";
  aEsc    = "";
  &nTecla  = 0;
  &eaRelCta = "";
  nEstado = 0;
  nLnEstado = 0;

   aAlfa1  = "";
   nCuenta = 0;
   nNume1  = 0;
   nNume2  = 0;
   nNume3  = 0;
   nNume4  = 0;
   nModoEntrada = 0;
   nUltCod = 0;

   nCasilla   = 0;
   aMas       = "";
   &eaTabMod  = "";
   aQueQuiero = "";
   aTitulo    = "";
   aNumCampos = "";
   nNumCampos = 0;
   nCampos    = 0;
   nCampo     = 0;
   aNombCampo = "";
   aTipoCampo = "";
   aLongCampo = "";
   aDirInicio = "";
    aFichero  = "";
    nContador = 0;
   nNoClave   = 0;
    aDirBase  = "";
  aPath       = "";
  aPathImpuesto = "";
  nInkey      = 0;

  fFecha     = @;


  aAlfa3 = "";
  aAlfa4 = "";
  nCont1 = 0;
  nCont2 = 0;
  aDire  = "";
  aFich  = "";
  handle = 0;
  nFlag  = 0;
  nMenos = 0;
  aDatos = "";
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;

|| ... ... ... ... ...

|RUTINA ClaveBaja58;
 #59#0 = #0#0;
 #59#1 = 01;
 #59#2 = 000;
|FRUT;

|RUTINA ClaveAlta58;
 #59#0 = #0#0;
 #59#1 = 99;
 #59#2 = 999;
|FRUT;


|PROCESO WTipo11;  |TIPO 11;
 nTecla = FSalida;
 |HAZ MTipo0;
 |SI nTecla = 14; |HAZ Copiar; |FINSI;
|FPRC;

|PROCESO MTipo7; |TIPO 7;
   |CONTROL_SIMPLE 0, "LBOTON,F2 Deducciones", 0759, 0774, Boton2;
   nBoton2 = FSalida;

   |ENTLINEAL #1#59, -2, 7, 22, 0, ClaveBaja58, ClaveAlta58;
|FPRC;

|PROCESO MTipo0;  |TIPO 0;
 enEjercicio = #0#0;

 |FIN_CONTROL_WINDOWS nBoton2;
 |PULSATECLA;

 |SI nTecla = 10;
     |ENTLINEAL #1#59, -2, 2, 22, 0, ClaveBaja58, ClaveAlta58;
 |FINSI;
|FPRC;

|PROCESO Boton2;
  |PTEC 824;
|FPRC;


|PROCESO Quepasa;
 nTecla = FSalida;
 |HAZ MTipo0;
|FPRC;

|PROCESO BorraLineas0;
 |BORRA 020#59a;
 |LIBERA #59;
|FPRC;

|DEFBUCLE BorraLineas;
 #59#1;
 ;
 #0#0, nDTipo, 001;
 #0#0, nHTipo, 999;
 be;
 NULL, BorraLineas0;
|FIN;

|PROCESO MTipo1; |TIPO 1;
 nEstado = (FEntrada / 100) ! 0;
 |SI nEstado = 3;
     |CONFI "    NEsta seguro de borrar el Control ";
     |SI FSalida = 0;
         nHTipo = 00;
         nHTipo = 99;
         |BUCLE BorraLineas;
     |SINO;
         |ERROR;
     |FINSI;
 |FINSI;
|FPRC;

|| **********************************************************************

|PROCESO elTLinea; |TIPO 0;

     |SI #59#3 = "S"; |O #59#3 = "R";
         |SI #59#3 = "S"; #59#4 = "--------------- Salto Pagina"; |FINSI;
         |SI #59#3 = "R"; #59#4 = "--------------- Raya"; |FINSI;
         |PINTA #59#4;
         #59#5 = 0; |PINTA #59#5;
         #59#6 = 0; |PINTA #59#6;
         #59#7 = 0; |PINTA #59#7;
         #59#8 = 0; |PINTA #59#8;
         #59#9 = 0; |PINTA #59#9;
         #59#10= 0; |PINTA #59#10;
         |PTEC 806;
     |FINSI;

     |SI #59#3 = "D";
         |C_M #59#5,1,"N"; #59#5 = 0; |PINTA #59#5;
         |C_M #59#6,1,"N"; #59#6 = 0; |PINTA #59#6;
         |C_M #59#7,1,"N"; #59#7 = 0; |PINTA #59#7;
         |C_M #59#8,1,"N"; #59#8 = 0; |PINTA #59#8;
         |C_M #59#9,1,"N"; #59#9 = 0; |PINTA #59#9;
         |C_M #59#10,1,"N"; #59#10 = 0; |PINTA #59#10;
     |SINO;
         |C_M #59#5,1,"S";
         |C_M #59#6,1,"S";
         |C_M #59#7,1,"S";
         |C_M #59#8,1,"S";
         |C_M #59#9,1,"S";
         |C_M #59#10,1,"S";
    |FINSI;
|FPRC;

|PROCESO LeeCodTab;
 nUltCod = 0;
 |ABRE #901;
 #901#0 = enModelo;
 #901#1 = nCasilla;
 |LEE 001#901=;
 |SI FSalida ! 0;
     nUltCod = 1;
 |FINSI;
 |CIERRA #901;
|FPRC;

|CALCULO TrasImpuesto; |TIPO 0;
 nTecla = FSalida;
 nCampo = Campo;
 |C_M #59Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 nCasilla = #59nCampo;

 enModelo = #0#0 - 2000;

 |SI nTecla = 10;
     |HAZ TablaImpuesto;
 |FINSI;
 |SI nCasilla = 0;
     nNume1 = nCampo + 1; #59nNume1 = 0;  |PINTA #59nNume1;
     |ACABA;
 |FINSI;
 nNume1 = nCampo + 1;
 |HAZ LeeCodTab;
 |SI nUltCod = 1;
     |ERROR;
 |SINO;
     #59nCampo = nCasilla; |PINTA #59nCampo;

     aAlfa1 = #901#2; aAlfa1 = aAlfa1 - "Casilla";
                      aAlfa1 = aAlfa1 - "Campo";
     #59nNume1 = aAlfa1; |PINTA #59nNume1;
 |FINSI;
|FCAL;


|CALCULO LaClave7; |TIPO 7;
 #59#0 = #0#0;
|FCAL;

|CALCULO LaClave3; |TIPO 3;
 #59#0 = #0#0;
|FCAL;

|CALCULO Linea0; |TIPO 0;
|FCAL;

|| ********************************************************************
|RUTINA ClauBaja57;
 |SI FSalida = "POSICION";
     #0#0 = nNume2;
 |SINO;
     #0#0 = 1990;
 |FINSI;
|FRUT;

|RUTINA ClauAlta57;
 #0#0 = 2900;
|FRUT;

|PROCESO Auxiliar;
 #0#0 = #57#0;
 |GRABA 020#0n;
|FPRC;

|DEFBUCLE Auxiliar;
 #57#1;
 ;
 1900;
 3999;
 ;
 NULL, Auxiliar;
|FIN;


|PROGRAMA;

 || .. |HAZ PasoSecun;


 |DBASS aPath; |QBT aPath;
 aPathImpuesto = aPath + "contasoc/fich/";

 |HAZ CargaTablaAux;

 fFecha = ~;
 aAlfa1 = fFecha; aAlfa1 = aAlfa1 % -104;
 nNume2 = aAlfa1;
 nNume2 = nNume2 - 1;

 |CLS;
 |CABEZA "Control Compr. Impuesto Sociedades Deducciones";

 aFichero = "3w" + Usuario;
 |NOME_DAT #0 aFichero;
 |DELINDEX #0;

 |ABRE #0;
 |BUCLE Auxiliar;
 |CIERRA #0;

 |ENTLINEAL #1#0, -1, 2, 22, 1, ClauBaja57, ClauAlta57;
 |DELINDEX #901;
|FPRO;

|| ********************************************************************
|| ///// Carga de Auxiliar del fichero del Impuesto
|PROCESO CargaTemporal;
     aMas  = aDirInicio + "contasoc/def/" + aFichero;
     |CARGA_DEF aMas, referen@;
     |SI FSalida ! 0;
         |MENAV  "         Error en cargar el Def ... Proceso Abortado.";
         |ACABA;
     |FINSI;

     aQueQuiero = "|TITULO";
     aTitulo    = #referen@#aQueQuiero#;  |QBF aTitulo;

     nNoClave  = 2;
     #901#0    = nContador;
     #901#4    = aFichero;
     #901#5    = "contasoc";
     #901#6    = aTitulo;

     aQueQuiero = "|NC";
     aNumCampos = #referen@#aQueQuiero#;
     nNumCampos = aNumCampos;
     nNumCampos = nNumCampos - 1;
     |PARA nCampos = nNoClave;  |SI nCampos [ nNumCampos;  |HACIENDO nCampos = nCampos + 1;
           aQueQuiero = "|C" + (("000" + nCampos) % -103) + "NOMBRE";
           aNombCampo = #referen@#aQueQuiero#;

           aQueQuiero = "|C" + (("000" + nCampos) % -103) + "TIPO";
           aTipoCampo = #referen@#aQueQuiero#;

           |SI aTipoCampo = "N";
               aQueQuiero = "|C" + (("000" + nCampos) % -103) + "LONGITUD";
               aLongCampo = #referen@#aQueQuiero#;

               #901#1 = nCampos;
               #901#2 = aNombCampo;
               #901#3 = aLongCampo;
               |GRABA 020#901n;
               |LIBERA #901;
           |FINSI;
     |SIGUE;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO CargaTablaAux;
     eaTabMod = ("zm" + Usuario + "zzzzzzzzz") % 108;
     |NOME_DAT #901 eaTabMod;
     |ABRE #901;  |CIERRA #901;  |DELINDEX #901;

     |DBASS aDirInicio;
     |DBASE aDirBase;

     |ABRE #901;
     aFichero = "isocie85";  nContador = 007; |HAZ CargaTemporal;
     aFichero = "isocie84";  nContador = 006; |HAZ CargaTemporal;
     aFichero = "isocie83";  nContador = 005; |HAZ CargaTemporal;
     aFichero = "isocie82";  nContador = 004; |HAZ CargaTemporal;
     aFichero = "isocie81";  nContador = 003; |HAZ CargaTemporal;
     aFichero = "isocie76";  nContador = 002; |HAZ CargaTemporal;
     aFichero = "isocie74";  nContador = 001; |HAZ CargaTemporal;
     |CIERRA #901;
|FPRC;
|| -------------------------------------------------------------------

|RUTINA ClInf901;
 #901#0 = enModelo;
 #901#1 = 1;
 #901#2 = "                    ";
|FRUT;

|RUTINA ClSup901;
 #901#0 = enModelo;
 #901#1 = 999;
 #901#2 = "zzzzzzzzzzzzzzzzzzzz";
|FRUT;

|PROCESO TablaImpuesto;
 |PUSHV 0701 2157;
 nCasilla = #59nCampo;
 |PINPA #0#901;
 #901#0 = enModelo; |PINTA #901#0;
 |ENTLINEAL #1#901, -2, 4, 20, 0, ClInf901, ClSup901;
 |POPV;
|FPRC;

|CALCULO wTip11; |TIPO 11;
 nTecla = FSalida;
 |SI nTecla = 1; |O nTecla = 0;
     nCasilla = #901#1;
 |FINSI;
|FCAL;

|CALCULO wTip5; |TIPO 0;
 nTecla = FSalida;
 |SI nTecla = 0;
     |PTEC 806;
     |PTEC 808;
 |FINSI;
|FCAL;

|| ----------------------------------------------------------------
|CALCULO QueCopio; |TIPO 0;
|FCAL;

|CALCULO noigual; |TIPO 0;
 |SI #53#1 = #53#0;  |AVISO; |ERROR;  |FINSI;
|FCAL;

|| ---------------------
|PROCESO CopiarLin;
     |SALVA_FICHA #59;
     #59#0 = #53#1;
     |GRABA 020#59n;
     |REPON_FICHA #59;
     |LIBERA #59;
|FPRC;

|DEFBUCLE CopiaLineas;
     #59#1;
     ;
     #53#0, nDTipo, 000;
     #53#0, nHTipo, 999;
     be;
     NULL, CopiarLin;
|FIN;

|PROCESO Copiar; ||*********** Proceso para duplicar control

 |ERROR;

 |PUSHV 0712 1838;
 |PUSHV 1212 1838;
 |PINPA #0#53;
 |POPV;
 |C_M #53#2, 1, "N"; |C_V #53#2, 1, "N";
 |C_M #53#3, 1, "N"; |C_V #53#3, 1, "N";
 |C_M #53#4, 1, "N"; |C_V #53#4, 1, "N";
 |C_M #53#5, 1, "N"; |C_V #53#5, 1, "N";
 |C_M #53#6, 1, "N"; |C_V #53#6, 1, "N";

 #53#1 = #0#0;
 #53#0 = #53#1 - 1;
 |PINDA #0#53;
 |ENDATOS #1#53;
 |SI FSalida ! 0;
     |POPV;
     |ACABA;
 |FINSI;

 |SI #53#0 = #53#1;
     |MENAV "    Error El mismo A¤o ";
     |POPV;
     |ACABA;
 |FINSI;

 #0#0  = #53#0;
 |LEE 001#0=;
 |SI FSalida ! 0;
     |MENAV "    Copia cancelada. Tabla A¤o Origen inexistente ...";
     |POPV;
     |ACABA;
 |FINSI;
 |SALVA_DATOS #0;

 #0#0 = #53#1;
 |LEE 001#0=;
 |SI FSalida = 0;
     |AVISO;
     |CONFI "    NRegrabar Tabla del A¤o Destino YA EXISTENTE (S/N): ";
     |SI FSalida ! 0;
         |MENAV "    Copia cancelada ...";
         |POPV;
         |REPON_DATOS #0;    ||para que no se queda el salvadatos suelto
         |ACABA;
     |SINO;
         |BORRA 020#0a;
         nDTipo = 0;  nHTipo = 99;
         |BUCLE BorraLineas;
     |FINSI;
 |FINSI;

 |REPON_DATOS #0;
 #0#0  = #53#1;
 |GRABA 020#0n;

 nDTipo = 0;  nHTipo = 99;
 |BUCLE CopiaLineas;
 |POPV;

 |PTEC 809;
 |PTEC 808;
|FPRC;



|PROCESO Graba59;
  aAlfa1 = aDatos % 102;
  nNume2 = aAlfa1;
  |SI nCont1 = 0; nCont1 = nNume2; |FINSI;
  |SI nNume2 > 6; |ACABA; |FINSI;

  |SI nNume2 ! nCont1;
      |SI nNume1 < 3; |GRABA 020#59n; |FINSI;
      nCont1 = nNume2;
      nNume1 = 0;
      nCont2 = 0;
  |FINSI;

  nNume1 = nNume1 + 1; |SI nNume1 = 4; nNume1 = 1; |FINSI;
  |SI nNume1 = 1;
      nCont2 = nCont2 + 5;
      aAlfa4 = aDatos % 365; |QBF aAlfa4;
  |FINSI;
  aAlfa3 = aDatos % -105;
  aAlfa3 = aAlfa3 - "[";
  aAlfa3 = aAlfa3 - "]";
  #59#0 = 2006;
  #59#1 = nCont1;
  #59#2 = nCont2;
  #59#3 = "N";
  #59#4 = aAlfa4;
  |SI nNume1 = 1; #59#6  = aAlfa3; |FINSI;
  |SI nNume1 = 2; #59#8  = aAlfa3; |FINSI;
  |SI nNume1 = 3; #59#10 = aAlfa3; |FINSI;
  |SI nNume1 = 3;
      |GRABA 020#59n;
  |FINSI;
  |SI nNume1 = 2;
      |SI nCont1 = 2; |Y nCont2 = 5;
          |GRABA 020#59n;
          nNume1 = 0;
      |FINSI;
      |SI nCont1 = 5; |Y nCont2 = 5;
          |GRABA 020#59n;
          nNume1 = 0;
      |FINSI;
      |SI nCont1 = 6; |Y nCont2 = 5;
          |GRABA 020#59n;
          nNume1 = 0;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO PasoSecun;

     nCont1 = 0;
     nCont2 = 0;
     |ABRE #59;

     aDire = "c:/tmp/";
     aFich = "prueba.txt"; |QBF aFich;
     aFich  = aDire + aFich;
     |XABRE "U", aFich, handle;
     |SI FSalida < 0;
         |XABRE "CU", aFich, handle;
     |FINSI;

     |SI FSalida ] 0;
          nFlag  = FSalida;
          |PARA; |SI; |HACIENDO;
                 |XLEE handle, 250, aDatos;
                 |SI FSalida > 0;
                     |HAZ Graba59;
                 |SINO;
                     |SAL;
                 |FINSI;
          |SIGUE;
          FSalida = nFlag;
          |XCIERRA handle;
          Pos = nMenos;
     |SINO;
          |MENAV "    Fichero de Compras no encontrado";
     |FINSI;
     |CIERRA #59;
|FPRC;
