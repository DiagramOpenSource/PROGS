|FICHEROS;
     dsz00002;
     dsw00001;
     dsw00002,MANTE;

     dsborsql;

     dsficher;
     agifigen;

     origen@;
     destin@;
|FIN;

|VARIABLES;
     n1Vent              = 0;
     nGrid1              = 0;
     nLbl1               = -1;
     nLbl2               = -1;
     nLbl3               = -1;
     nLbl4               = -1;
     nRango              = 0;
     nHandle             = 0;
     nTree               = 0;
     nLinea              = 0;
     nLong               = 0;
     nCampo              = 0;
     nCaracter           = 0;
     nPos                = 0;
     nPrime              = 0;
     nCmp                = 0;
     nCmpCli             = 0;
     nTCmp               = 0;
     nPanta              = 0;
     nSwTgzOk            = 0;

     aFic                = "";
     aFicSQL             = "";
     aFicCSV             = "";
     aFicTar             = "";
     aEsc1               = "";
     aEsc2               = "";
     aRetu               = "";
     aTecla              = "";
     aAlfa               = "";
     aPathTmp            = "";
     aPathTar            = "";
     aAbre               = "";
     aCampoA             = "";
     aCampoB             = "";
     aCadena             = "";
     aLong               = "";
     aTab                = "";
     aCarac1             = "";
     aRuta               = "";
     aHora               = "";
     aDBase              = "";
     aDBass              = "";
     aPathPaq            = "";
     aPathApl            = "";
     aPathSql            = "";
     aPathCtO            = "";
     aPathCtD            = "";
     aPathOri            = "";
     aPaq                = "";
     aApl                = "";
     aMas                = "";
     aPro                = "";
     aQQ                 = "";
     aDir                = "";
     aOri                = "";
     aDes                = "";
     aParaBor            = "";
     aParaIni            = "";
     aEjecuta            = "";
     aLee                = "";
     aIPRemoto           = "";
     aBorra              = "";
     aPass               = "";

     fFecha              = @;

 {-1}aVent               = "";
     aVent1              = 0;
     aVent2              = 0;
     aVent3              = 0;
     aVent4              = 0;
     aVent5              = "";

 {-1}sTree               = 0;
     sT_nID              = 0;
     sT_nOper            = 0;
     sT_aData            = "";

  {1}aContiene           = "";

     &eaOrigen           = "";
     &eaDestino          = "";
     &eaUnidadBasico     = "";

     &aPathFich          = "";
     &eaEjec             = "";
|FIN;

|PROCESO FinVent1;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO DocMegwordl;
     aPathCtO = aDBass + "contasoc/emisiones";
     aPathCtO = aPathCtO + "/" + (("00000" + #origen@#0) % -105);
     aPathCtO = aPathCtO + "/" + (("0000" + #origen@#1) % -104);
     aPathCtO = aPathCtO + "/";

     aPathCtD = aPathApl + "emisiones";                           |MKDIR aPathCtD;
     aPathCtD = aPathCtD + "/" + (("00000" + #origen@#0) % -105); |MKDIR aPathCtD;
     aPathCtD = aPathCtD + "/" + (("0000" + #origen@#1) % -104);  |MKDIR aPathCtD;
     aPathCtD = aPathCtD + "/";

     aOri = aPathCtO + #origen@#2;   |QBF aOri;
     aDes = aPathCtD + #origen@#2;   |QBF aDes;
     |COPIA_FICHERO aOri, aDes;
|FPRC;

|PROCESO DocSocm0005;
     aPathCtO = aDBass + "basica/documentos/actas/";

     aPathCtD = aPathApl + "documentos";    |MKDIR aPathCtD;
     aPathCtD = aPathCtD + "/actas";        |MKDIR aPathCtD;
     aPathCtD = aPathCtD + "/";

     aFic = ("00000" + #origen@#0) % -105;
     aFic = aFic + ("0000"  + #origen@#1) % -104;
     aFic = aFic + ("0000"  + #origen@#2) % -104;
     aFic = aFic + "1." + #origen@#5;             |QBF aFic;

     aOri = aPathCtO + aFic;
     aDes = aPathCtD + aFic;
     |COPIA_FICHERO aOri, aDes;

     aFic = ("00000" + #origen@#0) % -105;
     aFic = aFic + ("0000"  + #origen@#1) % -104;
     aFic = aFic + ("0000"  + #origen@#2) % -104;
     aFic = aFic + "2." + #origen@#6;             |QBF aFic;

     aOri = aPathCtO + aFic;
     aDes = aPathCtD + aFic;
     |COPIA_FICHERO aOri, aDes;
|FPRC;

|PROCESO Registros;
     nCmpCli = #dsficher#4;

     |DFICE aPathSql;  |QBT aPathSql;

     aPathOri = aDBass + #dsficher#0 + "/fich/";
     |SI #dsficher#0 = "contagen";
         aPathOri = aDBass + #dsficher#0 + "/fich/000000/";
     |FINSI;

     |QBT aPathOri;

     aPro = #dsficher#0 + "/def/" + #dsficher#1;  |QBT aPro;
     aMas = aDBass + aPro;                        |QBT aMas;

     aOri  = aMas;
     aDes  = aDBase + "def/dsborsql.mas";
     |COPIA_FICHERO aOri, aDes;

     aFicSQL = "sql" + Usuario;
     eaEjec  = "SELECT * FROM dsborsql INTO " + aPathSql + aFicSQL + " WHERE ";
     eaEjec  = eaEjec + nCmpCli + " == " + #dsw00001#0;

     aPathFich = aPathOri;
     |SUB_EJECUTA "dsborra1;NOMEQUITESQUETECORTOLOSGUEVOS";

     |CARGA_DEF aMas, origen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aMas, destin@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #origen@;
         |ACABA;
     |FINSI;

     aQQ   = "|NC";
     aAlfa = #origen@#aQQ#;
     nTCmp = aAlfa;
     nTCmp = nTCmp - 1;

     |PATH_DAT #destin@#aPathApl#;
     |PATH_DAT #origen@#aPathSql#;
     |NOME_DAT #origen@#aFicSQL#;

     |ABRE #origen@;
     |ABRE #destin@;

     |LEE 000#origen@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |PARA nCmp = 0;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
                #destin@#nCmp# = #origen@#nCmp#;
          |SIGUE;

          |GRABA 020#destin@.n;
          |LIBERA #destin@;

          |SI aPro = "contasoc/def/megwordl.mas";
              |HAZ DocMegwordl;
          |FINSI;

          |SI aPro = "basica/def/socm0005.mas";
              |HAZ DocSocm0005;
          |FINSI;

          |LEE 000#origen@.s;
     |SIGUE;

     |CIERRA #origen@;
     |CIERRA #destin@;

     |DELINDEX #origen@;
     |DESCARGA_DEF #destin@;
     |DESCARGA_DEF #origen@;
|FPRC;

|PROCESO dsficher;
     |SI #dsficher#5 = "N";
         |ACABA;
     |FINSI;

     |SI #dsficher#0 = "facturar";
         |ACABA;
     |FINSI;

     aPathApl = aPathPaq + #dsficher#0;  |QBF aPathApl;

     |SI #dsficher#0 = "contagen";
         aPathApl = aPathApl + "/000000";
     |FINSI;

     |SI aApl ! #dsficher#0;
         |SI nLbl4 ! -1;
             |FIN_CONTROL_WINDOWS nLbl4;
         |FINSI;

         aAlfa = "LABEL,{{16}}" + #dsficher#0;
         |CONTROL_SIMPLE 0, aAlfa, 1860, 1898, NULL;
         nLbl4 = FSalida;
         |PULSATECLA;

         |SI nPrime = 0;
             |MKDIR aPathApl;
         |FINSI;

         aApl = #dsficher#0;
     |FINSI;

     aPathApl = aPathApl + "/";

     |HAZ Registros;
|FPRC;

|DEFBUCLE dsficher;
     #dsficher#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsficher;
|FIN;

|PROCESO CopiaEmpConta;
     aPathCtO = aPathOri + (("00000" + #origen@#2) % -105) + #origen@#3;
     aPathCtD = aPathApl + (("00000" + #origen@#2) % -105) + #origen@#3;
     |MKDIR aPathCtD;

     aPathCtO = aPathCtO + "/";
     aPathCtD = aPathCtD + "/";

     aDir = aPathCtO + "*.*";
     |_PDIR aDir;
     |PARA; |SI FSalida = 0; |HACIENDO;
            aFic = aDir - aPathCtO;
            aOri = aDir;
            aDes = aPathCtD + aFic;
            |COPIA_FICHERO aOri, aDes;

            |_SDIR aDir;
     |SIGUE;
|FPRC;

|PROCESO Contagen;
     aPathApl = aPathPaq + "contagen";

     |SI nLbl4 ! -1;
         |FIN_CONTROL_WINDOWS nLbl4;
     |FINSI;

     aAlfa = "LABEL,{{16}}contagen";
     |CONTROL_SIMPLE 0, aAlfa, 1860, 1898, NULL;
     nLbl4 = FSalida;
     |PULSATECLA;

     aPathApl = aPathApl + "/";

     aPathOri = aDBass + "contagen/fich/";
     |QBT aPathOri;

     aMas = aDBass + "contagen/def/canempre.mas";

     |CARGA_DEF aMas, origen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aMas, destin@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #origen@;
         |ACABA;
     |FINSI;

     aQQ   = "|NC";
     aAlfa = #origen@#aQQ#;
     nTCmp = aAlfa;
     nTCmp = nTCmp - 1;

     |PATH_DAT #origen@#aPathOri#;
     |PATH_DAT #destin@#aPathApl#;

     |ABRE #origen@;
     |ABRE #destin@;

     nCmpCli = 2;

     |DDEFECTO #origen@;
     #origen@#nCmpCli# = #dsw00001#0;
     |LEE 000#origen@.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #origen@#nCmpCli# ! #dsw00001#0;
              |SAL;
          |FINSI;

          |PARA nCmp = 0;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
                #destin@#nCmp# = #origen@#nCmp#
          |SIGUE;

          |GRABA 020#destin@.n;
          |LIBERA #destin@;

          |HAZ CopiaEmpConta;

          |LEE 000#origen@.s;
     |SIGUE;

     |CIERRA #origen@;
     |CIERRA #destin@;

     |DESCARGA_DEF #destin@;
     |DESCARGA_DEF #origen@;
|FPRC;

|PROCESO CopiaFicGAD;
     aOri = #origen@#7;  |QBF aOri;
     aOri = aOri + #origen@#9;     |QBF aOri;
     aDes = aPathApl + #origen@#9; |QBF aDes;
     |COPIA_FICHERO aOri, aDes;
|FPRC;

|PROCESO GAD;
     aPathApl = aPathPaq + "dsarchi";
     |SI nPrime = 0;
         |MKDIR aPathApl;
     |FINSI;

     |SI nLbl4 ! -1;
         |FIN_CONTROL_WINDOWS nLbl4;
     |FINSI;

     aAlfa = "LABEL,{{16}}dsarchi";
     |CONTROL_SIMPLE 0, aAlfa, 1860, 1898, NULL;
     nLbl4 = FSalida;
     |PULSATECLA;

     aPathApl = aPathApl + "/";

     aPathOri = aDBass + "dsarchi/fich/";
     |QBT aPathOri;

     aMas = aDBass + "dsarchi/def/dsarm005.mas";

     |CARGA_DEF aMas, origen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aMas, destin@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #origen@;
         |ACABA;
     |FINSI;

     aQQ   = "|NC";
     aAlfa = #origen@#aQQ#;
     nTCmp = aAlfa;
     nTCmp = nTCmp - 1;

     |PATH_DAT #origen@#aPathOri#;
     |PATH_DAT #destin@#aPathApl#;

     |ABRE #origen@;
     |ABRE #destin@;

     nCmpCli = 8;

     |SELECT #3#origen@;
     |DDEFECTO #origen@;
     #origen@#nCmpCli# = #dsw00001#0;
     #origen@#4        = "01.01.0000";
     #origen@#5        = "";
     |LEE 000#origen@.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #origen@#nCmpCli# ! #dsw00001#0;
              |SAL;
          |FINSI;

          |PARA nCmp = 0;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
                #destin@#nCmp# = #origen@#nCmp#
          |SIGUE;

          |GRABA 020#destin@.n;
          |LIBERA #destin@;

          |HAZ CopiaFicGAD;

          |LEE 000#origen@.s;
     |SIGUE;

     |CIERRA #origen@;
     |CIERRA #destin@;

     |DESCARGA_DEF #destin@;
     |DESCARGA_DEF #origen@;
|FPRC;

|PROCESO Listin;
     aPathApl = aPathPaq + "integral";

     |SI nLbl4 ! -1;
         |FIN_CONTROL_WINDOWS nLbl4;
     |FINSI;

     aAlfa = "LABEL,{{16}}integral";
     |CONTROL_SIMPLE 0, aAlfa, 1860, 1898, NULL;
     nLbl4 = FSalida;
     |PULSATECLA;

     aPathApl = aPathApl + "/";

     aPathOri = aDBass + "integral/fich/";
     |QBT aPathOri;

     aMas = aDBass + "integral/def/dsam0106.mas";

     |CARGA_DEF aMas, origen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aMas, destin@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #origen@;
         |ACABA;
     |FINSI;

     aQQ   = "|NC";
     aAlfa = #origen@#aQQ#;
     nTCmp = aAlfa;
     nTCmp = nTCmp - 1;

     |PATH_DAT #origen@#aPathOri#;
     |PATH_DAT #destin@#aPathApl#;

     |ABRE #origen@;
     |ABRE #destin@;

     nCmpCli = 0;

     |DDEFECTO #origen@;
     #origen@#nCmpCli# = #dsw00001#1;
     |LEE 000#origen@.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #origen@#nCmpCli# ! #dsw00001#1;
              |SAL;
          |FINSI;

          |PARA nCmp = 0;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
                #destin@#nCmp# = #origen@#nCmp#
          |SIGUE;

          |GRABA 020#destin@.n;
          |LIBERA #destin@;

          |LEE 000#origen@.s;
     |SIGUE;

     |CIERRA #origen@;
     |CIERRA #destin@;

     |DESCARGA_DEF #destin@;
     |DESCARGA_DEF #origen@;

     aMas = aDBass + "integral/def/dsam0107.mas";

     |CARGA_DEF aMas, origen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aMas, destin@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #origen@;
         |ACABA;
     |FINSI;

     aQQ   = "|NC";
     aAlfa = #origen@#aQQ#;
     nTCmp = aAlfa;
     nTCmp = nTCmp - 1;

     |PATH_DAT #origen@#aPathOri#;
     |PATH_DAT #destin@#aPathApl#;

     |ABRE #origen@;
     |ABRE #destin@;

     nCmpCli = 0;

     |DDEFECTO #origen@;
     #origen@#nCmpCli# = #dsw00001#1;
     |LEE 000#origen@.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #origen@#nCmpCli# ! #dsw00001#1;
              |SAL;
          |FINSI;

          |PARA nCmp = 0;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
                #destin@#nCmp# = #origen@#nCmp#
          |SIGUE;

          |GRABA 020#destin@.n;
          |LIBERA #destin@;

          |LEE 000#origen@.s;
     |SIGUE;

     |CIERRA #origen@;
     |CIERRA #destin@;

     |DESCARGA_DEF #destin@;
     |DESCARGA_DEF #origen@;
|FPRC;

|PROCESO dsw00001;
     |SI nLbl2 ! -1;
         |FIN_CONTROL_WINDOWS nLbl2;
     |FINSI;

     aAlfa = "LABEL,{{16}}" + (("00000" + #dsw00001#0) % -105);
     aAlfa = aAlfa + " " + #dsw00001#1;  |QBF aAlfa;
     |CONTROL_SIMPLE 0, aAlfa, 1560, 1698, NULL;
     nLbl2 = FSalida;
     |PULSATECLA;

     |BUCLE dsficher;
     |PULSATECLA;

     |HAZ Contagen;
     |PULSATECLA;

     |HAZ Listin;
     |PULSATECLA;

     |SI #dsw00002#0 = "S";
         |HAZ GAD;
         |PULSATECLA;
     |FINSI;

     nPrime = 1;

     |BORRA 020#dsw00001.a;
     |LIBERA #dsw00001;

     |REFRESCACONTROL nGrid1;
|FPRC;

|DEFBUCLE dsw00001;
     #dsw00001;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dsw00001;
|FIN;


|PROCESO T12w2;  |TIPO 12;
     |SI FSalida = 7;
         |HAZ FinVent1;
         |ACABA;
     |FINSI;

     aAlfa = #dsw00002#1;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Introduzca una ubicaci¢n";
         |ERROR;
         |ACABA;
     |FINSI;

     |HAZ FinVent1;

     fFecha = ~;
     |HORA aHora;
     aPaq   = (fFecha % -104) + (fFecha % 402) + (fFecha % 102);
     aPaq   = aPaq + (aHora % 102) + (aHora % 402) + (aHora % 702);

     |DBASS aDBass;
     |DBASE aDBase;
     aPathPaq = aDBase + "tmp";                   |MKDIR aPathPaq;
     aPathPaq = aDBase + "tmp/paquetes";          |MKDIR aPathPaq;
     aPathPaq = aDBase + "tmp/paquetes/" + aPaq;  |MKDIR aPathPaq;
     aPathPaq = aDBase + "tmp/paquetes/" + aPaq + "/";

     |CONTROL_SIMPLE 0, "LABEL,{{15}}Cliente", 1460, 1498, NULL;
     nLbl1 = FSalida;

     |CONTROL_SIMPLE 0, "LABEL,{{15}}Aplicaci¢n", 1760, 1798, NULL;
     nLbl3 = FSalida;

     nPrime = 0;
     |BUCLE dsw00001;

     |FIN_CONTROL_WINDOWS nLbl1;
     |FIN_CONTROL_WINDOWS nLbl2;
     |FIN_CONTROL_WINDOWS nLbl3;
     |FIN_CONTROL_WINDOWS nLbl4;
|FPRC;

|PROCESO Ubica;
     |DBASE aDBase;   |QBF aDBase;

     |HAZ LeeUnidadBasico;
     aPathTmp = eaUnidadBasico + "\documentos";         |RMKDIR aPathTmp;
     aPathTmp = aPathTmp + "\dsselect";  |RMKDIR aPathTmp;
     aPathTmp = aPathTmp + "\";

     eaOrigen  = aDBase + "plantillas/dsselect.exe";
     eaDestino = aPathTmp + "dsselect.exe";
     |HAZ EnviaFicheroConMD5;
     |XABRE "EC", eaDestino, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aParaBor = aPathTmp + "dsselect.txt";
     aParaIni = aPathTmp + "dsselect.ini";

     |RFBORRA aParaIni;

     aAlfa = &34 + eaUnidadBasico + &34 + " " + &34 + aParaBor + &34;
     aAlfa = aAlfa + " " + &34 + "C" + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aAlfa;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPathTmp + "dsselect.exe";
     |RSYSTEM aEjecuta;

     aAbre = aPathTmp + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
         |RFBORRA aParaBor;
         |RFBORRA aParaIni;

         |ACABA;
     |FINSI;

     |XLEE nHandle, 250, aLee;
     |XCIERRA nHandle;
     |QBF aLee;

     #dsw00002#1 = aLee + "\";
     |PINTA #dsw00002#1;
|FPRC;

|PROCESO BorraCarpeta;
     aEjecuta = aDBass + "bin/agirm -r " + aPathPaq;

     |SYSTEM aEjecuta;
|FPRC;

|PROCESO Paquete;
     aPathTar = aDBase + "tmp/paquetes/";

     nSwTgzOk = 0;
     aFicTar  = aPathTar + aPaq + ".tar" + " " + aPaq + "/*";

     |ATAR aFicTar, aPathTar;
     |SI FSalida = 0;
          |PULSATECLA;
          aFicTar = aPathTar + aPaq + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aPathTar + aPaq + ".tar";
               |FBORRA aBorra;

               nSwTgzOk = 1;
          |FINSI;
     |FINSI;

     |SI nSwTgzOk = 1;
         |PULSATECLA;

         aOri = aPathTar  + aPaq + ".tgz";
         aDes = #dsw00002#1 + aPaq + ".tgz";  |QBT aDes;

         aIPRemoto   = "";
         |IP_REMOTO aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;

         |XABRE "EC", aDes, 0;
         |SI FSalida ] 0;
             aAlfa = "0000Generado. La ubicaci¢n y nombre del paquete es la siguiente ";
             aAlfa = aAlfa + aDes;
             |MENAV aAlfa;
         |SINO;
             |MENAV "0000Ha habido un error a generar el paquete. Vuelva a intentarlo.";
         |FINSI;

         |FBORRA aOri;
     |SINO;
         |MENAV "0000Ha habido un error a generar el paquete. Vuelva a intentarlo.";
     |FINSI;

     |PULSATECLA;
     |HAZ BorraCarpeta;
     |PULSATECLA;
|FPRC;

|PROCESO Importar;
     |VENTANA 0501, 1190, -1, 16, "Importaci¢n";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |DDEFECTO #dsw00002;
     |PINPA #0#dsw00002;  nPanta = FSalida;
     |PINDA #0#dsw00002;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}", 0986, 0988, Ubica;

     |ENDATOS #1#dsw00002;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |PULSATECLA;

     |VENTANA 0501, 0550, -1, 16, "Creando paquete de datos";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |HAZ Paquete;

     |HAZ FinVent1;

     |PULSATECLA;
|FPRC;

|PROCESO Evnt1;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#dsw00001.=;
     |FINSI;
|FPRC;

|PROCESO agifigen;
     #dsw00001#0 = #agifigen#0;
     |LEE 000#dsw00001.=;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     #dsw00001#0 = #agifigen#0;
     #dsw00001#1 = #agifigen#1;
     |GRABA 020#dsw00001.n;
     |LIBERA #dsw00001;
|FPRC;

|DEFBUCLE agifigen;
     #agifigen#1;
     ;
     #dsz00002#0;
     #dsz00002#1;
     ;
     NULL, agifigen;
|FIN;

|PROCESO T12;  |TIPO 12;
     |SI FSalida = 7;
         |ACABA;
     |FINSI;

     |BUCLE agifigen;
|FPRC;

|PROCESO PorDesdeHasta;
     |VENTANA 0501, 1130, -1, 16, "Selecci¢n Desde-Hasta";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |DDEFECTO #dsz00002;
     |PINPA #0#dsz00002;
     |PINDA #0#dsz00002;
     |ENDATOS #1#dsz00002;

     |HAZ FinVent1;

     |REFRESCACONTROL nGrid1;
|FPRC;

|PROCESO PorSeleccion;
     |ABRE #agifigen;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |CONSULTA_CLAVE #1#agifigen;
          |SI FSalida = 0;
              #dsw00001#0 = #agifigen#0;
              |LEE 000#dsw00001.=;
              |SI FSalida ! 0;
                  #dsw00001#0 = #agifigen#0;
                  #dsw00001#1 = #agifigen#1;
                  |GRABA 020#dsw00001.n;
                  |LIBERA #dsw00001;

                  |REFRESCACONTROL nGrid1;
              |SINO;
                  |MENAV "0000Cliente ya ha sido seleccionado.";
              |FINSI;
              FSalida = 0;
          |FINSI;
     |SIGUE;
     |CIERRA #agifigen;
|FPRC;

|PROCESO LeeCSV;
     |XABRE "C", aFicCSV, nHandle;
     |PARA;  |SI FSalida ] 0;  |HACIENDO;
          |XLEE nHandle, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aCampoA  = "";
          aCampoB  = "";

          aCadena = aAlfa;  |QBF aCadena;
          aLong   = aCadena % 0;
          nLong   = aLong;
          nCampo  = 1;
          aTab    = ";";

          |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                nPos    = (100 * nCaracter) + 1;
                aCarac1 = aCadena % nPos;
                |SI aCarac1 = aTab;
                    nCampo = nCampo + 1;
                |SINO;
                    |SI nCampo = 1;  aCampoA  = aCampoA  + aCarac1;  |FINSI;
                    |SI nCampo = 2;  aCampoB  = aCampoB  + aCarac1;  |FINSI;

                    |SI nCampo ] 3;
                        |SAL;
                    |FINSI;
                |FINSI;
          |SIGUE;

          |QBF aCampoA;

          |SI aCampoA ! "";
              #dsw00001#0 = aCampoA;
              |LEE 000#dsw00001.=;
              |SI FSalida ! 0;
                  |DDEFECTO #dsw00001;
                  #dsw00001#0 = aCampoA;
                  #dsw00001#1 = aCampoB;
                  |GRABA 020#dsw00001.n;
                  |LIBERA #dsw00001;
              |FINSI;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;
|FPRC;

|PROCESO PorCSV;
     |MENAV "0000Fichero CSV: (Columna A - Codigo)  (Columna B - Nombre cliente)";
     |MENAV "0000A continuacion busque el fichero CSV.";

     aRuta = "F*.csv";
     |BROWSE aRuta;  |QBF aRuta;
     |SI aRuta = "F";
         |MENAV "0000Importacion cancelada.";
         |ACABA;
     |FINSI;

     aFicCSV = aRuta % 280;
     |XABRE "EC", aFicCSV, 0;
     |SI FSalida < 0;
         |MENAV "0000Importacion cancelada.";
        |ACABA;
     |FINSI;

     aAlfa = (aFicCSV % -103) < "";
     |SI aAlfa ! "csv";
         |MENAV "0000El fichero debe tener extension CSV.";
         |ACABA;
     |FINSI;

     |ABRE #agifigen;
     |HAZ LeeCSV;

     |REFRESCACONTROL nGrid1;
|FPRC;

|PROCESO EvntTree;
     |SI FEntrada = 0;  |ACABA;  |FINSI;

     aAlfa = Contenido % -101;

     |ESTADO_CONTROL nTree, "DISABLE";

     |SI aAlfa = "1";  |HAZ PorDesdeHasta; |FINSI;
     |SI aAlfa = "2";  |HAZ PorSeleccion;  |FINSI;
     |SI aAlfa = "3";  |HAZ PorCSV;        |FINSI;
     |SI aAlfa = "4";  |HAZ Importar;      |FINSI;

     |ESTADO_CONTROL nTree, "ENABLE";
|FPRC;

|PROCESO GrabaArbol;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO CreaArbol;
     |PTEC 802;  |PAUSA;

     |HAZ LeeUnidadBasico;
     aPathTmp = eaUnidadBasico + "\documentos";    |RMKDIR aPathTmp;
     aPathTmp = aPathTmp + "\tmp";  |RMKDIR aPathTmp;
     aPathTmp = aPathTmp + "\";

     aAbre = aPathTmp + "dsz00002.txt";

     sT_nID   = nTree;
     sT_nOper = 0;

     |XABRE "WBC", aAbre, nHandle;

     nLinea  = 1;
     aAlfa   = nLinea + ":Preparar c¢digos Desde / Hasta {{1}}";
     |HAZ GrabaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Preparar c¢digos por selecci¢n {{2}}";
     |HAZ GrabaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Preparar c¢digos por documento CSV {{3}}";
     |HAZ GrabaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Realizar exportaci¢n {{4}}";
     |HAZ GrabaArbol;

     |XCIERRA nHandle;

     aAlfa = "TREECTRL,Opciones {{" + aAbre + "}}";
     |CONTROL_SIMPLE 0, aAlfa, 0760, 1297, EvntTree;
     nTree = FSalida;

     |RFBORRA aAbre;

     sT_nID   = nTree;
     sT_nOper = 2;
     sT_aData = "1:";
     |ESPECIFICA "COMMANDCONTROL", sTree;

     |FOCOTECLADO nTree;
|FPRC;

|PROGRAMA;
     |VENTANA 0501, 0730, -1, 16, "Introduzca password";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     E_inf = "";
     E_sup = "20";
     aPass = 0605 ? -1;  |QBF aPass;

     |HAZ FinVent1;

     |SI aPass ! "<MYPASWD>";
         |MENAV "0000 Password de acceso incorrecto.";
         |ACABA;
     |FINSI;

     |CLS;

     |CONTROL_SIMPLE 0, "LABEL,{{15}}Exportaci¢n Datos Clientes a otra PI", 0502, 0590, NULL;

     |HAZ CreaArbol;

     nRango = 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #1#dsw00001, nRango, 0702, 3055, NULL, NULL, Evnt1;
     nGrid1 = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Salir," + nTree;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;
|FPRO;

|PROCESO T80;  |TIPO 80;
     aFic = "dsw00001" + Usuario;  |NOME_DAT #dsw00001#aFic#;

     |ABRE #dsw00001;  |CIERRA #dsw00001;  |DELINDEX #dsw00001;

     |ABRET #dsw00001;

     FSalida = 3299;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #dsw00001;
     |DELINDEX #dsw00001;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;
