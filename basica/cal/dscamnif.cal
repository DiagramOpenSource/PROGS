|FICHEROS;
     dscamnif;
     dsfinifc;
     dsfinifl;

     :/facturar/def/facemp;                || Empresas Facturacion
     :/contagen/def/canempre;              || Empresas Contabilidad
     :/contagen/def/camandia;              || Diario Contabilidad
     :/contagen/def/cacuenta;              || Plan Contable

     &regisnif@;
     &referen@;
     &refesql@;
|FIN;

|VARIABLES;
     aBaseAqui  = "";
     aFichSql   = "";
     aOrigen    = "";
     aDestino   = "";
     aDef       = "";
     aFich      = "";
     aSelect    = "";
     aFrom      = "";
     aInto      = "";
     aWhere     = "";
     aBorrar    = "";
     aFichero   = "";
     aPath      = "";
     aQueQuiero = "";
     aCampo     = "";
     aAplica    = "";
     aAlfa      = "";
     aAlfa1     = "";
     aAlfa2     = "";
     aBuscar    = "";
     aParametro = "";
     aBaseDSARCHI = "";
     aMas        = "";

     nHandle    = 0;
     nCampoDef  = 0;
     nTCampo    = 0;
     nLong      = 0;
     nPos       = 0;
     nDAnyo     = 0;
     nHAnyo     = 0;
     nSwHay     = 0;
     nCampo     = 0;
     nImprime   = 0;

     &eaVarDni  = "";
     &eaCodNif  = "";
     &enCalcCif = 0;

     &eaEjec         = "";
     &aPathFich      = "";
     &eaNifOrigen    = "";
     &eaNifDestino   = "";
     &eaContab       = "";
     &enEjerc        = 0;

     &eaPathBasica   = "";
     &eaPathContagen = "";
     &eaPathContanex = "";
     &eaPathContasoc = "";
     &eaPathRen2019  = "";
     &eaPathRen2018  = "";
     &eaPathRen2017  = "";
     &eaPathRen2016  = "";
     &eaPathRen2015  = "";
     &eaPathRen2014  = "";
     &eaPathRen2013  = "";
     &eaPathRen2012  = "";
     &eaPathRen2011  = "";
     &eaPathRen2010  = "";
     &eaPathRen2009  = "";
     &eaPathRen2008  = "";
     &eaPathRen2007  = "";
     &eaPathRen2006  = "";
     &eaPathRen2005  = "";
     &eaPathRen2004  = "";
     &eaPathRen2003  = "";
     &eaPathRen2002  = "";
     &eaPathRen2001  = "";
     &eaPathRen2000  = "";
     &eaPathRen1999  = "";
     &eaPathRen1998  = "";
     &eaPathRen1997  = "";
     &eaPathRen1996  = "";
     &eaPathRen1995  = "";
     &eaPathRen1994  = "";
     &eaPathFacturar = "";
     &eaPathLaboral  = "";
     &eaPathIntegral = "";
     &eaPathDsmodelo = "";
     &eaPathFiscal   = "";
     &eaEmpresa      = "";
     &eaNifAntARCHI  = "";
     &eaNifNueARCHI  = "";
|FIN;

|| --------------------------------------------------------------------------
|| Procesos del Programa
|| --------------------------------------------------------------------------

|PROCESO LetraDni;  |TIPO 6;
     |SI FSalida ! 10;  |ACABA;  |FINSI;

     eaVarDni  = #dscamnif#Campo#;
     enCalcCif = 1;
     |HAZ CalculoDNI;
     #dscamnif#Campo# = eaVarDni;
     |PINTA #dscamnif#Campo#;
|FPRC;

|PROCESO PonNombreO;  |TIPO 0;
      eaCodNif  = #dscamnif#0;
      |HAZ LeeNifs;

      #dscamnif#1 = #regisnif@#1;  |PINTA #dscamnif#1;
|FPRC;

|PROCESO NifDestino;  |TIPO 0;
      eaCodNif  = #dscamnif#2;
      |HAZ LeeNifs;
      |SI #regisnif@#0 = #dscamnif#2;
          |CONFI "0000N El NIF Destino ya existe, desea continuar ";
          |SI FSalida ! 0;  |ERROR;  |ACABA;  |FINSI;

          #dscamnif#3 = #regisnif@#1;  |PINTA #dscamnif#3;
      |FINSI;
|FPRC;

|PROCESO Contabilidad;
     |C_M #dscamnif#5, 1, "S";
     |SI #dscamnif#4 = "A";
         |C_M #dscamnif#5, 1, "N";  #dscamnif#5 = 0000;  |PINTA #dscamnif#5;
     |FINSI;
|FPRC;

|| --------------------------------------------------------------------------
|| Procesos del Cambio
|| --------------------------------------------------------------------------

|PROCESO Imprime;
     eaEmpresa = "";
     |SI #dsfinifc#0 = "contagen";
         eaEmpresa = (("00000" + #canempre#2) % -105) + " " + #canempre#3;
     |FINSI;

     |SI #dsfinifc#0 = "facturar";
         eaEmpresa = (("00" + #facemp#0) % -102);
     |FINSI;

     |SI aParametro = "";  |PRINT;  |FINSI;

     nSwHay   = 1;
     nImprime = 1;
|FPRC;

|PROCESO SQL;
     aQueQuiero = "|C" + (("000" + #dsfinifl#2) % -103) + "LONGITUD";
     aAlfa      = #referen@#aQueQuiero#;
     nLong      = aAlfa;
     aBuscar    = #dscamnif#0;  |QBF aBuscar;
     nPos       = 100 + nLong;
     aBuscar    = (aBuscar + (" " * nLong)) % nPos;

     |DBASE aBaseAqui;   |QBF aBaseAqui;

     aFichSql = ("sql" + Usuario + "zzzzzzzz") % 108;

     aOrigen  = aDef;
     aDestino = aBaseAqui + "def/dsborsql.mas";
     |COPIA_FICHERO aOrigen, aDestino;
     aFich    = aBaseAqui + "fich/";

     |CARGA_DEF aDestino, refesql@;
     |SI FSalida = 0;
         |PATH_DAT #refesql@#aFich#;
         |NOME_DAT #refesql@#aFichSql#;

         aSelect = "SELECT * ";
         aFrom   = "FROM "  + "dsborsql ";
         aInto   = "INTO "  + aFichSql + ".def ";
         aWhere  = "WHERE " + #dsfinifl#2 + " == " + aBuscar;
         eaEjec  =  aSelect + aFrom + aInto + aWhere;
         |SUB_EJECUTA_NP "dsborra1;NOMEQUITESQUETECORTOLOSGUEVOS";

         nCampo   = #dsfinifl#2;
         nImprime = 0;

         |ABRET #referen@;
         |ABRET #refesql@;
         |LEE 040#refesql@.p;
         |PARA;  |SI FSalida = 0;  |HACIENDO;
              |PARA nCampoDef = 0;  |SI nCampoDef [ nTCampo;  |HACIENDO nCampoDef = nCampoDef + 1;
                    #referen@#nCampoDef# = #refesql@#nCampoDef#;
              |SIGUE;

              |SI #dsfinifl#4 = "S";
                  #referen@#nCampo# = #dscamnif#2;
                  |LEE 101#referen@.=;
                  |SI FSalida ! 0;
                      |PARA nCampoDef = 0;  |SI nCampoDef [ nTCampo;  |HACIENDO nCampoDef = nCampoDef + 1;
                            #referen@#nCampoDef# = #refesql@#nCampoDef#;
                      |SIGUE;

                      |LEE 101#referen@.=;
                      |SI FSalida = 0;
                          |BORRA 020#referen@.a;
                          |LIBERA #referen@;
                      |FINSI;

                      |DDEFECTO #referen@;
                      |PARA nCampoDef = 0;  |SI nCampoDef [ nTCampo;  |HACIENDO nCampoDef = nCampoDef + 1;
                            #referen@#nCampoDef# = #refesql@#nCampoDef#;
                      |SIGUE;
                      #referen@#nCampo# = #dscamnif#2;
                      |GRABA 020#referen@.n;
                      |LIBERA #referen@;

                      |SI nImprime = 0;  |HAZ Imprime;  |FINSI;
                  |SINO;
                      |SI #dsfinifc#1 = "dsam0103.mas";  |O #dsfinifc#1 = "agim0003.mas";
                          #referen@#nCampo# = #dscamnif#0;
                          |LEE 101#referen@.=;
                          |SI FSalida = 0;
                              |BORRA 020#referen@.a;
                              |LIBERA #referen@;
                          |FINSI;
                      |FINSI;
                  |FINSI;
              |SINO;
                  |LEE 101#referen@.=;
                  |SI FSalida = 0;
                      #referen@#nCampo# = #dscamnif#2;
                      |GRABA 020#referen@.a;
                      |LIBERA #referen@;
                      |SI nImprime = 0;  |HAZ Imprime;  |FINSI;
                  |FINSI;
              |FINSI;

              |LEE 040#refesql@.s;
          |SIGUE;
          |CIERRAT #referen@;
          |CIERRAT #refesql@;

          |DELINDEX #refesql@;

          |DESCARGA_DEF #refesql@;
     |FINSI;

     aBorrar = aBaseAqui + "def/" + aFichSql  + ".mas";  |FBORRA aBorrar;
     aBorrar = aBaseAqui + "def/" + "dsborsql.mas";      |FBORRA aBorrar;

     aOrigen  = aBaseAqui + "def/dsborsq1.mas";
     aDestino = aBaseAqui + "def/dsborsql.mas";
     |COPIA_FICHERO aOrigen, aDestino;

     |PULSATECLA;
|FPRC;

|PROCESO dsfinifl;
     |PINTA 2202, #dsfinifc#0;
     |PINTA 2212, #dsfinifc#1;
     |PINTA 2225, #dsfinifl#2;
     |PINTA 2230, #dsfinifl#3;

     |HAZ SQL;
|FPRC;

|DEFBUCLE dsfinifl;
     #dsfinifl#1;
     ;
     #dsfinifc#0, #dsfinifc#1, 000;
     #dsfinifc#0, #dsfinifc#1, 999;
     ;
     NULL, dsfinifl;
|FIN;

|PROCESO dsfinifc;
     aFichero = #dsfinifc#1;
     aDef     = aPath + "def/" + aFichero;
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aQueQuiero = "|NC";
     aCampo     = #referen@#aQueQuiero#;
     nTCampo    = aCampo;
     nTCampo    = nTCampo - 1;

     |PATH_DAT #referen@#aPathFich#;

     |BUCLE dsfinifl;

     |DESCARGA_DEF #referen@;
|FPRC;

|DEFBUCLE dsfinifc;
     #dsfinifc#1;
     ;
     aAplica, "            ";
     aAplica, "zzzzzzzzzzzz";
     ;
     NULL, dsfinifc;
|FIN;

|PROCESO TrataDSARCHI;
     |DBASS aBaseDSARCHI;   |QBF aBaseDSARCHI;
     aMas = aBaseDSARCHI + "dsarchi/def/dsarz016.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aAlfa = "CNIF" + #dscamnif#0 + #dscamnif#2;

     aAlfa = "|:dsarchi/dsarz016;" + aAlfa;
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO Integral;
     aPath     = eaPathIntegral;
     aPathFich = aPath + "fich/";
     aAplica   = "integral";
     |BUCLE dsfinifc;

     |HAZ TrataDSARCHI;
|FPRC;

|PROCESO Modelos;
     aPath     = eaPathDsmodelo;
     aPathFich = aPath + "fich/";
     aAplica   = "modelos";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Basica;
     aPath     = eaPathBasica;
     aPathFich = aPath + "fich/";
     aAplica   = "basica";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Laboral;
     aPath     = eaPathLaboral;
     aPathFich = aPath + "fich/";
     aAplica   = "laboral";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Contasoc;
     aPath     = eaPathContasoc;
     aPathFich = aPath + "fich/";
     aAplica   = "contasoc";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2002;
     aPath     = eaPathRen2002;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2002";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2003;
     aPath     = eaPathRen2003;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2003";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2004;
     aPath     = eaPathRen2004;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2004";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2005;
     aPath     = eaPathRen2005;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2005";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2006;
     aPath     = eaPathRen2006;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2006";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2007;
     aPath     = eaPathRen2007;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2007";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2008;
     aPath     = eaPathRen2008;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2008";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2009;
     aPath     = eaPathRen2009;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2009";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2010;
     aPath     = eaPathRen2010;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2010";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2011;
     aPath     = eaPathRen2011;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2011";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2012;
     aPath     = eaPathRen2012;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2012";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2013;
     aPath     = eaPathRen2013;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2013";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2014;
     aPath     = eaPathRen2014;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2014";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2015;
     aPath     = eaPathRen2015;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2015";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2016;
     aPath     = eaPathRen2016;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2016";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2017;
     aPath     = eaPathRen2017;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2017";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2018;
     aPath     = eaPathRen2018;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2018";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO Renta2019;
     aPath     = eaPathRen2019;
     aPathFich = aPath + "fich/";
     aAplica   = "ren2019";
     |BUCLE dsfinifc;
|FPRC;

|PROCESO facemp;
     aPath     = eaPathFacturar;
     aPathFich = aPath + "fich/" + (("00" + #facemp#0) % -102) + "/";
     aAplica   = "facturar";
     |BUCLE dsfinifc;
|FPRC;

|DEFBUCLE facemp;
     #facemp#1;
     3;
     00, "S";
     99, "S";
     ;
     NULL, facemp;
|FIN;

|PROCESO Facturar;
     |BUCLE facemp;
|FPRC;

|PROCESO canempre;
     aPath     = eaPathContagen;
     aPathFich = aPath + "fich/" + (("00000" + #canempre#2) % -105) + #canempre#3 + "/";
     aAplica   = "contagen";

     |PATH_DAT #cacuenta#aPathFich#;
     |ABRE #cacuenta;
     |LEE 000#cacuenta.p;
     |SI FSalida ! 0;
         |CIERRA #cacuenta;
         |ACABA;
     |FINSI;
     |CIERRA #cacuenta;

     |SI #dscamnif#4 = "A";
         |PATH_DAT #camandia#aPathFich#;

         |ABRE #camandia;
         #camandia#0 = 99;
         |LEE 040#camandia.=;
         |SI FSalida = 0;  |Y #camandia#2 ! 0;  |Y #camandia#3 ! 0;
             |CIERRA #camandia;
             |ACABA;
         |FINSI;
         |CIERRA #camandia;
     |FINSI;

     |BUCLE dsfinifc;

     aAlfa1 = #canempre#8;  |QBF aAlfa1;
     aAlfa2 = #dscamnif#0;    |QBF aAlfa2;
     |SI aAlfa1 = aAlfa2;
         #canempre#8 = #dscamnif#2;
         |GRABA 020#canempre.a;

         #dsfinifc#0 = "contagen";
         #dsfinifc#1 = "canempre.mas";
         #dsfinifc#1 = "Empresas Contables";
         #dsfinifl#2 = 8;
         #dsfinifl#3 = "NIF";

         |HAZ Imprime;
     |FINSI;
     |LIBERA #canempre;
|FPRC;

|DEFBUCLE canempre;
     #canempre#4;
     ;
     00000, nDAnyo;
     99999, nHAnyo;
     be;
     NULL, canempre;
|FIN;

|PROCESO Contagen;
     aPath     = eaPathContagen;
     aPathFich = aPath + "fich/000000/";
     aAplica   = "contagen";

     |BUCLE dsfinifc;

     nDAnyo = 00;
     nHAnyo = 99;
     |SI #dscamnif#4 = "T";
         aAlfa = #dscamnif#5;
         aAlfa = aAlfa % -102;
         nDAnyo = aAlfa;
         nHAnyo = 70;
     |FINSI;

     |BUCLE canempre;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     |HAZ BusquedaApli;

     |SI aParametro = "";
         |IMPRE 0;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |INFOR "dscamnif";
         |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;
     |FINSI;

     |SI eaPathIntegral ! "";  |HAZ Integral;  |FINSI;
     |SI eaPathDsmodelo ! "";  |HAZ Modelos;   |FINSI;
     |SI eaPathBasica   ! "";  |HAZ Basica;    |FINSI;
     |SI eaPathLaboral  ! "";  |HAZ Laboral;   |FINSI;
     |SI eaPathContasoc ! "";  |HAZ Contasoc;  |FINSI;
     |SI eaPathRen2019  ! "";  |HAZ Renta2019; |FINSI;
     |SI eaPathRen2018  ! "";  |HAZ Renta2018; |FINSI;
     |SI eaPathRen2017  ! "";  |HAZ Renta2017; |FINSI;
     |SI eaPathRen2016  ! "";  |HAZ Renta2016; |FINSI;
     |SI eaPathRen2015  ! "";  |HAZ Renta2015; |FINSI;
     |SI eaPathRen2014  ! "";  |HAZ Renta2014; |FINSI;
     |SI eaPathRen2013  ! "";  |HAZ Renta2013; |FINSI;
     |SI eaPathRen2012  ! "";  |HAZ Renta2012; |FINSI;
     |SI eaPathRen2011  ! "";  |HAZ Renta2011; |FINSI;
     |SI eaPathRen2010  ! "";  |HAZ Renta2010; |FINSI;
     |SI eaPathRen2009  ! "";  |HAZ Renta2009; |FINSI;
     |SI eaPathRen2008  ! "";  |HAZ Renta2008; |FINSI;
     |SI eaPathRen2007  ! "";  |HAZ Renta2007; |FINSI;
     |SI eaPathRen2006  ! "";  |HAZ Renta2006; |FINSI;
     |SI eaPathRen2005  ! "";  |HAZ Renta2005; |FINSI;
     |SI eaPathRen2004  ! "";  |HAZ Renta2004; |FINSI;
     |SI eaPathRen2003  ! "";  |HAZ Renta2003; |FINSI;
     |SI eaPathRen2002  ! "";  |HAZ Renta2002; |FINSI;
     |SI eaPathFacturar ! "";  |HAZ Facturar;  |FINSI;
     |SI eaPathContagen ! "";  |HAZ Contagen;  |FINSI;

     |SI aParametro = "";
         |SI nSwHay = 0;
             |MENAV  "0000 Nif no encontrado en ninguna Aplicacion.";
         |SINO;
             |PIEINF;
         |FINSI;
         |FININF;
         |FINIMP;
     |FINSI;
|FPRC;

|PROGRAMA;
     aParametro = PARAMETRO;  |QBF aParametro;
     |SI aParametro = "";
         |MANTE #dscamnif;
     |SINO;
         |DDEFECTO #dscamnif;
         |PINPA #0#dscamnif;
         #dscamnif#0 = eaNifOrigen;
         #dscamnif#2 = eaNifDestino;
         #dscamnif#4 = eaContab;
         #dscamnif#5 = enEjerc;
         |PINDA #0#dscamnif;
         |HAZ Tipo3;
     |FINSI;
|FPRO;
