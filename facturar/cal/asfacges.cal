|FICHEROS;
    asfacges #0;
    ascabmin #1;
    aslinmin #2;
    aslinmil #22;
    ascontro #4;
    ascontrt #450;
    asempres #3;
    asclient #5;
    facemp   #999;

    ascabfdi #8;
    aslinfdi #9;
    ascontfd #12;
    ascontft #451;
    aslinfdl #99;

    ashismic #10;
    ashismil #11;
    ashismit #111;

    :/integral/def/dsam0000 #400;

    asm00013 #500;
    asw00050 #900;

    &fopagos@ #712;
    &clientes@ #715;
    &bancosp@ #706;

    Ref0001@ #1000;
    Ref0002@ #2000;

    referen@ #800;
|FIN;

|VARIABLES;
     aInformePapel = "";

     nSwFacturaYaImpresa = 0;           ||Si solo hay una factura y ya
                                        ||ha sido impresa. No la tengo que
                                        ||imprimir por papel al terminar de
                                        ||archivar
     &enPorRetenIRPF = 0;

     &eaFacturaPDFFe = "";
     aFicheroPDF = "";
     nSwHayPDF = 0;
     nHayConfEmp = 0;
     nSwGenerarPDF = 0;
     nEmpresa = 0;
     aMensaje = "";

     nSwSinCorreo = 0;
     aIPRemoto = "";
     nSalida = 0;
     nCanal = 0;
     aTipoFactura = "";
     &eaArTipoDoc = ""; || Tipo documento.  FD, FV, etc ...
     &eaArSerDoc = "";  || Serie Docuemnto.
     &enArNumDoc = 0;   || Numero Documento
     &eaArFecDoc = "";  || Fecha Documento.
     &eaAplicacion = "";
     &eaDefFE = "";
     &eaEmpresaFE = "";
     &eaSerieFE = "";
     &eaNumeroFE = "";
     &eaDefLinFe = "";
     &eaDefEmpFe = "";
     &eaDefCliFe = "";
     &eaDefIvaFe = "";
     &eaCodCliFe = "";
     &eaDefAlbFe = "";
     &enTipoIvaFe = 0;
     &enTipoFacFe = 0;
     &eaDefMultiLin = "";
     &eaDefAAPPFe = "";
     &eaDForPago = "";
     &eaDefFPago = "";   ||Desc. Forma de Pago.
     &eaDefVencFe = "";  || Fichero de donde pillar los vencimientos y F.Pago

     &eaSwEnvioCorreo = "";  ||Indica si se enivia por correo al emitir la minuta
     &eaDirDesFE = "";  || Direccion destino para envio por correo
     &eaFirmarFE = "";  || Indica si tenemos que firmar o no el documento

     nSwFirma = 0;
     &enNumLinCon = 0;
     &enColNumexp = 0;
     nSwAsterisco = 0;
     aAux = "";

     aFichero = "";
     &eaSerExp = "";
     &enNumExp = 0;
     &eaDesExp = "";
     &eaCtrFac = "";
     &efFecVia = @;

     &eaSwNotasIFac = "";     ||Indica si imprimimos notas internas en Facturas
     &enModVisados = 0;       ||Indica que se llama desde Modulo VISADOS
     &enModVis     = 0;       ||Modo de impresion Modulo visados 1-Normal, 2-Borrador
     &enSwPDFVisados = 0;     ||Si el pdf de la factura se ha creado correctamente

   &eaArGrpMin = "";  || Grupo archivo en caso de archivar desde minutacion
   &eaArSbGMin = "";  || Subgrupo archivo en caso de archivar desde minutacion
   &eaArTipMin = "";  || Tipo archivo en caso de archivar desde minutacion
   &PRMNT_nOpc = 0;

    aAlfa     = "";
    aAlfa1    = "";
    aAlfa2    = "";
    aAlfa3    = "";
    aAlfa4    = "";
    aAlfa5    = "";
    aAlfa6    = "";
    aBase     = "";
    aDef      = "";
    aOrig     = "";
    aDest     = "";
    nCuadre   = 0;
    nHandle   = 0;
    nPrimero  = 0;
    nArchi    = 0;
    nSwArchiXML = 0;
    nParAnt   = 0;
    nIntento  = 0;

    thono1    = 0;
    impdto    = 0;
    timp      = 0;
    tret      = 0;
    tpagar    = 0;
    cab       = "Control";
    informe   = "";

    fechav    = @;
    em        = 0;
    j         = 0;

    indihono  = 0;
    i         = 0;
    SwLectura = 0;

    D_Serie   = "";
    H_Serie   = "";
    D_Factura = 0;
    H_Factura = 0;
    D_TipoFac = 0;
    H_TipoFac = 0;
    D_Cliente = 0;
    H_Cliente = 0;
    D_Linea   = 0;
    H_Linea   = 0;
    aAct      = "";
    nPrint    = 0;
    nCampo    = 0;
    nCodigo   = 0;

    &enFactor   = 0;
    &enSwCuotas = 0;
    &enTipoFac = 0;
    &descr1    = "";
    &descr2    = "";
    &descr3    = "";
    &retsino   = "";
    &timporte  = 0;
    &serie     = "  "
    &sw        = 0;
    &vacio     = "                                                  ";
    &factura   = 0;
    &ivabo     = 0;
    &acum      = 0;
    &hono      = 0;
    &supli     = 0;
    &ret       = 0;
    &dto       = 0;
    &fech      = @;
    &fechv     = @;
    &unidades  = 0;
    &ptasunid  = 0;
    &tipo      = "";
    &tacum     = 0;
    &thono     = 0;
    &tsupli    = 0;
    &tfac      = 0;
    &cargo     = 0;
    &cargo_h   = 0;
    &abono     = 0;
    &abono_h   = 0;
    &seccion   = "";
    &concepto  = "";
    &fecha_lin = "";
    &saldo_a   = 0;
    &tsal_a    = 0;
    &acuen_a   = 0;
    &acuen_i   = 0;
    &d_viene   = 0;
    &enDReme   = 0;
    &enHReme   = 0;
    &enDFPag   = 0;
    &enHFPag   = 0;

    &tipo_d    = 0;
    &cliente_d = 0;
    &serie_d   = "";
    &factura_d = 0;

    &d_serie     = "";
    &h_serie     = "";
    &d_factu     = 0;
    &h_factu     = 0;
    &d_fecha     = @;
    &h_fecha     = @;
    &d_clien     = 0;
    &h_clien     = 0;
    &eaParrilla  = "";
    &empresa     = 0;
    &cuotas      = "";
    &observa     = "";
    &Cab1        = "";
    &Cab2        = "";
    &Cab3        = "";
    &Pie1        = "";
    &Pie2        = "";
    &Pie3        = "";
    &EURODB      = 0;
    &eaEscalera  = "";
    &eaPiso      = "";
    &eaPuerta    = "";
    &enSwDeDonde = 0;
    &enCodCli    = 0;
    &enCodBanco  = 0;
    &eaTipoDir   = "";

    &enCodPago = 0;

    {-1}&des   = "                                        ";
        &des1  = "                                        ";
        &des2  = "                                        ";
        &des3  = "                                        ";
        &des4  = "                                        ";
        &des5  = "                                        ";
        &des6  = "                                        ";
        &des7  = "                                        ";
        &des8  = "                                        ";
        &des9  = "                                        ";
        &des10 = "                                        ";
        &des11 = "                                        ";
        &des12 = "                                        ";

    {-1}&imp   = 0;
        &imp1  = 0;
        &imp2  = 0;
        &imp3  = 0;
        &imp4  = 0;
        &imp5  = 0;
        &imp6  = 0;
        &imp7  = 0;
        &imp8  = 0;
        &imp9  = 0;
        &imp10 = 0;
        &imp11 = 0;
        &imp12 = 0;

    {-1}parada  = "";
        parada1 = "2400";
        parada2 = "1";
        parada3 = "  PAUSA por cada Factura : ";
        parada4 = "NS";
        parada5 = "  No  ";
        parada6 = "  Si  ";

    aSerie    = "";
    nFactura  = 0;
    aSeccion  = "";
    aConcept  = "";
    aDescrip  = "";
    aDescri1  = "";
    aDescri2  = "";
    aDescri3  = "";
    nImporte  = 0;
    nLinea    = 0;
    nTipoFac  = 0;
    nCliente  = 0;
    nError    = 0;

    &enUnidades = 0;
    &enImpTotal = 0;
    &enOrden    = 0;

{-1}aMenu  = "";
    aMenu1 = "2400";
    aMenu2 = "1";
    aMenu3 = "";
    aMenu4 = "APSNC";
    aMenu5 = "Archivar";
    aMenu6 = "Papel";
    aMenu7 = "S/Conf.Cli.";
    aMenu8 = "Arc.NO Correo";
    aMenu9 = "Cancelar";

    aImpre = "";
{1}aPuntero = "";

   &eaArCodCli = "";  || Codigo Cliente
   &eaArNomCli = "";  || Nombre Cliente
   &eaArCodCif = "";  || Cif
   &eaArNomCif = "";  || Nombre Cif
   &eaArCodTra = "";  || Codigo Trabajador
   &eaArNomTra = "";  || Nombre Trabajador
   &eaArCamPDF = "";  || Camino al PDF a archivar
   &eaArSerMin = "";  || Serie minuta en caso de ser archivar desde minutacion
   &eaArNumMin = "";  || Numero minuta en caso de ser archivar desde minutacion
   &eaArFecMin = "";  || Fecha minuta en caso de ser archivar desde minutacion
/*
   &eaArGrpMin = "";  || Grupo archivo en caso de archivar desde minutacion
   &eaArSbGMin = "";  || Subgrupo archivo en caso de archivar desde minutacion
   &eaArTipMin = "";  || Tipo archivo en caso de archivar desde minutacion
*/
   aImpresora  = "";
   nOpcion     = 0;
   aBaseBin    = "";
   aSystem     = "";
   aOpcionCli  = "";

   {10} aPopup = "";


   &enErrorFac = 0;
   &enTipo     = 0;
   &enCliente  = 0;
|FIN;

|INCLUYE i_lletre;
|INCLUYE i_asefec;

|| -----------------------------------------------
||     MIRA QUE TIPO DE CUADRE VAMOS A LANZAR
|| -----------------------------------------------

|PROCESO MiraQueCuadre;
     |DBASE aBase;    |QBF aBase;
     aDef    = aBase + "def/" + informe + ".inf";
     nCuadre = 0;

     |XABRE "U", aDef, nHandle;
     |PARA;  |SI  FSalida ] 0;  |HACIENDO;
             |XLEE nHandle, 250, aAlfa;
             |SI FSalida < 0;  |SAL;  |FINSI;

             |QBF aAlfa;
             aAlfa1 = aAlfa;

             aAlfa1 = aAlfa1 - "descr1";
             |SI aAlfa1 ! aAlfa;
                 nCuadre = 1;
                 |SAL;
             |FINSI;
     |SIGUE;
     |XCIERRA  nHandle;
|FPRC;

|PROCESO Tipo0C5;
    |ABRE #3;
    #3#0 = #0#5;
    |LEE 000#3=;
    |SI FSalida = 0;
        #0#26 = #3#19; |PINTA #0#26;
        #0#38 = #3#15; |PINTA #0#38;
    |FINSI;
    |CIERRA #3;
|FPRC;

|PROCESO LeeCliente;
     |ABRE #5;
     #asclient#0 = nCodigo;
     |LEE 040#5=;
     |SI FSalida ! 0; |DDEFECTO #5; |FINSI;
     |CIERRA #5;

     |SI #0#38 = "F";  |ACABA;  |FINSI;

     |ABRE #400;
     #400#0 = nCodigo;
     |LEE 040#400=;
     |SI FSalida ! 0; |DDEFECTO #400; |FINSI;
     |CIERRA #400;

     aAlfa = #400#40;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aAlfa1  = #400#39;  |QBF aAlfa1;
     aAlfa2  = #400#40;  |QBF aAlfa2;
     aAlfa3  = #400#41;  |QBF aAlfa3;
     aAlfa4  = #400#42;  |QBF aAlfa4;
     aAlfa5  = #400#43;  |QBF aAlfa5;
     aAlfa6  = #400#44;  |QBF aAlfa6;

     aAlfa   = aAlfa1 + " " + aAlfa2;
     |SI aAlfa3 ! "";  aAlfa = aAlfa + ", " + aAlfa3;  |FINSI;
     |SI aAlfa4 ! "";  aAlfa = aAlfa + " "  + aAlfa4;  |FINSI;
     |SI aAlfa5 ! "";  aAlfa = aAlfa + " "  + aAlfa5;  |FINSI;
     |SI aAlfa6 ! "";  aAlfa = aAlfa + " "  + aAlfa6;  |FINSI;

     #5#3  = aAlfa;
     #5#4  = #400#45;
     #5#5  = #400#46;
     #5#6  = #400#47;
     #5#7  = #400#48;
|FPRC;

|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE MINUTAS NORMALES
|| ***********************************************************************

|PROCESO Linlinmin;
   |SI #2#6 = aDescrip; |Y #2#7 = aDescri1; |Y #2#8 = aDescri2;
    |Y #2#9 = aDescri3; |Y #2#12 = nImporte;
      enUnidades = enUnidades + #2#11;
      enImpTotal = enImpTotal + #2#13;
      |SI #2#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linlinmin; || PEPE
#aslinmin#1;
4,5;
nTipoFac, nCliente, 001, aSeccion, aConcept;
nTipoFac, nCliente, 999, aSeccion, aConcept;
;
NULL,Linlinmin;
|FIN:

|PROCESO Cuotas;
   |SI informe ! "sinlinea";
       |PRINT;
   |FINSI;
|FPRC;

|DEFBUCLE Cuotas;
#asm00013#1;
;
D_TipoFac,D_Cliente,D_Serie,D_Factura,aAct,D_Linea,01;
H_TipoFac,H_Cliente,H_Serie,H_Factura,aAct,H_Linea,99;
;
NULL,Cuotas;
|FIN;

|PROCESO Imprime1;
     #0#12 = #22#4;
     |SI informe ! "sinlinea";
         |PRINT;
     |FINSI;
     #0#13     = 0;
     #0#14     = 0;
     #0#15     = 0;
     #0#27     = 0;
     #0#28     = 0;
     #0#29     = "";
     #0#34     = 0;
     #0#35     = 0;
     #0#36     = "";
     #0#37     = "";
     unidades  = 0;
     ptasunid  = 0;
     seccion   = "";
     concepto  = "";
|FPRC;

|DEFBUCLE aslinmil;
   #22#1;
   ;
   #2#0, #2#1, #2#2, 001;
   #2#0, #2#1, #2#2, 999;
   ;
   NULL, Imprime1;
|FIN;

|PROCESO imprelin_n;
|SI SwLectura = 1;
    |SI #2#4 = "ASUN"; |Y #2#5 = "01";
        Cab1 = #2#7;
        Cab2 = #2#8;
        Cab3 = #2#9;
    |FINSI;

    |SI #2#4 = "OBSE"; |Y #2#5 = "01";
        Pie1 = #2#7;
        Pie2 = #2#7;
        Pie3 = #2#7;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #2#4 = "ASUN"; |Y #2#5 = "01";
        |ACABA;
    |FINSI;

    |SI #2#4 = "OBSE"; |Y #2#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #2#10;
    secc_ase = #2#4;
    conc_ase = #2#5;
    dcab_ase = #2#6;
    unid_ase = #2#11;
    impo_ase = #2#13;
    prec_ase = #2#12;
    des1_ase = #2#7;
    des2_ase = #2#8;
    des3_ase = #2#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

|SALVA_FICHA #2;
nTipoFac = #2#0;
nCliente = #2#1;
aSeccion = #2#4;
aConcept = #2#5;
aDescrip = #2#6;
aDescri1 = #2#7;
aDescri2 = #2#8;
aDescri3 = #2#9;
nImporte = #2#12;
nLinea   = #2#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linlinmin;
|REPON_FICHA #2;
|| FIN PEPE

descr1    = #2#7;
descr2    = #2#8;
descr3    = #2#9;
unidades  = #2#11;
ptasunid  = #2#12;
seccion   = #2#4;
concepto  = #2#5;
fecha_lin = #2#15
enColNumexp = #2#17;
enNumLinCon = #2#2;


#0#34     = #2#11;
#0#35     = #2#12;
#0#36     = #2#4;
#0#37     = #2#5;

|SI #2#3 = 0;  fecha_lin = "";  |FINSI;

cargo_h = 0;
abono_h = 0;
saldo_a = 0;
acuen_a = 0;
acuen_i = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #2#10 = "H";
    |SI #2#13 > 0;
        cargo_h = #2#13;
        cargo   = #2#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#2#13;
        abono_h = -#2#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #2#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #2#10 = "S";
    |SI #2#13 > 0;
        cargo = #2#13;
        abono = 0;
    |SINO;
        abono = -#2#13;
        cargo = 0;
    |FINSI;

    supli    = #2#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #2#10 = "A";
    |SI #2#13 > 0;
        abono   = #2#13;
        cargo   = 0;
        acuen_a = #2#13;
        acuen_i = #2#13;
    |SINO;
        cargo   = -#2#13;
        abono   = 0;
        acuen_i = -#2#13;
        saldo_a = -#2#13;
    |FINSI;

    acum     = #2#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #2#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #2#13;
    indihono = indihono + 1;
|FINSI;

|SI #2#10 = "H";  #0#13 = #2#13;  #0#29 = "H";  |FINSI;
|SI #2#10 = "S";  #0#14 = #2#13;  #0#29 = "S";  |FINSI;
|SI #2#10 = "A";  #0#15 = #2#13;  #0#29 = "A";  |FINSI;

#0#27 = cargo;
#0#28 = abono;
#0#40 = #0#40 + cargo_h;
#0#41 = #0#41 + abono_h;

|SI nCuadre = 0;
    |BUCLE aslinmil;
    #22#4 = "";  |HAZ Imprime1;
|SINO;
     |SI informe ! "sinlinea";
         |PRINT;
     |FINSI;
|FINSI;

|SI #asfacges#26 = "S";
    enSwCuotas = 1;
    D_TipoFac  = #aslinmin#0;  H_TipoFac  = #aslinmin#0;
    D_Cliente  = #aslinmin#1;  H_Cliente  = #aslinmin#1;
    D_Serie    = #ascabmin#27; H_Serie    = #ascabmin#27;
    D_Factura  = #ascabmin#28; H_Factura  = #ascabmin#28;
    D_Linea    = #aslinmin#2;  H_Linea    = #aslinmin#2;
    aAct = "N";
    |BUCLE Cuotas;
    enSwCuotas = 0;
|FINSI;
|FPRC;

|DEFBUCLE aslinmin;
#2#2;
;
#1#0, #1#1, "00.00.0000", 000;
#1#0, #1#1, "31.12.9999", 999;
e;
NULL, imprelin_n;
|FIN;

|PROCESO lineasfac_n;
|SI #1#28 = 0; |ACABA; |FINSI;

|SI parada2 = 2;
    |ATRI R;
    |ATRI P;
    |PINTA 2130, " Introduzca Factura en impresora ";
    |ATRI 0;
    |PAUSA;
    |PINTA 2130, "                                  ";
|FINSI;

retsino   = #1#12;
|SI #1#12 = "S"; ret = #4#31; |SINO; ret = 0; |FINSI;
dto       = #1#20;
observa   = #1#30;

|ABRE #450;
|SELECT #1#450;
#450#0 = #1#0;
|LEE 000#450=;
|SI FSalida ! 0; |DDEFECTO #450; |FINSI;
|CIERRA #450;

ivabo     = #450#3;
enTipoFac = #1#0;
serie     = #1#27;
factura   = #1#28;
fech      = #1#29;

#0#10   = #1#27;
#0#11   = #1#28;
#0#4    = #1#29;

enCodPago = #1#10;
|HAZ LeeFormaDePago;
eaDForPago = #712#1;
|SI #1#10 = 99;
    fechv = "A LA VISTA";
|SINO;
    fechav    = #1#29;
    fechv     = fechav;
    |SI #712#5 ! 0;
        |SI #712#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #712#5 / em;
        fechav = #1#29 + j;
        fechv = fechav;
    |FINSI;
|FINSI;

|HAZ desconfec;

nCodigo = #1#1;
|HAZ LeeCliente;

|HAZ CtlAsteriscoCta;

enCodCli = #5#0;
|HAZ LeePersona;

enCodBanco = #1#11;
|HAZ LeeBancoPropio;

|SI #0#38 = "F";
    |SI enSwDeDonde = 1;
        eaEscalera = #715#22;
        eaPiso     = #715#23;
        eaPuerta   = #715#24;
    |SINO;
        eaEscalera = #715#6;
        eaPiso     = #715#7;
        eaPuerta   = #715#8;
    |FINSI;
|FINSI;

SwLectura = 1; |BUCLE aslinmin;
SwLectura = 0; |BUCLE aslinmin;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;

#0#16 = thono;
#0#17 = tsupli;
#0#18 = tacum;
#0#19 = ivabo;
#0#20 = timp;
#0#22 = tfac;
#0#39 = thono1;

|SI EURODB = 0;
    #0#21 = (#0#22 / 166.386) ! 2;
|SINO;
    #0#21 = (#0#22 * 166.386) ! 0;
|FINSI;
#0#23 = tpagar;
#0#24 = thono;
#0#25 = impdto;

|SI informe = "asfacmja";  |O informe = "asfacacg";
 |O informe = "asfa1mja";  |O informe = "asfa1acg";
    |SI dto ! 0;
        #0#12 = "REDUCCION ESPECIAL " + dto + "% ";
        #0#13 = -#0#25;
        |PRINT;

        #0#13     = 0;
        #0#14     = 0;
        #0#15     = 0;
        #0#27     = 0;
        #0#28     = 0;
        #0#29     = "";
        #0#34     = 0;
        #0#35     = 0;
        #0#36     = "";
        #0#37     = "";
        unidades  = 0;
        ptasunid  = 0;
        seccion   = "";
        concepto  = "";
    |FINSI;
|FINSI;

|SI informe ! "sinlinea";
    |PIEINF;
|SINO;
    |PRINT;
    |PIEINF;
|FINSI;

|HAZ borra;
|FPRC;

|PROCESO CtlAsteriscoCta;
     |SI informe = "asfacvic"; |O informe = "asfacvip";
          nSwAsterisco = 1;
     |SINO;
          nSwAsterisco = 0;
     |FINSI;
     |SI nSwAsterisco = 1;
          aAux = #5#14;
          |QBF aAux;
          aAux = aAux % 106;
          aAux = aAux + "****" + "          ";
          #5#14 = aAux;
     |FINSI;
|FPRC;

|DEFBUCLE ascabmin;
#1#1;
27, 28, 11, 10;
#0#0, #0#2, #0#6, #0#8, #0#30, #0#32;
#0#1, #0#3, #0#7, #0#9, #0#31, #0#33;
e;
NULL, lineasfac_n;
|FIN;

|PROCESO desde_normal;
parada2 = "1";
|SI PARAMETRO ! "SOLOUNAMINUTA";
    |MENU parada;
    parada2 = FSalida;
    |SI parada2 < 1; |O parada2 > 2; |ACABA; |FINSI;
|FINSI;

|IMPRE 0;
|SI FSalida ! 0; |ACABA; |FINSI;

|DDEFECTO #3;
|ABRE #3;
#3#0 = #0#5;
|LEE 101#3=;
|SI FSalida = 0;
    #3#15 = #0#38;
    #3#19 = #0#26;
    |GRABA 020#3a;
    |LIBERA #3;
|FINSI;
|CIERRA #3;

|SI nArchi = 1;
     informe = #3#16;
     |QBF informe;
     |SI informe = "";
          informe = #3#8;
     |FINSI;
|SINO;
     informe = #3#8;
|FINSI;
aInformePapel = #3#8;
|QBF aInformePapel;

|QBF informe;
informe = informe < "";

|HAZ MiraQueCuadre;

|INFOR informe;
|SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

|ABRE #2;
|ABRE #4;
|LEE 121#4p;
|SI FSalida = 0;
    |BUCLE ascabmin;
|SINO;
    |MENAV " ***  ATENCION  ***  FICHERO DE CONTROL INEXISTENTE";
|FINSI;
|LIBERA #4;
|CIERRA #2;
|CIERRA #4;
|FININF;
|FINIMP;
|FPRC;

|| ***********************************************************************


|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE MINUTAS DIRECTAS
|| ***********************************************************************

|PROCESO Linfacdir;
   |SI #9#6 = aDescrip; |Y #9#7 = aDescri1; |Y #9#8 = aDescri2;
    |Y #9#9 = aDescri3; |Y #9#12 = nImporte;
      enUnidades = enUnidades + #9#11;
      enImpTotal = enImpTotal + #9#13;
      |SI #9#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linfacdir; || PEPE
#aslinfdi#1;
4,5;
nTipoFac, aSerie, nFactura, nCliente, 001, aSeccion, aConcept;
nTipoFac, aSerie, nFactura, nCliente, 999, aSeccion, aConcept;
;
NULL,Linfacdir;
|FIN:

|PROCESO Imprime2;
     #0#12 = #99#6;
     |SI informe ! "sinlinea";
         |PRINT;
     |FINSI;
     #0#13     = 0;
     #0#14     = 0;
     #0#15     = 0;
     #0#27     = 0;
     #0#28     = 0;
     #0#29     = "";
     #0#34     = 0;
     #0#35     = 0;
     #0#36     = "";
     #0#37     = "";
     unidades  = 0;
     ptasunid  = 0;
     seccion   = "";
     concepto  = "";
|FPRC;

|DEFBUCLE aslinfdl;
   #99#1;
   ;
   #9#0, #9#14, #9#15, #9#1, #9#2, 001;
   #9#0, #9#14, #9#15, #9#1, #9#2, 999;
   ;
   NULL, Imprime2;
|FIN;

|PROCESO imprelin_d;
|SI SwLectura = 1;
    |SI #9#4 = "ASUN"; |Y #9#5 = "01";
        Cab1 = #9#7;
        Cab2 = #9#8;
        Cab3 = #9#9;
    |FINSI;

    |SI #9#4 = "OBSE"; |Y #9#5 = "01";
        Pie1 = #9#7;
        Pie2 = #9#8;
        Pie3 = #9#9;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #9#4 = "ASUN"; |Y #9#5 = "01";
        |ACABA;
    |FINSI;

    |SI #9#4 = "OBSE"; |Y #9#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #9#10;
    secc_ase = #9#4;
    conc_ase = #9#5;
    dcab_ase = #9#6;
    unid_ase = #9#11;
    impo_ase = #9#13;
    prec_ase = #9#12;
    des1_ase = #9#7;
    des2_ase = #9#8;
    des3_ase = #9#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

|SALVA_FICHA #9;
aSerie   = #9#14;
nFactura = #9#15;
nTipoFac = #9#0;
nCliente = #9#1;
aSeccion = #9#4;
aConcept = #9#5;
aDescrip = #9#6;
aDescri1 = #9#7;
aDescri2 = #9#8;
aDescri3 = #9#9;
nImporte = #9#12;
nLinea   = #9#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linfacdir;
|REPON_FICHA #9;
|| FIN PEPE

descr1    = #9#7;
descr2    = #9#8;
descr3    = #9#9;
unidades  = #9#11;
ptasunid  = #9#12;
seccion   = #9#4;
concepto  = #9#5;
fecha_lin = #9#17;
enColNumexp = 0;
enNumLinCon = #9#2;

#0#34     = #9#11;
#0#35     = #9#12;
#0#36     = #9#4;
#0#37     = #9#5;

|SI #9#3 = 0;  fecha_lin = "";  |FINSI;

cargo_h = 0;
abono_h = 0;
saldo_a = 0;
acuen_a = 0;
acuen_i = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #9#10 = "H";
    |SI #9#13 > 0;
        cargo_h = #9#13;
        cargo   = #9#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#9#13;
        abono_h = -#9#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #9#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #9#10 = "S";
    |SI #9#13 > 0;
        cargo = #9#13;
        abono = 0;
    |SINO;
        abono = -#9#13;
        cargo = 0;
    |FINSI;

    supli    = #9#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #9#10 = "A";
    |SI #9#13 > 0;
        abono   = #9#13;
        cargo   = 0;
        acuen_a = #9#13;
        acuen_i = #9#13;
    |SINO;
        cargo   = -#9#13;
        abono   = 0;
        acuen_i = -#9#13;
        saldo_a = -#9#13;
    |FINSI;

    acum     = #9#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #9#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #9#13;
    indihono = indihono + 1;
|FINSI;

|SI #9#10 = "H";  #0#13 = #9#13;  #0#29 = "H";  |FINSI;
|SI #9#10 = "S";  #0#14 = #9#13;  #0#29 = "S";  |FINSI;
|SI #9#10 = "A";  #0#15 = #9#13;  #0#29 = "A";  |FINSI;

#0#27 = cargo;
#0#28 = abono;
#0#40 = #0#40 + cargo_h;
#0#41 = #0#41 + abono_h;

|SI nCuadre = 0;
    |BUCLE aslinfdl;
    #99#6 = "";  |HAZ Imprime2;
|SINO;
     |SI informe ! "sinlinea";
         |PRINT;
     |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE aslinfdi;
#9#2;
;
#8#0, #8#27, #8#28, #8#1, "00.00.0000", 000;
#8#0, #8#27, #8#28, #8#1, "31.12.9999", 999;
e;
NULL, imprelin_d;
|FIN;

|PROCESO lineasfac_d;
retsino   = #8#12;
|SI #8#12 = "S"; ret = #12#31; |SINO; ret = 0; |FINSI;
dto       = #8#20;
observa   = #8#31;

|ABRE #451;
|SELECT #1#451;
#451#0 = #8#0;
|LEE 000#451=;
|SI FSalida ! 0; |DDEFECTO #451; |FINSI;
|CIERRA #451;

ivabo     = #451#3;
enTipoFac = #8#0;
serie     = #8#27;
factura   = #8#28;
#0#4      = #8#29;
fech      = #8#29;

#0#10   = #8#27;
#0#11   = #8#28;
#0#4    = #8#29;


enCodPago = #8#10;
|HAZ LeeFormaDePago;
eaDForPago = #712#1;
|SI #8#10 = 99;
    fechv = "A LA VISTA";
|SINO;
    fechav    = #8#29;
    fechv     = fechav;
    |SI #712#5 ! 0;
        |SI #712#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #712#5 / em;
        fechav = #8#29 + j;
        fechv  = fechav;
    |FINSI;
|FINSI;

|HAZ desconfec;

nCodigo = #8#1;
|HAZ LeeCliente;

|HAZ CtlAsteriscoCta;

enCodCli = #5#0;
|HAZ LeePersona;

enCodBanco = #8#11;
|HAZ LeeBancoPropio;

|SI #0#38 = "F";
    |SI enSwDeDonde = 1;
        eaEscalera = #715#22;
        eaPiso     = #715#23;
        eaPuerta   = #715#24;
    |SINO;
        eaEscalera = #715#6;
        eaPiso     = #715#7;
        eaPuerta   = #715#8;
    |FINSI;
|FINSI;

SwLectura = 1; |BUCLE aslinfdi;
SwLectura = 0; |BUCLE aslinfdi;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;

#0#16 = thono;
#0#17 = tsupli;
#0#18 = tacum;
#0#19 = ivabo;
#0#20 = timp;
#0#22 = tfac;
#0#39 = thono1;

|SI EURODB = 0;
    #0#21 = (#0#22 / 166.386) ! 2;
|SINO;
    #0#21 = (#0#22 * 166.386) ! 0;
|FINSI;
#0#23 = tpagar;
#0#24 = thono;
#0#25 = impdto;

|SI informe = "asfacmja";  |O informe = "asfacacg";
  |O informe = "asfa1mja";  |O informe = "asfa1acg";
    |SI dto ! 0;
        #0#12 = "REDUCCION ESPECIAL " + dto + "% ";
        #0#13 = -#0#25;
        |PRINT;
        #0#13     = 0;
        #0#14     = 0;
        #0#15     = 0;
        #0#27     = 0;
        #0#28     = 0;
        #0#29     = "";
        #0#34     = 0;
        #0#35     = 0;
        #0#36     = "";
        #0#37     = "";
        unidades  = 0;
        ptasunid  = 0;
        seccion   = "";
        concepto  = "";
    |FINSI;
|FINSI;

|SI informe ! "sinlinea";
    |PIEINF;
|SINO;
    |PRINT;
    |PIEINF;
|FINSI;

|HAZ borra;
|FPRC;

|PROCESO desde_directa;
|ABRE #8;
#8#0  = tipo_d;
#8#1  = cliente_d;
#8#27 = serie_d;
#8#28 = factura_d;
|LEE 040#8=;
|SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
|CIERRA #8;

|IMPRE 0;
|SI FSalida ! 0; |ACABA; |FINSI;

     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = #8#30;
     |LEE 101#3=;
     |SI FSalida = 0;
         #3#15 = #0#38;
         #3#19 = #0#26;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
     |CIERRA #3;

|SI nArchi = 1;
     informe = #3#17;
     |QBF informe;
     |SI informe = "";
          informe = #3#12;
     |FINSI;
|SINO;
     informe = #3#12;
|FINSI;
|QBF informe;
aInformePapel = #3#12;
|QBF aInformePapel;
informe = informe < "";

|HAZ MiraQueCuadre;

|INFOR informe;
|SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

|ABRE #12;
|LEE 121#12p;
|SI FSalida = 0;
    |HAZ lineasfac_d;
|FINSI;
|CIERRA #12;
|FININF;
|FINIMP;
|FPRC;

|| ***********************************************************************


|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE HISTORICO MINUTAS
|| ***********************************************************************

|PROCESO Linhismil;
   |SI #11#6 = aDescrip; |Y #11#7 = aDescri1; |Y #11#8 = aDescri2;
    |Y #11#9 = aDescri3; |Y #11#12 = nImporte;
      enUnidades = enUnidades + #11#11;
      enImpTotal = enImpTotal + #11#13;
      |SI #11#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linhismil; || PEPE
#ashismil#1;
4,5;
aSerie, nFactura, 001, aSeccion, aConcept;
aSerie, nFactura, 999, aSeccion, aConcept;
;
NULL,Linhismil;
|FIN:

|PROCESO Imprime3;
     #0#12 = #111#4;
     |SI informe ! "sinlinea";
         |PRINT;
     |FINSI;

     #0#13     = 0;
     #0#14     = 0;
     #0#15     = 0;
     #0#27     = 0;
     #0#28     = 0;
     #0#29     = "";
     #0#34     = 0;
     #0#35     = 0;
     #0#36     = "";
     #0#37     = "";
     unidades  = 0;
     ptasunid  = 0;
     seccion   = "";
     concepto  = "";

     nPrint = 1;
|FPRC;

|DEFBUCLE ashismit;
   #111#1;
   ;
   #11#0, #11#1, #11#2, 001;
   #11#0, #11#1, #11#2, 999;
   ;
   NULL, Imprime3;
|FIN;

|PROCESO imprelin_h;
|SI SwLectura = 1;
    |SI #11#4 = "ASUN"; |Y #11#5 = "01";
        Cab1 = #11#7;
        Cab2 = #11#8;
        Cab3 = #11#9;
    |FINSI;

    |SI #11#4 = "OBSE"; |Y #11#5 = "01";
        Pie1 = #11#7;
        Pie2 = #11#8;
        Pie3 = #11#9;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #11#4 = "ASUN"; |Y #11#5 = "01";
        |ACABA;
    |FINSI;

    |SI #11#4 = "OBSE"; |Y #11#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

||     PEPE
|SALVA_FICHA #11;
aSerie   = #11#0;
nFactura = #11#1;
aSeccion = #11#4;
aConcept = #11#5;
aDescrip = #11#6;
aDescri1 = #11#7;
aDescri2 = #11#8;
aDescri3 = #11#9;
nImporte = #11#12;
nLinea   = #11#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linhismil;
|REPON_FICHA #11;
|| FIN PEPE

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #11#10;
    secc_ase = #11#4;
    conc_ase = #11#5;
    dcab_ase = #11#6;
    unid_ase = #11#11;
    impo_ase = #11#13;
    prec_ase = #11#12;
    des1_ase = #11#7;
    des2_ase = #11#8;
    des3_ase = #11#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

descr1    = #11#7;
descr2    = #11#8;
descr3    = #11#9;
unidades  = #11#11;
ptasunid  = #11#12;
seccion   = #11#4;
concepto  = #11#5;
fecha_lin = #11#3;
enColNumexp = #11#15;
enNumLinCon = #11#2;

#0#34     = #11#11;
#0#35     = #11#12;
#0#36     = #11#4;
#0#37     = #11#5;

cargo_h   = 0;
abono_h   = 0;
saldo_a   = 0;
acuen_a   = 0;
acuen_i   = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #11#10 = "H";
    |SI #11#13 > 0;
        cargo_h = #11#13;
        cargo   = #11#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#11#13;
        abono_h = -#11#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #11#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #11#10 = "S";
    |SI #11#13 > 0;
        cargo = #11#13;
        abono = 0;
    |SINO;
        abono = -#11#13;
        cargo = 0;
    |FINSI;

    supli    = #11#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #11#10 = "A";
    |SI #11#13 > 0;
        abono   = #11#13;
        cargo   = 0;
        acuen_a = #11#13;
        acuen_i = #11#13;
    |SINO;
        cargo   = -#11#13;
        abono   = 0;
        acuen_i = -#11#13;
        saldo_a = -#11#13;
    |FINSI;

    acum     = #11#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #11#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #11#13;
    indihono = indihono + 1;
|FINSI;

|SI #11#10 = "H";  #0#13 = #11#13;  #0#29 = "H";  |FINSI;
|SI #11#10 = "S";  #0#14 = #11#13;  #0#29 = "S";  |FINSI;
|SI #11#10 = "A";  #0#15 = #11#13;  #0#29 = "A";  |FINSI;

#0#27 = cargo;
#0#28 = abono;
#0#40 = #0#40 + cargo_h;
#0#41 = #0#41 + abono_h;

|SI nCuadre = 0;
    nPrint = 0;
    |BUCLE ashismit;

    |SI nPrint = 0;
        |PARA nCampo = 7;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
              aAlfa = #11nCampo;  |QBF aAlfa;
              |SI aAlfa ! "";
                  #0#12 = #11nCampo;
                  |SI informe ! "sinlinea";
                      |PRINT;
                  |FINSI;

                  #0#13     = 0;
                  #0#14     = 0;
                  #0#15     = 0;
                  #0#27     = 0;
                  #0#28     = 0;
                  #0#29     = "";
                  #0#34     = 0;
                  #0#35     = 0;
                  #0#36     = "";
                  #0#37     = "";
                  unidades  = 0;
                  ptasunid  = 0;
                  seccion   = "";
                  concepto  = "";

              |FINSI;
        |SIGUE;
    |FINSI;

    #111#4 = "";  |HAZ Imprime3;
|SINO;
    |SI informe ! "sinlinea";
        |PRINT;
    |FINSI;
|FINSI;

|SI #asfacges#26 = "S";
   enSwCuotas = 1;
   D_TipoFac  = 0;            H_TipoFac  = 9;
   D_Cliente  = #ashismic#3;  H_Cliente  = #ashismic#3;
   D_Serie    = #ashismil#0;  H_Serie    = #ashismil#0;
   D_Factura  = #ashismil#1;  H_Factura  = #ashismil#1;
   D_Linea    = #ashismil#2;  H_Linea    = #ashismil#2;
   aAct = "S";
   |BUCLE Cuotas;
   enSwCuotas = 0;
|FINSI;
|FPRC;

|DEFBUCLE ashismil;
#11#2;
;
#10#0, #10#1, "00.00.0000", 000;
#10#0, #10#1, "31.12.9999", 999;
e;
NULL, imprelin_h;
|FIN;

|PROCESO lineasfac_h;
|SI parada2 = 2;
    |ATRI R;
    |ATRI P;
    |PINTA 2130, " Introduzca Factura en impresora ";
    |ATRI 0;
    |PAUSA;
    |PINTA 2130, "                                  ";
|FINSI;

retsino   = #10#14;
|SI #10#14 = "S";
    ret = #10#46;
|SINO;
    ret = 0;
|FINSI;

dto       = #10#22;
observa   = #10#34;
ivabo     = #10#45;
enTipoFac = #10#2;
serie     = #10#0;
factura   = #10#1;
#0#4      = #10#29;
fech      = #10#29;

#0#10   = #10#0;
#0#11   = #10#1;
#0#4    = #10#29;

enCodPago = #10#12;
|HAZ LeeFormaDePago;
eaDForPago = #712#1;
|SI #10#12 = 99;
    fechv = "A LA VISTA";
|SINO;
    fechav    = #10#29;
    fechv     = fechav;
    |SI #712#5 ! 0;
        |SI #712#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #712#5 / em;
        fechav = #10#29 + j;
        fechv = fechav;
    |FINSI;
|FINSI;

|HAZ desconfec;

nCodigo = #10#3;
|HAZ LeeCliente;

|HAZ CtlAsteriscoCta;

enCodCli = #5#0;
|HAZ LeePersona;

enCodBanco = #10#13;
|HAZ LeeBancoPropio;

|SI #0#38 = "F";
    |SI enSwDeDonde = 1;
        eaEscalera = #715#22;
        eaPiso     = #715#23;
        eaPuerta   = #715#24;
    |SINO;
        eaEscalera = #715#6;
        eaPiso     = #715#7;
        eaPuerta   = #715#8;
    |FINSI;
|FINSI;

SwLectura = 1; |BUCLE ashismil;
SwLectura = 0; |BUCLE ashismil;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;

#0#16 = thono;
#0#17 = tsupli;
#0#18 = tacum;
#0#19 = ivabo;
#0#20 = timp;
#0#22 = tfac;
#0#23 = tpagar;
#0#24 = thono;
#0#25 = impdto;
#0#39 = thono1;

|SI informe = "asfacmja";  |O informe = "asfacacg";
 |O informe = "asfa1mja";  |O informe = "asfa1acg";
    |SI dto ! 0;
        #0#12 = "REDUCCION ESPECIAL " + dto + "% ";
        #0#13 = -#0#25;
        |PRINT;

        #0#13     = 0;
        #0#14     = 0;
        #0#15     = 0;
        #0#27     = 0;
        #0#28     = 0;
        #0#29     = "";
        #0#34     = 0;
        #0#35     = 0;
        #0#36     = "";
        #0#37     = "";
        unidades  = 0;
        ptasunid  = 0;
        seccion   = "";
        concepto  = "";
    |FINSI;
|FINSI;

|SI informe ! "sinlinea";
    |PIEINF;
|SINO;
    |PRINT;
    |PIEINF;
|FINSI;

|HAZ borra;
|FPRC;

|DEFBUCLE ashismic;
     #10#1;
     29, 3, 13, 12;
     d_serie, d_factu, d_fecha, d_clien, enDReme, enDFPag;
     h_serie, h_factu, h_fecha, h_clien, enHReme, enHFPag;
     e;
     NULL, lineasfac_h;
|FIN;

|PROCESO asw00050;
     #10#0 = #900#1;
     #10#1 = #900#2;
     |LEE 000#10=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ lineasfac_h;
|FPRC;

|DEFBUCLE asw00050;
     #900#1;
     ;
     001;
     999;
     ;
     NULL, asw00050;
|FIN;

|PROCESO LeeHistorico1;
     |SI eaParrilla ! "P";
         |BUCLE ashismic;
     |SINO;
         aAlfa = ("f5" + Usuario + "zzzzzzzz") % 108; |NOME_DAT #900 aAlfa;

         |ABRE #10;
         |BUCLE asw00050;
         |CIERRA #10;
     |FINSI;
|FPRC;

|PROCESO GeneraPDF;
     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + informe + ".rpt";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida < 0;
         aAlfa = "    Falta el cuadre " + aAlfa + ". El documento no se archivara";
         |MENAV aAlfa;

         |ACABA;
     |FINSI;

     |ESPECIFICA "RBASS", aPuntero;
     aOrig = aPuntero; |QBF aOrig;
     aOrig = aOrig + "crystal/";
     aOrig = aOrig + "tm" + Usuario + ".pdf";
     |RFBORRA aOrig;

     |DFICE aDest; |QBF aDest;
     aDest = aDest + "tm" + Usuario + ".pdf";
     |FBORRA aDest;

     aImpresora = "CrystalReport;" + aOrig;
     Impresora = aImpresora;
     |IMPRE -1;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR informe;
     |SI FSalida ! 0;
         |FINIMP;
         |ACABA;
     |FINSI;

     nParAnt = parada2; parada2 = 1;
     |SI aTipoFactura = "H";  |HAZ lineasfac_h;  |FINSI;
     |SI aTipoFactura = "N";  |HAZ lineasfac_n;  |FINSI;
     |SI aTipoFactura = "D";  |HAZ lineasfac_d;  |FINSI;

     parada2 = nParAnt;
     |FININF;
     |FINIMP;

     nIntento = 0;
     |PARA;  |SI nIntento [ 3;  |HACIENDO;
          |XABRE "EC", aOrig, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          nIntento = nIntento + 1;
     |SIGUE;

     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrig, aDest;
     |SINO;
         |COPIA_FICHERO aOrig, aDest;
     |FINSI;

     |SI FSalida ! 0;
         |MENAV "    Ha habido algun problema en la copia del documento al servidor";

         aAlfa = "    Origen  : " + aOrig;
         |MENAV aAlfa;

         aAlfa = "    Destino : " + aDest;
         |MENAV aAlfa;

         |ACABA;
     |SINO;
         |RFBORRA aOrig;
     |FINSI;

     |SI aTipoFactura = "H";
         eaArCodCli = #ashismic#3;  || Codigo Cliente
         eaArNomCli = #ashismic#5;  || Nombre Cliente
         eaArCodCif = #ashismic#11; || Cif
         eaArNomCif = #ashismic#3;  || Nombre Cif
         eaArCamPDF = aDest;        || Camino al PDF a archivar
         eaArSerMin = #ashismic#0;  || Serie minuta
         eaArNumMin = #ashismic#1;  || Numero minuta
         eaArFecMin = #ashismic#29; || Fecha minuta
     |FINSI;

     |SI aTipoFactura = "N";
         eaArCodCli = #ascabmin#1;  || Codigo Cliente
         eaArNomCli = #ascabmin#3;  || Nombre Cliente
         eaArCodCif = #ascabmin#9;  || Cif
         eaArNomCif = #ascabmin#3;  || Nombre Cif
         eaArCamPDF = aDest;        || Camino al PDF a archivar
         eaArSerMin = #ascabmin#27; || Serie minuta
         eaArNumMin = #ascabmin#28; || Numero minuta
         eaArFecMin = #ascabmin#29; || Fecha minuta
     |FINSI;

     |SI aTipoFactura = "D";
         eaArCodCli = #ascabfdi#1;  || Codigo Cliente
         eaArNomCli = #ascabfdi#3;  || Nombre Cliente
         eaArCodCif = #ascabfdi#9;  || Cif
         eaArNomCif = #ascabfdi#3;  || Nombre Cif
         eaArCamPDF = aDest;        || Camino al PDF a archivar
         eaArSerMin = #ascabfdi#27; || Serie minuta
         eaArNumMin = #ascabfdi#28; || Numero minuta
         eaArFecMin = #ascabfdi#29; || Fecha minuta
     |FINSI;

     |SI nSwSinCorreo = 1;
         eaDirDesFE = "";
         eaSwEnvioCorreo = "N";
     |SINO;
         eaDirDesFE = #asclient#57;
         |SI #asclient#74 = "P";
             eaSwEnvioCorreo = "N";
         |SINO;
             eaSwEnvioCorreo = #asclient#74;
         |FINSI;
     |FINSI;

     eaFirmarFE = #asclient#75;
     eaEmpresaFE = ("00" + #48#0) % -102;

     |SUB_EJECUTA ":dsarchi/dsarz004.tab";
|FPRC;

|PROCESO ashismic2;
      |SI nOpcion = 3;
          ||Ahora tengo que imprimir en papel o firmar segun el cliente.

          |ABRE #5;
          #5#0 = #ashismic#3;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          |SI #asclient#74 = "S";
              |SI aOpcionCli = "3"; |ACABA;  |FINSI;
          |SINO;
              |SI aOpcionCli = "2"; |ACABA;  |FINSI;
          |FINSI;

          |SI #asclient#74 = "S"; |O #asclient#75 = "S";
              |SI nSwArchiXML = 0;
                  aTipoFactura = "H";  |HAZ GeneraPDF;
              |SINO;
                  |HAZ FirmaFactura;
              |FINSI;
         |FINSI;

         |SI #asclient#74 = "P"; |Y nSwFacturaYaImpresa = 0;
              |SI nPrimero = 0;
                  Impresora = aImpre; |IMPRE -1;
              |SINO;
                  |IMPRE 0;
                  |SI FSalida ! 0; |ACABA; |FINSI;
                  aImpre = Impresora;
                  |QBF aImpre;
                  nPrimero = 0;
              |FINSI;

              |INFOR aInformePapel;
              |SI FSalida = 0; |HAZ lineasfac_h; |FINSI;

              |FININF;
              |FINIMP;
         |FINSI;
      |FINSI;

      |SI nOpcion = 1;
         |SI nSwArchiXML = 0;
             aTipoFactura = "H";  |HAZ GeneraPDF;
         |SINO;
              |HAZ FirmaFactura;
         |FINSI;

         |SI #asclient#74 = "P"; |Y nSwFacturaYaImpresa = 0;
              |SI nPrimero = 0;
                  Impresora = aImpre; |IMPRE -1;
              |SINO;
                  |IMPRE 0;
                  |SI FSalida ! 0; |ACABA; |FINSI;
                  aImpre = Impresora;
                  |QBF aImpre;
                  nPrimero = 0;
              |FINSI;

              |INFOR aInformePapel;
              |SI FSalida = 0; |HAZ lineasfac_h; |FINSI;

              |FININF;
              |FINIMP;
         |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE ashismic2;
     #10#1;
     29, 3, 13, 12;
     d_serie, d_factu, d_fecha, d_clien, enDReme, enDFPag;
     h_serie, h_factu, h_fecha, h_clien, enHReme, enHFPag;
     e;
     NULL, ashismic2;
|FIN;

|PROCESO asw00050_2;
     #10#0 = #900#1;
     #10#1 = #900#2;
     |LEE 000#10=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ ashismic2;
|FPRC;

|DEFBUCLE asw00050_2;
     #900#1;
     ;
     001;
     999;
     ;
     NULL, asw00050_2;
|FIN;

|PROCESO LeeHistorico2;
     |SI eaParrilla ! "P";
         |BUCLE ashismic2;
     |SINO;
         aAlfa = ("f5" + Usuario + "zzzzzzzz") % 108; |NOME_DAT #900 aAlfa;

         |ABRE #10;
         |BUCLE asw00050_2;
         |CIERRA #10;
     |FINSI;
|FPRC;

|PROCESO desde_histori;
     |SI enModVisados = 0;
          parada2 = "1";
          |SI PARAMETRO ! "SOLOUNAMINUTA";
              |MENU parada;
              parada2 = FSalida;
          |FINSI;
          #asfacges#26 = cuotas;
          |SI parada2 < 1; |O parada2 > 2; |ACABA; |FINSI;
     |SINO;
          parada2 = 1;
          #asfacges#26 = cuotas;
     |FINSI;

     |SI enModVisados = 0;
          |IMPRE 0;
     |SINO;
        |SI enModVis = 1;
           Impresora = "visfact";
           |IMPRE -1;
        |SINO;
          |IMPRE 0;
        |FINSI;
     |FINSI;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = empresa;
     |LEE 101#3=;
     |SI FSalida = 0;
         #3#15 = #0#38;
         #3#19 = #0#26;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
     |CIERRA #3;

     |SI nArchi = 1;
          informe = #3#18;
          |QBF informe;
          |SI informe = "";
               informe = #3#11;
          |FINSI;
     |SINO;
          informe = #3#11;
     |FINSI;
     |QBF informe;
     informe = informe < "";

     aInformePapel = #3#11;
     |QBF aInformePapel;

     |HAZ MiraQueCuadre;

     |INFOR informe;
     |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

     |SI enModVisados = 1;
          eaSerExp = "";
          enNumExp = 0;
          eaDesExp = "";
          eaCtrFac = "";
          efFecVia = "01.01.0000";

          |DBASE aBase;
          |QBF aBase;
          aFichero = aBase + "def/visam001";
          |CARGA_DEF aFichero, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               |SELECT #5#referen@;
               #referen@#24 = d_serie;
               #referen@#25 = d_factu;
               |LEE 000#referen@.=;
               |SI FSalida = 0;
                    ||Campos del expediente.
                    eaSerExp = ("00" + #referen@#0) % -102;
                    enNumExp = #referen@#14;
                    eaDesExp = #referen@#13;
                    eaCtrFac = #referen@#29;
                    efFecVia = #referen@#30;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;

     |ABRE #2;
     |ABRE #4;
     |LEE 121#4p;
     |SI FSalida = 0;
         |HAZ LeeHistorico1;
     |SINO;
         |SI enModVisados = 0;
              |MENAV " ***  ATENCION  ***  FICHERO DE CONTROL INEXISTENTE";
         |SINO;
              |DDEFECTO #4;
              |HAZ LeeHistorico1;
         |FINSI;
     |FINSI;
     |LIBERA #4;
     |CIERRA #2;
     |CIERRA #4;
     |FININF;
     |FINIMP;

     enSwPDFVisados = 1;
|FPRC;

|| ***********************************************************************

|PROCESO borra;
Ides = des1 <-;
Iimp = imp1 <-;
|PARA i = 0;|SI i < 12;|HACIENDO i = i + 1;
    des  = "";
    imp  = 0;
    Ides = Ides + 1;
    Iimp = Iimp + 1;
|SIGUE;

Cab1   = "";
Cab2   = "";
Cab3   = "";
Pie1   = "";
Pie2   = "";
Pie3   = "";

tacum  = 0;
thono  = 0;
tsupli = 0;
tsal_a = 0;

#0#16 = 0;
#0#17 = 0;
#0#18 = 0;
#0#19 = 0;
#0#20 = 0;
#0#21 = 0;
#0#22 = 0;
#0#23 = 0;
#0#24 = 0;
#0#39 = 0;
#0#40 = 0;
#0#41 = 0;
|FPRC;

|PROCESO MiraSiArchiva;
   nSwGenerarPDF = 0;
   nArchi = 0;
   nSwFirma = 0;
   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida ] 0;
      |CARGA_DEF aAlfa, Ref0001@;
      |SI FSalida = 0;

         ||Configuracion de Factura_E por empresa
         nHayConfEmp = 0;
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dsarchi/def/dsarm057.mas";
         |CARGA_DEF aAlfa, Ref0002@;
         |SI FSalida = 0;
              |DBASS aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #2000 aAlfa;
              nEmpresa = #48#0;
              |ABRE #Ref0002@;
              #Ref0002@#0 = nEmpresa;
              |LEE 000#Ref0002@.=;
              |SI FSalida = 0;
                   nHayConfEmp = 1;
                   |SI #Ref0002@#6 = "S";
                       nSwGenerarPDF = 1;
                   |SINO;
                       nSwGenerarPDF = 0;
                   |FINSI;
              |FINSI;
              |CIERRA #Ref0002@; |DESCARGA_DEF #Ref0002@;
         |FINSI;

         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #1000 aAlfa;
         |ABRE #Ref0001@;
         |DDEFECTO #Ref0001@;
         |LEE 000#Ref0001@.p;
         |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

         |SI #Ref0001@#3 = "S";
            nArchi = 1;
            eaArGrpMin = #Ref0001@#4;
            eaArSbGMin = #Ref0001@#5;
            eaArTipMin = #Ref0001@#6;

            ||Ahora siempre sera si es dsarchi. FacturaE.
            nSwArchiXML = 1;

            |SI nHayConfEmp = 0;
                |SI #Ref0001@#164 = "S";
                    nSwGenerarPDF = 1;
                |SINO;
                    nSwGenerarPDF = 0;
                |FINSI;
           |FINSI;
         |SINO;
            eaArGrpMin = "";
            eaArSbGMin = "";
            eaArTipMin = "";
         |FINSI;
         |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
      |FINSI;
   |FINSI;

   |SI nArchi = 1; |O nSwFirma = 1;
      |HAZ Archivando;
   |SINO;
      nArchi = 0;

      |SI d_viene = 0; |HAZ desde_normal;  |FINSI;
      |SI d_viene = 1; |HAZ desde_directa; |FINSI;
      |SI d_viene = 2; |HAZ desde_histori; |FINSI;
   |FINSI;
|FPRC;

|PROGRAMA;
     |SI #48#3 = "N";
         #0#38 = "F";
         |C_M #0#38, 1, "N";
     |FINSI;

     PRMNT_nOpc = 0;
     |HAZ PreparaInformes;

     |SI PARAMETRO = "SOLOUNAMINUTA";
         #0#0 = enTipo;
         #0#1 = enTipo;
         #0#2 = enCliente;
         #0#3 = enCliente;

         |C_M #0#0,  1, "N";
         |C_M #0#1,  1, "N";
         |C_M #0#2,  1, "N";
         |C_M #0#3,  1, "N";
         |C_M #0#6,  1, "N";
         |C_M #0#7,  1, "N";
         |C_M #0#8,  1, "N";
         |C_M #0#9,  1, "N";
         |C_M #0#30, 1, "N";
         |C_M #0#31, 1, "N";
         |C_M #0#32, 1, "N";
         |C_M #0#33, 1, "N";
     |FINSI;

     |SI d_viene = 0;
         |CLS;
         |CABEZA "Impresion Facturas";
         |PINPA #0#0;

         |HAZ Tipo0C5;

         |PINDA #0#0;
         |ENDATOS #1#0;
         |SI FSalida = 0;
             enErrorFac = 0;
             |HAZ MiraSiArchiva;
         |FINSI;
     |SINO;
         |SI eaTipoDir ! "";  #0#38 = eaTipoDir; |FINSI;
         |SI cuotas    ! "";  #0#26 = cuotas;    |FINSI;
         |HAZ MiraSiArchiva;
     |FINSI;
|FPRO;


||***************************************************************************
||***************************************************************************
||***************************************************************************
||***************************************************************************

|PROCESO ascabmin2;
      |SI nOpcion = 3;
          ||Ahora tengo que imprimir en papel o firmar segun el cliente.
          |ABRE #5;
          #5#0 = #ascabmin#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          |SI #asclient#74 = "S";
              |SI aOpcionCli = "3"; |ACABA;  |FINSI;
          |SINO;
              |SI aOpcionCli = "2"; |ACABA;  |FINSI;
          |FINSI;

          |SI #asclient#74 = "S"; |O #asclient#75 = "S";   ||2
              |SI nSwArchiXML = 0;
                  aTipoFactura = "N";  |HAZ GeneraPDF;
              |SINO;
                   |HAZ FirmaFactura;
              |FINSI;
          |FINSI;

          |SI #asclient#74 = "P"; |Y nSwFacturaYaImpresa = 0;
              |SI nPrimero = 0;
                   Impresora = aImpre; |IMPRE -1;
              |SINO;
                   |IMPRE 0;
                   |SI FSalida ! 0; |ACABA; |FINSI;
                   aImpre = Impresora;
                   |QBF aImpre;
                   nPrimero = 0;
              |FINSI;

              ||INFOR informe;
              |INFOR aInformePapel;
              |SI FSalida = 0; |HAZ lineasfac_n; |FINSI;
              |FININF;
              |FINIMP;
          |FINSI;
     |FINSI;

   |SI nOpcion = 1;
      |SI nSwArchiXML = 0;
          aTipoFactura = "N";  |HAZ GeneraPDF;
      |SINO;
           |HAZ FirmaFactura;
      |FINSI;

      |SI #asclient#74 = "P"; |Y nSwFacturaYaImpresa = 0;
          |SI nPrimero = 0;
               Impresora = aImpre; |IMPRE -1;
          |SINO;
               |IMPRE 0;
               |SI FSalida ! 0; |ACABA; |FINSI;
               aImpre = Impresora;
               |QBF aImpre;
               nPrimero = 0;
          |FINSI;

          ||INFOR informe;
          |INFOR aInformePapel;
          |SI FSalida = 0; |HAZ lineasfac_n; |FINSI;
          |FININF;
          |FINIMP;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE ascabmin2;
#1#1;
27, 28, 11, 10;
#0#0, #0#2, #0#6, #0#8, #0#30, #0#32;
#0#1, #0#3, #0#7, #0#9, #0#31, #0#33;
e;
NULL, ascabmin2;
|FIN;

|PROCESO ProcesosConf;
     aPopup1  = 0;
     aPopup2  = 4;
     aPopup3  = "1.- Todas";
     aPopup4  = "2.- Solo facturas por correo";
     aPopup5  = "3.- Solo facturas por papel";
     aPopup6  = "4.- Cancelar";

     |PARA;  |SI;  |HACIENDO;
          IaPopup  = aPopup1  <-;
          |ESPECIFICA "TRACKPOPUP", aPopup;
          |SI FSalida ! 0;
              IaPopup  = aPopup3  <-;
              IaPopup  = IaPopup + (FSalida - 1);

              aOpcionCli = aPopup % 101;

              |PULSATECLA;

              |SI aOpcionCli = "1";  |SAL;  |FINSI;
              |SI aOpcionCli = "2";  |SAL;  |FINSI;
              |SI aOpcionCli = "3";  |SAL;  |FINSI;
              |SI aOpcionCli = "4";  |SAL;  |FINSI;
          |FINSI;
     |SIGUE;

     |PULSATECLA;
|FPRC;

|PROCESO ConfCliente;
     nError = 1;
     |HAZ ProcesosConf;
     |SI aOpcionCli = "4";  |ACABA;  |FINSI;

     |SI d_viene = 0;
         nError = 0;
     |FINSI;

     |SI d_viene = 2;
         |SI d_serie ! h_serie; |O d_factu ! h_factu;
             nError = 0;
             |ACABA;
         |FINSI;

         nCliente = 0;
         |ABRE #ashismic;
         #ashismic#0 = d_serie;
         #ashismic#1 = d_factu;
         |LEE 000#ashismic.=;
         |SI FSalida = 0;
             nCliente = #ashismic#3;
         |FINSI;
         |CIERRA #ashismic;

         |ABRE #5;
         #5#0 = nCliente;
         |LEE 000#5=;
         |SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
         |CIERRA #5;

         |SI #asclient#74 = "S";
             |SI aOpcionCli = "3"; |ACABA;  |FINSI;
         |SINO;
             |SI aOpcionCli = "2"; |ACABA;  |FINSI;
         |FINSI;

         |SI #asclient#74 = "S"; |O #asclient#75 = "S";
             |SI #asclient#74 = "P";
                 nArchi = 0;
                 |SI d_viene = 0; |HAZ desde_normal;  |FINSI;
                 |SI d_viene = 1; |HAZ desde_directa; |FINSI;
                 |SI d_viene = 2; |HAZ desde_histori; |FINSI;

                 nArchi = 1;
                 nSwFacturaYaImpresa = 1;
             |FINSI;

             nError  = 0;
             nOpcion = 1;
         |SINO;
             |SI #asclient#74 = "P";
                 nError  = 0;
                 nOpcion = 2;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI d_viene = 1;
         |ABRE #8;
         #8#0  = tipo_d;
         #8#1  = cliente_d;
         #8#27 = serie_d;
         #8#28 = factura_d;
         |LEE 040#8=;
         |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
         |CIERRA #8;

         |ABRE #5;
         #5#0 = #ascabfdi#1;
         |LEE 000#5=;
         |SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
         |CIERRA #5;

         |SI #asclient#74 = "S";
             |SI aOpcionCli = "3"; |ACABA;  |FINSI;
         |SINO;
             |SI aOpcionCli = "2"; |ACABA;  |FINSI;
         |FINSI;

         |SI #asclient#74 = "S"; |O #asclient#75 = "S";
             |SI #asclient#74 = "P";
                 nArchi = 0;
                 |SI d_viene = 0; |HAZ desde_normal;  |FINSI;
                 |SI d_viene = 1; |HAZ desde_directa; |FINSI;
                 |SI d_viene = 2; |HAZ desde_histori; |FINSI;

                 nArchi = 1;
                 nSwFacturaYaImpresa = 1;
             |FINSI;
             nError  = 0;
             nOpcion = 1;
         |SINO;
             |SI #asclient#74 = "P";
                 nError  = 0;
                 nOpcion = 2;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Archivando;
     nSwSinCorreo = 0;
     |SI enModVisados = 0;
        nOpcion = 0;
        |MENU aMenu;
     |SINO;
        |SI enModVis = 2;
           FSalida = 2;
        |SINO;
           nOpcion = 0;
           |MENU aMenu;
        |FINSI;
     |FINSI;

     |SI FSalida < 1; |O FSalida > 4; |ACABA; |FINSI;
     nOpcion = FSalida;

     |SI nOpcion = 4;
          nSwSinCorreo = 1;
          nOpcion      = 1;
     |FINSI;

     |SI nOpcion = 3;
         nError = 0;
         |HAZ ConfCliente;
         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI nOpcion = 2;
         nArchi = 0;
     |FINSI;

     |SI nOpcion = 1;
        aAlfa = "0000SSe van a enviar por email las minutas. Continuar?";
        |SI d_viene = 1;
            aAlfa = "0000SSe va a enviar por email la minuta. Continuar?";
        |FINSI;
        |CONFI aAlfa;
        |SI FSalida ! 0; |ACABA; |FINSI;

        |SI nSwArchiXML = 0;
             |DFICB aAlfa; |QBF aAlfa;
             aAlfa = aAlfa + "tm" + Usuario + ".txt";
             Impresora = aAlfa;
             |IMPRE -77;
             |SI FSalida ! 0; |ACABA; |FINSI;
        |FINSI;

        |SI d_viene = 1;
           |ABRE #8;
           #8#0  = tipo_d;
           #8#1  = cliente_d;
           #8#27 = serie_d;
           #8#28 = factura_d;
           |LEE 040#8=;
           |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
           |CIERRA #8;
        |FINSI;
     |FINSI;

     |SI nOpcion = 2;
         |SI d_viene = 0; |HAZ desde_normal;  |FINSI;
         |SI d_viene = 1; |HAZ desde_directa; |FINSI;
         |SI d_viene = 2; |HAZ desde_histori; |FINSI;

         |ACABA;
     |FINSI;

     |SI nOpcion = 3; |Y d_viene = 1;
          |HAZ desde_directa;
     |FINSI;

     nPrimero = 1;

     |SI nOpcion = 3;
        |SI d_viene = 0; |O d_viene = 2;
            parada2 = "1";
            |SI PARAMETRO ! "SOLOUNAMINUTA";
                |MENU parada;
                parada2 = FSalida;
            |FINSI;
           |SI parada2 < 1; |O parada2 > 2; |ACABA; |FINSI;
        |SINO;
           |ABRE #8;
           #8#0  = tipo_d;
           #8#1  = cliente_d;
           #8#27 = serie_d;
           #8#28 = factura_d;
           |LEE 040#8=;
           |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
           |CIERRA #8;
        |FINSI;

        |SI nSwArchiXML = 0;
              Impresora = "CrystalReport";
              |IMPRE -1;
              |SI FSalida ! 0; |ACABA; |FINSI;
              aImpre = Impresora;
        |SINO;
              |SI d_viene ! 1;
                   |IMPRE 0;
                   |SI FSalida ! 0; |ACABA; |FINSI;
                   aImpre = Impresora;
                   nPrimero = 0;
              |FINSI;
        |FINSI;
     |FINSI;

     |ABRE #3;
     |SI d_viene = 0; #3#0 = #0#5;    |FINSI;
     |SI d_viene = 1; #3#0 = #8#30;   |FINSI;
     |SI d_viene = 2; #3#0 = empresa; |FINSI;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     |SI d_viene = 0;
          |SI nArchi = 1;
               informe = #3#16;
               |QBF informe;
               |SI informe = "";
                    informe = #3#8;
               |FINSI;
          |SINO;
               informe = #3#8;
          |FINSI;
          aInformePapel = #3#8;
          |QBF aInformePapel;
     |FINSI;
     |SI d_viene = 1;
          |SI nArchi = 1;
               informe = #3#17;
               |QBF informe;
               |SI informe = "";
                    informe = #3#12;
               |FINSI;
          |SINO;
               informe = #3#12;
          |FINSI;
          aInformePapel = #3#12;
          |QBF aInformePapel;
     |FINSI;
     |SI d_viene = 2;
          |SI nArchi = 1;
               informe = #3#18;
               |QBF informe;
               |SI informe = "";
                    informe = #3#11;
               |FINSI;
          |SINO;
               informe = #3#11;
          |FINSI;
          aInformePapel = #3#11;
          |QBF aInformePapel;
     |FINSI;
     |QBF informe;
     informe = informe < "";

     |HAZ MiraQueCuadre;

     |ABRE #2;
     |ABRE #4;
     |LEE 121#4p;
     |SI FSalida = 0;
        |SI d_viene = 0; |BUCLE ascabmin2;   |FINSI;
        |SI d_viene = 2; |HAZ LeeHistorico2; |FINSI;
        |SI d_viene = 1;
           |SI nOpcion = 1; |O nOpcion = 3;
                |SI nSwArchiXML = 0;
                    aTipoFactura = "D";  |HAZ GeneraPDF;
                |SINO;
                   ||z011
                   |HAZ FirmaFactura;
                |FINSI;
           |FINSI;

           |SI #asclient#74 = "P"; |Y nSwFacturaYaImpresa = 0;
                |SI nPrimero = 0;
                    Impresora = aImpre; |IMPRE -1;
                |SINO;
                    |IMPRE 0;
                    |SI FSalida ! 0; |ACABA; |FINSI;
                    aImpre = Impresora;
                    |QBF aImpre;
                    nPrimero = 0;
                |FINSI;

                ||INFOR informe;
                |INFOR aInformePapel;
                |SI FSalida = 0;
                     |ABRE #12;
                     |LEE 121#12p;
                     |SI FSalida = 0;
                         |HAZ lineasfac_d;
                     |FINSI;
                     |CIERRA #12;
                |FINSI;
                |FININF;
                |FINIMP;
           |FINSI;
        |FINSI;
     |SINO;
        |MENAV " ***  ATENCION  ***  FICHERO DE CONTROL INEXISTENTE";
     |FINSI;
     |LIBERA #4;
     |CIERRA #2;
     |CIERRA #4;

     |SI nSwArchiXML = 0; |O nOpcion = 3;
          |SI nOpcion = 1; |O nOpcion = 3; |FINIMP; |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaFacturaPDF;
     ||aMensaje = "0000Tengo que generar el PDF para enviarlo a DSARCHI";
     ||MENAV aMensaje;

     aFicheroPDF    = "";
     eaFacturaPDFFe = "";
     nSwHayPDF      = "";

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + informe + ".rpt";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida < 0;
         aAlfa = "    Falta el cuadre " + aAlfa + ". El documento no se archivara";
         |MENAV aAlfa;

         |ACABA;
     |FINSI;

     |ESPECIFICA "RBASS", aPuntero;
     aOrig = aPuntero; |QBF aOrig;
     aOrig = aOrig + "crystal/";
     aOrig = aOrig + "tm" + Usuario + ".pdf";
     |RFBORRA aOrig;

     aImpresora = "CrystalReport;" + aOrig;
     Impresora = aImpresora;
     |IMPRE -1;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR informe;
     |SI FSalida ! 0;
         |FINIMP;
         |ACABA;
     |FINSI;

     nParAnt = parada2; parada2 = 1;
     |SI aTipoFactura = "N";  |HAZ lineasfac_n;  |FINSI;
     |SI aTipoFactura = "D";  |HAZ lineasfac_d;  |FINSI;
     |SI aTipoFactura = "H";  |HAZ lineasfac_h;  |FINSI;
     parada2 = nParAnt;
     |FININF;
     |FINIMP;

     nIntento = 0;
     |PARA;  |SI nIntento [ 3;  |HACIENDO;
          |XABRE "EC", aOrig, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          nIntento = nIntento + 1;
     |SIGUE;

     aFicheroPDF = aOrig;

     |XABRE "EC", aFicheroPDF, 0;
     |SI FSalida ] 0;
         nSwHayPDF      = 1;
         eaFacturaPDFFe = aFicheroPDF;
     |FINSI;
|FPRC;

|PROCESO FirmaFactura;
     ||TODO CCC
     ||Pasamos la variables y llamabamos a dsarz011
     ||depende del aTipoFactura.
     ||aTipoFactura = "";   || (N)ormal; (D)irecta; (H)istorico

     |SI d_viene = 0; aTipoFactura = "N"; |FINSI;
     |SI d_viene = 1; aTipoFactura = "D"; |FINSI;
     |SI d_viene = 2; aTipoFactura = "H"; |FINSI;

     |SI nSwGenerarPDF = 1;
          |HAZ CreaFacturaPDF;
     |FINSI;

     |SI aTipoFactura = "N";
          enTipoFacFe = #ascabmin#0;
          |ABRE #450;
          |SELECT #1#450;
          #450#0 = #ascabmin#0;
          |LEE 000#450=;
          |SI FSalida ! 0; |DDEFECTO #450; |FINSI;
          |CIERRA #450;
          ivabo     = #450#3;
          enTipoIvaFe = ivabo;

          eaArCodCli = #ascabmin#1;  || Codigo Cliente
          eaArNomCli = #ascabmin#3;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ascabmin#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ascabmin#3;  || Nombre Cif

          eaArTipoDoc = "FN";
          eaArSerDoc = #ascabmin#27;
          enArNumDoc = #ascabmin#28;
          eaArFecDoc = #ascabmin#29;

          |SI nSwSinCorreo = 1;
               eaDirDesFE = "";
               eaSwEnvioCorreo = "N";
          |SINO;
               eaDirDesFE = #5#57;
               |SI #asclient#74 = "P";
                    eaSwEnvioCorreo = "N";
               |SINO;
                    eaSwEnvioCorreo = #asclient#74;
               |FINSI;
          |FINSI;
          eaFirmarFE = #asclient#75;

          eaAplicacion = "facturar";
          eaDefFE = "ascabmin";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ascabmin#27;
          eaNumeroFE = #ascabmin#28;
          eaDefLinFe = "aslinmin";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ascabmin#1;
          eaDefAlbFe = "";
          eaDefVencFe = "";
          eaArFecMin = #ascabmin#29; || Fecha minuta
          eaDefMultiLin = "aslinmil";
          eaDefAAPPFe = "asoraapp";

          enPorRetenIRPF = #4#31;

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;

     |SI aTipoFactura = "D";
          enTipoFacFe = #ascabfdi#0;
          |ABRE #451;
          |SELECT #1#451;
          #451#0 = #ascabfdi#0;
          |LEE 000#451=;
          |SI FSalida ! 0; |DDEFECTO #451; |FINSI;
          |CIERRA #451;

          ivabo     = #451#3;
          enTipoIvaFe = ivabo;

          eaArCodCli = #ascabfdi#1;  || Codigo Cliente
          eaArNomCli = #ascabfdi#3;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ascabfdi#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ascabfdi#3;  || Nombre Cif

          eaArTipoDoc = "FD";
          eaArSerDoc = #ascabfdi#27;
          enArNumDoc = #ascabfdi#28;
          eaArFecDoc = #ascabfdi#29;

          |SI nSwSinCorreo = 1;
               eaDirDesFE = "";
               eaSwEnvioCorreo = "N";
          |SINO;
               eaDirDesFE = #5#57;
               |SI #asclient#74 = "P";
                    eaSwEnvioCorreo = "N";
               |SINO;
                    eaSwEnvioCorreo = #asclient#74;
               |FINSI;
          |FINSI;
          eaFirmarFE = #asclient#75;

          eaAplicacion = "facturar";
          eaDefFE = "ascabfdi";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ascabfdi#27;
          eaNumeroFE = #ascabfdi#28;
          eaDefLinFe = "aslinfdi";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ascabfdi#1;
          eaDefAlbFe = "";
          eaDefVencFe = "";
          eaArFecMin = #ascabfdi#29; || Fecha minuta
          eaDefMultiLin = "aslinfdl";
          eaDefAAPPFe = "asoraapp";

          |ABRE #12;
          |DDEFECTO #12;
          |LEE 000#12.p;
          enPorRetenIRPF = #12#31;
          |CIERRA #12;

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;

     |SI aTipoFactura = "H";
          ivabo       = #10#45;
          enTipoIvaFe = ivabo;

          eaArCodCli = #ashismic#3;  || Codigo Cliente
          eaArNomCli = #ashismic#5;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ashismic#3;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ashismic#5;  || Nombre Cif

          eaArTipoDoc = "FH";
          eaArSerDoc = #ashismic#0;
          enArNumDoc = #ashismic#1;
          eaArFecDoc = #ashismic#29;

          |SI nSwSinCorreo = 1;
               eaDirDesFE = "";
               eaSwEnvioCorreo = "N";
          |SINO;
               eaDirDesFE = #5#57;
               |SI #asclient#74 = "P";
                    eaSwEnvioCorreo = "N";
               |SINO;
                    eaSwEnvioCorreo = #asclient#74;
               |FINSI;
          |FINSI;
          eaFirmarFE = #asclient#75;

          eaAplicacion = "facturar";
          eaDefFE = "ashismic";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ashismic#0;
          eaNumeroFE = #ashismic#1;
          eaDefLinFe = "ashismil";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ashismic#3;
          eaDefAlbFe = "";
          eaDefVencFe = "ashisrec";
          eaArFecMin = #ashismic#29; || Fecha minuta
          eaDefMultiLin = "ashismit";
          eaDefAAPPFe = "asoraapp";

          ||Ahora controlo si ademas de la integral instalada, esta activa
          |DBASS aBase;   |QBT aBase;
          aBase = aBase + "integral/def/dsam0000.mas";
          |XABRE "E", aBase, nCanal;
          nSalida = FSalida;
          |SI nSalida ] 0

               |DFICE aAlfa;  |QBF aAlfa;
               aAlfa = aAlfa % -202;

               |ABRE #999;
               #999#0 = aAlfa;
               |LEE 000#999=;
               |SI FSalida ! 0;  |DDEFECTO #999;  |FINSI;
               |CIERRA #999;

               |SI #999#3 = "N";
                    nSalida = -1;
               |FINSI;
          |FINSI;
          FSalida = nSalida;
          |SI FSalida ] 0;
               |HAZ IntegralActiva;
               |SI FSalida ] 0;
                    eaDefFPago = "dsam0118";
               |SINO;
                    eaDefFPago = "asfpagos";
               |FINSI;
          |SINO;
               eaDefFPago = "asfpagos";
          |FINSI;

          enPorRetenIRPF = #ashismic#46;

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;
|FPRC;
