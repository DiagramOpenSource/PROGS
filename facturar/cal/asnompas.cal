|FICHEROS;
     asnompas #0;
     asnomdat #1;    || datos nominas mes
     asconcep #2;    || conceptos
     asclient #3;    || clientes
     asnomenl #4;    || enlace codigos y tarifa
     asnomtar #5;    || tarifas
     ascabmin #6;    || minutas cabs.
     aslinmin #7;    || minutas lins.
     ascontro #8;    || control facturacion
     ascontrt #450;
     asconmen #9;    || conceptos variables
     aslinmil #10;   || Texto Minutas.
     asconlin #11;
|FIN;

|VARIABLES;
    nVariable     = 0;
    nFichero      = 0;
    nCliente      = 0;
    nDeDonde      = 0;
    aSeccion      = "";
    aConcepto     = "";

    fecha  = @;
    varalf = "";
    honorario = 0;
    suplido   = 0;
    acuenta   = 0;
    seccion   = "";
    concepto  = "";
    canti     = 0;
    import    = 0;
    tlinea    = 0;
    iva       = 0;
    linea     = 0;
    FEstado   = 0;
    sw_cabecera = 0;

    nTotalNominas = 0;

    h_nomin = 0;
    h_pagas = 0;
    h_finiq = 0;
    h_fijas = 0;
    h_tc1   = 0;
    h_tc2   = 0;
    h_tc21  = 0;
    h_contr = 0;
    h_prorr = 0;

    &h_comun    = 0;
    &nSwSoloImp = 0;
    &empre_n    = 0;

    seleccio = 0;
    descrip  = "";
    descrip1 = "";
    descrip2 = "";
    conver    = "";
    conver1   = "";
    conver2   = "";

    &empre_p  = 0;
    &empre_f  = 0;
    &mes_p    = 0;
    &anyo_p   = 0;
    &anyo_n   = 0;
    &fecha_p  = @;
    &tipo_p   = 0;
    &rete_p   = "";
    &tarifa   = 0;

    nTipoFactG=0;
|FIN;
____________________________________/ CALCULOS DE PANTALLA
|PROCESO pinta; |TIPO 7;
    fecha = ~;
    varalf = fecha % 402;
    #0#2 = varalf;
    varalf = fecha % 902;
    #0#3 = varalf;
    |PINTA #0#2;
    |PINTA #0#3;
|FPRC;

|PROCESO MiraSiFactFin;
    |SI #0#9 = "S";
        |C_M #0#8, 1, "S";
    |SINO;
        #0#8 = "S"; |PINTA #0#8;
        |C_M #0#8, 1, "N";
    |FINSI;
|FPRC;

|PROCESO FactGlobal;|TIPO 0;
    |SI #0#7="N";
         |CAMPO_MODIFICA #0#5,1,"N";
    |SINO;
         |CAMPO_MODIFICA #0#5,1,"S";
    |FINSI;
|FPRC;

____________________________________/ CALCULOS DE GRABACION DE MINUTAS
|PROCESO linea;
    linea = #7#2;
|FPRC;

|DEFBUCLE leelin;
    #7#1;
    ;
    #0#5, empre_f, 001;
    #0#5, empre_f, 999;
    e;
    NULL, linea;
|FIN;

|PROCESO leeconc;
    nDeDonde = 0;
    |DDEFECTO #2;
    #2#0 = seccion;
    #2#1 = concepto;
    |LEE 000#2=;
    descrip  = #2#2;           || conceptos
    descrip1 = #2#17;          || conceptos 2
    descrip2 = #2#18;          || conceptos 3

    #9#0 = seccion;
    #9#1 = concepto;
    |LEE 000#9=;
    |SI FSalida = 0;
        descrip  = #9#2;       || conceptos variables
        descrip1 = #9#3;       || conceptos variables
        descrip2 = #9#4;       || conceptos variables
        nDeDonde = 1;
    |FINSI;
|FPRC;

|PROCESO GrabaTexto;
     |ABRE #10;

     #10#0 = #7#0;
     #10#1 = #7#1;
     #10#2 = #7#2;
     #10#3 = 1;
     |LEE 101#10=;
     |SI FSalida ! 0;
         |DDEFECTO #10;
         #10#0 = #7#0;
         #10#1 = #7#1;
         #10#2 = #7#2;
         #10#3 = 1;
         #10#4 = #7#7;
         |GRABA 020#10n;
     |FINSI;
     |LIBERA #10;

     #10#0 = #7#0;
     #10#1 = #7#1;
     #10#2 = #7#2;
     #10#3 = 2;
     |LEE 101#10=;
     |SI FSalida ! 0;
         |DDEFECTO #10;
         #10#0 = #7#0;
         #10#1 = #7#1;
         #10#2 = #7#2;
         #10#3 = 2;
         #10#4 = #7#8;
         |GRABA 020#10n;
     |FINSI;
     |LIBERA #10;
     |LIBERA #10;

     #10#0 = #7#0;
     #10#1 = #7#1;
     #10#2 = #7#2;
     #10#3 = 3;
     |LEE 101#10=;
     |SI FSalida ! 0;
         |DDEFECTO #10;
         #10#0 = #7#0;
         #10#1 = #7#1;
         #10#2 = #7#2;
         #10#3 = 3;
         #10#4 = #7#9;
         |GRABA 020#10n;
     |FINSI;
     |LIBERA #10;
     |CIERRA #10;
|FPRC;

|PROCESO RecogeTexto;
     |ABRE #10;
     |ABRE #11;
     |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
           #11#0 = nFichero;
           #11#1 = nCliente;
           #11#2 = aSeccion;
           #11#3 = aConcepto;
           #11#4 = nVariable;
           |LEE 040#11=;
           |SI FSalida = 0;
               #10#0 = #7#0;
               #10#1 = #7#1;
               #10#2 = #7#2;
               #10#3 = nVariable;
               |LEE 101#10=;
               |SI FSalida ! 0;
                   |DDEFECTO #10;
                   #10#0 = #7#0;
                   #10#1 = #7#1;
                   #10#2 = #7#2;
                   #10#3 = nVariable;
                   |GRABA 020#10b;
               |FINSI;
               #10#4 = #11#5;
               |GRABA 020#10a;
               |LIBERA #10;
           |FINSI;
     |SIGUE;

     |CIERRA #10;
     |CIERRA #11;
|FPRC;

|PROCESO grabalin;
    |ABRE #7;
    |SI linea = 0; |HAZ saldo_ant; |FINSI;

    |HAZ leeconc;
    linea = linea + 5;
    #7#0  = #0#5;             || tipo facturacion
    #7#1  = empre_f;             || cliente
    #7#2  = linea;            || linea
    |HAZ conver_fec;
    #7#3  = conver;           || fecha
    #7#4  = seccion;          || seccion
    #7#5  = concepto;         || concepto
    #7#6  = descrip;          || descrip. abreviada
    #7#7  = descrip;          || descrip. 1
    #7#8  = descrip1;         || descrip. 2
    #7#9  = descrip2;         || descrip. 3
    #7#10 = #2#3;             || tipo (hon., sup., etc.)
    #7#11 = canti;            || cantidad
    #7#12 = import;           || importe unidad
    #7#13 = #7#11 * #7#12;    || total linea
    #7#14 = #2#5;             || unitario/global
    #7#15 = #0#4;             || fecha
    |GRABA 020#7n;
    |CIERRA #7;

    nFichero  = 1;
    |SI nDeDonde = 1;  nFichero = 3;  |FINSI;
    nCliente  = 0;
    aSeccion  = #7#4;
    aConcepto = #7#5;
    |HAZ RecogeTexto;
    |HAZ GrabaTexto;
|FPRC;

|PROCESO conver_fec;
    conver1 = #0#4 % 0102;
    conver2 = #0#4 % 0402;
    conver  = conver1 + conver2;
|FPRC;

|PROCESO saldo_ant;
   |ABRE #8;
   |LEE 040#8p;
   |SI FSalida ! 0;  |DDEFECTO #8;  |FINSI;
   |CIERRA #8;

   |SI #8#32 ! "S"; |ACABA; |FINSI;

   |SI #3#24 = 0;   |ACABA; |FINSI;

   #2#0 = #8#33;
   #2#1 = #8#34;
   |LEE 040#2=;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |SI #2#3 ! "A";  |ACABA; |FINSI;

   linea = 5;
   #7#0  = #0#5;
   #7#1  = empre_f;
   #7#2  = linea;
   #7#3  = 0;
   #7#4  = #2#0;
   #7#5  = #2#1;
   #7#6  = #2#2;
   #7#7  = #2#16;
   #7#8  = #2#17;
   #7#9  = #2#18;
   #7#10 = #2#3;
   #7#11 = 1;
   #7#12 = -#3#24;
   #7#13 = -#3#24;
   #7#14 = "G";
   #7#15 = "00.00.0000";
   |GRABA 040#7n;

   nFichero  = 1;
   nCliente  = 0;
   aSeccion  = #7#4;
   aConcepto = #7#5;
   |HAZ RecogeTexto;
|FPRC;

|PROCESO linealin;
   |SI #7#10 = "H"; honorario = honorario + #7#13; |FINSI;
   |SI #7#10 = "S"; suplido   = suplido   + #7#13; |FINSI;
   |SI #7#10 = "A"; acuenta   = acuenta   + #7#13; |FINSI;
|FPRC;

|PROCESO iva;
   |ABRE #8;
   |LEE 000#8p;
   |SI FSalida ! 0; |DDEFECTO #8; |FINSI;
   |CIERRA #8;

   |ABRE #450;
   #450#0 = #6#0;
   |LEE 000#450=;
   |SI FSalida ! 0; |DDEFECTO #450; |FINSI;
   |CIERRA #450;

   iva = #450#3;
|FPRC;

|PROCESO cabecera;
    |DDEFECTO #6;
    |ABRE #6;
    #6#0 = #0#5;         || tipo facturacion
    #6#1 = empre_f;         || cliente
    |LEE 101#6=;
    FEstado = FSalida;

    #6#2  = #3#1;        || razon social
    #6#3  = #3#2;        || nombre
    #6#4  = #3#3;        || direccion
    #6#5  = #3#4;        || cod. postal 1
    #6#6  = #3#5;        || cod. postal 2
    #6#7  = #3#6;        || poblacion
    #6#8  = #3#7;        || provincia
    #6#9  = #3#8;        || cif
    #6#10 = #3#15;       || forma de pago
    #6#11 = #3#16;       || banco
    |SI #0#6 = "S";
        #6#12 = #3#17;
    |SINO;
        #6#12 = "N";
    |FINSI;  || retencion IRPF
    #6#13 = #3#11;       || banco
    #6#14 = #3#12;       || direccion banco
    #6#15 = #3#13;       || CCC
    #6#16 = #3#14;       || cta. cte.

    honorario = 0;
    suplido   = 0;
    acuenta   = 0;

    |BUCLELIN 2linealin#6;             || calcula total lineas

    |SI honorario ! 0;|O suplido ! 0;|O acuenta ! 0;
            #6#17 = honorario;         || honorarios
            #6#18 = suplido;           || suplidos
            #6#19 = acuenta;           || a cuenta
            #6#20 = #3#23;             || descuento
            #6#21 = #6#17 % #6#20;     || total descuento
            #6#22 = #6#17 - #6#21;     || base imponible
        |HAZ iva;
            #6#23 = #6#17 % iva;       || cuota iva
            #6#24 = #6#22 + #6#23 + #6#18;  || total factura
        |SI #6#12 = "S"; #6#25 = #6#22 % #8#31; |SINO; #6#25 = 0; |FINSI; || ret.
            #6#26 = #6#24 - #6#19 - #6#25;  || total a pagar
        |SI FEstado = 0;    |GRABA 020#6a; |FINSI;
        |SI FEstado ! 0;    |GRABA 020#6n; |FINSI;
            sw_cabecera = 1;
    |FINSI;
    |LIBERA #6;
    |CIERRA #6;
|FPRC;

|PROCESO gra_cab;
    sw_cabecera = 0;
    |HAZ cabecera;
    |SI sw_cabecera = 1;
        #1#4 = "S";      || facturado SI
        |GRABA 020#1a;
        seleccio = 1;
    |FINSI;
    |LIBERA #1;
|FPRC;

|PROCESO gra_lin;
    h_finiq = 0;
    h_nomin = 0;
    h_pagas = 0;
    h_fijas = 0;
    h_tc1   = 0;
    h_tc2   = 0;
    h_tc21  = 0;
    h_contr = 0;
    h_prorr = 0;
    h_comun = 0;
    import  = 0;

    |SI #0#8 = "S";
        nTotalNominas = #1#6;
    |SINO;
        nTotalNominas = #1#6 + #1#20;
    |FINSI;

    |SI #5#9 = "S";|Y nTotalNominas ! 0;                     || nominas
        |SI nTotalNominas ] #5#12; |Y  nTotalNominas [ #5#13; import = #5#14; |FINSI;
        |SI nTotalNominas ] #5#16; |Y  nTotalNominas [ #5#17; import = #5#18; |FINSI;
        |SI nTotalNominas ] #5#20; |Y  nTotalNominas [ #5#21; import = #5#22; |FINSI;
        |SI nTotalNominas ] #5#24; |Y  nTotalNominas [ #5#25; import = #5#26; |FINSI;
        |SI nTotalNominas ] #5#28; |Y  nTotalNominas [ #5#29; import = #5#30; |FINSI;
        |SI nTotalNominas ] #5#32; |Y  nTotalNominas [ #5#33; import = #5#34; |FINSI;

        canti = nTotalNominas; h_nomin = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#10;
            concepto = #5#11;
            |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#9 = "S";|Y #1#8 ! 0;                     || pagas
        |SI #1#8 ] #5#12; |Y #1#8 [ #5#13; import = #5#15; |FINSI;
        |SI #1#8 ] #5#16; |Y #1#8 [ #5#17; import = #5#19; |FINSI;
        |SI #1#8 ] #5#20; |Y #1#8 [ #5#21; import = #5#23; |FINSI;
        |SI #1#8 ] #5#24; |Y #1#8 [ #5#25; import = #5#27; |FINSI;
        |SI #1#8 ] #5#28; |Y #1#8 [ #5#29; import = #5#31; |FINSI;
        |SI #1#8 ] #5#32; |Y #1#8 [ #5#33; import = #5#35; |FINSI;

        canti = #1#8; h_pagas = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#10;
            concepto = #5#11;
            |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #0#8 = "S"; |Y #0#9 = "S";
        |SI #5#9 = "S"; |Y  #1#20 ! 0;                     || finiquitos
            |SI #1#20 ] #5#12; |Y #1#20 [ #5#13; import = #5#59; |FINSI;
            |SI #1#20 ] #5#16; |Y #1#20 [ #5#17; import = #5#60; |FINSI;
            |SI #1#20 ] #5#20; |Y #1#20 [ #5#21; import = #5#61; |FINSI;
            |SI #1#20 ] #5#24; |Y #1#20 [ #5#25; import = #5#62; |FINSI;
            |SI #1#20 ] #5#28; |Y #1#20 [ #5#29; import = #5#63; |FINSI;
            |SI #1#20 ] #5#32; |Y #1#20 [ #5#33; import = #5#64; |FINSI;

            canti   = #1#20;
            h_finiq = canti * import;
            |SI #5#2 = "N";
                seccion = #5#10;
                concepto = #5#11;
                |HAZ grabalin;
            |FINSI;
        |FINSI;
    |FINSI;

    |SI #5#5 = "S";                                   || fijas
        canti = 1;
        import = #5#6;
        h_fijas = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#7;
            concepto = #5#8;
            |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#5 = "S";|Y #5#9 = "S";|Y h_nomin = 0;
        h_fijas = 0;
    |FINSI;

    |SI #5#36 = "S";                                   || TC1
        canti = 1;
        import = #5#37;
        h_tc1 = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#38;
            concepto = #5#39;
            |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#40 = "S";  |Y #1#10 ! 0;                  || TC2
        canti = #1#10;
        import = #5#41;
        h_tc2 = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#42;
            concepto = #5#43;
           |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#44 = "S"; |Y #1#12 ! 0;                    || TC2/1
        canti = #1#12;
        import = #5#45;
        h_tc21 = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#46;
            concepto = #5#47;
            |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#48 = "S"; |Y #1#14 ! 0;              || contratos
        canti = #1#14;
        import = #5#49;
        h_contr = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#50;
            concepto = #5#51;
           |HAZ grabalin;
        |FINSI;
    |FINSI;

    |SI #5#52 = "S"; |Y #1#16 ! 0;           || prorrogas
        canti = #1#16;
        import = #5#53;
        h_prorr = canti * import;
        |SI #5#2 = "N";
            seccion  = #5#54;
            concepto = #5#55;
            |HAZ grabalin;
        |FINSI;
   |FINSI;

    |SI #5#65 = "S";                              || Comunicaciones
        nSwSoloImp = 1;
        empre_n    = #1#0;
        mes_p      = #0#2;
        |SI #0#3 > 80;
            anyo_n = 1900 + #0#3;
        |SINO;
            anyo_n = 2000 + #0#3;
        |FINSI;
        tipo_p     = #0#5;
        |SUB_EJECUTA_NP "asnompa2";
        nSwSoloImp = 0;
        |SI h_comun ! 0;
            canti  = 1;
            import = h_comun;
            |SI #5#2 = "N";
                seccion  = #5#67;
                concepto = #5#68;
                |HAZ grabalin;
            |FINSI;
        |FINSI;
   |FINSI;

   |SI #5#2 = "S";                              || globaliza
       seccion = #5#3;
       concepto = #5#4;
       canti = 1;
       import = h_fijas + h_nomin + h_finiq + h_pagas + h_tc1 + h_tc2 + h_tc21 + h_contr + h_prorr + h_comun;
       |HAZ grabalin;
   |FINSI;

   |SI #5#56 = "S";
       seccion = #5#57;
       concepto = #5#58;       || suplidos TC1
       canti = 1;
       import = #1#18;
       |HAZ grabalin;
   |FINSI;
|FPRC;

|PROCESO lee_datos1;
    |SI #1#6 = 0;|Y #1#8  = 0;|Y #1#10 = 0;|Y #1#12 = 0;   || si todo es cero
                 |Y #1#14 = 0; |Y #1#16 = 0;|Y #1#18 = 0;
                 |Y #1#20 = 0;                ||/se lo salta
        |ACABA;
    |FINSI;

    |SI empre_p = 0;
        #4#0 = #1#0;
        |LEE 000#4=;                  || lee codigo de enlace
        |SI FSalida ! 0; |O #4#7 = "N"; |ACABA; |FINSI;
        empre_f = #4#2;
        tarifa  = #4#4;

        |SI #0#7="S";         || tipo facturacion igual para todas las empresas
              #0#5=nTipoFactG;
        |SINO;
              #0#5=#4#6;      || facturacion individual, se guarda en #0#5 porque lo lee simpre de ahi
        |FINSI;
    |FINSI;

    #5#0 = tarifa;
    |LEE 000#5=;              || lee tarifa
    |SI FSalida = 0;
        |DDEFECTO #3;
        #3#0 = empre_f;
        |LEE 000#3=;          || lee el cliente
        linea     = 0;
        |BUCLE leelin;        || ultima linea
        |HAZ gra_lin;         || calcula y graba lineas
        |HAZ gra_cab;         || calcula y graba cabecera
    |FINSI;

    |LIBERA #1;
|FPRC;

|DEFBUCLE lee_datos;
     #1#1;
     4;
     #0#0, #0#2, #0#3, "N";
     #0#1, #0#2, #0#3, "N";
     be;
     NULL, lee_datos1;
|FIN;
____________________________________/ CALCULO PRINCIPAL

|PROCESO tipo3; |TIPO 3;
    |ABRE #2;      || conceptos
    |ABRE #3;      || clientes
    |ABRE #4;      || enlaces
    |ABRE #5;      || tarifas
    |ABRE #9;      || conceptos variables

    nTipoFactG = #0#5;

    |BUCLE lee_datos;
    |SI seleccio = 0;
        |SI empre_p = 0; |MENAV "    Seleccion vacia ..."; |FINSI;
    |FINSI;
    |CIERRA #9;
    |CIERRA #5;
    |CIERRA #4;
    |CIERRA #3;
    |CIERRA #2;
|FPRC;

|PROGRAMA;
    |SI empre_f = 0;
        |ABRE #0;
        |LEE 000#0p;
        |SI FSalida ! 0;
           |DDEFECTO #0;
           |GRABA 020#0c;
        |FINSI;

        |CLS;
        |CABEZA "Pase Minut.Nominas";
        #0#0 = 1;
        #0#1 = 99999;
        |PINPA #0#0;
        |PINDA #0#0;
        |ENDATOS #1#0;
        |SI FSalida = 0;
           |GRABA 020#0a;
           |HAZ tipo3;
        |FINSI;
        |CIERRA #0;
    |SINO;
        #0#0 = empre_p;
        #0#1 = empre_p;
        #0#2 = mes_p;
        #0#3 = anyo_p;
        #0#4 = fecha_p;
        #0#5 = tipo_p;
        #0#6 = rete_p;
        |HAZ tipo3;
    |FINSI;
|FPRO;
