|FICHEROS;
   visaz004 #0;

   visaw004 #10,MANTE;
   visaw005 #11,MANTE;

   asclient #50;
   ashisrec #51;
   asparcia #52;
|FIN;

|VARIABLES;
   aAlfa = "";

   nCalc        = 0;
   nImpMarcados = 0;
   nMarcados    = 0;
   nLinea       = 0;
   nSwSigue     = 0;
|FIN;

|PROCESO RellenaTmp;
   |SI #ashisrec#6 ] 0;
      |SI #ashisrec#6 [ #ashisrec#9; |ACABA; |FINSI;
   |SINO;
      |SI #ashisrec#6 ] #ashisrec#9; |ACABA; |FINSI;
   |FINSI;

   |SI #ashisrec#6 ] 0;
      |DDEFECTO #visaw004;
      #visaw004#0 = #ashisrec#0;
      #visaw004#1 = #ashisrec#1;
      #visaw004#2 = #ashisrec#5;
      #visaw004#3 = #ashisrec#6 - #ashisrec#9;
      #visaw004#4 = #asclient#2;
      #visaw004#5 = #ashisrec#2;
      #visaw004#6 = #ashisrec#6;
      #visaw004#7 = #ashisrec#9;
      |GRABA 020#visaw004.c;
   |SINO;
      |DDEFECTO #visaw005;
      #visaw005#0 = #ashisrec#0;
      #visaw005#1 = #ashisrec#1;
      #visaw005#2 = #ashisrec#5;
      #visaw005#3 = #ashisrec#6 - #ashisrec#9;
      #visaw005#4 = #asclient#2;
      #visaw005#5 = #ashisrec#2;
      #visaw005#6 = #ashisrec#6;
      #visaw005#7 = #ashisrec#9;
      |GRABA 020#visaw005.c;
   |FINSI;
|FPRC;

|DEFBUCLE RellenaTmp;
#ashisrec#3;
;
#visaz004#0, "     ", 000000;
#visaz004#0, "zzzzz", 999999;
;
NULL, RellenaTmp;
|FIN;

|PROCESO Tipo00Fw004C001;
   |ERROR;
|FPRC;

|PROCESO BorraMarcas;
   #visaw005#8  = " "; |PINTA #visaw005#8;
   #visaw005#9  = "";
   #visaw005#10 = 0;
   |GRABA 020#visaw005.a;
|FPRC;

|DEFBUCLE BorraMarcas;
#visaw005#2;
;
"     ", 000000, #visaw004#0, #visaw004#1;
"zzzzz", 999999, #visaw004#0, #visaw004#1;
;
NULL, BorraMarcas;
|FIN;

|PROCESO Tipo11Fw004C001; |TIPO 11;
   |SI FSalida = 10;
      |LEE 000#visaw004.c;
      |SI FSalida = 0;
         |SI #visaw004#8 = " ";
            #visaw004#8 = "*";
            |GRABA 020#visaw004.a; |PINTA #visaw004#8;

            nMarcados = 0;
            |ENTLINEAL #1#visaw005, -2, 4, 18, 1, infw005, supw005;
            #visaw004#9  = nImpMarcados;
            |GRABA 020#visaw004.a;

            |ENTLINEAL #1#visaw005, -2, 7, 18, 1, infw005, supw005;
            aAlfa = "    " + &191 + " Conforme con los datos editados ?";
            |CONFI aAlfa;
            |SI FSalida = 0; |HAZ Salda; |FINSI;
            nSwSigue = 1; |PTEC 807;
         |FINSI;
      |SINO;
         |ERROR;
      |FINSI;
   |FINSI;
   |SI FSalida = 11;
      aAlfa = "    N" + &191 + " Esta seguro de generar el cobro de este recibo ? ";
      |CONFI aAlfa;
      |SI FSalida = 0;
         nLinea = 1;
         #asparcia#0 = #visaw004#0;
         #asparcia#1 = #visaw004#1;
         #asparcia#2 = 0;
         |LEE 000#asparcia.];
         |PARA; |SI FSalida = 0; |Y #asparcia#0 = #visaw004#0; |Y #asparcia#1 = #visaw004#1; |HACIENDO;
            nLinea = #asparcia#2 + 1;
            |LEE 000#asparcia.s;
         |SIGUE;

         |DDEFECTO #asparcia;
         #asparcia#0 = #visaw004#0;
         #asparcia#1 = #visaw004#1;
         #asparcia#2 = nLinea;
         #asparcia#3 = ~;
         #asparcia#4 = #visaw004#2;
         #asparcia#5 = #visaw004#6;
         #asparcia#6 = #visaw004#3;
         #asparcia#8 = #visaw004#3;
         #asparcia#7 = 0;
         #asparcia#9 = #visaz004#0;
         #asparcia#10 = "S";
         #asparcia#11 = #asparcia#3;
         #asparcia#12 = #visaw004#5;
         |GRABA 020#asparcia.n;

         #ashisrec#0 = #visaw004#0;
         #ashisrec#1 = #visaw004#1;
         |LEE 101#ashisrec.=;
         |SI FSalida = 0;
            #ashisrec#9 = #ashisrec#9 + #visaw004#3;
            |SI #ashisrec#6 = #ashisrec#9;
               #ashisrec#10 = "S";
               |BORRA 020#visaw004.a; |PONCONTROL 23, "si";
            |FINSI;
            |GRABA 020#ashisrec.a;
            |LIBERA #ashisrec;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Tipo11Fw005C001; |TIPO 11;
   |SI FSalida = 10;
      |SI #visaw005#8 ! " ";
         |SI #visaw005#8 = "*";
            nCalc = -#visaw005#3;
            nImpMarcados = nImpMarcados - nCalc;
         |SINO;
            nImpMarcados = nImpMarcados - #visaw005#11;
         |FINSI;
         nImpMarcados = nImpMarcados ! 2;
         #visaw005#8  = " ";
         #visaw005#9  = "";
         #visaw005#10 = 0;
         nMarcados    = nMarcados - 1;
      |SINO;
         nCalc = -#visaw005#3;
         nImpMarcados = nImpMarcados + nCalc;
         nImpMarcados = nImpMarcados ! 2;
         |SI nImpMarcados [ #visaw004#3;
            #visaw005#8  = "*";
            #visaw005#9  = #visaw004#0;
            #visaw005#10 = #visaw004#1;
            #visaw005#11 = nCalc;
            nMarcados    = nMarcados + 1;
         |SINO;
            nImpMarcados = nImpMarcados - nCalc;
            nImpMarcados = nImpMarcados ! 2;
            |SI nImpMarcados [ #visaw004#3;
               nMarcados    = nMarcados + 1;
               #visaw005#8  = "P";
               #visaw005#11 = #visaw004#3 - nImpMarcados;
               nImpMarcados = nImpMarcados + #visaw005#11;
               nImpMarcados = nImpMarcados ! 2;
            |SINO;
               |MENAV "    Importe pendiente de abono sobrepasado";
               |ERROR; |ACABA;
            |FINSI;
         |FINSI;
      |FINSI;
      |GRABA 020#visaw005.a;
      |PINTA #visaw005#8;
      |ERROR;
   |FINSI;
|FPRC;

|RUTINA infw004;
   #visaw004#0 = "     ";
   #visaw004#1 = 000000;
|FRUT;

|RUTINA supw004;
   #visaw004#0 = "zzzzz";
   #visaw004#1 = 999999;
|FRUT;

|RUTINA infw005;
   #visaw005#0 = "     ";
   #visaw005#1 = 000000;
|FRUT;

|RUTINA supw005;
   #visaw005#0 = "zzzzz";
   #visaw005#1 = 999999;
|FRUT;

|PROCESO Cobros;
   |SI #visaw005#8 = " "; |ACABA; |FINSI;

   nCalc = 0; nLinea = 1;
   || Primero grabamos el cobro de la factura ....
   #asparcia#0 = #visaw005#0;
   #asparcia#1 = #visaw005#1;
   #asparcia#2 = 0;
   |LEE 000#asparcia.];
   |PARA; |SI FSalida = 0; |Y #asparcia#0 = #visaw005#0; |Y #asparcia#1 = #visaw005#1; |HACIENDO;
      nLinea = #asparcia#2 + 1;
      nCalc = nCalc + #asparcia#8;
      |LEE 000#asparcia.s;
   |SIGUE;

   |DDEFECTO #asparcia;
   #asparcia#0 = #visaw005#0;
   #asparcia#1 = #visaw005#1;
   #asparcia#2 = nLinea;
   #asparcia#3 = ~;
   #asparcia#4 = #visaw005#2;
   #asparcia#5 = #visaw005#6;
   #asparcia#6 = nCalc;
   #asparcia#8 = -#visaw005#11;
   #asparcia#7 = #asparcia#5 - (#asparcia#6 + #asparcia#8);
   #asparcia#9 = #visaz004#0;
   #asparcia#10 = "S";
   #asparcia#11 = #asparcia#3;
   #asparcia#12 = #visaw005#5;
   |GRABA 020#asparcia.n;

   #ashisrec#0 = #visaw005#0;
   #ashisrec#1 = #visaw005#1;
   |LEE 101#ashisrec.=;
   |SI FSalida = 0;
      #ashisrec#9 = #ashisrec#9 - #visaw005#11;
      |SI #ashisrec#6 = #ashisrec#9;
         #ashisrec#10 = "S";
      |FINSI;
      |GRABA 020#ashisrec.a;
      |LIBERA #ashisrec;
   |FINSI;
|FPRC;

|DEFBUCLE Cobros;
#visaw005#1;
;
INICIO;
FINAL;
;
NULL, Cobros;
|FIN;

|PROCESO Salda;
   nCalc = 0; nLinea = 1;
   || Primero grabamos el cobro de la factura ....
   #asparcia#0 = #visaw004#0;
   #asparcia#1 = #visaw004#1;
   #asparcia#2 = 0;
   |LEE 000#asparcia.];
   |PARA; |SI FSalida = 0; |Y #asparcia#0 = #visaw004#0; |Y #asparcia#1 = #visaw004#1; |HACIENDO;
      nLinea = #asparcia#2 + 1;
      nCalc = nCalc + #asparcia#8;
      |LEE 000#asparcia.s;
   |SIGUE;

   |DDEFECTO #asparcia;
   #asparcia#0 = #visaw004#0;
   #asparcia#1 = #visaw004#1;
   #asparcia#2 = nLinea;
   #asparcia#3 = ~;
   #asparcia#4 = #visaw004#2;
   #asparcia#5 = #visaw004#6;
   #asparcia#6 = nCalc;
   #asparcia#8 = #visaw004#9;
   #asparcia#7 = #asparcia#5 - (#asparcia#6 + #asparcia#8);
   #asparcia#9 = #visaz004#0;
   #asparcia#10 = "S";
   #asparcia#11 = #asparcia#3;
   #asparcia#12 = #visaw004#5;
   |GRABA 020#asparcia.n;

   #ashisrec#0 = #visaw004#0;
   #ashisrec#1 = #visaw004#1;
   |LEE 101#ashisrec.=;
   |SI FSalida = 0;
      #ashisrec#9 = #ashisrec#9 + #visaw004#9;
      |SI #ashisrec#6 = #ashisrec#9;
         #ashisrec#10 = "S";
      |FINSI;
      |GRABA 020#ashisrec.a;
      |LIBERA #ashisrec;
   |FINSI;

   || .... y luego se hace un bucle grabando los cobros de las facturas de abono

   |BUCLE Cobros;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA "Asistente de compensacion de cobros";

   |PINPA #0#0; |PINDA #0#0;
   |ENTLINEAL #1#visaw004, -2, 7, 18, 1, infw004, supw004;
   |ENTLINEAL #1#visaw005, -2, 7, 18, 1, infw005, supw005;

   nSwSigue = 1;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |ABRE #asparcia; |ABRE #ashisrec;
      |PARA; |SI nSwSigue = 1; |HACIENDO;
         nMarcados = 0; nImpMarcados = 0;
         nSwSigue = 0;
         aAlfa = "t1" + Usuario; |NOME_DAT #visaw004#aAlfa#;
         aAlfa = "t2" + Usuario; |NOME_DAT #visaw005#aAlfa#;
         |DELINDEX #visaw004; |ABRE #visaw004;
         |DELINDEX #visaw005; |ABRE #visaw005;
         |ABRE #asclient;

         #asclient#0 = #visaz004#0;
         |LEE 000#asclient.=;
         |SI FSalida ! 0; |DDEFECTO #asclient; |FINSI;

         |BUCLE RellenaTmp;
         |CIERRA #asclient;

         |ENTLINEAL #1#visaw005, -2, 7, 18, 1, infw005, supw005;
         |PINTA #visaw005#4; |PINTA #visaw005#5;
         |PINTA #visaw005#6; |PINTA #visaw005#7;
         |ENTLINEAL #1#visaw004, -2, 4, 18, 1, infw004, supw004;
      |SIGUE;
      |CIERRA #asparcia; |CIERRA #ashisrec;
   |FINSI;

   |CIERRA #visaw005; |DELINDEX #visaw005;
   |CIERRA #visaw004; |DELINDEX #visaw004;
|FPRO;
