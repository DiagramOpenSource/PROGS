|FICHEROS;
     abow0020 #920;
     abow0021 #921;
     abom0514 #514;
     abom0515 #515;
     abom0518 #518;
     abom0001 #1;
     abom0014 #14;
     abom0015 #15;
     abom0016 #16;
|FIN;

|VARIABLES;
     aFichero       = "";
     aAlfa          = "";
     aAbre          = "";
     aBase          = "";
     aOrigen        = "";
     aDestino       = "";
     aIPRemoto      = "";
     aDSCorreo      = "";
     aUsu           = "";
     aPwd           = "";
     aProxy         = "";
     aTitulo        = "";
     aDirOri        = "";
     aDirDes        = "";
     aTexto         = "";
     aFic           = "";
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa3         = "";
     aAlfa4         = "";
     aAlfa5         = "";
     aAlfa6         = "";
     aMenLog        = "";
     aDocu          = "";
     aRuta          = "";
     aLong          = "";
     aCaracter      = "";
     aEsDeNuevo     = "";

     nLong          = 0;
     nCaracter      = 0;
     nPosi          = 0;
     nVariable      = 0;
     nLinea         = 0;
     nHandle        = 0;
     nError         = 0;
     nGuarda        = 0;

     fFecha         = @;
     fFechaGuarda   = @;

     &enExped        = 0;
     &enCodUbica     = 0;
     &efFechaDocu    = @;
     &eaRutaDocumento= "";
     &enTotalVaria   = 0;
     &eaNombreList   = "";
     &enCuadroIni    = 0;
     &enCuadroFin    = 0;
     &enCampoAncho   = 0;
     &enModoEdita    = 0;
     &eaFicheroEdita = "";
     &eaFichAdjunto  = "";
     &enCuenta       = 0;
     &eaUnidadBasico = "";

{101}&epPuntEdita   = "";
|FIN;

|PROCESO Tipo7w20;  |TIPO 7;
     |SI enExped = 0;  |ACABA;  |FINSI;

     #1#0 = enExped;
     |LEE 040#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;

     || aTitulo = "Expediente : " + enExped + " " + #1#15; |QBF aTitulo;
     aTitulo = "N/REF: " + enExped;                  |QBF aTitulo;
     || aTitulo = aTitulo + "       N§ AUTOS:" + #1#15; |QBF aTitulo;
     aTitulo = aTitulo + "       S/REF:" + #1#38;    |QBF aTitulo;
     #920#3 = aTitulo;
     |PINTA #920#3;
|FPRC;

|PROCESO Browse;
     |SI FSalida ! 10;  |ACABA;  |FINSI;

     aRuta = #920#4;  |QBF aRuta;
     |SI aRuta = "";
         aRuta = eaUnidadBasico + "\*.*";
     |FINSI;
     aRuta = "F" + aRuta;

     |BROWSE aRuta;

     #920#4 = aRuta % 299;  |PINTA #920#4;
|FPRC;

|PROCESO Libreta;
     |SI #920#0 = 0;
         |C_M #920#2, 1, "S";
     |SINO;
         |C_M #920#2, 1, "N";

         |ABRE #515;
         #515#0 = #920#0;
         |LEE 040#515=;
         |SI FSalida ! 0;
             |MENAV "      No existe la Libreta de Direcciones";
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaTxt;
     aAlfa = #921#1 + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE dsmow021;
     #921#1;
     ;
     0;
     999;
     ;
     NULL, CreaTxt;
|FIN;

|PROCESO PonFecha;
     fFecha = ~;
     aAlfa1 = fFecha % 102;
     aAlfa2 = fFecha % 402;
     aAlfa3 = fFecha % -104;

     |SI aAlfa2 = "01";  aAlfa2 = "Enero";       |FINSI;
     |SI aAlfa2 = "02";  aAlfa2 = "Febrero";     |FINSI;
     |SI aAlfa2 = "03";  aAlfa2 = "Marzo";       |FINSI;
     |SI aAlfa2 = "04";  aAlfa2 = "Abril";       |FINSI;
     |SI aAlfa2 = "05";  aAlfa2 = "Mayo";        |FINSI;
     |SI aAlfa2 = "06";  aAlfa2 = "Junio";       |FINSI;
     |SI aAlfa2 = "07";  aAlfa2 = "Julio";       |FINSI;
     |SI aAlfa2 = "08";  aAlfa2 = "Agosto";      |FINSI;
     |SI aAlfa2 = "09";  aAlfa2 = "Septiembre";  |FINSI;
     |SI aAlfa2 = "10";  aAlfa2 = "Octubre";     |FINSI;
     |SI aAlfa2 = "11";  aAlfa2 = "Noviembre";   |FINSI;
     |SI aAlfa2 = "12";  aAlfa2 = "Diciembre";   |FINSI;

     fFecha = fFecha % 1;
     aAlfa4 = fFecha % 1109;  |QBF aAlfa4;
     |HORA aAlfa5;

     aAlfa  = aAlfa4 + ", " + aAlfa1 + " de " + aAlfa2 + " de " + aAlfa3 + " a las " + aAlfa5;
|FPRC;

|PROCESO TrataAdjunto;
     aAlfa = #920#4;  |QBT aAlfa;
     |SI aAlfa = "";
         aDestino = aBase + "VACIO.TXT";
         |XABRE "BW", aDestino, nHandle;
         aAlfa1 = "Uso interno " + &13 + &10;
         |XGRABA nHandle, aAlfa1;
         |XCIERRA nHandle;
         eaFicheroEdita = "";
     |SINO;
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aFichero = "";

         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPosi     = (100 * nCaracter) + 1;
               aCaracter = aAlfa % nPosi;
               |SI aCaracter = "/";  |O aCaracter = "\";
                   aFichero = "";
               |SINO;
                   aFichero = aFichero + aCaracter;
               |FINSI;
         |SIGUE;

         aOrigen   = #920#4;  |QBF aOrigen;
         aDestino  = aBase + aFichero;

         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |RECIBE_FICHERO aOrigen, aDestino;
         |FINSI;

         fFechaGuarda = efFechaDocu;
         efFechaDocu  = ~;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;

         aOrigen   = aDestino;
         aDestino  = eaRutaDocumento + "/" + aFichero;
         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |ENVIA_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         eaFicheroEdita = aFichero;
         aEsDeNuevo     = "S";
         aDestino       = aOrigen;
     |FINSI;
|FPRC;

|PROCESO Tipo12;  |TIPO 12;
     |HAZ LeeUnidadBasico;

     aEsDeNuevo    = "N";
     enTotalVaria  = 99;
     eaNombreList  = "";
     enCuadroIni   = 1507;
     enCuadroFin   = 2276;
     enCampoAncho  = 70;
     enModoEdita   = 0;

     aFichero = ("a9" + Usuario + "zzzzzzzz") % 108;  |NOME_DAT #921 aFichero;
     |ABRE #921;  |CIERRA #921;  |DELINDEX #921;

     |ABRE #921;

     |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
           IepPuntEdita  = epPuntEdita1 <-;
           IepPuntEdita = IepPuntEdita + (nVariable - 1);

           #921#0 = nVariable;
           |LIBERA #921;
           |LEE 101#921=;
           |SI FSalida ! 0;
               epPuntEdita  = "";
           |SINO;
               epPuntEdita  = #921#1;
               |BORRA 020#921a;
           |FINSI;
     |SIGUE;

     |PUSHV  0501 2380;
     |BLANCO 1504 2278;

     |HAZ Edita;
     |POPV;

     |SI #abom0514#24 ! "P";
        |CONFI "0000SDesea enviar el Correo ";
        |SI FSalida ! 0;
            |CIERRA #921; |DELINDEX #921; |ACABA;
        |FINSI;
     |FINSI;

     |SI #abom0514#24 = "E";
        |SUB_EJECUTA "abom0518;PIDECUENTA";

        |ABRE #518;
        #518#0 = enCuenta;
        |LEE 040#518=;
        |SI FSalida ! 0;
            |MENAV "       No existe la Cuenta de Correo.";
            |ACABA;
        |FINSI;
        |CIERRA #518;

        |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
              IepPuntEdita = epPuntEdita1 <-;
              IepPuntEdita = IepPuntEdita + (nVariable - 1);

              |DDEFECTO #921;
              #921#0 = nVariable;
              |LIBERA #921;
              |LEE 101#921=;
              |SI FSalida ! 0;  |GRABA 020#921b;  |FINSI;
              #921#1 = epPuntEdita;
              |GRABA 020#921a;
        |SIGUE;

        |PARA nVariable = 100;  |SI nVariable ] 1;  |HACIENDO nVariable = nVariable - 1;
              #921#0 = nVariable;
              |LIBERA #921;
              |LEE 101#921=;
              aAlfa = #921#1;  |QBF aAlfa;

              |SI aAlfa ! "";  |SAL;  |FINSI;

              |BORRA 020#921a;
        |SIGUE;
        |CIERRA #921;

        aBase  = "";
        |DBASE aBase;  |QBF aBase;
        aBase  = aBase + "correos/";  |MKDIR aBase;
        nLinea = 1;
        |SI enExped = 0;
            |ABRE #14;
            |LEE 040#14u;
            |SI FSalida = 0;
                nLinea = #14#0 + 1;
            |FINSI;
            |CIERRA #14;
            aDocu = (("00000000" + nLinea) % -108) + ".txt";
            aAbre = aBase + aDocu;
        |SINO;
            nLinea = 1;
            |ABRE #15;
            #15#0 = enExped;
            #15#1 = 9999;
            |LEE 040#15];
            |SI FSalida = 0;
                |LEE 040#15a;
            |SINO;
                |LEE 040#15u;
            |FINSI;
            |SI FSalida = 0;  |Y #15#0 = enExped;
                nLinea = #15#1 + 1;
            |FINSI;
            |CIERRA #15;

            aDocu = (("00000000" + enExped) % -108) + (("0000" + nLinea) % -104) + ".txt";
            aAbre = aBase + aDocu;
        |FINSI;

        |XABRE "BW", aAbre, nHandle;
        |BUCLE dsmow021;
        |XCIERRA nHandle;

        |DELINDEX #921;

        |ABRE #514;
        |LEE 040#514p;
        |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
        |CIERRA #514;

        nGuarda      = enCodUbica;
        fFechaGuarda = efFechaDocu;
        efFechaDocu  = ~;
        enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
        enCodUbica   = nGuarda;
        efFechaDocu  = fFechaGuarda;

        aOrigen   = aAbre;
        aDestino  = eaRutaDocumento + "/" + aDocu;
        |SI #514#21 ! "C";
            aIPRemoto = "";
            |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
            |SI aIPRemoto ! "";
                |ENVIA_FICHERO aOrigen, aDestino;
            |SINO;
                |COPIA_FICHERO aOrigen, aDestino;
            |FINSI;
        |SINO;
            |COPIA_FICHERO aOrigen, aDestino;
        |FINSI;

        |SI eaFichAdjunto ! "";
            aOrigen   = #920#4;  |QBF aOrigen;  || Cuando es un correo de documentos
            aDestino  = aBase + eaFicheroEdita; || o un reenvio.

            |SI #514#21 ! "C";
                aIPRemoto = "";
                |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
                |SI aIPRemoto ! "";
                    |RECIBE_FICHERO aOrigen, aDestino;
                |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
                |FINSI;
            |SINO;
                |COPIA_FICHERO aOrigen, aDestino;
            |FINSI;
        |SINO;
            |HAZ TrataAdjunto;   || Cuando es correo nuevo.
        |FINSI;

        aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
        aUsu      = #518#6;           |QBF aUsu;        || usuario
        aPwd      = #518#7;           |QBF aPwd;        || password
        aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

        aTitulo   = #920#3;            |QBF aTitulo;     || Asunto
        aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
        aDirDes   = #920#2;            |QBF aDirDes;     || Direccion Destino
        aTexto    = "$$$$" + aAbre;
        aFic      = aDestino;

        aAlfa1 = "0000Enviando Correo [" + aDSCorreo + "] ...";
        |MENSA aAlfa1;

        |SI #514#20 = "S"
            aDirOri = "!" + aDirOri;
        |FINSI;

        |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFic;
        nError = FSalida;
        |BLIN 4;

        |SI nError < 0;
             aMenLog = "    Problemas al enviar correo ..." + nError;
             |MENAV aMenLog;
             |CONFI "0000SRevisar detalles?";
             |SI FSalida = 0;
                aAlfa6 = "0000IPDSCorreo: " + aDSCorreo;     |MENAV aAlfa6;
                aAlfa6 = "0000Servidor: " + aProxy;          |MENAV aAlfa6;
                aAlfa6 = "0000Dir.Origen: " + aDirOri;       |MENAV aAlfa6;
                aAlfa6 = "0000Dir.Destin: " + aDirDes;       |MENAV aAlfa6;
                |MENAV "0000Ninguno de estos 4 parametros deberia estar vacio.";
             |FINSI;
             |FBORRA aAbre;
             |FBORRA aDestino;
             |ACABA;
        |FINSI;

        |FBORRA aAbre;
        |FBORRA aDestino;

        |HAZ PonFecha;
        |SI enExped = 0;
            |ABRE #14;
            |DDEFECTO #14;
            #14#0  = nLinea;
            #14#2  = #920#3;
            #14#3  = aAlfa;
            #14#4  = #920#2;
            #14#5  = eaFicheroEdita;
            #14#6   = enCodUbica;
            #14#7  = ~;
            #14#8  = efFechaDocu;
            #14#9  = aEsDeNuevo;
            #14#11 = aDirOri;
            |GRABA 020#14n;
            |CIERRA #14;
        |SINO;
            |ABRE #15;
            |DDEFECTO #15;
            #15#0  = enExped;
            #15#1  = nLinea;
            #15#2  = #920#3;
            #15#3  = aAlfa;
            #15#4  = #920#2;
            #15#5  = eaFicheroEdita;
            #15#6  = enCodUbica;
            #15#7  = ~;
            #15#8  = efFechaDocu;
            #15#9  = aEsDeNuevo;
            #15#11 = aDirOri;
            |GRABA 020#15n;
            |CIERRA #15;
        |FINSI;
     |SINO;
         |SI #abom0514#24 = "P";
            aAlfa = "    N" + &191 + " Enviar a bandeja de pendientes de envio ? ";
            |CONFI aAlfa;
            |SI FSalida ! 0;
               |CIERRA #921;
               |DELINDEX #921;
               |ACABA;
            |FINSI;
         |FINSI;

         |SUB_EJECUTA "abom0518;PIDECUENTA";

         |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
              IepPuntEdita = epPuntEdita1 <-;
              IepPuntEdita = IepPuntEdita + (nVariable - 1);

              |DDEFECTO #921;
              #921#0 = nVariable;
              |LIBERA #921;
              |LEE 101#921=;
              |SI FSalida ! 0;  |GRABA 020#921b;  |FINSI;
              #921#1 = epPuntEdita;
              |GRABA 020#921a;
         |SIGUE;

         |PARA nVariable = 100;  |SI nVariable ] 1;  |HACIENDO nVariable = nVariable - 1;
              #921#0 = nVariable;
              |LIBERA #921;
              |LEE 101#921=;
              aAlfa = #921#1;  |QBF aAlfa;

              |SI aAlfa ! "";  |SAL;  |FINSI;

              |BORRA 020#921a;
         |SIGUE;
         |CIERRA #921;

         aBase  = "";
         |DBASE aBase;  |QBF aBase;
         aBase  = aBase + "correos/";  |MKDIR aBase;
         nLinea = 1;
         |ABRE #16;
         #16#0 = enExped;
         #16#1 = 9999;
         |LEE 040#16];
         |SI FSalida = 0;
             |LEE 040#16a;
         |SINO;
             |LEE 040#16u;
         |FINSI;
         |SI FSalida = 0;  |Y #16#0 = enExped;
            nLinea = #16#1 + 1;
         |FINSI;
         |CIERRA #16;

         aDocu = (("00000000" + enExped) % -108) + (("0000" + nLinea) % -104) + ".txt";
         aAbre = aBase + aDocu;

         |XABRE "BW", aAbre, nHandle;
         |BUCLE dsmow021;
         |XCIERRA nHandle;

         |DELINDEX #921;

         |ABRE #514;
         |LEE 040#514p;
         |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
         |CIERRA #514;

         nGuarda      = enCodUbica;
         fFechaGuarda = efFechaDocu;
         efFechaDocu  = ~;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
         enCodUbica   = nGuarda;
         efFechaDocu  = fFechaGuarda;

         aOrigen   = aAbre;
         aDestino  = eaRutaDocumento + "/" + aDocu;
         |SI #514#21 ! "C";
            aIPRemoto = "";
            |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
            |SI aIPRemoto ! "";
                |ENVIA_FICHERO aOrigen, aDestino;
            |SINO;
                |COPIA_FICHERO aOrigen, aDestino;
            |FINSI;
         |SINO;
            |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         |SI eaFichAdjunto ! "";
            aOrigen   = #920#4;  |QBF aOrigen;  || Cuando es un correo de documentos
            aDestino  = aBase + eaFicheroEdita; || o un reenvio.

            |SI #514#21 ! "C";
                aIPRemoto = "";
                |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
                |SI aIPRemoto ! "";
                    |RECIBE_FICHERO aOrigen, aDestino;
                |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
                |FINSI;
            |SINO;
                |COPIA_FICHERO aOrigen, aDestino;
            |FINSI;
         |SINO;
            |HAZ TrataAdjunto;   || Cuando es correo nuevo.
         |FINSI;

         aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
         aUsu      = #518#6;           |QBF aUsu;        || usuario
         aPwd      = #518#7;           |QBF aPwd;        || password
         aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

         aTitulo   = #920#3;            |QBF aTitulo;     || Asunto
         aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
         aDirDes   = #920#2;            |QBF aDirDes;     || Direccion Destino
         aTexto    = "$$$$" + aAbre;
         aFic      = aDestino;


         |HAZ PonFecha;

         |ABRE #16;
         |DDEFECTO #16;
         #16#0  = enExped;
         #16#1  = nLinea;
         #16#2  = #920#3;
         #16#3  = aAlfa;
         #16#4  = #920#2;
         #16#5  = #920#4;
         #16#6  = enCodUbica;
         #16#7  = ~;
         #16#8  = efFechaDocu;
         #16#9 = aEsDeNuevo;
         #16#12 = enCuenta;
         |GRABA 020#16n;
         |CIERRA #16;
     |FINSI;
|FPRC;
