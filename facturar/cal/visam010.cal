|FICHEROS;
    visam010 #0;
    visam001 #1;
    visam002 #2;
    ascabmin #3;
    aslinmin #4;

    asclient #6;
    ascontro #7;
    ascontrt #450;

    asconcep #8;
    asenlcon #9;
    asempcon #10;
    asw00001 #99;

    ashismic;
|FIN;

|VARIABLES;
/*
     &enSwCliVarios = 0;
     &enCodCliVarios = 0;
*/

     &enModVisados = 0;
     &enModDtos    = 0;

     &enNumFac = 0;
     &eaSerFac = "";

     aParametro = "";
     aPrograma = "";

     &enDesdeCli = 0;
     &enHastaCli = 0;
     &enDesdeExp = 0;
     &enHastaExp = 0;
     &efDesdeFec = @;
     &efHastaFec = @;
     &enDesdeAny = 0;
     &enHastaAny = 0;
     &efFechaFac = @;
     &enTipoFac = 0;

    c_clie    = "";
    fijo      = "";
    sw        = 0;
    x         = 0;
    y         = 0;
    linea     = 0;
    sw_cab    = 0;
    FEstado   = 0;
    iva       = 0;
    juan      = 0;
    refer     = 0;
    conver    = "";
    conver1   = "";
    conver2   = "";
     fFech = @;
     qFech = "";
     dFech = "";
     hFech = "";
|FIN;

|INCLUYE agicon_i;
|INCLUYE i_ficher;

|PROCESO linea_aut;
     |HAZ grabamin;
     #2#15 = "S";
     |GRABA 140#2a;
     |LIBERA #2;
|FPRC;

|PROCESO lineas;
     |SI #0#6 = "A";
         #1#0  = #2#0;
         #1#14 = #2#16;
/*
         |LIBERA #1;
         |LEE 140#1=;
         |SI FSalida ! 0; |ACABA; |FINSI;
         |HAZ linea_aut;
         |GRABA 140#1a;
*/
         |LEE 000#1=;
         |SI FSalida ! 0; |ACABA; |FINSI;
         |HAZ linea_aut;
     |FINSI;
|FPRC;

|DEFBUCLE visam002;
     #2#1;
     1, 17, 15;
     #0#0, #0#7, 000, #0#2, #0#4, "N";
     #0#1, #0#8, 999, #0#3, #0#5, "N";
     be;
     NULL, lineas;
|FIN;

|PROCESO miralin;
    linea = #4#2;
|FPRC;

|PROCESO grabamin;
/*
     |ABRE #6;
     |SI enSwCliVarios = 0;
          #6#0 = #1#1;
     |SINO;
          #6#0 = enCodCliVarios;
     |FINSI;
     |LEE 040#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
     |CIERRA #6;
*/

     |ABRE #6;
     #6#0 = #1#1;
     |LEE 040#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
     |CIERRA #6;

     |ABRE #3;
     sw_cab = 0;
     #3#0 = #1#5;
     #3#1 = #1#1;
     |LIBERA #3;
     |LEE 110#3=;
     |SI FSalida ! 0;
         linea = 1;
         |DDEFECTO #3;
         #3#0 = #1#5;
         #3#1 = #1#1;
         #3#2 = #6#1;
         #3#3 = #6#2;
         #3#4 = #6#3;
         #3#5 = #6#4;
         #3#6 = #6#5;
         #3#7 = #6#6;
         #3#8 = #6#7;
         #3#9 = #6#8;
         #3#10 = #6#15;
         #3#11 = #6#16;
         #3#12 = #6#17;
         #3#13 = #6#11;
         #3#14 = #6#12;
         #3#15 = #6#13;
         #3#16 = #6#14;
         |SI enModDtos = 0;
            #3#20 = #6#23;
         |SINO;
            #3#20 = 0;
         |FINSI;
         linea = 5;
         |GRABA 020#3b;
         linea = linea + 5;
     |SINO;
         |BUCLELIN 0miralin#3;
         linea = linea + 5;
     |FINSI;
     |ABRE #4;
     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = linea;
     |PARA juan = 3; |SI juan [ 14; |HACIENDO juan = juan + 1;
         #4juan = #2juan;
     |SIGUE;
     #4#15 = #2#17;

     |SI sw_cab = 0;
        |SI #2#10 = "H"; #3#17 = #3#17 + #2#13; #1#9  = #1#9  - #2#13; |FINSI;
        |SI #2#10 = "S"; #3#18 = #3#18 + #2#13; #1#10 = #1#10 - #2#13; |FINSI;
        |SI #2#10 = "A"; #3#19 = #3#19 + #2#13; #1#11 = #1#11 - #2#13; |FINSI;
     |FINSI;

     |HAZ iva;

     #3#21 = #3#17 % #3#20;
     #3#22 = #3#17 - #3#21;
     #3#23 = #3#22 % iva;
     #3#24 = #3#22 + #3#23 + #3#18;
     |SI #3#12 = "S";
         #3#25 = #3#22 % #7#31;
     |SINO;
         #3#25 = 0;
     |FINSI;
     #3#26 = #3#24 - #3#19 - #3#25;
     #3#27 = #0#12;
     #3#28 = #0#13;
     #3#29 = #0#9;

     |GRABA 020#3a;
     |LIBERA #3;

     |GRABA 020#4n;
     |LIBERA #4;

     |CIERRA #3;
     |CIERRA #4;
     |HAZ graba_con;
|FPRC;

|PROCESO iva;
     |ABRE #7;
     |LEE 040#7p;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;
     |CIERRA #7;

     |ABRE #450;
     #450#0 = #3#0;
     |LEE 000#450=;
     |SI FSalida ! 0; |DDEFECTO #450; |FINSI;
     |CIERRA #450;

     iva = #450#3;
|FPRC;

|PROCESO graba_con;
     |ABRE #9;
     #9#0 = #4#4;
     #9#1 = #4#5;
     |LEE 040#9=;
     |SI FSalida ! 0; |CIERRA #9; |ACABA; |FINSI;
     |CIERRA #9;

     |ABRE #10;
     |LEE 040#10p;
     |SI FSalida ! 0; |DDEFECTO #10; |FINSI;
     |CIERRA #10;

     c_clie    = #4#1;
     c_clie    = ("00000" + c_clie) % -105;
     fijo    = #10#3; |QBF fijo;
     fijo    = fijo + c_clie;
     conver1 = #4#15 % 0102;
     conver2 = #4#15 % 0402;
     conver  = conver1 + conver2;
     c_fecha = conver;
     c_fecha = ("0000" + c_fecha) % -104;

     |ABRE #99;
     #99#0 = #4#0;
     #99#1 = #4#1;
     #99#2 = #4#2;
     |LIBERA #99;
     |LEE 140#99=;
     |SI FSalida = 0;
        #99#3  = #10#1;
        #99#4  = #10#2;
        #99#5  = c_fecha;
        #99#6  = fijo;
        #99#7  = #9#2;
        #99#8  = #9#6;
        #99#9  = #9#3;
        #99#10 = #9#4;
        #99#11 = #4#13;
        #99#12 = #9#5;
        #99#13 = 0;
        #99#14 = "";
        |GRABA 140#99a;
     |SINO;
        |DDEFECTO #99;
        #99#0  = #4#0;
        #99#1  = #4#1;
        #99#2  = #4#2;
        #99#3  = #10#1;
        #99#4  = #10#2;
        #99#5  = c_fecha;
        #99#6  = fijo;
        #99#7  = #9#2;
        #99#8  = #9#6;
        #99#9  = #9#3;
        #99#10 = #9#4;
        #99#11 = #4#13;
        #99#12 = #9#5;
        #99#13 = 0;
        #99#14 = "";
        |GRABA 140#99n;
     |FINSI;
     |CIERRA #99;
|FPRC;


|PROCESO sacaano; |TIPO 7;
     fFech = ~;
     qFech = fFech % -104;
     dFech = "01.01." + qFech;
     hFech = "31.12." + qFech;
     #0#4  = dFech;
     #0#5  = hFech;
     |PINTA #0#4;
     |PINTA #0#5;
|FPRC;

|PROCESO DameNumeroFactura;
     |ABRE #ashismic;
     |DDEFECTO #ashismic;
     #ashismic#0 = #0#12;
     #ashismic#1 = 99999;
     |LEE 000#ashismic.];
     |SI FSalida = 0;
          |LEE 000#ashismic.a;
     |SINO;
          |LEE 000#ashismic.u;
     |FINSI;
     |SI FSalida = 0; |Y #ashismic#0 = #0#12;
          #0#13 = #ashismic#1 + 1;
     |SINO;
          #0#13 = 1;
     |FINSI;

     |DDEFECTO #ashismic;
     #ashismic#0 = #0#12;
     #ashismic#1 = #0#13;
     |LEE 101#ashismic.=;
     |SI FSalida ! 0;
          |GRABA 020#ashismic.n;
     |FINSI;
     |LIBERA #ashismic;
     |CIERRA #ashismic;
|FPRC;

|PROGRAMA;
     |ABRE #7;
     |LEE 040#7p;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;
     |CIERRA #7;

     |CLS;

     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro = "AUTO";
          |ABRE #0;
          |DDEFECTO #0;

          #0#0  = enDesdeAny;
          #0#1  = enHastaAny;
          #0#2  = enDesdeCli;
          #0#3  = enHastaCli;
          #0#4  = efDesdeFec;
          #0#5  = efHastaFec;
          #0#7  = enDesdeExp;
          #0#8  = enHastaExp;
          #0#9  = efFechaFac;
          #0#10 = enTipoFac;
          #0#12 = eaSerFac;

          |HAZ DameNumeroFactura;

          enNumFac = #0#13;

          refer = 0;
          |ABRE #1;
          |BUCLE visam002;

          enTipoFac    = #0#10;
          enModVisados = 1;
          aPrograma    = "asactual;AUTO";
          |SUB_EJECUTA_NP aPrograma;
          enModVisados = 0;

          |CIERRA #1;
          |CIERRA #0;
     |FINSI;
|FPRO;
