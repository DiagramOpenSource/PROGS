|FICHEROS;
     abxy0001 #901;

     abom0001 #1;
     abom0002 #2;
     abom0006 #6;
     abom0505 #505;
     abom0514 #514;
     abom0511 #511;
     abxw0019 #919;
     abxw0020 #920;
     abxw0021 #921;
|FIN;

|VARIABLES;
     aAbre          = "";
     aBase          = "";
     aAlfa          = "";
     aAlfa1         = "";
     aEsc1          = "";
     aEsc2          = "";
     aRetu          = "";
     aTecla         = "";
     aFichero       = "";
     aCarga         = "";
     aQueQuiero     = "";
     aTexto         = "";
     aLong          = "";
     aCarac         = "";
     aRefresca      = "";
     aBusca         = "";
     aAdministrador = "";
     aLaborable     = "";
     aIPRemoto      = "";
     aOrigen        = "";
     aDestino       = "";
     aInforme       = "";
     aBaseRemoto    = "";
     aBaseDS        = "";
     aFic           = "";
     aMes           = "";
     aAnyo          = "";
     aFicheroActu   = "";
     aCarac10       = "";
     aCarac13       = "";

     nBotonLabel    = 0;
     nHandle        = 0;
     nTree          = -1;
     nPanta         = 0;
     nLong          = 0;
     nCargar        = 0;
     nPos           = 0;
     nPosi          = 0;
     nBoton1        = 0;
     nBoton2        = 0;
     nBoton3        = 0;
     nSubVent       = 0;
     nCampo         = 0;
     nTCampo        = 0;
     nCarpeta       = 0;
     FEstado        = 0;
     nPersona       = 0;
     nConta1        = 0;
     nConta2        = 0;
     nConta3        = 0;
     nAnyo          = 0;
     nMes           = 0;
     nLinea         = 0;
     nDia           = 0;
     nDiaDesde      = 0;
     nDiaHasta      = 0;
     nAnyoDest      = 0;
     nMesDest       = 0;
     nDesdeMes      = 0;
     nHastaMes      = 0;
     nContMes       = 0;
     nCont          = 0;
     nCalc          = 0;
     nDias          = 0;
     nSegundo       = 0;

     fFecha         = @;
     fFecha1        = @;

     {2}aContiene  = "";

     {-1}sTree      = 0;
     sT_nID         = 0;
     sT_nOper       = 0;
     sT_aData       = "";

     {-1}aVent      = "";
         aVent1     = 0;
         aVent2     = 0;
         aVent3     = 0;
         aVent4     = 0;
         aVent5     = "";

     &eaRutaOrigen    = "";
     &eaRutaDestino   = "";
     &eaFicheroTxt    = "";
     &eaFicheroTgz    = "";
     &eaFicheroTar    = "";
     &eaAlfa          = "";
     &eaFicheroEdita  = "";
     &efFechaDocu     = @;
     &enCodUbica      = 0;
     &enLineas        = 0;
     &aCadena         = "";
     &eaRutaDocumento = "";
     &XVAR_DC_IMPRIME = 0;
     &eaUnidadBasico = "";
|FIN;

|PROCESO Envia;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO Imprime;

     aInforme = "abxy0001.rpt";

     XVAR_DC_IMPRIME = 0;

     |DBASE aBase;   |QBF aOrigen;
     aOrigen     = aBase + "def/" + aInforme;
     aDestino    = aBaseRemoto + aInforme;
     |HAZ Envia;

     aOrigen     = #514#28;  |QBF aOrigen;

     |SI aOrigen = "";
        aOrigen = "/u/dsprofes/facturar/plantillas/insertar.bmp";
     |FINSI;

     aDestino    = aBaseDS + "logo.bmp";
     |HAZ Envia;

     aDestino    = aBaseRemoto + "logo.bmp";
     |HAZ Envia;

     |DFICE aFic; |QBF aFic;
     aOrigen  = aFic + "c2" + Usuario + ".dbf";
     aDestino = aBaseRemoto + "cabecera.dbf";
     |HAZ Envia;

     aOrigen  = aFic + "c3" + Usuario + ".dbf";
     aDestino = aBaseRemoto + "detalle.dbf";
     |HAZ Envia;

     aOrigen  = aFic + "c4" + Usuario + ".dbf";
     aDestino = aBaseRemoto + "detalle1.dbf";
     |HAZ Envia;

     aDestino = aBaseRemoto + aInforme;
     |INFOR aDestino; |PULSATECLA;

     aAlfa    = "attrib -r " + aBaseRemoto + "*";        |RSYSTEM aAlfa;
     aDestino = aBaseRemoto + "cabecera.dbf";     |RFBORRA aDestino;
     aDestino = aBaseRemoto + "detalle.dbf";      |RFBORRA aDestino;
     aDestino = aBaseRemoto + "detalle1.dbf";     |RFBORRA aDestino;
     aDestino = aBaseRemoto + "detalle2.dbf";     |RFBORRA aDestino;
     aDestino = aBaseRemoto + aInforme;      |RFBORRA aDestino;

     aAlfa = aBaseDS + "*.doc";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;
|FPRC;

|PROCESO abom0006;
     |SI #901#6 ! "T";
         #1#0 = #6#0;
         |LEE 000#1=;
         |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;

         |SI #901#6 = "A";
             |SI #1#2 ! "01.01.0000";  |ACABA;  |FINSI;
         |FINSI;

         |SI #901#6 = "C";
             |SI #1#2 = "01.01.0000";  |ACABA;  |FINSI;
         |FINSI;
     |FINSI;

     |SI #901#2 = "M";
         #505#0 = #6#8;
         |LEE 000#505=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         aAlfa = Usuario % 810;
         aAlfa = (aAlfa + "          ") % 110;

         #511#0 = #505#0;
         #511#1 = aAlfa;
         |LEE 000#511=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #901#2 = "P";  |Y #6#8 ! #901#3;
         |ACABA;
     |FINSI;

     fFecha  = #6#5;
     aAlfa   = fFecha % -104;  nAnyo  = aAlfa;
     aAlfa   = fFecha %  402;  nMes   = aAlfa;
     |PARA nSegundo = 0;  |SI nSegundo [ 59;  |HACIENDO nSegundo = nSegundo + 1;
           #920#0  = fFecha;
           #920#1  = (nAnyo * 100) + nMes;
           #920#2  = (("00" + #6#6) % -102) + ":" + (("00" + #6#7) % -102) + ":" + (("00" + nSegundo) % -102);
           #920#3  = #6#8;
           |LEE 000#920=;
           |SI FSalida ! 0;  |SAL;  |FINSI;
     |SIGUE;

     |DDEFECTO #920;
     #920#0  = fFecha;
     #920#1  = (nAnyo * 100) + nMes;
     #920#2  = (("00" + #6#6) % -102) + ":" + (("00" + #6#7) % -102) + ":" + (("00" + nSegundo) % -102);
     #920#3  = #6#8;
     #920#4  = #6#9;
     #920#5  = #6#0;
     #920#6  = #6#1;
     #920#7  = (("00" + #6#2) % -102) + ":" + (("00" + #6#3) % -102) + ":" + (("00" + #6#18) % -102);
     #920#8  = #6#19;
     #920#9  = #6#10;
     #920#10 = #6#11;
     #920#11 = #6#12;
     #920#12 = #6#13;
     #920#13 = #6#14;
     #920#14 = #6#15;
     |GRABA 020#920n;
     |LIBERA #920;

     #921#0  = #920#0;
     #921#1  = #920#1;
     #921#2  = 99999;
     |LEE 000#921];
     |SI FSalida = 0;
         |LEE 000#921a;
     |SINO;
         |LEE 000#921u;
     |FINSI;

     nLinea = 1;
     |SI FSalida = 0;  |Y  #921#0  = #920#0;  |Y  #921#1  = #920#1;
         nLinea = #921#2 + 1;
     |FINSI;

     |DDEFECTO #921;
     #921#0  = #920#0;
     #921#1  = #920#1;
     #921#2  = nLinea;
     #921#3  = #6#9;
     #921#4  = #6#8;
     aAlfa   = ("00" + #920#3) % -102;
     #921#5  = aAlfa + ": " + #6#10;
     |GRABA 020#921n;
     |LIBERA #921;

     |SI #901#5  ! "S";  |ACABA;  |FINSI;
     |SI #6#0    = 0;    |ACABA;  |FINSI;

     #2#0 = #6#0;
     #2#1 = 1;
     |LEE 000#2=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |QBF aFicheroActu;
     efFechaDocu    = #2#4;
     enCodUbica     = #2#10;  |HAZ LeeUbicaciones;
     eaFicheroEdita = #2#3;   |QBF eaFicheroEdita;

     aOrigen  = eaRutaDocumento + "/" + eaFicheroEdita;       |QBF aOrigen;
     aDestino = aBaseDS + "w" + (("00000000" + #2#0) % -108) + ".doc";

     |XABRE "EC", aDestino, nHandle;
     |SI FSalida ] 0;   |ACABA;   |FINSI;

     |SI #514#21 ! "C";
         |XABRE "EC", aOrigen, nHandle;
     |SINO;
         |XABRE "E", aOrigen, nHandle;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     |SI #514#21 = "C";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |RCOPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|DEFBUCLE abom0006;
     #6#7;
     ;
     #901#0, 00, 00,       0;
     #901#1, 99, 99, 99999999;
     ;
     NULL, abom0006;
|FIN;

|PROCESO PreparaFicheros;
     aAlfa = "c2" + Usuario; |NOME_DAT #919 aAlfa;
     aAlfa = "c3" + Usuario; |NOME_DAT #920 aAlfa;
     aAlfa = "c4" + Usuario; |NOME_DAT #921 aAlfa;

     |ABRE #919;  |CIERRA #919;  |DELINDEX #919;  |ABRE #919;
     |ABRE #920;  |CIERRA #920;  |DELINDEX #920;  |ABRE #920;
     |ABRE #921;  |CIERRA #921;  |DELINDEX #921;  |ABRE #921;

     fFecha    = #901#0;
     aAlfa     = fFecha;
     aAlfa1    = fFecha % 0402;
     nMes      = aAlfa1;
     aMes      = ("00" + nMes) % -102;

     aAlfa1    = fFecha % 0704;
     nAnyo     = aAlfa1;
     aAnyo     = nAnyo;

     aAlfa     = #901#1 % 0704;
     nAnyoDest = aAlfa;
     aAlfa     = #901#1 % 0402;
     nMesDest  = aAlfa;

     nDesdeMes = nMes;
     |PARA; |SI nAnyo [ nAnyoDest; |HACIENDO nAnyo = nAnyo + 1;
          |SI nAnyo = nAnyoDest;
              nHastaMes = nMesDest;
          |SINO;
              nHastaMes = 12;
          |FINSI;

          |PARA nContMes = nDesdeMes; |SI nContMes [ nHastaMes; |HACIENDO nContMes = nContMes + 1;
                aAlfa  = (("00" + nContMes) % -102);
                aAlfa  = "01." + aAlfa + "." + nAnyo;
                fFecha = aAlfa;
                fFecha = fFecha % 1;
                aAlfa  = (fFecha % 1109) > "";
                |QBF aAlfa;

                |SI aAlfa = "LUNES";     nDia = 0; |FINSI;
                |SI aAlfa = "MARTES";    nDia = 1; |FINSI;
                |SI aAlfa = "MIERCOLES"; nDia = 2; |FINSI;
                |SI aAlfa = "JUEVES";    nDia = 3; |FINSI;
                |SI aAlfa = "VIERNES";   nDia = 4; |FINSI;
                |SI aAlfa = "SABADO";    nDia = 5; |FINSI;
                |SI aAlfa = "DOMINGO";   nDia = 6; |FINSI;

                aAlfa  = (("00" + nContMes) % -102);
                aAlfa  = "01." + aAlfa + "." + nAnyo;
                fFecha = aAlfa;

                |PARA nCont = nDia; |SI nCont > 0; |HACIENDO nCont = nCont - 1;
                      nCalc   = fFecha;
                      nCalc   = nCalc - nCont;
                      fFecha1 = nCalc;
                      aAnyo   = nAnyo;     |QBF aAnyo;
                      aMes    = (("00" + nContMes) % -102);
                      aAlfa   = aAnyo + aMes;

                      #919#0  = fFecha1;
                      #919#1  = aAlfa;
                      |LEE 000#919=;
                      |SI FSalida ! 0;
                          |DDEFECTO #919;
                          #919#0  = fFecha1;
                          #919#1  = aAlfa;
                          |SI nDia ! 6;
                              #919#2 = "S";
                          |SINO;
                              #919#2 = "N";
                          |FINSI;
                          |GRABA 020#919n;
                          |LIBERA #919;
                     |FINSI;
                |SIGUE;

                |SI nContMes = 01; |O nContMes = 03; |O nContMes = 05;
                 |O nContMes = 07; |O nContMes = 08; |O nContMes = 10;
                 |O nContMes = 12;
                    nDias = 31;
                |SINO;
                    |SI nContMes = 2;
                        aAlfa   = "28.02." + aAnyo;
                        fFecha1 = aAlfa;
                        nCalc   = fFecha1;
                        nCalc   = nCalc + 1;
                        fFecha1 = nCalc;
                        aAlfa   = fFecha1; |QBF aAlfa;
                        aAlfa   = aAlfa % 0102;
                        |SI aAlfa = "01";
                            nDias = 28;
                        |SINO;
                            nDias = 29;
                        |FINSI;
                    |SINO;
                        nDias = 30;
                    |FINSI;
                |FINSI;

                |PARA nCont = 1; |SI nCont [ nDias; |HACIENDO nCont = nCont + 1;
                      aAlfa   = (("00" + nContMes) % -102);
                      aAlfa   = (("00" + nCont) % -102) + "." + aAlfa + "." + nAnyo;
                      fFecha1 = aAlfa;

                      fFecha  = aAlfa;
                      fFecha = aAlfa;
                      fFecha = fFecha % 1;
                      aAlfa  = (fFecha % 1109) > "";
                      |QBF aAlfa;

                      |SI aAlfa = "LUNES";     nDia = 0; |FINSI;
                      |SI aAlfa = "MARTES";    nDia = 1; |FINSI;
                      |SI aAlfa = "MIERCOLES"; nDia = 2; |FINSI;
                      |SI aAlfa = "JUEVES";    nDia = 3; |FINSI;
                      |SI aAlfa = "VIERNES";   nDia = 4; |FINSI;
                      |SI aAlfa = "SABADO";    nDia = 5; |FINSI;
                      |SI aAlfa = "DOMINGO";   nDia = 6; |FINSI;

                      aAlfa   = (("00" + nContMes) % -102);
                      aAlfa   = (("00" + nCont) % -102) + "." + aAlfa + "." + nAnyo;
                      fFecha1 = aAlfa;
                      aAnyo   = nAnyo; |QBF aAnyo;
                      aMes    = (("00" + nContMes) % -102);
                      aAlfa   = aAnyo + aMes;
                      #919#0  = fFecha1;
                      #919#1  = aAlfa;
                      |LEE 000#919=;
                      |SI FSalida ! 0;
                          |DDEFECTO #919;
                          #919#0 = fFecha1;
                          #919#1 = aAlfa;
                          |SI nDia ! 6;
                              #919#2 = "S";
                          |SINO;
                              #919#2 = "N";
                          |FINSI;
                          |GRABA 020#919n;
                          |LIBERA #919;
                      |FINSI;
                |SIGUE;
          |SIGUE;
          nDesdeMes = 1;
     |SIGUE;

     |ABRE #505;
     |ABRE #511;
     |ABRE #2;
     |ABRE #1;
     |BUCLE abom0006;
     |CIERRA #505;
     |CIERRA #511;
     |CIERRA #2;
     |CIERRA #1;

     |CIERRA #919;
     |CIERRA #920;
     |CIERRA #921;
|FPRC;

|PROCESO Tipo12Fxy1;  |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     |HAZ LeeUnidadBasico;

     aAlfa       = eaUnidadBasico + "\DS";            |RMKDIR aAlfa;
     aAlfa       = aAlfa + "\crystal"; |RMKDIR aAlfa;
     aBaseDS     = eaUnidadBasico + "\DS\crystal\";

     |ESPECIFICA "RBASS", aContiene;
     aBaseRemoto = aContiene + "crystal";    |RMKDIR aBaseRemoto;
     aBaseRemoto = aContiene + "crystal\";

     |VENTANA 0501, 2799, -1, 17, "Control de entradas de correos a expedientes";
     nSubVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |CONTROL_SIMPLE nSubVent, "LABEL,{{5}}Editando documento", 1320, 1498, NULL;
     |CONTROL_SIMPLE nSubVent, "LABEL,{{2}}Espere por favor ...", 1640, 1698, NULL;

     |PTEC 802;
     |PAUSA;

     |HAZ PreparaFicheros;
     |HAZ Imprime;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVent;

     |DELINDEX #919;
     |DELINDEX #920;
     |DELINDEX #921;
|FPRC;

|PROCESO Tipo0C2Fxy1;  |TIPO 0;
     |C_M #901#3, 1, "S";
     |SI #901#2 ! "P";
         |C_M #901#3, 1, "N";
         #901#3 = 0;
         #901#4 = "";
     |FINSI;

     |PINTA #901#3;
     |PINTA #901#4;
|FPRC;

|PROCESO Tipo0C3Fxy1;  |TIPO 0;
     |SI #901#2 ! "P";   |ACABA;  |FINSI;

     |ABRE #505;
     #505#0 = #901#3;
     |LEE 040#505=;
     |SI FSalida ! 0;
         |MENAV "0000 No existe la persona del despacho";
         |ERROR;
     |FINSI;
     |CIERRA #505;
|FPRC;

|PROCESO Tipo7C0Fxy1;  |TIPO 7;
     |SI #514#27 ! "S";
         |C_V #901#5, 1, "N";
         |PINTA 1926, "                              ";

         #901#5 = "N";
     |FINSI;

     aAdministrador = "N";
     aAlfa          = Usuario % 810;
     aAlfa          = (aAlfa + "          ") % 110;

     |ABRE #505;
     |ABRE #511;
     |SELECT #2#511;
     |PARA nCampo = 1;  |SI nCampo [ 99;  |HACIENDO nCampo = nCampo + 1;
           #511#1 = aAlfa;
           #511#0 = nCampo;
           |LEE 000#511=;
           |SI FSalida = 0;
               #505#0 = #511#0;
               |LEE 040#505=;
               |SI FSalida ! 0;  |DDEFECTO #505;  |FINSI;

               |SI #505#22 = "S";
                   aAdministrador = "S";
                   |SAL;
               |FINSI;
           |FINSI;
     |SIGUE;
     |CIERRA #511;
     |CIERRA #505;

     |C_M #901#2, 1, "S";
     |SI aAdministrador = "N";
         |C_M #901#2, 1, "N";
         #901#2 = "M";
         #901#3 = 0;
         #901#4 = "";
     |FINSI;

     |PINTA #901#2;
     |PINTA #901#3;
     |PINTA #901#4;
|FPRC;

|PROCESO Tipo80Fxy1;  |TIPO 80;
     |ABRE #514;
     |LEE 000#514p;
     |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
     |CIERRA #514;

     FSalida = 2799;
|FPRC;
