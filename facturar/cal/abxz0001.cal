|FICHEROS;
     abom0001 #1;
     abom0014 #14;
     abom0015 #15;
     abom0016 #16;
     abom0511 #511;
     abom0514 #514;
     abom0518 #518;
     abxz0001 #901;
     abxw0006 #906;
     abxw0007 #907,MANTE;

     abow0027 #927;
     abow0028 #928;

     asclient #999;
     abxm0505 #505;
     abxm0503 #503;
     abxm0516 #516;
     abxm0517 #517;
|FIN;

|VARIABLES;
     aRGB = "";
     aBr  = "";
     &enNumExpeCorreo = 0;
     aTempo = "";
     nClave = 0;
     aTipoContacto = "";
     aEmail = "";
     nGridSel = 0;
     aEsc1           = "";
     aEsc2           = "";
     aRetu           = "";
     aTecla          = "";
     nPantaSel = 0;
     nBotonMarcar = 0;
     nBotonDesmarcar = 0;

     &eaOrigen       = "";
     &eaDestino      = "";
     &eaUnidadBasico  = "";
     aNombreFic = "";
     aIP = "";
     aBorra = "";

     aExtension = "";
     aTextoLabel = "";

     aNombre = "";
     aSacaEmail = "";
     nConta = 0;
     aCampo = "";
     aValor= "";
     aAlfaDos = "";
     nSwAdjuntoVacio = 0;
     aUsuario = "";
     aBaseOrigen = "";
     aBaseDestino = "";
     aAbreTXTO = "";
     aAbreTXTD = "";
     aAbreFIN = "";
     aCarac10 = "";
     aConten = "";
     aEjecuta = "";
     nHandle1 = 0;
     nHandle2 = 0;
     aAsunto = "";
     aFicheroAdjunto = "";
     aCuerpo = "";
     aMensaje = "";
     aFrase = "";
     aTo = "";
     aDirec = "";
     nPos = 0;
     aCarac = "";
     aFrom = "";
     aHora = "";
     aPos  = "";

     nPos1          = 0;
     nPos2          = 0;
     nPanta         = 0;
     nSubBoton1     = 0;
     nSubBoton2     = 0;
     nSubBoton3     = 0;
     nSubBoton4     = 0;
     nGrid          = 0;
     nRango         = 0;
     nVentana       = 0;
     nHastaCampo    = 0;
     nCampo         = 0;
     nRegilla       = 0;
     nLLave         = 0;
     nErrorGeneral  = 0;
     nBotonAceptar  = -1;
     nVent          = -1;

     aFichero       = "";
     aRuta          = "";
     aAlfa          = "";
     aQueBoton      = "";
     aID            = "";

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     aAbre          = "";
     aBase          = "";
     aOrigen        = "";
     aDestino       = "";
     aIPRemoto      = "";
     aDSCorreo      = "";
     aUsu           = "";
     aPwd           = "";
     aProxy         = "";
     aTitulo        = "";
     aDirOri        = "";
     aDirDes        = "";
     aTexto         = "";
     aFic           = "";
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa3         = "";
     aAlfa4         = "";
     aAlfa5         = "";
     aAlfa6         = "";
     aMenLog        = "";
     aDocu          = "";
     aLong          = "";
     aCaracter      = "";
     aEsDeNuevo     = "";
     aBaseMensaje   = "";
     aBasePlant     = "";
     aPathLanzador  = "";
     aHTM           = "";
     aAbreHTMO      = "";
     aAbreHTMD      = "";
     aNLogo         = "";

     nLong          = 0;
     nCaracter      = 0;
     nPosi          = 0;
     nVariable      = 0;
     nLinea         = 0;
     nHandle        = 0;
     nGuarda        = 0;

     fFecha         = @;
     fFechaGuarda   = @;

     &enCodUbica     = 0;
     &efFechaDocu    = @;
     &eaRutaDocumento= "";
     &enTotalVaria   = 0;
     &eaNombreList   = "";
     &enCuadroIni    = 0;
     &enCuadroFin    = 0;
     &enCampoAncho   = 0;
     &enModoEdita    = 0;
     &eaFicheroEdita = "";
     &enCuenta       = 0;
     &enError        = 0;
     &eaFichAdjunto  = "";
     &enExped        = 0;
     &enContador     = 0;
     &enDoc          = 0;
     &eaPath         = "";
     &eaEmpAcceso    = "";
     &eaParametro1   = "";
     &eaParametro2   = "";
     &eaParametro3   = "";
     &eaParametro5   = "";
     &eaFicheroPdf   = "";
     &eaPaq          = "";
     &eaNomDes       = "";
     &enCambAdj      = 0;
|FIN;

|PROCESO TrataAdjunto;
     aAlfa = #901#1;  |QBT aAlfa;
     |SI aAlfa = "";
         aDestino = aBase + "VACIO.TXT";
         |XABRE "BW", aDestino, nHandle;
         aAlfa1   = "Uso interno " + &13 + &10;
         |XGRABA nHandle, aAlfa1;
         |XCIERRA nHandle;
         eaFicheroEdita = "";
         nSwAdjuntoVacio = 1;
     |SINO;
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aFichero = "";

         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPosi     = (100 * nCaracter) + 1;
               aCaracter = aAlfa % nPosi;
               |SI aCaracter = "/";  |O aCaracter = "\";
                   aFichero = "";
               |SINO;
                   aFichero = aFichero + aCaracter;
               |FINSI;
         |SIGUE;

         aOrigen   = #901#1;  |QBF aOrigen;
         aDestino  = aBase + aFichero;

         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |RECIBE_FICHERO aOrigen, aDestino;
         |FINSI;

         fFechaGuarda = efFechaDocu;
         efFechaDocu  = ~;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;

         aOrigen   = aDestino;
         aDestino  = eaRutaDocumento + "/" + aFichero;
         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |ENVIA_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         eaFicheroEdita = aFichero;
         aEsDeNuevo     = "S";
         aDestino       = aOrigen;
     |FINSI;
|FPRC;

|PROCESO PonFecha;
     fFecha = ~;
     aAlfa1 = fFecha % 102;
     aAlfa2 = fFecha % 402;
     aAlfa3 = fFecha % -104;

     |SI aAlfa2 = "01";  aAlfa2 = "Enero";       |FINSI;
     |SI aAlfa2 = "02";  aAlfa2 = "Febrero";     |FINSI;
     |SI aAlfa2 = "03";  aAlfa2 = "Marzo";       |FINSI;
     |SI aAlfa2 = "04";  aAlfa2 = "Abril";       |FINSI;
     |SI aAlfa2 = "05";  aAlfa2 = "Mayo";        |FINSI;
     |SI aAlfa2 = "06";  aAlfa2 = "Junio";       |FINSI;
     |SI aAlfa2 = "07";  aAlfa2 = "Julio";       |FINSI;
     |SI aAlfa2 = "08";  aAlfa2 = "Agosto";      |FINSI;
     |SI aAlfa2 = "09";  aAlfa2 = "Septiembre";  |FINSI;
     |SI aAlfa2 = "10";  aAlfa2 = "Octubre";     |FINSI;
     |SI aAlfa2 = "11";  aAlfa2 = "Noviembre";   |FINSI;
     |SI aAlfa2 = "12";  aAlfa2 = "Diciembre";   |FINSI;

     fFecha = fFecha % 1;
     aAlfa4 = fFecha % 1109;  |QBF aAlfa4;
     |HORA aAlfa5;

     aAlfa  = aAlfa4 + ", " + aAlfa1 + " de " + aAlfa2 + " de " + aAlfa3 + " a las " + aAlfa5;
|FPRC;

|PROCESO PonNotifica;
     aConten = "--notifica \" + &10;
|FPRC;

|PROCESO PonDirecciones;
     aLong  = aTo % 0;
     nLong  = aLong;
     aFrase = "";
     aDirec = "";
     |PARA nPosi = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos   = (nPosi * 100) + 1;
           aCarac = aTo % nPos;

           |SI aCarac = ";";  |O aCarac = ",";
               aFrase = aFrase + "--to=" + &34 + aDirec + &34 + " ";
               aDirec = "";
           |SINO;
               aDirec = aDirec + aCarac;
           |FINSI;
     |SIGUE;

     |SI aDirec ! "";
         aFrase = aFrase + "--to=" + &34 + aDirec + &34;
     |FINSI;

     aConten = aConten + aFrase + " \" + &10;
|FPRC;

|PROCESO EnvioSinHTM;
     |DBASE aBase;
     |QBF aBase;
     aBaseOrigen  = aBase + "plantillas/";
     aBaseDestino = aBase + "dscorreo";              |MKDIR aBaseDestino;
     aBaseDestino = aBase + "dscorreo/" + Usuario;   |MKDIR aBaseDestino;
     aBaseDestino = aBase + "dscorreo/" + Usuario + "/";

     aAbreTXTO = aBaseOrigen + "dscorreo.sh";
     aAbreTXTD = aBaseDestino + aUsuario + ".sh";  |QBT aAbreTXTD;
     aAbreFIN  = aBaseDestino + aUsuario + ".txt"; |QBT aAbreFIN;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aFrom + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    ||La cuenta tiene echo de notificacion.
                    |SI #518#9 = "S"
                         |HAZ PonNotifica;
                    |SINO;
                         aConten = "";
                    |FINSI;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "CUERPO=$4";
                |SI FSalida ! 0;
                    aConten = "CUERPO=" + &34 + aCuerpo + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$ADJUNTO";
                |SI FSalida ! 0;
                    aConten = "";
                    |SI aFicheroAdjunto ! ""; |Y nSwAdjuntoVacio = 0;
                        aConten = "--attach " + aFicheroAdjunto + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                |SINO;
                     |XGRABA nHandle1, aConten;
                |FINSI;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     ||TODO CCC. DESCOMENTAR ESTE TROZO
     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     fFecha   = ~;
     |HORA aHora;

     aAlfa  = aBase + "dscorreo";
     aAlfa  = aBase + "dscorreo/envios";    |MKDIR aAlfa;
     aAlfa  = aBase + "dscorreo/envios/";
     aAlfa1 = Usuario % 810;  |QBF aAlfa1;

     aAlfaDos = aAlfa + aAlfa1 + "_" + (fFecha % -104) + (fFecha % 402) + (fFecha % 102);
     aAlfaDos = aAlfaDos + "_" + (aHora % 102) + (aHora % 402) + (aHora % 702) + ".txt";
     |COPIA_FICHERO aAbreTXTD, aAlfaDos;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO CargaPathSMTPCLI;
     |SI aBaseMensaje ! "";  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aBaseMensaje = aBase + "dscorreo/";
     aBasePlant   = aBase + "plantillas/";

     |DBASE aPathLanzador;
     aPathLanzador = aBaseMensaje + Usuario;  |QBF aPathLanzador;
                                              |MKDIR aPathLanzador;
     aPathLanzador = aPathLanzador + "/"
|FPRC;

|PROCESO CopiaAlLanzador;
     aHTM     = #abom0514#48;  |QBF aHTM;

     |SI #abom0518#10 = "P";
         aHTM = #abom0518#11;  |QBF aHTM;
     |FINSI;

     aOrigen  = aBaseMensaje  + aHTM;
     aDestino = aPathLanzador + aHTM;
     |COPIA_FICHERO aOrigen, aDestino;
     aEjecuta = "chmod +x " + aDestino;  |SYSTEM aEjecuta;

     aOrigen  = aBasePlant + "smtp-cli";
     aDestino = aPathLanzador + "smtp-cli";
     |COPIA_FICHERO aOrigen, aDestino;
     aEjecuta = "chmod +x " + aDestino;  |SYSTEM aEjecuta;
|FPRC;

|PROCESO EnvioConHTM;
     |HAZ CargaPathSMTPCLI;
     |HAZ CopiaAlLanzador;

     aAbreHTMO = aBaseMensaje + aHTM;
     aAbreHTMD = aPathLanzador + aHTM;
     |FBORRA aAbreHTMD;

     |XABRE "WB", aAbreHTMD, nHandle1;
     |XABRE "AB", aAbreHTMO, nHandle2;

     nRegilla = 0;
     nLLave   = 0;

     aNLogo   = "";
     aAlfa    = #abom0514#28;  |QBF aAlfa;
     |SI aAlfa ! "";
         aOrigen  = aAlfa;
         aDestino = aPathLanzador + "logo.bmp";
         |COPIA_FICHERO aOrigen, aDestino;

         aNLogo = "logo.bmp";
     |FINSI;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = "#";
                nRegilla = nRegilla + 1;
            |FINSI;

            |SI nRegilla = 2;  |SAL;  |FINSI;

            |SI nLLave = 0;  |Y aAlfa ! "{";  |Y nRegilla = 0;
                |XGRABA nHandle1, aAlfa;
            |FINSI;

            |SI aAlfa = "}";
                aConten  = aConten + aAlfa;

                |SI aConten = "{LOGO}";
                    aAlfa = aNLogo;
                |FINSI;

                |XGRABA nHandle1, aAlfa;

                nLLave   = 0;
                aConten  = "";
            |SINO;
                |SI aAlfa = "{";  |O nLLave = 1;
                    aConten  = aConten + aAlfa;
                    nLLave = 1;
                |FINSI;
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;

     |AFEGIR_FICHERO aAbre, aAbreHTMD;

     |XABRE "AB", aAbreHTMD, nHandle1;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |XGRABA nHandle1, aAlfa;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aAbreTXTO = aBasePlant + "dscorreohtm.sh";
     aAbreTXTD = aPathLanzador + "dscorreohtm.sh";
     aAbreFIN  = aPathLanzador + "dscorreohtm.txt";
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                    aConten = aPathLanzador + "smtp-cli" + aAlfa1;
                |FINSI;
                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aFrom + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    |SI #518#9 = "S"
                         |HAZ PonNotifica;
                    |SINO;
                         aConten = "";
                    |FINSI;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICHTM=$4";
                |SI FSalida ! 0;
                    aConten = "FICHTM=" + &34 + aAbreHTMD + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICAT1=$5";
                |SI FSalida ! 0;
                    aConten = "FICAT1=" + &34 + "--attach-inline " + aPathLanzador + "logo.bmp" + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "$ADJUNTO";
                |SI FSalida ! 0;
                    aConten = "";
                    |SI aFicheroAdjunto ! ""; |Y nSwAdjuntoVacio = 0;
                        aConten = "--attach " + aFicheroAdjunto + " \" + &10;
                    |FINSI;
                |FINSI;

                |XGRABA nHandle1, aConten;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     fFecha   = ~;
     |HORA aHora;

     aAlfa  = aBase + "dscorreo";
     aAlfa  = aBase + "dscorreo/envios";    |MKDIR aAlfa;
     aAlfa  = aBase + "dscorreo/envios/";
     aAlfa1 = Usuario % 810;  |QBF aAlfa1;

     aAlfaDos = aAlfa + aAlfa1 + "_" + (fFecha % -104) + (fFecha % 402) + (fFecha % 102);
     aAlfaDos = aAlfaDos + "_" + (aHora % 102) + (aHora % 402) + (aHora % 702) + ".txt";
     |COPIA_FICHERO aAbreTXTD, aAlfaDos;

     |FBORRA aAbreTXTD;
     |FBORRA aAbreHTMD;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO EnvioSMTPCLI;
     aUsuario = Usuario;

     |SI #abom0514#47 = "N";  |HAZ EnvioSinHTM;  |FINSI;
     |SI #abom0514#47 = "S";  |HAZ EnvioConHTM;  |FINSI;
|FPRC;

|PROCESO SacaSoloEmail;
     ||Ahora nos configuran los correos de esta forma:
     ||password:usuario:email.

     aNombre = "";
     aLong = aSacaEmail % A0;
     nLong = aLong;
     |PARA nConta = 1; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
          |SI nConta [ 99;
               aCampo = ("00" + nConta) % -102;
               aCampo = "-" + aCampo + "01";
               nCampo = aCampo;
               aValor = aSacaEmail % nCampo;
               |SI aValor ! ":";
                    aNombre = aValor + aNombre;
               |SINO;
                    |SAL;
               |FINSI;
          |SINO;
               aNombre = "";
               |SAL;
          |FINSI;
     |SIGUE;

     aSacaEmail = aNombre;
|FPRC;

|PROCESO AdjuntoDoc;
     nSwAdjuntoVacio = 1;
     |SI eaFichAdjunto ! "";
         nSwAdjuntoVacio = 0;
         aOrigen   = #901#1;  |QBF aOrigen;  || Cuando es un correo de documentos
         aDestino  = aBase + eaFicheroEdita; || o un reenvio.

         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         nSwAdjuntoVacio = 0;
         |HAZ TrataAdjunto;   || Cuando es correo nuevo.
     |FINSI;
|FPRC;

|PROCESO EnvioCorreo;
     aBase  = "";
     |DBASE aBase;  |QBF aBase;
     aBase  = aBase + "correos/";  |MKDIR aBase;
     nLinea = 1;
     |SI enExped = 0;
         |ABRE #14;
         |LEE 040#14u;
         |SI FSalida = 0;
             nLinea = #14#0 + 1;
         |FINSI;
         |CIERRA #14;
         aDocu = (("00000000" + nLinea) % -108) + ".txt";
         aAbre = aBase + aDocu;
     |SINO;
         nLinea = 1;
         |ABRE #15;
         #15#0 = enExped;
         #15#1 = 9999;
         |LEE 040#15];
         |SI FSalida = 0;
             |LEE 040#15a;
         |SINO;
             |LEE 040#15u;
         |FINSI;
         |SI FSalida = 0;  |Y #15#0 = enExped;
             nLinea = #15#1 + 1;
         |FINSI;
         |CIERRA #15;

         aDocu = (("00000000" + enExped) % -108) + (("0000" + nLinea) % -104) + ".txt";
         aAbre = aBase + aDocu;
     |FINSI;

     |XABRE "BW", aAbre, nHandle;
     nHastaCampo = 2;
     |PARA nCampo = 101;  |SI nCampo ] 2;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #901nCampo;  |QBF aAlfa;
           |SI aAlfa ! "";  nHastaCampo = nCampo;  |SAL;  |FINSI;
     |SIGUE;

     |SI #abom0514#47 = "N";
         |PARA nCampo = 2;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #901nCampo;
               |ANSI_OEM aAlfa, aAlfa;

               aAlfa = aAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
         |SIGUE;
     |FINSI;

     |SI #abom0514#47 = "S";
         |PARA nCampo = 2;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #901#nCampo#;  |QBF aAlfa;
               |ANSI_OEM aAlfa, aAlfa;

               |SI aAlfa = "";
                   aAlfa = "<br>";
               |SINO;
                   aAlfa = aAlfa + " " + &13 + &10;
               |FINSI;

               |XGRABA nHandle, aAlfa;
         |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     nGuarda      = enCodUbica;
     fFechaGuarda = efFechaDocu;
     efFechaDocu  = ~;
     enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
     enCodUbica   = nGuarda;
     efFechaDocu  = fFechaGuarda;

     aOrigen   = aAbre;
     aDestino  = eaRutaDocumento + "/" + aDocu;
     |SI #514#21 ! "C";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |SI enCambAdj = 0;
         |HAZ AdjuntoDoc;
     |SINO;
         aDestino = eaFichAdjunto;
     |FINSI;

     aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
     aUsu      = #518#6;           |QBF aUsu;        || usuario
     aPwd      = #518#7;           |QBF aPwd;        || password
     aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

     aTitulo = #901#0;
     |ANSI_OEM aTitulo, aTitulo;
     |QBF aTitulo;                                    || Asunto

     aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
     aTexto    = "$$$$" + aAbre;
     aFic      = aDestino;  |QBF aFic;

     |SI aFic ! "";
         |XABRE "E", aFic, nHandle;
         |SI FSalida < 0;
             |MENAV "0000Ha habido algun error el el documento adjunto. Por favor envielo de nuevo";

             |FBORRA aAbre;
             |FBORRA aDestino;
             nErrorGeneral = 1;

             |ACABA;
         |FINSI;
     |FINSI;

     aDirDes   = #906#0;            |QBF aDirDes;     || Direccion Destino
     aAlfa1 = "0000Enviando Correo [" + aDSCorreo + "] ...";
     |MENSA aAlfa1;

     |SI #514#29 = "S";
          aFrom      = aDirOri;
          aSacaEmail = aFrom;
          |HAZ SacaSoloEmail;
          aFrom           = aSacaEmail;
          aTo             = aDirDes;
          aAsunto         = aTitulo;
          aFicheroAdjunto = aFic;
          aCuerpo         = aAbre;
          |HAZ EnvioSMTPCLI;
     |SINO;
          |SI #518#9 = "S"
              aDirOri = "!" + aDirOri;
          |FINSI;

          |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFic;
          enError = FSalida;
          |BLIN 4;

          |SI enError < 0;
              aMenLog = "    Problemas al enviar correo ..." + enError;
              |MENAV aMenLog;
              |CONFI "0000SRevisar detalles?";
              |SI FSalida = 0;
                  aAlfa6 = "0000IPDSCorreo: " + aDSCorreo;     |MENAV aAlfa6;
                  aAlfa6 = "0000Servidor: " + aProxy;          |MENAV aAlfa6;
                  aAlfa6 = "0000Dir.Origen: " + aDirOri;       |MENAV aAlfa6;
                  aAlfa6 = "0000Dir.Destin: " + aDirDes;       |MENAV aAlfa6;
                  |MENAV "0000Ninguno de estos 4 parametros deberia estar vacio.";
              |FINSI;
              |FBORRA aAbre;
              |FBORRA aDestino;
              nErrorGeneral = 1;
              |ACABA;
          |FINSI;
     |FINSI;
     |FBORRA aAbre;

     |SI enCambAdj = 0;
         |FBORRA aDestino;
     |FINSI;

     |HAZ PonFecha;

     |SI enExped = 0;
         |ABRE #14;
         |DDEFECTO #14;
         #14#0  = nLinea;
         #14#2  = #901#0;
         #14#3  = aAlfa;
         #14#4  = #906#0;
         #14#5  = eaFicheroEdita;
         #14#6  = enCodUbica;
         #14#7  = ~;
         #14#8  = efFechaDocu;
         #14#9  = aEsDeNuevo;
         #14#11 = aDirOri;
         |GRABA 020#14n;
         |CIERRA #14;
     |SINO;
         |ABRE #15;
         |DDEFECTO #15;
         #15#0  = enExped;
         #15#1  = nLinea;
         #15#2  = #901#0;
         #15#3  = aAlfa;
         #15#4  = #906#0;
         |SI enCambAdj = 0;
             #15#5  = eaFicheroEdita;
             #15#6  = enCodUbica;
             #15#8  = efFechaDocu;
             #15#12 = "N";
         |SINO;
             #15#5  = eaPaq;
             #15#6  = 0;
             #15#8  = ~;
             #15#12 = "S";
         |FINSI;

         #15#7  = ~;
         #15#9  = aEsDeNuevo;
         #15#11 = aDirOri;

         |GRABA 020#15n;
         |CIERRA #15;
     |FINSI;

     |BORRA 020#906a;
     |LIBERA #906;
|FPRC;

|PROCESO BandejaPendiente;
     aBase  = "";
     |DBASE aBase;  |QBF aBase;
     aBase  = aBase + "correos/";  |MKDIR aBase;
     nLinea = 1;
     |ABRE #16;
     #16#0 = enExped;
     #16#1 = 9999;
     |LEE 040#16];
     |SI FSalida = 0;
         |LEE 040#16a;
     |SINO;
         |LEE 040#16u;
     |FINSI;
     |SI FSalida = 0;  |Y #16#0 = enExped;
         nLinea = #16#1 + 1;
     |FINSI;
     |CIERRA #16;

     aDocu = (("00000000" + enExped) % -108) + (("0000" + nLinea) % -104) + ".txt";
     aAbre = aBase + aDocu;

     |XABRE "BW", aAbre, nHandle;
     nHastaCampo = 2;
     |PARA nCampo = 101;  |SI nCampo ] 2;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #901nCampo;  |QBF aAlfa;
           |SI aAlfa ! "";  nHastaCampo = nCampo;  |SAL;  |FINSI;
     |SIGUE;

     |SI #abom0514#47 = "N";
         |PARA nCampo = 2;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #901nCampo;
               |ANSI_OEM aAlfa, aAlfa;

               aAlfa = aAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
         |SIGUE;
     |FINSI;

     |SI #abom0514#47 = "S";
         |PARA nCampo = 2;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #901#nCampo#;  |QBF aAlfa;
               |ANSI_OEM aAlfa, aAlfa;

               |SI aAlfa = "";
                   aAlfa = "<br>";
               |SINO;
                   aAlfa = aAlfa + " " + &13 + &10;
               |FINSI;

               |XGRABA nHandle, aAlfa;
         |SIGUE;
     |FINSI;

     |XCIERRA nHandle;

     nGuarda      = enCodUbica;
     fFechaGuarda = efFechaDocu;
     efFechaDocu  = ~;
     enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
     enCodUbica   = nGuarda;
     efFechaDocu  = fFechaGuarda;

     aOrigen   = aAbre;
     aDestino  = eaRutaDocumento + "/" + aDocu;
     |SI #514#21 ! "C";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |SI eaFichAdjunto ! "";
         aOrigen   = #901#1;  |QBF aOrigen;  || Cuando es un correo de documentos
         aDestino  = aBase + eaFicheroEdita; || o un reenvio.

         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |HAZ TrataAdjunto;   || Cuando es correo nuevo.
     |FINSI;

     aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
     aUsu      = #518#6;           |QBF aUsu;        || usuario
     aPwd      = #518#7;           |QBF aPwd;        || password
     aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

     aTitulo = #901#0;
     |ANSI_OEM aTitulo, aTitulo;
     |QBF aTitulo;                                    || Asunto

     aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
     aDirDes   = #906#0;            |QBF aDirDes;     || Direccion Destino
     aTexto    = "$$$$" + aAbre;
     aFic      = aDestino;

     |HAZ PonFecha;

     |ABRE #16;
     |DDEFECTO #16;
     #16#0  = enExped;
     #16#1  = nLinea;
     #16#2  = #901#0;
     #16#3  = aAlfa;
     #16#4  = #906#0;
     #16#5  = #901#1;
     #16#6  = enCodUbica;
     #16#7  = ~;
     #16#8  = efFechaDocu;
     #16#9  = aEsDeNuevo;
     #16#12 = enCuenta;
     |GRABA 020#16n;
     |CIERRA #16;
|FPRC;

|PROCESO abxw0006;
     aAlfa = #906#0;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     |SI #514#24 = "E";
          |HAZ EnvioCorreo;
     |SINO;
         |HAZ BandejaPendiente;
     |FINSI;
|FPRC;

|DEFBUCLE abxw0006;
     #906#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, abxw0006;
|FIN;

|PROCESO ConversionPDF;
     ||TODO CCC
     ||falta el instalar la impresora DSPDF

     |HAZ LeeUnidadBasico;

     |HAZ InstalaImpresora;

     ||TODO CCC      ||Nombre    (aNombreFic)
     |SI enCambAdj = 0;
         aNombreFic = (eaFicheroEdita - aExtension);
     |SINO;
         aNombreFic = eaNomDes - aExtension;
     |FINSI;

     aAlfa = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/";

     eaOrigen  = eaFichAdjunto;
     eaDestino = aAlfa + aNombreFic + ".doc";
     |HAZ EnviaFicheroConMD5;

     aAlfa2 = aAlfa + aNombreFic + ".txt";
     |XABRE "WCB", aAlfa2, nHandle;
     |SI FSalida = 0;
        aAlfa2 = "[FICHERO]#" + aAlfa + aNombreFic + ".doc#" + aAlfa + "pdf_" + aNombreFic + ".doc" + &13 + &10; |XGRABA nHandle, aAlfa2;
        aAlfa2 = "[IMPRESORA]#I#2#DSPDF#2" + &13 + &10; |XGRABA nHandle, aAlfa2;
        |XCIERRA nHandle;
     |FINSI;

     eaFicheroPdf = "pdf_" + aNombreFic + ".pdf";
     eaParametro1 = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/dsxml.exe ";
     eaParametro2 = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/" + aNombreFic + ".txt";
     eaParametro5 = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/";
     eaParametro3 = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/pdf_" + aNombreFic + ".doc";
     |HAZ EjecutaDSXML;

     aBorra = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/" + aNombreFic + ".doc";
     |RFBORRA aBorra;
     aBorra = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/pdf_" + aNombreFic + ".doc";
     |RFBORRA aBorra;
     aBorra = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/" + aNombreFic + ".txt";
     |RFBORRA aBorra;

     aOrigen = eaUnidadBasico + "/DOCUMENTOS/IPABOGAD/pdf_" + aNombreFic + ".pdf";
     aDestino = eaFichAdjunto - aExtension;
     aDestino = aDestino + ".pdf";
     |HAZ RecibeFichero;

     aAlfa = aDestino;
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida < 0;
         #901#1        = "";
         eaFichAdjunto = "";
         aAlfa = "0000Ha habido un error en la conversi¢n a PDF. ";
         aAlfa = aAlfa + "Por favor intenlo de nuevo o pongase en contacto con su administrador";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     eaFicheroEdita = aNombreFic + ".pdf";
     eaFichAdjunto  = aDestino;
     #901#1         = eaFichAdjunto;

     ||TODO CCC FALTA.. dejar donde corresponfa el  .pdf.
|FPRC;

|PROCESO RecibeFichero;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
          |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO Tipo12Fxz1; |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     |LEE 000#906p;
     |SI FSalida ! 0;  |DDEFECTO #906;  |FINSI;

     aAlfa = #906#0;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Introduzca un destinatario";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #514#24 = "P";
        |CONFI "0000SDesea enviar el Correo ";
        |SI FSalida = 0;
            #514#24 = "E";
        |SINO;
            |CONFI "0000SLo enviamos a la bandeja de pendiente de envio";
            |SI FSalida = 0;
                #514#24 = "C";
            |SINO;
                |MENAV "0000 Env¡o cancelado.";
                |ACABA;
            |FINSI;
        |FINSI;
     |FINSI;

     |SI PARAMETRO = "";  |O PARAMETRO = "DSARCHI";
         |VENTANA 0501, 2799, -1, 17, "Cuentas de correos - Pulse doble click sobre la cuenta por la que quiere enviar";
         nVentana = FSalida;

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = nVentana;
         aVent5 = "MODAL";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |SUB_EJECUTA_NP "abom0518;PIDECUENTAX";

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = nVentana;
         aVent5 = "MODELESS";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |FINVENTANA nVentana;
     |FINSI;

     |ABRE #518;
     #518#0 = enCuenta;
     |LEE 040#518=;
     |SI FSalida ! 0;
         |MENAV "       No existe la Cuenta de Correo.";
         |CIERRA #518;
         |ACABA;
     |FINSI;
     |CIERRA #518;

     |SI aExtension = ".doc"; |O aExtension = ".DOC";
          ||TODO CCC
          |SI #abxz0001#102 = "P";
              |HAZ ConversionPDF;
              |SI eaFichAdjunto = "";
                  |ACABA;
              |FINSI;
          |FINSI;
     |FINSI;

     nErrorGeneral = 0;
     |BUCLE abxw0006;

     |SI PARAMETRO = "";
         |SI #514#24 ! "E";
             |MENAV "0000Los correos se han enviado a la bandeja de correos pendientes.";
         |SINO;
             |SI nErrorGeneral = 0;
                 |MENAV "0000 El correo se ha enviado correctamente.";
             |SINO;
                 |REFRESCACONTROL nGrid;
                 |MENAV "0000 No se ha podido enviar el correo en las direcciones que tenemos en el lineal de Contactos.";
                 |MENAV "0000 Por favor revise las direcciones o cancele para terminar el env¡o.";
                 |ERROR;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO BotonValida;
     |PTEC 806;
|FPRC;

|PROCESO Tipo7C0Fxz1;  |TIPO 7;
     |SI nBotonAceptar ! -1;  |ACABA;  |FINSI;

     aQueBoton     = "|X000";
     aID           = #901#aQueBoton#;
     nBotonAceptar = aID;
     |ESTADO_CONTROL nBotonAceptar, "HIDE";

     |CONTROL_SIMPLE 0, "BOTON,{{206}}Enviar correo", 2770, 2783, BotonValida;
|FPRC;

|PROCESO Browse;
     aRuta = #901#1;  |QBF aRuta;
     |SI aRuta = "";
         aRuta = "C:\*.*";
     |FINSI;
     aRuta = "F" + aRuta;

     |BROWSE aRuta;
     aAlfa = aRuta % 299;  |QBF aAlfa;

     |SI aAlfa ! "";
         #901#1 = aRuta % 299;  |PINTA #901#1;
     |FINSI;
|FPRC;

|PROCESO NuevoContacto;
     |VENTANA 0501, 2799, -1, 17, "Nuevo contacto";
     nVentana = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |DDEFECTO #907;

     |PINPA #0#907;
     |PINDA #0#907;
     |ENDATOS #1#907;
     |SI FSalida = 0;
         |DDEFECTO #906;
         #906#0 = #907#2;
         |LEE 101#906=;
         |SI FSalida ! 0;
             #906#0 = #907#2;
             |GRABA 020#906n;
             |LIBERA #906;
         |FINSI;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentana;

     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO BorrarContacto;
     |LEE 101#906=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CONFI "0000NSeguro que quiere borrar el contacto seleccionado.";
     |SI FSalida ! 0;  |LIBERA #906;  |ACABA;  |FINSI;

     |BORRA 020#906a;
     |LIBERA #906;

     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     |ABRE #514;
     |LEE 000#514p;
     |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
     |CIERRA #514;

     aFichero = ("c5" + Usuario + "zzzzzzzz") % 108;  |NOME_DAT #906 aFichero;

     |ABRE #906;  |CIERRA #906;  |DELINDEX #906;

     |ABRET #906;

     FSalida = 2799;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     |CIERRAT #906;

     |DELINDEX #906;
|FPRC;

|PROCESO EventoPanta;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#906=;
         |SI FSalida = 0;
             |ESTADO_CONTROL nSubBoton3, "ENABLE";
         |SINO;
             |ESTADO_CONTROL nSubBoton3, "DISABLE";
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO abom0511;
     #906#0 = #511#2;
     |LEE 101#906=;
     |SI FSalida ! 0;
         #906#0 = #511#2;
         |GRABA 020#906n;
         |LIBERA #906;
     |FINSI;
|FPRC;

|DEFBUCLE abom0511;
     #511#1;
     ;
     #1#28, "          ";
     #1#28, "zzzzzzzzzz";
     ;
     NULL, abom0511;
|FIN;

|PROCESO MeteAsclient;
     nClave = nClave + 1;
     |DDEFECTO #927;
     #927#0 = nClave;
     |LEE 101#927.=;
     |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
     #927#1 = #asclient#1;
     #927#2 = aEmail;
     #927#3 = aTipoContacto;
     #927#4 = #asclient#0;
     |GRABA 020#927.a;
     |LIBERA #927;
|FPRC;

|PROCESO EventoSelContaExpe;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#927=;
     |FINSI;

     |SI FSalida = 4;
          |LEE 000#927=;
          |SI FSalida ! 0; |ACABA; |FINSI;

          |LEE 101#927.=;
          aRGB = #927#5;
          |QBF aRGB;
          |SI aRGB = "0,185,0;255,255,255";
               #927#5 = "0,0,0;0,0,0";
          |SINO;
               #927#5 = "0,185,0;255,255,255";
          |FINSI;
          |GRABA 020#927.a;
          |LIBERA #927;

          |REFRESCACONTROL nGridSel;
     |FINSI;
|FPRC;

|PROCESO MarcarTodos;
     |LEE 000#927.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |LEE 101#927.=;
          |SI FSalida ! 0; |SAL; |FINSI;
          #927#5 = "0,185,0;255,255,255";
          |GRABA 020#927.a;
          |LIBERA #927;

          |LEE 000#927.s;
     |SIGUE;
     |REFRESCACONTROL nGridSel;
|FPRC;

|PROCESO DesarcarTodos;
     |LEE 000#927.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |LEE 101#927.=;
          |SI FSalida ! 0; |SAL; |FINSI;
          #927#5 = "0,0,0;0,0,0";
          |GRABA 020#927.a;
          |LIBERA #927;

          |LEE 000#927.s;
     |SIGUE;
     |REFRESCACONTROL nGridSel;
|FPRC;

|PROCESO Seleccion927;
     aRGB = #927#5;
     |QBF aRGB;
     |SI aRGB = "0,185,0;255,255,255";
          |DDEFECTO #906;
          #906#0 = #927#2;
          |LEE 101#906.=;
          |SI FSalida ! 0;
               #906#0 = #927#2;
               |GRABA 020#906n;
               |LIBERA #906;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Seleccion927;
 #927#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, Seleccion927;
|FIN;


|PROCESO ContactosExpe;
     |SI enNumExpeCorreo = 0;
          aMensaje = "0000Correo no vinculado a ning£n expediente";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aTempo = Usuario;
     |QBF aTempo;
     aTempo = "27" + aTempo;
     |NOME_DAT #927 aTempo;

     |ABRE #927;
     |CIERRA #927;
     |DELINDEX #927;

     nClave = 0;
     |ABRE #927;

     |ABRE #asclient;
     |ABRE #1;
     #1#0 = enNumExpeCorreo;
     |LEE 000#1=;
     |SI FSalida = 0;
          |DDEFECTO #asclient;
          #asclient#0 = #1#3;
          |LEE 000#asclient.=;
          |SI FSalida = 0;
               aEmail = #asclient#57;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Cliente del expediente";
                    |HAZ MeteAsclient;
               |FINSI;
          |FINSI;

          |ABRE #abxm0505;

          ||DIRECTOR
          |DDEFECTO #abxm0505;
          #abxm0505#0 = #1#5;
          |LEE 000#abxm0505.=;
          |SI FSalida = 0;
               aEmail = #abxm0505#21;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Director";
                    nClave = nClave + 1;
                    |DDEFECTO #927;
                    #927#0 = nClave;
                    |LEE 101#927.=;
                    |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
                    #927#1 = #abxm0505#1;
                    #927#2 = aEmail;
                    #927#3 = aTipoContacto;
                    #927#4 = #abxm0505#0;
                    |GRABA 020#927.a;
                    |LIBERA #927;
               |FINSI;
          |FINSI;

          ||TRAMITADOR
          |DDEFECTO #abxm0505;
          #abxm0505#0 = #1#28;
          |LEE 000#abxm0505.=;
          |SI FSalida = 0;
               aEmail = #abxm0505#21;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Tramitador";
                    nClave = nClave + 1;
                    |DDEFECTO #927;
                    #927#0 = nClave;
                    |LEE 101#927.=;
                    |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
                    #927#1 = #abxm0505#1;
                    #927#2 = aEmail;
                    #927#3 = aTipoContacto;
                    #927#4 = #abxm0505#0;
                    |GRABA 020#927.a;
                    |LIBERA #927;
               |FINSI;
          |FINSI;
          |CIERRA #abxm0505;

/*
          ||No hay direcciones de correo en los letrados .. :(
          ||Y tampoco en los contrarios :(
          |ABRE #abxm0503;
          ||Procurador Despacho
          |DDEFECTO #abxm0503;
          #abxm0503#0 = #1#18;
          |LEE 000#abxm0503.=;
          |SI FSalida = 0;
               aEmail = #abxm0503#21;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Procurador Despacho";
                    nClave = nClave + 1;
                    |DDEFECTO #927;
                    #927#0 = nClave;
                    |LEE 101#927.=;
                    |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
                    #927#1 = #abxm0503#1;
                    #927#2 = aEmail;
                    #927#3 = aTipoContacto;
                    #927#4 = #abxm0503#0;
                    |GRABA 020#927.a;
                    |LIBERA #927;
               |FINSI;
          |FINSI;
          |CIERRA #abxm0503;
*/

          ||CORREDURIA SEGUROS
          |ABRE #abxm0516;
          ||DIRECTOR
          |DDEFECTO #abxm0516;
          #abxm0516#0 = #1#39;
          |LEE 000#abxm0516.=;
          |SI FSalida = 0;
               aEmail = #abxm0516#9;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Correduria Seguros";
                    nClave = nClave + 1;
                    |DDEFECTO #927;
                    #927#0 = nClave;
                    |LEE 101#927.=;
                    |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
                    #927#1 = #abxm0516#1;
                    #927#2 = aEmail;
                    #927#3 = aTipoContacto;
                    #927#4 = #abxm0516#0;
                    |GRABA 020#927.a;
                    |LIBERA #927;
               |FINSI;
          |FINSI;
          |CIERRA #abxm0516;


          ||AGENTE DE SEGUROS
          |ABRE #abxm0517;
          ||DIRECTOR
          |DDEFECTO #abxm0517;
          #abxm0517#0 = #1#41;
          |LEE 000#abxm0517.=;
          |SI FSalida = 0;
               aEmail = #abxm0517#19;
               |QBF aEmail;
               |SI aEmail ! "";
                    aTipoContacto = "Agente de Seguros";
                    nClave = nClave + 1;
                    |DDEFECTO #927;
                    #927#0 = nClave;
                    |LEE 101#927.=;
                    |SI FSalida ! 0; |GRABA 020#927.b; |FINSI;
                    #927#1 = #abxm0517#1;
                    #927#2 = aEmail;
                    #927#3 = aTipoContacto;
                    #927#4 = #abxm0517#0;
                    |GRABA 020#927.a;
                    |LIBERA #927;
               |FINSI;
          |FINSI;
          |CIERRA #abxm0517;



     |FINSI;
     |CIERRA #1;

     |CIERRA #asclient;

     |SI nClave = 0;
          aMensaje = "0000No hay ning£n contactos expediente con direcci¢n de correo";
          |MENAV aMensaje;
          |CIERRA #927;
          |DELINDEX #927;
          |ACABA;
     |SINO;
          |VENTANA 0501, 2799, -1, 17, "Contactos Expediente";
          nVentana = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PINPA #0#928;
          nPantaSel = FSalida;
          |PINDA #0#928;

          |CONTROL_SIMPLE nPantaSel, "BOTON,Marcar Todos", 2702, 2722, MarcarTodos;
          nBotonMarcar = FSalida;

          |CONTROL_SIMPLE nPantaSel, "BOTON,Desarcar Todos", 2724, 2744, DesarcarTodos;
          nBotonDesmarcar = FSalida;

          nRango = 4 + 8 + 16 + 32 + 128;
          |LINEAL_SIMPLE #1#927, nRango, 0702, 2698, NULL, NULL, EventoSelContaExpe;
          nGridSel = FSalida;

          aEsc1  = &255 + "806";
          aEsc2  = &255 + "807";
          aRetu  = &255 + "802";
          |PARA; |SI;  |HACIENDO;
              FSalida = "::{{001}}Salir," + nGridSel;
              |LEETECLA aTecla;
              |SI aTecla = aEsc1; |SAL;  |FINSI;
              |SI aTecla = aEsc2; |SAL;  |FINSI;
              |SI aTecla = aRetu; |SAL;  |FINSI;
          |SIGUE;

          |CIERRA #927;

          |ABRE #906;
          |BUCLE Seleccion927;
          |CIERRA #906;

          |FIN_CONTROL_WINDOWS nBotonMarcar;
          |FIN_CONTROL_WINDOWS nBotonDesmarcar;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentana;

          |REFRESCACONTROL nGrid;
     |FINSI;


     ||Crea el temporal, lo rellena y muestra en LINEAL_SIMPLE.
     ||PARA SELECCIONAR LOS QUE QUERAMOS.


     |ABRE #927;
     |CIERRA #927;
     |DELINDEX #927;
|FPRC;

|PROCESO DSARCHI;
     |PATH_DAT #1   eaPath;
     |PATH_DAT #14  eaPath;
     |PATH_DAT #15  eaPath;
     |PATH_DAT #16  eaPath;
     |PATH_DAT #511 eaPath;

     |ABRE #1;
     #1#0 = enExped;
     |LEE 000#1=;
     |SI FSalida ! 0;
         |CIERRA #1;
         |ACABA;
     |FINSI;
     |CIERRA #1;

     |VENTANA 0501, 2799, -1, 17, "Env¡o aviso a los tramitadores";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |BUCLE abom0511;

     #901#0 = "Fax recibido y vinculado desde DSARCHI";
     #901#1 = "";

     #901#2 = "Fax recibido y vinculado desde DSARCHI";
     #901#3 = "Expediente: " + #1#0;
     #901#4 = "Documento: " + enDoc;

     |PINPA #0#901;
     nPanta = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{136}}", 1596, 1598, Browse;
     nSubBoton1 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Contactos Expediente", 0672, 0790, ContactosExpe;
     nSubBoton4 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Nuevo contacto", 0972, 1090, NuevoContacto;
     nSubBoton2 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Borrar contacto", 1272, 1390, BorrarContacto;
     nSubBoton3 = FSalida;

     |SI enNumExpeCorreo = 0;
          |ESTADO_CONTROL nSubBoton4, "DISABLE";
     |SINO;
          |ESTADO_CONTROL nSubBoton4, "ENABLE";
     |FINSI;

     |C_M #901#1, 1, "S";
     |ESTADO_CONTROL nSubBoton1, "ENABLE";

     nRango = 4 + 8 + 16 + 32 + 128;

     |LINEAL_SIMPLE #1#906, nRango, 0714, 1265, NULL, NULL, EventoPanta;
     nGrid = FSalida;

     |PINDA #0#901;
     |ENDATOS #1#901;

     |FIN_CONTROL_WINDOWS nSubBoton1;
     |FIN_CONTROL_WINDOWS nSubBoton2;
     |FIN_CONTROL_WINDOWS nSubBoton3;
     |FIN_CONTROL_WINDOWS nSubBoton4;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent;

     |PULSATECLA;
|FPRC;

|PROCESO QuitaBr;
     aBr = aAlfa1 - "<br>";
     |SI FSalida = 0;
         #901nCampo = aAlfa1;
         nCampo     = nCampo + 1;

         |ACABA;
     |FINSI;

     |PARA;  |SI;  |HACIENDO;
          aBr = aAlfa1 - "<br>";
          |SI FSalida = 0;  |SAL;  |FINSI;

          aAlfa2 = ("00" + FSalida) % -104;
          aPos   = aAlfa2 % 102;  nPos1 = aPos;
          aPos   = aAlfa2 % 302;  nPos2 = aPos;
          nPos   = ((nPos1 + nPos2) * 100) + 99;

          |SI nPos1 = 1;
              #901nCampo = "";
              nCampo     = nCampo + 1;
              aAlfa1     = aBr;
          |SINO;
              nPos       = 100 + (nPos1 - 1);
              #901nCampo = aAlfa1 % nPos;

              aAlfa2     = #901nCampo;  |QBF aAlfa2;
              aAlfa1     = aAlfa1 - aAlfa2;

              |PARA;  |SI;  |HACIENDO;
                   aAlfa2 = aAlfa1 % 101;
                   |SI aAlfa2 ! " ";  |SAL;  |FINSI;

                   aAlfa1 = aAlfa1 - " ";
              |SIGUE;

              nCampo     = nCampo + 1;
          |FINSI;
     |SIGUE;

     |PARA;  |SI;  |HACIENDO;
             aAlfa2 = aAlfa1 % 101;
             |SI aAlfa2 ! " ";  |SAL;  |FINSI;

             aAlfa1 = aAlfa1 - " ";
     |SIGUE;

     |SI aAlfa1 ! "";
         #901nCampo = aAlfa1;
         nCampo     = nCampo + 1;
     |FINSI;
|FPRC;

|PROCESO TrataParametros;
     |SI PARAMETRO = "DSARCHI";
         |HAZ DSARCHI;

         |ACABA;
     |FINSI;

     |SI PARAMETRO = "CONSULTA16";  |O PARAMETRO = "ENVIO16";
         |ABRE #16;
         #16#0 = enExped;
         #16#1 = enContador;
         |LEE 000#16=;
         |SI FSalida ! 0;
             |CIERRA #16;
             |ACABA;
         |FINSI;

         |PINPA #0#901;
         nPanta = FSalida;

         #901#0 = #16#2;
         #901#1 = #16#5;

         efFechaDocu  = #16#7;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
         aAlfa        = eaRutaDocumento + "/" + (("00000000" + #16#0) % -108) + (("0000" + #16#1) % -104) + ".txt";

         |SI #514#21 = "C";
             |XABRE "U", aAlfa, nHandle;
         |SINO;
             |XABRE "CU", aAlfa, nHandle;
         |FINSI;

         FSalida     = 1;
         nCampo      = 2;
         |PARA;  |SI  FSalida ] 0;  |HACIENDO;
                 |XLEE nHandle, 254, aAlfa1;
                 |SI FSalida < 0; |O nCampo > 101; |SAL;  |FINSI;

                 aAlfa1     = aAlfa1 % 170;
                 |HAZ QuitaBr;
         |SIGUE;
         |XCIERRA nHandle;

         nRango = 4 + 8 + 16 + 32 + 128;

         #906#0 = #16#4;
         |LEE 101#906=;
         |SI FSalida ! 0;
             #906#0 = #16#4;
             |GRABA 020#906n;
             |LIBERA #906;
         |FINSI;

         |LINEAL_SIMPLE #1#906, nRango, 0714, 1265, NULL, NULL, EventoPanta;
         nGrid = FSalida;

         |PINDA #0#901;

         |SI PARAMETRO = "CONSULTA16";
             |LEETECLA aAlfa;
         |FINSI;

         |SI PARAMETRO = "ENVIO16";
             |PTEC 802;
             |PAUSA;
             enError  = 0;
             enCuenta = #16#12;
             #514#24  = "E";
             |HAZ Tipo12Fxz1;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI PARAMETRO = "CONSULTA14";
         |ABRE #14;
         #14#0 = enContador;
         |LEE 000#14=;
         |SI FSalida ! 0;
             |CIERRA #14;
             |ACABA;
         |FINSI;

         |PINPA #0#901;
         nPanta = FSalida;

         #901#0 = #14#2;
         #901#1 = #14#5;

         |C_V #abxz0001#102, 1, "N";

         efFechaDocu  = #14#7;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
         aAlfa        = eaRutaDocumento + "/" + (("00000000" + #14#0) % -108) + ".txt";

         |SI #514#21 = "C";
             |XABRE "U", aAlfa, nHandle;
         |SINO;
             |XABRE "CU", aAlfa, nHandle;
         |FINSI;

         FSalida     = 1;
         nCampo      = 2;
         |PARA;  |SI  FSalida ] 0;  |HACIENDO;
                 |XLEE nHandle, 254, aAlfa1;
                 |SI FSalida < 0; |O nCampo > 101; |SAL;  |FINSI;

                 aAlfa1     = aAlfa1 % 170;
                 |HAZ QuitaBr;
         |SIGUE;
         |XCIERRA nHandle;

         nRango = 4 + 8 + 16 + 32 + 128;

         #906#0 = #14#4;
         |LEE 101#906=;
         |SI FSalida ! 0;
             #906#0 = #14#4;
             |GRABA 020#906n;
             |LIBERA #906;
         |FINSI;

         |LINEAL_SIMPLE #1#906, nRango, 0714, 1265, NULL, NULL, EventoPanta;
         nGrid = FSalida;

         |PINDA #0#901;

         |LEETECLA aAlfa;

         |ACABA;
     |FINSI;

     |SI PARAMETRO = "CONSULTA15";
         |ABRE #15;
         #15#0 = enExped;
         #15#1 = enContador;
         |LEE 000#15=;
         |SI FSalida ! 0;
             |CIERRA #15;
             |ACABA;
         |FINSI;

         |PINPA #0#901;
         nPanta = FSalida;

         #901#0 = #15#2;
         #901#1 = #15#5;

         |C_V #abxz0001#102, 1, "N";

         efFechaDocu  = #15#7;
         enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
         aAlfa        = eaRutaDocumento + "/" + (("00000000" + #15#0) % -108) + (("0000" + #15#1) % -104) + ".txt";

         |SI #514#21 = "C";
             |XABRE "U", aAlfa, nHandle;
         |SINO;
             |XABRE "CU", aAlfa, nHandle;
         |FINSI;

         FSalida     = 1;
         nCampo      = 2;
         |PARA;  |SI  FSalida ] 0;  |HACIENDO;
                 |XLEE nHandle, 254, aAlfa1;
                 |SI FSalida < 0; |O nCampo > 101; |SAL;  |FINSI;

                 aAlfa1     = aAlfa1 % 170;
                 |HAZ QuitaBr;
         |SIGUE;
         |XCIERRA nHandle;

         nRango = 4 + 8 + 16 + 32 + 128;

         #906#0 = #15#4;
         |LEE 101#906=;
         |SI FSalida ! 0;
             #906#0 = #15#4;
             |GRABA 020#906n;
             |LIBERA #906;
         |FINSI;

         |LINEAL_SIMPLE #1#906, nRango, 0714, 1265, NULL, NULL, EventoPanta;
         nGrid = FSalida;

         |PINDA #0#901;

         |LEETECLA aAlfa;

         |ACABA;
     |FINSI;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO ! "";
         |HAZ TrataParametros;
         |ACABA;
     |FINSI;

     aEsDeNuevo = "N";

     |PINPA #0#901;
     nPanta = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{136}}", 1596, 1598, Browse;
     nSubBoton1 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Contactos Expediente", 0672, 0790, ContactosExpe;
     nSubBoton4 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Nuevo contacto", 0972, 1090, NuevoContacto;
     nSubBoton2 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Borrar contacto", 1272, 1390, BorrarContacto;
     nSubBoton3 = FSalida;

     |SI enNumExpeCorreo = 0;
          |ESTADO_CONTROL nSubBoton4, "DISABLE";
     |SINO;
          |ESTADO_CONTROL nSubBoton4, "ENABLE";
     |FINSI;

     |C_M #901#1, 1, "S";
     |ESTADO_CONTROL nSubBoton1, "ENABLE";

     |SI eaFichAdjunto  ! "";
         |C_M #901#1, 1, "N";
         |ESTADO_CONTROL nSubBoton1, "DISABLE";
         #901#1 = eaFichAdjunto;
     |FINSI;

     nRango = 4 + 8 + 16 + 32 + 128;

     |LINEAL_SIMPLE #1#906, nRango, 0714, 1265, NULL, NULL, EventoPanta;
     nGrid = FSalida;

     |SI enExped ! 0;
         |ABRE #1;
         #1#0 = enExped;
         |LEE 000#1=;
         |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
         |CIERRA #1;

         aAlfa  = "N/REF: " + enExped;                  |QBF aAlfa;
         aAlfa  = aAlfa + "       S/REF:" + #1#38;      |QBF aAlfa;
         #901#0 = aAlfa;
     |FINSI;

     aExtension = #901#1;
     |QBF aExtension;
     aExtension = aExtension % -104;
     |SI aExtension = ".doc"; |O aExtension = ".DOC";
          ||TODO CCC. Pinta Label
          aTextoLabel = "Formato";
          aTextoLabel = "LABEL,{{001}}" + aTextoLabel;
          |CONTROL_SIMPLE nPanta, aTextoLabel, 1686, 1698, NULL;
          aTextoLabel = "PDF";
          aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
          |CONTROL_SIMPLE nPanta, aTextoLabel, 1790, 1798, NULL;
          aTextoLabel = "Word";
          aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
          |CONTROL_SIMPLE nPanta, aTextoLabel, 1890, 1898, NULL;

          |C_M #abxz0001#102, 1, "S";
          |C_V #abxz0001#102, 1, "S";
     |SINO;
          |C_M #abxz0001#102, 1, "N";
          |C_V #abxz0001#102, 1, "N";
     |FINSI;

     |PINDA #0#901;
     |ENDATOS #1#901;

     |FIN_CONTROL_WINDOWS nSubBoton1;
     |FIN_CONTROL_WINDOWS nSubBoton2;
     |FIN_CONTROL_WINDOWS nSubBoton3;
     |FIN_CONTROL_WINDOWS nSubBoton4;

     |PULSATECLA;
|FPRO;
