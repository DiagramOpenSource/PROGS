|FICHEROS;
     abom0014 #14;
     abom0015 #15;
     abom0016 #16;
     abom0514 #514;
     abom0518 #518;
     abow0020 #920;
     abow0021 #921;

     Referen@ #1000;
|FIN;

|VARIABLES;
     aFicTxt = "";
     nSwNoGrabar = 0;
     aMensaje = "";
     aParametro = "";
     nBoton2   = 0;
     nBoton3   = 0;
     nBoton4   = 0;
     nBoton5   = 0;
     nTecla    = 0;
     nHandle   = 0;
     nVariable = 0;
     nLong     = 0;
     nCaracter = 0;
     nPosi     = 0;
     nCont     = 0;
     nLinea    = 0;
     nGuarda   = 0;
     nError    = 0;
     nCalc     = 0;
     nPos1     = 0;
     nPos2     = 0;
     nPos      = 0;

     fFecha    = @;
     fFechaGuarda = @;

     aBr       = "";
     aPos      = "";
     aIPRemoto = "";
     aOrigen   = "";
     aDestino  = "";
     aAlfa     = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aAlfa3    = "";
     aAlfa4    = "";
     aAlfa5    = "";
     aAlfa6    = "";
     aRuta     = "";
     aLong     = "";
     aCaracter  = "";
     aOri       = "";
     aDes       = "";
     aBase      = "";
     aDocu      = "";
     aAbre      = "";
     aDSCorreo  = "";
     aUsu       = "";
     aPwd       = "";
     aProxy     = "";
     aTitulo    = "";
     aDirOri    = "";
     aDirDes    = "";
     aTexto     = "";
     aFic       = "";
     aMenLog    = "";
     aFichero   = "";
     aEsDeNuevo = "";
     aNombreFichero = "";

     &enTotalVaria    = 0;
     &eaNombreList    = "";
     &enCuadroIni     = 0;
     &enCuadroFin     = 0;
     &enCampoAncho    = 0;
     &enModoEdita     = 0;
     &enCodUbica      = 0;
     &enCuenta        = 0;
     &efFechaDocu     = @;
     &eaRutaDocumento = "";
     &eaFicheroEdita  = "";
     &eaFichAdjunto   = "";
     &eaUnidadBasico = "";

{101}&epPuntEdita     = "";

{1001}pPuntero = "";
|FIN;

|PROCESO TrataAdjunto;
    aAlfa = #Referen@#5;  |QBT aAlfa;
     |SI aAlfa = "";
         aDestino = aBase + "VACIO.TXT";
         |XABRE "BW", aDestino, nHandle;
         aAlfa1 = "Uso interno " + &13 + &10;
         |XGRABA nHandle, aAlfa1;
         |XCIERRA nHandle;
         eaFicheroEdita = "";
     |SINO;
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aFichero = "";

         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPosi     = (100 * nCaracter) + 1;
               aCaracter = aAlfa % nPosi;
               |SI aCaracter = "/";  |O aCaracter = "\";
                   aFichero = "";
               |SINO;
                   aFichero = aFichero + aCaracter;
               |FINSI;
         |SIGUE;

         aOrigen   = #Referen@#5;  |QBF aOrigen;
/*
         |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "ipabogad/documentos/";
         aAlfa = aOrigen - aAlfa; aAlfa = eaUnidadBasico + "/documentos/ipabogad/" + aAlfa;
         |XABRE "CE", aAlfa, nHandle;
         |SI FSalida ] 0;
            aOrigen = aAlfa;
            aDestino  = eaRutaDocumento + "/" + aFichero;

            |SI #514#21 ! "C";
                aIPRemoto = "";
                |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
                |SI aIPRemoto ! "";
                   |RECIBE_FICHERO aOrigen, aDestino;
                |SINO;
                   |COPIA_FICHERO aOrigen, aDestino;
                |FINSI;
            |SINO;
                |RECIBE_FICHERO aOrigen, aDestino;
            |FINSI;

            fFechaGuarda = efFechaDocu;
            efFechaDocu  = ~;
            enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
         |FINSI;
*/
         aDestino  = aBase + aFichero;
         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 ||ENVIA_FICHERO aOrigen, aDestino;
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         eaFicheroEdita = aFichero;
         aEsDeNuevo     = "S";
     |FINSI;
|FPRC;

|PROCESO CreaTxt;
     aAlfa = #921#1 + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE dsmow021;
     #921#1;
     ;
     0;
     999;
     ;
     NULL, CreaTxt;
|FIN;

|PROCESO PonFecha;
     fFecha = ~;
     aAlfa1 = fFecha % 102;
     aAlfa2 = fFecha % 402;
     aAlfa3 = fFecha % -104;

     |SI aAlfa2 = "01";  aAlfa2 = "Enero";       |FINSI;
     |SI aAlfa2 = "02";  aAlfa2 = "Febrero";     |FINSI;
     |SI aAlfa2 = "03";  aAlfa2 = "Marzo";       |FINSI;
     |SI aAlfa2 = "04";  aAlfa2 = "Abril";       |FINSI;
     |SI aAlfa2 = "05";  aAlfa2 = "Mayo";        |FINSI;
     |SI aAlfa2 = "06";  aAlfa2 = "Junio";       |FINSI;
     |SI aAlfa2 = "07";  aAlfa2 = "Julio";       |FINSI;
     |SI aAlfa2 = "08";  aAlfa2 = "Agosto";      |FINSI;
     |SI aAlfa2 = "09";  aAlfa2 = "Septiembre";  |FINSI;
     |SI aAlfa2 = "10";  aAlfa2 = "Octubre";     |FINSI;
     |SI aAlfa2 = "11";  aAlfa2 = "Noviembre";   |FINSI;
     |SI aAlfa2 = "12";  aAlfa2 = "Diciembre";   |FINSI;

     fFecha = fFecha % 1;
     aAlfa4 = fFecha % 1109;  |QBF aAlfa4;
     |HORA aAlfa5;

     aAlfa  = aAlfa4 + ", " + aAlfa1 + " de " + aAlfa2 + " de " + aAlfa3 + " a las " + aAlfa5;
|FPRC;

|PROCESO QuitaBr;
     aBr = aAlfa1 - "<br>";
     |SI FSalida = 0;
         epPuntEdita  = aAlfa1;
         IepPuntEdita = IepPuntEdita + 1;
         nCont        = nCont + 1;

         |ACABA;
     |FINSI;

     |PARA;  |SI;  |HACIENDO;
          aBr = aAlfa1 - "<br>";
          |SI FSalida = 0;  |SAL;  |FINSI;

          aAlfa2 = ("00" + FSalida) % -104;
          aPos   = aAlfa2 % 102;  nPos1 = aPos;
          aPos   = aAlfa2 % 302;  nPos2 = aPos;
          nPos   = ((nPos1 + nPos2) * 100) + 99;

          |SI nPos1 = 1;
              epPuntEdita  = "";
              IepPuntEdita = IepPuntEdita + 1;
              nCont        = nCont + 1;

              aAlfa1     = aBr;
          |SINO;
              nPos         = 100 + (nPos1 - 1);
              aAlfa2       = aAlfa1 % nPos;
              epPuntEdita  = aAlfa2;
              IepPuntEdita = IepPuntEdita + 1;
              nCont        = nCont + 1;

              |QBF aAlfa2;
              aAlfa1       = aAlfa1 - aAlfa2;

              |PARA;  |SI;  |HACIENDO;
                   aAlfa2 = aAlfa1 % 101;
                   |SI aAlfa2 ! " ";  |SAL;  |FINSI;

                   aAlfa1 = aAlfa1 - " ";
              |SIGUE;
          |FINSI;
     |SIGUE;

     |PARA;  |SI;  |HACIENDO;
             aAlfa2 = aAlfa1 % 101;
             |SI aAlfa2 ! " ";  |SAL;  |FINSI;

             aAlfa1 = aAlfa1 - " ";
     |SIGUE;

     |SI aAlfa1 ! "";
         epPuntEdita  = aAlfa1;
         IepPuntEdita = IepPuntEdita + 1;
         nCont        = nCont + 1;
     |FINSI;
|FPRC;


|PROCESO EditaCuerpo;
     |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
           IepPuntEdita  = epPuntEdita1 <-;
           IepPuntEdita = IepPuntEdita + (nVariable - 1);

           epPuntEdita  = "";
     |SIGUE;

     efFechaDocu  = #16#7;
     enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
     aAlfa        = eaRutaDocumento + "/" + (("00000000" + #16#0) % -108) + (("0000" + #16#1) % -104) + ".txt";
     IepPuntEdita = epPuntEdita1 <-;

     |SI #514#21 = "C";
         |XABRE "U", aAlfa, nHandle;
     |SINO;
         |XABRE "CU", aAlfa, nHandle;
     |FINSI;

     nSwNoGrabar = 0;
     nCont = 1; FSalida = 1;
     |PARA;  |SI  FSalida ] 0;  |HACIENDO;
             |XLEE nHandle, 254, aAlfa1;
             |SI FSalida < 0; |O nCont > 100; |SAL;  |FINSI;

             aAlfa1 = aAlfa1 % 170;
             |HAZ QuitaBr;

             |SI nCont = 100;  nSwNoGrabar = 1;  |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     enTotalVaria  = 99;
     eaNombreList  = "";
     enCuadroIni   = 0909;
     enCuadroFin   = 2280;
     enCampoAncho  = 70;
     enModoEdita   = 1;

     |PUSHV  0501 2380;
     |BLANCO 1009 2279;
     |HAZ Edita;
     |POPV;

     |SI nSwNoGrabar = 0;

          efFechaDocu  = #16#7;
          enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
          aAlfa        = eaRutaDocumento + "/" + (("00000000" + #16#0) % -108) + (("0000" + #16#1) % -104) + ".txt";
          IepPuntEdita = epPuntEdita1 <-;

          |SI #514#21 = "C";
              |XABRE "W", aAlfa, nHandle;
          |SINO;
              |XABRE "CW", aAlfa, nHandle;
          |FINSI;

          nCont = 1;
          |PARA;  |SI  nCont [ 100;  |HACIENDO;
                  aAlfa = epPuntEdita;
                  |XGRABA nHandle, aAlfa;
                  |SI FSalida < 0;  |SAL;  |FINSI;
                  IepPuntEdita = IepPuntEdita + 1;
                  nCont = nCont + 1;
          |SIGUE;

          |XCIERRA nHandle;
     |SINO;
          ||No lo grabo, es como lo hubiera abierto en modo lectura.
          ||Porque tiene mas de 100 lineas, que es el tope.
          ||No, le amplio el tope, porque si pongo por ejemplo 1000.
          ||me da error de numero de variables globales excedido.
     |FINSI;
|FPRC;

|PROCESO Manual;
     |PARA nVariable = 1;  |SI nVariable [ 1000;  |HACIENDO nVariable = nVariable + 1;
           IpPuntero  = pPuntero1 <-;
           IpPuntero = IpPuntero + (nVariable - 1);

           pPuntero  = "";
     |SIGUE;

     efFechaDocu  = #Referen@#7;
     enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
     aAlfa        = eaRutaDocumento + "/" + (("00000000" + #Referen@#0) % -108) + (("0000" + #Referen@#1) % -104) + ".txt";
     IpPuntero = pPuntero1 <-;

     |SI #514#21 = "C";
         |XABRE "U", aAlfa, nHandle;
     |SINO;
         |XABRE "CU", aAlfa, nHandle;
     |FINSI;

     nCont = 1; FSalida = 1;
     |PARA;  |SI  FSalida ] 0;  |HACIENDO;
             |XLEE nHandle, 254, aAlfa1;
             |SI FSalida < 0; |O nCont > 1000; |SAL;  |FINSI;

             aAlfa1 = aAlfa1 % 170;
             |HAZ QuitaBr;
     |SIGUE;
     |XCIERRA nHandle;

     |ABRE #921;
     |PARA nVariable = 1;  |SI nVariable [ 1000;  |HACIENDO nVariable = nVariable + 1;
           IpPuntero = pPuntero1 <-;
           IpPuntero = IpPuntero + (nVariable - 1);

           |DDEFECTO #921;
           #921#0 = nVariable;
           |LIBERA #921;
           |LEE 101#921=;
           |SI FSalida ! 0;  |GRABA 020#921b;  |FINSI;
           #921#1 = pPuntero;
           |GRABA 020#921a;
     |SIGUE;

     |PARA nVariable = 1000;  |SI nVariable ] 1;  |HACIENDO nVariable = nVariable - 1;
           #921#0 = nVariable;
           |LIBERA #921;
           |LEE 101#921=;
           aAlfa = #921#1;  |QBF aAlfa;

           |SI aAlfa ! "";  |SAL;  |FINSI;

           |BORRA 020#921a;
     |SIGUE;
     |CIERRA #921;

     aBase  = "";
     |DBASE aBase;  |QBF aBase;
     aBase  = aBase + "correos/";  |MKDIR aBase;
     nLinea = 1;
     |SI #Referen@#0 = 0;
         |ABRE #abom0014;
         |LEE 040#abom0014.u;
         |SI FSalida = 0;
             nLinea = #abom0014#0 + 1;
         |FINSI;
         |CIERRA #abom0014;
         aDocu = (("000000000000" + nLinea) % -112) + ".txt";
         aAbre = aBase + aDocu;
     |SINO;
         nLinea = 1;
         |ABRE #abom0015;
         #abom0015#0 = #Referen@#0;
         #abom0015#1 = 9999;
         |LEE 040#abom0015.];
         |SI FSalida = 0;
             |LEE 040#abom0015.a;
         |SINO;
             |LEE 040#abom0015.u;
         |FINSI;
         |SI FSalida = 0;  |Y #15#0 = #Referen@#0;
             nLinea = #abom0015#1 + 1;
         |FINSI;
         |CIERRA #abom0015;

         aDocu = (("00000000" + #Referen@#0) % -108) + (("0000" + nLinea) % -104) + ".txt";
         aAbre = aBase + aDocu;
     |FINSI;

     |XABRE "BW", aAbre, nHandle;
     |BUCLE dsmow021;
     |XCIERRA nHandle;

     |DELINDEX #921;

     |ABRE #514;
     |LEE 040#514p;
     |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
     |CIERRA #514;

     nGuarda      = enCodUbica;
     fFechaGuarda = efFechaDocu;
     efFechaDocu  = ~;
     enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
     enCodUbica   = nGuarda;
     efFechaDocu  = fFechaGuarda;

     aOrigen   = aAbre;
     aDestino  = eaRutaDocumento + "/" + aDocu;
     |SI #514#21 ! "C";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |SI eaFichAdjunto ! "";
         efFechaDocu = #Referen@#8;
         enCodUbica  = #Referen@#6;  |HAZ LeeUbicaciones;
         aOrigen       = #Referen@#5;  |QBF aOrigen;
         |QBF eaFicheroEdita;
         |SI eaFicheroEdita = "";
             aDestino  = aBase + eaFicheroEdita; || o un reenvio.
         |SINO;
             aAlfa = aOrigen; |QBF aAlfa;
             aAlfa = aAlfa - eaRutaDocumento; aAlfa = aAlfa - "-";
             aDestino  = aBase + aAlfa; || o un reenvio.
         |FINSI;

         |SI #514#21 ! "C";
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
             aDestino = aOrigen;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |HAZ TrataAdjunto;   || Cuando es correo nuevo.
     |FINSI;

     aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
     aUsu      = #518#6;           |QBF aUsu;        || usuario
     aPwd      = #518#7;           |QBF aPwd;        || password
     aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

     aTitulo   = #Referen@#2;       |QBF aTitulo;     || Asunto
     aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
     aDirDes   = #Referen@#4;       |QBF aDirDes;     || Direccion Destino
     aTexto    = "$$$$" + aAbre;
     aFic      = aDestino;

     aAlfa1 = "0000Enviando Correo [" + aDSCorreo + "] ...";
     |MENSA aAlfa1;

     |SI #514#20 = "S"
         aDirOri = "!" + aDirOri;
     |FINSI;

     |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFic;
     nError = FSalida;
     |BLIN 4;

     |SI nError < 0;
         aMenLog = "    Problemas al enviar correo ..." + nError;
         |MENAV aMenLog;
         |CONFI "0000SRevisar detalles?";
         |SI FSalida = 0;
             aAlfa6 = "0000IPDSCorreo: " + aDSCorreo;     |MENAV aAlfa6;
             aAlfa6 = "0000Servidor: " + aProxy;          |MENAV aAlfa6;
             aAlfa6 = "0000Dir.Origen: " + aDirOri;       |MENAV aAlfa6;
             aAlfa6 = "0000Dir.Destin: " + aDirDes;       |MENAV aAlfa6;
             |MENAV "0000Ninguno de estos 4 parametros deberia estar vacio.";
          |FINSI;

          |ACABA;
     |SINO;
          nLinea = 1;
          |SI #Referen@#0 = 0;
              |ABRE #14;
              |LEE 040#14u;
              |SI FSalida = 0;
                  nLinea = #14#0 + 1;
              |FINSI;
              |CIERRA #14;
              aDocu = (("00000000" + nLinea) % -108) + ".txt";
              aAbre = aBase + aDocu;
          |SINO;
              nLinea = 1;
              |ABRE #15;
              #15#0 = #Referen@#0;
              #15#1 = 9999;
              |LEE 040#15];
              |SI FSalida = 0;
                  |LEE 040#15a;
              |SINO;
                  |LEE 040#15u;
              |FINSI;
              |SI FSalida = 0;  |Y #15#0 = #Referen@#0;
                  nLinea = #15#1 + 1;
              |FINSI;
              |CIERRA #15;
          |FINSI;

          |HAZ PonFecha;
          |SI #Referen@#0 = 0;
              |ABRE #14;
              |DDEFECTO #14;
              #14#0 = nLinea;
              #14#2 = #Referen@#2;
              #14#3 = #Referen@#3;
              #14#4 = #Referen@#4;

              aAlfa = #Referen@#5; |QBF aAlfa;
              aAlfa = aAlfa - "/";
              |PARA; |SI FSalida ! 0; |HACIENDO;
                 nCalc = FSalida + 98; aAlfa = aAlfa % nCalc;
                 aAlfa = aAlfa - "/";
              |SIGUE;

              #14#5 = aAlfa;
              #14#6 = #Referen@#6;
              #14#7 = #Referen@#7;
              #14#8 = #Referen@#8;
              #14#9 = #Referen@#9;
              |GRABA 020#14n;
              |CIERRA #14;
          |SINO;
              |ABRE #15;
              |DDEFECTO #15;
              #15#0 = #Referen@#0;
              #15#1  = nLinea;
              #15#2 = #Referen@#2;
              #15#3 = #Referen@#3;
              #15#4 = #Referen@#4;

              aAlfa = #Referen@#5; |QBF aAlfa;
              aAlfa = aAlfa - "/";
              |PARA; |SI FSalida ! 0; |HACIENDO;
                   nCalc = FSalida + 98; aAlfa = aAlfa % nCalc;
                   aAlfa = aAlfa - "/";
              |SIGUE;

              #15#5 = aAlfa;
              #15#6 = #Referen@#6;
              #15#7 = #Referen@#7;
              #15#8 = #Referen@#8;
              #15#9 = #Referen@#9;
              |GRABA 020#15n;
              |CIERRA #15;
          |FINSI;

          aAlfa = #Referen@#2 - "Situacion expedientes a dia";
          |SI FSalida ! 0;
              |BORRA 020#Referen@.a;
          |SINO;
              #Referen@#11 = "S";
              |GRABA 020#Referen@.a;
          |FINSI;
     |FINSI;

     |FBORRA aAbre;
     |FBORRA aDestino;
|FPRC;

|PROCESO Automatico;
     efFechaDocu  = #Referen@#7;

     aBase = "";
     |DBASE aBase;  |QBF aBase;
     aBase  = aBase + "correos/";  |MKDIR aBase;
     eaRutaDocumento = aBase;

     |SI #Referen@#13 = "N";
          |PARA nVariable = 1;  |SI nVariable [ 1000;  |HACIENDO nVariable = nVariable + 1;
                IpPuntero  = pPuntero1 <-;
                IpPuntero = IpPuntero + (nVariable - 1);

                pPuntero  = "";
          |SIGUE;

          aAlfa        = eaRutaDocumento + "/" + (("00000000" + #Referen@#0) % -108) + (("0000" + #Referen@   #1) % -104) + ".txt";
          IpPuntero = pPuntero1 <-;

          |SI #514#21 = "C";
              |XABRE "U", aAlfa, nHandle;
          |SINO;
              |XABRE "CU", aAlfa, nHandle;
          |FINSI;

          nCont = 1; FSalida = 1;
          |PARA;  |SI  FSalida ] 0;  |HACIENDO;
                  |XLEE nHandle, 254, aAlfa1;
                  |SI FSalida < 0; |O nCont > 1000; |SAL;  |FINSI;

                  aAlfa1 = aAlfa1 % 170;
                  |HAZ QuitaBr;
          |SIGUE;
          |XCIERRA nHandle;

          |ABRE #921;
          |PARA nVariable = 1;  |SI nVariable [ 1000;  |HACIENDO nVariable = nVariable + 1;
                IpPuntero = pPuntero1 <-;
                IpPuntero = IpPuntero + (nVariable - 1);

                |DDEFECTO #921;
                #921#0 = nVariable;
                |LIBERA #921;
                |LEE 101#921=;
                |SI FSalida ! 0;  |GRABA 020#921b;  |FINSI;
                #921#1 = pPuntero;
                |GRABA 020#921a;
          |SIGUE;

          |PARA nVariable = 1000;  |SI nVariable ] 1;  |HACIENDO nVariable = nVariable - 1;
                #921#0 = nVariable;
                |LIBERA #921;
                |LEE 101#921=;
                aAlfa = #921#1;  |QBF aAlfa;

                |SI aAlfa ! "";  |SAL;  |FINSI;

                |BORRA 020#921a;
          |SIGUE;
          |CIERRA #921;

          aBase  = "";
          |DBASE aBase;  |QBF aBase;
          aBase  = aBase + "correos/";  |MKDIR aBase;
          nLinea = 1;
          |SI #Referen@#0 = 0;
              |ABRE #abom0014;
              |LEE 040#abom0014.u;
              |SI FSalida = 0;
                  nLinea = #abom0014#0 + 1;
              |FINSI;
              |CIERRA #abom0014;
              aDocu = (("000000000000" + nLinea) % -112) + ".txt";
              aAbre = aBase + aDocu;
          |SINO;
              nLinea = 1;
              |ABRE #abom0015;
              #abom0015#0 = #Referen@#0;
              #abom0015#1 = 9999;
              |LEE 040#abom0015.];
              |SI FSalida = 0;
                  |LEE 040#abom0015.a;
              |SINO;
                  |LEE 040#abom0015.u;
              |FINSI;
              |SI FSalida = 0;  |Y #15#0 = #Referen@#0;
                  nLinea = #abom0015#1 + 1;
              |FINSI;
              |CIERRA #abom0015;

              aDocu = (("00000000" + #Referen@#0) % -108) + (("0000" + nLinea) % -104) + ".txt";
              aAbre = aBase + aDocu;
          |FINSI;

          |XABRE "BW", aAbre, nHandle;
          |BUCLE dsmow021;
          |XCIERRA nHandle;

          |DELINDEX #921;
     |FINSI;

     |ABRE #514;
     |LEE 040#514p;
     |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
     |CIERRA #514;

     |SI #Referen@#13 = "N";
          nGuarda      = enCodUbica;
          fFechaGuarda = efFechaDocu;
          efFechaDocu  = ~;
          enCodUbica   = #514#9;  |HAZ LeeUbicaciones;
          enCodUbica   = nGuarda;
          efFechaDocu  = fFechaGuarda;

          aOrigen   = aAbre;
          aDestino  = eaRutaDocumento + "/" + aDocu;
          |SI #514#21 ! "C";
              aIPRemoto = "";
              |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
              |SI aIPRemoto ! "";
                  |ENVIA_FICHERO aOrigen, aDestino;
              |SINO;
                  |COPIA_FICHERO aOrigen, aDestino;
              |FINSI;
          |SINO;
              |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          |SI eaFichAdjunto ! "";
              efFechaDocu = #Referen@#8;
              enCodUbica  = #Referen@#6;  |HAZ LeeUbicaciones;
              ||aOrigen       = eaRutaDocumento + "/" + #Referen@#5;  |QBF aOrigen;
              aOrigen       = #Referen@#5;  |QBF aOrigen;
              ||aDestino  = aBase + eaFicheroEdita; || o un reenvio.
              |QBF eaFicheroEdita;
              |SI eaFicheroEdita = "";
                 aDestino  = aBase + eaFicheroEdita; || o un reenvio.
              |SINO;
                 aAlfa = aOrigen; |QBF aAlfa;
                 aAlfa = aAlfa - eaRutaDocumento; aAlfa = aAlfa - "-";
                 aDestino  = aBase + aAlfa; || o un reenvio.
              |FINSI;

              |SI #514#21 ! "C";
                  aIPRemoto = "";
                  |IP_REMOTO aIPRemoto;   |QBT aIPRemoto;
                  |SI aIPRemoto ! "";
                      |RECIBE_FICHERO aOrigen, aDestino;
                  |SINO;
                      |COPIA_FICHERO aOrigen, aDestino;
                  |FINSI;
                  aDestino = aOrigen;
              |SINO;
                  |COPIA_FICHERO aOrigen, aDestino;
              |FINSI;
          |SINO;
              |HAZ TrataAdjunto;   || Cuando es correo nuevo.
          |FINSI;
     |SINO;
          ||ARA
          aFicTxt = (("00000000" + #Referen@#0) % -108) + (("0000" + #Referen@#1) % -104) + ".txt";
          aAbre = eaRutaDocumento + aFicTxt;
          aDestino = aAbre;
     |FINSI;

     aDSCorreo = #518#2;           |QBF aDSCorreo;   || Direccion IP
     aUsu      = #518#6;           |QBF aUsu;        || usuario
     aPwd      = #518#7;           |QBF aPwd;        || password
     aProxy    = #518#4;           |QBF aProxy;      || servidor proxy

     aTitulo   = #Referen@#2;       |QBF aTitulo;     || Asunto
     aDirOri   = #518#5;            |QBF aDirOri;     || Direccion Origen
     aDirDes   = #Referen@#4;       |QBF aDirDes;     || Direccion Destino
     aTexto    = "$$$$" + aAbre;
     aFic      = aDestino;

     aAlfa1 = "0000Enviando Correo [" + aDSCorreo + "] ...";
     |MENSA aAlfa1;

     |SI #514#20 = "S"
         aDirOri = "!" + aDirOri;
     |FINSI;

     |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFic;
     nError = FSalida;
     |BLIN 4;

     |SI nError < 0;
          aMenLog = "    Problemas al enviar correo ..." + nError;
          |MENAV aMenLog;
          |CONFI "0000SRevisar detalles?";
          |SI FSalida = 0;
             aAlfa6 = "0000IPDSCorreo: " + aDSCorreo;     |MENAV aAlfa6;
             aAlfa6 = "0000Servidor: " + aProxy;          |MENAV aAlfa6;
             aAlfa6 = "0000Dir.Origen: " + aDirOri;       |MENAV aAlfa6;
             aAlfa6 = "0000Dir.Destin: " + aDirDes;       |MENAV aAlfa6;
             |MENAV "0000Ninguno de estos 4 parametros deberia estar vacio.";
          |FINSI;
          |FBORRA aAbre;
          |FBORRA aDestino;
          |ACABA;
     |SINO;
          |SI #Referen@#13 = "N";
               nLinea = 1;
               |SI #Referen@#0 = 0;
                   |ABRE #14;
                   |LEE 040#14u;
                   |SI FSalida = 0;
                       nLinea = #14#0 + 1;
                   |FINSI;
                   |CIERRA #14;
                   aDocu = (("00000000" + nLinea) % -108) + ".txt";
                   aAbre = aBase + aDocu;
               |SINO;
                   nLinea = 1;
                   |ABRE #15;
                   #15#0 = #Referen@#0;
                   #15#1 = 9999;
                   |LEE 040#15];
                   |SI FSalida = 0;
                       |LEE 040#15a;
                   |SINO;
                       |LEE 040#15u;
                   |FINSI;
                   |SI FSalida = 0;  |Y #15#0 = #Referen@#0;
                       nLinea = #15#1 + 1;
                   |FINSI;
                   |CIERRA #15;
               |FINSI;

               |HAZ PonFecha;
               |SI #Referen@#0 = 0;
                   |ABRE #14;
                   |DDEFECTO #14;
                   #14#0 = nLinea;
                   #14#2 = #Referen@#2;
                   #14#3 = #Referen@#3;
                   #14#4 = #Referen@#4;

                   aAlfa = #Referen@#5; |QBF aAlfa;
                   aAlfa = aAlfa - "/";
                   |PARA; |SI FSalida ! 0; |HACIENDO;
                      nCalc = FSalida + 98; aAlfa = aAlfa % nCalc;
                      aAlfa = aAlfa - "/";
                   |SIGUE;

                   #14#5 = aAlfa;
                   #14#6 = #Referen@#6;
                   #14#7 = #Referen@#7;
                   #14#8 = #Referen@#8;
                   #14#9 = #Referen@#9;
                   |GRABA 020#14n;
                   |CIERRA #14;
               |SINO;
                   |ABRE #15;
                   |DDEFECTO #15;
                   #15#0 = #Referen@#0;
                   #15#1  = nLinea;
                   #15#2 = #Referen@#2;
                   #15#3 = #Referen@#3;
                   #15#4 = #Referen@#4;

                   aAlfa = #Referen@#5; |QBF aAlfa;
                   aAlfa = aAlfa - "/";
                   |PARA; |SI FSalida ! 0; |HACIENDO;
                      nCalc = FSalida + 98; aAlfa = aAlfa % nCalc;
                      aAlfa = aAlfa - "/";
                   |SIGUE;

                   #15#5 = aAlfa;
                   #15#6 = #Referen@#6;
                   #15#7 = #Referen@#7;
                   #15#8 = #Referen@#8;
                   #15#9 = #Referen@#9;
                   |GRABA 020#15n;
                   |CIERRA #15;
               |FINSI;
          |FINSI;

          aAlfa = #Referen@#2 - "Situacion expedientes a dia";
          |SI FSalida ! 0;
              |BORRA 020#Referen@.a;
          |SINO;
              #Referen@#11 = "S";
              |GRABA 020#Referen@.a;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EnviaCorreo;
     enCuenta = #Referen@#12;
     |ABRE #518;
     #518#0 = enCuenta;
     |LEE 040#518=;
     |SI FSalida ! 0;
         |SI aParametro = "";
             aMensaje = "0000No existe la Cuenta de Correo. [" + enCuenta + "]";
             |MENAV aMensaje;
         |FINSI;

         |CIERRA #518;
        |ACABA;
     |FINSI;
     |CIERRA #518;

     |SI aParametro = "";
         |HAZ Manual;
     |SINO;
         |HAZ Automatico;
     |FINSI;
|FPRC;

|DEFBUCLE EnviaCorreo;
#Referen@#2003;
;
"N", 000000000, 0001;
"N", 999999999, 9999;
be;
NULL,EnviaCorreo;
|FIN;

|PROCESO Tipo11;  |TIPO 11;
     nTecla = FSalida;

     |SI nTecla = 10;
         |HAZ EditaCuerpo;
     |FINSI;

     |SI nTecla = 11;
         |SI #16#6 = 0;
              |MENAV "     No hay Fichero Adjunto";
              |ACABA;
         |FINSI;

         |SI #16#9 = "N";
             eaFicheroEdita = #16#5;  |QBF eaFicheroEdita;
             |SI eaFicheroEdita ! "";
                 efFechaDocu    = #16#8;
                 enCodUbica     = #16#6;  |HAZ LeeUbicaciones;
                 eaFicheroEdita = #16#5;  |QBF eaFicheroEdita;
                 aAlfa1 = eaRutaDocumento + "/";
                 eaFicheroEdita = eaFicheroEdita - aAlfa1;
                 |HAZ AbreDocumento;
             |SINO;
                 |MENAV "     No hay Fichero Adjunto";
                 |ACABA;
             |FINSI;
         |SINO;
             aAlfa = #16#5;  |QBF aAlfa;
             |SI aAlfa ! "";
                 aLong          = aAlfa % 0;
                 nLong          = aLong;
                 aRuta          = "";
                 aNombreFichero = "";

                 |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                       nPosi     = (100 * nCaracter) + 1;
                       aCaracter = aAlfa % nPosi;
                       |SI aCaracter = "/";  |O aCaracter = "\";
                           aNombreFichero = "";
                       |SINO;
                           aNombreFichero = aNombreFichero + aCaracter;
                       |FINSI;
                 |SIGUE;

                 efFechaDocu = #16#8;
                 enCodUbica  = #16#6;  |HAZ LeeUbicaciones;
                 aAlfa       = eaRutaDocumento + "/" + aNombreFichero;  |QBF aAlfa;

                 |SI #514#21 ! "C";
                     aLong    = aAlfa % 0;
                     nLong    = aLong;
                     aRuta    = "";

                     |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                           nPosi     = (100 * nCaracter) + 1;
                           aCaracter = aAlfa % nPosi;
                           |SI aCaracter = "/";
                               aCaracter = "\";
                           |FINSI;
                           aRuta = aRuta + aCaracter;
                     |SIGUE;
                     aAlfa = aRuta;
                 |SINO;
                     aOrigen = aAlfa;
                     aDestino = eaUnidadBasico + "\DOCUMENTOS\IPABOGAD\" + aNombreFichero;  |QBF aDestino;
                     |ENVIA_FICHERO aOrigen, aDestino;

                     aAlfa = aDestino;
                 |FINSI;

                 aAlfa = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
                 |RSYSTEM aAlfa;

                 |RFBORRA aDestino;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nTecla = 12;
         |CONFI "0000NEsta Seguro de Borrar el Correo ";
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         efFechaDocu = #16#7;
         enCodUbica  = #514#9;  |HAZ LeeUbicaciones;
         aAlfa       = eaRutaDocumento + "/" + (("00000000" + #16#0) % -108) + (("0000" + #16#1) % -104) + ".txt";
         |SI #514#21 ! "C";
             |RFBORRA aAlfa;
         |SINO;
             |FBORRA aAlfa;
         |FINSI;

         |LEE 101#16=;
         |SI FSalida = 0;
             |BORRA 020#16a;
         |FINSI;
         |LIBERA #16;

         |PONCONTROL 23, "SI";
     |FINSI;

     |SI nTecla = 13;

          aAlfa = "    N" + &191 + " Desea enviar los correos pendientes ? ";
          |CONFI aAlfa;
          |SI FSalida ! 0; |ACABA; |FINSI;

          |DDEF aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "abom0016.mas";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida = 0;
             |ABRE #Referen@;
             |BUCLE EnviaCorreo;
             |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
          |FINSI;

          |PONCONTROL 23, "SI";
     |FINSI;
|FPRC;

|RUTINA ClaveBaja14;
     #16#0  = 0;
     #16#1  = 1;
     #16#11 = "N";
|FRUT;

|RUTINA ClaveAlta14;
     #16#0  = 999999999;
     #16#1  = 9999;
     #16#11 = "N";
|FRUT;

|PROCESO Boton2;
     |PTEC 824;
|FPRC;

|PROCESO Boton3;
     |PTEC 825;
|FPRC;

|PROCESO Boton4;
     |PTEC 826;
|FPRC;

|PROCESO Boton5;
     |PTEC 827;
|FPRC;

|PROCESO PonBoton;
     |CONTROL_SIMPLE 0, "BOTON,F2 Visualizar Cuerpo", 2304, 2321, Boton2;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,F3 Visualizar Adjunto", 2323, 2340, Boton3;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,F4 Borrar Correo ", 2342, 2359, Boton4;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,F5 Enviar Todo ", 2361, 2378, Boton5;
     nBoton5 = FSalida;
|FPRC;

|PROCESO FinBoton;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;

     |PULSATECLA;
|FPRC;

|PROGRAMA;
     |HAZ LeeUnidadBasico;

     aParametro = PARAMETRO;
     |QBF aParametro;

     |ABRE #514;
     |LEE 040#514p;
     |SI FSalida ! 0;  |DDEFECTO #514;  |FINSI;
     |CIERRA #514;

     |SI #514#1 = "N";  |Y aParametro = "";
         |MENAV "     No tiene Configurado el Correo en la Aplicacion";
         |ACABA;
     |FINSI;

     |CLS;

     |SI aParametro = "";
          |CABEZA "Salida de Correos";
          |HAZ PonBoton;
          |ENTLINEAL #2#16, -2, 4, 21, 1, ClaveBaja14, ClaveAlta14;
          |HAZ FinBoton;
     |SINO;
          |DDEF aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "abom0016.mas";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida = 0;
          |ABRE #Referen@;
          |BUCLE EnviaCorreo;
          |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
          |FINSI;
     |FINSI;
|FPRO;
