|FICHEROS;
   asprepar;

   ascontro;
   ascontrt;
   asconcep;
   asprepa1;

   ascabmin;
   aslinmin;
   asclient;

   asenlcon;
   asempcon;
   asw00001;
   aslinmil;
   asconlin;

   asm00013;
|FIN;

|VARIABLES;
    nVariable    = 0;
    nFichero     = 0;
    nCliente     = 0;
    aSeccion     = "";
    aConcepto    = "";

     c_clie      = "";
     fijo        = "";
     sw          = 0;
     sw_existe   = 0;
     factura_1   = 0;
     factura_2   = 0;
     serie_1     = "";
     serie_2     = "";
     fecha       = @;
     varalf      = "";
     conver      = "";
     conver1     = "";
     conver2     = "";
     alfa1       = "";
     alfa2       = "";
     nIVA1       = 0;
     nIVA2       = 0;
     nDCliente   = 0;
     nHCliente   = 0;
     nSwLinea    = 0;
     nSwSalAnt   = 0;


     &enErrorFac = 0;
     &enTipo     = 0;
     &enCliente  = 0;
|FIN;

|INCLUYE pastil_i;
|INCLUYE agicon_i;

|PROCESO Tipo7C0; |TIPO 7;
    #asprepar#0 = enTipo; |PINTA #asprepar#0;
|FPRC;

|PROCESO VerFecha;
    fecha = ~;
    alfa2 = fecha;
    alfa2 = alfa2 % -104;
    nume2 = alfa2;

    alfa1 = #asprepar#2;
    alfa1 = alfa1 % -104;
    nume1 = alfa1;
    |SI nume1 < 1990;
        |MENAV "    Fecha Erronea";
        |ERROR;
    |SINO;
        |SI nume2 ! nume1;
            |MENAV "    La Fecha no correspondel al A¤o en Curso.";
        |FINSI;
    |FINSI;
|FPRC;

|| ////////////////// Borrar preparacion Anterior
|PROCESO desprepa_t1;
    |SI sw = 0;
        sw = 1;
        |SI #ascabmin#22 ! 0; |O #ascabmin#18 ! 0;
            factura_1 = #ascabmin#28;
        |SINO;
            factura_2 = #ascabmin#28;
        |FINSI;
    |FINSI;

    |SI #asprepar#0 = #asprepar#3;
        |SI #ascabmin#28 < factura_1; |Y #ascabmin#28 ! 0;
            factura_1 = #ascabmin#28;
        |FINSI;
    |SINO;
        |SI #ascabmin#22 ! 0; |O #ascabmin#18 ! 0;
            |SI #ascabmin#28 < factura_1; |Y #ascabmin#28 ! 0;
                factura_1 = #ascabmin#28;
            |FINSI;
        |SINO;
            |SI factura_2 = 0; |Y  #ascabmin#28 ! 0;
                factura_2 = #ascabmin#28;
            |FINSI;

            |SI #ascabmin#28 < factura_2; |Y #ascabmin#28 ! 0;
                factura_2 = #ascabmin#28;
            |FINSI;
        |FINSI;
    |FINSI;

    #ascabmin#27 = "<<";
    #ascabmin#28 = 0;
    #ascabmin#29 = "01.01.1900";
    |GRABA 020#ascabmin.a;
    |LIBERA #ascabmin;
|FPRC;

|DEFBUCLE asprepar_t1;
     #ascabmin#1;
     ;
     #asprepar#0, nDCliente;
     #asprepar#0, nHCliente;
     be;
     NULL, desprepa_t1;
|FIN;
|| //////////////////////////////////////////////////////////////

|| //////////////// Preparar factura
|PROCESO HistCuotCli;
    |SALVA_FICHA #asm00013;
    #asm00013#2 = #ascabmin#27;
    #asm00013#3 = #ascabmin#28;
    |GRABA 020#asm00013.n;
    |REPON_FICHA #asm00013;
    |BORRA 020#asm00013.a;
|FPRC;

|DEFBUCLE HistCuotCli;
    #asm00013#1;
    ;
    #ascabmin#0, #ascabmin#1, "  ", 00000, "N", 001, 01;
    #ascabmin#0, #ascabmin#1, "  ", 00000, "N", 999, 99;
    be;
    NULL,HistCuotCli;
|FIN;

|PROCESO LeoAsLinMin;
    #asconcep#0 = #aslinmin#4;
    #asconcep#1 = #aslinmin#5;
    |LEE 040#asconcep.=;
    |SI FSalida = 0; |Y #asconcep#3 = "A";
        nSwSalAnt = 1;
    |FINSI;
    nSwLinea = nSwLinea + 1;
|FPRC;

|DEFBUCLE LeoAsLinMin;
    #aslinmin#1;
    ;
    #ascabmin#0, #ascabmin#1, 001;
    #ascabmin#0, #ascabmin#1, 999;
    e;
    NULL, LeoAsLinMin;
|FIN;

|PROCESO ponefac;
     p_imp = #asprepar#2;
     |HAZ pastilla;

     |SI #ascabmin#28 = 0;|Y p_cen = 0;

          nSwLinea  = 0;
          nSwSalAnt = 0;
          |SI #asprepar#4 = "N";
              |BUCLE LeoAsLinMin;
          |FINSI;

          |SI nSwSalAnt = 1; |Y nSwLinea = 1;
              #ascabmin#27 = "";
              #ascabmin#28 = 0;
          |SINO;
              |SI #asprepar#0 = #asprepar#3;
                  factura_1    = factura_1 + 1;
                  #ascabmin#27 = serie_1;
                  #ascabmin#28 = factura_1;
                  #ascabmin#29 = #asprepar#2;
              |SINO;
                  |SI #ascabmin#22 ! 0; |O #ascabmin#18 ! 0;
                      factura_1    = factura_1 + 1;
                      #ascabmin#27 = serie_1;
                      #ascabmin#28 = factura_1;
                      #ascabmin#29 = #asprepar#2;
                  |SINO;
                      factura_2 = factura_2 + 1;
                      #ascabmin#27 = serie_2;
                      #ascabmin#28 = factura_2;
                      #ascabmin#29 = #asprepar#2;
                  |FINSI;
              |FINSI;
          |FINSI;

          |GRABA 020#ascabmin.a;
          |LIBERA #ascabmin;

          |BUCLE HistCuotCli;
     |FINSI;
|FPRC;

|DEFBUCLE asprepar1;
     #ascabmin#1;
     ;
     #asprepar#0, nDCliente;
     #asprepar#0, nHCliente;
     be;
     NULL, ponefac;
|FIN;
|| //////////////////////////////////////////////////////////////////////
|PROCESO existe;
     sw_existe = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE ascabmin;
     #ascabmin#1;
     ;
     00, #asclient#0;
     99, #asclient#0;
     e;
     NULL, existe;
|FIN;

|PROCESO RecogeTexto;
     |ABRE #aslinmil;
     |ABRE #asconlin;
     |PARA nVariable = 1;  |SI nVariable [ 100;  |HACIENDO nVariable = nVariable + 1;
           #asconlin#0 = nFichero;
           #asconlin#1 = nCliente;
           #asconlin#2 = aSeccion;
           #asconlin#3 = aConcepto;
           #asconlin#4 = nVariable;
           |LEE 040#asconlin.=;
           |SI FSalida = 0;
               #aslinmil#0 = #aslinmin#0;
               #aslinmil#1 = #aslinmin#1;
               #aslinmil#2 = #aslinmin#2;
               #aslinmil#3 = nVariable;
               #aslinmil#4 = #asconlin#5;
               |GRABA 020#aslinmil.n;
               |LIBERA #aslinmil;
           |FINSI;
     |SIGUE;
     |CIERRA #aslinmil;
     |CIERRA #asconlin;
|FPRC;

|PROCESO saldo;

     |SI #asclient#24 = 0; |ACABA; |FINSI;

     sw_existe = 0;     || si hay una minuta de este cliente, salta
     |BUCLE ascabmin;
     |SI sw_existe = 1; |ACABA; |FINSI;

     |SI #asprepar#4 = "S";
         factura_2 = factura_2 + 1;
     |FINSI;

     |ABRE #ascabmin;
     |DDEFECTO #ascabmin;
     #ascabmin#0  = #asprepar#0;
     #ascabmin#1  = #asclient#0;
     #ascabmin#2  = #asclient#1;
     #ascabmin#3  = #asclient#2;
     #ascabmin#4  = #asclient#3;
     #ascabmin#5  = #asclient#4;
     #ascabmin#6  = #asclient#5;
     #ascabmin#7  = #asclient#6;
     #ascabmin#8  = #asclient#7;
     #ascabmin#9  = #asclient#8;
     #ascabmin#10 = #asclient#15;
     #ascabmin#11 = #asclient#16;
     #ascabmin#12 = #asclient#17;
     #ascabmin#13 = #asclient#11;
     #ascabmin#14 = #asclient#12;
     #ascabmin#15 = #asclient#13;
     #ascabmin#16 = #asclient#14;
     |SI #asprepar#4 = "S";
         #ascabmin#27 = serie_2;
         #ascabmin#28 = factura_2;
         #ascabmin#29 = #asprepar#2;
     |FINSI;

     #aslinmin#0  = #ascabmin#0;
     #aslinmin#1  = #ascabmin#1;
     #aslinmin#2  = 5;
     #aslinmin#3  = 0;
     #aslinmin#4  = #asconcep#0;
     #aslinmin#5  = #asconcep#1;
     #aslinmin#6  = #asconcep#2;
     #aslinmin#7  = #asconcep#16;
     #aslinmin#8  = #asconcep#17;
     #aslinmin#9  = #asconcep#18;
     #aslinmin#10 = #asconcep#3;
     #aslinmin#11 = 1;
     #aslinmin#12 = -#asclient#24;
     #aslinmin#13 = -#asclient#24;
     #aslinmin#14 = "G";
     #aslinmin#15 = "00.00.0000";
     |GRABA 140#aslinmin.n;
     |LIBERA #aslinmin;

     nFichero  = 1;
     nCliente  = 0;
     aSeccion  = #aslinmin#4;
     aConcepto = #aslinmin#5;
     |HAZ RecogeTexto;

     #ascabmin#19 = #aslinmin#13;
     #ascabmin#26 = #ascabmin#24 -#ascabmin#19 - #ascabmin#25;
     |GRABA 140#ascabmin.n;
     |LIBERA #ascabmin;
     |CIERRA #ascabmin;

     |HAZ graba_con;
|FPRC;

|DEFBUCLE asclient;
     #asclient#1;
     ;
     nDCliente;
     nHCliente;
     e;
     NULL, saldo;
|FIN;

|PROCESO graba_con;
     |ABRE #asenlcon;
     #asenlcon#0 = #aslinmin#4;
     #asenlcon#1 = #aslinmin#5;
     |LEE 040#asenlcon.=;
     |SI FSalida ! 0;
         |CIERRA #asenlcon;
         |ACABA;
     |FINSI;
     |CIERRA #asenlcon;

     |ABRE #asempcon;
     |LEE 040#asempcon.p;
     |SI FSalida ! 0; |DDEFECTO #asempcon; |FINSI;
     |CIERRA #asempcon;

     c_clie  = #aslinmin#1;
     c_clie  = ("00000" + c_clie) % -105;
     fijo    = #asempcon#3; |QBF fijo;
     fijo    = fijo + c_clie;
     conver1 = #aslinmin#15 % 0102;
     conver2 = #aslinmin#15 % 0402;
     conver  = conver1 + conver2;
     c_fecha = conver;
     c_fecha = ("0000" + c_fecha) % -104;

     |ABRE #asw00001;
     #asw00001#0 = #aslinmin#0;
     #asw00001#1 = #aslinmin#1;
     #asw00001#2 = #aslinmin#2;
     |LIBERA #asw00001;
     |LEE 140#asw00001.=;
     |SI FSalida = 0;
        #asw00001#3  = #asempcon#1;
        #asw00001#4  = #asempcon#2;
        #asw00001#5  = c_fecha;
        #asw00001#6  = fijo;
        #asw00001#7  = #asenlcon#2;
        #asw00001#8  = #asenlcon#6;
        #asw00001#9  = #asenlcon#3;
        #asw00001#10 = #asenlcon#4;
        #asw00001#11 = #aslinmin#13;
        #asw00001#12 = #asenlcon#5;
        #asw00001#13 = 0;
        #asw00001#14 = "";
        |GRABA 140#asw00001.a;
     |SINO;
        |DDEFECTO #asw00001;
        #asw00001#0  = #aslinmin#0;
        #asw00001#1  = #aslinmin#1;
        #asw00001#2  = #aslinmin#2;
        #asw00001#3  = #asempcon#1;
        #asw00001#4  = #asempcon#2;
        #asw00001#5  = c_fecha;
        #asw00001#6  = fijo;
        #asw00001#7  = #asenlcon#2;
        #asw00001#8  = #asenlcon#6;
        #asw00001#9  = #asenlcon#3;
        #asw00001#10 = #asenlcon#4;
        #asw00001#11 = #aslinmin#13;
        #asw00001#12 = #asenlcon#5;
        #asw00001#13 = 0;
        #asw00001#14 = "";
        |GRABA 140#asw00001.n;
     |FINSI;
     |CIERRA #asw00001;
|FPRC;

|| /////////////////////// Actualiza Numero de Factura en Tipo Facturacion
|PROCESO grabacon_1;
     |ABRE #ascontrt;
     #ascontrt#0 = #asprepar#0;
     |LEE 101#ascontrt.=;
     |SI FSalida ! 0;
         |DDEFECTO #ascontrt;
         #ascontrt#0 = #asprepar#0;
         |GRABA 020#ascontrt.b;
     |FINSI;

     #ascontrt#2 = factura_1;
     |GRABA 020#ascontrt.a;
     |LIBERA #ascontrt;
|FPRC;

|PROCESO grabacon_2;
    |ABRE #ascontrt;
    #ascontrt#0 = #asprepar#3;
    |LEE 101#ascontrt.=;
    |SI FSalida ! 0;
        |DDEFECTO #ascontrt;
        #ascontrt#0 = #asprepar#3;
        |GRABA 020#ascontrt.b;
    |FINSI;

    #ascontrt#2 = factura_2;
    |GRABA 020#ascontrt.a;
    |LIBERA #ascontrt;
|FPRC;

|| ************************************************************************

|PROCESO prepara;   |TIPO 3;
    nDCliente = 1;
    nHCliente = 99999;
    |SI enCliente ! 0;
        nDCliente = enCliente;
        nHCliente = enCliente;
        #asprepar#0 = enTipo;
        #asprepar#1 = "N";
        #asprepar#3 = enTipo;
        #asprepar#4 = "S";
    |FINSI;

    |ABRE #ascontrt;
    #ascontrt#0 = #asprepar#0;
    |LEE 000#ascontrt.=;
    |SI FSalida ! 0; |DDEFECTO #ascontrt; |FINSI;
    nIVA1 = #ascontrt#3;

    #ascontrt#0 = #asprepar#3;
    |LEE 000#ascontrt.=;
    |SI FSalida ! 0; |DDEFECTO #ascontrt; |FINSI;
    nIVA2 = #ascontrt#3;

    |CIERRA #ascontrt;

    |SI #asprepar#2 [ "30.06.2010";
        |SI nIVA1 = 8;  |O nIVA1 = 18; |O nIVA1 = 10; |O nIVA1 = 21;
            alfa1 = nIVA1;
            alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
            |MENAV alfa1;
            |CONFI "0000NQuiere continuar";
            |SI FSalida ! 0;
                |MENAV "0000Revise los % IVA y las minutas.";
                |ACABA;
            |FINSI;
        |SINO;
            |SI nIVA2 = 8;  |O nIVA2 = 18; |O nIVA2 = 10; |O nIVA2 = 21;
                alfa1 = nIVA2;
                alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                |MENAV alfa1;
                |CONFI "0000NQuiere continuar";
                |SI FSalida ! 0;
                    |MENAV "0000Revise los % IVA y las minutas.";
                    |ACABA;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;

    |SI #asprepar#2 ] "01.07.2010"; |Y #asprepar#2 < "01.09.2012";

        |SI nIVA1 = 7;  |O nIVA1 = 16; |O nIVA1 = 10; |O nIVA1 = 21;
            alfa1 = nIVA1;
            alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
            |MENAV alfa1;
            |CONFI "0000NQuiere continuar";
            |SI FSalida ! 0;
                |MENAV "0000Revise los % IVA y las minutas.";
                |ACABA;
            |FINSI;
        |SINO;
            |SI nIVA2 = 7;  |O nIVA2 = 16; |O nIVA2 = 10; |O nIVA2 = 21;
                alfa1 = nIVA2;
                alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                |MENAV alfa1;
                |CONFI "0000NQuiere continuar";
                |SI FSalida ! 0;
                    |MENAV "0000Revise los % IVA y las minutas.";
                    |ACABA;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;

    |SI #asprepar#2 ] "01.09.2012";
        |SI nIVA1 = 7;  |O nIVA1 = 16; |O nIVA1 = 8; |O nIVA1 = 18;
            alfa1 = nIVA1;
            alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
            |MENAV alfa1;
            |CONFI "0000NQuiere continuar";
            |SI FSalida ! 0;
                |MENAV "0000Revise los % IVA y las minutas.";
                |ACABA;
            |FINSI;
        |SINO;
            |SI nIVA2 = 7;  |O nIVA2 = 16; |O nIVA2 = 8; |O nIVA2 = 18;
                alfa1 = nIVA2;
                alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                |MENAV alfa1;
                |CONFI "0000NQuiere continuar";
                |SI FSalida ! 0;
                    |MENAV "0000Revise los % IVA y las minutas.";
                    |ACABA;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;

    fecha = ~;
    varalf = (fecha % 102) + (fecha % 402);

    |ABRE #ascontro;
    |LEE 000#ascontro.p;
    |SI FSalida ! 0;  |DDEFECTO #ascontro;  |FINSI;
    |CIERRA #ascontro;

    enErrorFac = 0;
    |SI #asprepar#1 = "S";
        sw = 0; |BUCLE asprepar_t1;
        |SI factura_1 ! 0; |O factura_2 ! 0;

            |PINPA #0#asprepa1;
            #asprepa1#0 = factura_1;
            #asprepa1#3 = factura_2;
            |PINTA #asprepa1#0;
            |PINTA #asprepa1#3;
            |ENCAMPO #1#asprepa1;
            |SI #asprepa1#1 = "N";
                |PARA;  |SI;  |HACIENDO;
                      |ENCAMPO #2#asprepa1;
                      |ENCAMPO #4#asprepa1;
                      |CONFI "2400SEs Correcto : ";
                      |SI FSalida = 0;
                          factura_1 = #asprepa1#2 - 1;
                          factura_2 = #asprepa1#4 - 1;
                          |SAL;
                      |FINSI;
                 |SIGUE;
            |SINO;
                 factura_1 = factura_1 - 1;
                 factura_2 = factura_2 - 1;
            |FINSI;

            |SI #asprepar#0 = #asprepar#3;
                |HAZ grabacon_1;
            |SINO;
                |HAZ grabacon_1;
                |HAZ grabacon_2;
            |FINSI;
        |FINSI;
    |FINSI;

    |ABRE #ascontrt;
    #ascontrt#0 = #asprepar#0;
    |LEE 000#ascontrt.=;
    |SI FSalida ! 0; |DDEFECTO #ascontrt; |FINSI;

    serie_1   = #ascontrt#1;
    factura_1 = #ascontrt#2;

    #ascontrt#0 = #asprepar#3;
    |LEE 000#ascontrt.=;
    |SI FSalida ! 0; |DDEFECTO #ascontrt; |FINSI;

    serie_2   = #ascontrt#1;
    factura_2 = #ascontrt#2;

    |CIERRA #ascontrt;

    |ABRE #asconcep;
    |BUCLE asprepar1;
    |CIERRA #asconcep;

    |SI #asprepar#0 = #asprepar#3;
        factura_2 = factura_1;
        serie_2   = serie_1;
    |FINSI;

    |ABRE #asconcep;
    #asconcep#0 = #ascontro#33;
    #asconcep#1 = #ascontro#34;
    |LEE 040#asconcep.=;
    |SI FSalida = 0; |Y #asconcep#3 = "A";
        |ABRE #aslinmin;
        |SI #ascontro#32 = "S"; |BUCLE asclient; |FINSI;
        |CIERRA #aslinmin;
    |FINSI;
    |CIERRA #asconcep;

    |SI #asprepar#0 = #asprepar#3;
        |HAZ grabacon_1;
        factura_2 = factura_1;
        serie_2   = serie_1;
    |SINO;
        |SI factura_1 ! 0; |HAZ grabacon_1; |FINSI;
        |SI factura_2 ! 0; |HAZ grabacon_2; |FINSI;
    |FINSI;
|FPRC;

|PROGRAMA;
     |SI enCliente = 0;
         |MANTE #asprepar;
     |SINO;
         |HAZ prepara;
     |FINSI;
|FPRO;
