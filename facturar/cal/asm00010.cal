|FICHEROS;
   asm00010 #0;
   asm00011 #1;
   asm00007 #2,MANTE;
   asm00008 #3,MANTE;

   asw00023 #5,MANTE;

   asw00021 #7;
   asw00022 #8;

   FMaster@ #9;
   FEsclav@ #10;
   Referen@ #11;
   RefCabs@ #111;
   Princip@ #100;

   asm00006 #13;
   asm00009 #14,MANTE;

   asm00013 #15;
   ascuenco #16;
   ascontro #17;
   asconcep #18;
   asw00029 #19;
   asempcon #27;
   ascontrt #450;
   ascontft #451;

   canempr@ #20;
   caivase@ #21;
   caenlac@ #23;
   caconas@ #24;
   camoned@ #25;
   calibro@ #26;
   camasic@ #28;
   caivasi@ #29;

   asw00027 #927;
   asw00031 #931;

   Tempo00@ #60;
   DatoTlf@ #61;
   Visados@ #1000;

   asw00050;
|FIN;

|VARIABLES;
   &PRMNT_enError = 0;
   &PRMNT_enVer   = 0;

   &eaCodPase      = "";
   &eaProcedencia  = "";
   &eaTipoPase     = "";
   &enNoModif      = 0;
   &enCambioCtaIVA = 0;
   &enDesdeActual  = 0;
   &eaFichero      = "";

   aDepart = "";

   nBase1 = 0; nBase2 = 0; nBase3 = 0; nBase4 = 0; nBase5 = 0;
   nRevDia = 0; aRevFec = ""; nRevDoc = 0; nEmp = 0; nPer = 0;
   aBase1 = ""; aBase2 = ""; aBase3 = ""; aBase4 = ""; aBase5 = "";
   nSwEsVisados = 0; nHandle = 0;

   Direc    = ""; MarcaPant = "|"; aAlfa = "";
   DComodin = ""; HComodin  = ""; Ref = ""; Mast = ""; Escl = ""; RefCab = "";
   Comodin  = ""; PathAplic = ""; Fichero = ""; Mensaje = "";
   Comodin1 = "";
   Comodin2 = "";
   ComodNum = 0;
   ComodinA = "";
   aConIVA  = "";
   aCtaCli  = "";

   SwError = 0;
   Calc = 0; Calc1 = 0; Calc2 = 0; Cont = 0; Cont1 = 0; Cont2 = 0;
   aLong = ""; nLong = 0;
   Oper1 = 0; Oper2 = 0;
   Operacion = "";
   Resultado = 0; nCont = 0; nVuelta = 0;
   FechaCom = @; FEstado = 0;
   nEmprAnt = 0; nPeriAnt = 0;

   Tipo = ""; nNumero = 0; Modif = ""; Emision = ""; Caracter = "";

   Diario = 0; Fecha = 0; Docum = 0; nAsient = 0; nAsto = 0; nApunt = 0;
   Cuenta = ""; Descr = ""; Cadena = ""; nImporte = 0;
   UltimoAsiento = 0; UltimoApunte  = 0;

   TipoDato = ""; LongDato = 0;
   nDiario = 0; fFecha = @; nSw = 0; Empr1 = 0; Peri1 = 0;
   nDiaBas = 0; fFecBas = @; nDocBas = 0; nEmpBas = 0; nPerBas = 0;
   nLinDesc = 0; nTotalDesc = 0; nNumAcum = 0;
   fFechaC  = @;

   Fich = ""; LinRel = 0; Fich1 = ""; FichCab1 = "";
   Cmp  = ""; SwCondic = 0; nNumBase = 0;

   nCalc = 0; nCont1 = 0; nCont2 = 0; aCuenta = ""; nRemAnt = 0;

   Salir = 0; Opcion = 0; NumAcum = 1;

   &CodEnlace = ""; CmpContab = 0; CmpRegist = 0;

   PosicAPar = 0; PosicCPar = 0;
   Cad1 = ""; Cad2 = "";
   Neg  = 0;  Modo = "";
   &fich_alta = "";

   NumAsientos  = 0; NumAstoAnt = 0;
   nSwImpre     = 0;
   nErrContador = 0;

   NomFich = ""; NumCmps = 0; FichRelac = ""; NombreRel = "";
   NumCmps1 = 0; NumCmps2 = 0;

   Clave1 = ""; Clave2 = "";
   CmpClave1 = 0; CmpClave2 = 0;

   Empresa = 0;
   Periodo = 0;
   PathEnlace = "";
   Tecla   = 0;
   Ejerc   = 0;
   EmpAnt  = 0;
   PerAnt  = 0;
   EjercA  = 0;
   nEjer   = 0;
   fec1    = @;
   fec2    = @;
   nSwBueno = 0;
   aAlfa1   = "";
   aAlfa2   = "";
   aAlfa3   = "";
   nAny     = 0;
   nNume1   = 0;
   nNume2   = 0;

   CmpDebe  = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe  = 0; TotHaber = 0; TotSaldo = 0;
   SwNivel = 0; Nivel = 0; UltDocum = 0;
   Dig1 = 0; Dig2 = 0; Dig3 = 0; Dig4 = 0; Dig5 = 0; Dig6 = 0;

   DigFormat = 0;
   NumReg = 0;

   UltFecha  = @;
   UltRecibo = 0;
   ReciboAct = 0;

   NumApunte = 1; NumAsto = 0;

   Libro = 0; Serie = 0; Factura = 0; Recibo = 0;
   FichEsclavo = ""; FichMaster = ""; Marca = 0;

   &EURO = 1; &EURODB = 0; &EURODV = 0;

{100}nIvas = 0;
{100}aCtrp = "";

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "REC";
    Menu5 = " Revisar ";
    Menu6 = " Enlazar ";
    Menu7 = " Cancelar ";

    nNumFicheros = 2;

    ClaveCabAnt1 = ""; ClaveCabAnt2 = "";

{-1}TiposEnlaces  = "";
    TiposEnlaces1 = "FC";
    TiposEnlaces2 = "CB";

{-1}Ficheros  = "";
    Ficheros1 = "ashismil";   || Facturas
    Ficheros2 = "asparcia";   || Cobros

{-1}FichCabs  = "";
    FichCabs1 = "ashismic";   || Facturas
    FichCabs2 = "asparcia";   || Cobros

{-1}Cmp1ClaveCab  = 0;
    Cmp1ClaveCab1 = 0;
    Cmp1ClaveCab2 = 0;

{-1}Cmp2ClaveCab  = 0;
    Cmp2ClaveCab1 = 1;
    Cmp2ClaveCab2 = 1;

{-1}nAsiento  = 0;
    nAsiento1 = 16;
    nAsiento2 = 16;

{-1}Campo1Clave  = 0;
    Campo1Clave1 = 0;
    Campo1Clave2 = 0;

{-1}Campo2Clave  = 0;
    Campo2Clave1 = 1;
    Campo2Clave2 = 1;

{-1}Campo3Clave  = 0;
    Campo3Clave1 = 2;
    Campo3Clave2 = 2;

{-1}CmpEmpresa  = 0;
    CmpEmpresa1 = 20;
    CmpEmpresa2 = 20;

{-1}CmpPeriodo  = 0;
    CmpPeriodo1 = 21;
    CmpPeriodo2 = 21;

{-1}CmpEnlace  = 0;
    CmpEnlace1 = 22;
    CmpEnlace2 = 22;

{-1}Fechas  = 0;
    Fechas1 = 29;
    Fechas2 = 3;

   &eaFicSel = "";
   &enSwRel  = 0;
   &nGTempo  = 0;

   aClau    = "";
   nClau0   = 0;
   nClau1   = 0;
   aClau2   = "";
   nClau3   = 0;
   nClau4   = 0;
   nClau5   = 0;

   aAlfa1a  = "";
   aAlfa2a  = "";
   aAlfa1b  = "";
   aAlfa2b  = "";
   nSwError = 0;
   nSwOpera = 0;
   nTotal   = 0;
   nUltim   = 0;
   nDifer   = 0;
   nOpera   = 0;

   aCampo0  = "";
   nCampo1  = 0;
   aSerie   = "";
   nFactura = 0;
   aDedSop  = "";
   aDedSopC = "";
   nHay     = 0;
   aDSerie  = "";
   aHSerie  = "";
   nDNumero = 0;
   nHNumero = 0;
|FIN;

|RUTINA inferior;
   #asm00011#12 = 00000;
   #asm00011#13 = 0;
   #asm00011#0  = 00;
   #asm00011#1  = "01.01.1900";
   #asm00011#2  = 000001;
   #asm00011#3  = 0001;
|FRUT;

|RUTINA superior;
   #asm00011#12 = 99999;
   #asm00011#13 = 9;
   #asm00011#0 = 99;
   #asm00011#1 = "31.12.2900";
   #asm00011#2 = 999999;
   #asm00011#3 = 9999;
|FRUT;

|PROCESO TomaDatos;

/*
   Si se le pasa en la variable 'Fich' el nombre del fichero del que quieres
   extraer el dato y en la variable 'Cmp' el numero del campo, devuelve en la
   variable 'Comodin' el valor correspondiente
*/
   #asw00022#0 = Fich;
   #asw00022#1 = Cmp;
   |LEE 010#asw00022.=;
   |SI FSalida = 0;
      |SI #asw00022#2 = "A"; Comodin = #asw00022#3; |FINSI;
      |SI #asw00022#2 = "N"; Comodin = #asw00022#4; |FINSI;
      |SI #asw00022#2 = "F"; Comodin = #asw00022#5; |FINSI;
   |SINO;
      Comodin = ""; |ACABA;
   |FINSI;

   |SI DigFormat ! 0;
      |SI #asw00022#2 = "N";
         Comodin1 = "0" * DigFormat;
         Calc = 0 - (100 + DigFormat);
         Comodin = Comodin1 + Comodin;
      |FINSI;
      |SI #asw00022#2 = "A";
         Comodin1 = " " * DigFormat;
         Calc = 100 + DigFormat;
         Comodin = Comodin + Comodin1;
      |FINSI;
      Comodin = Comodin % Calc;
   |SINO;
      |QBF Comodin;
   |FINSI;

|FPRC;

|PROCESO BuscaFactura;
   |DBASS Comodin; |QBF Comodin; Comodin = Comodin + "contagen/";
   Comodin1 = Comodin + "fich/" + ((("00000" + Empresa) % -105) + Periodo) + "/";

   |PATH_DAT #21 Comodin1;
   |PATH_DAT #26 Comodin1;
   |PATH_DAT #29 Comodin1;
   |ABRE #29;
   |DDEFECTO #29;
   |LEE 041#29p;
   |CIERRA #29;
   aDedSop  = #29#21;
   aDedSopC = #29#82;

   |SI #caivasi@#44 = "N";
       aSerie = "";
       |ABRE #calibro@;
       #calibro@#0 = #asm00010#6;
       |LEE 101#calibro@.=;
       |SI FSalida = 0;
           nFactura  = #calibro@#4;
           #calibro@#4 = #calibro@#4 + #calibro@#3;
           |GRABA 020#calibro@.a;
           |LIBERA #calibro@;
       |FINSI;
       |CIERRA #calibro@;
   |SINO;
       aSerie = #caivasi@#65;
       |ABRE #caivase@;
       #caivase@#0 = aSerie;
       #caivase@#1 = "S";
       |LEE 101#caivase@.=;
       |SI FSalida = 0;
           nFactura = #caivase@#3;
           #caivase@#3 = #caivase@#3 + #caivase@#4;
           |GRABA 020#caivase@.a;
           |LIBERA #caivase@;
      |FINSI;
      |CIERRA #caivase@;
   |FINSI;
|FPRC;

|PROCESO LaFactura;
   Fich = "ashismic"; Cmp = "000"; |HAZ TomaDatos; #caenlac@#12 = Comodin;
   Fich = "ashismic"; Cmp = "001"; |HAZ TomaDatos; #caenlac@#13 = Comodin;
   |SI aCampo0 ! #caenlac@#12; |O nCampo1 ! #caenlac@#13;
       aSerie   = #caenlac@#12;
       nFactura = #caenlac@#13;
       aDedSop  = "";
       aDedSopC = "";
       |SI #asm00006#8 = "S";
           #caenlac@#46 = #caenlac@#12;
           #caenlac@#47 = #caenlac@#13;
           |HAZ BuscaFactura;
       |FINSI;
       aCampo0  = #caenlac@#12;
       nCampo1  = #caenlac@#13;
   |FINSI;
   #caenlac@#12 = aSerie;
   #caenlac@#13 = nFactura;
|FPRC;

|PROCESO LaFecha;
  |SI #canempr@#26 < 80;
      nAny = 2000 + #canempr@#26;
  |SINO;
      nAny = 1900 + #canempr@#26;
  |FINSI;

  aAlfa1 = nAny;
  aAlfa2 = #canempr@#11; |QBF aAlfa2;
  aAlfa2 = ("00" + aAlfa2) % -102;
  aAlfa2 = "01." + aAlfa2 + "." + aAlfa1;
  fec1  = aAlfa2;

  |SI #canempr@#11 ! 1;
      nAny = nAny + 1;
      aAlfa1 = nAny;
  |FINSI;
  aAlfa2 = #canempr@#12; |QBF aAlfa2;
  aAlfa2 = ("00" + aAlfa2) % -102;

  aAlfa3 = "31.";
  |SI #canempr@#12 = 4; |O #canempr@#12 = 6; |O #canempr@#12 = 9; |O #canempr@#12 = 11;
      aAlfa3 = "30.";
  |SINO;
      |SI #canempr@#12 = 2;
          aAlfa3 = "28.";
          nNume1 = nAny / 4; nNume2 = (nAny / 4) ! 0;
          |SI nNume1 = nNume2;
              aAlfa3 = "29.";
          |FINSI;
      |FINSI;
  |FINSI;
  aAlfa2 = aAlfa3 + aAlfa2 + "." + aAlfa1;
  fec2 = aAlfa2;
|FPRC;

|PROCESO EncuentraConta;
       nSwBueno = 0;
       #canempr@#2  = Empresa;
       #canempr@#26 = nEjer;
       |LEE 000#canempr@.=;
       |SI FSalida = 0;
           |HAZ LaFecha;
           |SI fec1 [ fFechaC; |Y fec2 ] fFechaC
               nSwBueno = 1;
           |FINSI;
       |FINSI;
|FPRC;

|PROCESO BuscaPer;

    Periodo = -1;
   |SI enSwRel = 1;
       |ABRE #927;
       |SELECT #2#927;
       #927#1 = Empresa;
       |LEE 001#927=;
       |SI FSalida ! 0;
           |CIERRA #927;
           |ACABA;
       |FINSI;
       |SELECT #1#927;
       |CIERRA #927;
   |FINSI;

   Comodin  = PathEnlace; |QBF Comodin;
   Comodin1 = Comodin;
   Comodin  = Comodin + "def/canempre.mas";
   Comodin1 = Comodin1 + "fich/";
   |CARGA_DEF Comodin, canempr@;
   |SI FSalida = 0;
       |PATH_DAT #20 Comodin1;

       |ABRE #canempr@;
       |SELECT #4#canempr@;
       nEjer = EjercA; |HAZ EncuentraConta;
       |SI nSwBueno = 0;
           nEjer = nEjer - 1;
           |HAZ EncuentraConta;
           |SI nSwBueno = 0;
               nEjer = EjercA + 1; |HAZ EncuentraConta;
           |FINSI;
       |FINSI;
       |SI nSwBueno = 1;
           Dig1 = #canempr@#14;
           Dig2 = #canempr@#15;
           Dig3 = #canempr@#16;
           Dig4 = #canempr@#17;
           Dig5 = #canempr@#18;
           Dig6 = #canempr@#19;
           Periodo = #canempr@#3;
           aDepart = "";
           |SI #canempr@#24 = "S";
              aDepart = #canempr@#30;
              aDepart = ("00" + aDepart) % -102;
           |FINSI;
       |FINSI;
       |SELECT #1#canempr@;
       |CIERRA #canempr@;
       |DESCARGA_DEF #canempr@;

       |SI #asm00006#8 = "S"; |Y #asm00006#2 = "FC";

           |DBASS Comodin; |QBF Comodin; Comodin = Comodin + "contagen/";
           Comodin1 = Comodin + "fich/" + ((("00000" + Empresa) % -105) + Periodo) + "/";
           |PATH_DAT #26 Comodin1;
           |ABRE #calibro@;
           #calibro@#0 = #asm00010#6;
           |LEE 000#calibro@.=;
           |SI FSalida = 0;
               |SI #calibro@#2 ! "S";
                   |SI nOpera = 1;
                       aAlfa1 = "     Libro de IVA No Correcto en Empresa " + Empresa;
                       |MENAV aAlfa1;
                   |FINSI;
                   Periodo = -1;
               |FINSI;
           |FINSI;
           |CIERRA #calibro@;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO RevisaBases;
   |SI #caenlac@#26 = "B";
      |SI #caenlac@#27 = 1; nBase1 = #caenlac@#28; aBase1 = #caenlac@#4; |FINSI;
      |SI #caenlac@#27 = 2; nBase2 = #caenlac@#28; aBase2 = #caenlac@#4; |FINSI;
      |SI #caenlac@#27 = 3; nBase3 = #caenlac@#28; aBase3 = #caenlac@#4; |FINSI;
      |SI #caenlac@#27 = 4; nBase4 = #caenlac@#28; aBase4 = #caenlac@#4; |FINSI;
      |SI #caenlac@#27 = 5; nBase5 = #caenlac@#28; aBase5 = #caenlac@#4; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaBases;
   #caenlac@#1006;
   ;
   nRevDia,aRevFec,nRevDoc,0001,nEmp,nPer;
   nRevDia,aRevFec,nRevDoc,9999,nEmp,nPer;
   ;
   NULL,RevisaBases;
|FIN;

|PROCESO RevisaIvas;
   |SI #caenlac@#26 = "I";
      |SI #asm00006#8 = "S"; |Y #caenlac@#31 = "N"; |Y #caenlac@#4 = "            ";
          |SI #caenlac@#27 [ 1; #caenlac@#4 = aBase1; |FINSI;
          |SI #caenlac@#27 = 2; #caenlac@#4 = aBase2; |FINSI;
          |SI #caenlac@#27 = 3; #caenlac@#4 = aBase3; |FINSI;
          |SI #caenlac@#27 = 4; #caenlac@#4 = aBase4; |FINSI;
          |SI #caenlac@#27 = 5; #caenlac@#4 = aBase5; |FINSI;
      |FINSI;

      |SI #caenlac@#27 = 1;
         |SI nBase1 = -1; #caenlac@#27 = 2; |FINSI;
      |FINSI;
      |SI #caenlac@#27 = 2;
         |SI nBase2 = -1; #caenlac@#27 = 3; |FINSI;
      |FINSI;
      |SI #caenlac@#27 = 3;
         |SI nBase3 = -1; #caenlac@#27 = 4; |FINSI;
      |FINSI;
      |SI #caenlac@#27 = 4;
         |SI nBase4 = -1; #caenlac@#27 = 5; |FINSI;
      |FINSI;

      |GRABA 020#caenlac@.a;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaIvas;
   #caenlac@#1006;
   ;
   nRevDia,aRevFec,nRevDoc,0001,nEmp,nPer;
   nRevDia,aRevFec,nRevDoc,9999,nEmp,nPer;
   be;
   NULL,RevisaIvas;
|FIN;

|PROCESO RevisaPuente;
   |SI nRevDia ! #caenlac@#0; |O aRevFec ! #caenlac@#1; |O nRevDoc ! #caenlac@#2;
    |O nEmp ! #caenlac@#37; |O nPer ! #caenlac@#38;
      nBase1 = 0;  nBase2 = 0;  nBase3 = 0;  nBase4 = 0;  nBase5 = 0;
      aBase1 = ""; aBase2 = ""; aBase3 = ""; aBase4 = ""; aBase5 = "";
      nRevDia = #caenlac@#0;
      aRevFec = #caenlac@#1;
      nRevDoc = #caenlac@#2;
      nEmp    = #caenlac@#37;
      nPer    = #caenlac@#38;
      |SALVA_FICHA #caenlac@;
      |BUCLE RevisaBases;
      |BUCLE RevisaIvas;
      |REPON_FICHA #caenlac@;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaPuente;
   #caenlac@#1006;
   ;
   00,"00.00.0000",000000,0000,00000,0;
   99,"31.12.9999",999999,9999,99999,9;
   ;
   NULL,RevisaPuente;
|FIN;

|PROCESO BuscaIva;
     Fich = "ashismic"; Cmp = "045"; |HAZ TomaDatos;
     #caenlac@#28 = Comodin;
|FPRC;

|PROCESO BuscaBases;
   |SI #caenlac@#26 = "D";
      nLinDesc = #caenlac@#3; nNumAcum = #caenlac@#27;
      nTotalDesc = #caenlac@#9;
      |SALVA_FICHA #caenlac@;
      #caenlac@#3 = 0;
      |LEE 000#caenlac@.];
      |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiaBas; |Y #caenlac@#1 = fFecBas;
              |Y #caenlac@#2 = nDocBas; |Y #caenlac@#37 = nEmpBas; |Y #caenlac@#38 = nPerBas; |HACIENDO;
         |SI #caenlac@#26 = "B";
            |SI nNumAcum = #caenlac@#27;
               |SI nTotalDesc > #caenlac@#9; nNumAcum = 0; |FINSI;
            |SINO;
               |SI nTotalDesc [ #caenlac@#9;
                  nNumAcum = #caenlac@#27; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |LEE 000#caenlac@.s;
      |SIGUE;
      |REPON_FICHA #caenlac@;

      |SI nNumAcum ! 0; #caenlac@#27 = nNumAcum; |GRABA 020#caenlac@.a; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaBases;
   #caenlac@#1006;
   ;
   nDiaBas, fFecBas, nDocBas, 0000, nEmpBas, nPerBas;
   nDiaBas, fFecBas, nDocBas, 9999, nEmpBas, nPerBas;
   ;
   NULL, BuscaBases;
|FIN;

|PROCESO AdjudicaDesc;
   |SALVA_DATOS #caenlac@;
   nDiaBas = #caenlac@#0;  fFecBas = #caenlac@#1;
   nDocBas = #caenlac@#2;  nEmpBas = #caenlac@#37;
   nPerBas = #caenlac@#37;
   nLinDesc = 0; nNumAcum = 0;
   nTotalDesc = nImporte; |BUCLE BuscaBases;
   |REPON_DATOS #caenlac@;
|FPRC;

|PROCESO asm00008a;

/*
   Consta de tres partes :
    1 - Se resuelve la expresion o se recoge el valor fijo que se indico como
        la cuenta que ira referida a la linea que estamos tratando.
    2 - Resolvera la expresion indicada para usar como descripcion en la
        linea del asiento
    3 - Se resolvera el importe del asiento en base a la cantidad o la
        expresion indicadas para ello

   Una vez calculado todo esto, se escribe la linea del asiento en el fichero
   puente.

   Ademas se ocupa de marcar el registro del fichero principal del enlace
   con el numero de empresa y el periodo con el que se ejecuta el enlace asi
   como el codigo de enlace usado.
*/

   |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
   |PINTA 2310, Mensaje; |ATRI R;

||************************************* PARTE 1
   |SALVA_DATOS #caenlac@;
   |ABRE #asw00022;

   Cuenta = #asm00008#3; aLong = Cuenta % 0; nLong = aLong;
   |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
      Calc = (nCont * 100) + 1;
      Caracter = Cuenta % Calc;
      |SI Caracter = "[";
         Calc1 = Calc + 100;
         Caracter = Cuenta % Calc1;
         |SI Caracter = "%";
            Calc1 = Calc + 17;
            Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
            aLong = Cadena % 0302; DigFormat = aLong;
            Fich  = Cadena % 0508; Cmp   = Cadena % 1503;
            |HAZ TomaDatos;
         |SINO;
            Calc1 = Calc + 14;
            Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
            DigFormat = 0;
            Fich  = Cadena % 0208; Cmp   = Cadena % 1203;
            |HAZ TomaDatos;
         |FINSI;
         Calc1 = 100 + (nCont - 1);
         Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
         Cuenta = Cadena + Comodin + Cuenta;
         nCont = nCont - 1;
      |FINSI;
   |SIGUE;

   aAlfa1 = Cuenta; |QBF aAlfa1; aAlfa1 = aAlfa1 % 108;
   |SI aAlfa1 = "DESGLOSE";
       nSwError = 0;
       |HAZ EspAdade1;
       |SI nSwError = 0;
           |VETE Final;
       |FINSI;
   |FINSI;

   |SI #asm00008#13 = "I";  || tique
       |SI aDedSop = "N"; |Y #asm00006#8 = "S";
           Cuenta = aDedSopC;
       |FINSI;
   |FINSI;

   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   SwNivel = 0;
   |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
   |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
   |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
   |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
   |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
   |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
   |SI SwNivel = 0; Nivel = 0; |FINSI;

||************************************* PARTE 2
   Comodin = #asm00008#6; |QBF Comodin;

   |SI Comodin ! "[=]";
      Cadena = "";
      Comodin = "";
      Descr = #asm00008#6;
      Descr = Descr - "][";
      |SI FSalida ! 0;
         |PARA; |SI FSalida ! 0; |HACIENDO;
            Descr = Descr - "[";
            Calc = FSalida;
            Comodin1 = Descr % Calc;
            |SI Comodin1 = "%";
               Calc = Calc + 100;
               Comodin1 = Descr % Calc;
               |SI Comodin1 ] "0"; |Y Comodin1 [ "9";
                  Calc = Calc + 2;
                  Comodin1 = Descr % Calc;
                  Descr = Descr - "%";
                  DigFormat = Comodin1;
                  Descr = Descr - Comodin1;
               |FINSI;
            |FINSI;
            ComodNum = FSalida;
            ComodNum = ((ComodNum / 100) ! 0);
            ComodNum = 100 + (ComodNum - 1);
            Comodin1 = Descr % ComodNum; Descr = Descr - Comodin1;
            Cadena   = Cadena + Comodin1; ||QBF Cadena;
            Fich = Descr % 0108; |QBF Fich; Descr = Descr - Fich;
            Cmp  = Descr % 0103; Descr = Descr - Cmp;
            Descr = Descr - "]";
            |HAZ TomaDatos; DigFormat = 0;
            Cadena = Cadena + Comodin;
            Descr = Descr - "][";
         |SIGUE;
         Descr = Cadena;
      |FINSI;
   |FINSI;

||************************************* PARTE 3
   DigFormat = 0;
   Cadena = #asm00008#8; |HAZ ResuelveExpr; nImporte = Resultado;

   aConIVA = "";
   aAlfa = #asm00008#3; |QBF aAlfa;
   aAlfa = aAlfa - "[ascuenco]";
   |SI FSalida ! 0;

      Comodin = "";
      Fich = "asconcep"; Cmp = "003"; |HAZ TomaDatos;
      |SI Comodin = "";
         |ABRE #asconcep;
         Fich = "ascuenco"; Cmp = "000"; |HAZ TomaDatos;
         #asconcep#0 = Comodin;
         Fich = "ascuenco"; Cmp = "001"; |HAZ TomaDatos;
         #asconcep#1 = Comodin;
         |LEE 000#asconcep.=;
         |SI FSalida = 0;
            |SI #asm00008#14 = " ";
               |SI #asconcep#3 = "A";
                  |SI #asm00008#4 = "D";
                     #asm00008#4 = "H";
                  |SINO;
                     #asm00008#4 = "D";
                  |FINSI;
               |FINSI;
            |SINO;
               |SI #asconcep#3 ! #asm00008#14; nImporte = 0; |FINSI;
               |SI #asconcep#3 = "S"; aConIVA = "N"; |SINO; aConIVA = "S"; |FINSI;
            |FINSI;
         |FINSI;
         |CIERRA #asconcep;
      |SINO;
         |SI #asm00008#14 = " ";
            |SI Comodin = "A";
               |SI #asm00008#4 = "D";
                  #asm00008#4 = "H";
               |SINO;
                  #asm00008#4 = "D";
               |FINSI;
            |FINSI;
         |SINO;
            |SI Comodin ! #asm00008#14; nImporte = 0; |FINSI;
            |SI Comodin = "S"; aConIVA = "N"; |SINO; aConIVA = "S"; |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   aAlfa = #asm00008#3; |QBF aAlfa;
   aAlfa = aAlfa - "[ascuenco][003]";
   |SI FSalida ! 0;
       Fich = "ascuenco"; Cmp = "003"; |HAZ TomaDatos;
       |SI Comodin = ""; |VETE Final; |FINSI;
   |FINSI;

   |SI nSwEsVisados = 1;
      aAlfa = #asm00008#8; |QBF aAlfa;
      aAlfa = aAlfa - "[asparcia][008]";
      |SI FSalida ! 0;
         |DDEF aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "visam017.mas";
         |CARGA_DEF aAlfa, Visados@;
         |SI FSalida = 0;
            |ABRE #Visados@;
            Fich = "asparcia"; Cmp = "000"; |HAZ TomaDatos;
            #Visados@#0 = Comodin;
            Fich = "asparcia"; Cmp = "001"; |HAZ TomaDatos;
            #Visados@#1 = Comodin;
            |LEE 000#Visados@.=;
            |SI FSalida = 0;
               nImporte = nImporte + #Visados@#5;
               nImporte = nImporte ! 2;
            |FINSI;
            |CIERRA #Visados@; |DESCARGA_DEF #Visados@;
         |FINSI;
      |FINSI;
   |FINSI;

||  A partir de aqui, se genera la/s linea/s del fichero puente necesarias
||    para dar de alta el/los asiento/s necesario/s

   UltimoApunte  = NumApunte;

   |SI #asm00008#7 = "S";
      |SI #asm00006#7 = "N";
         |SELECT #2#caenlac@;
      |SINO;
         |SELECT #3#caenlac@;
      |FINSI;
      #caenlac@#4 = Cuenta; Cuenta = #caenlac@#4;
      |SI #asm00006#8 = "S";
         |SI #asm00006#2 = "FC";
            Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
         |FINSI;
         |SI #asm00006#2 = "CB";
            Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
         |FINSI;

         fFechaC  = Comodin;
         ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
         Comodin  = Comodin % -104; |QBF Comodin;
         Ejerc    = Comodin;
         Empresa  = #caenlac@#37;
         Periodo = -1;
         |HAZ BuscaPer;
         #caenlac@#38 = Periodo;
         #caenlac@#43 = "";
         #caenlac@#44 = "";
      |SINO;
      |FINSI;

      nSw = 0;
      |SALVA_DATOS #caenlac@; FEstado = FSalida;
      Empr1 = #caenlac@#37; #caenlac@#37 = 0;
      Peri1 = #caenlac@#38; #caenlac@#38 = 0;
      nDiario = #caenlac@#0;
      fFecha  = #caenlac@#1;
      nAsto   = #caenlac@#2;
      nApunt  = #caenlac@#3;
      |LEE 000#caenlac@.];
      |PARA; |SI FSalida = 0; |Y #caenlac@#4 = Cuenta; |HACIENDO;
         |SI #caenlac@#37 = Empr1; |Y #caenlac@#38 = Peri1; |Y #caenlac@#8 = #asm00008#4;
          |Y #caenlac@#26 = #asm00008#13; |Y #caenlac@#0 = nDiario; |Y fFecha = #caenlac@#1;
          |Y nAsto = #caenlac@#2;
            |SI aConIVA = "";
               Empr1   = #caenlac@#37; Peri1   = #caenlac@#38; nDiario = #caenlac@#0;
               fFecha  = #caenlac@#1;  nAsto   = #caenlac@#2;  nApunt  = #caenlac@#3;
               nSw = 1; |SAL;
            |SINO;
               |SI aConIVA = "N"; |Y #caenlac@#28 = 0;
                  Empr1   = #caenlac@#37; Peri1   = #caenlac@#38; nDiario = #caenlac@#0;
                  fFecha  = #caenlac@#1;  nAsto   = #caenlac@#2;  nApunt  = #caenlac@#3;
                  nSw = 1; |SAL;
               |FINSI;
               |SI aConIVA = "S"; |Y #caenlac@#28 ! 0;
                  Empr1   = #caenlac@#37; Peri1   = #caenlac@#38; nDiario = #caenlac@#0;
                  fFecha  = #caenlac@#1;  nAsto   = #caenlac@#2;  nApunt  = #caenlac@#3;
                  nSw = 1; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |LEE 000#caenlac@.s;
      |SIGUE;
      |REPON_DATOS #caenlac@;
      |SELECT #1#caenlac@;
      |SI nSw = 1;
          #caenlac@#37 = Empr1;
          #caenlac@#38 = Peri1;
          #caenlac@#0  = nDiario;
          #caenlac@#1  = fFecha;
          #caenlac@#2  = nAsto;
          #caenlac@#3  = nApunt;
          |LEE 000#caenlac@.=;
      |SINO;
          FSalida = 1;
      |FINSI;
      |SI FSalida = 0;
         |SI #caenlac@#9 = 0; |Y #caenlac@#6 ! #asm00008#5; #caenlac@#6 = #asm00008#5; |FINSI;
         #caenlac@#7 = Descr;
         |SI #asm00008#12 = "S";
            #caenlac@#9 = #caenlac@#9 + nImporte;
         |SINO;
            #caenlac@#9 = nImporte;
         |FINSI;
         |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
      |SINO;
         #caenlac@#25 = "N";
         #caenlac@#3  = NumApunte; NumApunte = NumApunte + 5;
         #caenlac@#4  = Cuenta;
         Comodin = Cuenta; |QBF Comodin;
         aLong = Comodin % 0; nLong = aLong;
         SwNivel = 0;
         |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
         |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
         |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
         |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
         |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
         |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
         |SI SwNivel = 0; Nivel = 0; |FINSI;
         #caenlac@#5  = Nivel;
         #caenlac@#6  = #asm00008#5;
         #caenlac@#7  = Descr;
         #caenlac@#8  = #asm00008#4;
         #caenlac@#9  = nImporte;
         |SI #asm00006#2 = "FC";
            |SI #asm00006#8 = "S";
                #caenlac@#10 = "S";
                |HAZ CalReferencia;
            |SINO;
                #caenlac@#10 = "R";
            |FINSI;
         |SINO;
            #caenlac@#10 = " ";
         |FINSI;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            |SI #asm00006#2 = TiposEnlaces; #asw00022#0 = Ficheros; |SAL; |FINSI;
         |SIGUE;

         #caenlac@#15 = aDepart;

         #caenlac@#17 = 0; #caenlac@#18 = "";
         Comodin = Usuario % 0810;
         #caenlac@#19 = Comodin;
         #caenlac@#24 = #asm00006#2;
         #caenlac@#26 = #asm00008#13;
         #caenlac@#27 = NumAcum;

         |SI #asm00006#8 = "S";
            |SI #asm00006#2 = "FC";
               Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
               #caenlac@#37 = Comodin;
               Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
            |FINSI;
            |SI #asm00006#2 = "CB";
               Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
               #caenlac@#37 = Comodin;
               Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
            |FINSI;
            fFechaC  = Comodin;
            ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
            Comodin  = Comodin % -104; |QBF Comodin;
            Ejerc    = Comodin;
            Empresa  = #caenlac@#37;
            Periodo  = -1; |HAZ BuscaPer;
            |SI Periodo = -1; |VETE Final; |FINSI;
            #caenlac@#38 = Periodo;
         |FINSI;

         |SI #caenlac@#26 = "F"; |O #caenlac@#26 = "I"; #caenlac@#27 = 0; |FINSI;

         |SI #caenlac@#26 = "F"; |O #caenlac@#26 = " ";
              Fich = "ashismic"; Cmp = 3;  |HAZ TomaDatos; nNumero = Comodin;
              |SI nNumero = 0;
                  Fich = "ashismic"; Cmp = 5;  |HAZ TomaDatos; #caenlac@#43 = Comodin;
                  Fich = "ashismic"; Cmp = 11; |HAZ TomaDatos; #caenlac@#44 = Comodin;
              |SINO;
                  Fich = "ashismic"; Cmp = 5;  |HAZ TomaDatos; #caenlac@#43 = Comodin;
                  Fich = "ashismic"; Cmp = 11; |HAZ TomaDatos; #caenlac@#44 = Comodin;
              |FINSI;
              |SI #asm00006#8 = "S";
                  #caenlac@#43 = "";
                  #caenlac@#44 = "";
              |FINSI;
         |FINSI;

         || ... Tique 3237 _ 1947
||       Esta parte es exclusiva del enlace de la minutacion. Es una peque¤a
||       trampa para poder saber el tipo de iva, ya que no se guarda ni en los
||       ficheros de la minuta ni en ninguno de los que tiene relacionados

         |SI #caenlac@#10 ! " "; |Y #asm00006#2 = "FC";
            |HAZ LaFactura;
            #caenlac@#11 = #asm00010#6;
            #caenlac@#31 = aDedSop;
            |SI #caenlac@#26 = "P";
               Fich = "ashismic"; Cmp = "046"; |HAZ TomaDatos; #caenlac@#41 = Comodin;
               Fich = "ashismic"; Cmp = "024"; |HAZ TomaDatos; #caenlac@#42 = Comodin;
            |FINSI;

            |SI #caenlac@#26 = "I";
                |SI aDedSop = "N"; |Y #asm00006#8 = "S";
                    #caenlac@#4 = aDedSopC;
                |FINSI;
                #caenlac@#31 = aDedSop;
            |FINSI;

            |SI #caenlac@#26 = "B";
                |HAZ BuscaIva;

              aAlfa = #asm00008#8; |QBF aAlfa;
               aAlfa = aAlfa - "[ashismic][020]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
               aAlfa = aAlfa - "[ashismic][021]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
               aAlfa = aAlfa - "[ashismic][023]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
               aAlfa = aAlfa - "[ashismil]";
               |SI #caenlac@#28 ! 0; |Y FSalida ! 0;
                  Fich = "asconcep"; Cmp = "003"; |HAZ TomaDatos;
                  |SI Comodin = "S"; |O Comodin = "A";
                      #caenlac@#28 = 0;
                  |FINSI;
               |FINSI;
               #caenlac@#27 = 0;
               aCuenta = #caenlac@#4; |QBF aCuenta;

               |PARA nCont2 = 0; |SI nCont2 [ 99; |HACIENDO nCont2 = nCont2 + 1;
                  InIvas = nIvas1<-; InIvas = InIvas + nCont2;
                  IaCtrp = aCtrp1<-; IaCtrp = IaCtrp + nCont2;
                  |SI nIvas = -1; |SAL; |FINSI;

                  |SI #caenlac@#28 = nIvas; |Y aCuenta = aCtrp;
                     #caenlac@#27 = nCont2 + 1;
                  |FINSI;
               |SIGUE;
               |SI #caenlac@#27 = 0;
                  |PARA nCont2 = 0; |SI nCont2 [ 99; |HACIENDO nCont2 = nCont2 + 1;
                     InIvas = nIvas1<-; InIvas = InIvas + nCont2;
                     IaCtrp = aCtrp1<-; IaCtrp = IaCtrp + nCont2;
                     |SI nIvas = -1;
                        #caenlac@#27 = nCont2 + 1;
                        nIvas = #caenlac@#28; aCtrp = aCuenta; |SAL;
                     |FINSI;
                  |SIGUE;
               |FINSI;
            |FINSI;
         |FINSI;

||FIN DE LA TRAMPA

         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
            ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
            ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
            |SI #asm00006#2 = TiposEnlaces;
               Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
               Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
               Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
               |SAL;
            |FINSI;
         |SIGUE;

         |SI #caenlac@#26 = "D"; |HAZ AdjudicaDesc; |FINSI;
         |GRABA 020#caenlac@.n; |LEE 010#caenlac@.=; |LIBERA #caenlac@;
      |FINSI;
      |SELECT #4#caenlac@;
   |SINO;
      #caenlac@#3 = NumApunte; NumApunte = NumApunte + 5;
      #caenlac@#4 = Cuenta;
      Comodin = Cuenta; |QBF Comodin;
      aLong = Comodin % 0; nLong = aLong;
      SwNivel = 0;
      |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
      |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
      |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
      |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
      |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
      |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
      |SI SwNivel = 0; Nivel = 0; |FINSI;
      #caenlac@#5 = Nivel;
      #caenlac@#6 = #asm00008#5;
      #caenlac@#7 = Descr;
      #caenlac@#8 = #asm00008#4;
      #caenlac@#9 = nImporte;
      |SI #asm00006#2 = "FC";
         |SI #asm00006#8 = "S";
            #caenlac@#10 = "S";
            |HAZ CalReferencia;
         |SINO;
            #caenlac@#10 = "R";
         |FINSI;
      |SINO;
         #caenlac@#10 = " ";
      |FINSI;

      #caenlac@#15 = aDepart;

      #caenlac@#17 = 0; #caenlac@#18 = "";
      Comodin = Usuario % 0810;
      #caenlac@#19 = Comodin;
      #caenlac@#24 = #asm00006#2;
      #caenlac@#26 = #asm00008#13;
      #caenlac@#27 = NumAcum;
      |SI #asm00006#8 = "S";
         |SI #asm00006#2 = "FC";
            Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
         |FINSI;
         |SI #asm00006#2 = "CB";
            Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
         |FINSI;
         fFechaC  = Comodin;
         ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
         Comodin  = Comodin % -104; |QBF Comodin;
         Ejerc    = Comodin;
         Empresa  = #caenlac@#37;
         Periodo  = -1;
         |HAZ BuscaPer;
         |SI Periodo = -1; |VETE Final; |FINSI;
         #caenlac@#38 = Periodo;
      |FINSI;
      |SI #caenlac@#26 = "F"; |O #caenlac@#26 = "I"; #caenlac@#27 = 0; |FINSI;

      |SI #caenlac@#26 = "F"; |O #caenlac@#26 = " ";
          Fich = "ashismic"; Cmp = 3;  |HAZ TomaDatos; nNumero = Comodin;
          |SI nNumero = 0;
              Fich = "ashismic"; Cmp = 5;  |HAZ TomaDatos; #caenlac@#43 = Comodin;
              Fich = "ashismic"; Cmp = 11; |HAZ TomaDatos; #caenlac@#44 = Comodin;
          |SINO;
               Fich = "ashismic"; Cmp = 5;  |HAZ TomaDatos; #caenlac@#43 = Comodin;
               Fich = "ashismic"; Cmp = 11; |HAZ TomaDatos; #caenlac@#44 = Comodin;
          |FINSI;
          |SI #asm00006#8 = "S";
              #caenlac@#43 = "";
              #caenlac@#44 = "";
          |FINSI;
      |FINSI;

||       Esta parte es exclusiva del enlace de la minutacion. Es una peque¤a
||       trampa para poder saber el tipo de iva, ya que no se guarda ni en los
||       ficheros de la minuta ni en ninguno de los que tiene relacionados

         |SI #caenlac@#10 ! " "; |Y #asm00006#2 = "FC";
            |HAZ LaFactura;
            || ...Fich = "ashismic"; Cmp = "000"; |HAZ TomaDatos; #caenlac@#12 = Comodin;
            || ...Fich = "ashismic"; Cmp = "001"; |HAZ TomaDatos; #caenlac@#13 = Comodin;
            #caenlac@#11 = #asm00010#6;
            #caenlac@#31 = aDedSop;

            |SI #caenlac@#26 = "P";
               Fich = "ashismic"; Cmp = "046"; |HAZ TomaDatos; #caenlac@#41 = Comodin;
               Fich = "ashismic"; Cmp = "024"; |HAZ TomaDatos; #caenlac@#42 = Comodin;
            |FINSI;

            |SI #caenlac@#26 = "I";
                |SI aDedSop = "N"; |Y #asm00006#8 = "S";
                    #caenlac@#4 = aDedSopC;
                |FINSI;
                #caenlac@#31 = aDedSop;
            |FINSI;

            |SI #caenlac@#26 = "B";
                |HAZ BuscaIva;

               aAlfa = #asm00008#8; |QBF aAlfa;
               aAlfa = aAlfa - "[ashismic][020]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
               aAlfa = aAlfa - "[ashismic][021]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
                aAlfa = aAlfa - "[ashismic][023]";
               |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
               aAlfa = aAlfa - "[ashismil]";
               |SI #caenlac@#28 ! 0; |Y FSalida ! 0;
                  Fich = "asconcep"; Cmp = "003"; |HAZ TomaDatos;
                  |SI Comodin = "S"; |O Comodin = "A";
                      #caenlac@#28 = 0;
                  |FINSI;
               |FINSI;
               #caenlac@#27 = 0;
               aCuenta = #caenlac@#4; |QBF aCuenta;

               |PARA nCont2 = 0; |SI nCont2 [ 99; |HACIENDO nCont2 = nCont2 + 1;
                  InIvas = nIvas1<-; InIvas = InIvas + nCont2;
                  IaCtrp = aCtrp1<-; IaCtrp = IaCtrp + nCont2;
                  |SI nIvas = -1; |SAL; |FINSI;

                  |SI #caenlac@#28 = nIvas; |Y aCuenta = aCtrp;
                     #caenlac@#27 = nCont2 + 1;
                  |FINSI;
               |SIGUE;
               |SI #caenlac@#27 = 0;
                  |PARA nCont2 = 0; |SI nCont2 [ 99; |HACIENDO nCont2 = nCont2 + 1;
                     InIvas = nIvas1<-; InIvas = InIvas + nCont2;
                     IaCtrp = aCtrp1<-; IaCtrp = IaCtrp + nCont2;
                     |SI nIvas = -1;
                        #caenlac@#27 = nCont2 + 1;
                        nIvas = #caenlac@#28; aCtrp = aCuenta; |SAL;
                     |FINSI;
                  |SIGUE;
               |FINSI;
            |FINSI;
         |FINSI;

||FIN DE LA TRAMPA

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
         ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
         ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
         |SI #asm00006#2 = TiposEnlaces;
            Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
            Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
            Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
            |SAL;
         |FINSI;
      |SIGUE;

      |SI #caenlac@#26 = "D"; |HAZ AdjudicaDesc; |FINSI;

      |SI #asm00008#12 = "N";
         |SI nVuelta = 0;
            |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
         |FINSI;
      |SINO;
         |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
      |FINSI;
   |FINSI;

   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
      ICmpEnlace    = CmpEnlace1<-;    ICmpEnlace    = ICmpEnlace    + Cont;
      ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
      ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
      ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
      |SI #asm00006#2 = TiposEnlaces;
         Diario = nAsiento;
         |SI #asm00006#8 = "S"; Diario = Diario + 7; |FINSI;
         Fecha = Diario + 1; Docum = Fecha + 1; nAsient = Docum + 1;
         |SI NumAsto = 1;
            Calc = Campo1Clave; #Princip@#Calc# = #Referen@#Calc#;
            Calc = Campo2Clave; #Princip@#Calc# = #Referen@#Calc#;
            Calc = Campo3Clave; #Princip@#Calc# = #Referen@#Calc#;
            |LEE 101#Princip@.=;
            |SI FSalida = 0;
               #Princip@#Diario#  = #caenlac@#0; #Princip@#Fecha#   = #caenlac@#1;
               #Princip@#Docum#   = #caenlac@#2; #Princip@#nAsient# = #caenlac@#3;
               |SI #asm00006#8 = "S";
                  Calc = CmpEmpresa + 7; #Princip@#Calc# = Empresa;
                  Calc = CmpPeriodo + 7; #Princip@#Calc# = Periodo;
                  Calc = CmpEnlace  + 7; #Princip@#Calc# = CodEnlace;
               |SINO;
                  Calc = CmpEmpresa; #Princip@#Calc# = Empresa;
                  Calc = CmpPeriodo; #Princip@#Calc# = Periodo;
                  Calc = CmpEnlace;  #Princip@#Calc# = CodEnlace;
               |FINSI;
               |SI #asm00006#2 = "CB";
                  #Princip@#11 = #Referen@#Calc#;
               |FINSI;
               |GRABA 020#Princip@.a;
            |FINSI;
            |LIBERA #Princip@;
         |FINSI;
         |SAL;
      |FINSI;
   |SIGUE;
   |SI FichCab1 = "ashismic";
      #RefCabs@#0 = #Referen@#0;
      #RefCabs@#1 = #Referen@#1;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#31 = "S";
          |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;
   |SI FichCab1 = "asparcia";
      #RefCabs@#0 = #Referen@#0;
      #RefCabs@#1 = #Referen@#1;
      #RefCabs@#2 = #Referen@#2;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#10 = "S";
          #RefCabs@#11 = #caenlac@#1;
          |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;

|ET Final;

   |CIERRA #asw00022;
   |REPON_DATOS #caenlac@;
|FPRC;

|DEFBUCLE asm00008a;
#asm00008#1;
;
CodEnlace,#asm00007#2,0001;
CodEnlace,#asm00007#2,9999;
;
NULL,asm00008a;
|FIN;

|PROCESO Asiento;
   |DDEFECTO #caenlac@;
   #caenlac@#0  = #asm00007#3;
   #caenlac@#1  = #asm00007#4;
   |SI #caenlac@#1 = "00.00.0000"; |O #caenlac@#1 = "01.01.0000";
      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
         |SI #asm00006#2 = TiposEnlaces;
            #RefCabs@#0 = #Referen@#0;
            #RefCabs@#1 = #Referen@#1;
            #RefCabs@#2 = #Referen@#2;
            |LEE 101#RefCabs@.=;
            |SI FSalida = 0;
                Calc = Fechas; #caenlac@#1 = #RefCabs@#Calc#;
            |FINSI;
            |SI #asm00006#2 = "CB";
               Calc = Fechas; #caenlac@#1 = #Referen@#Calc#;
            |FINSI;
            |LIBERA #RefCabs@;
            |SAL;
         |FINSI;
      |SIGUE;
   |FINSI;

   |SI #asm00007#5 = "N";
      |SI #asm00006#7 = "S";
         |SI UltFecha ! #caenlac@#1;
            |HAZ Contador; NumApunte = 1; NumAcum = 1; nVuelta = 0;
         |FINSI;
      |FINSI;
   |SINO;
      |SI #asm00006#2 = "CB";
         Fich = "asparcia"; Cmp = 14; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0;
         nCalc = Comodin;
         |SI nRemAnt ! nCalc;
            |HAZ Contador; NumApunte = 1; NumAcum = 1; nVuelta = 0;
            nRemAnt = nCalc;
         |FINSI;
      |FINSI;
   |FINSI;
   #caenlac@#2 = NumAsientos;
   #caenlac@#29 = #caenlac@#1;
   UltFecha  = #caenlac@#1;

   |SI nVuelta = 0;
      |PARA nCont = 0; |SI nCont [ 99; |HACIENDO nCont = nCont + 1;
         InIvas = nIvas1<-; InIvas = InIvas + nCont;
         nIvas = -1;
         IaCtrp = aCtrp1<-; IaCtrp = IaCtrp + nCont;
         aCtrp = "";
      |SIGUE;
   |FINSI;
   |BUCLE asm00008a;

   || Creamos el fichero de apoyo al puente para crear la ficha de cli/pro
   |SI #asm00006#2 = "FC";
       Fich = "asclient"; Cmp = 52; |HAZ TomaDatos;
       |QBF Comodin;
       |SI Comodin = "";
          |ABRE #asempcon;
          |LEE 000#asempcon.p;
          |SI FSalida ! 0; |DDEFECTO #asempcon; |FINSI;
          Fich = "ashismic"; Cmp = 9;  |HAZ TomaDatos; |QBF Comodin;
          aAlfa = #asempcon#3; |QBF aAlfa;
          aAlfa = aAlfa + (("00000" + Comodin) % -105); Comodin = aAlfa;
          |CIERRA #asempcon;
      |FINSI;
      aCtaCli = Comodin;
      #asw00029#9 = aCtaCli;
      |LEE 041#asw00029.=;
      |SI FSalida ! 0
         |DDEFECTO #asw00029;
         #asw00029#9 = aCtaCli;
         Fich = "ashismic"; Cmp = 11; |HAZ TomaDatos; #asw00029#0 = Comodin;
         Fich = "ashismic"; Cmp = 5;  |HAZ TomaDatos; #asw00029#1 = Comodin;
         Fich = "ashismic"; Cmp = 6;  |HAZ TomaDatos; #asw00029#2 = Comodin;
         Fich = "ashismic"; Cmp = 7;  |HAZ TomaDatos; #asw00029#3 = Comodin;
         Fich = "ashismic"; Cmp = 8;  |HAZ TomaDatos; #asw00029#4 = Comodin;
         Fich = "ashismic"; Cmp = 9;  |HAZ TomaDatos; #asw00029#5 = Comodin;
         Fich = "ashismic"; Cmp = 10; |HAZ TomaDatos; #asw00029#6 = Comodin;
         Fich = "asclient"; Cmp = 9;  |HAZ TomaDatos; #asw00029#7 = Comodin;
         Fich = "asclient"; Cmp = 10; |HAZ TomaDatos; #asw00029#8 = Comodin;

         Fich = "asclient"; Cmp = 72; |HAZ TomaDatos; #asw00029#16 = Comodin;
         Fich = "asclient"; Cmp = 71; |HAZ TomaDatos; #asw00029#17 = Comodin;

         |GRABA 020#asw00029.n;
      |FINSI;
   |FINSI;

   NumAcum = NumAcum + 1;
|FPRC;

|PROCESO Contador;
   |SI #asm00010#4 = 0; |Y #asm00010#5 = 0;
      |SI #asm00006#8 = "S";
         |SI #asm00006#2 = "FC";
            Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            Empresa = Comodin;
            Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
         |FINSI;
         |SI #asm00006#2 = "CB";
            Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            Empresa = Comodin;
            Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
         |FINSI;
         fFechaC  = Comodin;
         ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
         Comodin  = Comodin % -104; |QBF Comodin;
         Ejerc    = Comodin;
         Periodo  = -1;
         |HAZ BuscaPer;
         |SI Periodo ! -1;
            Comodin2 = ("00000" + Empresa) % -105;
            Comodin2 = Comodin2 + Periodo + "/";
            Comodin1 = PathEnlace; |QBF Comodin1;
            Comodin1 = Comodin1 + "fich/" + Comodin2;
            |PATH_DAT #24 Comodin1;
         |FINSI;
      |FINSI;
   |FINSI;

   |ABRE #caconas@;
   |SI FSalida ! 0; SwError = 1; |ACABA; |FINSI;

   |LEE 101#caconas@.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconas@;
      |GRABA 020#caconas@.n;
      |LEE 101#caconas@.p;
   |FINSI;

   #caconas@#1 = #caconas@#1 + 1;
   Comodin = "|NC"; Calc = #caconas@#Comodin#;
   |SI Calc > 2; #caconas@#2 = #caconas@#2 + 1; |FINSI;
   NumAsientos = #caconas@#1;

   |GRABA 020#caconas@.a;

   |LIBERA #caconas@;
   |CIERRA #caconas@;
|FPRC;

|RUTINA infe1;
   #asw00023#15 = CodEnlace;
   #asw00023#0 = 001;
|FRUT;

|RUTINA supe1;
   #asw00023#15 = CodEnlace;
   #asw00023#0 = 999;
|FRUT;

|PROCESO Condicion;
/*
   Se devuelve en la variable 'SwCondic' un uno si el registro actual del
   fichero principal del enlace (o de cualquiera de sus relaciones) entra
   dentro de la acotacion que tenemos recogida en el fichero 'asw00023'. Si
   no es asi, devuelve un cero.
*/

   #asw00022#0 = #asw00023#13;
   #asw00022#1 = #asw00023#14;
   |LEE 010#asw00022.=;
   |SI FSalida = 0;
      |SI #asw00022#2 = "A"; Comodin = #asw00022#3; |FINSI;
      |SI #asw00022#2 = "N"; Comodin = #asw00022#4; |FINSI;
      |SI #asw00022#2 = "F"; Comodin = #asw00022#5; |FINSI;
      |SI #asw00023#11 = "A";
         Calc = 100 + #asw00022#6; Comodin = Comodin % Calc;
         DComodin = #asw00023#3; DComodin = DComodin % Calc;
         HComodin = #asw00023#4; HComodin = HComodin % Calc;
         |SI DComodin [ Comodin; |Y Comodin [ HComodin;
            SwCondic = 1;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
      |SI #asw00023#11 = "N";
         |SI #asw00023#5 [ Comodin; |Y Comodin [ #asw00023#6;
            SwCondic = 1;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
      |SI #asw00023#11 = "F";
         FechaCom = Comodin;
         |SI #asw00023#7 [ FechaCom; |Y FechaCom [ #asw00023#8;
            SwCondic = 1;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Condicion;
#asw00023#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Condicion;
|FIN;

|PROCESO BucleFichero;

  |SI #0#8 > "01.01.1900"; #asm00007#4 = #0#8; |FINSI;

/*
   Esta rutina crea los asientos en base a la plantilla que nosotros hemos
   generado anteriormente en la parametrizacion. Recorre el fichero
   'asm00007'. Por cada linea que encuentra de este fichero (que representa
   un asiento) recogeremos los datos que estan relacionados con el registro
   ,miraremos si el registro entra dentro de la acotacion que tenemos y si es
   validado recorreremos el fichero 'asm00008' con la clave correspondiente
*/
   |DBASE Comodin; |QBF Comodin;
   Comodin = Comodin + "def/" + Fich1 + ".mas";
   |CARGA_DEF Comodin, Princip@;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |ABRE #Princip@;

   Fichero = Fich1; |HAZ GeneraSQL;
   |SQL Fichero; aAlfa = FSalida % -102;
   |SI aAlfa ! ":0";
      |CARGA_DEF "tempo",Referen@;
      |SI FSalida = 0;
         |ABRE #Referen@;
         |SI #asm00006#2 = "CB"; |SELECT #3#Referen@; |FINSI;

         NumAsto = NumAsto + 1;
         |LEE 101#Referen@.p;
         |SI FSalida = 0;
            |PARA; |SI FSalida = 0; |HACIENDO;
               |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
               |PINTA 2310, Mensaje; |ATRI R;

               FichRelac = Fich1; |HAZ ResuelveRels;
               SwCondic = 0;

               |ABRE #asw00022;
               |BUCLE Condicion;
               |SI SwCondic = 1;
                  || Primero reviso si el asiento ya ha sido enlazado ...

                  |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                     ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                     InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
                     ICmp1ClaveCab = Cmp1ClaveCab1<-;  ICmp1ClaveCab = ICmp1ClaveCab + Cont;
                     ICmp2ClaveCab = Cmp2ClaveCab1<-;  ICmp2ClaveCab = ICmp2ClaveCab + Cont;
                     |SI #asm00006#2 = TiposEnlaces;
                        Diario = nAsiento;
                        |SI #asm00006#8 = "S"; Diario = Diario + 7; |FINSI;
                        Fecha  = Diario + 1; Docum  = Diario + 2; nAsient = Diario + 3;
                        |SI #Referen@#Docum# ! 0;
                        || .... y si ha sido enlazado , escribimos las lineas pertinentes
                        ||      del fichero de enlace para que las borre
                           |DDEFECTO #caenlac@;
                           #caenlac@#0 = #Referen@#Diario#;
                           #caenlac@#1 = #Referen@#Fecha#;
                           #caenlac@#2 = #Referen@#Docum# + (#asm00007#2 - 1);
                           #caenlac@#3 = 0;
                           |SI #asm00006#8 = "S";
                              |SI #asm00006#2 = "FC";
                                 Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
                                 #caenlac@#37 = Comodin;
                                 Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
                              |FINSI;
                              |SI #asm00006#2 = "CB";
                                 Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
                                 #caenlac@#37 = Comodin;
                                 Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
                              |FINSI;
                              fFechaC  = Comodin;
                              ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
                              Comodin  = Comodin % -104; |QBF Comodin;
                              Ejerc    = Comodin;
                              Empresa  = #caenlac@#37;
                              Periodo = -1; nOpera = 1;
                              |HAZ BuscaPer; #caenlac@#38 = Periodo; nOpera = 0;
                              aAlfa = Empresa; |QBF aAlfa;
                              aAlfa = "Tratando empresa " + (("00000" + aAlfa) % -105) + "/" + Periodo + "     ";
                              |ATRI I; |PINTA 2410,aAlfa; |ATRI N;
                           |FINSI;
                           |LEE 000#caenlac@.=;
                           |SI FSalida ! 0;
                              #caenlac@#0 = #Referen@#Diario#;
                              #caenlac@#1 = #Referen@#Fecha#;
                              #caenlac@#2 = #Referen@#Docum# + (#asm00007#2 - 1);
                              #caenlac@#3 = 0;
                              #caenlac@#9 = 0;
                              #caenlac@#25 = "S";
                              |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
                           |FINSI;
                           NumAsientos = #Referen@#Docum# + (#asm00007#2 - 1); UltFecha = #Referen@#Fecha#;
                           |SI NumAstoAnt ! NumAsientos; |O nEmprAnt ! Empresa; |O nPeriAnt ! Periodo;
                              NumApunte = 1; NumAcum = 1; nVuelta = 0;
                           |FINSI;
                           NumAstoAnt = NumAsientos;
                           nEmprAnt   = Empresa;
                           nPeriAnt   = Periodo;
                           |SI #asm00006#2 = "CB";
                              Fich = "asparcia"; Cmp = 14; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0;
                              nCalc = Comodin;
                              |SI nCalc ! nRemAnt; |Y nRemAnt = 0;
                                 nRemAnt = nCalc;
                              |FINSI;
                           |FINSI;

                           #asw00031#0 = #Referen@#Diario#;
                           #asw00031#1 = #Referen@#Fecha#;
                           #asw00031#2 = #Referen@#Docum# + (#asm00007#2 - 1);
                           #asw00031#3 = 0;
                           |LEE 000#asw00031.=;
                           |SI FSalida ! 0;
                              |DDEFECTO #asw00031;
                              #asw00031#0 = #Referen@#Diario#;
                              #asw00031#1 = #Referen@#Fecha#;
                              #asw00031#2 = #Referen@#Docum# + (#asm00007#2 - 1);
                              #asw00031#3 = 0;
                              |GRABA 020#asw00031.n;
                           |FINSI;
                        |SINO;
                           |SI #asm00006#8 = "S";
                              |SI #asm00006#2 = "FC";
                                 Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0;
                                 Empresa = Comodin;
                                 Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
                              |FINSI;
                              |SI #asm00006#2 = "CB";
                                 Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
                                 Empresa = Comodin;
                                 Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
                              |FINSI;
                              fFechaC  = Comodin;
                              ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
                              Comodin = Comodin % -104; |QBF Comodin;
                              Ejerc   = Comodin; Periodo = -1; nOpera = 1; |HAZ BuscaPer; nOpera = 0;
                              aAlfa = Empresa; |QBF aAlfa;
                              aAlfa = "Tratando empresa " + (("00000" + aAlfa) % -105) + "/" + Periodo + "     ";
                              |ATRI I; |PINTA 2410,aAlfa; |ATRI N;
                              |SI EmpAnt ! Empresa; |O PerAnt ! Periodo;
                                 EmpAnt = Empresa; PerAnt = Periodo;
                                 NumAsientos = -1; NumApunte = 1; NumAcum = 1;
                              |FINSI;
                           |FINSI;
                        |FINSI;
                        |SAL;
                     |FINSI;
                  |SIGUE;

                  |SI Modo = "B"; |ACABA; |FINSI;

                  |SI #asm00007#5 = "N";
                     Calc = Cmp1ClaveCab; Comodin1 = #Referen@#Calc#;
                     Calc = Cmp2ClaveCab; Comodin2 = #Referen@#Calc#;
                     |SI #Referen@#Docum# = 0;
                        |SI ClaveCabAnt1 ! Comodin1; |O ClaveCabAnt2 ! Comodin2;
                           NumAsientos = -1; NumApunte = 1; NumAcum = 1;
                           ClaveCabAnt1 = Comodin1;
                           ClaveCabAnt2 = Comodin2;
                        |FINSI;
                     |FINSI;
                  |FINSI;

                  SwError = 0;
                  |SI NumAsientos < 0;
                     |HAZ Contador; NumApunte = 1;
                      nVuelta = 0;   NumAcum = 1;
                     |SI #asm00006#2 = "CB";
                        Fich = "asparcia"; Cmp = 14; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0;
                        nCalc = Comodin; nRemAnt = nCalc;
                     |FINSI;
                  |FINSI;

                  |SI SwError = 0; |HAZ Asiento; |FINSI;
               |FINSI;
               |CIERRA #asw00022;
               |LIBERA #Referen@;
               |LEE 101#Referen@.s;
               nVuelta = nVuelta + 1;
            |SIGUE;
         |FINSI;
         |LIBERA #Referen@;
         |SI #asm00006#2 = "CB"; |SELECT #1#Referen@; |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |FINSI;
   |SINO;
      |MENAV "    Seleccion vacia";
   |FINSI;

   |CIERRA #Princip@; |DESCARGA_DEF #Princip@;
   |BUCLE RevisaPuente;
|FPRC;

|DEFBUCLE Asientos;
 #asm00007#1;
 ;
 CodEnlace,000001;
 CodEnlace,999999;
 ;
 NULL, BucleFichero;
|FIN;

|PROCESO Deshaz;
   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
      ICmpEnlace    = CmpEnlace1<-;    ICmpEnlace    = ICmpEnlace    + Cont;
      ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
      ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
      ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
      |SI #asm00006#2 = TiposEnlaces;
         Diario = nAsiento;
         ||  |SI #asm00006#8 = "S"; Diario = Diario + 7; |FINSI;         || Tique 1243_1924 y 1002_416
         Fecha = Diario + 1; Docum = Fecha + 1; nAsient = Docum + 1;     || da error 43, pues luego vuelve a sumar 7.

         || Miro si estaba marcado antes de este enlace, en cuyo caso no
         ||     lo vacio ....
         #asw00031#0 = #caenlac@#0;
         #asw00031#1 = #caenlac@#1;
         #asw00031#2 = #caenlac@#2;
         #asw00031#3 = 0;
         |LEE 000#asw00031.=;
         |SI FSalida = 0; |ACABA; |FINSI;

         |SI NumAsto = 1;
            |SI TiposEnlaces = "FC";
               Calc = Campo1Clave; #Princip@#Calc# = #caenlac@#12; aAlfa1a = #caenlac@#12; |QBF aAlfa1a;
               Calc = Campo2Clave; #Princip@#Calc# = #caenlac@#13; aAlfa2a = #caenlac@#13; |QBF aAlfa2a;
               |LEE 101#Princip@.];
               Calc = Campo1Clave; aAlfa1b = #Princip@#Calc#; |QBF aAlfa1b;
               Calc = Campo2Clave; aAlfa2b = #Princip@#Calc#; |QBF aAlfa2b;
               |PARA; |SI FSalida = 0; |Y aAlfa1a = aAlfa1b; |Y aAlfa2a = aAlfa2b; |HACIENDO;
                  |SI #asm00006#8 = "S";
                     Calc = Diario     + 7; #Princip@#Calc# = 0;
                     Calc = Fecha      + 7; #Princip@#Calc# = "01.01.0000";
                     Calc = Docum      + 7; #Princip@#Calc# = 0;
                     Calc = nAsient    + 7; #Princip@#Calc# = 0;
                     Calc = CmpEmpresa + 7; #Princip@#Calc# = 0;
                     Calc = CmpPeriodo + 7; #Princip@#Calc# = 0;
                     Calc = CmpEnlace  + 7; #Princip@#Calc# = 0;
                  |SINO;
                     Calc = Diario;     #Princip@#Calc# = 0;
                     Calc = Fecha;      #Princip@#Calc# = "01.01.0000";
                     Calc = Docum;      #Princip@#Calc# = 0;
                     Calc = nAsient;    #Princip@#Calc# = 0;
                     Calc = CmpEmpresa; #Princip@#Calc# = 0;
                     Calc = CmpPeriodo; #Princip@#Calc# = 0;
                     Calc = CmpEnlace;  #Princip@#Calc# = 0;
                  |FINSI;
                  |GRABA 020#Princip@.a; |LIBERA #Princip@;
                  |LEE 101#Princip@.s;
                  Calc = Campo1Clave; aAlfa1b = #Princip@#Calc#; |QBF aAlfa1b;
                  Calc = Campo2Clave; aAlfa2b = #Princip@#Calc#; |QBF aAlfa2b;
               |SIGUE;
            |SINO;
               Calc = Campo1Clave; #Princip@#Calc# = #caenlac@#12;
               Calc = Campo2Clave; #Princip@#Calc# = #caenlac@#13;
               Calc = Campo3Clave; #Princip@#Calc# = #caenlac@#14;
               |LEE 101#Princip@.=;
               |SI FSalida = 0;
                  ||#Princip@#Diario#  = #caenlac@#0; #Princip@#Fecha#   = #caenlac@#1;
                  ||#Princip@#Docum#   = #caenlac@#2; #Princip@#nAsient# = #caenlac@#3;
                  |SI #asm00006#8 = "S";
                     Calc = Diario     + 7; #Princip@#Calc# = 0;
                     Calc = Fecha      + 7; #Princip@#Calc# = 0;
                     Calc = Docum      + 7; #Princip@#Calc# = 0;
                     Calc = nAsient    + 7; #Princip@#Calc# = 0;
                     Calc = CmpEmpresa + 7; #Princip@#Calc# = 0;
                     Calc = CmpPeriodo + 7; #Princip@#Calc# = 0;
                     Calc = CmpEnlace  + 7; #Princip@#Calc# = 0;
                  |SINO;
                     Calc = Diario;     #Princip@#Calc# = 0;
                     Calc = Fecha;      #Princip@#Calc# = 0;
                     Calc = Docum;      #Princip@#Calc# = 0;
                     Calc = nAsient;    #Princip@#Calc# = 0;
                     Calc = CmpEmpresa; #Princip@#Calc# = 0;
                     Calc = CmpPeriodo; #Princip@#Calc# = 0;
                     Calc = CmpEnlace;  #Princip@#Calc# = 0;
                  |FINSI;
                  |GRABA 020#Princip@.a; |LIBERA #Princip@;
               |FINSI;
            |FINSI;
         |FINSI;
         |SAL;
      |FINSI;
   |SIGUE;
   |SI FichCab1 = "ashismic";
      #RefCabs@#0 = #caenlac@#12;
      #RefCabs@#1 = #caenlac@#13;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#31 = "N";
          |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;
   |SI FichCab1 = "asparcia";
      #RefCabs@#0 = #caenlac@#12;
      #RefCabs@#1 = #caenlac@#13;
      #RefCabs@#2 = #caenlac@#14;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#10 = "N";
          |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;
|FPRC;

|DEFBUCLE Deshaz;
#caenlac@#4006;
;
00000,0,00,"00.00.0000",000001,0001;
99999,9,99,"31.12.2999",999999,9999;
;
NULL,Deshaz;
|FIN;

|PROCESO LineasLog;

   |SI #asm00006#8 = "S"; |Y #asm00006#2 = "FC";

      |DDEFECTO #Princip@;
      #Princip@#0 = #caenlac@#46;
      #Princip@#1 = #caenlac@#47;
      #Princip@#2 = 001;
      |LEE 000#Princip@.];
      aAlfa  = #caenlac@#46; |QBF aAlfa;
      aAlfa1 = #Princip@#0;  |QBF aAlfa1;
      |PARA; |SI FSalida = 0; |Y aAlfa = aAlfa1; |Y #Princip@#1 = #caenlac@#47; |HACIENDO;
         || Compruebo si se ha grabado el asiento en la cabecera de la minuta
         |SI #Princip@#23 ! #caenlac@#0;  |O #Princip@#24 ! #caenlac@#1;
          |O #Princip@#25 ! #caenlac@#2;  |O #Princip@#27 ! #caenlac@#37;
          |O #Princip@#28 ! #caenlac@#38;
            |SI nSwImpre = 0;
               aAlfa = "    SSe han encontrado problemas de vinculos de minutas. " + &191 + " Imprimir ? ";
               |CONFI aAlfa;
               |SI FSalida = 0;
                  |IMPRE 0;
                  |SI FSalida = 0;
                     nSwImpre = 1;
                     aAlfa = "*" * 91; |IMPRIME aAlfa;
                     aAlfa = "*****" + (" " * 24) + "INFORME DE INCIDENCIAS DEL ENLACE" + (" " * 24) + "*****"; |IMPRIME aAlfa;
                     aAlfa = "*" * 91; |IMPRIME aAlfa;
                     aAlfa = " "; |IMPRIME aAlfa;
                  |SINO;
                     |MENAV "    Imposible abrir impresora";
                     nSwImpre = -1;
                  |FINSI;
               |SINO;
                  nSwImpre = -1;
               |FINSI;
            |FINSI;
            |SI nSwImpre > 0;
               aAlfa = (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/" + (("000000" + #caenlac@#2) % -106);
               aAlfa = "La factura " + #Princip@#0 + "/" + (("00000" + #Princip@#1) % -105) + " no ha grabado en la linea " + #Princip@#2 + " el asiento vinculado [" + aAlfa + "]";
               |IMPRIME aAlfa;
            |FINSI;
         |FINSI;
         |LEE 000#Princip@.s;
         aAlfa1 = #Princip@#0;  |QBF aAlfa1;
      |SIGUE;
   |FINSI;

   |DDEFECTO #asm00011;
   #asm00011#0  = #caenlac@#0;
   #asm00011#1  = #caenlac@#1;
   #asm00011#2  = #caenlac@#2;
   #asm00011#3  = #caenlac@#3;
   #asm00011#4  = #caenlac@#4;
   #asm00011#5  = #caenlac@#5;
   #asm00011#6  = #caenlac@#6;
   #asm00011#7  = #caenlac@#7;
   #asm00011#8  = #caenlac@#8;
   #asm00011#9  = #caenlac@#9;
   #asm00011#10 = #caenlac@#16;
   #asm00011#11 = #caenlac@#16;
   #asm00011#12 = #caenlac@#37;
   #asm00011#13 = #caenlac@#38;
   |SI #asm00011#9 ! 0; |GRABA 020#asm00011.n; |FINSI;

   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
      |SI #asm00006#2 = TiposEnlaces;
         |SAL;
      |FINSI;
   |SIGUE;

|FPRC;

|DEFBUCLE LineasLog;
  #caenlac@#4006;
  ;
  00000,0,00,"00.00.0000",000001,0001;
  99999,9,99,"31.12.2999",999999,9999;
  ;
  NULL,LineasLog;
|FIN;

|PROCESO GraboW23;
   |DDEFECTO #asw00023;
   #asw00023#0 = nSw;
   #asw00023#1 = "Historico Minutas L";
   |SI nSw = 1;
       #asw00023#2  = "Serie";
       #asw00023#3  = aDSerie;
       #asw00023#4  = aHSerie;
       #asw00023#9  = aDSerie;
       #asw00023#10 = aHSerie;
       #asw00023#11 = "A";
       #asw00023#12 = 2;
       #asw00023#14 = 0;
       #asw00023#16 = 10;
   |SINO;
       #asw00023#2 = "Factura";
       #asw00023#5  = nDNumero;
       #asw00023#6  = nHNumero;
       #asw00023#9  = nDNumero;
       #asw00023#10 = nHNumero;
       #asw00023#11 = "N";
       #asw00023#12 = 5;
       #asw00023#14 = 1;
       #asw00023#16 = 20;
   |FINSI;
   #asw00023#13 = "ashismil";
   #asw00023#15 = #asm00010#0;
   #asw00023#17 = "S";
   |SI aDSerie = aHSerie; |Y nDNumero = nHNumero;
       #asw00023#17 = "N";
   |FINSI;
   |GRABA 020#asw00023.n;
|FPRC;

|PROCESO LeoAsw00050;
   |SI nHay = 0;
       aDSerie  = #asw00050#1;
       nDNumero = #asw00050#2;
       aHSerie  = #asw00050#1;
       nHNumero = #asw00050#2;
   |FINSI;
   |SI #asw00050#1 ] aHSerie;  aHSerie  = #asw00050#1; |FINSI;
   |SI #asw00050#2 ] nHNumero; nHNumero = #asw00050#2; |FINSI;

   nHay = 1;
|FPRC;

|DEFBUCLE LeoAsw00050;
   #asw00050#1;
   ;
   001;
   999;
   ;
   NULL, LeoAsw00050;
|FIN;

|PROCESO RellenoW0050;
   nHay = 0;
   aDSerie = ""; aHSerie = "";
   nDNumero = 0; nHNumero = 0;
   |BUCLE LeoAsw00050;
   |SI nHay = 1;
       nSw = 1; |HAZ GraboW23;
       nSw = 2; |HAZ GraboW23;
   |FINSI;
|FPRC;

|PROCESO RellenaAcot;
   |DDEFECTO #asw00023;
   |PARA Cont = 0; |SI Cont [ 17; |HACIENDO Cont = Cont + 1;
      #asw00023#Cont# = #asm00009#Cont#;
   |SIGUE;
   |GRABA 020#asw00023.n;
|FPRC;

|DEFBUCLE RellenaAcot1;
  #asm00009#2;
  ;
  CodEnlace,"S",001;
  CodEnlace,"S",999;
  ;
  NULL,RellenaAcot;
|FIN;

|DEFBUCLE RellenaAcot2;
#asm00009#2;
;
CodEnlace,"N",001;
CodEnlace,"N",999;
;
NULL,RellenaAcot;
|FIN;

|PROGRAMA;
   |HAZ EsAppVisados;

   |SI enDesdeActual = 1;
       |NOME_DAT #asw00050#eaFichero#;
   |FINSI;

   eaProcedencia = "FACTURAR";
   |SI PARAMETRO ! "";
      CodEnlace = PARAMETRO;
      CodEnlace = CodEnlace - "|";
      |SI FSalida ! 0;
         Calc = (((FSalida / 100) ! 0) * 100) + 99;
         PathAplic = CodEnlace % Calc;
         CodEnlace = CodEnlace - PathAplic;
         Comodin = PathAplic % -112;
         Comodin = PathAplic - Comodin;
      |SINO;
         |DFICE PathAplic;
         |DBASS Comodin; |QBF Comodin;
         Comodin = Comodin + "contagen/";
      |FINSI;

      Comodin1 = Comodin + "def/calibros.mas";
      |CARGA_DEF Comodin1, calibro@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |ACABA;
      |FINSI;

      Comodin1 = Comodin + "def/caivaasi.mas";
      |CARGA_DEF Comodin1, caivasi@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |DESCARGA_DEF #calibro@;
          |ACABA;
      |FINSI;

      Comodin1 = Comodin + "def/caivases.mas";
      |CARGA_DEF Comodin1, caivase@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |DESCARGA_DEF #caivasi@;
          |DESCARGA_DEF #calibro@;
          |ACABA;
      |FINSI;

      |PATH_DAT #13 PathAplic;
      |PATH_DAT #2 PathAplic;
      |PATH_DAT #3 PathAplic;
      CodEnlace = CodEnlace - ",B";
      |SI FSalida ! 0; Modo = "B"; |FINSI;

      |ABRE #asm00006;
      #asm00006#0 = CodEnlace;
      |LEE 000#asm00006.=;
      |SI FSalida = 0;
         PathEnlace = #asm00006#6;
         #asm00010#0 =#asm00006#0;
         #asm00010#1 =#asm00006#1;
         #asm00010#4 =#asm00006#4;
         #asm00010#5 =#asm00006#5;
         |HAZ MiraEmp;
      |FINSI;
      |CIERRA #asm00006;
      FSalida = 0;

   |SINO;

      |DFICE PathAplic;
      |DBASS Comodin; |QBF Comodin;

      Comodin = Comodin + "contagen/";
      Comodin1 = Comodin + "def/calibros.mas";
      |CARGA_DEF Comodin1, calibro@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |ACABA;
      |FINSI;

      Comodin1 = Comodin + "def/caivaasi.mas";
      |CARGA_DEF Comodin1, caivasi@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |DESCARGA_DEF #calibro@;
          |ACABA;
      |FINSI;

      Comodin1 = Comodin + "def/caivases.mas";
      |CARGA_DEF Comodin1, caivase@;
      |SI FSalida ! 0;
          |MENAV "   Error al cargar fichero referencia";
          |DESCARGA_DEF #caivasi@;
          |DESCARGA_DEF #calibro@;
          |ACABA;
      |FINSI;

      Comodin1 = Comodin + "fich/" + ((("00000" + #asm00010#4) % -105) + #asm00010#5) + "/";
      |PATH_DAT #26 Comodin1;

      |CLS;
      |PINPA #0#0;
      |PINDA #0#0;
      |ENDATOS #1#asm00010;
   |FINSI;

   |SI FSalida = 0;
      |SI PARAMETRO = "";
         CodEnlace = #asm00010#0;
         |DELINDEX #asw00023;

         |ABRE #asw00023;
         |SI enDesdeActual = 1;
             |HAZ RellenoW0050;
         |FINSI;
         |SI enDesdeActual ! 1; |O nHay = 0;
             |BUCLE RellenaAcot1;
         |FINSI;
         |PARA; |SI; |HACIENDO;
            |ENTLINEAL #2#asw00023,-3,1,21,1,infe1,supe1;
            |MENU Menu;
            Opcion = FSalida;
            |SI Opcion = 2; Salir = 0; |SAL; |FINSI;
            |SI Opcion = 3; Salir = 1; |SAL; |FINSI;
         |SIGUE;
         |BUCLE RellenaAcot2;
         |CIERRA #asw00023;
      |SINO;
         |HAZ TomaDefectos;
      |FINSI;

      |SI Salir = 1; |ACABA; |FINSI;

|| ... Proceso nuevo para seleccion de Empresas por tipos
   || ... enSwRel = 1  seleccionados
   || ... enSwRel = -1   seleccion vacia
   || ... enSwRel = 0   no vale seleccion No hay basica
   |SI enSwRel = -1; |ACABA; |FINSI;
   |SI enSwRel = 1;
       |NOME_DAT #927 eaFicSel;
   |FINSI;
|| ......................................................
      aAlfa = "31" + Usuario;
      |NOME_DAT #asw00031#aAlfa#;
      |DELINDEX #asw00031;
      |ABRE #asw00031;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         IFichCabs     = FichCabs1<-;     IFichCabs     = IFichCabs     + Cont;
         |SI #asm00006#2 = TiposEnlaces;
            Fich1    = Ficheros; FichCab1 = FichCabs;
            |SAL;
         |FINSI;
      |SIGUE;

      |DBASE Direc;
      Comodin = Direc + "def/" + Fich1 + ".mas";
      |CARGA_DEF Comodin, Tempo00@; Ref = Comodin;
      |SI FSalida = 0;
         Comodin = Direc + "def/" + FichCab1 + ".mas";
         |CARGA_DEF Comodin, RefCabs@; RefCab = Comodin; |ABRE #RefCabs@;

         Comodin  = PathEnlace; |QBF Comodin;
         Comodin  = Comodin + "def/";
         Comodin1 = Comodin + "caenlace.mas"; |CARGA_DEF Comodin1, caenlac@;
         Comodin1 = Comodin + "caconasi.mas"; |CARGA_DEF Comodin1, caconas@;
         Comodin2 = ("00000" + #asm00010#4) % -105;
         Comodin2 = Comodin2 + #asm00010#5 + "/";
         Comodin1 = PathEnlace; |QBF Comodin1;
         Comodin1 = Comodin1 + "fich/" + Comodin2;
         |PATH_DAT #23 Comodin1; |PATH_DAT #24 Comodin1;
         |PATH_DAT #19 Comodin1;
         aAlfa = "pu" + Usuario; |NOME_DAT #23 aAlfa;
         aAlfa = "p1" + Usuario; |NOME_DAT #19 aAlfa;
         |DELINDEX #caenlac@; |ABRE #caenlac@;
         |DELINDEX #asw00029;

         |ABRE #asw00029;
         NumAsientos = -1; NumApunte = 1; NumAsto = 0;
         |BUCLE Asientos;          ||  MEOLLO !!!!!!!!! .......

         Comodin2 = ("00000" + #asm00010#4) % -105;
         Comodin2 = Comodin2 + #asm00010#5 + "/";
         fich_alta = Comodin2;

         |HAZ CogeVersion;
         Comodin = PathEnlace; |QBF Comodin;
         Comodin = Comodin - "agicont";
         |SI FSalida = 0;
            Comodin = PathEnlace; |QBF Comodin;
            Comodin = ":contagen/dsapunte;" + Comodin;
         |SINO;
            Comodin = PathEnlace; |QBF Comodin;
            Comodin = ":agicont/dsapunte;" + Comodin;
         |FINSI;

         |SI #asm00006#11 = "S";
             enNoModif = 0;
         |SINO;
             enNoModif = 100;
         |FINSI;

         eaTipoPase = #asm00006#8;
         enCambioCtaIVA = 0;
         |SI #asm00006#8 = "S"; |Y #asm00006#12 = "F";
             enCambioCtaIVA = 1;
         |FINSI;

         Comodin2 = ("00000" + #asm00010#4) % -105;
         Comodin2 = Comodin2 + #asm00010#5 + "/";
         Comodin = Comodin + "fich/" + Comodin2 + ",pu" + Usuario;
         |CIERRA #caenlac@;
         |CIERRA #asw00029;
         |SUB_EJECUTA_NP Comodin;

         |ABRE #caenlac@;

         |LEE 000#caenlac@.c;
         |DELINDEX #asm00011;

         |SI PRMNT_enError = 0;
            ||Cargo en el caso de facturas y orientada a la contabilidad de
            ||   clientes, el def de minutas
            |SI #asm00006#8 = "S"; |Y #asm00006#2 = "FC";
               |DBASE Comodin; |QBF Comodin;
               Comodin = Comodin + "def/" + Fich1 + ".mas";
               |CARGA_DEF Comodin, Princip@;
               |ABRE #Princip@;
            |FINSI;

            |ABRE #asm00011;
            nSwImpre = 0; |BUCLE LineasLog;
            |SI nSwImpre > 0; |FINIMP; |FINSI;
            |CIERRA #asm00011;

            |SI #asm00006#8 = "S"; |Y #asm00006#2 = "FC";
               |CIERRA #Princip@; |DESCARGA_DEF #Princip@;
            |FINSI;
         |SINO;
            |DBASE Comodin; |QBF Comodin;
            Comodin = Comodin + "def/" + Fich1 + ".mas";
            |CARGA_DEF Comodin, Princip@;
            |SI FSalida ! 0; |ACABA; |FINSI;
            |ABRE #Princip@
            |BUCLE Deshaz;
            |CIERRA #Princip@; |DESCARGA_DEF #Princip@;
         |FINSI;

         |DESCARGA_DEF #caconas@;
         |CIERRA #caenlac@; |DESCARGA_DEF #caenlac@;

         |SI PARAMETRO = "";
            |ENTLINEAL #1#asm00011,-6,4,21,1,inferior,superior;
         |FINSI;
         |DESCARGA_DEF #Tempo00@;

         |DBASE Direc; Comodin = Direc + "def/tempo.mas";  |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.dat"; |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.ddx"; |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.ixx"; |FBORRA Comodin;

         |CIERRA #RefCabs@; |DESCARGA_DEF #RefCabs@;
      |FINSI;
      |CIERRA #asw00031; |DELINDEX #asw00031;
   |FINSI;

   |DESCARGA_DEF #caivase@;
   |DESCARGA_DEF #caivasi@;
   |CIERRA #calibro@;
   |DESCARGA_DEF #calibro@;
|FPRO;

|| **************************************************************************
|| **************************************************************************
|| ****              RESOLUCION DE EXPRESIONES Y FORMULAS                ****
|| **************************************************************************
|| **************************************************************************

/*
   Recoge de la variable 'cadena' la expresion a resolver y devuelve el
   valor de la expresion en la variable 'Resultado'
*/

|PROCESO ResuelveExpr;
   |HAZ ResolCampos;

|ET Comienzo;
   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = "";

   Comodin = Cadena;
   Comodin1 = Comodin - "(";
   |SI FSalida ! 0;
      aLong = Comodin % 0; nLong = aLong;
      |PARA Cont = 1; |SI Cont [ nLong; |HACIENDO Cont = Cont + 1;
         Calc = (Cont * 100) + 1;
         Comodin1 = Comodin % Calc;
         |SI Comodin1 = "(";
            PosicAPar = Cont;
            Cad1 = "";
         |SINO;
            |SI Comodin1 = ")";
               PosicCPar = Cont;
               |SI PosicAPar ! 0;
                  |HAZ ResolSimple;
                  Calc1 = 100 + (PosicAPar - 1);
                  Calc2 = ((PosicCPar + 1) * 100) + 99;
                  Comodin1 = Comodin % Calc1;
                  Comodin1 = Comodin1 + Cad1;
                  Comodin1 = Comodin1 + (Comodin % Calc2);
                  Cadena   = Comodin1;
                  |VETE Comienzo;
               |SINO;
                  |MENAV "    Error de sintaxis en la expresion";
                  |ERROR;
                  |ACABA;
               |FINSI;
            |SINO;
               Cad1 = Cad1 + Comodin1;
            |FINSI;
         |FINSI;
      |SIGUE;
   |FINSI;

   Cad1 = Cadena;
   |HAZ ResolSimple;
   Resultado = Cad1;
|FPRC;

|PROCESO ResolSimple;
   Oper1 = 0; Oper2 = 0;
   Operacion = "";
   Cad2 = "";
   Neg = 0;

   aLong = Cad1 % 0; nLong = aLong;

   |PARA Cont1 = 1; |SI Cont1 [ nLong; |HACIENDO Cont1 = Cont1 + 1;
      Calc1 = (Cont1 * 100) + 1;
      Comodin1 = Cad1 % Calc1;
      |SI Comodin1 = "+"; |O Comodin1 = "-";
       |O Comodin1 = "/"; |O Comodin1 = "*";
       |O Comodin1 = "%"; |O Comodin1 = "[";
       |O Comodin1 = "!";
         |SI Oper1 = 0;
            Oper1 = Cad2;
            |SI Neg = 1; Oper1 = 0 - Oper1; Neg = 0; |FINSI;
            |SI Cad2 = "";
               Neg = 1;
            |SINO;
               Operacion = Comodin1;
               Cad2 = "";
               Neg = 0;
            |FINSI;
         |SINO;
            Oper2 = Cad2;
            |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;
            |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;
            |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;
            |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;
            |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;
            |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;
            Operacion = Comodin1; Cad2 = "";
         |FINSI;
      |SINO;
         Cad2 = Cad2 + Comodin1;
      |FINSI;
   |SIGUE;

   |QBF Operacion;
   |SI Operacion ! "";
      Oper2 = Cad2;
      |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;
      |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;
      |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;
      |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;
      |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;
      |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;
   |SINO;
      Oper1 = Cad1;
   |FINSI;
   Cad1 = Oper1;
|FPRC;

|PROCESO ResolCampos;
|| Esta rutina obtiene el valor del campo dado por la expresion
||   [fichero][n§ campo] del temporal de datos relacionados

   Cad1 = "";
   Cad2 = "";
   ||Cadena = #asm00008#8;
   Cadena = Cadena - "][";
   |SI FSalida ! 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         Cadena = Cadena - "[";
         ComodNum = FSalida;
         ComodNum = ((ComodNum / 100) ! 0);
         ComodNum = 100 + (ComodNum - 1);
         Cad1 = Cadena % ComodNum; Cadena = Cadena - Cad1;
         Fich = Cadena % 0108; |QBF Fich; Cadena = Cadena - Fich;
         Cmp  = Cadena % 0103; Cadena = Cadena - Cmp;
         Cadena = Cadena - "]";
         Cad2 = Cadena;
         || ABRE #asw00022;
         |HAZ TomaDatos;
         || CIERRA #asw00022;
         Cadena = Cad1 + Comodin + Cad2;
         Cadena = Cadena - "][";
      |SIGUE;
   |FINSI;
|FPRC;


|| **************************************************************************
|| **************************************************************************
|| ****                     RESOLUCION DE RELACIONES                     ****
|| **************************************************************************
|| **************************************************************************

/*

  La llamada al proceso principal 'ResuelveRels' toma el valor de la variable
  'FichRelac' que contiene el nombre del fichero del cual se resolveran las
  relaciones. En base al registro corriente del fichero 'FichRelac', se
  rellena el fichero 'asw00022' con los registros correspondientes de los
  ficheros relacionados con el indicado.

*/

|PROCESO CargaRegAct;
   ComodNum = #asw00022#1;
   |SI #asw00022#2 = "A"; #FMaster@#ComodNum# = #asw00022#3; |FINSI;
   |SI #asw00022#2 = "N"; #FMaster@#ComodNum# = #asw00022#4; |FINSI;
   |SI #asw00022#2 = "F"; #FMaster@#ComodNum# = #asw00022#5; |FINSI;
|FPRC;

|DEFBUCLE CargaRegAct;
#asw00022#1;
;
#asw00021#1,000;
#asw00021#1,255;
;
NULL,CargaRegAct;
|FIN;

|PROCESO SacaRels;
   |DBASE Direc;
   Comodin = #asw00021#1; |QBF Comodin; FichMaster = Comodin;
   Comodin = Direc + "def/" + Comodin + ".mas";
   |CARGA_DEF Comodin, FMaster@; Mast = Comodin;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;

      |BUCLE CargaRegAct;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin1 = Comodin % 108; NombreRel = Comodin1;
         Comodin = Comodin - Comodin1;
         Comodin = Comodin - "|";
         Comodin = Comodin - "-";
         |SI FSalida = 0;
            |DBASE Direc;
            FichEsclavo = Comodin1;
            Comodin1 = Direc + "def/" + Comodin1 + ".mas";
            |CARGA_DEF Comodin1, FEsclav@; Escl = Comodin1;
            |SI FSalida = 0;
               |ATRI I; Comodin1 = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
               |PINTA 2310, Comodin1; |ATRI R;

               |PATH_DAT #10 PathAplic;
               |ABRE #FEsclav@;

               || Cargo la clave del fichero nuevo y lo busco

               Comodin1 = Comodin % 103;
               Comodin = Comodin - Comodin1;
               Calc2 = Comodin1;

               Clave1 = Comodin;
               Comodin = "|K000";
               Comodin = #FEsclav@#Comodin#;
               Clave2 = Comodin % 0499;
               aClau = "";
               |PARA Cont1 = 0; |SI Cont1 < Calc2; |HACIENDO Cont1 = Cont1 + 1;
                  Comodin = Clave1 % 0103; Clave1 = Clave1 - Comodin; CmpClave1 = Comodin;
                  CmpClave1 = CmpClave1 - 1;
                  Comodin = Clave2 % 0103; Clave2 = Clave2 - Comodin; CmpClave2 = Comodin;
                  #FEsclav@#CmpClave2# = #FMaster@#CmpClave1#;
                  aClau = aClau + #FMaster@#CmpClave1#;
               |SIGUE;

               |LEE 010#FEsclav@.=;

               || Si se encuentra , grabo los datos en el temporal de datos relaccionados

               |SI FSalida = 0;
                  Comodin1 = "|NC";
                  NumCmps = #FEsclav@#Comodin1# - 1;
                  |PARA Cont2 = 0; |SI Cont2 [ NumCmps; |HACIENDO Cont2 = Cont2 + 1;
                     #asw00022#0 = NombreRel;
                     #asw00022#1 = Cont2;
                     |LEE 010#asw00022.=;
                     |SI FSalida ! 0;
                        |DDEFECTO #asw00022;
                        #asw00022#0 = NombreRel;
                        #asw00022#1 = Cont2;
                        Comodin1 = ("000" + Cont2) % -103;
                        Comodin1 = "|C" + Comodin1 + "TIPO";
                        Comodin1 = #FEsclav@#Comodin1#;
                        #asw00022#2 = Comodin1;
                        |SI Comodin1 = "A"; #asw00022#3 = #FEsclav@#Cont2#; |FINSI;
                        |SI Comodin1 = "N"; #asw00022#4 = #FEsclav@#Cont2#; |FINSI;
                        |SI Comodin1 = "F"; #asw00022#5 = #FEsclav@#Cont2#; |FINSI;
                        Comodin1 = ("000" + Cont2) % -103;
                        Comodin1 = "|C" + Comodin1 + "LONGITUD";
                        #asw00022#6 = #FEsclav@#Comodin1#;
                        |HAZ EspAdade;
                        |GRABA 020#asw00022.n; |LIBERA #asw00022;
                     |FINSI;
                  |SIGUE;

                  |SALVA_FICHA #asw00021;
                  |SELECT #2#asw00021;
                  #asw00021#1 = NombreRel;
                  |LEE 000#asw00021.=;
                  |SI FSalida ! 0;
                     |DDEFECTO #asw00021;
                     #asw00021#0 = LinRel; LinRel = LinRel + 1;
                     #asw00021#1 = NombreRel;
                     |GRABA 000#asw00021.n;
                  |FINSI;
                  |SELECT #1#asw00021;
                  |REPON_FICHA #asw00021;
               |FINSI;

               |CIERRA #FEsclav@;
               |DESCARGA_DEF #FEsclav@;
            |FINSI;
         |FINSI;
      |SIGUE;
      |CIERRA #FMaster@;
      |DESCARGA_DEF #FMaster@;
   |FINSI;
   |BORRA 020#asw00021.a;
|FPRC;

|PROCESO ResuelveRels;

|| Esta rutina rellena un temporal con el registro del fichero principal que
||   se esta tratando, ademas de rellenarlo con los registros de todos los
||   ficheros que estan relacionados con el. Para esto se apoya sobre un
||   temporal que indica los ficheros relacionados con el fichero principal
||   y los relacionados entre si, comenzando luego escribiendo el registro
||   actual del fichero principal y buscando los registros relacionados a
||   partir de ahi


||  Primero, rellenamos el temporal para saber todos los ficheros que
||    tendremos que leer ....
   |PATH_DAT #8 PathAplic;
   aAlfa = "t1" + Usuario; |NOME_DAT #7 aAlfa;
   aAlfa = "t2" + Usuario; |NOME_DAT #8 aAlfa;
   |DELINDEX #asw00021; |DELINDEX #asw00022;
   |ABRE #asw00021; |ABRE #asw00022;
   LinRel = 1;

   |DDEFECTO #asw00021;
   #asw00021#0 = LinRel; LinRel = LinRel + 1;
   #asw00021#1 = FichRelac;
   |GRABA 020#asw00021.n;

   |DBASE Direc;
   FichMaster = FichRelac;
   Comodin = Direc + "def/" + FichRelac + ".mas";
   |CARGA_DEF Comodin, FMaster@; Mast = Comodin;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;
      aClau = "";
      Comodin1 = "|NC";
      NumCmps = #FMaster@#Comodin1# - 1;
      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         #FMaster@#Cont# = #Referen@#Cont#;
           aClau = aClau + #Referen@#Cont#;
      |SIGUE;
      |LEE 000#FMaster@.=;

      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         |DDEFECTO #asw00022;
         #asw00022#0 = FichRelac;
         #asw00022#1 = Cont;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "TIPO";
         Comodin1 = #FMaster@#Comodin1#;
         #asw00022#2 = Comodin1;
         |SI Comodin1 = "A"; #asw00022#3 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "N"; #asw00022#4 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "F"; #asw00022#5 = #FMaster@#Cont#; |FINSI;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "LONGITUD";
         #asw00022#6 = #FMaster@#Comodin1#;
         |HAZ EspAdade;
         |GRABA 020#asw00022.n;
      |SIGUE;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin = Comodin % 108;
         |DDEFECTO #asw00021;
         #asw00021#0 = LinRel; LinRel = LinRel + 1;
         #asw00021#1 = Comodin;
         |GRABA 020#asw00021.n;
      |SIGUE;

      |CIERRA #FMaster@;
      |DESCARGA_DEF #FMaster@;
   |FINSI;

||  ... y una vez lo tenemos , vamos obteniendo los registros relacionados
||   con el registro actual del fichero principal o con cualquiera
||   relacionado con este

   |LEE 010#asw00021.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      |HAZ SacaRels;
      |LEE 010#asw00021.p;
   |SIGUE;

   |CIERRA #asw00022; |CIERRA #asw00021;
|FPRC;

|PROCESO EscogeFic;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

         TipoDato = #asw00023#11; LongDato = #asw00023#12;
         |SI TipoDato = "A";
            |CAMPO_ANCHO #asw00023#3,1,LongDato;
            |CAMPO_MAXIMO #asw00023#3,1,"#";
            |CAMPO_ANCHO #asw00023#4,1,LongDato;
            |CAMPO_MAXIMO #asw00023#4,1,"#";
            |C_M #asw00023#3,1,"S"; |C_V #asw00023#3,1,"S"; |PINTA #asw00023#3;
            |C_M #asw00023#4,1,"S"; |C_V #asw00023#4,1,"S"; |PINTA #asw00023#4;
            |C_M #asw00023#5,1,"N"; |C_V #asw00023#5,1,"N";
            |C_M #asw00023#6,1,"N"; |C_V #asw00023#6,1,"N";
            |C_M #asw00023#7,1,"N"; |C_V #asw00023#7,1,"N";
            |C_M #asw00023#8,1,"N"; |C_V #asw00023#8,1,"N";
         |FINSI;
         |SI TipoDato = "N";
            |C_M #asw00023#3,1,"N"; |C_V #asw00023#3,1,"N";
            |C_M #asw00023#4,1,"N"; |C_V #asw00023#4,1,"N";
            |C_M #asw00023#5,1,"S"; |C_V #asw00023#5,1,"S"; |PINTA #asw00023#5;
            |C_M #asw00023#6,1,"S"; |C_V #asw00023#6,1,"S"; |PINTA #asw00023#6;
            |C_M #asw00023#7,1,"N"; |C_V #asw00023#7,1,"N";
            |C_M #asw00023#8,1,"N"; |C_V #asw00023#8,1,"N";
         |FINSI;
         |SI TipoDato = "F";
            |C_M #asw00023#3,1,"N"; |C_V #asw00023#3,1,"N";
            |C_M #asw00023#4,1,"N"; |C_V #asw00023#4,1,"N";
            |C_M #asw00023#5,1,"N"; |C_V #asw00023#5,1,"N";
            |C_M #asw00023#6,1,"N"; |C_V #asw00023#6,1,"N";
            |C_M #asw00023#7,1,"S"; |C_V #asw00023#7,1,"S"; |PINTA #asw00023#7;
            |C_M #asw00023#8,1,"S"; |C_V #asw00023#8,1,"S"; |PINTA #asw00023#8;
         |FINSI;
|FPRC;

|PROCESO TomaVal;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

   |SI TipoDato = "A"; #asw00023#9 = #asw00023#3; #asw00023#10 = #asw00023#4; |FINSI;
   |SI TipoDato = "N"; #asw00023#9 = #asw00023#5; #asw00023#10 = #asw00023#6; |FINSI;
   |SI TipoDato = "F"; #asw00023#9 = "   " + #asw00023#7; #asw00023#10 = "   "+ #asw00023#8; |FINSI;

   |C_M #asw00023#3,1,"N"; |C_V #asw00023#3,1,"N";
   |C_M #asw00023#4,1,"N"; |C_V #asw00023#4,1,"N";
   |C_M #asw00023#5,1,"N"; |C_V #asw00023#5,1,"N";
   |C_M #asw00023#6,1,"N"; |C_V #asw00023#6,1,"N";
   |C_M #asw00023#7,1,"N"; |C_V #asw00023#7,1,"N";
   |C_M #asw00023#8,1,"N"; |C_V #asw00023#8,1,"N";
                           |C_V #asw00023#9,1,"S";
                           |C_V #asw00023#10,1,"S";
|FPRC;

|PROCESO MiraEmp;

   Tecla = FSalida;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI #asm00006#8 = "S"; |ACABA; |FINSI;

   Comodin  = PathEnlace; |QBF Comodin;
   Comodin1 = Comodin;
   Comodin  = Comodin + "def/canempre.mas";
   Comodin1 = Comodin1 + "fich/";
   |CARGA_DEF Comodin, canempr@;
   |SI FSalida = 0;
      |PATH_DAT #20 Comodin1;
      |ABRE #canempr@;
      |SI Tecla = 10;
         |CONSULTA_CLAVE #1#canempr@;
         |SI FSalida ] 0;
            #asm00010#4 = #canempr@#2; |PINTA #asm00010#4;
            #asm00010#5 = #canempr@#3; |PINTA #asm00010#5;
            Dig1 = #canempr@#14; Dig2 = #canempr@#15; Dig3 = #canempr@#16;
            Dig4 = #canempr@#17; Dig5 = #canempr@#18; Dig6 = #canempr@#19;
            |PINTA 0738, #canempr@#1;
         |SINO;
            |ERROR;
         |FINSI;
      |SINO;
         #canempr@#2 = #asm00010#4;
         #canempr@#3 = #asm00010#5;
         |LEE 010#canempr@.=;
         |SI FSalida = 0;
            Dig1 = #canempr@#14; Dig2 = #canempr@#15; Dig3 = #canempr@#16;
            Dig4 = #canempr@#17; Dig5 = #canempr@#18; Dig6 = #canempr@#19;
            |SI PARAMETRO = ""; |PINTA 0738, #canempr@#1; |FINSI;
         |SINO;
            |MENAV "    Empresa inexistente";
            |ERROR;
         |FINSI;
      |FINSI;

      Comodin = "|NC"; Comodin = #canempr@#Comodin#;

      |SI Comodin = 27;
         Comodin  = PathEnlace; |QBF Comodin;
         Comodin1 = Comodin;
         Comodin  = Comodin + "def/camoneda.mas";
         Comodin1 = Comodin1 + "fich/000000/";
         |CARGA_DEF Comodin , camoned@;
         |SI FSalida = 0;
            |PATH_DAT #25 Comodin1;
            |ABRE #camoned@;
            #camoned@#0 = #asm00010#4; #camoned@#1 = #asm00010#5;
            |LEE 000#camoned@.=;
            |SI FSalida = 0;
               |SI #camoned@#2 = "P";
                  EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
               |SINO;
                  EURO = 166.386; EURODB = 2; EURODV = 0;
               |FINSI;
            |SINO;
               EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
            |FINSI;
            |CIERRA #camoned@; |DESCARGA_DEF #camoned@;
         |FINSI;
      |SINO;
         |SI #canempr@#28 = "P";
            EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
         |SINO;
            EURO = 166.386; EURODB = 2; EURODV = 0;
         |FINSI;
      |FINSI;

      |CIERRA #canempr@;
      |DESCARGA_DEF #canempr@;
   |FINSI;
|FPRC;

|PROCESO TomaDefectos;
   |SI PARAMETRO = "";
      CodEnlace = #asm00010#0;
   |SINO;
      Comodin = PARAMETRO;
      Comodin = Comodin - ",M";
      |SI FSalida ! 0; Modif = "S"; |SINO; Modif = "N"; |FINSI;
      Comodin = Comodin - ",E";
      |SI FSalida ! 0; Emision = "S"; |SINO; Emision = "N"; |FINSI;
      Comodin = Comodin - ",B";
      |SI FSalida ! 0; Modo = "B"; |FINSI;
      CodEnlace = Comodin;
   |FINSI;
   |ABRE #asm00006;
   #asm00006#0 = CodEnlace;
   |LEE 010#asm00006.=;
   |SI FSalida = 0;
      Empresa = #asm00006#4;
      Periodo = #asm00006#5;
      PathEnlace = #asm00006#6;
      #asm00010#4 = Empresa; |PINTA #asm00010#4;
      #asm00010#5 = Periodo; |PINTA #asm00010#5;
      |SI #asm00006#8 = "S";
         |C_M #asm00010#4,1,"N";
         |C_M #asm00010#5,1,"N";
      |SINO;
         |C_M #asm00010#4,1,"S";
         |C_M #asm00010#5,1,"S";
      |FINSI;
   |FINSI;

   |CIERRA #asm00006;
|FPRC;

|PROCESO FNueva7; |TIPO 7;
 |SI #asm00006#9 = "N";
     #asm00010#8 = "01.01.0000";
     |PINTA #asm00010#8;
     |PTEC 802;
 |FINSI;
|FPRC;

|PROCESO FNueva0; |TIPO 0;

 |PINTA 0832, "                                   ";
 |SI #asm00006#10 = "S";
     eaCodPase = #asm00006#0;
     |SUB_EJECUTA_NP "asz00003";
     |SI enSwRel = 1;
         aAlfa1 = nGTempo; |QBF aAlfa1;
         aAlfa1 = "Seleccionada(s) " + aAlfa1 + " Empresa(s) por Tipo ";

         |ATRI S; |PINTA 0832, aAlfa1; |ATRI 0;
     |SINO;
         |PINTA 0832, "                                         ";
     |FINSI;
 |FINSI;
|FPRC;


|PROCESO ActMarca;
   |SI MarcaPant = "|"; MarcaPant = "/"; |ACABA; |FINSI;
   |SI MarcaPant = "/"; MarcaPant = "-"; |ACABA; |FINSI;
   |SI MarcaPant = "-"; MarcaPant = "\"; |ACABA; |FINSI;
   |SI MarcaPant = "\"; MarcaPant = "|"; |ACABA; |FINSI;
|FPRC;

|PROCESO Acotaciones;

   aAlfa1 = #asw00023#13; |QBF aAlfa1;
   |SI aAlfa1 ! Fich1; |ACABA; |FINSI;

   Comodin1 = " " * #asw00023#12; Calc = -(100 + #asw00023#12);
   |SI #asw00023#11 = "A";
      Calc = -Calc;
      aAlfa1 = #asw00023#3; |QBF aAlfa1; aAlfa1 = (aAlfa1 + Comodin1) % Calc;
      aAlfa2 = #asw00023#4; |QBF aAlfa2; aAlfa2 = (aAlfa2 + Comodin1) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + #asw00023#14 + " == '" + aAlfa1 + "' ";
      |SINO;
         Comodin = Comodin + #asw00023#14 + " BETWEEN " + aAlfa1 + ", " + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SI #asw00023#11 = "N";
      aAlfa1 = #asw00023#5; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #asw00023#6; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + #asw00023#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + #asw00023#14 + " BETWEEN " + aAlfa1 + ", " + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SI #asw00023#11 = "F";
      aAlfa1 = #asw00023#7; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #asw00023#8; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + #asw00023#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + #asw00023#14 + " BETWEEN " + aAlfa1 + "," + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SALVA_FICHA #asw00023;
   |LEE 000#asw00023.s;
   |SI FSalida = 0;
      aAlfa1 = #asw00023#13; |QBF aAlfa1;
      |SI aAlfa1 = Fich1; Comodin = Comodin + "AND "; |FINSI;
   |FINSI;
   |REPON_FICHA #asw00023;
|FPRC;

|DEFBUCLE Acotaciones;
#asw00023#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Acotaciones;
|FIN;

|PROCESO GeneraSQL;
   Cadena = "SELECT * FROM " + Fichero + " INTO tempo.def WHERE ";
   Comodin = ""; |BUCLE Acotaciones; Cadena = Cadena + Comodin;
   Fichero = Cadena;
|FPRC;

|PROCESO AntesLibro; |TIPO 7;
   |SI #asm00006#2 = "CB";
      #asm00010#6 = 0;  |PINTA #asm00010#6;
      #asm00010#7 = ""; |PINTA #asm00010#7;
      |C_M #asm00010#6,1,"N";
   |SINO;
      |C_M #asm00010#6,1,"S";
   |FINSI;
|FPRC;

|PROCESO TrasLibro;
   |SI #asm00006#2 = "CB"; |ACABA; |FINSI;
   |SI #asm00006#8 = "S";  |ACABA; |FINSI;

   |DBASS Comodin; |QBF Comodin; Comodin = Comodin + "contagen/";
   Comodin1 = Comodin + "fich/" + ((("00000" + #asm00010#4) % -105) + #asm00010#5) + "/";
   |PATH_DAT #26 Comodin1;
   |ABRE #calibro@;
   #calibro@#0 = #asm00010#6;
   |LEE 000#calibro@.=;
   |SI FSalida = 0;
      #asm00010#7 = #calibro@#1; |PINTA #asm00010#7;
      |SI #calibro@#2 ! "R";
          |MENAV "     Libro de IVA No Correcto";
          |ERROR;
      |FINSI;
   |SINO;
      |MENAV "    Libro inexistente";
      |ERROR;
   |FINSI;
   |CIERRA #calibro@;
|FPRC;

|PROCESO Prueba;
   |CARGA_DEF "ashismic.mas", FMaster@;
   |SQL "SELECT * FROM ashismic INTO tempo.def WHERE 0 == 16 AND 1 BETWEEN 488,489";
   || |SQL "SELECT @file.txt";
   |CARGA_DEF "tempo",Referen@;
   |ABRE #Referen@;
   |LEE 000#Referen@.p
   |PARA; |SI FSalida = 0; |HACIENDO;
      |LEE 000#Referen@.s;
   |SIGUE;
   |CIERRA #Referen@;
   |DESCARGA_DEF #Referen@;
|FPRC;

|| *********** Nuevo ADADE
|PROCESO EspAdade;
 |SI #asw00022#0 = "ascuenco"; |Y #asw00022#1 = 3;
     aAlfa1 = #asw00022#3; |QBF aAlfa1;
     |SI aAlfa1 = "DESGLOSE";
         aAlfa2 = nClau0;
         aAlfa3 = nClau1; |QBF aAlfa3; aAlfa3 = ("00000" + aAlfa3) % -105;
         aAlfa2 = aAlfa2 + aAlfa3 + aClau2;
         aAlfa3 = nClau3; |QBF aAlfa3; aAlfa3 = ("00000" + aAlfa3) % -105;
         aAlfa2 = aAlfa2 + aAlfa3;
         aAlfa3 = nClau4; |QBF aAlfa3; aAlfa3 = ("000" + aAlfa3) % -103;
         aAlfa2 = aAlfa2 + aAlfa3;
         aAlfa3 = nClau5; |QBF aAlfa3; aAlfa3 = ("              " + aAlfa3) % -114;
         aAlfa2 = aAlfa2 + aAlfa3;

         aAlfa1 = aAlfa1 + aClau + aAlfa2;
         #asw00022#3 = aAlfa1;
     |FINSI;
     |ACABA;
 |FINSI;
 |SI #asw00022#0 = "ashismic";
     |SI #asw00022#1 = 2; nClau0 = #asw00022#4; |FINSI; || tipo facturacion
     |SI #asw00022#1 = 3; nClau1 = #asw00022#4; |FINSI; || cliente
     |SI #asw00022#1 = 0;
         aClau2 = #asw00022#3; |QBF aClau2;
         aClau2 = (aClau2 + "  ") % 102;
     |FINSI; || Serie
     |SI #asw00022#1 = 1; nClau3 = #asw00022#4; |FINSI; || Factura
 |FINSI;
 |SI #asw00022#0 = "ashismil";
     |SI #asw00022#1 = 2;  nClau4 = #asw00022#4; |FINSI; || Linea factura
     |SI #asw00022#1 = 13; nClau5 = #asw00022#4; |FINSI; || Importe de la linea
 |FINSI;
|FPRC;



|PROCESO ParaElDesglose;
   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   SwNivel = 0;
   |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
   |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
   |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
   |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
   |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
   |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
   |SI SwNivel = 0; Nivel = 0; |FINSI;

||************************************* PARTE 2
   Comodin = #asm00008#6; |QBF Comodin;

   |SI Comodin ! "[=]";
      Cadena = "";
      Comodin = "";
      Descr = #asm00008#6;
      Descr = Descr - "][";
      |SI FSalida ! 0;
         |PARA; |SI FSalida ! 0; |HACIENDO;
            Descr = Descr - "[";
            Calc = FSalida;
            Comodin1 = Descr % Calc;
            |SI Comodin1 = "%";
               Calc = Calc + 100;
               Comodin1 = Descr % Calc;
               |SI Comodin1 ] "0"; |Y Comodin [ "9";
                  Calc = Calc + 2;
                  Comodin1 = Descr % Calc;
                  Descr = Descr - "%";
                  DigFormat = Comodin1;
                  Descr = Descr - Comodin1;
               |FINSI;
            |FINSI;
            ComodNum = FSalida;
            ComodNum = ((ComodNum / 100) ! 0);
            ComodNum = 100 + (ComodNum - 1);
            Comodin1 = Descr % ComodNum; Descr = Descr - Comodin1;
            Cadena   = Cadena + Comodin1; ||QBF Cadena;
            Fich = Descr % 0108; |QBF Fich; Descr = Descr - Fich;
            Cmp  = Descr % 0103; Descr = Descr - Cmp;
            Descr = Descr - "]";
            |HAZ TomaDatos; DigFormat = 0;
            Cadena = Cadena + Comodin;
            Descr = Descr - "][";
         |SIGUE;
         Descr = Cadena;
      |FINSI;
   |FINSI;

||************************************* PARTE 3

   || Cadena = #asm00008#8; |HAZ ResuelveExpr; nImporte = Resultado;
   nImporte = Resultado;

||  A partir de aqui, se genera la/s linea/s del fichero puente necesarias
||    para dar de alta el/los asiento/s necesario/s

   UltimoApunte  = NumApunte;

   |SI #asm00008#7 = "S";
      |SI #asm00006#7 = "N";
         |SELECT #2#caenlac@;
      |SINO;
         |SELECT #3#caenlac@;
      |FINSI;
      #caenlac@#4 = Cuenta; Cuenta = #caenlac@#4;
      |SI #asm00006#8 = "S";
         |SI #asm00006#2 = "FC";
            Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
         |FINSI;
         |SI #asm00006#2 = "CB";
            Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
         |FINSI;

         fFechaC  = Comodin;
         ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
         Comodin  = Comodin % -104; |QBF Comodin;
         Ejerc    = Comodin;
         Empresa  = #caenlac@#37;
         Periodo = -1;
         |HAZ BuscaPer;
         #caenlac@#38 = Periodo;
      |FINSI;

      nSw = 0;
      |SALVA_DATOS #caenlac@;
      Empr1 = #caenlac@#37; #caenlac@#37 = 0;
      Peri1 = #caenlac@#38; #caenlac@#38 = 0;
      nDiario = #caenlac@#0;
      fFecha  = #caenlac@#1;
      nAsto   = #caenlac@#2;
      nApunt  = #caenlac@#3;
      |LEE 000#caenlac@.];
      |PARA; |SI FSalida = 0; |Y #caenlac@#4 = Cuenta; |HACIENDO;
         |SI #caenlac@#37 = Empr1; |Y #caenlac@#38 = Peri1; |Y #caenlac@#8 = #asm00008#4;
          |Y #caenlac@#26 = #asm00008#13; |Y #caenlac@#0 = nDiario;
          |Y fFecha = #caenlac@#1; |Y nAsto = #caenlac@#2;
             Empr1   = #caenlac@#37;
             Peri1   = #caenlac@#38;
             nDiario = #caenlac@#0;
             fFecha  = #caenlac@#1;
             nAsto   = #caenlac@#2;
             nApunt  = #caenlac@#3;
             nSw = 1;
             |SAL;
         |FINSI;
         |LEE 000#caenlac@.s;
      |SIGUE;
      |REPON_DATOS #caenlac@;
      |SELECT #1#caenlac@;
      |SI nSw = 1;
          #caenlac@#37 = Empr1;
          #caenlac@#38 = Peri1;
          #caenlac@#0  = nDiario;
          #caenlac@#1  = fFecha;
          #caenlac@#2  = nAsto;
          #caenlac@#3  = nApunt;
          |LEE 000#caenlac@.=;
      |SINO;
          FSalida = 1;
      |FINSI;
      |SI FSalida = 0;
         #caenlac@#7 = Descr;
         |SI #asm00008#12 = "S";
            #caenlac@#9 = #caenlac@#9 + nImporte;
         |SINO;
            #caenlac@#9 = nImporte;
         |FINSI;
         |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
      |SINO;
         #caenlac@#25 = "N";
         #caenlac@#3  = NumApunte; NumApunte = NumApunte + 5;
         #caenlac@#4  = Cuenta;
         Comodin = Cuenta; |QBF Comodin;
         aLong = Comodin % 0; nLong = aLong;
         SwNivel = 0;
         |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
         |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
         |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
         |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
         |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
         |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
         |SI SwNivel = 0; Nivel = 0; |FINSI;
         #caenlac@#5  = Nivel;
         #caenlac@#6  = #asm00008#5;
         #caenlac@#7  = Descr;
         #caenlac@#8  = #asm00008#4;
         #caenlac@#9  = nImporte;
         |SI #asm00006#2 = "FC";
            |SI #asm00006#8 = "S";
                #caenlac@#10 = "S";
                |HAZ CalReferencia;
            |SINO;
                #caenlac@#10 = "R";
            |FINSI;
         |SINO;
            #caenlac@#10 = " ";
         |FINSI;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            |SI #asm00006#2 = TiposEnlaces; #asw00022#0 = Ficheros; |SAL; |FINSI;
         |SIGUE;

         #caenlac@#17 = 0; #caenlac@#18 = "";
         Comodin = Usuario % 0810;
         #caenlac@#19 = Comodin;
         #caenlac@#24 = #asm00006#2;
         #caenlac@#26 = #asm00008#13;
         #caenlac@#27 = NumAcum;
         |SI #asm00006#8 = "S";
            |SI #asm00006#2 = "FC";
               Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
               #caenlac@#37 = Comodin;
               Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
            |FINSI;
            |SI #asm00006#2 = "CB";
               Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
               #caenlac@#37 = Comodin;
               Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
            |FINSI;
            fFechaC  = Comodin;
            ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
            Comodin  = Comodin % -104; |QBF Comodin;
            Ejerc    = Comodin;
            Empresa  = #caenlac@#37;
            Periodo  = -1; |HAZ BuscaPer;
            |SI Periodo = -1; |VETE Final1; |FINSI;
            #caenlac@#38 = Periodo;
         |FINSI;

||       Esta parte es exclusiva del enlace de la minutacion. Es una peque¤a
||       trampa para poder saber el tipo de iva, ya que no se guarda ni en los
||       ficheros de la minuta ni en ninguno de los que tiene relacionados

         |SI #caenlac@#10 ! " "; |Y #asm00006#2 = "FC";
            |HAZ LaFactura;
            ||...Fich = "ashismic"; Cmp = "000"; |HAZ TomaDatos; #caenlac@#12 = Comodin;
            ||...Fich = "ashismic"; Cmp = "001"; |HAZ TomaDatos; #caenlac@#13 = Comodin;
            #caenlac@#11 = #asm00010#6;

            Comodin = "BUSCATIPO";
            Fich = "asconcep"; Cmp = "003"; |HAZ TomaDatos;
            |SI #caenlac@#26 = "B";
               |SI Comodin = "S"; |O Comodin = "A";
                   #caenlac@#28 = 0;
               |SINO;
                   |HAZ BuscaIva;

                   |SI Comodin = "BUSCATIPO";
                      aAlfa = #asm00008#8; |QBF aAlfa;
                      aAlfa = aAlfa - "[ashismic][020]";
                      |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
                      aAlfa = aAlfa - "[ashismic][021]";
                      |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
                      aAlfa = aAlfa - "[ashismic][023]";
                      |SI FSalida ! 0; #caenlac@#28 = 0; |FINSI;
                   |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;

         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
            ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
            ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
            |SI #asm00006#2 = TiposEnlaces;
               Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
               Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
               Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
               |SAL;
            |FINSI;
         |SIGUE;

         |GRABA 020#caenlac@.n; |LEE 010#caenlac@.=; |LIBERA #caenlac@;
      |FINSI;
      |SELECT #4#caenlac@;
   |SINO;
      #caenlac@#3 = NumApunte; NumApunte = NumApunte + 5;
      #caenlac@#4 = Cuenta;
      Comodin = Cuenta; |QBF Comodin;
      aLong = Comodin % 0; nLong = aLong;
      SwNivel = 0;
      |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
      |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
      |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
      |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
      |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
      |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
      |SI SwNivel = 0; Nivel = 0; |FINSI;
      #caenlac@#5 = Nivel;
      #caenlac@#6 = #asm00008#5;
      #caenlac@#7 = Descr;
      #caenlac@#8 = #asm00008#4;
      #caenlac@#9 = nImporte;
      |SI #asm00006#2 = "FC";
         |SI #asm00006#8 = "S";
            #caenlac@#10 = "S";
            |HAZ CalReferencia;
         |SINO;
            #caenlac@#10 = "R";
         |FINSI;
      |SINO;
         #caenlac@#10 = " ";
      |FINSI;
      #caenlac@#15 = "01";
      #caenlac@#17 = 0; #caenlac@#18 = "";
      Comodin = Usuario % 0810;
      #caenlac@#19 = Comodin;
      #caenlac@#24 = #asm00006#2;
      #caenlac@#26 = #asm00008#13;
      #caenlac@#27 = NumAcum;
      |SI #asm00006#8 = "S";
         |SI #asm00006#2 = "FC";
            Fich = "ashismic"; Cmp = 3; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "ashismic"; Cmp = 29; |HAZ TomaDatos;
         |FINSI;
         |SI #asm00006#2 = "CB";
            Fich = "asparcia"; Cmp = 9; DigFormat = 5; |HAZ TomaDatos; DigFormat = 0
            #caenlac@#37 = Comodin;
            Fich = "asparcia"; Cmp = 3; |HAZ TomaDatos;
         |FINSI;
         fFechaC  = Comodin;
         ComodinA = Comodin % -102; |QBF ComodinA; EjercA = ComodinA;
         Comodin  = Comodin % -104; |QBF Comodin;
         Ejerc    = Comodin;
         Empresa  = #caenlac@#37;
         Periodo  = -1;
         |HAZ BuscaPer;
         |SI Periodo = -1; |VETE Final1; |FINSI;
         #caenlac@#38 = Periodo;
      |FINSI;

      |SI #caenlac@#10 ! " "; |Y #asm00006#2 = "FC";
          |HAZ LaFactura;
          ||...Fich = "ashismic"; Cmp = "000"; |HAZ TomaDatos; #caenlac@#12 = Comodin;
          ||...Fich = "ashismic"; Cmp = "001"; |HAZ TomaDatos; #caenlac@#13 = Comodin;
          #caenlac@#11 = #asm00010#6;

         |SI #caenlac@#26 = "B"; #caenlac@#28 = 16; |FINSI;
      |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
         ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
         ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
         |SI #asm00006#2 = TiposEnlaces;
            Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
            Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
            Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
            |SAL;
         |FINSI;
      |SIGUE;

      |SI #asm00008#12 = "N";
         |SI nVuelta = 0;
            |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
         |FINSI;
      |SINO;
         |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
      |FINSI;
   |FINSI;

   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
      ICmpEnlace    = CmpEnlace1<-;    ICmpEnlace    = ICmpEnlace    + Cont;
      ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
      ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
      ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
      |SI #asm00006#2 = TiposEnlaces;
         Diario = nAsiento;
         |SI #asm00006#8 = "S"; Diario = Diario + 7; |FINSI;
         Fecha = Diario + 1; Docum = Fecha + 1; nAsient = Docum + 1;
         |SI NumAsto = 1;
            Calc = Campo1Clave; #Princip@#Calc# = #Referen@#Calc#;
            Calc = Campo2Clave; #Princip@#Calc# = #Referen@#Calc#;
            Calc = Campo3Clave; #Princip@#Calc# = #Referen@#Calc#;
            |LEE 101#Princip@.=;
            |SI FSalida = 0;
               #Princip@#Diario#  = #caenlac@#0; #Princip@#Fecha#   = #caenlac@#1;
               #Princip@#Docum#   = #caenlac@#2; #Princip@#nAsient# = #caenlac@#3;
               |SI #asm00006#8 = "S";
                  Calc = CmpEmpresa + 7; #Princip@#Calc# = Empresa;
                  Calc = CmpPeriodo + 7; #Princip@#Calc# = Periodo;
                  Calc = CmpEnlace  + 7; #Princip@#Calc# = CodEnlace;
               |SINO;
                  Calc = CmpEmpresa; #Princip@#Calc# = Empresa;
                  Calc = CmpPeriodo; #Princip@#Calc# = Periodo;
                  Calc = CmpEnlace;  #Princip@#Calc# = CodEnlace;
               |FINSI;
               |GRABA 020#Princip@.a;
            |FINSI;
            |LIBERA #Princip@;
         |FINSI;
         |SAL;
      |FINSI;
   |SIGUE;
   |SI FichCab1 = "ashismic";
      #RefCabs@#0 = #Referen@#0;
      #RefCabs@#1 = #Referen@#1;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#31 = "S";
         |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;
   |SI FichCab1 = "asparcia";
      #RefCabs@#0 = #Referen@#0;
      #RefCabs@#1 = #Referen@#1;
      #RefCabs@#2 = #Referen@#2;
      |LEE 101#RefCabs@.=;
      |SI FSalida = 0;
          #RefCabs@#10 = "S";
          #RefCabs@#11 = #caenlac@#1;
          |GRABA 020#RefCabs@.a;
      |FINSI;
      |LIBERA #RefCabs@;
   |FINSI;

|ET Final1;
   |REPON_DATOS #caenlac@;
|FPRC;

|PROCESO LeeDesglose0;
 |SI nSwOpera = 0;   || solo sumo
     nTotal = nTotal + (#15#8 * #Referen@#11);
     nUltim = #15#5;  || Ultima linea
 |SINO;
      |ABRE #16;
      |DDEFECTO #16;
      #16#0 = #15#6;
      #16#1 = #15#7;
      |LEE 041#16=;
      |CIERRA #16;
      Cuenta    = #16#3;
      Resultado = #15#8 * #Referen@#11;
      |SI nUltim = #15#5;
          Resultado = Resultado + nDifer;
      |FINSI;
      |HAZ ParaElDesglose;
 |FINSI;
 nSwError = 0;
|FPRC;

|DEFBUCLE LeeDesglose;
 #15#1;
 ;
 nClau0, nClau1, aClau2, nClau3, "S", nClau4, 01;
 nClau0, nClau1, aClau2, nClau3, "S", nClau4, 99;
 e;
 NULL, LeeDesglose0;
|FIN;

|PROCESO EspAdade1;
 || que datos tengo?
 aAlfa1 = Cuenta - "DESGLOSE";
 aClau  = aAlfa1 %  106;
 aAlfa2 = aAlfa1 %  701; nClau0 = aAlfa2;
 aAlfa2 = aAlfa1 %  805; nClau1 = aAlfa2;
 aAlfa2 = aAlfa1 % 1302; aClau2 = aAlfa2;
 aAlfa2 = aAlfa1 % 1505; nClau3 = aAlfa2;
 aAlfa2 = aAlfa1 % 2003; nClau4 = aAlfa2;
 aAlfa2 = aAlfa1 % 2314; nClau5 = aAlfa2;
 nSwOpera = 0;
 nSwError = 1;
 nTotal   = 0;
 nUltim   = 0;
 nDifer   = 0;
 |BUCLE LeeDesglose;
 |SI nSwError = 0;
     nDifer = (nClau5 - nTotal) ! EURODB;
     nSwOpera = 1;
    |BUCLE LeeDesglose;
 |FINSI;
|FPRC;

|PROCESO EsAppVisados;
   |DDEF aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "visam001.mas";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida ] 0;
      nSwEsVisados = 1;
   |SINO;
      nSwEsVisados = -1;
   |FINSI;
|FPRC;

|PROCESO CalReferencia;
  aAlfa1 = "";
  |SI FichCab1 = "ashismic";
      aAlfa1 = #Referen@#0; |QBF aAlfa1;
      |SI aAlfa1 ! ""; aAlfa1 = aAlfa1 + "/"; |FINSI;
      aAlfa1 = aAlfa1 + #Referen@#1;
  |FINSI;
  #caenlac@#45 = aAlfa1;
|FPRC;
