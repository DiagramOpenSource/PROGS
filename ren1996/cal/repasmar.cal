|FICHEROS;
   repasmar #0;
   redatcon #1;
   rehacien #2;
   reacceso #3;
|FIN;

|VARIABLES;
    corta = 0;

    alfa1 = "";

    nif   = "";
    fiche = "";
    field = "";
    field1 = "";
    field2 = "";
    field3 = "";
    field4 = "";
    canal = "";
    FEstado = 0;

    letrasnif = "TRWAGMYFPDXBNJZSQVHLCKE";
    letra1 = "";
    letra2 = "";
    letra3 = "";
    letra4 = "";
    letra5  = "";
    letra6  = "";
    letra7  = "";
    letra8  = "";
    xx = "";
    xnumerica1 = 0;
    xnumerica2 = 0;
    xnumerica3 = 0;
    xnumerica4 = 0;
    xnumerica5 = 0;
|FIN;

|PROCESO creacion; |TIPO 3;
|SI #0#0 ! "SI"; |ACABA; |FINSI;


|ABRE #1;
|ABRE #2;
|ABRE #3;

|DFICE alfa1;
fiche = "rb  " + alfa1 + #0#3;
|QBF fiche;
    |FABRE fiche;
    |SI FSalida ] 0;
        canal = FSalida;
         corta = 0;
        |PARA; |SI corta = 0; |HACIENDO;
            field1 = canal + " " + 231;
            |FLEE field1;
            |SI FSalida > 0;                     || realiza dos lecturas para
                field2 = canal + " " + 220;   || poder leer los chr$(0)
                |FLEE field2;
                |SI FSalida > 0;
                    field3 = canal + " " + 200;
                    |FLEE field3;
                    |SI FSalida > 0;
                        field4 = canal + " " + 160;
                        |FLEE field4;
                        |SI FSalida > 0;
                            |HAZ pasamelo;
                        |SINO;
                            corta = 1;
                        |FINSI;
                    |SINO;
                        corta = 1;
                    |FINSI;
                |SINO;
                    corta = 1;
                |FINSI;
            |SINO;
               corta = 1;
            |FINSI;
        |SIGUE;
        |FCIERRA canal;
    |FINSI;
        Pos = -1;
|CIERRA #1;
|CIERRA #2;
|CIERRA #3;
|FPRC;

||**********************************************************************

|PROCESO pasamelo;
   field = field1 % 104;
   #0#1 = field;
   |PINTA #0#1;
   field = field1 % 540;
   #0#2 = field;
   |PINTA #0#2;

   #1#0 = #0#1;
   |LIBERA #1;
   |LEE 110#1=;
   |SI FSalida = 0; |AVISO; |PAUSA; |FINSI;
   FEstado = FSalida;
   |DDEFECTO #1;
   #1#0   = #0#1;
   #1#1   = #0#2;
   #1#2   = field1 % 4612; nif = #1#2; |HAZ letranif; #1#2 = nif;
   #1#3   = field1 % 5804;
   #1#4   = field1 % 6201;
   #1#5   = field1 % 6301;
   #1#7   = field1 % 6430;
   #1#8   = field1 % 9404;
   #1#9   = field1 % 9802;
   #1#10  = field1 % 10002;
   #1#11  = field1 % 10202;
   field  = field1 % 10402; #1#12  = field;
   field  = field1 % 10603; #1#13  = field;
   #1#14  = field1 % 10925;
   #1#15  = field1 % 22012;
   #1#16  = field1 % 10505;
   #1#18  = #1#7;
   #1#19  = #1#8;
   #1#20  = #1#9;
   #1#21  = #1#10;
   #1#22  = #1#11;
   #1#23  = #1#12;
   #1#24  = #1#13;
   #1#25  = #1#14;
   #1#26  = #1#15;
   #1#27  = #1#16;
   #1#28  = field1 % 13440;
   #1#29  = field1 % 17412; nif = #1#29; |HAZ letranif; #1#29 = nif;
   #1#30  = field1 % 18604;
   #1#31  = field1 % 19001;

   field  = field1 % 19301;
   |SI field = "I"; #1#32 = "X"; #1#33 = " "; |FINSI;
   |SI field ! "I"; #1#32 = " "; #1#33 = "X"; |FINSI;

   field  = field1 % 19201;
   |SI field = "S"; #1#36 = "X"; #1#34 = " "; #1#35 = " "; |FINSI;

   field  = field1 % 19101;
   |SI field = "G"; #1#37 = "X"; #1#38 = " "; #1#39 = " "; |FINSI;
   |SI field = "S"; #1#38 = "X"; #1#37 = " "; #1#39 = " "; |FINSI;
   |SI field = "O"; #1#39 = "X"; #1#37 = " "; #1#38 = " "; |FINSI;
   field = field1 % 21502; #1#40 = field;
   field = field1 % 21703; #1#41 = field;

   #2#0 = #1#40;
   #2#1 = #1#41;
   |LEE 040#2=;
   |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
   #1#42 = #2#2;
   #1#43 = #2#3;
   #1#48 = field4 % 4112;   nif = #1#48; |HAZ letranif; #1#48 = nif;
   #1#49 = field4 % 5312;   nif = #1#49; |HAZ letranif; #1#49 = nif;
   #1#50 = field4 % 6512;   nif = #1#50; |HAZ letranif; #1#50 = nif;
   #1#51 = field4 % 7712;   nif = #1#51; |HAZ letranif; #1#51 = nif;
   #1#52 = field4 % 8912;   nif = #1#52; |HAZ letranif; #1#52 = nif;
   #1#53 = field4 % 10112;  nif = #1#53; |HAZ letranif; #1#53 = nif;
   #1#54 = field4 % 11312;  nif = #1#54; |HAZ letranif; #1#54 = nif;
   #1#55 = field4 % 12512;  nif = #1#55; |HAZ letranif; #1#55 = nif;
   #1#56 = field4 % 13712;  nif = #1#56; |HAZ letranif; #1#56 = nif;
   #1#57 = field4 % 14912;  nif = #1#57; |HAZ letranif; #1#57 = nif;

   #1#58 = field2 % 2140;
   #1#59 = field2 % 6140;
   #1#60 = field2 % 10140;
   #1#61 = field2 % 14140;
   #1#62 = field2 % 18140;
   #1#63 = field3 % 140;
   #1#64 = field3 % 4140;
   #1#65 = field3 % 8140;
   #1#66 = field3 % 12140;
   #1#67 = field3 % 16140;

   #1#68 = field4 % 104;
   #1#69 = field4 % 504;
   #1#70 = field4 % 904;
   #1#71 = field4 % 1304;
   #1#72 = field4 % 1704;
   #1#73 = field4 % 2104;
   #1#74 = field4 % 2504;
   #1#75 = field4 % 2904;
   #1#76 = field4 % 3304;
   #1#77 = field4 % 3704;

   field = field2 % 102;  |QBT field; #1#164 = field;
   field = field2 % 302;  |QBT field; #1#165 = field;
   field = field2 % 502;  |QBT field; #1#166 = field;
   field = field2 % 702;  |QBT field; #1#167 = field;
   field = field2 % 902;  |QBT field; #1#168 = field;
   field = field2 % 1102; |QBT field; #1#169 = field;
   field = field2 % 1302; |QBT field; #1#170 = field;
   field = field2 % 1502; |QBT field; #1#171 = field;
   field = field2 % 1702; |QBT field; #1#172 = field;
   field = field2 % 1902; |QBT field; #1#173 = field;

   |SI FEstado = 0; |GRABA 020#1a; |SINO; |GRABA 020#1n; |FINSI;

   #3#0 = #1#0;
   |LIBERA #3;
   |LEE 110#3=;
   FEstado = FSalida;
   |DDEFECTO #3;
   #3#0 = #1#0;
   #3#1 = #1#1;
   #3#2 = #1#2;
   |SI FEstado = 0; |GRABA 020#3a; |SINO; |GRABA 020#3n; |FINSI;

|FPRC;

|PROCESO letranif;
    letra2 = nif;                          || recoge valor en variable trabajo
    |QBT letra2;                               || le quita los espacios en blanco
        xx = letra2 % 101;                     || carga primer caracter
    |SI xx!"A";|Y xx!"B";|Y xx!"C";|Y xx!"D";
         |Y xx!"E";|Y xx!"F";                  || si es un CIF !!!
         |Y xx!"G";|Y xx!"P";|Y xx!"Q";|Y xx!"S";|Y xx!"X";
            letra4 = "";                       || inicializa variable de trabajo
            letra3 = letra2 % 0;               || halla la longitud en caracteres
            xnumerica2 = letra3;                || recoge valor en variable numerica
        |PARA xnumerica5 = 1;  |SI xnumerica5 [ xnumerica2;  |HACIENDO xnumerica5 = xnumerica5 + 1;
                xnumerica3 = (xnumerica5 * 100) + 1;       || construye literal
                letra3 = letra2 % xnumerica3;           || despreciando puntos, etc.
            |SI letra3="0";|O letra3="1";|O letra3="2";|O letra3="3";
                          |O letra3="4";|O letra3="5";|O letra3="6";
                          |O letra3="7";|O letra3="8";|O letra3="9";
                    letra4 = letra4 + letra3;
            |FINSI;
        |SIGUE;
            xnumerica4 = letra4;
        |SI xnumerica4 ! 0; |Y letra4 ! "";
                xnumerica1 = xnumerica4 $ 23;       || halla el numerica1
                xnumerica1 = xnumerica1 + 1;         || le suma uno para no operar con cero
                xnumerica3 = (xnumerica1 * 100) + 1; || halla la posicion en el literal
                letra1 = letrasnif % xnumerica3; || saca la letra segun posicion

                letra4 = "000000000000" + letra4;
                letra7 = letra4 % -103;
                letra6 = letra4 % -403;
                letra5 = letra4 % -703;

                letra8 = letra5  % 101;
                |SI letra8 = "0"; letra5 = letra5 % 202; |FINSI;

                letra8 = letra5  % 101;
                |SI letra8 = "0"; letra5 = letra5 % 201; |FINSI;

                letra8 = letra5  % 101;
                |SI letra8 = "0"; letra5 = ""; |FINSI;

                |SI letra5 ! "";
                    letra4 = letra5 + letra6 + letra7 + letra1;
                |SINO;
                    letra4 = letra6 + letra7 + letra1;
                |FINSI;

                nif = letra4;
        |FINSI;
    |SINO;
        |MENAV "    ATENCION !!! No se calcular un C.I.F. ...";
    |FINSI;
|FPRC;
