|FICHEROS;
     isoz0001 #0;

     isom0001 #101;
     isom0002 #102;
     isom0003 #103;
     isom0004 #104;
     isom0005 #105;

     sodacoli #1;
     soda8w02 #2;
     soda8w04 #4;
     soda8m11 #431;
     soda8m12 #432;
|FIN;

|VARIABLES;
     &enAnyo    = 0;
     &enCampo0  = 0;
     nHay       = 0;

     aFichero   = "";
     &aCuenta   = "";
     &aTitulo   = "";
     &aAPR      = "";
     aSigno     = "";
     nImporte   = 0;

     aDCta      = "";
     aHCta      = "";
     aAlfa1     = "";
|FIN;

|INCLUYE varcon_i;
|INCLUYE varbal_i;

|PROCESO MiroSiHay;
    |SI nHay = -1; nHay = 0; |FINSI;
    |SI #1#5 ! 0; |O #1#6 ! 0; |O #1#7 ! 0; |O #1#8 ! 0; |O #1#9 ! 0;
        nHay = 1;
    |FINSI;
|FPRC;

|DEFBUCLE MiroSiHay;
   #1#2;
   ;
   enEmpresa, enAnyo,"8           ";
   enEmpresa, enAnyo, "999999999999";
   ;
   NULL, MiroSiHay;
|FIN;

|PROCESO Grabaw3;
   |DDEFECTO #2;
   #2#0 = aCuenta;
   #2#5 = enAnyo;
   |LEE 001#2=;
   |SI FSalida ! 0;
       #2#0 = aCuenta;
       #2#5 = enAnyo;
       |GRABA 020#2c;
   |FINSI;
   |SI aSigno = "D";
       #2#1 = #2#1 + nImporte;
   |SINO;
       #2#2 = #2#2 + nImporte;
   |FINSI;
   |GRABA 020#2a;
|FPRC;

|PROCESO reparto_lin;
   aAlfa1 = #432#2; |QBF aAlfa1;
   |SI aAlfa1 ! "";
       aCuenta  = #432#2;
       aSigno   = #431#8;
       nImporte = #432#4;
       |HAZ Grabaw3;
   |FINSI;
|FPRC;

|DEFBUCLE reparto_lin;
    #432#1;
    ;
    #431#9, #431#10, #431#0, 01;
    #431#9, #431#10, #431#0, 99;
    e;
    NULL, reparto_lin;
|FIN;

|PROCESO reparto;
   aAlfa1 = #431#2; |QBF aAlfa1;
   |SI aAlfa1 ! "";
       aCuenta  = #431#2;
       nImporte = #431#4;
       aSigno   = #431#8;
       |HAZ Grabaw3;
    |SINO;
       |BUCLE reparto_lin;
    |FINSI;
|FPRC;

|DEFBUCLE reparto;
    #431#1;
    ;
    enEmpresa, enAnyo, "            ";
    enEmpresa, enAnyo, "zzzzzzzzzzzz";
    e;
    NULL, reparto;
|FIN;

|PROCESO pide8y9;
  |ABRE #2;
  |BUCLE reparto;
  |CIERRA #2;
|FPRC;

|PROCESO conexi8y9;
  enErrorW17 = 0;
  nHay  = -1;
  |BUCLE MiroSiHay;
  |SI nHay = 1;
      enEmpresa = enEmpresa;
      |SUB_EJECUTA "soda8z03;BALANCEN";
      |SI enErrorW17 = 1; |ACABA; |FINSI;
  |FINSI;
  |HAZ pide8y9;
|FPRC;

|| ***************************************************************************
|| *********************  GRABACION y CALCULOS *******************************
|| ***************************************************************************

|PROCESO LasLineas102;
  |DDEFECTO #102;
  #102#0  = enEmpresa;
  #102#1  = enAnyo;
  #102#3  = #4#2;
  |LEE 101#102=;
  |SI FSalida = 0;
      #102#5 = #102#5 + nImporte;
      |GRABA 020#102a;
  |FINSI;
  |LIBERA #102;
|FPRC;

|PROCESO LaCondicion102;
  nImporte = (nImporte) ! 2;
  |SI nImporte ! 0;
      |SI #4#6 ! " ";
          |SI #4#6 = "P"; |Y nImporte < 0; nImporte = 0; |FINSI;
          |SI #4#6 = "N"; |Y nImporte > 0; nImporte = 0; |FINSI;
      |FINSI;
  |FINSI;
  |SI #4#5 = "-"; nImporte = - nImporte; |FINSI;
  |SI nImporte !  0;
      |HAZ LasLineas102;
  |FINSI;
|FPRC;

|PROCESO calculit102;
  #0#6 = enAnyo; #0#7 = #1#3;
  || |SI PARAMETRO = ""; |PINTA #0#6; |PINTA #0#7; |FINSI;

  aCuenta = #1#3;
  |HAZ MSigno08_s;

  nImporte = #1#8;
  |HAZ LaCondicion102;
|FPRC;

|DEFBUCLE cabasitu102;
  #1#2;
  ;
  enEmpresa, enAnyo, aDCta;
  enEmpresa, enAnyo, aHCta;
  e;
  NULL,calculit102;
|FIN;

|PROCESO calculit1_102;
  #0#6 = enAnyo; #0#7 = #2#0;
  || |SI PARAMETRO = ""; |PINTA #0#6; |PINTA #0#7; |FINSI;

  aCuenta = #2#0;
  |HAZ MSigno08_s;

  nImporte = #2#1 - #2#2; ||debe menos haber
  |HAZ LaCondicion102;
|FPRC;

|DEFBUCLE elauxiliar;
    #2#1;
    ;
    enAnyo, aDCta;
    enAnyo, aHCta;
    e;
    NULL,calculit1_102;
|FIN;

|PROCESO Carga_isom0002;

 aAlfa1 = #4#4; |QBF aAlfa1;
 aDCta = (aAlfa1 + "            ") % 112;
 aHCta = (aAlfa1 + "zzzzzzzzzzzz") % 112;

 |BUCLE cabasitu102;
 |BUCLE elauxiliar;
|FPRC;

|DEFBUCLE Carga_isom0002;
   #4#1;
   ;
   nBalNum, nBalance, "     ", 001;
   nBalNum, nBalance, "99999", 999;
   e;
   NULL, Carga_isom0002;
|FIN;


|PROCESO Pase_isom0002;

  aFichero = "2x" + Usuario;
  |NOME_DAT #2 aFichero;|DELINDEX #2;

  |SI PARAMETRO = "";
      || |ATRI I; |PINTA 2156, "Balance de Situacion   "; |ATRI 0;
  |FINSI;

  |HAZ conexi8y9;
  |SI enErrorW17 = 1;
      |MENAV "    Existe un descudre en el Reparto de las cuentas 8 y 9";
  |FINSI;

  aFichero = "2y" + Usuario;
  |NOME_DAT #4 aFichero; |DELINDEX #4;
  enCampo0 = nBalNum;
  |HAZ MontaEstPase;

  |ABRET #102;

  |SELECT #2#102;
  |BUCLE Carga_isom0002;
  |SELECT #1#102;

  |HAZ TotalFich102;
  |CIERRAT #102;
|FPRC;
