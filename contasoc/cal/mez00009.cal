|FICHEROS;
     zregcu13 #1013;

     labtrab@  #200;
     :/laboral/def/labempre  #203;
     :/laboral/def/nomanmel  #210;
     :/laboral/def/nomconca  #211;
     :/laboral/def/nominfm1  #212;
|FIN;

|VARIABLES;
     &eaPathLaboral = "";
     &enEmpresa     = 0;
     &enEjerCuadro  = 0;
     &nSwPaseAnt    = 0;
     &enTBal        = 0;

     aDef           = "";
     aDesde         = "";
     aHasta         = "";
     fDesde         = @;
     fHasta         = @;
     fech1          = @;
     fech2          = @;
     alfa1          = "";
     nume1          = 0;
     nume2          = 0;
     nume3          = 0;
     nDias          = 0;
     nDiasAlta      = 0;
     nCodCat        = 0;
     aNomCat        = "";
     nPeriodo       = 0;
     nPeriodo0      = 0;
     nHorasSemana   = 0;
     aSexo          = "";
     swSinSexo    = 0;
     aAlfa          = "";
     swSigue        = 0;
     nCampo         = 0;
     nCampo1        = 0;
     nCampo2        = 0;
     nContrato      = 0;
     nGraba         = 0;
     nAny           = 0;
     nSwEjer        = 0;
|FIN;

|PROCESO SumaCuadro;
    |SI nAny = 2012; |O nAny = 2016; |O nAny = 2020; |O nAny = 2024;
        nDias = (nDiasAlta / 366) ! 2;
    |SINO;
        nDias = (nDiasAlta / 365) ! 2;
    |FINSI;

    |SI aSexo ! "M"; |Y aSexo ! "V"; swSinSexo = 1; |FINSI;
    |SI enTBal ! 1;  |Y nAny ] 2009;
        |SI aSexo ! "M"; |Y aSexo ! "V"; aSexo = "M"; |FINSI;
    |FINSI;

    |SI nSwEjer = 0;       ||Ejercicio Actual
        |SI aSexo = "V";
            |SI nCodCat = 1; #1013#24 = #1013#24 + nDias; |FINSI;
            |SI nCodCat = 2; #1013#25 = #1013#25 + nDias; |FINSI;
            |SI nCodCat = 3; #1013#26 = #1013#26 + nDias; |FINSI;
            |SI nCodCat = 4; #1013#27 = #1013#27 + nDias; |FINSI;
            |SI nCodCat = 5; #1013#28 = #1013#28 + nDias; |FINSI;
            |SI nCodCat = 6; #1013#29 = #1013#29 + nDias; |FINSI;
            |SI nCodCat = 7; #1013#30 = #1013#30 + nDias; |FINSI;
            |SI nCodCat = 8; #1013#31 = #1013#31 + nDias; |FINSI;
            |SI nCodCat = 9; #1013#32 = #1013#32 + nDias; |FINSI;
            |SI nCodCat > 9; #1013#33 = #1013#33 + nDias; |FINSI;
        |FINSI;

        |SI aSexo = "M";
            |SI nCodCat = 1; #1013#46 = #1013#46 + nDias; |FINSI;
            |SI nCodCat = 2; #1013#47 = #1013#47 + nDias; |FINSI;
            |SI nCodCat = 3; #1013#48 = #1013#48 + nDias; |FINSI;
            |SI nCodCat = 4; #1013#49 = #1013#49 + nDias; |FINSI;
            |SI nCodCat = 5; #1013#50 = #1013#50 + nDias; |FINSI;
            |SI nCodCat = 6; #1013#51 = #1013#51 + nDias; |FINSI;
            |SI nCodCat = 7; #1013#52 = #1013#52 + nDias; |FINSI;
            |SI nCodCat = 8; #1013#53 = #1013#53 + nDias; |FINSI;
            |SI nCodCat = 9; #1013#54 = #1013#54 + nDias; |FINSI;
            |SI nCodCat > 9; #1013#55 = #1013#55 + nDias; |FINSI;
        |FINSI;

        #1013#34 = #1013#24 + #1013#25 + #1013#26 + #1013#27 + #1013#28 + #1013#29 + #1013#30 + #1013#31 + #1013#32 + #1013#33;
        #1013#56 = #1013#46 + #1013#47 + #1013#48 + #1013#49 + #1013#50 + #1013#51 + #1013#52 + #1013#53 + #1013#54 + #1013#55;

        #1013#2  = #1013#24 + #1013#46;
        #1013#3  = #1013#25 + #1013#47;
        #1013#4  = #1013#26 + #1013#48;
        #1013#5  = #1013#27 + #1013#49;
        #1013#6  = #1013#28 + #1013#50;
        #1013#7  = #1013#29 + #1013#51;
        #1013#8  = #1013#30 + #1013#52;
        #1013#9  = #1013#31 + #1013#53;
        #1013#10 = #1013#32 + #1013#54;
        #1013#11 = #1013#33 + #1013#55;
        #1013#12 = #1013#34 + #1013#56;
    |FINSI;

    |SI nSwEjer = 1;        || Ejercicio Anterior
        |SI aSexo = "V";
            |SI nCodCat = 1; #1013#35 = #1013#35 + nDias; |FINSI;
            |SI nCodCat = 2; #1013#36 = #1013#36 + nDias; |FINSI;
            |SI nCodCat = 3; #1013#37 = #1013#37 + nDias; |FINSI;
            |SI nCodCat = 4; #1013#38 = #1013#38 + nDias; |FINSI;
            |SI nCodCat = 5; #1013#39 = #1013#39 + nDias; |FINSI;
            |SI nCodCat = 6; #1013#40 = #1013#40 + nDias; |FINSI;
            |SI nCodCat = 7; #1013#41 = #1013#41 + nDias; |FINSI;
            |SI nCodCat = 8; #1013#42 = #1013#42 + nDias; |FINSI;
            |SI nCodCat = 9; #1013#43 = #1013#43 + nDias; |FINSI;
            |SI nCodCat > 9; #1013#44 = #1013#44 + nDias; |FINSI;
        |FINSI;

        |SI aSexo = "M";
            |SI nCodCat = 1; #1013#57 = #1013#57 + nDias; |FINSI;
            |SI nCodCat = 2; #1013#58 = #1013#58 + nDias; |FINSI;
            |SI nCodCat = 3; #1013#59 = #1013#59 + nDias; |FINSI;
            |SI nCodCat = 4; #1013#60 = #1013#60 + nDias; |FINSI;
            |SI nCodCat = 5; #1013#61 = #1013#61 + nDias; |FINSI;
            |SI nCodCat = 6; #1013#62 = #1013#62 + nDias; |FINSI;
            |SI nCodCat = 7; #1013#63 = #1013#63 + nDias; |FINSI;
            |SI nCodCat = 8; #1013#64 = #1013#64 + nDias; |FINSI;
            |SI nCodCat = 9; #1013#65 = #1013#65 + nDias; |FINSI;
            |SI nCodCat > 9; #1013#66 = #1013#66 + nDias; |FINSI;
        |FINSI;

        #1013#45 = #1013#35 + #1013#36 + #1013#37 + #1013#38 + #1013#39 + #1013#40 + #1013#41 + #1013#42 + #1013#43 + #1013#44;
        #1013#67 = #1013#57 + #1013#58 + #1013#59 + #1013#60 + #1013#61 + #1013#62 + #1013#63 + #1013#64 + #1013#65 + #1013#66;

        #1013#13 = #1013#35 + #1013#57;
        #1013#14 = #1013#36 + #1013#58;
        #1013#15 = #1013#37 + #1013#59;
        #1013#16 = #1013#38 + #1013#60;
        #1013#17 = #1013#39 + #1013#61;
        #1013#18 = #1013#40 + #1013#62;
        #1013#19 = #1013#41 + #1013#63;
        #1013#20 = #1013#42 + #1013#64;
        #1013#21 = #1013#43 + #1013#65;
        #1013#22 = #1013#44 + #1013#66;
        #1013#23 = #1013#45 + #1013#67;
    |FINSI;
|FPRC;

|PROCESO Dias;
     nume3 = 0;

     || ... Si tenemos en cuenta las exclusiones de laboral
          #nomanmel#0 = #labtrab@#87;
          #nomanmel#1 = #labtrab@#17;
          |LEE 000#nomanmel.=;
          |SI FSalida = 0;
               nCodCat = #nomanmel#3;
               aNomCat = #nomanmel#4;
          |SINO;
               nCodCat = 999;
               aNomCat = "Otros";
          |FINSI;

     aSexo = #labtrab@#252;
     aSexo = aSexo > " ";

     fech1 = #labtrab@#36;    || fecha de alta
     fech2 = #labtrab@#37;    || fecha de baja
     alfa1 = #labtrab@#37;
     |QBF alfa1;
     |SI alfa1 = ""; |O alfa1 = ".........."; |O fech2 > fHasta;
          fech2 = fHasta;
     |FINSI;
     |SI fech1 < fDesde;
          fech1 = fDesde;
     |FINSI;

     |SI fech2 < fDesde;
          |ACABA;
     |FINSI;
     |SI fech1 > fHasta;
          |ACABA;
     |FINSI;

     nume1 = fech1;
     nume2 = fech2;
     nume3 = nume2 - nume1 + 1;

     nHorasSemana = 40;
     #nomconca#0 = #labtrab@#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |SI #nomconca#162 ! 0;
               nHorasSemana = #nomconca#162;
          |FINSI;
     |FINSI;

     |SI #labtrab@#42 = "T"; |O #labtrab@#42 = "X";
          |SI #labtrab@#234 ! 0;
               nume3 = nume3 * (#labtrab@#234 / nHorasSemana);
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Exclusiones;
     nContrato = #labtrab@#45;

     |PARA nCampo1 = 1; |SI nCampo1 [ 7; |HACIENDO nCampo1 = nCampo1 + 2;
          nCampo2 = nCampo1 + 1;
          |SI #nominfm1#nCampo1# [ nContrato; |Y nContrato [ #nominfm1#nCampo2#;
               swSigue = 0;
               |SAL;
          |FINSI;
     |SIGUE;

     |PARA nCampo = 9; |SI nCampo [ 20; |HACIENDO nCampo = nCampo + 1;
          |SI nContrato = #nominfm1#nCampo#
               swSigue = 0;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CalculoDias;
     nDiasAlta = 0;
     nPeriodo  = nAny;
     aDesde    = nPeriodo;
     aDesde    = "01.01." + aDesde;
     aHasta    = nPeriodo;
     aHasta    = "31.12." + aHasta;

     fDesde = aDesde;
     fHasta = aHasta;

     |HAZ Dias;
     nDiasAlta = nume3;

     |SI nDiasAlta ! 0;
         |HAZ SumaCuadro;
         nGraba = 1;
     |FINSI;
|FPRC;

|PROCESO buscarencia;
     aAlfa = #labtrab@#36;    || fecha de alta
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          |ACABA;
     |FINSI;

     swSigue = 1;
     |HAZ Exclusiones;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     nSwEjer = 0;
     nAny    = enEjerCuadro;
     |HAZ CalculoDias;

     |SI nSwPaseAnt = 0;
         nSwEjer = 1;
         nAny    = enEjerCuadro - 1;
         |HAZ CalculoDias;
     |FINSI;
|FPRC;

|DEFBUCLE buscarencia;
     #labtrab@#1002;
     ;
     #1013#0, 00001;
     #1013#0, 99999;
     ;
     NULL, buscarencia;
|FIN;

|PROGRAMA;
     |HAZ BusquedaApli;

     |SI eaPathLaboral ! "";
         aDef = eaPathLaboral  + "def/labtraba.mas";
         |CARGA_DEF aDef, labtrab@;
         |SI FSalida ! 0;
             |ACABA;
         |FINSI;
         eaPathLaboral  = eaPathLaboral + "fich/";

         |PATH_DAT #210 eaPathLaboral;
         |PATH_DAT #211 eaPathLaboral;
         |PATH_DAT #212 eaPathLaboral;

         |ABRE #1013;
         #1013#0 = enEmpresa;
         #1013#1 = enEjerCuadro;
         |LEE 101#1013=;
         |SI FSalida ! 0;
             |DDEFECTO #1013;
             #1013#0  = enEmpresa;
             #1013#1  = enEjerCuadro;
             |GRABA 020#1013b;
         |FINSI;

         |PDEFECTO #1013,  2, 13;
         |PDEFECTO #1013, 24, 35;
         |PDEFECTO #1013, 46, 57;

         |SI nSwPaseAnt = 0;
             |PDEFECTO #1013, 13, 24;
             |PDEFECTO #1013, 35, 46;
             |PDEFECTO #1013, 57, 68;
         |FINSI;

         nGraba    = 0;
         swSinSexo = 0;

         |ABRE #labempre;
         |DDEFECTO #labempre;
         #labempre#0 = enEmpresa;
         |LEE 040#labempre.=;

         |ABRE #nomanmel;
         |ABRE #nomconca;
         |ABRE #nominfm1;

         |LEE 000#nominfm1.p;

         |BUCLE buscarencia;
         |CIERRA #nominfm1;
         |CIERRA #nomconca;
         |CIERRA #nomanmel;
         |CIERRA #labempre;

         |SI enTBal ! 1;  |Y enEjerCuadro ] 2009;
             |PARA nCampo = 24;  |SI nCampo [ 34;  |HACIENDO nCampo = nCampo + 1;
                   #1013nCampo = 0;
             |SIGUE;

             |PARA nCampo = 46;  |SI nCampo [ 56;  |HACIENDO nCampo = nCampo + 1;
                   #1013nCampo = 0;
             |SIGUE;

             #1013#11 = #1013#11 + #1013#3 + #1013#4;
             #1013#3  = 0;
             #1013#4  = 0;

             |SI nSwPaseAnt = 0;
                 |PARA nCampo = 35;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
                       #1013nCampo = 0;
                 |SIGUE;

                 |PARA nCampo = 57;  |SI nCampo [ 67;  |HACIENDO nCampo = nCampo + 1;
                       #1013nCampo = 0;
                 |SIGUE;

                 #1013#22 = #1013#22 + #1013#14 + #1013#15;
                 #1013#14 = 0;
                 #1013#15 = 0;
             |FINSI;
         |FINSI;

         |SI nGraba = 1;
             |GRABA 020#1013a;
         |FINSI;
         |LIBERA #1013;
         |CIERRA #1013;

         |DESCARGA_DEF #labtrab@;

         |SI swSinSexo = 1;
             aAlfa = "    ATENCION. Se han detectado trabajadores ";
             aAlfa = aAlfa + " con el campo 'Sexo' en blanco.";
             |MENAV aAlfa;
         |FINSI;

     |FINSI;
|FPRO;
