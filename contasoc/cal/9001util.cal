|FICHEROS;
     isom9000;
     maempr10;

     :integral/dsam0009;
     :integral/dsam0116;

     &clientes@;
|FIN;

|INCLUYE 9001vari;

|PROCESO QuitaRaros;
     aCadena = "";
     aLen    = eaAlfa % 0;
     nLen    = aLen;
     |PARA nCampo = 1;  |SI nCampo [ nLen;  |HACIENDO nCampo = nCampo + 1;
           nPos = (100 * nCampo) + 1;
           aCaracter = eaAlfa % nPos;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &241; |FINSI;
           |SI aCaracter = " ";  aCaracter = &225; |FINSI;
           |SI aCaracter = "‚";  aCaracter = &233; |FINSI;
           |SI aCaracter = "¡";  aCaracter = &237; |FINSI;
           |SI aCaracter = "¢";  aCaracter = &243; |FINSI;
           |SI aCaracter = "£";  aCaracter = &250; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     eaAlfa = aCadena;
|FPRC;

|PROCESO Calcula3E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("000" + aAlfa1) % -103) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula2E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("00" + aAlfa1) % -102) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula5E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("00000" + aAlfa1) % -105) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula3E4D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("000" + aAlfa1) % -103) + ((aAlfa2 + "0000") % 104);
|FPRC;

|PROCESO Calcula17D;
     enCanti = enCanti * 100;
     enCanti = enCanti ! 0;

     |SI enCanti ] 0;
         aAlfa = enCanti;
         eaAlfa = ("00000000000000000" + aAlfa) % -117;
     |SINO;
         enCanti  = -enCanti;
         aAlfa   = enCanti;
         eaAlfa   = "N" + (("0000000000000000" + aAlfa) % -116);
     |FINSI;
|FPRC;

|PROCESO GrabaSecuencial;
     |HAZ QuitaRaros;

     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO CogeDatosBancos;
     enBanco    = 0;
     enFormaPag = 0;
     eaEfectivo = "";
     eaAdeudo   = "";
     eaEntidad  = "";
     eaOficina  = "";
     eaDC       = "";
     eaCuenta   = "";
     eaNomEnt   = "";
     eaNomOfi   = "";
     eaIBAN     = "";

     |ABRE #dsam0009;

     #dsam0009#0 = #clientes@#0;
     #dsam0009#1 = enModelo;
     |LEE 040#dsam0009.=;
     |SI FSalida = 0;
         |CIERRA #dsam0009;

         |SI #dsam0009#9 = 1;  |O #dsam0009#8 = "          ";
             eaEfectivo = "X";
         |SINO;
             eaAdeudo  = "X";
             eaEntidad = #dsam0009#5;
             eaOficina = #dsam0009#6;
             eaDC      = #dsam0009#7;
             eaCuenta  = #dsam0009#8;
             eaNomEnt  = #dsam0009#4;
             eaNomOfi  = #dsam0009#10;
             eaIBAN    = #dsam0009#12;

             |SI #dsam0009#9 = 3;  eaAdeudo = "3";  |FINSI;
         |FINSI;

         |SI enForzar = 1;
             enBanco    = #dsam0009#3;
             enFormaPag = #dsam0009#9;
             eaEntidad  = #dsam0009#5;
             eaOficina  = #dsam0009#6;
             eaDC       = #dsam0009#7;
             eaCuenta   = #dsam0009#8;
             eaNomEnt   = #dsam0009#4;
             eaNomOfi   = #dsam0009#10;
             eaIBAN    = #dsam0009#12;
         |FINSI;

         |ACABA;
     |FINSI;

     #dsam0009#0 = #clientes@#0;
     #dsam0009#1 = 999;
     |LEE 040#dsam0009.=;
     |SI FSalida = 0;
         |CIERRA #dsam0009;

         |SI #dsam0009#9 = 1;  |O #dsam0009#8 = "          ";
             eaEfectivo = "X";
         |SINO;
             eaAdeudo  = "X";
             eaEntidad = #dsam0009#5;
             eaOficina = #dsam0009#6;
             eaDC      = #dsam0009#7;
             eaCuenta  = #dsam0009#8;
             eaNomEnt  = #dsam0009#4;
             eaNomOfi  = #dsam0009#10;
             eaIBAN    = #dsam0009#12;

             |SI #dsam0009#9 = 3;  eaAdeudo = "3";  |FINSI;
         |FINSI;

         |SI enForzar = 1;
             enBanco    = #dsam0009#3;
             enFormaPag = #dsam0009#9;
             eaEntidad  = #dsam0009#5;
             eaOficina  = #dsam0009#6;
             eaDC       = #dsam0009#7;
             eaCuenta   = #dsam0009#8;
             eaNomEnt   = #dsam0009#4;
             eaNomOfi   = #dsam0009#10;
             eaIBAN     = #dsam0009#12;
         |FINSI;

         |ACABA;
     |FINSI;
     |CIERRA #dsam0009;

     |SI #clientes@#104 = 1;  |O #clientes@#93 = "          ";
         eaEfectivo = "X";
         enFormaPag = #clientes@#104;
     |SINO;
         enFormaPag = #clientes@#104;
         eaAdeudo   = "X";
         eaEntidad  = #clientes@#90;
         eaOficina  = #clientes@#91;
         eaDC       = #clientes@#92;
         eaCuenta   = #clientes@#93;
         eaNomEnt   = #clientes@#89;
         eaIBAN     = #clientes@#116;

         |ABRE #dsam0116;
         #dsam0116#0 = #clientes@#88;
         |LEE 000#dsam0116.=;
         |SI FSalida ! 0;  |DDEFECTO #dsam0116;  |FINSI;
         |CIERRA #dsam0116;

         eaNomOfi  = #dsam0116#5;

         |SI #clientes@#104 = 3;   eaAdeudo = "3";   |FINSI;
     |FINSI;

     |SI enForzar = 1;
         enBanco    = #clientes@#88;
         enFormaPag = #clientes@#104;
         eaEntidad  = #clientes@#90;
         eaOficina  = #clientes@#91;
         eaDC       = #clientes@#92;
         eaCuenta   = #clientes@#93;
         eaNomEnt   = #clientes@#89;
         eaIBAN     = #clientes@#116;

         |ABRE #dsam0116;
         #dsam0116#0 = #clientes@#88;
         |LEE 000#dsam0116.=;
         |SI FSalida ! 0;  |DDEFECTO #dsam0116;  |FINSI;
         |CIERRA #dsam0116;

         eaNomOfi  = #dsam0116#5;
     |FINSI;
|FPRC;

|PROCESO PonVentana;
     |VENTANA 0501, 0540, -1, 16, "Procesando emisi¢n modelo 202";
     nVent202 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent202;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO QuitaVentana;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent202;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent202;
|FPRC;

|PROCESO CopiaFichero;
     aAlfa = "";
     |IP_REMOTO aAlfa;  |QBT aAlfa;
     |SI aAlfa ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO GrabaPortal;
     eaAlfa = eaAlfa + &13 + &10;
     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO GrabaPortalSin;
     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO TraeWait;
     |DBASE aAlfa;  |QBT aAlfa;
     aAlfa    = aAlfa + "planilla";
     aOrigen  = aAlfa + "/wait.exe";
     aDestino = eaDirLanza + "wait.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PresentaDeclaracion;
     aOrigen  = eaDirServidor + eaFicheroTxt;
     aDestino = eaDirLanza + eaFicheroTxt;
     |HAZ CopiaFichero;

     |HAZ TraeWait;

     eaForzExplorador = "N";
     enEjercicio      = #isom9000#1;
     |HAZ Explorador;

     aAbre = eaDirLanza + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandle;

     eaAlfa = eaDirLanza + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     |SI #isom9000#1 ] 2015;
         eaAlfa = "https://www2.agenciatributaria.gob.es";
         |HAZ GrabaPortalSin;

         eaAlfa = "/static_files/common/internet/dep/aplicaciones";
         |HAZ GrabaPortalSin;

         |SI #isom9000#1 = 2015;
             eaAlfa = "/ov/servurls.html?WEB=INTERNET&PRG=202&EJE=0001&URL=PIR&EXT=?FIC=";
         |SINO;
             |SI #isom9000#1 < 2018;
                 eaAlfa = "/ov/servurls.html?WEB=INTERNET&PRG=202&EJE=0002&URL=PIR";
             |SINO;
                 eaAlfa = "/ov/servurls.html?WEB=INTERNET&PRG=202&EJE=0003&URL=PIR";
             |FINSI;
         |FINSI;

         |HAZ GrabaPortalSin;
     |FINSI;

     |SI #isom9000#1 [ 2014;
         eaAlfa = "https://www2.agenciatributaria.gob.es"
         |HAZ GrabaPortalSin;

         eaAlfa = "/es13/h/servurls.html";
         |HAZ GrabaPortalSin;

         eaAlfa = "?WEB=INTERNET&PRG=202&EJE=0000&URL=PIR&EXT=?FIC=";
         |HAZ GrabaPortalSin;
     |FINSI;

     |SI #isom9000#1 ] 2018;
          eaAlfa = &13 + &10;
     |SINO;
          eaAlfa = eaDirLanza + eaFicheroTxt + &34 + &13 + &10;
     |FINSI;
     |HAZ GrabaPortal;

     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaDirLanza + eaFicheroTxt;
     |RFBORRA aAbre;
|FPRC;

|PROCESO Pag202_2018;
     aOrigen  = eaDirServidor + eaFicheroTxt;
     aDestino = eaDirLanza + eaFicheroTxt;
     |HAZ CopiaFichero;

     |HAZ TraeWait;

     eaForzExplorador = "N";
     enEjercicio      = #isom9000#1;
     |HAZ Explorador;

     aAbre = eaDirLanza + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandle;

     eaAlfa = eaDirLanza + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     |SI #isom9000#1 ] 2015;
         eaAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV18-M202/index.zul";
         |HAZ GrabaPortalSin;
     |FINSI;

     eaAlfa = &13 + &10;
     |HAZ GrabaPortal;

     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaDirLanza + eaFicheroTxt;
     |RFBORRA aAbre;
|FPRC;

|PROCESO MandaAInternet;
     aQuePeriodo = #isom9000#1 + #isom9000#2;

     |CONFI "0000NDesea presentar en estos momentos la declaracion";
     |SI FSalida = 0;
         aAlfa = "0000El fichero generado est  en " + eaDirLanza + " para su revisi¢n por la p gina de hacienda.";
         |MENAV aAlfa;

         |SI aQuePeriodo [ "20181P";
             |HAZ PresentaDeclaracion;
         |SINO;
             |HAZ Pag202_2018;
         |FINSI;
     |SINO;
         aOrigen  = eaDirServidor + eaFicheroTxt;
         aDestino = eaDirInternet + eaFicheroTxt;
         |HAZ CopiaFichero;

         aAlfa = "0000El fichero generado est  en " + aDestino + " para su presentaci¢n.";
         |MENAV aAlfa;
     |FINSI;

     eaImpre = "S";
     eaJusti = "";
|FPRC;

|PROCESO Portal;
     |HAZ PonVentana;

     aAlfa = eaDirInternet + eaFicheroTxt;   |RFBORRA aAlfa;

     |HAZ MandaAInternet;

     |HAZ QuitaVentana;
|FPRC;

|PROCESO AbreSecuencial;
     |DBASE aBase;  |QBF aBase;
     eaDirServidor = aBase + "tmp";   |MKDIR eaDirServidor;
     eaDirServidor = aBase + "tmp/";

     eaDirLanza    = eaUnidadBasico + "\AEAT";                                              |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\202";                                          |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\202\" + #isom9000#1;                           |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\202\" + #isom9000#1 + "\" + #isom9000#2;       |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\202\" + #isom9000#1 + "\" + #isom9000#2 + "\";

     aDirBase     = eaUnidadBasico + "\AEAT\202\";

     eaDirInternet = eaUnidadBasico + "/AEAT";                                                  |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET";                                         |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/202";                                     |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/202/" + #isom9000#1;                      |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/202/" + #isom9000#1 + "/" + #isom9000#2;  |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/202/" + #isom9000#1 + "/" + #isom9000#2 + "/";

     eaFicheroTxt = "202" + (("00000" + #isom9000#0) % -105) + (("00" + #isom9000#3) % -102) + ".txt";
     aFicheroP    = "portal202.html";

     aAbre       = eaDirServidor + eaFicheroTxt;
     |XABRE "BW", aAbre, enHandle;
|FPRC;

|PROCESO CierraSecuencial;
     |XCIERRA enHandle;

     |HAZ Portal;

     aAlfa = eaDirServidor + eaFicheroTxt;   |FBORRA aAlfa;
|FPRC;
