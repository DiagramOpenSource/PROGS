|FICHEROS;
    cubal800 #0;
    sodacoli #1;         || cuentas
    soda8w02 #2;
    soda8w03 #3;
    cubal804 #804;       || Total
    cubal8v4 #814;       || Variaciones

    soda8m02 #421;  || Def Balance Estado
    soda8m03 #422;  || Def Balance Linea

    :contagen/ca8cumay #410;  || Control de Balances
    :contagen/ca8m0000 #420;  || Descripcion Numero de Balance
|FIN;

|VARIABLES;
     aFichero = "";
     &empresa = 0;
     &anyo    = 0;
     &nombre  = "";
     &nif     = "";
     &unid    = "";
     &tipo    = "";
     &acabalo = 0;
     &aTitulo  = "";
     &aAPR     = "";
     &aCuenta  = "";
      nLong    = 0;

     nNume1    = 0;
     nNume2    = 0;
     aAlfa1    = "";
     aDCta     = "";
     aHCta     = "";
     nEjer     = 0;
     nEjer1    = 0;
     nEjer2    = 0;
     nCol      = 0;
     aSigno    = "";
     swImp     = 0;
     swEjer    = 0;

     nImporte = 0;
     nCampo2 = 0;
     aCampo3 = "";
     nCampo4 = 0;
     aCampo5 = "";
     &enSwCero = 0;
|FIN;

|INCLUYE varcon_i;
|INCLUYE varbal_i;

|PROCESO cargatra_804;  ||Carga Trabajo de Cuentas

  |SI aSigno = "-"; nImporte = - nImporte; |FINSI;

  #804#0  = empresa;
  #804#1  = anyo;
  #804#2  = nCampo2;
  |LEE 101#804=;
  |SI FSalida ! 0;
      |DDEFECTO #804;
      #804#0 = empresa;
      #804#1 = anyo;
      #804#2 = nCampo2;
      #804#3 = aCampo3;
      #804#4 = nCampo4;
      #804#5 = aCampo5;
      |GRABA 020#804b;
  |FINSI;

  nNume2 = nCol + 18;  || Columna del fichero
  #804nNume2 = #804nNume2 + nImporte;
  |GRABA 020#804a;
  |LIBERA #804;

  |SI swImp ] 3; #0#6 = anyo;   |FINSI;
  |SI swImp = 2; #0#6 = nEjer1; |FINSI;
  |SI swImp = 1; #0#6 = nEjer2; |FINSI;
  #0#7 = aCuenta;
  |PINTA #0#6;
  |PINTA #0#7;
|FPRC;

|PROCESO movimientos;
  aCuenta = #1#3;
  aTitulo = #1#4;
  |HAZ MSigno08_s;

  aAlfa1 = #1#3; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #1#3;
  aTitulo = #1#4;

  |SI swEjer = 3;
      |SI swImp = 1; nImporte = #1#8; |FINSI;
      |SI swImp = 2; nImporte = #1#6 - #1#7; |FINSI;
      |SI swImp ] 3;
          |SI swImp = 3; #1#7 = 0; |FINSI;  ||solo debe
          |SI swImp = 4; #1#6 = 0; |FINSI;  ||solo haber
          nImporte = #1#6 - #1#7;
      |FINSI;
      |HAZ cargatra_804;
  |FINSI;

  |SI swEjer = 2;
      |SI #0#2 = "A";
          |SI swImp = 1; nImporte = #1#8; |FINSI;
          |SI swImp = 2; nImporte = #1#6 - #1#7; |FINSI;
          |SI swImp ] 3;
              |SI swImp = 3; #1#7 = 0; |FINSI;
              |SI swImp = 4; #1#6 = 0; |FINSI;
              nImporte = #1#6 - #1#7;
          |FINSI;
          |HAZ cargatra_804;
      |SINO;
          nImporte = #1#9; || todos igual
          |SI swImp ] 3;
              |SI swImp = 3; |Y nImporte < 0; nImporte = 0; |FINSI;
              |SI swImp = 4; |Y nImporte > 0; nImporte = 0; |FINSI;
          |FINSI;
          |HAZ cargatra_804;
      |FINSI;
  |FINSI;

  |SI swEjer = 1;
      |SI #0#2 = "A";
          nImporte = #1#9; || todos igual
          |SI swImp ] 3;
              |SI swImp= 3; |Y nImporte < 0; nImporte = 0; |FINSI;
              |SI swImp= 4; |Y nImporte > 0; nImporte = 0; |FINSI;
          |FINSI;
          |HAZ cargatra_804;
      |FINSI;
      || .... Manual no podemos pasar el ejercicio - 2
  |FINSI;
|FPRC;

|DEFBUCLE movimientos;
 #1#2;
 ;
 empresa, nEjer, aDCta;
 empresa, nEjer, aHCta;
 e;
 NULL,movimientos;
|FIN;

|PROCESO calculit2;
  aCuenta = #3#0;
  |HAZ MSigno08_s;

  aAlfa1 = #3#0; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;

  |SI swEjer = 2;
      |SI swImp = 1; nImporte = #3#2; |FINSI;
      |SI swImp = 2; nImporte = #3#5 - #3#6; |FINSI;
      |SI swImp ] 3;
          |SI swImp = 3; nImporte = #3#5;   |FINSI;
          |SI swImp = 4; nImporte = - #3#6; |FINSI;
      |FINSI;
      |HAZ cargatra_804;
  |FINSI;
  |SI swEjer = 1;
      nImporte = #3#3;
      |SI swImp = 3; |Y nImporte < 0; nImporte = 0; |FINSI;
      |SI swImp = 4; |Y nImporte > 0; nImporte = 0; |FINSI;
      |HAZ cargatra_804;
   |FINSI;
|FPRC;

|DEFBUCLE AuxEquival4;  ||para el ejer. 2008 equivalencia
 #3#1;
 ;
 anyo, aDCta;
 anyo, aHCta;
 e;
 NULL,calculit2;
|FIN;

|PROCESO calaux804;
  aCuenta = #2#0;
  |HAZ MSigno08_s;

  |SI swEjer = 3;
      |SI swImp ] 3;
          |SI swImp = 3; #2#2 = 0; |FINSI;  ||solo debe
          |SI swImp = 4; #2#1 = 0; |FINSI;  ||solo haber
      |FINSI;
       nImporte = #2#1 - #2#2;
      |HAZ cargatra_804;
  |FINSI;

  |SI swEjer = 2;
      |SI swImp ] 3;
          |SI swImp = 3; #2#4 = 0; |FINSI;  ||solo debe
          |SI swImp = 4; #2#3 = 0; |FINSI;  ||solo haber
      |FINSI;
       nImporte = #2#3 - #2#4;
      |HAZ cargatra_804;
  |FINSI;

|FPRC;

|DEFBUCLE elaux804;
 #2#1;
 ;
 anyo, aDCta;
 anyo, aHCta;
 e;
 NULL,calaux804;
|FIN;

|PROCESO linea804;
 aAlfa1 = #422#4; |QBF aAlfa1;
 aDCta = (aAlfa1 + "            ") % 112;
 aHCta = (aAlfa1 + "zzzzzzzzzzzz") % 112;
 aSigno = #422#5;
 swImp  = #422#6;

 |SI swEjer = 3;
     nEjer = anyo;
     |BUCLE movimientos;
 |FINSI;

 |SI swEjer [ 2;
     |SI #0#2 = "A";
         |SI anyo ! 2008;    || lee el balance del ejercicio anterior
             nEjer  = anyo - 1;
             |BUCLE movimientos;
         |SINO;
             |BUCLE AuxEquival4;  ||para el ejer. 2008 equivalencia
         |FINSI;
     |SINO;
         nEjer = anyo;
         |BUCLE movimientos;
     |FINSI;
 |FINSI;

 |BUCLE elaux804;
|FPRC;

|DEFBUCLE linea804;
 #422#1;
 ;
 #421#34, #421#0, #421#1, nCol, 001;
 #421#34, #421#0, #421#1, nCol, 999;
 e;
 NULL, linea804;
|FIN;

|PROCESO calculit_804;
 swEjer  = #421#4;
 nCampo2 = #421#1;
 aCampo3 = #421#2;
 nCampo4 = #421#3;
 aCampo5 = #421#6;

 |PARA nCol = 1; |SI nCol [12; |HACIENDO nCol = nCol + 1;
       nNume1 = nCol + 6;
       |SI #421nNume1 = "C";
           |BUCLE linea804;
       |FINSI;
 |SIGUE;
|FPRC;

|DEFBUCLE cabasitu4_804;
 #421#1;
 ;
 enEjerBal, nBalNum, 001;
 enEjerBal, nBalNum, 999;
 e;
 NULL,calculit_804;
|FIN;

|PROCESO PaseEstadoCambio;

  aFichero = "x" + Usuario;
  |NOME_DAT #2 aFichero;

  aFichero = "y" + Usuario;
  |NOME_DAT #3 aFichero;

  |SI PARAMETRO = "";
      |ATRI I; |PINTA 1847, "Estado de Cambios P.Neto"; |ATRI 0;
  |FINSI;

  nEjer1 = anyo - 1;
  nEjer2 = anyo - 2;

  |ABRE #804;
  |BUCLE cabasitu4_804;
  |CIERRA #804;

  enSwCero = 0;
  |HAZ ElCalFinal804;

  |DELINDEX #2;
|FPRC;
