|FICHEROS;
    cubal800 #0;

    sodacoli #1;         || cuentas
    cubal803 #803;       || Total

    :contagen/ca8cumay #410;  || Control de Balances
    :contagen/ca8m0000 #420;  || Descripcion Numero de Balance
    :contagen/ca8m0001 #421;  || Def Balance Textos
    :contagen/ca8m0002 #422;  || Def Balance Linea Cuentas
|FIN;

|VARIABLES;
    aFichero = "";
     &empresa = 0;
     &anyo    = 0;
     &nombre  = "";
     &nif     = "";
     &unid    = "";
     &tipo    = "";
     &acabalo = 0;

   nImporte = 0;
   nImporte1= 0;
   nImporte2= 0;
   nImporte3= 0;
   nImporte4= 0;
   nImporte5= 0;
   nLong    = 0;
   &aTitulo  = "";
   &aAPR     = "";
   &aCuenta  = "";
   aAlfa1   = "";
   acumula = 0;
   acumul1 = 0;
   nCampo  = 0;
   nCampo2 = 0;
   aCampo3 = "";
   nCampo4 = 0;
   nCampo5 = 0;
   nCampo6 = 0;
   nCampo7 = 0;
   nCampo8 = 0;
   nCampo16 = 0;
   nSI     = 0;
   aDCta   = "";
   aHCta   = "";
   aCtaM   = "";
   nNivel  = 0;
   nCam1  = 0;
   nCam2  = 0;

    activo  = 0;
    pasivo  = 0;
    activ1  = 0;
    pasiv1  = 0;
    saldo   = 0;
  debe1 = 0;
  debe2 = 0;
  haber1 = 0;
  haber2 = 0;
  explo  = 0;
  explo2 = 0;
   nHay     = 0;
   nDCampo5 = 0;
   nDCampo6 = 0;
   nDCampo7 = 0;
   nDCampo8 = 0;
   nHCampo5 = 0;
   nHCampo6 = 0;
   nHCampo7 = 0;
   nHCampo8 = 0;
   nEjer    = 0;
|FIN;

|INCLUYE varbal_i;

||**************************************
|PROCESO cargatra_803;  ||Carga Trabajo de Cuentas
  #803#0  = empresa;
  #803#1  = anyo;
  #803#9  = nCampo2;
  #803#10 = aCampo3;
  #803#11 = nCampo4;
  #803#12 = nCampo5;
  #803#13 = nCampo6;
  #803#14 = nCampo7;
  #803#15 = nCampo8;
  |LEE 101#803=;
  |SI FSalida = 0; |Y #803#8 ! "A";
      #803acumula = #803acumula + nImporte;
      |GRABA 020#803a;
  |FINSI;
  |LIBERA #803;
|FPRC;

|PROCESO LosTotales_803;
  #0#6 = nEjer;   |PINTA #0#6;
  #0#7 = aCuenta; |PINTA #0#7;

  nCampo2 = #422#2;
  aCampo3 = #422#3;
  nCampo4 = #422#4;
  nCampo5 = #422#5;
  nCampo6 = #422#6;
  nCampo7 = #422#7;
  nCampo8 = #422#12;
  nCampo16 = #421#11;

  |HAZ cargatra_803;

  |SI nCampo8 ! 0;    ||Subpartida (A/P = 0)
      nCampo8 = 0;
      |HAZ cargatra_803;
  |FINSI;

  |SI nCampo7 ! 0;   ||Partida
      nCampo8 = 0;
      nCampo7 = 0;
      |HAZ cargatra_803;
  |FINSI;

  |SI nCampo6 ! 0;   ||Epigrafe
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      |HAZ cargatra_803;
  |FINSI;

/*
  |SI nCampo5 ! 0;  ||Subagrupacion
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      nCampo5 = 0;
      |HAZ cargatra_803;
  |FINSI;

  |SI nCampo4 ! 0;  ||Agrupacion
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      nCampo5 = 0;
      nCampo4 = 0;
      |HAZ cargatra_803;
  |FINSI;

  |SI aCampo3 = "A";
      activo = (activo + nImporte) ! 2;
  |SINO;
      pasivo = (pasivo + nImporte) ! 2;
  |FINSI;
*/
|FPRC;

|PROCESO LeoTotales803;
 |SI #803#8 = "C"; |O nCampo4 = 1;
     nImporte = nImporte + #803acumula;
 |FINSI;
|FPRC;

|DEFBUCLE LeoTotales803;
 #803#2;
 ;
 empresa, anyo, nCampo2, aCampo3, nCampo4, nDCampo5, nDCampo6, 00,0;
 empresa, anyo, nCampo2, aCampo3, nCampo4, nHCampo5, nHCampo6, 99,9;
 ;
 NULL, LeoTotales803;
|FIN;

|PROCESO elTotal803;
  |SI #421#8 = "A"; |ACABA; |FINSI;

  nImporte = 0;
  nCampo2 = #421#2;  ||Bloque
  aCampo3 = #421#3;  ||Tipo
  nCampo4 = #421#4;  ||Agrupacion
  nCampo5 = #421#5;  ||Subagrupacion

  |SI nCampo4 = 01;
      nDCampo5 = 1; nHCampo5 = 1;
      nDCampo6 = 0; nHCampo6 = 0;
      |BUCLE LeoTotales803;
  |FINSI;
  |SI nCampo4 = 02; |O nCampo4 = 03;
      nDCampo5 = 0; nHCampo5 = 0;
      nDCampo6 = 1; nHCampo6 = 99;
      |BUCLE LeoTotales803;
  |FINSI;
  |SI nCampo4 = 4;
      nImporte = nImporte1 + nImporte2 + nImporte3;
  |FINSI;

|SI nCampo4 ! 1;
  |ABRE #803;
  |SELECT #2#803;
  nCampo6 = 0;
  nCampo7 = 0;
  nCampo8 = 0;
  |HAZ cargatra_803;
  |SELECT #1#803;
  |CIERRA #803;
|FINSI;

  |SI nCampo4 = 1; nImporte1 = nImporte; |FINSI;
  |SI nCampo4 = 2; nImporte2 = nImporte; |FINSI;
  |SI nCampo4 = 3; nImporte3 = nImporte; |FINSI;
  |SI nCampo4 = 4; nImporte4 = nImporte; |FINSI;
|FPRC;

|DEFBUCLE elTotal803;
 #421#1;
 ;
 enEjerBal, nBalNum, nBalance, 6, "E", 00, 1, 00, 00, 0;
 enEjerBal, nBalNum, nBalance, 6, "E", 99, 9, 00, 00, 0;
 e;
 NULL, elTotal803;
|FIN;

|PROCESO ElCalculoFinal803;
|SI #0#3 = "SI";
    acumula   = 6;
    nImporte1 = 0;
    nImporte2 = 0;
    nImporte3 = 0;
    nImporte4 = 0;
    nImporte5 = 0;
    |BUCLE elTotal803;
|FINSI;
|SI #0#4 = "SI";
    acumula   = 7;
    nImporte1 = 0;
    nImporte2 = 0;
    nImporte3 = 0;
    nImporte4 = 0;
    nImporte5 = 0;
    |BUCLE elTotal803;
|FINSI;
|FPRC;

|| ***********************************************

|PROCESO grabatra803; || grabo todas
  |SI nImporte ! 0;
      nImporte = - nImporte; || (H-D)  IMPORTANTE
      |SI aAPR = "D"; |O aAPR = "G";
         |SI #422#10 = "-"; nImporte = - nImporte; |FINSI;
      |FINSI;
      |SI aAPR = "H"; |O aAPR = "I";
         |SI #422#10 = "+"; nImporte = - nImporte; |FINSI;
      |FINSI;

      |SI #422#11 ! " ";
          |SI #422#11 = "P"; |Y nImporte < 0; nImporte = 0; |FINSI;
          |SI #422#11 = "N"; |Y nImporte > 0; nImporte = 0; |FINSI;
      |FINSI;
      |SI nImporte ! 0;
          |HAZ LosTotales_803;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO calexpl01;
  aCuenta = #1#3;
  |HAZ MSigno08_s;

  debe1  = (debe1  + #1#6) ! 2;
  haber1 = (haber1 + #1#7) ! 2;
  |SI #1#9 > 0;
      debe2  = (debe2 + #1#9) ! 2;
  |SINO;
      haber2 = (haber2 - #1#9) ! 2;
  |FINSI;
|FPRC;

|DEFBUCLE calexpl0;
 #1#2;
 ;
 empresa, nEjer, "6           ";
 empresa, nEjer, "7zzzzzzzzzzz";
 e;
 NULL,calexpl01;
|FIN;

|PROCESO Explota;
  explo  = 0;
  explo2 = 0;
  debe1  = 0; debe2  = 0;
  haber1 = 0; haber2 = 0;

  |SI #0#2 = "A";
      |SI #0#3 = "SI";
         nEjer   = anyo - 1;
         |BUCLE calexpl0;
         explo2 = (debe1 - haber1) ! 2;
         debe1  = 0; debe2  = 0;
         haber1 = 0; haber2 = 0;
     |FINSI;
     |SI #0#4 = "SI";        || lee balance del ejercicio
         nEjer = anyo;
         |BUCLE calexpl0;
         explo  = (debe1 - haber1) ! 2;
         debe1  = 0; debe2  = 0;
         haber1 = 0; haber2 = 0;
     |FINSI;
 |SINO;
     nEjer = anyo;      ||solo lee el balance para los dos ejercicios
     |BUCLE calexpl0;
     explo  = (debe1 - haber1) ! 2;
     explo2 = (debe2 - haber2) ! 2;
 |FINSI;

  #422#2  = 6;
  #422#3  = "E";
  #422#4  = 1;
  #422#5  = 1;
  #422#6  = 0;
  #422#7  = 0;
  #422#8  = 1;
  #422#10 = "";
  #422#11 = "";
  #422#12 = 0;
  aAPR    = "";
  |SI #0#4 = "SI";
      nImporte = explo;
      |SI nImporte !  0;
          acumula = 7;
          |HAZ grabatra803; || grabo todas
      |FINSI;
  |FINSI;

   |SI #0#3 = "SI";
       nImporte = explo2;
       |SI nImporte ! 0;
           acumula = 6;
           |HAZ grabatra803; || grabo todas
       |FINSI;
  |FINSI;
|FPRC;


|PROCESO calculit803;

  aCuenta = #1#3;
  aTitulo = #1#4;
  |HAZ MSigno08_s;
  |SI aAPR ! "G"; |Y aAPR ! "I";
    |Y aAPR ! "D"; |Y aAPR ! "H";
      |ACABA;
  |FINSI;

  aAlfa1 = #1#3; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #1#3;
  aTitulo = #1#4;

  |SI #0#2 = "A"; |Y anyo ! 2008;
      nImporte = #1#8;
      |SI nImporte !  0;
          |HAZ grabatra803; || grabo todas
      |FINSI;
  |SINO;
      |SI #0#4 = "SI";
         nImporte = #1#8;
         |SI nImporte !  0;
             acumula = 7;
             |HAZ grabatra803; || grabo todas
         |FINSI;
     |FINSI;

      |SI #0#3 = "SI";
          nImporte = #1#9;
          |SI nImporte ! 0;
              acumula = 6;
              |HAZ grabatra803; || grabo todas
          |FINSI;
     |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE cabasitu803;
 #1#2;
 ;
 empresa, nEjer, aDCta;
 empresa, nEjer, aHCta;
 e;
 NULL,calculit803;
|FIN;


|PROCESO calculit_803;
 aAlfa1 = #422#9; |QBF aAlfa1;
 aDCta = (aAlfa1 + "            ") % 112;
 aHCta = (aAlfa1 + "zzzzzzzzzzzz") % 112;

 |SI #0#2 = "A"; |Y anyo ! 2008;   ||para el 2008 no hay 'a' de automatico
     |SI #0#3 = "SI";
         acumula = 6;
         nEjer   = anyo - 1;
         |BUCLE cabasitu803;
     |FINSI;
     |SI #0#4 = "SI";        || lee balance del ejercicio
         acumula = 7;
         nEjer = anyo;
         |BUCLE cabasitu803;
     |FINSI;
 |SINO;
     nEjer = anyo;      ||solo lee el balance para los dos ejercicios
     |BUCLE cabasitu803;
 |FINSI;
|FPRC;

|DEFBUCLE cabasitu4_803;
 #422#1;
 ;
 enEjerBal, nBalNum, nBalance, 6, "E", 00, 0, 00, 00, 0, 001;
 enEjerBal, nBalNum, nBalance, 9, "E", 99, 9, 99, 99, 9, 999;
 e;
 NULL,calculit_803;
|FIN;


|PROCESO PaseIngyGastos;
  |SI PARAMETRO = "";
      |ATRI I; |PINTA 1847, "Ingresos y Gastos Recon."; |ATRI 0;
  |FINSI;

  |ABRE #803;
  |SELECT #2#803;
  |HAZ Explota;
  |BUCLE cabasitu4_803;
  |SELECT #1#803;
  |CIERRA #803;

  |HAZ ElCalculoFinal803;
|FPRC;
