|FICHEROS;
     isom9232;
     maempr10;

     :integral/dsam0009;
     :integral/dsam0116;

     &clientes@;
|FIN;

|INCLUYE 9001vari;

|PROCESO QuitaRaros;
     aCadena = "";
     aLen    = eaAlfa % 0;
     nLen    = aLen;
     |PARA nCampo = 1;  |SI nCampo [ nLen;  |HACIENDO nCampo = nCampo + 1;
           nPos = (100 * nCampo) + 1;
           aCaracter = eaAlfa % nPos;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &241; |FINSI;
           |SI aCaracter = " ";  aCaracter = &225; |FINSI;
           |SI aCaracter = "‚";  aCaracter = &233; |FINSI;
           |SI aCaracter = "¡";  aCaracter = &237; |FINSI;
           |SI aCaracter = "¢";  aCaracter = &243; |FINSI;
           |SI aCaracter = "£";  aCaracter = &250; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     eaAlfa = aCadena;
|FPRC;

|PROCESO Calcula3E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("000" + aAlfa1) % -103) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula2E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("00" + aAlfa1) % -102) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula5E2D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("00000" + aAlfa1) % -105) + ((aAlfa2 + "00") % 102);
|FPRC;

|PROCESO Calcula3E4D;
     aAlfa     = (enCanti + "          ") % 110;
     nPos      = 0;
     aAlfa0    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nSwPunto  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ 10;  |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (100 * nCaracter) + 1;
           aAlfa0 = aAlfa % nPos;
           |SI aAlfa0 = "."; nSwPunto = 1;  |FINSI;
           |SI nSwPunto = 0;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                  aAlfa1 = aAlfa1 + aAlfa0;
               |FINSI;
           |FINSI;

           |SI nSwPunto = 1;
               |SI aAlfa0 ! " "; |Y aAlfa0 ! ".";
                   aAlfa2 = aAlfa2 + aAlfa0;
               |FINSI;
           |FINSI;
     |SIGUE;

     eaAlfa = (("000" + aAlfa1) % -103) + ((aAlfa2 + "0000") % 104);
|FPRC;

|PROCESO Calcula17D;
     enCanti = enCanti * 100;
     enCanti = enCanti ! 0;

     |SI enCanti ] 0;
         aAlfa = enCanti;
         eaAlfa = ("00000000000000000" + aAlfa) % -117;
     |SINO;
         enCanti  = -enCanti;
         aAlfa   = enCanti;
         eaAlfa   = "N" + (("0000000000000000" + aAlfa) % -116);
     |FINSI;
|FPRC;

|PROCESO GrabaSecuencial;
     |HAZ QuitaRaros;

     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO PonVentana;
     |VENTANA 0501, 0540, -1, 16, "Procesando emisi¢n modelo 232";
     nVent232 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent232;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO QuitaVentana;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent232;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent232;
|FPRC;

|PROCESO CopiaFichero;
     aAlfa = "";
     |IP_REMOTO aAlfa;  |QBT aAlfa;
     |SI aAlfa ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO GrabaPortal;
     eaAlfa = eaAlfa + &13 + &10;
     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO GrabaPortalSin;
     |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO TraeWait;
     |DBASE aAlfa;  |QBT aAlfa;
     aAlfa    = aAlfa + "planilla";
     aOrigen  = aAlfa + "/wait.exe";
     aDestino = eaDirLanza + "wait.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PresentaDeclaracion;
     aOrigen  = eaDirServidor + eaFicheroTxt;
     aDestino = eaDirLanza + eaFicheroTxt;
     |HAZ CopiaFichero;

     |HAZ TraeWait;

     eaForzExplorador = "N";
     enEjercicio      = #isom9232#1;
     |HAZ Explorador;

     aAbre = eaDirLanza + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandle;

     eaAlfa = eaDirLanza + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     eaAlfa = "https://www1.agenciatributaria.gob.es";
     |HAZ GrabaPortalSin;

     eaAlfa = "/wlpl/OV16-M232/index.zul";
     |HAZ GrabaPortal;

     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaDirLanza + eaFicheroTxt;
     |RFBORRA aAbre;
|FPRC;

|PROCESO MandaAInternet;
     |CONFI "0000NDesea presentar en estos momentos la declaracion";
     |SI FSalida = 0;
         aAlfa = "0000El fichero generado est  en " + eaDirLanza + " para su revisi¢n por la p gina de hacienda.";
         |MENAV aAlfa;

         |HAZ PresentaDeclaracion;
     |SINO;
         aOrigen  = eaDirServidor + eaFicheroTxt;
         aDestino = eaDirInternet + eaFicheroTxt;
         |HAZ CopiaFichero;

         aAlfa = "0000El fichero generado est  en " + aDestino + " para su presentaci¢n.";
         |MENAV aAlfa;
     |FINSI;

     eaImpre = "S";
     eaJusti = "";
|FPRC;

|PROCESO Portal;
     |HAZ PonVentana;

     aAlfa = eaDirInternet + eaFicheroTxt;   |RFBORRA aAlfa;

     |HAZ MandaAInternet;

     |HAZ QuitaVentana;
|FPRC;

|PROCESO AbreSecuencial;
     |DBASE aBase;  |QBF aBase;
     eaDirServidor = aBase + "tmp";   |MKDIR eaDirServidor;
     eaDirServidor = aBase + "tmp/";

     eaDirLanza    = eaUnidadBasico + "\AEAT";                                        |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\232";                                    |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\232\" + #isom9232#1;                          |RMKDIR eaDirLanza;
     eaDirLanza    = eaUnidadBasico + "\AEAT\232\" + #isom9232#1 + "\";

     aDirBase     = eaUnidadBasico + "\AEAT\232\";

     eaDirInternet = eaUnidadBasico + "/AEAT";                                        |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET";                               |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/232";                           |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/232/" + #isom9232#1;                 |RMKDIR eaDirInternet;
     eaDirInternet = eaUnidadBasico + "/AEAT/INTERNET/232/" + #isom9232#1 + "/";

     eaFicheroTxt = "232" + (("00000" + #isom9232#0) % -105) + (("00" + #isom9232#2) % -102) + ".txt";
     aFicheroP    = "portal232.html";

     aAbre       = eaDirServidor + eaFicheroTxt;
     |XABRE "BW", aAbre, enHandle;
|FPRC;

|PROCESO CierraSecuencial;
     |XCIERRA enHandle;

     |HAZ Portal;

     aAlfa = eaDirServidor + eaFicheroTxt;   |FBORRA aAlfa;
|FPRC;
