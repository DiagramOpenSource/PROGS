|FICHEROS;
     reparame #1;
     rem00021 #20;

     retabla7 #407;

     rew00621 #621,MANTE;
     rew00602 #602,MANTE;

     rew00003;
     rew00005;
|FIN;

|VARIABLES;
     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";

     nPorce        = 0;
     nAnyoIni      = 0;
     nAnyoAmor     = 0;
     nCoefiA       = 0;
     nResta        = 0;
     nError        = 0;
     nTotal        = 0;
     nTotalDias1   = 0;
     nTotalDias2   = 0;
     nImputable    = 0;
     nMejoras      = 0;
     nEdad         = 0;
     nAnyos        = 0;
     nLineaViv     = 0;
     nHabitual     = 0;
     nValor2       = 0;
     nNume         = 0;
     nAct117       = 0;
     nLin117       = 0;
     nSuma         = 0;
     nTotalDias    = 0;
     nDiasHab      = 0;
     nDiasAlq      = 0;
     nDiasUso      = 0;
     nLong         = 0;
     nCaracter     = 0;
     nPosi         = 0;
     nNumCampos    = 0;
     nNumPanta     = 0;
     nModo         = 0;
     nEntrada      = 0;
     nRetencion    = 0;
     nValor        = 0;
     nValor1       = 0;
     nValorPat     = 0;
     nDias         = 0;
     nAnyoVenta    = 0;
     nAnyoCompra   = 0;
     nDiferencia   = 0;
     nCoefi        = 0;
     nLinea        = 0;
     nContenido1   = 0;
     nContenido2   = 0;
     nAnyo         = 0;
     nSwHay        = 0;
     nCampo        = 0;
     nCampo1       = 0;
     nCampo2       = 0;
     nCampo3       = 0;
     nCampo4       = 0;
     nCampo5       = 0;
     nSwContenido  = 0;
     nCanti1       = 0;
     nCanti2       = 0;
     n73           = 0;
     nDia1         = 0;
     nDia2         = 0;
     nCoefMej      = 0;

     nTodosDias    = 0;
     nParciDias    = 0;
     nAmortiza     = 0;

     fFecha        = @;
     fFechaI       = @;
     fFechaF       = @;
     fFechaLim     = @;
     fFechaAdq     = @;
     fFechaTra     = @;
     fFechaBue     = @;
     fFecha1       = @;
     fFecha2       = @;
     fFechaTop     = @;
     fFechaDT9     = @;

     &eaExtr       = "";
     &enImporte    = 0;
     &enError      = 0;
|FIN;

|PROCESO Tipo12Fw602;  |TIPO 12;
     |SI FSalida ! 1; |Y FSalida ! 7;
         |POSICIONATE #602#65;

         |ERROR;
     |FINSI;
|FPRC;

|PROCESO PtecAbajo;
     |PTEC 809;
|FPRC;

|PROCESO TraeCoefi;
     |ABRE #407;
     #407#0 = 2015;
     #407#1 = nAnyoAmor;
     |LEE 040#407=;
     |SI FSalida ! 0;  |DDEFECTO #407;  |FINSI;
     |CIERRA #407;

     nCoefiA = #407#2;
     |SI #602#128 = "A";  nCoefiA = #407#3;  |FINSI;
     |SI #602#128 = "a";  nCoefiA = #407#3;  |FINSI;
|FPRC;

|PROCESO Amortiza;
     nAmortiza = 0;
     |SI nValor = 0;  |ACABA;  |FINSI;

     aAlfa = fFechaBue % -104;  nAnyoIni = aAlfa;

     |PARA nAnyoAmor = nAnyoIni;  |SI nAnyoAmor [ 2015;  |HACIENDO nAnyoAmor = nAnyoAmor + 1;
           aAlfa   = "01.01." + nAnyoAmor;  fFechaI = aAlfa;
           aAlfa   = "31.12." + nAnyoAmor;  fFechaF = aAlfa;
           nDias   = (fFechaF - fFechaI) + 1;

           |SI nAnyoAmor = 2015;
               fFechaF = #602#68;
           |FINSI;

           fFecha2 = fFechaBue;
           |SI fFechaBue < fFechaI;  fFecha2 = fFechaI;  |FINSI;

           nResta   = (fFechaF - fFecha2) + 1;
           |SI nResta < 0;
               nPorce = 0;
           |SINO;
               |HAZ TraeCoefi;
               nPorce = nCoefiA * (nResta / nDias);
           |FINSI;

           nAmortiza = nAmortiza + ((nValor % #602#65) * nPorce);
     |SIGUE;
|FPRC;


|PROCESO Coeficiente;
     aAlfa1      = fFecha1 % -104;
     aAlfa2      = fFecha2 % -104;
     nAnyoCompra = aAlfa1;
     ||nDiferencia = (fFecha2 - fFecha1) + 1;
     nDiferencia = fFecha2 - fFecha1;

     |SI #602#128 ! "A";  |Y #602#128 ! "a";
         |SI fFecha1 < "31.12.1994";  nAnyoCompra = 1994;  |FINSI;
         |SI fFecha1 = "31.12.1994";  nAnyoCompra = 1995;  |FINSI;
     |SINO;
         |SI fFecha1 < "01.01.1984";  nAnyoCompra = 1983;  |FINSI;
     |FINSI;

     |ABRE #407;
     |SI eaExtr = "S";
        #407#0 = aAlfa2;
     |SINO;
        #407#0 = 2015;
     |FINSI;
     #407#1 = nAnyoCompra;
     |LEE 040#407=;
     |SI FSalida ! 0;  |DDEFECTO #407;  |FINSI;
     |CIERRA #407;

                          nCoefi = #407#2;
     |SI #602#128 = "A";  nCoefi = #407#3;  |FINSI;
     |SI #602#128 = "a";  nCoefi = #407#3;  |FINSI;

     |SI nDiferencia [ 365;
         nCoefi = 1;
     |FINSI;

     nAnyoCompra = aAlfa1;
|FPRC;

|PROCESO Pinta602;
     |PINTA #rew00602#69;
     |PINTA #rew00602#70;
     |PINTA #rew00602#71;

     |PINTA #rew00602#26;
     |PINTA #rew00602#29;
     |PINTA #rew00602#63;
     |PINTA #rew00602#64;
     |PINTA #rew00602#66;
     |PINTA #rew00602#67;
     |PINTA #rew00602#146;
     |PINTA #rew00602#147;

     |PINTA #rew00602#144;
     |PINTA #rew00602#73;

     |PINTA #rew00602#148;
     |PINTA #rew00602#149;
     |PINTA #rew00602#150;
     |PINTA #rew00602#151;

     |PINTA #rew00602#109;
     |PINTA #rew00602#110;
     |PINTA #rew00602#111;
     |PINTA #rew00602#107;
     |PINTA #rew00602#152;
     |PINTA #rew00602#74;

     |PINTA #rew00602#153;
     |PINTA #rew00602#154;
     |PINTA #rew00602#72;
     |PINTA #rew00602#155;

     |PINTA #rew00602#75;
     |PINTA #rew00602#108;
     |PINTA #rew00602#76;
|FPRC;

|PROCESO CalculaValor;
     nValor  = #602#26;
     |SI #1#16 = "N";
         nValor  = #602#26 + #602#29;
     |FINSI;

     fFecha1 = #602#25;
     fFecha2 = #602#68;
     |HAZ Coeficiente;
     #602#63 = nCoefi;

     #602#64 = nValor * #602#63;

|| 컴컴컴컴컴컴컴컴  Venta

     nValor    = #602#26 - #602#29 - #602#28;
     |SI #1#16 = "N";
         nValor    = #602#26 - #602#28;
     |FINSI;

     nAmortiza = 0;
     fFechaBue = #602#25;
     |HAZ Amortiza;
     |SI #602#66 = 0;  |O nSwContenido = 1;
         #602#66  = nAmortiza;
     |FINSI;

     nValor    = #602#26;
     |SI #1#16 = "N";
         nValor    = #602#26 + #602#29;
     |FINSI;

     fFecha1   = #602#25;
     fFecha2   = #602#68;
     |HAZ Coeficiente;
     #602#63  = nCoefi;
     #602#64  = nValor * #602#63;


|| 컴컴컴컴컴컴컴컴  Mejora 1

     nValor    = #602#79 - #602#80;
     |SI #1#16 = "N";
         nValor    = #602#79;
     |FINSI;

     nAmortiza = 0;
     fFechaBue = #602#77;
     |HAZ Amortiza;
     |SI #602#81 = 0;  |O nSwContenido = 1;
         #602#81  = nAmortiza;
     |FINSI;

     nValor    = #602#79;
     |SI #1#16 = "N";
         nValor    = #602#79 + #602#80;
     |FINSI;
     fFecha1   = #602#77
     fFecha2   = #602#68;
     |HAZ Coeficiente;
     #602#82  = (nValor * nCoefi) - #602#81;

|| 컴컴컴컴컴컴컴컴  Mejora 2

     nValor    = #602#85 - #602#86;
     |SI #1#16 = "N";
         nValor    = #602#85;
     |FINSI;

     nAmortiza = 0;
     fFechaBue = #602#83;
     |HAZ Amortiza;
     |SI #602#87 = 0;  |O nSwContenido = 1;
         #602#87  = nAmortiza;
     |FINSI;

     nValor    = #602#85;
     |SI #1#16 = "N";
         nValor    = #602#85 + #602#86;
     |FINSI;
     fFecha1   = #602#83
     fFecha2   = #602#68;
     |HAZ Coeficiente;
     #602#88  = (nValor * nCoefi) - #602#87;

|| 컴컴컴컴컴컴컴컴  Mejora 3

     nValor    = #602#91 - #602#92;
     |SI #1#16 = "N";
         nValor    = #602#91;
     |FINSI;

     nAmortiza = 0;
     fFechaBue = #602#89;
     |HAZ Amortiza;
     |SI #602#93 = 0;  |O nSwContenido = 1;
         #602#93  = nAmortiza;
     |FINSI;

     nValor    = #602#91;
     |SI #1#16 = "N";
         nValor    = #602#91 + #602#92;
     |FINSI;
     fFecha1   = #602#89
     fFecha2   = #602#68;
     |HAZ Coeficiente;
     #602#94     = (nValor * nCoefi) - #602#93;

     #602#67     = #602#64 - #602#66;
     nMejoras    = #602#82 + #602#88 + #602#94;

     nCoefMej    = #602#67 / (#602#67 + nMejoras);
     #602#71     = (#602#69 - #602#70) * nCoefMej;
|FPRC;

|PROCESO Tipo7C108;  |TIPO 7;
     nContenido2 = #602#108;
|FPRC;

|PROCESO TotalFw602;
     nCampo      = Campo;
     nContenido1 = #602#75;

     |SI Campo ! 108;
         nContenido2 = #602#108;
     |FINSI;

     |HAZ CalculaValor;

     #602#150 = (#602#148 + #602#149) * nCoefMej;
     #602#107 = (#602#109 + #602#110) * nCoefMej;

     nValor  = (#602#148 + #602#149) ! 2;
     nValor1 = (#602#69 - #602#70) ! 2;

     |SI nValor > nValor1;
         |MENAV "0000Valor transmisi줻 rentas vitalicias mayor valor transmisi줻";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #602#107 > nValor1;
         |MENAV "0000Valor transmisi줻 vivienda habitual mayor valor transmisi줻";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #602#153 > nValor1;
         |MENAV "0000Valor transmisi줻 D.T.9 mayor valor transmisi줻";
         |ERROR;
         |ACABA;
     |FINSI;

     nValor = #602#148 + #602#149 + #602#109 + #602#110 + #602#153;
     |SI nValor > nValor1;
         |MENAV "0000Valor reinversi줻 mayor al valor venta";
         |ERROR;
         |ACABA;
     |FINSI;

     |C_M #602#144, 1, "S";
     |C_M #602#147, 1, "S";
     |C_M #602#148, 1, "S";
     |C_M #602#149, 1, "S";

     |C_M #602#109, 1, "S";
     |C_M #602#110, 1, "S";
     |C_M #602#111, 1, "S";

     |C_M #602#153, 1, "S";

     |C_M #602#108, 1, "S";
     |C_M #602#76,  1, "S";

     |C_M #602#144, 1, "S";
     |SI #602#25 < "15.05.2012";  |O #602#25 ] "01.01.2013";
         |C_M #602#144, 1, "N";  #602#144 = "N";
     |FINSI;

     |SI #602#25 ] "31.12.1994";
         |C_M #602#153, 1, "N";  #602#153 = 0;
     |FINSI;

     nValor = #602#71 - #602#67;
     |SI nValor < 0;
         nValor = -nValor;
         |SI #602#146 ! nValor;
             #602#146 = nValor;
             #602#147 = #602#146;
         |FINSI;

         |C_M #602#144, 1, "N";  #602#144 = "N";
         |C_M #602#73,  1, "N";  #602#73  = 0;
         |C_M #602#148, 1, "N";  #602#148 = 0;
         |C_M #602#149, 1, "N";  #602#149 = 0;
         |C_M #602#150, 1, "N";  #602#150 = 0;
         |C_M #602#151, 1, "N";  #602#151 = 0;
         |C_M #602#109, 1, "N";  #602#109 = 0;
         |C_M #602#110, 1, "N";  #602#110 = 0;
         |C_M #602#111, 1, "N";  #602#111 = 0;
         |C_M #602#107, 1, "N";  #602#107 = 0;
         |C_M #602#152, 1, "N";  #602#152 = 0;
         |C_M #602#74,  1, "N";  #602#74  = 0;

         |C_M #602#153, 1, "N";  #602#153 = 0;
         |C_M #602#154, 1, "N";  #602#154 = 0;
         |C_M #602#72,  1, "N";  #602#72  = 0;
         |C_M #602#155, 1, "N";  #602#155 = 0;

         |C_M #602#75,  1, "N";  #602#75  = 0;
         |C_M #602#108, 1, "N";  #602#108 = 0;
         |C_M #602#76,  1, "N";  #602#76  = 0;

         |HAZ Pinta602;

         |ACABA;
     |FINSI;

     |C_M #602#146, 1, "N";  #602#146 = 0;
     |C_M #602#147, 1, "N";  #602#147 = 0;

     |SI #602#128 = "A";  |O #602#128 = "a";
         |C_M #602#109, 1, "N";  #602#109 = 0;
         |C_M #602#110, 1, "N";  #602#110 = 0;
         |C_M #602#111, 1, "N";  #602#111 = 0;
         |C_M #602#153, 1, "N";  #602#153 = 0;
         |C_M #602#154, 1, "N";  #602#154 = 0;
         |C_M #602#72,  1, "N";  #602#72  = 0;
         |C_M #602#155, 1, "N";  #602#155 = 0;
     |FINSI;

     #602#73 = 0;
     |SI #602#144 = "S";
         #602#73 = nValor / 2;
     |FINSI;

     #602#151 = 0;
     |SI #602#150 ! 0;
         nValor1  = #602#150 * nCoefMej;
         #602#151 = (nValor - #602#73) * (#602#150 / #602#71);
     |FINSI;

     #602#152 = 0;
     |SI #602#107 ! 0;
         nValor1  = #602#111 * nCoefMej;
         #602#152 = ((nValor - #602#73) / (#602#71 - nValor1)) * #602#107;
     |FINSI;

     #602#74 = nValor - #602#73 - #602#151 - #602#152;

     #602#154 = 0;
     #602#155 = 0;
     #602#72  = 0;
     |SI #602#25 < "31.12.1994";  |Y #602#153 > 0;
         nPorce    = 11.11;
         fFechaDT9 = "20.01.2006";
         fFechaTop = "31.12.1996";
         nDia1     = fFechaDT9 - #rew00602#25;
         nDia2     = #rew00602#68 - #rew00602#25;
         nAnyos    = ((((fFechaTop - #rew00602#25) / 365) - 2) + .49) ! 0;
         |SI nAnyos < 0;  nAnyos = 0;  |FINSI;

         nCoefi    = nAnyos * nPorce;
         |SI nCoefi > 100; nCoefi = 100; |FINSI;

         #602#154 = (((#602#74 / nDia2) * nDia1) / (#602#71)) * #602#153;
         |SI #602#154 < 0;  #602#154 = 0;  |FINSI;

         #602#72  = nAnyos;

         #602#155 = (#602#154 * nCoefi) / 100;
         |SI #602#155 < 0;  #602#155 = 0;  |FINSI;
     |FINSI;

     #602#75 = #602#74 - #602#155;

     |SI nContenido1 ! #602#75;  |O nContenido2 ! #602#108;
         nValor      = #602#71 - #602#67;
         |SI nValor  ] 0;
             #602#76 = (#602#75 * #602#108) / #602#69;
             |SI #602#76 > #602#75;  #602#76 = #602#75;  |FINSI;
         |SINO;
             #602#76 = (#602#75 * #602#108) / #602#69;
         |FINSI;
     |FINSI;

     |HAZ Pinta602;

     nSwContenido = 0;
|FPRC;

|PROCESO PonCobrado;
     |SI #602#108 = 0;
         #602#108 = #602Campo;
         |PINTA #602#108;
     |FINSI;
|FPRC;

|PROCESO Mejoras;
     nCampo1 = Campo + 1;
     nCampo2 = Campo + 2;
     nCampo3 = Campo + 3;
     nCampo4 = Campo + 4;
     nCampo5 = Campo + 5;

     |C_M #602nCampo1, 1, "S";
     |C_M #602nCampo2, 1, "S";
     |C_M #602nCampo3, 1, "S";

     |SI #602Campo = "01.01.0000";
         |C_M #602nCampo1, 1, "N";  #602nCampo1 = "";  |PINTA #602nCampo1;
         |C_M #602nCampo2, 1, "N";  #602nCampo2 = 0;   |PINTA #602nCampo2;
         |C_M #602nCampo3, 1, "N";  #602nCampo3 = 0;   |PINTA #602nCampo3;
                                    #602nCampo4 = 0;   |PINTA #602nCampo4;
                                    #602nCampo5 = 0;   |PINTA #602nCampo5;
     |FINSI;
|FPRC;

|PROCESO Tipo0Vital;  |TIPO 0;
     #rew00003#0 = #rew00602#2;
     #rew00003#1 = #rew00602#3;
     #rew00003#2 = #rew00602#4;
     #rew00003#3 = #rew00602#5;
     #rew00003#4 = #rew00602#6;
     #rew00003#5 = #rew00602#7;
     #rew00003#6 = #rew00602#8;
     #rew00003#7 = #rew00602#9;
     #rew00003#8 = #rew00602#10;

     enImporte = #rew00602#150;
     |HAZ ChequeaVitalicias;
     |SI enError = 1;
         aAlfa = "0000El importe de la transmisi줻 supera a lo que nos queda pendiente.";
         |MENAV aAlfa;
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0DT9;  |TIPO 0;
     #rew00003#0 = #rew00602#2;
     #rew00003#1 = #rew00602#3;
     #rew00003#2 = #rew00602#4;
     #rew00003#3 = #rew00602#5;
     #rew00003#4 = #rew00602#6;
     #rew00003#5 = #rew00602#7;
     #rew00003#6 = #rew00602#8;
     #rew00003#7 = #rew00602#9;
     #rew00003#8 = #rew00602#10;

     enImporte = #rew00602#153;
     |HAZ ChequeaDT9;
     |SI enError = 1;
         aAlfa = "0000El importe de la transmisi줻 supera a lo que nos queda pendiente.";
         |MENAV aAlfa;
         |ERROR;
     |FINSI;
|FPRC;
