|FICHEROS;
    preinfor #0;

    premvtol #11;   || movtos. lins.
    pretopes #12;   || ajustes de marcado

    prequiva #20;   || tarjetas
    pretarea #21;   || incidencias
    labempre #23;   || empresas
    labtraba #24;   || trabajadores
    nomtrcal #25;   || calendario laboral

    pretmp01 #50;   || def de impresion del detalle
    pretopel;
    precontr;
|FIN;

|VARIABLES;
    &enAnyo = 0;
    &enMes  = 0;

    &enDTarj = 0; &enHTarj = 0;
    &enDEmpr = 0; &enHEmpr = 0;
    &enDTrab = 0; &enHTrab = 0;
    &enDTerm = 0; &enHTerm = 0;

    &diaant = 0;
    aAlfa  = "";
    aAlfa1 = "";

    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;
    elsw1 = 0;
    elsw2 = 0;
    elsw3 = 0;
    elsw4 = 0;
    FEstado = 0;
    seleccio = 0;
    modo = 0;
    sw_rup = 0;
    nSwHay = 0;

    p_mes = "";
    dia_ant = 0;
    bar_ant = 0;
    hor_ant = 0;
    min_ant = 0;
    lin_ant = 0;
    nhor = 0;
    nmin = 0;
    &shor = 0;
    &sext = 0;
    &dhor = 0;
    &dext = 0;
    &ghor = 0;
    &gext = 0;
    &error = "";
    &swlin = 0;
    swentra = 0;
    dhora = 0;
    hhora = 0;
    chora = 0;
    dminu = 0;
    hminu = 0;
    cminu = 0;
    desde = 0;
    hasta = 0;
    rajus = 0;
    hajus = 0;
    majus = 0;
    lectu = 0;
    rhora = 0;
    dlect = 0;
    hlect = 0;
    aju_cod = 0;
    aju_dia = @;
    elmes = 0;
    eldia = 0;
    fehas = @;
    emp_ant = 0;
    tra_ant = 0;
     nCodAjus = 0;
     swAjuste = 0;
     swentra2 = 0;

   nTarjeta = 0;
   fFechaAnt = @;
   nRegAnt  = 0;
   nTerEnt = 0;
   nTerSal = 0;
|FIN;
____________________________________/
|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
    fech1 = ~;
    alfa1 = fech1;
    alfa1 = alfa1 % -104;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO mirames; |TIPO 7; ||CALCULA EL MES POR DEFECTO SEGUN FECHA SISTEMA
    fech1 = ~;
    alfa1 = fech1;
    alfa1 = alfa1 % 402;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
|SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
|SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
|SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
|SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
|SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|PINTA 1136, p_mes;
|FPRC;

|PROCESO mayus; |TIPO 0;
    #0Campo = #0Campo > #0Campo;
|PINTA #0Campo;
|FPRC;

|PROCESO dias; |TIPO 7;
|SI #0#2 = #0#3;
        #0#12 = "N";
    |PINTA #0#12;
    |C_M #0#12, 1, "N";
|SINO;
    |C_M #0#12, 1, "S";
|FINSI;
|FPRC;
____________________________________/
|PROCESO h_extras;
    #24#0 = emp_ant;
    #24#1 = tra_ant;
|LEE 000#24=;
|SI FSalida = 0;
    |DDEFECTO #25;
        #25#0 = #24#156;
        #25#13 = #0#0;
    |LEE 000#25=;
        elmes = #0#1;
        eldia = (#50#0 * 100) + 1;
        alfa1 = #25elmes % eldia;
    |SI alfa1 = "1";
            dext = dhor;
    |SINO;
        |SI dhor > 8;
                dext = dhor - 8;
        |SINO;
                dext = 0;
        |FINSI;
    |FINSI;
|FINSI;

    sext = sext + dext;       || total tarjeta extras
    gext = gext + dext;       || total general extras
|FPRC;

|PROCESO AjusteLineal;
     desde = (#pretopel#2 * 100) + #pretopel#3;
     hasta = (#pretopel#4 * 100) + #pretopel#5;
     |SI lectu ] desde;|Y lectu [ hasta;
          nhor = #pretopel#6 - hajus;
          nmin = #pretopel#7 - majus;
          |SI nmin < 0;
               nhor = nhor - 1;
               nmin = 60 + nmin;
          |FINSI;
          rajus = (nhor * 60) + nmin;

          hajus = #pretopel#6;
          majus = #pretopel#7;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE AjusteLineal;
     #pretopel#1;
     ;
     #pretopes#0, #pretopes#142,  0,  0;
     #pretopes#0, #pretopes#142, 23, 59;
     ;
     NULL, AjusteLineal;
|FIN;

|PROCESO ajustes1;
    aju_cod = #12#0;
    aju_dia = #12#142;
|FPRC;

|DEFBUCLE ajustes;
 #12#1;
 ;
 nCodAjus, "01.01.1900";
 nCodAjus, fehas;
 ;
 NULL, ajustes1;
|FIN;

|PROCESO lee_ajuste;
    alfa1 = #11#3;  alfa1 = ("00" + alfa1) % -102;
    alfa2 = #0#1;   alfa2 = ("00" + alfa2) % -102;
    alfa3 = alfa1 + "." + alfa2 + "." + #0#0;
    fehas = alfa3;

    aju_cod = -1;

     |SI swAjuste = 1;        || tengo en cuenta ajuste de Salida y de Entrada
          |SI swentra2 = 0;              || significa que es ENTRADA
               nCodAjus = #20#3;
          |SINO;
               nCodAjus = #20#6;
          |FINSI;
     |SINO;
          nCodAjus = #20#3;   || para todos el mismo
     |FINSI;

|BUCLE ajustes;

|DDEFECTO #12;
|SI aju_cod ! -1;
        #12#0 = aju_cod;
        #12#142 = aju_dia;
    |LEE 020#12=;
|FINSI;
|FPRC;

|PROCESO descuentos;
|HAZ lee_ajuste;

    rajus = 0;
    dlect = (#50#5 * 100) + #50#6;
    hlect = (#50#7 * 100) + #50#8;
|PARA para1 = 122; |SI para1 [ 125; |HACIENDO para1 = para1 + 1;
        dhora = para1;         dminu = para1 + 4;
        hhora = para1 + 8;     hminu = para1 + 12;
        rhora = para1 + 16;

        desde = (#12dhora * 100) + #12dminu;
        hasta = (#12hhora * 100) + #12hminu;
    |SI desde ! 0;|Y hasta ! 0;
        |SI hlect ] desde;|Y dlect [ hasta;
                rajus = #12rhora;
        |FINSI;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO ajustes;
|HAZ lee_ajuste;

    rajus = 0;
    lectu = (hajus * 100) + majus;
|PARA para1 = 2; |SI para1 [ 21; |HACIENDO para1 = para1 + 1;
        dhora = para1;         dminu = para1 + 20;
        hhora = para1 + 40;    hminu = para1 + 60;
        chora = para1 + 80;    cminu = para1 + 100;

        desde = (#12dhora * 100) + #12dminu;
        hasta = (#12hhora * 100) + #12hminu;
    |SI lectu ] desde;|Y lectu [ hasta;
            nhor = #12chora - hajus;
            nmin = #12cminu - majus;
        |SI nmin < 0;     nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;
            rajus = (nhor * 60) + nmin;

            hajus = #12chora;
            majus = #12cminu;
        |SAL;
    |FINSI;
|SIGUE;

|BUCLE AjusteLineal;
|FPRC;

|PROCESO detalle;
    #50#0 = #11#3;       || dia
    #50#1 = hor_ant;     || desde hora (M)
    #50#2 = min_ant;     || hasta minutos (M)
    #50#3 = #11#4;       || hasta hora (M)
    #50#4 = #11#5;       || hasta minutos (M)
    #50#5 = hor_ant;     || desde hora (C)
    #50#6 = min_ant;     || hasta minutos (C)
    #50#7 = #11#4;       || hasta hora (C)
    #50#8 = #11#5;       || hasta minutos (C)
    #50#9 = 0;           || minutos ajustados
    #50#10 = 0;          || fraccion horas
    #50#11 = 0;          || fraccion minutos
    #50#12 = 0;          || tiempo en minutos
    #50#13 = 0;          || tiempo en horas

     swentra2 = 0;
    hajus = #50#5;  majus = #50#6;
|HAZ ajustes;                      || ajusta el desde
    #50#9 = #50#9 - rajus;
    #50#5 = hajus;  #50#6 = majus;

     swentra2 = 1;
    hajus = #50#7;  majus = #50#8;
|HAZ ajustes;                      || ajusta el hasta
    #50#9 = #50#9 + rajus;
    #50#7 = hajus;  #50#8 = majus;

    nhor = #50#7 - #50#5;
    nmin = #50#8 - #50#6
|SI nmin < 0;    nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;

|HAZ descuentos;
    #50#15 = rajus;
    nmin = nmin + #50#15;
|SI nmin < 0;    nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;

|SI nmin < 0;  nmin = 0; |FINSI;
|SI nhor < 0;  nhor = 0; |FINSI;

    #50#10 = nhor;
    #50#11 = nmin;
    #50#12 = (nhor * 60) + nmin;
    #50#13 = nhor + (nmin / 60);
    #50#14= #11#2;       || linea

    shor = shor + #50#13;     || total por tarjeta
    dhor = dhor + #50#13;     || total por dia
    ghor = ghor + #50#13;     || total general

   aAlfa = (("00" + #11#3) % -102) + "." + (("00" + #11#1) % -102) + "." + (("0000" + #11#0) % -104);
   #50#17 = #11#7;
   #50#18 = aAlfa;
|FPRC;

|PROCESO rup_bar;
|DDEFECTO #20;   #20#0 = bar_ant;              |LEE 000#20=;     || tarjeta
|SI FSalida ! 0; |DDEFECTO #20; |FINSI;
|DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
|SI FSalida ! 0; |DDEFECTO #23; |FINSI;
|DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
|SI FSalida ! 0; |DDEFECTO #24; |FINSI;
/*
    swlin = 1;
|PRINT;
*/
    shor = 0;
    sext = 0;
    bar_ant = #11#7;
    swentra = 0;
|FPRC;

|PROCESO rup_dia;
error = "";
|SI swentra = 1;
        error = "Tarjeta [" + bar_ant + "." + lin_ant + "] sin registro de salida. [" + hor_ant + ":" + min_ant + "]";
        swlin = 3;
    |PRINT;
    error = "";
|FINSI;

|HAZ h_extras;

/*
|SI #0#12 = "S";
        swlin = 2;
    |PRINT;
|FINSI;
*/
    dhor = 0;
    dia_ant = #11#3;
    swentra = 0;
|FPRC;

|PROCESO movimientos1;
|DDEFECTO #20;   #20#0 = #11#7;                |LEE 000#20=;     || tarjeta
|SI FSalida ! 0; |DDEFECTO #20; |FINSI;
|SI #20#1 < #0#8; |O #20#1 > #0#9;      |ACABA;   |FINSI;   || empresas
|SI #20#2 < #0#10;|O #20#2 > #0#11;     |ACABA;   |FINSI;   || trabajadores

|DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
|SI FSalida ! 0; |DDEFECTO #23; |FINSI;
|DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
|SI FSalida ! 0; |DDEFECTO #24; |FINSI;

|SI sw_rup = 0;
        sw_rup = 1;
        bar_ant = #11#7;
        dia_ant = #11#3;
|FINSI;

diaant = dia_ant;
|SI bar_ant ! #11#7;
    |HAZ rup_dia;
    |HAZ rup_bar;
|SINO;
    |SI dia_ant ! #11#3;
        |HAZ rup_dia;
    |FINSI;
|FINSI;

|SI swentra = 1;
        swentra = 0;
    |HAZ detalle;

        swlin = 0;
    |PRINT;
|SINO;
        swentra = 1;

        hor_ant = #11#4;
        min_ant = #11#5;
        lin_ant = #11#2;
|FINSI;

    emp_ant = #20#1;
    tra_ant = #20#2;
|FPRC;

|PROCESO GrabaRegistro;
    #50#0 = fFechaAnt;   || dia
    #50#1 = hor_ant;     || desde hora (M)
    #50#2 = min_ant;     || hasta minutos (M)
    #50#3 = #11#4;       || hasta hora (M)
    #50#4 = #11#5;       || hasta minutos (M)
    #50#5 = hor_ant;     || desde hora (C)
    #50#6 = min_ant;     || hasta minutos (C)
    #50#7 = #11#4;       || hasta hora (C)
    #50#8 = #11#5;       || hasta minutos (C)
    #50#9 = 0;           || minutos ajustados
    #50#10 = 0;          || fraccion horas
    #50#11 = 0;          || fraccion minutos
    #50#12 = 0;          || tiempo en minutos
    #50#13 = 0;          || tiempo en horas
    #50#20 = nTerEnt;
    #50#21 = nTerSal;

    swentra2 = 0;
    hajus = #50#5;  majus = #50#6; |HAZ ajustes; || ajusta el desde
    #50#9 = #50#9 - rajus;
    #50#5 = hajus;  #50#6 = majus;

    swentra2 = 1;
    hajus = #50#7;  majus = #50#8; |HAZ ajustes; || ajusta el hasta
    #50#9 = #50#9 + rajus;
    #50#7 = hajus;  #50#8 = majus;

    nhor = #50#7 - #50#5;
    nmin = #50#8 - #50#6
    |SI nmin < 0; nhor = nhor - 1; nmin = 60 + nmin; |FINSI;

    |HAZ descuentos;
    #50#15 = rajus;
    nmin = nmin + #50#15;
    |SI nmin < 0; nhor = nhor - 1; nmin = 60 + nmin; |FINSI;

    |SI nmin < 0;  nmin = 0; |FINSI;
    |SI nhor < 0;  nhor = 0; |FINSI;

    #50#10 = nhor;
    #50#11 = nmin;
    #50#12 = (nhor * 60) + nmin;
    #50#13 = nhor + (nmin / 60);
    #50#14= #11#2;       || linea

    aAlfa = (("00" + #11#3) % -102) + "." + (("00" + #11#1) % -102) + "." + (("0000" + #11#0) % -104);
    #50#17 = #11#7;
    #50#18 = aAlfa;
    #50#19 = error;

    |GRABA 020#50n;

    nSwHay = 1;
|FPRC;

|PROCESO movimientos;
   |DDEFECTO #20;   #20#0 = #11#7;                |LEE 000#20=;     || tarjeta
   |SI FSalida ! 0; |DDEFECTO #20; #20#0 = #50#17; |FINSI;
   |SI #20#1 < #0#8; |O #20#1 > #0#9;      |ACABA;   |FINSI;   || empresas
   |SI #20#2 < #0#10;|O #20#2 > #0#11;     |ACABA;   |FINSI;   || trabajadores

   |DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
   |SI FSalida ! 0; |DDEFECTO #23; |FINSI;
   |DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
   |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

   aAlfa = (("00" + #11#3) % -102) + "." + (("00" + #11#1) % -102) + "." + (("0000" + #11#0) % -104);
   |SI #premvtol#7 ! nTarjeta; |O aAlfa ! fFechaAnt;
      |SI hor_ant = 0; |Y min_ant = 0;  || Ya se ha grabado antes o es el primero
         hor_ant = #premvtol#4;
         min_ant = #premvtol#5;
         nTerEnt = #premvtol#9;
      |SINO;                            || Falta la hora de salida
         || Cojo los datos del movimiento de entrada
         |SALVA_FICHA #11; |SELECT #1#11;
         aAlfa  = fFechaAnt; |QBF aAlfa;
         aAlfa1 = aAlfa % 0704;
         #11#0 = aAlfa1;
         aAlfa1 = aAlfa % 0402;
         #11#1 = aAlfa1;
         aAlfa1 = aAlfa % 0102;
         #11#3 = aAlfa1;
         #11#2 = nRegAnt;
         |LEE 000#11=;
         |SI FSalida ! 0; |DDEFECTO #11; |FINSI;
         #11#4 = ""; #11#5 = "";

         error = "Tarjeta [" + (("00" + hor_ant) % -102) + ":" + (("00" + min_ant) % -102) + "] sin registro de salida. [" + (("000000" + nTarjeta) % -106) + "-" + fFechaAnt + "]";
         |HAZ GrabaRegistro;

         |SELECT #2#11; |REPON_FICHA #11;
         error = "";
         hor_ant = #premvtol#4; min_ant = #premvtol#5;
         nTerEnt = #premvtol#9;
      |FINSI;
   |SINO;
      |SI hor_ant ! 0; |O min_ant ! 0;
         nTerSal = #premvtol#9;
         |HAZ GrabaRegistro;
         hor_ant = 0; min_ant = 0;
         nTerEnt = 0;
         nTerEnt = 0;
      |SINO;
         hor_ant = #premvtol#4;
         min_ant = #premvtol#5;
         nTerEnt = #premvtol#9;
      |FINSI;
   |FINSI;

   nTarjeta = #premvtol#7;
   aAlfa = (("00" + #11#3) % -102) + "." + (("00" + #11#1) % -102) + "." + (("0000" + #11#0) % -104);
   fFechaAnt = aAlfa;
   nRegAnt  = #11#2;
|FPRC;

|DEFBUCLE movimientos;
 #11#2;
 9;
 #0#0, #0#1, #0#4, #0#2,  0,  0,  0, #0#13;
 #0#0, #0#1, #0#5, #0#3, 23, 59, 59, #0#14;
 ;
 NULL, movimientos;
|FIN;

|PROCESO Control;
     |LEE 000#precontr.p;
     |SI FSalida ! 0;    || No existe control de la aplicacion, entonces
          swAjuste = 0;  || el Codigo de Ajuste de Salida es el de Entrada
     |SINO;              || esto para los que usaran el programa antes de
          |SI #precontr#1 = "S";   || meter el codigo de salida, cuando
               swAjuste = 0;       || solo habia de entrada 26.05.2004
          |SINO;
               swAjuste = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Imprime;
   |DDEFECTO #20;   #20#0 = #50#17;               |LEE 000#20=;     || tarjeta
   |SI FSalida ! 0; |DDEFECTO #20; #20#0 = #50#17; |FINSI;
   |DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
   |SI FSalida ! 0; |DDEFECTO #23; |FINSI;
   |DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
   |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
   |PRINT;
|FPRC;

|DEFBUCLE Imprime;
#50#1;
;
INICIO;
FINAL;
;
NULL, Imprime;
|FIN;

|PROCESO tipo3;
    Impresora = "CrystalReport";
    |IMPRE -1;
    |SI FSalida = 0;
       aAlfa = "tm" + Usuario; |NOME_DAT #50#aAlfa#;
       |DELINDEX #50; |ABRE #50;
       |ABRET #12; |ABRE #20; |ABRE #21;
       |ABRE #23;  |ABRE #24; |ABRE #25;
       |ABRE #precontr;

       |HAZ Control;
       nSwHay = 0; |BUCLE movimientos;

       |SI nSwHay ! 0;
          |SI PARAMETRO = "";    |INFOR "preinfor"; |FINSI;
          |SI PARAMETRO = "MES"; |INFOR "preinme1"; |FINSI;
          |SI FSalida = 0;
             |BUCLE Imprime;
             |PIEINF; |FININF;
          |FINSI;
       |SINO;
          |MENAV "    Seleccion vacia ...";
       |FINSI;

       |CIERRA #50; |DELINDEX #50;
       |CIERRAT #12; |CIERRA #20; |CIERRA #21;
       |CIERRA #23;  |CIERRA #24; |CIERRA #25;
       |CIERRA #precontr;
       |FINIMP;
   |SINO;
       |MENAV "    Proceso abortado ... No puedo abrir la impresora.";
   |FINSI;
|FPRC;

|PROCESO Nuevo;
     aAlfa = "tm" + Usuario; |NOME_DAT #50#aAlfa#;
     |DELINDEX #50; |ABRE #50;
     |ABRET #12; |ABRE #20; |ABRE #21;
     |ABRE #23;  |ABRE #24; |ABRE #25;
     |ABRE #precontr;

     |HAZ Control;
     |BUCLE movimientos;
|FPRC;

|PROGRAMA;
   |SI PARAMETRO = "";
      |CLS;
      |CABEZA " Informe de comprobacion de movimientos ";
      |PINPA #0#0; |PINDA #0#0;
      |ENDATOS #1#0;
   |SINO;
      #preinfor#0 = enAnyo;   #preinfor#1 = enMes;
      #preinfor#2  = 1;       #preinfor#3  = 31;
      #preinfor#4  = enDTarj; #preinfor#5  = enHTarj;
      #preinfor#8  = enDEmpr; #preinfor#9  = enHEmpr;
      #preinfor#10 = enDTrab; #preinfor#11 = enHTrab;
      #preinfor#13 = enDTerm; #preinfor#14 = enHTerm;

      #preinfor#12 = "N";

      |SI PARAMETRO = "NUEVO"; |HAZ Nuevo; |ACABA; |FINSI;

      FSalida = 0;
   |FINSI;

   |SI FSalida = 0;
      |HAZ tipo3;
   |FINSI;
|FPRO;
