|FICHEROS;
    preinsem #0;

    premvtol #11;   || movtos. lins.
    pretopes #12;   || ajustes de marcado

    prequiva #20;   || tarjetas
    pretarea #21;   || incidencias
    labempre #23;   || empresas
    labtraba #24;   || trabajadores
    nomtrcal #25;   || calendario laboral

    pretmp01 #50;   || def de impresion del detalle

    pretmp03 #60;   || Varios Horas.
    pretopel;
    precontr;
|FIN;

|VARIABLES;
    nRedo = 0;
    nDeci = 0;
    num1  = 0;
    num2  = 0;
    aDefe = "";
    aHafe = "";
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;
    elsw1 = 0;
    elsw2 = 0;
    elsw3 = 0;
    elsw4 = 0;
    FEstado = 0;
    seleccio = 0;
    modo = 0;
    sw_rup = 0;

    p_mes = "";
    dia_ant = 0;
    bar_ant = 0;
    hor_ant = 0;
    min_ant = 0;
    lin_ant = 0;
    nhor = 0;
    nmin = 0;
    &shor = 0;
    &sext = 0;
    &dhor = 0;
    &dext = 0;
    &ghor = 0;
    &gext = 0;
    &error = "";
    &swlin = 0;
    swentra = 0;
    dhora = 0;
    hhora = 0;
    chora = 0;
    dminu = 0;
    hminu = 0;
    cminu = 0;
    desde = 0;
    hasta = 0;
    rajus = 0;
    hajus = 0;
    majus = 0;
    lectu = 0;
    rhora = 0;
    dlect = 0;
    hlect = 0;
    aju_cod = 0;
    aju_dia = @;
    elmes = 0;
    eldia = 0;
    fehas = @;
    emp_ant = 0;
    tra_ant = 0;
    sdia = 0;
    smas = 0;
    sdife = 0;
    srest = 0;
    nAnde = 0;
    nMede = 0;
    nDide = 0;
    nAnha = 0;
    nMeha = 0;
    nDiha = 0;

     nCodAjus = 0;
     swAjuste = 0;
     swentra2 = 0;
|FIN;
____________________________________/
|PROCESO defecto; |TIPO 7; ||calcula el a¤o por defecto segun fecha sistema
    fech1 = ~;
    alfa1 = fech1;
    alfa1 = alfa1 % -104;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO mayus; |TIPO 0;
    #0Campo = #0Campo > #0Campo;
|PINTA #0Campo;
|FPRC;

|PROCESO dias; |TIPO 7;
|SI #0#2 = #0#3;
        #0#12 = "N";
    |PINTA #0#12;
    |C_M #0#12, 1, "N";
|SINO;
    |C_M #0#12, 1, "S";
|FINSI;
|FPRC;
____________________________________/
|PROCESO h_extras;
/*
    #24#0 = emp_ant;
    #24#1 = tra_ant;
|LEE 000#24=;
|SI FSalida = 0;
    |DDEFECTO #25;
        #25#0 = #24#156;
        #25#13 = #0#0;
    |LEE 000#25=;
        elmes = #0#1;
        eldia = (#50#0 * 100) + 1;
        alfa1 = #25elmes % eldia;
    |SI alfa1 = "1";
            dext = dhor;
    |SINO;
        |SI dhor > 8;
                dext = dhor - 8;
        |SINO;
                dext = 0;
        |FINSI;
    |FINSI;
|FINSI;
*/
    sext = sext + dext;       || total tarjeta extras
    gext = gext + dext;       || total general extras
|FPRC;

|PROCESO AjusteLineal;
     desde = (#pretopel#2 * 100) + #pretopel#3;
     hasta = (#pretopel#4 * 100) + #pretopel#5;
     |SI lectu ] desde;|Y lectu [ hasta;
          nhor = #pretopel#6 - hajus;
          nmin = #pretopel#7 - majus;
          |SI nmin < 0;
               nhor = nhor - 1;
               nmin = 60 + nmin;
          |FINSI;
          rajus = (nhor * 60) + nmin;

          hajus = #pretopel#6;
          majus = #pretopel#7;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE AjusteLineal;
     #pretopel#1;
     ;
     #pretopes#0, #pretopes#142,  0,  0;
     #pretopes#0, #pretopes#142, 23, 59;
     ;
     NULL, AjusteLineal;
|FIN;

|PROCESO ajustes1;
    aju_cod = #12#0;
    aju_dia = #12#142;
|FPRC;

|DEFBUCLE ajustes;
 #12#1;
 ;
 nCodAjus, "01.01.1900";
 nCodAjus, fehas;
 ;
 NULL, ajustes1;
|FIN;

|PROCESO lee_ajuste;
    alfa1 = #11#3;  alfa1 = ("00" + alfa1) % -102;
    alfa2 = #0#1;   alfa2 = ("00" + alfa2) % -102;
    alfa3 = alfa1 + "." + alfa2 + "." + #0#0;
    fehas = alfa3;

    aju_cod = -1;

     |SI swAjuste = 1;        || tengo en cuenta ajuste de Salida y de Entrada
          |SI swentra2 = 0;              || significa que es ENTRADA
               nCodAjus = #20#3;
          |SINO;
               nCodAjus = #20#6;
          |FINSI;
     |SINO;
          nCodAjus = #20#3;   || para todos el mismo
     |FINSI;

|BUCLE ajustes;

|DDEFECTO #12;
|SI aju_cod ! -1;
        #12#0 = aju_cod;
        #12#142 = aju_dia;
    |LEE 020#12=;
|FINSI;
|FPRC;

|PROCESO descuentos;
|HAZ lee_ajuste;

    rajus = 0;
    dlect = (#50#5 * 100) + #50#6;
    hlect = (#50#7 * 100) + #50#8;
|PARA para1 = 122; |SI para1 [ 125; |HACIENDO para1 = para1 + 1;
        dhora = para1;         dminu = para1 + 4;
        hhora = para1 + 8;     hminu = para1 + 12;
        rhora = para1 + 16;

        desde = (#12dhora * 100) + #12dminu;
        hasta = (#12hhora * 100) + #12hminu;
    |SI desde ! 0;|Y hasta ! 0;
        |SI hlect ] desde;|Y dlect [ hasta;
                rajus = #12rhora;
        |FINSI;
    |FINSI;
|SIGUE;
|FPRC;

|PROCESO ajustes;
|HAZ lee_ajuste;

    rajus = 0;
    lectu = (hajus * 100) + majus;
|PARA para1 = 2; |SI para1 [ 21; |HACIENDO para1 = para1 + 1;
        dhora = para1;         dminu = para1 + 20;
        hhora = para1 + 40;    hminu = para1 + 60;
        chora = para1 + 80;    cminu = para1 + 100;

        desde = (#12dhora * 100) + #12dminu;
        hasta = (#12hhora * 100) + #12hminu;
    |SI lectu ] desde;|Y lectu [ hasta;
            nhor = #12chora - hajus;
            nmin = #12cminu - majus;
        |SI nmin < 0;     nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;
            rajus = (nhor * 60) + nmin;

            hajus = #12chora;
            majus = #12cminu;
        |SAL;
    |FINSI;
|SIGUE;
|BUCLE AjusteLineal;
|FPRC;

|PROCESO detalle;
    #50#0 = #11#3;       || dia
    #50#1 = hor_ant;     || desde hora (M)
    #50#2 = min_ant;     || hasta minutos (M)
    #50#3 = #11#4;       || hasta hora (M)
    #50#4 = #11#5;       || hasta minutos (M)
    #50#5 = hor_ant;     || desde hora (C)
    #50#6 = min_ant;     || hasta minutos (C)
    #50#7 = #11#4;       || hasta hora (C)
    #50#8 = #11#5;       || hasta minutos (C)
    #50#9 = 0;           || minutos ajustados
    #50#10 = 0;          || fraccion horas
    #50#11 = 0;          || fraccion minutos
    #50#12 = 0;          || tiempo en minutos
    #50#13 = 0;          || tiempo en horas

     swentra2 = 0;
    hajus = #50#5;  majus = #50#6;
|HAZ ajustes;                      || ajusta el desde
    #50#9 = #50#9 - rajus;
    #50#5 = hajus;  #50#6 = majus;

     swentra2 = 1;
    hajus = #50#7;  majus = #50#8;
|HAZ ajustes;                      || ajusta el hasta
    #50#9 = #50#9 + rajus;
    #50#7 = hajus;  #50#8 = majus;

    nhor = #50#7 - #50#5;
    nmin = #50#8 - #50#6
|SI nmin < 0;    nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;

|HAZ descuentos;
    #50#15 = rajus;
    nmin = nmin + #50#15;
|SI nmin < 0;    nhor = nhor - 1;    nmin = 60 + nmin;   |FINSI;

|SI nmin < 0;  nmin = 0; |FINSI;
|SI nhor < 0;  nhor = 0; |FINSI;

    #50#10 = nhor;
    #50#11 = nmin;
    #50#12 = (nhor * 60) + nmin;
    #50#13 = nhor + (nmin / 60);
    #50#14= #11#2;       || linea

    shor = shor + #50#13;     || total por tarjeta
    dhor = dhor + #50#13;     || total por dia
    ghor = ghor + #50#13;     || total general
|FPRC;

|PROCESO rup_bar;
|DDEFECTO #20;   #20#0 = bar_ant;              |LEE 000#20=;     || tarjeta
|DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
|DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador

||    swlin = 1;
||    |PRINT;
||    swlin = 4;
||    |PRINT;
      nDeci = ((shor * 100) $ 100);
      nRedo = nDeci / 100;
      nRedo = shor - nRedo;
      nDeci = ((nDeci * 60) / 100 ) ! 0;
      nDeci = nDeci / 100;
      shor  = nDeci + nRedo
    swlin = 5;
    |PRINT;

    |DDEFECTO #60;
    num1 = 0;
    num2 = 0;
    shor = 0;
    sext = 0;
    bar_ant = #11#7;
    swentra = 0;
|FPRC;

|PROCESO rup_dia;
|| |SI swentra = 1;
||        error = "Tarjeta [" + bar_ant + "." + lin_ant + "] sin registro de salida. [" + hor_ant + ":" + min_ant + "]";
||        swlin = 4;
||        |PRINT;
|| |FINSI;

|HAZ h_extras;

|| |SI #0#12 = "S";
      nDeci = ((dhor * 100) $ 100);
      nRedo = nDeci / 100;
      nRedo = dhor - nRedo;
      nDeci = ((nDeci * 60) / 100 ) ! 0;
      nDeci = nDeci / 100;
      dhor  = nDeci + nRedo
      swlin = 4;
      |PRINT;
|| |FINSI;
    |DDEFECTO #60;
    num1 = 0;
    num2 = 0;
    dhor = 0;
    dia_ant = #11#3;
    swentra = 0;
|FPRC;

|PROCESO movimientos1;

     alfa1 = #11#3;
     alfa3 = ("00" + alfa1) % -102;
     alfa1 = #11#1;
     alfa2 = ("00" + alfa1) % -102;

     alfa1 = alfa2 + alfa3;

     |SI alfa1 < aDefe; |O alfa1 > aHafe; |ACABA; |FINSI;

|DDEFECTO #20; #20#0 = #11#7; |LEE 000#20=;
|SI #20#1 < #0#8; |O #20#1 > #0#9;      |ACABA;   |FINSI;   || empresas
|SI #20#2 < #0#10;|O #20#2 > #0#11;     |ACABA;   |FINSI;   || trabajadores

|SI sw_rup = 0;
        sw_rup = 1;
        bar_ant = #11#7;
        dia_ant = #11#3;
|DDEFECTO #20;   #20#0 = bar_ant;              |LEE 000#20=;     || tarjeta
|DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
|DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
        swlin = 1;
        |PRINT;
        #60#0 = #11#3;
|FINSI;

|SI bar_ant ! #11#7;
    |HAZ rup_dia;
    |HAZ rup_bar;
|DDEFECTO #20;   #20#0 = bar_ant;              |LEE 000#20=;     || tarjeta
|DDEFECTO #23;   #23#0 = #20#1;                |LEE 000#23=;     || empresa
|DDEFECTO #24;   #24#0 = #20#1; #24#1 = #20#2; |LEE 000#24=;     || trabajador
        swlin = 1;
        |PRINT;
    #60#0 = #11#3;
|SINO;
    |SI dia_ant ! #11#3;
        |HAZ rup_dia;
        #60#0 = #11#3;
    |FINSI;
|FINSI;

num1 = num2 + 1;
num2 = num1 + 1;
        |SI num1 [ 23;
             #60num1 = #11#4;
             #60num2 = #11#5;
        |FINSI;

|SI swentra = 1;
        swentra = 0;
    |HAZ detalle;

        swlin = 0;
||    |PRINT;
|SINO;
        swentra = 1;

        hor_ant = #11#4;
        min_ant = #11#5;
        lin_ant = #11#2;
|FINSI;

    emp_ant = #20#1;
    tra_ant = #20#2;
|FPRC;

|DEFBUCLE movimientos;
 #11#3;
 9;
 #0#4, nAnde, nMede,  1,  0,  0,  0, #0#13;
 #0#5, nAnha, nMeha, 31, 23, 59, 59, #0#14;
 ;
 NULL, movimientos1;
|FIN;

|PROCESO Control;
     |LEE 000#precontr.p;
     |SI FSalida ! 0;    || No existe control de la aplicacion, entonces
          swAjuste = 0;  || el Codigo de Ajuste de Salida es el de Entrada
     |SINO;              || esto para los que usaran el programa antes de
          |SI #precontr#1 = "S";   || meter el codigo de salida, cuando
               swAjuste = 0;       || solo habia de entrada 26.05.2004
          |SINO;
               swAjuste = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tipo3; |TIPO 3;
|IMPRE 0;
|SI FSalida = 0;
    |ABRET #12;
    |ABRE #20;
    |ABRE #21;
    |ABRE #23;
    |ABRE #24;
    |ABRE #25;
    |ABRE #60;
    |INFOR "preinsem";
    |HAZ desglo;
    |DDEFECTO #60;
    |HAZ Control;
    |BUCLE movimientos;
    |SI sw_rup ! 0;
        |HAZ rup_dia;
        |HAZ rup_bar;
        nDeci = ((ghor * 100) $ 100);
        nRedo = nDeci / 100;
        nRedo = ghor - nRedo;
        nDeci = ((nDeci * 60) / 100 ) ! 0;
        nDeci = nDeci / 100;
        ghor  = nDeci + nRedo
        |PIEINF;
    |SINO;
        |MENAV "    Seleccion vacia ...";
    |FINSI;
    |FININF;
    |CIERRAT #12;
    |CIERRA #20;
    |CIERRA #21;
    |CIERRA #23;
    |CIERRA #24;
    |CIERRA #25;
|SINO;
    |MENAV "    Proceso abortado ...";
|FINSI;
|FINIMP;
|FPRC;

|PROCESO mirasem; |TIPO 7;
    alfa1 = #0#0;
    alfa1 = "01.01." + alfa1;
    fech1 = alfa1;            || primero saca el dia de la semana
    fech2 = fech1 % 1;        ||/que fue el uno de enero
    alfa1 = fech2 % 11;

|SI alfa1 = "Lunes";     sdia=1; smas=0; |FINSI;
|SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
|SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
|SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
|SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
|SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
|SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

    alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
    fech1 = ~;                     ||/como fecha inicial de calculo
    alfa2 = fech1 % -104;
    alfa1 = alfa1 + ".01." + alfa2;
    fech1 = alfa1;
    nume1 = fech1;                 || calcula dias hasta primer lunes a¤o

    fech1 = ~;                     || calcula dias hasta fecha actual
    nume2 = fech1;

    sdife = nume2 - nume1;         || calcula la diferencia desde el primer
|SI sdife ] 0;
        srest = sdife $ 7;           || lunes hasta la fecha actual,la redondea,
        sdife = sdife + (7 - srest); || la divide por 7 y le suma 1 por la
        #0Campo = (sdife / 7) + smas;|| primera semana (en su caso !!!)
|SINO;
        #0Campo = 1;
|FINSI;

|PINTA #0Campo;
|HAZ deshas;
|FPRC;

|PROCESO deshas; |TIPO 0;   || calcula segun semana, desde dia hasta dia
    nume2 = #0#1 - smas;
    nume2 = (nume2 * 7) + (sdia - 1);   || dias hasta
    nume1 = nume2 - 6;                  || dias desde

    nume3 = #0#0;
    nume3 = nume3 - 1;
    alfa1 = "31.12." + nume3;    || saca los dias que hay hasta el 31.12
    fech1 = alfa1;
    nume3 = fech1;

    nume1 = nume1 + nume3;
    fech1 = nume1;         || fecha desde
    #0#6 = fech1;

    nume2 = nume2 + nume3;
    fech1 = nume2;         || fecha hasta
    #0#7 = fech1;

|PINTA #0#6;
|PINTA #0#7;
|FPRC;

|PROCESO desglo;
     || Proceso para desglosar las fechas desde hasta para la clave.

     alfa1 = #0#6 % -104;
     nAnde = alfa1;       ||A¤o Desde.
     alfa2 = #0#6 % 402;
     nMede = alfa2;       ||Mes Desde.
     alfa3 = #0#6 % 102;
     nDide = alfa3;       ||Dia Desde.

     aDefe = alfa2 + alfa3;

     alfa1 = #0#7 % -104;
     nAnha = alfa1;       ||A¤o Hasta.
     alfa2 = #0#7 % 402;
     nMeha = alfa2;       ||Mes Hasta.
     alfa3 = #0#7 % 102;
     nDiha = alfa3;       ||Dia Hasta.

     aHafe = alfa2 + alfa3;

|FPRC;
