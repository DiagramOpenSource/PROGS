|FICHEROS;
     agiz0010 #0;
     agim0017 #1,MANTE;
|FIN;

|VARIABLES;
   &VarImpre1    = "";
   &VarImpre2    = "";

   FechaSys      = @;
   PosiFecha     = 0;
   PosiFechaI    = 0;
   PosiFechaF    = 0;
   PonFecha      = 0;
   XPara         = 0;
   XPara1        = 0;
   XCoge         = 0;
   XCopias       = 0;
   Llave         = "";
   Caracter      = "";
   Variable      = "";
   Variable1     = "";
   Variable2     = "";
   Variable3     = "";
   FIfa          = "";
   FicheroFabre  = "";
   SwPrint       = 0;

   TeclaAntes1   = "";
   TeclaAntes2   = "";
   TeclaAntes3   = "";
   TeclaAntes4   = "";
   TeclaAntes5   = "";
   TeclaAntes6   = "";
   TeclaAntes7   = "";
   TeclaAntes8   = "";
   TeclaAntes9   = "";
   TeclaAntes10  = "";

   TeclaAhora1   = "";
   TeclaAhora2   = "";
   TeclaAhora3   = "";
   TeclaAhora4   = "";
   TeclaAhora5   = "";
   TeclaAhora6   = "";
   TeclaAhora7   = "";
   TeclaAhora8   = "";
   TeclaAhora9   = "";
   TeclaAhora10  = "";

   Pinta         = "";
   SwSalir       = 0;
   Directorio    = "";
   Origen        = "";
   Destino       = "";
   NombreFichero = "";
   NombreFich    = "";
   Nombre        = "";
   LineasAnte    = 0;
   TotalLinea    = 0;
   Baffer        = 0;
   BafferEdita   = 0;
   BafferLck     = 0;
   Opcion        = 0;
   Raiz          = "";
   Repetido      = 0;
   Bloqueo       = "";

   Vn1           = 0;
   Vn2           = 0;
   Vn3           = 0;
   Vn4           = 0;
   Vn5           = 0;
   Vn6           = 0;
   Vn7           = 0;
   Vn8           = 0;
   Vn9           = 0;
   Valfa1        = "";
   Valfa2        = "";
   Valfa3        = "";
   TotLin        = 0;
   Dire          = "";
   Cadena        = "";
   xxx           = 0;
   Lineas        = 0;
   Editor        = "";
   CogeOpcion    = 0;
   NFichero      = "";
   SwBorra       = 0;
   Contenido     = "";
   Handle        = "";
   Final         = "";
   Cadena1       = "";
   Cadena2       = "";
   Cadena3       = "";

   {-1} Menu     = "";
   Menu1         = "2400";
   Menu2         = "1";
   Menu3         = "Elija Opcion : ";
   Menu4         = "MBI";
   Menu5         = "   Modificacion   ";
   Menu6         = "   Baja   ";
   Menu7         = "   Impresion   ";
|FIN;

|PROGRAMA;
  TeclaAhora1  = "|:agicli/agiw0022";
  TeclaAhora2  = "@218&";
  TeclaAhora3  = "@217&";
  TeclaAhora4  = "@192&";
  TeclaAhora5  = "@191&";
  TeclaAhora6  = "@179&";
  TeclaAhora7  = "@196&";
  TeclaAhora8  = "@195&";
  TeclaAhora9  = "@197&";
  TeclaAhora10 = "@180&";

  |TECLA_FUNCION 10, 1, TeclaAntes1;
  |TECLA_FUNCION 11, 1, TeclaAntes2;
  |TECLA_FUNCION 12, 1, TeclaAntes3;
  |TECLA_FUNCION 13, 1, TeclaAntes4;
  |TECLA_FUNCION 14, 1, TeclaAntes5;
  |TECLA_FUNCION 15, 1, TeclaAntes6;
  |TECLA_FUNCION 16, 1, TeclaAntes7;
  |TECLA_FUNCION 17, 1, TeclaAntes8;
  |TECLA_FUNCION 18, 1, TeclaAntes9;
  |TECLA_FUNCION 19, 1, TeclaAntes10;

  |TECLA_FUNCION 10, 0, TeclaAhora1;
  |TECLA_FUNCION 11, 0, TeclaAhora2;
  |TECLA_FUNCION 12, 0, TeclaAhora3;
  |TECLA_FUNCION 13, 0, TeclaAhora4;
  |TECLA_FUNCION 14, 0, TeclaAhora5;
  |TECLA_FUNCION 15, 0, TeclaAhora6;
  |TECLA_FUNCION 16, 0, TeclaAhora7;
  |TECLA_FUNCION 17, 0, TeclaAhora8;
  |TECLA_FUNCION 18, 0, TeclaAhora9;
  |TECLA_FUNCION 19, 0, TeclaAhora10;

  |CLS;
  |CABEZA "Comunicados Libres";

  Directorio = "";
  |DBASE Directorio;

  Directorio = Directorio + "textos";
  |MKDIR Directorio;
  Directorio = Directorio + "/";

  |PARA; |SI SwSalir = 0; |HACIENDO;
         |PINPA #0#0;
         |HAZ GrabaFichero;
         |HAZ Tipo3;
         |FBORRA NombreFichero;
  |SIGUE;

  |TECLA_FUNCION 10, 0, TeclaAntes1;
  |TECLA_FUNCION 11, 0, TeclaAntes2;
  |TECLA_FUNCION 12, 0, TeclaAntes3;
  |TECLA_FUNCION 13, 0, TeclaAntes4;
  |TECLA_FUNCION 14, 0, TeclaAntes5;
  |TECLA_FUNCION 15, 0, TeclaAntes6;
  |TECLA_FUNCION 16, 0, TeclaAntes7;
  |TECLA_FUNCION 17, 0, TeclaAntes8;
  |TECLA_FUNCION 18, 0, TeclaAntes9;
  |TECLA_FUNCION 19, 0, TeclaAntes10;
|FPRO;

|PROCESO GrabaFichero;
  NombreFichero = "";
  NombreFichero = Usuario % 810; |QBF NombreFichero;
  NombreFichero = (NombreFichero + "zzzzzzzz") % 108;
  NombreFichero = Directorio + NombreFichero + ".men"
  NombreFich    = "wt  " + NombreFichero;
  Origen        = Directorio + "*";
  Contenido     = "";
  Final         = "";
  Handle        = "";
  Pos           = -1;

  |FABRE NombreFich;
  Handle = FSalida;

  |ABRE #1;
  |_PDIR Origen;
  |PARA; |SI; |HACIENDO;
       Destino = Origen - ".txt";
       |SI Destino ! Origen;
           Destino = Origen  - Directorio - ".txt";

           #1#0 = Destino;
           |LEE 040#1=;
           |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;

           Destino = (("        " + Destino) % -108) + ".txt";

           Cadena1 = Destino;
           Cadena2 = #1#1;  |QBF  Cadena2;
           Cadena2 = (Cadena2 + ("-" * 40)) % 140;
           Cadena3 = #1#2;  |QBF Cadena3;
           Cadena3 = (Cadena3 + ("-" * 8)) % 108;

           Contenido = Handle + " " + Cadena1 + " " + Cadena2 + " " + Cadena3 + Final;
           |FGRABA Contenido;
       |FINSI;

       |_SDIR Origen;
       |SI FSalida ! 0; |SAL; |FINSI;
  |SIGUE;

  Destino = "Abrir Documento Nuevo";
  Contenido = Handle + " " + Destino + Final;
  |FGRABA Contenido;

  FSalida = Handle;
  |FCIERRA FSalida;

  |CIERRA #1;
|FPRC;

|PROCESO Tipo3;
  Opcion     = 1;
  Baffer     = 0;
  TotalLinea = 0;
  |LEESECUENCIAL NombreFichero, Baffer, TotalLinea, 0, 0;
  SwSalir = 0;
  |PARA; |SI;  |HACIENDO;
         Opcion = CogeOpcion + 1;
         |BMENUG Baffer, 0, 1, TotalLinea, 1000, Opcion;
         Opcion     = FSalida;
         CogeOpcion = Opcion - 1;
         |SI FSalida [ TotalLinea; |Y FSalida ] 1;
             |DEL_BUF Baffer, CogeOpcion, Destino;
             |SI TotalLinea ! Opcion;
                 |PUSHV 0501 2580;
                 SwBorra = 0;
                 |HAZ ModiBaja;
                 |SI Menu2 = 1; |HAZ Edita; |FINSI;
                 |POPV;
                 |SI SwBorra = 1; |SAL; |FINSI;
             |SINO;
                 |HAZ Nuevo;
                 |SI Repetido = 0; |SAL; |FINSI;
             |FINSI;
         |SINO;
             SwSalir = 1;
             |SAL;
         |FINSI;
  |SIGUE;
  |FINDIM Baffer;
|FPRC;

|PROCESO Nuevo;
  Pos = -1;
  |PUSHV 0501 2580;

  |ABRE #1;
  |DDEFECTO #1;

  |ET OtraVez;
      |PINPA #0#1;
      |ENCAMPO #0#1;
      |SI #1#0 = "        ";  Repetido = 1;  |CIERRA #1; |ACABA;  |FINSI;
      |LIBERA #1;
      |LEE 140#1=;
      |SI FSalida = 0;
          |MENAV "      El Documento ya existe";
          |VETE OtraVez;
      |SINO;
          |ENDATOS #1#1;
          |SI FSalida ! 0;  |VETE OtraVez;  |FINSI;
          |GRABA 140#1n;
      |FINSI;

  |POPV;
  |CIERRA #1;

  NFichero = #1#0;
  Repetido = 0;
  |QBF NFichero;

  Valfa1   = NFichero + ".txt";
  |PARA xxx = 0; |SI xxx [ TotalLinea; |HACIENDO xxx = xxx + 1;
        |DEL_BUF Baffer, xxx, Destino;
        |SI Destino = Valfa1; Repetido = 1; |FINSI;
  |SIGUE;

  |SI Repetido = 1;  |ACABA; |FINSI;

  Destino = Valfa1;
  |HAZ Edita;
|FPRC;

|PROCESO ModiBaja;
  |MENU Menu;
  Menu2 = FSalida;

  Cadena1 = Destino % 112;  |QBT Cadena1;
  Valfa1 = Directorio + Cadena1; |QBT Dire;

  |SI Menu2 = 2;
      |CONFI "2400NConfirma la Baja del Documento : ";
      |SI FSalida ! 0; |ACABA; |FINSI;
      |FBORRA Valfa1;
      SwBorra = 1;
      |ACABA;
  |FINSI;

  |SI Menu2 = 3;
      |HAZ Impresion;
      SwBorra = 1;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO Bloqueo;
  Valfa3 = Directorio + Cadena1;
  Valfa3 = Valfa3 - ".txt" + ".lck";

  Origen  = Directorio + "*";
  TotLin  = -1;
  |_PDIR Origen;
  |PARA; |SI; |HACIENDO;
       |_SDIR Origen;
       |SI FSalida ! 0; |SAL; |FINSI;
       |SI Origen = Valfa3; TotLin = 0; |FINSI;
  |SIGUE;

  |SI TotLin = 0;
      |MENAV "      EL FICHERO ESTA SIENDO USADO. ESPERE SU TURNO";
      |ACABA;
  |FINSI;

  Handle        = "";
  NombreFich    = "wt  " + Valfa3;
  Final         = "";
  Contenido     = "";
  Pos           = -1;

  |FABRE NombreFich;
  Handle = FSalida;

  Bloqueo   = "  ESTE FICHERO ESTA USANDOSE EN ESTOS MOMENTOS    ";
  Contenido = Handle + " " + Bloqueo + Final;  |FGRABA Contenido;

  Bloqueo = "  SI EL DOCUMENTO ESTA BLOQUEADO POR ALGUNA RAZON ";
  Contenido = Handle + " " + Bloqueo + Final;  |FGRABA Contenido;

  Bloqueo = "  SOLAMENTE DEBES BORRARME FISICAMENTE ....       ";
  Contenido = Handle + " " + Bloqueo + Final;  |FGRABA Contenido;

  FSalida = Handle;
  |FCIERRA FSalida;
|FPRC;

|PROCESO Edita;
  |HAZ Bloqueo;
  |SI TotLin = 0; |ACABA; |FINSI;

  Cadena1 = Destino % 112;  |QBT Cadena1;
  Valfa1 = Directorio + Cadena1; |QBT Dire;

  BafferEdita = 0;
  TotLin      = 0;
  Vn4         = 72;
  |LEESECUENCIAL Valfa1, BafferEdita, TotLin, 0, Vn4;
  |SI TotLin [ 0;
      |AL_BUF BafferEdita, 0, "";
      |AL_BUF BafferEdita, 1, "";
      |GRABASECUENCIAL Valfa1, BafferEdita, 0, 1;
      |LEESECUENCIAL Valfa1, BafferEdita, TotLin, 0, Vn4;
  |FINSI;

  TotLin = TotLin + 72;

  Valfa2 = "EDICION DEL TEXTO : " + Valfa1;
  Vn2    = 0;
  Vn4    = 0701;
  Vn5    = 2380;
  Vn6    = 0;
  Vn7    = 132;
  Vn8    = 0;
  Vn9    = 0;
  Pinta  = "                         Control - F1 = Ayuda                         ";
  |ATRI I; |PINTA 2501, Pinta;
  |EDITA BafferEdita, Vn2, TotLin, Vn4, Vn5, Vn6, Valfa2, Vn7, Vn8, Vn9;
  |SI FSalida ! 0;
      |FINDIM BafferEdita;
      |FBORRA Valfa3;
      |ACABA;
  |FINSI;

  Lineas = 0;
  |PARA xxx = 0; |SI xxx [ TotLin; |HACIENDO xxx = xxx + 1;
        |DEL_BUF BafferEdita, xxx, Cadena;
        |QBF Cadena;
        |SI Cadena ! ""; Lineas = xxx; |FINSI;
  |SIGUE;

  |SI Lineas ! 0;
      TotLin = Lineas + 1;
      |GRABASECUENCIAL Valfa1, BafferEdita, 0, TotLin;
  |SINO;
      |FBORRA Valfa1;
  |FINSI;

  |FBORRA Valfa3;
  |FINDIM BafferEdita;
|FPRC;

|PROCESO Impresion;
  |PUSHV 0501 2380;

  |D_CUADRO 1623, 1955;
  |PINTA 1724, " Numero de Copias :            ";
  |PINTA 1824, " Fecha Comunicado :            ";

  XCopias  = 1;
  E_inf    = 1;
  E_sup    = 999;
  XCopias  = 1744 ? 1;

  FechaSys = ~;
  FechaSys = 1844 ? 1;
  |CONFI "2400SConforme con lo seleccionado : ";
  |SI FSalida ! 0; |POPV; |ACABA; |FINSI;

  |POPV;

  |IMPRE 0;
  |SI FSalida ! 0; |ACABA; |FINSI;

  |INFOR "agiz0010";
  |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

  |PARA XPara1 = 1; |SI XPara1 [ XCopias; |HACIENDO XPara1 = XPara1 + 1;
        FicheroFabre  = "rt  " + Valfa1;
        Pos           = -1;
        |FABRE FicheroFabre;
        |SI FSalida < 0; |FININF; |ACABA; |FINSI;

        FIfa    = FSalida;
        SwPrint = 0;
        |PARA; |SI; |HACIENDO;
               Variable = FIfa + " 250";
               |FLEE Variable;
               |SI FSalida < 0; |SAL; |FINSI;

               |HAZ BuscaFecha;

               VarImpre1 = "";
               VarImpre2 = "";
               Variable  = (Variable + (" " * 80)) % 180;
               VarImpre1 = Variable % 140;
               VarImpre2 = Variable % -140;

               SwPrint = 1;
               |PRINT;
        |SIGUE;

        FSalida = Variable;
        |FCIERRA FSalida;

        |PIEINF;
  |SIGUE;

  |FININF;
  |FINIMP;
|FPRC;

|PROCESO BuscaFecha;
|ET Arriba;

  PonFecha  = 0;
  Llave     = "";
  Caracter  = "";
  PosiFecha = 0;
  |PARA XPara = 1; |SI XPara [ 80; |HACIENDO XPara = XPara + 1;
        XCoge = (XPara * 100) + 1;
        Caracter  = Variable % XCoge;
        |SI Caracter = "{";
            Llave     = Llave + Caracter;
            PosiFecha = XPara;
        |SINO;
            Llave = Llave + Caracter;
            |SI Llave = "{{F";
                PonFecha = 1;
                |SAL;
            |SINO;
                Llave     = "";
                PosiFecha = 0;
            |FINSI;
        |FINSI;
  |SIGUE;

  |SI PonFecha = 1;
      PosiFechaI = 100 + (PosiFecha - 2);
      PosiFechaF = ((PosiFecha + 4) * 100) + 80;
      Variable1  = Variable % PosiFechaI;
      Variable2  = FechaSys;
      Variable3  = Variable % PosiFechaF;
      Variable   = Variable1 + Variable2 + Variable3;
      |VETE Arriba;
  |FINSI;
|FPRC;
