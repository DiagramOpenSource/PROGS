|FICHEROS;
     nombotra;
     nomboni3;
     labtraba;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nModo = 0;
     nPos1 = 0;
     nPos2 = 0;
     fFecha = @;
     nFecha = 0;
     nMeses = 0;
     &nBonif = 0;
     nRegimen = 0;
     aClave = "";
     nEmp = 0;
     nTra = 0;
     nBon = 0;
     nNume = 0;
     swHay111 = 0;
     fFechaIni = @;
     fFechaFin = @;
     fFechaAnt = @;
     fFechaAlta = @;

     &enEmp = 0;
     &enTra = 0;
     &enNom = "";
     &eaNIF = "";
     &eaAlta = "";
     &eaBaja = "";
     &eaContrato = "";
     &enOpcion = 0;
     &nMedia90 = 0;
     &nAltaFechaRef = 0;
     &enParada = 0;
     swSigue = 0;
|FIN;

|PROCESO infBo;
     |SI aAlfa = "labtraba"; |O aAlfa1 = "labcon";
          |SI #labtraba#121 = "S";
               #nomboni3#0 = 101;
          |FINSI;
          |SI #labtraba#121 = "T";
               #nomboni3#0 = 302;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO supBo;
     |SI aAlfa = "labtraba"; |O aAlfa1 = "labcon";
          |SI #labtraba#121 = "S";
               #nomboni3#0 = 299;
          |FINSI;
          |SI #labtraba#121 = "T";
               #nomboni3#0 = 999;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo66; |TIPO 66;
     |MODULO aAlfa;
     |QBF aAlfa;
     nBonif = 0;

     nModo = 4 + 8 + 16 + 32;
     nPos1 = 0832;
     nPos2 = 1880;

     |ABRE #nomboni3;
     |CONSULTA_F_CLAVE #1#nomboni3, infBo, supBo;
     |SI FSalida = 0;
          nBonif = #nomboni3#0;
     |FINSI;
     |CIERRA #nomboni3;

     |SI nBonif ! 0;
          #nombotra#2 = nBonif;
          |PINTA #nombotra#2
     |SINO;
          |ERROR;
     |FINSI;

     |SI FSalida = 1;
          nBonif = -1;
     |FINSI;
|FPRC;

|PROCESO Tipo12B; |TIPO 12;

|FPRC;

|PROCESO CambiaFechaFin;
     nModo = (FEntrada / 100) ! 0;
     |SI #nombotra#Campo# ! Contenido; |O nModo = 1;
          |ABRE #nomboni3;
          #nomboni3#0 = #nombotra#2;
          |LEE 000#nomboni3.=;

          |SI #nomboni3#3 = 999;
               #nombotra#5 = "31.12.9999";
          |SINO;
               nMeses = #nomboni3#3 / 1000;
               fFecha = #nombotra#4 + nMeses;
               nFecha = fFecha;
               nFecha = nFecha - 1;
               fFecha = nFecha;
               #nombotra#5 = fFecha;
          |FINSI;
          |CIERRA #nomboni3;

          |PINTA #nombotra#5;
     |FINSI;
|FPRC;

|PROCESO Defectos;
     nModo = (FEntrada / 100) ! 0;
     |SI nBonif = -1;
          ||ACABA;
     |FINSI;
     |ABRE #nomboni3;
     #nomboni3#0 = #nombotra#2;
     |LEE 000#nomboni3.=;
     |SI FSalida = 0;
          #nombotra#3 = #nomboni3#1;
          |SI nModo = 1;
               #nombotra#4 = #labtraba#36;
          |FINSI;
          nMeses = #nomboni3#3;

          fFecha = #nombotra#4;
          |HAZ CambiaFechaFin;

          #nombotra#6 = #nomboni3#2;
          |SI #nomboni3#4 = 9999;
               #nombotra#7 = #nomboni3#5;
          |SINO;
               #nombotra#7 = #nomboni3#2 / 12;
          |FINSI;
          |PINDA #0#nombotra;

          |MODULO aAlfa;
          |QBF aAlfa;
          aAlfa1 = aAlfa % 106;
          |SI aAlfa = "labtraba"; |O aAlfa1 = "labcon";
               nRegimen = #labtraba#247;
               aClave = #labtraba#42;
          |FINSI;

          |SI #nombotra#2 = 133; |O #nombotra#2 = 134;
               |SI nRegimen ! 613; |Y nRegimen ! 163;
                    aAlfa = "    La bonificación introducida sólo es compatible ";
                    aAlfa = aAlfa + "con el Régimen Agrario. Revise la selección.";
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
               |SI #nombotra#2 = 133; |Y aClave ! "A";
                    aAlfa = "    La bonificación introducida sólo es compatible ";
                    aAlfa = aAlfa + "con la clave A (Cot. General). Revise la selección.";
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
               |SI #nombotra#2 = 134; |Y aClave ! "E";
                    aAlfa = "    La bonificación introducida sólo es compatible ";
                    aAlfa = aAlfa + "con la clave E (Cot. Jornadas). Revise la selección.";
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
          |FINSI;
     |SINO;
          aAlfa = "    No existe el tipo de bonificación introducida. ";
          aAlfa = aAlfa + "Pulse F5 para consultar.";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;

     |CIERRA #nomboni3;
|FPRC;

|PROCESO ConsultaBo; |TIPO 11;
     |SI FSalida = 13;
          |HAZ Tipo66;
          |HAZ Permite;
          |HAZ Defectos;
     |FINSI;
|FPRC;


|PROCESO CuentaBon;
     nNume = nNume + 1;
     nBon = #nombotra#2;
     |SI nBon = 111;
          swHay111 = 1;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaBon;
     #nombotra#1;
     ;
     nEmp, nTra, 001;
     nEmp, nTra, 999;
     ;
     NULL, CuentaBon;
|FIN;

|PROCESO Permite; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O FEntrada = 1;
          nEmp = #nombotra#0;
          nTra = #nombotra#1;

          |SALVA_DATOS #nombotra;
          nNume = 0;
          swHay111 = 0;
          |BUCLE CuentaBon;
          |REPON_DATOS #nombotra;

          |SI nNume = 2;
               aAlfa = "    Sólo se permite aplicar dos bonificaciones ";
               aAlfa = aAlfa + "de fomento de empleo al mismo tiempo.";
               |MENAV aAlfa;

               #nombotra#0 = nEmp;
               #nombotra#1 = nTra;
               #nombotra#2 = nBon;
               |LEE 000#nombotra.=;
               |PTEC 808;

               ||ERROR;
          |FINSI;
          |SI nNume = 1;
/*
               |SI swHay111 = 0; |Y #nombotra#2 ! 111; |Y #nombotra#2 ! nBon;
                    aAlfa = "    La doble bonif. de fomento de empleo ";
                    aAlfa = aAlfa + "sólo es aplicable en caso de bonif. 111 junto con "
                    aAlfa = aAlfa + "otra compatible.";
                    |MENAV aAlfa;
                    aAlfa = "    Verifique que las bonificaciones introducidas ";
                    aAlfa = aAlfa + "son correctas";
                    |MENAV aAlfa;
               |FINSI;
*/
          |FINSI;
     |FINSI;
|FPRC;
/*
|PROCESO Permite; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O FEntrada = 1;
          nEmp = #nombotra#0;
          nTra = #nombotra#1;

          |SALVA_DATOS #nombotra;
          nNume = 0;
          |BUCLE CuentaBon;
          |REPON_DATOS #nombotra;

          |SI nNume = 2;
               #nombotra#0 = nEmp;
               #nombotra#1 = nTra;
               #nombotra#2 = nBon;
               |LEE 000#nombotra.=;
               |PTEC 808;
          |SINO;
               ||LEE 000#nombotra.a;
               ||PONCONTROL 23, "si";
          |FINSI;
     |FINSI;
|FPRC;
*/

|PROCESO PintaLinBo; |TIPO 7;
     |SI nBonif = -1; |O nBonif = 0;
          |ACABA;
     |FINSI;


     #nombotra#2 = nBonif;
     #nombotra#3 = #nomboni3#1;
     #nombotra#4 = #labtraba#36;
     fFecha = #labtraba#36;
     nMeses = #nomboni3#3;

     |HAZ CambiaFechaFin;

     #nombotra#6 = #nomboni3#2;
     |SI #nomboni3#4 = 9999;
          #nombotra#7 = #nomboni3#5;
     |SINO;
          #nombotra#7 = #nomboni3#2 / 12;
     |FINSI;

     |PINTA #nombotra#2;
     |PINTA #nombotra#3;
     |PINTA #nombotra#4;
     |PINTA #nombotra#5;
     |PINTA #nombotra#6;
     |PINTA #nombotra#7;

     nBonif = -1;
|FPRC;

|PROCESO Fechas;
     |MODULO aAlfa;
     |QBF aAlfa;
     aAlfa1 = aAlfa % 106;

     fFechaAnt = #labtraba#34;
     fFechaAlta = #labtraba#36;
     fFechaIni = #nomboni3#9;
     fFechaFin = #nomboni3#10;

     |SI fFechaIni ! "01.01.0000";
          |SI fFechaAnt < fFechaIni; |Y fFechaAlta < fFechaIni;
               aAlfa1 = fFechaIni;
               aAlfa = "    ATENCION: las fechas de alta y de antig. ";
               aAlfa = aAlfa + "son anteriores a la de inicio ";
               aAlfa = aAlfa + "de vigencia de la bonif: " + aAlfa1;
               |MENAV aAlfa;
               aAlfa = "    Compruebe que la bonificación se puede aplicar ";
               aAlfa = aAlfa + "para este trabajador";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |SI fFechaFin ! "01.01.0000";
          |SI fFechaAnt > fFechaFin; |Y fFechaAlta > fFechaFin;
               aAlfa1 = fFechaFin;
               aAlfa = "    ATENCION: las fechas de alta y de antig. ";
               aAlfa = aAlfa + "son posteriores a la de fin ";
               aAlfa = aAlfa + "de vigencia de la bonif: " + aAlfa1;
               |MENAV aAlfa;
               aAlfa = "    Compruebe que la bonificación se puede aplicar ";
               aAlfa = aAlfa + "para este trabajador";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FechasIni;
     fFechaIni = #nomboni3#9;
     fFechaFin = #nomboni3#10;

     |SI #nombotra#4 ! "01.01.0000"; |Y fFechaIni ! "01.01.0000";
          |SI #nombotra#4 < fFechaIni;
               aAlfa1 = fFechaIni;
               aAlfa = "    ATENCION: la fecha de inicio de la bonificación ";
               aAlfa = aAlfa + "es anterior a su fecha de inicio ";
               aAlfa = aAlfa + "de vigencia: " + aAlfa1;
               |MENAV aAlfa;
               aAlfa = "    Compruebe que la bonificación se puede aplicar ";
               aAlfa = aAlfa + "para este trabajador";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |SI #nombotra#4 ! "01.01.0000"; |Y fFechaFin ! "01.01.0000";
          |SI #nombotra#4 > fFechaFin;
               aAlfa1 = fFechaFin;
               aAlfa = "    ATENCION: la fecha de inicio de la bonificación ";
               aAlfa = aAlfa + "es posterior a su fecha de fin ";
               aAlfa = aAlfa + "de vigencia: " + aAlfa1;
               |MENAV aAlfa;
               aAlfa = "    Compruebe que la bonificación se puede aplicar ";
               aAlfa = aAlfa + "para este trabajador";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CalcMediaBon;
     |SI FSalida = 18;
          enParada = 1;
          |HAZ MediaBon;
     |FINSI;
|FPRC;

|PROCESO MediaBon;
     swSigue = 0;
     |SI enParada = 1;
          swSigue = 1;
     |SINO;
/*
          |SI nAltaFechaRef > 0; |O nMedia90 > 0;
               swSigue = 0;
          |SINO;
               swSigue = 1;
          |FINSI;
*/
          swSigue = 1;
     |FINSI;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     nNume = #nombotra#0;
     aAlfa = nNume; |QBF aAlfa; aAlfa = ("00000" + aAlfa) % -105;
     aAlfa1 = aAlfa;

     aAlfa = #labtraba#36;
     aAlfa1 = aAlfa1 + aAlfa;
     aAlfa1 = "nomcalme;" + aAlfa1;

     enEmp = #labtraba#0;
     enTra = #labtraba#1;
     enNom = #labtraba#2;
     eaNIF = #labtraba#7;
     eaAlta = #labtraba#36;
     eaBaja = #labtraba#37;
     eaContrato = #labtraba#45;
     enOpcion = 1;
     |SUB_EJECUTA aAlfa1;
|FPRC;

|PROCESO Media;
     |SI #nomboni3#0 ] 151; |Y #nomboni3#0 [ 158;
          |SI #labtraba#36 = "          "; |O #labtraba#36 = "..........";
               aAlfa = "    Es necesario informar la fecha de alta para comprobar ";
               aAlfa = aAlfa + "si esta bonificación se puede aplicar";
               |MENAV aAlfa;
          |SINO;
               |ACABA;

               || a partir de 2012 ya no dice nada en ningun sitio de que haya
               || que comprobar que el numero de trabajadores sea superior a
               || la media de los ultimos 90 dias, no lo hacemos

               enParada = 0;
               |HAZ MediaBon;

               |SI nAltaFechaRef > nMedia90;

               |SINO;
                    |AVISO;
                    aAlfa1 = nAltaFechaRef;
                    aAlfa1 = ("    " + aAlfa1) % -104;
                    nMedia90 = nMedia90 ! 2;
                    aAlfa2 = nMedia90;
                    aAlfa2 = ("       " + aAlfa2) % -107;

                    |PUSHV 13332279;
                   ||        3      4         5         6         7
                   ||        34567890123456789012345678901234567890123456789
                    |ATRI R;
                    aAlfa = "ATENCION: el número de trabajadores  fijos  in-";
                    |PINTA 1333, aAlfa;
                    aAlfa = "cluyendo este  contrato es de " + aAlfa1 + ". La media de";
                    |PINTA 1433, aAlfa;
                    aAlfa = "los últimos 90 días es de " + aAlfa2 + " por lo que la";
                    |PINTA 1533, aAlfa;
                    aAlfa = "bonificación no  se debería  aplicar. Pulse F10";
                    |PINTA 1633, aAlfa;
                    aAlfa = "si desea consultar  los cálculos  realizados  y"
                    |PINTA 1733, aAlfa;
                    aAlfa = "confirme si desea aplicarla.                   ";
                    |PINTA 1833, aAlfa;
                    |ATRI 0;
                    |PAUSA;
                    |HAZ CalcMediaBon;
                    |POPV;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;
