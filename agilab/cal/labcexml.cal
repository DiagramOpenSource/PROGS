|FICHEROS;
     labcerti;
     labcerag;
     labcerpu;      || fichero puente para cargar las etiquetas del XML
     labempre;
     labtraba;
     labcentr;
     labhisce;
     labcontr;
     labcer06;

     xmlcerca;
     xmlcerli;
     xmlarbol #100;

     gomccchi;
     nomcenes;
|FIN;

|VARIABLES;
     &aRegimen = "";
     aAlfa = "";
     &aCadena = "";
     &eaNom = "";
     &eaApel1 = "";
     &eaApel2 = "";
     nNume = 0;
     fFechaAlta = @;
     fFechaBaja = @;
     nFechaAlta = 0;
     nFechaBaja = 0;

     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aAlfa5 = "";
     aNivel = "";
     aNivel5 = "";
     i = 0;
     j = 0;
     k = 0;
     nNivel = 0;
     nNivel1 = 0;
     nNivel2 = 0;
     aNivel2 = "";
     nCorta = 0;
     nCorta1 = 0;
     nCorta2 = 0;
     aParte1 = "";
     aParte2 = "";
     swACero = 0;
     nElemento = 0;
     nContador = 0;
     swHayHijos = 0;
     aEntidad = "";
     nCanal = 0;

     aValor = "";
     nCampo = 0;

     aEtiqueta = "";
     aEtiqueta1 = "";
     aEtiqueta2 = "";
     aLinea = "";
     &eaFichero = "";
     &aPath = "";
     nNume1 = 0;
     nNume2 = 0;
     nPara1 = 0;

     &enEmp = 0;
     &enTra = 0;

     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nCampo4 = 0;
     nCampoPu = 0;
     nCampoPu1 = 0;
     nCampoPu2 = 0;
     nCampoPu3 = 0;
     fFecha1 = @;
     fFecha2 = @;
     nFecha1 = 0;
     nFecha2 = 0;
     nDias = 0;

     &nAnyo1 = 0; &nAnyo2 = 0; &nAnyo3 = 0; &nAnyo4 = 0;
     &nAnyo5 = 0; &nAnyo6 = 0; &nAnyo7 = 0;

     &aMes1 = ""; &aMes2 = ""; &aMes3 = ""; &aMes4 = "";
     &aMes5 = ""; &aMes6 = ""; &aMes7 = "";

     &nDiasCot1 = 0; &nDiasCot2 = 0; &nDiasCot3 = 0; &nDiasCot4 = 0;
     &nDiasCot5 = 0; &nDiasCot6 = 0; &nDiasCot7 = 0;

     &nBaseCotCC1 = 0; &nBaseCotCC2 = 0; &nBaseCotCC3 = 0; &nBaseCotCC4 = 0;
     &nBaseCotCC5 = 0; &nBaseCotCC6 = 0; &nBaseCotCC7 = 0;

     &nBaseCotDes1 = 0; &nBaseCotDes2 = 0; &nBaseCotDes3 = 0; &nBaseCotDes4 = 0;
     &nBaseCotDes5 = 0; &nBaseCotDes6 = 0; &nBaseCotDes7 = 0;

     &nMes1 = 0; &nMes2 = 0; &nMes3 = 0; &nMes4 = 0;
     &nMes5 = 0; &nMes6 = 0; &nMes7 = 0;

     &nanyo = 0;

     aPunto = "";
     aTipoCot = "";
     nCampoDias = 0;
     nDesdeCampo = 0;
     nHastaCampo = 0;

     swLinea = 0;
     aEspacios = "";
     aArchivo = "";
     aHora = "";
     fFecha = @;
     &enSwHisto = 0;
     &enCanal = 0;
     aNombre = "";
     swEtiCCC = 0;
     &aAntCCC = "";
     swPrimerCCC = 0;
     aCCC = "";
     &swNetContrata = 0;

     aMensa = "";
     aEsc1 = "";
     aEsc2 = "";
     aTecla = "";

     &nArchi = 0;
     &eaOrig = "";
     &eaObservaciones = "";
     &enMes = 0;
     &enAny = 0;
     &eaVengoDe = "";
     &swSigue = 0;
     &enSwErrorRecDoc = 0;
     &enSwDesde9 = 0;
     &enSwMeteGrupoSubTipo = 0;
     aFichHuella = "";
     aFichCertif = "";
     aNif = "";
     aFichero = "";
     aFichero1 = "";
     aFechaAlta = "";
     nCampo5 = 0;
     nValor = 0;
     nAny = 0;
     nMes = 0;
     nCampito = 0;
     aRutaBAT = "";
     nHandleBAT = 0;
     aUnidad = "";
     aResto = "";
     {1}aContiene = "";
     aRuta = "";

     &eaCadena = "";
     &eaCadenaSal = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";
|FIN;

/*
|| no hace falta, el separador de nombre lo divide correctamente

|PROCESO CompNombre;
     aNombre = #labtraba#2;
     |QBF aNombre;
     aAlfa = aNombre - " ";
     |SI aAlfa ! aNombre;
          aNombre = aAlfa;
          aAlfa = aNombre - " ";
          |SI aAlfa = aNombre;     || extranjero, se supone: nombre + apellido
               |ACABA;
          |FINSI;
     |FINSI;

     aAlfa = aNombre - ",";
     |SI aAlfa = aNombre;     || no extranjero, sin coma, aviso
          aAlfa = "    ATENCION: el nombre no sigue el formato estándar: ";
          aAlfa = aAlfa + "Apellido1 Apellido2, Nombre";
          |MENAV aAlfa;

          aAlfa = "    Corríjalo para enviar los datos correctamente ";
          aAlfa = aAlfa + "en el fichero XML.";
          |MENAV aAlfa;
     |FINSI;
|FPRC;
*/

|PROCESO MensajeFinal;
     aAlfa = "    Se ha creado el fichero " + eaFichero;
     aAlfa = aAlfa + " en la carpeta " + aPath;
     |MENAV aAlfa;
|FPRC;

|PROCESO GrabaHis;
     |ABRE #labhisce;
     |DDEFECTO #labhisce;
     #labhisce#0 = aRegimen;
     #labhisce#1 = enEmp;
     #labhisce#2 = enTra;
     |LEE 101#labhisce.=;
     |SI FSalida = 0;
          fFecha = ~;
          |HORA aHora;
          aHora = aHora % 108;

          #labhisce#21 = eaFichero;
          #labhisce#22 = fFecha;
          #labhisce#23 = aHora;

          aAlfa = Usuario % 810;
          |QBF aAlfa;
          #labhisce#24 = aAlfa;

          #labhisce#25 = "S";

          |GRABA 020#labhisce.a;
     |FINSI;
     |CIERRA #labhisce;
|FPRC;

/******************* PROCESOS PARA GRABAR EL FICHERO XML ********************/

|PROCESO VerifEntCom;
     || este proceso es porque las entidades complejas que tienen dentro
     || entidades simples sin ningun valor no deben salir, compruebo lo
     || que haga falta en cada una y si no deben salir, que no salgan

     swLinea = 1;        || en principio siempre
     aAlfa = #xmlarbol#2;
     |QBF aAlfa;

     aAlfa1 = #xmlarbol#3;
     aNivel = aAlfa1 % 108;
     aNivel5 = aAlfa1 % 110;

     |SI aAlfa = "Cuenta_cotizacion";
          |SI swEtiCCC = 0;
               swLinea = 0;
          |FINSI;
          |SI #100#5 = 2;     || si cierro no hago la linea, lo controlo
               swLinea = 0;   || manual en esta etiqueta
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_Representante";
          aAlfa = #labcerpu#0; |QBF aAlfa;
          |SI aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_Empresa";
          aAlfa = #labcerpu#6; |QBF aAlfa;
          |SI aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "DistribucionJornadas";
          |SI #labcerpu#30 = " "; |Y #labcerpu#34 = " ";
          |Y #labcerpu#38 = " "; |Y #labcerpu#42 = " ";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Periodo";
          |SI aNivel5 = "0101032401"; |Y #labcerpu#30 = " ";
               swLinea = 0;
          |FINSI;
          |SI aNivel5 = "0101032402"; |Y #labcerpu#34 = " ";
               swLinea = 0;
          |FINSI;
          |SI aNivel5 = "0101032403"; |Y #labcerpu#38 = " ";
               swLinea = 0;
          |FINSI;
          |SI aNivel5 = "0101032404"; |Y #labcerpu#42 = " ";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_Cotizacion";
          |SI aRegimen = "A"
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#46; |QBF aAlfa;
          |SI aNivel = "01010328"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#52; |QBF aAlfa;
          |SI aNivel = "01010329"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#58; |QBF aAlfa;
          |SI aNivel = "01010330"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#64; |QBF aAlfa;
          |SI aNivel = "01010331"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#70; |QBF aAlfa;
          |SI aNivel = "01010332"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#76; |QBF aAlfa;
          |SI aNivel = "01010333"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#82; |QBF aAlfa;
          |SI aNivel = "01010334"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_Cotizacion_REA";
          |SI aRegimen = "G";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#88; |QBF aAlfa;
          |SI aNivel = "01010335"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#94; |QBF aAlfa;
          |SI aNivel = "01010336"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#100; |QBF aAlfa;
          |SI aNivel = "01010337"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#106; |QBF aAlfa;
          |SI aNivel = "01010338"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#112; |QBF aAlfa;
          |SI aNivel = "01010339"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#118; |QBF aAlfa;
          |SI aNivel = "01010340"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#124; |QBF aAlfa;
          |SI aNivel = "01010341"; |Y aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_VacacionesCotizadas";
          |SI aRegimen = "A";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#130;
          |QBF aAlfa;
          |SI aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;

     |SI aAlfa = "Datos_VacacionesCotizadas_REA";
          |SI aRegimen = "G";
               swLinea = 0;
          |FINSI;
          aAlfa = #labcerpu#134;
          |QBF aAlfa;
          |SI aAlfa = "";
               swLinea = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ImprimeLinea;
     aEtiqueta = #xmlarbol#2;
     |QBF aEtiqueta;
     aEtiqueta1 = "";
     aEtiqueta2 = "";
     aValor = "";
     |SI #100#1 = 1;     || el nivel uno se imprime en la cabecera
          |ACABA;        || para que solo se imprima una vez
     |FINSI;

     aEspacios = "";
     |SI #100#1 = 2;
          aEspacios = "  ";
     |FINSI;
     |SI #100#1 = 3;
          aEspacios = "  " + "  ";
     |FINSI;
     |SI #100#1 = 4;
          aEspacios = "  " + "  " + "  ";
     |FINSI;
     |SI #100#1 = 5;
          aEspacios = "  " + "  " + "  " + "  ";
     |FINSI;
     |SI #100#1 = 6;
          aEspacios = "  " + "  " + "  " + "  " + "  ";
     |FINSI;

     |SI #100#5 = 0;                              || abro entidad compleja
          aEtiqueta1 = "<" + aEtiqueta + ">";
     |FINSI;
     |SI #100#5 = 1;                              || entidad simple (
          aEtiqueta1 = "<" + aEtiqueta + ">";
          aEtiqueta2 = "</" + aEtiqueta + ">";
     |FINSI;
     |SI #100#5 = 2;                              || cierro entidad compleja
          aEtiqueta2 = "</" + aEtiqueta + ">";
     |FINSI;

     aValor = #xmlarbol#4;
     |QBF aValor;
     swLinea = 0;             || para saber si creo o no la linea

     |SI #100#5 = 1;          || entidad simple, siempre que haya algo
          |SI aValor ! "";
               swLinea = 1;
          |FINSI;
     |SINO;                   || si abre o cierra entidad compleja
          |HAZ VerifEntCom;
     |FINSI;

     |SI aEtiqueta = "Cuenta_cotizacion";
          |SI swLinea = 1;
               |SI swPrimerCCC ! 1;
                   || primero cierro la anterior
                    aEtiqueta1 = "";
                    aEtiqueta2 = "</" + aEtiqueta + ">";
                    aLinea = aEspacios + aEtiqueta1 + aValor + aEtiqueta2 + &13 + &10;
                    |XGRABA nCanal, aLinea;
               |FINSI;

               || y ahora abro la nueva
               aEtiqueta1 = "<" + aEtiqueta + ">";
               aEtiqueta2 = "";
               aLinea = aEspacios + aEtiqueta1 + aValor + aEtiqueta2 + &13 + &10;
               |XGRABA nCanal, aLinea;
          |FINSI;
     |SINO;
          |SI swLinea = 1;
               aLinea = aEspacios + aEtiqueta1 + aValor + aEtiqueta2 + &13 + &10;
               |XGRABA nCanal, aLinea;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LineasXML;
     #xmlarbol#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ImprimeLinea;
|FIN;

|PROCESO Cabecera;
     aArchivo = eaFichero;
     aAlfa = aArchivo % -104;
     |SI aAlfa ! ".xml";
          aArchivo = aArchivo + ".xml";
     |FINSI;
     aArchivo = aPath + aArchivo;
     |XABRE "CBW", aArchivo, nCanal;

     aLinea = "<?xml version=" + &34 + "1.0" + &34 + " encoding=";
     aLinea = aLinea + &34 + "ISO-8859-1" + &34 + " ?>" + &13 + &10;
     |XGRABA nCanal, aLinea;
     aLinea = "<Certificado_empresa xmlns:xsi=" + &34;
     aLinea = aLinea + "http://www.w3.org/2001/XMLSchema-instance" + &34;
     aLinea = aLinea + ">" + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|PROCESO Pie;
     aLinea = "  </Cuenta_cotizacion>" + &13 + &10;
     |XGRABA nCanal, aLinea;

     aLinea = "</Certificado_empresa>" + &13 + &10;
     |XGRABA nCanal, aLinea;

     |XCIERRA nCanal;
|FPRC;

|PROCESO CreaFichero;
     |SI enSwHisto = 0;
          |HAZ Cabecera;
     |FINSI;

     |BUCLE LineasXML;

     |SI enSwHisto = 0;
          |HAZ Pie;
     |FINSI;
|FPRC;

|PROCESO CreaDirectorio;
     aPath = #labcontr#51;
     |QBF aPath;
     |SI aPath = "";
          aPath = "C:\tmp\xmlcert";
          aAlfa = "    ATENCION. No está definida la ruta para almacenar los fichero xml ";
          aAlfa = aAlfa + "en el Control de la Aplicación.";
          |MENAV aAlfa;
          aAlfa = "    Se usará por defecto la carpeta C:\tmp";
          |MENAV aAlfa;
     |SINO;
          aAlfa = aPath % -101;
          |SI aAlfa ! "/"; |Y aAlfa ! "\";
               aPath = aPath + "\";
          |FINSI;
          |SI swNetContrata = 1;
               aPath = aPath + "NETCONTRATA\CERTIFICADOS\";
          |SINO;
               aPath = aPath + "xmlcert\";
          |FINSI;
     |FINSI;

     aAlfa1 = aPath % 0;  nNume1 = aAlfa1;
     aAlfa2 = "";
     |PARA nPara1 = 1; |SI nPara1 [ nNume1; |HACIENDO nPara1 = nPara1 + 1;
          nNume2 = (nPara1 * 100) + 1;
          aAlfa1 = aPath % nNume2;
          |SI aAlfa1 = "/"; |O aAlfa1 = "\";
               |SI aAlfa2 ! "";
                    |RMKDIR aAlfa2;
               |FINSI;
          |FINSI;
          aAlfa2 = aAlfa2 + aAlfa1;
     |SIGUE;
     |SI aAlfa2 ! "";
          |RMKDIR aAlfa2;
     |FINSI;

     aRuta = aPath; |HAZ CompRuta; aPath = aRuta;
     aRutaBAT = aPath + "ejecuta.bat";
|FPRC;

/***************** FIN PROCESOS PARA GRABAR EL FICHERO XML ******************/

/****************** PROCESOS PARA CARGAR VALORES EN ARBOL *******************/

|PROCESO Valor;
     aAlfa1 = #xmlarbol#3;
     aNivel = aAlfa1 % 108;
     aNivel5 = aAlfa1 % 110;

     || cambio de valor para entidad Periodo

     |SI aNivel5 = "0101032401"; nCampo = nCampo + 0; |FINSI;
     |SI aNivel5 = "0101032402"; nCampo = nCampo + 4; |FINSI;
     |SI aNivel5 = "0101032403"; nCampo = nCampo + 8; |FINSI;
     |SI aNivel5 = "0101032404"; nCampo = nCampo + 12; |FINSI;

     || cambio de valor para entidad Datos_Cotizacion

     |SI aNivel = "01010328"; nCampo = nCampo + 0; |FINSI;
     |SI aNivel = "01010329"; nCampo = nCampo + 6; |FINSI;
     |SI aNivel = "01010330"; nCampo = nCampo + 12; |FINSI;
     |SI aNivel = "01010331"; nCampo = nCampo + 18; |FINSI;
     |SI aNivel = "01010332"; nCampo = nCampo + 24; |FINSI;
     |SI aNivel = "01010333"; nCampo = nCampo + 30; |FINSI;
     |SI aNivel = "01010334"; nCampo = nCampo + 36; |FINSI;

     || cambio de valor para entidad DatosCotizacion_REA

     aAlfa2 = aNivel5 % -102;

     |SI aNivel = "01010335";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 0;
          |SINO;
               nCampo = nCampo + 0;
          |FINSI;
     |FINSI;

     |SI aNivel = "01010336";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 6;
          |SINO;
               nCampo = nCampo + 1;
          |FINSI;
     |FINSI;
     |SI aNivel = "01010337";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 12;
          |SINO;
               nCampo = nCampo + 2;
          |FINSI;
     |FINSI;
     |SI aNivel = "01010338";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 18;
          |SINO;
               nCampo = nCampo + 3;
          |FINSI;
     |FINSI;
     |SI aNivel = "01010339";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 24;
          |SINO;
               nCampo = nCampo + 4;
          |FINSI;
     |FINSI;
     |SI aNivel = "01010340";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 30;
          |SINO;
               nCampo = nCampo + 5;
          |FINSI;
     |FINSI;
     |SI aNivel = "01010341";
          |SI aAlfa2 ! "07";
               nCampo = nCampo + 36;
          |SINO;
               nCampo = nCampo + 6;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LineasArbol;
     nCampo = #xmlarbol#6;

     |HAZ Valor;

     aValor = #labcerpu#nCampo#;
     |QBF aValor;
     |SI aValor ! "";
          aCadena = aValor; |HAZ QuitaRaros; aValor = aCadena;
          ||OEM_ANSI aValor, aAlfa;    || no consigo que me funcione
          #xmlarbol#4 = aValor;
          |GRABA 020#xmlarbol.a;
     |FINSI;
|FPRC;

|DEFBUCLE LineasArbol;
     #xmlarbol#1;
     5;
     001, 1;
     999, 1;
     be;
     NULL, LineasArbol;
|FIN;

/**************** FIN PROCESOS PARA CARGAR VALORES EN ARBOL *****************/

/****************** PROCESOS PARA CREACION DEL ARBOL XML ********************/

|PROCESO QuitaCeros;
     |PARA i = 1; |SI i [ 21; |HACIENDO i = i + 1;
          aAlfa = aNivel % -101;
          |SI aAlfa = "0";
               k = 20 - i;
               k = k + 100;
               aNivel = aNivel % k;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     |SI nNivel2 = 10; |O nNivel2 = 20; |O nNivel2 = 30; |O nNivel2 = 40;
      |O nNivel2 = 50; |O nNivel2 = 60; |O nNivel2 = 70; |O nNivel2 = 80;
      |O nNivel2 = 90;
          aNivel = aNivel + "0";
     |FINSI;
|FPRC;

|PROCESO Construye2;
     aNivel = aNivel + "00000000000000000000";
     aNivel = aNivel % 120;
     nCorta = nNivel * 2;
     nCorta1 = nCorta - 2;
     nCorta1 = 100 + nCorta1;
     aParte1 = aNivel % nCorta1;
     nCorta2 = 20 - nCorta;
     nCorta2 = -1 * (100 + nCorta2);
     aParte2 = aNivel % nCorta2;

     nCorta = 100 + nCorta;
     aNivel2 = aNivel % nCorta;
     aNivel2 = aNivel2 % -102;
     nNivel2 = aNivel2;
     nNivel2 = nNivel2 + 1;
     || aNivel2 = nNivel2;
     aNivel2 = #xmlcerli#1;
     aNivel2 = "00" + aNivel2;
     aNivel2 = aNivel2 % -102;
     nNivel2 = aNivel2;

     aNivel = aParte1 + aNivel2 + aParte2;
     |SI swACero = 1;
          aNivel = aNivel - aParte2;
          aNivel = aNivel + "0000000000000000000";
          aNivel = aNivel % 120;
     |FINSI;
     |HAZ QuitaCeros;
|FPRC;

|PROCESO ConstruyeNivel;
     |SI nElemento [ 1;
          nNivel = nNivel + 1;
     |FINSI;
     nContador = nContador + 1;
|FPRC;

|PROCESO BuscaHijos;
     swHayHijos = 1;

     aEntidad = #xmlcerli#2;
     nCampo = #xmlcerli#3;
     |HAZ CreaArbol;
|FPRC;

|DEFBUCLE BuscaHijos;
     #xmlcerli#1;
     ;
     aEntidad,   1;
     aEntidad, 999;
     ;
     NULL, BuscaHijos;
|FIN;

|PROCESO MarcaFin;
     |HAZ ConstruyeNivel;
     |HAZ Construye2
     #100#0 = nContador;
     #100#1 = nNivel;
     #100#2 = #xmlcerli#2;
     |SI nNivel = 1;          || excepcion: la ultima
          #100#2 = #xmlcerli#0;
     |FINSI;
     #100#3 = aNivel;
     #100#5 = 2;         || cierro entidad compleja
     |GRABA 020#100n;
|FPRC;

|PROCESO BuscaLineaUno;
     || tengo que buscar la linea del xmlcerli para que me haga el SALVA_FICHA
     || de la primera linea tambien, sino, no saldra bien al final
     || esto no esta en el proceso que imprime, aunque daria igual
     |SI nContador = 0;
          #xmlcerli#0 = #xmlcerca#0;
          #xmlcerli#1 = 1;
          |LEE 000#xmlcerli.=;
     |FINSI;
|FPRC;

|PROCESO CreaArbol;
     swHayHijos = 0;
     #xmlcerca#0 = aEntidad;
     |HAZ BuscaLineaUno;
     |LEE 000#xmlcerca.=;
     |SI FSalida = 0;         || tiene hijos
          |SALVA_FICHA #xmlcerca;
          |SALVA_FICHA #xmlcerli;

          swACero = 0;
          |SI nElemento ! 0;
               nNivel = nNivel - 1;
               swACero = 1;
          |FINSI;
          nElemento = 0;
          |HAZ ConstruyeNivel;
          |HAZ Construye2

          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 0;                   || abro entidad compleja
          |GRABA 020#100n;

          |BUCLE BuscaHijos;

          |SI swHayHijos = 0;
               nNivel = nNivel - 1;
               |REPON_FICHA #xmlcerca;
               |REPON_FICHA #xmlcerli;
               |PARA; |SI FSalida = -1; |HACIENDO;
                    |REPON_FICHA #xmlcerca;
                    |REPON_FICHA #xmlcerli;
                    ||HAZ MarcaFin2;
               |SIGUE;
               |HAZ MarcaFin;
          |FINSI;
     |SINO;
          nElemento = nElemento + 1;
          |HAZ ConstruyeNivel;
          |HAZ Construye2;
          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 1;                   || entidad simple
          #100#6 = nCampo;              || entidad simple
          |GRABA 020#100n;
     |FINSI;
|FPRC;

|PROCESO arbol;
     aAlfa = Usuario;    |QBT aAlfa;    aAlfa = ("x" + aAlfa) % 108;
     |NOME_DAT #100 aAlfa;
     |DELINDEX #100;
     |ABRE #100;
     |ABRE #xmlcerca;
     |ABRE #xmlcerli;

     aEntidad = "Certificado_empresa";  || la entidad a partir de la cual
                                        || quiero que me cree la estructura
     |HAZ CreaArbol;
     |BUCLE LineasArbol;

     |CIERRA #100;
     |CIERRA #xmlcerca;
     |CIERRA #xmlcerli;
|FPRC;

/*************** FINAL PROCESOS PARA CREACION DEL ARBOL XML *****************/

|PROCESO FormatoNum;
     aPunto = aAlfa % -201;
     |SI aPunto = ".";
          aAlfa = aAlfa + "0";
     |FINSI;
     aPunto = aAlfa % -301;
     |SI aPunto ! ".";
          aAlfa = aAlfa + "00";
     |FINSI;
     aAlfa = aAlfa - ".";
     aAlfa = ("000000000" + aAlfa) % -109;
|FPRC;

|PROCESO DatosVac_Agrario;
     |SI #labcerag#102 ! 0;
          aAlfa = #labtraba#33;              || grupo cotizacion
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;
          #labcerpu#134 = aAlfa;

          #labcerpu#135 = "00";              || dias cot.
          #labcerpu#136 = "00";              || jornadas cot.
                                             || por defecto a cero
          aAlfa = #labcerag#102;
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;

          |SI aTipoCot = "G";
               #labcerpu#135 = aAlfa;
               #labcerpu#136 = "";
          |SINO;
               #labcerpu#136 = aAlfa;
               #labcerpu#135 = "";
          |FINSI;

          aAlfa = #labcerag#140; |QBF aAlfa;
          |HAZ FormatoNum;
          #labcerpu#145 = aAlfa;
     |FINSI;
|FPRC;

|PROCESO DatosVac_General;
     |SI #labcerti#70 ! 0;
          aAlfa = #labcerti#70; |QBF aAlfa;
          aAlfa = ("000" + aAlfa) % -103;
          #labcerpu#130 = aAlfa;

          |SI #labcerti#78 = 16; |O #labcerti#78 = 17; |O #labcerti#78 = 18;
               aAlfa = #labcerti#71; |QBF aAlfa;
               |HAZ FormatoNum;
               #labcerpu#131 = aAlfa;
          |FINSI;

          aAlfa = #labcerti#72; |QBF aAlfa;
          |HAZ FormatoNum;
          #labcerpu#132 = aAlfa;
     |FINSI;
|FPRC;

|PROCESO LineaAgr;
     #labcerpu#nCampo# = aAlfa1;        || a¤o

     |QBF aAlfa2;                       || mes
     aAlfa = aAlfa2;
     aAlfa = ("00" + aAlfa) % -102;
     #labcerpu#nCampo1# = aAlfa;

     aAlfa = #labtraba#33;              || grupo cotizacion
     |QBF aAlfa;
     aAlfa = ("00" + aAlfa) % -102;
     #labcerpu#nCampo2# = aAlfa;

     #labcerpu#nCampo3# = "00";              || dias cot.
     #labcerpu#nCampo4# = "00";              || jornadas cot.
                                             || por defecto a cero
     nNume = aAlfa1;
     |SI aTipoCot = "G"; |Y nNume ] 2012;
          #labcerpu#nCampo4# = "";           || jornadas cot. por defecto en blanco
     |FINSI;                                 || para que no salga si no toca
     |SI aTipoCot = "J"; |Y nNume ] 2012;
          #labcerpu#nCampo3# = "";           || dias cot. por defecto en blanco
     |FINSI;                                 || para que no salga si no toca

     aAlfa = aAlfa3;
     |QBF aAlfa;
     aAlfa = ("00" + aAlfa) % -102;

     |SI aTipoCot = "G";
          #labcerpu#nCampo3# = aAlfa;
     |SINO;
          #labcerpu#nCampo4# = aAlfa;
     |FINSI;

     nNume = aAlfa1;
     |SI nNume ] 2012;
          aAlfa = aAlfa4;
          |HAZ FormatoNum;
          #labcerpu#nCampo5# = aAlfa;
     |FINSI;
|FPRC;

|PROCESO BuscaBaseXML;
     nValor = 0;
     |SI nAny [ 2011;
          |ACABA;
     |FINSI;
     |PARA nCampito = 126; |SI nCampito [ 138; |HACIENDO nCampito = nCampito + 2;
          aAlfa1 = nAny;
          aAlfa2 = nMes; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
          aAlfa = aAlfa1 + aAlfa2;
          |SI #labcerag#nCampito# = aAlfa;
               nNume = nCampito + 1;
               nValor = #labcerag#nNume#;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DatosCot_Agrario;
     |PARA nCampo = 88; |SI nCampo [ 124; |HACIENDO nCampo = nCampo + 6;
          nCampo1 = nCampo + 1;
          nCampo2 = nCampo + 2;
          nCampo3 = nCampo + 3;
          nCampo4 = nCampo + 4;
          nCampo5 = 88 + ((nCampo - 88) / 6) + 50;

          |SI nCampo = 88;                   || linea 1
               |SI nAnyo1 = nanyo;
                    nCampoDias = 71 + nMes1;
               |SINO;
                    nCampoDias = 59 + nMes1;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo1;
                    aAlfa2 = nMes1;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo1;
                    nMes = nMes1;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 94;                   || linea 2
               |SI nAnyo2 = nanyo;
                    nCampoDias = 71 + nMes2;
               |SINO;
                    nCampoDias = 59 + nMes2;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo2;
                    aAlfa2 = nMes2;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo2;
                    nMes = nMes2;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 100;                  || linea 3
               |SI nAnyo3 = nanyo;
                    nCampoDias = 71 + nMes3;
               |SINO;
                    nCampoDias = 59 + nMes3;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo3;
                    aAlfa2 = nMes3;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo3;
                    nMes = nMes3;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 106;                  || linea 4
               |SI nAnyo4 = nanyo;
                    nCampoDias = 71 + nMes4;
               |SINO;
                    nCampoDias = 59 + nMes4;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo4;
                    aAlfa2 = nMes4;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo4;
                    nMes = nMes4;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 112;                  || linea 5
               |SI nAnyo5 = nanyo;
                    nCampoDias = 71 + nMes5;
               |SINO;
                    nCampoDias = 59 + nMes5;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo5;
                    aAlfa2 = nMes5;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo5;
                    nMes = nMes5;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 118;                  || linea 6
               |SI nAnyo6 = nanyo;
                    nCampoDias = 71 + nMes6;
               |SINO;
                    nCampoDias = 59 + nMes6;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo6;
                    aAlfa2 = nMes6;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo6;
                    nMes = nMes6;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;

          |SI nCampo = 124;                  || linea 7
               |SI nAnyo7 = nanyo;
                    nCampoDias = 71 + nMes7;
               |SINO;
                    nCampoDias = 59 + nMes7;
               |FINSI;

               |SI #labcerag#nCampoDias# ! 0;
                    aAlfa1 = nAnyo7;
                    aAlfa2 = nMes7;
                    aAlfa3 = #labcerag#nCampoDias#;

                    nAny = nAnyo7;
                    nMes = nMes7;
                    |HAZ BuscaBaseXML;
                    aAlfa4 = nValor;

                    |HAZ LineaAgr;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO mesnum;
     |SI aAlfa = "ENE"; aAlfa = "01"; |FINSI;
     |SI aAlfa = "FEB"; aAlfa = "02"; |FINSI;
     |SI aAlfa = "MAR"; aAlfa = "03"; |FINSI;
     |SI aAlfa = "ABR"; aAlfa = "04"; |FINSI;
     |SI aAlfa = "MAY"; aAlfa = "05"; |FINSI;
     |SI aAlfa = "JUN"; aAlfa = "06"; |FINSI;
     |SI aAlfa = "JUL"; aAlfa = "07"; |FINSI;
     |SI aAlfa = "AGO"; aAlfa = "08"; |FINSI;
     |SI aAlfa = "SEP"; aAlfa = "09"; |FINSI;
     |SI aAlfa = "OCT"; aAlfa = "10"; |FINSI;
     |SI aAlfa = "NOV"; aAlfa = "11"; |FINSI;
     |SI aAlfa = "DIC"; aAlfa = "12"; |FINSI;
|FPRC;

|PROCESO Linea;
     #labcerpu#nCampo# = aAlfa1;        || a¤o

     |QBF aAlfa2;                       || mes
     aAlfa = aAlfa2
     |HAZ mesnum;
     #labcerpu#nCampo1# = aAlfa;

     |QBF aAlfa3;                       || dias
     aAlfa = aAlfa3;
     aAlfa = ("000" + aAlfa) % -103;
     #labcerpu#nCampo2# = aAlfa;

                                        || base contingencias comunes
     |SI #labcerti#78 = 16; |O #labcerti#78 = 17; |O #labcerti#78 = 18;
          |QBF aAlfa4;
          aAlfa = aAlfa4;
          |HAZ FormatoNum;
          #labcerpu#nCampo3# = aAlfa;
     |FINSI;

     |QBF aAlfa5;                       || base desempleo
     aAlfa = aAlfa5;
     |HAZ FormatoNum;
     #labcerpu#nCampo4# = aAlfa;
|FPRC;

|PROCESO DatosCot_General;
     |PARA nCampo = 46; |SI nCampo [ 82; |HACIENDO nCampo = nCampo + 6;
          nCampo1 = nCampo + 1;
          nCampo2 = nCampo + 2;
          nCampo3 = nCampo + 3;
          nCampo4 = nCampo + 4;

          |SI nCampo = 46;                   || linea 1
               |SI nBaseCotDes1 ! 0;
                    aAlfa1 = nAnyo1;
                    aAlfa2 = aMes1;
                    aAlfa3 = nDiasCot1;
                    aAlfa4 = nBaseCotCC1;
                    aAlfa5 = nBaseCotDes1;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 52;                   || linea 2
               |SI nBaseCotDes2 ! 0;
                    aAlfa1 = nAnyo2;
                    aAlfa2 = aMes2;
                    aAlfa3 = nDiasCot2;
                    aAlfa4 = nBaseCotCC2;
                    aAlfa5 = nBaseCotDes2;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 58;                   || linea 3
               |SI nBaseCotDes3 ! 0;
                    aAlfa1 = nAnyo3;
                    aAlfa2 = aMes3;
                    aAlfa3 = nDiasCot3;
                    aAlfa4 = nBaseCotCC3;
                    aAlfa5 = nBaseCotDes3;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 64;                   || linea 4
               |SI nBaseCotDes4 ! 0;
                    aAlfa1 = nAnyo4;
                    aAlfa2 = aMes4;
                    aAlfa3 = nDiasCot4;
                    aAlfa4 = nBaseCotCC4;
                    aAlfa5 = nBaseCotDes4;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 70;                   || linea 5
               |SI nBaseCotDes5 ! 0;
                    aAlfa1 = nAnyo5;
                    aAlfa2 = aMes5;
                    aAlfa3 = nDiasCot5;
                    aAlfa4 = nBaseCotCC5;
                    aAlfa5 = nBaseCotDes5;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 76;                   || linea 6
               |SI nBaseCotDes6 ! 0;
                    aAlfa1 = nAnyo6;
                    aAlfa2 = aMes6;
                    aAlfa3 = nDiasCot6;
                    aAlfa4 = nBaseCotCC6;
                    aAlfa5 = nBaseCotDes6;
                    |HAZ Linea;
               |FINSI;
          |FINSI;

          |SI nCampo = 82;                   || linea 7
               |SI nBaseCotDes7 ! 0;
                    aAlfa1 = nAnyo7;
                    aAlfa2 = aMes7;
                    aAlfa3 = nDiasCot7;
                    aAlfa4 = nBaseCotCC7;
                    aAlfa5 = nBaseCotDes7;
                    |HAZ Linea;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DistrJor;
     |SI aRegimen = "G";
          nDesdeCampo = 87;
          nHastaCampo = 99;
     |SINO;
          nDesdeCampo = 106;
          nHastaCampo = 118;
     |FINSI;

     |PARA nCampo = nDesdeCampo; |SI nCampo [ nHastaCampo; |HACIENDO nCampo = nCampo + 4;
          nCampo1 = nCampo + 1;
          nCampo2 = nCampo + 2;
          nCampo3 = nCampo + 3;

          |SI aRegimen = "G";                || el campo 30 del labcerpu
               nCampoPu = nCampo - 57;
          |SINO;
               nCampoPu = nCampo - 76;
          |FINSI;
          nCampoPu1 = nCampoPu + 1;
          nCampoPu2 = nCampoPu + 2;
          nCampoPu3 = nCampoPu + 3;

          |SI aRegimen = "G";
               aAlfa1 = #labcerti#nCampo#;
               nNume1 = #labcerti#nCampo1#;
               aAlfa2 = #labcerti#nCampo2#;
               aAlfa3 = #labcerti#nCampo3#;
          |SINO;
               aAlfa1 = #labcerag#nCampo#;
               nNume1 = #labcerag#nCampo1#;
               aAlfa2 = #labcerag#nCampo2#;
               aAlfa3 = #labcerag#nCampo3#;
          |FINSI;

          |QBF aAlfa1;
          |SI aAlfa1 ! "";
               || tipo de distribucion
               |SI aAlfa1 = "R"; aAlfa = "1"; |FINSI;
               |SI aAlfa1 = "I"; aAlfa = "2"; |FINSI;
               #labcerpu#nCampoPu# = aAlfa;

               || fecha inicio periodo
               |QBF aAlfa2;
               |SI aAlfa2 ! "";
                    aAlfa2 = (aAlfa2 % -104) + (aAlfa2 % 402) + (aAlfa2 % 102);
                    #labcerpu#nCampoPu1# = aAlfa2;
               |FINSI;

               || fecha fin periodo
               |QBF aAlfa3;
               |SI aAlfa3 ! "";
                    aAlfa3 = (aAlfa3 % -104) + (aAlfa3 % 402) + (aAlfa3 % 102);
                    #labcerpu#nCampoPu2# = aAlfa3;
               |FINSI;

               || Dias
               aAlfa = nNume1;
               |QBF aAlfa;
               |SI nNume1 ! 0;
                    aAlfa = ("00000" + aAlfa) % -105;
                    #labcerpu#nCampoPu3# = aAlfa;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO DiasAlta;
     nFechaAlta = fFechaAlta;
     nFechaBaja = fFechaBaja;
     nNume = nFechaBaja - nFechaAlta + 1;

     aAlfa = nNume; aAlfa = ("00000" + aAlfa) % -105;
|FPRC;

|PROCESO Datos_Resto;
     fFechaAlta = #labtraba#36;    || dias de alta

     |SI aRegimen = "G";
          fFechaBaja = #labcerti#8;
     |SINO;
          fFechaBaja = #labcerag#4;
     |FINSI;

     |HAZ DiasAlta;
     #labcerpu#14 = aAlfa;

     #labcerpu#15 = "D";

     |SI aRegimen = "G";           || codigo de profesion
          aAlfa = #labcerti#103;
     |SINO;
          aAlfa = #labcerag#122;
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = (aAlfa + "0000000") % 107;
          #labcerpu#16 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#82;  || cargo publico sindical
     |SINO;
          aAlfa = #labcerag#124; || cargo publico sindical
     |FINSI;
     |QBF aAlfa;
     #labcerpu#17 = aAlfa;
     |SI aAlfa ! "";       || dedicacion cargo sindical
          |SI aRegimen = "G";
               aAlfa = #labcerti#83;
          |SINO;
               aAlfa = #labcerag#125;
          |FINSI;
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;
          aAlfa = aAlfa + "00";
          #labcerpu#18 = aAlfa;
     |FINSI;

     aAlfa1 = #labtraba#36;         || fecha alta trabajador
     aAlfa2 = #labtraba#34;         || fecha antiguedad trabajador

     aAlfa = aAlfa1;               || en principio la de alta

     aAlfa3 = #labtraba#0; |QBF aAlfa3; aAlfa3 = ("00000" + aAlfa3) % -105;
     aAlfa4 = #labtraba#1; |QBF aAlfa4; aAlfa4 = ("00000" + aAlfa4) % -105;

     |SI aAlfa1 ! aAlfa2;
          aAlfa = "    ATENCION: Trab. " + aAlfa3 + "." + aAlfa4;
          aAlfa = aAlfa + ": fecha alta (" + aAlfa1 + ") no coincide ";
          aAlfa = aAlfa + "con fecha antigüedad (" + aAlfa2 + ")";
          |MENAV aAlfa;
          aAlfa = "    SDesea enviar la fecha de antigüedad en lugar de la de alta?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               aAlfa = aAlfa2;

               aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
               #labcerpu#19 = aAlfa;

               fFechaAlta = #labtraba#34;    || dias de alta
               |HAZ DiasAlta;
               #labcerpu#14 = aAlfa;
          |SINO;
               aAlfa = aAlfa1;
               aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
               #labcerpu#19 = aAlfa;
          |FINSI;
     |SINO;
          aAlfa = aAlfa1;
          aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          #labcerpu#19 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#78;         || causa baja
     |SINO;
          aAlfa = #labcerag#98;         || causa baja
     |FINSI;
     |QBF aAlfa;
     aAlfa = ("00" + aAlfa) % -102;
     #labcerpu#20 = aAlfa;

     |SI aRegimen = "G";
          aAlfa = #labcerti#8;          || fecha baja trabajador
     |SINO;
          aAlfa = #labcerag#4;          || fecha baja trabajador
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          #labcerpu#21 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#80;         || fecha prevista reincorporacion
     |SINO;
          aAlfa = #labcerag#100;        || fecha prevista reincorporacion
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          #labcerpu#22 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#81;         || numero ERE
     |SINO;
          aAlfa = #labcerag#101;        || numero ERE
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = ("000000000" + aAlfa) % -109;
          #labcerpu#23 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          nNume = #labcerti#85;
     |SINO;
          nNume = #labcerag#104;
     |FINSI;
     |SI nNume ! 0;         || porcentaje reduccion ERE
          nNume1 = nNume ! 0;
          |SI nNume = nNume1;  || no tengo decimales
               nNume = nNume * 100;
          |FINSI;
          aAlfa = nNume;
          |QBF aAlfa;
          aAlfa1 = aAlfa % -201;
          |SI aAlfa1 = ".";
               aAlfa = aAlfa + "0";
          |FINSI;
          aAlfa = aAlfa - ".";
          aAlfa = ("0000" + aAlfa) % -104;
          #labcerpu#24 = aAlfa;
          #labcerpu#26 = "01";
     |FINSI;

     |SI aRegimen = "G";
          nNume = #labcerti#86;
     |SINO;
          nNume = #labcerag#105;
     |FINSI;
     |SI nNume ! 0;         || porcentaje reduccion otras causas
          nNume1 = nNume ! 0;
          |SI nNume = nNume1;  || no tengo decimales
               nNume = nNume * 100;
          |FINSI;
          aAlfa = nNume;
          |QBF aAlfa;
          aAlfa1 = aAlfa % -201;
          |SI aAlfa1 = ".";
               aAlfa = aAlfa + "0";
          |FINSI;
          aAlfa = aAlfa - ".";
          aAlfa = ("0000" + aAlfa) % -104;
          #labcerpu#25 = aAlfa;
          #labcerpu#26 = "02";
     |FINSI;

     |SI aRegimen = "G";
          |SI #labcerti#85 ! 0; |Y #labcerti#86 ! 0;   || causa reduccion (las dos)
               #labcerpu#26 = "03";
          |FINSI;
     |SINO;
          |SI #labcerag#105 ! 0; |Y #labcerag#106 ! 0;   || causa reduccion (las dos)
               #labcerpu#26 = "03";
          |FINSI;
     |FINSI;

     nDias = 0;                         || fechas salarios tramitacion
     |SI aRegimen = "G";
          fFecha1 = #labcerti#74;
          fFecha2 = #labcerti#75;
     |SINO;
          fFecha1 = #labcerag#8;
          fFecha2 = #labcerag#9;
     |FINSI;
     nFecha1 = fFecha1;
     nFecha2 = fFecha2;
     |SI aRegimen = "G";
          |SI nFecha1 ! -1; |Y nFecha2 ! -1;
               nDias = nFecha2 - nFecha1 + 1;
          |FINSI;
     |SINO;
          nDias = #labcerag#10;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#74;         || fecha desde salarios tramitacion
     |SINO;
          aAlfa = #labcerag#8;          || fecha desde salarios tramitacion
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          #labcerpu#27 = aAlfa;
     |FINSI;

     |SI aRegimen = "G";
          aAlfa = #labcerti#75;         || fecha hasta salarios tramitacion
     |SINO;
          aAlfa = #labcerag#9;         || fecha hasta salarios tramitacion
     |FINSI;
     |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          #labcerpu#28 = aAlfa;
     |FINSI;

     aAlfa = nDias;
     |QBF aAlfa;
     aAlfa = ("00000" + aAlfa) % -105;
     #labcerpu#29 = aAlfa;
|FPRC;

|PROCESO Datos_Representante;
     || DATOS REPRESENTANTE

     aAlfa = #labcer06#2; |QBF aAlfa;
     |SI aAlfa = "";
          aAlfa = #labempre#17; |QBF aAlfa;
     |FINSI;

     |SI aAlfa ! "";
          #labcerpu#0 = aAlfa;
     |FINSI;

     aCadena = #labcer06#1; |QBF aCadena;
     |SI aCadena = "";
          aCadena = #labempre#15;
     |FINSI;
     |HAZ SeparaNom_plb;

     #labcerpu#1 = eaNom;
     #labcerpu#2 = eaApel1;
     #labcerpu#3 = eaApel2;

     aAlfa = #labcer06#3; |QBF aAlfa;
     aAlfa1 = #labcer06#1; |QBF aAlfa1;
     aAlfa2 = #labcer06#2; |QBF aAlfa2;
     |SI aAlfa = ""; |Y aAlfa1 = ""; |Y aAlfa2 = "";
          aAlfa = #labempre#18; |QBF aAlfa;
     |SINO;
          aAlfa = #labcer06#3; |QBF aAlfa;
     |FINSI;
     |SI aAlfa ! "";
          #labcerpu#4 = aAlfa;
     |FINSI;
|FPRC;

|PROCESO Datos_Empresa;
     || DATOS EMPRESA

     #labcerpu#5 = #labempre#10;             || CIF o NIF empresa

     aAlfa = #labtraba#247;                  || CCC empresa o centro
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;

     aAlfa1 = #labcentr#10; |QBF aAlfa1;
     aAlfa = aAlfa + aAlfa1;
     |QBF aAlfa;
     #labcerpu#6 = aAlfa;
|FPRC;

|PROCESO BuscaCCCCen2;
     |ABRE #gomccchi;
     #gomccchi#0 = #labcentr#0;
     #gomccchi#1 = #labcentr#1;
     |LEE 000#gomccchi.=;
     |SI FSalida = 0;
          aAlfa = #labcerag#4;
          |QBF aAlfa;
          aAlfa = aAlfa % -104;
          nNume = aAlfa;
          |SI nNume [ 2011;
               #labcentr#10 = #gomccchi#2;
          |FINSI;
     |FINSI;
     |CIERRA #gomccchi;
|FPRC;

|PROCESO Datos_Comunes;
     #labempre#0 = enEmp;
     |LEE 000#labempre.=;

     #labtraba#0 = enEmp;
     #labtraba#1 = enTra;
     |LEE 000#labtraba.=;

     #labcentr#0 = enEmp;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     ||HAZ BuscaCCCCen2;
     |SI #labtraba#45 = "087"; |O #labtraba#45 = "421";
          |ABRE #nomcenes;
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = 87;
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               #labcentr#10 = #nomcenes#10;
          |FINSI;
          |CIERRA #nomcenes;
     |FINSI;

     aAlfa = #labtraba#247;                  || CCC empresa o centro
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;

     aAlfa1 = #labcentr#10; |QBF aAlfa1;
     aAlfa = aAlfa + aAlfa1;
     |QBF aAlfa;
     aCCC = aAlfa;

     |SI aCCC = aAntCCC;
          swEtiCCC = 0;
     |SINO;
          swEtiCCC = 1;       || incluimos etiqueta Cuenta_cotizacion y
                              || datos de la empresa
          |HAZ Datos_Representante;
          |HAZ Datos_Empresa;
     |FINSI;

     |SI aAntCCC = "";
          swPrimerCCC = 1;
     |SINO;
          swPrimerCCC = 0;
     |FINSI;

     aAntCCC = aCCC;                  || me quedo con el CCC

     || DATOS TRABAJADOR

     #labcerpu#7 = #labtraba#7;

     aCadena = #labtraba#2;
     |HAZ SeparaNom_plb;

     #labcerpu#8 = eaNom;
     #labcerpu#9 = eaApel1;
     #labcerpu#10 = eaApel2;
     #labcerpu#11 = #labtraba#75;
     |SI #labtraba#247 ! 0613; |Y #labtraba#247 ! 0163;
          aAlfa = #labtraba#33; aAlfa = ("00" + aAlfa) % -102;
          #labcerpu#12 = aAlfa;
     |FINSI;
     #labcerpu#13 = #labtraba#45;
|FPRC;

|PROCESO GeneraXML;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #labcentr;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |ABRE #labcer06; |LEE 000#labcer06.p; |CIERRA #labcer06;

     |HAZ Datos_Comunes;
     |HAZ Datos_Resto;
     |HAZ DistrJor;

     |SI aRegimen = "G";
          |HAZ DatosCot_General;
          |HAZ DatosVac_General;
     |FINSI;

     |SI aRegimen = "A";
          |SI #labtraba#42 = "A";
               aTipoCot = "G";
          |SINO;
               aTipoCot = "J";
          |FINSI;

          |HAZ DatosCot_Agrario;
          |HAZ DatosVac_Agrario;
     |FINSI;

     |CIERRA #labcentr;
     |CIERRA #labtraba;
     |CIERRA #labempre;

     |HAZ arbol;

     |SI enSwHisto = 0;
          |HAZ CreaDirectorio;
     |FINSI;

     |SI enSwHisto = 0;
          aAlfa1 = enEmp; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
          aAlfa2 = enTra; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
          eaFichero = aAlfa1 + "_" + aAlfa2 + "_" + "cert.xml";
     |FINSI;

     nCanal = enCanal;
     |HAZ CreaFichero;

     |HAZ GrabaHis;

     |SI enSwHisto = 0; |Y swNetContrata = 0;
          |HAZ MensajeFinal;
     |FINSI;
|FPRC;

/****************************************************************************/
/*                          ENVIO A NETCONTRATA                             */
/****************************************************************************/

|VARIABLES;
     aRutaErrores = "";
     aOrigen = "";
     aDestino = "";
     nSwEtiq = 0;
     aEtiqu = "";
     aError = "";
     nNumChars = 0;
     aRutaSal = "";
     aLon = "";
     nLon = 0;
     nPunt = 0;
     nPos = 0;
     aCaracter = "";
     aFich = "";
     nHandle = 0;
|FIN;

|PROCESO CompRuta;
     aRutaSal = "";
     |QBF aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nPunt = 1; |SI nPunt [ nLon; |HACIENDO nPunt = nPunt + 1;
          nPos = (nPunt * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "/";
               aRutaSal = aRutaSal + "\";
          |SINO;
               aRutaSal = aRutaSal + aCaracter;
          |FINSI;
     |SIGUE;
     aCaracter = aRutaSal % -101;
     |SI aCaracter ! "\";
          aRutaSal = aRutaSal + "\";
     |FINSI;
     aRuta = aRutaSal;

     eaCadena = aRuta;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aRuta = eaCadenaSal;
|FPRC;

|PROCESO EnvioNetContrata;

     || A PARTIR DE AQUI SI ME VALDRA, EL SE PONE A HACER SU NETCONTRATA
     || Y SUS COSAS

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     aFich = aPath + eaFichero;

     aRuta = #labcontr#51;
     |QBF aRuta;
     aAlfa = aRuta % -101;
     |SI aAlfa ! "\"; |Y aAlfa ! "/";
          aRuta = aRuta + "/";
     |FINSI;
/*
     aRuta = aRuta + "NETCONTRATA/CERTIFICADOS";
     |RMKDIR aRuta;
     aRuta = aRuta + "/ERRORES";
     |RMKDIR aRuta;
     aRutaErrores = aRuta;
*/

     || ruta para errores
     aAlfa1 = #labcontr#63;
     |QBF aAlfa1;
     aAlfa = aAlfa1 % -101;
     |SI aAlfa ! "\"; |Y aAlfa ! "/";        || ruta de los XML
          aAlfa1 = aAlfa1 + "\";
     |FINSI;

     aAlfa = aAlfa1 + "ERRORES";
     aRutaErrores = aAlfa;
     aRuta = aRutaErrores; |HAZ CompRuta; aRutaErrores = aRuta;

     aAlfa = aRutaErrores + "ERRORESNET.XML";
     |RFBORRA aAlfa;

     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aRutaErrores;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;


     || aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aRutaErrores;

/*
     |HAZ RegistroNetC_Inicial;
     |BUCLE IniErrores;
*/

     || aAlfa1 = #labcontr#62; |QBF aAlfa1;
     || aAlfa = "start " + aAlfa;
     || RSYSTEM aAlfa;

     |HAZ DSArchi;
|FPRC;

|PROCESO Mensaje;
/*
     |PUSHV 11151965;
     |BLANCO 12181863;
     |CUADRO 12181862;
     |ATRI S;
          ||   2         3         4         5        6
          ||   0123456789012345678901234567890123467890
     aMensa = "Pulse ENTER cuando haya validado la ope-";
     |PINTA 1320, aMensa;
     aMensa = "raci¢n y enviado  el certificado  online";
     |PINTA 1420, aMensa;
     aMensa = "para archivar los documentos recibidos o";
     |PINTA 1520, aMensa;
     aMensa = "pulse ESC para no archivar.             ";
     |PINTA 1620, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";        || ENTER
     aEsc2  = &255 + "806";        || ESC
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
          |SI aTecla = aEsc2;
               |MENAV "    Se ha cancelado el envío del documento a DSArchi.";
               nArchi = 0;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;
*/

     aAlfa = "    SDespués de enviar el certificado, pulse SI para archivar ";
     aAlfa = aAlfa + "la huella y el certif. o NO para no archivar.";
     |CONFI aAlfa;
     |SI FSalida ! 0;
          nArchi = 0;
     |FINSI;
|FPRC;

|PROCESO NombreFichero;
     aNif = #labtraba#7; |QBF aNif;
     aCCC = #labcentr#10; |QBF aCCC;
     aFechaAlta = #labtraba#36; |QBF aFechaAlta;

     aFichero = aCCC + "_" + aNif + "_" + (aFechaAlta % -104);
     aFichero = aFichero + (aFechaAlta % 402) + (aFechaAlta % 102);
|FPRC;

|PROCESO DSArchi;
/*
     eaVengoDe = "labcexml";
     nArchi = 0;
     |HAZ MiraSiArchiva;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     |HAZ Mensaje;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     swSigue = 1;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aFichCertif = "";
     aFichHuella = "";

     aAlfa = #labcontr#63; |QBF aAlfa;
     |HAZ NombreFichero;
     aFichero = aFichero + ".pdf";
     aFichHuella = aFichero;
     aAlfa = aAlfa + "\CERTIFICA2\" + aFichero;
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa = #labcontr#63; |QBF aAlfa;
     |HAZ NombreFichero;
     aFichero = aFichero + "cdo.pdf";
     aFichCertif = aFichero;
     aAlfa = aAlfa + "\CERTIFICA2\" + aFichero;
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     |SI swSigue = 0;
          aAlfa = "    No se han encontrado los documentos de respuesta para archivar";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     aAlfa = fFechaBaja;
     aAlfa = aAlfa % 402;
     enMes = aAlfa;
     aAlfa = fFechaBaja;
     aAlfa = aAlfa % -104;
     enAny = aAlfa;

     enSwDesde9 = 1;
     enSwMeteGrupoSubTipo = 0;
     |HAZ CtrlPedirGrupoDsArchi;

     || aqui le tengo que poner el nombre de los archivos para enviar uno y
     || despues el otro

     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\CERTIFICA2\" + aFichCertif;
     eaOrig = aAlfa;
     eaObservaciones = "Certificado de cese en empresa";
     |HAZ Archivando;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\CERTIFICA2\" + aFichHuella;
     eaOrig = aAlfa;
     eaObservaciones = "Huella de certificado de cese en empresa";
     |HAZ Archivando;

     |SI enSwErrorRecDoc ! 1;
          aAlfa = "    Se han archivado los documentos asociados al ";
          aAlfa = aAlfa + "certificado de empresa del trabajador.";
          |MENAV aAlfa;
     |FINSI;
*/
|FPRC;
