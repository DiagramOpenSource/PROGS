|FICHEROS;
     labtraba;
     labcontr;
     labhisto;
     labregis;
|FIN;

|VARIABLES;
     &enEmp = 0;
     &enTra = 0;
     &eaNif = "";
     &eaFechaAlta = "";
     &enRegistro = 0;
     &eaIdContrato = "";

     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aRuta = "";
     aFichero = "";
     aFich = "";
     aRutaSal = "";
     aLon = "";
     nLon = 0;
     nPunt = 0;
     nPos = 0;
     aCaracter = "";

     aIdContrata = "";

     nHandle = 0;
     nHandle1 = 0;
     aCadena = "";
     aTipoID = "";
     &swSigue = 0;
     nNivel = 0;

     nSwEtiq = 0;
     aEtiqu = "";
     aError = "";
     nNumChars = 0;
     swAcaba = 0;
     aLinea = "";
     aMensa = "";
     aEsc1 = "";
     aTecla = "";

     &nArchi = 0;
     aFichero1 = "";
     &eaVengoDe = "";
     aFichHuella = "";
     fFechaAlta = @;
     &enMes = 0;
     &enAny = 0;
     &enSwDesde9 = 0;
     &enSwMeteGrupoSubTipo = 0;
     &enSwErrorRecDoc = 0;
     &eaOrig = "";
     &eaObservaciones = "";
     aQueEs = "";
     aRutaBAT = "";
     nHandleBAT = 0;
     aUnidad = "";
     aResto = "";
     {1}aContiene = "";

     &eaCadena = "";
     &eaCadenaSal = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";
|FIN;

|PROCESO Mensaje;
/*
     |PUSHV 11151965;
     |BLANCO 12181763;
     |CUADRO 12181762;
     |ATRI S;
          ||   2         3         4         5        6
          ||   0123456789012345678901234567890123467890
     aMensa = "Pulse ENTER cuando haya validado la ope-";
     |PINTA 1320, aMensa;
     aMensa = "raci¢n y enviado el certificado  online,";
     |PINTA 1420, aMensa;
     aMensa = "para archivar  los documentos recibidos.";
     |PINTA 1520, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;
*/

     aAlfa = "    SPulse SI para archivar la huella del contrato ";
     aAlfa = aAlfa + "o NO para no archivar.";
     |CONFI aAlfa;
     |SI FSalida ! 0;
          nArchi = 0;
     |FINSI;
|FPRC;

|PROCESO NombreFichero;
/*
     || QUEDE CON MIGUEL ANGEL EN QUE FUERA DE ESTA MANERA, PERO AL FINAL
     || EL TIO ESTA USANDO EL ID. DEL CONTRATO. COMO ME DA IGUAL, YO
     || USO LO MISMO

     aNif = #labtraba#7; |QBF aNif;
     aCCC = #labcentr#10; |QBF aCCC;
     aFechaAlta = #labtraba#34; |QBF aFechaAlta;

     aFichero1 = aCCC + "_" + aNif + "_" + (aFechaAlta % -104);
     aFichero1 = aFichero1 + (aFechaAlta % 402) + (aFechaAlta % 102);
*/

     aFichero1 = (aIdContrata % 103) + "-" + (aIdContrata % 404) + "-" + (aIdContrata % 807);
|FPRC;
/*
|PROCESO DSArchi;
     eaVengoDe = "labimpre";
     nArchi = 0;
     |HAZ MiraSiArchiva;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     swSigue = 1;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aFichHuella = "";

     aAlfa = #labcontr#63; |QBF aAlfa;
     |HAZ NombreFichero;
     aFichero1 = aFichero1 + ".pdf";
     aFichHuella = aFichero1;
     aAlfa = aAlfa + "\HCONTRATOS\" + aFichero1;
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     |SI swSigue = 1;
          aAlfa = "    SSe ha obtenido la huella del contrato. ";
          aAlfa = aAlfa + "Pulse SI para archivar en GAD ";
          aAlfa = aAlfa + "o NO para no archivar.";
          |CONFI aAlfa;
          |SI FSalida ! 0;
               nArchi = 0;
          |FINSI;
     |SINO;
          nArchi = 0;
     |FINSI;

     |SI nArchi ! 1;
          |ACABA;
     |FINSI;

     enEmp = #labregis#1;
     enTra = #labregis#2;

     fFechaAlta = #labregis#7;

     aAlfa = fFechaAlta;
     aAlfa = aAlfa % 402;
     enMes = aAlfa;
     aAlfa = fFechaAlta;
     aAlfa = aAlfa % -104;
     enAny = aAlfa;

     enSwDesde9 = 1;
     enSwMeteGrupoSubTipo = 0;
     |HAZ CtrlPedirGrupoDsArchi;

     || aqui le tengo que poner el nombre de los archivos para enviar uno y
     || despues el otro

     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\HCONTRATOS\" + aFichHuella;
     eaOrig = aAlfa;
     eaObservaciones = "Huella del contrato de trabajo";
     |HAZ Archivando;

     |SI enSwErrorRecDoc ! 1;
          aAlfa = "    Se ha archivado la huella del registro ";
          |SI aQueEs = "C";
               aAlfa = aAlfa + "del contrato de trabajo del trabajador.";
          |FINSI;
          |SI aQueEs = "P";
               aAlfa = aAlfa + "de la prórroga del trabajador.";
          |FINSI;
          |SI aQueEs = "T";
               aAlfa = aAlfa + "de la transformación del trabajador.";
          |FINSI;
          |MENAV aAlfa;
     |FINSI;
|FPRC;
*/

|PROCESO Linea;
     |QBF aAlfa;
     aCadena = aAlfa;
     |HAZ QuitaRaros;
     |SI nNivel = 1;
          aCadena = aCadena;
     |FINSI;
     |SI nNivel = 2;
          aCadena = "  " + aCadena;
     |FINSI;
     |SI nNivel = 3;
          aCadena = "  " + "  " + aCadena;
     |FINSI;
     |SI nNivel = 4;
          aCadena = "  " + "  " + "  " + aCadena;
     |FINSI;
     |SI nNivel = 5;
          aCadena = "  " + "  " + "  " + "  " + aCadena;
     |FINSI;
     |SI nNivel = 6;
          aCadena = "  " + "  " + "  " + "  " + "  " + aCadena;
     |FINSI;
     aCadena = aCadena + &13 + &10;
     aAlfa = aCadena;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO TipoID;
     |ABRE #labtraba;
     #labtraba#0 = enEmp;
     #labtraba#1 = enTra;
     |LEE 000#labtraba.=;
     |CIERRA #labtraba;

     aAlfa = eaNif; |QBF aAlfa;
     aAlfa1 = aAlfa % 0101;
     |SI aAlfa1 ] "0"; |Y aAlfa1 [ "9";
          aAlfa = "D";
     |SINO;
          |SI aAlfa1 = "X"; |O aAlfa1 = "Y"; |O aAlfa1 = "Z";
               aAlfa = "E";
          |SINO;
               aAlfa1 = #labtraba#76; |QBF aAlfa1;
               aAlfa2 = aAlfa1 % 0599; aAlfa1 = aAlfa1 % 0103;
               |SI aAlfa1 = "ESP"; |O aAlfa1 = "724"; |O aAlfa1 = "250";
                |O aAlfa1 = "276"; |O aAlfa1 = "056"; |O aAlfa1 = "442";
                |O aAlfa1 = "380"; |O aAlfa1 = "208"; |O aAlfa1 = "372";
                |O aAlfa1 = "826"; |O aAlfa1 = "300"; |O aAlfa1 = "620";
                |O aAlfa1 = "040"; |O aAlfa1 = "246"; |O aAlfa1 = "752";
                |O aAlfa1 = "233"; |O aAlfa1 = "428"; |O aAlfa1 = "440";
                |O aAlfa1 = "616"; |O aAlfa1 = "203"; |O aAlfa1 = "703";
                |O aAlfa1 = "705"; |O aAlfa1 = "348"; |O aAlfa1 = "470";
                |O aAlfa1 = "196"; |O aAlfa2 = "HOLANDA";
                    aAlfa = "U";
               |SINO;
                    aAlfa = "W";
               |FINSI;
          |FINSI;
     |FINSI;
     aTipoID = aAlfa;
|FPRC;

|PROCESO GeneraXML;
     |ABRE #labcontr;
     |LEE 000#labcontr.p;
     |CIERRA #labcontr;

     aRuta = #labcontr#51;
     |QBF aRuta;
     aAlfa = aRuta % -101;
     |SI aAlfa ! "\"; |Y aAlfa ! "/";
          aRuta = aRuta + "/";
     |FINSI;
     aRuta = aRuta + "NETCONTRATA\SOLICITUDES_ID\";
     |RMKDIR aRuta;

     aAlfa1 = enEmp; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = enTra; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;

     aFichero = aAlfa1 + "_" + aAlfa2 + "_" + eaNif + "_" + eaFechaAlta - "/" - "/";
     aFichero = aFichero + ".xml";

     aRuta = aRuta + aFichero;
     nHandle = 9;
     |XABRE "CBW", aRuta, nHandle;
     |SI FSalida ] 0;
          aFich = aRuta;

          nNivel = 1;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + " ?>";
          |HAZ Linea;

          aAlfa = "<IDENCONTRATO>";
          |HAZ Linea;

          nNivel = 2;

          |HAZ TipoID;
          aAlfa = "<TIPODOC>" + aTipoID + "</TIPODOC>";
          |HAZ Linea;

          aAlfa = "<NIF_NIE>" + eaNif + "</NIF_NIE>";
          |HAZ Linea;

          aAlfa = "<FECHA_ALTA>" + eaFechaAlta + "</FECHA_ALTA>";
          |HAZ Linea;

          nNivel = 1;
          aAlfa = "</IDENCONTRATO>";
          |HAZ Linea;
     |FINSI;
     |XCIERRA nHandle;
|FPRC;

|PROCESO CompRuta;
     aRutaSal = "";
     |QBF aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nPunt = 1; |SI nPunt [ nLon; |HACIENDO nPunt = nPunt + 1;
          nPos = (nPunt * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "/";
               aRutaSal = aRutaSal + "\";
          |SINO;
               aRutaSal = aRutaSal + aCaracter;
          |FINSI;
     |SIGUE;
     aCaracter = aRutaSal % -101;
     |SI aCaracter ! "\";
          aRutaSal = aRutaSal + "\";
     |FINSI;
     aRuta = aRutaSal;

     eaCadena = aRuta;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aRuta = eaCadenaSal;
|FPRC;

|PROCESO labhisto_act;
     |ABRE #labhisto;
     #labhisto#100 = enRegistro;
     #labhisto#103 = "  ";
     |LEE 101#labhisto.=;
     |SI FSalida = 0;
          #labhisto#163 = aIdContrata;

          |GRABA 020#labhisto.a;
          |LIBERA #labhisto;
     |FINSI;
     |CIERRA #labhisto;
|FPRC;

|PROCESO labregis_act;
     |ABRE #labregis;
     #labregis#0 = enRegistro;
     |LEE 101#labregis.=;
     |SI FSalida = 0;
          #labregis#14 = aIdContrata;
          |GRABA 020#labregis.a; |LIBERA #labregis;
     |FINSI;
     |CIERRA #labregis;
|FPRC;

|PROCESO Envio;
     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa;
     |RSYSTEM aAlfa;

     || examinamos la respuesta que nos da

     nSwEtiq = 0; aEtiqu = ""; aError = ""; nNumChars = 0;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     || examinamos la respuesta que nos da

     nSwEtiq = 0; aEtiqu = ""; aError = ""; nNumChars = 0;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     |PUSHV 12192159;
     |BLANCO 13202058;
     |CUADRO 13202058;
     |ATRI S;
     aMensa = " -- Esperando respuesta Online -- ";
     |PINTA 1422, aMensa;
     aMensa = "    Pulse ENTER para continuar    ";
     |PINTA 1522, aMensa;
     aMensa = "    después de pulsar el boton    ";
     |PINTA 1622, aMensa;
     aMensa = "     ";
     |PINTA 1722, aMensa;
     |ATRI R;
     aMensa =        "Continuar Registrando"      ;
     |PINTA 1729, aMensa;
     |ATRI 0;
     aMensa =                              "     ";
     |PINTA 1751, aMensa;
     aMensa = "                 o                ";
     |PINTA 1822, aMensa;
     aMensa = "    ";
     |PINTA 1922, aMensa;
     |ATRI R;
     aMensa =      "Finalizar Registro  Online";
     |PINTA 1926, aMensa;
     |ATRI 0;
     aMensa =                                 "  ";
     |PINTA 1954, aMensa;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
          /*
          |SINO;
               |XABRE "CE", aAlfa, nHandle; nHandle = FSalida;
               |SI nHandle ] 0;
                    |MENAV "    Encontrado";
                    |SAL;
               |FINSI;
               |XCIERRA nHandle;
          |FINSI;
          */
     |SIGUE;
     |POPV;

     aIdContrata = "";
     |XABRE "C", aAlfa, nHandle1; nHandle1 = FSalida;
     |SI FSalida ] 0;
          swAcaba = 0;
          |PARA; |SI FSalida ] 0; |Y swAcaba = 0; |HACIENDO;
               |XLEE nHandle1, 250, aAlfa;
               aAlfa = aAlfa - "<IDCONTRATO>";
               |SI FSalida ! 0;
                    || todo ha ido bien, me guardo el ID del contrato
                    aLinea = aAlfa;
                    |QBF aLinea;
                    aLinea = aLinea - "</IDCONTRATO>";
                    aIdContrata = aLinea;
                    |QBT aIdContrata;

                    |SI aIdContrata ! "";
                         aIdContrata = aIdContrata - "-" - "-" - "-";
                         |HAZ labhisto_act;
                         |HAZ labregis_act;
                         swAcaba = 1;
                    |FINSI;
               |FINSI;
/*
               aAlfa = aAlfa - "<ERRORES>";
               |SI FSalida ! 0;
                    || Ha habido errores, me los guardo
                    || A partir de aqui leo hasta encontrar la etiqueta </ERRORES>

                    |ABRE #labnct06;

                    |XLEE nHandle1, 250, aAlfa; nNumChars = FSalida;
                    swAcaba = 0;
                    |PARA; |SI nNumChars ! 0; |Y swAcaba = 0; |HACIENDO;
                         || es una de las lineas con el codigo de error

                         aAlfa = aAlfa - "</ERRORES>";
                         |QBF aAlfa;
                         aLinea = aAlfa;
                         aLinea = aLinea - "        ";
                         |SI aLinea = "";
                              swAcaba = 1;
                              |SAL;
                              || fin de las lineas de errores;
                         |SINO;
                              aLinea = aLinea - "<ERROR";
                              aCodigo = aLinea % 101;
                              aLinea = aLinea - aCodigo;
                              aAlfa = aLinea % 101;
                              |SI aAlfa ! ">";
                                   aCodigo = aCodigo + aAlfa;
                              |FINSI;
                              aLinea = aLinea - aAlfa;
                              aLinea = aLinea - (aCodigo + ". ");
                              aLinea = aLinea - ("</ERROR" + aCodigo + ">");
                              aLinea = aLinea % 180;

                              || bueno pues en teoria aqui ya tengo el numero
                              || de error y la descripcion, me quedo en principio
                              || con los primeros 80 caracteres

                              aCadena = aLinea;
                              |HAZ Tildes;
                              aLinea = aCadena;

                              #labnct06#0 = #labtmpc2#0;
                              #labnct06#1 = #labtmpc2#17;
                              #labnct06#2 = aCodigo;
                              #labnct06#3 = aLinea;
                              |GRABA 020#labnct06.n;
                              |LIBERA #labnct06;
                         |FINSI;
                         |XLEE nHandle1, 250, aAlfa; nNumChars = FSalida;
                    |SIGUE;

                    swEstado = 1;
                    |HAZ RegistroNetC_Act;
                    |HAZ labhisto_act;
                    |CIERRA #labnct06;

                    |SAL;
               |FINSI;
*/
          |SIGUE;
          |XLEE nHandle1, 250, aAlfa;
     |FINSI;
     |XCIERRA nHandle1;

     eaIdContrato = aIdContrata;

/*
     |SI #labtmpc2#23 = 0;
          |MENAV "    Fichero de respuesta NO encontrado. Proceso de envío no completado";
     |FINSI;
     |SI #labtmpc2#23 = 1;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado con errores";
     |FINSI;
     |SI #labtmpc2#23 = 2;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado correctamente";
     |FINSI;

     |XCIERRA nHandle;

     |SI #labtmpc2#23 = 2;
          |HAZ DSArchi;  || esta mas abajo, el siguiente proceso
     |FINSI;
*/
|FPRC;

|PROGRAMA;
     |HAZ GeneraXML;
     |HAZ Envio;
     ||HAZ DSArchi;
|FPRO;
