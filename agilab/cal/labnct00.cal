|FICHEROS;
     labnct21;
     labcontr;

     labnct11;
     nompanta;
     labempre;
     labclean;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nHandle = 0;
     nHandle2 = 0;
     &swSigue = 0;
     &eaVengoDe = "";
     &nOpcionSS = 0;

     {1}aContiene = "";
     aBase = "";
     aBaseLocal = "";
     aRuta = "";

     aOrigen = "";
     aDestino = "";
     aIPRemoto = "";
     aRutaOrigen = "";
     aRutaDestino = "";
     aUnidadLocal = "";
     aFicheroTgz = "";
     aAbre = "";
     nHandleTgz = 0;
     aFicheroTar = "";
     aFicheroTxt = "";
     aParam = "";

     aFicheroBAT = "";
     aFicheroBAT2 = "";
     nCanal = 0;
     aLinea = "";
     nNume = 0;
     FEstado = 0;
     aDescarga = "";
     nHandleDes = 0;
     nHandleSize = 0;
     nBytes = 0;
     nTama¤oZip = 118000000;
     nProgreso = 0;
     nProgresoAnt = 0;
     nPorcentaje = 0;
     aProgreso = "";

     aSize = "";
     nPaso = 0;
     nPasoLim = 0;
     swSal = 0;

     &eaCadena = "";
     &eaCadenaSal = "";
     aLongitud = "";
     nLongitud = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";
     nNume1 = 0;
     nNume2 = 0;

     aFinal = "";
     nHandleFin = 0;
     swGeconet = 0;
     aCif = "";
     swAnuncio = 0;
     &eaDSMAC = "";
     swTecla = 0;

     aIP = "";
     aAlfaX = "";
     nCalc = 0;

     swAginom = 0;
     swIplabor2 = 0;

     aHora = "";
     aHor = "";
     aMin = "";
     aSeg = "";
     aHoraFin = "";
     nHor = 0;
     nMin = 0;
     nSeg = 0;
     swRespuesta = 0;
     aRespuesta = "";
     &swNuevo = 0;
     aPrueba = "";
     nHandleRes = 0;
|FIN;

|PROCESO NetContrata;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa1 = aAlfa % -101;
     |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
          aAlfa = aAlfa + "\";
     |FINSI;
     aAlfa = aAlfa + "rdn.exe";

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          aAlfa = "    No es posible realizar el envío. El módulo para envíos online no se ha instalado.";
          |MENAV aAlfa;
          aAlfa = "    Consulte al departamento de atención al cliente de Diagram Software, S.L.";
          |MENAV aAlfa;
          |ERROR;
          swSigue = 0;
          |XCIERRA nHandle;
          |ACABA;
     |SINO;
          swSigue = 1;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO BuscaCIF;
     aAlfa = #labcontr#62;
     |QBF aAlfa;
     aCif = aAlfa;
     |SI aAlfa ! "";
          || HABIA CIF, PUEDE QUE USARAN NETCONTRATA
          aAlfa = #labcontr#63; |QBF aAlfa;
          aAlfa1 = aAlfa % -101;
          |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
               aAlfa = aAlfa + "\";
          |FINSI;
          aAlfa = aAlfa + "datos\usuarios.dbf";
          |XABRE "CE", aAlfa, nHandle;
          |SI FSalida < 0;
               || NO ENCUENTRO INSTALACION DE NETCONTRATA, HAY QUE EMPEZAR DE CERO
               || puede que sea un usuario completamente nuevo
               || o a lo mejor es alguien que

          |SINO;
               || TENGO INSTALACION DE NETCONTRATA

               aOrigen = aAlfa;

               aDestino = aBase + "fich/usu_netc.dbf";

               |IP_REMOTO aIPRemoto;
               |SI aIPRemoto ! "";
                    |RECIBE_FICHERO aOrigen, aDestino;
               |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
               |FINSI;

               |SI FSalida ] 0;
                    aOrigen = aDestino;
                    aDestino = aBaseLocal + "conectass\Datos\usuarios.dbf";
                    |SI aIPRemoto ! "";
                         |ENVIA_FICHERO aOrigen, aDestino;
                    |SINO;
                         |COPIA_FICHERO aOrigen, aDestino;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || NO HABIA CIF, INSTALACION COMPLETAMENTE NUEVA

          |PINPA #0#labnct11;
          |PINDA #0#labnct11;
          |ENDATOS #1#labnct11;
          |SI FSalida = 0;
               aCif = #labnct11#0;
               |QBF aCif;
               |SI aCif ! "";
                    |ABRE #labcontr;
                    |LEE 000#labcontr.p;
                    #labcontr#62 = aCif;
                    |GRABA 020#labcontr.a;
                    |LIBERA #labcontr;
                    |CIERRA #labcontr;
               |SINO;
                    aAlfa = "    ATENCION. Es necesario indicar el CIF/NIF del autorizacion Contrat@";
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
          |SI aCif ! "";
               aAlfa = "    A continuación se procederá al alta de nuevo usuario ConectaSS";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SizeBAT;
     aAlfa = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsmini.exe";
     aAlfa = aDestino + " " + aFicheroBAT2;
     |RSYSTEM aAlfa;

     |XABRE "C", aSize, nHandleSize;
     swSal = 0;
     || nBytes = 0;
     |PARA; |SI swSal = 0; |HACIENDO;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida < 0;
               swSal = 1;
          |FINSI;
          |QBF aLinea;
          aAlfa = aLinea;
          aAlfa = aLinea - "conectass.zip";
          |SI aAlfa ! aLinea;
               |QBF aAlfa;
               aAlfa = aAlfa % -110;
               |QBT aAlfa;
               nBytes = aAlfa;
               swSal = 1;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandleSize;
|FPRC;

|PROCESO PintaProgreso2;
     aFicheroBAT2 = aBaseLocal + "downsize.bat";
     |RFBORRA aFicheroBAT2;
     aAlfa = aBaseLocal + "size.txt";
     |RFBORRA aAlfa;
     |XABRE "CBW", aFicheroBAT2, nCanal;
     |SI FSalida ] 0;
          aLinea = "@echo off" + &13 + &10;
          |XGRABA nCanal, aLinea;
          aLinea = "dir /-c " + aBaseLocal + "conectass.zip > " + aBaseLocal + "size.txt";
          aLinea = aLinea + &13 + &10;
          |XGRABA nCanal, aLinea;
     |FINSI;
     |XCIERRA nCanal;

     aSize = aBaseLocal + "size.txt";
     |PINTA 1420, "³                                      ³"

     |PARA; |SI FEstado < 0; |HACIENDO;
          |XABRE "EC", aFinal, nHandleFin;
          FEstado = FSalida;

          nPaso = nPaso + 1;
          |SI nPaso > nPasoLim;
               nPaso = 0;

               |HAZ SizeBAT;

               nPorcentaje = ((nBytes / nTama¤oZip) * 100) ! 0;
               aAlfa1 = nPorcentaje;
               aAlfa1 = ("   " + aAlfa1) % -103;
               aAlfa1 = aAlfa1 + " % Completado";
               |PINTA 1432, aAlfa1;
               |PULSATECLA;

               nNume = nBytes;
               nNume = nNume / 2139000;
               nNume = nNume ! 0;
               nProgreso = nNume;
               |SI nProgreso > nProgresoAnt;
                    aProgreso = aProgreso + " ";
                    |ATRI R;
                    |PINTA 1522, aProgreso;
                    |ATRI 0;
                    nProgresoAnt = nProgreso;
                    |PULSATECLA;
               |FINSI;
          |FINSI;
          |PULSATECLA;
     |SIGUE;
     aProgreso = "                                    ";
     |ATRI R;
     |PINTA 1522, aProgreso;
     |ATRI 0;
     |PINTA 1420, "³   Descarga completada. Instalando.   ³"
     |PULSATECLA;
|FPRC;

|PROCESO PintaProgreso;
     |PARA; |SI FEstado < 0; |HACIENDO;
          |XABRE "EC", aFinal, nHandleFin;
          FEstado = FSalida;

          nNume = nNume + 1;
          |SI nNume > 3000; |Y FEstado < 0;
               nNume = 0;
               aProgreso = aProgreso + " ";
               |ATRI R;
               |PINTA 1522, aProgreso;
               |ATRI 0;
               |SI aProgreso = "                                    ";
                    |PINTA 1522, aProgreso;
                    aProgreso = "";
               |FINSI;
               |PULSATECLA;
          |FINSI;
          |PULSATECLA;
     |SIGUE;
|FPRC;

|PROCESO EnviaFichero;
   aIP = ""; |IP_REMOTO aIP;
   aContiene = "";
   |ESPECIFICA "RBASS", aContiene;
   aAlfaX = aContiene1;
   aAlfaX = aAlfaX - "\";
   |SI FSalida ! 0;
      nCalc = ((FSalida / 100) ! 0) + 99;
      aAlfaX = aAlfaX % nCalc;
   |SINO;
      aAlfaX = aAlfaX - "/";
      |SI FSalida ! 0;
         nCalc = ((FSalida / 100) ! 0) + 99;
         aAlfaX = aAlfaX % nCalc;
      |FINSI;
   |FINSI;
   aUnidadLocal = aAlfaX;

   aAlfaX = aUnidadLocal + "/DOCUMENTOS/";
   |SI aIP = ""; |MKDIR aAlfaX; |SINO; |RMKDIR aAlfaX; |FINSI;
   aAlfaX = aAlfaX + "TMP/";
   |SI aIP = ""; |MKDIR aAlfaX; |SINO; |RMKDIR aAlfaX; |FINSI;
   aAlfaX = aAlfaX + "PARAMCOPIA.TXT";
   |XABRE "CW", aAlfaX, nHandle;
   |SI FSalida ] 0;
      aAlfa1 = aOrigen  + &13 + &10; |XGRABA nHandle, aAlfa1;
      aAlfa1 = aDestino + &13 + &10; |XGRABA nHandle, aAlfa1;
      |XCIERRA nHandle;

      |SI swIplabor2 = 1;
           aAlfa1 = "|:laboral/nomca8zc.tab;" + aAlfaX;
      |FINSI;
      |SI swAginom = 1;
           aAlfa1 = "|:aginom/nomca8zc.tab;" + aAlfaX;
      |FINSI;
      |SUB_EJECUTA aAlfa1;

      |XABRE "C", aAlfaX, nHandle;
      |SI FSalida ] 0;
         |XLEE nHandle, 254, aAlfa1;
         |XCIERRA nHandle;
         FSalida = aAlfa1;
      |SINO;
         aAlfa1 = "-1";
         FSalida = aAlfa1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Descarga;
     aFicheroTgz = "conectass.tgz"
     aFicheroTar = "conectass.tar"
     aFinal = "conectass/rdn.exe";
     aRutaDestino = aBaseLocal;

     aAlfa = aBaseLocal + "conectass.tar";
     |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "conectass.tgz";
     |RFBORRA aAlfa;

     |DBASE aBase;
     aOrigen = aBase + "ejecutables/conectass.tgz";
     aDestino = aBaseLocal + "conectass.tgz";
     |HAZ EnviaFichero;

     |XABRE "EC", aDestino, nHandleTgz;
     |SI FSalida < 0;
          |MENAV "    No se ha podido descargar el instalador";
          |ACABA;
     |FINSI;


     |PUSHV 05012380;
     |ATRI R;
     |PINTA 1220, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿";
     |PINTA 1320, "³         Descarga finalizada          ³";
     |PINTA 1420, "³        Instalando ConectaSS.         ³";
     |PINTA 1520, "³   Por favor, espere unos segundos.   ³";
     |PINTA 1620, "³                                      ³";
     |PINTA 1720, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";
     |ATRI 0;

     aAlfa = aDestino;
     |RDESCOMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTar;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |RDETAR aAbre, aRutaDestino;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFinal;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |SLEEP 5;
     |POPV;

     aAlfa = aBaseLocal + "conectass.tar";
     |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "conectass.tgz";
     |RFBORRA aAlfa;
|FPRC;

|PROCESO SegundaParte;
     aAlfa = "    La primera parte de la instalación se ha completado.";
     aAlfa = aAlfa + " Puede que se requiera algún componente adicional";
     |MENAV aAlfa;
     aAlfa = "    Se instalarán los componentes nece- sarios ";
     aAlfa = aAlfa + "para completar la instalación. Pulse 'Siguiente' ";
     aAlfa = aAlfa + "cuando se requiera.";
     |MENAV aAlfa;

     |ABRE #labempre;
     |LEE 000#labempre.p;
     aAlfa1 = #labempre#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = "00001";        || centro 1
     aAlfa = "labnct07;"+ "19" + aAlfa1 + aAlfa2;
     |CIERRA #labempre;

     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO DescargaInternet;
     aAlfa = aBaseLocal + "conectass.zip";
     |RFBORRA aAlfa;

     aRutaOrigen = aBase + "ejecutables/"
     aRutaDestino = aUnidadLocal + "\DOCUMENTOS\"
     aFicheroTgz = "dsdownlo.tgz"
     aFicheroTar = "dsdownlo.tar"
     aFicheroTxt = "dsdownlo\LEEME.txt";

     aOrigen = aRutaOrigen + aFicheroTgz;
     aDestino = aRutaDestino + aFicheroTgz;

     |RFBORRA aDestino;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTgz;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     Pos   = -1;
     aAlfa = aRutaDestino + aFicheroTgz;
     |RDESCOMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTar;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |RDETAR aAbre, aRutaDestino;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTxt;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaDestino + aFicheroTgz;  |RFBORRA aAlfa;
     aAlfa = aRutaDestino + aFicheroTar;  |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "conectass.zip"; |RFBORRA aAlfa;

     aAlfa = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsdownloader.exe ";
     aAlfa = aAlfa + "-u http://basprog.diagram.es/master9/Externos/conectass/conectass.zip -c ";
     aAlfa = aAlfa + aBaseLocal;

     aFicheroBAT = aUnidadLocal + "\DOCUMENTOS\dsdownlo\" + "descarga.bat";
     |RFBORRA aFicheroBAT;
     |XABRE "CBW", aFicheroBAT, nCanal;
     |SI FSalida ] 0;
          aLinea = "@echo off" + &13 + &10;
          |XGRABA nCanal, aLinea;
          aLinea = aAlfa + &13 + &10;
          |XGRABA nCanal, aLinea;
     |FINSI;
     |XCIERRA nCanal;

     aOrigen = aBase + "ejecutables/dsmini.exe";
     aDestino = aUnidadLocal + "\DOCUMENTOS\dsdownlo\dsmini.exe";
     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aAlfa = aDestino + " " + aFicheroBAT;

     |RSYSTEM aAlfa;

     |PINTA 1220, "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿";
     |PINTA 1320, "³                                      ³"
     |PINTA 1420, "³                                      ³"
     |PINTA 1520, "³                                      ³"
     |PINTA 1620, "³                                      ³"
     |PINTA 1720, "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ"
     |ATRI R;
     |PINTA 1328,        " Descargando ConectaSS ";
     |ATRI 0;

     nNume = 0;
     aFinal = aBaseLocal + "conectass/rdn.exe";
     aDescarga = aBaseLocal + "conectass.zip";
     nProgreso = 0;
     nProgresoAnt = 0;
     FEstado = -1;

     |HAZ PintaProgreso2;

     |XCIERRA nHandleFin;

     |POPV;

     |SLEEP 5;
     aAlfa = aBaseLocal + "conectass.zip"; |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "downsize.bat"; |RFBORRA aAlfa;
     aAlfa = aBaseLocal + "size.txt"; |RFBORRA aAlfa;
|FPRC;


|PROCESO ConectaSS;
     |DBASE aBase;

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;

     eaCadena = aBaseLocal;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aBaseLocal = eaCadenaSal;

     aUnidadLocal = aBaseLocal % 102;

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     aAlfa = aBaseLocal + "conectass\rdn.exe";

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          || NO EXISTE conectass
          || hay que descargarse el programa.

          ||HAZ Descarga;
          |HAZ DescargaInternet;
          |HAZ SegundaParte;
          |HAZ BuscaCIF;

          aCif = "";     || para que devuelva swSigue = 0 y no haga nada
                         || hasta la siguiente vez que se ejecute
     |SINO;
          || SI QUE EXISTE conectass

          || adelante pues

          || por si no hubieran llegado a meter el CIF

          aAlfa = #labcontr#62;
          |QBF aAlfa;
          aCif = aAlfa;
          |SI aAlfa = "";
               |HAZ BuscaCIF;
          |FINSI;
     |FINSI;

     |XCIERRA nHandle;
|FPRC;

|PROCESO Mensaje;
     swAnuncio = 0;

     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;
     aAlfa = aBaseLocal + "conectass\rdn.exe";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          |XCIERRA nHandle;
          |ACABA;
     |FINSI;
     |XCIERRA nHandle;

     |HAZ CogeMac;

     |ABRE #labnct21;
     #labnct21#0 = eaDSMAC;
     #labnct21#1 = 0001;
     |LEE 101#labnct21.=;
     |SI FSalida ! 0
          #labnct21#0 = eaDSMAC;
          #labnct21#1 = 0001;
          #labnct21#2 = 1;              || visto la primera vez
          |GRABA 020#labnct21.n;
          swAnuncio = 1;
     |SINO;
          |SI #labnct21#2 = 0;
               #labnct21#1 = 1;         || visto por primera vez
               swAnuncio = 1;           || aunque estaba guardado el registro
               |GRABA 020#labnct21.a;
          |FINSI;
     |FINSI;
     |LIBERA #labnct21;

     |SI swAnuncio = 1;
          |PUSHV 05012380;
          |PINPA #6#nompanta;
          |PAUSA;
          swTecla = FSalida;
          |SI swTecla = 1;
               #labnct21#0 = eaDSMAC;
               #labnct21#1 = 0001;
               |LEE 101#labnct21.=;
               #labnct21#2 = 0;              || visto la primera vez
               |GRABA 020#labnct21.a;
          |FINSI;
          |POPV;
     |FINSI;

     |LIBERA #labnct21;
     |CIERRA #labnct21;
|FPRC;

|PROCESO Version;
     |DBASE aAlfa;
     aAlfa1 = aAlfa - "aginom";
     |SI aAlfa ! aAlfa1;
          swAginom = 1;
     |SINO;
          swIplabor2 = 1;
     |FINSI;
|FPRC;

|PROCESO IniciaCampo;
     |ABRE #labclean;
     #labclean#0 = "labcontr";
     #labclean#1 = 6;
     |LEE 101#labclean.=;
     |SI FSalida ! 0;
          #labclean#0 = "labcontr";
          #labclean#1 = 6;
          #labclean#2 = "S";
          |GRABA 020#labclean.n;

          |ABRE #labcontr;
          |LEE 101#labcontr.p;
          #labcontr#6 = 0;
          |GRABA 020#labcontr.a;
          |LIBERA #labcontr;
          |CIERRA #labcontr;
     |FINSI;
     |CIERRA #labclean;
     |LIBERA #labclean;
|FPRC;

|PROCESO CompRespuesta;
     || esperamos 10 segundos

     |HORA aHora;
     aPrueba = aHora;
     |QBF aHora;
     aHor = aHora % 102;
     aMin = aHora % 402;
     aSeg = aHora % 702;

     aHoraFin = "";
     nHor = aHor;
     nMin = aMin;
     nSeg = aSeg;

     nSeg = nSeg + 10;
     |SI nSeg > 59;
          nSeg = nSeg - 60;
          nMin = nMin + 1;
          |SI nMin = 60;
               nMin = 00;
               nHor = nHor + 1;
               |SI nHor = 24;
                    nHor = 00;
               |FINSI;
          |FINSI;
     |FINSI;

     aHor = nHor; aHor = ("00" + aHor) % -102;
     aMin = nMin; aMin = ("00" + aMin) % -102;
     aSeg = nSeg; aSeg = ("00" + aSeg) % -102;
     aHoraFin = aHor + ":" + aMin + ":" + aSeg;
     |QBF aHoraFin;
     aAlfa = aUnidadLocal + "\DOCUMENTOS\estado_conectass.txt";

     || el labclean !!!

     |HAZ IniciaCampo;

     |SI #labcontr#6 ! 0;
          nNume = #labcontr#6;
          |SLEEP nNume;
     |FINSI;

     |PARA; |SI aHora ! aHoraFin; |HACIENDO;
          |HORA aHora;
          |QBF aHora;

          |XABRE "C", aAlfa, nHandleRes;
          |SI FSalida ] 0;
               |XLEE nHandleRes, 20, aAlfa1;
               |QBF aAlfa1;
               aHora = aHoraFin;   || para que se salga, ya tengo respuesta
          |FINSI;
          |XCIERRA nHandleRes;
     |SIGUE;

     |SI aAlfa1 = "ACTIVADO";
          swRespuesta = 0;
     |SINO;
          |SI aAlfa1 = "DESACTIVADO";
               swRespuesta = 1;
          |SINO;
               swRespuesta = 2;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     aParam = "conectass";
     |QBF aParam;

     |HAZ Version;

     swSigue = 0;
     swGeconet = 0;

     || provisional
/*
     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;
     aAlfa = aBaseLocal + "conectass.txt";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          swSigue = 1;
     |FINSI;
     |XCIERRA nHandle;
*/

     || definitivo
     |ESPECIFICA "RBASS", aContiene;
     aBaseLocal = aContiene1;
     |QBF aBaseLocal;
     aAlfa = aBaseLocal + "netcontrata.txt";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida ] 0;
          aParam = "netcontrata";
     |SINO;
          swSigue = 1;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa1 = aBaseLocal;
     aAlfa2 = aBaseLocal - "geconet";
     |SI aAlfa1 ! aAlfa2;
          swGeconet = 1;
          nPasoLim = 2;
     |SINO;
          swGeconet = 0;
          nPasoLim = 2000;
     |FINSI;

     |SI aParam = "conectass"; |Y swSigue = 1;
          swTecla = 0;
          |HAZ Mensaje;

          |SI swTecla = 1;
               swSigue = 0;
               |ACABA;
          |FINSI;

          |HAZ ConectaSS;
          |SI aCif ! "";
               swSigue = 2;
               |HAZ EnvioRegConectaSS;

               |SI swNuevo = 0;
                    || si swNuevo = 0 es cuando tengo en entrar
                    || en los nuevos no compruebo nada
                    swRespuesta = 2;
                    |HAZ CompRespuesta;

                    |SI swRespuesta = 1;
                         |MENAV "    Acceso a ConectaSS inactivo. Por favor, contacte con el servicio técnico";
                         swSigue = 0;
                    |FINSI;
                    |SI swRespuesta = 2;
                         |MENAV "    Se ha producido un error en la comunicación. Por favor, vuelva a intentarlo más tarde";
                         swSigue = 0;
                    |FINSI;
               |FINSI;
          |SINO;
               swSigue = 0;
          |FINSI;
     |SINO;
          |HAZ NetContrata;
     |FINSI;
|FPRO;
