|FICHEROS;
     pdfimtmp #100;
     pdfcontr;
     labcontr;
     nomcontr;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aLinea = "";
     nLinea = 0;
     aValor = "";
     aCampo = "";
     &aArchivo = "";
     aArchivoPDF = "";
     aArchivoFDF = "";
     aPathLocPDF = "";
     aPathSerPDF = "";
     aPathLocFDF = "";
     aPathSerFDF = "";
     aPathReader = "";
     aPathDestino = "";
     &aID = "";
     aOrigen = "";
     aDestino = "";
     nCanal = 0;
     aSystem = "";
     aDirBase = "";
     aLongitud = "";
     nLongitud = "";
     aCaracter = "";
     aCaracterSal = "";
     aCadena = "";
     aCadenaSal = "";
     nPos = 0;
     nBusca = 0;
     nAscii = 0;

     &enWeb = 0;
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     &eaWebDirPDF = "";
     nTipo = 0;
     aIP = "";
     &swCopia = 0;
     &aProcedencia = "";
     &aListaFich = "";
     &swDondeEstoy = 0;
     aUsuario = "";
     &nTipoSalida = 0;
     &nTipoImpre = 0;
     &nNroCopias = 0;
     aParametros = "";
     i = 0;
     aFicheroBAT = "";
     &aVengoDe = "";
     aMiCaracter = "";
     nCaracter = 0;
     nPorDonde = 0;
     aEjecutable = "";
     aUnidad = "";
     aMatador = "";
     aElUltimo = "";
     aElUltimo2 = "";
     aListaTmp = "";
     nPosicion = 0;
     aPosicion = "";
     &swAvisado = 0;
     {1}aContiene = "";
     aBusca = "";
     aCambia = "";
|FIN;

|PROCESO control;
     |ABRE #labcontr;
     |LEE 000#labcontr.p;
     |CIERRA #labcontr;
|FPRC;

|PROCESO sustituye;
     || aCadena es la cadena a buscar un caracter
     || aBusca es el caracter a buscar
     || aCambia es por el que lo queremos cambiar

     aCadenaSal = "";
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nBusca = (nPos * 100) + 1;
          aCaracter = aCadena % nBusca;
          |SI aCaracter = aBusca;
               aCadenaSal = aCadenaSal + aCambia;
          |SINO;
               aCadenaSal = aCadenaSal + aCaracter;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CargaInicial;
     |DBASE aDirBase;
     aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)
     aPathLocFDF = "C:\ds\spoolpdf\";  || aqui va la plantilla y el FDF local
     aPathSerPDF = aDirBase + "pdf/";  || aqui van todas las plantillas PDF
     aPathSerFDF = aDirBase + "fich/"; || aqui va el FDF en el servidor

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aPathDestino = aContiene1;
     |QBF aPathDestino;
     aPathDestino = aPathDestino + "spoolpdf/";
     |RMKDIR aPathDestino;       || lo creo primero de nada, por si no hubiera

     aPathLocFDF = aPathDestino;  || aqui va la plantilla y el FDF local
     || aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)

     aCadena = aPathDestino;
     aBusca = "\";
     aCambia = "/";
     |HAZ sustituye;
     aCadena = aCadenaSal;
     aBusca = ":";
     aCambia = "";
     |HAZ sustituye;
     aPathLocPDF = aCadenaSal;
     aPathLocPDF = "/" + aPathLocPDF;

     |SI #labcontr#65 = 0;    || como siempre
          aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)
          aPathLocFDF = "C:\ds\spoolpdf\";  || aqui va la plantilla y el FDF local
     |FINSI;
|FPRC;

|PROCESO BuscaMata;          || ME TRAIGO EL mata.exe DEL SERVIDOR A LOCAL
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "pdf/mata.exe";
     aDestino = "C:\ds\spoolpdf\mata.exe";
     |QBF aOrigen;
     |QBF aDestino;
     ||XABRE "CE", aDestino, nCanal;
     ||SI FSalida < 0;         || FSalida = 0: no existe el mata.exe en C:\ds\spoolpdf
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     ||FINSI;
     aMatador = aDestino;
     ||XCIERRA nCanal;
|FPRC;

|PROCESO BuscaRuta;
     |ABRE #pdfcontr;
     aIP = "";
     |IP_REMOTO aIP;
     |QBF aIP;
     #pdfcontr#0 = aIP;
     |LEE 000#pdfcontr.=;
|FPRC;

|PROCESO BuscaCaracter;
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nCaracter = ((nPos * 100) + 1) * nPorDonde;
          aCaracter = aCadena % nCaracter;
          |SI aCaracter = aMiCaracter;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROGRAMA;
     |SI enWeb = 0;
          |HAZ control;
          |HAZ BuscaRuta;
          |HAZ CargaInicial;
          |HAZ BuscaMata;
          aPathReader = #pdfcontr#1;
          |QBF aPathReader;
          |SI nTipoSalida = 0;                    || Solo Vista Previa
               aParametros = "";
               nNroCopias = 1;
          |FINSI;
          |SI nTipoSalida = 1;                    || Impresion
               |SI nTipoImpre = 1;
                    aParametros = " /p";            || Muesta cuadro impresion
                    nNroCopias = 1;
               |SINO;
                    aParametros = " /h /p /n";         || Impresora por defecto
                    nNroCopias = nNroCopias;
               |FINSI;
          |FINSI;

          aCadena = aPathReader;
          aMiCaracter = "\";
          nPorDonde = -1;
          |HAZ BuscaCaracter;
          nPos = nPos -1;
          nPos = nPos + 100;
          nPos = (-1) * nPos;
          aEjecutable = aPathReader % nPos;
          aPathReader = aPathReader - aEjecutable;
          |SI #labcontr#65 = 0;    || como siempre
               aPathDestino = aPathReader;
          |FINSI;

          /* |SI nTipoSalida = 1;               || el ultimo fichero pasa a lla-
               aAlfa = aListaFich % -108;    || marse "no.fdf" porque es nece-
               aAlfa = aAlfa - &34;          || sario para el mata.exe
               aAlfa = aAlfa - &34;
               aElUltimo = aPathReader + aAlfa;
               aElUltimo2 = aPathReader + "no.fdf";
               |RCOPIA_FICHERO aElUltimo, aElUltimo2;
               aAlfa = &34 + aAlfa + &34;
               aListaFich = aListaFich - aAlfa;
               aListaFich = aListaFich + &34 + "no.fdf" + &34;
          |FINSI;
          */
          aDestino = "start " + aEjecutable + aParametros + aListaFich;
          aFicheroBAT = aPathLocFDF + Usuario + ".bat";
          |XABRE "CBW", aFicheroBAT, nCanal;
          |SI FSalida ] 0;
               aAlfa = "@echo off" + &13 + &10;
               |XGRABA nCanal, aAlfa;
               || aUnidad = aPathReader % 102;
               aUnidad = aPathDestino % 102;
               aAlfa = aUnidad + &13 + &10;
               |XGRABA nCanal, aAlfa;
               || aAlfa = "cd " + &34 + aPathReader + &34 + &13 + &10;
               aAlfa = "cd " + &34 + aPathDestino + &34 + &13 + &10;
               aAlfa = aAlfa - aUnidad;

               aCadena = aAlfa; aBusca = "/"; aCambia = "\";
               |HAZ sustituye;
               aAlfa = aCadenaSal;

               |XGRABA nCanal, aAlfa;

               |SI #labcontr#65 = 0;    || como siempre
                    aAlfa = "start " + aEjecutable + aParametros;
                    |XGRABA nCanal, aAlfa;
                    |PARA i = 1; |SI i [ nNroCopias; |HACIENDO i = i + 1;
                         aAlfa = aListaFich;
                         |XGRABA nCanal, aAlfa;
                    |SIGUE;
                    |SI nTipoSalida ! 0;
                         aAlfa = " " + &34 + "no.pdf" + &34;
                         |XGRABA nCanal, aAlfa;
                    |FINSI;
                    aAlfa = &13 + &10;
                    |XGRABA nCanal, aAlfa;
               |SINO;
                    |PARA i = 1; |SI i [ nNroCopias; |HACIENDO i = i + 1;
                         aListaTmp = aListaFich;
                         aListaTmp = aListaTmp - " ";
                         |QBF aListaTmp;
                         |PARA; |SI aListaTmp ! ""; |HACIENDO;
                              aListaTmp = aListaTmp - " ";
                              aPosicion = FSalida;
                              |SI FSalida ! 0;
                                   aPosicion = ("0000" + aPosicion) % -104;
                                   aPosicion = aPosicion % 102;
                                   nPosicion = aPosicion;
                                   nPosicion = nPosicion - 1;
                                   nPosicion = nPosicion + 100;
                                   aAlfa = aListaTmp % nPosicion;
                              |SINO;
                                   aAlfa = aListaTmp;
                              |FINSI;

                              aAlfa = aAlfa - &34 - &34;
                              aAlfa = "start " + aAlfa;
                              |XGRABA nCanal, aAlfa;
                              aAlfa = aAlfa - "start ";

                              aListaTmp = aListaTmp - &34 - aAlfa - &34;

                              aAlfa = &13 + &10;
                              |XGRABA nCanal, aAlfa;

                              |QBF aListaTmp;
                         |SIGUE;
                         |XGRABA nCanal, aAlfa;
                    |SIGUE;
               |FINSI;

               |SI nTipoSalida ! 0;
                    aAlfa = aMatador + &13 + &10;
                    |XGRABA nCanal, aAlfa;
               |FINSI;
          |FINSI;
          |XCIERRA nCanal;

          |RSYSTEM aFicheroBAT;
          aAlfa = aPathSerFDF + aArchivoFDF;
          |FBORRA aAlfa;
          aListaFich = "";
          |CIERRA #pdfcontr;
     |FINSI;
|FPRO;
