|FICHEROS;
     labere10 #0;
     labere12 #12,MANTE;

     labtraba;
     labempre;
     labmunic;
     labcentr;

     labere13 #20,MANTE;
     labere14;

     ||xmlereca;
     ||xmlereli;
     xmlarbre #100;

     xmlerezz #200;
     labcontr;

     labtrtra #150;
|FIN;

|VARIABLES;
     aLong = "";
     nLong = 0;
     aAuxDos = "";
     nNumero = 0;
     aTab = "";
     aTextoTab = "";
     nHandle = 0;
     aFicheroXML = "";
     aRuta = "";

     aHoraDesde = "";
     aHoraHasta = "";

     aFecha = "";
     aDia = "";
     aMes = "";
     aAny = "";

     nRegistroXML = "";
     aValor = "";
     aTipo = "";

     aAux = "";
     aDefDatos = "";
     nNumCampoDef = 0;

     aEtiqueta = "";
     nSwPrimeraEmpresa = 1;   ||Nos indica que estamos en la primera empresa.  Debe de leerla
     nEmpresaActual = 0;
     nProximaEmpresa = 0;
     nSwContinua = 0;

     aVoyEntidad = "";
     nRepeCentro = 0;
     nRepeTraba = 0;
     nRepeCalen = 0;

     aAlfa1 = "";
     aNombreRepre = "";
     &aCadena = "";
     &eaNom   = "";
     &eaApel1 = "";
     &eaApel2 = "";

     aCP = "";
     aDomicilio = "";
     aNumero = "";
     aPiso = ""
     aDireccion = "";
     aMensaje = "";
     nModo = 0;
     nModoLin = 0;
     &swAlgo = 0;

     fFechaAlta = @;
     fFechaBaja = @;
     fFechaIni = @;
     fFechaFin = @;

     aEmpresa = "";
     aCampanya = "";
     nPrimerTra = 0;

     ||Variables para la emision XML
     aObligatorio = "";
     swHayHijos = 0;
     aVengoDe = "";
     aEntComp = "";
     nContador = 0;
     aAlfa = "";
     aEntidad = "";
     nNume1 = 0;
     nNivel = 0;
     nElemento = 0;
     nPrimerDig = 1;
     aBlanco = " ";
     nBlancos = 0;
     aNivel = "";
     aNivel2 = "";
     nLongitud = 0;
     aLongitud = "";
     nCorta = 0;
     nCorta1 = 0;
     nCorta2 = 0;
     aParte1 = "";
     aParte2 = "";
     nNivel2 = 0;

     i = 0;
     j = 0;
     k = 0;
     swACero = 0;
     nValor = 0;
     nCampo = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     aAntCCCCentro = "";
     aAlfa2 = "";

     nEmpresa = 0;
     aExpediente = "";
     nCopiaEnvio = 0;
     nEnvioActual = 0;
     nUltEnvio = 0;
     aDescripcion = "";

     aCampo3 = ""; aCampo4 = ""; aCampo5 = ""; aCampo6 = "";
     aCampo7 = ""; aCampo8 = ""; aCampo9 = "";

     fCampo10 = @; fCampo11 = @; fCampo12 = @; fCampo13 = @;

     aCampo14 = ""; aCampo15 = ""; aCampo16 = ""; aCampo17 = "";
     aCampo18 = ""; aCampo19 = ""; aCampo20 = ""; aCampo21 = "";
     aCampo22 = ""; aCampo23 = "";

     fCampo24 = @; fCampo25 = @;
|FIN;

|PROCESO Lineas;
     #labere12#2 = nEnvioActual;
     |GRABA 000#labere12.n;
|FPRC;

|DEFBUCLE Lineas;
     #labere12#1;
     ;
     nEmpresa, aExpediente, nCopiaEnvio, 00001;
     nEmpresa, aExpediente, nCopiaEnvio, 99999;
     be;
     NULL, Lineas;
|FIN;

|PROCESO TraeLineas;
     |BUCLE Lineas;
|FPRC;

|PROCESO TraeExpediente;
     |SALVA_FICHA #labere10;
     #labere10#0 = nEmpresa;
     #labere10#1 = aExpediente;
     #labere10#2 = nCopiaEnvio;
     |LEE 000#labere10.=;
     |SI FSalida = 0;
          aCampo3 = #labere10#3;
          aCampo4 = #labere10#4;
          aCampo5 = #labere10#5;
          aCampo6 = #labere10#6;
          aCampo7 = #labere10#7;
          aCampo8 = #labere10#8;
          aCampo9 = #labere10#9;
          fCampo10 = #labere10#10;
          fCampo11 = #labere10#11;
          fCampo12 = #labere10#12;
          fCampo13 = #labere10#13;
          aCampo14 = #labere10#14;
          aCampo15 = #labere10#15;
          aCampo16 = #labere10#16;
          aCampo17 = #labere10#17;
          aCampo18 = #labere10#18;
          aCampo19 = #labere10#19;
          aCampo20 = #labere10#20;
          aCampo21 = #labere10#21;
          aCampo22 = #labere10#22;
          aCampo23 = #labere10#23;
          fCampo24 = #labere10#24;
          fCampo25 = #labere10#25;
     |FINSI;
     |REPON_FICHA #labere10;

     #labere10#3 = aCampo3;
     #labere10#4 = aCampo4;
     #labere10#5 = aCampo5;
     #labere10#6 = aCampo6;
     #labere10#7 = aCampo7;
     #labere10#8 = aCampo8;
     #labere10#9 = aCampo9;
     #labere10#10 = fCampo10;
     #labere10#11 = fCampo11;
     #labere10#12 = fCampo12;
     #labere10#13 = fCampo13;
     #labere10#14 = aCampo14;
     #labere10#15 = aCampo15;
     #labere10#16 = aCampo16;
     #labere10#17 = aCampo17;
     #labere10#18 = aCampo18;
     #labere10#19 = aCampo19;
     #labere10#20 = aCampo20;
     #labere10#21 = aCampo21;
     #labere10#22 = aCampo22;
     #labere10#23 = aCampo23;
     #labere10#24 = fCampo24;
     #labere10#25 = fCampo25;

     || y los datos de la cabecera
     #0#0 = nEmpresa;
     #0#1 = aExpediente;
     #0#2 = nEnvioActual;
     #0#26 = aDescripcion;

     |PINDA #0#labere10;
|FPRC;

|PROCESO maxexp;
     #labere10#0 = nEmpresa;
     #labere10#1 = aExpediente;
     #labere10#2 = nUltEnvio;
|FPRC;

|PROCESO minexp;
     #labere10#0 = nEmpresa;
     #labere10#1 = aExpediente;
     #labere10#2 = 1;
|FPRC;

|PROCESO CopiaExpediente; |TIPO 7;
     nCopiaEnvio = 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |SI #0#2 ! 1;
               |CONFI "0000N¿Desea copiar los datos y traba- jadores desde otro envío de este número de expediente?";
               |SI FSalida = 0;
                    aAlfa = "    A continuación, escoja del lineal el envío desde el cual se copiarán los datos.";
                    |MENAV aAlfa;
                    |SALVA_FICHA #labere10;
                    nEmpresa = #0#0;
                    aExpediente = #0#1;
                    nEnvioActual = #0#2;
                    aDescripcion = #0#26;
                    nUltEnvio = #0#2 - 1;
                    |CONSULTA_F_CLAVE #1#labere10, minexp, maxexp;
                    |SI FSalida = 0;
                         nCopiaEnvio = #labere10#2;
                    |FINSI;
                    |REPON_FICHA #labere10;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nCopiaEnvio ! 0;
          |HAZ TraeExpediente;
          |HAZ TraeLineas;
          |HAZ Muestra;
     |FINSI;
|FPRC;

|PROCESO Tipo0C24ere10; |TIPO 0;
     aAux = #labere10#24;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Es obligatorio introducir la fecha de inicio de aplicación del procedimiento";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0C25ere10; |TIPO 0;
     aAux = #labere10#25;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Es obligatorio introducir la fecha de fin de aplicación del procedimiento";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0C10ere10; |TIPO 0;
     aAux = #labere10#10;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Es obligatorio indicar la fecha de la comunicación "
          aMensaje = aMensaje + "de la decisión empresarial";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Activa11; |TIPO 7
     |SI #0#22 = "F";
          |CAMPO_MODIFICA #0#11, 1, "N";
          #0#11 = #0#24;
          |PINTA #0#11;
     |SINO;
          |CAMPO_MODIFICA #0#11, 1, "N";
          #0#11 = "01.01.0000";
          |PINTA #0#11;
     |FINSI;
|FPRC;

|PROCESO Aviso11; |TIPO 0;
     |SI #0#22 ! "F"; |ACABA; |FINSI;

     aAux = #labere10#11;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Este dato es obligatorio en expedientes por causa ";
          aMensaje = aMensaje + "de fuerza mayor.";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Activa12; |TIPO 7
     |SI #0#8 = "2"; |O #0#8 = "3";
          |CAMPO_MODIFICA #0#12, 1, "S";
     |SINO;
          |CAMPO_MODIFICA #0#12, 1, "N";
          #0#12 = "01.01.0000";
          |PINTA #0#12;
     |FINSI;
|FPRC;

|PROCESO Aviso12; |TIPO 0;
     |SI #0#8 ! "2"; |Y #0#8 ! "3"; |ACABA; |FINSI;

     aAux = #labere10#12;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Este dato es obligatorio en empresas con Naturaleza ";
          aMensaje = aMensaje + "tipo 2 ó 3.";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;

     |SI #labere10#12 < #0#24;
          || Correcto
     |SINO;
          aMensaje = "0000La fecha del informe de las AAPP debe ser anterior a ";
          aMensaje = aMensaje + "la fecha de inicio del periodo de aplicación";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Activa13; |TIPO 7
     |SI #0#22 = "C";
          |CAMPO_MODIFICA #0#13, 1, "S";
     |SINO;
          |CAMPO_MODIFICA #0#13, 1, "N";
          #0#13 = "01.01.0000";
          |PINTA #0#13;
     |FINSI;
|FPRC;

|PROCESO Aviso13; |TIPO 0;
     |SI #0#22 ! "C"; |ACABA; |FINSI;

     aAux = #labere10#13;
     |QBF aAux;
     |SI aAux = ""; |O aAux = "01.01.0000";
          aMensaje = "0000Este dato es obligatorio en expedientes por causa ";
          aMensaje = aMensaje + "consursal.";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
     |SI #0#24 [ #0#13; |Y #0#13 [ #0#24
          || Correcto
     |SINO;
          aMensaje = "0000La fecha de la resolución judicial ha de estar ";
          aMensaje = aMensaje + "dentro del periodo de aplicación del procedimiento";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0C21ere10; |TIPO 0;
     aAux = #labere10#21;
     |QBF aAux;
     |SI aAux = "";
          aMensaje = "0000Introduza el Tipo de Procedimiento";
          |MENAV aMensaje;
          |ERROR;
     |SINO;
          |SI aAux = "E"; |O aAux = "S"; |O aAux = "R"; |O aAux = "ES";
           |O aAux = "ER"; |O aAux = "SR"; |O aAux = "ESR";
               ||Es correcto
          |SINO;
               aMensaje = "0000Formato incorrecto. (E/S/R/ES/ER/SR/ESR)";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Borra_labere12;
     |BORRA 020#labere12.a;
     |LIBERA #labere12;
|FPRC;

|DEFBUCLE Borra_labere12;
     #labere12#1;
     ;
     #labere10#0, #labere10#1, #labere10#2, 00001;
     #labere10#0, #labere10#1, #labere10#2, 99999;
     be;
     NULL, Borra_labere12;
|FIN;

|PROCESO BorraLineas; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 3;
          |BUCLE Borra_labere12;
     |FINSI;
|FPRC;

|PROCESO Tipo0C1ere10; |TIPO 0;
     nModo = (FEntrada/100) ! 0;
     |SI nModo = 1;
          ||VerificaFormato Num. ERE  (NNNNN/AAAA)
          aAux = #labere10#1;
          |QBT aAux;
          |SI aAux = "";
               aMensaje = "0000Introduza el Numero de ERE";
               |MENAV aMensaje;
               |ERROR;
          |SINO;
               aAux = ("00000" + aAux) % -110;
               #labere10#1 = aAux;
               |PINTA #labere10#1;

               aAuxDos = aAux % 601;
               |SI aAuxDos ! "/";
                    aMensaje = "0000Introduzca el nro. de ERE en formato (NNNNN/AAAA)";
                    |MENAV aMensaje;
                    |ERROR;
               |SINO;
                    aLong = aAux % A0;
                    nLong = aLong;
                    |SI nLong ! 10;
                         aMensaje = "0000Introduzca el nro. de ERE en formato (NNNNN/AAAA)";
                         |MENAV aMensaje;
                         |ERROR;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 3;
          |ABRE #labempre;
          #labempre#0 = #labere10#0;
          |LEE 000#labempre.=;
          |SI FSalida ! 0;
               |DDEFECTO #labempre;
          |FINSI;

          aDomicilio = #labempre#3;
          |QBF aDomicilio;

          aNumero = #labempre#4;
          |QBF aNumero;

          aPiso = #labempre#5;
          |QBF aPiso;

          aDireccion = aDomicilio;
          |QBF aDireccion;
          |SI aNumero ! "";
               aDireccion = aDireccion + ", " + aNumero;
               |QBF aDireccion;
          |FINSI;

          |SI aPiso ! "";
               aDireccion = aDireccion + " - " + aPiso;
               |QBF aDireccion;
          |FINSI;

          #labere10#6 = aDireccion;
          |PINTA #labere10#6;


          aNombreRepre = #labempre#15;
          |QBF aNombreRepre;
          |CIERRA #labempre;

          aCadena = aNombreRepre;
          |HAZ SeparaNom_plb;
          #labere10#15 = eaNom;
          #labere10#16 = eaApel1;
          #labere10#17 = eaApel2;
     |FINSI;
|FPRC;

|PROCESO inferior;
     #12#0 = #0#0;
     #12#1 = #0#1;
     #12#2 = #0#2;
     #12#4 = 00001;
|FPRC;

|PROCESO superior;
     #12#0 = #0#0;
     #12#1 = #0#1;
     #12#2 = #0#2;
     #12#4 = 99999;
|FPRC;

|PROCESO Muestra; |TIPO 14;
     |ENTLINEAL #1#12, -4, 7, 22, 0, inferior, superior;
     |ATRI I;
|FPRC;

|PROCESO CargaTemporal;
     |PARA nCampo = 0; |SI nCampo [ 247; |HACIENDO nCampo = nCampo + 1;
          #150nCampo = #labtraba#nCampo#;
     |SIGUE;
     |GRABA 000#150n;
|FPRC;

|DEFBUCLE CargaTemporal;
     #labtraba#1;
     44;
     #0#0, 00001, "A";
     #0#0, 99999, "A";
     ;
     NULL, CargaTemporal;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     swAlgo = 0;
     nModo = (FEntrada / 100) ! 0;

     aAlfa = Usuario; |QBF aAlfa;    aAlfa = "t" + aAlfa;
     |DELINDEX #150;
     |NOME_DAT #150 aAlfa;
     |ABRE #150;
     |BUCLE CargaTemporal;

     |ENTLINEAL #1#12, -4, 2, 22, 0, inferior, superior;

     |DELINDEX #150;
     |CIERRA #150;
|FPRC;

|PROCESO Tipo20_ere10; |TIPO 20;
     aAlfa1 = FSalida;
     |SI aAlfa1 = "OPCION";
         FSalida = "Generar XML";
         |ACABA;
     |FINSI;

     |LEE 101#0=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     ||HAZ EmisionXML;

     |HAZ NuevaEmisionXML;
|FPRC;
/*
|PROCESO ElPrint;
     aAlfa = "";
     nBlancos = #xmlarbre#1 - 1;
     |PARA nNume1 = 0; |SI nNume1 [ nBlancos; |HACIENDO nNume1 = nNume1 + 1;
          aAlfa = aAlfa + " ";
     |SIGUE;
     aAlfa = aAlfa + #xmlarbre#2;
     #xmlarbre#2 = aAlfa;
     |PRINT;
|FPRC;

|DEFBUCLE informe;
     #xmlarbre#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ElPrint;
|FIN;

|PROCESO informe;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "xmlarbre";
          |BUCLE informe;
          |PIEINF;
          |FININF;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO QuitaCeros;
     |PARA i = 1; |SI i [ 21; |HACIENDO i = i + 1;
          || j = 100 + i;
          || j = (-1) * j;
          aAlfa = aNivel % -101;
          |SI aAlfa = "0";
               k = 20 - i;
               k = k + 100;
               aNivel = aNivel % k;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     |SI nNivel2 = 10; |O nNivel2 = 20; |O nNivel2 = 30; |O nNivel2 = 40;
      |O nNivel2 = 50; |O nNivel2 = 60; |O nNivel2 = 70; |O nNivel2 = 80;
      |O nNivel2 = 90; || migue
          aNivel = aNivel + "0";
     |FINSI;
|FPRC;

|PROCESO Construye2;
     aNivel = aNivel + "00000000000000000000";
     aNivel = aNivel % 120;
     nCorta = nNivel * 2;
     nCorta1 = nCorta - 2;
     nCorta1 = 100 + nCorta1;
     aParte1 = aNivel % nCorta1;
     nCorta2 = 20 - nCorta;
     nCorta2 = -1 * (100 + nCorta2);
     aParte2 = aNivel % nCorta2;

     nCorta = 100 + nCorta;
     aNivel2 = aNivel % nCorta;
     aNivel2 = aNivel2 % -102;
     nNivel2 = aNivel2;
     nNivel2 = nNivel2 + 1;
     || aNivel2 = nNivel2;

     aNivel2 = #xmlereli#1;
     aNivel2 = "00" + aNivel2;
     aNivel2 = aNivel2 % -102;
     nNivel2 = aNivel2;       || migue

     aNivel = aParte1 + aNivel2 + aParte2;
     |SI swACero = 1;
          aNivel = aNivel - aParte2;
          aNivel = aNivel + "0000000000000000000";
          aNivel = aNivel % 120;
     |FINSI;
     |HAZ QuitaCeros;
|FPRC;

|PROCESO ConstruyeNivel;
     |SI nElemento [ 1;
          nNivel = nNivel + 1;
     |FINSI;
     nContador = nContador + 1;
|FPRC;

|PROCESO BuscaHijos;
     swHayHijos = 1;

     aEntidad = #xmlereli#2;
     aObligatorio = #xmlereli#4;
     aDefDatos = #xmlereli#5;
     nNumCampoDef =  #xmlereli#3;

     aEtiqueta = aEntidad;
     |QBF aEtiqueta;

     nSwContinua = 1;

     |SI aEtiqueta = "Datos_Centro_Trabajo_Afectado";
      |O aEtiqueta = "Datos_Trabajador_Afectado";
      |O aEtiqueta = "Datos_Calendario";
      |O aEtiqueta = "Periodo_SuspReduc";

          |SI aEtiqueta = "Datos_Centro_Trabajo_Afectado"; |Y nSwPrimeraEmpresa = 1;
               nSwPrimeraEmpresa = 0;
               |SI aObligatorio = "N";
                    |DDEFECTO #labere11;
                    #labere11#0 = #labere10#0;
                    #labere11#1 = #labere10#1;
                    #labere11#2 = #labere10#2;
                    #labere11#3 = 1;
                    |LEE 000#labere11.];
                    |SI FSalida = 0; |Y #labere11#0 = #labere10#0;
                     |Y #labere11#1 = #labere10#1; |Y #labere11#2 = #labere10#2;
                         nEmpresaActual = #labere11#3;
                    |SINO;
                         nSwContinua = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwContinua = 1;
          |HAZ impresion;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaHijos;
     #xmlereli#1;
     ;
     aEntidad,   1;
     aEntidad, 999;
     ;
     NULL, BuscaHijos;
|FIN;
*/
|PROCESO MarcaFin;
/*
     |HAZ ConstruyeNivel;
     |HAZ Construye2
     |DDEFECTO #100;
     #100#0 = nContador;
     #100#1 = nNivel;
     #100#2 = #xmlereli#2;
     #100#3 = aNivel;
     #100#5 = 2;
     #100#7 = #xmlereli#4;
     |SI nNivel = 1;          || excepcion: la ultima
          #100#2 = "Procedimiento_ERE";
          #100#3 = "01";
          #100#7 = "N";
     |FINSI;
     |GRABA 020#100n;
     |LIBERA #100;

     aVoyEntidad = #xmlereli#2;
     |QBF aVoyEntidad;
     |SI aVoyEntidad = "Datos_Centro_Trabajo_Afectado";
          nProximaEmpresa = nEmpresaActual + 1;

          |DDEFECTO #labere11;
          #labere11#0 = #labere10#0;
          #labere11#1 = #labere10#1;
          #labere11#2 = #labere10#2;
          #labere11#3 = nProximaEmpresa;
          |LEE 000#labere11.];
          |SI FSalida = 0; |Y #labere11#0 = #labere10#0;
           |Y #labere11#1 = #labere10#1; |Y #labere11#2 = #labere10#2;
               nEmpresaActual = #labere11#3;
               aObligatorio = #xmlereli#4;
               aEntidad = aVoyEntidad;
               aDefDatos = #xmlereli#5;
               nNumCampoDef =  #xmlereli#3;
               |HAZ impresion;
          |FINSI;
     |FINSI;
*/
/*
     |SI aVoyEntidad = "Datos_Trabajador_Afectado";
          nRepeTraba = nRepeTraba + 1;
          |SI nRepeTraba < 5;
               aObligatorio = #xmlereli#4;
               aEntidad = aVoyEntidad;
               |HAZ impresion;
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO impresion;
/*
     swHayHijos = 0;
     #xmlereca#0 = aEntidad;
     |LEE 000#xmlereca.=;
     |SI FSalida = 0;         || tiene hijos
          |SALVA_FICHA #xmlereca;
          |SALVA_FICHA #xmlereli;

          swACero = 0;
          |SI nElemento ! 0;
               nNivel = nNivel - 1;
               swACero = 1;
          |FINSI;
          nElemento = 0;
          |HAZ ConstruyeNivel;
          |HAZ Construye2
          |DDEFECTO #100;
          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 0;              || abro entidad compleja
          #100#7 = aObligatorio;
          |GRABA 020#100n;
          |LIBERA #100;

          |BUCLE BuscaHijos;

          |SI swHayHijos = 0;
               nNivel = nNivel - 1;
               |REPON_FICHA #xmlereca;
               |REPON_FICHA #xmlereli;
               |PARA; |SI FSalida = -1; |HACIENDO;
                    |REPON_FICHA #xmlereca;
                    |REPON_FICHA #xmlereli;
               |SIGUE;
               |HAZ MarcaFin;
          |FINSI;
     |SINO;
          nElemento = nElemento + 1;
          |HAZ ConstruyeNivel;
          |HAZ Construye2;
          |DDEFECTO #100;
          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 1;              || entidad simple
          #100#7 = aObligatorio;

          ||AQUI ES DONDE METO LOS DATOS
          |QBF aDefDatos;
*/

/*
          aAux = aDefDatos + " -- " + nNumCampoDef;

          |SI aDefDatos = "labere10";
               aAux = #labere10#nNumCampoDef#;
          |FINSI;
          |SI aDefDatos = "labere11";
               aAux = #labere11#nNumCampoDef#;
          |FINSI;
          |SI aDefDatos = "labere12";
               aAux = #labere12#nNumCampoDef#;
          |FINSI;
*/

/*
          aAux = aDefDatos;
          #100#4 = aAux;
          #100#6 = nNumCampoDef;

          |GRABA 020#100n;
          |LIBERA #100;
     |FINSI;
*/
|FPRC;

/*
|PROCESO EmisionXML;
     ||ESTA YA NO SE UTILIZA.

     nSwPrimeraEmpresa = 1;
     nContador = 0;
     nNivel = 0;
     aNivel = "";

     ||Falta rellenar los datos, y controlar los bucles que se repiten.

     aAlfa = Usuario;    |QBT aAlfa;    aAlfa = ("y" + aAlfa) % 108;
     |NOME_DAT #100 aAlfa;
     |DELINDEX #100;
     |ABRE #100;
     |ABRE #xmlereca;
     |ABRE #labere11;
     |ABRE #labere12;

     #xmlereli#1 = 1;         ||Para que empiece por este nivel.

     aEntidad = "Procedimiento_ERE";
     aObligatorio = "S";
     aDefDatos = "";
     nNumCampoDef = 0;
     swACero = 1;

     |HAZ impresion;

     ||CONSULTA_CLAVE #1#100;
     |HAZ informe;
     |CIERRA #labere11;
     |CIERRA #labere12;
     |CIERRA #xmlereca;
     |CIERRA #100;
     |DELINDEX #100;
|FPRC;
*/

|PROCESO MeteRegistroTmp;
     |QBF aValor;

     |DDEFECTO #xmlerezz;
     #xmlerezz#0 = nRegistroXML;
     |LEE 000#xmlerezz.=;

     |SI #xmlerezz#5 = 1;
          |SI aValor = ""; |Y #xmlerezz#7 = "N";
               ||Si el campo NO tiene valor, y NO es Obligatorio ==> NO debe salir
               |ACABA;
          |SINO;
               |SI aValor = ""; |Y #xmlerezz#7 = "S";
                    aMensaje = "0000ERROR: Campo " + #xmlerezz#2;
                    |QBF aMensaje;
                    aMensaje = aMensaje + " Obligatorio.";
                    |MENAV aMensaje;
               |FINSI;
          |FINSI;
     |FINSI;

     nContador = nContador + 1;
     |DDEFECTO #100;
     #100#0 = nContador;
     #100#1 = #xmlerezz#1;
     #100#2 = #xmlerezz#2;
     #100#3 = #xmlerezz#3;
     #100#4 = aValor;
     #100#5 = #xmlerezz#5;
     #100#6 = #xmlerezz#6;
     #100#7 = #xmlerezz#7;
     |GRABA 020#100n;
     |LIBERA #100;
|FPRC;

|PROCESO LimpiaFecha;
     aFecha = aValor;
     |QBF aFecha;
     |SI aFecha = ""; |O aFecha = "01.01.0000";
          aValor = "";
     |SINO;
          aDia = aFecha % 102;
          aMes = aFecha % 402;
          aAny = aFecha % -104;
          aValor = aAny + aMes + aDia;
     |FINSI;
|FPRC;

|PROCESO HoraReduc;
     |SI aHoraDesde ! "0000"; |Y aHoraHasta ! "0000";
          nRegistroXML = 50;      aValor = "";           |HAZ MeteRegistroTmp;

          nRegistroXML = 51;      aValor = aHoraDesde;   |HAZ MeteRegistroTmp;
          nRegistroXML = 52;      aValor = aHoraHasta;   |HAZ MeteRegistroTmp;

          nRegistroXML = 53;      aValor = "";           |HAZ MeteRegistroTmp;
     |FINSI;
|FPRC;

|PROCESO labere14;
     nRegistroXML = 47;      aValor = "";           |HAZ MeteRegistroTmp;

     nRegistroXML = 48;     aValor = #labere14#4; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 49;     aValor = #labere14#5; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;

     |SI #labere12#10 = "R";
         |PARA nCampo1 = 6; |SI nCampo1 [ 44; |HACIENDO nCampo1 = nCampo1 + 2;
               nCampo2 = nCampo1 + 1;
               aHoraDesde = #labere14#nCampo1#;
               aHoraDesde = ("0000" + aHoraDesde) % -104;
               aHoraHasta = #labere14#nCampo2#;
               aHoraHasta = ("0000" + aHoraHasta) % -104;
               |HAZ HoraReduc;
          |SIGUE;
     |FINSI;

     nRegistroXML = 54;      aValor = "";           |HAZ MeteRegistroTmp;
|FPRC;

|DEFBUCLE labere14;
     #labere14#1;
     ;
     #labere13#0, #labere13#1, 001;
     #labere13#0, #labere13#1, 999;
     ;
     NULL, labere14;
|FIN;

|PROCESO DatosCalendario;
     nRegistroXML = 45;      aValor = "";           |HAZ MeteRegistroTmp;

     |SI #labere12#10 = "E";
          nRegistroXML = 46;     aValor = #labere13#3; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     |FINSI;

     |SI #labere12#10 = "R"; |O #labere12#10 = "S";
          |BUCLE labere14;
     |FINSI;

     |SI #labere12#10 = "R";
          nRegistroXML = 55;
          nNumero = #labere13#4;
          nNumero = nNumero * 100;
          aValor = ("0000" + nNumero) % -104;
          |HAZ MeteRegistroTmp;

          nRegistroXML = 56;     aValor = #labere13#5;  |HAZ MeteRegistroTmp;
     |FINSI;

     nRegistroXML = 57;      aValor = "";           |HAZ MeteRegistroTmp;
|FPRC;

|PROCESO Trabajador;
     nRegistroXML = 38;      aValor = "";           |HAZ MeteRegistroTmp;
     nRegistroXML = 39;      aValor = #labere12#5;
     |QBT aValor;           aValor = aValor % 109;
     |HAZ MeteRegistroTmp;
     nRegistroXML = 40;      aValor = #labere12#6;  |HAZ MeteRegistroTmp;
     nRegistroXML = 41;      aValor = #labere12#7;  |HAZ MeteRegistroTmp;
     nRegistroXML = 42;      aValor = #labere12#8;  |HAZ MeteRegistroTmp;
     nRegistroXML = 43;      aValor = #labere12#9;  |HAZ MeteRegistroTmp;
     nRegistroXML = 44;      aValor = #labere12#10;  |HAZ MeteRegistroTmp;

     ||ARA41

     |DDEFECTO #labere13;
     #labere13#0 = #labere10#0;
     #labere13#1 = #labere12#11;
     |LEE 000#labere13.=;
     |SI FSalida = 0;
          |HAZ DatosCalendario;
     |FINSI;

     nRegistroXML = 58;      aValor = "";           |HAZ MeteRegistroTmp;
|FPRC;

|PROCESO labere12;
     |SI aAntCCCCentro ! #labere12#12;
          |SI aAntCCCCentro ! "";
              nRegistroXML = 59;      aValor = "";           |HAZ MeteRegistroTmp;
          |FINSI;
          #labcentr#0 = #labere12#0;
          #labcentr#1 = #labere12#3;
          |LEE 000#labcentr.=;

          nRegistroXML = 33;      aValor = "";           |HAZ MeteRegistroTmp;

          #labtraba#0 = #labere12#0;
          #labtraba#1 = #labere12#4;
          |LEE 000#labtraba.=;

          aAlfa = #labempre#10;
          |QBF aAlfa;
          nRegistroXML = 34;      aValor = aAlfa;
          |QBT aValor;            aValor = aValor % 109;
          |HAZ MeteRegistroTmp;

          aAlfa1 = #labtraba#247;
          |QBF aAlfa1;
          aAlfa1 = ("0000" + aAlfa1) % -104;
          aAlfa2 = #labcentr#10;
          |QBF aAlfa2;
          aAlfa = aAlfa1 + aAlfa2;

          nRegistroXML = 35;      aValor = aAlfa;  |HAZ MeteRegistroTmp;

          aAlfa1 = #labcentr#3; |QBF aAlfa1;
          aAlfa = aAlfa1;
          aAlfa1 = #labcentr#4; |QBF aAlfa1;
          |SI aAlfa1 ! "";
               aAlfa = aAlfa + " " + aAlfa1;
          |FINSI;
          aAlfa1 = #labcentr#5; |QBF aAlfa1;
          |SI aAlfa1 ! "";
               aAlfa = aAlfa + " - " + aAlfa1;
          |FINSI;

          nRegistroXML = 36;      aValor = aAlfa;  |HAZ MeteRegistroTmp;

          aCP = ("00" + #labcentr#7) % -102 + ("000" + #labcentr#8) % -103;
          |ABRE #labmunic;
          |SELECT #4#labmunic;
          #labmunic#4 = aCP;
          |LEE 000#labmunic.=;
          |SI FSalida = 0;
               aAlfa = #labmunic#1;
          |SINO;
               aAlfa = "";
          |FINSI;
          |CIERRA #labmunic;

          nRegistroXML = 37;      aValor = aAlfa;  |HAZ MeteRegistroTmp;

     |FINSI;

     || DATOS DEL TRABAJADOR

     |HAZ Trabajador;

     aAntCCCCentro = #labere12#12;
     |QBF aAntCCCCentro;
|FPRC;

|DEFBUCLE labere12;
     #labere12#2;
     ;
     #labere10#0, #labere10#1, #labere10#2, "           ", 00001;
     #labere10#0, #labere10#1, #labere10#2, "zzzzzzzzzzz", 99999;
     ;
     NULL, labere12;
|FIN;

|PROCESO labere12_previo;
     aAlfa = #labere12#12;
     |QBF aAlfa;
     |SI aAlfa = "";
          #labcentr#0 = #labere12#0;
          #labcentr#1 = #labere12#3;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
               #labere12#12 = #labcentr#10;
               |GRABA 020#labere12.a;
               |LIBERA #labere12;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labere12_previo;
     #labere12#2;
     ;
     #labere10#0, #labere10#1, #labere10#2, "           ", 00001;
     #labere10#0, #labere10#1, #labere10#2, "zzzzzzzzzzz", 99999;
     be;
     NULL, labere12_previo;
|FIN;

|PROCESO BuscaRegimen;
     |SI #labtraba#42 ! "H";
          aAlfa1 = #labtraba#247;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaRegimen;
     #labtraba#1;
     44;
     #labere10#0, 00001, "A";
     #labere10#0, 99999, "A";
     ;
     NULL, BuscaRegimen;
|FIN;

|PROCESO BuscaMunicipio;
          aCP = ("00" + #labempre#7) % -102 + ("000" + #labempre#8) % -103;
          |ABRE #labmunic;
          |SELECT #4#labmunic;
          #labmunic#4 = aCP;
          |LEE 000#labmunic.=;
          |SI FSalida = 0;
               aValor = #labmunic#1;
          |SINO;
               aValor = "";
          |FINSI;
          |CIERRA #labmunic;
|FPRC;

|PROCESO DatosEmpresa;
     aAntCCCCentro = "";
     #labempre#0 = #labere10#0;
     |LEE 000#labempre.=;

     nRegistroXML = 1;      aValor = ""; |HAZ MeteRegistroTmp;

     nRegistroXML = 2;
     |SI #labere10#2 = 1;
          aValor = "A";
     |SINO;
          aValor = "V";
     |FINSI;
     |HAZ MeteRegistroTmp;

     nRegistroXML = 3;      aValor = "";  |HAZ MeteRegistroTmp;

     nRegistroXML = 4;      aValor = #labere10#3;
     |QBT aValor;           aValor = aValor % 109;
     |HAZ MeteRegistroTmp;

     aAlfa1 = "";
     |BUCLE BuscaRegimen;
     |QBF aAlfa1;
     aAlfa1 = ("0000" + aAlfa1) % -104;
     aAlfa2 = #labempre#13;
     |QBF aAlfa2;
     aAlfa2 = ("00000000000" + aAlfa2) % -111;
     aAlfa = aAlfa1 + aAlfa2;

     nRegistroXML = 5;      aValor = aAlfa;        |HAZ MeteRegistroTmp;

     nRegistroXML = 6;      aValor = #labere10#5;  |HAZ MeteRegistroTmp;
     nRegistroXML = 7;      aValor = #labere10#6;  |HAZ MeteRegistroTmp;
     nRegistroXML = 8;      |HAZ BuscaMunicipio;   |HAZ MeteRegistroTmp;
     nRegistroXML = 9;      aValor = #labere10#8;  |HAZ MeteRegistroTmp;
     nRegistroXML = 10;     aValor = #labere10#9;  |HAZ MeteRegistroTmp;
     nRegistroXML = 11;     aValor = #labere10#10; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 12;     aValor = #labere10#11; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 13;     aValor = #labere10#12; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 14;     aValor = #labere10#13; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;

     aAux = #labere10#14; |QBF aAux;
     |SI aAux ! "";
          nRegistroXML = 15;      aValor = "";         |HAZ MeteRegistroTmp;
          nRegistroXML = 16;      aValor = #labere10#14;
          |QBT aValor;            aValor = aValor % 109;
          |HAZ MeteRegistroTmp;
          nRegistroXML = 17;      aValor = #labere10#15;  |HAZ MeteRegistroTmp;
          nRegistroXML = 18;      aValor = #labere10#16;  |HAZ MeteRegistroTmp;
          nRegistroXML = 19;      aValor = #labere10#17;  |HAZ MeteRegistroTmp;
          nRegistroXML = 20;      aValor = #labere10#18;  |HAZ MeteRegistroTmp;
          nRegistroXML = 21;      aValor = #labere10#19;  |HAZ MeteRegistroTmp;
          nRegistroXML = 22;      aValor = #labere10#20;  |HAZ MeteRegistroTmp;
     |FINSI;

     nRegistroXML = 23;      aValor = "";           |HAZ MeteRegistroTmp;
     nRegistroXML = 24;      aValor = "";           |HAZ MeteRegistroTmp;
     nRegistroXML = 25;      aValor = #labere10#1;  |HAZ MeteRegistroTmp;
     nRegistroXML = 26;      aValor = #labere10#20; |HAZ MeteRegistroTmp;
     nRegistroXML = 27;      aValor = #labere10#21; |HAZ MeteRegistroTmp;
     nRegistroXML = 28;      aValor = #labere10#22; |HAZ MeteRegistroTmp;
     nRegistroXML = 29;      aValor = #labere10#23; |HAZ MeteRegistroTmp;
     nRegistroXML = 30;      aValor = #labere10#24; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 31;      aValor = #labere10#25; |HAZ LimpiaFecha; |HAZ MeteRegistroTmp;
     nRegistroXML = 32;      aValor = "";           |HAZ MeteRegistroTmp;

     ||Datos Centros y resto

     |BUCLE labere12_previo;
     |BUCLE labere12;

     nRegistroXML = 59;      aValor = "";           |HAZ MeteRegistroTmp;

     nRegistroXML = 60;      aValor = "";           |HAZ MeteRegistroTmp;
|FPRC;


|PROCESO RellenaTempo;
     ||Datos a partir del labere10;
     |HAZ DatosEmpresa;
|FPRC;


|PROCESO Linea;
     |QBF aAlfa;
     aCadena = aAlfa;
     |HAZ QuitaRaros;

     ||ESTO NO FUNCIONA.
     ||aTextoTab = aTab * (nNivel - 1);

     nNivel = nNivel - 1;

     |SI nNivel = 1;
          aTextoTab = aTab;
     |SINO;
          |SI nNivel = 2;
               aTextoTab = aTab + aTab;
          |SINO;
               |SI nNivel = 3;
                    aTextoTab = aTab + aTab + aTab;
               |SINO;
                    |SI nNivel = 4;
                         aTextoTab = aTab + aTab + aTab + aTab;
                    |SINO;
                         |SI nNivel = 5;
                              aTextoTab = aTab + aTab + aTab + aTab + aTab;
                         |SINO;
                              |SI nNivel = 6;
                                   aTextoTab = aTab + aTab + aTab + aTab + aTab + aTab;
                              |SINO;
                                   |SI nNivel = 7;
                                        aTextoTab = aTab + aTab + aTab + aTab + aTab + aTab + aTab;
                                   |SINO;
                                        aTextoTab = aTab + aTab + aTab + aTab + aTab + aTab + aTab + aTab;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nNivel [ 0;
          aTextoTab = "";
     |FINSI;


     aCadena = aTextoTab + aCadena;
     aCadena = aCadena + &13 + &10;
     aAlfa = aCadena;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO MeteEnXML;
     nNivel = #xmlarbre#1;

     |SI #xmlarbre#5 = 0;
          aAlfa = "<" + #xmlarbre#2;
          |QBF aAlfa;
          aAlfa = aAlfa + ">";
     |SINO;
          |SI #xmlarbre#5 = 2;
               aAlfa = "</" + #xmlarbre#2;
               |QBF aAlfa;
               aAlfa = aAlfa + ">";
          |SINO;
               aAlfa = "<" + #xmlarbre#2;
               |QBF aAlfa;
               aAlfa = aAlfa + ">";

               aAlfa = aAlfa + #xmlarbre#4;
               |QBF aAlfa;

               aAlfa = aAlfa + "</" + #xmlarbre#2;
               |QBF aAlfa;
               aAlfa = aAlfa + ">";
          |FINSI;
     |FINSI;
     |HAZ Linea;
|FPRC;

|DEFBUCLE xmlarbre;
     #xmlarbre#1;
     ;
     2;
     99999;
     ;
     NULL, MeteEnXML;
|FIN;

|PROCESO NuevaEmisionXML;
     aTab = &9;

     aAlfa = Usuario;    |QBT aAlfa;    aAlfa = ("y" + aAlfa) % 108;
     |NOME_DAT #100 aAlfa;
     |DELINDEX #100;
     |ABRE #100;

     |ABRE #xmlerezz;
     ||ABRE #xmlereca;
     ||ABRE #xmlereli;
     |ABRE #labere13;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #labcentr;

     nContador = 0;
     |HAZ RellenaTempo;

     |ABRE #labcontr;
     |LEE 000#labcontr.p;
     |CIERRA #labcontr;

     aRuta = #labcontr#51;
     |QBF aRuta;
     aAlfa = aRuta % -101;
     |SI aAlfa ! "\"; |Y aAlfa ! "/";
          aRuta = aRuta + "/";
     |FINSI;
     aRuta = aRuta + "Certific@2/";

     |RMKDIR aRuta;

     aAux = #labere10#0;
     |QBF aAux;
     aAux = ("00000" + aAux) % -105;
     aFicheroXML = aAux;

     aFicheroXML = aFicheroXML + "_" + #labere10#1;
     |QBF aFicheroXML;
     aFicheroXML = aFicheroXML - "/" - "\";

     aAux = #labere10#2;
     aAux = ("000" + aAux) % -103;
     aFicheroXML = aFicheroXML + "_" + aAux;
     aFicheroXML = aFicheroXML + ".xml";

     aRuta = aRuta + aFicheroXML;
     |XABRE "CBW", aRuta, nHandle;
     |SI FSalida ] 0;
          nNivel = 1;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>";
          |HAZ Linea;
          aAlfa = "<Procedimiento_ERE xmlns:xsi=" +  &34 + "http://www.w3.org/2001/XMLSchema-instance" +  &34;
          aAlfa = aAlfa + " xsi:noNamespaceSchemaLocation=" + &34 + "ProcedimientoERE.xsd" + &34 + ">";
          |HAZ Linea;

          |BUCLE xmlarbre;
     |FINSI;

     |XCIERRA nHandle;

     aMensaje = "0000Fichero: " + aFicheroXML + " generado en " + (aRuta - aFicheroXML);
     |MENAV aMensaje;

     |CIERRA #labempre;
     |CIERRA #labtraba;
     |CIERRA #labempre;
     |CIERRA #labere14;
     |CIERRA #xmlerezz;
     ||CIERRA #xmlereca;
     ||CIERRA #xmlereli;
     |CIERRA #100;
     |DELINDEX #100;
|FPRC;
