|FICHEROS;
     labimpre #0;
     labtmpct #1,MANTE;

     labregis #2;
     labhisto #3;
     labtmpc1 #4,MANTE;

     labempre #4;
     labtraba #5;
     labcentr #6;
     labcontr #10;

     labenvcc #11;
     labenvcl #12;
     labmunic #13;
     nomconca #15;

     dsnetm00@ #150;     || parametros dsnetcom

     labtmpdt #2000,MANTE;
     Referen@ #2001;
     labvaltb #2002;
     Refere1@ #2003;

     labnct03;           || REGISTRO CONTRATOS
     labnct06;           || REGISTRO ERRORES NETCONTRATA
     labnct10;           || REGISTRO ENVIOS ONLINE
     labacuer;
     labtmpc2 #102,MANTE;
|FIN;

|VARIABLES;
     &aCodPos = "";
     &aCodigoMunicipio = "";

     Result = 0;
     NumMarcas = 0;

   nSwCont = 0;
   nSwTrns = 0;
   nSwPror = 0;
   nSwCPBs = 0;

     nCont  = 0;
     nCalc  = 0;
     nCalc2 = 0;
     nSalida = 0;
     nTecla  = 0;
     nSwUno  = 0;

     aAlfa  = "";
     aDSitu = "";
     aHSitu = "";

     nSwNuevo   = 0;
     nSwLectura = 0;
     nCampo1    = 0;
     nAbierto   = 0;
     nPosic     = 0;
     nCalc1     = 0;
     nLong      = 0;
     nSwImp     = 0;

     aLong      = "";
     aLF        = "";
     aCR        = "";
     aComillas  = "";
     aCadena    = "";
     aAlfa3     = "";

     aTipoDat = "";
     nLongDat = 0;

     &nLabHisto = 0;
     &enNumRegis = 0;
     &eaNumProrr = "";

     &enWeb = 0;
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     &eaWebDirPDF = "";

     fFecha = @;
     nHandle  = 0;
     nHandle1 = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aFichs = "";

     aTitulo  = "";
     aNombre  = "";
     aRegistro = "";
     aValor   = "";
     aFich    = "";
     aTabla   = "";
     aClv     = "";
     aClv1    = "";
     aClv2    = "";
     nCmp     = 0;
     nSwError = 0;
     nClave   = 0;
     nLinea   = 0;
     nCampo   = 0;

 {1}aContiene = "";
{-1}aMenu = "";
    aMenu1 = "2400";
    aMenu2 = "1";
    aMenu3 = "";
    aMenu4 = "123";
    aMenu5 = "     1 - Contrato     ";
    aMenu6 = "2 - Comunicacion datos";
    aMenu7 = "      3 - Ambos       ";

    &enTipoEmision = 0;
      swHeGrabado = 0;
    aMD5Origen  = "";
    aMD5Destino = "";
    aOrigen     = "";
    aDestino    = "";
    aIP         = "";

     &swNetContrata = 0;
     aParam = "";
     nJornada = 0;
     nHorasMax = 0;
     aHora = "";
     nNume = 0;
     FEstado = 0;
     aUsuario = "";
     aFecha = "";
     aFichero = "";
     nUltimo = 0;
     nDesdeChar = 0;
     aLinea = "";
     aCodigo = "";
     swAcaba = 0;
     aIdContrata = "";
     swEstado = 0;
     aQueEs = "";
     aProrroga = "";
     nProrroga = 0;
     aCabeza = "";

     aLongRar = "";
     nLongRar = 0;
     aAlfaRar = "";
     aAlfaRar1 = "";
     aAlfaRar2 = "";
     CalcRar1 = 0;
     nContRar1 = 0;
     aPrefijo = "";
     aMensa = "";
     aEsc1 = "";
     aTecla = "";
     aStop = "";
     aRuta = "";
     aRutaSal = "";
     aLon = "";
     nLon = 0;
     aCaracter = "";
     nPunt = 0;
     aTipo = "";
     &nSwTrans = 0;
     &enExtRegis = 0;
     &eaExtProrr = "";
     &eaExtDef = "";
     &enExtEmp = 0;
     &enExtTra = 0;

     fFechaAlta = @;
     &nArchi = 0;
     &eaOrig = "";
     &eaObservaciones = "";
     &enMes = 0;
     &enAny = 0;
     &eaVengoDe = "";
     &swSigue = 0;
     &enSwErrorRecDoc = 0;
     &enSwDesde9 = 0;
     &enSwMeteGrupoSubTipo = 0;
     &enEmp = 0;
     &enTra = 0;

     aFichHuella = "";
     aFichCertif = "";
     aNif = "";
     aFichero1 = "";
     aCCC = "";
     aFechaAlta = "";
     nPos = 0;
     &eaCodNIF = "";
     nSwEtiq = 0;
     aEtiq = "";
     aError = "";
     nNumChars = 0;
     aNom = "";
     aApel1 = "";
     aApel2 = "";
     nInd = 0;
     nHayComa = 0;
     SwSalir = 0;
     aEtiqu = "";
     &swNetContEmi = 0;       || llamada a NetContrata desde la emision
                              || del contrato, no desde historico
     &eaIdContrato = "";
     aResultado = "";
     aRutaBAT = "";
     nHandleBAT = 0;
     aUnidad = "";
     aResto = "";

     &eaCadena = "";
     &eaCadenaSal = "";
     &eaCaracter1 = "";
     &eaCaracter2 = "";
|FIN;

|PROCESO Tildes;
     aLongRar = aCadena % 0; nLongRar = aLongRar; aAlfaRar2 = "";
     |PARA nContRar1 = 1; |SI nContRar1 [ nLongRar; |HACIENDO nContRar1 = nContRar1 + 1;
          CalcRar1 = (nContRar1 * 100) + 1; aAlfaRar1  = aCadena % CalcRar1;
          |SI aAlfaRar1 = " ";                     |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "A"; |Y aAlfaRar1 [ "Z"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "a"; |Y aAlfaRar1 [ "z"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 ] "0"; |Y aAlfaRar1 [ "9"; |VETE Sigue1; |FINSI;
          |SI aAlfaRar1 = "."; |O aAlfaRar1 = ","; |O aAlfaRar1 = ";"; |O aAlfaRar1 = ":";
          |O aAlfaRar1 = "_"; |O aAlfaRar1 = "'"; |O aAlfaRar1 = "-";
               |VETE Sigue1;
          |FINSI;

          |SI aAlfaRar1 = "Ã";  aAlfaRar1 = "";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "¡";  aAlfaRar1 = "á";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "©";  aAlfaRar1 = "é";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "­";  aAlfaRar1 = "í";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "³";  aAlfaRar1 = "ó";   |VETE Sigue1;|FINSI;
          |SI aAlfaRar1 = "º";  aAlfaRar1 = "ú";   |VETE Sigue1;|FINSI;

          aAlfaRar = " ";
          |ET Sigue1;
          aAlfaRar2 = aAlfaRar2 + aAlfaRar1;
     |SIGUE;
     aCadena = aAlfaRar2;
|FPRC;

|PROCESO CompRuta;
     aRutaSal = "";
     |QBF aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nPunt = 1; |SI nPunt [ nLon; |HACIENDO nPunt = nPunt + 1;
          nPos = (nPunt * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "/";
               aRutaSal = aRutaSal + "\";
          |SINO;
               aRutaSal = aRutaSal + aCaracter;
          |FINSI;
     |SIGUE;
     aCaracter = aRutaSal % -101;
     |SI aCaracter ! "\";
          aRutaSal = aRutaSal + "\";
     |FINSI;
     aRuta = aRutaSal;

     eaCadena = aRuta;
     eaCaracter1 = "/";
     eaCaracter2 = "\";
     |HAZ sustituye_plb;
     aRuta = eaCadenaSal;
|FPRC;

|PROCESO Comprobacion;
   #labempre#0 = #labtmpct#1;
   |LEE 101#labempre.=;
   |SI FSalida ! 0;
      aAlfa = "    No se encuentra la empresa [" + #labtmpct#1 + "]"; |MENAV aAlfa;
      |ACABA;
   |FINSI;

   #labtraba#0 = #labtmpct#1;
   #labtraba#1 = #labtmpct#2;
   |LEE 101#labtraba.=;
   |SI FSalida ! 0;
      |LIBERA #labempre;
      aAlfa = "    No se encuentra el trabajador [" + #labtmpct#1 + "/" + #labtmpct#2 + "]"; |MENAV aAlfa;
      |ACABA;
   |FINSI;
   |HAZ Comprueba;
   |LIBERA #labempre; |LIBERA #labtraba;
|FPRC;

|PROCESO Imprime;
     |SI #labcontr#55 = "N";
          #labtmpct#0 = #labtmpc1#0;
          #labtmpct#17 = #labtmpc1#17;
          |LEE 000#labtmpct.=;
          |HAZ Impresion;
          |ACABA;
     |FINSI;
   nSwImp = 1;

   |SI #labcontr#41 = "S";
      enTipoEmision = 0;
      |MENU aMenu;
      |SI FSalida [ 0; |ERROR; |ACABA; |FINSI;
      enTipoEmision = FSalida;
   |SINO;
      enTipoEmision = 1;
   |FINSI;

   #labtmpct#0 = #labtmpc1#0;
   #labtmpct#17 = #labtmpc1#17;
   |LEE 000#labtmpct.=;

   aAlfa = "tm" + Usuario; |NOME_DAT #2000 aAlfa;
   |DELINDEX #labtmpdt; |ABRE #labtmpdt; nLinea = 1;
   |ABRE #labvaltb;
   nSwError = 0; |HAZ Comprobacion;
   |PARA; |SI nSwError = 1; |HACIENDO;
      |PUSHV 0501 2380;
      |ENTLINEAL #1#labtmpdt, -1, 4, 18, 1, inf, sup;
      |POPV;
      |CIERRA #labtmpdt; |DELINDEX #labtmpdt; |ABRE #labtmpdt;
      nSwError = 0; |HAZ Comprobacion;
      |SI nSwError ! 0;
         |CONFI "    NAun hay datos erroneos. Volver a editar ?";
         |SI FSalida ! 0;
            || nSwError = 1;
            nSwError = 0;     || para que me deje seguir, tampoco pasa nada
            |SAL;
         |FINSI;
      |FINSI;
   |SIGUE;
   |CIERRA #labvaltb;

   |CIERRA #labtmpdt; |DELINDEX #labtmpdt;
   |SI nSwError = 0;
      #labtmpct#0 = #labtmpc1#0;
      #labtmpct#17 = #labtmpc1#17;
      |LEE 000#labtmpct.=;
      |HAZ Impresion; |ERROR;
   |FINSI;

   nSwImp = 0;
|FPRC;

|PROCESO Jornada;
     nHorasMax = 40;
     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida = 0;
          |SI #nomconca#162 ! 0;
               nHorasMax = #nomconca#162;
          |FINSI;
     |FINSI;
     |CIERRA #nomconca;

     nNume = #labtraba#234;
     nJornada = 0;
     |SI nNume ! 0;
          nJornada = nNume / nHorasMax;
          nJornada = (nJornada * 1000) ! 0;
     |FINSI;
|FPRC;

|PROCESO Ultimo;
     nUltimo = nUltimo + 1;
|FPRC;

|DEFBUCLE Ultimo;
     #labnct03#1;
     ;
     #labtraba#0, #labtraba#1, aQueEs, 01;
     #labtraba#0, #labtraba#1, aQueEs, 99;
     ;
     NULL, Ultimo;
|FIN;

|PROCESO RegistroOnline;
     |ABRE #labnct10;

     #labnct10#0 = #labtraba#0;
     #labnct10#1 = #labtraba#1;
     #labnct10#11 = #labtraba#77;
     |SI aQueEs = "C";
          #labnct10#2 = 101;
          #labnct10#3 = "Contrato";
     |FINSI;
     |SI aQueEs = "P"
          #labnct10#2 = 102;
          #labnct10#3 = "Pr¢rroga";
     |FINSI;
     |SI aQueEs = "T"
          #labnct10#2 = 103;
          #labnct10#3 = "Transformaci¢n";
     |FINSI;

     fFecha = ~;
     aFecha = fFecha;
     #labnct10#4 = fFecha;         || fecha

     |HORA aHora;
     |QBF aHora;
     #labnct10#5 = aHora;          || hora

     aUsuario = Usuario % 810;
     |QBF aUsuario;
     #labnct10#6 = aUsuario;       || usuario

     |SI eaExtDef = "";
          #labnct10#7 = "labimpre";         || desde envio a NetContrata
     |SINO;
          #labnct10#7 = eaExtDef;           || desde un contrato directamente
     |FINSI;

     #labnct10#8 = #labtraba#45;             || tipo de contrato
     #labnct10#9 = #labtraba#36;             || fecha de alta
     #labnct10#10 = #labtraba#37;            || fecha de baja

     |GRABA 020#labnct10.n;
     |LIBERA #labnct10;
|FPRC;

|PROCESO RegistroNetC_Act;
     |ABRE #labnct03;

     #labnct03#0 = #labtraba#0;
     #labnct03#1 = #labtraba#1;
     #labnct03#10 = aQueEs;           || para la prorroga
     |SI aQueEs = "C";
          #labnct03#16 = 00;
     |FINSI;
     |SI aQueEs = "P"
          #labnct03#16 = aProrroga;
     |FINSI;
     |LEE 101#labnct03.=;

     |SI FSalida = 0;
          |SI swEstado = 1;
               #labnct03#13 = "1";                || indicador con errores
               #labnct03#14 = "Con errores";      || descripcion
               #labnct03#17 = "";                 || id contrata
          |FINSI;
          |SI swEstado = 2;
               #labnct03#13 = "2";                || indicador aceptado
               #labnct03#14 = "Aceptado";         || descripcion
               #labnct03#17 = aIdContrata;        || id contrata
          |FINSI;
          |GRABA 020#labnct03.a;
     |FINSI;

     |LIBERA #labnct03;
     |CIERRA #labnct03;
|FPRC;

|PROCESO RegistroNetC_Inicial;
     |ABRE #labnct03;
/*
     nUltimo = 0;
     |BUCLE Ultimo;
*/

     #labnct03#0 = #labtraba#0;
     #labnct03#1 = #labtraba#1;
     #labnct03#10 = aQueEs;           || para el contrato
     |SI aQueEs = "C";
          #labnct03#16 = 00;
     |FINSI;
     |SI aQueEs = "P";
          #labnct03#16 = aProrroga;
     |FINSI;
     |LEE 000#labnct03.=;
     FEstado = FSalida;


     #labnct03#2 = #labtraba#45;
     #labnct03#3 = #labtraba#36;
     #labnct03#4 = #labtraba#37;
     |HAZ Jornada;
     #labnct03#5 = nJornada;
     #labnct03#6 = #labtraba#33;

     aUsuario = Usuario % 810;
     |QBF aUsuario;
     #labnct03#7 = aUsuario;       || usuario

     fFecha = ~;
     aFecha = fFecha;
     #labnct03#8 = fFecha;         || fecha

     |HORA aHora;
     |QBF aHora;
     aHora = aHora % 105;
     #labnct03#9 = aHora;               || hora
     #labnct03#10 = aQueEs;             || para el envio desde aqui
     |SI eaExtDef = "";
          #labnct03#11 = "labimpre";         || desde envio a NetContrata
     |SINO;
          #labnct03#11 = eaExtDef;           || desde un contrato directamente
     |FINSI;
     #labnct03#12 = aFichero;           || Nombre de fichero desde el que fue generado
     #labnct03#13 = "0";                || estado inicial
     #labnct03#14 = "No completado";    || descripcion estado
     #labnct03#15 = #labtmpc2#0;        || codigo registro labregis
     #labnct03#17 = "";                 || Id Contrata

     |SI FEstado = 0;
          |GRABA 020#labnct03.a;
     |SINO;
          |GRABA 020#labnct03.n;
     |FINSI;

     swEstado = 0;
     |HAZ labhisto_act;

     |LIBERA #labnct03;
     |CIERRA #labnct03;
|FPRC;

|PROCESO IniErrores;
     |BORRA 020#labnct06.a;
|FPRC;

|DEFBUCLE IniErrores;
     #labnct06#1;
     ;
     #labtmpc2#0, nProrroga, 01;
     #labtmpc2#0, nProrroga, 99;
     ;
     NULL, IniErrores;
|FIN;

|PROCESO labhisto_act;
     #labhisto#100 = #labtmpc2#0;
     #labhisto#103 = #labtmpc2#17;
     |LEE 101#labhisto.=;
     |SI FSalida = 0;
          |SI swEstado = 0;
               #labhisto#161 = "0";
               #labhisto#162 = "No completado";
               #labhisto#163 = "";
          |FINSI;
          |SI swEstado = 1;
               #labhisto#161 = "1";
               #labhisto#162 = "Con errores";
               #labhisto#163 = "";
          |FINSI;
          |SI swEstado = 2;
               #labhisto#161 = "2";
               #labhisto#162 = "Aceptado";
               #labhisto#163 = aIdContrata;
          |FINSI;

          |GRABA 020#labhisto.a;
          |LIBERA #labhisto;

          #labtmpc2#23 = #labhisto#161;
          #labtmpc2#24 = #labhisto#162;
          #labtmpc2#25 = #labhisto#163;

          |SI eaExtDef = "";       || si vengo de un contrato directamente no
                                   || grabo nada, aunque me quedo con los va-
                                   || lores en los campos para guardar errores
               |GRABA 020#labtmpc2.a;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO labregis_act;
     |ABRE #labregis;
     #labregis#0 = #labtmpc2#0;
     |LEE 101#labregis.=;
     |SI FSalida = 0;
          #labregis#14 = aIdContrata;
          |GRABA 020#labregis.a; |LIBERA #labregis;
     |FINSI;
     |CIERRA #labregis;
|FPRC;

|PROCESO labacuer_act;
     |ABRE #labacuer;
     #labacuer#0 = #labtmpc2#1;
     #labacuer#1 = #labtmpc2#2;
     |LEE 101#labacuer.=;
     |SI FSalida = 0;
          aAlfa = aIdContrata;
          #labacuer#28 = aIdContrata % 101;
          #labacuer#29 = aIdContrata % 202;
          #labacuer#31 = aIdContrata % 404;
          #labacuer#34 = aIdContrata % 807;
          |GRABA 020#labacuer.a;
          |LIBERA #labacuer;

          aAlfa = "    Se ha actualizado el número de registro " + aIdContrata;
          aAlfa = aAlfa + " en el acuerdo de formación del trabajador."
          |MENAV aAlfa;
     |FINSI;
     |CIERRA #labacuer;
|FPRC;

|PROCESO Correcciones;
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     |ABRE #labregis;
     #labregis#0 = #labtmpc2#0;
     |LEE 000#labregis.=;
     |SI FSalida ! 0;
          |MENAV "    No existe el registro de emision del contrato";
          |ACABA;
     |FINSI;
     |CIERRA #labregis;

     aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SI aAlfa = "labprorr"; |O aAlfa = "labproli";
          aPrefijo = "pr";
          aTipo = "PRORROGA";
     |SINO;
          |SI nSwTrans = 1;
               aPrefijo = "tr";
               aTipo = "TRANSFORMACION";
          |SINO;
               aPrefijo = "co";
               aTipo = "CONTRATO";
          |FINSI;
     |FINSI;

     aAlfa = #labcontr#51;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
     |RMKDIR aAlfa;
     aRutaBAT = aRuta + "ejecuta.bat";
     aAlfa1 = (("000000" + #labtmpc2#0) % -106);

     |SI aPrefijo = "co";
          aFich = aAlfa + "CORRECCION_CONTR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "pr";
          aFich = aAlfa + "CORRECCION_PRORR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "tr";
          aFich = aAlfa + "CORRECCION_TRANS" + aAlfa1 + ".xml";
     |FINSI;

     |XABRE "CBW", aFich, nHandle;
     |SI FSalida ] 0;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "<CORRECCIONES>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "     <CORRECCION_" + aTipo + ">" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "          <DATOS_CONTRATO>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = #labregis#14; |QBF aAlfa;
          aAlfa = "               <IDENTIFICADOR>" + aAlfa + "</IDENTIFICADOR>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "          </DATOS_CONTRATO>" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "     </CORRECCION_" + aTipo + ">" + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aAlfa = "</CORRECCIONES>" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |PULSATECLA;
          |XCIERRA nHandle;
     |FINSI;

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     |DBASE aOrigen; |QBF aOrigen;
     aOrigen = aOrigen + "ejecutables/rdn.exe";
     aDestino = #labcontr#63; |QBF aDestino; aDestino = aDestino + "rdn.exe";

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;
     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     || en las correcciones, paso de esto de momento

     ||HAZ RegistroNetC_Inicial;
     ||HAZ RegistroOnline;
     ||BUCLE IniErrores;

     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO NetContrata;
     #labempre#0 = #labtmpc2#1;
     |LEE 000#labempre.=;
     |SI FSalida ! 0; |DDEFECTO #labempre; |FINSI;

     #labtraba#0 = #labtmpc2#1;
     #labtraba#1 = #labtmpc2#2;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0; |DDEFECTO #labtraba; |FINSI;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida ! 0; |DDEFECTO #labcentr; |FINSI;

     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |SI FSalida ! 0; |DDEFECTO #nomconca; |FINSI;

     #labhisto#100 = #labtmpc2#0;
     #labhisto#103 = #labtmpc2#17;
     |LEE 000#labhisto.=;
     |SI FSalida ! 0; |MENAV "    No encuentro el registro de emision del contrato"; |ERROR; |ACABA; |FINSI;

     aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SI aAlfa = "labprorr"; |O aAlfa = "labproli";
          aPrefijo = "pr";
          aTipo = "PRORROGAS";
     |SINO;
          |SI nSwTrans = 1;
               aPrefijo = "tr";
               aTipo = "TRANSFORMACIONES";
          |SINO;
               aPrefijo = "co";
               aTipo = "CONTRATOS";
          |FINSI;
     |FINSI;

     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;

     aAlfa = #labcontr#51;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
     |RMKDIR aAlfa;
     aRutaBAT = aRuta + "ejecuta.bat";
     aAlfa1 = (("000000" + #labtmpc2#0) % -106);

     |SI aPrefijo = "co";
          aFich = aAlfa + "CONTR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "pr";
          aFich = aAlfa + "PRORR" + aAlfa1 + ".xml";
     |FINSI;
     |SI aPrefijo = "tr";
          aFich = aAlfa + "TRANS" + aAlfa1 + ".xml";
     |FINSI;

     |XABRE "CBW", aFich, nHandle;
     |SI FSalida ] 0;
          aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
          aAlfa = "<" + aTipo + ">" + &13 + &10;                                                                             |XGRABA nHandle, aAlfa;
          aAlfa = #labtmpc2#17; |QBF aAlfa;

          aFichs = "C:/DOCUMENTOS/Contrat@/" + aPrefijo + (("000000" + #labtmpc2#0) % -106) + (("00" + aAlfa) % -102) + ".txt";
          |XABRE "CB", aFichs, nHandle1;
          |SI FSalida ] 0;
               |XLEE nHandle1, 20, aAlfa;
               |PARA; |SI FSalida ! 0; |HACIENDO;
                    |XGRABA nHandle, aAlfa;
                    |XLEE nHandle1, 20, aAlfa;
               |SIGUE;
               |XCIERRA nHandle1;

               |ABRE #labregis;
               #labregis#0 = #labtmpc2#0;
               |LEE 101#labregis.=;
               |SI FSalida = 0;
                    #labregis#27 = "R";
                    |GRABA 020#labregis.a; |LIBERA #labregis;
               |FINSI;
               |CIERRA #labregis;
          |FINSI;
          aAlfa = "</" + aTipo + ">" + &13 + &10;          |XGRABA nHandle, aAlfa;
     |FINSI;
     |PULSATECLA;
     |XCIERRA nHandle;

     || A PARTIR DE AQUI SI ME VALDRA, EL SE PONE A HACER SU NETCONTRATA
     || Y SUS COSAS

     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     |SI swSigue = 2;
          aContiene = "";
          |ESPECIFICA "RBASS", aContiene;
          aAlfa = aContiene1;
          |QBF aAlfa;
          aAlfa = aAlfa + "conectass";
          #labcontr#63 = aAlfa;
     |FINSI;

     aAlfa = #labcontr#63;    || ruta del netcontrata + errores
     |QBF aAlfa;              || ahi guardare las respuestas
     aAlfa = aAlfa + "\ERRORES";
     |RMKDIR aAlfa;
     aAlfa = aAlfa + "\ERRORESNET.XML";
     |RFBORRA aAlfa;

     swSigue = 0;
     |SUB_EJECUTA "labnct00";
     |SI swSigue = 0;
          |ACABA;
     |FINSI;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;
     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa2 = aAlfa + "ERRORES";
     aAlfa = aAlfa + "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aProrroga = #labtmpc2#17;
     nProrroga = aProrroga;
     |QBF aProrroga;
     |SI aProrroga ! "";
          aQueEs = "P";       || es una prorroga
     |SINO;
          |SI nSwTrans = 1;
               aQueEs = "T";       || es una transformacion
          |SINO;
               aQueEs = "C";       || es un contrato
          |FINSI;
     |FINSI;

     |HAZ RegistroNetC_Inicial;
     |HAZ RegistroOnline;
     |BUCLE IniErrores;
     |XABRE "CBW", aRutaBAT, nHandleBAT;

     aAlfa = #labcontr#63; |QBF aAlfa;
     aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta;

     aUnidad = aAlfa % 102;
     aResto = aAlfa - aUnidad;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aUnidad = aUnidad + &13 + &10;
     |XGRABA nHandleBAT, aUnidad;

     aAlfa = "CD " + aResto + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     aAlfa1 = #labcontr#62; |QBF aAlfa1;
     aAlfa = "rdn.exe " + aAlfa1 + " " + aFich + " " + aAlfa2;

     aAlfa = "start " + aAlfa + &13 + &10;
     |XGRABA nHandleBAT, aAlfa;

     |XCIERRA nHandleBAT;
     |RSYSTEM aRutaBAT;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     || examinamos la respuesta que nos da

     nSwEtiq = 0; aEtiqu = ""; aError = ""; nNumChars = 0;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";

     |PUSHV 12191859;
     |BLANCO 13201758;
     |CUADRO 13201758;
     |ATRI S;
     aMensa = " -- Esperando respuesta Online -- ";
     |PINTA 1422, aMensa;
     aMensa = "Pulse ENTER cuando procese el envío";
     |PINTA 1522, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;

     |XABRE "C", aAlfa, nHandle; nHandle = FSalida;
     |SI FSalida ] 0;
          swAcaba = 0;
          |PARA; |SI FSalida ] 0; |Y swAcaba = 0; |HACIENDO;
               |XLEE nHandle, 250, aAlfa;
               aAlfa = aAlfa - "<IDCONTRATO>";
               |SI FSalida ! 0;
                    || todo ha ido bien, me guardo el ID del contrato
                    aLinea = aAlfa;
                    |QBF aLinea;
                    aLinea = aLinea - "</IDCONTRATO>";
                    aIdContrata = aLinea;
                    |QBT aIdContrata;
                    |SI aIdContrata ! "";
                         swEstado = 2;
                         |HAZ RegistroNetC_Act;
                         |HAZ labhisto_act;
                         |HAZ labregis_act;
                         aAlfa1 = #labtmpc2#15; |QBF aAlfa1;
                         |SI aAlfa1 = "";
                              aAlfa1 = #labhisto#0; |QBF aAlfa1;
                         |FINSI;
                         |SI aAlfa1 = "421"; |O aAlfa1 = "085";
                              |HAZ labacuer_act;
                         |FINSI;
                         swAcaba = 1;
                    |FINSI;
               |FINSI;

               |SI aQueEs = "P";       || es una prorroga
                    aAlfa = aAlfa - "<RESULTADO>";
                    |SI FSalida ! 0;    || prorroga aceptada
                         aLinea = aAlfa;
                         |QBF aLinea;
                         aLinea = aLinea - "</RESULTADO>";
                         aResultado = aLinea;
                         |QBT aResultado;
                         |SI aResultado = "ACEPTADO";
                              swEstado = 2;
                              aIdContrata = eaIdContrato;
                              |HAZ RegistroNetC_Act;
                              |HAZ labhisto_act;
                              /*
                              || se supone que esto no hace falta para la prorroga
                              |HAZ labregis_act;
                              aAlfa1 = #labtmpc2#15; |QBF aAlfa1;
                              |SI aAlfa1 = "";
                                   aAlfa1 = #labhisto#0; |QBF aAlfa1;
                              |FINSI;
                              |SI aAlfa1 = "421"; |O aAlfa1 = "085";
                                   |HAZ labacuer_act;
                              |FINSI;
                              */
                              swAcaba = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;

               aAlfa = aAlfa - "<ERRORES>";
               |SI FSalida ! 0;
                    || Ha habido errores, me los guardo
                    || A partir de aqui leo hasta encontrar la etiqueta </ERRORES>

                    |ABRE #labnct06;

                    |XLEE nHandle, 250, aAlfa; nNumChars = FSalida;
                    swAcaba = 0;
                    |PARA; |SI nNumChars ! 0; |Y swAcaba = 0; |HACIENDO;
                         || es una de las lineas con el codigo de error

                         aAlfa = aAlfa - "</ERRORES>";
                         |QBF aAlfa;
                         aLinea = aAlfa;
                         aLinea = aLinea - "        ";
                         |SI aLinea = "";
                              swAcaba = 1;
                              |SAL;
                              || fin de las lineas de errores;
                         |SINO;
                              aLinea = aLinea - "<ERROR";
                              aCodigo = aLinea % 101;
                              aLinea = aLinea - aCodigo;
                              aAlfa = aLinea % 101;
                              |SI aAlfa ! ">";
                                   aCodigo = aCodigo + aAlfa;
                              |FINSI;
                              aLinea = aLinea - aAlfa;
                              aLinea = aLinea - (aCodigo + ". ");
                              aLinea = aLinea - ("</ERROR" + aCodigo + ">");
                              aLinea = aLinea % 180;

                              || bueno pues en teoria aqui ya tengo el numero
                              || de error y la descripcion, me quedo en principio
                              || con los primeros 80 caracteres

                              aCadena = aLinea;
                              |HAZ Tildes;
                              aLinea = aCadena;

                              #labnct06#0 = #labtmpc2#0;
                              #labnct06#1 = #labtmpc2#17;
                              #labnct06#2 = aCodigo;
                              #labnct06#3 = aLinea;
                              |GRABA 020#labnct06.n;
                              |LIBERA #labnct06;
                         |FINSI;
                         |XLEE nHandle, 250, aAlfa; nNumChars = FSalida;
                    |SIGUE;

                    swEstado = 1;
                    |HAZ RegistroNetC_Act;
                    |HAZ labhisto_act;
                    |CIERRA #labnct06;

                    |SAL;
               |FINSI;
          |SIGUE;
          |XLEE nHandle, 250, aAlfa;
     |FINSI;
     |XCIERRA nHandle1;

     |SI #labtmpc2#23 = 0;
          |MENAV "    Fichero de respuesta NO encontrado. Proceso de envío no completado";
     |FINSI;
     |SI #labtmpc2#23 = 1;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado con errores";
     |FINSI;
     |SI #labtmpc2#23 = 2;
          |MENAV "    Fichero de respuesta encontrado. Proceso de envío finalizado correctamente";
     |FINSI;

     |XCIERRA nHandle;
     aAlfa = #labcontr#63; |QBF aAlfa;
     aAlfa = aAlfa + "\ERRORES\ERRORESNET.XML";
     |RFBORRA aAlfa;
/*
     |SI #labtmpc2#23 = 2;
          |HAZ DSArchi;  || esta mas abajo, el siguiente proceso
     |FINSI;
*/
|FPRC;

|PROCESO Mensaje;
/*
     |PUSHV 11151965;
     |BLANCO 12181763;
     |CUADRO 12181762;
     |ATRI S;
          ||   2         3         4         5        6
          ||   0123456789012345678901234567890123467890
     aMensa = "Pulse ENTER cuando haya validado la ope-";
     |PINTA 1320, aMensa;
     aMensa = "raci¢n y enviado el certificado  online,";
     |PINTA 1420, aMensa;
     aMensa = "para archivar  los documentos recibidos.";
     |PINTA 1520, aMensa;
     |ATRI 0;

     aEsc1  = &255 + "802";
     |PARA; |SI; |HACIENDO;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1;
               |SAL;
          |FINSI;
     |SIGUE;
     |POPV;
*/

     aAlfa = "    SPulse SI para archivar la huella del contrato ";
     aAlfa = aAlfa + "o NO para no archivar.";
     |CONFI aAlfa;
     |SI FSalida ! 0;
          nArchi = 0;
     |FINSI;
|FPRC;

|PROCESO NombreFichero;
     aNif = #labtraba#7; |QBF aNif;
     aCCC = #labcentr#10; |QBF aCCC;
     aFechaAlta = #labtraba#34; |QBF aFechaAlta;

     aFichero1 = aCCC + "_" + aNif + "_" + (aFechaAlta % -104);
     aFichero1 = aFichero1 + (aFechaAlta % 402) + (aFechaAlta % 102);
|FPRC;

|PROCESO inf_nct06;
     #labnct06#0 = #labtmpc2#0;
     #labnct06#1 = #labtmpc2#17;
     #labnct06#2 = 01;
|FPRC;

|PROCESO sup_nct06;
     #labnct06#0 = #labtmpc2#0;
     #labnct06#1 = #labtmpc2#17;
     #labnct06#2 = 99;
|FPRC;

|PROCESO Marca; |TIPO 11;
     |SI FSalida ! 10; |Y FSalida ! 11; |Y FSalida ! 12; |Y FSalida ! 13;
          |ACABA;
     |FINSI;

     |SI FSalida = 10; |Y aParam = "CONTRAT@";
        |SI #labtmpct#14 = " ";
             #labtmpct#14 = "*";
             NumMarcas = NumMarcas + 1;
        |SINO;
             #labtmpct#14 = " ";
             NumMarcas = NumMarcas - 1;
        |FINSI;
        |GRABA 020#labtmpct.a;

        |PONCONTROL 23, "si";
        |PTEC 802;
     |FINSI;
     |SI aParam = "NETCONTRAT@";
          |SI FSalida = 11;
               swNetContrata = 1;
               |HAZ Impresion;
               |HAZ NetContrata;
               |PINTA #labtmpc2#23;
               |PINTA #labtmpc2#24;
               |PINTA #labtmpc2#25;
               |PONCONTROL 23, "si";
          |FINSI;
          |SI FSalida = 12;
               |PUSHV 10012380;
               |CUADRO 10671480
               |ATRI R;
               |PINTA 1169, "Emp:";
               |PINTA 1269, "Tra:";
               |PINTA 1369, "Reg:";
               |ATRI 0;
               |PINTA 1174, #labtmpc2#1;
               |PINTA 1274, #labtmpc2#2;
               |PINTA 1374, #labtmpc2#0;
               |ENTLINEAL #1#labnct06, -3, 4, 22, 1, inf_nct06, sup_nct06;
               |POPV;
               |ERROR;
          |FINSI;
          |SI FSalida = 13;
               |HAZ Correcciones;
               |PINTA #labtmpc2#23;
               |PINTA #labtmpc2#24;
               |PINTA #labtmpc2#25;
               |PONCONTROL 23, "si";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Impresion;
     nLabHisto = 1;
     |SI aParam = "NETCONTRAT@";
          enNumRegis = #labtmpc2#0;
          eaNumProrr = #labtmpc2#17;
     |SINO;
          enNumRegis = #labtmpct#0;
          eaNumProrr = #labtmpct#17;
     |FINSI;

     |SI aParam = "NETCONTRAT@";
          aAlfa = #labtmpc2#16; |QBF aAlfa;
     |SINO;
          aAlfa = #labtmpct#16; |QBF aAlfa;
     |FINSI;
     aAlfa = aAlfa + ".tab";
     |SI aAlfa = "labproli.tab";
          aAlfa = "labprorr.tab";
     |FINSI;

     |SI aParam = "CONTRAT@"; |O aParam = "NETCONTRAT@";
          aAlfa = aAlfa + ";CONTRAT@";
     |FINSI;

     |SUB_EJECUTA_NP aAlfa;

     |ABRE #labregis;
     #labregis#0 = enNumRegis;
     |LEE 101#labregis.=;
     |SI FSalida = 0;
          |SI nSwImp = 0;
               #labregis#27 = "R";
               |GRABA 020#labregis.a;
          |FINSI;
          |LIBERA #labregis;
     |FINSI;
     |CIERRA #labregis;
|FPRC;

|DEFBUCLE Impresion;
     #labtmpct#1;
     14;
          1, "  ", "*";
     999999, "zz", "*";
     ;
     NULL, Impresion;
|FIN;

|RUTINA infimpre;
     #labtmpct#0 = 1;
     #labtmpct#17 = "  ";
|FRUT;

|RUTINA supimpre;
     #labtmpct#0 = 999999;
     #labtmpct#17 = "zz";
|FRUT;

|RUTINA infimpre1;
     #labtmpc1#0 = 1;
     #labtmpc1#17 = "  ";
|FRUT;

|RUTINA supimpre1;
     #labtmpc1#0 = 999999;
     #labtmpc1#17 = "zz";
|FRUT;

|PROCESO infimpre2;
     #labtmpc2#0 = 1;
     #labtmpc2#17 = "  ";
|FPRC;

|PROCESO supimpre2;
     #labtmpc2#0 = 999999;
     #labtmpc2#17 = "zz";
|FPRC;

|PROCESO Registro;
     fFechaAlta = #labregis#7;

     |SI #0#2 [ fFechaAlta; |Y fFechaAlta [ #0#5;
          || adelante
     |SINO;
          |ACABA;
     |FINSI;

     #labempre#0 = #labregis#1;
     |LEE 000#labempre.=;

     #labtraba#0 = #labregis#1;
     #labtraba#1 = #labregis#2;
     |LEE 000#labtraba.=;

     #labhisto#100 = #labregis#0;
     #labhisto#103 = "  ";
     |LEE 000#labhisto.];
     |PARA; |SI FSalida = 0; |Y #labhisto#100 = #labregis#0; |HACIENDO;
          |DDEFECTO #labtmpct;
          #labtmpct#0  = #labregis#0;     || Contador
          #labtmpct#1  = #labregis#1;     || Empresa
          #labtmpct#2  = #labregis#2;     || Trabajador
          #labtmpct#3  = #labempre#2;     || Nombre empresa
          #labtmpct#4  = #labtraba#2;     || Nombre Trabajador
          #labtmpct#5  = #labregis#3;     || DNI
          #labtmpct#6  = #labtraba#75;    || NAFSS
          #labtmpct#7  = #labregis#6;     || Real Decreto
          #labtmpct#8  = #labregis#5;     || Descripcion Real Decreto
          #labtmpct#9  = #labregis#9;     || Meses duracion contrato
          #labtmpct#10 = #labregis#10;    || Dias duracion contrato
          #labtmpct#11 = #labregis#21;    || Fecha registro
          #labtmpct#12 = #labregis#7;     || Fecha inicio contrato
          #labtmpct#13 = #labregis#8;     || Fecha fin contrato
          |SI enWeb ! 0;
               #labtmpct#14 = "*";        || Marcado para PDF's
          |FINSI;
          #labtmpct#15 = #labregis#4;     || Codigo Contrato
          #labtmpct#16 = #labhisto#101;   || Modulo ejecucion
          #labtmpct#17 = #labhisto#103;   || N§ Prorroga
          |SI #labhisto#101 = "labprorr";
               #labtmpct#18 = #labhisto#7; #labtmpct#19 = #labhisto#8;
               #labtmpct#20 = #labhisto#5; #labtmpct#21 = #labhisto#6;
          |FINSI;
          |SI #labhisto#101 = "labproli";
               #labtmpct#18 = #labhisto#9;  #labtmpct#19 = #labhisto#42;
               #labtmpct#20 = #labhisto#10; #labtmpct#21 = #labhisto#11;
          |FINSI;
          #labtmpct#22 = #labregis#27;    || Situacion
          |SI aParam = "NETCONTRAT@";
               #labtmpct#23 = #labhisto#161;    || Situacion Netcontrat@
               #labtmpct#24 = #labhisto#162;    || Descripcion Situacion Netcontrat@
               #labtmpct#25 = #labhisto#163;    || Id Contrat@ Netcontrat@
          |FINSI;
          |GRABA 020#labtmpct.n;
          |LEE 000#labhisto.s;
     |SIGUE;
|FPRC;

|DEFBUCLE Registro;
     #labregis#1;
     1, 2, 27;
          1, #labimpre#0, #labimpre#1, aDSitu;
     999999, #labimpre#3, #labimpre#4, aHSitu;
     ;
     NULL, Registro;
|FIN;

|DEFBUCLE Registro2;
     #labregis#1;
     1, 2, 29;
          1, #labimpre#0, #labimpre#1, aDSitu;
     999999, #labimpre#3, #labimpre#4, aHSitu;
     ;
     NULL, Registro;
|FIN;

|PROCESO Cabeza;
          |ATRI R;
          |SI aParam = "";
               aCabeza = " EMISION DE CONTRATOS  DESDE HISTORICO ";
               |PINTA 0623, aCabeza;
          |FINSI;
          |SI aParam = "CONTRAT@";
               aCabeza = " CREACION DE FICHEROS XML PARA CONTRAT@ ";
               |PINTA 0623, aCabeza;
          |FINSI;
          |SI aParam = "NETCONTRAT@";
               aCabeza = " ENVIO DE CONTRATOS ONLINE ";
               |PINTA 0520, aCabeza;
          |FINSI;
          |ATRI 0;
|FPRC;

|PROCESO EnlaceCont;
|| xxxxxxxxxxxx
     |ABRE #labcontr; |LEE 000#labcontr.p; |CIERRA #labcontr;
     |ABRE #labhisto;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #labcentr;
     |ABRE #nomconca;

     #labtmpc2#0 = enExtRegis;
     #labtmpc2#1 = enExtEmp;
     #labtmpc2#2 = enExtTra;
     #labtmpc2#17 = eaExtProrr;
     #labtmpc2#16 = eaExtDef;
     |HAZ Impresion;
     |HAZ NetContrata;

     |CIERRA #nomconca;
     |CIERRA #labcentr;
     |CIERRA #labtraba;
     |CIERRA #labempre;
     |CIERRA #labhisto;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "ENLACECONT";     || vengo directamente del contrato
          aParam = "NETCONTRAT@";
          |HAZ EnlaceCont;
          |ACABA;
     |FINSI;
     |SI aParam ! ""; |Y aParam ! "CONTRAT@"; |Y aParam ! "NETCONTRAT@";
          |HAZ LeeParam;
          |HAZ LeeOrigen;

          |ABRE #labhisto;
          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #labcentr;
          aAlfa = "li" + Usuario; |NOME_DAT #1 aAlfa; |NOME_DAT #4 aAlfa;
          |DELINDEX #labtmpct;
          |ABRE #labtmpct;

          |ABRE #labregis;
          #labregis#0 = enWeb;
          |LEE 000#labregis.=;
          |SI FSalida = 0;
               |HAZ Registro;
          |FINSI;
          |CIERRA #labregis;

          |BUCLE Impresion;

          |CIERRA #labhisto;
          |CIERRA #labempre;
          |CIERRA #labtraba;
          |CIERRA #labcentr;
          |CIERRA #labtmpct;
          |DELINDEX #labtmpct;
     |SINO;
          |CLS;
          |CABEZA "Historico contratos";
          |PINPA #0#0;
          |PINDA #0#0;

          |HAZ Cabeza;

          |SI aParam = "CONTRAT@"; |O aParam = "NETCONTRAT@";
               |ABRE #labcontr;
               |LEE 000#labcontr.p;
               |SI FSalida ! 0; |DDEFECTO #labcontr; |FINSI;
               |CIERRA #labcontr;
               |SI #labcontr#55 = "N";
                    |MENAV "    Opcion para uso de Contrat@ desactivada";
                    |ACABA;
               |FINSI;
               |CUADRO 1623 1859;
               |C_M #labimpre#11, 1, "S"; |C_V #labimpre#11, 1, "S";
               |C_P #labimpre#11, 1, 1751; |PINTA #labimpre#11;
               |PINTA 1724, "Pendientes / Todos (P/T) :";
          |FINSI;
          |ABRE #labcontr;
          |LEE 000#labcontr.p;
          |CIERRA #labcontr;
          |SI #labcontr#50 = "N";
               |MENAV "    Opcion de historico de contratos desactivada";
               |ACABA;
          |FINSI;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |ABRE #labhisto;
               |ABRE #labempre;
               |ABRE #labtraba;
               |ABRE #labcentr;
               aAlfa = "li" + Usuario;
               |NOME_DAT #1 aAlfa;
               |NOME_DAT #4 aAlfa;
               |NOME_DAT #102 aAlfa;
               |DELINDEX #labtmpct;
               |ABRE #labtmpct;
               |ABRE #labtmpc1;
               |ABRE #labtmpc2;
               |SI aParam = "CONTRAT@";
                  |SI #labimpre#11 = "P";
                     aDSitu = "P"; aHSitu = "P";
                  |SINO;
                     aDSitu = " "; aHSitu = "z";
                  |FINSI;
                  |BUCLE Registro;
                  |ENTLINEAL #1#labtmpct,-1,4,21,1,infimpre,supimpre;
                  |SI NumMarcas > 0;
                     aAlfa = #labcontr#44;
                     |QBF aAlfa;
                     Impresora = aAlfa;
                     ||IMPRE 0;
                     |SI FSalida = 0;
                         aAlfa = "tm" + Usuario; |NOME_DAT #2000 aAlfa;
                         |DELINDEX #labtmpdt; |ABRE #labtmpdt; nLinea = 1;
                         |ABRE #labvaltb;
                         nSwError = 0; |HAZ Comprobacion;
                         |PARA; |SI nSwError = 1; |HACIENDO;
                            |PUSHV 0501 2380;
                            |ENTLINEAL #1#labtmpdt, -1, 4, 18, 1, inf, sup;
                            |POPV;
                            |CIERRA #labtmpdt; |DELINDEX #labtmpdt; |ABRE #labtmpdt;
                            nSwError = 0; |HAZ Comprobacion;
                            |SI nSwError ! 0;
                               |CONFI "    NAun hay datos erroneos. Volver a editar ?";
                               |SI FSalida ! 0;
                                  nSwError = 1; |SAL;
                               |FINSI;
                            |FINSI;
                         |SIGUE;

                         |CIERRA #labvaltb;
                         |CIERRA #labtmpdt; |DELINDEX #labtmpdt;
                         |SI nSwError = 0;
                            |BUCLE Impresion;
                            |HAZ GeneraXML;
                         |FINSI;
                     |SINO;
                         aAlfa = "0000Impresora [" + Impresora + "] inaccesible o inexistente.";
                         |MENAV aAlfa;
                     |FINSI;
                     ||FINIMP;
                  |FINSI;
               |SINO;
                  |SI aParam = "NETCONTRAT@";
                       |SI #labimpre#11 = "P";
                            aDSitu = " "; aHSitu = "1";
                       |SINO;
                            aDSitu = " "; aHSitu = "2";
                       |FINSI;

                       |BUCLE Registro2;
                       |ENTLINEAL #1#labtmpc2, -1, 4, 22, 1, infimpre2, supimpre2;
                  |SINO;
                       aDSitu = " "; aHSitu = "z";
                       |BUCLE Registro;
                       |ENTLINEAL #1#labtmpc1,-1,4,21,1,infimpre1,supimpre1;
                   |FINSI;
               |FINSI;
               |CIERRA #labcentr;
               |CIERRA #labhisto; |CIERRA #labempre; |CIERRA #labtraba;
               |CIERRA #labtmpc1; |CIERRA #labtmpct;
               |CIERRA #labtmpc2;
               |DELINDEX #labtmpct;
               |DELINDEX #labtmpc2;
          |FINSI;
     |FINSI;
|FPRO;

_________________________________________ DESDE WEB
|VARIABLES;
     aRutaDes = "";
     aRutaDatos = "";
     aDirOri = "";
     nCanal = 0;
     aCabecera = "";
     aWRegistro = "";
     aDireccion = "";
|FIN;

|PROCESO LeeParam;
     |DBASS aRutaDes;
     |DBASS aRutaDatos;
     |QBF aRutaDes;
     |QBF aRutaDatos;
     aRutaDes = aRutaDes + "dsnetcom/def/dsnetm00.mas";
     |CARGA_DEF aRutaDes, dsnetm00@;
     |SI FSalida ! 0;
          |MENAV "    Error en CARGADEF: dsnetm00";
     |SINO;
          aRutaDatos = aRutaDatos + "dsnetcom/fich/";
          |PATH_DAT #150 aRutaDatos;
          |ABRE #150;
          |LEE 000#150p;
          |SI FSalida = 0;
               eaWebDirDes = #150#7;    |QBF eaWebDirDes;
               aDirOri = eaWebDirDes;
          |SINO;
               |MENAV "    Error de datos en fichero de configuracion dsnetm00";
          |FINSI;
          |CIERRA #150;
     |FINSI;
     |DESCARGA_DEF #dsnetm00@;
|FPRC;

|PROCESO LeeOrigen;

     eaWebArchivo = PARAMETRO;
     |QBF aDirOri;
     aRuta = aDirOri + eaWebArchivo;

     |XABRE "U", aRuta, nCanal;
     |SI FSalida ] 0;
          |XLEE nCanal, 100, aCabecera;
          |XLEE nCanal, 10, aWRegistro;
          |XLEE nCanal, 100, aDireccion;
     |FINSI;
     |XCIERRA nCanal;
     |QBF aCabecera;
     |QBF aWRegistro;
     |QBF aDireccion;

     enWeb = aWRegistro;
     eaWebDirPDF = aDireccion + "/pdf/";
|FPRC;

|PROCESO Contratos;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/co" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Contratos;
     #labenvcl#1;
     11;
     #labenvcc#0, #labenvcc#6, 001, "C";
     #labenvcc#0, #labenvcc#6, 999, "C";
     ;
     NULL, Contratos;
|FIN;

|PROCESO Prorrogas;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/pr" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Prorrogas;
#labenvcl#1;
11;
#labenvcc#0, #labenvcc#6, 001, "P";
#labenvcc#0, #labenvcc#6, 999, "P";
;
NULL,Prorrogas;
|FIN;

|PROCESO Transformaciones;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/tr" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE Transformaciones;
#labenvcl#1;
11;
#labenvcc#0, #labenvcc#6, 001, "T";
#labenvcc#0, #labenvcc#6, 999, "T";
;
NULL,Transformaciones;
|FIN;

|PROCESO CopiasBasicas;
   aAlfa = #labenvcl#10; |QBF aAlfa;
   aFichs = "C:/DOCUMENTOS/Contrat@/cb" + (("000000" + #labenvcl#9) % -106) + (("00" + aAlfa) % -102) + ".txt";
   |XABRE "CB", aFichs, nHandle1;
   |SI FSalida ] 0;
      |XLEE nHandle1, 20, aAlfa;
      |PARA; |SI FSalida ! 0; |HACIENDO;
          |XGRABA nHandle, aAlfa;
          |XLEE nHandle1, 20, aAlfa;
      |SIGUE;
      |XCIERRA nHandle1;
   |FINSI;

   |ABRE #labregis;
   #labregis#0 = #labenvcl#9;
   |LEE 101#labregis.=;
   |SI FSalida = 0;
      #labregis#27 = "R";
      |GRABA 020#labregis.a; |LIBERA #labregis;
   |FINSI;
   |CIERRA #labregis;
|FPRC;

|DEFBUCLE CopiasBasicas;
#labenvcl#1;
;
#labenvcc#0, #labenvcc#6, 001;
#labenvcc#0, #labenvcc#6, 999;
;
NULL,CopiasBasicas;
|FIN;

|PROCESO GeneraXML;
   nSwCont = 0;
   nSwTrns = 0;
   nSwPror = 0;
   nSwCPBs = 0;

   |ABRE #labenvcc; |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "C";
         nSwCont = 1;
         || aAlfa = "C:/DOCUMENTOS/Contrat@/";
         aAlfa = #labcontr#51; |QBF aAlfa; aAlfa = aAlfa + "/";
         |RMKDIR aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "co" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         ||XABRE "BW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<CONTRATOS>" + &13 + &10;                                                                             |XGRABA nHandle, aAlfa;
            |BUCLE Contratos;
            aAlfa = "</CONTRATOS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "P";
         nSwPror = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "pr" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<PRORROGAS>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE Prorrogas;
            aAlfa = "</PRORROGAS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "O";
         nSwCPBs = 1;
         || aAlfa = "C:/DOCUMENTOS/Contrat@/";
         aAlfa = #labcontr#51; |QBF aAlfa; aAlfa = aAlfa + "/";
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "cb" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         ||XABRE "BW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<COPIASBASICAS>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE CopiasBasicas;
            aAlfa = "</COPIASBASICAS>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #2#labenvcc;
   |LEE 000#labenvcc.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      swHeGrabado = 0;
      |SI #labenvcc#3 = "          "; |Y #labenvcc#5 = "T";
         nSwTrns = 1;
         aAlfa = #labcontr#51;
         aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
         aAlfa1 = (("000000" + #labenvcc#0) % -106) + (("00000" + #labenvcc#6) % -105);
         aFich = aAlfa + "tr" + aAlfa1 + ".xml";
         |XABRE "CBW", aFich, nHandle;
         |SI FSalida ] 0;
            #labenvcc#4 = aFich;
            fFecha = ~;                        #labenvcc#1 = fFecha;
            |HORA aAlfa; aAlfa = aAlfa % 0105; #labenvcc#2 = aAlfa;
            aAlfa = Usuario % 0810;            #labenvcc#3 = aAlfa;
            aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;     |XGRABA nHandle, aAlfa;
            aAlfa = "<TRANSFORMACIONES>" + &13 + &10;                                                                          |XGRABA nHandle, aAlfa;
            |BUCLE Transformaciones;
            aAlfa = "</TRANSFORMACIONES>" + &13 + &10;                                                                         |XGRABA nHandle, aAlfa;
            |GRABA 020#labenvcc.a; |LIBERA #labenvcc;
            |SI FSalida = 0;    || asi se que he grabado algo, luego de esto de-
               swHeGrabado = 1; || pendera si sigo o si vuelvo al primero, sin es-
            |FINSI;             || to si hay mas de una empresa no va bien
         |FINSI;
         |XCIERRA nHandle;
      |FINSI;
      |SI swHeGrabado = 1;         || vuelvo a leer el primero
          |LEE 000#labenvcc.p;
      |SINO;                       || sigo por el siguiente
          |LEE 000#labenvcc.s;
      |FINSI;
   |SIGUE;

   |SELECT #1#labenvcc;
   |CIERRA #labenvcc;

   |SI nSwCont ! 0; |O nSwPror ! 0; |O nSwCPBs ! 0; |O nSwTrns ! 0;
      aAlfa1 = "    Ficheros generados correctamente en el directorio '";
      aAlfa = #labcontr#51;
      aRuta = aAlfa; |HAZ CompRuta; aAlfa = aRuta; |QBF aAlfa;
      aAlfa = aAlfa1 + aAlfa + "'";
      |MENAV aAlfa;
   |FINSI;
|FPRC;

|RUTINA inf;
   #labtmpdt#0 = 0000001;
|FRUT;

|RUTINA sup;
   #labtmpdt#0 = 9999999;
|FRUT;

|PROCESO Comprueba;
   nSwError = 0;
   aClv1 = #labtraba#0; aClv2 = #labtraba#1;

   aCodPos = (("00" + #labtraba#8) % -102) + (("000" + #labtraba#9) % -103);
   aFich = "labtraba"; nCampo = 6;  |HAZ CompruebaMunic;

   || aFich = "labtraba"; nCampo = 12; aTabla = "stiacatc"; nCmp = 1; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 12; aTabla = "thitiaca"; nCmp = 1; |HAZ CompruebaValor;
   || aFich = "labtraba"; nCampo = 19; aTabla = "socupatc"; nCmp = 1; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 19; aTabla = "taiclaoc"; nCmp = 1; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 33; aTabla = "tfggrcot"; nCmp = 0; |HAZ CompruebaValor;
   aFich = "labtraba"; nCampo = 73; aTabla = "tbonvfor"; nCmp = 0; |HAZ CompruebaValor;
   aAlfa = #labtraba#7; |QBF aAlfa; aAlfa = aAlfa % 0101;
   |SI aAlfa < "0"; |O aAlfa > "9";
      aFich = "labtraba"; nCampo = 76; aTabla = "spaisxtc"; nCmp = 1; |HAZ CompruebaValor;
   |FINSI;

   || aClv1 = #labempre#0; aClv2 = "";
   || aFich = "labempre"; nCampo = 12; aTabla = "sacecotc"; nCmp = 1; |HAZ CompruebaValor;

   aClv1 = #labtraba#0; aClv2 = #labtraba#1;
   aFich = "labpadre"; nCampo = 5; aTabla = "ssexoxtc"; nCmp = 0; |HAZ CompruebaValor;
|FPRC;

|PROCESO CompruebaMunic;
   nTecla = FSalida;

   |ABRE #labmunic; |DDEFECTO #labmunic;

   #labmunic#4 = aCodPos;
   |LEE 000#labmunic.];
   |SI FSalida = 0; |Y #labmunic#4 = aCodPos;
      |SALVA_FICHA #labmunic;
      |LEE 000#labmunic.s;
      |SI FSalida = 0; |Y #labmunic#4 = aCodPos;
         nSwUno = 0;
      |SINO;
         nSwUno = 1;
      |FINSI;
      |REPON_FICHA #labmunic;
      |SI nSwUno = 0;
         #labmunic#4 = aCodPos;
         |LEE 000#labmunic.];
         |PARA; |SI FSalida = 0; |Y #labmunic#4 = aCodPos; |HACIENDO;
            aAlfa1 = #labmunic#3; |QBF aAlfa1; aLong = aAlfa1 % 0; nCalc1 = aLong;
            aAlfa2 = #labtraba#6; |QBF aAlfa2; aLong = aAlfa2 % 0; nCalc2 = aLong;
            |SI nCalc1 ] nCalc2;
               nCalc = 100 + nCalc2; aAlfa = aAlfa % nCalc;
            |SINO;
               nCalc = 100 + nCalc1; aAlfa1 = aAlfa1 % nCalc;
            |FINSI;
            |SI aAlfa1 = aAlfa2; |SAL; |FINSI;
            |LEE 000#labmunic.s;
         |SIGUE;
         |SI aAlfa1 ! aAlfa2;
            aCodPos = (("00" + #labtraba#8) % -102) + (("000" + #labtraba#9) % -103);
            |SUB_EJECUTA "labmunic.tab";
            #labmunic#1 = aCodigoMunicipio;
            #labmunic#4 = aCodPos;
            |LEE 000#labmunic.=;
            |SI FSalida ! 0; |DDEFECTO #labmunic; |FINSI;
            #labtraba#6 = #labmunic#3; |PINTA #labtraba#6;
         |FINSI;
      |FINSI;
      |SI nSwUno = 1;
         #labtraba#6 = #labmunic#3; |PINTA #labtraba#6;
      |FINSI;
   |SINO;
      nSwError = 1; |ACABA;
      ||MENAV "    No se encuentra el codigo postal en la tabla de municipios"; |ERROR;
   |FINSI;
   |CIERRA #labmunic;
|FPRC;

|PROCESO CompruebaValor;
   |DDEFECTO #labvaltb;
   #labvaltb#0 = aFich;
   #labvaltb#1 = nCampo;
   #labvaltb#5 = aClv1;
   #labvaltb#6 = aClv2;
   |LEE 000#labvaltb.=;
   |SI FSalida = 0;
      aValor = #labvaltb#4; |QBF aValor;
      |SI aFich = "labempre";
         aAlfa = #labempre#nCampo#; |QBF aAlfa;
/*
         |SI aAlfa ! aValor;
            #labempre#nCampo# = aValor;
            |GRABA 020#labempre.a;
         |FINSI;
*/
      |FINSI;
      |SI aFich = "labtraba";
         aAlfa = #labtraba#nCampo#; |QBF aAlfa;

         |SI aFich = "labtraba"; |Y nCampo = 76;
            aAlfa1 = aAlfa % 0101;
            |SI aAlfa ] "0"; |Y aAlfa [ "9"; aAlfa = aAlfa % 0599; |FINSI;

            aLon = aValor % 0;
            nLon = aLon;
            |SI nLon ] 27;    || tama¤o maximo del campo del labtraba sin cod. pais
                 aAlfa = aValor;
            |FINSI;

            aValor = aAlfa;
         |FINSI;
      |FINSI;
   |SINO;
      |DBASE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "def/" + aFich + ".mas";
      |CARGA_DEF aAlfa, Referen@;
      |SI FSalida = 0;
         |ABRE #Referen@;
         nClave = 1;
         aAlfa = "|K000"; aAlfa = #Referen@#aAlfa#; aAlfa = aAlfa % 0499;
         |PARA; |SI aAlfa ! ""; |HACIENDO;
            |SI nClave = 1; aClv = aClv1; |FINSI;
            |SI nClave = 2; aClv = aClv2; |FINSI;
            aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
            #Referen@#nCalc# = aClv;
            nClave = nClave + 1;
         |SIGUE;
         |LEE 000#Referen@.=;
         |SI FSalida = 0;
            aValor = #Referen@#nCampo#; |QBF aValor;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "TIPO";     aTipoDat = #Referen@#aAlfa#;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "LONGITUD"; nLongDat = #Referen@#aAlfa#;
            |SI aTipoDat = "N";
               aAlfa = "0" * nLongDat; aAlfa = aAlfa + aValor;
               nLongDat = -(nLongDat + 100); aValor = aAlfa % nLongDat;
            |FINSI;
         |SINO;
            |SI aTabla = "ssexoxtc";
               |DDEFECTO #Referen@;
               nClave = 1;
               aAlfa = "|K000"; aAlfa = #Referen@#aAlfa#; aAlfa = aAlfa % 0499;
               |PARA; |SI aAlfa ! ""; |HACIENDO;
                  |SI nClave = 1; aClv = aClv1; |FINSI;
                  |SI nClave = 2; aClv = aClv2; |FINSI;
                  aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
                  #Referen@#nCalc# = aClv;
                  nClave = nClave + 1;
               |SIGUE;
               |GRABA 020#Referen@.n;
            |SINO;
               |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
               nSwError = 1; |ACABA;
            |FINSI;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |FINSI;
   ||SINO;
   ||   nSwError = 1; |ACABA;
   |FINSI;

   nSwNuevo = 0;
/*
   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "def/" + aTabla + ".mas";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida < 0;
      aAlfa1 = aTabla;
      aAlfa = "SELECT * FROM labcotmp INTO " + aAlfa1 + ".def WHERE"; |SQL aAlfa;
      nSwNuevo = 1;
   |SINO;
      nSwNuevo = 0;
   |FINSI;
*/
   aAlfa1 = aTabla; |QBF aAlfa1; aAlfa1 = aAlfa1 - ".txt";
   |DBASE aAlfa; aAlfa = aAlfa + "def/" + aAlfa1 + ".mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |ABRE #Referen@;
      |LEE 000#Referen@.p;
      |SI FSalida ! 0; nSwLectura = 1; |FINSI;
      |SI nSwNuevo = 1; |O nSwLectura = 1; |DELINDEX #Referen@; |FINSI;
      |ABRE #Referen@;
      |SI nSwLectura = 1;
         aLF = &13; aComillas = &34; aCR = &10;
         |DBASE aAlfa; aAlfa = aAlfa + "tablas/" + aTabla + ".txt";
         aAlfa = "rb  " + aAlfa;
         |FABRE aAlfa;
         |SI FSalida ] 0;
            nHandle = FSalida;
            |MENSA "    Rellenando tabla .....";
            nCampo1 = 0; nAbierto = 0; nPosic = 0;
            |DDEFECTO #Referen@;
            aAlfa = nHandle + " 250"; |FLEE aAlfa;
            |PARA; |SI FSalida > 0; |HACIENDO;
               aAlfa1 = aAlfa - aLF;
               |PARA; |SI FSalida ! 0; |HACIENDO;
                  nCalc = ((FSalida / 100) ! 0) - 1; nPosic = nPosic + nCalc;
                  |SI nCalc > 99;
                     nCalc1 = 199; aAlfa1 = aAlfa % nCalc1; aAlfa = aAlfa - aAlfa1;
                     nCalc = nCalc - 99;
                  |SINO;
                     aAlfa1 = "";
                  |FINSI;
                  nCalc = nCalc + 100; aAlfa2 = (aAlfa % nCalc);
                  aAlfa1 = aAlfa1 + aAlfa2; aAlfa = aAlfa - aAlfa2;
                  aAlfa2 = aLF + aCR;     aAlfa = aAlfa - aAlfa2; nPosic = nPosic + 2;
                  nCampo1 = 0;
                  aAlfa2 = aAlfa1 - ";";
                  |PARA; |SI FSalida ! 0; |HACIENDO;
                     nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2 = aAlfa1 % nCalc;
                     aLong = aAlfa1 % 0; nLong = aLong;
                     |SI nLong > 99;
                        nCalc1 = ((((FSalida / 100) ! 0) + 1) * 100) + 99; aAlfa3 = aAlfa1 % nCalc1;
                        aAlfa1 = aAlfa1 - aAlfa3;                    aAlfa1 = aAlfa1 % nCalc1;
                        aAlfa1 = aAlfa3 + aAlfa1;
                     |SINO;
                        nCalc = FSalida + 198;                       aAlfa1 = aAlfa1 % nCalc;
                     |FINSI;
                     aAlfa2 = aAlfa2 - aComillas;
                     |PARA; |SI FSalida ! 0; |HACIENDO;
                        aAlfa2 = aAlfa2 - aComillas;
                     |SIGUE;
                     |SI nCampo = 2; |O nCampo = 3;
                        aAlfa2 = (aAlfa2 % 0702) + "." + (aAlfa2 % 0502) + "." (aAlfa2 % 0104);
                     |FINSI;
                     #Referen@#nCampo1# = aAlfa2;
                     nCampo1 = nCampo1 + 1;
                     aAlfa2 = aAlfa1 - ";";
                  |SIGUE;
                  aAlfa1 = aAlfa1 - aComillas;
                  |PARA; |SI FSalida ! 0; |HACIENDO;
                     aAlfa1 = aAlfa1 - aComillas;
                  |SIGUE;
                  |SI nCampo = 2; |O nCampo = 3;
                     aAlfa1 = (aAlfa1 % 0702) + "." + (aAlfa1 % 0502) + "." (aAlfa1 % 0104);
                  |FINSI;
                  aCadena = aAlfa1; |HAZ QuitaRaros; aAlfa1 = aCadena;
                  #Referen@#nCampo1# = aAlfa1;
                  #Referen@#4 = aTabla;
                  |GRABA 020#Referen@.n; |DDEFECTO #Referen@;
                  aAlfa1 = aAlfa - aLF;
                  |SI aAlfa1 = ""; FSalida = 0; |FINSI;
               |SIGUE;
               Pos = nPosic;
               aAlfa = nHandle + " 250"; |FLEE aAlfa;
            |SIGUE;
            |BLIN 4;
         |FINSI;
         FSalida = nHandle; |FCIERRA FSalida;
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;

   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "def/" + aTabla + ".mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |ABRE #Referen@;
      |SI nCmp = 0; |SELECT #1#Referen@; |FINSI;
      |SI nCmp = 1; |SELECT #2#Referen@; |FINSI;
      #Referen@#nCmp# = aValor;
      |LEE 000#Referen@.=;
      |SI FSalida ! 0;
         |DBASE aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "def/" + aFich + ".mas";
         |CARGA_DEF aAlfa, Refere1@;
         |SI FSalida = 0;
            |ABRE #Refere1@; nClave = 1; aRegistro = "";
            aAlfa = "|TITULO"; aTitulo = #Refere1@#aAlfa#;
            aAlfa = "|C" + (("000" + nCampo) % -103) + "NOMBRE";
            aNombre = #Refere1@#aAlfa#;
            aAlfa = "|K000"; aAlfa = #Refere1@#aAlfa#; aAlfa = aAlfa % 0499;
            |PARA; |SI aAlfa ! ""; |HACIENDO;
               |SI nClave = 1; aClv = aClv1; |FINSI;
               |SI nClave = 2; aClv = aClv2; |FINSI;
               aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499; nCalc = aAlfa1;
               #Refere1@#nCalc# = aClv;
               nClave = nClave + 1;
            |SIGUE;
            |LEE 000#Refere1@.=;
            |SI FSalida = 0;
               aRegistro = #Refere1@#2;
               aAlfa1 = aClv1; |QBF aAlfa1;
               |SI aAlfa1 ! "";
                  aAlfa = "[" + aAlfa1;
                  aAlfa1 = aClv2; |QBF aAlfa1;
                  |SI aAlfa1 ! "";
                     aAlfa = aAlfa + "/" + aAlfa1 + "] ";
                  |SINO;
                     aAlfa = aAlfa + "] ";
                  |FINSI;
               |SINO;
                  aAlfa1 = aClv2; |QBF aAlfa1;
                  |SI aAlfa1 ! ""; aAlfa = "[" + aAlfa1 + "] "; |FINSI;
               |FINSI;
               aRegistro = aAlfa + aRegistro;
            |FINSI;
            |CIERRA #Refere1@; |DESCARGA_DEF #Refere1@;
         |FINSI;

         |DDEFECTO #labtmpdt;
         |SELECT #2#labtmpdt;
         #labtmpdt#1 = aFich;
         #labtmpdt#2 = nCampo;
         #labtmpdt#3 = aClv1;
         #labtmpdt#4 = aClv2;
         |LEE 000#labtmpdt.=;
         nSalida = FSalida;
         |SELECT #1#labtmpdt;
         |SI nSalida ! 0;
            |DDEFECTO #labtmpdt;
            #labtmpdt#0 = nLinea; nLinea = nLinea + 1;
            #labtmpdt#1 = aFich;
            #labtmpdt#2 = nCampo;
            #labtmpdt#3 = aClv1;
            #labtmpdt#4 = aClv2;
            #labtmpdt#5 = aValor;
            #labtmpdt#6 = aTitulo;
            #labtmpdt#7 = aNombre;
            #labtmpdt#8 = aRegistro;
            |GRABA 020#labtmpdt.n;
            nSwError = 1;
         |FINSI;
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |SINO;
      nSwError = 1; |ACABA;
   |FINSI;
|FPRC;

|PROCESO SeparaNombre;
   aNom = ""; aApel1 = ""; aApel2 = "";
   nInd = 1;
   aLong = aAlfa % 0; nLong = aLong;
   aAlfa1 = aAlfa -",";
   |SI FSalida ! 0;
      nCalc = FSalida + 98;
      aAlfa1 = aAlfa % nCalc;
      aNom = aAlfa1;
      |PARA; |SI; |HACIENDO;
         aAlfa1 = aNom % 0101;
         |SI aAlfa1 = " "; |O aAlfa1 = ",";
            aNom = aNom % 0299;
         |SINO;
            |SAL;
         |FINSI;
      |SIGUE;
      nHayComa = 1;
      aAlfa1 = aAlfa - ",";
      nCalc = ((FSalida / 100) ! 0) + 99;
      aAlfa = aAlfa % nCalc;
   |SINO;
     nHayComa = 0;
   |FINSI;
   aAlfa1 = "";
   |PARA nCalc = 1; |SI nCalc [ nLong; |HACIENDO nCalc = nCalc + 1;
      nPos = (nCalc * 100) + 1;
      aAlfa2 = aAlfa % nPos;
      |SI aAlfa2 = " "; |O aAlfa2 = ",";
         |SI aAlfa1 ! "DE";
          |Y aAlfa1 ! "de";
          |Y aAlfa1 ! "LA";
          |Y aAlfa1 ! "la";
          |Y aAlfa1 ! "LAS";
          |Y aAlfa1 ! "las";
          |Y aAlfa1 ! "LOS";
          |Y aAlfa1 ! "los";
          |Y aAlfa1 ! "DEL";
          |Y aAlfa1 ! "del";
            |SI nHayComa = 0;
               |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
               |SI nInd = 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
               |SI nInd ] 3; aNom   = aNom   + aAlfa1 + " "; |FINSI;
                nInd = nInd + 1;
            |SINO;
               |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
               |SI nInd ] 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
                nInd = nInd + 1;
            |FINSI;
         |SINO;
            |SI nHayComa = 0;
               |SI nInd > 1; nInd = nInd - 1; |FINSI;
               |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
               |SI nInd = 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
               |SI nInd ] 3; aNom   = aNom   + aAlfa1 + " "; |FINSI;
            |SINO;
               ||SI nInd > 1; nInd = nInd - 1; |FINSI;
               |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
               |SI nInd ] 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
            |FINSI;
         |FINSI;
         aAlfa1 = "";
      |SINO;
         aAlfa1 = aAlfa1 + aAlfa2;
      |FINSI;
   |SIGUE;
   |QBF aAlfa1;
   |SI aAlfa1 ! "";
      |SI nHayComa = 0;
         |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
         |SI nInd = 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
         |SI nInd ] 3; aNom   = aNom   + aAlfa1 + " "; |FINSI;
      |SINO;
         |SI nInd = 1; aApel1 = aApel1 + aAlfa1 + " "; |FINSI;
         |SI nInd ] 2; aApel2 = aApel2 + aAlfa1 + " "; |FINSI;
      |FINSI;
   |FINSI;

   |PARA; |SI SwSalir = 0; |HACIENDO;
      SwSalir = 1;
      aAlfa1 = aApel1 % 0101;
      |SI aAlfa1 = " "; aApel1 = aApel1 % 0299; SwSalir = 0; |FINSI;
      aAlfa1 = aApel2 % 0101;
      |SI aAlfa1 = " "; aApel2 = aApel2 % 0299; SwSalir = 0; |FINSI;
      |SI nHayComa = 0;
         aAlfa1 = aNom   % 0101;
         |SI aAlfa1 = " "; aNom   = aNom   % 0299; SwSalir = 0; |FINSI;
      |FINSI;
   |SIGUE;
   |QBF aNom; |QBF aApel1; |QBF aApel2;
   aNom = aNom % 115;         || limitacion ticket 423.403 retocado 05.07.2005
   aApel1 = aApel1 % 120;
   aApel2 = aApel2 % 120;
   |SI aNom = ""; |Y aApel1 ! ""; |Y aApel2 ! "";
      aNom = aApel1;
      aApel1 = aApel2;
      aApel2 = "";
   |FINSI;
|FPRC;

|PROCESO Ayuda001; |TIPO 7;
     |SI aParam = "NETCONTRAT@";
          |MENSA "    <F3> Enviar Online, <F4> Consulta errores, <F5> Correccion errores";
     |FINSI;
     |SI aParam = "CONTRAT@";
          |MENSA "    Pulse < F2 > para marcar/desmarcar el registro para su envio";
     |FINSI;
|FPRC;
