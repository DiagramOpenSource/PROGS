|| ---------------------------------------
|| Presupuestos
|| ---------------------------------------

|FICHEROS;
     dslpz001 #0;
     dslpm000 #100;
     dslpm001 #1;
     dslpm008 #8;
     dslpm011 #11;
     dslpm521 #521;
     dslpm522 #522;
     dslpw042 #942;
|FIN;

|VARIABLES;
      aAlfa         = "";
      aDocRtf       = "";
      aNif          = "";
      aAbre         = "";
      aBase         = "";
      aIPRemoto     = "";

      nHandle       = 0;
      nSwHay        = 0;
      nPers         = 0;
      nCampo        = 0;
      nHastaCampo   = 0;
      nContador     = 0;
      nNume         = 0;
      nPos          = 0;
      nPosi         = 0;
      nColumna      = 0;

     &enCliente      = 0;
     &enModelo       = 0;
     &enFichero      = 0;
     &eaNomFichero   = "";
     &enError        = 0;
     &eaAlfa         = "";
     &eaAsigna       = "";
     &eaConten       = "";
     &eaHora         = "";
     &enWord1        = 0;
     &enCamWord      = 0;
     &enCargaPuntero = 0;
     &eaGuarda       = "";
     &enTipoDoc      = 0;
     &enDocumento    = 0;
     &eaFecha        = "";
     &efFecha        = @;
     &enPresenta     = 0;
     &eaImporte      = "";

     &eaDirPlantilla  = "";
     &eaDirTrabajo    = "";
     &eaDirTrabServi  = "";
     &eaDirSerGuarda  = "";
     &eaDirSerPlan    = "";
     &eaOrigen        = "";
     &eaDestino       = "";
     &eaDestinoTra    = "";
     &eaFicheroTra    = "";
     &eaFicheroDef    = "";
     &eaFicheroXgz    = "";
     &eaFicheroTgz    = "";
     &eaFicheroTar    = "";
     &eaFicheroTxt    = "";
     &enHandleTxt     = 0;
     &eaFicheroPlaGz  = "";
     &eaFicheroPlaMl  = "";
     &eaPathLogo      = "";
     &eaRaiz          = "";
     &eaModoPresenta  = "";
|FIN;

|PROCESO AbreDocuAE;
     |DBASE aBase;  |QBF aBase;
     |HORA eaHora;
     enDocumento    = 0;

     |HAZ SacaDocumentos;
     |SI eaNomFichero = "";  |ACABA;  |FINSI;

     eaDirPlantilla = "C:\DOCUMENTOS\DSLPD\PLANTILLAS\";
     eaDirTrabajo   = "C:\DOCUMENTOS\DSLPD\DOCDSLPD\";
     eaDirSerPlan   = aBase  + "documentos/plantillas/";
     eaDirSerGuarda = aBase  + "documentos/clientes/" + (("00000" + #1#1) % -105) + "/";
     eaDirTrabServi = aBase  + "documentos/tmp/";
     eaRaiz         = eaNomFichero - ".xgz";
     eaFicheroTra   = eaRaiz + "." + "doc";
     eaFicheroXgz   = eaRaiz + ".xgz";
     eaFicheroTar   = eaRaiz + ".tar";
     eaFicheroTgz   = eaRaiz + ".tgz";
     eaFicheroTxt   = eaRaiz + ".txt";
     eaFicheroPlaGz = (eaRaiz + ".xgz") < "";
     eaFicheroPlaMl = (eaRaiz + ".doc") < "";

     |MKDIR eaDirTrabServi;

     eaOrigen       = eaDirSerPlan   + eaFicheroPlaGz;
     eaDestino      = eaDirPlantilla + eaFicheroPlaGz;
     eaDestinoTra   = eaDirTrabajo   + eaFicheroPlaGz;

     |HAZ MiraDirectorios;
     |HAZ EnviaFicheroConMD5;
     |HAZ DescomprimeFichero;

     aAbre = eaDirTrabajo + eaFicheroTra;
     |XABRE "EC", aAbre, nHandle;
     |SI FSalida < 0;
         aAlfa   = "0000 El Documento " + aAbre + " no esta instalado. Instalelo.";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     aAbre = eaDirTrabServi + eaFicheroTxt;
     |XABRE "WB", aAbre, enHandleTxt;

     aAlfa = "[FICHERO]#" + eaDirTrabajo + eaFicheroTra + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;
|FPRC;

|PROCESO CierraDocuAE;
     |HAZ MiraLogos;

     aAlfa = "[LIMPIA FINAL]" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     |SI eaModoPresenta ! "N";
         aAlfa = "[IMPRESORA]#" + eaModoPresenta + &13 + &10;
         |XGRABA enHandleTxt, aAlfa;
     |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     |SI aIPRemoto = "192.168.10.42";
         aAlfa = "[ERROR]" + &13 + &10;
         |XGRABA enHandleTxt, aAlfa;
     |FINSI;

     |XCIERRA enHandleTxt;

     eaOrigen  = eaDirTrabServi + eaFicheroTxt;
     eaDestino = eaDirTrabajo   + eaFicheroTxt;
     |HAZ EnviaFicheroSinMD5;

     |FBORRA eaOrigen;

     |HAZ AbreWordExterno;

     |SI eaGuarda = "S";
         |HAZ ActualizaRegistro;

         eaRaiz        = "doc" + (("00000" + #8#1) % -105);
         eaFicheroDef  = eaRaiz + ".doc";
         eaFicheroXgz  = eaRaiz + ".xgz";
         eaFicheroTar  = eaRaiz + ".tar";
         eaFicheroTgz  = eaRaiz + ".tgz";
         eaFicheroTxt  = eaRaiz + ".txt";

         |HAZ ComprimeFichero;

         eaOrigen  = eaDirSerGuarda + eaFicheroXgz;
         eaDestino = eaDirTrabajo   + eaFicheroTgz;

         |HAZ RecibeFichero;

         |RFBORRA eaDestino;
     |SINO;
         eaDestino = eaDirTrabajo + eaFicheroTxt;  |RFBORRA eaDestino;
         eaDestino = eaDirTrabajo + eaFicheroTra;  |RFBORRA eaDestino;
     |FINSI;
|FPRC;

|| ------------------------------------------------------
|| Procesos de la Generacion del Presupuesto
|| ------------------------------------------------------

|PROCESO dslpm011P;
     |ABRE #521;
     #521#0 = #11#2;
     |LEE 000#521=;
     |SI FSalida ! 0;  |DDEFECTO #521;  |FINSI;
     |CIERRA #521;

     |ABRE #522;
     #522#0 = #11#4;
     |LEE 000#522=;
     |SI FSalida ! 0;  |DDEFECTO #522;  |FINSI;
     |CIERRA #522;

     |SI #11#4 = 0;
         #942#12 = #942#12 + #11#8;
     |FINSI;

     |SI #11#4 = 1;
         #942#0 = #942#0 + #11#8;
         #942#1 = #522#2;
         #942#2 = #942#0 % #942#1;
         #942#3 = #942#0 + #942#2;
     |FINSI;

     |SI #11#4 = 2;
         #942#4 = #942#4 + #11#8;
         #942#5 = #522#2;
         #942#6 = #942#4 % #942#5;
         #942#7 = #942#4 + #942#6;
     |FINSI;

     |SI #11#4 = 3;
         #942#8  = #942#8 + #11#8;
         #942#9  = #522#2;
         #942#10 = #942#8 % #942#9;
         #942#11 = #942#8 + #942#10;
     |FINSI;

     #942#13 = #942#3 + #942#7 + #942#11 + #942#12;

     |SI nContador ! 1;
         eaAsigna = "T}2}2}1}+G";
         eaConten = "";
         |HAZ GrabaFicheroExterno;

         eaAsigna = "T}2}1}1}+P";
         eaConten = "";
         |HAZ GrabaFicheroExterno;
     |FINSI;

     nContador = nContador + 1;

     eaAlfa = #521#6;                    |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#7;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#8;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#9;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#10;    |QBF eaAlfa;
     |HAZ QuitaRaros;

     eaAsigna = "T}2}" + nContador + "}1}";
     eaConten = eaAlfa;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}2}" + nContador + "}2}";
     eaConten = #522#2 + "%";
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}2}" + nContador + "}3}";
     eaImporte = #11#6;            |HAZ SeparaImporte;
     eaConten = eaImporte;           |QBT eaConten;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}2}" + nContador + "}4}";
     eaImporte = #11#7;            |HAZ SeparaImporte;
     eaConten = eaImporte;           |QBT eaConten;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}2}" + nContador + "}5}";
     eaImporte = #11#8;            |HAZ SeparaImporte;
     eaConten = eaImporte;           |QBT eaConten;
     |HAZ GrabaFicheroExterno;
|FPRC;

|DEFBUCLE dslpm011P;
     #11#1;
     ;
     #1#1, 01;
     #1#1, 99;
     ;
     NULL, dslpm011P;
|FIN;

|PROCESO HojaValoracionP;
     |DDEFECTO #942;
     nContador = 1;
     |BUCLE dslpm011P;

     eaAsigna = "T}3}1}2}";
     nNume     = #942#0 + #942#4 + #942#8 + #942#12;
     eaImporte = nNume;                              |HAZ SeparaImporte;
     eaConten    = eaImporte;                          |QBT eaConten;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}3}2}2}";
     nNume     = #942#2 + #942#6 + #942#10;
     eaImporte = nNume;                              |HAZ SeparaImporte;
     eaConten  = eaImporte;                          |QBT eaConten;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}3}3}2}";
     eaImporte = #942#13;                            |HAZ SeparaImporte;
     eaConten    = eaImporte;                          |QBT eaConten;
     |HAZ GrabaFicheroExterno;

     nColumna = 0;
     |PARA nPos = 1;  |SI nPos [ 4;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna   = "T}4}2}" + nColumna + "}";
           eaConten = #1#40 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 4;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna   = "T}4}2}" + nColumna + "}";
           eaConten = #1#41 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 2;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna   = "T}4}2}" + nColumna + "}";
           eaConten = #1#43 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 10;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna   = "T}4}2}" + nColumna + "}";
           eaConten = #1#42 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;
|FPRC;

|PROCESO Presupuesto;
     eaGuarda       = "S";
     enTipoDoc      = 20;
     eaModoPresenta = "N";

     |HAZ SacaDocumentos;
     |SI eaNomFichero = "";  enError = 1;  |ACABA;  |FINSI;

     |HAZ AbreDocuAE;

     |ABRE #1;
     |SELECT #2#1;
     #1#1 = enCliente;
     |LEE 000#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     eaAlfa   = #1#2;             |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#2#";   |HAZ GrabaFicheroExterno;

     aAlfa = #1#4;  |QBF aAlfa;
     aAlfa = aAlfa + " " + #1#5;  |QBF aAlfa;
     |SI #1#6 ! "    ";
         aAlfa = aAlfa + ", " + #1#6;  |QBF aAlfa;
     |FINSI;
     |SI #1#7 ! "   ";
         aAlfa = aAlfa + " " + #1#7;  |QBF aAlfa;
     |FINSI;
     |SI #1#8 ! "  ";
         aAlfa = aAlfa + " " + #1#8;  |QBF aAlfa;
     |FINSI;
     |SI #1#9 ! "  ";
         aAlfa = aAlfa + " " + #1#9;  |QBF aAlfa;
     |FINSI;

     aAlfa    = aAlfa + ", " + (("00" + #1#10) % -102) + (("000" + #1#11) % -103);
     aAlfa    = aAlfa + " " + #1#12;  |QBF aAlfa;
     aAlfa    = aAlfa + " (" + #1#13;  |QBF aAlfa;
     aAlfa    = aAlfa + ")";
     eaAlfa   = aAlfa;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#4#";   |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#15;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#15#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#3;             |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#3#";   |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#18;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#18#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#21;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#21#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#22;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#22#";           |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#23;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#23#";           |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#24;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#24#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#25 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#25#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#26 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#26#";           |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#27;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#27#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#28 = "S";  eaAlfa = "X";  |FINSI;
     eaAsigna  = "V#28#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#29 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#29#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#30 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#30#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#31 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#31#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#32 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#32#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#33 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#33#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = "";
     |SI #1#34 = "S";  eaAlfa = "X";  |FINSI;
     eaConten = eaAlfa;
     eaAsigna  = "V#34#";           |HAZ GrabaFicheroExterno;

     eaAlfa    = #1#35;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna  = "V#35#";           |HAZ GrabaFicheroExterno;

     eaImporte = #1#36;            |HAZ SeparaImporte;
     eaAlfa    = eaImporte;
     eaConten = eaAlfa;
     eaAsigna  = "V#dslpm001#36#";  |HAZ GrabaFicheroExterno;

     |ABRE #100;
     |LEE 000#100p;
     |SI FSalida ! 0;  |DDEFECTO #100;  |FINSI;
     |CIERRA #100;

     eaAlfa   = #100#20;          |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm000#20#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #100#1;           |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm000#1#";   |HAZ GrabaFicheroExterno;

     eaAlfa   = #100#3;                  |QBF eaAlfa;
     eaAlfa   = eaAlfa + " "  + #100#4;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + ", " + #100#5;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + ", " + #100#6;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + " "  + #100#7;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + " "  + #100#8;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + ", (" + (("00" + #100#9) % -102) + (("000" + #100#10) % -103) + ")";
     eaAlfa   = eaAlfa + " "  + #100#11; |QBF eaAlfa;
     eaAlfa   = eaAlfa + " ("  + #100#12; |QBF eaAlfa;
     eaAlfa   = eaAlfa + ")";
                                    |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm000#3#";     |HAZ GrabaFicheroExterno;

     eaAlfa   = #100#2;           |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm000#2#";   |HAZ GrabaFicheroExterno;

     efFecha  = ~;
     |HAZ SacaFecha;
     eaAlfa   = #100#11;  |QBF eaAlfa;
     eaAlfa   = eaAlfa + ", " + eaFecha;
     eaConten = eaAlfa;
     eaAsigna = "V#FECHAENTERA#";  |HAZ GrabaFicheroExterno;

     |HAZ HojaValoracionP;

     |HAZ CierraDocuAE;

     |PULSATECLA;
|FPRC;
