|| ------------------------------------------------------
|| Ofertas, Solicitud N§ Inscripcion
|| ------------------------------------------------------

|FICHEROS;
     dslpz001 #0;
     dslpm000 #100;
     dslpm001 #1;
     dslpm002 #2;
     dslpm004 #4;
     dslpm005 #5;
     dslpm006 #6;
     dslpm008 #8;
     dslpm011 #11;
     dslpm100 #1000;
     dslpm012 #12;
     dslpw042 #942;
     dslpw053 #953;

     dslpm510 #510;
     dslpm521 #521;
     dslpm522 #522;
|FIN;

|VARIABLES;
     nContador = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aAlfa5 = "";
     aAlfa6 = "";
     aAlfa7 = "";
     aAlfa8 = "";

     aAlfa9    = "";
     aFichero  = "";
     aEtiqueta = "";
     aAbre     = "";
     aBase     = "";
     aIPRemoto = "";

     nCalc    = 0;
     nContLin = 0;
     nContTabla = 0;
     nContFichs = 0;
     nCont      = 0;
     nLinCont   = 0;

     aIDNombre = "";
     aIDNif    = "";
     nIDCampo    = 0;
     nDatosId  = 0;

      aAlfa         = "";
      aDocRtf       = "";
      aNif          = "";

      nHandle       = 0;
      nSwHay        = 0;
      nPers         = 0;
      nCampo        = 0;
      nHastaCampo   = 0;
      nPos          = 0;
      nPosi         = 0;
      nColumna      = 0;
      nNume         = 0;

      nLetra = 0;
      aChar  = "";

     aDescotros1  = "";
     aDescotros2  = "";
     aDescotros3  = "";
     aDescotros4  = "";
     aDescotros5  = "";
     aDescotros6  = "";
     aDescotros7  = "";
     aDescotros8  = "";
     aDescotros9  = "";
     aDescotros10 = "";
     aDescotros11 = "";

     &enCliente      = 0;
     &enModelo       = 0;
     &enFichero      = 0;
     &eaNomFichero   = "";
     &enError        = 0;
     &eaAlfa         = "";
     &eaAsigna       = "";
     &eaConten       = "";
     &eaHora         = "";
     &eaImporte      = "";
     &enWord1        = 0;
     &enCamWord      = 0;
     &enCargaPuntero = 0;
     &eaGuarda       = "";
     &enTipoDoc      = 0;
     &enDocumento    = 0;
     &eaFecha        = "";
     &efFecha        = @;
     &enPresenta     = 0;
     &enImprime      = 0;
     &enMasivo       = 0;

     &eaDirPlantilla  = "";
     &eaDirTrabajo    = "";
     &eaDirTrabServi  = "";
     &eaDirSerGuarda  = "";
     &eaDirSerPlan    = "";
     &eaOrigen        = "";
     &eaDestino       = "";
     &eaDestinoTra    = "";
     &eaFicheroTra    = "";
     &eaFicheroDef    = "";
     &eaFicheroXgz    = "";
     &eaFicheroTgz    = "";
     &eaFicheroTar    = "";
     &eaFicheroTxt    = "";
     &enHandleTxt     = 0;
     &eaFicheroPlaGz  = "";
     &eaFicheroPlaMl  = "";
     &eaPathLogo      = "";
     &eaRaiz          = "";
     &eaModoPresenta  = "";
|FIN;

|PROCESO AbreDocuAC;
     |DBASE aBase;  |QBF aBase;
     |HORA eaHora;
     enDocumento    = 0;

     |HAZ SacaDocumentos;
     |SI eaNomFichero = "";  |ACABA;  |FINSI;

     eaDirPlantilla = "C:\DOCUMENTOS\DSLPD\PLANTILLAS\";
     eaDirTrabajo   = "C:\DOCUMENTOS\DSLPD\DOCDSLPD\";
     eaDirSerPlan   = aBase  + "documentos/plantillas/";
     eaDirSerGuarda = aBase  + "documentos/clientes/" + (("00000" + #1#1) % -105) + "/";
     eaDirTrabServi = aBase  + "documentos/tmp/";
     eaRaiz         = eaNomFichero - ".xgz";
     eaFicheroTra   = eaRaiz + "." + "doc";
     eaFicheroXgz   = eaRaiz + ".xgz";
     eaFicheroTar   = eaRaiz + ".tar";
     eaFicheroTgz   = eaRaiz + ".tgz";
     eaFicheroTxt   = eaRaiz + ".txt";
     eaFicheroPlaGz = (eaRaiz + ".xgz") < "";
     eaFicheroPlaMl = (eaRaiz + ".doc") < "";

     |MKDIR eaDirTrabServi;

     eaOrigen       = eaDirSerPlan   + eaFicheroPlaGz;
     eaDestino      = eaDirPlantilla + eaFicheroPlaGz;
     eaDestinoTra   = eaDirTrabajo   + eaFicheroPlaGz;

     |HAZ MiraDirectorios;
     |HAZ EnviaFicheroConMD5;
     |HAZ DescomprimeFichero;

     aAbre = eaDirTrabajo + eaFicheroTra;
     |XABRE "EC", aAbre, nHandle;
     |SI FSalida < 0;
         aAlfa   = "0000 El Documento " + aAbre + " no esta instalado. Instalelo.";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     aAbre = eaDirTrabServi + eaFicheroTxt;
     |XABRE "WB", aAbre, enHandleTxt;

     aAlfa = "[FICHERO]#" + eaDirTrabajo + eaFicheroTra + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;
|FPRC;

|PROCESO CierraDocuAC;
     |HAZ MiraLogos;

     aAlfa = "[LIMPIA FINAL]" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     |SI eaModoPresenta ! "N";
         aAlfa = "[IMPRESORA]#" + eaModoPresenta + &13 + &10;
         |XGRABA enHandleTxt, aAlfa;
     |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     |SI aIPRemoto = "192.168.10.42";
         aAlfa = "[ERROR]" + &13 + &10;
         |XGRABA enHandleTxt, aAlfa;
     |FINSI;

     |XCIERRA enHandleTxt;

     eaOrigen  = eaDirTrabServi + eaFicheroTxt;
     eaDestino = eaDirTrabajo   + eaFicheroTxt;
     |HAZ EnviaFicheroSinMD5;

     |FBORRA eaOrigen;

     |HAZ AbreWordExterno;

     |SI eaGuarda = "S";
         |HAZ ActualizaRegistro;

         eaRaiz        = "doc" + (("00000" + #8#1) % -105);
         eaFicheroDef  = eaRaiz + ".doc";
         eaFicheroXgz  = eaRaiz + ".xgz";
         eaFicheroTar  = eaRaiz + ".tar";
         eaFicheroTgz  = eaRaiz + ".tgz";
         eaFicheroTxt  = eaRaiz + ".txt";

         |HAZ ComprimeFichero;

         eaOrigen  = eaDirSerGuarda + eaFicheroXgz;
         eaDestino = eaDirTrabajo   + eaFicheroTgz;

         |HAZ RecibeFichero;

         |RFBORRA eaDestino;
     |SINO;
         eaDestino = eaDirTrabajo + eaFicheroTxt;  |RFBORRA eaDestino;
         eaDestino = eaDirTrabajo + eaFicheroTra;  |RFBORRA eaDestino;
     |FINSI;
|FPRC;

|| ------------------------------------------------------
|| Procesos de la Generacion de la Oferta
|| ------------------------------------------------------

|PROCESO dslpm011O;
     |ABRE #521;
     #521#0 = #11#2;
     |LEE 000#521=;
     |SI FSalida ! 0;  |DDEFECTO #521;  |FINSI;
     |CIERRA #521;

     |ABRE #522;
     #522#0 = #11#4;
     |LEE 000#522=;
     |SI FSalida ! 0;  |DDEFECTO #522;  |FINSI;
     |CIERRA #522;

     |SI #11#4 = 0;
         #942#12 = #942#12 + #11#8;
     |FINSI;

     |SI #11#4 = 1;
         #942#0 = #942#0 + #11#8;
         #942#1 = #522#2;
         #942#2 = #942#0 % #942#1;
         #942#3 = #942#0 + #942#2;
     |FINSI;

     |SI #11#4 = 2;
         #942#4 = #942#4 + #11#8;
         #942#5 = #522#2;
         #942#6 = #942#4 % #942#5;
         #942#7 = #942#4 + #942#6;
     |FINSI;

     |SI #11#4 = 3;
         #942#8  = #942#8 + #11#8;
         #942#9  = #522#2;
         #942#10 = #942#8 % #942#9;
         #942#11 = #942#8 + #942#10;
     |FINSI;

     #942#13 = #942#3 + #942#7 + #942#11 + #942#12;

     |SI nContador ! 1;
         eaAsigna = "T}1}2}1}+G";
         eaConten = "";
         |HAZ GrabaFicheroExterno;

         eaAsigna = "T}1}1}1}+P";
         eaConten = "";
         |HAZ GrabaFicheroExterno;
     |FINSI;

     nContador = nContador + 1;

     eaAlfa = #521#6;                    |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#7;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#8;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#9;     |QBF eaAlfa;
     eaAlfa = eaAlfa + " " + #521#10;    |QBF eaAlfa;
     |HAZ QuitaRaros;

     eaAsigna = "T}1}" + nContador + "}1}";
     eaConten = eaAlfa;
     |HAZ GrabaFicheroExterno;

     eaAsigna = "T}1}" + nContador + "}2}";
     eaConten = #522#2 + "%";
     |HAZ GrabaFicheroExterno;

     eaAsigna  = "T}1}" + nContador + "}3}";
     eaImporte = #11#6;            |HAZ SeparaImporte;
     eaConten  = eaImporte;           |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;

     eaAsigna  = "T}1}" + nContador + "}4}";
     eaImporte = #11#7;            |HAZ SeparaImporte;
     eaConten  = eaImporte;           |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;

     eaAsigna  = "T}1}" + nContador + "}5}";
     eaImporte = #11#8;            |HAZ SeparaImporte;
     eaConten  = eaImporte;           |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;
|FPRC;

|DEFBUCLE dslpm011O;
     #11#1;
     ;
     #1#1, 01;
     #1#1, 99;
     ;
     NULL, dslpm011O;
|FIN;

|PROCESO HojaValoracionO;
     |DDEFECTO #942;
     nContador = 1;
     |BUCLE dslpm011O;

     eaAsigna  = "T}2}1}2}";
     nNume     = #942#0 + #942#4 + #942#8 + #942#12;
     eaImporte = nNume;                              |HAZ SeparaImporte;
     eaConten  = eaImporte;                          |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;

     eaAsigna  = "T}2}2}2}";
     nNume     = #942#2 + #942#6 + #942#10;
     eaImporte = nNume;                              |HAZ SeparaImporte;
     eaConten  = eaImporte;                          |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;

     eaAsigna  = "T}2}3}2}";
     eaImporte = #942#13;                            |HAZ SeparaImporte;
     eaConten  = eaImporte;                          |QBT aAlfa2;
     |HAZ GrabaFicheroExterno;

     nColumna = 0;
     |PARA nPos = 1;  |SI nPos [ 4;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna = "T}3}2}" + nColumna + "}";
           eaConten = #1#40 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 4;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna = "T}3}2}" + nColumna + "}";
           eaConten = #1#41 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 2;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna = "T}3}2}" + nColumna + "}";
           eaConten = #1#43 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;

     |PARA nPos = 1;  |SI nPos [ 10;  |HACIENDO nPos = nPos + 1;
           nColumna = nColumna + 1;
           nPosi    = (nPos * 100) + 1;
           eaAsigna = "T}3}2}" + nColumna + "}";
           eaConten = #1#42 % nPosi;
           |HAZ GrabaFicheroExterno;
     |SIGUE;
|FPRC;

|PROCESO Oferta;
     enTipoDoc      = 10;
     eaModoPresenta = "N";
     eaGuarda       = "S";
     |HAZ AbreDocuAC;

     |ABRE #1;
     |SELECT #2#1;
     #1#1 = enCliente;
     |LEE 000#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     eaAlfa   = #1#2;             |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#2#";   |HAZ GrabaFicheroExterno;

     aAlfa = #1#4;  |QBF aAlfa;
     aAlfa = aAlfa + " " + #1#5;  |QBF aAlfa;
     |SI #1#6 ! "    ";
         aAlfa = aAlfa + ", " + #1#6;  |QBF aAlfa;
     |FINSI;
     |SI #1#7 ! "   ";
         aAlfa = aAlfa + " " + #1#7;  |QBF aAlfa;
     |FINSI;
     |SI #1#8 ! "  ";
         aAlfa = aAlfa + " " + #1#8;  |QBF aAlfa;
     |FINSI;
     |SI #1#9 ! "  ";
         aAlfa = aAlfa + " " + #1#9;  |QBF aAlfa;
     |FINSI;

     eaAlfa   = aAlfa;             |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#4#";   |HAZ GrabaFicheroExterno;

     aAlfa    = (("00" + #1#10) % -102) + (("000" + #1#11) % -103);
     aAlfa    = aAlfa + " " + #1#12;  |QBF aAlfa;
     aAlfa    = aAlfa + " (" + #1#13;  |QBF aAlfa;
     aAlfa    = aAlfa + ")";
     eaAlfa   = aAlfa;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#12#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#13;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#13#";  |HAZ GrabaFicheroExterno;

     |ABRE #100;
     |LEE 000#100p;
     |SI FSalida ! 0;  |DDEFECTO #100;  |FINSI;
     |CIERRA #100;

     eaAlfa   = #100#11;          |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm000#11#";  |HAZ GrabaFicheroExterno;

     efFecha  = ~;
     |HAZ SacaFecha;
     eaAlfa   = eaFecha;
     eaConten = eaAlfa;
     eaAsigna = "V#FECHA#";  |HAZ GrabaFicheroExterno;

     |SI eaRaiz = "doc10004";  |O eaRaiz = "doc10005";
      |O eaRaiz = "doc10006";
         |HAZ HojaValoracionO;
     |FINSI;

     |HAZ CierraDocuAC;
     |PULSATECLA;
|FPRC;

|| ------------------------------------------------------
|| Procesos de la Generacion de la Solicitud
|| ------------------------------------------------------

|PROCESO dslpw053;
     |SI nContador ! 0;
          eaAsigna = "T}1}" + nContador + "}1}+F";
          eaConten = "1";
          |HAZ GrabaFicheroExterno;
     |FINSI;
     nContador = nContador + 1;

     eaAlfa   = #953#1; |HAZ QuitaRaros;
     eaAsigna = "T}1}" + nContador + "}1}";
     eaConten = eaAlfa;
     |HAZ GrabaFicheroExterno;

     eaAlfa   = #953#2; |HAZ QuitaRaros;
     eaAsigna = "T}1}" + nContador + "}2}";
     eaConten = eaAlfa;
     |HAZ GrabaFicheroExterno;
|FPRC;

|DEFBUCLE dslpw053;
     #953#1;
     3;
     00001, "*";
     99999, "*";
     ;
     NULL, dslpw053;
|FIN;

|PROCESO Solicitud;
     enTipoDoc      = 60;
     eaModoPresenta = "P";
     eaGuarda       = "S";
     |HAZ AbreDocuAC;

     |DDEFECTO #1;
     |ABRE #1;
     |SELECT #2#1;
     #1#1 = enCliente;
     |LEE 000#1=;
     |CIERRA #1;

     |DDEFECTO #2;
     |ABRE #2;
     |SELECT #2#2;
     #2#33 = "S";
     #2#0 = enCliente;
     |LEE 000#2=;
     |CIERRA #2;

     |DDEFECTO #4;
     |ABRE #4;
     #4#0 = enCliente;
     #4#1 = enModelo;
     |LEE 000#4=;
     |CIERRA #4;

     eaAlfa   = #dslpm001#2#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#2#";  |HAZ GrabaFicheroExterno;

     aAlfa = #1#4;  |QBF aAlfa;
     aAlfa = aAlfa + " " + #1#5;  |QBF aAlfa;
     |SI #1#6 ! "    ";
         aAlfa = aAlfa + ", " + #1#6;  |QBF aAlfa;
     |FINSI;
     |SI #1#7 ! "   ";
         aAlfa = aAlfa + " " + #1#7;  |QBF aAlfa;
     |FINSI;
     |SI #1#8 ! "  ";
         aAlfa = aAlfa + " " + #1#8;  |QBF aAlfa;
     |FINSI;
     |SI #1#9 ! "  ";
         aAlfa = aAlfa + " " + #1#9;  |QBF aAlfa;
     |FINSI;

     eaAlfa   = aAlfa;             |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#4#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #1#5;            |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#5#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #dslpm001#6#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#6#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = (("00" + #dslpm001#10#) % -102) + (("000" + #dslpm001#11#) % -103);
     eaConten = eaAlfa;
     eaAsigna = "V#CP#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #dslpm001#13#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#13#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #dslpm001#12#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#12#";  |HAZ GrabaFicheroExterno;

     efFecha = ~;
     |HAZ SacaFecha;
     eaAlfa   = eaFecha;
     eaConten = eaAlfa;
     eaAsigna = "V#FECHA#";  |HAZ GrabaFicheroExterno;

     ||responsable y nif
     eaAlfa   = #dslpm004#4#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm004#4#";  |HAZ GrabaFicheroExterno;

     eaAlfa   = #dslpm004#3#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm004#3#";  |HAZ GrabaFicheroExterno;

     ||empresa
     eaAlfa   = #dslpm001#2#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm001#2#";  |HAZ GrabaFicheroExterno;

     ||gerente
     eaAlfa   = #dslpm002#2#; |HAZ QuitaRaros;
     eaConten = eaAlfa;
     eaAsigna = "V#dslpm002#2#";  |HAZ GrabaFicheroExterno;

     aFichero = ("53" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #953 aFichero;

     nContador = 0;
     |BUCLE dslpw053;

     |HAZ CierraDocuAC;

     |PULSATECLA;
|FPRC;
