|FICHEROS;
     gecow011;
     gecow012;

     gecom001;
     gecom002;
     gecom003;
     gecom004;
     gecom005;
     gecom006;
     gecom007;
     gecom008;
     gecom009;
     gecom010;
     gecom011;
     gecom012;
     gecom013;

     gecom053;
     gecom054;
     gecom055;
     gecom056;
     gecom057;
     gecom059;
     gecom061;
     gecom062;

     gecom500;
     gecom501;
|FIN;

|VARIABLES;
     n0Vent              = 0;
     nPan6               = 0;
     nId                 = 0;
     nIdE                = 0;
     nIdR                = 0;
     nIdC                = 0;
     nIdD                = 0;
     nCmp                = 0;
     nOk                 = 0;
     nHandle             = 0;
     nHandB64            = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nPausa              = 0;
     nGrabar             = 0;
     nConta              = 0;
     nLeidas             = 0;
     nGrabadas           = 0;
     nFaceB2B            = 0;
     nCampo              = 0;
     nCodEsp             = 0;
     nCad                = 0;
     nEsCSV              = 0;
     i                   = 0;

     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aAlfa3              = "";
     aVer1               = "";
     aVer2               = "";
     aOri                = "";
     aDes                = "";
     aProg               = "";
     aAbre               = "";
     aLinea              = "";
     aBase               = "";
     aRuta               = "";
     aFicXML             = "";
     aFicADJ             = "";
     aFicB64             = "";
     aFicBrowse          = "";
     aFicLCK             = "";
     aLong               = "";
     aCaracter           = "";
     aApi                = "";
     aParam1             = "";
     aParam2             = "";
     aEjec               = "";
     aCadena             = "";
     aFic                = "";
     aCar13              = "";
     aCar10              = "";
     aEtiq               = "";
     aDEtiq              = "";
     aHEtiq              = "";
     aClv                = "";
     aHora               = "";
     aVal                = "";
     aQQ                 = "";
     aTipoCmp            = "";
     aTipo               = "";
     aClav               = "";
     aClavAnt            = "";
     aRaizAnt            = "";
     aRaiz               = "";
     aId                 = "";
     aDir                = "";
     aPath               = "";
     aDato               = "";
     aTab                = "";
     aLon                = "";
     aReg                = "";
     aLetra              = "";
     aExt                = "";

     {1}aMd5             = "";

     {10}nIdAg           = 0;
     {10}nAgru           = 0;
     {10}nCal            = 0;
     {10}aValor          = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &eaUnidadBasico     = "";
     &eaPathTmpLocal     = "";
     &eaPathImp          = "";
     &eaPathPdt          = "";
     &eaPathDup          = "";
     &eaPathPlu          = "";
     &eaPathAdj          = "";
     &eaIP               = "";
     &eaAlfa             = "";
     &enEmp              = 0;
     &eaIde              = "";
     &eaCmp0             = "";
     &eaCmp1             = "";
     &eaCmp4             = "";
     &eaCmp5             = "";
     &eaCmp7             = "";
     &eaCmp8             = "";
     &eaCmp9             = "";
     &eaCmp10            = "";
     &eaNomFic           = "";
     &eaError            = "";
     &eaTFac             = "";
|FIN;

|PROCESO AbreVtn;
     |VENTANA 0501, 0540, -1, 16, "Realizando proceso ...";
     n0Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n0Vent;
|FPRC;

|PROCESO GrabaErrorResultado;
     |DFICE aPath;
     aDes = aPath + eaNomFic + ".sal";
     |XABRE "W", aDes, nHandle;
     |SI FSalida ] 0;
          aDato = "error" + aTab;
          |XGRABA nHandle, aDato;
          aDato = "";
          aAlfa = eaError; |QBF aAlfa;
          aDato = aDato + aAlfa + aTab;
          |XGRABA nHandle, aDato;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO SacaValor;
     aClv = (aClv + "00000000000000000000") % 120;

     |SELECT #2#gecow011;
     #gecow011#12 = aClv;
     |LEE 000#gecow011.=;
     |SI FSalida ! 0;  |DDEFECTO #gecow011;  |FINSI;

     aVal = #gecow011#1;  |QBF aVal;
|FPRC;

|PROCESO LeeGECOM053;
     aVal = "";

     |ABRE #gecom053;
     #gecom053#0 = aId;
     |LEE 000#gecom053.=;
     |SI FSalida = 0;
         aVal = #gecom053#1;
     |FINSI;
     |CIERRA #gecom053;
|FPRC;

|PROCESO LeeGECOM054;
     aVal = "";

     |ABRE #gecom054;
     #gecom054#0 = aId;
     |LEE 000#gecom054.=;
     |SI FSalida = 0;
         aVal = #gecom054#1;
     |FINSI;
     |CIERRA #gecom054;
|FPRC;

|PROCESO LeeGECOM055;
     aVal = "";

     |ABRE #gecom055;
     #gecom055#0 = aId;
     |LEE 000#gecom055.=;
     |SI FSalida = 0;
         aVal = #gecom055#1;
     |FINSI;
     |CIERRA #gecom055;
|FPRC;

|PROCESO LeeGECOM056;
     aVal = "";

     |ABRE #gecom056;
     #gecom056#0 = aId;
     |LEE 000#gecom056.=;
     |SI FSalida = 0;
         aVal = #gecom056#1;
     |FINSI;
     |CIERRA #gecom056;
|FPRC;

|PROCESO LeeGECOM057;
     aVal = "";

     |ABRE #gecom057;
     #gecom057#0 = aId;
     |LEE 000#gecom057.=;
     |SI FSalida = 0;
         aVal = #gecom057#1;
     |FINSI;
     |CIERRA #gecom057;
|FPRC;

|PROCESO LeeGECOM059;
     aVal = "";

     |ABRE #gecom059;
     #gecom059#0 = aId;
     |LEE 000#gecom059.=;
     |SI FSalida = 0;
         aVal = #gecom059#1;
     |FINSI;
     |CIERRA #gecom059;
|FPRC;

|PROCESO LeeGECOM061;
     aVal = "";

     |ABRE #gecom061;
     |SELECT #2#gecom061;
     #gecom061#1 = aId;
     |LEE 000#gecom061.=;
     |SI FSalida = 0;
         aVal = #gecom061#0;
     |FINSI;
     |CIERRA #gecom061;
|FPRC;

|PROCESO LeeGECOM062;
     aVal = "";

     |ABRE #gecom062;
     #gecom062#0 = aId;
     |LEE 000#gecom062.=;
     |SI FSalida = 0;
         aVal = #gecom062#1;
     |FINSI;
     |CIERRA #gecom062;
|FPRC;

|PROCESO gecow011_m003;
     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom003#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     |SI nCmp = 113;
         |SI nCad = 0;
             #gecom003#113 = aVal % 178;
             #gecom003#114 = aVal % 7978;
             #gecom003#115 = aVal % 15778;
             #gecom003#116 = aVal % 23516;
         |FINSI;

         |SI nCad = 1;
             aAlfa = (#gecom003#116 % 116) + (aVal % 162);
             #gecom003#116 = aAlfa;
             #gecom003#117 = aVal % 6378;
             #gecom003#118 = aVal % 14178;
             #gecom003#119 = aVal % 21932;
         |FINSI;

         |SI nCad = 2;
             aAlfa = (#gecom003#119 % 132) + (aVal % 146);
             #gecom003#119 = aAlfa;
             #gecom003#120 = aVal % 4778;
             #gecom003#121 = aVal % 12578;
             #gecom003#122 = aVal % 20348;
         |FINSI;

         |SI nCad = 3;
             aAlfa = (#gecom003#122 % 148) + (aVal % 130);
             #gecom003#122 = aAlfa;
         |FINSI;

         nCad = nCad + 1;
     |FINSI;

     |SI nCmp ! 113;
         #gecom003#nCmp# = aVal;
     |FINSI;
|FPRC;

|DEFBUCLE gecow011_m003;
     #gecow011#3;
     ;
     "gecom003",          0;
     "gecom003", 9999999999;
     ;
     NULL, gecow011_m003;
|FIN;

|PROCESO Gecom003;
     |DDEFECTO #gecom003;

     nCad = 0;
     |BUCLE gecow011_m003;

     |SI #gecom003#9 ! "01.01.0000";  |O  #gecom003#10 ! "01.01.0000";
         #gecom003#8 = "S";
     |FINSI;

     |SI #gecom003#12 = "F";
         aAlfa = #gecom003#18;  |QBF aAlfa;
         aAlfa = aAlfa + " " + #gecom003#19;   |QBF aAlfa;
         aAlfa = aAlfa + ", " + #gecom003#17;  |QBF aAlfa;
         |SI aAlfa ! " ,";
             #gecom003#20 = aAlfa;
         |FINSI;
     |FINSI;

     aId = #gecom003#13;  |HAZ LeeGECOM054;  #gecom003#14 = aVal;
     aId = #gecom003#25;  |HAZ LeeGECOM053;  #gecom003#26 = aVal;
     aId = #gecom003#44;  |HAZ LeeGECOM054;  #gecom003#45 = aVal;
     aId = #gecom003#56;  |HAZ LeeGECOM053;  #gecom003#57 = aVal;
     aId = #gecom003#85;  |HAZ LeeGECOM053;  #gecom003#86 = aVal;
     aId = #gecom003#94;  |HAZ LeeGECOM053;  #gecom003#95 = aVal;

     aClv = "0301070103";  |HAZ SacaValor;
     |SI aVal ! "";
         aId = aVal;  |HAZ LeeGECOM059;  #gecom003#76 = aVal;
     |FINSI;

     aVal = #gecom003#22;  |QBF aVal;
     |SI aVal = "";
         aClv = "02010401040202";  |HAZ SacaValor;  #gecom003#22 = aVal;
     |FINSI;

     aVal = #gecom003#22;  |QBF aVal;
     |SI aVal = "";
         aClv = "02010402040202";  |HAZ SacaValor;  #gecom003#22 = aVal;
     |FINSI;

     aVal = #gecom003#53;  |QBF aVal;
     |SI aVal = "";
         aClv = "02020401040202";  |HAZ SacaValor;  #gecom003#53 = aVal;
     |FINSI;

     aVal = #gecom003#53;  |QBF aVal;
     |SI aVal = "";
         aClv = "02020402040202";  |HAZ SacaValor;  #gecom003#53 = aVal;
     |FINSI;

     aVal = #gecom003#82;  |QBF aVal;
     |SI aVal = "";
         aClv = "0301070106040202";  |HAZ SacaValor;  #gecom003#82 = aVal;
     |FINSI;

     aVal = #gecom003#91;  |QBF aVal;
     |SI aVal = "";
         aClv = "0301070104040202";  |HAZ SacaValor;  #gecom003#91 = aVal;
     |FINSI;

     aAlfa = #gecom003#2;  |QBF aAlfa;
     aAlfa = aAlfa + #gecom003#3;  |QBF aAlfa;
     #gecom003#1 = aAlfa;

     aAlfa = #gecom003#25 % 102;
     #gecom003#11 = #gecom003#11 - aAlfa;

     aAlfa = #gecom003#56 % 102;
     #gecom003#42 = #gecom003#42 - aAlfa;
|FPRC;

|PROCESO gecow011_m004;
     aRaiz = #gecow011#12 % 104;
     aTipo = "E";
     |SI aRaiz = "0202";
         aTipo = "R";
     |FINSI;

     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";  |O aRaizAnt ! aRaiz;
         |SI aTipo = "E";  nIdE = nIdE + 1;  nId = nIdE;  |FINSI;
         |SI aTipo = "R";  nIdR = nIdR + 1;  nId = nIdR;  |FINSI;
     |FINSI;

     aId = ("00" + nId) % -102;

     #gecom004#0 = #gecom003#0;
     #gecom004#1 = #gecom003#1;
     #gecom004#2 = aTipo;
     #gecom004#3 = aId;
     |LEE 000#gecom004.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom004;
         #gecom004#0 = #gecom003#0;
         #gecom004#1 = #gecom003#1;
         #gecom004#2 = aTipo;
         #gecom004#3 = aId;
         |GRABA 020#gecom004.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom004#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom004#nCmp# = aVal;

     |SI nCmp = 4;
          aId = #gecom004#4;  |HAZ LeeGECOM055;  #gecom004#5 = aVal;
     |FINSI;

     |SI nCmp = 7;  |O nCmp = 8;  |O nCmp = 9;
         #gecom004#10 = "";

         aAlfa = #gecom004#7 + #gecom004#8;  |QBT aAlfa;
         |SI aAlfa ! "";
             aAlfa = #gecom004#8;  |QBF aAlfa;
             aAlfa = aAlfa + " " + #gecom004#9;   |QBF aAlfa;
             aAlfa = aAlfa + ", " + #gecom004#7;
             #gecom004#10 = aAlfa;
         |FINSI;
     |FINSI;

     |SI nCmp = 17;
         aId = #gecom004#17;  |HAZ LeeGECOM053;  #gecom004#18 = aVal;
     |FINSI;

     |GRABA 020#gecom004.a;
     |LIBERA #gecom004;

     aClavAnt = #gecow011#12;
     aRaizAnt = aRaiz;
|FPRC;

|DEFBUCLE gecow011_m004;
     #gecow011#3;
     ;
     "gecom004",          0;
     "gecom004", 9999999999;
     ;
     NULL, gecow011_m004;
|FIN;

|PROCESO Gecom004;
     nIdE     = 0;
     nIdR     = 0;
     aClavAnt = "";
     aRaizAnt = "";

     |BUCLE gecow011_m004;
|FPRC;

|PROCESO gecow011_m005;
     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom005#0 = #gecom003#0;
     #gecom005#1 = #gecom003#1;
     #gecom005#2 = nId;
     |LEE 000#gecom005.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom005;
         #gecom005#0 = #gecom003#0;
         #gecom005#1 = #gecom003#1;
         #gecom005#2 = nId;
         |GRABA 020#gecom005.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom005#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     |SI nCmp = 3;
         aAlfa = #gecom005#3;  |QBF aAlfa;
         |SI aAlfa = "";
             #gecom005#3 = aVal;
         |SINO;
             |PARA nCmp = 43;  |SI nCmp [ 51;  |HACIENDO nCmp = nCmp + 1;
                   aAlfa = #gecom005#nCmp#;  |QBF aAlfa;
                   |SI aAlfa = "";
                       #gecom005#nCmp# = aVal;
                       |SAL;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;

     |SI nCmp ! 3;
         #gecom005#nCmp# = aVal;
     |FINSI;

     |SI nCmp = 12;
         #gecom005#12 = aVal % 125;
         #gecom005#13 = aVal % 2625;
         #gecom005#14 = aVal % 5125;
         #gecom005#15 = aVal % 7625;
         #gecom005#16 = aVal % 10125;
         #gecom005#17 = aVal % 12625;
         #gecom005#18 = aVal % 15125;
         #gecom005#19 = aVal % 17625;
         #gecom005#20 = aVal % 20125;
         #gecom005#21 = aVal % 22625;
     |FINSI;

     |SI nCmp = 41;
         aId = #gecom005#41;  |HAZ LeeGECOM056;  #gecom005#5 = aVal;
     |FINSI;

     |SI nCmp = 42;
         aId = #gecom005#42;  |HAZ LeeGECOM062;  #gecom005#39 = aVal;
     |FINSI;

     |SI nCmp = 24;
         |SI #gecom005#24 > "01.01.0000";
             #gecom005#23 = "S";
         |FINSI;
     |FINSI;

     |SI nCmp = 27;
         |SI #gecom005#27 > "01.01.0000";
             #gecom005#26 = "S";
         |FINSI;
     |FINSI;

     |SI nCmp = 30;
         |SI #gecom005#30 > "01.01.0000";
             #gecom005#29 = "S";
         |FINSI;
     |FINSI;

     |SI nCmp = 33;
         |SI #gecom005#33 > "01.01.0000";
             #gecom005#32 = "S";
         |FINSI;
     |FINSI;

     |SI nCmp = 36;
         |SI #gecom005#36 > "01.01.0000";
             #gecom005#35 = "S";
         |FINSI;
     |FINSI;

     |GRABA 020#gecom005.a;
     |LIBERA #gecom005;

     aClavAnt = #gecow011#12;

     #gecow012#0 = nId;
     |LEE 000#gecow012.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecow012;
         #gecow012#0 = nId;
         #gecow012#1 = #gecow011#0;
         |GRABA 020#gecow012.b;
     |FINSI;
     #gecow012#2 = #gecow011#0;
     |GRABA 020#gecow012.a;
     |LIBERA #gecow012;
|FPRC;

|DEFBUCLE gecow011_m005;
     #gecow011#3;
     ;
     "gecom005",          0;
     "gecom005", 9999999999;
     ;
     NULL, gecow011_m005;
|FIN;

|PROCESO Gecom005;
     nId      = 0;
     aClavAnt = "";

     |BUCLE gecow011_m005;
|FPRC;

|PROCESO gecow011_m006;
     aRaiz = #gecow011#12 % 110;
     aTipo = "D";
     |SI aRaiz = "0301060119";
         aTipo = "C";
     |FINSI;

     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";  |O aRaizAnt ! aRaiz;
         |SI aTipo = "D";  nIdD = nIdD + 1;  nId = nIdD;  |FINSI;
         |SI aTipo = "C";  nIdC = nIdC + 1;  nId = nIdC;  |FINSI;
     |FINSI;

     #gecom006#0 = #gecom003#0;
     #gecom006#1 = #gecom003#1;
     #gecom006#2 = #gecow012#0;
     #gecom006#3 = aTipo;
     #gecom006#4 = nId;
     |LEE 000#gecom006.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom006;
         #gecom006#0 = #gecom003#0;
         #gecom006#1 = #gecom003#1;
         #gecom006#2 = #gecow012#0;
         #gecom006#3 = aTipo;
         #gecom006#4 = nId;
         |GRABA 020#gecom006.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom006#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom006#nCmp# = aVal;

     |GRABA 020#gecom006.a;
     |LIBERA #gecom006;

     aClavAnt = #gecow011#12;
     aRaizAnt = aRaiz;
|FPRC;

|DEFBUCLE gecow011_m006;
     #gecow011#3;
     ;
     "gecom006", #gecow012#1;
     "gecom006", #gecow012#2;
     ;
     NULL, gecow011_m006;
|FIN;

|PROCESO gecow011_m007;
     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom007#0 = #gecom003#0;
     #gecom007#1 = #gecom003#1;
     #gecom007#2 = #gecow012#0;
     #gecom007#3 = nId;
     |LEE 000#gecom007.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom007;
         #gecom007#0 = #gecom003#0;
         #gecom007#1 = #gecom003#1;
         #gecom007#2 = #gecow012#0;
         #gecom007#3 = nId;
         |GRABA 020#gecom007.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom007#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom007#nCmp# = aVal;

     |SI nCmp = 11;
         aId = ("00" + #gecom007#11) % -102;  |HAZ LeeGECOM057;  #gecom007#4 = aVal;
     |FINSI;

     |GRABA 020#gecom007.a;
     |LIBERA #gecom007;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m007;
     #gecow011#3;
     ;
     "gecom007", #gecow012#1;
     "gecom007", #gecow012#2;
     ;
     NULL, gecow011_m007;
|FIN;

|PROCESO gecow011_m008;
     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom008#0 = #gecom003#0;
     #gecom008#1 = #gecom003#1;
     #gecom008#2 = #gecow012#0;
     #gecom008#3 = nId;
     |LEE 000#gecom008.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom008;
         #gecom008#0 = #gecom003#0;
         #gecom008#1 = #gecom003#1;
         #gecom008#2 = #gecow012#0;
         #gecom008#3 = nId;
         |GRABA 020#gecom008.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom008#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom008#nCmp# = aVal;

     |SI nCmp = 7;
         aId = ("00" + #gecom008#7) % -102;  |HAZ LeeGECOM057;  #gecom008#4 = aVal;
     |FINSI;

     |GRABA 020#gecom008.a;
     |LIBERA #gecom008;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m008;
     #gecow011#3;
     ;
     "gecom008", #gecow012#1;
     "gecom008", #gecow012#2;
     ;
     NULL, gecow011_m008;
|FIN;

|PROCESO gecow011_m009;
     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom009#0 = #gecom003#0;
     #gecom009#1 = #gecom003#1;
     #gecom009#2 = #gecow012#0;
     #gecom009#3 = nId;
     |LEE 000#gecom009.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom009;
         #gecom009#0 = #gecom003#0;
         #gecom009#1 = #gecom003#1;
         #gecom009#2 = #gecow012#0;
         #gecom009#3 = nId;
         |GRABA 020#gecom009.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom009#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom009#nCmp# = aVal;

     |GRABA 020#gecom009.a;
     |LIBERA #gecom009;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m009;
     #gecow011#3;
     ;
     "gecom009", #gecow012#1;
     "gecom009", #gecow012#2;
     ;
     NULL, gecow011_m009;
|FIN;

|PROCESO gecow012;
     nIdC     = 0;
     nIdD     = 0;
     aClavAnt = "";
     aRaizAnt = "";

     |BUCLE gecow011_m006;

     aClavAnt = "";
     nId      = 0;
     |BUCLE gecow011_m007;

     aClavAnt = "";
     nId      = 0;
     |BUCLE gecow011_m008;

     aClavAnt = "";
     nId      = 0;
     |BUCLE gecow011_m009;
|FPRC;

|DEFBUCLE gecow012;
     #gecow012#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, gecow012;
|FIN;

|PROCESO gecow011_m010;
     aRaiz = #gecow011#12 % 108;
     aTipo = "D";
     |SI aRaiz = "03010503";
         aTipo = "C";
     |FINSI;

     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";  |O aRaizAnt ! aRaiz;
         |SI aTipo = "D";  nIdD = nIdD + 1;  nId = nIdD;  |FINSI;
         |SI aTipo = "C";  nIdC = nIdC + 1;  nId = nIdC;  |FINSI;
     |FINSI;

     #gecom010#0 = #gecom003#0;
     #gecom010#1 = #gecom003#1;
     #gecom010#2 = aTipo;
     #gecom010#3 = nId;
     |LEE 000#gecom010.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom010;
         #gecom010#0 = #gecom003#0;
         #gecom010#1 = #gecom003#1;
         #gecom010#2 = aTipo;
         #gecom010#3 = nId;
         |GRABA 020#gecom010.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom010#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom010#nCmp# = aVal;

     |GRABA 020#gecom010.a;
     |LIBERA #gecom010;

     aClavAnt = #gecow011#12;
     aRaizAnt = aRaiz;
|FPRC;

|DEFBUCLE gecow011_m010;
     #gecow011#3;
     ;
     "gecom010",          0;
     "gecom010", 9999999999;
     ;
     NULL, gecow011_m010;
|FIN;

|PROCESO Gecom010;
     nIdC     = 0;
     nIdD     = 0;
     aClavAnt = "";
     aRaizAnt = "";

     |BUCLE gecow011_m010;
|FPRC;

|PROCESO gecow011_m011;
     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom011#0 = #gecom003#0;
     #gecom011#1 = #gecom003#1;
     #gecom011#2 = nId;
     |LEE 000#gecom011.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom011;
         #gecom011#0 = #gecom003#0;
         #gecom011#1 = #gecom003#1;
         #gecom011#2 = nId;
         |GRABA 020#gecom011.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom011#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom011#nCmp# = aVal;

     |SI nCmp = 4;
         aId = #gecom011#4;  |HAZ LeeGECOM054;  #gecom011#5 = aVal;
     |FINSI;

     |SI nCmp = 8;
         aId = #gecom011#8;  |HAZ LeeGECOM054;  #gecom011#9 = aVal;
     |FINSI;

     |GRABA 020#gecom011.a;
     |LIBERA #gecom011;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m011;
     #gecow011#3;
     ;
     "gecom011",          0;
     "gecom011", 9999999999;
     ;
     NULL, gecow011_m011;
|FIN;

|PROCESO Gecom011;
     nId      = 0;
     aClavAnt = "";

     |BUCLE gecow011_m011;
|FPRC;

|PROCESO gecow011_m012;
     |SI #gecow011#14 = 5;
         aFicB64  = eaPathAdj + (("00000" + #gecom012#0) % -105);
         aFicB64  = aFicB64 + #gecom012#1;  |QBF aFicB64;
         aFicB64  = aFicB64 + (("00" + #gecom012#2) % -102);
         aFicB64  = aFicB64 + ".b64";

         aVal = #gecow011#1;  |QBF aVal;

         |XABRE "AB", aFicB64, nHandB64;
         |XGRABA nHandB64, aVal;
         |XCIERRA nHandB64;

         |ACABA;
     |FINSI;

     |SI aClavAnt > #gecow011#12;  |O aClavAnt = "";
         nId = nId + 1;
     |FINSI;

     #gecom012#0 = #gecom003#0;
     #gecom012#1 = #gecom003#1;
     #gecom012#2 = nId;
     |LEE 000#gecom012.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom012;
         #gecom012#0 = #gecom003#0;
         #gecom012#1 = #gecom003#1;
         #gecom012#2 = nId;
         |GRABA 020#gecom012.b;
     |FINSI;

     nCmp     = #gecow011#14;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";
     aTipoCmp = #gecom012#aQQ#;
     aVal     = #gecow011#1;  |QBF aVal;

     |SI aTipoCmp = "F";
         |SI aVal ! "";
             aVal = (aVal % 902) + "." + (aVal % 602) + "." + (aVal % 104);
         |FINSI;
     |FINSI;

     #gecom012#nCmp# = aVal;
     #gecom012#5     = "S";

     |GRABA 020#gecom012.a;
     |LIBERA #gecom012;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m012;
     #gecow011#3;
     ;
     "gecom012",          0;
     "gecom012", 9999999999;
     ;
     NULL, gecow011_m012;
|FIN;

|PROCESO Gecom012;
     nId      = 0;
     aClavAnt = "";

     |BUCLE gecow011_m012;
|FPRC;

|PROCESO gecow011_m013;
     nId     = nId + 1;
     eaAlfa = #gecow011#1;  |HAZ PonRaros;
     aId = eaAlfa;  |HAZ LeeGECOM061;

     |DDEFECTO #gecom013;
     #gecom013#0 = #gecom003#0;
     #gecom013#1 = #gecom003#1;
     #gecom013#2 = nId;
     #gecom013#3 = aVal;
     #gecom013#4 = eaAlfa;
     |GRABA 020#gecom013.n;
     |LIBERA #gecom013;

     aClavAnt = #gecow011#12;
|FPRC;

|DEFBUCLE gecow011_m013;
     #gecow011#3;
     ;
     "gecom013",          0;
     "gecom013", 9999999999;
     ;
     NULL, gecow011_m013;
|FIN;

|PROCESO Gecom013;
     nId      = 0;
     aClavAnt = "";

     |BUCLE gecow011_m013;
|FPRC;

|PROCESO QuitaBarras;
     |PARA; |SI;  |HACIENDO;
          aDes = aDes - "/";
          |SI FSalida = 0;  |SAL;  |FINSI;
     |SIGUE;

     |PARA; |SI;  |HACIENDO;
          aDes = aDes - "\";
          |SI FSalida = 0;  |SAL;  |FINSI;
     |SIGUE;
|FPRC;

|PROCESO MeteAdjunto;
     #gecom012#0 = #gecom003#0;
     #gecom012#1 = #gecom003#1;
     #gecom012#2 = 1;
     |LEE 000#gecom012.=;
     |SI FSalida ! 0;
         |DDEFECTO #gecom012;
         #gecom012#0 = #gecom003#0;
         #gecom012#1 = #gecom003#1;
         #gecom012#2 = 1;
         |GRABA 020#gecom012.b;
     |FINSI;

     aExt  = "";
     aAlfa = aFicADJ % -401;
     |SI aAlfa = ".";
         aExt = aFicADJ % -103;
     |SINO;
         aAlfa = aFicADJ % -501;
         |SI aAlfa = ".";
             aExt = aFicADJ % -104;
         |FINSI;
     |FINSI;

     aExt = aExt > "";
     #gecom012#3 = aExt;
     #gecom012#5 = "S";

     aAlfa = #gecom012#4;  |QBF aAlfa;
     |SI aAlfa = "";
         #gecom012#4 = "Documento adjunto a la factura";
     |FINSI;

     aOri = eaPathPdt + aFicADJ;

     aDes = (("00000" + #gecom012#0) % -105);
     aDes = aDes + #gecom012#1;  |QBF aDes;
     aDes = aDes + (("00" + #gecom012#2) % -102);
     aDes = aDes + "." + aExt;
     |HAZ QuitaBarras;
     aDes = eaPathAdj + aDes;

     |COPIA_FICHERO aOri, aDes;
     |SI FSalida ] 0;
         |FBORRA aOri;
     |FINSI;

     |GRABA 020#gecom012.a;
     |LIBERA #gecom012;
|FPRC;

|PROCESO CreaFactura;
     |HAZ Gecom003;

     aAlfa = #gecom003#1;  |QBF aAlfa;
     |SI aAlfa = "";
         |SI nEsCSV = 1;
             eaError = "Formato XML no v lido";
             |HAZ GrabaErrorResultado;
         |FINSI;

         |ACABA;
     |FINSI;

     aAlfa = #gecom003#1;  |QBF aAlfa;

     #gecom003#0 = enEmp;
     #gecom003#1 = aAlfa;

     |SI eaTFac = "REC";
         #gecom003#1 = "REC" + aAlfa;
     |FINSI;

     #gecom002#0 = #gecom003#0;
     #gecom002#1 = #gecom003#1;
     |LEE 000#gecom002.=;
     |SI FSalida = 0;
         |SI PARAMETRO = "BROWSE";
             |MENAV "0000La factura ya existe en la base de datos";
         |FINSI;

         |SI nEsCSV = 1;
             eaError = "La factura ya existe en la base de datos";
             |HAZ GrabaErrorResultado;
         |FINSI;

         aOri  = eaPathPdt + aFicXML;
         aDes  = eaPathDup + aFicXML;
         |COPIA_FICHERO aOri, aDes;
         |SI FSalida ] 0;
             |FBORRA aOri;
         |FINSI;

         |ACABA;
     |FINSI;

     enEmp = #gecom002#0;
     eaIde = #gecom002#1;
     |SUB_EJECUTA "gecoz002;BORRARESTOS";

     nGrabadas = nGrabadas + 1;

     #gecom003#109 = "01";
     #gecom003#110 = "FACe";
     |SI nFaceB2B = 1;
         #gecom003#109 = "02";
         #gecom003#110 = "FACeB2B";
     |FINSI;

     |GRABA 020#gecom003.n;
     |LIBERA #gecom003;

     |DBASE aBase;
     eaPathAdj = aBase + "documentos";
     eaPathAdj = eaPathAdj + "/adjuntos";
     eaPathAdj = eaPathAdj + "/" + (("00000" + #gecom003#0) % -105);
     eaPathAdj = eaPathAdj + "/";

     |DDEFECTO #gecom002;
     #gecom002#0  = #gecom003#0;
     #gecom002#1  = #gecom003#1;
     #gecom002#2  = #gecom003#4;
     #gecom002#3  = #gecom003#20;
     #gecom002#4  = #gecom003#51;
     #gecom002#5  = #gecom003#108;

     aAlfa = #gecom003#15;  |QBF aAlfa;
     |SI aAlfa ! "";
         #gecom002#3  = aAlfa;
     |FINSI;

     aAlfa = #gecom003#46;  |QBF aAlfa;
     |SI aAlfa ! "";
         #gecom002#4  = aAlfa;
     |FINSI;

     #gecom002#6  = #gecom500#0;
     #gecom002#7  = "R";

     |SI eaTFac = "EMI";
         #gecom002#7  = "P";
     |FINSI;

     #gecom002#8  = #gecom003#110;
     #gecom002#9  = "";
     #gecom002#10 = "01.01.0000";
     #gecom002#11 = "";
     #gecom002#12 = "";
     #gecom002#19 = aFicXML;

     |GRABA 020#gecom002.n;
     |LIBERA #gecom002;

     eaCmp0  = #gecom002#0;
     eaCmp1  = #gecom002#1;

     |SI eaTFac = "REC";
         eaCmp4  = "Factura recibida";
     |FINSI;

     |SI eaTFac = "EMI";
         eaCmp4  = "Importaci¢n factura emitida";
     |FINSI;

     eaCmp5  = #gecom002#7;
     eaCmp7  = "";
     eaCmp8  = "";
     eaCmp9  = "";
     eaCmp9  = "";
     eaCmp10 = Usuario % 810;
     |HAZ GrabaLog;

     |HAZ Gecom004;
     |HAZ Gecom005;

     |BUCLE gecow012;

     |HAZ Gecom010;
     |HAZ Gecom011;
     |HAZ Gecom012;
     |HAZ Gecom013;

     |SI aFicADJ ! "";
         |HAZ MeteAdjunto;
     |FINSI;

     eaIde = #gecom003#1;
     |SUB_EJECUTA "gecoz002;RECALCULO";

     aOri  = eaPathPdt + aFicXML;
     aDes  = eaPathImp + aFicXML;
     |COPIA_FICHERO aOri, aDes;
     |SI FSalida ] 0;
         |FBORRA aOri;
     |FINSI;

     |DFICE aPath;
     aAbre = aPath + eaNomFic + ".sal";
     |XABRE "WB", aAbre, nHandle;

     aTab = &9;

     aAlfa = "Empresa" + aTab;
     aAlfa = aAlfa  + "Identificador";
     aAlfa = aAlfa  +  &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = #gecom002#0;                     |QBF aAlfa;
     aAlfa = aAlfa + aTab + #gecom002#1;      |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO TrataCadena;
     aAlfa = aCadena;  |QBT aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aAlfa = aAlfa - aCar13;  |QBT aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aAlfa = aAlfa - aCar10;  |QBT aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aVal = aCadena;

     |QBF aCadena;

     |SI aCadena = "<fb2b:FaceB2BExtension>";
         nFaceB2B = 1;
     |FINSI;

     |SI aCadena = "<FileHeader>";
         nGrabar = 1;
     |FINSI;

     |SI nGrabar = 0;
         |ACABA;
     |FINSI;

     eaAlfa = aVal;  |HAZ QuitaRarosTF8; aVal = eaAlfa;

     nId = nId + 1;

     |DDEFECTO #gecow011;
     #gecow011#0 = nId;
     #gecow011#1 = aVal;

     |GRABA 020#gecow011.n;
     |LIBERA #gecow011;
|FPRC;

|PROCESO gecom501C2;
     nConta = nConta + 1;
|FPRC;

|DEFBUCLE gecom501C2;
     #gecom501#2;
     ;
     #gecom500#0, aEtiq;
     #gecom500#0, aEtiq;
     ;
     NULL, gecom501C2;
|FIN;

|PROCESO gecom501C3;
     nCal1  = #gecom501#1;
     nCal2  = #gecom501#2;
     nCal3  = #gecom501#3;
     nCal4  = #gecom501#4;
     nCal5  = #gecom501#5;
     nCal6  = #gecom501#6;
     nCal7  = #gecom501#7;
     nCal8  = #gecom501#8;
     nCal9  = #gecom501#9;
     nCal10 = #gecom501#10;

     |ERROR10;
|FPRC;

|DEFBUCLE gecom501C3;
     #gecom501#3;
     12;
     #gecom500#0, aDEtiq, aEtiq;
     #gecom500#0, aHEtiq, aEtiq;
     ;
     NULL, gecom501C3;
|FIN;

|PROCESO TrataAgru;
     |SI nCal10 ! 0; |Y nCal10 ! 99;   nAgru10 = 0;  |ACABA;  |FINSI;
     |SI nCal9  ! 0; |Y nCal9  ! 99;   nAgru9  = 0;  |ACABA;  |FINSI;
     |SI nCal8  ! 0; |Y nCal8  ! 99;   nAgru8  = 0;  |ACABA;  |FINSI;
     |SI nCal7  ! 0; |Y nCal7  ! 99;   nAgru7  = 0;  |ACABA;  |FINSI;
     |SI nCal6  ! 0; |Y nCal6  ! 99;   nAgru6  = 0;  |ACABA;  |FINSI;
     |SI nCal5  ! 0; |Y nCal5  ! 99;   nAgru5  = 0;  |ACABA;  |FINSI;
     |SI nCal4  ! 0; |Y nCal4  ! 99;   nAgru4  = 0;  |ACABA;  |FINSI;
     |SI nCal3  ! 0; |Y nCal3  ! 99;   nAgru3  = 0;  |ACABA;  |FINSI;
     |SI nCal2  ! 0; |Y nCal2  ! 99;   nAgru2  = 0;  |ACABA;  |FINSI;
     |SI nCal1  ! 0; |Y nCal1  ! 99;   nAgru1  = 0;  |ACABA;  |FINSI;
|FPRC;

|PROCESO BuscaCodigo;
     aAlfa = #gecow011#1 % 201;
     |SI aAlfa = "/";
         aAlfa1 = #gecom501#13;  |QBF aAlfa1;
         aAlfa2 = #gecow011#1;   |QBF aAlfa2;
         |SI aAlfa1 = aAlfa2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #gecom501#1 ! 0;
         nIdAg1  = #gecom501#1;
         nIdAg2  = #gecom501#2;
         nIdAg3  = #gecom501#3;
         nIdAg4  = #gecom501#4;
         nIdAg5  = #gecom501#5;
         nIdAg6  = #gecom501#6;
         nIdAg7  = #gecom501#7;
         nIdAg8  = #gecom501#8;
         nIdAg9  = #gecom501#9;
         nIdAg10 = #gecom501#10;
     |FINSI;

     nConta = 0;
     aEtiq  = #gecow011#1;  |QBF aEtiq;
     |BUCLE gecom501C2;

     |SI nConta = 1;
         |SELECT #2#gecom501;
         #gecom501#0  = #gecom500#0;
         #gecom501#12 = aEtiq;
         |LEE 000#gecom501.=;
         |SI FSalida = 0;  |ACABA;  |FINSI;
     |FINSI;

     nAgru1  = nIdAg1;
     nAgru2  = nIdAg2;
     nAgru3  = nIdAg3;
     nAgru4  = nIdAg4;
     nAgru5  = nIdAg5;
     nAgru6  = nIdAg6;
     nAgru7  = nIdAg7;
     nAgru8  = nIdAg8;
     nAgru9  = nIdAg9;
     nAgru10 = nIdAg10;

     |PARA;  |SI;  |HACIENDO;
          nCal1  = nAgru1;
          nCal2  = nAgru2;
          nCal3  = nAgru3;
          nCal4  = nAgru4;
          nCal5  = nAgru5;
          nCal6  = nAgru6;
          nCal7  = nAgru7;
          nCal8  = nAgru8;
          nCal9  = nAgru9;
          nCal10 = nAgru10;

          aDEtiq = (("00" + nCal1) % -102);
          aDEtiq = aDEtiq + (("00" + nCal2) % -102);
          aDEtiq = aDEtiq + (("00" + nCal3) % -102);
          aDEtiq = aDEtiq + (("00" + nCal4) % -102);
          aDEtiq = aDEtiq + (("00" + nCal5) % -102);
          aDEtiq = aDEtiq + (("00" + nCal6) % -102);
          aDEtiq = aDEtiq + (("00" + nCal7) % -102);
          aDEtiq = aDEtiq + (("00" + nCal8) % -102);
          aDEtiq = aDEtiq + (("00" + nCal9) % -102);
          aDEtiq = aDEtiq + (("00" + nCal10) % -102);

          |SI nCal1  = 0;  nCal1  = 99;  |FINSI;
          |SI nCal2  = 0;  nCal2  = 99;  |FINSI;
          |SI nCal3  = 0;  nCal3  = 99;  |FINSI;
          |SI nCal4  = 0;  nCal4  = 99;  |FINSI;
          |SI nCal5  = 0;  nCal5  = 99;  |FINSI;
          |SI nCal6  = 0;  nCal6  = 99;  |FINSI;
          |SI nCal7  = 0;  nCal7  = 99;  |FINSI;
          |SI nCal8  = 0;  nCal8  = 99;  |FINSI;
          |SI nCal9  = 0;  nCal9  = 99;  |FINSI;
          |SI nCal10 = 0;  nCal10 = 99;  |FINSI;

          aHEtiq = (("00" + nCal1) % -102);
          aHEtiq = aHEtiq + (("00" + nCal2) % -102);
          aHEtiq = aHEtiq + (("00" + nCal3) % -102);
          aHEtiq = aHEtiq + (("00" + nCal4) % -102);
          aHEtiq = aHEtiq + (("00" + nCal5) % -102);
          aHEtiq = aHEtiq + (("00" + nCal6) % -102);
          aHEtiq = aHEtiq + (("00" + nCal7) % -102);
          aHEtiq = aHEtiq + (("00" + nCal8) % -102);
          aHEtiq = aHEtiq + (("00" + nCal9) % -102);
          aHEtiq = aHEtiq + (("00" + nCal10) % -102);

          |SI aHEtiq = "99999999999999999999";
              |DDEFECTO #gecom501;
              |SAL;
          |FINSI;

          #gecom501#12 = aEtiq;
          aEtiq  = #gecom501#12;
          |BUCLE gecom501C3;

          |SELECT #1#gecom501;
          #gecom501#0  = #gecom500#0;
          #gecom501#1  = nCal1;
          #gecom501#2  = nCal2;
          #gecom501#3  = nCal3;
          #gecom501#4  = nCal4;
          #gecom501#5  = nCal5;
          #gecom501#6  = nCal6;
          #gecom501#7  = nCal7;
          #gecom501#8  = nCal8;
          #gecom501#9  = nCal9;
          #gecom501#10 = nCal10;
          |LEE 000#gecom501.=;
          |SI FSalida = 0;  |SAL;  |FINSI;

          |HAZ TrataAgru;
     |SIGUE;
|FPRC;

|PROCESO gecow011;
     |SI nFaceB2B = 1;
         aAlfa = #gecow011#1;  |QBF aAlfa;
         |SI aAlfa = "<publicOrganismCode>";
             nCodEsp = 1;
             |ACABA;
         |FINSI;

         |SI aAlfa = "<contractReference>";
             nCodEsp = 2;
             |ACABA;
         |FINSI;

         |SI aAlfa = "<code>";
             nCodEsp = 3;
             |ACABA;
         |FINSI;

         |SI aAlfa = "</publicOrganismCode>";
             nCodEsp = 0;
             |ACABA;
         |FINSI;

         |SI aAlfa = "</contractReference>";
             nCodEsp = 0;
             |ACABA;
         |FINSI;

         |SI aAlfa = "</code>";
             nCodEsp = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nCodEsp ! 0;
         |SI nCodEsp = 1;
             #gecow011#13 = "gecom003";
             #gecow011#14 = 111;
         |FINSI;

         |SI nCodEsp = 2;
             #gecow011#13 = "gecom003";
             #gecow011#14 = 112;
         |FINSI;

         |SI nCodEsp = 3;
             #gecow011#12 = "02020301990000000000";
             #gecow011#13 = "gecom004";
             #gecow011#14 = 27;
         |FINSI;

         |GRABA 020#gecow011.a;
         |LIBERA #gecow011;

         |ACABA;
     |FINSI;

     aAlfa = #gecow011#1 % 101;
     |SI aAlfa = "<";
         |HAZ BuscaCodigo;
     |FINSI;

     #gecow011#2  = #gecom501#1;
     #gecow011#3  = #gecom501#2;
     #gecow011#4  = #gecom501#3;
     #gecow011#5  = #gecom501#4;
     #gecow011#6  = #gecom501#5;
     #gecow011#7  = #gecom501#6;
     #gecow011#8  = #gecom501#7;
     #gecow011#9  = #gecom501#8;
     #gecow011#10 = #gecom501#9;
     #gecow011#11 = #gecom501#10;

     aAlfa = (("00" + #gecow011#2) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#3) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#4) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#5) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#6) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#7) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#8) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#9) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#10) % -102);
     aAlfa = aAlfa + (("00" + #gecow011#11) % -102);

     #gecow011#12 = aAlfa;

     aAlfa = #gecom501#14;  |QBF aAlfa;
     |SI aAlfa ! "";
         #gecow011#13 = #gecom501#14 % 214;
         aAlfa        = aAlfa % -203;
         #gecow011#14 = aAlfa;
     |FINSI;

     |GRABA 020#gecow011.a;
     |LIBERA #gecow011;
|FPRC;

|DEFBUCLE gecow011;
     #gecow011#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, gecow011;
|FIN;

|PROCESO gecow011Bor;
     aAlfa = #gecow011#1;  |QBF aAlfa;

     aAlfa1 = aAlfa % 101;
     aAlfa2 = aAlfa % -101;
     |SI aAlfa1 = "<";  |Y aAlfa2 = ">";
         |BORRA 020#gecow011.a;
         |LIBERA #gecow011;
     |FINSI;
|FPRC;

|DEFBUCLE gecow011Bor;
     #gecow011#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, gecow011Bor;
|FIN;

|PROCESO TrataXML;
     |ABRE #gecow011;  |CIERRA #gecow011;  |DELINDEX #gecow011;
     |ABRE #gecow012;  |CIERRA #gecow012;  |DELINDEX #gecow012;

     |ABRET #gecow011;
     |ABRET #gecow012;

     nLeidas = nLeidas + 1;

     nGrabar  = 0;
     nId      = 0;
     nFaceB2B = 0;

     aAbre = eaPathPdt + aFicXML;
     |XABRE "E", aAbre, nHandle;
     |SI FSalida < 0;
         |SI nEsCSV = 1;
             eaError = "No encuentro el fichero XML";
             |HAZ GrabaErrorResultado;
         |FINSI;

         |ACABA;
     |FINSI;

     |XABRE "B", aAbre, nHandle;
     |PARA; |SI; |HACIENDO;
         |XLEE nHandle, 1, aCaracter;
         |SI FSalida [ 0;  |SAL;  |FINSI;

         |SI aCaracter = "<";
             |HAZ TrataCadena;

             aCadena = "";
         |FINSI;

         |SI aCaracter = ">";
             aCadena = aCadena + aCaracter;
             |HAZ TrataCadena;

             aCaracter = "";
             aCadena  = "";
         |FINSI;

         aLong = aCadena % 0;
         |SI aLong = "250";
             |HAZ TrataCadena;

             aCadena  = "";
         |FINSI;

         aCadena = aCadena + aCaracter;
     |SIGUE;
     |XCIERRA nHandle;

     |BUCLE gecow011;

     |BUCLE gecow011Bor;

     |HAZ CreaFactura;

     |CIERRAT #gecow011;  |DELINDEX #gecow011;
     |CIERRAT #gecow012;  |DELINDEX #gecow012;
|FPRC;

|PROCESO CargaDirectorios;
     eaPathImp = aBase + "documentos";
     eaPathImp = eaPathImp + "/importacion";

     eaPathPdt = aBase + "documentos";
     eaPathPdt = eaPathPdt + "/importacion";

     eaPathDup = aBase + "documentos";
     eaPathDup = eaPathDup + "/importacion";

     |SI eaTFac = "REC";
         eaPathImp = eaPathImp + "/recibidas";
         eaPathImp = eaPathImp + "/" + (("00000" + enEmp) % -105); |MKDIR eaPathImp;
         eaPathImp = eaPathImp + "/recogidas";                     |MKDIR eaPathImp;
         eaPathImp = eaPathImp + "/";

         eaPathPdt = eaPathPdt + "/recibidas";
         eaPathPdt = eaPathPdt + "/" + (("00000" + enEmp) % -105);
         eaPathPdt = eaPathPdt + "/pendientes";                    |MKDIR eaPathPdt;
         eaPathPdt = eaPathPdt + "/";

         eaPathDup = eaPathDup + "/recibidas";
         eaPathDup = eaPathDup + "/" + (("00000" + enEmp) % -105);
         eaPathDup = eaPathDup + "/duplicadas";                    |MKDIR eaPathDup;
         eaPathDup = eaPathDup + "/";
     |FINSI;

     |SI eaTFac = "EMI";
         eaPathImp = eaPathImp + "/emitidas";
         eaPathImp = eaPathImp + "/" + (("00000" + enEmp) % -105); |MKDIR eaPathImp;
         eaPathImp = eaPathImp + "/recogidas";                     |MKDIR eaPathImp;
         eaPathImp = eaPathImp + "/";

         eaPathPdt = eaPathPdt + "/emitidas";
         eaPathPdt = eaPathPdt + "/" + (("00000" + enEmp) % -105);
         eaPathPdt = eaPathPdt + "/pendientes";                    |MKDIR eaPathPdt;
         eaPathPdt = eaPathPdt + "/";

         eaPathDup = eaPathDup + "/emitidas";
         eaPathDup = eaPathDup + "/" + (("00000" + enEmp) % -105);
         eaPathDup = eaPathDup + "/duplicadas";                    |MKDIR eaPathDup;
         eaPathDup = eaPathDup + "/";
     |FINSI;
|FPRC;

|PROCESO PorLISTA;
     |HAZ AbreVtn;

     nLeidas   = 0;
     nGrabadas = 0;

     aDir = eaPathPdt + "*.*";
     |_PDIR aDir;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          aAlfa = aDir < "";
          aAlfa = aAlfa % -103;
          |SI aAlfa = "xml";
              aFicXML = aDir - eaPathPdt;
              |HAZ TrataXML;
          |FINSI;

          |_SDIR aDir;
     |SIGUE;

     |HAZ CierraVtn;

     aAlfa = "0000Se han leido " + nLeidas + " ficheros xml de los cuales se han ";
     aAlfa = aAlfa + "grabado " + nGrabadas;
     |MENAV aAlfa;
|FPRC;

|PROCESO gecom001;
     enEmp = #gecom001#0;

     |HAZ CargaDirectorios;

     aDir = eaPathPdt + "*.*";
     |_PDIR aDir;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          aAlfa = aDir < "";
          aAlfa = aAlfa % -103;
          |SI aAlfa = "xml";
              aFicXML = aDir - eaPathPdt;
              |HAZ TrataXML;
          |FINSI;

          |_SDIR aDir;
     |SIGUE;
|FPRC;

|DEFBUCLE gecom001;
     #gecom001#3;
     ;
     "S", 00000;
     "S", 99999;
     ;
     NULL, gecom001;
|FIN;

|PROCESO PorCRON;
     |BUCLE gecom001;
|FPRC;

|PROCESO PonDsselect;
     aVer1 = "";
     aVer2 = "";
     aMd5  = eaPathPlu + "dsselect.exe";
     |ESPECIFICA "MD5", aMd5;
     aVer1 = FSalida;

     aMd5 = eaPathTmpLocal + "dsselect.exe";
     |ESPECIFICA "REMOTOMD5", aMd5;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = eaPathPlu + "dsselect.exe";
         aDes = eaPathTmpLocal + "dsselect.exe";

         |SI eaIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         |XABRE "EC", aDes, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el explorador de ficheros, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO TraeDoc;
     |SI eaTFac = "REC";
         |MENAV "0000A continuaci¢n busque y seleccione el fichero XML a recibir";
     |FINSI;

     |SI eaTFac = "EMI";
         |MENAV "0000A continuaci¢n busque y seleccione el fichero XML a importar";
     |FINSI;

     nOk = 0;
     |HAZ PonDsselect;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aProg = eaPathTmpLocal + "dsselect.exe " + eaPathTmpLocal + "dsselect.ini";

     aAlfa = eaPathTmpLocal + "dsselect.txt";  |RFBORRA aAlfa;
     aAlfa = eaPathTmpLocal + "dsselect.ini";  |RFBORRA aAlfa;

     aAbre = eaPathTmpLocal + "dsselect.ini";
     |XABRE "CW", aAbre, nHandle;
     |SI FSalida ] 0;
          aLinea = &34 + eaPathTmpLocal + &34 + " " + &34 + eaPathTmpLocal + "dsselect.txt" + &34;
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;

     |RSYSTEM aProg;
     |PULSATECLA;

     aRuta = "";
     aAbre = eaPathTmpLocal + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida ] 0;
         |XLEE nHandle, 250, aRuta;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa = eaPathTmpLocal + "dsselect.txt";
     |RFBORRA aAlfa;

     |PULSATECLA;

     |QBF aRuta;
     |SI aRuta = "";
         nOk = 0;
         |ACABA;
     |FINSI;

     aAlfa      = aRuta;
     aFicBrowse = "";
     aFicXML    = "";
     aLong      = aAlfa % 0;
     nLong      = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aFicBrowse = aFicBrowse + aCaracter;
           aFicXML    = aFicXML + aCaracter;

           |SI aCaracter = "/";  |O aCaracter = "\";
               aFicXML = "";
           |FINSI;
     |SIGUE;

     aFicXML = aFicXML < "";

     aAlfa = aFicXML - ".xml";
     |SI FSalida = 0;
         aAlfa = "0000El fichero deber  tener extesi¢n XML";
         |MENAV aAlfa;
         nOk = 0;

         |ACABA;
     |FINSI;

     aOri  = aFicBrowse;
     aDes  = eaPathImp + aFicXML;

     |XABRE "E", aDes, 0;
     |SI FSalida ] 0;
         aAlfa = "0000El fichero ya ha sido procesado.";
         |MENAV aAlfa;
         nOk = 0;

         |ACABA;
     |FINSI;

     aDes  = eaPathPdt + aFicXML;
     |SI eaIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |RECIBE_FICHERO aOri, aDes;
     |FINSI;
|FPRC;

|PROCESO PorBROWSE;
     |HAZ TraeDoc;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |HAZ AbreVtn;
     |HAZ TrataXML;
     |HAZ CierraVtn;
|FPRC;

|PROCESO Dato;
     nCampo  = 1;
     IaValor = aValor1<-;
     aLon    = aDato % 0;
     aReg    = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos   = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
              aValor = aReg;
              aReg = "";
              nCampo = nCampo + 1;
              IaValor = IaValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;

          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;

     aValor = aReg;
|FPRC;

|PROCESO LeeCSV;
     enEmp   = 0;
     aFicXML = "";
     aFicADJ = "";
     aDes    = "";

     |DFICE aPath;
     aDes = aPath + eaNomFic + ".ent";
     |XABRE "", aDes, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aDato;    || los nombres
          |XLEE nHandle, 250, aDato;
          |HAZ Dato;
          |XCIERRA nHandle;

          enEmp   = aValor1;
          aFicXML = aValor2;
          aFicADJ = aValor3;
          eaTFac  = aValor4 > "";
     |FINSI;

     |QBF aFicXML;
     |QBF aFicADJ;
     |QBF eaTFac;
|FPRC;

|PROCESO PorCSV;
     aTab     = &9;
     eaNomFic = PARAMETRO;   |QBF eaNomFic;
     |HAZ LeeCSV;

     eaError = "";
     |SI enEmp = 0;
         eaError = "0000Falta introducir c¢digo de empresa";
     |FINSI;

     |SI aFicXML = "";
         eaError = "0000Falta introducir nombre archivo xml";
     |FINSI;

     |SI eaError ! "";
         |HAZ GrabaErrorResultado;
         |ACABA;
     |FINSI;

     eaError = "";
     |HAZ CargaDirectorios;

     |HAZ TrataXML;
|FPRC;

|PROGRAMA;
     nEsCSV = 0;

     |SI PARAMETRO = "LISTA";
         |HAZ PorLISTA;
         |ACABA;
     |FINSI;

     |SI PARAMETRO = "CRON";
         |HAZ PorCRON;
         |ACABA;
     |FINSI;

     |SI PARAMETRO = "BROWSE";
         |HAZ PorBROWSE;
         |ACABA;
     |FINSI;

     nEsCSV = 1;
     |HAZ PorCSV;
|FPRO;

|PROCESO T80;  |TIPO 80;
     aCar10   = &10;
     aCar13   = &13;

     |HAZ LeeUnidadBasico;

     eaPathTmpLocal = eaUnidadBasico + "\documentos";   |RMKDIR eaPathTmpLocal;
     eaPathTmpLocal = eaPathTmpLocal + "\gecobase";     |RMKDIR eaPathTmpLocal;
     eaPathTmpLocal = eaPathTmpLocal + "\";

     |DBASE aBase;

     aAlfa = aBase + "documentos";    |MKDIR aAlfa;
     aAlfa = aAlfa + "/importacion";  |MKDIR aAlfa;

     |SI eaTFac = "REC";
         aAlfa = aAlfa + "/recibidas";  |MKDIR aAlfa;
     |FINSI;

     |SI eaTFac = "EMI";
         aAlfa = aAlfa + "/emitidas";  |MKDIR aAlfa;
     |FINSI;

     |SI enEmp ! 0;
         |HAZ CargaDirectorios;
     |FINSI;

     eaPathPlu = aBase + "plugins/";

     eaIP = "";
     |IP_REMOTO eaIP;

     aFic = "gecow011" + Usuario;
     |NOME_DAT #gecow011#aFic#;

     |ABRE #gecom500;
     |LEE 000#gecom500.u;
     |SI FSalida ! 0;  |DDEFECTO #gecom500;  |FINSI;
     |CIERRA #gecom500;

     |ABRET #gecom501;
     |ABRET #gecom002;
     |ABRET #gecom003;
     |ABRET #gecom004;
     |ABRET #gecom005;
     |ABRET #gecom006;
     |ABRET #gecom007;
     |ABRET #gecom008;
     |ABRET #gecom009;
     |ABRET #gecom010;
     |ABRET #gecom011;
     |ABRET #gecom012;
     |ABRET #gecom013;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #gecom501;

     |CIERRAT #gecom002;
     |CIERRAT #gecom003;
     |CIERRAT #gecom004;
     |CIERRAT #gecom005;
     |CIERRAT #gecom006;
     |CIERRAT #gecom007;
     |CIERRAT #gecom008;
     |CIERRAT #gecom009;
     |CIERRAT #gecom010;
     |CIERRAT #gecom011;
     |CIERRAT #gecom012;
     |CIERRAT #gecom013;
|FPRC;
