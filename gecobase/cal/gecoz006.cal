|FICHEROS;
     gecoz006;

     gecom002;
     gecom003;
     gecom004;
     gecom005;
     gecom006;
     gecom007;
     gecom008;
     gecom009;
     gecom010;
     gecom011;
     gecom012;
     gecom013;
|FIN;

|VARIABLES;
     n1Vent              = 0;

     aAlfa               = "";
     aBase               = "";
     aOriPDF             = "";
     aOriB64             = "";
     aDesPDF             = "";
     aDesB64             = "";
     aHora               = "";
     aIdRec              = "";
     aIdFac              = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &enEmp              = 0;
     &eaIde              = "";
     &eaPathAdj          = "";
     &eaCmp0             = "";
     &eaCmp1             = "";
     &eaCmp4             = "";
     &eaCmp5             = "";
     &eaCmp7             = "";
     &eaCmp8             = "";
     &eaCmp9             = "";
     &eaCmp10            = "";
|FIN;

|PROCESO FinVtn;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO gecom004;
     #gecom004#1 = aIdRec;
     |GRABA 020#gecom004.n;
     |LIBERA #gecom004;
|FPRC;

|DEFBUCLE gecom004;
     #gecom004#1;
     ;
     #gecom002#0, #gecom002#1, " ", "                              ";
     #gecom002#0, #gecom002#1, "z", "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, gecom004;
|FIN;

|PROCESO gecom005;
     #gecom005#1 = aIdRec;
     |GRABA 020#gecom005.n;
     |LIBERA #gecom005;
|FPRC;

|DEFBUCLE gecom005;
     #gecom005#1;
     ;
     #gecom002#0, #gecom002#1, 0000;
     #gecom002#0, #gecom002#1, 9999;
     be;
     NULL, gecom005;
|FIN;

|PROCESO gecom006;
     #gecom006#1 = aIdRec;
     |GRABA 020#gecom006.n;
     |LIBERA #gecom006;
|FPRC;

|DEFBUCLE gecom006;
     #gecom006#1;
     ;
     #gecom002#0, #gecom002#1, 0000, " ", 01;
     #gecom002#0, #gecom002#1, 9999, "z", 99;
     be;
     NULL, gecom006;
|FIN;

|PROCESO gecom007;
     #gecom007#1 = aIdRec;
     |GRABA 020#gecom007.n;
     |LIBERA #gecom007;
|FPRC;

|DEFBUCLE gecom007;
     #gecom007#1;
     ;
     #gecom002#0, #gecom002#1, 0000, 01;
     #gecom002#0, #gecom002#1, 9999, 99;
     be;
     NULL, gecom007;
|FIN;

|PROCESO gecom008;
     #gecom008#1 = aIdRec;
     |GRABA 020#gecom008.n;
     |LIBERA #gecom008;
|FPRC;

|DEFBUCLE gecom008;
     #gecom008#1;
     ;
     #gecom002#0, #gecom002#1, 0000, 01;
     #gecom002#0, #gecom002#1, 9999, 99;
     be;
     NULL, gecom008;
|FIN;

|PROCESO gecom009;
     #gecom009#1 = aIdRec;
     |GRABA 020#gecom009.n;
     |LIBERA #gecom009;
|FPRC;

|DEFBUCLE gecom009;
     #gecom009#1;
     ;
     #gecom002#0, #gecom002#1, 0000, 01;
     #gecom002#0, #gecom002#1, 9999, 99;
     be;
     NULL, gecom009;
|FIN;

|PROCESO gecom010;
     #gecom010#1 = aIdRec;
     |GRABA 020#gecom010.n;
     |LIBERA #gecom010;
|FPRC;

|DEFBUCLE gecom010;
     #gecom010#1;
     ;
     #gecom002#0, #gecom002#1, " ", 01;
     #gecom002#0, #gecom002#1, "z", 99;
     be;
     NULL, gecom010;
|FIN;

|PROCESO gecom011;
     #gecom011#1 = aIdRec;
     |GRABA 020#gecom011.n;
     |LIBERA #gecom011;
|FPRC;

|DEFBUCLE gecom011;
     #gecom011#1;
     ;
     #gecom002#0, #gecom002#1, 01;
     #gecom002#0, #gecom002#1, 99;
     be;
     NULL, gecom011;
|FIN;

|PROCESO gecom012;
     aOriPDF  = eaPathAdj + (("00000" + #gecom012#0) % -105);
     aOriPDF  = aOriPDF + #gecom012#1;  |QBF aOriPDF;
     aOriPDF  = aOriPDF + (("00" + #gecom012#2) % -102);
     aOriPDF  = aOriPDF + "." + #gecom012#3;   |QBF aOriPDF;

     aOriB64  = eaPathAdj + (("00000" + #gecom012#0) % -105);
     aOriB64  = aOriB64 + #gecom012#1;  |QBF aOriB64;
     aOriB64  = aOriB64 + (("00" + #gecom012#2) % -102);
     aOriB64  = aOriB64 + ".b64";

     #gecom012#1 = aIdRec;
     |GRABA 020#gecom012.n;
     |LIBERA #gecom012;

     aDesPDF  = eaPathAdj + (("00000" + #gecom012#0) % -105);
     aDesPDF  = aDesPDF + #gecom012#1;  |QBF aDesPDF;
     aDesPDF  = aDesPDF + (("00" + #gecom012#2) % -102);
     aDesPDF  = aDesPDF + "." + #gecom012#3;   |QBF aDesPDF;

     aDesB64  = eaPathAdj + (("00000" + #gecom012#0) % -105);
     aDesB64  = aDesB64 + #gecom012#1;  |QBF aDesB64;
     aDesB64  = aDesB64 + (("00" + #gecom012#2) % -102);
     aDesB64  = aDesB64 + ".b64";

     |COPIA_FICHERO aOriPDF, aDesPDF;
     |COPIA_FICHERO aOriB64, aDesB64;
|FPRC;

|DEFBUCLE gecom012;
     #gecom012#1;
     ;
     #gecom002#0, #gecom002#1, 01;
     #gecom002#0, #gecom002#1, 99;
     be;
     NULL, gecom012;
|FIN;

|PROCESO gecom013;
     #gecom013#1 = aIdRec;
     |GRABA 020#gecom013.n;
     |LIBERA #gecom013;
|FPRC;

|DEFBUCLE gecom013;
     #gecom013#1;
     ;
     #gecom002#0, #gecom002#1, 001;
     #gecom002#0, #gecom002#1, 999;
     be;
     NULL, gecom013;
|FIN;

|PROCESO Rectificacion;
     |DBASE aBase;
     eaPathAdj = aBase + "documentos";                         |MKDIR eaPathAdj;
     eaPathAdj = eaPathAdj + "/adjuntos";                      |MKDIR eaPathAdj;
     eaPathAdj = eaPathAdj + "/" + (("00000" + enEmp) % -105); |MKDIR eaPathAdj;
     eaPathAdj = eaPathAdj + "/";

     aIdRec = #gecoz006#0;  |QBF aIdRec;
     aIdRec = aIdRec + #gecoz006#1;  |QBF aIdRec;

     #gecom002#0 = enEmp;
     #gecom002#1 = eaIde;
     |LEE 101#gecom002.=;

     #gecom003#0 = enEmp;
     #gecom003#1 = eaIde;
     |LEE 000#gecom003.=;

     #gecom003#1 = aIdRec;
     #gecom003#2 = #gecoz006#0;
     #gecom003#3 = #gecoz006#1;
     |GRABA 020#gecom003.n;
     |LIBERA #gecom003;

     |BUCLE gecom004;
     |BUCLE gecom005;
     |BUCLE gecom006;
     |BUCLE gecom007;
     |BUCLE gecom008;
     |BUCLE gecom009;
     |BUCLE gecom010;
     |BUCLE gecom011;
     |BUCLE gecom012;
     |BUCLE gecom013;

     #gecom002#7  = "XX";

     eaCmp0  = #gecom002#0;
     eaCmp1  = #gecom002#1;
     eaCmp4  = "Rectificaci¢n factura";
     eaCmp5  = #gecom002#7;
     eaCmp7  = "Id Factura destino: " + aIdRec;
     eaCmp8  = "";
     eaCmp9  = "";
     eaCmp10 = Usuario % 810;
     |HAZ GrabaLog;

     |GRABA 020#gecom002.a;
     |LIBERA #gecom002;

     aIdFac = #gecom002#1;  |QBF aIdFac;

     #gecom002#13 = #gecom002#1;
     #gecom002#1  = aIdRec;
     #gecom002#7  = "RP";
     #gecom002#14 = #gecoz006#2;
     #gecom002#15 = #gecoz006#4;
     #gecom002#9  = "";
     #gecom002#10 = "01.01.0000";
     #gecom002#11 = "";
     #gecom002#12 = "";

     |GRABA 020#gecom002.n;
     |LIBERA #gecom002;

     eaCmp0  = #gecom002#0;
     eaCmp1  = #gecom002#1;
     eaCmp4  = "Factura rectificada";
     eaCmp5  = #gecom002#7;
     eaCmp7  = "Id Factura origen: " + aIdFac;
     eaCmp8  = "";
     eaCmp9  = "";
     eaCmp10 = Usuario % 810;
     |HAZ GrabaLog;
|FPRC;

|PROCESO T12z006;  |TIPO 12;
     |SI FSalida = 7;
         |HAZ FinVtn;
         |ACABA;
     |FINSI;

     |SI FSalida ! 1;
         |POSICIONATE #gecoz006#0;
         |ERROR;
         |ACABA;
     |FINSI;

     aIdRec = #gecoz006#0;  |QBF aIdRec;
     aIdRec = aIdRec + #gecoz006#1;  |QBF aIdRec;
     |SI aIdRec = "";
         |MENAV "0000Introduzca contenido en la Serie o Factura";
         |POSICIONATE #gecoz006#0;
         |ERROR;

         |ACABA;
     |FINSI;

     #gecom002#0 = enEmp;
     #gecom002#1 = aIdRec;
     |LEE 000#gecom002.=;
     |SI FSalida = 0;
         |MENAV "0000La factura ya existe";
         |POSICIONATE #gecoz006#0;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #gecoz006#2;   |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Campo motivo obligatorio.";

         |POSICIONATE #gecoz006#2;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #gecoz006#4;   |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Campo metodo obligatorio.";

         |POSICIONATE #gecoz006#4;
         |ERROR;
         |ACABA;
     |FINSI;

     |HAZ FinVtn;

     |VENTANA 0501, 0540, -1, 16, "Rectificando factura";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |HAZ Rectificacion;

     |HAZ FinVtn;

     |MENAV "0000La factura se encuentra en la bandeja Rectificativas Pendientes. Rectifique la factura desde alli.";
|FPRC;

|PROGRAMA;
     |VENTANA 0501, 2399, -1, 16, "Motivo de la rectificaci¢n";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     #gecoz006#0 = "R" + #gecom003#2;
     #gecoz006#1 = #gecom003#3;

     |PINPA #0#gecoz006;
     |PINDA #0#gecoz006;
     |ENDATOS #1#gecoz006;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |ABRET #gecom002;
     |ABRET #gecom003;

     #gecom002#0 = enEmp;
     #gecom002#1 = eaIde;
     |LEE 000#gecom002.=;

     #gecom003#0 = enEmp;
     #gecom003#1 = eaIde;
     |LEE 000#gecom003.=;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #gecom002;
     |CIERRAT #gecom003;
|FPRC;
