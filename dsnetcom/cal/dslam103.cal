|FICHEROS;
     dsnetm00 #0;
     dsnetm02 #2;
     dslam008 #8;
     dslam010 #10;
     dslam015 #15,MANTE;
     dslam103 #103;
     dslam105 #105;
     dsnetm07 #7;
     dslaw001 #203;
     dslaw006 #205;
     dslamx01 #99;

     labtraba@ #900;
     nomvarca@ #901;
     nomvarli@ #902;
     labparhi@ #903;     || HISTORICO DE PARTES DE ACCIDENTE
     labparma@ #904;     || MANTENIMIENTO DE PARTES EMITIDOS / NO EMITIDOS
|FIN;

|VARIABLES;
     sw = 0;
     aUsuPos = "";
     aPerPos = "";
     fFecPos = @;
     aHoraPos = "";

     nCampo         = 0;
     nCampo1        = 0;
     nCampo2        = 0;
     nCampo3        = 0;
     nRegis         = 0;
     nAscci         = 0;
     nHandle        = 0;
     nCanal         = 0;
     nCanal2        = 0;
     nError         = 0;

     &aParametro     = "";
     aCampo         = "";
     aCampo1        = "";
     aCampo2        = "";
     aCampo3        = "";
     aCampo4        = "";
     aCampo5        = "";
     aCampo6        = "";
     aCampo7        = "";
     aCampo8        = "";
     aCampo9        = "";
     aCampo10       = "";
     aCampo11       = "";
     aCampo12       = "";
     aCampo13       = "";
     aCampo14       = "";
     aCampo15       = "";
     aCampo16       = "";
     aCampo17       = "";
     aCampo18       = "";
     aCampo19       = "";
     aCampo20       = "";
     aCampo21       = "";
     aCampo22       = "";
     aCampo23       = "";
     aCampo24       = "";
     aCampo25       = "";
     aCampo26       = "";
     aCampo27       = "";
     aCaracter      = "";
     aWeb           = "";
     aAbre          = "";
     aAbreD         = "";
     aAbreSmf       = "";
     aAlfa          = "";
     aBase          = "";
     aMas           = "";
     aFich          = "";
     aTecla         = "";
     aCopialo1      = "";
     aCopialo2      = "";
     &aTituloV      = "";
     nExiste        = 0;

     aAlfa1 = "";
     aAlfa2 = "";
     aLongitud = "";
     nLongitud = 0;
     nTam = 0;
     nNume = 0;
     nCaracter = 0;
     swParteOK = 0;

     aDirOrigen = "";
     aUsuOrigen = "";
     aFichOrigen = "";
     aFichDestino = "";
     aFichTrabajo = "";
     aFichero = "";
     aOrigen = "";
     aDestino = "";
     aCol = "";
     nCol = 0;
     aFila = "";
     nFila = 0;
     aCelda = "";
     aNombreHoja = "";
     aHoja = "";
     nHoja = 0 ;
     aValor = "";
     aEmpresa = "";
     nEmpresa = 0;
     aNombre = "";
     aMes = "";
     nMes = "";
     aAny = "";
     nAny = 0;
     aFichHora = "";
     swValido = 0;
|FIN;

|| Carga desde Hoja Excel --------------------------------------------------

|PROCESO Borra;
     |BORRA 020#dslam015.a;
|FPRC;

|DEFBUCLE BorraRestos;
     #dslam015#1;
     ;
     "N", "          ", 00001, 1999, 01, "                              ";
     "N", "zzzzzzzzzz", 99999, 2999, 12, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, Borra;
|FIN;

|PROCESO CierraLibro;
     || aFichTrabajo es la ruta del xls de trabajo (con el "_TRA")
     || aDestino2 es la ruta del fichero que dejare copiado en local si se
     || me pide que es ademas el que enviare al directorio donde se quedara
     || aDestino no la uso mas

     ||aDestino2 = aOrigen - "_TRA";
     ||RFBORRA aDestino2;

     ||ALFACALLDLL "agixl97.dll", "fichero_destino", aDestino2;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
     |DESCARGADLL "agixl97.dll";

     |RFBORRA aFichTrabajo;
|FPRC;

|PROCESO LeeCelda;
     aCol = &nCol;   |QBF aCol;
     aFila = nFila; |QBF aFila;
     aCelda = aCol + aFila;
     |QBF aValor;
     aValor = aCelda;
     |ALFACALLDLL "agixl97.dll", "peek_dato", aValor;
|FPRC;

|PROCESO CargaLibro;
     aFichDestino = aFichOrigen - aDirOrigen - aUsuOrigen - "/CLI_CTOS/";

     aAlfa = aFichDestino;
     |HAZ Mensaje3;

     aFichDestino = "C:\DOCUMENTOS\XLSTMP\" + aFichDestino - ".xls" + "_TRA.xls";
     aFichTrabajo = aFichDestino;
     |ENVIA_FICHERO aFichOrigen, aFichTrabajo;

     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
          |MENAV "0000No se puede usar agixl97.dll";
          |ACABA;
     |FINSI;

     |ALFACALLDLL "agixl97.dll", "carga_book", aFichTrabajo;

     aHoja = nHoja;
     |QBF aHoja;
     aAlfa = "Hoja1";
     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", aAlfa;
|FPRC;

|PROCESO GrabaPtes;
     |HAZ CargaLibro;

     #dslam015#0 = aUsuOrigen;

     nCol = 67;
     nFila = 1;
     |HAZ LeeCelda;
     |QBF aValor;

     aEmpresa = aValor % 105;
     nEmpresa = aEmpresa;
     #dslam015#1 = nEmpresa;
     aNombre = aValor - aEmpresa - " - ";
     |QBF aNombre;
     #dslam015#2 = aNombre;

     nCol = 69;
     nFila = 1;
     |HAZ LeeCelda;
     |QBF aValor;
     nMes = aValor;
     #dslam015#4 = nMes;

     nCol = 69;
     nFila = 2;
     |HAZ LeeCelda;
     |QBF aValor;
     nAny = aValor;
     #dslam015#3 = nAny;

     swValido = 1;
     |SI nEmpresa = 0; |O nMes = 0; |O nAny = 0;
          swValido = 0;
     |FINSI;
     |SI swValido = 1;
          aNombreHoja = aFichOrigen - aDirOrigen - aUsuOrigen - "/CLI_CTOS/";
          |QBF aNombreHoja;
          #dslam015#5 = aNombreHoja;
          #dslam015#6 = "N";
          |GRABA 020#dslam015.n;
          |LIBERA #dslam015;
     |SINO;
          aAlfa = "    ATENCION: el siguiente libro Excel encontrado contiene errores.";
          aAlfa = aAlfa + " Por favor verifique su integridad.";
          |MENAV aAlfa;
          aAlfa = aFichDestino - "C:\DOCUMENTOS\XLSTMP";
          aAlfa = "    La copia local está en " + "C:\DOCUMENTOS\XLSTMP " + aAlfa;
          |MENAV aAlfa;
     |FINSI;

/*
     #dslam015#6 = "S";
     |LEE 101#dslam015.=;
     |SI FSalida = 0;
          aMes = nMes; aMes = "00" + aMes; aMes = aMes % -102;
          aAny = nAny;
          aAlfa = "    ATENCION: Fichero: " + aNombreHoja + ", Empresa: ";
          aAlfa = aAlfa + aEmpresa + ", Mes: " + aMes + ", A¤o: " + aAny;
          |MENAV aAlfa;
          aAlfa = "    SEl fichero ya ha sido importado. Desea volverlo a ";
          aAlfa = aAlfa + "generar?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               #dslam015#6 = "N";
               |GRABA 020#dslam015.a;
          |FINSI;
     |SINO;
          #dslam015#6 = "N";
          |GRABA 020#dslam015.n;
     |FINSI;
     |LIBERA #dslam015;
*/

     |HAZ CierraLibro;
|FPRC;

|PROCESO dsnetm02;
     aDirOrigen = #dsnetm00#7;
     |QBF aDirOrigen;
     aUsuOrigen = #dsnetm02#0;
     |QBF aUsuOrigen;

     aAlfa = aUsuOrigen;
     |HAZ Mensaje2;

     aFichOrigen = aDirOrigen + aUsuOrigen + "/" + "CLI_CTOS" + "/" + "*.xls";
     |_PDIR aFichOrigen;
     |PARA; |SI; |HACIENDO;
          |SI FSalida ! 0; |SAL; |FINSI;
          |HAZ GrabaPtes;
          ||FBORRA aFichero;
          |_SDIR aFichOrigen;
     |SIGUE;
|FPRC;

|DEFBUCLE dsnetm02;
     #dsnetm02#1;
     10;
     "          ", "S";
     "zzzzzzzzzz", "S";
     ;
     NULL, dsnetm02;
|FIN;

|PROCESO inferior;
     #dslam015#0 = "          ";
     #dslam015#1 = 1;
     #dslam015#3 = 1999;
     #dslam015#4 = 1;
     #dslam015#5 = "                              ";
     |SI aParametro = "N";
          #dslam015#6 = "N";
     |SINO;
          #dslam015#6 = "S";
     |FINSI;
|FPRC;

|PROCESO superior;
     #dslam015#0 = "zzzzzzzzzz";
     #dslam015#1 = 99999;
     #dslam015#3 = 2999;
     #dslam015#4 = 12;
     #dslam015#5 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     |SI aParametro = "N";
          #dslam015#6 = "N";
     |SINO;
          #dslam015#6 = "S";
     |FINSI;
|FPRC;

|PROCESO Limpia;
     aFichero = #dslam015#5;
     |QBF aFichero;
     aFichDestino = "C:\DOCUMENTOS\XLSTMP\" + aFichero - ".xls" + "_TRA.xls";
     |RFBORRA aFichDestino;
     aFichDestino = "C:\DOCUMENTOS\XLSTMP\" + aFichero - ".xls" + "_EDI.xls";
     |RFBORRA aFichDestino;
     |BORRA 020#dslam015.a;
|FPRC;

|DEFBUCLE Limpia;
     #dslam015#1;
     ;
     "N", "          ",     1, 1999,  1, "                              ";
     "N", "zzzzzzzzzz", 99999, 2999, 12, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, Limpia;
|FIN;

|PROCESO CargaExcel;
     /*
     aAlfa = Usuario;      |QBT aAlfa;    aAlfa = ("t" + aAlfa) % 108;
     |NOME_DAT #015 aAlfa;
     |DELINDEX #015;
     */

     |ABRE #dslam015;

     |SI aParametro = "N";
          |BUCLE Limpia;           || esta bien, limpio antes de entrar
          |BUCLE dsnetm02;
          |HAZ Mensaje4;
     |FINSI;

     |ENTLINEAL #1#dslam015, 2, 4, 22, 1, inferior, superior;

     |BUCLE Limpia;           || y al salir pa lo que se pueda quedar
                              || por ahi colgado
     |CIERRA #dslam015;
|FPRC;

*/
|| Recogida de la Web ------------------------------------------------------

|PROCESO CargaCampos;
     |SI nCampo = 1;  aCampo1  = aCampo;  |FINSI;
     |SI nCampo = 2;  aCampo2  = aCampo;  |FINSI;
     |SI nCampo = 3;  aCampo3  = aCampo;  |FINSI;
     |SI nCampo = 4;  aCampo4  = aCampo;  |FINSI;
     |SI nCampo = 5;  aCampo5  = aCampo;  |FINSI;
     |SI nCampo = 6;  aCampo6  = aCampo;  |FINSI;
     |SI nCampo = 7;  aCampo7  = aCampo;  |FINSI;
     |SI nCampo = 8;  aCampo8  = aCampo;  |FINSI;
     |SI nCampo = 9;  aCampo9  = aCampo;  |FINSI;
     |SI nCampo = 10; aCampo10 = aCampo;  |FINSI;
     |SI nCampo = 11; aCampo11 = aCampo;  |FINSI;
     |SI nCampo = 12; aCampo12 = aCampo;  |FINSI;
     |SI nCampo = 13; aCampo14 = aCampo;  |FINSI;
     |SI nCampo = 14; aCampo15 = aCampo;  |FINSI;
     |SI nCampo = 15; aCampo16 = aCampo;  |FINSI;
     |SI nCampo = 16; aCampo17 = aCampo;  |FINSI;
     |SI nCampo = 17; aCampo18 = aCampo;  |FINSI;
|FPRC;

|PROCESO CargaCamposDelta;
     |SI nCampo = 1; aCampo1 = aCampo; |FINSI;
     |SI nCampo = 2; aCampo2 = aCampo; |FINSI;
     |SI nCampo = 3; aCampo3 = aCampo; |FINSI;
     |SI nCampo = 4; aCampo4 = aCampo; |FINSI;
     |SI nCampo = 5; aCampo5 = aCampo; |FINSI;
     |SI nCampo = 6; aCampo6 = aCampo; |FINSI;
     |SI nCampo = 7; aCampo7 = aCampo; |FINSI;
     |SI nCampo = 8; aCampo8 = aCampo; |FINSI;
     |SI nCampo = 9; aCampo9 = aCampo; |FINSI;
     |SI nCampo = 10; aCampo10 = aCampo; |FINSI;
     |SI nCampo = 11; aCampo11 = aCampo; |FINSI;
     |SI nCampo = 12; aCampo12 = aCampo; |FINSI;
     |SI nCampo = 13; aCampo13 = aCampo; |FINSI;
     |SI nCampo = 14; aCampo14 = aCampo; |FINSI;
     |SI nCampo = 15; aCampo15 = aCampo; |FINSI;
     |SI nCampo = 16; aCampo16 = aCampo; |FINSI;
     |SI nCampo = 17; aCampo17 = aCampo; |FINSI;
     |SI nCampo = 18; aCampo18 = aCampo; |FINSI;
     |SI nCampo = 19; aCampo19 = aCampo; |FINSI;
     |SI nCampo = 20; aCampo20 = aCampo; |FINSI;
     |SI nCampo = 21; aCampo21 = aCampo; |FINSI;
     |SI nCampo = 22; aCampo22 = aCampo; |FINSI;
     |SI nCampo = 23; aCampo23 = aCampo; |FINSI;
     |SI nCampo = 24; aCampo24 = aCampo; |FINSI;
     |SI nCampo = 25; aCampo25 = aCampo; |FINSI;
     |SI nCampo = 26; aCampo26 = aCampo; |FINSI;
     |SI nCampo = 27; aCampo27 = aCampo; |FINSI;
|FPRC;

|PROCESO GrabaRegistrosDelta;
     |ABRE #105;
     #105#0 = "N";
     #105#1 = aCampo1;
     #105#2 = aCampo2;
     #105#3 = #103#3;
     #105#4 = #103#4;
     #105#5 = aCampo5;
     #105#6 = aCampo6;
     #105#7 = aCampo7;
     #105#8 = aCampo8;
     #105#9 = aCampo9;
     #105#10 = aCampo10;
     #105#11 = aCampo11;
     #105#12 = aCampo12;
     #105#13 = aCampo13;
     #105#14 = aCampo14;
     #105#15 = aCampo15;
     #105#16 = aCampo16;
     #105#17 = aCampo17;
     #105#18 = aCampo18;
     #105#19 = aCampo19;
     #105#20 = aCampo20;
     #105#21 = aCampo21;
     #105#22 = aCampo22;
     #105#23 = aCampo23;
     #105#24 = aCampo24;
     #105#25 = aCampo25;
     #105#26 = aCampo26;
     #105#27 = aCampo27;

     nExiste = 0;
     |SALVA_FICHA #105;
     #105#0 = "B";  |LEE 000#105=; |SI FSalida = 0;    nExiste = 1;   |FINSI;
     #105#0 = "S";  |LEE 000#105=; |SI FSalida = 0;    nExiste = 1;   |FINSI;
     |REPON_FICHA #105;

     |SI nExiste = 0;
          |GRABA 000#105n;
     |FINSI;


     nCampo   = 1;
     aCampo   = "";
     aCampo1  = "";
     aCampo2  = "";
     aCampo3  = "";
     aCampo4  = "";
     aCampo5  = "";
     aCampo6  = "";
     aCampo7  = "";
     aCampo8  = "";
     aCampo9  = "";
     aCampo10 = "";
     aCampo11 = "";
     aCampo12 = "";
     aCampo14 = "";
     aCampo15 = "";
     aCampo16 = "";
     aCampo17 = "";
     aCampo18 = "";
     aCampo19 = "";
     aCampo20 = "";
     aCampo21 = "";
     aCampo22 = "";
     aCampo23 = "";
     aCampo24 = "";
     aCampo25 = "";
     aCampo26 = "";
     aCampo27 = "";
|FPRC;

|PROCESO LeeRegistrosDelta;
     aCampo = "";
     nCampo = 1;
     |PARA; |SI FSalida ] 0; |HACIENDO;
          |XLEE nCanal2, 1, aCaracter;
          |SI FSalida [ 0; |SAL; |FINSI;

          nAscci = &aCaracter;

          |SI nCampo = 28; |Y nAscci = 10;
               |HAZ CargaCamposDelta;
               |HAZ GrabaRegistrosDelta;
          |FINSI;

          |SI aCaracter = "|";
               |HAZ CargaCamposDelta;
               nCampo = nCampo + 1;
               aCampo = "";
          |FINSI;

          |SI nAscci ! 10; |Y nAscci ! 13; |Y aCaracter ! "|";
               aCampo = aCampo + aCaracter;
          |FINSI;
     |SIGUE;
|FPRC;


|FPRC;

|PROCESO RecogeDelta;
     aAbreD = aWeb + aCampo18;
     |QBF aAbreD;
     |HORA aFichHora;    || esto porque los nombre de fichero largos me puteaban
     |QBF aFichHora;
     aFichHora = aFichHora - ":" - ":";
     aFichHora = aWeb + "cop_" + aFichHora;
     |COPIA_FICHERO aAbreD, aFichHora;
     aAbreD = aFichHora;
     |XABRE "AB", aAbreD, nCanal2;
     |SI FSalida ] 0;
          |HAZ LeeRegistrosDelta;
     |FINSI;
     |XCIERRA nCanal2;
     |FBORRA aAbreD;
|FPRC;

|PROCESO GrabaRegistros;
     #103#0  = "N";
     #103#1  = aCampo1;
     #103#2  = aCampo2;
     #103#3  = aCampo3;
     #103#4  = aCampo4;
     #103#5  = aCampo5;
     #103#6  = aCampo6;
     #103#7  = aCampo7;
     #103#8  = aCampo8;
     #103#9  = aCampo9;
     #103#10 = aCampo10;
     #103#11 = aCampo11;
     #103#12 = aCampo12;
     #103#14 = aCampo14;
     #103#15 = aCampo15;
     #103#16 = aCampo16;
     #103#17 = aCampo17;
     #103#21 = aCampo18;

     |SI #103#12 = 1;  #103#13 = "ENFERMEDAD          ";  |FINSI;
     |SI #103#12 = 2;  #103#13 = "MATERNIDAD          ";  |FINSI;
     |SI #103#12 = 3;  #103#13 = "ACCIDENTE           ";  |FINSI;
     |SI #103#12 = 4;  #103#13 = "ABSENTISMO          ";  |FINSI;
     |SI #103#12 = 5;  #103#13 = "VACACIONES          ";  |FINSI;
     |SI #103#12 = 6;  #103#13 = "HUELGA              ";  |FINSI;
     |SI #103#12 = 7;  #103#13 = "CONCEPTOS SALARIALES";  |FINSI;
     |SI #103#12 = "3";
          |HAZ RecogeDelta;
     |FINSI;
     #7#1 = "LABORAL";
     #7#2 = #103#5;
     |LEE 040#7=;
     |SI FSalida ! 0;  |DDEFECTO #7;  |FINSI;

     #103#18 = #7#3;

     #900#0 = #103#5;
     #900#1 = #103#6;
     |LEE 040#900=;
     |SI FSalida ! 0;  |DDEFECTO #900;  |FINSI;

     #103#19 = #900#2;

     #8#0 = #103#14;
     |LEE 040#8=;
     |SI FSalida ! 0;  |DDEFECTO #8;  |FINSI;

     #103#20 = #8#1;


     nExiste = 0;
     |SALVA_FICHA #103;
     #103#0 = "B";  |LEE 000#103=; |SI FSalida = 0;    nExiste = 1;   |FINSI;
     #103#0 = "S";  |LEE 000#103=; |SI FSalida = 0;    nExiste = 1;   |FINSI;
     |REPON_FICHA #103;

     |SI nExiste = 0;
          |GRABA 000#103n;
          |SI FSalida = 0; nRegis = nRegis + 1; |FINSI;
     |FINSI;

     nCampo   = 1;
     aCampo   = "";
     aCampo1  = "";
     aCampo2  = "";
     aCampo3  = "";
     aCampo4  = "";
     aCampo5  = "";
     aCampo6  = "";
     aCampo7  = "";
     aCampo8  = "";
     aCampo9  = "";
     aCampo10 = "";
     aCampo11 = "";
     aCampo12 = "";
     aCampo14 = "";
     aCampo15 = "";
     aCampo16 = "";
     aCampo17 = "";
     aCampo18 = "";
|FPRC;

|PROCESO LeeRegistros;
     aCampo        = "";
     nCampo        = 1;
     nRegis        = 0;

     |PARA;  |SI  FSalida ] 0;  |HACIENDO;
          |XLEE nHandle, 1, aCaracter;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          nAscci = &aCaracter;

          |SI nCampo = 18;  |Y nAscci = 10;
               |HAZ CargaCampos;

               ||nRegis = nRegis + 1;
               |HAZ GrabaRegistros;
          |FINSI;

          |SI aCaracter = "|";
               |HAZ CargaCampos;

               nCampo = nCampo + 1;
               aCampo = "";
          |FINSI;

          |SI nAscci ! 10;  |Y nAscci ! 13;  |Y aCaracter ! "|";
               aCampo = aCampo + aCaracter;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO RecogerDatos;
     |ABRE #0;
     |LEE 040#0p;
     |SI FSalida ! 0;  |CIERRA #0;  |ACABA;  |FINSI;
     |CIERRA #0;

     aWeb = #0#7;  |QBF aWeb;
     |SI aWeb = "";  |ACABA;  |FINSI;

     aAbreSmf = aWeb + "variaciones.smf";
     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreSmf, nHandle;
          |SI FSalida < 0;  |SAL;  |FINSI;
          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     |XABRE "W", aAbreSmf, nHandle;
     |SI FSalida ] 0;
         aAlfa = "Grabando";
         |XGRABA nHandle, aAlfa;
     |FINSI;
     |XCIERRA nHandle;

     |ABRE #103;
     |ABRE #7;
     |ABRE #8;
     |ABRE #900;
     |SELECT #2#7;

     aCopialo1 = aWeb + "variaciones.txt";
     aCopialo2 = aWeb + "variacionestra.txt";
     |COPIA_FICHERO aCopialo1, aCopialo2;

     aAbre = aWeb + "variacionestra.txt";
     |XABRE "AB", aAbre, nHandle;
     |SI FSalida ] 0;
         |HAZ LeeRegistros;
     |FINSI;
     |XCIERRA nHandle;

     |CIERRA #7;
     |CIERRA #8;
     |CIERRA #103;
     |CIERRA #900;

     ||FBORRA aCopialo1;
     |FBORRA aCopialo2;
     |FBORRA aAbreSmf;
|FPRC;

|| Actualizar Datos ------------------------------------------------------

|PROCESO Divide;
     aAlfa1 = "";
     aAlfa2 = "";

     |QBF aAlfa;
     |SI aAlfa = "";     |ACABA;   |FINSI;
     aLongitud = aAlfa % 0;
     nLongitud = aLongitud;
     |SI nLongitud [ nTam;
          aAlfa1 = aAlfa;
     |SINO;
          |PARA nNume = nTam; |SI nNume ] 0; |HACIENDO nNume = nNume - 1;
               nCaracter = (nNume * 100) + 1;
               aCaracter = aAlfa % nCaracter;
               |SI aCaracter = " "; |O aCaracter = ","; |O aCaracter = ";";
               |O aCaracter = ":";  |O aCaracter = ")";
                    |SAL;
               |FINSI;
          |SIGUE;
          nCaracter = 100 + nNume;
          aAlfa1 = aAlfa % nCaracter;
          aAlfa2 = aAlfa - aAlfa1;
          |QBF aAlfa1;
          |QBF aAlfa2;
     |FINSI;
|FPRC;

|PROCESO GrabaManteParte;
     |SI swParteOK ! 1;
          |ACABA;
     |FINSI;

     |ABRE #105;
     #105#0 = "N";
     #105#1 = #103#1;
     #105#2 = #103#2;
     #105#3 = #103#3;
     #105#4 = #103#4;
     |LEE 101#105=;
     |SI FSalida = 0;
          #904#1 = #105#5;    || EMPRESA
          #904#2 = #105#6;    || TRABAJADOR
          #904#3 = #105#12;  || FECHA BAJA MEDICA
          |LEE 000#904=;
          |SI FSalida = 0;
               aAlfa = "    No es posible actualizar el parte. ";
               |SI #904#8 = "S";
                    aAlfa = aAlfa + "Ya existe un parte emitido con esta fecha ";
               |SINO;
                    aAlfa = aAlfa + "Ya existe un parte pendiente con esta fecha ";
               |FINSI;
               aAlfa = aAlfa + "para este trabajador";
               |MENAV aAlfa;
               |BORRA 020#903a;    || BORRO LO QUE ANTES GRABE EN EL labparhi
          |SINO;
               |SELECT #3#904;
               |LEE 000#904p;
               |SI FSalida ! 0;
                    #904#0 = 1;
               |SINO;
                    |LEE 000#904u;
                    #904#0 = #904#0 + 1;
               |FINSI;
               |SELECT #1#904;
               #904#1 = #105#5;    || EMPRESA
               #904#2 = #105#6;    || TRABAJADOR
               #904#3 = #105#12;   || FECHA BAJA MEDICA
               #904#4 = "PAT";     || TIPO DE PARTE
               #904#5 = "";        || FECHA EMISION
               #904#6 = "-";       || PARTE NO EMITIDO
               #904#7 = "";        || FECHA CREACION
               #904#8 = " ";       || PARTE NO EMITIDO
               #904#9 = "";        || NOMBRE FICHERO
               |GRABA 020#904n;
          |FINSI;
     |FINSI;
     |CIERRA #105;
|FPRC;

|PROCESO GrabaDatosParte;
     swParteOK = 0;

     |ABRE #105;
     #105#0 = "N";
     #105#1 = #103#1;
     #105#2 = #103#2;
     #105#3 = #103#3;
     #105#4 = #103#4;
     |LEE 101#105=;
     |SI FSalida = 0;
          #903#1 = #105#5;    || EMPRESA
          #903#2 = #105#6;    || TRABAJADOR
          #903#15 = #105#12;  || FECHA BAJA MEDICA
          |LEE 101#903=;
          |SI FSalida = 0;
               aAlfa = "    No es posible actualizar el parte. ";
               aAlfa = aAlfa + "Ya existe un parte para este trabajador con ";
               aAlfa = aAlfa + "esta fecha de baja."
               |MENAV aAlfa;
          |SINO;
               #903#4 = #105#9;    || lugar accidente
               aAlfa = #105#10;    || direccion del accidente
               nTam = 26
               |HAZ Divide;
               #903#54 = aAlfa1;
               #903#55 = aAlfa2;
               #903#3 = #105#11;        || fecha Accidente
               #903#15 = #105#12;       || fecha Baja
               #903#8 = #105#13;        || hora dia
               #903#16 = #105#14;       || hora trabajo
               #903#13 = #105#15;       || trabajo habitual S/N
               aAlfa = #105#16;         || descripcion Accidente
               nTam = 63;
               |HAZ Divide;
               #903#17 = aAlfa1;
               aAlfa = aAlfa2;
               nTam = 76;
               |HAZ Divide;
               #903#18 = aAlfa1;
               #903#19 = aAlfa2;
               #903#74 = #105#17;       || Codigo Lugar
               #903#76 = #105#18;       || Codigo Proceso
               #903#86 = #105#19;       || Codigo Causa
               #903#88 = #105#20;       || Codigo Maquina
               |SI #105#21 > 1;
                    #903#90 = "S";
               |SINO;
                    #903#90 = "N";
               |FINSI;
               #903#101 = #105#22;
               #903#27 = #105#23;       || Codigo descripcion lesion
               #903#28 = #105#24;       || Codigo parte del cuerpo lesionada
               aAlfa = #105#25;         || grado de la lesion
               |QBF aAlfa;
               |SI aAlfa = "Leve";           #903#32 = 1;  |FINSI;
               |SI aAlfa = "Grave";          #903#32 = 2;  |FINSI;
               |SI aAlfa = "Muy Grave";      #903#32 = 3;  |FINSI;
               |SI aAlfa = "Fallecimiento";  #903#32 = 4;  |FINSI;
               #903#35 = #105#26;       || hospitalizado S/N
               #903#34 = #105#27;       || Centro Hospitalario
               |GRABA 020#903n;
               |SI FSalida = 0;
                    || El parte se ha grabado correctamente
                    swParteOK = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #105;
|FPRC;

|PROCESO TipoCabecera;
     |SI #901#12 ! " ";  |Y #901#13 ! " ";  |Y #901#14 ! " "; |Y #901#15 ! " ";
         |MENAV "0000 No puedo Actualizar el Registro hay ya cuatro variaciones.";
         nError = 1;
         |ACABA;
     |FINSI;

     #901#0 = #103#5;
     #901#1 = #103#6;
     #901#2 = #103#8;
     #901#3 = 0;
     |LEE 101#901=;
     |SI FSalida ! 0;
         |DDEFECTO #901;
         #901#0 = #103#5;
         #901#1 = #103#6;
         #901#2 = #103#8;
         #901#3 = 0;
         |GRABA 020#901b;
     |FINSI;

     |SI #901#15 = " ";  nCampo1 = 7;  nCampo2 = 11;  nCampo3 = 15;  |FINSI;
     |SI #901#14 = " ";  nCampo1 = 6;  nCampo2 = 10;  nCampo3 = 14;  |FINSI;
     |SI #901#13 = " ";  nCampo1 = 5;  nCampo2 = 9;   nCampo3 = 13;  |FINSI;
     |SI #901#12 = " ";  nCampo1 = 4;  nCampo2 = 8;   nCampo3 = 12;  |FINSI;

     #901nCampo1 = #103#10;
     #901nCampo2 = #103#11;

     |SI #103#12 = 1; #901nCampo3 = "E";  |FINSI;
     |SI #103#12 = 2; #901nCampo3 = "M";  |FINSI;
     |SI #103#12 = 3;
          #901nCampo3 = "A";
          |HAZ GrabaDatosParte;
          |HAZ GrabaManteParte;
     |FINSI;
     |SI #103#12 = 4; #901nCampo3 = "F";  |FINSI;
     |SI #103#12 = 5; #901nCampo3 = "V";  |FINSI;
     |SI #103#12 = 6; #901nCampo3 = "H";  |FINSI;

     |GRABA 020#901a;
     |LIBERA #901;

     #902#0  = #901#0;
     #902#1  = #901#1;
     #902#2  = #901#2;
     #902#3  = #901#3;
     #902#4  = 0;
     |LEE 040#902];
     |SI FSalida ! 0;  |O #902#0  ! #901#0;  |O #902#1  ! #901#1;
                       |O #902#2  ! #901#2;  |O #902#3  ! #901#3;
         |DDEFECTO #902;
         #902#0  = #901#0;
         #902#1  = #901#1;
         #902#2  = #901#2;
         #902#3  = #901#3;
         #902#4  = 999;
         #902#6  = "<INDEFINIDO>";
         |GRABA 020#902n;
         |LIBERA #902;
     |FINSI;
|FPRC;

|PROCESO TipoLinea;
     |ABRE #8;
     #8#0  = #103#14;
     |LEE 040#8=;
     |SI FSalida ! 0;  |DDEFECTO #8;  |FINSI;
     |CIERRA #8;

     |ABRE #10;
     #10#0  = #103#14;
     #10#1  = #103#5;
     #10#2  = #900#87;
     |LEE 040#10=;
     |SI FSalida ! 0;
         |CIERRA #10;
         |MENAV "0000 No puedo Actualizar el Registro NO existe la Empresa-Convenio-Concepto.";
         nError = 1;
         |ACABA;
     |FINSI;
     |CIERRA #10;

     #901#0 = #103#5;
     #901#1 = #103#6;
     #901#2 = #103#8;
     #901#3 = 0;
     |LEE 101#901=;
     |SI FSalida ! 0;
         |DDEFECTO #901;
         #901#0 = #103#5;
         #901#1 = #103#6;
         #901#2 = #103#8;
         #901#3 = 0;
         |GRABA 020#901b;
     |FINSI;
     |GRABA 020#901a;
     |LIBERA #901;

     #902#0  = #901#0;
     #902#1  = #901#1;
     #902#2  = #901#2;
     #902#3  = #901#3;
     #902#4  = #10#3;
     |LEE 101#902=;
     |SI FSalida ! 0;
         |DDEFECTO #902;
         #902#0  = #901#0;
         #902#1  = #901#1;
         #902#2  = #901#2;
         #902#3  = #901#3;
         #902#4  = #10#3;
         |GRABA 020#902b;
     |FINSI;

     |SI #8#2 = "D";
         #902#5 = #103#16;
         #902#6 = "";
     |FINSI;

     |SI #8#2 = "H";
         #902#5 = #103#15;
         #902#6 = ;
     |FINSI;

     |SI #8#2 = "I";
         #902#5 = 1;
         #902#6 = #103#17;
     |FINSI;

     |GRABA 020#902a;
     |LIBERA #902;
|FPRC;

|PROCESO GrabaDatos;
     |ABRE #900;
     #900#0 = #103#5;
     #900#1 = #103#6;
     |LEE 040#900=;
     |SI FSalida ! 0;
          |CIERRA #900;
          |MENAV "0000 No puedo Actualizar el Registro NO existe el Trabajador.";
          |ACABA;
     |FINSI;
     |CIERRA #900;

     |SI #900#44 = "B";
         |MENAV "0000 No puedo Actualizar el Registro el Trabajador esta de baja.";
         |ACABA;
     |FINSI;

     nError = 0;
     |SI #103#12 ! 7;  |HAZ TipoCabecera;  |FINSI;
     |SI #103#12 = 7;  |HAZ TipoLinea;     |FINSI;

     |SI nError = 1;  |ACABA;  |FINSI;

     |BORRA 020#103a;
     |LIBERA #103;

     #103#0 = "S";
     |GRABA 020#103n;
     |LIBERA #103;

     |BORRA 020#105a;
     |LIBERA #105;

     #105#0 = "S";
     |GRABA 020#105n;
     |LIBERA #105;

     |PONCONTROL 23, "SI";
     |PTEC 808;
|FPRC;

|PROCESO Actualiza;
     |CONFI "0000SSeguro de Actualizar el Registro";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |LEE 101#103=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #0#1 = "S";
         aMas  = aBase + "laboral/def/nomvarca.mas";
         aFich = aBase + "laboral/fich/";
     |SINO;
         aMas  = aBase + "aginom/def/nomvarca.mas";
         aFich = aBase + "aginom/fich/";
     |FINSI;

     |CARGA_DEF aMas, nomvarca@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI #0#1 = "S";
         aMas  = aBase + "laboral/def/nomvarli.mas";
     |SINO;
         aMas  = aBase + "aginom/def/nomvarli.mas";
     |FINSI;

     |CARGA_DEF aMas, nomvarli@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;

         |DESCARGA_DEF #nomvarca@;
         |ACABA;
     |FINSI;

     |SI #0#1 = "S";
         aMas  = aBase + "laboral/def/labparhi.mas";
         aFich = aBase + "laboral/fich/";
     |SINO;
         aMas  = aBase + "agilab/def/labparhi.mas";
         aFich = aBase + "agilab/fich/";
     |FINSI;

     |CARGA_DEF aMas, labparhi@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI #0#1 = "S";
         aMas  = aBase + "laboral/def/labparma.mas";
         aFich = aBase + "laboral/fich/";
     |SINO;
         aMas  = aBase + "agilab/def/labparma.mas";
         aFich = aBase + "agilab/fich/";
     |FINSI;

     |CARGA_DEF aMas, labparma@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |PATH_DAT #901 aFich;
     |PATH_DAT #902 aFich;
     |PATH_DAT #903 aFich;
     |PATH_DAT #904 aFich;

     |ABRE #901;
     |ABRE #902;
     |ABRE #903;
     |ABRE #904;

     |HAZ GrabaDatos;

     |CIERRA #904;
     |CIERRA #903;
     |CIERRA #902;
     |CIERRA #901;

     |DESCARGA_DEF #labparma@;
     |DESCARGA_DEF #labparhi@;
     |DESCARGA_DEF #nomvarli@;
     |DESCARGA_DEF #nomvarca@;
|FPRC;

|| Impresion de datos-------------------------------------------------------------------------

|PROCESO ImpWebVa;
     |SI #103#0 = aParametro;
          |SI aParametro =  "N";
               aTituloV = "       Informe web de variaciones       ";
          |SINO;
               aTituloV = "Informe del hist¢rico web de variaciones";
          |FINSI;
          |PRINT;
     |FINSI;

|FPRC;

|DEFBUCLE dslam103;
     #103#1;
     ;
     "0",#99#0,"000000000",#99#2,"00000000";
     "z",#99#1,"zzzzzzzzz",#99#3,"zzzzzzzz";
     ;
    NULL, ImpWebVa;
|FIN;

|PROCESO ImpreWebV;
     |AVISO;
     |CONFI "0000N Desea imprimir informe?";
     |SI FSalida = 0;
     |PUSHV 0501 2380;
     |CLS;
     |CABEZA "Recogida de la Web";
     |PINPA #0#99;
     |PINDA #0#99;
     |ABRE #99;
     |ENDATOS #1#99;
     |SI FSalida = 0;
          |IMPRE 0;
          |SI FSalida = 0;
               |INFOR "dslam103";
               |SI FSalida = 0;
                    |BUCLE dslam103;
                    sw = 1;
                    |PTEC 807;
                    |PIEINF;
                    |FININF;
               |SINO;
                    |MENAV "0000 El informe no esta disponible";
               |FINSI;
          |SINO;
               |MENAV "0000 La impresora no esta accesible.";
          |FINSI;
          |FINIMP;
          |CIERRA #99;
     |FINSI;
|FINSI;
|POPV;

|FPRC;


|| Datos Pantalla --------------------------------------------------------

|PROCESO Mensa;  |TIPO 7;
     |SI #103#0 = "N";
         |MENSA "0000 <F2> Ver Datos. <F3> Actualizar Variacion. <F4> Borrar Registro. <F5> Imprimir";
     |SINO;
         |MENSA "0000 <F2> Pantalla todos los Datos. <F5> Imprimir";
     |FINSI;
|FPRC;

|PROCESO Tipo11;  |TIPO 11;
     |SI FSalida = 10;
         |PARA nCampo = 0;  |SI nCampo [ 20;  |HACIENDO nCampo = nCampo + 1;
               #203nCampo = #103nCampo;
         |SIGUE;

         |SI #103#12 = "3";
              |ABRE #105;
              #105#0 = "N";
              #105#1 = #103#1;
              #105#2 = #103#2;
              #105#3 = #103#3;
              #105#4 = #103#4;
              |LEE 000#105=;
              |SI FSalida ! 0; |DDEFECTO #105; |FINSI;
              |PARA nCampo = 0;  |SI nCampo [ 27;  |HACIENDO nCampo = nCampo + 1;
                    #205nCampo = #105nCampo;
                    |SI nCampo = 16;
                         aAlfa = #105#16 % 175;
                         #205nCampo = aAlfa;
                         aAlfa = #105#16 - aAlfa;
                         #205#30 = aAlfa;
                    |FINSI;
              |SIGUE;
              #205#28 = #103#19;
              #205#29 = #103#18;
         |FINSI;

         |PUSHV 0501 2380;
         |PINPA #0#203;
         |PINDA #0#203;
         |LEETECLA aTecla;
         |SI #103#12 = "3";
              |PINPA #0#205;
              |PINDA #0#205;
              |ATRI R;
              |SI #105#9 = "1";
                    |PINTA 1025, "Centro de trabajo habitual"
              |FINSI;
              |SI #105#9 = "2";
                    |PINTA 1025, "Otro centro o lugar de trabajo"
              |FINSI;
              |SI #105#9 = "3";
                    |PINTA 1025, "Despl. en su jornada laboral"
              |FINSI;
              |SI #105#9 = "4";
                    |PINTA 1025, "Al ir o volver del trabajo, in itinere"
              |FINSI;
              |SI #105#9 = "5";
                    |PINTA 1025, "Accidente de trafico"
              |FINSI;
              |ATRI 0;
              |LEETECLA aTecla;
              |CIERRA #105;
         |FINSI;
         |POPV;
         |ERROR;
     |FINSI;

     |SI FSalida = 11;  |Y #103#0 = "N";
         |HAZ Actualiza;
     |FINSI;

     |SI FSalida = 12;  |Y #103#0 = "N";
         |CONFI "0000NSeguro de Borrar el Registro ";
         |SI FSalida ! 0;
             |ERROR;
             |ACABA;
         |FINSI;

         |LEE 101#103=;
         |BORRA 020#103a;
         |LIBERA #103;

          #103#0 = "B";
          |GRABA 020#103n;

         |PONCONTROL 23, "SI";
         |PTEC 808;
     |FINSI;
     |SI FSalida = 13;
          aUsuPos = #103#1;
          aPerPos = #103#2;
          fFecPos = #103#3;
          aHoraPos = #103#4;
          |HAZ ImpreWebV;
     |FINSI;
|FPRC;


|| Comienzo Programa -----------------------------------------------------


|RUTINA ClaveBaja103;
     ||Con esto se queda fea, pq. se posiciona, pero pone el registro como el
     ||primero.
/*
     |SI FSalida="POSICION";
          #103#0 = aParametro;
          #103#1 = aUsuPos;
          #103#2 = aPerPos;
          #103#3 = fFecPos;
          #103#4 = aHoraPos;
     |SINO;
*/
          #103#0 = aParametro;
          #103#1 = "";
          #103#2 = "";
          #103#3 = "01.01.0000";
          #103#4 = "";
/*
     |FINSI;
*/
|FRUT;

|RUTINA ClaveAlta103;
     #103#0 = aParametro;
     #103#1 = "zzzzzzzzzz";
     #103#2 = "zzzzzzzzzz";
     #103#3 = "31.12.9999";
     #103#4 = "zzzzzzzz";
|FRUT;

|PROGRAMA;
     |ABRE #0;
     |LEE 040#0p;
     |SI FSalida ! 0;  |DDEFECTO #0;  |FINSI;
     |CIERRA #0;

     |DBASS aBase;  |QBF aBase;

     |SI #0#1 = "S";
         aMas  = aBase + "laboral/def/labtraba.mas";
         aFich = aBase + "laboral/fich/";
     |SINO;
         aMas  = aBase + "aginom/def/labtraba.mas";
         aFich = aBase + "aginom/fich/";
     |FINSI;

     |CARGA_DEF aMas, labtraba@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |PATH_DAT #900 aFich;

     |CLS;
     |CABEZA "Variaciones";

     |PINPA #0#103;
     |MENSA "0000 Recogiendo Datos de la Web.";

     aParametro = PARAMETRO;  |QBF aParametro;

     |SI aParametro = "N";
         |HAZ RecogerDatos;

         aAlfa = "0000 Registros Recogidos " + nRegis;
         |MENAV aAlfa;

         |MENSA "0000                            ";
     |FINSI;

     sw = 1;
     |PARA; |SI sw ! 0; |HACIENDO;
          sw = 0;
          |ENTLINEAL #1#103, -2, 4, 22, 1, ClaveBaja103, ClaveAlta103;
     |SIGUE;

     aAlfa = "    SDesea buscar ahora las variaciones generadas desde ";
     aAlfa = aAlfa + "Libros Excel?";
     |CONFI aAlfa;
     |SI FSalida = 0;
          |HAZ Mensaje1;
          |HAZ CargaExcel;
          |BUCLE BorraRestos;
     |FINSI;

     |DESCARGA_DEF #labtraba@;
|FPRO;

|PROCESO Mensaje1;
     |CLS;
     |CUADRO 11241665;
     |ATRI R;
     ||       2    3         4         5         6
     ||       5678901234567890123456789012345678901234
     aAlfa = "   Proceso de busqueda de libros Excel  ";
     |PINTA 1225, aAlfa;
     |ATRI 0;
|FPRC;

|PROCESO Mensaje2;
     ||       2    3         4         5         6
     ||       5678901234567890123456789012345678901234
     |QBF aAlfa;
     aAlfa = aAlfa + "          ";
     aAlfa = aAlfa % 110;
     aAlfa = "      Buscando usuario: " + aAlfa + "      ";
     |PINTA 1325, aAlfa;
     aAlfa = "                                        ";
     |PINTA 1425, aAlfa;
     |PINTA 1525, aAlfa;
|FPRC;

|PROCESO Mensaje3;
     ||       2    3         4         5         6
     ||       5678901234567890123456789012345678901234
     |QBF aAlfa;
     aAlfa1 = "            Encontrado libro:           ";
     |PINTA 1425, aAlfa1;
     aAlfa = "      " + aAlfa + "      ";
     |PINTA 1525, aAlfa;
|FPRC;

|PROCESO Mensaje4;
     ||       2    3         4         5         6
     ||       5678901234567890123456789012345678901234
     aAlfa = "                                        ";
     |PINTA 1325, aAlfa;
     aAlfa = "         - FINALIZADO PROCESO -         ";
     |PINTA 1425, aAlfa;
     aAlfa = "                                        ";
     |PINTA 1525, aAlfa;
     |AVISO;
     |PAUSA;
|FPRC;
