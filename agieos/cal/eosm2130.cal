|FICHEROS;
    eosm2130 #0;
    eosclien #1;
    eosactiv #2;
    eosaplic #3;
    eosexist #4;
    eosm1300 #5;
    eosm3130 #6;
    eoscomul #15;
    eosw0016 #16;
    eosm1303 #25;
    dsmociva;

    espejo6@ #106;
    dsmod130@  #1130;
|FIN;

|VARIABLES;
    nAcabar   = 0;
    nSwPan    = 0;
    nPara1    = 0;
    nPara2    = 0;
    nNume1    = 0;
    fFecha1   = @;
    aAlfa1    = "";
    act_nor   = 0;
    x         = 0;
    cont      = 0;
    campo     = 0;
    empresa   = 0;
    activid   = 0;
    periodo   = 0;
    ejercic   = 0;
    v_anter   = 0;
    f_anter   = 0;
    c_anter   = 0;
    i_anter   = 0;
    d_anter   = 0;
    ad_anter  = "";
    r_anter   = 0;
    p_anter   = 0;
    coefi_g   = 0;
    ventas    = 0;
    activi_g  = 0;
    pagos_g   = 0;
    FEstado   = 0;
    sw_130    = 0;
    sw_esta   = 0;
    cuota     = 0;
    nSwPasada = 0;
    nSw       = 0;

    nTope        = 0;
    nTopeAgrario = 0;
    nEjer        = 0;
    nPeriodo     = 0;

    &emp_exis = 0;
    &act_exis = 0;
    &any_exis = 0;

    nEmpAnt = 0;
    nActAnt = 0;
    nSwHay  = 0;

    nImporte = 0;
    nSwNeg   = 0;
    nSumaD   = 0;
    aBase    = "";
    aMas     = "";
    nHPer    = 0;
    nSuma    = 0;

    enNume   = 0;
    nEl27    = 0;
    nEmpresa   = 0;
    nActividad = 0;
    nInkey     = 0;
    &enModelo  = 0;

     nTotalG17 = 0;
     nTotalG21 = 0;
     nOpe      = 0;
     nTp       = 0;
     nClave0   = 0;
     nClave1   = 0;
     nClave2   = 0;
     nClave3   = 0;
     aPathModelo = "";
     aDef        = "";
     aAlfa       = "";
     nEsComun    = 0;
|FIN;

|INCLUYE i_vareos;
|INCLUYE i_seguim;
|INCLUYE i_ficher;
|INCLUYE i_period;

|PROCESO Tipo14;  |TIPO 14;
  |ABRE #1;
  #1#0 = #0#0;
  |LEE 040#1=;
  |SI FSalida ! 0; |DDEFECTO #1; |FINSI;
  |CIERRA #1;

  |ABRE #2;
  #2#0 = #0#0;
  #2#1 = #0#1;
  #2#2 = #0#3;
  |LEE 040#2=;
  |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
  |CIERRA #2;

  |ATRI I;
  |PINTA 0803, #1#2;
  |PINTA 0903, #2#6;
  |PINTA 0944, #2#4;
  |PINTA 0946, #2#5;
  |PINTA 0861, #2#48;
  |PINTA 0961, #2#49;
                  |PINTA 1003, "                                        ";
                  |PINTA 1044, "                              ";
  |SI #2#29 = 1;  |PINTA 1003, "ORDINARIO                               ";  |FINSI;
  |SI #2#29 = 2;  |PINTA 1003, "ESPECIAL DE BIENES USADOS               ";  |FINSI;
  |SI #2#29 = 3;  |PINTA 1003, "OBJ. ARTE, ANTIGUEDADES Y OBJ.COLECCION ";  |FINSI;
  |SI #2#29 = 4;  |PINTA 1003, "AGENCIAS DE VIAJES                      ";  |FINSI;
  |SI #2#29 = 5;  |PINTA 1003, "DETERMINACION PROPORCIONAL              ";  |FINSI;
  |SI #2#29 = 6;  |PINTA 1003, "MODULOS IVA                             ";  |FINSI;
  |SI #2#29 = 7;  |PINTA 1003, "SIMPLIFICADO                            ";  |FINSI;
  |SI #2#29 = 8;  |PINTA 1003, "RECARGO EQUIVALENCIA                    ";  |FINSI;
  |SI #2#29 = 9;  |PINTA 1003, "RECARGO EQUIVALENCIA AGRICULTURA        ";  |FINSI;
  |SI #2#29 = 0;  |PINTA 1003, "EXENTAS                                 ";  |FINSI;
  |SI #2#22 = "A"; |PINTA 1044, "MODULOS                       ";  |FINSI;

  |SI #0#3 ] 0;  |Y #0#3 [ 80;
      |SI #2#22 = "B"; |PINTA 1044, "DIRECTA SIMPLIFICADA          ";  |FINSI;
      |SI #2#22 = "C"; |PINTA 1044, "DIRECTA NORMAL                ";  |FINSI;
  |SINO;
      |SI #0#3 [ 97;
          |SI #2#22 = "B"; |PINTA 1044, "COEFICIENTES                  ";  |FINSI;
          |SI #2#22 = "C"; |PINTA 1044, "DIRECTA                       ";  |FINSI;
      |SINO;
          |SI #2#22 = "B"; |PINTA 1044, "DIRECTA SIMPLIFICADA          ";  |FINSI;
          |SI #2#22 = "C"; |PINTA 1044, "DIRECTA NORMAL                ";  |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO control; |TIPO 8;
   |HAZ Periodo;
   |ABRE #3;
   |LEE 040#3p;
   |SI FSalida ! 0;
       |MENAV "     No existe control de 130.";
       |PTEC 807;
   |FINSI;
   |CIERRA #3;

   enModelo = 130;
   aAlfa1   = "eosy0092;MASIVO";
   |SUB_EJECUTA aAlfa1;
|FPRC;

|PROCESO DfectoPeriodo; |TIPO 7;
   #0#2 = Periodo;
   |PINTA #0#2;
|FPRC;

|PROCESO i_archiv; |TIPO 7;
   |SI #0#5 = "S";
       |MENAV "     Registro archivado, DESARCHIVELO";
       |PTEC 807;
   |FINSI;
|FPRC;

|PROCESO esta_super; |TIPO 2;

sw_esta   = 0;
empresa   = #0#0;
activid   = #0#1;
periodo   = #0#2;
ejercic   = #0#3;

|SI #0#2 = 4; |ACABA; |FINSI;

|GRABA 140#0a;
|LIBERA #0;

sw_esta   = 0;
empresa   = #0#0;
activid   = #0#1;
periodo   = #0#2;
ejercic   = #0#3;

#0#2 = #0#2 + 1;
|LEE 040#0=;
|SI FSalida = 0; sw_esta = 1; |FINSI;

#0#0 = empresa;
#0#1 = activid;
#0#2 = periodo;
#0#3 = ejercic;
|LIBERA #0;
|LEE 140#0=;
|SI FSalida ! 0;
    |DDEFECTO #0;
    #0#0 = empresa;
    #0#1 = activid;
    #0#2 = periodo;
    #0#3 = ejercic;
|FINSI;

|SI sw_esta = 1;
    |MENAV "    Ya existe registro con un PERIODO superior";
    |ERROR;
|FINSI;
|FPRC;

|PROCESO existenc; |TIPO 0;
|SI FSalida ! 9; |ACABA; |FINSI;

emp_exis = #0#0;
act_exis = #0#1;
any_exis = #0#3;
|SUB_EJECUTA "eosexis1.run";
|HAZ lee_exist;
|FPRC;

|PROCESO antes; |TIPO 7;
campo = Campo;
|FPRC;

|PROCESO activida; |TIPO 0;
|SI campo ! 3; |ACABA; |FINSI;

|ABRE #2;
#2#0 = #0#0;
#2#1 = #0#1;
#2#2 = #0#3;
|LEE 040#2=;
|SI FSalida = 0;
  |SI #2#22 = "A";
     |MENAV "     La Actividad esta sujeta a Modulos";
     |ERROR;
     |ACABA;
  |FINSI;

  |SI #2#14 = "S";
     |MENAV "     La Actividad es un Comunero";
     |ERROR;
  |FINSI;
|FINSI;
|CIERRA #2;
|FPRC;

|PROCESO nomodi; |TIPO 7;

    |ABRE #2;
    #2#0 = #0#0;
    #2#1 = #0#1;
    #2#2 = #0#3;
    |LEE 040#2=;
    |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
    |CIERRA #2;

   |CAMPO_MODIFICA #0#06, 1, "S";
   |CAMPO_MODIFICA #0#09, 1, "S";
   |CAMPO_MODIFICA #0#11, 1, "S";
   |CAMPO_MODIFICA #0#12, 1, "S";
   |CAMPO_MODIFICA #0#15, 1, "S";
   |CAMPO_MODIFICA #0#17, 1, "S";
   |CAMPO_MODIFICA #0#20, 1, "S";
   |CAMPO_MODIFICA #0#23, 1, "S";
   |CAMPO_MODIFICA #0#30, 1, "S";
   |CAMPO_MODIFICA #0#32, 1, "S";
   |CAMPO_MODIFICA #0#38, 1, "S";
   |CAMPO_MODIFICA #0#39, 1, "S";

   |SI #2#41 = "S";
       |CAMPO_MODIFICA #0#06, 1, "N";
       |CAMPO_MODIFICA #0#09, 1, "N";
       |CAMPO_MODIFICA #0#11, 1, "N";
       |CAMPO_MODIFICA #0#12, 1, "N";
       |CAMPO_MODIFICA #0#15, 1, "N";
       |CAMPO_MODIFICA #0#17, 1, "N";
       |CAMPO_MODIFICA #0#23, 1, "N";
       |CAMPO_MODIFICA #0#38, 1, "N";
       |CAMPO_MODIFICA #0#39, 1, "N";
       |PARA x = 6; |SI x [ 28; |HACIENDO x = x + 1;
             #0x = 0;
       |SIGUE;
       #0#38 = "N";
       #0#39 = 0;
       |PINDA #0#0;
   |SINO;
       |CAMPO_MODIFICA #0#30, 1, "N";
       |CAMPO_MODIFICA #0#32, 1, "N";
       #0#30 = 0;
       #0#31 = 0;
       #0#32 = 0;
       |PINDA #0#0;
   |FINSI;

   |SI #2#46 = "S";
       |CAMPO_MODIFICA #0#38, 1, "N"; #0#38 = "N";
       |CAMPO_MODIFICA #0#39, 1, "N"; #0#39 = 0;
   |FINSI;

   |SI #2#41 = "S"; |ACABA; |FINSI;

   |SI #0#3 ] 0;  |Y #0#3 [ 80;
       coefi_g = #2#25;
       |CAMPO_MODIFICA #0#20, 1, "S";
       |SI #0#3  < 10; |O #0#3 > 15;
           |CAMPO_MODIFICA #0#38, 1, "N"; #0#38 = "N";
           |CAMPO_MODIFICA #0#39, 1, "N"; #0#39 = 0;
       |FINSI;
   |SINO;
       |SI #0#3 [ 97;
           |SI #2#22 = "B";
               |CAMPO_MODIFICA #0#20, 1, "S";
               coefi_g = #2#25;
           |SINO;
               |CAMPO_MODIFICA #0#20, 1, "N";
               coefi_g = 0;
           |FINSI;
       |SINO;
           coefi_g = #2#25;
           |CAMPO_MODIFICA #0#20, 1, "S";
       |FINSI;
   |FINSI;

|FPRC;

|PROCESO lee_exist;
|SI #2#41 = "S"; |ACABA; |FINSI;

|ABRE #4;
#4#0 = #0#0;
#4#1 = #0#1;
#4#2 = #0#3;
|LEE 040#4=;
|SI FSalida ! 0; |DDEFECTO #4; |FINSI;
|CIERRA #4;

|SI #0#2 = 1; #0#9  = #4#7;  |FINSI;
|SI #0#2 = 2; #0#9  = #4#8;  |FINSI;
|SI #0#2 = 3; #0#9  = #4#9;  |FINSI;
|SI #0#2 = 4; #0#9  = #4#10; |FINSI;

|SI #0#2 = 1; #0#15 = #4#3;  |FINSI;
|SI #0#2 = 2; #0#15 = #4#3;  |FINSI;
|SI #0#2 = 3; #0#15 = #4#3;  |FINSI;
|SI #0#2 = 4; #0#15 = #4#3;  |FINSI;

|PINTA #0#9;
|PINTA #0#15;
|FPRC;

|PROCESO recogida; |TIPO 0;
     |SI #2#41 = "S"; |ACABA; |FINSI;

     |ABRE #3;
     |LEE 040#3p;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     cont = (FEntrada / 100) ! 0;
     |SI cont ! 1; |ACABA; |FINSI;

     nEjer = 2000 + #0#3;
     |SI nEjer ] 2080;
         nEjer = 1900 + #0#3;
     |FINSI;

     |SI nEjer < 2009;
         |ABRE #5;
         #5#0  = #0#0;
         #5#45 = #0#1;
         #5#1  = #0#2;
         #5#2  = #0#3;
         |LEE 040#5=;
         |SI FSalida ! 0; |DDEFECTO #5; |FINSI;
         |CIERRA #5;

         ventas = #5#5 + #5#8 + #5#11 + #5#49;
         |ACABA;
     |FINSI;

     |SI nEjer ] 2009;  |Y nEjer [ 2013;
         |ABRE #25;
        #25#0  = #0#0;
        #25#45 = #0#1;
        #25#1  = #0#2;
        #25#2  = #0#3;
        |LEE 040#25=;
        |SI FSalida ! 0; |DDEFECTO #25; |FINSI;
        |CIERRA #25;

         ventas = #25#5 + #25#8 + #25#11 + #25#49;
     |FINSI;

     |SI nEjer ] 2014;
         |SI #0#2 = 1;  nPeriodo = 3;  |FINSI;
         |SI #0#2 = 2;  nPeriodo = 6;  |FINSI;
         |SI #0#2 = 3;  nPeriodo = 9;  |FINSI;
         |SI #0#2 = 4;  nPeriodo = 12;  |FINSI;

         |ABRE #dsmociva;
         #dsmociva#0  = #0#0;
         #dsmociva#1  = nEjer;
         #dsmociva#2  = nPeriodo;
         #dsmociva#3  = 303;
         #dsmociva#4  = 0;
         #dsmociva#5  = #eosm2130#1;
         #dsmociva#6  = 1;
         #dsmociva#7  = 9;
         |LEE 000#dsmociva.=;
         |SI FSalida ! 0;  |DDEFECTO #dsmociva;  |FINSI;
         |CIERRA #dsmociva;

         ventas = #dsmociva#12;
     |FINSI;

    |SI #0#2 = 1;
        #0#20 = coefi_g;
        #0#6 = ventas;
        |HAZ lee_exist;

        |PINDA #0#0;
        |ACABA;
    |FINSI;

    v_anter = 0;
    f_anter = 0;
    c_anter = 0;
    i_anter = 0;
    d_anter = 0;
    r_anter = 0;
    p_anter = 0;

    empresa = #0#0;
    activid = #0#1;
    periodo = #0#2;
    ejercic = #0#3;

    #0#2    = #0#2 - 1;
    |LEE 040#0=;
    |SI FSalida = 0;
        v_anter = #0#8;
        f_anter = #0#11;
        c_anter = #0#14;
        i_anter = #0#17;
        r_anter = #0#25;
        p_anter = #0#28 + #0#29;
        ad_anter = #0#38;
        d_anter = #0#39;
    |FINSI;

    |DDEFECTO #0;
    |HAZ lee_exist;

    #0#0  = empresa;
    #0#1  = activid;
    #0#2  = periodo;
    #0#3  = ejercic;
    |LEE 040#0=;
    |SI FSalida ! 0; |DDEFECTO #0; |FINSI;

    #0#0  = empresa;
    #0#1  = activid;
    #0#2  = periodo;
    #0#3  = ejercic;
    #0#6  = ventas;
    #0#7  = v_anter;
    #0#10 = f_anter;
    #0#13 = c_anter;
    #0#16 = i_anter;
    #0#20 = coefi_g;
    #0#24 = r_anter;
    #0#28 = p_anter;
    #0#38 = ad_anter;
    #0#40 = d_anter;
    |PINDA #0#0;
|FPRC;

|PROCESO AntesGastos; |TIPO 7;
    |SI #0#3 ] 15;
        |MENSA "0000Recuerde los Gastos no pueden superar los 2.000 euros en el Ejercicio";
    |FINSI;
|FPRC;

|| /////////////
|PROCESO ElRestodelCalculo;
    #106#22 = #106#18 - #106#19 - #106#21;

    |SI #106#38 = "S"; |Y #106#22 > 0;  ||nuevo
        #106#39 = #106#22 % 20;
    |SINO;
        #106#39 = 0;
    |FINSI;
    #106#22 = #106#22 - #106#39;

    #106#25 = #106#23 + #106#24;

    |SI #3#10 = 1; #106#26 = #106#18; |SINO; #106#26 = #106#22; |FINSI;
    #106#26 = #106#26 + #106#33;
    #106#27 = #106#26 % 20;
    #106#31 = #106#30 % 2;

    #106#29 = #106#27 - #106#28 - #106#25;
    cuota = #106#31 - #106#32;

    #106#29 = #106#29 + cuota;
    |SI #106#29 < 0; #106#29 = 0; |FINSI;
|FPRC;

|PROCESO TotalGastos;
    |SI #106#1 ! nClave1;
        |SI nOpe = 0;
            |SI #106#18 > 0;
                nTotalG17 = nTotalG17 + #106#18;
                #106#21   = #106#18 % #106#20;
                |SI #106#21 < 0;  #106#21 = 0;  |FINSI;
                nTotalG21 = nTotalG21 + #106#21;
            |FINSI;
        |SINO;
            |SI #106#18 > 0;
                #106#21 = (#106#18 / nTp) ! 2;
            |SINO;
                #106#21 = 0;
            |FINSI;
            nTotalG21 = nTotalG21 + #106#21;
            |HAZ ElRestodelCalculo;
            |GRABA 040#106a;
        |FINSI;
    |FINSI;
    |LIBERA #106;
|FPRC;

|DEFBUCLE TotalGastos;
     #106#1004;
     ;
     nClave0, 1, nClave2, nClave3;
     nClave0, 6, nClave2, nClave3;
     e;
     NULL, TotalGastos;
|FIN;

|PROCESO RecogeTotalGastos;
     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/eosm2130.mas";
     |CARGA_DEF aDef, espejo6@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def eosm2130";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     nTotalG17 = 0;
     nTotalG21 = 0;
     |SI #0#18 > 0;
         nTotalG17 = #0#18;
         nTotalG21 = #0#18 % #0#20;
     |FINSI;

     nClave0 = #0#0;
     nClave1 = #0#1;
     nClave2 = #0#2;
     nClave3 = #0#3;

     nOpe = 0; |BUCLE TotalGastos;
     nOpe = 2;
     nTp  = (100 / #0#20) ! 2;
     |SI nTotalG21 > 2000;
         nTp  = (nTotalG17 / 2000) ! 2;
         nOpe = 1;
     |FINSI;
     nTotalG21 = 0;
     |BUCLE TotalGastos;
     |SI nOpe = 1;
         #0#21 = 2000 - nTotalG21;
     |SINO;
         #0#21 = (#0#18 % #0#20) ! 2;
     |FINSI;
     |SI #0#21 < 0; #0#21 = 0; |FINSI;
     |DESCARGA_DEF #espejo6@;
|FPRC;

|| /////////////

|PROCESO calcular; |TIPO 0;
    |BLIN 4;
    #0#8  = #0#6 + #0#7;
    #0#11 = #0#9;
    #0#14 = #0#12 + #0#13;
    #0#17 = #0#15;
    #0#18 = #0#8 + #0#11 - #0#14 - #0#17;

    |SI #0#3 ] 0;  |Y #0#3 [ 80;
        #0#19 = 0;
        #0#21 = #0#18 % #0#20;
    |SINO;
        |SI #0#3 [ 97;
            |SI #2#22 = "B";
                #0#21 = #0#18 % #0#20;
                #0#19 = 0;
            |SINO;
                |SI #2#23 = "P"; #0#19 = #0#8 % 1; |SINO; #0#19 = 0; |FINSI;
                #0#21 = 0;
            |FINSI;
        |SINO;
             #0#19 = 0;
             #0#21 = #0#18 % #0#20;
        |FINSI;
    |FINSI;

    |SI #0#18 < 0; #0#19 = 0; #0#21 = 0; |FINSI;

    |SI #0#21 > 2000; |Y #0#3 = 15;
        #0#21 = 2000;
    |FINSI;

    |SI #0#3 ] 16; |Y #2#46 ! "S";
        |HAZ RecogeTotalGastos;
    |FINSI;

    #0#22 = #0#18 - #0#19 - #0#21;

    |SI #0#38 = "S"; |Y #0#22 > 0;  ||nuevo
        |SI Campo < 22; |O Campo = 38;
             #0#39 = #0#22 % 20;
        |FINSI;
    |SINO;
        #0#39 = 0;
    |FINSI;
    #0#22 = #0#22 - #0#39;
|| -------------------------------------------

    #0#25 = #0#23 + #0#24;

    |SI #3#10 = 1; #0#26 = #0#18; |SINO; #0#26 = #0#22; |FINSI;
    #0#26 = #0#26 + #0#33;
    #0#27 = #0#26 % 20;
    #0#31 = #0#30 % 2;

    #0#29 = #0#27 - #0#28 - #0#25; || ... |SI #0#29 < 0; #0#29 = 0; |FINSI;   Tique Asefeco
    cuota = #0#31 - #0#32;         || ... |SI cuota < 0; cuota = 0; |FINSI;   Tique Asefeco

    #0#29 = #0#29 + cuota;
    |SI #0#29 < 0; #0#29 = 0; |FINSI; || Tique 70000_4881

    |SI nSwPan = 0; |PINDA #0#0; |FINSI;
|FPRC;

|PROCESO AntesRet; |TIPO 7;
     |SI #0#3 ] 15;
         |MENSA "0000<F7> Introducir Rendimiento Ejer. Anterior para Minoracion";
     |FINSI;
|FPRC;

|CALCULO DespuesRet; |TIPO 0;
 |BLIN 4;
 nInkey = FSalida;
 |SI nInkey = 15; |Y  #0#3 ] 15;
     enMod130 = 130;
     enEmp130 = #0#0;
     enEje130 = #0#3;
     |SUB_EJECUTA "eosz0099";
     |HAZ calcular;
     |ERROR;
 |FINSI;
|FCAL;

|PROCESO AntesSusCom; |TIPO 7;
     aAlfa1 = "0000Declararcion Complementaria";
     |SI #0#3 ] 15;
         aAlfa1 = "0000Declar. Complementaria. <F7> Introducir Rend. Ejer. Anterior para Minoracion";
     |FINSI;
     |MENSA aAlfa1;
|FPRC;

|PROCESO SusCom; |TIPO 0;
 |HAZ DespuesRet;

 aAlfa1 = "N"; |SI #0#34 = "S"; aAlfa1 = "S"; |FINSI;
 |C_M #0#35,1,aAlfa1;
 |C_M #0#36,1,aAlfa1;
 |C_M #0#37,1,aAlfa1;

 |SI #0#34 ! "S";
     #0#35 = ""; |PINTA #0#35;
     #0#36 = ""; |PINTA #0#36;
     #0#37 = 0;  |PINTA #0#37;
 |FINSI;
|FPRC;

|PROCESO LaReduccion;
 |C_M #0#38, 0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 aAlfa1 = #0#38;  |C_M #0#39,1,aAlfa1;
 |SI #0#38 = "N"; #0#39 = 0; |PINTA #0#39;  |FINSI;
|FPRC;

|PROCESO Crea2015;
   |C_M #0#39, 0, aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   |SI FSalida = 2; |ACABA; |FINSI;

   |SI #0#3 = 15;
       |SI #0#39 ! 0;
           aAlfa1 = "0000SImporte en Reduc.creacion empleo y ejercicio 2015 incompatibles. Modifiquela. ";
           |CONFI aAlfa1;
           |SI FSalida = 0;
               |ERROR;
           |FINSI;
       |SINO;
            #0#38 = "N"; |PINTA #0#38;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO MRedEmpleo; |TIPO 3;
      |SI #0#3 = 15;
          |SI #0#39 ! 0;
              |MENAV "0000Hay Importe en la Reduccion por creacion de empleo, no es correcto para Ejer. 2015.";
          |SINO;
              #0#38 = "N";
          |FINSI;
      |FINSI;
|FPRC;

|PROCESO graba_segui; |TIPO 30;

se_empre = #0#0;
se_ejerc = #0#3;
se_perio = #0#2;
se_tipos = 130;
se_activ = #0#1;
se_impor = #0#29;
se_fecha = #0#4;
se_factu = "";
|HAZ seguimie;


sw_130 = 0; |HAZ graba_glob;
#0#0 = empresa;
sw_130 = 1; |HAZ graba_glob;

#0#0 = empresa;
#0#1 = activid;
#0#2 = periodo;
#0#3 = ejercic;
|LEE 040#0=;
|FPRC;

|PROCESO borra_130;
  |BORRA 140#6a;
  |LIBERA #6;
|FPRC;

|DEFBUCLE eosm3130_1;
  #6#1;
  32;
  #0#0, 1, #0#2, #0#3, "N";
  #0#0, 9, #0#2, #0#3, "N";
  e;
  NULL, borra_130;
|FIN;

|PROCESO graba_glob;
|ABRE #2;
nSwPasada = 0;
|PARA act_nor = 1; |SI act_nor [ 6; |HACIENDO act_nor = act_nor + 1;
      |SALVA_DATOS #0;
      #2#0 = #0#0;
      #2#1 = act_nor;
      #2#2 = #0#3;
      |LEE 040#2=;
      |SI FSalida = 0;
          |SI #2#46 = "S";
              |SI nSwPasada = 0;  |HAZ comunero; |FINSI;
          |SINO;
              |SI #2#14 = "S";
                  |SI nSwPasada = 0;  |HAZ comuneroC; |FINSI;
              |SINO;
                  |HAZ normal;
              |FINSI;
          |FINSI;
      |FINSI;
      |REPON_DATOS #0;
|SIGUE;
|CIERRA #2;
|FPRC;

|| ////////////////////////////////////////////////////////////////////////
|PROCESO dsmod130;

     |SI #1130#3 = 8;  |Y #1130#2 = 1;
          nImporte = #1130#29;
     |SINO;
          nImporte = #1130#46;
     |FINSI;

     |SI nImporte < 0; nSwNeg = 1; |FINSI;

     |SI nImporte ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1130#42;

     |SI nImporte < 0;
         #6#43 = #6#43 + -nImporte;
     |SINO;
         #6#43 = #6#43 - #1130#42;
         |SI #6#43 [ 0; nSwNeg = 0; #6#43 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsmod130;
     #1130#1004;
     ;
     #6#0, #6#1,     1, #6#3;
     #6#0, #6#1, nHPer, #6#3;
     ;
     NULL, dsmod130;
|FIN;

|PROCESO CapturaNegativos130;
     |SI #6#42 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm3130.mas";
     |CARGA_DEF aMas, dsmod130@;

     nSwNeg   = 0;
     nSumaD   = 0;
     #6#43    = 0;
     nHPer    = #6#2 - 1;
     |BUCLE dsmod130;

     |DESCARGA_DEF #dsmod130@;
|FPRC;

|PROCESO dsmod130Tope;
     nTopeAgrario = nTopeAgrario + #1130#47;
|FPRC;

|DEFBUCLE dsmod130Tope;
     #1130#1004;
     ;
     #6#0, #6#1,     1, #6#3;
     #6#0, #6#1, nHPer, #6#3;
     ;
     NULL, dsmod130Tope;
|FIN;

|PROCESO CapturaTopeAgrario;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm3130.mas";
     |CARGA_DEF aMas, dsmod130@;

     nTopeAgrario = 0;
     nHPer        = #6#2 - 1;
     |BUCLE dsmod130Tope;

     |DESCARGA_DEF #dsmod130@;
|FPRC;

|PROCESO CalculaDed130;
     |SI nEjer < 2008;
         #6#41 = 0;
         #6#42 = 0;
         #6#43 = 0;
         #6#44 = 0;
         #6#47 = 0;
         |ACABA;
     |FINSI;

     #6#42 = #6#29 - #6#41;

     |SI #6#42 [ 0;
         #6#43 = 0;
         #6#47 = 0;
         |ACABA;
     |FINSI;

     |SI nEjer = 2008;
         |SI #6#2 > 1;
             |HAZ CapturaNegativos130;
         |SINO;
             #6#41 = 0;
             #6#42 = 0;
             #6#43 = 0;
             #6#44 = 0;
             #6#47 = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nEjer ] 2009;
         |SI #6#2 ! 1;
             |HAZ CapturaNegativos130;
         |FINSI;
     |FINSI;

     nSuma = #6#43 + #6#47;
     |SI nSuma > #6#42;
         |SI #6#43 > #6#42;
             #6#43 = #6#42;
             #6#47 = 0;
             |ACABA;
         |FINSI;

         #6#47 = #6#42 - #6#43;
     |FINSI;
|FPRC;

|PROCESO Casilla5;
     pagos_g = 0;

     |SI #0#2 = 1;  |ACABA;  |FINSI;

     |SI nEjer [ 2008;
         #6#0 = nEmpresa;
         #6#1 = nActividad;
         #6#2 = #0#2 - 1;
         #6#3 = #0#3;
         |LEE 000#6=;
         |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

         nEl27   = 0;
         |SI #6#27 > 0;
             nEl27 = #6#27;
         |FINSI;

         enNume  = nEl27 - #6#28 - #6#25;
         |SI enNume < 0; enNume = 0; |FINSI;

         pagos_g = enNume + #6#28;

         |ACABA;
     |FINSI;

     nHPer   = #0#2 - 1;
     |PARA nNume1 = 1; |SI nNume1 [ nHPer; |HACIENDO nNume1 = nNume1 + 1;
           |DDEFECTO #6;
           #6#0 = nEmpresa;
           #6#1 = nActividad;
           #6#2 = nNume1;
           #6#3 = #0#3;
           |LEE 040#6=;
           |SI FSalida = 0;
               nEl27   = 0;
               |SI #6#27 > 0;
                   nEl27 = #6#27;
               |FINSI;

               enNume  = nEl27 - #6#28 - #6#25;
               |SI enNume < 0; enNume = 0; |FINSI;

               pagos_g = pagos_g + (enNume - #6#47);
           |FINSI;
     |SIGUE;
|FPRC;

|| ************************************************************************
|PROCESO ParaCalMinoracion;
  enMod130 = 130;
  enEje130 = #0#3;
  enEmp130 = #0#0;
  enAct130 = #0#1;
  enPer130 = #0#2;
  efFec130 = fFecha1;
  enRend_NoAgr = #0#22;
  enRend_Agr   = #0#30;
  |HAZ eGrabadsmom094;
|FPRC;

|PROCESO ParaCalMinoracionC;
  enMod130 = 130;
  enEje130 = #0#3;
  enEmp130 = #15#3;
  enAct130 = #15#5;
  enPer130 = #0#2;
  efFec130 = fFecha1;
  enRend_NoAgr = ( #0#22  % #15#6) ! 2;
  enRend_Agr   = ( #0#30  % #15#6) ! 2;
  |HAZ eGrabadsmom094;
|FPRC;
|| ************************************************************************

|PROCESO PrimeroTope;
   |SI #0#3 = 15; |O nEsComun = 0;
       nNume1 = #6#21 + #0#21;
       |SI nNume1 > 2000;
           #0#21 = 2000 - #6#21;
           |SI #0#21 < 0; #0#21 = 0; |FINSI;
      |SINO;
           |ACABA;
      |FINSI;

      #0#22 = #0#18 - #0#19 - #0#21;

      |SI #0#38 = "S"; |Y #0#22 > 0;  ||nuevo
          #0#39 = #0#22 % 20;
      |SINO;
          #0#39 = 0;
      |FINSI;
      #0#22 = #0#22 - #0#39;

      #0#25 = #0#23 + #0#24;

      |SI #3#10 = 1; #0#26 = #0#18; |SINO; #0#26 = #0#22; |FINSI;
      #0#26 = #0#26 + #0#33;
      #0#27 = #0#26 % 20;
      #0#31 = #0#30 % 2;

      #0#29 = #0#27 - #0#28 - #0#25; || ... |SI #0#29 < 0; #0#29 = 0; |FINSI;   Tique Asefeco
      cuota = #0#31 - #0#32;         || ... |SI cuota < 0; cuota = 0; |FINSI;   Tique Asefeco

      #0#29 = #0#29 + cuota;
      |SI #0#29 < 0; #0#29 = 0; |FINSI; || Tique 70000_4881
  |FINSI;

  |SI #0#3 ] 16; |O nEsComun = 1;
       nNume1 = #6#21 + (#0#21 % #15#6);
       |SI nNume1 > 2000;
           nNume1 = 2000 - #6#21;
           #0#21 = ((100 * nNume1) / #15#6) ! 2;
           |SI #0#21 < 0; #0#21 = 0; |FINSI;
      |SINO;
           |ACABA;
      |FINSI;

      #0#22 = #0#18 - #0#19 - #0#21;

      |SI #0#38 = "S"; |Y #0#22 > 0;  ||nuevo
          #0#39 = #0#22 % 20;
      |SINO;
          #0#39 = 0;
      |FINSI;
      #0#22 = #0#22 - #0#39;

      #0#25 = #0#23 + #0#24;

      |SI #3#10 = 1; #0#26 = #0#18; |SINO; #0#26 = #0#22; |FINSI;
      #0#26 = #0#26 + #0#33;
      #0#27 = #0#26 % 20;
      #0#31 = #0#30 % 2;

      #0#29 = #0#27 - #0#28 - #0#25; || ... |SI #0#29 < 0; #0#29 = 0; |FINSI;   Tique Asefeco
      cuota = #0#31 - #0#32;         || ... |SI cuota < 0; cuota = 0; |FINSI;   Tique Asefeco

      #0#29 = #0#29 + cuota;
      |SI #0#29 < 0; #0#29 = 0; |FINSI; || Tique 70000_4881
  |FINSI;
|FPRC;

|PROCESO normal;
   |SI sw_130 = 0;
       |BUCLE eosm3130_1;
       |ACABA;
   |FINSI;

   |SI #2#42 = "S"; activi_g = #2#1; |SINO; activi_g = 9; |FINSI;

   |SI #0#3 ] 80;
       nEjer = 1900 + #0#3;
   |SINO;
       nEjer = 2000 + #0#3;
   |FINSI;

   fFecha1 = #2#48;

   |ABRE #6;

   nEmpresa   = #0#0;
   nActividad = activi_g;
   |HAZ Casilla5;

   nAcabar = 0;
   #0#0 = #0#0;
   #0#1 = #2#1;
   #0#2 = #0#2;
   #0#3 = #0#3;
   |LEE 040#0=;
   |SI FSalida ! 0;
       nAcabar = 1;
       |SI periodo ! 1;
           nEmpAnt = #0#0;
           nActAnt = #0#1;
           |HAZ MiroAnterior;
           |SI nSwHay =  0; |CIERRA #6; nAcabar = 2; |FINSI;
       |SINO;
           |CIERRA #6; nAcabar = 2;
       |FINSI;
   |FINSI;

   |SI nAcabar = 2;
       #0#22 = 0;
       #0#30 = 0;
   |FINSI;
   |SI nEjer ] 2010; |HAZ ParaCalMinoracion; |FINSI;
   |SI nAcabar = 2; |ACABA; |FINSI;

   #6#0 = #0#0;
   #6#1 = activi_g;
   #6#2 = #0#2;
   #6#3 = #0#3;
   |LIBERA #6;
   |LEE 140#6=;
   FEstado = FSalida;
   |SI FEstado ! 0;
       |DDEFECTO #6;
       #6#0 = #0#0;
       #6#1 = activi_g;
       #6#2 = #0#2;
       #6#3 = #0#3;
   |FINSI;

   |HAZ PrimeroTope;

   |PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
       #6x = #6x + #0x;
   |SIGUE;
   #6#20 = #0#20;
   #6#37 = #6#37 + #0#33;
   #6#48 = #0#38;
   #6#49 = #6#49 + #0#39;

   |SI #6#3 ] 80;
       nEjer = 1900 + #6#3;
   |SINO;
       nEjer = 2000 + #6#3;
   |FINSI;

   enSwApli = 0;
   enEmp130 = #6#0;
   enEje130 = #6#3;
   enPer130 = #6#2;
   enMod130 = 130;
   eaNombreAp   = #1#2;
   enRend_NoAgr = #6#22;
   enRend_Agr   = #6#30;
   |HAZ eLeeAplica;

   #6#41 = 0; #6#42 = 0;
   #6#43 = 0; #6#44 = 0;
   |SI nEjer = 2008; |Y eaAplica1 ! "N";
       |SI #6#2 = 2;  #6#41 = 200;  |FINSI;
       |SI #6#2 = 3;  #6#41 = 100;  |FINSI;
       |SI #6#2 = 4;  #6#41 = 100;  |FINSI;
   |FINSI;

   |SI nEjer = 2009; |Y eaAplica1 ! "N";
       |SI #6#2 = 1;  #6#41 = 100;  |FINSI;
       |SI #6#2 = 2;  #6#41 = 100;  |FINSI;
       |SI #6#2 = 3;  #6#41 = 100;  |FINSI;
       |SI #6#2 = 4;  #6#41 = 100;  |FINSI;
   |FINSI;

   |SI nEjer ] 2010; |Y eaAplica1 ! "N";
       #6#41 = enApli400;
   |FINSI;

   #6#47 = 0;
   |SI nEjer ] 2009; |Y eaAplica2 = "S";
       |SI #6#22 > 0;
           #6#47 = #6#22 % 2;
           |SI enAplica3 = 0;
               |SI #6#47 > 660.14;
                   #6#47 = 660.14;
               |FINSI;
           |SINO;
               |SI #6#47 > 440;
                   #6#47 = 440;
               |FINSI;
           |FINSI;
       |SINO;
           |SI #6#30 > 0;
               #6#47 = #6#30 % 2;
               |HAZ CapturaTopeAgrario;
               |SI enAplica3 = 0;
                   nTope = 660.14 - nTopeAgrario;
               |SINO;
                   nTope = 440 - nTopeAgrario;
               |FINSI;
               |SI nTope < 0;  nTope = 0;  |FINSI;
               |SI #6#47 > nTope;
                   #6#47 = nTope;
               |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI #0#34 = "S";
       #6#45 = #6#45 + #0#37;   ||Para complementarias
   |FINSI;

   |SI #2#41 = "N"; #6#28 = pagos_g; |FINSI;

   #6#30 = #6#30 + #0#30;
   #6#31 = #6#31 + #0#31;
   #6#36 = #6#36 + #0#32;

   #6#29 = #6#27 - #6#28 - #6#25;
||   |SI #6#29 < 0; #6#29 = 0; |FINSI;  tique 700000_4881

   cuota = #6#31 - #6#36;
||   |SI cuota < 0; cuota = 0; |FINSI;  tique 700000_4881

   #6#29 = #6#29 + cuota;
   |SI #6#29 < 0; #6#29 = 0; |FINSI;

   #6#38 = #0#34;
   #6#39 = #0#35;
   #6#40 = #0#36;

   |HAZ CalculaDed130;

   #6#44 = #6#42 - #6#43 - #6#47;
   #6#46 = #6#44 - #6#45;

   |SI FEstado ! 0; |GRABA 140#6n; |SINO; |GRABA 140#6a; |FINSI;

   |CIERRA #6;
|FPRC;

|PROCESO graba_inde;
   #16#0 = #15#3;
   |LIBERA #16;
   |LEE 140#16=;
   |SI FSalida = 0; |GRABA 140#16a; |SINO; |GRABA 140#16n; |FINSI;
|FPRC;

|DEFBUCLE eoscomul_1;
  #15#1;
  ;
  empresa, activid, ejercic, 000;
  empresa, activid, ejercic, 999;
  e;
  NULL, graba_inde;
|FIN;

|DEFBUCLE eosm3130_2;
  #6#1;
  32;
  #15#3, 1, #0#2, #0#3, "S";
  #15#3, 9, #0#2, #0#3, "S";
  be;
  NULL, borra_130;
|FIN;

|PROCESO graba_comu;
     |SI nSw = 1;
         |SI se_empre ! #15#3; |ACABA; |FINSI;
     |FINSI;

     |SI sw_130 = 0;
         |BUCLE eosm3130_2;
         |ACABA;
     |FINSI;

     |SI #0#3 ] 80;
         nEjer = 1900 + #0#3;
     |SINO;
         nEjer = 2000 + #0#3;
     |FINSI;

     nSwPasada = 1;
     |ABRE #1;
     #1#0 = #15#0;
     |LEE 040#1=;
     |SI FSalida ! 0; |DDEFECTO #1; |FINSI;
     |CIERRA #1;

     #2#0 = #15#3;
     #2#1 = #15#5;
     #2#2 = #15#7;
     |LEE 040#2=;
     |SI FSalida ! 0; |DDEFECTO #2; |FINSI;

     |SI #2#42 = "S"; activi_g = #15#5; |SINO; activi_g = 9; |FINSI;

     fFecha1 = #2#48;
     |ABRE #6;

     nEmpresa   = #15#3;
     nActividad = activi_g;
     |HAZ Casilla5;

     |SI activi_g = 9; |Y nSw = 0; |HAZ BuscoOtras; |FINSI;

     nAcabar = 0;
     #0#0 = #15#0;
     #0#1 = #15#1;
     #0#2 = periodo;
     #0#3 = ejercic;
     |LEE 040#0=;
     |SI FSalida ! 0;
         nAcabar = 1;
         |SI periodo ! 1;
             nEmpAnt = #15#0;
             nActAnt = #15#1;
             |HAZ MiroAnterior;
             |SI nSwHay = 0; |CIERRA #6; nAcabar = 2; |FINSI;
         |SINO;
             |CIERRA #6; nAcabar = 2;
         |FINSI;
     |FINSI;
     |SI nAcabar = 2;
         #0#22 = 0;  #0#30 = 0;
     |FINSI;
     |SI nEjer ] 2010; |HAZ ParaCalMinoracionC; |FINSI;
     |SI nAcabar = 2; |ACABA; |FINSI;

     #6#0 = #15#3;
     #6#1 = activi_g;
     #6#2 = #0#2;
     #6#3 = #0#3;
     |LIBERA #6;
     |LEE 140#6=;
     FEstado = FSalida;
     |SI FEstado ! 0;
         |DDEFECTO #6;
         #6#0 = #15#3;
         #6#1 = activi_g;
         #6#2 = #0#2;
         #6#3 = #0#3;
     |FINSI;

      |SI #6#3 ] 80;
          nEjer = 1900 + #6#3;
      |SINO;
          nEjer = 2000 + #6#3;
      |FINSI;

     enSwApli = 0;
     enEmp130 = #6#0;
     enEje130 = #6#3;
     enPer130 = #6#2;
     enMod130 = 130;
     eaNombreAp   = #1#2;
     enRend_NoAgr = #6#22;
     enRend_Agr   = #6#30;
     |HAZ eLeeAplica;

     #6#41 = 0; #6#42 = 0;
     #6#43 = 0; #6#44 = 0;
     |SI nEjer = 2008; |Y eaAplica1 ! "N";
         |SI #6#2 = 2;  #6#41 = 200;  |FINSI;
         |SI #6#2 = 3;  #6#41 = 100;  |FINSI;
         |SI #6#2 = 4;  #6#41 = 100;  |FINSI;
     |FINSI;
     |SI nEjer = 2009; |Y eaAplica1 ! "N";
         |SI #6#2 = 1;  #6#41 = 100;  |FINSI;
         |SI #6#2 = 2;  #6#41 = 100;  |FINSI;
         |SI #6#2 = 3;  #6#41 = 100;  |FINSI;
         |SI #6#2 = 4;  #6#41 = 100;  |FINSI;
     |FINSI;
     |SI nEjer ] 2010; |Y eaAplica1 ! "N";
         #6#41 = enApli400;
     |FINSI;

     #6#47 = 0;
     |SI nEjer ] 2009; |Y eaAplica2 = "S";
         |SI #6#22 > 0;
             #6#47 = #6#22 % 2;
             |SI enAplica3 = 0;
                 |SI #6#47 > 660.14;
                     #6#47 = 660.14;
                 |FINSI;
             |SINO;
                 |SI #6#47 > 440;
                     #6#47 = 440;
                 |FINSI;
             |FINSI;
         |SINO;
             |SI #6#30 > 0;
                 #6#47 = #6#30 % 2;
                 |HAZ CapturaTopeAgrario;
                 |SI enAplica3 = 0;
                     nTope = 660.14 - nTopeAgrario;
                 |SINO;
                     nTope = 440 - nTopeAgrario;
                 |FINSI;
                 |SI nTope < 0;  nTope = 0;  |FINSI;
                 |SI #6#47 > nTope;
                     #6#47 = nTope;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #0#34 = "S";
         #6#45 = #6#45 + (#0#37 % #15#6);   ||Para complementarias
     |FINSI;

     nEsComun = 1;
     |HAZ PrimeroTope;
     nEsComun = 0;

     |PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
          #6x = #6x + (#0x % #15#6);
     |SIGUE;
     #6#37 = #6#37 + (#0#33 % #15#6);

     |SI #2#41 = "N"; #6#28 = pagos_g; |FINSI;

     #6#20 = #0#20;
     #6#30 = #6#30 + (#0#30 % #15#6);
     #6#31 = #6#31 + (#0#31 % #15#6);
     #6#36 = #6#36 + (#0#32 % #15#6);

     #6#29 = #6#27 - #6#28 - #6#25;
     ||  |SI #6#29 < 0;  #6#29 = 0; |FINSI; tique 70000_4881

     cuota = #6#31 - #6#36;
     ||  |SI cuota < 0; cuota = 0; |FINSI;  tique 70000_4881

     #6#29 = #6#29 + cuota;
     |SI #6#29 < 0;  #6#29 = 0; |FINSI;

     #6#32 = "S";
     #6#33 = #6#33 + 1;
     #6#34 = #1#2;
     #6#35 = #15#6;
     #6#38 = #0#34;
     #6#39 = #0#35;
     #6#40 = #0#36;

     |HAZ CalculaDed130;

     #6#44 = #6#42 - #6#43 - #6#47;
     #6#46 = #6#44 - #6#45;

     |SI FEstado ! 0; |GRABA 140#6n; |SINO; |GRABA 140#6a; |FINSI;

     |CIERRA #6;
|FPRC;

|DEFBUCLE eoscomul_2;
  #15#2;
  1;
  #16#0, 1, ejercic, 1;  ||act_nor; empresa
  #16#0, 6, ejercic, 6;  ||act_nor;
  e;
  NULL, graba_comu;
|FIN;

|DEFBUCLE eoscomul_22;
  #15#1;
  ;
  #16#0, 1, #0#3, 000;  ||act_nor;
  #16#0, 6, #0#3, 999;  ||act_nor;
  e;
  NULL, graba_comu;
|FIN;

|PROCESO lee_comun;
  |SI nSw = 0;  |BUCLE eoscomul_2;   |FINSI;
  |SI nSw = 1;  |BUCLE eoscomul_22;  |FINSI;
|FPRC;

|DEFBUCLE eosw0016;
  #16#1;
  ;
  00000;
  99999;
  e;
  NULL, lee_comun;
|FIN;

|PROCESO comunero;
empresa = #0#0;
activid = #0#1;
periodo = #0#2;
ejercic = #0#3;

comienza = "16";
|HAZ fichero;
|NOME_DAT #16 fichero;

|ABRE #16; |CIERRA #16;
|DELINDEX #16;

|ABRE #16;
|BUCLE eoscomul_1;
|CIERRA #16;

nSw = 0;  |BUCLE eosw0016;
|DELINDEX #16;
|FPRC;

|PROCESO graba_inde3;
#16#0 = #15#0;
|LIBERA #16;
|LEE 140#16=;
|SI FSalida = 0; |GRABA 140#16a; |SINO; |GRABA 140#16n; |FINSI;
|FPRC;

|DEFBUCLE eoscomul_3;
#15#2;
1;
#0#0, 1, #0#3, 1;  ||act_nor;
#0#0, 6, #0#3, 6;  ||act_nor;
e;
NULL, graba_inde3;
|FIN;

|PROCESO comuneroC;
empresa = #0#0;
activid = #0#1;
periodo = #0#2;
ejercic = #0#3;

comienza = "16";
|HAZ fichero;
|NOME_DAT #16 fichero;

|ABRE #16; |CIERRA #16;
|DELINDEX #16;

|ABRE #16;
|BUCLE eoscomul_3;
|CIERRA #16;


nSw = 1;  |BUCLE eosw0016;
|DELINDEX #16;
|FPRC;


|PROCESO BuscoOtras;  || para calcular los comuneros desde comunidad

   #6#0 = #15#3;
   #6#1 = activi_g;
   #6#2 = periodo;
   #6#3 = ejercic;
   |LEE 141#6=;
   |SI FSalida ! 0;
       |DDEFECTO #6;
       #6#0 = #15#3;
       #6#1 = activi_g;
       #6#2 = periodo;
       #6#3 = ejercic;
       |GRABA 020#6b;
   |SINO;
       |LIBERA #6;
       |ACABA;
   |FINSI;

||...  aqui   |PDEFECTO #6,4,38;
||...  |PDEFECTO #6,4,32;
||...   #6#36 = 0;
||...   #6#37 = 0;

   |PARA nPara1 = 1; |SI nPara1 [ 6; |HACIENDO nPara1 = nPara1 + 1;
         |SI nPara1 ! #15#5;
             #2#0 = #15#3;
             #2#1 = nPara1;
             #2#2 = #15#7;
             |LEE 040#2=;
             |SI FSalida ! 0;   |VETE Alsigue; |FINSI;
             |SI #2#14   = "S"; |VETE Alsigue; |FINSI;

             #0#0 = #15#3;
             #0#1 = nPara1;
             #0#2 = periodo;
             #0#3 = ejercic;
             |LEE 040#0=;
             |SI FSalida ! 0;
                 |SI periodo ! 1;
                     nEmpAnt = #15#3;
                     nActAnt = nPara1;
                     |HAZ MiroAnterior;
                     |SI nSwHay = 0; |VETE Alsigue; |FINSI;
                 |SINO;
                     |VETE Alsigue;
                 |FINSI;
             |FINSI;

             |PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
                   #6x = #6x + #0x;
             |SIGUE;
             #6#37 = #6#37 + #0#33;
             #6#20 = #0#20;
             #6#30 = #6#30 + #0#30;
             #6#31 = #6#31 + #0#31;
             #6#36 = #6#36 + #0#32;

             |ET Alsigue;
        |FINSI;
   |SIGUE;

   |GRABA 040#6a;
   |LIBERA #6;
|FPRC;

|PROCESO ElAnterior;
  v_anter = #0#8;
  f_anter = #0#11;
  c_anter = #0#14;
  i_anter = #0#17;
  r_anter = #0#25;
  ad_anter = #0#38;
  d_anter = #0#39;
  nEl27   = 0; |SI #0#27 > 0; nEl27 = #0#27; |FINSI;
  enNume  = nEl27 - #0#28 - #0#25; |SI enNume < 0; enNume = 0; |FINSI;
  p_anter = enNume + #0#28;
  || ... p_anter = #0#28 + #0#29;

  |ABRE #4;
  #4#0 = #0#0;
  #4#1 = #0#1;
  #4#2 = #0#3;
  |LEE 040#4=;
  |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
  |CIERRA #4;

  |DDEFECTO #0;

  |SI periodo = 1; #0#9  = #4#7;  #0#15 = #4#3;  |FINSI;
  |SI periodo = 2; #0#9  = #4#8;  #0#15 = #4#3;  |FINSI;
  |SI periodo = 3; #0#9  = #4#9;  #0#15 = #4#3;  |FINSI;
  |SI periodo = 4; #0#9  = #4#10; #0#15 = #4#3;  |FINSI;

  #0#0  = nEmpAnt;
  #0#1  = nActAnt;
  #0#2  = periodo;
  #0#3  = ejercic;
  #0#6  = 0;
  #0#7  = v_anter;
  #0#10 = f_anter;
  #0#13 = c_anter;
  #0#16 = i_anter;
  #0#20 = coefi_g;
  #0#24 = r_anter;
  #0#28 = p_anter;
  #0#38 = ad_anter;
  #0#40 = d_anter;
  nSwPan = 1; |HAZ calcular; nSwPan = 0;
||   |GRABA 020#0n;  ||no lo grabo
|FPRC;

|PROCESO MiroAnterior;
 nSwHay = 0;
 nNume1 = periodo - 1;
 |PARA nPara2 = nNume1; |SI nPara2 ] 1; |HACIENDO nPara2 = nPara2 - 1;
       |DDEFECTO #0;
       #0#0 = nEmpAnt;
       #0#1 = nActAnt;
       #0#2 = nPara2;
       #0#3 = ejercic;
       |LEE 040#0=;
       |SI FSalida =  0;
           nSwHay = 1;
           |HAZ ElAnterior;
           |SAL;
       |FINSI;
 |SIGUE;
 #0#2 = periodo;
|FPRC;

|PROCESO CalculoNuevo;
   #6#41 = 0; #6#42 = 0;
   #6#43 = 0; #6#44 = 0;
   |SI #6#3 = 8; |Y eaAplica1 ! "N";
       |SI #6#2 = 2;  #6#41 = 200;  |FINSI;
       |SI #6#2 = 3;  #6#41 = 100;  |FINSI;
       |SI #6#2 = 4;  #6#41 = 100;  |FINSI;
   |FINSI;

   #6#46 = #6#29 - #6#45;   ||nuevo calculo Ley 80
   |SI #6#3 ] 8; |Y #6#3 [ 80;
       |SI #6#2 ] 2; |O #6#3 > 8;
           #6#42 = #6#29 - #6#41;
           |SI #6#2 ! 1;
               |HAZ CapturaNegativos130;
           |FINSI;
           #6#44 = #6#42 - #6#43;
           #6#46 = #6#44 - #6#45;
       |SINO;
           #6#41 = 0;
           #6#42 = 0;
           #6#43 = 0;
           #6#44 = 0;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO eosm3130_08;
    enSwApli = 0;
    enEmp130 = #6#0;
    enEje130 = #6#3;
    enPer130 = #6#2;
    enMod130 = 130;
    eaNombreAp   = #6#34;
    enRend_NoAgr = #6#22;
    enRend_Agr   = #6#30;
    |HAZ eLeeAplica;

    |SI #6#2 = 2; |Y eaAplica1 ! "N";
        |SI #6#41 = 200;
            |ERROR10;
            |ACABA;
        |FINSI;
    |FINSI;

    |SI #6#2 ! 1;
        |HAZ CalculoNuevo;
    |SINO;
        #6#46 = #6#29;
    |FINSI;
    |GRABA 020#6a;
    |LIBERA #6;
|FPRC;

|DEFBUCLE eosm3130_08;
     #6#1;
     ;
     00001, 1, 01, 08;
     99999, 9, 04, 08;
     be;
     NULL, eosm3130_08;
|FIN;

|PROCESO Tipo80;  |TIPO 80;
     |BUCLE eosm3130_08;
|FPRC;
