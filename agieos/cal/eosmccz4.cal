|FICHEROS;
   eosmccz4 #0;

   eoscabco #1;
   eoscabve #11;

   eoslinco #2;
   eoslinve #12;

   eosactiv #3;

   eosmcc01 #501;
   eosmcc02 #502;

   eosmccw1 #991;
   eosmccw4 #999;
   eosclien #30;

   eosmccz3;
|FIN;

|VARIABLES;
    aParam     = "";
    aParam1    = "";

    aAlfa1   = "";
    aAlfa2   = "";
    nNume1   = 0;
    nNume2   = 0;
    nPara1   = 0;
    aFichero = "";

    nCampo   = 0;

    nSwAlgun = 0;
    nSwSel   = 0;
    nSw      = 0;

    &aCif      = "";
    &enSwLinea = 0;
    &enTotal   = 0;
    &enTBases  = 0;
    &enTCuotas = 0;
    &eaTexto   = "";
    nOp        = 0;
    nError     = 0;
    &eaError   = "";
    nImpre     = 0;
    informe    = "";
    nSwPrint   = 0;

    nLibro     = 0;
    fFechaFin  = @;
    aDescrip   = "";
    nLinea     = 0;
    nLineaUlt  = 0;
    nNumBase   = 0;
    nEjerCobro = 0;
    nSuma1     = 0;
    nSuma2     = 0;
    nSuma3     = 0;

    nCampo1    = 0;
    nCampo2    = 0;
    nCampo3    = 0;
    nBase      = 0;
    nCuota     = 0;
    nEstado    = 0;
    &enPerLiq  = 0;
    d_act      = 0;
    h_act      = 0;
    fichero    = "";
    anyo       = "";
    nReten     = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcaj;


|| ***************** Calculos de Pantalla
|CALCULO Primero;
  |SI aParam = "";
      enPerLiq = 12;
      |SI #3#26 = "T"; enPerLiq = 4;  |FINSI;
  |FINSI;
|FCAL;

|CALCULO HagoInf;
  aAlfa1 = #0#4;
  |C_M #0#5,1,aAlfa1;
  |C_M #0#6,1,aAlfa1;
|FCAL;

|PROCESO activida; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;

    enDigCaja = 0;
    |ABRE #3;
    |SI #0#2 ! 0;
        #3#0 = #0#0;
        #3#1 = #0#2;
        #3#2 = #0#3;
        |LEE 040#3=;
        |SI FSalida ! 0;
            |SI aParam = "";
                |MENAV "     No existe esta Actividad en la Empresa";
                |ERROR;
            |FINSI;
        |SINO;
            d_act     = #0#2;
            h_act     = #0#2;
            enDigCaja = #3#50;
        |FINSI;
    |SINO;
        d_act = 1;
        h_act = 6;
        #3#0 = #0#0;
        #3#1 = 1;
        #3#2 = #0#3;
        |LEE 040#3];
        |SI FSalida = 0; |Y #3#0 = #0#0; |Y #3#2 = #0#3;
            enDigCaja = #3#50;
        |SINO;
            |SI aParam = "";
                |MENAV "      No existen actividades con esta empresa.";
                |ERROR;
            |FINSI;
        |FINSI;
    |FINSI;
    |CIERRA #3;
    |HAZ Primero;
|FPRC;

|| *************************************************************************
|PROCESO Campos502;
|| .. asi el calcul
     nCampo1 = 13 + (nNumBase * 3);
     nCampo2 = nCampo1 + 1;
     nCampo3 = nCampo1 + 2;

     #502nCampo1 = ((nBase + nCuota - nReten) % #502#13) ! 2;
     #502nCampo2 = (nBase  % #502#13) ! 2;
     #502nCampo3 = (nCuota % #502#13) ! 2;

     nSuma1 = (nSuma1 + #502nCampo1) ! 2;
     nSuma2 = (nSuma2 + #502nCampo2) ! 2;
     nSuma3 = (nSuma3 + #502nCampo3) ! 2;
     nLineaUlt = nNumBase;
|FPRC;

|PROCESO LeoLineaIVA;
     nSuma1 = 0;
     nSuma2 = 0;
     nSuma3 = 0;
     nLineaUlt = 0;
     |PDEFECTO #502,16,34;

     |SI #999#26 ! 0; |O #999#27 ! 0;
         nBase = #999#26;  nCuota = #999#27;  nReten = #999#28;
         nNumBase = 1; |HAZ Campos502;
     |FINSI;

     |SI #999#29 ! 0; |O #999#30 ! 0;
         nBase = #999#29;  nCuota = #999#30;  nReten = #999#31;
         nNumBase = 2; |HAZ Campos502;
     |FINSI;

     |SI #999#32 ! 0; |O #999#33 ! 0;
         nBase = #999#32;  nCuota = #999#33;  nReten = #999#34;
         nNumBase = 3; |HAZ Campos502;
     |FINSI;

     |SI #502#2 = "R";   ||Compras
         |SI #999#35 ! 0; |O #999#36 ! 0;
             nBase = #999#35;  nCuota = #999#36;  nReten = #999#37;
             nNumBase = 4; |HAZ Campos502;
         |FINSI;

         |SI #999#38 ! 0; |O #999#39 ! 0;
             nBase = #999#38;  nCuota = #999#39;  nReten = #999#40;
             nNumBase = 5; |HAZ Campos502;
         |FINSI;

         |SI #999#41 ! 0; |O #999#42 ! 0;
             nBase = #999#41;  nCuota = #999#42;  nReten = #999#43;
             nNumBase = 6; |HAZ Campos502;
         |FINSI;

     |FINSI;

     |SI nSuma1 ! #502#10; |O nSuma2 ! #502#11; |O nSuma3 ! #502#12;
         |SI nLineaUlt > 0;
             nCampo1 = 13 + nLineaUlt * 3;
             nCampo2 = nCampo1 + 1;
             nCampo3 = nCampo1 + 2;
             #502nCampo1 = #502nCampo1 + (#502#10 - nSuma1);
             #502nCampo2 = #502nCampo2 + (#502#11 - nSuma2);
             #502nCampo3 = #502nCampo3 + (#502#12 - nSuma3);
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO OpLiquidar;

   |SI #501#5 = "S"; |ACABA; |FINSI; || esta toda pagada/cobrada
   |SI #501#6 = #999#8; |Y #501#7 = #999#9;
       |ACABA;
   |FINSI;

   |ABRE #502;
   #502#0  = #501#0;
   #502#1  = #501#1;
   #502#2  = #501#13;
   #502#35 = #501#17;
   #502#3  = #501#2;
   #502#4  = 99;
   |LEE 041#502];
   |SI FSalida = 0;
       |LEE 041#502a;
   |SINO;
       |LEE 041#502u;
   |FINSI;

   nLinea = 1;
   |SI FSalida = 0; |Y #502#0 = #501#0; |Y #502#1 = #501#1;
          |Y #502#2 = #501#13; |Y #502#35 = #501#17; |Y #502#3 = #501#2;
       nLinea = #502#4 + 1;
   |FINSI;

   |DDEFECTO #502;
   #502#0  = #501#0;
   #502#1  = #501#1;
   #502#2  = #501#13;
   #502#35 = #501#17;
   #502#3  = #501#2;
   #502#4  = nLinea;

   #502#5  = fFechaFin;
   #502#6  = 9999;       ||diario de cierre
   #502#7  = enPerLiq;                      || falta este
   #502#10 = #999#10 - #501#12;  || Total Cobrado
   #502#11 = #999#8 - #501#6;
   #502#12 = #999#9 - #501#7;
   #502#13 = 100 - #501#16;
   #502#14 = "O";
   #502#15 = aDescrip;
   |GRABA 040#502b;

   nLinea = #502#4;
   |HAZ LeoLineaIVA;
   |GRABA 040#502a;
   |LIBERA #502;
   |CIERRA #502;

   #501#5 = "S";
   #501#6  = #999#8;
   #501#7  = #999#9;
   #501#12 = #999#10;
   #501#16 = 100;
   |GRABA 020#501a;
   |LIBERA #501;

|| .. Para Imprimir
   |SI nLibro ! 0; |Y nLibro ! #501#0;
       |SI nSwPrint = 1; |Y #0#4 = "S";
           |PIEINF;
       |FINSI;
        nSwPrint = 0;
   |FINSI;

   |SI #501#13 = "R";
       eaTexto = "Cobrados";
   |SINO;
       eaTexto = "Pagados";
   |FINSI;

    nLibro = #501#0;
    |SI #0#4 = "S";
        |PRINT;
         nSwPrint = 1;
    |FINSI;
    nSwAlgun = 1;
|FPRC;

|| *************************************************************************
|PROCESO IgualoCampos;
     |DDEFECTO #999;
     #999#0  = eEmpreCaja;
     #999#21 = enEjerCaja;
     #999#13 = aTipoIVA;
     #999#1  = eRegisCaja;

     |SI aTipoIVA = "S";
         #999#2  = #eoslinco#16;
         #999#3  = #eoslinco#15;
         #999#4  = #eoslinco#13;
         #999#5  = #eoslinco#3;
         |SI enDigCaja = 1;
             aAlfa1   = ("00" + #eoslinco#5) % -102;
             #999#6 = aAlfa1;
         |SINO;
             #999#6 = #eoslinco#72;
         |FINSI;
         #999#7  = #eoslinco#35;
         #999#8  = #eoslinco#7 + #eoslinco#23 + #eoslinco#24;
         #999#9  = #eoslinco#9 + #eoslinco#27 + #eoslinco#28;
         #999#10 = #eoslinco#22;
         #999#11 = #eoslinco#38;
         #999#12 = #eoslinco#12;
         #999#14 = #eoslinco#6;
         #999#15 = #eoslinco#13;
         #999#17 = #eoslinco#17;

         #999#26 = #eoslinco#7;
         #999#27 = #eoslinco#9;
         #999#28 = #eoslinco#42;

         #999#29 = #eoslinco#23;
         #999#30 = #eoslinco#27;
         #999#31 = #eoslinco#43;

         #999#32 = #eoslinco#24;
         #999#33 = #eoslinco#28;
         #999#34 = #eoslinco#44;
    |FINSI;
    |SI aTipoIVA = "R";
        #999#2  = #eoslinve#16;
        #999#3  = #eoslinve#15;
        #999#4  = #eoslinve#13;
        #999#5  = #eoslinve#3;
        |SI enDigCaja = 1;
            aAlfa1 = ("00" + #eoslinve#5) % -102;
            #999#6 = aAlfa1;
        |SINO;
            #999#6 = #eoslinve#72;
        |FINSI;
        #999#7  = #eoslinve#35;
        #999#8  = #eoslinve#7 + #eoslinve#23 + #eoslinve#24 + #eoslinve#45 + #eoslinve#46 + #eoslinve#47;
        #999#9  = #eoslinve#9 + #eoslinve#27 + #eoslinve#28 + #eoslinve#51 + #eoslinve#52 + #eoslinve#53;
        #999#10 = #eoslinve#22;
        #999#11 = #eoslinve#38;
        #999#12 = #eoslinve#12;
        #999#14 = #eoslinve#6;
        #999#15 = #eoslinve#13;
        #999#17 = #eoslinve#17;

        #999#26 = #eoslinve#7;
        #999#27 = #eoslinve#9;
        #999#28 = #eoslinve#42;

        #999#29 = #eoslinve#23;
        #999#30 = #eoslinve#27;
        #999#31 = #eoslinve#43;

        #999#32 = #eoslinve#24;
        #999#33 = #eoslinve#28;
        #999#34 = #eoslinve#44;

        #999#35 = #eoslinve#45;
        #999#36 = #eoslinve#51;
        #999#37 = #eoslinve#69;

        #999#38 = #eoslinve#46;
        #999#39 = #eoslinve#52;
        #999#40 = #eoslinve#70;

        #999#41 = #eoslinve#47;
        #999#42 = #eoslinve#53;
        #999#43 = #eoslinve#71;
    |FINSI;

    #999#22 = enEjer;
|FPRC;

|PROCESO GrabaAuxiliar;

     #991#0  = #501#0;
     #991#21 = #501#1;
     #991#13 = #501#13;
     #991#44 = #501#17;
     #991#1  = #501#2;
     |LEE 041#991=;
     |SI FSalida ! 0;
         |DDEFECTO #991;
         #991#0  = #501#0;
         #991#21 = #501#1;
         #991#13 = #501#13;
         #991#44 = #501#17;
         #991#1  = #501#2;
         |GRABA 020#991c;
     |FINSI;

     |SI nSwSel ! 2;
         |PARA nPara1 = 2; |SI nPara1 [ 45; |HACIENDO nPara1 = nPara1 + 1;
               #991nPara1 = #999nPara1;
         |SIGUE;
     |FINSI;
     #991#11 = eaError;
     |GRABA 020#991a;
     |LIBERA #991;
     nError = 1;
|FPRC;

|PROCESO Facturas;

  |SI aTipoIVA = "S";
      |SI #2#19 < d_act; |O #2#19 > h_act; |ACABA; |FINSI;
  |SINO;
      |SI #12#19 < d_act; |O #12#19 > h_act; |ACABA; |FINSI;
  |FINSI;

  enSwCaja = 0;
  |HAZ EsCajaIva;
  |SI enSwCaja = 0; |ACABA; |FINSI;

  nSwSel = 1;
  |HAZ IgualoCampos;

    #999#16 = #501#12;
    #999#17 = #501#8;
    #999#18 = #501#16;
    #999#19 = #501#6;
    #999#20 = #501#7;

    #999#44 = #501#17;
    #999#45 = #501#18;
|FPRC

|PROCESO RegCajaOrigen;

   aTipoIVA   = #501#13;
   eDevenCaja = #501#17;
   eRegisCaja = #501#2;
   ePerioCaja = #501#18;
   |HAZ ePathCaja;

   nSwSel = 0;
   |SI aTipoIVA = "S";
       aFichero = "c" + ePathCaja;
       |CIERRA #2;  |NOME_DAT #2  aFichero;
       |ABRE #2;
       |DDEFECTO #2;
       #2#0  = #501#0;
       #2#14 = eClvDeCaja;
       #2#1  = #501#2;
       |LEE 041#2=;
       nEstado = FSalida;
       |CIERRA #2;
   |SINO;
       aFichero = "v" + ePathCaja;
       |CIERRA #12;  |NOME_DAT #12  aFichero;
       |ABRE #12;
       |DDEFECTO #12;
       #12#0  = #501#0;
       #12#14 = eClvDeCaja;
       #12#1  = #501#2;
       |LEE 041#12=;
       nEstado = FSalida;
       |CIERRA #12;
   |FINSI;

   |SI nEstado = 0;
       |HAZ Facturas;
   |SINO;
       nSwSel = 2;
       eaError = "No existe Factura";
       |DDEFECTO #999;
   |FINSI;
   |SI nSwSel = 1;
       |HAZ OpLiquidar;
   |FINSI;
   |SI nSwSel ] 2;
       |HAZ GrabaAuxiliar;
   |FINSI;
|FPRC;

|DEFBUCLE RegCajaOrigen;
   #501#1;
   ;
   eEmpreCaja, enEjerCaja, "R", nEjerCobro, 00001;
   eEmpreCaja, enEjerCaja, "S", nEjerCobro, 32000;
   e;
   NULL, RegCajaOrigen;
|FIN;

|| ******************************************************
|PROCESO MiraErrores;
   |PRINT;
   nSwPrint = 1;
|FPRC;

|DEFBUCLE MiraErrores;
   #999#1;
   ;
   INICIO;
   FINAL;
   ;
   MiraErrores;
|FIN;

|| ******************************************************
|CALCULO impre; |TIPO 3;

   |SI #0#7 = "NO"; |ACABA; |FINSI;

   enEjer = 2000 + #0#3;
   aAlfa1 = enEjer;
   aAlfa1 = "31.12." + aAlfa1;
   fFechaFin = aAlfa1;
   aDescrip  = "DEVENGO A " + fFechaFin;

   nEjerCobro = enEjer - 1;

   aFichero = "y" + Usuario; |NOME_DAT #991 aFichero; |DELINDEX #991;

   eEmpreCaja  = #0#0;
   enEjerCaja  = #0#3;

   fichero = #0#0;
   fichero = "00000" + fichero;
   fichero = fichero % -105;
   anyo    = #0#3;
   anyo    = ("00" + anyo) % -102;
   eaNCaja = fichero + anyo;

   aFichero = "f" + eaNCaja;        |NOME_DAT #501 aFichero;
   aFichero = "m" + eaNCaja;        |NOME_DAT #502 aFichero;

   nSwAlgun = 0;

   |SI #0#4 = "S";
        |IMPRE 0;
        |SI FSalida ! 0;
            |MENAV "    Error en Impresora. Proceso abortado";
            |ACABA;
        |FINSI;
        nImpre = 1;

        |INFOR "eosmccz4";
        |SI FSalida ! 0;
            |MENAV "    Error en Informe. Proceso abortado";
            |FINIMP;
            |ACABA;
        |FINSI;
    |FINSI;

    |ABRE #991;
    nLibro   = 0;
    nError   = 0;
    nSwPrint = 0;
    |BUCLE RegCajaOrigen;
    |SI nImpre = 1;
        |SI nSwPrint = 1;  |PIEINF;  |FINSI;
        |FININF;
        nSwPrint = 0;
    |FINSI;

    |SI nSwAlgun = 0; |Y aParam = "";
        aAlfa1 = "0000No hay Facturas RECC para liquidar";
        |MENAV aAlfa1;
    |FINSI;

    |CIERRA #991;

    |SI nError ! 0;
        |SI nImpre = 0;
            |IMPRE 0;
            |SI FSalida ! 0;
                |MENAV "    Error en impresora. Proceso abortado";
                |VETE Salir;
            |FINSI;
            nImpre = 1;
        |FINSI;
        #eosmccz3#21 = #eosmccz4#5;
        #eosmccz3#22 = #eosmccz4#6;

        |INFOR "eosmccy3";
        |SI FSalida ! 0;
            |MENAV "    Error en informe. Proceso abortado";
            |VETE Salir;
        |FINSI;

        nSwPrint = 0;
        |BUCLE MiraErrores;
        |PIEINF;
        |FININF;
    |FINSI;

|ET Salir;
    |SI nImpre = 1;
        |FINIMP;
        nImpre = 0;
    |FINSI;
|FCAL;

|PROGRAMA;

   aParam = PARAMETRO; |QBF aParam;

   |DDEFECTO #0;
   |SI aParam = "";
       |CLS;
       |PINPA #0#0;
       |PINDA #0#0;

       |ENDATOS #1#0;
   |FINSI;

   |SI aParam ! "";
       enEjerCaja = enEjer - 2000;
       #0#0 = enEmpresa;
       #0#1 = eaNombreEmp;
       #0#2 = 0; |HAZ activida;
       #0#3 = enEjerCaja;
       #0#4  = "N";
       #0#7  = "SI";
       |HAZ impre;
   |FINSI;
|FPRO;
