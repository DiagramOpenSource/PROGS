|FICHEROS;
     eosm0017 #0;
     eosm0019 #2;
     eosm0020 #3;
     eoscomul #4;
     eosactiv #6;

     dsmom004;
     dsmom008;
     dsmoc310;

     eosm0020@ #1131;
|FIN;

|VARIABLES;
     &MTipo    = 0;
     &MEmpresa = 0;
     &MActivi  = 0;
     &MAnyo    = 0;
     &MTempor  = 0;

     nCampo     = 0;
     nAgra      = 0;
     Campo1     = 0;
     Campo2     = 0;
     Campo3     = 0;
     Campo4     = 0;
     Campo5     = 0;
     Campo6     = 0;
     Campo7     = 0;
     MPeriodo   = 0;
     LEpigrafe  = "";
     NEpigrafe  = "";
     REpigrafe  = 0;
     PEpigrafe  = 0;
     CEpigrafe  = 0;

     Trimestre  = 0;
     SwEstar    = 0;
     Periodo    = 0;
     Dias       = 0;
     Modelo     = "";
     NoAntes    = 0;
     DiasT      = 0;
     PFracci    = 0;
     SwLeer     = 0;
     Valfa      = "";
     SwBorra    = 0;

     Total      = 0;
     LaEmpresa  = 0;
     ElPeriodo  = 0;
     ElAnyo     = 0;
     Compensar  = 0;
     nSuma      = 0;
     nPeriodo   = 0;
     nHPer      = 0;

     aBase      = "";
     aMas       = "";
     aAlfa      = "";

     nSumaD     = 0;
     nSwNeg     = 0;

     nTope           = 0;
     nTope131        = 0;
     nEjer           = 0;
     nImporte        = 0;
     nNume1          = 0;
     nPer            = 0;
     nBorra          = 0;

     &enEmpresa      = 0;
     &enEjer         = 0;
     &enPeriodo      = 0;
     &enActividad    = 0;
     &enTipoEntrada  = 0;
     &enModelo       = 0;
     &enComplem      = 0;
|FIN;

|INCLUYE i_seguim;
|INCLUYE i_devolv;
|INCLUYE i_vareos;

|| *************************************************************************
|| ********************** GRABACION DEL Modelo 131 *************************
|| *************************************************************************

|PROCESO Segui131;
  se_empre = #3#0;
  se_ejerc = #3#1;
  se_perio = #3#2;
  se_tipos = 131;
  se_activ = 1;
  se_impor = #3#47;
  se_fecha = #3#3;
  se_factu = "";
  |HAZ seguimie;
|FPRC;

|PROCESO eosm0020_1;

     |SI #1131#47 < 0; nSwNeg = 1; |FINSI;

     |SI #1131#47 ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1131#55;

     |SI #1131#47 < 0;
         #3#56 = #3#56 + -#1131#47;
     |SINO;
         #3#56 = #3#56 - #1131#55;
         |SI #3#56 [ 0; nSwNeg = 0; #3#56 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE eosm0020_1;
     #1131#1003;
     ;
     #3#0, #3#1,     1;
     #3#0, #3#1, nHPer;
     ;
     NULL, eosm0020_1;
|FIN;

|PROCESO CapturaNegativos131;
     #3#56 = 0;
     |SI #3#55 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm0020.mas";
     |CARGA_DEF aMas, eosm0020@;

     nSwNeg   = 0;
     nSumaD   = 0;
     #3#56    = 0;
     nHPer    = #3#2 - 1;
     |BUCLE eosm0020_1;

     |DESCARGA_DEF #eosm0020@;
|FPRC;

|PROCESO eosm0020Tope;
     nTope131 = nTope131 + #1131#61;
|FPRC;

|DEFBUCLE eosm0020Tope;
     #1131#1003;
     ;
     #3#0, #3#1,     1;
     #3#0, #3#1, nHPer;
     ;
     NULL, eosm0020Tope;
|FIN;

|PROCESO CapturaTope;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm0020.mas";
     |CARGA_DEF aMas, eosm0020@;

     nTope131 = 0;
     nHPer    = #3#2 - 1;
     |BUCLE eosm0020Tope;

     |DESCARGA_DEF #eosm0020@;
|FPRC;

|PROCESO CalculaDed131;
     #3#55 = #3#53 - #3#54 - #3#59;

     |SI #3#55 [ 0;
         #3#56 = 0;
         #3#61 = 0;
         |ACABA;
     |FINSI;

     |SI nEjer ] 2008;  |Y #3#2 > 1;
         |HAZ CapturaNegativos131;
     |FINSI;

     nSuma = #3#56 + #3#61;
     |SI nSuma > #3#55;
         |SI #3#56 > #3#55;
             #3#56 = #3#55;
             #3#61 = 0;
             |ACABA;
         |FINSI;

         #3#61 = #3#55 - #3#56;
     |FINSI;
|FPRC;


|PROCESO ParaCalMinor131;
  #6#0 = #3#0;
  #6#1 = enAct130;
  #6#2 = #3#1;
  |LEE 040#6=;
  |SI FSalida = 0;
     enMod130 = 131;
     enEmp130 = #3#0;
     enEje130 = #3#1;
     enPer130 = #3#2;
     efFec130 = #6#48;
     enRend_Agr   = 0;
     enRend_NoAgr = #3nCampo;
     enDias130    = #0Dias;
     |SI #6#41 = "S"; |Y nAgra = 0;
         enRend_Agr = #3#43;
         nAgra = 1;
     |FINSI;
     |HAZ eGrabadsmom094;
  |FINSI;
|FPRC;

|PROCESO BuscoAgraria;
     |SI #6#1 = #0#1;
         enAct130 = #6#1;
         enMod130 = 131;
         enEmp130 = #3#0;
         enEje130 = #3#1;
         enPer130 = #3#2;
         efFec130 = #6#48;
         enRend_NoAgr = 0;
         enRend_Agr   = #3#43;
         enDias130 = #0Dias;
         |HAZ eGrabadsmom094;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscoAgraria;
  #6#1;
  41;
  #3#0, 1, #3#1, "S";
  #3#0, 6, #3#1, "S";
  ;
  NULL, BuscoAgraria;
|FIN;

|PROCESO Actualm0094;
     nAgra = 0;
     |ABRE #6;
     |SI #3#6  ! "S"; |Y #3#5 ! 0; |Y #3#5 = #0#1;
         enAct130 = #3#5;
         nCampo   = 9;
         |HAZ ParaCalMinor131;
     |FINSI;
     |SI #3#13 ! "S"; |Y #3#12 ! 0; |Y #3#12 = #0#1;
         enAct130 = #3#12;
         nCampo   = 16;
         |HAZ ParaCalMinor131;
     |FINSI;
     |SI #3#20 ! "S"; |Y #3#19 ! 0; |Y #3#20 = #0#1;
         enAct130 = #3#19;
         nCampo   = 23;
         |HAZ ParaCalMinor131;
     |FINSI;
     |SI #3#27 ! "S"; |Y #3#26 ! 0; |Y #3#26 = #0#1;
         enAct130 = #3#26;
         nCampo   = 30;
         |HAZ ParaCalMinor131;
     |FINSI;
     |SI #3#34 ! "S"; |Y #3#33 ! 0; |Y #3#33 = #0#1;
         enAct130 = #3#33;
         nCampo   = 37;
         |HAZ ParaCalMinor131;
     |FINSI;
     |CIERRA #6;
     |SI nAgra = 0;
         |BUCLE BuscoAgraria;
     |FINSI;
|FPRC;

|PROCESO Calculo131;
     |SI #3#1 ] 80;
         nEjer = 1900 + #3#1;
     |SINO;
         nEjer = 2000 + #3#1;
     |FINSI;

     #3#40 = 0;
     #3#60 = 0;
     |SI #3#6  ! "S";  #3#40 = #3#40 + #3#11;  #3#60 = #3#60 + #3#9;  |FINSI;
     |SI #3#13 ! "S";  #3#40 = #3#40 + #3#18;  #3#60 = #3#60 + #3#16; |FINSI;
     |SI #3#20 ! "S";  #3#40 = #3#40 + #3#25;  #3#60 = #3#60 + #3#23; |FINSI;
     |SI #3#27 ! "S";  #3#40 = #3#40 + #3#32;  #3#60 = #3#60 + #3#30; |FINSI;
     |SI #3#34 ! "S";  #3#40 = #3#40 + #3#39;  #3#60 = #3#60 + #3#37; |FINSI;

     |SI nEjer ] 2010; |HAZ Actualm0094; |FINSI;

     enMod130 = 131;
     enEmp130 = #3#0;
     enEje130 = #3#1;
     enPer130 = #3#2;
     enRend_NoAgr = #3#60;
     enRend_Agr   = #3#43;
     |HAZ eLeeAplica;

     #3#59 = 0;
     |SI nEjer = 2008; |Y eaAplica1 ! "N";
         |SI #3#2 = 2;  #3#59 = 200;  |FINSI;
         |SI #3#2 = 3;  #3#59 = 100;  |FINSI;
         |SI #3#2 = 4;  #3#59 = 100;  |FINSI;
     |FINSI;

     |SI nEjer = 2009; |Y eaAplica1 ! "N";
         |SI #3#2 = 1;  #3#59 = 100;  |FINSI;
         |SI #3#2 = 2;  #3#59 = 100;  |FINSI;
         |SI #3#2 = 3;  #3#59 = 100;  |FINSI;
         |SI #3#2 = 4;  #3#59 = 100;  |FINSI;
     |FINSI;

     |SI nEjer ] 2010; |Y eaAplica1 ! "N";
         #3#59 = enApli400;
     |FINSI;

     #3#61 = 0;
     |SI nEjer ] 2009; |Y eaAplica2 = "S";
         |SI #3#40 ! 0;
             #3#61 = (#3#60 % .5) + (#3#51 % 2);
         |SINO;
             #3#61 = #3#43 % 2;
         |FINSI;

         |HAZ CapturaTope;
         |SI enAplica3 = 0;
             nTope = 660.14 - nTope131;
         |SINO;
             nTope = 440 - nTope131;
         |FINSI;
         |SI nTope < 0;  nTope = 0;  |FINSI;
         |SI #3#61 > nTope;
             #3#61 = nTope;
         |FINSI;
     |FINSI;

||     #3#11 = #3#09 % #3#10;
||     #3#18 = #3#16 % #3#17;
||     #3#25 = #3#23 % #3#24;
||     #3#32 = #3#30 % #3#31;
||     #3#39 = #3#37 % #3#38;

     #3#40 = 0;
     |SI #3#6  ! "S";  #3#40 = #3#40 + #3#11;  |FINSI;
     |SI #3#13 ! "S";  #3#40 = #3#40 + #3#18;  |FINSI;
     |SI #3#20 ! "S";  #3#40 = #3#40 + #3#25;  |FINSI;
     |SI #3#27 ! "S";  #3#40 = #3#40 + #3#32;  |FINSI;
     |SI #3#34 ! "S";  #3#40 = #3#40 + #3#39;  |FINSI;

     #3#53 = #3#40 + #3#44 + #3#52;

     |SI nEjer [ 2006;
         #3#42 = #3#40 - #3#41;
         |SI #3#42 < 0;  #3#42 = 0;  |FINSI;
         |SI #0#205 = "S";  |Y #3#2 = 4;  |Y #3#1 = 2;
             #3#42 = #3#42 / 3;
         |FINSI;

         #3#44 = #3#43 % 2;
         #3#46 = #3#44 - #3#45;
         |SI #3#46 < 0;  #3#46 = 0;  |FINSI;

         #3#54 = #3#41 + #3#45;
         #3#55 = #3#53 - #3#54 - #3#59;
         #3#47 = #3#42 + #3#46;
     |SINO;
         #3#44 = #3#43 % 2;
         #3#52 = #3#51 % 2;

         |HAZ CalculaDed131;

         #3#57 = #3#55 - #3#56 - #3#61;
         #3#47 = #3#57 - #3#58;
     |FINSI;
|FPRC;

|| ****************************
|| PROCESOS BAJA DEL MODELO 131
|| ****************************

|PROCESO BajaMod;
  SwLeer = 1;

  #3#0 = #4#3;
  #3#1 = MAnyo;
  #3#2 = Periodo;
  |LIBERA #3;
  |LEE 140#3=;
  |SI FSalida !  0;  |ACABA;  |FINSI;

  SwEstar = 0;
  |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;
        Campo5 = Campo1 + 4;
        Campo6 = Campo1 + 5;
        Campo7 = Campo1 + 6;

        |SI #3Campo1 = #0#1;
            #3Campo1 = 0;
            #3Campo2 = "N";
            #3Campo3 = "";
            #3Campo4 = "";
            #3Campo5 = 0;
            #3Campo6 = 0;
            #3Campo7 = 0;
        |FINSI;
  |SIGUE;

  |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;

        |SI #3Campo1 ! 0;
             SwEstar = 1;
            |SAL;
        |FINSI;
  |SIGUE;

  |SI #3#43 ! 0;  |O  #3#44 ! 0;  |O  #3#45 ! 0;  |O  #3#46 ! 0;
      SwEstar = 1;
  |FINSI;

  |SI SwEstar = 1;
      |HAZ Calculo131;
      |GRABA 020#3a;
      |HAZ Segui131;
 |FINSI;

  |SI SwEstar = 0;
      |BORRA 140#3a;
  |FINSI;
|FPRC;

|DEFBUCLE eoscomulB;
  #4#1;
  ;
  #6#0, #6#1, #6#2, 001;
  #6#0, #6#1, #6#2, 999;
  ;
  NULL, BajaMod;
|FIN;

|PROCESO BorraComuneros;
  |ABRE #6

  |SELECT #2#6;
  #6#0 = #0#0;
  #6#1 = MActivi;
  #6#2 = #0#5;
  |LEE 040#6=;
  |SI FSalida = 0; |BUCLE eoscomulB; |FINSI;
  |CIERRA #6;
  |SELECT #1#6;
|FPRC;

|PROCESO Borra131;
  SwLeer = 1;
  SwEstar = 0;
  |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;
        Campo5 = Campo1 + 4;
        Campo6 = Campo1 + 5;
        Campo7 = Campo1 + 6;

        |SI #3Campo1 = #0#1;
            #3Campo1 = 0;
            #3Campo2 = "N";
            #3Campo3 = "";
            #3Campo4 = "";
            #3Campo5 = 0;
            #3Campo6 = 0;
            #3Campo7 = 0;
        |FINSI;
  |SIGUE;

  |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;

        |SI #3Campo1 ! 0;
             SwEstar = 1;
            |SAL;
        |FINSI;
  |SIGUE;

  |SI #3#43 ! 0;  |O  #3#44 ! 0;  |O  #3#45 ! 0;  |O  #3#46 ! 0;
      SwEstar = 1;
  |FINSI;

  |SI SwEstar = 1;
      |HAZ Calculo131;
      |GRABA 020#3a;
      |HAZ Segui131;
  |FINSI;

  |SI SwEstar = 0;
      |BORRA 140#3a;
  |FINSI;

  |HAZ BorraComuneros;
|FPRC;

|| ****************************
|| PROCESOS ALTA DEL MODELO 131
|| ****************************

|PROCESO GrabaComunero;
  #3#0 = #4#3;
  #3#1 = MAnyo;
  #3#2 = MPeriodo;
  |LIBERA #3;
  |LEE 110#3=;
  |SI FSalida = 0;
      SwEstar = 0;
      |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
            Campo2 = Campo1 + 1;
            Campo3 = Campo1 + 2;
            Campo4 = Campo1 + 3;
            Campo5 = Campo1 + 4;
            Campo6 = Campo1 + 5;
            Campo7 = Campo1 + 6;

            |SI #3Campo1 = #4#5;
                #3Campo2 = "C";
                #3Campo5 = REpigrafe % #4#6;
                #3Campo6 = PEpigrafe;
                #3Campo7 = #3Campo5 % #3Campo6;
                SwEstar = 1;
            |FINSI;
     |SIGUE;

     |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
           |SI SwEstar = 1; |SAL; |FINSI;

            Campo2 = Campo1 + 1;
            Campo3 = Campo1 + 2;
            Campo4 = Campo1 + 3;
            Campo5 = Campo1 + 4;
            Campo6 = Campo1 + 5;
            Campo7 = Campo1 + 6;

            |SI #3Campo1 = 0;
                #3Campo1 = #4#5;
                #3Campo2 = "C";
                #3Campo3 = LEpigrafe;
                #3Campo4 = NEpigrafe;
                #3Campo5 = REpigrafe % #4#6;
                #3Campo6 = PEpigrafe;
                #3Campo7 = #3Campo5 % #3Campo6;
                SwEstar = 1;
            |FINSI;
    |SIGUE;
    |HAZ Calculo131;
    |GRABA 140#3a;
    |LIBERA #3;

    |HAZ Segui131;
  |SINO;
     |DDEFECTO #3;
     #3#0  = #4#3;
     #3#1  = MAnyo;
     #3#2  = MPeriodo;
     #3#5  = #4#5;
     #3#6  = "C";
     #3#7  = LEpigrafe;
     #3#8  = NEpigrafe;
     #3#9  = REpigrafe % #4#6;
     #3#10 = PEpigrafe;
     #3#11 = #3#9 % #3#10;
     |HAZ Calculo131;
     |GRABA 140#3n;
     |LIBERA #3;

     |HAZ Segui131;
  |FINSI;
|FPRC;

|DEFBUCLE eoscomul;
  #4#1;
  ;
  #6#0, #6#1, #6#2, 001;
  #6#0, #6#1, #6#2, 999;
  ;
  NULL, GrabaComunero;
|FIN;

|PROCESO Comunidad;
  MEmpresa  = #3#0;
  MAnyo     = #3#1;
  MPeriodo  = #3#2;
  LEpigrafe = #3Campo3;
  NEpigrafe = #3Campo4;
  REpigrafe = #3Campo5;
  PEpigrafe = #3Campo6;
  CEpigrafe = #3Campo7;

  |ABRE #6;
  #6#0 = #0#0;
  #6#1 = MActivi;
  #6#2 = #0#5;
  |LEE 040#6=;
  |SI FSalida = 0; |BUCLE eoscomul; |FINSI;
  |CIERRA #6;

  #3#0 = MEmpresa;
  #3#1 = MAnyo;
  #3#2 = MPeriodo;
  |LIBERA #3;
  |LEE 140#3=;
|FPRC;

|PROCESO Actualiza131;
  SwEstar = 0;
  |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;
        Campo5 = Campo1 + 4;
        Campo6 = Campo1 + 5;
        Campo7 = Campo1 + 6;

        |SI #3Campo1 = #0#1;
            SwEstar    = 1;
            #3Campo2 = #0#190;
            |SI MTempor ! 0;
                #3Campo5 = (#0#114 / #0#128) * #0Dias;
            |SINO;
                #3Campo5 = #0#114 * (#0Dias / DiasT);
            |FINSI;
            #3Campo6 = #0#117;
            #3Campo7 = #3Campo5 % #3Campo6;
            |HAZ Calculo131;
            |GRABA 020#3a;
            |HAZ Segui131;
            |SAL;
       |FINSI;
  |SIGUE;

  |SI SwEstar = 0;
      SwEstar = 0;
      |PARA Campo1 = 5; |SI Campo1 [ 33; |HACIENDO Campo1 = Campo1 + 7;
            Campo2 = Campo1 + 1;
            Campo3 = Campo1 + 2;
            Campo4 = Campo1 + 3;
            Campo5 = Campo1 + 4;
            Campo6 = Campo1 + 5;
            Campo7 = Campo1 + 6;

            |SI #3Campo1  = 0;
                #3Campo1 = #0#1;
                #3Campo2 = #0#190;
                #3Campo3 = #0#2;
                #3Campo4 = #0#3;
                |SI MTempor ! 0;
                    #3Campo5 = (#0#114 / #0#128) * #0Dias;
                |SINO;
                    #3Campo5 = #0#114 * (#0Dias / DiasT);
                 |FINSI;
                #3Campo6 = #0#117;
                #3Campo7 = #3Campo5 % #3Campo6;
                |HAZ Calculo131;
                |GRABA 020#3a;
                |HAZ Segui131;
                |SAL;
            |FINSI;
      |SIGUE;
  |FINSI;

  |SI #3Campo2 = "S";  |HAZ Comunidad;  |FINSI;
|FPRC;

|PROCESO Nuevo131;
  Campo1 = 5;
  Campo2 = 6;
  Campo3 = 7;
  Campo4 = 8;
  Campo5 = 9;
  Campo6 = 10;
  Campo7 = 11;

  |DDEFECTO #3;
  #3#0     = #0#0;
  #3#1     = #0#5;
  #3#2     = Periodo;
  #3Campo1 = #0#1;
  #3Campo2 = #0#190;
  #3Campo3 = #0#2;
  #3Campo4 = #0#3;
  |SI MTempor ! 0;
      #3Campo5 = (#0#114 / #0#128) * #0Dias;
  |SINO;
      #3Campo5 = #0#114 * (#0Dias / DiasT);
  |FINSI;
  #3Campo6 = #0#117;
  #3Campo7 = #3Campo5 % #3Campo6;
  |HAZ Calculo131;
  |GRABA 140#3n;
  |LIBERA #3;

  |HAZ Segui131;
  |SI #3#6 = "S";  |HAZ Comunidad;  |FINSI;
|FPRC;

|| ***************************
|| DISTRIBUIDOR DEL MODELO 131
|| ***************************

|PROCESO Graba131;
  |ABRE #3;
  Periodo = 1;
  PFracci = 118;
  |PARA Dias = 129; |SI  Dias [ 132; |HACIENDO  Dias = Dias + 1;
        |SI Dias = 129;
            DiasT = 90;
            |SI #0#5 = 0;   |O #0#5 = 4;   |O #0#5 = 8;   |O #0#5 = 12;
             |O #0#5 = 16;  |O #0#5 = 20;  |O #0#5 = 24;  |O #0#5 = 28;
                DiasT = 91;
            |FINSI;
        |FINSI;
        |SI Dias = 130;  DiasT = 91;  |FINSI;
        |SI Dias = 131;  DiasT = 92;  |FINSI;
        |SI Dias = 132;  DiasT = 92;  |FINSI;

        |SI #0Dias = 0;
            #3#0 = #0#0;
            #3#1 = #0#5;
            #3#2 = Periodo;
            |LIBERA #3;
            |LEE 110#3=;
            |SI FSalida = 0;
                |SI #3#3 = "01.01.0000";  |HAZ Borra131;  |FINSI;
            |FINSI;
        |FINSI;

        ||SI #0Dias ! 0;  |Y #0PFracci ! 0;
        |SI #0Dias ! 0;
            #3#0 = #0#0;
            #3#1 = #0#5;
            #3#2 = Periodo;
            |LIBERA #3;
            |LEE 110#3=;
            |SI FSalida = 0;
                |SI #3#3 = "01.01.0000";
                    |SI MTipo = 1;  |HAZ Actualiza131;  |FINSI;
                    |SI MTipo = 2;  |HAZ Borra131;      |FINSI;
               |FINSI;
            |SINO;
               |SI MTipo = 1;  |HAZ Nuevo131;  |FINSI;
            |FINSI;
        |FINSI;
        Periodo = Periodo + 1;
        PFracci = PFracci + 1;
  |SIGUE;
  |CIERRA #3;
|FPRC;

|| *************************************************************************
|| ********************** GRABACION DEL MODELO 310 *************************
|| *************************************************************************

|PROCESO Segui310;
  se_empre = #2#0;
  se_ejerc = #2#1;
  se_perio = #2#2;
  se_tipos = 310;
  se_activ = 1;
  se_impor = 0;
  |SI #2#40 > 0; se_impor =  #2#40; |FINSI;
  |SI #2#41 > 0; se_impor = -#2#41; |FINSI;
  |SI #2#42 > 0; se_impor = -#2#42; |FINSI;
  se_fecha = #2#3;
  se_factu = "";
  |HAZ seguimie;
|FPRC;

|PROCESO Calculo310;
     #2#30 = #2#9  + #2#14 + #2#19 + #2#24 + #2#29;
     #2#44 = #2#30 - #2#43;
     #2#34 = #2#44 + #2#31 + #2#32 + #2#33;
     #2#46 = #2#35 + #2#45;
     #2#36 = #2#34 - #2#46;
     #2#38 = #2#36 - #2#37;

     Total = #2#38;
     |SI Total > 0;
         #2#40 = Total;   #2#41 = 0;   #2#42 = 0;
     |SINO;
         |SI #2#2 ! 4;
             #2#41 = Total * -1;  #2#40 = 0;  #2#42 = 0;
         |SINO;
              |SI #6#27 = "C";
                  #2#41 = Total * -1;  #2#40 = 0;  #2#42 = 0;
              |FINSI;

              |SI #6#27 = "D";
                  #2#42 = Total * -1;  #2#40 = 0;  #2#41 = 0;
              |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|| ******************
|| BORRADO MODELO 310
|| ******************

|PROCESO Borra310;
  SwLeer = 1;
  SwEstar = 0;
  |PARA Campo1 = 5; |SI Campo1 [ 25; |HACIENDO Campo1 = Campo1 + 5;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;
        Campo5 = Campo1 + 4;

        |SI #2Campo1 = #0#1;
            #2Campo1 = 0;
            #2Campo2 = "";
            #2Campo3 = "";
            #2Campo4 = "N";
            #2Campo5 = 0;
        |FINSI;
  |SIGUE;

  |PARA Campo1 = 5; |SI Campo1 [ 25; |HACIENDO Campo1 = Campo1 + 5;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;

        |SI #2Campo1 ! 0;
             SwEstar = 1;
            |SAL;
        |FINSI;
  |SIGUE;

  |SI SwEstar = 1;
      |HAZ Calculo310;
      |GRABA 020#2a;
      |HAZ Segui310;
  |FINSI;

  |SI SwEstar = 0;
      |BORRA 140#2a;
  |FINSI;
|FPRC;

|| ********************
|| GRABACION DEL MODELO
|| ********************

|PROCESO Del98;
     |DDEFECTO #2;
     #2#0    = LaEmpresa;
     #2#1    = ElAnyo;
     #2#2    = ElPeriodo;
     |LEE 040#2=;
     Compensar = 0;
     |SI FSalida = 0;  Compensar = #2#41;  |FINSI;

     nSuma = 0;
     |SI Periodo = 4;
         |PARA nPeriodo = 1;  |SI nPeriodo [ 3;  |HACIENDO nPeriodo = nPeriodo + 1;
               #2#0    = LaEmpresa;
               #2#1    = ElAnyo;
               #2#2    = nPeriodo;
               |LEE 040#2=;
               |SI FSalida = 0;  nSuma = nSuma + #2#44;  |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO EjerAnt; |TIPO 0;
  |SI #2#2 = 1;
      LaEmpresa = #2#0;
      ElPeriodo = 4;
      ElAnyo    = #2#1 - 1;
      |SI ElAnyo < 0;  ElAnyo = 99;  |FINSI;

      |SI #2#1 ] 0;  |Y #2#1 [ 80;
          |HAZ Del98;
      |SINO;
          |SI #2#1 > 98;  |HAZ Del98;  |FINSI;
      |FINSI;
  |SINO;
      LaEmpresa = #2#0;
      ElAnyo    = #2#1;
      ElPeriodo = #2#2 - 1;
      |HAZ Del98;
  |FINSI;
|FPRC;

|PROCESO Actualiza310;
  SwEstar = 0;
  |PARA Campo1 = 5; |SI Campo1 [ 25; |HACIENDO Campo1 = Campo1 + 5;
        Campo2 = Campo1 + 1;
        Campo3 = Campo1 + 2;
        Campo4 = Campo1 + 3;
        Campo5 = Campo1 + 4;

        |SI #2Campo1 = #0#1;
            SwEstar  = 1;
            #2Campo5 = #0PFracci;
            #2#43    = nSuma;
            #2#37    = Compensar;
            |HAZ Calculo310;
            |GRABA 020#2a;
            |HAZ Segui310;
            |SAL;
       |FINSI;
  |SIGUE;

  |SI SwEstar = 0;
      SwEstar = 0;
      |PARA Campo1 = 5; |SI Campo1 [ 25; |HACIENDO Campo1 = Campo1 + 5;
            Campo2 = Campo1 + 1;
            Campo3 = Campo1 + 2;
            Campo4 = Campo1 + 3;
            Campo5 = Campo1 + 4;

            |SI #2Campo1 = 0;
                #2Campo1 = #0#1;
                #2Campo2 = #0#2;
                #2Campo3 = #0#3;
                #2Campo4 = "N";
                #2Campo5 = #0PFracci;
                #2#43    = nSuma;
                #2#37    = Compensar;
                |HAZ Calculo310;
                |GRABA 020#2a;
                |HAZ Segui310;
                |SAL;
            |FINSI;
      |SIGUE;
  |FINSI;
|FPRC;

|PROCESO Nuevo310;
  Campo1 = 5;
  Campo2 = 6;
  Campo3 = 7;
  Campo4 = 8;
  Campo5 = 9;

  |DDEFECTO #2;
  #2#0     = #0#0;
  #2#1     = #0#5;
  #2#2     = Periodo;
  #2Campo1 = #0#1;
  #2Campo2 = #0#2;
  #2Campo3 = #0#3;
  #2Campo4 = "N";
  #2Campo5 = #0PFracci;
  #2#43    = nSuma;
  #2#37    = Compensar;
  |HAZ Calculo310;
  |GRABA 140#2n;
  |LIBERA #2;
  |HAZ Segui310;
|FPRC;

|| ***************************
|| DISTRIBUIDOR DEL MODELO 310
|| ***************************

|PROCESO Graba310_2013;
  |ABRE #2;
  Periodo = 1;
  PFracci = 124;
  |PARA Dias = 129; |SI  Dias [ 131; |HACIENDO  Dias = Dias + 1;
        |SI Dias = 129;
            DiasT = 90;
            |SI #0#5 = 0;   |O #0#5 = 4;   |O #0#5 = 8;   |O #0#5 = 12;
             |O #0#5 = 16;  |O #0#5 = 20;  |O #0#5 = 24;  |O #0#5 = 28;
                DiasT = 91;
            |FINSI;
        |FINSI;
        |SI Dias = 130;  DiasT = 91;  |FINSI;
        |SI Dias = 131;  DiasT = 92;  |FINSI;

        |SI #0Dias = 0;
            #2#0 = #0#0;
            #2#1 = #0#5;
            #2#2 = Periodo;
            |LIBERA #2;
            |LEE 110#2=;
            |SI FSalida = 0;
                |SI #2#3 = "01.01.0000";
                    |HAZ Borra310;
                |FINSI;
            |FINSI;
        |FINSI;

        |SI #0Dias ! 0;  |Y #0PFracci ! 0;
            #2#0 = #0#0;
            #2#1 = #0#5;
            #2#2 = Periodo;
            |HAZ EjerAnt;

            #2#0 = #0#0;
            #2#1 = #0#5;
            #2#2 = Periodo;
            |LIBERA #2;
            |LEE 110#2=;
            |SI FSalida = 0;
               |SI #2#3 = "01.01.0000";
                   |SI MTipo = 1;  |HAZ Actualiza310;  |FINSI;
                   |SI MTipo = 2;  |HAZ Borra310;      |FINSI;
               |FINSI;
            |SINO;
               |SI MTipo = 1;  |HAZ Nuevo310;  |FINSI;
            |FINSI;
        |FINSI;
        Periodo = Periodo + 1;
        PFracci = PFracci + 1;
  |SIGUE;

  Periodo = 4;
  PFracci = 127;
  |SI #0#127 = 0;
      #2#0 = #0#0;
      #2#1 = #0#5;
      #2#2 = Periodo;
      |LIBERA #2;
      |LEE 110#2=;
      |SI FSalida = 0;
          |SI #2#3 = "01.01.0000";
              |HAZ Borra310;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI #0#127 ! 0;
      #2#0 = #0#0;
      #2#1 = #0#5;
      #2#2 = Periodo;
      |HAZ EjerAnt;

      #2#0 = #0#0;
      #2#1 = #0#5;
      #2#2 = Periodo;
      |LIBERA #2;
      |LEE 110#2=;
      |SI FSalida = 0;
          |SI #2#3 = "01.01.0000";
              |SI MTipo = 1;  |HAZ Actualiza310;  |FINSI;
              |SI MTipo = 2;  |HAZ Borra310;      |FINSI;
          |FINSI;
      |SINO;
          |SI MTipo = 1;  |HAZ Nuevo310;  |FINSI;
      |FINSI;
  |FINSI;
  |CIERRA #2;
|FPRC;

|PROCESO CreaDSMOM004;
     |DDEFECTO #dsmom004;
     #dsmom004#0  = enEmpresa;
     #dsmom004#1  = enEjer;
     #dsmom004#2  = enPeriodo;
     #dsmom004#3  = 303;
     #dsmom004#4  = 00;
     #dsmom004#17 = "SIN DATOS";
     #dsmom004#26 = #eosm0017#7;

     |GRABA 020#dsmom004.n;
     |LIBERA #dsmom004;

     #dsmom008#0  = #dsmom004#0;
     #dsmom008#1  = #dsmom004#1;
     #dsmom008#2  = #dsmom004#2;
     #dsmom008#3  = #dsmom004#3;
     #dsmom008#4  = #dsmom004#4;
     #dsmom008#5  = 0;
     #dsmom008#6  = "REGISTRO DE IMPRESION";
     aAlfa        = "REGISTRO DEL MODELO 303 EJERCICIO " + #dsmom008#1;
     aAlfa        = aAlfa + " PERIODO " + (("00" + #dsmom008#2) % -102);
     #dsmom008#8  = aAlfa;
     #dsmom008#11 = "SIN DATOS";

     #dsmom008#12 = 303;
     #dsmom008#13 = "N";

     |GRABA 020#dsmom008.n;
     |LIBERA #dsmom008;
|FPRC;

|PROCESO CreaDSMOM008;
     #dsmom008#0  = #dsmom004#0;
     #dsmom008#1  = #dsmom004#1;
     #dsmom008#2  = #dsmom004#2;
     #dsmom008#3  = #dsmom004#3;
     #dsmom008#4  = #dsmom004#4;
     #dsmom008#5  = enActividad;
     #dsmom008#6  = #eosactiv#6;
     aAlfa        = "REGISTRO DEL MODELO 303 EJERCICIO " + #dsmom008#1;
     aAlfa        = aAlfa + " PERIODO " + (("00" + #dsmom008#2) % -102);
     #dsmom008#8  = aAlfa;
     #dsmom008#11 = "SIN DATOS";

     #dsmom008#12 = 310;
     #dsmom008#7  = "modulos";
     #dsmom008#13 = "N";

     |GRABA 020#dsmom008.n;
     |LIBERA #dsmom008;
|FPRC;

|PROCESO GrabaTrabajo310;
     |ABRE #dsmom004;
     |ABRE #dsmom008;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;
         |HAZ CreaDSMOM004;
     |FINSI;

     #dsmom008#0 = enEmpresa;
     #dsmom008#1 = enEjer;
     #dsmom008#2 = enPeriodo;
     #dsmom008#3 = 303;
     #dsmom008#4 = 0;
     #dsmom008#5 = enActividad;
     |LEE 040#dsmom008.=;
     |SI FSalida ! 0;
         |HAZ CreaDSMOM008;
     |FINSI;
     |CIERRA #dsmom004;
     |CIERRA #dsmom008;

     |ABRE #dsmoc310;
     #dsmoc310#0 = enEmpresa;
     #dsmoc310#1 = enEjer;
     #dsmoc310#2 = enPeriodo;
     #dsmoc310#3 = 303;
     #dsmoc310#4 = 0;
     #dsmoc310#5 = enActividad;
     |LEE 101#dsmoc310.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmoc310;
         #dsmoc310#0 = enEmpresa;
         #dsmoc310#1 = enEjer;
         #dsmoc310#2 = enPeriodo;
         #dsmoc310#3 = 303;
         #dsmoc310#4 = 0;
         #dsmoc310#5 = enActividad;
         |GRABA 020#dsmoc310.b;
     |FINSI;

     #dsmoc310#6 = #eosm0017#3;
     #dsmoc310#7 = #eosm0017#6;
     #dsmoc310#8 = "N";
     #dsmoc310#9 = nImporte;
     |GRABA 020#dsmoc310.a;
     |LIBERA #dsmoc310;
     |CIERRA #dsmoc310;

     enTipoEntrada = 98;
     enModelo      = 303;
     enComplem     = 0;
     |SUB_EJECUTA_NP "dsmoc310";

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 101#dsmom004.=;
     |SI FSalida = 0;
         |HAZ ChequeaSituacion;

         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;
|FPRC;

|PROCESO Baja310;
     |ABRE #dsmoc310;
     #dsmoc310#0 = enEmpresa;
     #dsmoc310#1 = enEjer;
     #dsmoc310#2 = enPeriodo;
     #dsmoc310#3 = 303;
     #dsmoc310#4 = 0;
     #dsmoc310#5 = enActividad;
     |LEE 101#dsmoc310.=;
     |SI FSalida = 0;
         nBorra      = 1;
         #dsmoc310#9 = 0;
         |PARA nCampo = 9;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
               |SI #dsmoc310#nCampo# ! 0;
                   nBorra = 0;
                   |SAL;
               |FINSI;
         |SIGUE;

         |SI nBorra = 1;
             |BORRA 020#dsmoc310.a;
         |SINO;
             |GRABA 020#dsmoc310.a;
         |FINSI;
         |LIBERA #dsmoc310;
     |FINSI;
     |CIERRA #dsmoc310;

     |ABRE #dsmom008;
     #dsmom008#0 = enEmpresa;
     #dsmom008#1 = enEjer;
     #dsmom008#2 = enPeriodo;
     #dsmom008#3 = 303;
     #dsmom008#4 = 0;
     #dsmom008#5 = enActividad;
     |LEE 101#dsmom008.=;
     |SI FSalida = 0;
         #dsmom008#11 = "SIN DATOS";
         |GRABA 020#dsmom008.a;
         |LIBERA #dsmom008;
     |FINSI;
     |CIERRA #dsmom008;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 101#dsmom004.=;
     |SI FSalida = 0;
         |HAZ ChequeaSituacion;

         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;
|FPRC;

|PROCESO Graba310_2014;
     |ABRE #eosactiv;
     #eosactiv#0 = enEmpresa;
     #eosactiv#1 = enActividad;
     #eosactiv#2 = enEjer - 2000;
     |LEE 000#eosactiv.=;
     |CIERRA #eosactiv;

     nNume1 = enPeriodo;

     |ABRE #dsmoc310;
     |SI #eosm0017#129 ! 0;
         |SI #eosm0017#195 = "N";
             enPeriodo = 3;
             nImporte  = #eosm0017#124;
             |HAZ GrabaTrabajo310;
         |FINSI;
     |SINO;
         enPeriodo = 3;
         nPer      = 3;
         |HAZ Baja310;
     |FINSI;

     |SI #eosm0017#130 ! 0;
         |SI #eosm0017#196 = "N";
             enPeriodo = 6;
             nImporte  = #eosm0017#125;
             |HAZ GrabaTrabajo310;
         |FINSI;
     |SINO;
         enPeriodo = 6;
         nPer = 6;
         |HAZ Baja310;
     |FINSI;

     |SI #eosm0017#131 ! 0;
         |SI #eosm0017#197 = "N";
             enPeriodo = 9;
             nImporte  = #eosm0017#126;
             |HAZ GrabaTrabajo310;
         |FINSI;
     |SINO;
         enPeriodo = 9;
         nPer = 9;
         |HAZ Baja310;
     |FINSI;

     |SI #eosm0017#133 ! 0;
         |SI #eosm0017#198 = "N";
             enPeriodo = 12;
             nImporte  = #eosm0017#127;
             |HAZ GrabaTrabajo310;
         |FINSI;
     |SINO;
         enPeriodo = 12;
         nPer = 12;
         |HAZ Baja310;
     |FINSI;
     |CIERRA #dsmoc310;

     enPeriodo = nNume1;
|FPRC;

|PROCESO Graba310;
     |SI enEjer = 0;
         |HAZ Graba310_2013;
     |SINO;
         |HAZ Graba310_2014;
     |FINSI;
|FPRC;

||  ************************************************************************
||  ********************* CALCULOS PARA GRABAR EL 131 Y 310 ****************
||  ************************************************************************

|PROGRAMA;
     |ABRE #0;
     #0#0  = MEmpresa;
     #0#1  = MActivi;
     #0#5  = MAnyo;
     |LIBERA #0;
     |LEE 140#0=;
     |SI FSalida ! 0;  |CIERRA #0;  |ACABA;  |FINSI;
     |CIERRA #0;

     Modelo = "131";
     |HAZ Graba131;     || Graba Modelo 131

     |ABRE #6;
     #6#0 = MEmpresa;
     #6#1 = MActivi;
     #6#2 = MAnyo;
     |LEE 040#6=;
     |SI #6#26 = "N";
         SwBorra = 0;
         |CIERRA  #6;
         |ACABA;
     |FINSI;
     |CIERRA #6;

     Modelo = "310";
     |HAZ Graba310;     || Graba Modelo 310
|FPRO;
