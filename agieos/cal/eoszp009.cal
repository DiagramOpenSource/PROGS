|FICHEROS;
     eoscabve #1;
     eoslinve #3;
     eoscabco #5;
     eoslinco #7;
     eosclpre #9;
     eosactiv #90;
     eosconce #91;
     eosclien #95;
|FIN;

|VARIABLES;
    aAlfa       = "";
    Fichero     = "";
    VarAnyo     = "";
    EsRetencion = "";
    Empresa     = "";
    Ejercicio   = "";
    Caracter    = "";
    Directorio  = "";
    Origen      = "";
|FIN;

|PROCESO LeeCliente;
     |ABRE #95;
     #95#0 = Empresa;
     |LEE 040#95=;
     |SI FSalida ! 0; |DDEFECTO #95; |FINSI;
     |CIERRA #95;
|FPRC;

****************************************************************************
      LECTURA Y GRABACION
****************************************************************************

|PROCESO LineasVentas;
     #90#0 = #1#0;
     #90#1 = #3#19;
     #90#2 = #1#4;
     |LEE 040#90=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #91#0 = #3#5;
     |LEE 040#91=;
     |SI FSalida = 0; |Y #91#3 = "I";
         #3#22 = #3#7 + #3#9 + #3#11 - #3#42;

         #1#5 = #1#5 + #3#7;
         #1#6 = #1#6 + #3#9;
         #1#7 = #1#7 + #3#11;
         #1#9 = #1#9 + #3#42;
     |FINSI;

     #91#0 = #3#33;
     |LEE 040#91=;
     |SI FSalida = 0; |Y #91#3 = "I";
         #3#22 = #3#22 + #3#23 + #3#27 + #3#31 - #3#43;

         #1#5 = #1#5 + #3#23;
         #1#6 = #1#6 + #3#27;
         #1#7 = #1#7 + #3#31;
         #1#9 = #1#9 + #3#43;
     |FINSI;

     #91#0 = #3#34;
     |LEE 040#91=;
     |SI FSalida = 0; |Y #91#3 = "I";
         #3#22 = #3#22 + #3#24 + #3#28 + #3#32 - #3#44;

         #1#5 = #1#5 + #3#24;
         #1#6 = #1#6 + #3#28;
         #1#7 = #1#7 + #3#32;
         #1#9 = #1#9 + #3#44;
     |FINSI;

     #1#8 = #1#5 + #1#6 + #1#7 - #1#9;
|FPRC;

|DEFBUCLE eoslinve;
     #3#1;
     ;
     #1#0, #1#4, 00000;
     #1#0, #1#4, 32000;
     be;
     NULL, LineasVentas;
|FIN;

|PROCESO Ventas;
     Fichero = #1#0;
     Fichero = ("00000" + Fichero) % -105;
     VarAnyo = #1#4;
     VarAnyo = ("00" + VarAnyo) % -102;
     Fichero = "v" + Fichero + VarAnyo;
     |NOME_DAT #3 Fichero;

     #1#5 = 0;  #1#6 = 0;  #1#7 = 0;
     #1#8 = 0;  #1#9 = 0;

     |BUCLE eoslinve;

     |GRABA 020#1a;
     |LIBERA #1;
|FPRC;

|DEFBUCLE eoscabve;
     #1#1;
     ;
     00000, 00;
     99999, 99;
     be;
     NULL, Ventas;
|FIN;

|PROCESO Proceso1;
     |ABRE #1;
     |DFICE Directorio;  |QBF Directorio;
     Origen = Directorio + "*.dat";
     |_PDIR Origen;
     |PARA; |SI FSalida = 0; |HACIENDO;
            |QBF Origen;
            Fichero  = Origen % -112;
            Fichero  = Fichero % 108;
            Caracter = Fichero % 101;
            |PINTA 1625, Fichero;

            |SI Caracter = "v";  |O Caracter = "V";
                |PINTA 1649, Fichero;

                |NOME_DAT #3 Fichero;
                |ABRE #3;
                |LEE 040#3p;
                |SI FSalida ! 0;
                    |CIERRA #3;
                    |DELINDEX #3;
                    |VETE FinV;
                |FINSI;
                |CIERRA #3;

                Empresa   = Fichero % 205;
                Ejercicio = Fichero % -102;
                |HAZ LeeCliente;
                #1#0 = Empresa;
                #1#1 = #95#2;
                #1#2 = #95#1;
                #1#3 = 1;
                #1#4 = Ejercicio;
                |GRABA 020#1n;
                |LIBERA #1;

                |ET FinV;

            |FINSI;
            |_SDIR Origen;
     |SIGUE;
     |CIERRA #1;

     |BUCLE eoscabve;
|FPRC;

|PROCESO LineasCompras;
     #90#0 = #5#0;
     #90#1 = #7#19;
     #90#2 = #5#4;
     |LEE 040#90=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #91#0 = #7#5;
     |LEE 040#91=;
     |SI FSalida = 0;
         |SI #91#9 = 1;
             #7#42 = #7#7 % #7#39;
         |SINO;
             #7#42 = (#7#7 + #7#9) % #7#39;
         |FINSI;
         #7#22 = #7#7 + #7#9 + #7#11 - #7#42;

         #5#5 = #5#5 + #7#7;
         #5#6 = #5#6 + #7#9;
         #5#7 = #5#7 + #7#11;
         #5#9 = #5#9 + #7#42;
     |FINSI;

     #91#0 = #7#33;
     |LEE 040#91=;
     |SI FSalida = 0;
         #5#5 = #5#5 + #7#23;
         #5#6 = #5#6 + #7#27;
         #5#7 = #5#7 + #7#31;
         #5#9 = #5#9 + #7#43;

         |SI #91#9 = 1;
             #7#43 = #7#23 % #7#40;
         |SINO;
             #7#43 = (#7#23 + #7#27) % #7#40;
         |FINSI;
         #7#22 = #7#22 + #7#23 + #7#27+ #7#31 - #7#43;
     |FINSI;

     #91#0 = #7#34;
     |LEE 040#91=;
     |SI FSalida = 0;
         |SI #91#9 = 1;
             #7#44 = #7#24 % #7#41;
         |SINO;
             #7#44 = (#7#24 + #7#28) % #7#41;
         |FINSI;
         #7#22 = #7#22 + #7#24 + #7#28+ #7#32 - #7#44;

         #5#5 = #5#5 + #7#24;
         #5#6 = #5#6 + #7#28;
         #5#7 = #5#7 + #7#32;
         #5#9 = #5#9 + #7#44;
     |FINSI;

     #5#8 = #5#5 + #5#6 + #5#7 - #5#9;
|FPRC;

|DEFBUCLE eoslinco;
     #7#1;
     ;
     #5#0, #5#4, 00000;
     #5#0, #5#4, 32000;
     be;
     NULL, LineasCompras;
|FIN;

|PROCESO Compras;
     Fichero = #5#0;
     Fichero = ("00000" + Fichero) % -105;
     VarAnyo = #5#4;
     VarAnyo = ("00" + VarAnyo) % -102;
     Fichero = "c" + Fichero + VarAnyo;
     |NOME_DAT #7 Fichero;

     #5#5 = 0;  #5#6 = 0;  #5#7 = 0;
     #5#8 = 0;  #5#9 = 0;

     |BUCLE eoslinco;

     |GRABA 020#5a;
     |LIBERA #5;
|FPRC;

|DEFBUCLE eoscabco;
     #5#1;
     ;
     00000, 00;
     99999, 99;
     be;
     NULL, Compras;
|FIN;

|PROCESO Proceso2;
     |ABRE #5;
     |DFICE Directorio;  |QBF Directorio;
     Origen = Directorio + "*.dat";
     |_PDIR Origen;
     |PARA; |SI FSalida = 0; |HACIENDO;
            |QBF Origen;
            Fichero  = Origen % -112;
            Fichero  = Fichero % 108;
            Caracter = Fichero % 101;
            |PINTA 1625, Fichero;

            |SI Caracter = "c";  |O Caracter = "C";
                |PINTA 1649, Fichero;

                |NOME_DAT #7 Fichero;
                |ABRE #7;
                |LEE 040#7p;
                |SI FSalida ! 0;
                    |CIERRA #7;
                    |DELINDEX #7;
                    |VETE FinC;
                |FINSI;
                |CIERRA #7;

                Empresa   = Fichero % 205;
                Ejercicio = Fichero % -102;
                |HAZ LeeCliente;
                #5#0 = Empresa;
                #5#1 = #95#2;
                #5#2 = #95#1;
                #5#3 = 2;
                #5#4 = Ejercicio;
                |GRABA 020#5n;
                |LIBERA #5;

                |ET FinC;

            |FINSI;
            |_SDIR Origen;
     |SIGUE;
     |CIERRA #5;

     |BUCLE eoscabco;
|FPRC;

|PROCESO MiraActi;
     EsRetencion = #90#17;
|FPRC;

|DEFBUCLE eosactiv;
     #90#1;
     ;
     #9#0, 1, 00;
     #9#0, 1, 99;
     ;
     NULL, MiraActi;
|FIN;

|PROCESO GrabaPorce;
     EsRetencion = "";
     |BUCLE eosactiv;

     |SI EsRetencion ! "T"; |ACABA; |FINSI;

     |SI #9#15 ! 0; |Y #9#22 = 0;
         #9#22 = #9#15;
         #9#15 = 0;
         |GRABA 020#9a;
         |LIBERA #9;
     |FINSI;
|FPRC;

|DEFBUCLE eosclpre;
     #9#1;
     ;
     00000, 1, 00000;
     99999, 9, 99999;
     be;
     NULL, GrabaPorce;
|FIN;

|PROCESO Proceso3;
     |BUCLE eosclpre;
|FPRC;

****************************************************************************
      INICIO DE PROCESO
****************************************************************************

|PROCESO Tipo3; |TIPO 3;
     |ABRE #1;  |CIERRA #1;  |DELINDEX #1;
     |ABRE #5;  |CIERRA #5;  |DELINDEX #5;

     |ABRE #90;
     |ABRE #91;
     |HAZ Proceso1;
     |HAZ Proceso2;
     |CIERRA #90;
     |CIERRA #91;

     |HAZ Proceso3;
|FPRC;
