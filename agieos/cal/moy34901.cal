|FICHEROS;
     dsmoy000;
     dsmoy349;
     eosclien;

     eos349ca;
     eos349li;

     dsmow538;
     dsmow539;
|FIN;

|VARIABLES;
     nCampo       = 0;
     nHandle1     = 0;
     nHandle2     = 0;
     nAnyo        = 0;
     nDEmpresa    = 0;
     nHEmpresa    = 0;
     nEjer        = 0;
     nBoton       = 0;
     nBoton1      = 0;
     nBoton2      = 0;
     nBoton3      = 0;

     nOk           = 0;
     aAlfa         = "";
     aAbre         = "";
     aPathLanza    = "";
     aPathEmision  = "";
     aPathInternet = "";
     aF2           = "";
     aF3           = "";
     aF4           = "";
     aEsc          = "";
     aTecla        = "";
     aPathAfegir   = "";
     aPathInter    = "";
     aBue          = "";
     aNombre       = "";
     aOrigen       = "";
     aDestino      = "";
     aFichero      = "";
     aIPRemoto     = "";
     nHasta        = 0;

     fFecha        = @;

     &eaFOrigen    = "";
     &eaFDestino   = "";
     &eaTipoE      = "";
     &eaTipoR      = "";
     &eaTipoV      = "";
     &enCalcCif    = 0;
     &eaVarDni     = "";
     &eaAlfa       = "";
     &enNume       = 0;
     &eaFichError  = "";
     &eaFichDatos  = "";
     &eaFichAuxil  = "";
     &enValidacion = 0;
     &enBuenos     = 0;
     &enMalos      = 0;

     &eaUnidad           = "";
     &eaModelos          = "";
     &enAnyo             = 0;
     &eaEjer             = "";
     &eaPeriodo          = "";
     &eaFicheroPlano     = "";
     &eaOpcion           = "";
     &enErrorPortal      = 0;
     &eaFicheroImpre     = "";
     &eaFicheroSalid     = "";
     &eaFicheroError     = "";
     &enEmpresa          = 0;
     &eaNomEmpresa       = "";
     &eaPathLanza        = "";
     &eaPathEjecu        = "";
     &eaPathEmision      = "";
     &eaPathInternet     = "";
     &enPresentar        = 0;
     &enTecla            = 0;
|FIN;

|PROCESO Registro1_2018;
     #eosclien#0 = #eos349ca#0;
     |LEE 000#eosclien.=;
     |SI FSalida ! 0;  |DDEFECTO #eosclien;  |FINSI;

     |DDEFECTO #dsmow538;

     #dsmow538#0   = "1";

     #dsmow538#1   = "349";

     #dsmow538#2   = #dsmoy349#41;

     enCalcCif = 3;
     eaVarDni  = #eosclien#1;  |HAZ CalculoDNI;
     #dsmow538#3    = eaVarDni;

     eaAlfa   = #eosclien#2;   |HAZ QuitaRaros;
     #dsmow538#4   = eaAlfa;

     |SI #dsmow538#2 < 2020;
         #dsmow538#5   = "T";
     |FINSI;

     eaAlfa   = #eosclien#14;  |HAZ QuitaRarosTfno;
     #dsmow538#6   = eaAlfa;

     eaAlfa   = #eosclien#2;   |HAZ QuitaRaros;
     #dsmow538#7   = eaAlfa;

     #dsmow538#8   = "3490000000000";

     |SI #eos349ca#16 = "C";
         #dsmow538#9 = "C";
         #dsmow538#11 = #eos349ca#17;
     |FINSI;

     |SI #eos349ca#16 = "S";
         #dsmow538#10 = "S";
         #dsmow538#11 = #eos349ca#17;
     |FINSI;

     |SI #eos349ca#18 = "M";
         #dsmow538#12 = (("00" + #eos349ca#1) % -102);

         |SI #eos349ca#19 = "S";   #dsmow538#17 = "X";  |FINSI;
     |FINSI;

     |SI #eos349ca#18 = "T";
         |SI #eos349ca#1 = 1;   #dsmow538#12 = "1T";  |FINSI;
         |SI #eos349ca#1 = 2;   #dsmow538#12 = "2T";  |FINSI;
         |SI #eos349ca#1 = 3;   #dsmow538#12 = "3T";  |FINSI;
         |SI #eos349ca#1 = 4;   #dsmow538#12 = "4T";  |FINSI;
     |FINSI;

     |SI #eos349ca#18 = "A";
         #dsmow538#12 = "0A";
     |FINSI;

     enNume   = #eos349ca#6 + #eos349ca#8;
     #dsmow538#13  = ("000000000" + enNume) % -109;

     enNume   = #eos349ca#7 + #eos349ca#9;  |HAZ Conver15;
     #dsmow538#14  = eaAlfa;

     enNume   = #eos349ca#10 + #eos349ca#11;
     #dsmow538#15  = ("000000000" + enNume) % -109;

     enNume   = #eos349ca#14 + #eos349ca#15;  |HAZ Conver15;
     #dsmow538#16  = eaAlfa;

     #dsmow538#21  = &13 + &10;

                          nHasta = 20;
     |SI eaOpcion = "3";  nHasta = 21;  |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHasta;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #dsmow538#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO Registro2_2018;
     |DDEFECTO #dsmow539;

     #dsmow539#0  = "2";

     #dsmow539#1  = "349";

     #dsmow539#2  = #dsmow538#2;
     #dsmow539#3  = #dsmow538#3;
     #dsmow539#4  = "";

     #dsmow539#5  = #eos349li#5;
     |SI #eos349li#5 = "GR ";  #dsmow539#5 = "EL";  |FINSI;

     #dsmow539#6  = #eos349li#6;

     #dsmow539#7  = #eos349li#7;

     |SI #eos349li#4  = "A";  #dsmow539#8 = "A";  |FINSI;
     |SI #eos349li#4  = "E";  #dsmow539#8 = "E";  |FINSI;
     |SI #eos349li#4  = "I";  #dsmow539#8 = "I";  |FINSI;
     |SI #eos349li#4  = "S";  #dsmow539#8 = "S";  |FINSI;
     |SI #eos349li#4  = "M";  #dsmow539#8 = "M";  |FINSI;
     |SI #eos349li#4  = "H";  #dsmow539#8 = "H";  |FINSI;

     |SI #eos349li#4  = "X";  #dsmow539#8 = "A";  |FINSI;
     |SI #eos349li#4  = "Y";  #dsmow539#8 = "I";  |FINSI;
     |SI #eos349li#4  = "Z";  #dsmow539#8 = "S";  |FINSI;
     |SI #eos349li#4  = "W";  #dsmow539#8 = "M";  |FINSI;
     |SI #eos349li#4  = "V";  #dsmow539#8 = "H";  |FINSI;

     |SI #dsmow539#2 ] 2020;
         |SI #eos349li#4  = "U";  #dsmow539#8 = "E";  |FINSI;
         |SI #eos349li#4  = "R";  #dsmow539#8 = "R";  |FINSI;
         |SI #eos349li#4  = "T";  #dsmow539#8 = "R";  |FINSI;
         |SI #eos349li#4  = "D";  #dsmow539#8 = "D";  |FINSI;
         |SI #eos349li#4  = "Q";  #dsmow539#8 = "D";  |FINSI;
         |SI #eos349li#4  = "C";  #dsmow539#8 = "C";  |FINSI;
         |SI #eos349li#4  = "P";  #dsmow539#8 = "C";  |FINSI;
     |SINO;
         |SI #eos349li#4  = "R";  #dsmow539#8 = "E";  |FINSI;
     |FINSI;

     |SI #eos349li#13 = "X";  #dsmow539#8 = "T";  |FINSI;

     nOk = 0;
     |SI #dsmow539#2 ] 2020;
         |SI #eos349li#4 = "A";  |O #eos349li#4 = "E";  |O #eos349li#4 = "S";  |O #eos349li#4 = "I"; |O #eos349li#4 = "M";
            |O #eos349li#4 = "H"; |O #eos349li#4 = "R";  |O #eos349li#4 = "D";  |O #eos349li#4 = "C";
             nOk = 1;
         |FINSI;
     |SINO;
         |SI #eos349li#4 = "A";  |O #eos349li#4 = "E";  |O #eos349li#4 = "S";  |O #eos349li#4 = "I"; |O #eos349li#4 = "M"; |O #eos349li#4 = "H";
             nOk = 1;
        |FINSI;
     |FINSI;

     |SI nOk = 1;
         enNume = #eos349li#8;   |HAZ Conver13;
         #dsmow539#9 = eaAlfa;

         #dsmow539#10 = "";

         #dsmow539#11 = "";

         #dsmow539#12 = "";

         #dsmow539#13 = "";
     |SINO;
         #dsmow539#9  = "";

         nEjer   = 2000  + #eos349li#11;
         #dsmow539#10 = nEjer;

         |SI #eos349li#12 = 0;   #dsmow539#11 = "0A";   |FINSI;
         |SI #eos349li#12 = 1;   #dsmow539#11 = "1T";   |FINSI;
         |SI #eos349li#12 = 2;   #dsmow539#11 = "2T";   |FINSI;
         |SI #eos349li#12 = 3;   #dsmow539#11 = "3T";   |FINSI;
         |SI #eos349li#12 = 4;   #dsmow539#11 = "4T";   |FINSI;
         |SI #eos349li#12 = 11;  #dsmow539#11 = "01";   |FINSI;
         |SI #eos349li#12 = 12;  #dsmow539#11 = "02";   |FINSI;
         |SI #eos349li#12 = 13;  #dsmow539#11 = "03";   |FINSI;
         |SI #eos349li#12 = 14;  #dsmow539#11 = "04";   |FINSI;
         |SI #eos349li#12 = 15;  #dsmow539#11 = "05";   |FINSI;
         |SI #eos349li#12 = 16;  #dsmow539#11 = "06";   |FINSI;
         |SI #eos349li#12 = 17;  #dsmow539#11 = "07";   |FINSI;
         |SI #eos349li#12 = 18;  #dsmow539#11 = "08";   |FINSI;
         |SI #eos349li#12 = 19;  #dsmow539#11 = "09";   |FINSI;
         |SI #eos349li#12 = 20;  #dsmow539#11 = "10";   |FINSI;
         |SI #eos349li#12 = 21;  #dsmow539#11 = "11";   |FINSI;
         |SI #eos349li#12 = 22;  #dsmow539#11 = "12";   |FINSI;

         enNume = #eos349li#8;   |HAZ Conver13;
         #dsmow539#12  = eaAlfa;

         enNume = #eos349li#28;  |HAZ Conver13;
         #dsmow539#13  = eaAlfa;
     |FINSI;

     |SI #dsmow539#2 ] 2020; |Y #dsmow539#8 = "C";
         #dsmow539#14 = #eos349li#29;
         |SI #eos349li#29 = "GR ";  #dsmow539#14 = "EL";  |FINSI;

         #dsmow539#15  = #eos349li#30;

         #dsmow539#16  = #eos349li#31;

     |FINSI;

     #dsmow539#19 = &13 + &10;

                          nHasta = 18;
     |SI eaOpcion = "3";  nHasta = 19;  |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHasta;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #dsmow539#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|DEFBUCLE eos349li_2018;
     #eos349li#1;
     ;
     #eos349ca#0, #eos349ca#2, #eos349ca#1, 001;
     #eos349ca#0, #eos349ca#2, #eos349ca#1, 999;
     ;
     NULL, Registro2_2018;
|FIN;

|PROCESO eos349ca_2018;
     eaFicheroPlano = "349" + (("00000" + #eos349ca#0) % -105) + ".txt";
     eaFicheroImpre = "349" + (("00000" + #eos349ca#0) % -105) + ".imp";
     eaFicheroSalid = "349" + (("00000" + #eos349ca#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #eos349ca#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Registro1_2018;

     |BUCLE eos349li_2018;

     |XCIERRA nHandle2;

     enEmpresa    = #eosclien#0;
     eaNomEmpresa = #eosclien#2;

     |HAZ PresentaPortal;
|FPRC;

|DEFBUCLE eos349ca_2018;
     #eos349ca#1;
     18, 5;
     nDEmpresa, nAnyo, #dsmoy349#39, #dsmoy349#40, "N";
     nHEmpresa, nAnyo, #dsmoy349#39, #dsmoy349#40, "N";
     be;
     NULL, eos349ca_2018;
|FIN;

|PROCESO Botones349_2018;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Presentacion Telematica      ", 0513, 0654, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Borrador con validacion ", 0813, 0954, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton3 = FSalida;

     aF2  = &255 + "824";
     aF3  = &255 + "825";
     aEsc = &255 + "806";

     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;

         |SI aTecla = aF2;  eaOpcion = "3"; |SAL;  |FINSI;
         |SI aTecla = aF3;  eaOpcion = "1"; |SAL;  |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;

                          enTecla = 0;
     |SI eaOpcion = "1";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "3";  enTecla = 3;  |FINSI;

     |PULSATECLA;
|FPRC;

|PROCESO Bloque2018;
     |HAZ Botones349_2018;
     |SI enTecla = 0;  |ACABA;  |FINSI;

     |SI enTecla = 3;
         |HAZ PreguntaPresentacion;
     |FINSI;

     aAlfa = #dsmoy349#41;
     aAlfa = aAlfa % -102;
     nAnyo = aAlfa;

     |ABRE #eosclien;
     |SI #dsmoy349#33 = "N";
         nDEmpresa = #dsmoy349#1;
         nHEmpresa = #dsmoy349#2;
         |BUCLE eos349ca_2018;
     |SINO;
         |PARA nCampo = 3; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
               |SI #dsmoy349#nCampo# ! 0;
                   nDEmpresa = #dsmoy349#nCampo#;
                   nHEmpresa = #dsmoy349#nCampo#;
                   |BUCLE eos349ca_2018;
               |FINSI;
         |SIGUE;
     |FINSI;
     |CIERRA #eosclien;

     |SI enTecla = 3;
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;
|FPRC;
