|FICHEROS;
     eoszp007 #0;
     eosm1300 #1;
     eosm1303 #11;
     eosactiv #2;
     eosepial #3;
     eosopesp #4;
     eosopes2 #5;
|FIN;

|VARIABLES;
     aTipo     = "";
     nPer      = 0;
     nAny      = 0;
     CampoModi = 0;
     Fecha     = @;
     VarAlfa   = "";
     Total     = 0;
     DEmpre    = 0;
     HEmpre    = 0;
     nEjerO    = 0;
     nEjerD    = 0;
     nCampo    = 0;
|FIN;


|INCLUYE i_consul;

|PROCESO RecogeAnyo; |TIPO 7;
     Fecha   = ~;
     VarAlfa = Fecha % -104;
     nAny    = VarAlfa;
     |SI nAny > 2013; nAny = 2013; |FINSI;
     VarAlfa = nAny;
     VarAlfa = VarAlfa % -102;
     #0#2    = VarAlfa;   |PINTA #0#2;
|FPRC;

|PROCESO CalculaDestino;
     |SI FSalida = 2; |ACABA; |FINSI;

     nAny = #0#2 + 2000;
     |SI #0#2 > 80;
         nAny = #0#2 + 1900;
     |FINSI;
     |SI nAny ] 2014; |ERROR; |ACABA; |FINSI;

     |SI nAny = 2013;
         |SI #0#0 = 12; |ERROR; |ACABA; |FINSI;
         #0#1 = #0#0 + 1; |PINTA #0#1;
         |ACABA;
     |FINSI;

     |SI #0#0 ! 4; |Y #0#0 ! 12;
         #0#1 = #0#0 + 1;  |PINTA #0#1;
         #0#3 = #0#2;      |PINTA #0#3;
     |SINO;
         #0#1 = 1;         |PINTA #0#1;
         #0#3 = #0#2 + 1;  |PINTA #0#3;
     |FINSI;
|FPRC;

|PROCESO FiltraPeriodo;
     |SI #0#1 [ #0#0; |Y #0#3 = #0#2;
         |MENAV "     El Periodo / A¤o Destino es inferior o igual al Origen";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #0#3 < #0#2;
         |MENAV "     El A¤o Destino es inferior al Origen";
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO ModificaEmpresas;
     |PARA CampoModi = 5; |SI CampoModi [ 24; |HACIENDO CampoModi = CampoModi + 1;
           |C_M #0CampoModi, 1, "S";
     |SIGUE;

     |SI #0#4 ! "N"; |ACABA; |FINSI;

     |PARA CampoModi = 5; |SI CampoModi [ 24; |HACIENDO CampoModi = CampoModi + 1;
           |C_M #0CampoModi, 1, "N";
           #0CampoModi = 0; |PINTA #0CampoModi;
     |SIGUE;
|FPRC;
|| *************************************************************************

|PROCESO Graba300;
    #1#0  = #2#0;
    #1#45 = #2#1;
    #1#1  = #0#1;
    #1#2  = #0#3;
    |LEE 000#1=;
    |SI FSalida = 0; |ACABA; |FINSI;

    #1#0  = #2#0;
    #1#45 = #2#1;
    #1#1  = #0#0;
    #1#2  = #0#2;
    |LEE 000#1=;
    |SI FSalida ! 0; |ACABA; |FINSI;

    #1#1  = #0#1;
    #1#2  = #0#3;
    #1#3  = "";
    #1#4  = "N";

    |SI #1#1 = 1;
        #1#29 = #2#34;
    |SINO;
        |SI #1#55 < 0; #1#29 = -#1#55; #1#55 = 0; |FINSI;
    |FINSI;

    #1#25 = #1#21 + #1#22 + #1#23 + #1#43 + #1#44 + #1#51;
    #1#26 = #1#20 - #1#25;
    #1#27 = 100;
    #1#28 = #1#26 % #1#27;
    Total = #1#28 - #1#29;
    |SI Total = 0; #1#33 = 0; #1#32 = 0; #1#31 = 0; |FINSI;

    |SI Total > 0; #1#33 = Total; #1#32 = 0; #1#31 = 0; |FINSI;

    |SI Total < 0;|Y #1#1 ! 4;
        #1#32 = -Total;
        #1#31 = 0;
        #1#33 = 0;
    |FINSI;

    |SI Total < 0; |Y #1#1 = 4;
        |SI #2#27 = "D";
            #1#31 = -Total;
            #1#32 = 0;
            #1#33 = 0;
        |SINO;
            #1#32 = Total;
            #1#31 = 0;
            #1#33 = 0;
        |FINSI;
    |FINSI;

    |GRABA 020#1n;
    |LIBERA #1;

    #4#0 = #1#0;
    #4#1 = #1#45;
    #4#2 = #0#1;
    #4#3 = #0#3;
    |LEE 000#4=;
    |SI FSalida = 0; |ACABA; |FINSI;

    #4#0 = #1#0;
    #4#1 = #1#45;
    #4#2 = #0#0;
    #4#3 = #0#2;
    |LEE 000#4=;
    |SI FSalida ! 0; |ACABA; |FINSI;

    #4#2 = #0#1;
    #4#3 = #0#3;
    |GRABA 020#4n;
    |LIBERA #4;
|FPRC;

|PROCESO Graba303;
     |SI nEjerO = 2008;
         #11#0  = #2#0;
         #11#45 = #2#1;
         #11#1  = #0#1;
         #11#2  = #0#3;
         |LEE 000#11=;
         |SI FSalida = 0; |ACABA; |FINSI;

         #1#0  = #2#0;
         #1#45 = #2#1;
         #1#1  = #0#0;
         #1#2  = #0#2;
         |LEE 000#1=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |PARA nCampo = 0;  |SI nCampo [ 80;  |HACIENDO nCampo = nCampo + 1;
               #11nCampo = #1nCampo;
         |SIGUE;

         #11#1  = #0#1;
         #11#2  = #0#3;
         #11#3  = "";
         #11#4  = "N";

         |SI #11#1 = 1;
             #11#29 = #2#34;
         |SINO;
             |SI #11#55 < 0; #11#29 = -#11#55; #11#55 = 0; |FINSI;
         |FINSI;

         #11#25 = #11#21 + #11#22 + #11#23 + #11#43 + #11#44 + #11#51;
         #11#26 = #11#20 - #11#25;
         #11#27 = 100;
         #11#28 = #11#26 % #11#27;
         Total = #11#28 - #11#29;
         |SI Total = 0; #11#33 = 0; #11#32 = 0; #11#31 = 0; |FINSI;

         |SI Total > 0; #11#33 = Total; #11#32 = 0; #11#31 = 0; |FINSI;

         |SI Total < 0;
              aTipo = #2#26;
              |SI aTipo = "F";  aTipo = "T";  |FINSI;
              |SI aTipo = "D";  aTipo = "M";  |FINSI;

              |SI aTipo = "T";
                  nPer = 4;
              |FINSI;

              |SI aTipo = "M";
                  |SI #2#26 ! "D";
                      nPer = 12;
                  |SINO;
                      nPer = #11#1;
                  |FINSI;
              |FINSI;

              |SI #11#1 ! nPer;
                  #11#32 = -Total;
                  #11#31 = 0;
                  #11#33 = 0;
              |SINO;
                  |SI #2#27 = "C";
                      #11#32 = -Total;
                      #11#31 = 0;
                      #11#33 = 0;
                  |FINSI;

                  |SI #2#27 = "D";
                      #11#32 = 0;
                      #11#33 = 0;
                      #11#31 = -Total;
                 |FINSI;
             |FINSI;
         |FINSI;

         |GRABA 020#11n;
         |LIBERA #11;

         #5#0 = #11#0;
         #5#1 = #11#45;
         #5#2 = #0#1;
         #5#3 = #0#3;
         |LEE 000#5=;
         |SI FSalida = 0; |ACABA; |FINSI;

         #5#0 = #11#0;
         #5#1 = #11#45;
         #5#2 = #0#0;
         #5#3 = #0#2;
         |LEE 000#5=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         #5#2 = #0#1;
         #5#3 = #0#3;
         |GRABA 020#5n;
         |LIBERA #5;
     |FINSI;

     |SI nEjerO ] 2009;
         #11#0  = #2#0;
         #11#45 = #2#1;
         #11#1  = #0#1;
         #11#2  = #0#3;
         |LEE 000#11=;
         |SI FSalida = 0; |ACABA; |FINSI;

         #11#0  = #2#0;
         #11#45 = #2#1;
         #11#1  = #0#0;
         #11#2  = #0#2;
         |LEE 000#11=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         #11#1  = #0#1;
         #11#2  = #0#3;
         #11#3  = "";
         #11#4  = "N";

         |SI #11#1 = 1;
             #11#29 = #2#34;
         |SINO;
             |SI #11#55 < 0; #11#29 = -#11#55; #11#55 = 0; |FINSI;
         |FINSI;

         #11#25 = #11#21 + #11#22 + #11#23 + #11#43 + #11#44 + #11#51;
         #11#26 = #11#20 - #11#25;
         #11#27 = 100;
         #11#28 = #11#26 % #11#27;
         Total = #11#28 - #11#29;
         |SI Total = 0; #11#33 = 0; #11#32 = 0; #11#31 = 0; |FINSI;

         |SI Total > 0; #11#33 = Total; #11#32 = 0; #11#31 = 0; |FINSI;

         |SI Total < 0;
              aTipo = #2#26;
              |SI aTipo = "F";  aTipo = "T";  |FINSI;
              |SI aTipo = "D";  aTipo = "M";  |FINSI;

              |SI aTipo = "T";
                  nPer = 4;
              |FINSI;

              |SI aTipo = "M";
                  |SI #2#26 ! "D";
                      nPer = 12;
                  |SINO;
                      nPer = #11#1;
                  |FINSI;
              |FINSI;

              |SI #11#1 ! nPer;
                  #11#32 = -Total;
                  #11#31 = 0;
                  #11#33 = 0;
              |SINO;
                  |SI #2#27 = "C";
                      #11#32 = -Total;
                      #11#31 = 0;
                      #11#33 = 0;
                  |FINSI;

                  |SI #2#27 = "D";
                      #11#32 = 0;
                      #11#33 = 0;
                      #11#31 = -Total;
                 |FINSI;
             |FINSI;
         |FINSI;

         |GRABA 020#11n;
         |LIBERA #11;

         #5#0 = #11#0;
         #5#1 = #11#45;
         #5#2 = #0#1;
         #5#3 = #0#3;
         |LEE 000#5=;
         |SI FSalida = 0; |ACABA; |FINSI;

         #5#0 = #11#0;
         #5#1 = #11#45;
         #5#2 = #0#0;
         #5#3 = #0#2;
         |LEE 000#5=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         #5#2 = #0#1;
         #5#3 = #0#3;
         |GRABA 020#5n;
         |LIBERA #5;
     |FINSI;
|FPRC;

|PROCESO GrabaIVA;
     nEjerO = 2000 + #0#2;
     |SI #0#2 ] 80;
          nEjerO = 1900 + #0#2;
     |FINSI;

     nEjerD = 2000 + #0#3;
     |SI #0#3 ] 80;
          nEjerD = 1900 + #0#3;
     |FINSI;

     |SI nEjerD [ 2008;
         |HAZ Graba300;
     |SINO;
         |HAZ Graba303;
     |FINSI;
|FPRC;

|DEFBUCLE eosactiv;
     #2#2;
     ;
     DEmpre, #3#0, #3#1, #0#2;
     HEmpre, #3#0, #3#1, #0#2;
     ;
     NULL, GrabaIVA;
|FIN;

|PROCESO MiraEmpresas;
     |SI #0#4 = "N";
         DEmpre = 0;
         HEmpre = 99999;
         |BUCLE eosactiv;
     |SINO;
         |PARA CampoModi = 5; |SI CampoModi [ 24; |HACIENDO CampoModi = CampoModi + 1;
               |SI #0CampoModi ! 0;
                   DEmpre = #0CampoModi;
                   HEmpre = #0CampoModi;
                  |BUCLE eosactiv;
               |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|DEFBUCLE eosepial;
   #3#1;
   ;
   " ", "    ";
   "z", "zzzz";
   ;
   NULL, MiraEmpresas;
|FIN;

|PROCESO Tipo3; |TIPO 3;
   |ABRE #1;
   |ABRE #11;
   |ABRE #4;
   |BUCLE eosepial;
   |CIERRA #1;
   |CIERRA #11;
   |CIERRA #4;
|FPRC;
