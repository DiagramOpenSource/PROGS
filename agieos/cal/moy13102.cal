|FICHEROS;
     eosem131;
     dsmoy000;
     eosclien;
     eosdaban;
     eosm0020;
     eoscomul;

     eosm0020@;

     t1513101;
|FIN;

|VARIABLES;
     aMas       = "";
     aDef       = "";
     Campos     = 0;
     LLeno40    = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     Vacio40    = "                                        ";
     nDEmpre      = 0;
     nHEmpre      = 0;

     aDirOri      = "";
     aDirDes      = "";
     aOrigen      = "";
     aDestino     = "";
     aVacio40     = "                                        ";
     aLLeno40     = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";

     nNeg = 0;
     aAlfa        = "";
     aAlfa2       = "";
     aCadena      = "";
     aLong        = "";
     aCaracter    = "";
     nLong        = 0;
     nPos         = 0;
     nCont        = 0;
     nCalc        = 0;
     nTecla       = 0;
     nComa        = 0;
     nCaracter    = 0;
     nPosi        = 0;

     nPara1     = 0;
     nCampo     = 0;
     nCampo1    = 0;
     nCampo2    = 0;
     nCampo3    = 0;
     nCampo4    = 0;
     nCampo5    = 0;
     nCampo6    = 0;
     nCampo7    = 0;

     aAbre        = "";
     aModelos     = "";

     nHandle1     = 0;
     nHandle2     = 0;
     nAnyo2D      = 0;
     nSwHay       = 0;
     nTCampo      = 0;
     nContador    = 0;
     nSeImprime   = 0;

     fFecha       = @;

     aAlfa1       = "";
     aUnidad      = "";
     aFichero     = "";

  {1}aContiene    = "";

     &eaFOrigen   = "";
     &eaFDestino  = "";
     &eaInternet  = "";
     &eaImpresora = "";
     &enNume      = 0;
     &eaAlfa      = "";
     &eaDiaB      = "";
     &eaMesB      = "";
     &eaAnyoB     = "";
     &eaModelos   = "";
     nNume1       = 0;

     &eaPathEmision      = "";
     &eaPathLanza        = "";
     &eaPathExplorador   = "";
     &eaPathInternet     = "";
     &eaPathAEAT         = "";
     &eaFicheroPlano     = "";
     &eaFicheroSalid     = "";
     &eaFicheroImpre     = "";
     &eaFicheroError     = "";
     &eaOpcion           = "";
     &enEmpresa          = 0;
     &eaNomEmpresa       = "";
     &enPresentar        = 0;
     &enErrorPortal      = 0;
     &enTecla            = 0;
     &enPeriodo          = 0;
     &eaPeriodo          = "";
     &eaEjer             = "";
     &eaNIF              = "";
     &enImprtMd          = 0;
     &eaUnidad           = 0;
     &eaForzExplorador   = 0;
     &enHandlePortal     = 0;
     &eaVersMod          = "    ";
     &eaNIFDs            = "         ";
|FIN;

|INCLUYE i_seguim;

|PROCESO PresentaModelo_02;
     |SI eaOpcion = "1";
         eaNIF     = #t1513101#7;
         enImprtMd = #eosm0020#47;
         |HAZ PortalPDFPeriodicos;
     |FINSI;

     |SI eaOpcion = "3";
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFicheroPtl;
     |FINSI;
|FPRC;

|PROCESO AbrePagina;
     eaPathAEAT = eaUnidad + "\AEAT";        |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaModelos;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaEjer;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaPeriodo;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\";

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathAEAT + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     |DBASE aAlfa;  |QBT aAlfa;
     eaFOrigen  = aAlfa + "hacienda/wait.exe";
     eaFDestino = eaPathAEAT + "wait.exe";
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     eaAlfa = "https://www1.agenciatributaria.gob.es/es13/h/ie51150a.html";
     |HAZ GrabaPortalSin;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaPathAEAT + aFichero;
     |RFBORRA aAlfa;
     |RFBORRA aAbre;
|FPRC;

|PROCESO eoscomul;
     #eosm0020@#0 = #eoscomul#0;
     #eosm0020@#1 = #eosm0020#1;
     #eosm0020@#2 = #eosm0020#2;
     |LEE 101#eosm0020@.=;
     |SI FSalida = 0;
         #eosm0020@#3 = #eosem131#6;
         |GRABA 020#eosm0020@.a;
         |LIBERA #eosm0020@;
     |FINSI;
|FPRC;

|DEFBUCLE eoscomul;
     #eoscomul#2;
     ;
     #eosm0020#0, nNume1, #eosm0020#1;
     #eosm0020#0, nNume1, #eosm0020#1;
     ;
     NULL, eoscomul;
|FIN;

|PROCESO VerComunidad;
     |DDEF aDef;
     aDef = aDef + "eosm0020.mas";
     |CARGA_DEF aDef, eosm0020@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |ABRE #eosm0020@;
     |PARA nCampo2 = 6; |SI nCampo2 [ 34; |HACIENDO nCampo2 = nCampo2 + 7;
           nCampo7 = nCampo2 - 1;
           |SI #eosm0020#nCampo2#  = "C";
               nNume1 = #eosm0020#nCampo7#;
               |BUCLE eoscomul;
           |FINSI;
     |SIGUE;
     |CIERRA #eosm0020@;
     |DESCARGA_DEF #eosm0020@;
|FPRC;

|PROCESO BuscaNombre_02;
     |QBF eaAlfa;
     aAlfa1 = "";
     aAlfa2 = "";
     aLong  = eaAlfa % 0;
     nLong  = aLong;
     nComa  = 0;

     |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
           nPos      = (nCaracter * 100) + 1;
           aCaracter = eaAlfa % nPos;

           |SI aCaracter = ",";
               nComa = 1;
           |SINO;
               |SI nComa = 0;
                   aAlfa1 = aAlfa1 + aCaracter;
               |SINO;
                   |SI aCaracter = " ";  |Y aAlfa2 = "";
                   |SINO;
                       aAlfa2 = aAlfa2 + aCaracter;
                   |FINSI;
               |FINSI;
           |FINSI;
      |SIGUE;
|FPRC;

|PROCESO TDeclaracion2015;
     |ABRE #eosdaban;
     #eosdaban#0 = #eosclien#0;
     |LEE 000#eosdaban.=;
     |SI FSalida ! 0; |DDEFECTO #eosdaban; |FINSI;
     |CIERRA #eosdaban;

     |SI #eosm0020#47 > 0;
                                 #t1513101#6 = "I";
         |SI #eosdaban#14 = "3"; #t1513101#6 = "U";  |FINSI;
         |SI #eosdaban#14 = "6"; #t1513101#6 = "G";  |FINSI;
         |SI #eosdaban#14 ! "1";
             #t1513101#47 = #eosdaban#7;
         |FINSI;
     |SINO;
         #t1513101#6 = "N";
         |SI #eosm0020#47 ! 0;
             |SI #eosm0020#2 ! 4;  #t1513101#6 = "B";  |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeModelo;
     nContador  = 0;
     nSeImprime = 0;
     |PARA nCampo2 = 6; |SI nCampo2 [ 34; |HACIENDO nCampo2 = nCampo2 + 7;
           nCampo7 = nCampo2 + 5;
           |SI #eosm0020#nCampo2# = "C";
               nContador  = nContador + 1;
               nSeImprime = 1;
           |FINSI;

           |SI #eosm0020#nCampo2# = "N";
               |SI #eosm0020#nCampo7# ! 0; nSeImprime = 1; |FINSI;
           |FINSI;
     |SIGUE;

     |SI #eosm0020#43 ! 0; |O #eosm0020#44 ! 0; |O #eosm0020#45 ! 0; |O #eosm0020#46 ! 0; |O #eosm0020#47 ! 0;
         nSeImprime = 1;
     |FINSI;

     |SI #eosm0020#11 = 0; |Y #eosm0020#18 = 0; |Y #eosm0020#25 = 0; |Y #eosm0020#32 = 0; |Y #eosm0020#39 = 0;
      |Y #eosm0020#40 = 0; |Y #eosm0020#41 = 0; |Y #eosm0020#43 = 0; |Y #eosm0020#45 = 0; |Y #eosm0020#47 = 0;
         nSeImprime = 1;
     |FINSI;

     |SI nSeImprime ! 0;
         #eosm0020#3 = #eosem131#6;
         |GRABA 020#eosm0020.a;
         |LIBERA #eosm0020;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO CargaEpi_02;
     nCampo3 = nCampo2 + 1;
     nCampo4 = nCampo2 + 2;
     nCampo5 = nCampo2 + 3;
     nCampo6 = nCampo2 + 4;
     nCampo7 = nCampo2 + 5;

     nPosi   = 0;
     |SI #t1513101#31 = "00000000000000000";  nPosi = 28;  |FINSI;
     |SI #t1513101#27 = "00000000000000000";  nPosi = 24;  |FINSI;
     |SI #t1513101#23 = "00000000000000000";  nPosi = 20;  |FINSI;
     |SI #t1513101#19 = "00000000000000000";  nPosi = 16;  |FINSI;
     |SI #t1513101#15 = "00000000000000000";  nPosi = 12;  |FINSI;

     #t1513101#nPosi# = #eosm0020#nCampo4#;

     nPosi = nPosi + 1;  enNume   = #eosm0020#nCampo5#; |HAZ Conver17;
     #t1513101#nPosi# = eaAlfa;

     nPosi = nPosi + 1;  enNume   = #eosm0020#nCampo6# * 100;  aAlfa = ("00000" + enNume) % -105;
     #t1513101#nPosi# = aAlfa;

     nPosi = nPosi + 1;  enNume   = #eosm0020#nCampo7#;  |HAZ Conver17;
     #t1513101#nPosi# = eaAlfa;
|FPRC;

|PROCESO Carga131_2013;
     |DDEFECTO #t1513101;

     aAlfa         = #eosclien#1;  |QBF aAlfa;
     #t1513101#7   = ("000000000" + aAlfa) % -109;

     aAlfa = #eosclien#1 % 101;
     |SI aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
      |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7";
      |O aAlfa = "8"; |O aAlfa = "9"; |O aAlfa = "X"; |O aAlfa = "Y";
      |O aAlfa = "Z";
         eaAlfa = #eosclien#2;      |HAZ BuscaNombre_02;
         eaAlfa = aAlfa1;    |HAZ QuitaRaros;   #t1513101#8   = eaAlfa;
         eaAlfa = aAlfa2;    |HAZ QuitaRaros;   #t1513101#9   = eaAlfa % 115;
     |SINO;
         eaAlfa   = #eosclien#2;  |HAZ QuitaRaros;  #t1513101#8 = eaAlfa;
                                                    #t1513101#9 = "";
     |FINSI;

     #t1513101#10  = #eosem131#2;
     #t1513101#11  = eaPeriodo;

     |PARA nCampo2 = 6;  |SI nCampo2 [ 34;  |HACIENDO nCampo2 = nCampo2 + 7;
           |SI #eosm0020#nCampo2# ! "S";  |HAZ CargaEpi_02;  |FINSI;
     |SIGUE;

     enNume  = #eosm0020#60;  |HAZ Conver17;  #t1513101#32 = eaAlfa;
     enNume  = #eosm0020#40;  |HAZ Conver17;  #t1513101#33 = eaAlfa;
     enNume  = #eosm0020#51;  |HAZ Conver17;  #t1513101#34 = eaAlfa;
     enNume  = #eosm0020#52;  |HAZ Conver17;  #t1513101#35 = eaAlfa;
     enNume  = #eosm0020#43;  |HAZ Conver17;  #t1513101#36 = eaAlfa;
     enNume  = #eosm0020#44;  |HAZ Conver17;  #t1513101#37 = eaAlfa;
     enNume  = #eosm0020#53;  |HAZ Conver17;  #t1513101#38 = eaAlfa;
     enNume  = #eosm0020#54;  |HAZ Conver17;  #t1513101#39 = eaAlfa;
     enNume  = #eosm0020#59;  |HAZ Conver17;  #t1513101#40 = eaAlfa;  ||campo minoracion

     enNume  = #eosm0020#55;  |HAZ Conver17;  #t1513101#41 = eaAlfa;
     enNume  = #eosm0020#56;  |HAZ Conver17;  #t1513101#42 = eaAlfa;
     enNume  = #eosm0020#61;  |HAZ Conver17;  #t1513101#43 = eaAlfa;
     enNume  = #eosm0020#57;  |HAZ Conver17;  #t1513101#44 = eaAlfa;
     enNume  = #eosm0020#58;  |HAZ Conver17;  #t1513101#45 = eaAlfa;
     enNume  = #eosm0020#47;  |HAZ Conver17;  #t1513101#46 = eaAlfa;

     |HAZ TDeclaracion2015;

     |SI #eosm0020#48 = "S";
         #t1513101#48 = "X";
         #t1513101#49 = #eosm0020#49;
     |FINSI;

     #t1513101#53 = &13 + &10;

     aAlfa = "<T1310" + #t1513101#10 + #t1513101#11 + "0000>";  |XGRABA nHandle2, aAlfa;
     aAlfa = "<AUX>";                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 70;                                          |XGRABA nHandle2, aAlfa;
     aAlfa = eaVersMod;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 4;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = eaNIFDs;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 213;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = "</AUX>";                                          |XGRABA nHandle2, aAlfa;

     |PARA nCampo = 1;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #t1513101#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;

     aAlfa = "</T1310" + #t1513101#10 + #t1513101#11 + "0000>";  |XGRABA nHandle2, aAlfa;
|FPRC;

|PROCESO eosm0020_02;
     |SI #eosem131#33 ! "N";
         #eosclien#0 = #eosm0020#0;
         |LEE 040#eosclien.=;
         |SI FSalida ! 0; |DDEFECTO #eosclien; |FINSI;
     |FINSI;

     |HAZ LeeModelo;
     |SI nSeImprime = 0; |ACABA; |FINSI;

     eaFicheroPlano = "131" + (("00000" + #eosclien#0) % -105) + ".txt";
     eaFicheroImpre = "131" + (("00000" + #eosclien#0) % -105) + ".pdf";
     eaFicheroError = "err" + (("00000" + #eosclien#0) % -105) + ".txt";

     aAlfa = eaPathLanza + eaFicheroPlano;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroImpre;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Carga131_2013;

     |XCIERRA nHandle2;

     |HAZ PresentaModelo_02;

     aAlfa    = #eosem131#2 % -102;
     se_empre = #eosclien#0;
     se_ejerc = aAlfa;
     se_perio = #eosem131#4;
     se_tipos = 131;
     se_activ = 10;
     se_impor = #eosm0020#47;
     se_fecha = #eosem131#6;
     se_factu = "N";
     |HAZ seguimie;
     |HAZ AlAgicli;
     |HAZ VerComunidad;

     enEmpresa    = #eosclien#0;
     eaNomEmpresa = #eosclien#1;
|FPRC;

|DEFBUCLE eosm0020_02;
     #eosm0020#1;
     4;
     #eosem131#0, nAnyo2D, #eosem131#4, "N";
     #eosem131#1, nAnyo2D, #eosem131#4, "N";
     be;
     NULL, eosm0020_02;
|FIN;

|PROCESO eosclien_02;
     #eosm0020#0 = #eosclien#0;
     #eosm0020#1 = #eosclien#0;
     |BUCLE eosm0020_02;
|FPRC;

|DEFBUCLE eosclien_02;
     #eosclien#3;
     0;
     aVacio40, nDEmpre;
     aLLeno40, nHEmpre;
     e;
     NULL, eosclien_02;
|FIN;

|PROCESO moy13102;
     |HAZ LeeUnidad;

     eaModelos  = "131";
     eaEjer     = #eosem131#2;
     enPeriodo  = #eosem131#4;
     nAnyo2D    = #eosem131#2 - 2000;

     |SI #eosem131#4 = 1; eaPeriodo = "1T"; |FINSI;
     |SI #eosem131#4 = 2; eaPeriodo = "2T"; |FINSI;
     |SI #eosem131#4 = 3; eaPeriodo = "3T"; |FINSI;
     |SI #eosem131#4 = 4; eaPeriodo = "4T"; |FINSI;

     #dsmoy000#0 = eaModelos;
     #dsmoy000#6 = eaEjer;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaPeriodo;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaPeriodo;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaPeriodo;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ Botones2015;
     |SI enTecla = 0;  |ACABA;  |FINSI;

     |SI eaOpcion = "1";
         |MENAV "0000La opcion de validacion no esta activada por hacienda.";
         |ACABA;
     |FINSI;

     |SI #eosem131#33 = "N";
         nDEmpre = #eosem131#0;
         nHEmpre = #eosem131#0;
         |BUCLE eosclien_02;
     |SINO;
         |ABRE #eosclien;
         |SI #eosem131#7 = "S";
             |BUCLE eosm0020_02;
         |SINO;
             |PARA nPara1 = 8; |SI nPara1 [ 31; |HACIENDO nPara1 = nPara1 + 1;
                   |SI #eosem131#nPara1# ! 0;
                       #eosem131#0 = #eosem131#nPara1#;
                       #eosem131#1 = #eosem131#nPara1#;
                       |BUCLE eosm0020_02;
                   |FINSI;
             |SIGUE;
         |FINSI;
         |CIERRA #eosclien;
     |FINSI;

     |SI eaOpcion = "1";
         |HAZ SacaErrorPtl;
     |FINSI;

     |SI eaOpcion = "3";
         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;

/*
         |CONFI "0000SQuiere cargar la pagina de hacienda del modelo";
         |SI FSalida = 0;
             |HAZ AbrePagina;
         |FINSI;
*/
     |FINSI;
|FPRC;
