|FICHEROS;
    eosm2130 #0;
    eosclien #1;
    eosactiv #2;
    eosm3130 #6;
    eoscomul #15;
    eosw0016 #16;
    eoszr130 #20;
|FIN;

|VARIABLES;
    act_nor   = 0;
    x         = 0;
    empresa   = 0;
    activid   = 0;
    periodo   = 0;
    ejercic   = 0;
    activi_g  = 0;
    pagos_g   = 0;
    FEstado   = 0;
    sw_130    = 0;
    cuota     = 0;
|FINSI;

|INCLUYE i_seguim;
|INCLUYE i_ficher;

|PROCESO calcula;
empresa = #0#0;
activid = #0#1;
periodo = #0#2;
ejercic = #0#3;

sw_130 = 0; |HAZ graba_glob;
sw_130 = 1; |HAZ graba_glob;

#0#0 = empresa;
#0#1 = activid;
#0#2 = periodo;
#0#3 = ejercic;
|LEE 040#0=;
|FPRC;

|PROCESO borra_130;
|BORRA 140#6a;
|LIBERA #6;
|FPRC;

|DEFBUCLE eosm3130_1;
#6#1;
32;
#0#0, 1, #0#2, #0#3, "N";
#0#0, 9, #0#2, #0#3, "N";
e;
NULL, borra_130;
|FIN;

|PROCESO graba_glob;
|ABRE #2;
|PARA act_nor = 1; |SI act_nor [ 6; |HACIENDO act_nor = act_nor + 1;
      #2#0 = #0#0;
      #2#1 = act_nor;
      #2#2 = #0#3;
      |LEE 040#2=;
      |SI FSalida = 0;
          |SI #2#46 = "S"; |HAZ comunero; |SINO; |HAZ normal; |FINSI;
      |FINSI;
|SIGUE;
|CIERRA #2;
|FPRC;

|PROCESO normal;
|SI sw_130 = 0; |BUCLE eosm3130_1; |ACABA; |FINSI;

|SI #2#42 = "S"; activi_g = #2#1; |SINO; activi_g = 9; |FINSI;

|ABRE #6;
|SI #0#2 ! 1;
    #6#0 = #0#0;
    #6#1 = activi_g;
    #6#2 = #0#2 - 1;
    #6#3 = #0#3;
    |LEE 040#6=;
    |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

    cuota = #6#31 - #6#36;
    |SI cuota < 0; cuota = 0; |FINSI;

    pagos_g = #6#29 + #6#28 - cuota;
|SINO;
    pagos_g = 0;
|FINSI;

#0#0 = #0#0;
#0#1 = #2#1;
#0#2 = #0#2;
#0#3 = #0#3;
|LEE 040#0=;
|SI FSalida ! 0; |CIERRA #6; |ACABA; |FINSI;

#6#0 = #0#0;
#6#1 = activi_g;
#6#2 = #0#2;
#6#3 = #0#3;
|LIBERA #6;
|LEE 140#6=;
FEstado = FSalida;
|SI FEstado ! 0;
    |DDEFECTO #6;
    #6#0 = #0#0;
    #6#1 = activi_g;
    #6#2 = #0#2;
    #6#3 = #0#3;
    #6#4 = #0#4;
    #6#5 = #0#5;
|FINSI;
|PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
    #6x = #6x + #0x;
|SIGUE;
#6#37 = #6#37 + #0#33;
|SI #2#41 = "N"; #6#28 = pagos_g; |FINSI;
#6#30 = #6#30 + #0#30;
#6#31 = #6#31 + #0#31;
#6#36 = #6#36 + #0#32;

#6#29 = #6#27 - #6#28 - #6#25;
|SI #6#29 < 0; #6#29 = 0; |FINSI;

cuota = #6#31 - #6#36;
|SI cuota < 0; cuota = 0; |FINSI;

#6#29 = #6#29 + cuota;
|SI #6#29 < 0; #6#29 = 0; |FINSI;

|SI FEstado ! 0; |GRABA 140#6n; |SINO; |GRABA 140#6a; |FINSI;

|CIERRA #6;
|FPRC;

|PROCESO graba_inde;
#16#0 = #15#3;
|LIBERA #16;
|LEE 140#16=;
|SI FSalida = 0; |GRABA 140#16a; |SINO; |GRABA 140#16n; |FINSI;
|FPRC;

|DEFBUCLE eoscomul_1;
#15#1;
;
empresa, activid, ejercic, 000;
empresa, activid, ejercic, 999;
e;
NULL, graba_inde;
|FIN;

|DEFBUCLE eosm3130_2;
#6#1;
32;
#15#3, 1, #0#2, #0#3, "S";
#15#3, 9, #0#2, #0#3, "S";
be;
NULL, borra_130;
|FIN;

|PROCESO graba_comu;
|SI sw_130 = 0; |BUCLE eosm3130_2; |ACABA; |FINSI;

|ABRE #1;
#1#0 = #15#0;
|LEE 040#1=;
|SI FSalida ! 0; |DDEFECTO #1; |FINSI;
|CIERRA #1;

#2#0 = #15#3;
#2#1 = #15#5;
#2#2 = #15#7;
|LEE 040#2=;
|SI FSalida ! 0; |DDEFECTO #2; |FINSI;

|SI #2#42 = "S"; activi_g = #15#5; |SINO; activi_g = 9; |FINSI;

|ABRE #6;

|SI periodo ! 1;
    #6#0 = #15#3;
    #6#1 = activi_g;
    #6#2 = #0#2 - 1;
    #6#3 = #15#7;
    |LEE 040#6=;
    |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

    cuota = #6#31 - #6#36;
    |SI cuota < 0; cuota = 0; |FINSI;

    pagos_g = #6#29 + #6#28 - cuota;
|SINO;
    pagos_g = 0;
|FINSI;

#0#0 = #15#0;
#0#1 = #15#1;
#0#2 = periodo;
#0#3 = ejercic;
|LEE 040#0=;
|SI FSalida ! 0; |CIERRA #6; |ACABA; |FINSI;

#6#0 = #15#3;
#6#1 = activi_g;
#6#2 = #0#2;
#6#3 = #0#3;
|LIBERA #6;
|LEE 140#6=;
FEstado = FSalida;
|SI FEstado ! 0;
    |DDEFECTO #6;
    #6#0 = #15#3;
    #6#1 = activi_g;
    #6#2 = #0#2;
    #6#3 = #0#3;
    #6#4 = #0#4;
    #6#5 = #0#5;
|FINSI;
|PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
     #6x = #6x + (#0x % #15#6);
|SIGUE;
#6#37 = #6#37 + (#0#33 % #15#6);

|SI #2#41 = "N"; #6#28 = pagos_g; |FINSI;
#6#20 = #0#20;
#6#30 = #6#30 + (#0#30 % #15#6);
#6#31 = #6#31 + (#0#31 % #15#6);
#6#36 = #6#36 + (#0#32 % #15#6);

#6#29 = #6#27 - #6#28 - #6#25;
|SI #6#29 < 0;  #6#29 = 0; |FINSI;

cuota = #6#31 - #6#36;
|SI cuota < 0; cuota = 0; |FINSI;

#6#29 = #6#29 + cuota;
|SI #6#29 < 0;  #6#29 = 0; |FINSI;

#6#32 = "S";
#6#33 = #6#33 + 1;
#6#34 = #1#2;
#6#35 = #15#6;

|SI FEstado ! 0; |GRABA 140#6n; |SINO; |GRABA 140#6a; |FINSI;

|CIERRA #6;
|FPRC;

|DEFBUCLE eoscomul_2;
#15#2;
1;
#16#0, 1, ejercic, act_nor;
#16#0, 6, ejercic, act_nor;
e;
NULL, graba_comu;
|FIN;

|PROCESO lee_comun;
|BUCLE eoscomul_2;
|FPRC;

|DEFBUCLE eosw0016;
#16#1;
;
00000;
99999;
e;
NULL, lee_comun;
|FIN;

|PROCESO comunero;
comienza = "16";
|HAZ fichero;
|NOME_DAT #16 fichero;

|ABRE #16; |CIERRA #16;
|DELINDEX #16;

|ABRE #16;
|BUCLE eoscomul_1;
|CIERRA #16;

|BUCLE eosw0016;
|DELINDEX #16;
|FPRC;

|DEFBUCLE eosm2130;
#0#1;
;
00000, 0, 00, 00;
99999, 9, 99, 99;
e;
NULL, calcula;
|FIN;

|PROCESO tipo_3; |TIPO 3;
|SI #20#0 ! "SI"; |ACABA; |FINSI;

|ABRE #6; |CIERRA #6;
|DELINDEX #6;
|BUCLE eosm2130;
|FPRC;
