|FICHEROS;
     eosw0064 #0;
     eosm0023 #2;
     eosm0024 #3;
|FIN;

|VARIABLES;
     XPara         = 0;
     Fecha         = @;
     Tempo         = "";
     TempoF        = "";
     Valfa         = "";
     FEstado       = 0;
     SwExiste      = 0;

     nCampos       = 0;
     fFecha        = @;
     aAlfa         = "";
     nAnyo         = 0;

     &nAmort       = 0;
     &nVAnyo       = 0;
     &nCAnyo       = 0;
     &nPendiente   = 0;
     &nTCompra     = 0;
     &nPorceA      = 0;
     &nPorceD      = 0;
     &nImport      = 0;
     &nTipoMod     = 0;
     &enImpProv    = 0;
     &enCalcProv   = 0;

     &fFechaUso    = @;
     &fFechaCompra = @;
     &fFechaVenta  = @;
     &fPriCompra   = @;
     &fFinCompra   = @;
     &fPriVenta    = @;
     &fFinVenta    = @;

     &eaIniActi    = "";
     &efFecActi    = @;

     &Modo       = 0;
     &MEmpresa   = 0;
     &MActivi    = 0;
     &MAnyo      = 0;
     &TeclaF     = 0;
     {18}&TAmorc = 0;
     nElPend     = 0;
     nElAmor    = 0;
|FIN;

|PROCESO Calculo;
     enImpProv   = 0;
     nImport     = 0;
     fFechaUso   = #2#13;
     fFechaVenta = #2#17;
     nTCompra    = #2#16;
     |SI #2#6 = "B";  nTCompra = #2#14;  |FINSI;
     nPorceA     = #2#25;
     nPorceD     = #2#7;
     nTipoMod    = #2#4;

     aAlfa  = "31.12." + (fFechaUso % -104);     fFinCompra = aAlfa;
     aAlfa  = "01.01." + (fFechaUso % -104);     fPriCompra = aAlfa;

     aAlfa  = fFechaUso   % -104;                nCAnyo    = aAlfa;
     aAlfa  = fFechaVenta % -104;                nVAnyo    = aAlfa;
     aAlfa  = "01.01." + (fFechaVenta % -104);   fPriVenta = aAlfa;
     aAlfa  = "31.12." + (fFechaVenta % -104);   fFinVenta = aAlfa;
     |SI fPriVenta < fFechaUso;                  fPriVenta = fFechaUso;  |FINSI;

     nAmort  = nAnyo;
     |SI nAmort > nVAnyo;  |Y nVAnyo ! 0;  |ACABA;  |FINSI;
     |SI #2#22 = 0;  |Y #2#23 < nAmort;    |ACABA;  |FINSI;

     |SI nCAnyo = nAmort;

         |SI eaIniActi = "S";
             |SI efFecActi < fFechaUso;
                 |ACABA;
             |FINSI;
         |SINO;
             |SI eaIniActi ! "P";
                 aAlfa = fFechaUso % 105;
                 |SI aAlfa ! "01.01";
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;

     |FINSI;

     nPendiente = #2#22;
     |SI #2#23 = nAmort;
         nPendiente = #2#22 + #3#5;
         fFechaVenta = "01.01.0000";
         nVAnyo      = 0;
     |FINSI;
     nPendiente = nElPend;

     |HAZ Amortizamelo;
|FPRC;
|| ***************************
|PROCESO VuelvoACal;
     |SI nAnyo ! #3#3;
         nElPend = nElPend - #3#5;
         nElAmor = nElAmor + #3#5;
     |FINSI;
|FPRC;

|DEFBUCLE VuelvoACal;
     #3#1;
     ;
     #2#0, #2#1, #2#2, 0000;
     #2#0, #2#1, #2#2, nAnyo;
     ;
     NULL, VuelvoACal;
|FIN;
|| ******************************

|PROCESO MiraCabe;
     aAlfa  = "01.01." + (("0000" + nAnyo) % -104);
     fFecha = aAlfa;

     |SI #2#17 > "01.01.0000";  |Y #2#17 < fFecha;  |ACABA;  |FINSI;
     |SI #2#22 = 0;  |Y #2#23 < nAnyo;              |ACABA;  |FINSI;

     |DDEFECTO #0;
     #0#0  = ("00000" + #2#2) % -105 + " " + #2#3;
     #0#1  = #2#13;
     #0#2  = #2#14;
     |SI #2#6 = "F";  #0#2  = #2#16;  |FINSI;
     #0#11 = #2#4;
     |SI #0#11 = 0;
         #0#3 = #2#21;
         |SI #0#3 = 0;  #0#3 = #2#22;  |FINSI;
         #0#4 = 0;
         #0#6 = 0;
         #0#7 = 0;
         #0#8 = 0;
     |SINO;
         #0#4 = #2#21;
         #0#6 = #2#7;
         #0#8 = #2#8;
         #0#7 = #2#22;
     |FINSI;

     nElPend   = #2#16; |SI #2#6 = "B";  nElPend = #2#14;  |FINSI;
     nElAmor   = 0;
     enImpProv = 0;
     nImport   = 0;
     |BUCLE VuelvoACal;

     |ABRE #3;
     #3#0 = #2#0;
     #3#1 = #2#1;
     #3#2 = #2#2;
     #3#3 = nAnyo;
     |LEE 040#3=;
     |SI FSalida ! 0;
         |DDEFECTO #3;
         #3#0 = #2#0;
         #3#1 = #2#1;
         #3#2 = #2#2;
         #3#3 = nAnyo;
     |FINSI;

     |HAZ Calculo;
     #0#9  = nImport;
     |SI nTipoMod ! 0;  |Y enCalcProv = 1;
         #0#9  = enImpProv;
     |FINSI;
     |SI nTipoMod ! 0; |Y enCalcProv = 3;
         |SI #3#5 ! 0; #0#9  = #3#5; |FINSI;
     |FINSI;
     #0#10 = #3#5;

     |SI nTipoMod = 0;  #0#9 = 0;  |FINSI;

     |GRABA 140#0n;
     |LIBERA #0;
     SwExiste = 1;
     |CIERRA #3;
|FPRC;

|DEFBUCLE eosm0023;
     #2#1;
     ;
     MEmpresa, MActivi, 00000;
     MEmpresa, MActivi, 99999;
     ;
     NULL, MiraCabe;
|FIN;

|PROCESO CargaEste;
  |ABRE #0;
  |BUCLE eosm0023;
  |CIERRA #0;
|FPRC;

|RUTINA ClaveBaja;
  #0#0 = "                                        ";
|FRUT;

|RUTINA ClaveAlta;
  #0#0 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
|FRUT;

|PROCESO CogeValores;
  |SI #0#11 = 1;
      |SI #0#1 [ Fecha;
          ITAmorc = TAmorc1 <-;   TAmorc = TAmorc + #0#2;
          ITAmorc = TAmorc2 <-;   TAmorc = TAmorc + #0#9;
      |FINSI;
      ITAmorc = TAmorc10 <-;   TAmorc = TAmorc + #0#2;
      ITAmorc = TAmorc11 <-;   TAmorc = TAmorc + #0#10;
  |FINSI;

  |SI #0#11 = 2;
      |SI #0#1 [ Fecha;
          ITAmorc = TAmorc3 <-;   TAmorc = TAmorc + #0#2;
          ITAmorc = TAmorc4 <-;   TAmorc = TAmorc + #0#9;
      |FINSI;
      ITAmorc = TAmorc12 <-;   TAmorc = TAmorc + #0#2;
      ITAmorc = TAmorc13 <-;   TAmorc = TAmorc + #0#10;
  |FINSI;

  |SI #0#11 = 3;
      |SI #0#1 [ Fecha;
          ITAmorc = TAmorc5 <-;   TAmorc = TAmorc + #0#2;
          ITAmorc = TAmorc6 <-;   TAmorc = TAmorc + #0#9;
      |FINSI;
      ITAmorc = TAmorc14 <-;   TAmorc = TAmorc + #0#2;
      ITAmorc = TAmorc15 <-;   TAmorc = TAmorc + #0#10;
  |FINSI;

  |SI #0#11 = 4;
      |SI #0#1 [ Fecha;
          ITAmorc = TAmorc7 <-;   TAmorc = TAmorc + #0#2;
          ITAmorc = TAmorc8 <-;   TAmorc = TAmorc + #0#9;
      |FINSI;
      ITAmorc = TAmorc16 <-;   TAmorc = TAmorc + #0#2;
      ITAmorc = TAmorc17 <-;   TAmorc = TAmorc + #0#10;
  |FINSI;

  |SI #0#11 = 0;
      |SI eaIniActi = "P";
          ITAmorc = TAmorc18 <-;   TAmorc = TAmorc + #0#3;
      |FINSI;

      ITAmorc = TAmorc9  <-;   TAmorc = TAmorc + #0#10;
  |FINSI;
|FPRC;

|DEFBUCLE eosw0064;
  #0#1;
  ;
  "                                        ";
  "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
  ;
  NULL, CogeValores;
|FIN;

|PROGRAMA;
  Valfa = "";
  Tempo = "";
  |DFICE Valfa;
  |TEMPO Tempo; TempoF = Tempo - Valfa; |NOME_DAT #0 TempoF; |FBORRA Tempo;
  |ABRE #0;  |CIERRA #0;  |DELINDEX #0;

  |SI MAnyo [ 80;
      nAnyo = 2000 + MAnyo;
  |SINO;
      nAnyo = 1900 + MAnyo;
  |FINSI;

  SwExiste = 0;
  |HAZ CargaEste;

  |SI TeclaF = 9;
      |SI SwExiste ! 0;
          |ENTLINEAL #1#0, -1, 4, 22, 1, ClaveBaja, ClaveAlta;
      |FINSI;
  |FINSI;

  |SI TeclaF = 10;
      |SUB_EJECUTA "reoz0001";
  |FINSI;

  ITAmorc = TAmorc1 <-;
  |PARA XPara = 1;  |SI XPara [ 18;  |HACIENDO XPara = XPara + 1;
        TAmorc = 0;
        ITAmorc = ITAmorc + 1;
  |SIGUE;

  |ABRE #0;  |CIERRA #0;  |DELINDEX #0;
  |HAZ CargaEste;

  |SI MAnyo [ 80;
      Valfa = "01.01.20" + (("00" + MAnyo) % -102);
  |SINO;
      Valfa = "01.01.19" + (("00" + MAnyo) % -102);
  |FINSI;

  Fecha = Valfa;
  |SI eaIniActi = "S";  Fecha = efFecActi;     |FINSI;
  |SI eaIniActi = "P";  Fecha = "31.12.2999";  |FINSI;

  |BUCLE eosw0064;

  |ABRE #0;  |CIERRA #0;  |DELINDEX #0;
|FPRO;
