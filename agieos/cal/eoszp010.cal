|FICHEROS;
     eoszp010 #0;
     eoscabve #1;
     eoslinve #2;
     eosconce #3;
     eosclpre #4;
     eosactiv #5;
     eoscolib #6;
     eosclien #7;
     eosconc6 #13;
     eosw0038 #98;
     eosw0034 #99,MANTE;
|FIN;

|VARIABLES;
     XPara         = 0;
     Conta         = 0;
     CalIRPF       = 0;
     Suma          = 0;

     ErrorFatal    = 0;
     Modo          = 0;
     FechaAnterior = @;
     NDocuAnterior = 0;
     NDocumento    = 0;
     NDocumento1   = 0;
     ReferError    = 0;
     ModoChequeo   = 0;

     MesAlfa   = "";
     LaCantidad = 0;
     Campos1   = 0;
     Campos2   = 0;
     Campos3   = 0;
     Campos4   = 0;
     Campos5   = "";
     Campos6   = "";
     Campos7   = 0;
     LaBase    = 0;
     CampoBase = 0;
     CampoIva  = 0;
     CampoRec  = 0;
     CampoRet  = 0;
     VTipo1    = 0;
     VConc1    = 0;
     VCona1    = "";
     VConn1    = "";
     VPiva1    = 0;
     VCiva1    = 0;
     VPrec1    = 0;
     VCrec1    = 0;
     VPret1    = 0;
     VCret1    = 0;
     VCbas1    = 0;

     VTipo2    = 0;
     VConc2    = 0;
     VCona2    = "";
     VConn2    = "";
     VPiva2    = 0;
     VCiva2    = 0;
     VPrec2    = 0;
     VCrec2    = 0;
     VPret2    = 0;
     VCret2    = 0;
     VCbas2    = 0;

     VTipo3    = 0;
     VConc3    = 0;
     VCona3    = "";
     VConn3    = "";
     VPiva3    = 0;
     VCiva3    = 0;
     VPrec3    = 0;
     VCrec3    = 0;
     VPret3    = 0;
     VCret3    = 0;
     VCbas3    = 0;

     VTipo4    = 0;
     VConc4    = 0;
     VCona4    = "";
     VConn4    = "";
     VPiva4    = 0;
     VCiva4    = 0;
     VPrec4    = 0;
     VCrec4    = 0;
     VPret4    = 0;
     VCret4    = 0;
     VCbas4    = 0;

     VTipo5    = 0;
     VConc5    = 0;
     VCona5    = "";
     VConn5    = "";
     VPiva5    = 0;
     VCiva5    = 0;
     VPrec5    = 0;
     VCrec5    = 0;
     VPret5    = 0;
     VCret5    = 0;
     VCbas5    = 0;

     VTipo6    = 0;
     VConc6    = 0;
     VCona6    = "";
     VConn6    = "";
     VPiva6    = 0;
     VCiva6    = 0;
     VPrec6    = 0;
     VCrec6    = 0;
     VPret6    = 0;
     VCret6    = 0;
     VCbas6    = 0;

     Linea         = 0;
     VarAnyo       = "";
     CantiTope     = 0;
     NumeFact      = 0;
     Varalfa       = "";
     Varalfa1      = "";
     Varalfa2      = "";
     NumeDocu      = 0;
     FechaApu      = @;

     &EURODB       = 0;
|FIN;

|INCLUYE i_ficher;

|PROGRAMA;
|ABRE #6;
|LEE 040#6p;
|SI FSalida ! 0; |DDEFECTO #6; |FINSI;
|CIERRA #6;

|SI #6#92 = 0;
    |MENAV "      Introduzca en el control del libro Cantidad Maxima";
    |ACABA;
|FINSI;

comienza = "34";  |HAZ fichero;
|NOME_DAT #99 fichero;

|CLS;
|CABEZA "Introduccion F.Englobadas";
|PARA; |SI; |HACIENDO;
     |ABRE #99; |CIERRA #99; |DELINDEX #99;

     |DDEFECTO #0;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida ! 0; |SAL; |FINSI;
|SIGUE;
|ABRE #99; |CIERRA #99; |DELINDEX #99;
|FPRO;

|PROCESO Actividad; |TIPO 0;
|ABRE #5;
#5#0 = #0#0;
#5#1 = #0#3;
#5#2 = #0#2;
|LEE 040#5=;
|SI FSalida ! 0; |DDEFECTO #5; |FINSI;
|CIERRA #5;

|PINTA 1414, "      ";
|PINTA 1514, "      ";
|PINTA 1614, "      ";
|PINTA 1714, "      ";
|PINTA 1814, "      ";
|PINTA 1914, "      ";

|SI #5#50 = 1;
    |PARA XPara = 13; |SI XPara [ 38; |HACIENDO XPara = XPara + 5;
          |C_V #0XPara, 1, "S";
          |C_M #0XPara, 1, "S";
    |SIGUE;

    |PARA XPara = 48; |SI XPara [ 53; |HACIENDO XPara = XPara + 1;
          |C_V #0XPara, 1, "N";
          |C_M #0XPara, 1, "N";
    |SIGUE;
|SINO;
    |PARA XPara = 13; |SI XPara [ 38; |HACIENDO XPara = XPara + 5;
          |C_V #0XPara, 1, "N";
          |C_M #0XPara, 1, "N";
    |SIGUE;

    |PARA XPara = 48; |SI XPara [ 53; |HACIENDO XPara = XPara + 1;
          |C_V #0XPara, 1, "S";
          |C_M #0XPara, 1, "S";
    |SIGUE;
|FINSI;
|FPRC;

|PROCESO ChequeaCliente; |TIPO 0;
#0#5 = 1;

|ABRE #4;
|SELECT #1#4;
#4#0 = #0#0;
#4#1 = #0#6;
#4#2 = #0#5;
|LEE 040#4=;
|SI FSalida ! 0;
    |DDEFECTO #4;
    |CIERRA #4;
    |MENAV "     No existe Cliente.";
    |ERROR;
    |ACABA;
|FINSI;
|CIERRA #4;

#0#7 = #4#4;   |PINTA #0#7;
|FPRC;

|PROCESO Trimestre; |TIPO 0;
MesAlfa = #0#8 % 402;
|SI MesAlfa [ "03"; #0#9 = 1; |PINTA #0#9; |ACABA; |FINSI;
|SI MesAlfa [ "06"; #0#9 = 2; |PINTA #0#9; |ACABA; |FINSI;
|SI MesAlfa [ "09"; #0#9 = 3; |PINTA #0#9; |ACABA; |FINSI;
#0#9 = 4; |PINTA #0#9;
|FPRC;

|PROCESO Concepto; |TIPO 0;
|SI Campo > 38; |Y #5#50 = 1; |ACABA; |FINSI;
|SI Campo < 48; |Y #5#50 = 2; |ACABA; |FINSI;

|SI #5#50 = 1;
    Campos1 = Campo + 1;
    Campos2 = Campo + 2;
    Campos3 = Campo + 3;
    Campos4 = Campo + 4;
|SINO;
    |SI Campo = 48; Conta = 34; |FINSI;
    |SI Campo = 49; Conta = 30; |FINSI;
    |SI Campo = 50; Conta = 26; |FINSI;
    |SI Campo = 51; Conta = 22; |FINSI;
    |SI Campo = 52; Conta = 18; |FINSI;
    |SI Campo = 53; Conta = 14; |FINSI;

    Campos1 = Campo - Conta;
    Campos2 = Campo - (Conta - 1);
    Campos3 = Campo - (Conta - 2);
    Campos4 = Campo - (Conta - 3);
|FINSI;

|SI Campo = 13;
    |SI #0Campo = 0;
        |MENAV "      Introduzca Concepto.";
        |ERROR;
        |ACABA;
    |FINSI;
|FINSI;

|SI Campo = 48;
    |SI #0Campo = "      ";
        |MENAV "      Introduzca Concepto.";
        |ERROR;
        |ACABA;
    |FINSI;
|FINSI;

|C_M #0Campos2, 1, "S";
|C_M #0Campos3, 1, "S";
|C_M #0Campos4, 1, "S";

#0Campos2 = #4#14;  |PINTA #0Campos2;
#0Campos3 = #4#15;  |PINTA #0Campos3;
#0Campos4 = #4#22;  |PINTA #0Campos4;

|SI #5#50 = 1;
    |SI #0Campo = 0;
        #0Campos1 = "";        |PINTA #0Campos1;
        #0Campos2 = 0;         |PINTA #0Campos2;
        #0Campos3 = 0;         |PINTA #0Campos3;
        #0Campos4 = 0;         |PINTA #0Campos4;

        |C_M #0Campos2, 1, "N";
        |C_M #0Campos3, 1, "N";
        |C_M #0Campos4, 1, "N";
        |ACABA;
    |FINSI;

    |ABRE #3;
    #3#0 = #0Campo;
    |LEE 040#3=;
    |SI FSalida ! 0;
        |CIERRA #3;
        |MENAV "      El concepto no existe.";
        |ERROR;
        |ACABA;
    |FINSI;
    |CIERRA #3;

    |SI #3#3 = "G";
        |MENAV "      El concepto es de Gasto.";
        |ERROR;
    |FINSI;

    |SI #3#2 = "N";
        #0Campos2 = 0;         |PINTA #0Campos2;
        #0Campos3 = 0;         |PINTA #0Campos3;
        #0Campos4 = 0;         |PINTA #0Campos4;

        |C_M #0Campos2, 1, "N";
        |C_M #0Campos3, 1, "N";
        |C_M #0Campos4, 1, "N";
    |FINSI;

    #0Campos1 = #3#1; |PINTA #0Campos1;
|SINO;
    |SI #0Campo = "      ";
        #0Campos1 = "";        |PINTA #0Campos1;
        #0Campos2 = 0;         |PINTA #0Campos2;
        #0Campos3 = 0;         |PINTA #0Campos3;
        #0Campos4 = 0;         |PINTA #0Campos4;

        |C_M #0Campos2, 1, "N";
        |C_M #0Campos3, 1, "N";
        |C_M #0Campos4, 1, "N";
        |ACABA;
    |FINSI;

    |ABRE #13;
    #13#0 = #0Campo;
    |LEE 040#13=;
    |SI FSalida ! 0;
        |CIERRA #13;
        |MENAV "      El concepto no existe.";
        |ERROR;
        |ACABA;
    |FINSI;
    |CIERRA #13;

    |SI #13#3 = "G";
        |MENAV "      El concepto es de Gasto.";
        |ERROR;
    |FINSI;

    |SI #13#2 = "N";
        #0Campos2 = 0;         |PINTA #0Campos2;
        #0Campos3 = 0;         |PINTA #0Campos3;
        #0Campos4 = 0;         |PINTA #0Campos4;

        |C_M #0Campos2, 1, "N";
        |C_M #0Campos3, 1, "N";
        |C_M #0Campos4, 1, "N";
    |FINSI;

    #0Campos1 = #13#1; |PINTA #0Campos1;
|FINSI;

|SI #5#17 = "N";
    #0Campos2 = 0;         |PINTA #0Campos2;
    #0Campos3 = 0;         |PINTA #0Campos3;
    #0Campos4 = 0;         |PINTA #0Campos4;

    |C_M #0Campos2, 1, "N";
    |C_M #0Campos3, 1, "N";
    |C_M #0Campos4, 1, "N";
|FINSI;

|SI #5#17 = "R";
    #0Campos4 = 0;         |PINTA #0Campos4;
    |C_M #0Campos4, 1, "N";
|FINSI;

|SI #5#17 = "T";
    #0Campos3 = 0;         |PINTA #0Campos3;
    |C_M #0Campos3, 1, "N";
|FINSI;
|FPRC;

|RUTINA ClaveBaja;
#99#0 = 1;
|FRUT;

|RUTINA ClaveAlta;
#99#0 = 999;
|FRUT;

|RUTINA ClaveBaja98;
#98#0 = 1;
|FRUT;

|RUTINA ClaveAlta98;
#98#0 = 9999;
|FRUT;

|PROCESO TipoLinea; |TIPO 0;
|SI #5#50 = 1;
    |SI #99#1 = 2; |Y #0#18 = 0;
        |MENAV "      No existe Concepto en el Tipo 2.";
        |ERROR;
        |ACABA;
    |FINSI;

    |SI #99#1 = 3; |Y #0#23 = 0;
        |MENAV "      No existe Concepto en el Tipo 3.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 4; |Y #0#28 = 0;
        |MENAV "      No existe Concepto en el Tipo 4.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 5; |Y #0#33 = 0;
        |MENAV "      No existe Concepto en el Tipo 5.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 6; |Y #0#38 = 0;
        |MENAV "      No existe Concepto en el Tipo 6.";
        |ERROR;
    |FINSI;
|SINO;
    |SI #99#1 = 2; |Y #0#49 = "      ";
        |MENAV "      No existe Concepto en el Tipo 2.";
        |ERROR;
        |ACABA;
    |FINSI;

    |SI #99#1 = 3; |Y #0#50 = "      ";
        |MENAV "      No existe Concepto en el Tipo 3.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 4; |Y #0#51 = "      ";
        |MENAV "      No existe Concepto en el Tipo 4.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 5; |Y #0#52 = "      ";
        |MENAV "      No existe Concepto en el Tipo 5.";
        |ERROR;
    |FINSI;

    |SI #99#1 = 6; |Y #0#53 = "      ";
        |MENAV "      No existe Concepto en el Tipo 6.";
        |ERROR;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO BorraTopes;
VTipo1 = 0;
VConc1 = 0;
VCona1 = "";
VConn1 = "";
VPiva1 = 0;
VCiva1 = 0;
VPrec1 = 0;
VCrec1 = 0;
VPret1 = 0;
VCret1 = 0;
VCbas1 = 0;

VTipo2 = 0;
VConc2 = 0;
VCona2 = "";
VConn2 = "";
VPiva2 = 0;
VCiva2 = 0;
VPrec2 = 0;
VCrec2 = 0;
VPret2 = 0;
VCret2 = 0;
VCbas2 = 0;

VTipo3 = 0;
VConc3 = 0;
VCona3 = "";
VConn3 = "";
VPiva3 = 0;
VCiva3 = 0;
VPrec3 = 0;
VCrec3 = 0;
VPret3 = 0;
VCret3 = 0;
VCbas3 = 0;

VTipo4 = 0;
VConc4 = 0;
VCona4 = "";
VConn4 = "";
VPiva4 = 0;
VCiva4 = 0;
VPrec4 = 0;
VCrec4 = 0;
VPret4 = 0;
VCret4 = 0;
VCbas4 = 0;

VTipo5 = 0;
VConc5 = 0;
VCona5 = "";
VConn5 = "";
VPiva5 = 0;
VCiva5 = 0;
VPrec5 = 0;
VCrec5 = 0;
VPret5 = 0;
VCret5 = 0;
VCbas5 = 0;

VTipo6 = 0;
VConc6 = 0;
VCona6 = "";
VConn6 = "";
VPiva6 = 0;
VCiva6 = 0;
VPrec6 = 0;
VCrec6 = 0;
VPret6 = 0;
VCret6 = 0;
VCbas6 = 0;

NumeDocu = 0;
|FPRC;

|PROCESO PonDescripcion;           || Descripcion Ampliada
Varalfa = #0#12;  |QBF Varalfa;
|SI Varalfa ! "***";
    #2#6  = #0#12;                            || Descripcion Ampliada
    #2#16 = #0#11;                            || Factura
    |ACABA;
|FINSI;

Varalfa1    = NumeDocu;   Varalfa1    = ("000000" + Varalfa1) % -106
Varalfa2    = NumeFact;   Varalfa2    = ("000000" + Varalfa2) % -106

#2#6 = "FRA." + Varalfa1 + " AL " +  Varalfa2;    || Descripcion Ampliada
|FPRC;

|PROCESO GrabaLinea;
Linea = Linea + 1;

#2#0  = #0#0;                             || Empresa
#2#1  = Linea;                            || Linea
#2#2  = 1;                                || Tipo Cliente
#2#3  = #0#6;                             || Codigo Cliente
#2#4  = (FechaApu % 102) + (FechaApu % 402);  || Formato Fecha (DD/MM)
#2#5  = VConc1;                           || Codigo Concepto Nume 2 1

|HAZ PonDescripcion;

#2#7  = VCbas1;                           || Base Imponible 1
#2#8  = VPiva1;                           || Porcentaje IVA 1
#2#9  = VCiva1;                           || Cantidad IVA 1
#2#10 = VPrec1;                           || Porcentaje Recargo 1
#2#11 = VCrec1;                           || Cantidad Recargo  1
#2#12 = #4#3;                             || DNI Cliente
#2#13 = FechaApu;                         || Fecha (DD/MM/AAAA)
#2#14 = #0#2;                             || A¤o
#2#15 = #0#10;                            || Serie
#2#16 = NumeDocu;                         || Factura
#2#17 = #0#9;                             || Trimestre
#2#18 = "N";                              || Pasado al 300
#2#19 = #0#3;                             || Actividad
#2#20 = "S";                              || Englobadas
#2#21 = (NumeFact - NumeDocu) + 1;        || Numero Facturas
#2#23 = VCbas2;                           || Base Imponible 2
#2#24 = VCbas3;                           || Base Imponible 3
#2#25 = VPiva2;                           || Porcentaje IVA 2
#2#26 = VPiva3;                           || Porcentaje IVA 3
#2#27 = VCiva2;                           || Cantidad IVA 2
#2#28 = VCiva3;                           || Cantidad IVA 3
#2#29 = VPrec2;                           || Porcentaje Recargo 2
#2#30 = VPrec3;                           || Porcentaje Recargo 3
#2#31 = VCrec2;                           || Cantidad Recargo  2
#2#32 = VCrec3;                           || Cantidad Recargo  3
#2#33 = VConc2;                           || Codigo Concepto Nume 2 2
#2#34 = VConc3;                           || Codigo Concepto Nume 2 3
#2#35 = VConn1;                           || Descripcion Concepto 1
#2#36 = VConn2;                           || Descripcion Concepto 2
#2#37 = VConn3;                           || Descripcion Concepto 3
#2#38 = #0#7;                             || Nombre cliente
#2#39 = VPret1;                           || Porcentaje Retencion 1
#2#40 = VPret2;                           || Porcentaje Retencion 2
#2#41 = VPret3;                           || Porcentaje Retencion 3
#2#42 = VCret1;                           || Cantidad Retencion  1
#2#43 = VCret2;                           || Cantidad Retencion  2
#2#44 = VCret3;                           || Cantidad Retencion  3

#2#45 = VCbas4;                           || Base Imponible 4
#2#46 = VCbas5;                           || Base Imponible 5
#2#47 = VCbas6;                           || Base Imponible 6
#2#48 = VPiva4;                           || Porcentaje IVA 4
#2#49 = VPiva5;                           || Porcentaje IVA 5
#2#50 = VPiva6;                           || Porcentaje IVA 6
#2#51 = VCiva4;                           || Cantidad IVA 4
#2#52 = VCiva5;                           || Cantidad IVA 5
#2#53 = VCiva6;                           || Cantidad IVA 6
#2#54 = VPrec4;                           || Porcentaje Recargo 4
#2#55 = VPrec5;                           || Porcentaje Recargo 5
#2#56 = VPrec6;                           || Porcentaje Recargo 6
#2#57 = VCrec4;                           || Cantidad Recargo  4
#2#58 = VCrec5;                           || Cantidad Recargo  5
#2#59 = VCrec6;                           || Cantidad Recargo  6
#2#60 = VConc4;                           || Codigo Concepto Nume 2 4
#2#61 = VConc5;                           || Codigo Concepto Nume 2 5
#2#62 = VConc6;                           || Codigo Concepto Nume 2 6
#2#63 = VConn4;                           || Descripcion Concepto 4
#2#64 = VConn5;                           || Descripcion Concepto 5
#2#65 = VConn6;                           || Descripcion Concepto 6
#2#66 = VPret4;                           || Porcentaje Retencion 4
#2#67 = VPret5;                           || Porcentaje Retencion 5
#2#68 = VPret6;                           || Porcentaje Retencion 6
#2#69 = VCret4;                           || Cantidad Retencion  4
#2#70 = VCret5;                           || Cantidad Retencion  5
#2#71 = VCret6;                           || Cantidad Retencion  6

#2#72 = VCona1;                           || Codigo Concepto Alfa 6 1
#2#73 = VCona2;                           || Codigo Concepto Alfa 6 2
#2#74 = VCona3;                           || Codigo Concepto Alfa 6 3
#2#75 = VCona4;                           || Codigo Concepto Alfa 6 4
#2#76 = VCona5;                           || Codigo Concepto Alfa 6 5
#2#77 = VCona6;                           || Codigo Concepto Alfa 6 6

#2#22 = #2#7  + #2#23 + #2#24 + #2#45 + #2#46 + #2#47;
#2#22 = #2#22 + #2#9  + #2#27 + #2#28 + #2#51 + #2#52 + #2#53;
#2#22 = #2#22 + #2#11 + #2#31 + #2#32 + #2#57 + #2#58 + #2#59;
#2#22 = #2#22 - #2#42 - #2#43 - #2#44 - #2#69 - #2#70 - #2#71;

|GRABA 140#2n;

#1#5 = #1#5 + #2#7  + #2#23 + #2#24 + #2#45 + #2#46 + #2#47;
#1#6 = #1#6 + #2#9  + #2#27 + #2#28 + #2#51 + #2#52 + #2#53;
#1#7 = #1#7 + #2#11 + #2#31 + #2#32 + #2#57 + #2#58 + #2#59;
#1#9 = #1#9 + #2#42 + #2#43 + #2#44 + #2#69 + #2#70 + #2#71;
#1#8 = #1#5 + #1#6  + #1#7  - #1#9;

|HAZ BorraTopes;
|FPRC;

|PROCESO CargaTopes;
|SI NumeDocu = 0;
    |SI NumeFact = 0; NumeDocu = #99#3;        |FINSI;
    |SI NumeFact ! 0; NumeDocu = NumeFact + 1; |FINSI;
    FechaApu = #99#2;
|FINSI;

NumeFact = #99#3;

|SI #99#1 = 1;
    Campos1 = #0#15; Campos2 = #0#16; Campos3 = #0#17;
    Campos4 = #0#13; Campos5 = #0#14; Campos6 = #0#48;
|FINSI;

|SI #99#1 = 2;
    Campos1 = #0#20;  Campos2 = #0#21;  Campos3 = #0#22;
    Campos4 = #0#18;  Campos5 = #0#19;  Campos6 = #0#49;
|FINSI;

|SI #99#1 = 3;
    Campos1 = #0#25;  Campos2 = #0#26;  Campos3 = #0#27;
    Campos4 = #0#23;  Campos5 = #0#24;  Campos6 = #0#50;
|FINSI;

|SI #99#1 = 4;
    Campos1 = #0#30;  Campos2 = #0#31;  Campos3 = #0#32;
    Campos4 = #0#28;  Campos5 = #0#29;  Campos6 = #0#51;
|FINSI;

|SI #99#1 = 5;
    Campos1 = #0#35;  Campos2 = #0#36;  Campos3 = #0#37;
    Campos4 = #0#33;  Campos5 = #0#34;  Campos6 = #0#52;
|FINSI;

|SI #99#1 = 6;
    Campos1 = #0#40;  Campos2 = #0#41;  Campos3 = #0#42;
    Campos4 = #0#38;  Campos5 = #0#39;  Campos6 = #0#53;
|FINSI;

|SI #5#50 = 1;
    #3#0 = Campos4;
    |LEE 040#3=;
    |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
    CalIRPF = #3#9;
|SINO;
    #13#0 = Campos6;
    |LEE 040#13=;
    |SI FSalida ! 0; |DDEFECTO #13; |FINSI;
    CalIRPF = #13#9;
|FINSI;

|SI #5#17 ! "I";
    |SI CalIRPF = 1;
        CampoBase = #99#4;
        CampoIva  = (#99#4 % Campos1) ! EURODB;
        CampoRec  = (#99#4 % Campos2) ! EURODB;
        CampoRet  = (#99#4 % Campos3) ! EURODB;
    |SINO;
        CampoBase = #99#4;
        CampoIva  = (#99#4 % Campos1) ! EURODB;
        CampoRec  = (#99#4 % Campos2) ! EURODB;
        CampoRet  = ((#99#4 + CampoIva + CampoRec) % Campos3) ! EURODB;
    |FINSI;
|SINO;
    LaBase    = #99#4;
    CampoBase = #99#4;
    CampoIva  = 0;
    CampoRec  = 0;
    CampoRet  = 0;

    |SI CalIRPF = 1;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 - Campos3 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec - CampoRet);
    |SINO;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec);
    |FINSI;
|FINSI;

|SI #99#1 = VTipo1;
    VCiva1 = VCiva1 + CampoIva;
    VCrec1 = VCrec1 + CampoRec;
    VCret1 = VCret1 + CampoRet;
    VCbas1 = VCbas1 + CampoBase;
    |ACABA;
|FINSI;

|SI #99#1 = VTipo2;
    VCiva2 = VCiva2 + CampoIva;
    VCrec2 = VCrec2 + CampoRec;
    VCret2 = VCret2 + CampoRet;
    VCbas2 = VCbas2 + CampoBase;
    |ACABA;
|FINSI;

|SI #99#1  = VTipo3;
    VCiva3 = VCiva3 + CampoIva;
    VCrec3 = VCrec3 + CampoRec;
    VCret3 = VCret3 + CampoRet;
    VCbas3 = VCbas3 + CampoBase;
    |ACABA;
|FINSI;

|SI #99#1  = VTipo4;
    VCiva4 = VCiva4 + CampoIva;
    VCrec4 = VCrec4 + CampoRec;
    VCret4 = VCret4 + CampoRet;
    VCbas4 = VCbas4 + CampoBase;
    |ACABA;
|FINSI;

|SI #99#1  = VTipo5;
    VCiva5 = VCiva5 + CampoIva;
    VCrec5 = VCrec5 + CampoRec;
    VCret5 = VCret5 + CampoRet;
    VCbas5 = VCbas5 + CampoBase;
    |ACABA;
|FINSI;

|SI #99#1  = VTipo6;
    VCiva6 = VCiva6 + CampoIva;
    VCrec6 = VCrec6 + CampoRec;
    VCret6 = VCret6 + CampoRet;
    VCbas6 = VCbas6 + CampoBase;
    |ACABA;
|FINSI;

|SI VTipo1 = 0;
    VTipo1 = #99#1;
    VConc1 = Campos4;      VConn1 = Campos5;
    VPiva1 = Campos1;      VCiva1 = CampoIva;
    VPrec1 = Campos2;      VCrec1 = CampoRec;
    VPret1 = Campos3;      VCret1 = CampoRet;
    VCbas1 = CampoBase;    VCona1 = Campos6;
    |ACABA;
|FINSI;

|SI VTipo2 = 0;
    VTipo2 = #99#1;
    VConc2 = Campos4;      VConn2 = Campos5;
    VPiva2 = Campos1;      VCiva2 = CampoIva;
    VPrec2 = Campos2;      VCrec2 = CampoRec;
    VPret2 = Campos3;      VCret2 = CampoRet;
    VCbas2 = CampoBase;    VCona2 = Campos6;
    |ACABA;
|FINSI;

|SI VTipo3 = 0;
    VTipo3 = #99#1;
    VConc3 = Campos4;      VConn3 = Campos5;
    VPiva3 = Campos1;      VCiva3 = CampoIva;
    VPrec3 = Campos2;      VCrec3 = CampoRec;
    VPret3 = Campos3;      VCret3 = CampoRet;
    VCbas3 = CampoBase;    VCona3 = Campos6;
    |ACABA;
|FINSI;

|SI VTipo4 = 0;
    VTipo4 = #99#1;
    VConc4 = Campos4;      VConn4 = Campos5;
    VPiva4 = Campos1;      VCiva4 = CampoIva;
    VPrec4 = Campos2;      VCrec4 = CampoRec;
    VPret4 = Campos3;      VCret4 = CampoRet;
    VCbas4 = CampoBase;    VCona4 = Campos6;
    |ACABA;
|FINSI;

|SI VTipo5 = 0;
    VTipo5 = #99#1;
    VConc5 = Campos4;      VConn5 = Campos5;
    VPiva5 = Campos1;      VCiva5 = CampoIva;
    VPrec5 = Campos2;      VCrec5 = CampoRec;
    VPret5 = Campos3;      VCret5 = CampoRet;
    VCbas5 = CampoBase;    VCona5 = Campos6;
    |ACABA;
|FINSI;

|SI VTipo6 = 0;
    VTipo6 = #99#1;
    VConc6 = Campos4;      VConn6 = Campos5;
    VPiva6 = Campos1;      VCiva6 = CampoIva;
    VPrec6 = Campos2;      VCrec6 = CampoRec;
    VPret6 = Campos3;      VCret6 = CampoRet;
    VCbas6 = CampoBase;    VCona6 = Campos6;
    |ACABA;
|FINSI;
|FPRC;

|PROCESO LaCantidad;
LaCantidad = 0;

|SI #99#1 = 1;
    Campos1 = #0#15; Campos2 = #0#16; Campos3 = #0#17;
    Campos4 = #0#13; Campos5 = #0#14; Campos6 = #0#48;
|FINSI;

|SI #99#1 = 2;
    Campos1 = #0#20;  Campos2 = #0#21;  Campos3 = #0#22;
    Campos4 = #0#18;  Campos5 = #0#19;  Campos6 = #0#49;
|FINSI;

|SI #99#1 = 3;
    Campos1 = #0#25;  Campos2 = #0#26;  Campos3 = #0#27;
    Campos4 = #0#23;  Campos5 = #0#24;  Campos6 = #0#50;
|FINSI;

|SI #99#1 = 4;
    Campos1 = #0#30;  Campos2 = #0#31;  Campos3 = #0#32;
    Campos4 = #0#28;  Campos5 = #0#29;  Campos6 = #0#51;
|FINSI;

|SI #99#1 = 5;
    Campos1 = #0#35;  Campos2 = #0#36;  Campos3 = #0#37;
    Campos4 = #0#33;  Campos5 = #0#34;  Campos6 = #0#52;
|FINSI;

|SI #99#1 = 6;
    Campos1 = #0#40;  Campos2 = #0#41;  Campos3 = #0#42;
    Campos4 = #0#38;  Campos5 = #0#39;  Campos6 = #0#53;
|FINSI;

|SI #5#50 = 1;
    #3#0 = Campos4;
    |LEE 040#3=;
    |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
    CalIRPF = #3#9;
|SINO;
    #13#0 = Campos6;
    |LEE 040#13=;
    |SI FSalida ! 0; |DDEFECTO #13; |FINSI;
    CalIRPF = #13#9;
|FINSI;

|SI #5#17 ! "I";
    |SI CalIRPF = 1;
        CampoBase = #99#4;
        CampoIva  = (#99#4 % Campos1) ! EURODB;
        CampoRec  = (#99#4 % Campos2) ! EURODB;
        CampoRet  = (#99#4 % Campos3) ! EURODB;
    |SINO;
        CampoBase = #99#4;
        CampoIva  = (#99#4 % Campos1) ! EURODB;
        CampoRec  = (#99#4 % Campos2) ! EURODB;
        CampoRet  = ((#99#4 + CampoIva + CampoRec) % Campos3) ! EURODB;
    |FINSI;
|SINO;
    LaBase    = #99#4;
    CampoBase = #99#4;
    CampoIva  = 0;
    CampoRec  = 0;
    CampoRet  = 0;

    |SI CalIRPF = 1;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 - Campos3 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec - CampoRet);
    |SINO;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec);
    |FINSI;
|FINSI;

LaCantidad = CampoBase + CampoIva + CampoRec - CampoRet;
|FPRC;

|PROCESO ChequeaCanti;
               || \\ *********************************** PROCESO INCIDENCIAS

|SI ModoChequeo = 0;
    |SI NDocumento > #99#3; |Y NDocumento ! 0;
        ReferError = ReferError + 1;
        #98#0 = ReferError;
        #98#1 = "N§DOC: " + #99#3 + " TIENE FECHA SUPERIOR A OTRO N§.SUPERIOR Y FECHA INFERIOR";
        |GRABA 000#98n;
        ErrorFatal  = 1;
        |ACABA;
    |FINSI;

    |SI #99#3 = NDocumento; |Y NDocumento ! 0;
        ReferError  = ReferError + 1;
        #98#0 = ReferError;
        #98#1 = "EL DOCUMENTO N§ : " + #99#3 + " ESTA REPETIDO";
        |GRABA 000#98n;
        ErrorFatal  = 1;
        |ACABA;
    |FINSI;

    NDocumento = NDocumento + 1;
    |SI #99#3 ! NDocumento; |Y NDocumento ! 1;
        ReferError  = ReferError + 1;
        NDocumento1 = #99#3 - 1;

        #98#0 = ReferError;
        #98#1 = "FALTAN DOCUMENTOS DEL N§ : " + NDocumento + " AL N§ : " + NDocumento1;
        |GRABA 000#98n;
    |FINSI;

    NDocumento  = #99#3;
    |ACABA;
|FINSI;

               || \\ ************************************** PROCESO GRABACION

|HAZ LaCantidad;

|SI LaCantidad > #6#92;
    |SI CantiTope ! 0; |HAZ GrabaLinea; |FINSI;
    |HAZ CargaTopes;
    |HAZ GrabaLinea;
    CantiTope = 0;
    |ACABA;
|FINSI;

CantiTope = CantiTope + LaCantidad;
|SI CantiTope > #6#92;
    |HAZ GrabaLinea;

    CantiTope = LaCantidad;
    |HAZ CargaTopes;
|SINO;
    |HAZ CargaTopes;
    |SI CantiTope = #6#92;
        |HAZ GrabaLinea;
        CantiTope = 0;
    |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE eosw0034;
#99#2;
;
"00.00.0000", 000000;
"31.12.2999", 999999;
;
NULL, ChequeaCanti;
|FIN;

|PROCESO Tipo3; |TIPO 3;
|SI #5#50 = 1;
    Suma = #0#13 + #0#18 + #0#23 + #0#28 + #0#33 + #0#38;
    |SI Suma = 0; |ACABA; |FINSI;
|SINO;
    |SI #0#48 = "      "; |Y  #0#49 = "      "; |Y  #0#50 = "      ";
     |Y #0#51 = "      "; |Y  #0#52 = "      "; |Y  #0#53 = "      ";
        |ACABA;
    |FINSI;
|FINSI;

|PINPA #1#0;

|ET AquiArriba;

    |ABRE #3;
    |ABRE #13;
    |ENTLINEAL #1#99, 1, 1, 20, 0, ClaveBaja, ClaveAlta;
    |CIERRA #3;
    |CIERRA #13;

    |CONFI "2400SActualizamos libros : ";
    |SI FSalida ! 0;
        |CONFI "2400SDesea volver a introducir o modificar importes : ";
        |SI FSalida = 0;  |VETE AquiArriba; |FINSI;
        |ACABA;
    |FINSI;

comienza = "38";  |HAZ fichero;
|NOME_DAT #98 fichero;
|ABRE #98; |CIERRA #98; |DELINDEX #98;

NDocumento  = 0;
NDocumento1 = 0;
ReferError  = 0;
ErrorFatal  = 0;

|ABRE #98; ModoChequeo = 0; |BUCLE eosw0034; |CIERRA #98;

|SI ReferError > 0;
    |PUSHV  0501 2380;
    |ENTLINEAL #1#98, 1, 4, 20, 1, ClaveBaja98, ClaveAlta98;
    |POPV;
    |ABRE #98; |CIERRA #98; |DELINDEX #98;
    |SI ErrorFatal = 1;
        |MENAV "     EXISTEN ERRORES FATALES, NO PUEDO HACER LA ACTUALIZACION";
        |VETE AquiArriba;
    |SINO;
        |MENSA "     EXISTEN ERRORES LEVES ";
        |CONFI "2400NPONEMOS LAS FACTURAS QUE FALTAN VALOR CERO Y SEGUIMOS LA ACTUALIZACION :";
        |SI FSalida ! 0;  |VETE AquiArriba; |FINSI;
    |FINSI;
|FINSI;

|ABRE #7;
#7#0 = #0#0;
|LEE 040#7=;
|SI FSalida ! 0; |DDEFECTO #7; |FINSI;
|CIERRA #7;

fichero = #0#0;
fichero = ("00000" + fichero) % -105;
fichero = fichero % -105;
VarAnyo    = #0#2;
VarAnyo    = ("00" + VarAnyo) % -102;
fichero = "v" + fichero + VarAnyo;
|NOME_DAT #2fichero;

|ABRE #1;
#1#0 = #0#0;
#1#4 = #0#2;
|LIBERA #1;
|LEE 140#1=;
|SI FSalida ! 0;
    #1#0 = #0#0;
    #1#4 = #0#2;
    #1#1 = #0#1;
    #1#2 = #7#1;
    #1#3 = 1;
    #1#5 = 0;
    #1#6 = 0;
    #1#7 = 0;
    #1#8 = 0;
    #1#9 = 0;
    |GRABA 140#1b;
|FINSI;

|ABRE #3;
|ABRE #13;
|ABRE #2;
|LEE 040#2u;
Linea = #2#1;
|SI FSalida ! 0; Linea = 0; |FINSI;

NumeDocu  = 0;
CantiTope = 0;
|HAZ BorraTopes;
ModoChequeo = 1; |BUCLE eosw0034;

|SI CantiTope ! 0; |HAZ GrabaLinea; |FINSI;

|GRABA 140#1a;
|CIERRA #1;
|CIERRA #2;
|CIERRA #3;
|CIERRA #13;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
|SI #99#1 = 1; Campos1 = #0#15; Campos2 = #0#16; Campos3 = #0#17; Campos4 = 13; Campos7 = 48; |FINSI;
|SI #99#1 = 2; Campos1 = #0#20; Campos2 = #0#21; Campos3 = #0#22; Campos4 = 18; Campos7 = 49; |FINSI;
|SI #99#1 = 3; Campos1 = #0#25; Campos2 = #0#26; Campos3 = #0#27; Campos4 = 23; Campos7 = 50; |FINSI;
|SI #99#1 = 4; Campos1 = #0#30; Campos2 = #0#31; Campos3 = #0#32; Campos4 = 28; Campos7 = 51; |FINSI;
|SI #99#1 = 5; Campos1 = #0#35; Campos2 = #0#36; Campos3 = #0#37; Campos4 = 33; Campos7 = 52; |FINSI;
|SI #99#1 = 6; Campos1 = #0#40; Campos2 = #0#41; Campos3 = #0#42; Campos4 = 38; Campos7 = 53; |FINSI;

|SI #5#50 = 1;
    #3#0 = #0Campos4;
    |LEE 040#3=;
    |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
    CalIRPF = #3#9;
|SINO;
    #13#0 = #0Campos7;
    |LEE 040#13=;
    |SI FSalida ! 0; |DDEFECTO #13; |FINSI;
    CalIRPF = #13#9;
|FINSI;

|SI #5#17 ! "I";
    #0#43 = #0#43 +. #99#4;
    #0#44 = #0#44 +. (#99#4 % Campos1);
    #0#45 = #0#45 +. (#99#4 % Campos2);
    |SI CalIRPF = 1;
        #0#46 = #0#46 +. (#99#4 % Campos3);
    |SINO;
        #0#46 = #0#46 +. ((#99#4 + (#99#4 % Campos1) + (#99#4 % Campos2)) % Campos3);
    |FINSI;
    #0#47 = #0#43 + #0#44 + #0#45 - #0#46
|SINO;
    LaBase    = #99#4;
    CampoBase = #99#4;
    CampoIva  = 0;
    CampoRec  = 0;
    CampoRet  = 0;

    |SI CalIRPF = 1;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 - Campos3 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec - CampoRet);
    |SINO;
        CampoRet  = ((CampoBase * Campos3) / 100) ! EURODB;
        CampoBase = ((CampoBase * 100) / (Campos1 + Campos2 + 100)) ! EURODB;
        CampoIva  = ((CampoBase * Campos1) / 100) ! EURODB;
        CampoRec  = ((CampoBase * Campos2) / 100) ! EURODB;
        CampoBase = LaBase - (CampoIva + CampoRec);
    |FINSI;
    #0#43 = #0#43 +. CampoBase;
    #0#44 = #0#44 +. CampoIva;
    #0#45 = #0#45 +. CampoRec;
    #0#46 = #0#46 +. CampoRet;
    #0#47 = #0#43 + #0#44 + #0#45 - #0#46;
|FINSI;

|PINTA #0#43;
|PINTA #0#44;
|PINTA #0#45;
|PINTA #0#46;
|PINTA #0#47;
|FPRC;

|PROCESO Tipo11; |TIPO 11;
|SI FSalida = 9;
    |PUSHV 0501 2380;
    |PINPA #0#0;  |PINDA #0#0;
    |PAUSA;
    |PINPA #1#0;
    |POPV;
    |PINDA #1#0;
|FINSI;
|FPRC;

|PROCESO Defectos99; |TIPO 7;
Modo = (FEntrada / 100) ! 0;
|SI Modo ! 1; |ACABA; |FINSI;

|SI #99#0 = 1;
    #99#2 = #0#8;                |PINTA #99#2;
    #99#3 = (#0#11 + #99#0) - 1; |PINTA #99#3;
|SINO;
    #99#2 = FechaAnterior;       |PINTA #99#2;
    #99#3 = NDocuAnterior + 1;   |PINTA #99#3;
|FINSI;
|FPRC;

|PROCESO CogeAnterior; |TIPO 0;
|SI Modo ! 1; |ACABA; |FINSI;

FechaAnterior = #99#2;
NDocuAnterior = #99#3;
|FPRC;
