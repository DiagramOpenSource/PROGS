|FICHEROS;
     reoy0002 #0;
     eosm0023 #1;
     eosm0024 #2;
     eosactiv #3;
|FIN;


|VARIABLES;
     fFecha    = @;

     aAlfa     = "";
     aFichero  = "";

     nCampos   = 0;

     &nAmort       = 0;
     &nVAnyo       = 0;
     &nCAnyo       = 0;
     &nPendiente   = 0;
     &nTCompra     = 0;
     &nPorceA      = 0;
     &nPorceD      = 0;
     &nImport      = 0;
     &nTipoMod     = 0;
     &enImpProv    = 0;

     &fFechaUso    = @;
     &fFechaCompra = @;
     &fFechaVenta  = @;
     &fPriCompra   = @;
     &fFinCompra   = @;
     &fPriVenta    = @;
     &fFinVenta    = @;
|FIN;

|INCLUYE i_consul;

|PROCESO Mayus;
     #0Campo = #0Campo > #0Campo;
     |PINTA #0Campo;
|FPRC;

|PROCESO PonFecha; |TIPO 7;
     fFecha  = ~;
     aAlfa   = fFecha % -104;
     #0#29   = aAlfa;  |PINTA #0#29;
|FPRC;

|PROCESO Seleccion;
     |SI #0#0 = "S";
         |C_M #0#1, 1, "N";   #0#1 = 1;      |PINTA #0#1;
         |C_M #0#2, 1, "N";   #0#2 = 99999;  |PINTA #0#2;
         |PARA nCampos = 3; |SI nCampos [ 26;  |HACIENDO nCampos = nCampos + 1;
               |C_M #0nCampos, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #0#1, 1, "S";
         |C_M #0#2, 1, "S";
         |PARA nCampos = 3; |SI nCampos [ 26;  |HACIENDO nCampos = nCampos + 1;
               |C_M #0nCampos, 1, "N";  #0nCampos = 0;  |PINTA #0nCampos;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Calculo;
     nImport     = 0;
     fFechaUso   = #1#13;
     fFechaVenta = #1#17;
     nTCompra    = #1#16;
     |SI #1#6 = "B";  nTCompra = #1#14;  |FINSI;
     nPorceA     = #1#25;
     nPorceD     = #1#7;
     nTipoMod    = #1#4;

     aAlfa  = "31.12." + (fFechaUso % -104);     fFinCompra = aAlfa;
     aAlfa  = "01.01." + (fFechaUso % -104);     fPriCompra = aAlfa;

     aAlfa  = fFechaUso   % -104;                nCAnyo    = aAlfa;
     aAlfa  = fFechaVenta % -104;                nVAnyo    = aAlfa;
     aAlfa  = "01.01." + (fFechaVenta % -104);   fPriVenta = aAlfa;
     aAlfa  = "31.12." + (fFechaVenta % -104);   fFinVenta = aAlfa;
     |SI fPriVenta < fFechaUso;                  fPriVenta = fFechaUso;  |FINSI;

     nAmort  = #0#29;
     |SI nAmort > nVAnyo;  |Y nVAnyo ! 0;  |ACABA;  |FINSI;
     |SI #1#22 = 0; |Y #1#23 < nAmort;     |ACABA;  |FINSI;
     |SI nCAnyo = nAmort;                  |ACABA;  |FINSI;

     #2#0  = #1#0;
     #2#1  = #1#1;
     #2#2  = #1#2;
     #2#3  = #0#29;
     |LEE 040#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;

     nPendiente = #1#22;
     |SI #1#23 = #2#3;
         nPendiente = #1#22 + #2#5;
     |FINSI;

     |HAZ Amortizamelo;
|FPRC;

|PROCESO Regulariza;
     nImport = 0;

     |SI #0#29 ] 2001;          |ACABA;  |FINSI;
     |SI #0#29 < 1998;          |ACABA;  |FINSI;
     |SI #1#12 ] "01.01.1998";  |ACABA;  |FINSI;
     |SI #1#15 = 0;             |ACABA;  |FINSI;

     aAlfa   = #1#12 % -104;
     nCAnyo  = aAlfa;

     |SI nCAnyo < 1994;     |ACABA   |FINSI;

     |SI nCAnyo = 1996;
         |SI #0#29 = 2001;  |ACABA;  |FINSI;
     |FINSI;

     |SI nCAnyo = 1995;
         |SI #0#29 = 2001;  |ACABA;  |FINSI;
         |SI #0#29 = 2000;  |ACABA;  |FINSI;
     |FINSI;

     |SI nCAnyo = 1994;
         |SI #0#29 = 2001;  |ACABA;  |FINSI;
         |SI #0#29 = 2000;  |ACABA;  |FINSI;
         |SI #0#29 = 1999;  |ACABA;  |FINSI;
     |FINSI;

     nImport = (#1#14 % #1#15) / 5;
|FPRC;


|PROCESO Imprime;
     #2#0  = #1#0;
     #2#1  = #1#1;
     #2#2  = #1#2;
     #2#3  = #0#29;
     |LEE 040#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;

     #3#0  = #1#0;
     #3#1  = #1#1;
     #3#2  = #0#29 - 1900;
     |SI #3#2 ] 100;  #3#2 = #0#29 - 2000;  |FINSI;
     |LEE 040#3=;
     |SI FSalida ! 0;  |DDEFECTO #3;  |FINSI;

     |PDEFECTO #0, 30, 45;

     #0#30 = #1#0;
     #0#31 = #1#1;
     #0#32 = #3#3;
     #0#33 = #3#6;
     #0#34 = #1#2;
     #0#35 = #1#3;
     #0#36 = #1#13; ||Fecha Inicio
     #0#46 = #1#12; ||Fecha Compra
     #0#37 = #1#4;
     #0#38 = #1#14;
     #0#39 = #1#15;
     #0#40 = #1#16;
     #0#42 = #2#5;
     #0#41 = 0;
     enImpProv = 0;

     |HAZ Calculo;

     #0#41  = nImport;
     |SI nTipoMod ! 0;  |Y #0#47 = 1;
         #0#41 = enImpProv;
     |FINSI;

     |SI nCAnyo = #0#29;
         #0#43 = #1#14 % #1#15;
     |FINSI;

     |HAZ Regulariza;

     #0#44 = nImport;

     |SI #0#41 = 0; |Y #0#42 = 0; |Y #0#43 = 0; |Y #0#44 = 0;
         |ACABA;
     |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE eosm0023P;
     #1#2;
     ;
     #0#1, #0#27, 0, 00000;
     #0#2, #0#28, 9, 99999;
     ;
     NULL, Imprime;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |INFOR "reoy0002";
     |SI FSalida ! 0;  |FINIMP; |ACABA;  |FINSI;

     |ABRE #2;
     |ABRE #3;
     |SI #0#0 = "S";
         |PARA nCampos = 3; |SI nCampos [ 26;  |HACIENDO nCampos = nCampos + 1;
               |SI #0nCampos ! 0;
                   #0#1 = #0nCampos;
                   #0#2 = #0nCampos;
                   |BUCLE eosm0023P;
                |FINSI;
         |SIGUE;
     |SINO;
         |BUCLE eosm0023P;
     |FINSI;
     |CIERRA #2;
     |CIERRA #3;

     |SI #0#30 ! 0;  |PIEINF;  |FINSI;
     |FININF;
     |FINIMP;
|FPRC;
