|FICHEROS;
     reoz0004 #0;

     eosactiv #4;
     eoslinco #5;
     eoslinve #7;
     eosconce #8;
     eosaplic #9;
     eoscabco #11;
     eoscabve #12;
     eosagga1 #19;
     eosconc6 #28;
     eosm0019 #40;
     eosm0023 #50;

     dsmom004;
     dsmoc310;
     dsmoc311;
     dsmom033;
     dsmom133;

     reow0002 #99,MANTE;
|FIN;

|VARIABLES;
     fFecha      = @;

     aAlfa       = "";
     aConcep6    = "";

     nConcep2    = 0;
     nTipo310    = 0;
     nBase       = 0;
     nIva        = 0;
     nSwPase     = 0;
     nSwAgri     = 0;
     nCampo1     = 0;
     nCampo2     = 0;
     nCampo3     = 0;
     nCampo4     = 0;
     nCampo5     = 0;
     nCampo6     = 0;
     nCampo7     = 0;
     nCampo8     = 0;
     nCampo9     = 0;
     nCampo10    = 0;
     nCampo11    = 0;
     nCampo12    = 0;
     nCampo13    = 0;
     nCampo16    = 0;
     nSwIntra    = 0;
     nTotal      = 0;
     nLaEmpresa  = 0;
     nElAnyo     = 0;
     nElPeriodo  = 0;
     nCompensar  = 0;
     nSuma       = 0;
     nPeriodo    = 0;
     nEmpresa    = 0;
     nAnyoEjer   = 0;
     nAnyoCompra = 0;
     nAnyoHasta  = 0;
     nSwEstar    = 0;
     nDesde      = 0;
     nMes        = 0;
     nCultivo    = 0;

     &enEmpresa      = 0;
     &enEjer         = 0;
     &enPeriodo      = 0;
     &enActividad    = 0;
     &enTipoEntrada  = 0;
     &enModelo       = 0;
     &enComplem      = 0;
     nError          = 0;
     &eaExtension    = "";
     &eaPrograma     = "";
|FIN;

|INCLUYE i_seguim;

------------------- PROCESOS DE LA PANTALLA --------------------------------

|INCLUYE i_consul;

|PROCESO PulsaTecla;
     |PINTA 0565, "께께께께께께께";

     |SI FSalida ! 10;  |ACABA;  |FINSI;

     nSwPase = 1;

     |PUSHV 0501 2380;
     |D_CUADRO 0658, 1180;
     |BLANCO 0759 1079;
     |PINTA 0759, "Trimestre ....: ";
     |PINTA 0859, "A쨚 ..........: ";
     |PINTA 0959, "De la Empresa : ";
     |PINTA 1059, "A  la Empresa : ";

     |C_V #0#0, 1, "S";  |C_M #0#0, 1, "S";  |C_P #0#0, 1, 0775;
     |C_V #0#1, 1, "S";  |C_M #0#1, 1, "S";  |C_P #0#1, 1, 0875;
     |C_V #0#2, 1, "S";  |C_M #0#2, 1, "S";  |C_P #0#2, 1, 0975;
     |C_V #0#3, 1, "S";  |C_M #0#3, 1, "S";  |C_P #0#3, 1, 1075;

     |PINTA #0#0;  |PINTA #0#1;  |PINTA #0#2;  |PINTA #0#3;

     |ET nCampo0;
                 |ENCAMPO #0#0;

                 |SI FSalida = 1;  |VETE Final;      |FINSI;
                 |SI FSalida = 7;  |VETE Final;      |FINSI;
                 |SI FSalida = 2;  |VETE nCampo0;    |FINSI;

     |ET nCampo1;
                 |ENCAMPO #1#0;

                 |SI FSalida = 1;  |VETE Final;      |FINSI;
                 |SI FSalida = 7;  |VETE Final;      |FINSI;
                 |SI FSalida = 2;  |VETE nCampo0;    |FINSI;

     |ET nCampo2;
                 |ENCAMPO #2#0;

                 |SI FSalida = 1;  |VETE Final;      |FINSI;
                 |SI FSalida = 7;  |VETE Final;      |FINSI;
                 |SI FSalida = 2;  |VETE nCampo1;    |FINSI;

     |ET nCampo3;
                 |ENCAMPO #3#0;

                 |SI FSalida = 1;  |VETE Final;      |FINSI;
                 |SI FSalida = 7;  |VETE Final;      |FINSI;
                 |SI FSalida = 2;  |VETE nCampo2;    |FINSI;

     |ET Final;

                                     |C_M #0#0, 1, "N";  |C_P #0#0, 1, 0776;
                                     |C_M #0#1, 1, "N";  |C_P #0#1, 1, 0876;
                 |C_V #0#2, 1, "N";  |C_M #0#2, 1, "N";
                 |C_V #0#3, 1, "N";  |C_M #0#3, 1, "N";

     |POPV;

     |PINTA #0#0;
     |PINTA #0#1;
|FPRC;

|PROCESO PonAnyo;  |TIPO 7;
     fFecha = ~;
     aAlfa  = fFecha % -102;
     #0#1   = aAlfa;     |PINTA #0#1;
|FPRC;

------------------- FIN PROCESOS DE LA PANTALLA ----------------------------


------------------- PROCESOS GRABACION DEL MODELO 310 ----------------------

|PROCESO Calculo310;
     #4#0 = #40#0;
     #4#1 = #40#5;
     #4#2 = #40#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     #40#30 = #40#9  + #40#14 + #40#19 + #40#24 + #40#29;
     #40#44 = #40#30 - #40#43;
     #40#34 = #40#44 + #40#31 + #40#32 + #40#33;
     #40#46 = #40#35 + #40#45;
     #40#36 = #40#34 - #40#46;
     #40#38 = #40#36 - #40#37;

     nTotal = #40#38;
     |SI nTotal > 0;
         #40#40 = nTotal;   #40#41 = 0;   #40#42 = 0;
     |SINO;
         |SI #40#2 ! 4;
             #40#41 = nTotal * -1;  #40#40 = 0;  #40#42 = 0;
         |SINO;
              |SI #4#27 = "C";
                  #40#41 = nTotal * -1;  #40#40 = 0;  #40#42 = 0;
              |FINSI;

              |SI #4#27 = "D";
                  #40#42 = nTotal * -1;  #40#40 = 0;  #40#41 = 0;
              |FINSI;
         |FINSI;
     |FINSI;


|FPRC;

|PROCESO Del98;
     |DDEFECTO #40;
     #40#0    = nLaEmpresa;
     #40#1    = nElAnyo;
     #40#2    = nElPeriodo;
     |LEE 040#40=;
     nCompensar = 0;
     |SI FSalida = 0;  nCompensar = #40#41;  |FINSI;

     nSuma = 0;
     |SI #0#0 = 4; |O nMes = 4;
         |PARA nPeriodo = 1;  |SI nPeriodo [ 3;  |HACIENDO nPeriodo = nPeriodo + 1;
               #40#0    = nLaEmpresa;
               #40#1    = nElAnyo;
               #40#2    = nPeriodo;
               |LEE 040#40=;
               |SI FSalida = 0;  nSuma = nSuma + #40#44;  |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO EjerAnt; |TIPO 0;
     |SI #40#2 = 1;
         nLaEmpresa = #40#0;
         nElPeriodo = 4;
         nElAnyo    = #40#1 - 1;
         |SI nElAnyo < 0;  nElAnyo = 99;  |FINSI;

         |HAZ Del98;
     |SINO;
         nLaEmpresa = #40#0;
         nElAnyo    = #40#1;
         nElPeriodo = #40#2 - 1;
         |HAZ Del98;
     |FINSI;
|FPRC;

|PROCESO Agricultura;
     |PARA nCampo1 = 5; |SI nCampo1 [ 25; |HACIENDO nCampo1 = nCampo1 + 5;
           nCampo2 = nCampo1 + 1;
           nCampo3 = nCampo1 + 2;
           nCampo4 = nCampo1 + 3;
           nCampo5 = nCampo1 + 4;

           |SI nCampo1 = 5;   nCampo6 = 47;  |FINSI;
           |SI nCampo1 = 10;  nCampo6 = 50;  |FINSI;
           |SI nCampo1 = 15;  nCampo6 = 53;  |FINSI;
           |SI nCampo1 = 20;  nCampo6 = 56;  |FINSI;
           |SI nCampo1 = 25;  nCampo6 = 59;  |FINSI;

           nCampo7 = nCampo6 + 1;
           nCampo8 = nCampo6 + 2;

           |SI #40nCampo1 = #99#1;
               nSwEstar   = 1;
               #40nCampo4 = #99#4;
               #40nCampo6 = #99#5;
               #40nCampo7 = #99#6;
               #40nCampo8 = #99#7;
               #40nCampo5 = #40nCampo6 - (#40nCampo7 + #40nCampo8);
               |SAL;
           |FINSI;
     |SIGUE;

     |SI nSwEstar = 0;
         nSwEstar = 0;
         |PARA nCampo1 = 5; |SI nCampo1 [ 25; |HACIENDO nCampo1 = nCampo1 + 5;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               nCampo4 = nCampo1 + 3;
               nCampo5 = nCampo1 + 4;

               |SI nCampo1 = 5;   nCampo6 = 47;  |FINSI;
               |SI nCampo1 = 10;  nCampo6 = 50;  |FINSI;
               |SI nCampo1 = 15;  nCampo6 = 53;  |FINSI;
               |SI nCampo1 = 20;  nCampo6 = 56;  |FINSI;
               |SI nCampo1 = 25;  nCampo6 = 59;  |FINSI;

               nCampo7 = nCampo6 + 1;
               nCampo8 = nCampo6 + 2;

               |SI #40nCampo1 = 0;
                   #40nCampo1 = #99#1;
                   #40nCampo2 = #99#2;
                   #40nCampo3 = #99#3;
                   #40nCampo4 = #99#4;
                   #40nCampo6 = #99#5;
                   #40nCampo7 = #99#6;
                   #40nCampo8 = #99#7;
                   #40nCampo5 = #40nCampo6 - (#40nCampo7 + #40nCampo8);
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Segui310;
     se_empre = #40#0;
     se_ejerc = #40#1;
     se_perio = #40#2;
     se_tipos = 310;
     se_activ = 1;
     se_impor = 0;
     |SI #40#40 > 0; se_impor =  #40#40; |FINSI;
     |SI #40#41 > 0; se_impor = -#40#41; |FINSI;
     |SI #40#42 > 0; se_impor = -#40#42; |FINSI;
     se_fecha = #40#3;
     se_factu = "";
     ||HAZ seguimie;
|FPRC;

|PROCESO Mira310;
     nMes = 0;
     #40#0 = #99#0;
     #40#1 = #0#1;
     #40#2 = #0#0;
     |HAZ EjerAnt;

     #40#0 = #99#0;
     #40#1 = #0#1;
     #40#2 = #0#0;
     |LIBERA #40;
     |LEE 140#40=;
     |SI FSalida ! 0;
         |DDEFECTO #40;
         #40#0  = #99#0;
         #40#1  = #0#1;
         #40#2  = #0#0;
         |GRABA 020#40b;
     |FINSI;

     #40#37 = nCompensar;
     #40#43 = nSuma;
     |SI #99#4 = "S";  |HAZ Agricultura;  |FINSI;

     |SI nEmpresa ! #99#0;
         nEmpresa = #99#0;

         #40#31   = #99#9;
         #40#32   = #99#10;
         #40#33   = #99#11;
         #40#35   = #99#12;
         #40#45   = #99#13;
     |SINO;
         #40#31   = #40#31 + #99#9;
         #40#32   = #40#32 + #99#10;
         #40#33   = #40#33 + #99#11;
         #40#35   = #40#35 + #99#12;
         #40#45   = #40#45 + #99#13;
     |FINSI;

     |HAZ Calculo310;
     |GRABA 120#40a;
     |HAZ Segui310;

     |SI #0#0 ! 4;
         nDesde = #0#0 + 1;
         |PARA nMes = nDesde;  |SI nMes [ 4;  |HACIENDO nMes = nMes + 1;
               #40#0 = #99#0;
               #40#1 = #0#1;
               #40#2 = nMes;
               |HAZ EjerAnt;

               #40#0 = #99#0;
               #40#1 = #0#1;
               #40#2 = nMes;
               |LIBERA #40;
               |LEE 140#40=;
               |SI FSalida = 0;
                   #40#37 = nCompensar;
                   #40#43 = nSuma;
                   |HAZ Calculo310;
                   |GRABA 120#40a;
                   |HAZ Segui310;
               |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|DEFBUCLE reow0004;
     #99#1;
     ;
     #0#2, 1;
     #0#3, 6;
     ;
     NULL, Mira310;
|FIN;

------------------- FIN PROCESOS GRABACION DEL MODELO 310 ------------------


------------------- PROCESOS PASES DEL LIBRO -------------------------------

|PROCESO BorraAcu;
     nCampo5  = 0;
     nCampo7  = 0;
     nCampo9  = 0;
     nCampo10 = 0;
     nCampo11 = 0;
     nCampo12 = 0;
     nCampo13 = 0;
     nCampo16 = 0;
|FPRC;

|PROCESO Graba2013;
     #99#0 = #4#0;
     #99#1 = #4#1;
     |LIBERA #99;
     |LEE 140#99=;
     |SI FSalida ! 0;
         |DDEFECTO #99;
         #99#0  = #4#0;
         #99#1  = #4#1;
         #99#2  = #4#4;
         #99#3  = #4#5;
         #99#4  = #4#41;
         #99#14 = #4#3;
         #99#15 = #4#6;
         |GRABA 020#99b;
     |FINSI;

     #99#5  = #99#5  + nCampo5;

     |SI #0#0 = 4;
         #99#6  = #99#5  % 1;
         #99#7  = #99#7  + nCampo7;
         #99#8  = #99#5  - (#99#6 + #99#7);
     |SINO;
         #99#6  = 0;
         #99#7  = 0;
         #99#8  = 0;
     |FINSI;

     #99#9  = #99#9  + nCampo9;
     #99#10 = #99#10 + nCampo10;
     #99#11 = #99#11 + nCampo11;
     #99#12 = #99#12 + nCampo12;
     #99#13 = #99#13 + nCampo13;
     |GRABA 120#99a;
|FPRC;

|PROCESO dsmom133;
     |SI #dsmom133#3 = #eosagga1#4;  |Y #dsmom133#4 = #eosagga1#5;
         nCultivo = #dsmom133#0;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom133;
     #dsmom133#1;
     ;
     001, enEjer;
     999, enEjer;
     ;
     NULL, dsmom133;
|FIN;

|PROCESO GrabaCultivo;
     |ABRE #dsmom033;
     #dsmom033#0 = nCultivo;
     |LEE 000#dsmom033.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom033;  |FINSI;
     |CIERRA #dsmom033;

     |ABRE #dsmom133;
     #dsmom133#0 = #dsmom033#0;
     #dsmom133#1 = enEjer;
     |LEE 000#dsmom133.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom133;  |FINSI;
     |CIERRA #dsmom133;

     #dsmoc311#0  = enEmpresa;
     #dsmoc311#1  = enEjer;
     #dsmoc311#2  = enPeriodo;
     #dsmoc311#3  = enModelo;
     #dsmoc311#4  = enComplem;
     #dsmoc311#5  = enActividad;
     #dsmoc311#6  = nCultivo;
     |LEE 101#dsmoc311.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmoc311;
         #dsmoc311#0  = enEmpresa;
         #dsmoc311#1  = enEjer;
         #dsmoc311#2  = enPeriodo;
         #dsmoc311#3  = enModelo;
         #dsmoc311#4  = enComplem;
         #dsmoc311#5  = enActividad;
         #dsmoc311#6  = nCultivo;
         #dsmoc311#7  = #dsmom033#1;
         #dsmoc311#9  = #dsmom133#3;
         #dsmoc311#10 = #dsmom133#4;
         |GRABA 020#dsmoc311.b;
     |FINSI;

     #dsmoc311#8  = #dsmoc311#8 + nBase;
     |SI enPeriodo < 12;
         #dsmoc311#12 = ((#dsmoc311#8 * #dsmoc311#9) * #dsmoc311#10) / 100;
     |SINO;
         #dsmoc311#11 = #dsmoc311#11 + nCampo7;

         #dsmoc311#12 = #dsmoc311#8 * #dsmoc311#9;
         #dsmoc311#12 = #dsmoc311#12  - (((#dsmoc311#8 * #dsmoc311#9) % 1) + #dsmoc311#11);
     |FINSI;

     #dsmoc311#13 = #dsmoc311#8;
     #dsmoc311#14 = #dsmoc311#9;
     #dsmoc311#15 = #dsmoc311#10;
     #dsmoc311#16 = #dsmoc311#11;
     #dsmoc311#17 = #dsmoc311#12;
     #dsmoc311#18 = 0;
     #dsmoc311#19 = 0;
     #dsmoc311#20 = 0;
     #dsmoc311#21 = 0;
     #dsmoc311#22 = 0;
     #dsmoc311#23 = 1;

     |GRABA 020#dsmoc311.a;
     |LIBERA #dsmoc311;
|FPRC;

|PROCESO GrabaTempo;
     |SI PARAMETRO = "";
         |HAZ Graba2013;
         |ACABA;
     |FINSI;

     #dsmoc310#0  = enEmpresa;
     #dsmoc310#1  = enEjer;
     #dsmoc310#2  = enPeriodo;
     #dsmoc310#3  = enModelo;
     #dsmoc310#4  = enComplem;
     #dsmoc310#5  = enActividad;
     |LEE 101#dsmoc310.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmoc310;
         #dsmoc310#0  = enEmpresa;
         #dsmoc310#1  = enEjer;
         #dsmoc310#2  = enPeriodo;
         #dsmoc310#3  = enModelo;
         #dsmoc310#4  = enComplem;
         #dsmoc310#5  = enActividad;
         #dsmoc310#6  = #eosactiv#5;
         #dsmoc310#7  = #eosactiv#6;
         #dsmoc310#8  = #eosactiv#41;
         |GRABA 020#dsmoc310.b;
     |FINSI;

     #dsmoc310#10 = #dsmoc310#10 + nCampo9;
     #dsmoc310#11 = #dsmoc310#11 + nCampo10;
     #dsmoc310#12 = #dsmoc310#12 + nCampo11;
     #dsmoc310#13 = #dsmoc310#13 + nCampo12;
     #dsmoc310#14 = #dsmoc310#14 + nCampo13;
     #dsmoc310#17 = #dsmoc310#17 + nCampo16;

     |SI nCampo5 ! 0; |O nCampo7 ! 0;
         #eosagga1#0 = #eosactiv#4;
         #eosagga1#1 = #eosactiv#5;
         |LEE 040#eosagga1.=;
         |SI FSalida ! 0; |DDEFECTO #eosagga1;  |FINSI;

         nCultivo = 0;
         |BUCLE dsmom133;

         |SI nCultivo ! 0;
             |HAZ GrabaCultivo;
         |FINSI;
     |FINSI;

     |GRABA 020#dsmoc310.a;
     |LIBERA #dsmoc310;
|FPRC;

|PROCESO PonCompras;
     |HAZ BorraAcu;

     |SI #4#50 = 1;
         #8#0 = nConcep2;
         |LEE 040#8=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |SI #8#3 ! "G";  |ACABA;  |FINSI;

         nTipo310 = #8#11;
         nSwIntra = 0; |SI #8#6 = "S"; nSwIntra = 1; |FINSI;
     |SINO;
         #28#0 = aConcep6;
         |LEE 040#28=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |SI #28#3 ! "G";  |ACABA;  |FINSI;

         nTipo310 = #28#18;
         nSwIntra = 0; |SI #8#6 = "S"; nSwIntra = 1; |FINSI;
     |FINSI;

     |SI nSwAgri = 1;
         |SI nTipo310 ! 1; |Y nIva ! 0;
             nCampo7  = nIva;
             |HAZ GrabaTempo;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI nTipo310 = 1; |Y nIva ! 0;

         nCampo12 = nIva;

         |HAZ GrabaTempo;
     |FINSI;
|FPRC;

|PROCESO Compras;
     |SI PARAMETRO ! "";
         |SI #eoslinco#19 ! enActividad;  |ACABA;  |FINSI;
     |FINSI;

     #4#0 = #5#0;
     #4#1 = #5#19;
     #4#2 = #0#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     |SI #4#22 ! "A"; |Y #4#41 ! "S";
         |ACABA;
     |FINSI;

     nSwAgri = 0;

     nConcep2 = #5#5;  aConcep6 = #5#72; nIva = #5#9;  |HAZ PonCompras;
     nConcep2 = #5#33; aConcep6 = #5#73; nIva = #5#27; |HAZ PonCompras;
     nConcep2 = #5#34; aConcep6 = #5#74; nIva = #5#28; |HAZ PonCompras;
|FPRC;

|DEFBUCLE eoslincoT;
     #5#2;
     ;
     #11#0, #11#4, #0#0, 1, "01.01.0000", 00001;
     #11#0, #11#4, #0#0, 6, "31.12.9999", 32000;
     ;
     NULL, Compras;
|FIN;

|PROCESO ComprasAgri;
     nSwAgri = 0;

     |SI PARAMETRO ! "";
         |SI #eoslinco#19 ! enActividad;  |ACABA;  |FINSI;
     |FINSI;

     #4#0 = #5#0;
     #4#1 = #5#19;
     #4#2 = #0#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     |SI #4#26 = "F";  |ACABA;  |FINSI;

     #19#0 = #4#4;
     #19#1 = #4#5;
     |LEE 040#19=;
     |SI FSalida ! 0; |ACABA;  |FINSI;

     nSwAgri = 1;

     nConcep2 = #5#5;  aConcep6 = #5#72; nIva = #5#9;  |HAZ PonCompras;
     nConcep2 = #5#33; aConcep6 = #5#73; nIva = #5#27; |HAZ PonCompras;
     nConcep2 = #5#34; aConcep6 = #5#74; nIva = #5#28; |HAZ PonCompras;
|FPRC;

|DEFBUCLE eoslincoF;
     #5#1;
     ;
     #11#0, #11#4, 00001;
     #11#0, #11#4, 32000;
     ;
     NULL, ComprasAgri;
|FIN;

|PROCESO CabeCompra;

     aAlfa  = "c" + (("00000" + #11#0) % -105) +  (("00" + #11#4) % -102);
     |NOME_DAT #5 aAlfa;

                    |BUCLE eoslincoT;
     |SI #0#0 = 4;  |BUCLE eoslincoF;  |FINSI;
|FPRC;

|DEFBUCLE eoscabco;
     #11#1;
     ;
     #0#2, #0#1;
     #0#3, #0#1;
     ;
     NULL, CabeCompra;
|FIN;

|PROCESO PonVentas;
     |HAZ BorraAcu;

     |SI #4#50 = 1;
         #8#0 = nConcep2;
         |LEE 040#8=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |SI #8#3 ! "I";  |ACABA;  |FINSI;

         nTipo310 = #8#11;
         nSwIntra = 0; |SI #8#6 = "S"; nSwIntra = 1; |FINSI;
     |SINO;
         #28#0 = aConcep6;
         |LEE 040#28=;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |SI #28#3 ! "I";  |ACABA;  |FINSI;

         nTipo310 = #28#18;
         nSwIntra = 0; |SI #28#6 = "S"; nSwIntra = 1; |FINSI;
     |FINSI;

     |SI nSwAgri = 1;
         |SI #0#0 ! 4;
             nCampo5  = (nBase * #19#4) % #19#5;
         |SINO;
             nCampo5  = nBase * #19#4;
         |FINSI;
         |HAZ GrabaTempo;

         |HAZ BorraAcu;
     |FINSI;

     |SI nIva     = 0;  |ACABA;  |FINSI;
     |SI nTipo310 = 0;  |ACABA;  |FINSI;

     |SI nTipo310 = 1;  nCampo9  = nIva;  |FINSI;
     |SI nTipo310 = 2;  nCampo10 = nIva;  |FINSI;
     |SI nTipo310 = 3;
         |SI nSwIntra = 0;
             nCampo11 = nIva;
         |SINO;
             nCampo16 = nIva;
         |FINSI;
     |FINSI;

     |HAZ GrabaTempo;
|FPRC;

|PROCESO Ventas;
     |SI PARAMETRO ! "";
         |SI #eoslinve#19 ! enActividad;  |ACABA;  |FINSI;
     |FINSI;

     #4#0 = #7#0;
     #4#1 = #7#19;
     #4#2 = #0#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     |SI #4#26 = "F";  |ACABA;  |FINSI;

     nSwAgri = 0;

     #19#0 = #4#4;
     #19#1 = #4#5;
     |LEE 040#19=;
     |SI FSalida = 0;  nSwAgri = 1;  |FINSI;
     |SI #0#0    = 4;  nSwAgri = 0;  |FINSI;

     |SI #4#22 ! "A";  |ACABA;  |FINSI;

     nConcep2 = #7#5;  aConcep6 = #7#72; nBase = #7#7;  nIva = #7#9;  |HAZ PonVentas;
     nConcep2 = #7#33; aConcep6 = #7#73; nBase = #7#23; nIva = #7#27; |HAZ PonVentas;
     nConcep2 = #7#34; aConcep6 = #7#74; nBase = #7#24; nIva = #7#28; |HAZ PonVentas;
     nConcep2 = #7#60; aConcep6 = #7#75; nBase = #7#45; nIva = #7#51; |HAZ PonVentas;
     nConcep2 = #7#61; aConcep6 = #7#76; nBase = #7#46; nIva = #7#52; |HAZ PonVentas;
     nConcep2 = #7#62; aConcep6 = #7#77; nBase = #7#47; nIva = #7#53; |HAZ PonVentas;
|FPRC;

|DEFBUCLE eoslinveT;
     #7#2;
     ;
     #12#0, #12#4, #0#0, 1, "01.01.0000", 00001;
     #12#0, #12#4, #0#0, 6, "31.12.9999", 32000;
     ;
     NULL, Ventas;
|FIN;

|PROCESO VentasAgri;
     |SI PARAMETRO ! "";
         |SI #eoslinve#19 ! enActividad;  |ACABA;  |FINSI;
     |FINSI;

     nSwAgri = 0;

     #4#0 = #7#0;
     #4#1 = #7#19;
     #4#2 = #0#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     |SI #4#26 = "F";  |ACABA;  |FINSI;

     #19#0 = #4#4;
     #19#1 = #4#5;
     |LEE 040#19=;
     |SI FSalida ! 0; |ACABA;  |FINSI;

     nSwAgri = 1;

     nConcep2 = #7#5;  aConcep6 = #7#72; nBase = #7#7;  nIva = #7#9;  |HAZ PonVentas;
     nConcep2 = #7#33; aConcep6 = #7#73; nBase = #7#23; nIva = #7#27; |HAZ PonVentas;
     nConcep2 = #7#34; aConcep6 = #7#74; nBase = #7#24; nIva = #7#28; |HAZ PonVentas;
     nConcep2 = #7#60; aConcep6 = #7#75; nBase = #7#45; nIva = #7#51; |HAZ PonVentas;
     nConcep2 = #7#61; aConcep6 = #7#76; nBase = #7#46; nIva = #7#52; |HAZ PonVentas;
     nConcep2 = #7#62; aConcep6 = #7#77; nBase = #7#47; nIva = #7#53; |HAZ PonVentas;
|FPRC;

|DEFBUCLE eoslinveF;
     #7#1;
     ;
     #12#0, #12#4, 00001;
     #12#0, #12#4, 32000;
     ;
     NULL, VentasAgri;
|FIN;

|PROCESO CabeVenta;
     aAlfa  = "v" + (("00000" + #12#0) % -105) +  (("00" + #12#4) % -102);
     |NOME_DAT #7 aAlfa;

                    |BUCLE eoslinveT;
     |SI #0#0 = 4;  |BUCLE eoslinveF;  |FINSI;
|FPRC;

|DEFBUCLE eoscabve;
     #12#1;
     ;
     #0#2, #0#1;
     #0#3, #0#1;
     ;
     NULL, CabeVenta;
|FIN;

|PROCESO Regulariza;
     |SI PARAMETRO ! "";
         |SI #eosm0023#1 ! enActividad;  |ACABA;  |FINSI;
     |FINSI;

     |HAZ BorraAcu;

     nAnyoEjer = 1900 + #0#1;
     |SI #0#1 < 80;  nAnyoEjer = 2000 + #0#1;  |FINSI;

     aAlfa       = #50#12 % -104;
     nAnyoCompra = aAlfa;

     #4#0 = #50#0;
     #4#1 = #50#1;
     #4#2 = #0#1;
     |LIBERA #4;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     |SI nAnyoEjer = nAnyoCompra;
         |SI #0#0 ! #50#26;  |ACABA;  |FINSI;

         nCampo12 = #50#14 % #50#15;
         |HAZ GrabaTempo;

         |ACABA;
     |FINSI;

     |SI #0#0 ! 4;  |ACABA;  |FINSI;

     |SI nAnyoEjer < 1998;          |ACABA;  |FINSI;
     |SI #50#12    ] "01.01.1998";  |ACABA;  |FINSI;
     |SI #50#15 = 0;  |ACABA;  |FINSI;

     |SI nAnyoCompra < 1994;  |ACABA;  |FINSI;

     nCampo13 = (#50#14 % #50#15) / 5;


     nAnyoHasta = nAnyoCompra + 5;

     |SI nAnyoEjer ] nAnyoHasta;  |ACABA;  |FINSI;

     |HAZ GrabaTempo;
|FPRC;

|DEFBUCLE eosm0023;
     #50#1;
     ;
     #0#2, 1, 00000;
     #0#3, 6, 99999;
     ;
     NULL, Regulariza;
|FIN;

|PROCESO PaseLibro;
     |ABRE #99;
     |ABRE #19;
     |ABRE #4;
     |ABRE #8;
     |ABRE #28;
     |BUCLE eoscabco;
     |BUCLE eoscabve;
     |BUCLE eosm0023;
     |CIERRA #99;
     |CIERRA #19;
     |CIERRA #4;
     |CIERRA #8;
     |CIERRA #28;
|FPRC;

------------------- FIN PROCESOS PASES DEL LIBRO ---------------------------

|RUTINA ClaveBaja;
     #99#0 = #0#2;
     #99#1 = 1;
|FRUT;

|RUTINA ClaveAlta;
     #99#0 = #0#3;
     #99#1 = 6;
|FRUT;

|PROCESO Tipo3;  |TIPO 3;
     aAlfa = ("04" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #99 aAlfa;
     |ABRE #99;  |CIERRA #99;  |DELINDEX #99;

     |SI nSwPase = 1;  |HAZ PaseLibro;  |FINSI;

     |ENTLINEAL #1#99, 1, 2, 21, 0, ClaveBaja, ClaveAlta;
     |CONFI "2400SPaso los datos al Modelo 310 S/N : ";
     |SI FSalida = 0;
         |ABRE #4;
         |ABRE #40;
         |BUCLE reow0004;
         |CIERRA #4;
         |CIERRA #40;
     |FINSI;


     |ABRE #99;  |CIERRA #99;  |DELINDEX #99;
|FPRC;

------------------- PROCESOS DEL TEMPORAL -----------------------------------

|PROCESO LeeActiv;
     |ABRE #4;
     #4#0 = #99#0;
     #4#1 = #99#1;
     #4#2 = #0#1;
     |LEE 040#4=;
     |SI FSalida ! 0;
         |MENAV "      No existe la actividad";
         |ERROR;
         |ACABA;
     |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO PonCampos;
     #99#2  = #4#4;     |PINTA #99#2;
     #99#3  = #4#5;     |PINTA #99#3;
     #99#4  = #4#41;    |PINTA #99#4;
     #99#15 = #4#6;     |PINTA #99#15;
|FPRC;

|PROCESO NoAgri;
     |C_M #99#5, 1, "S";
     |C_M #99#7, 1, "S";

     |SI #99#4 = "N";
         |C_M #99#5, 1, "N";  #99#5 = 0;  |PINTA #99#5;
                              #99#6 = 0;  |PINTA #99#6;
         |C_M #99#7, 1, "N";  #99#7 = 0;  |PINTA #99#7;
                              #99#8 = 0;  |PINTA #99#8;
         |ACABA;
     |FINSI;

     |SI #0#0 ! 4;
                              #99#6 = 0;  |PINTA #99#6;
         |C_M #99#7, 1, "N";  #99#7 = 0;  |PINTA #99#7;
                              #99#8 = 0;  |PINTA #99#8;
     |FINSI;
|FPRC;

|PROCESO TotalCuota;
     |SI #0#0 ! 4;  |ACABA;  |FINSI;
     #99#6 = #99#5 % 1;                     |PINTA #99#6;
     #99#8 = #99#5 - (#99#6 + #99#7);       |PINTA #99#8;
|FPRC;

-----------------------------------------------------------------------------

|PROCESO Anula2014; |TIPO 0;
     |SI #0Campo ] 14;  |Y #0Campo [ 79;
         |MENAV "0000Mantenimiento en desuso, use el programa para 2014 y posteriores.";
||         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Instala;
     eaExtension = "eos";
     eaPrograma  = "dsmom033";
     |SUB_EJECUTA "eosz0035";
     eaExtension = "eos";
     eaPrograma  = "dsmom133";
     |SUB_EJECUTA "eosz0035";
|FPRC;

|PROCESO VerPatModulos;
     nError   = 0;
     |ABRE #dsmom133;
     #dsmom133#0 = 11;
     #dsmom133#1 = 2020;
     |LEE 040#dsmom133.=;
     |SI FSalida ! 0;
         nError = 1;
     |FINSI;
     |CIERRA #dsmom133;

     |SI nError ! 0;
         |HAZ Instala;

         |ABRE #dsmom133;
         #dsmom133#0 = 11;
         #dsmom133#1 = 2020;
         |LEE 040#dsmom133.=;
         |SI FSalida ! 0;
             |CIERRA #dsmom133;
             |MENAV "0000Fichero patron incorrecto, no estan los Productos Agricolas 2020. Pongase en contacto con su admistrador";
             nError = 1;
         |SINO;
             |CIERRA #dsmom133;
             |MENAV "0000Se ha instalado el fichero patron de cultivos ejercicio 2018";
             nError = 0;
         |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO = "";
         |CLS;
         |MANTE #reoz0004;
         |ACABA;
     |FINSI;

     |HAZ VerPatModulos;
     |SI nError = 1; |ACABA; |FINSI;

     |ABRE #eosactiv;
     #eosactiv#0 = enEmpresa;
     #eosactiv#1 = enActividad;
     #eosactiv#2 = enEjer - 2000;
     |LEE 000#eosactiv.=;
     |CIERRA #eosactiv;

     #reoz0004#2 = enEmpresa;
     #reoz0004#3 = enEmpresa;
     #reoz0004#1 = enEjer - 2000;
     #reoz0004#0 = enPeriodo;

     |SI enPeriodo = 3;  #reoz0004#0 = 1;  |FINSI;
     |SI enPeriodo = 6;  #reoz0004#0 = 2;  |FINSI;
     |SI enPeriodo = 9;  #reoz0004#0 = 3;  |FINSI;
     |SI enPeriodo = 12; #reoz0004#0 = 4;  |FINSI;

     enTipoEntrada = 3;   |SUB_EJECUTA "dsmoc310";

     |ABRE #dsmoc310;
     |ABRE #dsmoc311;
     |HAZ PaseLibro;
     |CIERRA #dsmoc310;
     |CIERRA #dsmoc311;

     enTipoEntrada = 91;  |SUB_EJECUTA "dsmoc310";

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 101#dsmom004.=;
     |SI FSalida = 0;
         |HAZ ChequeaSituacion;

         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;
|FPRO;
