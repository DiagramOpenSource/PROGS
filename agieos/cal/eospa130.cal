|FICHEROS;
   eospa130 #0;
   eosclien #1;
   eos130co #2;
   eosactiv #4;
   eoslinve #7;
   eosconce #8;
   eosm2130 #10;
   eoscabve #11;
   eoslinco #13;
   eoscabco #14;
   eosw0008 #15;
   eosaplic #16;
   eosexist #17;
   eosconc6 #18;
   eosm3130 #24;
   eoscomul #25;
   eosw0016 #26;
   eosm0020 #37;
   eosm0020@ #1131;
   eosm3130@ #1130;

   espejo6@ #106;
|FIN;

|VARIABLES;
    CalIRPF   = 0;
    sw_130    = 0;
    act_nor   = 0;
    activi_g  = 0;
    pagos_g   = 0;
    x         = 0;
    anyocab   = "";
    Concep2   = 0;
    Concep6   = "";
    Base      = 0;
    Base1     = 0;
    Base2     = 0;
    Ret       = 0;
    empresa   = 0;
    actividad = 0;
    sw        = 0;
    varalf    = "";
    fec1      = @;
    fec2      = @;
    fec3      = @;
    fFecha1   = @;
    anio      = "";
    anyo      = 0;
    periodo   = 0;
    estamos   = 0;
    FEstado   = 0;
    pagos     = 0;
    f_antes   = 0;
    i_antes   = 0;
    fecha_per = @;
    tri1      = 0;
    tri2      = 0;
    cuota     = 0;
    SwComunero = 0;
    anyo_alfa  = "";
    anyo_alta  = 0;
    teorico    = 0;
    letra      = "";
    nSw        = 0;

    nSwPasada  = 0;

    nEmp131 = 0;
    nAny131 = 0;
    nPer131 = 0;
    nNume1  = 0;
    nSwNeg  = 0;
    nSumaD  = 0;
    aBase   = "";
    aMas    = "";
    nHPer   = 0;
    aParam  = "";
    nImporte = 0;
    nEl27    = 0;
    enNume   = 0;

    nTope        = 0;
    nTope131     = 0;
    nTopeAgrario = 0;
    nEjer        = 0;
    nSuma        = 0;
    nEmpresa     = 0;
    nActividad   = 0;
    e_antes      = "";

     nTotalG17 = 0;
     nTotalG21 = 0;
     nOpe      = 0;
     nTp       = 0;
     nClave0   = 0;
     nClave1   = 0;
     nClave2   = 0;
     nClave3   = 0;
     aPathModelo = "";
     aDef        = "";
     aAlfa       = "";
|FIN;

|INCLUYE i_vareos;
|INCLUYE i_seguim;
|INCLUYE i_ficher;
|INCLUYE i_anyode;
|INCLUYE i_consul;

|PROCESO pinta_anyo; |TIPO 7;

 |HAZ i_anyodef;
 #0#2 = i_anyodef; |PINTA #0#2;

 |SI aParam = "";
     |ATRI R; |PINTA 0743, "0"; |ATRI 0;
     |BLANCO 1603 2248;
 |FINSI;
|FPRC;

|PROCESO control; |TIPO 8;
 aParam  = PARAMETRO; |QBF aParam;
 |ABRE #16;
 |LEE 040#16p;
 |SI FSalida ! 0;
     |MENAV "     No existe control de 130.";
     |PTEC 807;
 |FINSI;
 |CIERRA #16;
|FPRC;

|PROCESO graba_ind;
#15#0 = empresa;
#15#1 = actividad;
#15#2 = #0#3;
#15#3 = #0#2;
|LIBERA #15;
|LEE 140#15=;
FEstado = FSalida;
|SI FEstado ! 0;
    |DDEFECTO #15;
    #15#0 = empresa;
    #15#1 = actividad;
    #15#2 = #0#3;
    #15#3 = #0#2;
|FINSI;

|SI estamos = 1;
    |SI CalIRPF = 1; Base = Base1; |FINSI;
    |SI CalIRPF = 2; Base = Base2; |FINSI;

    |SI #0#4 = "T";
        |SI periodo ! #0#3; #15#4 = #15#4 + Base;     |FINSI;
        |SI periodo = #0#3; #15#5 = #15#5 + Base;     |FINSI;

        |SI periodo ! #0#3; #15#8  = #15#8  + Ret;    |FINSI;
        |SI periodo = #0#3; #15#10 = #15#10 + Base;   |FINSI;
        |SI periodo = #0#3; #15#9  = #15#9  + Ret;    |FINSI;
    |SINO;
        |SI fecha_per < fec3; #15#4 = #15#4 + Base;   |FINSI;
        |SI fecha_per ] fec3; #15#5 = #15#5 + Base;   |FINSI;

        |SI fecha_per < fec3; #15#8  = #15#8  + Ret;  |FINSI;
        |SI fecha_per ] fec3; #15#10 = #15#10 + Base; |FINSI;
        |SI fecha_per ] fec3; #15#9  = #15#9  + Ret;  |FINSI;
    |FINSI;
|FINSI;

|SI estamos = 2;
    |SI #0#4 = "T";
        |SI periodo ! #0#3; #15#6 = #15#6 + Base; |FINSI;
        |SI periodo = #0#3; #15#7 = #15#7 + Base; |FINSI;
    |SINO;
        |SI fecha_per < fec3; #15#6 = #15#6 + Base; |FINSI;
        |SI fecha_per ] fec3; #15#7 = #15#7 + Base; |FINSI;
    |FINSI;
|FINSI;

|SI FEstado = 0; |GRABA 140#15a; |SINO; |GRABA 140#15n; |FINSI;
|FPRC;

|PROCESO LeeConc;
|SI #4#50 = 1;
    #8#0 = Concep2;
    |LEE 040#8=;
    |SI FSalida ! 0; |ACABA; |FINSI;

    CalIRPF = #8#9;

    |SI #8#3  = "I"; |Y estamos = 1;
        empresa   = #7#0;
        actividad = #7#19;
        periodo   = #7#17;
        fecha_per = #7#13;
        |HAZ graba_ind;
    |FINSI;

    |SI #8#3  = "G"; |Y estamos = 2;
        empresa   = #13#0;
        actividad = #13#19;
        periodo   = #13#17;
        fecha_per = #13#13;
        |HAZ graba_ind;
    |FINSI;
|SINO;
    #18#0 = Concep6;
    |LEE 040#18=;
    |SI FSalida ! 0; |ACABA; |FINSI;

    CalIRPF = #18#9;

    |SI #18#3  = "I"; |Y estamos = 1;
        empresa   = #7#0;
        actividad = #7#19;
        periodo   = #7#17;
        fecha_per = #7#13;
        |HAZ graba_ind;
    |FINSI;

    |SI #18#3  = "G"; |Y estamos = 2;
        empresa   = #13#0;
        actividad = #13#19;
        periodo   = #13#17;
        fecha_per = #13#13;
        |HAZ graba_ind;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO linea_vent;
|ABRE #4;
#4#0 = #7#0;
#4#1 = #7#19;
#4#2 = #0#2;
|LEE 040#4=;
|SI FSalida ! 0; |DDEFECTO #4; |FINSI;
|CIERRA #4;

|SI #4#22 = "N"; |Y #4#41 ! "S"; |ACABA; |FINSI;
|SI aParam = "MODULOS";
    |SI #4#22 ! "A"; |ACABA; |FINSI;
|SINO;
    |SI #4#22 = "A"; |ACABA; |FINSI;
|FINSI;

estamos = 1;
Concep2 = #7#5;  Concep6 = #7#72;
Base1   = #7#7;  Base2 = #7#7  + #7#9  + #7#11; Ret = #7#42;
|HAZ LeeConc;

Concep2 = #7#33; Concep6 = #7#73;
Base1   = #7#23; Base2 = #7#23 + #7#27 + #7#31; Ret = #7#43;
|HAZ LeeConc;

Concep2 = #7#34; Concep6 = #7#74;
Base1   = #7#24; Base2 = #7#24 + #7#28 + #7#32; Ret = #7#44;
|HAZ LeeConc;

Concep2 = #7#60; Concep6 = #7#75;
Base1   = #7#45; Base2 = #7#45 + #7#51 + #7#57; Ret = #7#69;
|HAZ LeeConc;

Concep2 = #7#61; Concep6 = #7#76;
Base1   = #7#46; Base2 = #7#46 + #7#52 + #7#58; Ret = #7#70;
|HAZ LeeConc;

Concep2 = #7#62; Concep6 = #7#77;
Base1   = #7#47; Base2 = #7#47 + #7#53 + #7#59; Ret = #7#71;
|HAZ LeeConc;
|FPRC;

|DEFBUCLE eoslinve;
#7#2;
;
#11#0, #11#4, tri1, 1, fec1, 00001;
#11#0, #11#4, tri2, 6, fec2, 32000;
e;
NULL, linea_vent;
|FIN;

|PROCESO cabe_vent;
sw        = 0;
fichero   = #11#0;
fichero   = "00000" + fichero;
fichero   = fichero % -105;
anyocab   = #11#4;
anyocab   = "00" + anyocab;
anyocab   = anyocab % -102;
fichero   = "v" + fichero + anyocab;
|NOME_DAT #7fichero;

|BUCLE eoslinve;
|FPRC;

|DEFBUCLE eoscabve;
#11#1;
;
#0#0, #0#2;
#0#1, #0#2;
e;
NULL, cabe_vent;
|FIN;

|PROCESO linea_comp;
|ABRE #4;
#4#0 = #13#0;
#4#1 = #13#19;
#4#2 = #0#2;
|LEE 040#4=;
|SI FSalida ! 0; |DDEFECTO #4; |FINSI;
|CIERRA #4;

|SI #4#22 = "N"; |Y #4#41 ! "S"; |ACABA; |FINSI;
|SI aParam = "MODULOS";
    |SI #4#22 ! "A"; |ACABA; |FINSI;
|SINO;
    |SI #4#22 = "A"; |ACABA; |FINSI;
|FINSI;

estamos  = 2;
Concep2 = #13#5;  Concep6 = #13#72; Base = #13#7;  Ret = #13#42; |HAZ LeeConc;
Concep2 = #13#33; Concep6 = #13#73; Base = #13#23; Ret = #13#43; |HAZ LeeConc;
Concep2 = #13#34; Concep6 = #13#74; Base = #13#24; Ret = #13#44; |HAZ LeeConc;
|FPRC;

|DEFBUCLE eoslinco;
#13#2;
;
#14#0, #14#4, tri1, 1, fec1, 00001;
#14#0, #14#4, tri2, 6, fec2, 32000;
e;
NULL, linea_comp;
|FIN;

|PROCESO cabe_comp;
fichero   = #14#0;
fichero   = "00000" + fichero;
fichero   = fichero % -105;
anyocab   = #14#4;
anyocab   = "00" + anyocab;
anyocab   = anyocab % -102;
fichero   = "c" + fichero + anyocab;
|NOME_DAT #13 fichero;
|BUCLE eoslinco;
|FPRC;

|DEFBUCLE eoscabco;
#14#1;
;
#0#0, #0#2;
#0#1, #0#2;
e;
NULL, cabe_comp;
|FIN;

|PROCESO graba_mod;
#4#0 = #15#0;
#4#1 = #15#1;
#4#2 = #15#3;
|LIBERA #4;
|LEE 140#4=;
|SI FSalida ! 0; |ACABA; |FINSI;

|SI aParam = "MODULOS";
    |SI #4#22 ! "A"; |ACABA; |FINSI;
|SINO;
    |SI #4#22 = "A"; |ACABA; |FINSI;
|FINSI;

anyo_alfa = #4#48 % -102;
anyo_alta = anyo_alfa;

|SI anyo_alta = #0#2; |Y #4#41 = "S";
    |SI #4#24 ! 1; #4#24 = 2; |FINSI;
    teorico = #15#10 / #15#5;
    |SI teorico < 0.70; |ACABA; |FINSI;
|SINO;
    |SI #4#41 = "S"; |Y #4#22 = "N"; |ACABA; |FINSI;
|FINSI;

|SI #4#22 = "N"; |HAZ question; #4#22 = letra; |FINSI;

|GRABA 140#4a;

|SI #4#22 = "A"; || .... Tambien las NO agrarias |Y #4#41 = "S";
    |SI #0#2 ] 0;  |Y #0#2 [ 80;
        |HAZ Graba131_98;
    |SINO;
        |SI #0#2 ] 98;  |HAZ Graba131_98;   |FINSI;
    |FINSI;
|FINSI;
|SI #4#22 = "B"; |O #4#22 = "C"; |HAZ graba_130; |FINSI;
|FPRC;

|PROCESO question;
|PUSHV 0501 2380;

|CUADRO 0811 1873;
|ATRI R;
|PINTA 0912, "  La Empresa :                                               ";
|PINTA 1012, "  Actividad  :                                               ";
|PINTA 1112, "no tiene informado que tipo de modelo queremos hacer.        ";
|PINTA 1212, "                                                             ";
|PINTA 1312, "  Introducir ahora :                                         ";
|PINTA 1412, "                       <A> Modelo 131                        ";
|PINTA 1512, "                       <B> Modelo 130                        ";
|PINTA 1612, "-------------------------------------------------------------";
|PINTA 0927, #4#0;
|PINTA 0933, #4#3;
|PINTA 1027, #4#1;
|PINTA 1033, #4#6;

|ATRI 0;

|PINTA 1712, "  Letra :                                                    ";

E_inf = "AB";
E_sup = 1;

|ET otra_letra;
    letra = 1722 ? 1;
    |CONFI "2400SEs Correcto : ";
    |SI FSalida ! 0; |VETE otra_letra; |FINSI;

|POPV;
|FPRC;

|| *********************************************
|| GRABACION DEL 131 1998
|| *********************************************

|PROCESO Segui131_98;
  se_empre = #37#0;
  se_ejerc = #37#1;
  se_perio = #37#2;
  se_tipos = 131;
  se_activ = 1;
  se_impor = #37#47;
  se_fecha = #37#3;
  se_factu = "";
  |HAZ seguimie;
|FPRC;

|| ///////////////////////////////////////////////////////////////////////
|PROCESO eosm0020_1;
     |SI #1131#47 < 0; nSwNeg = 1; |FINSI;

     |SI #1131#47 ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1131#55;

     |SI #1131#47 < 0;
         #37#56 = #37#56 + -#1131#47;
     |SINO;
         #37#56 = #37#56 - #1131#55;
         |SI #37#56 [ 0; nSwNeg = 0; #37#56 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE eosm0020_1;
     #1131#1003;
     ;
     #37#0, #37#1,     1;
     #37#0, #37#1, nHPer;
     ;
     NULL, eosm0020_1;
|FIN;

|PROCESO CapturaNegativos131;
     #37#56 = 0;
     |SI #37#55 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm0020.mas";
     |CARGA_DEF aMas, eosm0020@;

     nSwNeg   = 0;
     nSumaD   = 0;
     #37#56   = 0;
     nHPer    = #37#2 - 1;
     |BUCLE eosm0020_1;

     |DESCARGA_DEF #eosm0020@;
|FPRC;

|PROCESO eosm0020Tope;
     nTope131 = nTope131 + #1131#61;
|FPRC;

|DEFBUCLE eosm0020Tope;
     #1131#1003;
     ;
     #37#0, #37#1,     1;
     #37#0, #37#1, nHPer;
     ;
     NULL, eosm0020Tope;
|FIN;

|PROCESO CapturaTope;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm0020.mas";
     |CARGA_DEF aMas, eosm0020@;

     nTope131 = 0;
     nHPer    = #37#2 - 1;
     |BUCLE eosm0020Tope;

     |DESCARGA_DEF #eosm0020@;
|FPRC;

|PROCESO CalculaDed131;
     #37#55 = #37#53 - #37#54 - #37#59;

     |SI #37#55 [ 0;
         #37#56 = 0;
         #37#61 = 0;
         |ACABA;
     |FINSI;

     |SI nEjer ] 2008;  |Y #37#2 > 1;
         |HAZ CapturaNegativos131;
     |FINSI;

     nSuma = #37#56 + #37#61;
     |SI nSuma > #37#55;
         |SI #37#56 > #37#55;
             #37#56 = #37#55;
             #37#61 = 0;
             |ACABA;
         |FINSI;

         #37#61 = #37#55 - #37#56;
     |FINSI;
|FPRC;


|| ///////////////////////////////////////////////////////////////////////
|PROCESO ParaCalMin131;
      enDias130 = 0;    ||no es de modulos, es agricola
      enMod130  = 131;
      enEje130  = #0#2;
      enPer130  = #0#3;
      efFec130  = fFecha1;
      enRend_Agr   = #37#43;
      enRend_NoAgr = 0;
      |HAZ eGrabadsmom094;
|FPRC;
|| ///////////////////////////////////////////////////////////////////////

|PROCESO Calculo131_98;
     |SI #37#1 ] 80;
         nEjer = 1900 + #37#1;
     |SINO;
         nEjer = 2000 + #37#1;
     |FINSI;

     enMod130 = 131;
     enEmp130 = #37#0;
     enEje130 = #37#1;
     enPer130 = #37#2;
     enRend_NoAgr = #37#60;
     enRend_Agr   = #37#43;
     |HAZ eLeeAplica;

     #37#59 = 0;
     |SI nEjer = 2008; |Y eaAplica1 ! "N";
         |SI #37#2 = 2;  #37#59 = 200;  |FINSI;
         |SI #37#2 = 3;  #37#59 = 100;  |FINSI;
         |SI #37#2 = 4;  #37#59 = 100;  |FINSI;
     |FINSI;

     |SI nEjer = 2009; |Y eaAplica1 ! "N";
         |SI #37#2 = 1;  #37#59 = 100;  |FINSI;
         |SI #37#2 = 2;  #37#59 = 100;  |FINSI;
         |SI #37#2 = 3;  #37#59 = 100;  |FINSI;
         |SI #37#2 = 4;  #37#59 = 100;  |FINSI;
     |FINSI;

     |SI nEjer ] 2010; |Y eaAplica1 ! "N";
         #37#59 = enApli400;
     |FINSI;

     #37#11 = #37#09 % #37#10;
     #37#18 = #37#16 % #37#17;
     #37#25 = #37#23 % #37#24;
     #37#32 = #37#30 % #37#31;
     #37#39 = #37#37 % #37#38;

     #37#40 = 0;
     #37#60 = 0;
     |SI #37#6  ! "S";  #37#40 = #37#40 + #37#11;  #37#60 = #37#60 + #37#9;  |FINSI;
     |SI #37#13 ! "S";  #37#40 = #37#40 + #37#18;  #37#60 = #37#60 + #37#16; |FINSI;
     |SI #37#20 ! "S";  #37#40 = #37#40 + #37#25;  #37#60 = #37#60 + #37#23; |FINSI;
     |SI #37#27 ! "S";  #37#40 = #37#40 + #37#32;  #37#60 = #37#60 + #37#30; |FINSI;
     |SI #37#34 ! "S";  #37#40 = #37#40 + #37#39;  #37#60 = #37#60 + #37#37; |FINSI;

     #37#61 = 0;
     |SI nEjer ] 2009; |Y eaAplica2 = "S";
         |SI #37#40 ! 0;
             #37#61 = (#37#60 % .5) + (#37#51 % 2);
         |SINO;
             #37#61 = #37#43 % 2;
         |FINSI;

         |HAZ CapturaTope;
         |SI enAplica3 = 0;
             nTope = 660.14 - nTope131;
         |SINO;
             nTope = 440 - nTope131;
         |FINSI;
         |SI nTope < 0;  nTope = 0;  |FINSI;
         |SI #37#61 > nTope;
             #37#61 = nTope;
         |FINSI;
     |FINSI;

     |SI nEjer [ 2006;
         #37#42 = #37#40 - #37#41;
         |SI #37#42 < 0;  #37#42 = 0;  |FINSI;

         #37#44 = #37#43 % 2;
         #37#46 = #37#44 - #37#45;
         |SI #37#46 < 0;  #37#46 = 0;  |FINSI;
         #37#53 = #37#40 + #37#44 + #37#52;

         #37#54 = #37#41 + #37#45;
         #37#55 = #37#53 - #37#54 - #37#59;
         #37#47 = #37#42 + #37#46;
     |SINO;
         #37#41 = 0;
         #37#45 = 0;

         #37#44 = #37#43 % 2;
         #37#52 = #37#51 % 2;

         #37#53 = #37#40 + #37#44 + #37#52;

         |HAZ CalculaDed131;

         #37#57 = #37#55 - #37#56 - #37#61;
         #37#47 = #37#57 - #37#58;
    |FINSI;
|FPRC;

|PROCESO GrabaComu131_98;
  SwComunero = 1;

  |ABRE #37;
  #37#0 = #25#3;
  #37#1 = #15#3;
  #37#2 = #15#2;
  |LIBERA #37;
  |LEE 140#37=;
  FEstado = FSalida;
  |SI FEstado ! 0;
      |DDEFECTO #37;
      #37#0 = #25#3;
      #37#1 = #15#3;
      #37#2 = #15#2;
  |FINSI;

  #4#0 = #25#3;
  #4#1 = #25#5;
  #4#2 = #15#3;
  |LIBERA #4;
  |LEE 140#4=;
  |SI FSalida ! 0; |ACABA; |FINSI;

  fFecha1 = #4#48;
  |SI #4#41 = "S";
      #37#45 = (#15#9 % #25#6);  ||retenciones
      #37#43 = (#15#5 % #25#6);
      enEmp130 = #25#3;
      enAct130 = #25#5;
      |HAZ ParaCalMin131;
  |SINO;
      |SI FEstado ! 0;
          |CIERRA #37;
          |ACABA;      || Si no existe sale
      |FINSI;
      #37#41 = (#15#9 % #25#6);  ||retenciones
  |FINSI;
  #37#54 = #37#41 + #37#45;
  |HAZ Calculo131_98;
  |HAZ Segui131_98;

  |SI FEstado ! 0; |GRABA 140#37n; |SINO; |GRABA 140#37a; |FINSI;

  nEmp131 = #37#0;
  nAny131 = #37#1;
  nPer131 = #37#2 + 1;
  |HAZ ActResto131;
  |CIERRA #37;
|FPRC;

|DEFBUCLE eosmul131_98;
  #25#1;
  ;
  #15#0, #15#1, #15#3, 000;
  #15#0, #15#1, #15#3, 999;
  e;
  NULL, GrabaComu131_98;
|FIN;

|PROCESO Graba131_98;
  SwComunero = 0;
  |BUCLE eosmul131_98;
  |SI SwComunero = 1; |ACABA; |FINSI;

  |ABRE #37;
  #37#0 = #15#0;
  #37#1 = #15#3;
  #37#2 = #15#2;
  |LIBERA #37;
  |LEE 140#37=;
  FEstado = FSalida;
  |SI FEstado ! 0;
      |DDEFECTO #37;
      #37#0 = #15#0;
      #37#1 = #15#3;
      #37#2 = #15#2;
  |FINSI;

  |SI #4#41 = "S";
      #37#43 = #15#5;
      #37#45 = #15#9;  ||retenciones
      enEmp130 = #15#0;
      enAct130 = #15#1;
      fFecha1  = #4#48;
      |HAZ ParaCalMin131;
  |SINO;
      |SI FEstado ! 0;
          |CIERRA #37;
          |ACABA;      || Si no existe sale
      |FINSI;
      #37#41 = #15#9;  ||retenciones
  |FINSI;
  #37#54 = #37#41 + #37#45;
  |HAZ Calculo131_98;
  |HAZ Segui131_98;

  |SI FEstado ! 0; |GRABA 140#37n; |SINO; |GRABA 140#37a; |FINSI;

  nEmp131 = #37#0;
  nAny131 = #37#1;
  nPer131 = #37#2 + 1;
  |HAZ ActResto131;
  |CIERRA #37;
|FPRC;

|PROCESO ActResto131;
  |PARA nNume1 = nPer131; |SI nNume1 [ 4; |HACIENDO nNume1 = nNume1 + 1;
        #eosm0020#0 = nEmp131;
        #eosm0020#1 = nAny131;
        #eosm0020#2 = nNume1;
        |LEE 101#eosm0020.=;
        |SI FSalida = 0;
            |SI #eosm0020#3 = "01.01.0000";
                |HAZ Calculo131_98;
                |GRABA 020#eosm0020.a;
                |HAZ Segui131_98;
            |FINSI;
        |FINSI;
        |LIBERA #eosm0020;
  |SIGUE;
|FPRC;
|| *********************************************
|| GRABACION DEL 130
|| *********************************************

|PROCESO graba_130;
#17#0 = #15#0;
#17#1 = #15#1;
#17#2 = #15#3;
|LEE 040#17=;
|SI FSalida ! 0; |DDEFECTO #17; |FINSI;

|SI #4#41 = "S"; |HAZ agricola_si; |FINSI;
|SI #4#41 = "N"; |HAZ agricola_no; |FINSI;

se_empre = #10#0;
se_ejerc = #10#3;
se_perio = #10#2;
se_tipos = 130;
se_activ = #10#1;
se_impor = #10#29;
se_fecha = #10#4;
se_factu = "";
|HAZ seguimie;

sw_130 = 0; |HAZ graba_glob;
sw_130 = 1; |HAZ graba_glob;
|FPRC;

|| /////////////
|PROCESO ElRestodelCalculo;
    #106#22 = #106#18 - #106#19 - #106#21;

    |SI #106#38 = "S"; |Y #106#22 > 0;  ||nuevo
        #106#39 = #106#22 % 20;
    |SINO;
        #106#39 = 0;
    |FINSI;
    #106#22 = #106#22 - #106#39;

    #106#25 = #106#23 + #106#24;

    |SI #16#10 = 1; #106#26 = #106#18; |SINO; #106#26 = #106#22; |FINSI;
    #106#26 = #106#26 + #106#33;
    #106#27 = #106#26 % 20;
    #106#31 = #106#30 % 2;

    #106#29 = #106#27 - #106#28 - #106#25;
    cuota = #106#31 - #106#32;

    #106#29 = #106#29 + cuota;
    |SI #106#29 < 0; #106#29 = 0; |FINSI;
|FPRC;

|PROCESO TotalGastos;
    |SI #106#1 ! nClave1;
        |SI nOpe = 0;
            |SI #106#18 > 0;
                nTotalG17 = nTotalG17 + #106#18;
                #106#21   = #106#18 % #106#20;
                |SI #106#21 < 0;  #106#21 = 0;  |FINSI;
                nTotalG21 = nTotalG21 + #106#21;
            |FINSI;
        |SINO;
            |SI #106#18 > 0;
                #106#21 = (#106#18 / nTp) ! 2;
            |SINO;
                #106#21 = 0;
            |FINSI;
            nTotalG21 = nTotalG21 + #106#21;
            |HAZ ElRestodelCalculo;
            |GRABA 040#106a;
        |FINSI;
    |FINSI;
    |LIBERA #106;
|FPRC;

|DEFBUCLE TotalGastos;
     #106#1004;
     ;
     nClave0, 1, nClave2, nClave3;
     nClave0, 6, nClave2, nClave3;
     e;
     NULL, TotalGastos;
|FIN;

|PROCESO RecogeTotalGastos;
     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/eosm2130.mas";
     |CARGA_DEF aDef, espejo6@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def eosm2130";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     nTotalG17 = 0;
     nTotalG21 = 0;
     |SI #10#18 > 0;
         nTotalG17 = #10#18;
         nTotalG21 = #10#18 % #10#20;
     |FINSI;

     nClave0 = #10#0;
     nClave1 = #10#1;
     nClave2 = #10#2;
     nClave3 = #10#3;

     nOpe = 0; |BUCLE TotalGastos;
     nOpe = 2;
     nTp  = (100 / #10#20) ! 2;
     |SI nTotalG21 > 2000;
         nTp  = (nTotalG17 / 2000) ! 2;
         nOpe = 1;
     |FINSI;
     nTotalG21 = 0;
     |BUCLE TotalGastos;
     |SI nOpe = 1;
         #10#21 = 2000 - nTotalG21;
     |SINO;
         #10#21 = (#10#18 % #10#20) ! 2;
     |FINSI;
     |SI #10#21 < 0; #10#21 = 0; |FINSI;
     |DESCARGA_DEF #espejo6@;
|FPRC;
|| /////////////

|PROCESO agricola_no;
pagos   = 0;
f_antes = 0;
i_antes = 0;
e_antes = "N";

#10#0 = #15#0;
#10#1 = #15#1;
#10#2 = #15#2 - 1;
#10#3 = #15#3;
|LEE 040#10=;
|SI FSalida = 0;
    nEl27   = 0; |SI #10#27 > 0; nEl27 = #10#27; |FINSI;
    enNume  = nEl27 - #10#28 - #10#25; |SI enNume < 0; enNume = 0; |FINSI;
    pagos   = enNume + #10#28;
    || pagos   = #10#28 + #10#29;
    f_antes = #10#11;
    i_antes = #10#17;
    e_antes = #10#38;
|FINSI;

#10#0 = #15#0;
#10#1 = #15#1;
#10#2 = #15#2;
#10#3 = #15#3;
|LIBERA #10;
|LEE 140#10=;
FEstado = FSalida;
|SI FEstado ! 0;
    |DDEFECTO #10;
    #10#0 = #15#0;
    #10#1 = #15#1;
    #10#2 = #15#2;
    #10#3 = #15#3;
    #10#38 = e_antes;
|FINSI;

#10#6  = #15#5;
#10#7  = #15#4;
#10#8  = #10#6 + #10#7;

|SI #15#2 = 1; #10#9 = #17#7;  |FINSI;
|SI #15#2 = 2; #10#9 = #17#8;  |FINSI;
|SI #15#2 = 3; #10#9 = #17#9;  |FINSI;
|SI #15#2 = 4; #10#9 = #17#10; |FINSI;

#10#10 = f_antes;
#10#11 = #10#9;
#10#12 = #15#7;
#10#13 = #15#6;
#10#14 = #10#12 + #10#13;

|SI #15#2 = 1; #10#15 = #17#3;  |FINSI;
|SI #15#2 = 2; #10#15 = #17#3;  |FINSI;
|SI #15#2 = 3; #10#15 = #17#3;  |FINSI;
|SI #15#2 = 4; #10#15 = #17#3;  |FINSI;

#10#16 = i_antes;
#10#17 = #10#15;

#10#18 = #10#8 + #10#11 - #10#14 - #10#17;

|SI #0#2 ] 0;  |Y #0#2 [ 80;
    #10#20 = #4#25;
    #10#21 = #10#18 % #10#20;
    #10#19 = 0;
|SINO;
    |SI #0#2 [ 97;
        |SI #4#22 = "B";
            #10#20 = #4#25;
            #10#21 = #10#18 % #10#20;
            #10#19 = 0;
        |SINO;
            #10#20 = 0;
            #10#21 = 0;
            |SI #4#23 = "P"; #10#19 = #10#8 % 1; |SINO; #10#19 = 0; |FINSI;
        |FINSI;
    |SINO;
        #10#20 = #4#25;
        #10#21 = #10#18 % #10#20;
        #10#19 = 0;
    |FINSI;
|FINSI;

|SI #10#18 < 0; #10#19 = 0; #10#21 = 0; |FINSI;

|SI #10#21 > 2000; |Y #10#3 = 15;
    #10#21 = 2000;
|FINSI;

|SI #10#3 ] 16; |Y #4#46 ! "S";
    |HAZ RecogeTotalGastos;
|FINSI;

#10#22 = #10#18 - #10#19 - #10#21;
|SI #0#2 ] 10; |Y #0#2 [ 80; ||nuevo
    |SI #10#38 = "S"; |Y #10#22 > 0;
        #10#39 = #10#22 % 20;
    |SINO;
        #10#39 = 0;
    |FINSI;
    #10#22 = #10#22 - #10#39;
|FINSI;

#10#23 = #15#9;
#10#24 = #15#8;
#10#25 = #10#23 + #10#24;

|SI #16#10 = 1; #10#26 = #10#18; |SINO; #10#26 = #10#22; |FINSI;
#10#26 = #10#26 + #10#33;
#10#27 = #10#26 % 20;
#10#28 = pagos;
#10#29 = #10#27 - #10#28 - #10#25;
|SI #10#29 < 0; #10#29 = 0; |FINSI;

|SI FEstado = 0; |GRABA 140#10a; |SINO; |GRABA 140#10n; |FINSI;
|FPRC;

|PROCESO agricola_si;
#10#0 = #15#0;
#10#1 = #15#1;
#10#2 = #15#2;
#10#3 = #15#3;
|LIBERA #10;
|LEE 140#10=;
FEstado = FSalida;

|DDEFECTO #10;
#10#0  = #15#0;
#10#1  = #15#1;
#10#2  = #15#2;
#10#3  = #15#3;
#10#30 = #15#5;
#10#31 = #15#5 % 2;
#10#32 = #15#9;
#10#29 = #10#31 - #10#32;
|SI #10#29 < 0; #10#29 = 0; |FINSI;
|SI FEstado = 0; |GRABA 140#10a; |SINO; |GRABA 140#10n; |FINSI;
|FPRC;

|PROCESO borra_130;
|BORRA 140#24a;
|LIBERA #24;
|FPRC;

|DEFBUCLE eosm3130_1;
#24#1;
32;
#10#0, 1, #10#2, #10#3, "N";
#10#0, 9, #10#2, #10#3, "N";
e;
NULL, borra_130;
|FIN;

|PROCESO graba_glob;
nSwPasada = 0;
|PARA act_nor = 1; |SI act_nor [ 6; |HACIENDO act_nor = act_nor + 1;
      |SALVA_DATOS #10;
      #4#0 = #10#0;
      #4#1 = act_nor;
      #4#2 = #10#3;
      |LEE 040#4=;
      |SI FSalida = 0;
          |SI #4#46 = "S";
              |SI nSwPasada = 0;  |HAZ comunero; |FINSI;
          |SINO;
              |SI #4#14 = "S";
                  |SI nSwPasada = 0;  |HAZ comuneroC; |FINSI;
              |SINO;
                  |HAZ normal;
              |FINSI;
          |FINSI;
      |FINSI;
      |REPON_DATOS #10;
|SIGUE;
|FPRC;
|| ////////////////////////////////////////////////////////////////////////

|PROCESO dsmod130;
     |SI #1130#3 = 8;  |Y #1130#2 = 1;
          nImporte = #1130#29;
     |SINO;
          nImporte = #1130#46;
     |FINSI;

     |SI nImporte < 0; nSwNeg = 1; |FINSI;

     |SI nImporte ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1130#42;

     |SI nImporte < 0;
         #24#43 = #24#43 + -nImporte;
     |SINO;
         #24#43 = #24#43 - #1130#42;
         |SI #24#43 [ 0; nSwNeg = 0; #24#43 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsmod130;
     #1130#1004;
     ;
     #24#0, #24#1,     1, #24#3;
     #24#0, #24#1, nHPer, #24#3;
     ;
     NULL, dsmod130;
|FIN;

|PROCESO CapturaNegativos130;
     |SI #24#42 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm3130.mas";
     |CARGA_DEF aMas, eosm3130@;

     nSwNeg   = 0;
     nSumaD   = 0;
     #24#43    = 0;
     nHPer    = #24#2 - 1;
     |BUCLE dsmod130;

     |DESCARGA_DEF #eosm3130@;
|FPRC;

|PROCESO dsmod130Tope;
     nTopeAgrario = nTopeAgrario + #1130#47;
|FPRC;

|DEFBUCLE dsmod130Tope;
     #1130#1004;
     ;
     #24#0, #24#1,     1, #24#3;
     #24#0, #24#1, nHPer, #24#3;
     ;
     NULL, dsmod130Tope;
|FIN;

|PROCESO CapturaTopeAgrario;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosm3130.mas";
     |CARGA_DEF aMas, eosm3130@;

     nTopeAgrario = 0;
     nHPer        = #24#2 - 1;
     |BUCLE dsmod130Tope;

     |DESCARGA_DEF #eosm3130@;
|FPRC;

|PROCESO CalculaDed130;
     |SI nEjer < 2008;
         #24#41 = 0;
         #24#42 = 0;
         #24#43 = 0;
         #24#44 = 0;
         #24#47 = 0;
         |ACABA;
     |FINSI;

     #24#42 = #24#29 - #24#41;

     |SI #24#42 [ 0;
         #24#43 = 0;
         #24#47 = 0;
         |ACABA;
     |FINSI;

     |SI nEjer = 2008;
         |SI #24#2 > 1;
             |HAZ CapturaNegativos130;
         |SINO;
             #24#41 = 0;
             #24#42 = 0;
             #24#43 = 0;
             #24#44 = 0;
             #24#47 = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nEjer ] 2009;
         |SI #24#2 ! 1;
             |HAZ CapturaNegativos130;
         |FINSI;
     |FINSI;

     nSuma = #24#43 + #24#47;
     |SI nSuma > #24#42;
         |SI #24#43 > #24#42;
             #24#43 = #24#42;
             #24#47 = 0;
             |ACABA;
         |FINSI;

         #24#47 = #24#42 - #24#43;
     |FINSI;
|FPRC;

|PROCESO Casilla5;
     pagos_g = 0;

     |SI #10#2 = 1;  |ACABA;  |FINSI;

     |SI #0#2 ] 80;
         nEjer = 1900 + #0#2;
     |SINO;
         nEjer = 2000 + #0#2;
     |FINSI;

     |SI nEjer [ 2008;
         #24#0 = nEmpresa;
         #24#1 = nActividad;
         #24#2 = #0#3 - 1;
         #24#3 = #0#2;
         |LEE 000#24=;
         |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

         nEl27   = 0;
         |SI #24#27 > 0;
             nEl27 = #24#27;
         |FINSI;

         enNume  = nEl27 - #24#28 - #24#25;
         |SI enNume < 0; enNume = 0; |FINSI;

         pagos_g = enNume + #24#28;

         |ACABA;
     |FINSI;

     nHPer   = #0#3 - 1;
     |PARA nNume1 = 1; |SI nNume1 [ nHPer; |HACIENDO nNume1 = nNume1 + 1;
           |DDEFECTO #24;
           #24#0 = nEmpresa;
           #24#1 = nActividad;
           #24#2 = nNume1;
           #24#3 = #0#2;
           |LEE 040#24=;
           |SI FSalida = 0;
               nEl27   = 0;
               |SI #24#27 > 0;
                   nEl27 = #24#27;
               |FINSI;

               enNume  = nEl27 - #24#28 - #24#25;
               |SI enNume < 0; enNume = 0; |FINSI;

               pagos_g = pagos_g + (enNume - #24#47);
           |FINSI;
     |SIGUE;
|FPRC;

|| ************************************************************************
|PROCESO ParaCalMinoracion;
  enMod130 = 130;
  enEje130 = #10#3;
  enEmp130 = #10#0;
  enAct130 = #10#1;
  enPer130 = #10#2;
  efFec130 = fFecha1;
  enRend_NoAgr = #10#22;
  enRend_Agr   = #10#30;
  |HAZ eGrabadsmom094;
|FPRC;

|PROCESO ParaCalMinoracionC;
  enMod130 = 130;
  enEje130 = #10#3;
  enEmp130 = #25#3;
  enAct130 = #25#5;
  enPer130 = #10#2;
  efFec130 = fFecha1;
  enRend_NoAgr = ( #10#22  % #25#6) ! 2;
  enRend_Agr   = ( #10#30  % #25#6) ! 2;
  |HAZ eGrabadsmom094;
|FPRC;
|| ************************************************************************

|PROCESO PrimeroTope;
   |SI #10#3 = 15;
       nNume1 = #24#21 + #10#21;
       |SI nNume1 > 2000;
           #10#21 = 2000 - #24#21;
           |SI #10#21 < 0; #10#21 = 0; |FINSI;
      |SINO;
           |ACABA;
      |FINSI;

      #10#22 = #10#18 - #10#19 - #10#21;

      |SI #10#38 = "S"; |Y #10#22 > 0;  ||nuevo
          #10#39 = #10#22 % 20;
      |SINO;
          #10#39 = 0;
      |FINSI;
      #10#22 = #10#22 - #10#39;

      #10#25 = #10#23 + #10#24;

      |SI #16#10 = 1; #10#26 = #10#18; |SINO; #10#26 = #10#22; |FINSI;
      #10#26 = #10#26 + #10#33;
      #10#27 = #10#26 % 20;
      #10#31 = #10#30 % 2;

      #10#29 = #10#27 - #10#28 - #10#25; || ... |SI #10#29 < 0; #10#29 = 0; |FINSI;   Tique Asefeco
      cuota = #10#31 - #10#32;         || ... |SI cuota < 0; cuota = 0; |FINSI;   Tique Asefeco

      #10#29 = #10#29 + cuota;
      |SI #10#29 < 0; #10#29 = 0; |FINSI; || Tique 70000_4881
  |FINSI;
|FPRC;

|PROCESO normal;
     |SI sw_130 = 0; |BUCLE eosm3130_1; |ACABA; |FINSI;
     |SI #4#42 = "S"; activi_g = #4#1; |SINO; activi_g = 9; |FINSI;

     fFecha1 = #4#48;

     |SI #10#3 ] 80;
         nEjer = 1900 + #10#3;
     |SINO;
         nEjer = 2000 + #10#3;
     |FINSI;

     nEmpresa   = #4#0;
     nActividad = activi_g;

     #10#0 = #4#0;
     #10#1 = #4#1;
     #10#2 = #0#3;
     #10#3 = #4#2;
     |LEE 040#10=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI nEjer ] 2010; |HAZ ParaCalMinoracion; |FINSI;
     |ABRE #24;

     nEmpresa   = #10#0;
     nActividad = activi_g;
     |HAZ Casilla5;

     #24#0 = #10#0;
     #24#1 = activi_g;
     #24#2 = #10#2;
     #24#3 = #10#3;
     |LIBERA #24;
     |LEE 140#24=;
     FEstado = FSalida;
     |SI FEstado ! 0;
         |DDEFECTO #24;
         #24#0 = #10#0;
         #24#1 = activi_g;
         #24#2 = #10#2;
         #24#3 = #10#3;
     |FINSI;

     |HAZ PrimeroTope;
     |PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
           #24x = #24x + #10x;
     |SIGUE;
     #24#48 = #10#38;
     #24#49 = #10#39;

    |SI #24#3 ] 80;
        nEjer = 1900 + #24#3;
    |SINO;
        nEjer = 2000 + #24#3;
    |FINSI;

    enMod130 = 130;
    enEmp130 = #24#0;
    enEje130 = #24#3;
    enPer130 = #24#2;
    enRend_NoAgr = #24#22;
    enRend_Agr   = #24#30;
    |HAZ eLeeAplica;

    #24#41 = 0; #24#42 = 0;
    #24#43 = 0; #24#44 = 0;

    |SI nEjer = 2008; |Y eaAplica1 ! "N";
        |SI #24#2 = 2;  #24#41 = 200;  |FINSI;
        |SI #24#2 = 3;  #24#41 = 100;  |FINSI;
        |SI #24#2 = 4;  #24#41 = 100;  |FINSI;
    |FINSI;

    |SI nEjer = 2009; |Y eaAplica1 ! "N";
        |SI #24#2 = 1;  #24#41 = 100;  |FINSI;
        |SI #24#2 = 2;  #24#41 = 100;  |FINSI;
        |SI #24#2 = 3;  #24#41 = 100;  |FINSI;
        |SI #24#2 = 4;  #24#41 = 100;  |FINSI;
    |FINSI;

    |SI nEjer ] 2010; |Y eaAplica1 ! "N";
        #24#41 = enApli400;
    |FINSI;

    #24#47 = 0;
    |SI nEjer ] 2009; |Y eaAplica2 = "S";
        |SI #24#22 > 0;
            #24#47 = #24#22 % 2;
            |SI enAplica3 = 0;
                |SI #24#47 > 660.14;
                    #24#47 = 660.14;
                |FINSI;
            |SINO;
                |SI #24#47 > 440;
                    #24#47 = 440;
                |FINSI;
            |FINSI;
        |SINO;
            |SI #24#30 > 0;
                #24#47 = #24#30 % 2;
                |HAZ CapturaTopeAgrario;
                |SI enAplica3 = 0;
                    nTope = 660.14 - nTopeAgrario;
                |SINO;
                    nTope = 440 - nTopeAgrario;
                |FINSI;
                |SI nTope < 0;  nTope = 0;  |FINSI;
                |SI #24#47 > nTope;
                    #24#47 = nTope;
                |FINSI;
            |FINSI;
        |FINSI;
     |FINSI;

     #24#37 = #24#37 + #10#33;

     |SI #4#41 = "N"; #24#28 = pagos_g; |FINSI;

     #24#30 = #24#30 + #10#30;
     #24#31 = #24#31 + #10#31;
     #24#36 = #24#36 + #10#32;

     #24#29 = #24#27 - #24#28 - #24#25; ||  |SI #24#29 < 0; #24#29 = 0; |FINSI;

     cuota = #24#31 - #24#36;           ||  |SI cuota < 0; cuota = 0; |FINSI;

     #24#29 = #24#29 + cuota;
     |SI #24#29 < 0; #24#29 = 0; |FINSI;

     |HAZ CalculaDed130;

     #24#44 = #24#42 - #24#43 - #24#47;
     #24#46 = #24#44 - #24#45;   ||nuevo calculo Ley 80

     |SI FEstado ! 0; |GRABA 140#24n; |SINO; |GRABA 140#24a; |FINSI;

     |CIERRA #24;
|FPRC;

|PROCESO graba_inde;
#26#0 = #25#3;
|LIBERA #26;
|LEE 140#26=;
|SI FSalida = 0; |GRABA 140#26a; |SINO; |GRABA 140#26n; |FINSI;
|FPRC;

|DEFBUCLE eoscomul_1;
#25#1;
;
#10#0, #10#1, #10#3, 000;
#10#0, #10#1, #10#3, 999;
e;
NULL, graba_inde;
|FIN;

|DEFBUCLE eosm3130_2;
#24#1;
32;
#25#3, 1, #10#2, #10#3, "S";
#25#3, 9, #10#2, #10#3, "S";
be;
NULL, borra_130;
|FIN;

|PROCESO graba_comu;
     |SI sw_130 = 0; |BUCLE eosm3130_2; |ACABA; |FINSI;

     nSwPasada = 1;
     |ABRE #1;
     #1#0 = #25#0;
     |LEE 040#1=;
     |SI FSalida ! 0; |DDEFECTO #1; |FINSI;
     |CIERRA #1;

     #4#0 = #25#3;
     #4#1 = #25#5;
     #4#2 = #25#7;
     |LEE 040#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     fFecha1 = #4#48;

     |SI #4#42 = "S"; activi_g = #25#5; |SINO; activi_g = 9; |FINSI;

     #10#0 = #25#0;
     #10#1 = #25#1;
     #10#2 = #0#3;
     #10#3 = #0#2;
     |LEE 040#10=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #10#3 ] 80;
         nEjer = 1900 + #10#3;
     |SINO;
         nEjer = 2000 + #10#3;
     |FINSI;
     |SI nEjer ] 2010; |HAZ ParaCalMinoracionC; |FINSI;

     |ABRE #24;

     nEmpresa   = #25#3;
     nActividad = activi_g;
     |HAZ Casilla5;

     #24#0 = #25#3;
     #24#1 = activi_g;
     #24#2 = #10#2;
     #24#3 = #10#3;
     |LIBERA #24;
     |LEE 140#24=;
     FEstado = FSalida;
     |SI FEstado ! 0;
         |DDEFECTO #24;
         #24#0 = #25#3;
         #24#1 = activi_g;
         #24#2 = #10#2;
         #24#3 = #10#3;
     |FINSI;

     |HAZ PrimeroTope;
     |PARA x = 6; |SI x [ 27; |HACIENDO x = x + 1;
         #24x = #24x + (#10x % #25#6);
     |SIGUE;
      #24#48 = #10#38;
      #24#49 = #10#39 % #25#6;

    |SI #24#3 ] 80;
        nEjer = 1900 + #24#3;
    |SINO;
        nEjer = 2000 + #24#3;
    |FINSI;

     enMod130 = 130;
     enEmp130 = #24#0;
     enEje130 = #24#3;
     enPer130 = #24#2;
     enRend_NoAgr = #24#22;
     enRend_Agr   = #24#30;
     |HAZ eLeeAplica;

     #24#41 = 0; #24#42 = 0;
     #24#43 = 0; #24#44 = 0;
     |SI nEjer = 2008; |Y eaAplica1 ! "N";
         |SI #24#2 = 2;  #24#41 = 200;  |FINSI;
         |SI #24#2 = 3;  #24#41 = 100;  |FINSI;
         |SI #24#2 = 4;  #24#41 = 100;  |FINSI;
     |FINSI;

     |SI nEjer = 2009; |Y eaAplica1 ! "N";
         |SI #24#2 = 1;  #24#41 = 100;  |FINSI;
         |SI #24#2 = 2;  #24#41 = 100;  |FINSI;
         |SI #24#2 = 3;  #24#41 = 100;  |FINSI;
         |SI #24#2 = 4;  #24#41 = 100;  |FINSI;
     |FINSI;

     |SI nEjer ] 2010; |Y eaAplica1 ! "N";
         #24#41 = enApli400;
     |FINSI;

    #24#47 = 0;
    |SI nEjer ] 2009; |Y eaAplica2 = "S";
        |SI #24#22 > 0;
            #24#47 = #24#22 % 2;
            |SI enAplica3 = 0;
                |SI #24#47 > 660.14;
                    #24#47 = 660.14;
                |FINSI;
            |SINO;
                |SI #24#47 > 440;
                    #24#47 = 440;
                |FINSI;
            |FINSI;
        |SINO;
            |SI #24#30 > 0;
                #24#47 = #24#30 % 2;
                |HAZ CapturaTopeAgrario;
                |SI enAplica3 = 0;
                    nTope = 660.14 - nTopeAgrario;
                |SINO;
                    nTope = 440 - nTopeAgrario;
                |FINSI;
                |SI nTope < 0;  nTope = 0;  |FINSI;
                |SI #24#47 > nTope;
                    #24#47 = nTope;
                |FINSI;
            |FINSI;
        |FINSI;
     |FINSI;

     #24#37 = #24#37 + (#10#33 % #25#6);

     |SI #4#41 = "N"; #24#28 = pagos_g; |FINSI;

     #24#20 = #10#20;
     #24#30 = #24#30 + (#10#30 % #25#6);
     #24#31 = #24#31 + (#10#31 % #25#6);
     #24#36 = #24#36 + (#10#32 % #25#6);

     #24#29 = #24#27 - #24#28 - #24#25;   || |SI #24#29 < 0; #24#29 = 0; |FINSI;

     cuota = #24#31 - #24#36;             || |SI cuota < 0; cuota = 0; |FINSI;

     #24#29 = #24#29 + cuota;
     |SI #24#29 < 0; #24#29 = 0; |FINSI;

     #24#32 = "S";
     #24#33 = #24#33 + 1;
     #24#34 = #1#2;
     #24#35 = #25#6;

     |HAZ CalculaDed130;

     #24#44 = #24#42 - #24#43 - #24#47;
     #24#46 = #24#44 - #24#45;   ||nuevo calculo Ley 80

     |SI FEstado ! 0; |GRABA 140#24n; |SINO; |GRABA 140#24a; |FINSI;

     |CIERRA #24;
|FPRC;

|DEFBUCLE eoscomul_2;
#25#2;
1;
#26#0, 1, #10#3, 1;  ||act_nor;
#26#0, 6, #10#3, 6;  ||act_nor;
e;
NULL, graba_comu;
|FIN;

|DEFBUCLE eoscomul_22;
#25#1;
;
#26#0, 1, #10#3, 1;  ||act_nor;
#26#0, 6, #10#3, 6;  ||act_nor;
e;
NULL, graba_comu;
|FIN;

|PROCESO lee_comun;
|SI nSw = 0;  |BUCLE eoscomul_2;  |FINSI;
|SI nSw = 1;  |BUCLE eoscomul_22;  |FINSI;
|FPRC;

|DEFBUCLE eosw0016;
#26#1;
;
00000;
99999;
e;
NULL, lee_comun;
|FIN;

|PROCESO comunero;
comienza = "26";
|HAZ fichero;
|NOME_DAT #26 fichero;

|ABRE #26; |CIERRA #26;
|DELINDEX #26;

|ABRE #26;
|BUCLE eoscomul_1;
|CIERRA #26;

nSw = 0;  |BUCLE eosw0016;
|DELINDEX #26;
|FPRC;

|PROCESO graba_inde3;
#26#0 = #25#0;
|LIBERA #26;
|LEE 140#26=;
|SI FSalida = 0; |GRABA 140#26a; |SINO; |GRABA 140#26n; |FINSI;
|FPRC;

|DEFBUCLE eoscomul_3;
#25#2;
1;
#10#0, 1, #10#3, 1;  ||act_nor;
#10#0, 6, #10#3, 6;  ||act_nor;
e;
NULL, graba_inde3;
|FIN;

|PROCESO comuneroC;
comienza = "26";
|HAZ fichero;
|NOME_DAT #26 fichero;

|ABRE #26; |CIERRA #26;
|DELINDEX #26;

|ABRE #26;
|BUCLE eoscomul_3;
|CIERRA #26;

nSw = 1;  |BUCLE eosw0016;
|DELINDEX #26;
|FPRC;

|DEFBUCLE eosw0008;
#15#1;
;
00000, 1, 00, 00;
99999, 9, 99, 99;
e;
NULL, graba_mod;
|FIN;

|PROCESO pase;|TIPO 3;
|SI #0#5 ! "SI"; |ACABA; |FINSI;

comienza = "1";
|HAZ fichero;
|NOME_DAT #15 fichero;
|ABRE #15; |CIERRA #15; |DELINDEX #15;

|ABRE #8;
|ABRE #18;
|ABRE #15;
|ATRI I;
|PINTA 2330,"PASANDO LAS VENTAS";
|ATRI 0;

|HAZ periodo;
|BUCLE eoscabve;  || Pasamos  ventas

|PINTA 2330,"PASANDO LAS COMPRAS";
|ATRI 0;
|BUCLE eoscabco;  || Pasamos  compras

|BLIN 23;
|CIERRA #8;
|CIERRA #18;
|CIERRA #15;

|ABRE #16;
|LEE 040#16p;
|SI FSalida ! 0; |DDEFECTO #16; |FINSI;
|CIERRA #16;

|ABRE #10;
|ABRE #17;
|ABRE #4;
|BUCLE eosw0008;
|CIERRA #10;
|CIERRA #17;
|CIERRA #4;
|DELINDEX #15;
|FPRC;

|PROCESO periodo;
anio = ("00" + #0#2) % -102;
|SI #0#2 < 80; anio = "20" + anio; |SINO; anio = "19" + anio; |FINSI;

|SI #0#4 = "T";
    varalf = "01.01." + anio; fec1   = varalf;
    varalf = "31.12." + anio; fec2   = varalf;
    tri1   = 1;
    tri2   = #0#3;
|SINO;
    |SI #0#3 = 1;
        varalf = "01.01." + anio; fec1   = varalf;
        varalf = "31.03." + anio; fec2   = varalf;
        varalf = "31.03." + anio; fec3   = varalf;
        tri1   = 1;
        tri2   = 4;
    |FINSI;

    |SI #0#3 = 2;
        varalf = "01.01." + anio; fec1   = varalf;
        varalf = "30.06." + anio; fec2   = varalf;
        varalf = "01.04." + anio; fec3   = varalf;
        tri1   = 1;
        tri2   = 4;
    |FINSI;

    |SI #0#3 = 3;
        varalf = "01.01." + anio; fec1   = varalf;
        varalf = "30.09." + anio; fec2   = varalf;
        varalf = "01.07." + anio; fec3   = varalf;
        tri1   = 1;
        tri2   = 4;
    |FINSI;

    |SI #0#3 = 4;
        varalf = "01.01." + anio; fec1   = varalf;
        varalf = "31.12." + anio; fec2   = varalf;
        varalf = "01.10." + anio; fec3   = varalf;
        tri1   = 1;
        tri2   = 4;
    |FINSI;
|FINSI;
|FPRC;
