|FICHEROS;
     dsmoy000;
     dsmow190,MANTE;
|FIN;

|VARIABLES;
     nHandle             = 0;
     nHandle1            = 0;
     nHandleError        = 0;
     nReg                = 0;
     nError              = 0;
     nCodError           = 0;
     nConta              = 0;
     nPos                = 0;
     nPosi               = 0;
     nErrorCC            = 0;
     nErrorEE            = 0;
     nCaracter           = 0;
     nLong               = 0;
     nCopiado            = 0;
     nNoLoHago           = 0;
     nLinea              = 0;

     nBoton1             = 0;
     nBoton2             = 0;
     nBoton3             = 0;
     nBoton4             = 0;
     nBoton5             = 0;
     nBtnF2              = 0;
     nBtnF3              = 0;
     nBtnF4              = 0;
     nBtnF5              = 0;
     nBtnEs              = 0;

     aF2                 = "";
     aF3                 = "";
     aF4                 = "";
     aF5                 = "";
     aF6                 = "";
     aEsc                = "";
     aTecla              = "";
     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aNum                = "";
     aAbre               = "";
     aAbrePortal         = "";
     aOrigen             = "";
     aDestino            = "";
     aFicPortal          = "";
     aFicError           = "";
     aPathLocal          = "";
     aPathPlugins        = "";
     aPathPatrones       = "";
     aPatron             = "";
     aEjecutable         = "";
     aFichero            = "";
     aError              = "";
     aDocRemoto          = "";
     aDocServidor        = "";
     aIPRemoto           = "";
     aCadena1            = "";
     aCadena2            = "";
     aCadena3            = "";
     aCadena4            = "";
     aRegistro           = "";
     aTipo               = "";
     aNif                = "";
     aNombre             = "";
     aDescri             = "";
     aLong               = "";
     aCaracter           = "";
     aValidar            = "";
     aEnsobrar           = "";
     aEjecu              = "";
     aPrgJava            = "";
     aMod                = "";

     aHID                = "";
     aPRG                = "";
     aDIR                = "";
     aNDC                = "";
     aIDI                = "";
     aEJF                = "";
     aMOD                = "";
     aTIA                = "";
     aINI                = "";

     {1}aContiene        = "";

     {99}aCodEE          = "";
     {99}aCodDCC         = "";
     {99}aCodPCC          = "";

     &enErrorPortal      = 0;
     &eaEjer             = "";
     &eaModelos          = "";
     &eaAlfa             = "";
     &eaPathEmision      = "";
     &eaPathLanza        = "";
     &eaPathAEAT         = "";
     &eaPathExplorador   = "";
     &eaPathInternet     = "";
     &eaForzExplorador   = "";
     &eaFOrigen          = "";
     &eaFDestino         = "";
     &eaOpcion           = "";
     &eaJusti            = "";
     &eaUnidad           = "";
     &eaFicheroPlano     = "";
     &eaFicheroImpre     = "";
     &eaFicheroSalid     = "";
     &eaFicheroError     = "";
     &enEmpresa          = 0;
     &eaNomEmpresa       = "";
     &eaNIF              = "";
     &enPresentar        = 0;
     &enSinActividad     = 0;

     &eaTercera          = "";
     &enTecla            = 0;
     &eaPeriodo          = "";
     &eaPer              = "";
     &enPeriodo          = 0;
     &enError            = 0;
     &eaPathAcrobat      = "";
     &enHandlePortal     = 0;
     &enImprtMd          = 0;
|FIN;

|PROCESO GrabaPortal;
     eaAlfa = eaAlfa + &13 + &10;
     |XGRABA enHandlePortal, eaAlfa;
|FPRC;

|PROCESO GrabaPortalSin;
     |XGRABA enHandlePortal, eaAlfa;
|FPRC;

|PROCESO VarVacia_Plb;
     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + aTipo + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;
|FPRC;

|PROCESO MandaInformativas;
     |SI eaUnidad = "";
         |HAZ LeeUnidad;
     |FINSI;

     eaPathAEAT = eaUnidad + "\AEAT";            |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaModelos;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaEjer;     |RMKDIR eaPathAEAT;
     |SI eaPeriodo ! "";
         eaPathAEAT = eaPathAEAT + "\" + eaPeriodo;  |RMKDIR eaPathAEAT;
     |FINSI;
     eaPathAEAT = eaPathAEAT + "\";

     |DBASE aAlfa;  |QBT aAlfa;
     eaFOrigen  = aAlfa + "hacienda/wait.exe";
     eaFDestino = eaPathAEAT + "wait.exe";
     |HAZ CopiaFicheroPtl;

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathAEAT     + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     |SI eaEjer [ "2013";
         eaAlfa = eaPathExplorador + " " + &34 + "https://www2.agenciatributaria.gob.es/es13/h/servurli.html";
         |HAZ GrabaPortalSin;

         eaAlfa = "?WEB=INTERNET&PRG=" + eaModelos + "&EJE=" + eaEjer + "&URL=PIR&EXT=?FIC=";
         |HAZ GrabaPortalSin;

         eaAlfa = eaPathInternet + eaFicheroPlano + &34 + &13 + &10;
         |HAZ GrabaPortalSin;
     |FINSI;

     |SI eaEjer ] "2014";  |Y eaEjer [ "2016";
         eaAlfa = eaPathExplorador + " " + &34;
         |HAZ GrabaPortalSin;

         eaAlfa = "https://www1.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/ov/servurli.html";
         |HAZ GrabaPortalSin;

         eaAlfa = "?WEB=INTERNET&PRG=" + eaModelos;
         |HAZ GrabaPortalSin;

         eaAlfa = "&EJE=" + eaEjer;
         |HAZ GrabaPortalSin;

         eaAlfa = "&URL=PIR&EXT=?FIC=";
         |HAZ GrabaPortalSin;

         eaAlfa = eaPathInternet + eaFicheroPlano + &34 + &13 + &10;
         |HAZ GrabaPortalSin;
     |FINSI;

     |SI eaEjer = "2017";
         eaAlfa = eaPathExplorador + " " + &34;
         |HAZ GrabaPortalSin;

         eaAlfa = "https://www1.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/ov/servurli.html";
         |HAZ GrabaPortalSin;

         eaAlfa = "?WEB=INTERNET&PRG=" + eaModelos;
         |HAZ GrabaPortalSin;

         eaAlfa = "&EJE=" + eaEjer;
         |HAZ GrabaPortalSin;

         eaAlfa = "&URL=PIR";
         |HAZ GrabaPortalSin;
     |FINSI;

     |SI eaEjer = "2018";
         eaAlfa = eaPathExplorador + " " + &34;
         |HAZ GrabaPortalSin;

         aAlfa = eaEjer % -102;
         eaAlfa = "https://www1.agenciatributaria.gob.es/wlpl/PA" + aAlfa + "-M";
         eaAlfa = eaAlfa + eaModelos + "/index.zul";
         |HAZ GrabaPortalSin;
     |FINSI;

     |SI eaEjer ] 2019;
         eaAlfa = eaPathExplorador + " " + &34;
         |HAZ GrabaPortalSin;

         eaAlfa = "https://www1.agenciatributaria.gob.es/wlpl/PAIN-M" + eaModelos;
         eaAlfa = eaAlfa + "/E" + eaEjer + "/index.zul";
         |HAZ GrabaPortalSin;
     |FINSI;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     ||RFBORRA aAbre;
|FPRC;

|PROCESO Portal349;
     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     |SI eaEjer [ 2019;
         aAlfa = eaEjer  % -102;
         eaAlfa = eaPathExplorador + " " + &34 + "https://www1.agenciatributaria.gob.es/wlpl/PA" + aAlfa + "-M349/index.zul";
     |SINO;
         eaAlfa = eaPathExplorador + " " + &34 + "https://www1.agenciatributaria.gob.es/wlpl/PAIN-M349/E" + eaEjer + "/index.zul";
     |FINSI;
     |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;
|FPRC;

|PROCESO MandaPeriodicas;
     |SI eaUnidad = "";
         |HAZ LeeUnidad;
     |FINSI;

     eaPathAEAT = eaUnidad + "\AEAT";            |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaModelos;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + eaEjer;     |RMKDIR eaPathAEAT;
     |SI eaPeriodo ! "";
         eaPathAEAT = eaPathAEAT + "\" + eaPeriodo;  |RMKDIR eaPathAEAT;
     |FINSI;
     eaPathAEAT = eaPathAEAT + "\";

     |DBASE aAlfa;  |QBT aAlfa;
     eaFOrigen  = aAlfa + "hacienda/wait.exe";
     eaFDestino = eaPathAEAT + "wait.exe";
     |HAZ CopiaFicheroPtl;

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathAEAT + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaEjer ] "2018";
         |SI eaModelos = "349";
             |HAZ Portal349;
             |ACABA;
         |FINSI;
     |FINSI;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34 + "https://www1.agenciatributaria.gob.es/es13/h/iemodelb.html";
     |HAZ GrabaPortalSin;

     aNum = eaEjer % -101;
     eaAlfa = "?mod=" + aNum + eaModelos + "0&FIC=";
|| ...     eaAlfa = "?mod=3" + eaModelos + "0&FIC="; Tique 1030_714
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathAEAT + eaFicheroPlano + &34 + &13 + &10;
     |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaPathAEAT + aFichero;
     ||RFBORRA aAlfa;
     ||RFBORRA aAbre;
|FPRC;

|PROCESO MandaAInternet;
     |SI enPresentar = 0;
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFicheroPtl;

         |ACABA;
     |FINSI;

     eaPathAEAT = eaUnidad + "\AEAT";
     eaPathAEAT = eaPathAEAT + "\" + eaModelos;
     eaPathAEAT = eaPathAEAT + "\" + eaEjer;
     |SI eaPeriodo ! "";
         eaPathAEAT = eaPathAEAT + "\" + eaPeriodo;
     |FINSI;
     eaPathAEAT = eaPathAEAT;

     aAlfa = "0000Ubicacion: " + eaPathAEAT + &13 + &10;
     aAlfa = aAlfa  + " Fichero: " + eaFicheroPlano;
     |MENAV aAlfa;

     |SI eaModelos = "180";  |O eaModelos = "184";  |O eaModelos = "190";
      |O eaModelos = "193";  |O eaModelos = "296";  |O eaModelos = "347";
         |HAZ MandaInformativas;
     |FINSI;

     |SI eaModelos = "349";  |O eaModelos = "340";
         |HAZ MandaPeriodicas;
     |FINSI;
|FPRC;

|PROCESO CopiaFicheroPtl;
     nCopiado   = 0;

     aContiene1 = eaFDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = eaFOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaFOrigen, eaFDestino;
         |SINO;
             |COPIA_FICHERO eaFOrigen, eaFDestino;
         |FINSI;

         nCopiado = 1;
     |FINSI;
|FPRC;

|PROCESO RecibeFicheroPtl;
     nCopiado   = 0;

     aContiene1 = eaFDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = eaFOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO eaFOrigen, eaFDestino;
         |SINO;
             |COPIA_FICHERO eaFOrigen, eaFDestino;
         |FINSI;

         nCopiado = 1;
     |FINSI;
|FPRC;

|PROCESO LeeFicheroSalida390;
     enErrorPortal = 1;

     aAbre = eaPathLanza + eaFicheroError;
     |XABRE "C", aAbre, nHandleError;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nLinea = 0;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandleError, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aAlfa1 = aAlfa - "Conversion realizada correctamente";
          |SI FSalida ! 0;
              enErrorPortal = 0;
              |SAL;
          |FINSI;

          nLinea = nLinea + 1;
          |SI nLinea > 2;  |SAL;  |FINSI;
     |SIGUE;

     |XCIERRA nHandleError;

     |SI enErrorPortal = 1;
         #dsmow190#0 = eaFicheroError;
         #dsmow190#1 = enEmpresa;
         #dsmow190#2 = eaNomEmpresa;
         |GRABA 020#dsmow190.n;
         |LIBERA #dsmow190;
     |SINO;
         aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

         eaFOrigen  = eaPathLanza + eaFicheroSalid;
         eaFDestino = eaPathEmision + eaFicheroSalid;
         |HAZ RecibeFicheroPtl;
     |FINSI;
|FPRC;

|PROCESO PasaAPlano;
     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathLanza + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + eaPathLanza + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aPrgJava = "iva.jar";
     |SI aValidar ! "SI";
         aPrgJava = "ivabor.jar";
     |FINSI;

     aAlfa = eaPathLanza + "wait ";
     aAlfa = aAlfa + "java -cp " + aPrgJava + ";xercesImpl-2.6.2.jar;xml-apis-2.6.2.jar com.dit.aeat.traductor.Console ";
     aAlfa = aAlfa + eaPathLanza + eaFicheroPlano;
     aAlfa = aAlfa + " -ejf " + eaEjer + " -mod " + eaModelos;

     |SI aValidar = "SI";
         aAlfa = aAlfa + " -validar ";
     |FINSI;

     |SI aEnsobrar = "SI";
         aAlfa = aAlfa + " -ensobrar";
     |FINSI;

     aAlfa = aAlfa + " > " + eaFicheroError + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;

     |HAZ LeeFicheroSalida390;

     aAlfa = eaPathLanza + "imprime.bat";  |RFBORRA aAlfa;
|FPRC;

|PROCESO CargaListaErrores;
     IaCodEE = aCodEE1 <-;

     |PARA nCodError = 1;  |SI nCodError [ 99;  |HACIENDO nCodError = nCodError + 1;
           aCodEE = "";

           IaCodEE = IaCodEE + 1;
     |SIGUE;

     IaCodDCC = aCodDCC1 <-;

     |PARA nCodError = 1;  |SI nCodError [ 99;  |HACIENDO nCodError = nCodError + 1;
           aCodDCC = "";

           IaCodDCC = IaCodDCC + 1;
     |SIGUE;

     IaCodPCC = aCodPCC1 <-;

     |PARA nCodError = 1;  |SI nCodError [ 99;  |HACIENDO nCodError = nCodError + 1;
           aCodPCC = "";

           IaCodPCC = IaCodPCC + 1;
     |SIGUE;

     aAbre = eaPathLanza + "listaerrores.asc";
     |XABRE "C", aAbre, nHandleError;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandleError, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aAlfa1 = aAlfa % 103;
          |SI aAlfa1 = "EEE";
              aAlfa1 = aAlfa % 402;  nErrorEE = aAlfa1;

              IaCodEE = aCodEE1 <-;
              IaCodEE = IaCodEE + (nErrorEE - 1);

              aAlfa2 = aAlfa % 106;
              aCodEE = aAlfa - aAlfa2;
          |FINSI;

          |SI aAlfa1 = "DCC";
              aAlfa1 = aAlfa % 402;  nErrorCC = aAlfa1;

              IaCodDCC = aCodDCC1 <-;
              IaCodDCC = IaCodDCC + (nErrorCC - 1);

              aAlfa2   = aAlfa % 106;
              aCodDCC  = aAlfa - aAlfa2;
          |FINSI;

          |SI aAlfa1 = "PCC";
              aAlfa1 = aAlfa % 402;  nErrorCC = aAlfa1;

              IaCodPCC = aCodPCC1 <-;
              IaCodPCC = IaCodPCC + (nErrorCC - 1);

              aAlfa2   = aAlfa % 106;
              aCodPCC  = aAlfa - aAlfa2;
          |FINSI;
     |SIGUE;

     |XCIERRA nHandleError;
|FPRC;

|PROCESO TraeTgzCobol;
     |SI eaEjer [ "2015";
         nError = 0;
         |DBASE aPathPatrones;
         aPathPatrones = aPathPatrones + "hacienda/";

         aPatron     = "z" + eaEjer + eaModelos + ".tgz";
         aEjecutable = "p" + eaModelos + eaEjer;

         eaFOrigen   = aPathPatrones + aPatron;
         eaFDestino  = eaPathLanza    + aPatron;
         |HAZ CopiaFicheroPtl;

         |XABRE "EC", eaFDestino, nHandle;
         |SI FSalida < 0;
             aAlfa1 =  "      No existe el ejecutable " + aPatron + " pongase en contacto con su distribuidor";
             |MENAV aAlfa1;
             nError = 1;
             |ACABA;
         |FINSI;

         |SI nCopiado = 1;
             |RDESCOMPRIME eaFDestino;

             eaFDestino = (eaFDestino - ".tgz") + ".tar";
             |RDETAR eaFDestino, eaPathLanza;

             |RFBORRA eaFDestino;

             |PTEC 802;  |PAUSA;  |PULSATECLA;
         |FINSI;

         |SI eaModelos ! "390";
             |HAZ CargaListaErrores;
         |FINSI;
     |FINSI;

     aFichero = "dsmow190" + Usuario;  |NOME_DAT #dsmow190#aAlfa#;
     |ABRE #dsmow190;  |CIERRA #dsmow190;  |DELINDEX #dsmow190;

     |ABRET #dsmow190;
|FPRC;

|PROCESO TraeTgzMPF;
     nError = 0;
     |DBASE aPathPatrones;
     aPathPatrones = aPathPatrones + "hacienda/";

     aPatron     = "z" + eaEjer + "mpf.tgz";

     eaFOrigen   = aPathPatrones + aPatron;
     eaFDestino  = eaPathLanza   + aPatron;
     |HAZ CopiaFicheroPtl;

     |XABRE "EC", eaFDestino, nHandle;
     |SI FSalida < 0;
         aAlfa1 =  "      No existe el ejecutable " + aPatron + " pongase en contacto con su distribuidor";
         |MENAV aAlfa1;
         nError = 1;
         |ACABA;
     |FINSI;

     |SI nCopiado = 1;
         |RDESCOMPRIME eaFDestino;

         eaFDestino = (eaFDestino - ".tgz") + ".tar";
         |RDETAR eaFDestino, eaPathLanza;

         |RFBORRA eaFDestino;

         |PTEC 802;  |PAUSA;  |PULSATECLA;
     |FINSI;

     aFichero = "dsmow190" + Usuario;  |NOME_DAT #dsmow190#aAlfa#;
     |ABRE #dsmow190;  |CIERRA #dsmow190;  |DELINDEX #dsmow190;

     |ABRET #dsmow190;
|FPRC;

|PROCESO SacaError;
     aAlfa = aError % 102;  nErrorCC = aAlfa;
     aAlfa = aError % 302;  nErrorEE = aAlfa;

     IaCodEE = aCodEE1 <-;
     IaCodEE = IaCodEE + (nErrorEE - 1);

     |SI aTipo = "1";
         IaCodDCC = aCodDCC1 <-;
         IaCodDCC = IaCodDCC + (nErrorCC - 1);

         aAlfa = aError + " " + aCodEE + " " + aCodDCC;
     |FINSI;

     |SI aTipo = "2";
         IaCodPCC = aCodPCC1 <-;
         IaCodPCC = IaCodPCC + (nErrorCC - 1);

         aAlfa = aError + " " + aCodEE + " " + aCodPCC;
     |FINSI;

     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO LeeErrores;
     enErrorPortal = 1;
     aRegistro = aCadena1 % 108;
     aTipo     = aCadena1 % 901;

     |SI aTipo = "1";
         aDescri = "Registro declarante";
         aNif    = aCadena1 % 1709;
         aNombre = aCadena1 % 2640;
     |FINSI;

     |SI aTipo = "2";
         aDescri = "Registro perceptor";
         aNif    = aCadena1 % 2609;
         aNombre = aCadena1 % 4440;
     |FINSI;

     aAlfa = "Registro: " + aRegistro + " " + aDescri + " NIF: " + aNif + " NOMBRE: " + aNombre + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |SI nReg = 4;
         aLong    = aCadena3 % 0;
         nLong    = aLong;
         aAlfa    = aCadena3;
         aCadena3 = "";
         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPos      = (nCaracter * 100) + 1;
               aCaracter = aAlfa % nPos;
               |SI aCaracter = "0"; |O aCaracter = "1"; |O aCaracter = "2";
                |O aCaracter = "3"; |O aCaracter = "4"; |O aCaracter = "5";
                |O aCaracter = "6"; |O aCaracter = "7"; |O aCaracter = "8";
                |O aCaracter = "9";
                   aCadena3 = aCadena3 + aCaracter;
               |SINO;
                   aCadena3 = "";
               |FINSI;
         |SIGUE;

         |PARA nPos = 1;  |SI nPos [ 250;  |HACIENDO nPos = nPos + 4;
               nPosi  = (nPos * 100) + 4;
               aError = aCadena3 % nPosi;
               |SI aError = "0000";
                   |SAL;
               |FINSI;

               |HAZ SacaError;
         |SIGUE;

         |PARA nPos = 1;  |SI nPos [ 250;  |HACIENDO nPos = nPos + 4;
               nPosi  = (nPos * 100) + 4;
               aError = aCadena4 % nPosi;
               |SI aError = "0000";
                   |SAL;
               |FINSI;

               |HAZ SacaError;
         |SIGUE;
     |FINSI;

     |SI nReg = 3;
         aLong    = aCadena3 % 0;
         nLong    = aLong;
         aAlfa    = aCadena3;
         aCadena3 = "";
         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPos      = (nCaracter * 100) + 1;
               aCaracter = aAlfa % nPos;
               |SI aCaracter = "0"; |O aCaracter = "1"; |O aCaracter = "2";
                |O aCaracter = "3"; |O aCaracter = "4"; |O aCaracter = "5";
                |O aCaracter = "6"; |O aCaracter = "7"; |O aCaracter = "8";
                |O aCaracter = "9";
                   aCadena3 = aCadena3 + aCaracter;
               |SINO;
                   aCadena3 = "";
               |FINSI;
         |SIGUE;

         |PARA nPos = 1;  |SI nPos [ 250;  |HACIENDO nPos = nPos + 4;
               nPosi  = (nPos * 100) + 4;
               aError = aCadena3 % nPosi;
               |SI aError = "0000";
                   |SAL;
               |FINSI;

               |HAZ SacaError;
         |SIGUE;
     |FINSI;

     |SI nReg = 2;
         aLong    = aCadena2 % 0;
         nLong    = aLong;
         aAlfa    = aCadena2;
         aCadena3 = "";
         |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
               nPos      = (nCaracter * 100) + 1;
               aCaracter = aAlfa % nPos;
               |SI aCaracter = "0"; |O aCaracter = "1"; |O aCaracter = "2";
                |O aCaracter = "3"; |O aCaracter = "4"; |O aCaracter = "5";
                |O aCaracter = "6"; |O aCaracter = "7"; |O aCaracter = "8";
                |O aCaracter = "9";
                   aCadena2 = aCadena2 + aCaracter;
               |SINO;
                   aCadena2 = "";
               |FINSI;
         |SIGUE;

         |PARA nPos = 1;  |SI nPos [ 250;  |HACIENDO nPos = nPos + 4;
               nPosi  = (nPos * 100) + 4;
               aError = aCadena2 % nPosi;
               |SI aError = "0000";
                   |SAL;
               |FINSI;

               |HAZ SacaError;
         |SIGUE;
     |FINSI;

     aAlfa = &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO LeeFicheroSalida;
     enErrorPortal = 0;

     aAbre = eaPathLanza + eaFicheroSalid;
     |XABRE "C", aAbre, nHandleError;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aAbre = eaPathLanza + eaFicheroError;
     |XABRE "CBW", aAbre, nHandle;

     |SI eaModelos = "180";
         nReg = 3;
         |SI #dsmoy000#6 < 2014; nReg = 2; |FINSI;
     |FINSI;

     |SI eaModelos = "184";  nReg = 2;  |FINSI;
     |SI eaModelos = "190";  nReg = 3;  |FINSI;
     |SI eaModelos = "193";  nReg = 3;  |FINSI;
     |SI eaModelos = "296";  nReg = 4;  |FINSI;
     |SI eaModelos = "340";  nReg = 4;  |FINSI;
     |SI eaModelos = "347";  nReg = 4;  |FINSI;
     |SI eaModelos = "349";  nReg = 3;  |FINSI;

     aCadena1 = "";
     aCadena2 = "";
     aCadena3 = "";
     aCadena4 = "";
     nConta   = 0;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandleError, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          nConta = nConta + 1;

          |SI nReg = 4;
              |SI nConta = 1;  aCadena1 = aAlfa;  |FINSI;
              |SI nConta = 2;  aCadena2 = aAlfa;  |FINSI;
              |SI nConta = 3;  aCadena3 = aAlfa;  |FINSI;

              |SI nConta = 4;
                  aCadena4 = aAlfa;

                  |HAZ LeeErrores;

                  aCadena1 = "";
                  aCadena2 = "";
                  aCadena3 = "";
                  aCadena4 = "";
                  nConta   = 0;
              |FINSI;
          |FINSI;

          |SI nReg = 3;
              |SI nConta = 1;  aCadena1 = aAlfa;  |FINSI;
              |SI nConta = 2;  aCadena2 = aAlfa;  |FINSI;

              |SI nConta = 3;
                  aCadena3 = aAlfa;

                  |HAZ LeeErrores;

                  aCadena1 = "";
                  aCadena2 = "";
                  aCadena3 = "";
                  nConta   = 0;
              |FINSI;
          |FINSI;

          |SI nReg = 2;
              |SI nConta = 1;  aCadena1 = aAlfa;  |FINSI;

              |SI nConta = 2;
                  aCadena2 = aAlfa;

                  |HAZ LeeErrores;

                  aCadena1 = "";
                  aCadena2 = "";
                  nConta   = 0;
              |FINSI;
          |FINSI;
     |SIGUE;

     |XCIERRA nHandleError;
     |XCIERRA nHandle;

     #dsmow190#0 = eaFicheroError;
     #dsmow190#1 = enEmpresa;
     #dsmow190#2 = eaNomEmpresa;

     |SI enErrorPortal = 1;
         |GRABA 020#dsmow190.n;
         |LIBERA #dsmow190;
     |SINO;
         aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;
     |FINSI;
|FPRC;

|PROCESO LanzaCobol;
     enErrorPortal = 0;

     |SI enSinActividad = 0;
         aAlfa = eaPathLanza + eaFicheroPlano;  |RFBORRA aAlfa;
         aAlfa = eaPathLanza + eaFicheroImpre;  |RFBORRA aAlfa;
         aAlfa = eaPathLanza + eaFicheroSalid;  |RFBORRA aAlfa;
         aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathLanza + eaFicheroPlano;
         |HAZ CopiaFicheroPtl;

         aAbre = eaPathLanza + "imprime.bat";
         |XABRE "CBW", aAbre, nHandle1;

         aAlfa = "CD " + eaPathLanza + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         aAlfa = "echo off" + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         aAlfa = "SET CINTA=" + eaPathLanza + eaFicheroPlano + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         aAlfa = "SET IMPRE=" + eaPathLanza + eaFicheroImpre + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         aAlfa = "SET SALIDA=" + eaPathLanza + eaFicheroSalid + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         aAlfa = "wait " + aEjecutable +  &13 + &10;
         |XGRABA nHandle1, aAlfa;

         |XCIERRA nHandle1;

         |RSYSTEM aAbre;

         |HAZ LeeFicheroSalida;
     |FINSI;

     |SI enErrorPortal = 0;
         |HAZ MandaAInternet;
     |FINSI;

     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
     aAlfa = eaPathLanza   + eaFicheroImpre;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza   + eaFicheroSalid;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza   + "imprime.bat";   |RFBORRA aAlfa;
|FPRC;

|PROCESO TraeDsaeatresp;
     aPathLocal  = eaPathLanza;

     |DBASE aPathPlugins;  |QBT aPathPlugins;
     aPathPlugins = aPathPlugins + "plugins";
     |MKDIR aPathPlugins;
     eaFOrigen      = aPathPlugins   + "/dsaeatresp.exe";
     eaFDestino     = aPathLocal + "dsaeatresp.exe";
     |HAZ CopiaFicheroPtl;
|FPRC;

|PROCESO PortalBor2017;
     aFicPortal = "Portal" + eaModelos + ".html";
     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbre, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     eaAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = "<head>";
     |HAZ GrabaPortal;

     eaAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     function carga()";
     |HAZ GrabaPortal;

     eaAlfa = "     {";
     |HAZ GrabaPortal;

     eaAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = "     }";
     |HAZ GrabaPortal;

     eaAlfa = "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + aDIR + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aHID + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIC" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroPlano;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "RUT" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + eaEjer + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + eaModelos + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;
     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "</form>";   |HAZ GrabaPortal;
     eaAlfa = "</body>";   |HAZ GrabaPortal;
     eaAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = eaPathEmision + aFicPortal;
     eaFDestino = eaPathLanza   + aFicPortal;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         aAlfa = eaPathExplorador + " " + eaFDestino;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaFDestino + &34;
     |FINSI;

     |RSYSTEM aAlfa;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
|FPRC;

|PROCESO PortalBor2018;
     aFicPortal = "Portal" + eaModelos + ".html";
     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbre, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 ";
     eaAlfa = eaAlfa + "Transitional//EN" + &34 + " ";
     eaAlfa = eaAlfa + &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = &9 + "<head>";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "<meta http-equiv=" + &34 + "Content-Type" + &34;
     eaAlfa = eaAlfa + " content=" + &34 + "text/html; charset=iso-8859-1";
     eaAlfa = eaAlfa + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = &9 + "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = &9 + "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "function carga()";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "{";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "}";
     |HAZ GrabaPortal;

     eaAlfa = &9 + "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = &9 + "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "<form method=" + &34 + "POST" + &34 + " action=" + &34;
     eaAlfa = eaAlfa + aDIR + &34 + " name=" + &34 + "form1" + &34;
     eaAlfa = eaAlfa + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "LEV" + &34 + " value=" + &34 + "000000000000";
     eaAlfa = eaAlfa + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "FIC" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroPlano;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "RUT" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "EJF" + &34 + " value=" + &34 + eaEjer + &34;
     eaAlfa = eaAlfa + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 3) + "<input type=" + &34 + "hidden" + &34 + " name=" + &34;
     eaAlfa = eaAlfa + "MOD" + &34 + " value=" + &34 + eaModelos + &34;
     eaAlfa = eaAlfa + " />";
     |HAZ GrabaPortal;

     eaAlfa = (&9 * 2) + "</form>";   |HAZ GrabaPortal;
     eaAlfa = &9 + "</body>";         |HAZ GrabaPortal;
     eaAlfa = "</html>";              |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = eaPathEmision + aFicPortal;
     eaFDestino = eaPathLanza   + aFicPortal;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         aAlfa = eaPathExplorador + " " + eaFDestino;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaFDestino + &34;
     |FINSI;

     |RSYSTEM aAlfa;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
|FPRC;

|PROCESO PortalBorrador;
     aHID = "INV2" + eaModelos + "A";

     |SI eaModelos = "180";  |O eaModelos = "184";  |O eaModelos = "190";
      |O eaModelos = "193";  |O eaModelos = "296";  |O eaModelos = "347";
         |SI #dsmoy000#6 = 2013;
             aHID = "INV3" + eaModelos + "A";
         |FINSI;
     |FINSI;

     aDIR = "https://www2.agenciatributaria.gob.es/l/zi22zilk0022";

     |SI #dsmoy000#6 = 2016;
         |SI eaModelos = "180";
             aDIR = "https://www2.agenciatributaria.gob.es/wlpl/OVCT-IPDF/ovweb/vistaprevia";
             aHID = "IE6180A";
         |FINSI;

         |SI eaModelos = "193";
             aDIR = "https://www2.agenciatributaria.gob.es/wlpl/OVCT-IPDF/ovweb/vistaprevia";
             aHID = "IE6193A";
         |FINSI;

         |SI eaModelos = "184";  aHID = "INV6184A";  |FINSI;
         |SI eaModelos = "190";  aHID = "INV6190A";  |FINSI;
         |SI eaModelos = "347";  aHID = "INV6347A";  |FINSI;
     |FINSI;

     |SI #dsmoy000#6 = 2017;
         aDIR = "https://www2.agenciatributaria.gob.es/wlpl/OVCT-IPDF/ovweb/vistaprevia";
         aHID = "IE7" + eaModelos + "A";
     |FINSI;

     aPRG = "";

     |SI #dsmoy000#6 ] 2018;
         aDIR = "https://www6.aeat.es/wlpl/PFTW-PICW/ServVali";

         |SI eaModelos = "349";  aHID = "INV8349A";  |FINSI;

         |SI eaModelos = "180";  |O eaModelos = "184";  |O eaModelos = "190";
          |O eaModelos = "193";  |O eaModelos = "296";  |O eaModelos = "347";
             |HAZ PortalBor2018;

             |ACABA;
         |FINSI;
     |FINSI;

     |HAZ PortalBor2017;
|FPRC;

|PROCESO Validacion;
     enErrorPortal = 0;
     |HAZ TraeDsaeatresp;

     aAlfa = eaPathLanza + aFicError;  |RFBORRA aAlfa;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     aAbre = eaPathLanza + "ejecutaweb.bat";
     |XABRE "WBC", aAbre, nHandle;

     aAlfa = eaPathLanza + "dsaeatresp " + eaPathLanza + aFicPortal + " " + eaPathLanza + aFicError;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     aAbre = eaPathLanza + aFicError;
     |XABRE "UC", aAbre, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aAlfa1 = aAlfa < "";  |QBF aAlfa1;
          aAlfa2 = aAlfa1 - "<title>";
          |SI FSalida ! 0;
              aAlfa2 = aAlfa1 - "error";
              |SI FSalida ! 0;  enErrorPortal = 1;  |SAL;  |FINSI;

              aAlfa2 = aAlfa1 - "errónea";
              |SI FSalida ! 0;  enErrorPortal = 1;  |SAL;  |FINSI;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |SI enErrorPortal = 1;
         |CONFI "0000SHay errores. Quiere consultarlos";
         |SI FSalida = 0;
             eaForzExplorador = "N";
             |HAZ Explorador;

             |SI eaPathExplorador ! "";
                 aAlfa = eaPathExplorador + " " + eaPathLanza + aFicError;
                 aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
             |SINO;
                 aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaPathLanza + aFicError + &34;
             |FINSI;

             |RSYSTEM aAlfa;
         |FINSI;
     |FINSI;

||     aAlfa = eaPathLanza + aFicError;  |RFBORRA aAlfa;
|FPRC;

|PROCESO PortalPDFPeriodicos;
     aDIR    = "https://www2.agenciatributaria.gob.es/es13/l/zi21zilk0021";
     aHID    = "IE5" + #dsmoy000#0 + "0B";
     aNDC    = eaNIF;    |QBF aNDC;
     aIDI    = "ES";
     aEJF    = #dsmoy000#6;
     aMOD    = #dsmoy000#0;
     aPRG    = "PTLINK5V";

                         aTIA = "N";
     |SI enImprtMd > 0;  aTIA = "I";  |FINSI;

     |PUSHV 0501 2380;
     |BLANCO 0501 2380;
     |CUADRO 0501 2380;

     eaAlfa = "Conectandose a la pagina de la aeat";
     |PINTA 1210, eaAlfa;

     aFicPortal = "Portal" + #dsmoy000#0 + ".html";

     aAbrePortal = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbrePortal, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     eaAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = "<head>";
     |HAZ GrabaPortal;

     eaAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     function carga()";
     |HAZ GrabaPortal;

     eaAlfa = "     {";
     |HAZ GrabaPortal;

     eaAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = "     }";
     |HAZ GrabaPortal;

     eaAlfa = "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + aDIR + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aHID + &34 + " />";
     |HAZ GrabaPortal;


     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "TIA" + &34 + " value=" + &34 + aTIA + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NDC" + &34 + " value=" + &34 + aNDC + &34 + " />";
     |HAZ GrabaPortal;

     aTipo = "NRC";  |HAZ VarVacia_Plb;
     aTipo = "ING";  |HAZ VarVacia_Plb;
     aTipo = "NRR";  |HAZ VarVacia_Plb;
     aTipo = "ICO";  |HAZ VarVacia_Plb;
     aTipo = "NR1";  |HAZ VarVacia_Plb;
     aTipo = "IN1";  |HAZ VarVacia_Plb;
     aTipo = "NR2";  |HAZ VarVacia_Plb;
     aTipo = "IN2";  |HAZ VarVacia_Plb;
     aTipo = "NR3";  |HAZ VarVacia_Plb;
     aTipo = "IN3";  |HAZ VarVacia_Plb;
     aTipo = "NR4";  |HAZ VarVacia_Plb;
     aTipo = "IN4";  |HAZ VarVacia_Plb;
     aTipo = "NR5";  |HAZ VarVacia_Plb;
     aTipo = "IN5";  |HAZ VarVacia_Plb;
     aTipo = "NR6";  |HAZ VarVacia_Plb;
     aTipo = "IN6";  |HAZ VarVacia_Plb;
     aTipo = "NR7";  |HAZ VarVacia_Plb;
     aTipo = "IN7";  |HAZ VarVacia_Plb;
     aTipo = "CMN";  |HAZ VarVacia_Plb;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LOT" + &34 + " value=" + &34 + "0" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + aIDI + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LEV" + &34 + " value=" + &34 + "000000000000" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;

     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroPlano;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PUN" + &34 + " value=" + &34 + "00000000" + &34 + " />";
     |HAZ GrabaPortal;

     aTipo = "TXT";  |HAZ VarVacia_Plb;
     aTipo = "FIR";  |HAZ VarVacia_Plb;

     aTipo = "F";

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + aTipo + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + aEJF + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + aMOD + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "</form>";   |HAZ GrabaPortal;
     eaAlfa = "</body>";   |HAZ GrabaPortal;
     eaAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = aAbrePortal;
     eaFDestino = eaPathLanza + aFicPortal;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         eaAlfa = eaPathExplorador + " " + eaFDestino;
         eaAlfa  = "cmd " + &34 + "/c START /WAIT " + eaAlfa + &34;
     |SINO;
         eaAlfa  = "cmd " + &34 + "/c START /WAIT " + eaFDestino + &34;
     |FINSI;

     |RSYSTEM eaAlfa;

     |FBORRA eaFOrigen;

||     |RFBORRA eaFDestino;

     |POPV;
|FPRC;

|PROCESO PortalPDF;
     |SI eaModelos = "180";  |O eaModelos = "184";  |O eaModelos = "190";
      |O eaModelos = "193";  |O eaModelos = "296";
         |SI eaEjer ] "2013";
             |MENAV "0000Hacienda ha eliminado esta opcion para las declaraciones informativas a partir del 2013.";
             |ACABA;
         |FINSI;
     |FINSI;

     aHID = "INB2" + eaModelos + "A";
     aPRG = "EWLINKXD";
     aDIR = "https://www2.agenciatributaria.gob.es/es13/l/zi21zilk0021";

     aFicPortal = "Portal" + eaModelos + ".html";
     aFicError  = "Error" + eaModelos + ".html";
     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbre, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     eaAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = "<head>";
     |HAZ GrabaPortal;

     eaAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     function carga()";
     |HAZ GrabaPortal;

     eaAlfa = "     {";
     |HAZ GrabaPortal;

     eaAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = "     }";
     |HAZ GrabaPortal;

     eaAlfa = "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + aDIR + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aHID + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + eaModelos + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + eaEjer + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LEV" + &34 + " value=" + &34 + "000000000000" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroPlano;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "CMN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;
     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "</form>";   |HAZ GrabaPortal;
     eaAlfa = "</body>";   |HAZ GrabaPortal;
     eaAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = eaPathEmision + aFicPortal;
     eaFDestino = eaPathLanza   + aFicPortal;
     |HAZ CopiaFicheroPtl;

     |HAZ Validacion;
     |SI  enErrorPortal = 1;
          aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
          aAlfa = eaPathLanza   + aFicPortal;      |RFBORRA aAlfa;
          aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;

          |ACABA;
     |FINSI;

     |SI eaOpcion = "3";
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFicheroPtl;

         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
         |ACABA;
     |FINSI;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         aAlfa = eaPathExplorador + " " + eaPathLanza + aFicPortal;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaPathLanza + aFicPortal + &34;
     |FINSI;

     |RSYSTEM aAlfa;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;

||     aAlfa = eaPathLanza   + aFicPortal;      |RFBORRA aAlfa;
|FPRC;

|PROCESO PortalBorrador390;
     aValidar  = "NO";
     aEnsobrar = "SI";
     |HAZ PasaAPlano;

     |SI enErrorPortal = 1;
         aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;

         aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
         aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

         |ACABA;
     |FINSI;

     aDIR = "https://www2.agenciatributaria.gob.es/es13/l/zi22zilk0022";

     |SI eaEjer = "2012";
         aHID = "INF2" + eaModelos + "A";
     |FINSI;

     |SI eaEjer = "2013";
         aHID = "INF3" + eaModelos + "A";
     |FINSI;

     |SI #dsmoy000#6 = 2014;
         aHID = "INF4" + #dsmoy000#0 + "A";
     |FINSI;

     aPRG = "";

     aFicPortal = "Portal" + eaModelos + ".html";
     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbre, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     eaAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = "<head>";
     |HAZ GrabaPortal;

     eaAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     function carga()";
     |HAZ GrabaPortal;

     eaAlfa = "     {";
     |HAZ GrabaPortal;

     eaAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = "     }";
     |HAZ GrabaPortal;

     eaAlfa = "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + aDIR + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aHID + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIC" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroSalid;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "RUT" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + eaEjer + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + eaModelos + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;
     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "</form>";   |HAZ GrabaPortal;
     eaAlfa = "</body>";   |HAZ GrabaPortal;
     eaAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = eaPathEmision + aFicPortal;
     eaFDestino = eaPathLanza   + aFicPortal;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         aAlfa = eaPathExplorador + " " + eaPathLanza + aFicPortal;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaPathLanza + aFicPortal + &34;
     |FINSI;

     |RSYSTEM aAlfa;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroSalid;  |FBORRA aAlfa;

||     aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
||     aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;
|FPRC;

|PROCESO PortalPDF390;
     aValidar  = "SI";
     aEnsobrar = "SI";
     |HAZ PasaAPlano;

     |SI enErrorPortal = 1;
         aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;

         aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
         aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

         |ACABA;
     |FINSI;

     aDIR = "https://www2.agenciatributaria.gob.es/es13/l/zi21zilk0021";

     |SI eaEjer = "2012";
         aHID = "INF2" + eaModelos + "A";
         aPRG = "EWLINKXG";
     |FINSI;

     |SI eaEjer = "2013";
         aHID = "INF3" + eaModelos + "A";
         aPRG = "PTLINK1N";
     |FINSI;

     |SI #dsmoy000#6 = 2014;
         aHID = "INF4" + #dsmoy000#0 + "A";
         aPRG = "PTLINK5N";
     |FINSI;

     aFicPortal = "Portal" + eaModelos + ".html";
     aFicError  = "Error" + eaModelos + ".html";
     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "WB", aAbre, enHandlePortal;

     eaAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     eaAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<html>";
     |HAZ GrabaPortal;

     eaAlfa = "<head>";
     |HAZ GrabaPortal;

     eaAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     eaAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "</head>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     function carga()";
     |HAZ GrabaPortal;

     eaAlfa = "     {";
     |HAZ GrabaPortal;

     eaAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     eaAlfa = "     }";
     |HAZ GrabaPortal;

     eaAlfa = "</script>";
     |HAZ GrabaPortal;

     eaAlfa = "";
     |HAZ GrabaPortal;

     eaAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + aDIR + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aHID + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LEV" + &34 + " value=" + &34 + "000000000000" + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA enHandlePortal;

     aDestino   = eaPathEmision + aFicPortal;
     aOrigen    = eaPathEmision + eaFicheroSalid;
     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre      = eaPathEmision + aFicPortal;
     |XABRE "AB", aAbre, enHandlePortal;

     eaAlfa = &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "ANA" + &34 + " value=" + &34 + (eaNomEmpresa % 103) + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "XFI" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + eaModelos + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + aPRG + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + eaEjer + &34 + " />";
     |HAZ GrabaPortal;

     eaAlfa = "";  |HAZ GrabaPortal;
     eaAlfa = "";  |HAZ GrabaPortal;

     eaAlfa = "</form>";   |HAZ GrabaPortal;
     eaAlfa = "</body>";   |HAZ GrabaPortal;
     eaAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     eaFOrigen  = eaPathEmision + aFicPortal;
     eaFDestino = eaPathLanza   + aFicPortal;
     |HAZ CopiaFicheroPtl;

     |HAZ Validacion;
     |SI enErrorPortal = 1;
         aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroSalid;  |FBORRA aAlfa;

         aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
         aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

         |ACABA;
     |FINSI;

     eaForzExplorador = "N";
     |HAZ Explorador;

     |SI eaPathExplorador ! "";
         aAlfa = eaPathExplorador + " " + eaPathLanza + aFicPortal;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + eaPathLanza + aFicPortal + &34;
     |FINSI;

     |RSYSTEM aAlfa;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroSalid;  |FBORRA aAlfa;

||     aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
||     aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

     eaJusti = "";
     |HAZ GrabaImpreso;
|FPRC;

|PROCESO PortalInternet390;
     aValidar  = "SI";
     aEnsobrar = "SI";
     |HAZ PasaAPlano;

     |SI enErrorPortal = 1;
         aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;

         aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
         aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

         |ACABA;
     |FINSI;

     |SI enPresentar = 0;
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFicheroPtl;

         aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
         aAlfa = eaPathEmision + eaFicheroSalid;  |FBORRA aAlfa;

         aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
         aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

         eaJusti = "";  |HAZ GrabaImpreso;

         |ACABA;
     |FINSI;

     |DBASE aAlfa;  |QBT aAlfa;
     eaFOrigen  = aAlfa + "hacienda/wait.exe";
     eaFDestino = eaPathInternet + "wait.exe";
     |HAZ CopiaFicheroPtl;

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathInternet + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     |SI eaEjer [ "2013";
         aAlfa = eaPathLanza + "wait ";
         aAlfa = aAlfa + eaPathExplorador + " " + &34 + "https://www2.agenciatributaria.gob.es/es13/h/servurlp.html";
         aAlfa = aAlfa + "?WEB=INTERNET&PRG=390&EJE=" + eaEjer + "&VER=1.00&URL=PIR&IDI=E&EXT=?FIC=";
         aAlfa = aAlfa + eaPathInternet + eaFicheroPlano + &34;
     |FINSI;

     |SI eaEjer ] "2014";
         aAlfa = eaPathLanza + "wait ";
         aAlfa = aAlfa + eaPathExplorador + " " + &34;
         aAlfa = aAlfa + "https://www1.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/ov/servurlp.html";
         aAlfa = aAlfa + "?WEB=INTERNET&PRG=390&EJE=" + eaEjer + "&VER=1.00&URL=PIR&IDI=E&EXT=?FIC=";
         aAlfa = aAlfa + eaPathInternet + eaFicheroPlano + &34;
     |FINSI;

     eaAlfa  = aAlfa;
     |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathEmision + aFicPortal;      |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroPlano;  |FBORRA aAlfa;
     aAlfa = eaPathEmision + eaFicheroSalid;  |FBORRA aAlfa;

     aAlfa = eaPathLanza   + aFicPortal;       |RFBORRA aAlfa;
     aAlfa = eaPathLanza   + eaFicheroSalid;   |RFBORRA aAlfa;

     eaJusti = "";
     |HAZ GrabaImpreso;
|FPRC;

|PROCESO PreguntaPresentacion;
     |SI eaModelos ! "180";  |Y eaModelos ! "184";  |Y eaModelos ! "190";
      |Y eaModelos ! "193";  |Y eaModelos ! "296";  |Y eaModelos ! "347";
      |Y eaModelos ! "349";  |Y eaModelos ! "340";  |Y eaModelos ! "390";
         |ACABA;
     |FINSI;

     enPresentar = 0;
     |CONFI "0000SPresentamos la declaracion en el momento de crearlas";
     |SI FSalida = 0;
         enPresentar = 1;
     |FINSI;
|FPRC;

|PROCESO PresentaPortal;
     |SI eaModelos ! "390";
         |SI eaOpcion = "1";  |HAZ PortalBorrador;  |FINSI;
         |SI eaOpcion = "2";  |HAZ PortalPDF;       |FINSI;
         |SI eaOpcion = "3";
             |SI #dsmoy000#6 [ 2014;
                 |HAZ LanzaCobol;
             |SINO;
                 |HAZ MandaAInternet;

                 eaJusti = "";
                 |HAZ GrabaImpreso;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI eaModelos = "390";
         |SI eaOpcion = "1";  |HAZ PortalBorrador390;  |FINSI;
         |SI eaOpcion = "2";  |HAZ PortalPDF390;       |FINSI;
         |SI eaOpcion = "3";  |HAZ PortalInternet390;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO BotonF2;
     |PTEC 824;
|FPRC;

|PROCESO BotonF3;
     |PTEC 825;
|FPRC;

|PROCESO BotonF4;
     |PTEC 826;
|FPRC;

|PROCESO BotonF5;
     |PTEC 827;
|FPRC;

|PROCESO BotonEsc;
     |PTEC 806;
|FPRC;

|PROCESO Botones_2012;
     |SI eaModelos = "390";
         |HAZ TraeTgzCobol;
     |FINSI;

     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Borrador sin validacion ", 0513, 0754, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Formato PDF", 0913, 1154, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Presentacion Telematica ", 1313, 1554, BotonF4;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F5> Explorador predeterminado", 2113, 2354, BotonF5;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton5 = FSalida;

     aF2      = &255 + "824";
     aF3      = &255 + "825";
     aF4      = &255 + "826";
     aF5      = &255 + "827";
     aEsc     = &255 + "806";
     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  eaOpcion = "1"; |SAL;  |FINSI;
         |SI aTecla = aF3;  eaOpcion = "2"; |SAL;  |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;

         |SI aTecla = aF4;
             enPresentar = 0;
             |HAZ PreguntaPresentacion;

             |SI eaModelos = "180";  |O eaModelos = "190";
              |O eaModelos = "193";  |O eaModelos = "296";
              |O eaModelos = "184";  |O eaModelos = "347";
                 |HAZ TraeTgzCobol;
                 |SI nError = 1;
                     eaOpcion = "";
                 |FINSI;

                 |SI nError = 0;
                     eaOpcion = "3";
                     |SAL;
                 |FINSI;
             |FINSI;

             |SI eaModelos = "390";
                 eaOpcion   = "3";

                 |SAL;
             |FINSI;

             |SI eaOpcion = "0";
                 |MENAV "0000En construccion, en breve activaremos la opcion";
             |FINSI;
         |FINSI;

         |SI aTecla = aF5;
             eaForzExplorador = "S";
             |HAZ Explorador;
         |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;

     |PULSATECLA;
|FPRC;

|PROCESO Botones_2015;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Borrador sin validacion ", 0513, 0754, BotonF2;
     nBtnF2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Presentacion Telematica ", 0913, 1154, BotonF3;
     nBtnF3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F5> Explorador predeterminado", 2113, 2354, BotonF5;
     nBtnF5 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBtnEs = FSalida;

     aF2      = &255 + "824";
     aF3      = &255 + "825";
     aF5      = &255 + "827";
     aEsc     = &255 + "806";
     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  eaOpcion = "1"; |SAL;  |FINSI;

         |SI aTecla = aF3;
             enPresentar = 0;
             |HAZ PreguntaPresentacion;

             eaOpcion = "3";
             |SAL;
         |FINSI;

         |SI aTecla = aEsc;                 |SAL;  |FINSI;

         |SI aTecla = aF5;
             eaForzExplorador = "S";
             |HAZ Explorador;
         |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBtnF2;
     |FIN_CONTROL_WINDOWS nBtnF3;
     |FIN_CONTROL_WINDOWS nBtnF5;
     |FIN_CONTROL_WINDOWS nBtnEs;

     |PULSATECLA;
|FPRC;

|PROCESO LeeUnidad;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     eaUnidad = aContiene1 % 102;
|FPRC;

|PROCESO Tipo7C0; |TIPO 7;
     |SI eaModelos = "390";
         |MENSA "0000Editar <F2> Errores; <F3> XML";
         |ACABA;
     |FINSI;

     |SI eaModelos = "110";  |O eaModelos = "115";  |O eaModelos = "123";
      |O eaModelos = "130";  |O eaModelos = "131";  |O eaModelos = "303";
      |O eaModelos = "310";
         |MENSA "0000Editar <F2> Errores; <F3> TXT";
         |ACABA;
     |FINSI;

     |MENSA "0000Editar <F2> Errores";
|FPRC;

|PROCESO Tipo11w190;  |TIPO 11;
     |SI FSalida = 10;
         aAlfa = "START " + eaPathLanza + #dsmow190#0;  |QBF aAlfa;
         |RSYSTEM aAlfa;
     |FINSI;

     |SI FSalida = 11;
         |SI eaModelos = 390;
             aAlfa = "390" + (#dsmow190#0 % 405) + ".xml";
         |SINO;
             |SI eaModelos = "110";
                 aAlfa = "111" + (#dsmow190#0 % 405) + ".txt";
             |SINO;
                 aAlfa = eaModelos + (#dsmow190#0 % 405) + ".txt";
             |FINSI;
         |FINSI;
         aAlfa = "START " + eaPathLanza + aAlfa;
         |RSYSTEM aAlfa;
     |FINSI;
|FPRC;

|PROCESO Baja190;
     #dsmow190#0 = "";
|FPRC;

|PROCESO Alta190;
     #dsmow190#0 = "z" * 12;
|FPRC;

|PROCESO SacaErrorPtl;
     |LEE 000#dsmow190.p;
     |SI FSalida = 0;
         |PUSHV 0501 2380;
         |ENTLINEAL #1#dsmow190, -1, 4, 22, 1, Baja190, Alta190;
         |POPV;
     |FINSI;

     |CIERRAT #dsmow190;
     |DELINDEX #dsmow190;

     |SI eaModelos = "390";
         aFichero    = eaPathLanza + "*.xml";  |QBT aFichero;
         |R_PDIR aFichero;
         |PARA; |SI; |HACIENDO;
              |SI FSalida ! 0; |SAL; |FINSI;
              |RFBORRA aFichero;

              |R_SDIR aFichero;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO BotonesMPF;
     |HAZ TraeTgzMPF;

     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision oficial (directo por impresora predeterminada) ", 0513, 0654, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Emision oficial (Vista previa por el acrobat) ", 0813, 0954, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Presentacion Telematica", 1113, 1254, BotonF4;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F5> Directorio Acrobat  ", 1413, 1554, BotonF5;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton5 = FSalida;

     aF2  = &255 + "824";
     aF3  = &255 + "825";
     aF4  = &255 + "826";
     aF5  = &255 + "827";
     aF6  = &255 + "828";
     aEsc = &255 + "806";

     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  eaOpcion = "1"; |SAL;  |FINSI;
         |SI aTecla = aF3;  eaOpcion = "2"; |SAL;  |FINSI;
         |SI aTecla = aF4;  eaOpcion = "3"; |SAL;  |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;

         |SI aTecla = aF5;
             |HAZ Acrobat;
         |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;

     |SI eaOpcion = "1";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "2";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "3";  enTecla = 3;  |FINSI;

     |SI enTecla = 1;
         eaTercera = "N";
         |CONFI "0000NQuiere tercera copia";
         |SI FSalida = 0;  eaTercera = "S";  |FINSI;

         |HAZ LocalizaAcrobat;
         |SI enError ! 0;
             |MENAV "0000Por favor introduzca el directorio acrobat de su PC";
             enTecla  = 0;
             eaOpcion = "";
         |FINSI;
     |FINSI;

     |PULSATECLA;
|FPRC;

|PROCESO BotonesMPFPortal;
     |SI #dsmoy000#6 [ 2014;
         |SI #dsmoy000#0 ! 303;
             |HAZ TraeTgzMPF;
         |FINSI;

         |SI #dsmoy000#0 = 303;  |Y #dsmoy000#6 [ 2013;
             |HAZ TraeTgzMPF;
         |FINSI;
     |FINSI;

     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision PDF pagina hacienda ", 0513, 0654, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Presentacion Telematica      ", 0813, 0954, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Predeterminar Explorador de internet ", 1113, 1254, BotonF4;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton5 = FSalida;

     eaForzExplorador = "S";

     aF2  = &255 + "824";
     aF3  = &255 + "825";
     aF4  = &255 + "826";
     aF5  = &255 + "827";
     aF6  = &255 + "828";
     aEsc = &255 + "806";

     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;

         |SI aTecla = aF2;
             |SI eaModelos = 110;
                |SI eaPer = "M";
                    |MENAV "     El Modelo mensual se emite por internet.";
                |SINO;
                    eaOpcion = "1"; |SAL;
                |FINSI;
             |SINO;
                 eaOpcion = "1"; |SAL;
             |FINSI;
         |FINSI;

         |SI aTecla = aF3;  eaOpcion = "3"; |SAL;  |FINSI;
         |SI aTecla = aF4; |HAZ Explorador;        |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton5;

     |SI eaOpcion = "1";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "3";  enTecla = 3;  |FINSI;

     |PULSATECLA;
|FPRC;

|PROCESO Botones2015;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision PDF pagina hacienda ", 0513, 0654, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Presentacion Telematica      ", 0813, 0954, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Predeterminar Explorador de internet ", 1113, 1254, BotonF4;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton5 = FSalida;

     eaForzExplorador = "S";

     aF2  = &255 + "824";
     aF3  = &255 + "825";
     aF4  = &255 + "826";
     aEsc = &255 + "806";

     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;

         |SI aTecla = aF2;
             |SI eaModelos = 110;
                |SI eaPer = "M";
                    |MENAV "     El Modelo mensual se emite por internet.";
                |SINO;
                    eaOpcion = "1"; |SAL;
                |FINSI;
             |SINO;
                 eaOpcion = "1"; |SAL;
             |FINSI;
         |FINSI;

         |SI aTecla = aF3;  eaOpcion = "3"; |SAL;  |FINSI;
         |SI aTecla = aF4; |HAZ Explorador;        |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton5;

     |SI eaOpcion = "1";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "3";  enTecla = 3;  |FINSI;

     |PULSATECLA;
|FPRC;

|PROCESO LeeFicheroSalidaMPF;
     enErrorPortal = 0;

     aAbre = eaPathLanza + eaFicheroError;
     |XABRE "EC", aAbre, nHandleError;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     enErrorPortal = 1;
     #dsmow190#0 = eaFicheroError;
     #dsmow190#1 = enEmpresa;
     #dsmow190#2 = eaNomEmpresa;
     |GRABA 020#dsmow190.n;
     |LIBERA #dsmow190;
|FPRC;

|PROCESO PresentaMPF;
     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathLanza + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + eaPathLanza + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aEjecu = eaEjer;
     aEjecu = aEjecu % -102;

     aAlfa = eaPathLanza + "wait ";
     aAlfa = aAlfa + "java -Xmx256m -classpath .\mipf" + aEjecu + "pdf.jar es.aeat.mipf.mi" + aEjecu + ".Mipfj ";
     aAlfa = aAlfa + "/E:" + &34 + eaPathLanza + eaFicheroPlano + &34;
     aAlfa = aAlfa + " /R:" + &34 + eaPathLanza + eaFicheroError + &34;

     |SI enTecla = 1;
         aAlfa = aAlfa + " /P:" + &34 + eaPathLanza + eaFicheroImpre + &34;
     |FINSI;

     |SI enTecla = 3;
         aAlfa = aAlfa + " /V:S";
     |FINSI;

     |SI eaTercera = "S";
         aAlfa = aAlfa + " /C:S";
     |FINSI;

     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;

     |HAZ LeeFicheroSalidaMPF;

     aAlfa = eaPathLanza + "imprime.bat";  |RFBORRA aAlfa;

     |SI enErrorPortal = 1;  |ACABA;  |FINSI;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + eaPathLanza + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     |SI eaOpcion = "1";
         aAlfa = "wait dsprint " + eaFicheroImpre + &13 + &10;
         |XGRABA nHandle1, aAlfa;
     |FINSI;

     |SI eaOpcion = "2";
         aAlfa = "wait " + eaPathAcrobat + " " + eaFicheroImpre + &13 + &10;
         |XGRABA nHandle1, aAlfa;
     |FINSI;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;

     aAlfa = eaPathLanza + "imprime.bat";  |RFBORRA aAlfa;
|FPRC;

|PROCESO ValidaMPF;
     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathLanza + eaFicheroPlano;
     |HAZ CopiaFicheroPtl;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + eaPathLanza + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aEjecu = eaEjer;
     aEjecu = aEjecu % -102;

     aAlfa = eaPathLanza + "wait ";
     aAlfa = aAlfa + "java -Xmx256m -classpath .\mipf" + aEjecu + "pdf.jar es.aeat.mipf.mi" + aEjecu + ".Mipfj ";
     aAlfa = aAlfa + "/E:" + &34 + eaPathLanza + eaFicheroPlano + &34;
     aAlfa = aAlfa + " /R:" + &34 + eaPathLanza + eaFicheroError + &34;

     aAlfa = aAlfa + " /V:S";

     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;

     |HAZ LeeFicheroSalidaMPF;

     aAlfa = eaPathLanza + "imprime.bat";  |RFBORRA aAlfa;
|FPRC;

|PROCESO FormularioOV17;
     aMod        = #dsmoy000#0;
     |SI aMod = "110";  aMod = "111";  |FINSI;

     |DBASE aAlfa;  |QBT aAlfa;
     eaFOrigen  = aAlfa + "hacienda/wait.exe";
     eaFDestino = eaPathAEAT + "wait.exe";
     |HAZ CopiaFicheroPtl;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     eaAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV17-M" + aMod + "/index.zul";
     |HAZ GrabaPortalSin;

     eaAlfa = "";
     |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;
|FPRC;
