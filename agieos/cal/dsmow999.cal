|FICHEROS;
     eosclien;

     dsmom004;
     dsmom008;
     dsmo3401;

     program@;
|FIN;

|VARIABLES;
     nLong          = 0;
     nConta         = 0;
     nPosi          = 0;
     nCampo         = 0;
     nNumPanta      = 0;
     nPanta         = 0;
     nContador      = 0;
     nSinDatos      = 0;
     nRegulacion    = 0;
     nActivi        = 0;

     aParametro     = "";
     aAlfa          = "";
     aLong          = "";
     aCampo         = "";
     aPathModelo    = "";
     aDef           = "";
     aQueQuiero     = "";
     aNumPanta      = "";
     aEscape        = "";
     aAvance        = "";
     aRetroceso     = "";

{-1} aMenuMod = "";
     aMenuMod1     = "2400";
     aMenuMod2     = "1";
     aMenuMod3     = "";
     aMenuMod4     = "MC";
     aMenuMod5     = " Modulo ";
     aMenuMod6     = " IVA Deducible ";

     {1}aContiene   = "";
|FIN;

|INCLUYE i_variar;

|PROCESO EntraModelo;
     aParametro = ("00000" + enEmpresa) % -105;
     aParametro = aParametro + ("0000" + enEjer) % -104;
     aParametro = aParametro + ("00" + enPeriodo) % -102;
     aParametro = aParametro + ("000" + enModelo) % -103;
     aParametro = aParametro + ("00" + enComplem) % -102;
     aParametro = aParametro + ("00" + enActividad) % -102;
     aParametro = aParametro + ("00" + enTipoEntrada) % -102;
     aParametro = aParametro + ("0" + enExistencia) % -101;

     |SI enModelo = 390;
         |SI enActividad = 0; |SUB_EJECUTA_NP "dsm39001";  |FINSI;

         |ACABA;
     |FINSI;

     |SI enModelo = 303;
         |SI enActividad = 0;
             aAlfa = "|:agieos/dsm30301;" + aParametro;
             |SI enTipoEntrada ! 1;  |Y enTipoEntrada ! 4;
                 aAlfa = "dsm30301;" + aParametro;
             |FINSI;

             |SUB_EJECUTA_NP aAlfa;
         |FINSI;

         |SI enActividad ! 0;
             |SI enModeloEntra = 303;  |SUB_EJECUTA_NP "dsmociva";  |FINSI;

             |SI enModeloEntra = 310;
                 enModi310 = 0;
                 aMenuMod2 = "2";
                 |SI eaModeloProg = "modulos";
                     |SI enTipoEntrada = 1;
                         |MENU aMenuMod;
                         aMenuMod2 = FSalida;
                         |SI aMenuMod2 = "1";
                             |SUB_EJECUTA "eosm0017;AUTO";
                             |ACABA;
                         |FINSI;
                     |FINSI;
                 |FINSI;

                 |SI aMenuMod2 = "2";
                     enModi310 = 1;
                     |SUB_EJECUTA_NP "dsmoc310";
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI enModeloEntra = 340;
         aAlfa = "|:agieos/dsmo3401;";
         |SI enTipoEntrada ! 1;  |Y enTipoEntrada ! 4;
             aAlfa = "dsmo3401;";
         |FINSI;

         aAlfa = aAlfa + (("00000" + enEmpresa) % -105);
         aAlfa = aAlfa + (("0000" + enEjer) % -104);
         aAlfa = aAlfa + (("00" + enPeriodo) % -102);
         aAlfa = aAlfa + (("000" + enModelo) % -103);
         aAlfa = aAlfa + (("00" + enComplem) % -102);
         aAlfa = aAlfa + (("00" + enActividad) % -102);
         aAlfa = aAlfa + (("00" + enTipoEntrada) % -102);
         aAlfa = aAlfa +  enMensa;

         |SUB_EJECUTA_NP aAlfa;

         enEntrada = 1;

         |ABRE #dsmo3401;
         #dsmo3401#0 = enEmpresa;
         #dsmo3401#1 = enEjer;
         #dsmo3401#2 = enPeriodo;
         #dsmo3401#3 = enModelo;
         #dsmo3401#4 = enComplem;
         #dsmo3401#5 = enActividad;
         |LEE 040#dsmo3401.=;
         |SI FSalida ! 0;  enEntrada = 0;  |FINSI;

         #dsmo3401#0 = enEmpresa;
         #dsmo3401#1 = enEjer;
         #dsmo3401#2 = enPeriodo;
         #dsmo3401#3 = enModelo;
         #dsmo3401#4 = enComplem;
         #dsmo3401#5 = 0;
         |LEE 040#dsmo3401.=;
         |SI FSalida = 0;  enEntrada = 1;  |FINSI;
         |CIERRA #dsmo3401;
     |FINSI;
|FPRC;

|PROCESO dsmom008Cheq;
     |SI #dsmom008#5 ! 0;
         enHayTrabajo  = 1;
     |FINSI;

     enEmpresa     = #dsmom008#0;
     enEjer        = #dsmom008#1;
     enPeriodo     = #dsmom008#2;
     enModelo      = #dsmom008#3;
     enComplem     = #dsmom008#4;
     enActividad   = #dsmom008#5;
     eaComunidad   = #dsmom008#9;
     eaComunero    = #dsmom008#10;
     eaCaptura     = #dsmom008#7;
     eaNombreAct   = #dsmom008#6;
     enModeloEntra = #dsmom008#12;
     eaModeloProg  = #dsmom008#7;   |QBF eaModeloProg;
     enTipoEntrada = 99;
     enExistencia  = 0;

     |SI #dsmom008#5 ! 0;  |Y #dsmom008#5 ! 99;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmom008#3 = 340;
         |ABRE #dsmo3401;
         #dsmo3401#0 = enEmpresa;
         #dsmo3401#1 = enEjer;
         #dsmo3401#2 = enPeriodo;
         #dsmo3401#3 = enModelo;
         #dsmo3401#4 = enComplem;
         #dsmo3401#5 = enActividad;
         |LEE 040#dsmo3401.=;
         |SI FSalida ! 0;  enExistencia = 1;  |FINSI;
         |CIERRA #dsmo3401;

         |SI enActividad = 0;
             nContador = nContador + 1;
             enResultado = 0;
             |SI enExistencia = 0;
                 nSinDatos = nSinDatos + 1;
             |FINSI;
         |FINSI;
     |FINSI;

     |HAZ EntraModelo;

     |SI #dsmom008#5  = 0;    |ACABA;  |FINSI;

     |SI enExistencia = 0;
         |SI #dsmom008#5 = 99;
             nRegulacion = 1;
             |ACABA;
         |FINSI;

         nSinDatos = nSinDatos + 1;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom008Cheq;
     #dsmom008#1;
     ;
     #dsmom004#0, #dsmom004#1, #dsmom004#2, #dsmom004#3, #dsmom004#4, 00;
     #dsmom004#0, #dsmom004#1, #dsmom004#2, #dsmom004#3, #dsmom004#4, 99;
     ;
     NULL, dsmom008Cheq;
|FIN;

|PROCESO ChequeaSituacion;
     |MENSA "      Recalculando Planing";

     enExistencia = 0;
     nSinDatos    = 0;
     nContador    = 0;
     nRegulacion  = 0;
     enResultado  = 0;
     nActivi      = enActividad;
     enHayTrabajo = 0;

     |SI #dsmom004#3 ! 390;
         |BUCLE dsmom008Cheq;
         enActividad  = nActivi;
     |FINSI;

     |SI #dsmom004#3 = 390;
         enEmpresa     = #dsmom004#0;
         enEjer        = #dsmom004#1;
         enPeriodo     = #dsmom004#2;
         enModelo      = #dsmom004#3;
         enComplem     = #dsmom004#4;
         enExistencia  = 0;
         enTipoEntrada = 99;
         |SUB_EJECUTA "dsm39001";

         enHayTrabajo = 1;
         |SI enExistencia = 0;
             nSinDatos  = 1;
             nContador  = 1;
         |FINSI;
     |FINSI;

     |SI nSinDatos = 0;  |Y nRegulacion = 0;
         #dsmom004#17 = "SIN DATOS";
         #dsmom004#7  = " ";
         #dsmom004#9  = " ";
         #dsmom004#11 = " ";
     |FINSI;

     |SI nRegulacion = 1;
         #dsmom004#17 = "PARCIALES";
         #dsmom004#7  = "X";
     |FINSI;

     |SI nSinDatos ! 0;  |Y nSinDatos ! nContador;
         #dsmom004#17 = "PARCIALES";
         #dsmom004#7  = "X";
     |FINSI;

     |SI nSinDatos = nContador;  |Y nSinDatos ! 0;
         #dsmom004#7  = "X";
         #dsmom004#8  = ~;
         #dsmom004#17 = "COMPLETADO";
     |FINSI;

     #dsmom004#15 = enResultado;
     #dsmom004#16 = eaUltimoPer;

     |SI enHayTrabajo = 0;
         #dsmom008#0 = #dsmom004#0;
         #dsmom008#1 = #dsmom004#1;
         #dsmom008#2 = #dsmom004#2;
         #dsmom008#3 = #dsmom004#3;
         #dsmom008#4 = #dsmom004#4;
         #dsmom008#5 = 0;
         |LEE 101#dsmom008.=;
         |SI FSalida = 0;
             |BORRA 020#dsmom008.a;
             |LIBERA #dsmom008;
         |FINSI;
     |FINSI;

     |BLIN 04;
|FPRC;

|PROCESO NoVisual;
     |QBF eaNoVisu;
     |SI eaNoVisu ! "";
         aLong = eaNoVisu % 0;
         nLong = aLong;
         |PARA nConta = 1;  |SI nConta [ nLong;  |HACIENDO nConta = nConta + 3;
               nPosi  = (nConta * 100) + 3
               aCampo = eaNoVisu % nPosi;
               nCampo = aCampo;

               |C_V #program@#nCampo#, 1, "N";
               |C_M #program@#nCampo#, 1, "N";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO PintaDatos;
     |ABRE #eosclien;
     #eosclien#0 = enEmpresa;
     |LEE 000#eosclien.=;
     |CIERRA #eosclien;

     aAlfa = (("00000" + enEmpresa) % -105) + " " + #eosclien#2;
     |SI enActividad = 0;
         aAlfa = aAlfa + " EMISION";
     |SINO;
         aAlfa = aAlfa + " Actividad: " + enActividad;
     |FINSI;
     aAlfa = aAlfa + " Periodo: " + enPeriodo + " / " + enEjer;

     |ATRI I;
     |PINTA 2401, aAlfa;
     |ATRI i;
|FPRC;

|PROCESO PintaPantalla;
     |SI nPanta < 0;   nPanta = 0;                                 |FINSI;
     |SI nPanta = 0;   |PINPA #00#program@;  |PINDA #00#program@;  |FINSI;
     |SI nPanta = 1;   |PINPA #01#program@;  |PINDA #01#program@;  |FINSI;
     |SI nPanta = 2;   |PINPA #02#program@;  |PINDA #02#program@;  |FINSI;
     |SI nPanta = 3;   |PINPA #03#program@;  |PINDA #03#program@;  |FINSI;
     |SI nPanta = 4;   |PINPA #04#program@;  |PINDA #04#program@;  |FINSI;
     |SI nPanta = 5;   |PINPA #05#program@;  |PINDA #05#program@;  |FINSI;
     |SI nPanta = 6;   |PINPA #06#program@;  |PINDA #06#program@;  |FINSI;
     |SI nPanta = 7;   |PINPA #07#program@;  |PINDA #07#program@;  |FINSI;
     |SI nPanta = 8;   |PINPA #08#program@;  |PINDA #08#program@;  |FINSI;
     |SI nPanta = 9;   |PINPA #09#program@;  |PINDA #09#program@;  |FINSI;
     |SI nPanta = 10;  |PINPA #10#program@;  |PINDA #10#program@;  |FINSI;
     |SI nPanta = 11;  |PINPA #11#program@;  |PINDA #11#program@;  |FINSI;
     |SI nPanta = 12;  |PINPA #12#program@;  |PINDA #12#program@;  |FINSI;
     |SI nPanta = 13;  |PINPA #13#program@;  |PINDA #13#program@;  |FINSI;
     |SI nPanta = 14;  |PINPA #14#program@;  |PINDA #14#program@;  |FINSI;
|FPRC;

|PROCESO SacaPantallas;
     |DBASE aPathModelo;  |QBT aPathModelo;
     aDef = aPathModelo + "def/" + eaNomDef + ".mas";
     |CARGA_DEF aDef, program@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + eaNomDef;
         |MENAV aAlfa;
         |ERROR;
     |FINSI;

     aQueQuiero = "|NP";
     aNumPanta  = #program@#aQueQuiero#;
     nNumPanta  = aNumPanta;
     nNumPanta  = nNumPanta - 1;

     aEscape    = &255 + "806";
     aAvance    = &255 + "815";
     aRetroceso = &255 + "814";

     |SI nNumPanta ] 1;
         |MENSA "0000 Av.Pag Pant.Siguiente. Re.Pag Pant.Anterior. ESC Salir.";
     |SINO;
         |MENSA "      ESC Salir.";
     |FINSI;

     |ABRE #program@;
     #program@#0 = enEmpresa;
     #program@#1 = enEjer;
     #program@#2 = enPeriodo;
     #program@#3 = enModelo;
     #program@#4 = enComplem;
     #program@#5 = enActividad;
     |LEE 000#program@.=;
     |SI FSalida ! 0;
         |MENAV "     No existe Registro.";
         |CIERRA #program@;
         |DESCARGA_DEF #program@;
         |ACABA;
     |FINSI;
     |CIERRA #program@;

     |SI enActividad ! 0;  |HAZ NoVisual;  |FINSI;

     |PUSHV 0401 2380;
     |PINPA #0#program@;
     |PINDA #0#program@;

     |HAZ PintaDatos;

     nPanta = 0;
     |PARA;  |SI;  |HACIENDO;
          |LEETECLA aAlfa;
          |SI aAlfa = aEscape;  |SAL;  |FINSI;
          |SI aAlfa = aAvance;
              |SI nPanta < nNumPanta;
                  nPanta = nPanta + 1;
                  |HAZ PintaPantalla;
             |FINSI;
          |FINSI;

          |SI aAlfa = aRetroceso;
              |SI nPanta [ nNumPanta;
                  nPanta = nPanta - 1;
                  |HAZ PintaPantalla;
              |FINSI;
          |FINSI;
     |SIGUE;
     |POPV;

     |DESCARGA_DEF #program@;
|FPRC;


|PROCESO Refresco;
     |PONCONTROL 23, "SI";
|FPRC;

|PROCESO SinBarra;  |TIPO 5;
     FSalida = "SINBARRA";
|FPRC;

|PROCESO LeeUnidad;
     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     eaUnidad = aContiene1 % 102;
|FPRC;
