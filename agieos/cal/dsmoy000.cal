|FICHEROS;
     dsmoy000;

     dsmom004;
     dsmom008;

     dsmow014;
     eosclien;
|FIN;

|VARIABLES;
      nMes      = 0;
      nAnyo     = 0;
      nSwIm     = 0;
      nDComple  = 0;
      nHComple  = 0;
      nSwUno    = 0;
      nModelo   = 0;
      aComproba = "";
      aContinua = "";
      nEmpresa  = 0;

     &enEjer    = 0;
     &eaElProm  = "dsmoy000";
     &enComplem = 0;
     &aCoBien   = "";

     &eaMensaCad       = "";
     &enErrorCad       = 0;
|FIN;

|INCLUYE i_varemi;
|INCLUYE i_consul;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\

|PROCESO Periodo;
     |SI #dsmoy000#4 = 1;   #dsmoy000#5 = "ENERO     ";  |FINSI;
     |SI #dsmoy000#4 = 2;   #dsmoy000#5 = "FEBRERO   ";  |FINSI;
     |SI #dsmoy000#4 = 3;   #dsmoy000#5 = "MARZO     ";  |FINSI;
     |SI #dsmoy000#4 = 4;   #dsmoy000#5 = "ABRIL     ";  |FINSI;
     |SI #dsmoy000#4 = 5;   #dsmoy000#5 = "MAYO      ";  |FINSI;
     |SI #dsmoy000#4 = 6;   #dsmoy000#5 = "JUNIO     ";  |FINSI;
     |SI #dsmoy000#4 = 7;   #dsmoy000#5 = "JULIO     ";  |FINSI;
     |SI #dsmoy000#4 = 8;   #dsmoy000#5 = "AGOSTO    ";  |FINSI;
     |SI #dsmoy000#4 = 9;   #dsmoy000#5 = "SEPTIEMBRE";  |FINSI;
     |SI #dsmoy000#4 = 10;  #dsmoy000#5 = "OCTUBRE   ";  |FINSI;
     |SI #dsmoy000#4 = 11;  #dsmoy000#5 = "NOVIEMBRE ";  |FINSI;
     |SI #dsmoy000#4 = 12;  #dsmoy000#5 = "DICIEMBRE ";  |FINSI;
     |SI #dsmoy000#4 = 99;  #dsmoy000#5 = "ANUAL     ";  |FINSI;

     |PINTA #dsmoy000#5;
     |PINTA #dsmoy000#6;
|FPRC;

|PROCESO Modelo;
     |SI #dsmoy000#0 ! 303;  |Y #dsmoy000#0 ! 340;
      |Y #dsmoy000#0 ! 390;
         |MENAV "     Modelo sin Activar.";
         |ERROR;
     |FINSI;

     |PINTA #dsmoy000#40;

     #dsmoy000#39 = #dsmoy000#4;

     fFecha = ~;
     aAlfa  = fFecha % -104;
     #dsmoy000#6   = aAlfa;
     |SI #dsmoy000#4 = 99;
          #dsmoy000#6   = #dsmoy000#6  - 1;
     |FINSI;

     |SI #dsmoy000#4 = 99;
         |C_M #dsmoy000#4, 1, "N";
         |PINTA #dsmoy000#4;
         |HAZ Periodo;
     |SINO;
         fFecha = ~;
         aAlfa  = fFecha % 402;   nMes  = aAlfa;
         aAlfa  = fFecha % -104;  nAnyo = aAlfa;

         |SI nMes [ 3;
             #dsmoy000#4  = 12;
             #dsmoy000#39 = 12;
             #dsmoy000#6 = nAnyo - 1;

             |SI #dsmoy000#6 = 2013;
                 #dsmoy000#6 = 2014;
                 #dsmoy000#4 = 1;
             |FINSI;

             |HAZ Periodo;

             |PINTA #dsmoy000#4;
             |PINTA #dsmoy000#6;
             |ACABA;
         |FINSI;

         |SI nMes [ 6;
             #dsmoy000#4  = 3;
             #dsmoy000#39 = 3;
             #dsmoy000#6  = nAnyo;
             |HAZ Periodo;
             |PINTA #dsmoy000#4;
             |PINTA #dsmoy000#6;
             |ACABA;
         |FINSI;

         |SI nMes [ 9;
             #dsmoy000#4  = 6;
             #dsmoy000#39 = 6;
             #dsmoy000#6  = nAnyo;
             |HAZ Periodo;
             |PINTA #dsmoy000#4;
             |PINTA #dsmoy000#6;
             |ACABA;
         |FINSI;

         |SI nMes [ 12;
             #dsmoy000#4  = 9;
             #dsmoy000#39 = 9;
             #dsmoy000#6  = nAnyo;
             |HAZ Periodo;
             |PINTA #dsmoy000#4;
             |PINTA #dsmoy000#6;
             |ACABA;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Parrilla;
     #dsmoy000#10 = 1;      |PINTA #dsmoy000#10;  |C_M #dsmoy000#10, 1, "N";
     #dsmoy000#11 = 99999;  |PINTA #dsmoy000#11;  |C_M #dsmoy000#11, 1, "N";
     #dsmoy000#36 = 0;  |PINTA #dsmoy000#36;  |C_M #dsmoy000#36, 1, "N";
     |PARA nCampo = 12;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
          |C_M #dsmoy000#nCampo#, 1, "S";
     |SIGUE;
|FPRC;

|PROCESO DesdeHasta;
     |C_M #dsmoy000#10, 1, "S";
     |C_M #dsmoy000#11, 1, "S";
     #dsmoy000#36 = 0;  |PINTA #dsmoy000#36;  |C_M #dsmoy000#36, 1, "N";

     |PARA nCampo = 12;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy000#nCampo#, 1, "N";
           #dsmoy000#nCampo# = 0;  |PINTA #dsmoy000#nCampo#;
     |SIGUE;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #dsmoy000#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
               #dsmoy000#nCampo# = 0;  |C_M #dsmoy000#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy000#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO BotonParrilla;
     |CONTROL_SIMPLE 0, "LBOTON,F2 Seleccion Empresas Desde-Hasta", 2007, 2039, Boton1;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON,F3 Seleccion Empresas Parrilla   ", 2107, 2139, Boton2;
     nBoton2 = FSalida;

     aF2 = &255 + "824";
     aF3 = &255 + "825";
     aF4 = &255 + "826";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  |HAZ DesdeHasta;  |SAL;  |FINSI;
         |SI aTecla = aF3;  |HAZ Parrilla;    |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;

     |PULSATECLA;
|FPRC;

|PROCESO GrabaTempo;
     |SI #dsmoy000#40 = "N";
         |SI #dsmom004#15 > 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #dsmoy000#40 = "P";
         |SI #dsmom004#15 [ 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #dsmoy000#9 = "N";
         |SI #dsmom004#9 = "X";   |ACABA;  |FINSI;
     |SINO;
         |SI #dsmoy000#9 = "S";  |Y aComproba ! "C";
             |SI #dsmom004#13 = "X";  |ACABA;  |FINSI;
         |FINSI;
     |FINSI;

     nSwEsta = 1;

     |SI #dsmoy000#12 ! 0;
         nSwEsta = 0;
         |PARA nCampo = 12;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
               |SI #dsmoy000#nCampo# = #dsmom004#0;
                   nSwEsta = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwEsta = 0;  |ACABA;  |FINSI;

     #eosclien#0 = #dsmom004#0;
     |LEE 000#eosclien.=;

     #dsmow014#0  = #dsmom004#0;
     #dsmow014#1  = #dsmom004#1;
     #dsmow014#2  = #dsmom004#2;
     |LEE 101#dsmow014.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmow014;
         #dsmow014#0  = #dsmom004#0;
         #dsmow014#1  = #dsmom004#1;
         #dsmow014#2  = #dsmom004#2;
         |GRABA 020#dsmow014.b;
     |FINSI;

     #dsmow014#3  = #eosclien#2;
     #dsmow014#4  = #dsmoy000#5;
     #dsmow014#5  = #dsmoy000#0;
     #dsmow014#6  = "S";
     #dsmow014#7  = #dsmom004#4;
     |GRABA 020#dsmow014.a;
     |LIBERA #dsmow014;

     nSwGraba = 1;
|FPRC;

|DEFBUCLE dsmom004;
     #dsmom004#1;
     7;
     #dsmoy000#10, #dsmoy000#6, #dsmoy000#4,  #dsmoy000#0, nDComple, "X";
     #dsmoy000#11, #dsmoy000#6, #dsmoy000#39, #dsmoy000#0, nHComple, "X";
     ;
     NULL, GrabaTempo;
|FIN;

|RUTINA ClaveBaja999;
     #dsmow014#0 = 1;
     #dsmow014#1 = 0000;
     #dsmow014#2 = 00;
|FRUT;

|RUTINA ClaveAlta999;
     #dsmow014#0 = 99999;
     #dsmow014#1 = 9999;
     #dsmow014#2 = 99;
|FRUT;

|PROCESO MiraCuantos;
     enSwHay = enSwHay + 1;
|FPRC;

|DEFBUCLE dsmow014M;
     #dsmow014#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, MiraCuantos;
|FIN;

|PROCESO Tipo3;  |TIPO 3;
     #dsmoy000#39 = #dsmoy000#4;

     |GRABA 020#dsmoy000.n;
     |LIBERA #dsmoy000;

     |SI enEmpresa ! 0;
         nDComple = enComplem;
         nHComple = enComplem;
     |FINSI;

     aFichero = ("imp" + Usuario) % 108;
     |NOME_DAT #dsmow014#aFichero#;
     |ABRE #dsmow014;  |CIERRA #dsmow014;  |DELINDEX #dsmow014;

     nSwGraba = 0;

     |ABRE #eosclien;
     |ABRE #dsmow014;
     |BUCLE dsmom004;
     |CIERRA #dsmow014;
     |CIERRA #eosclien;

     |SI nSwGraba = 1;
         |PINPA #0#dsmow014;
         |HAZ PonBoton;
         |ENTLINEAL #1#dsmow014, -1, 4, 21, 0, ClaveBaja999, ClaveAlta999;
         |HAZ QuitaBoton;

         enSwHay = 0;
         |BUCLE dsmow014M;
     |SINO;
         |MENAV "     Seleccion Vacia.";
         |DELINDEX #dsmow014;
         |ACABA;
     |FINSI;

     eaPathLanza = eaUnidad + "\AEAT";                 |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + #dsmoy000#0;                    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + #dsmoy000#6;                    |RMKDIR eaPathLanza;
     |SI #dsmoy000#4 ! 99;
         eaPathLanza = eaPathLanza + "\" + (("00" + #dsmoy000#4) % -102);  |RMKDIR eaPathLanza;
     |FINSI;
     eaPathLanza = eaPathLanza + "\";

     aAlfa = eaPathLanza + "*.bat";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;

     aAlfa = eaPathLanza + "*.txt";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;


     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";                     |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + #dsmoy000#0;                      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + #dsmoy000#6;                      |MKDIR eaPathEmision;
     |SI #dsmoy000#4 ! 99;
         eaPathEmision = eaPathEmision + "/" + (("00" + #dsmoy000#4) % -102);    |MKDIR eaPathEmision;
     |FINSI;
     eaPathEmision = eaPathEmision + "/";

     |HAZ LeeUnidad;
     eaPathInternet = eaUnidad + "/AEAT";                             |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";                   |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + #dsmoy000#0;                    |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + #dsmoy000#6;                    |RMKDIR eaPathInternet;
     |SI #dsmoy000#4 ! 99;
         eaPathInternet = eaPathInternet + "/" + (("00" + #dsmoy000#4) % -102);  |RMKDIR eaPathInternet;
     |FINSI;
     eaPathInternet = eaPathInternet + "/";

     |BLIN 23;
     |SI enSwHay = 0;
         |MENAV "      Seleccion Vacia";
     |SINO;
         eaModelos = #dsmoy000#0;
         eaEjer    = #dsmoy000#6;

         aAlfa = "dsmoy" + #dsmoy000#0;
         |SI #dsmoy000#0 = 390;
             |SI #dsmoy000#6 = 2014;                        aAlfa = "dsy39014";  |FINSI;
             |SI #dsmoy000#6 ] 2015; |Y #dsmoy000#6 [ 2017; aAlfa = "dsy39015";  |FINSI;
             |SI #dsmoy000#6 ] 2018;                        aAlfa = "dsy39018";  |FINSI;
         |FINSI;

         |SUB_EJECUTA_NP aAlfa;
     |FINSI;

     |DELINDEX #dsmow014;

     |CIERRA #dsmoy000;
     |DELINDEX #dsmoy000;
|FPRC;

|PROCESO Boton1;
     |PTEC 824;
|FPRC;

|PROCESO Boton2;
     |PTEC 825;
|FPRC;

|PROCESO Boton3;
     |PTEC 826;
|FPRC;

|PROGRAMA;
     |HAZ LeeUnidad;

     aCoBien  = "";
     aFichero = ("000" + Usuario) % 108;
     |NOME_DAT #dsmoy000#aFichero#;
     |ABRE #dsmoy000;  |CIERRA #dsmoy000;  |DELINDEX #dsmoy000;

     |ABRE #dsmoy000;
     nSwUno      = 0;
     enCalcCif   = 0;
     eaParametro = PARAMETRO;  |QBF eaParametro;
     |SI eaParametro = "PLANING"; |O eaParametro = "INFC";
         |DDEFECTO #dsmoy000;
         #dsmoy000#36 = 00;
         #dsmoy000#0  = enModelo;
         #dsmoy000#4  = enPeriodo;  |HAZ Periodo;
         #dsmoy000#39 = enPeriodo;
         #dsmoy000#6  = enEjer;
         #dsmoy000#9  = "X";
         #dsmoy000#10 = enEmpresa;
         #dsmoy000#11 = enEmpresa;
         #dsmoy000#40 = "T";

         |PUSHV 0501 2380;
         |BLANCO 1025 1244;
         |CUADRO 0925 1244;
         |SI eaParametro = "INFC";
             |PINTA 1026, "  FECHA INFORME   ";
             aAlfa       = enModelo;
             eaParametro = aAlfa + "C";
             nSwUno      = 1;
         |SINO;
             |PINTA 1026, "FECHA PRESENTACION";
         |FINSI;
         |ATRI r;

         fFecha = ~;
         fFecha = 1130 ? 1;

         #dsmoy000#7 = fFecha;

         |POPV;

         |HAZ Tipo3;

         |ACABA;
     |FINSI;

     |C_V #dsmoy000#39, 1, "N";  |C_M #dsmoy000#39, 1, "N";
     |C_V #dsmoy000#5,  1, "S";  |C_M #dsmoy000#5,  1, "N";

     aModelo     = eaParametro % 103; nModelo = aModelo;
     |SI aModelo ! "303";  |Y aModelo ! "340";
      |Y aModelo ! "390";
         |CIERRA #dsmoy000;  |DELINDEX #dsmoy000;
         |MENAV "     Modelo sin Activar.";
         |ACABA;
     |FINSI;

     |DDEFECTO #dsmoy000;

     aAlfa = eaParametro % 103;
     #dsmoy000#0  = aAlfa;
     |HAZ Modelo;

     |SI #dsmoy000#0 = 303;  #dsmoy000#1  = "Modelo 303";  |FINSI;
     |SI #dsmoy000#0 = 340;  #dsmoy000#1  = "Modelo 340";  |FINSI;

     |C_M #dsmoy000#4,  1, "S";
     |C_M #dsmoy000#40, 1, "S";
     |SI #dsmoy000#0 = 390;
         #dsmoy000#1  = "Modelo 390";
         #dsmoy000#4  = 99;
         #dsmoy000#40 = "T";
         |C_M #dsmoy000#4,  1, "N";
         |C_M #dsmoy000#40, 1, "N";
      |FINSI;

     |C_M #dsmoy000#0, 1, "N";
     |PINPA #0#dsmoy000;
     |PINDA #0#dsmoy000;
     |ENDATOS #1#dsmoy000;

     |PULSATECLA;
|FPRO;
