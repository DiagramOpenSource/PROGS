|FICHEROS;
   reem100a #0;

   zregubic #10;
   rem00100 #11;
   rem01001 #12;
   reacceso #13;

   rew00001 #100;
   rew02000 #101;
   rew02001 #102;
|FIN

|VARIABLES;
   &enEmpresa = 0;
   &eaTipo    = "";
   &eaNif     = "";

   &eaFOrigen      = "";
   &eaFDestino     = "";
   &eaPathLanza    = "";
   &eaDirJava      = "";
   &eaUnidadBasico = "";
   &eaPathAcrobat  = "";
   &eaModoImpre    = "";
   &eaTipoP        = "";
   &eaTipoR        = "";
   &eaTipoV        = "";
   &eaTipoE        = "";
   &eaTipoC        = "";
   &eaTipoA        = "";
   &eaTipoL        = "";
   &eaTipoF        = "";
   &enBasico       = 0;
   &enError        = 0;
   &enHandle       = 0;
   &enSwFalle      = 0;

   nCont    = 0;
   nCalc    = 0;
   nCalc1   = 0;
   nCalc2   = 0;
   nHandle  = 0;
   nHandle1 = 0;
   nHandle2 = 0;
   nHandleErr = 0;
   SwEstar  = 0;
   DEmpre   = 0;
   HEmpre   = 0;
   XCampos  = 0;

   nRango   = 0;
   nPos     = 0;
   nPos1    = 0;
   nPos2    = 0;

   nCopia    = 0;
   nCanal    = 0;
   nSwCopia  = 0;
   nLongitud = 0;

   aLongitud    = "";
   aCaracter    = "";
   aMarca       = "";
   aParte1      = "";
   aParte2      = "";
   eaJusti      = "";
   aAlfa        = "";
   aAlfa1       = "";
   aAlfa2       = "";
   aAbre        = "";
   aParam       = "";
   aTipo        = "";
   aIdioma      = "";
   aDirBase     = "";
   aDirServidor = "";
   aDirInternet = "";
   aDirLanza    = "";
   aFichero     = "";
   aFicheroP    = "";
   aTecla       = "";
   aRetu        = "";
   aEsc1        = "";
   aEsc2        = "";
   aOrigen      = "";
   aDestino     = "";
   aIPRemoto    = "";
   aImpre       = "";
   DReimp       = "";
   HReimp       = "";
   Comodin      = "";

   aPathServidor = "";
   aForzAcrobat  = "";

   aDirectorio  = "";
   aPathRenta   = "";
   aPathLocal   = "";
   aVersionBasico = "";
   aVersionJava   = "";
   aEjecutaJava   = "";
   aUnidadSistema = "";
   aProgFiles     = "";
   aPathPdf       = "";
   aDocRemoto     = "";
   aDocServidor   = "";
   aDIR           = "";
   nHandleEjec    = 0;
   nCaracter      = 0;
   nSwErrores     = 0;

   aPathExplorador = "";
   aForzExplorador = "";

 {1}version      = "";
 {1}aContiene    = "";
{-1}aVent        = "";
    aVent1       = 0;
    aVent2       = 0;
    aVent3       = 0;
    aVent4       = 0;
    aVent5       = "";

   nVent         = 0;
   nVentErr      = 0;
   nPant         = 0;
   nPantErr      = 0;
   nBotonCont    = 0;
   nBotonSal     = 0;
   nBotonErr     = 0;
   nBotonSalirErr = 0;

   nBotonUnidad  = 0;
   nBotonOk      = 0;
   nBotonCancel  = 0;
   nBotonExplor  = 0;
   nBotonReader  = 0;
   nBotonImpre   = 0;
   nBotonValida  = 0;
   nBotonSalir   = 0;
   nBotonPrevis  = 0;
   nGrid1        = 0;
   nGrid2        = 0;
   nGrid3        = 0;
|FIN;

|PROCESO Explorador;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |ABRE #zregubic;
     #zregubic#0 = 2010;
     #zregubic#1 = aIPRemoto;
     |LEE 101#zregubic.=;
     |SI FSalida ! 0;
         |DDEFECTO #zregubic;
         #zregubic#0 = 2010;
         #zregubic#1 = aIPRemoto;
         |GRABA 020#zregubic.b;
     |FINSI;

     aPathExplorador = #zregubic#4;  |QBF aPathExplorador;

     |SI aPathExplorador = "";  |O aForzExplorador = "S";
         |MENAV "0000Busque y pinche en el explorador con el que quiera trabajar";

         aPathExplorador = "F" + aPathExplorador;
         |BROWSE aPathExplorador;
         aPathExplorador = aPathExplorador % 290;  |QBF aPathExplorador;
     |FINSI;

     |SI aPathExplorador ! "";
         #zregubic#4 = aPathExplorador;
     |FINSI;

     |GRABA 020#zregubic.a;
     |LIBERA #zregubic;
     |CIERRA #zregubic;
|FPRC;

|PROCESO CopiaFichero;
     aAlfa = "";
     |IP_REMOTO aAlfa;  |QBT aAlfa;
     |SI aAlfa ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO GrabaPortal;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO GrabaPortalSin;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO PortalBorrador;
     aAbre = aDirServidor + aFicheroP;
     |XABRE "WB", aAbre, nHandle;

     aAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34;
     |HAZ GrabaPortal;

     aAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">";
     |HAZ GrabaPortal;

     aAlfa = "<html>";
     |HAZ GrabaPortal;

     aAlfa = "<head>";
     |HAZ GrabaPortal;

     aAlfa = "<title>Documento sin t&iacute;tulo</title>";
     |HAZ GrabaPortal;

     aAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">";
     |HAZ GrabaPortal;

     aAlfa = "</head>";
     |HAZ GrabaPortal;

     aAlfa = "";
     |HAZ GrabaPortal;

     aAlfa = "<script language=" + &34 + "javascript" + &34 + ">";
     |HAZ GrabaPortal;

     aAlfa = "     function carga()";
     |HAZ GrabaPortal;

     aAlfa = "     {";
     |HAZ GrabaPortal;

     aAlfa = "          document.form1.submit();";
     |HAZ GrabaPortal;

     aAlfa = "     }";
     |HAZ GrabaPortal;

     aAlfa = "</script>";
     |HAZ GrabaPortal;

     aAlfa = "";
     |HAZ GrabaPortal;

     aAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">";
     |HAZ GrabaPortal;

     aAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + "https://www2.agenciatributaria.gob.es/l/zi22zilk0022" + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + "IEV1000A" + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + aIdioma + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIC" + &34 + " value=" + &34;
     |HAZ GrabaPortalSin;
     |XCIERRA nHandle;

     aDestino   = aDirServidor + aFicheroP;
     aOrigen    = aDirServidor + aFichero;

     |AFEGIR_FICHERO aOrigen, aDestino;

     aAbre = aDirServidor + aFicheroP;
     |XABRE "AB", aAbre, nHandle;

     aAlfa = &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "RUT" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + "EWLINKNB" + &34 + " />";
     ||aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + "2010" + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + "100" + &34 + " />";
     |HAZ GrabaPortal;

     aAlfa = "";  |HAZ GrabaPortal;
     aAlfa = "";  |HAZ GrabaPortal;

     aAlfa = "</form>";   |HAZ GrabaPortal;
     aAlfa = "</body>";   |HAZ GrabaPortal;
     aAlfa = "</html>";   |HAZ GrabaPortal;

     |XCIERRA nHandle;

     aOrigen  = aDirServidor + aFicheroP;
     aDestino = aDirLanza + aFicheroP;
     |HAZ CopiaFichero;

     aForzExplorador = "N";
     |HAZ Explorador;

     || Filtro las '/' por '\'
     aDestino = aDestino - "/";
     |PARA; |SI FSalida ! 0; |HACIENDO;
        nCalc1 = ((FSalida / 100) ! 0) + 99; aParte1 = aDestino % nCalc1;
        nCalc2 = FSalida + 98;               aParte2 = aDestino % nCalc2;
        aDestino = aParte1 + "\" + aParte2;

        aDestino = aDestino - "/";
    |SIGUE;

     |SI aPathExplorador ! "";
         aAlfa = aPathExplorador + " " + aDestino;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
     |SINO;
         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aDestino + &34;
     |FINSI;

     |RSYSTEM aAlfa;
     |PULSATECLA;

     aAlfa = aDirServidor + aFicheroP;   |FBORRA aAlfa;
     aAlfa = aDirLanza + aFicheroP;      |RFBORRA aAlfa;
     |PULSATECLA;
|FPRC;

|PROCESO PortalValidacion;
     aOrigen  = aDirServidor + aFichero;
     aDestino = aDirLanza + aFichero;
     |HAZ CopiaFichero;

     aForzExplorador = "N";
     |HAZ Explorador;

     aAbre = aDirServidor + "imprime.bat";
     |XABRE "WB", aAbre, nHandle;

     aAlfa = aPathExplorador + " " + &34 + "https://www2.agenciatributaria.gob.es/es13/h/servurls.html";
     aAlfa = aAlfa + "?WEB=INTERNET&PRG=100&EJE=2010&URL=VPI&EXT=?FIC=";
     aAlfa = aAlfa + aDirLanza + aFichero + &34;

     |HAZ GrabaPortal;

     |XCIERRA nHandle;

     aOrigen  = aDirServidor + "imprime.bat";
     aDestino = aDirLanza + "imprime.bat";
     |HAZ CopiaFichero;

     |RSYSTEM aDestino;
     |PULSATECLA;

     aAlfa = aDirServidor + "imprime.bat";   |FBORRA aAlfa;
     aAlfa = aDirLanza + "imprime.bat";      |RFBORRA aAlfa;
     aAlfa = aDirLanza + aFichero;           |RFBORRA aAlfa;
     |PULSATECLA;
|FPRC;

|PROCESO PortalImprime;
     |VENTANA 0501, 2399, -1, 16, "Generar PDF";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{10}}A continuaci¢n se abrir  una ventana con el resumen ";
     aAlfa = aAlfa + "del fichero generado. Pulsaremos en Generar PDF y obtendremos ";
     aAlfa = aAlfa + "el impreso. Luego se puede guardar el PDF en cualquier directorio ";
     aAlfa = aAlfa + "de la red.";
     |CONTROL_SIMPLE 0, aAlfa, 1045, 1398, NULL;

     aAlfa = "LABEL,{{10}}Es conveniente hacer un copiar al n£mero de justificante ";
     aAlfa = aAlfa + "porque luego lo pediremos.";
     |CONTROL_SIMPLE 0, aAlfa, 1445, 2698, NULL;

     |CONTROL_SIMPLE 0, "BOTON, Continuar", 1215, 1435, BotonContinuar;
     nBotonCont = FSalida;

     |PULSATECLA;
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Cancelar," + nBotonCont;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINVENTANA nVent;

     aOrigen  = aDirServidor + aFichero;
     aDestino = aDirLanza + aFichero;
     |HAZ CopiaFichero;

     aForzExplorador = "N";
     |HAZ Explorador;

     aAbre = aDirServidor + "imprime.bat";
     |XABRE "WB", aAbre, nHandle;

     aAlfa = aPathExplorador + " " + &34 + "https://www2.agenciatributaria.gob.es/es13/h/servurls.html";
     aAlfa = aAlfa + "?WEB=INTERNET&PRG=100&EJE=2010&URL=BOR&EXT=?FIC=";
     aAlfa = aAlfa + aDirLanza + aFichero + &34;

     aAlfa  = aAlfa;
     |HAZ GrabaPortal;

     |XCIERRA nHandle;

     aOrigen  = aDirServidor + "imprime.bat";
     aDestino = aDirLanza + "imprime.bat";
     |HAZ CopiaFichero;

     |RSYSTEM aDestino;
     |PULSATECLA;

     aAlfa = aDirServidor + "imprime.bat";   |FBORRA aAlfa;
     aAlfa = aDirLanza + "imprime.bat";      |RFBORRA aAlfa;
     |PULSATECLA;

     |VENTANA 0501, 1350, -1, 16, "N£mero de justificante obtenido";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{2}}N£mero de justificante ";
     |CONTROL_SIMPLE 0, aAlfa, 0902, 0920, NULL;

     E_inf   = "";
     E_sup   = "16";

     |PARA;  |SI;  |HACIENDO;
          eaJusti = 0922 ? 1;
          |CONFI "0000SEl n£mero introducido es correcto";
          |SI FSalida = 0;  |SAL;  |FINSI;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINVENTANA nVent;

     |PULSATECLA;

     aImpre = "S";
     aAlfa = aDirLanza + aFichero;      |RFBORRA aAlfa;
|FPRC;

|PROCESO MandaAInternet;
     aOrigen  = aDirServidor + aFichero;
     aDestino = aDirInternet + aFichero;
     |HAZ CopiaFichero;

     aAlfa = "0000El fichero generado est  en " + aDestino + " para su presentaci¢n.";
     |MENAV aAlfa;

     aImpre = "S";
     eaJusti = "";
|FPRC;

|PROCESO BotonUnidad;
     |MENAV "0000Busque y pinche en la ubicacion que quiera asignar para depositar los ficheros a enviar";

     aAlfa = #reem100a#40; |QBF aAlfa;
     aAlfa = "D" + aAlfa; |BROWSE aAlfa;
     aAlfa = aAlfa % 290;  |QBF aAlfa;

     |ABRE #zregubic;
     #zregubic#0 = 2010;
     #zregubic#1 = aIPRemoto;
     |LEE 101#zregubic.=;
     |SI FSalida ! 0;
        |DDEFECTO #zregubic;
        #zregubic#0 = 2010;
        #zregubic#1 = aIPRemoto;
        |GRABA 020#zregubic.b;
     |FINSI;
     #zregubic#6 = aAlfa;
     |GRABA 020#zregubic.a;
     |LIBERA #zregubic; |CIERRA #zregubic;

     #reem100a#40 = #zregubic#6; |PINDA #0#reem100a;
|FPRC;

|PROCESO BotonContinuar;
     |PTEC 806;
|FPRC;

|PROCESO BotonSalir;
     |PTEC 807;
|FPRC;

|PROCESO ModoPresentacion;
     |VENTANA 0501, 2399, -1, 16, "Forma de env¡o";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{10}}A continuaci¢n elija el tipo de presentaci¢n";
     |CONTROL_SIMPLE 0, aAlfa, 1345, 2698, NULL;

     |CONTROL_SIMPLE 0, "BOTON, Internet", 1015, 1235, BotonContinuar;
     nBotonCont = FSalida;

     |CONTROL_SIMPLE 0, "BOTON, Presentaci¢n en PDF", 1415, 1635, BotonSalir;
     nBotonSal = FSalida;

     |PULSATECLA;
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Cancelar," + nBotonCont;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINVENTANA nVent;

     |SI aTecla = aEsc2;
         |HAZ PortalImprime;
         |ACABA;
     |FINSI;

     |SI aTecla = aEsc1;
         |HAZ MandaAInternet;
     |FINSI;
|FPRC;

|PROCESO Portal;
     |SI aTipo = "BORRADOR";
         |HAZ PortalBorrador;
         |ACABA;
     |FINSI;

     aAlfa = aDirInternet + aFichero;   |RFBORRA aAlfa;

     |HAZ PortalValidacion;

     |VENTANA 0501, 2399, -1, 16, "Resultado de la validaci¢n";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{2}}Nuestra aplicaci¢n no puede detectar autom ticamente ";
     aAlfa = aAlfa + "si la declaraci¢n ha sido correcta o no. Sabemos si la ";
     aAlfa = aAlfa + "respuesta de hacienda ha sido positiva si nos ha generado ";
     aAlfa = aAlfa + "el documento PDF ";
     |CONTROL_SIMPLE 0, aAlfa, 1040, 1398, NULL;

     aAlfa = "LABEL,{{2}}Pulse en el bot¢n de continuar SOLO si la respuesta ha sido positiva ";
     aAlfa = aAlfa + "en caso contrario pulse el bot¢n cancelar, ya que de otro modo a la ";
     aAlfa = aAlfa + "hora de presentar la declaraci¢n generada ser¡a rechazada por Hacienda.";
     |CONTROL_SIMPLE 0, aAlfa, 1440, 2498, NULL;

     |CONTROL_SIMPLE 0, "BOTON, Continuar", 1015, 1235, BotonContinuar;
     nBotonCont = FSalida;

     |CONTROL_SIMPLE 0, "BOTON, Cancelar", 1415, 1635, BotonSalir;
     nBotonSal = FSalida;

     |PULSATECLA;
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Cancelar," + nBotonCont;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINVENTANA nVent;

     |SI aTecla = aEsc2;
         |ACABA;
     |FINSI;

     #rem01001#0 = #rew00001#0;
     #rem01001#1 = 0;
     aAlfa = #rew00001#2; aAlfa = aAlfa % 0110;
     #rem01001#2 = aAlfa;
     |LEE 101#rem01001.=;
     |SI FSalida = 0;
         #rem01001#6 = "S";
         |GRABA 020#rem01001.a; |LIBERA #rem01001;
     |FINSI;

     |ABRE #reacceso;
     #reacceso#0 = #rew02000#0;
     |LEE 101#reacceso.=;
     |SI FSalida = 0;
        |SI #reacceso#14 = "INACTIVO  "; #reacceso#14 = "NO IMPRESO"; |FINSI;
        |SI #rem01001#6 = "S";  |Y #reacceso#14 = "NO IMPRESO";
           #reacceso#14 = "IMPRESO";
        |FINSI;

        |SI #rem01001#6 = "N";  |Y #reacceso#14 = "IMPRESO   "; #reacceso#14 = "PARCIAL"; |FINSI;

                                          #reacceso#20 = "";
        |SI #reacceso#12 = "*";           #reacceso#20 = "18,28,245;255,255,255";      |FINSI;
        |SI #reacceso#14 = "IMPRESO   ";  #reacceso#20 = "0,185,0;255,255,255";        |FINSI;
        |SI #reacceso#19 = "S";           #reacceso#20 = "215,120,210;255,255,255";    |FINSI;
        #reacceso#17 = #reem100a#33;
        |GRABA 020#reacceso.a; |LIBERA #reacceso;
     |FINSI;
     |CIERRA #reacceso;

     || aAlfa = #202#4 % 101;  || CIF ??????
     aAlfa = "";
     |SI aAlfa = "A";  |O aAlfa = "B";
         |HAZ MandaAInternet;
         |ACABA;
     |FINSI;

     |SI aTecla = aEsc1;
         |HAZ ModoPresentacion;
     |FINSI;
|FPRC;

|PROCESO GrabaTempo;
   SwEstar = 1;
   #rem00100#0 = #rem01001#0;
   |LEE 000#rem00100.=;
   |SI FSalida ! 0; |DDEFECTO #rem00100; |FINSI;

   #rew02000#0 = #rem01001#0;
   |LEE 000#rew02000.=;
   |SI FSalida ! 0;
      |DDEFECTO #rew02000;
      #rew02000#0 = #rem01001#0;
      aAlfa = #rem00100#2; |QBF aAlfa;
      aAlfa = aAlfa + " " + #rem00100#3; |QBF aAlfa;
      aAlfa = aAlfa + ", " + #rem00100#4; |QBF aAlfa;
      #rew02000#1 = aAlfa;
      #rew02000#2 = #rem00100#1;
      |GRABA 020#rew02000.n;
   |FINSI;

   #rew00001#0 = #rem01001#0;
   #rew00001#1 = "";
   #rew00001#2 = #rem01001#2;
   Comodin = #rew00001#2 % 0101;
   |SI #rew00001#2 = "CONJUNTAE    ";
      Comodin = "J";
   |FINSI;
   |SI #rew00001#2 = "CONJUNTA     ";
      Comodin = "N";
   |FINSI;
   #rew00001#1 = Comodin;
   #rew00001#3 = #rem01001#7;
   #rew00001#4 = 1;
   #rew00001#5 = "S";
   #rew00001#6 = 1;
   #rew00001#7 = "";
   #rew00001#8 = #reem100a#34;
   #rew00001#9 = #reem100a#34;
   |GRABA 000#rew00001.n;
|FPRC;

|DEFBUCLE DatosContrib;
  #rem01001#1;
  5,6;
  DEmpre,00,"          ","100",DReimp;
  HEmpre,99,"zzzzzzzzzz","101",HReimp;
  be;
  NULL, GrabaTempo;
|FIN;

|PROCESO Inf;
  #rem01001#0 = #reem100a#1;
|FPRC;

|PROCESO Sup;
  #rem01001#0 = #reem100a#2;
|FPRC;

|PROCESO CargaTempo;
  SwEstar = 0;

  |ABRE #rem00100;

  |SI #reem100a#36 = "S";
     DReimp = "N"; HReimp = "S";
  |SINO;
     DReimp = "N"; HReimp = "N";
  |FINSI;

  |SI #reem100a#0 = "S";
      DEmpre = #reem100a#1; HEmpre = #reem100a#2;
      |BUCLE DatosContrib;
  |SINO;
      |PARA XCampos = 3; |SI XCampos [ 32; |HACIENDO XCampos = XCampos + 1;
            |SI #reem100a#XCampos# ! 0;
                DEmpre = #reem100a#XCampos#;
                HEmpre = #reem100a#XCampos#;
                |BUCLE DatosContrib;
            |FINSI;
      |SIGUE;
  |FINSI;
  |CIERRA #rem00100;
|FPRC;

|PROCESO MiraSeleccion;
   |SI #reem100a#0 = "S";
      |C_M #reem100a#1, 1, "S"; |C_M #reem100a#2, 1, "S";
      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         |C_M #reem100a#nCont#, 1, "N";
      |SIGUE;
   |SINO;
      |C_M #reem100a#1, 1, "N"; |C_M #reem100a#2, 1, "N";
      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         |C_M #reem100a#nCont#, 1, "S";
      |SIGUE;
   |FINSI;

   |SI PARAMETRO ! "";
      aParam = PARAMETRO;
      aAlfa = aParam - "EMP";
      |SI FSalida ! 0;
         nCalc = FSalida + 2;
         aAlfa = aAlfa % nCalc;
      |FINSI;

      |C_M #reem100a#0, 1, "N"; #reem100a#0 = "S";   |PINTA #reem100a#0;
      |C_M #reem100a#1, 1, "N"; #reem100a#1 = aAlfa; |PINTA #reem100a#1;
      |C_M #reem100a#2, 1, "N"; #reem100a#2 = aAlfa; |PINTA #reem100a#2;

      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         |C_M #reem100a#nCont#, 1, "N"; #reem100a#nCont# = 0; |PINTA #reem100a#nCont#;
      |SIGUE;
   |FINSI;

   |PINDA #0#reem100a;
|FPRC;

|PROCESO Emision;
   |HAZ Lanza;
|FPRC;

|DEFBUCLE Emision;
#rew00001#1;
11;
00000, "          ", "*";
99999, "zzzzzzzzzz", "*";
;
NULL, Emision;
|FIN;

|PROCESO BotonErr;
   aAlfa = "notepad " + #rew02001#3; |QBF aAlfa;
   |RSYSTEM aAlfa;
   |PULSATECLA;
|FPRC;

|PROCESO BorraFichs;
   aAlfa = "or" + (("00000" + #rew02001#0) % -105);
   aAlfa1 = #rew02001#2; |QBF aAlfa1;
   aAlfa1 = aAlfa1 % 0101;
   |SI #rew02001#2 = "CONJUNTA "; |O #rew02001#2 = "CONJUNTAE";
      aAlfa1 = "A";
   |FINSI;
   aAlfa = aAlfa + aAlfa1;

   aIPRemoto = ""; |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
   aAlfa = eaPathLanza + aAlfa;
   |SI aIPRemoto = "";
      |FBORRA aAlfa;
   |SINO;
      |RFBORRA aAlfa;
   |FINSI;
   |PULSATECLA;
|FPRC;

|DEFBUCLE BorraFichs;
#rew02001#1;
;
INICIO;
FINAL;
;
NULL, BorraFichs;
|FIN;

|PROCESO Errores;
   |LEE 000#rew02001.p;
   |SI FSalida ! 0; |ACABA; |FINSI;

   ||Revision de errores
   |VENTANA 1010, 2290, -1, 16, "Errores encontrados en la emision";
   nVentErr = FSalida;

   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVentErr;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#rew02001; nPantErr = FSalida;

   nPos1 = 1856; nPos2 = 1866;
   |CONTROL_SIMPLE nPantErr, "BOTON,{{137}}Ver errores", nPos1, nPos2, BotonErr;
   nBotonErr = FSalida;

   nPos1 = 1868; nPos2 = 1878;
   |CONTROL_SIMPLE nPantErr, "BOTON,{{001}}Salir", nPos1, nPos2, BotonSalir;
   nBotonSalirErr = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 0603; nPos2 = 1679;
   |LINEAL_SIMPLE #1#rew02001, nRango, nPos1, nPos2, NULL, NULL, EvtoGrid3;
   nGrid3 = FSalida;

   aEsc1  = &255 + "806";
   aEsc2  = &255 + "807";
   aRetu  = &255 + "802";
   |PARA; |SI;  |HACIENDO;
      |LEETECLA aTecla;
      |SI aTecla = aEsc1; |SAL; |FINSI;
      |SI aTecla = aEsc2; |SAL; |FINSI;
      |SI aTecla = aRetu; |SAL; |FINSI;
   |SIGUE;

   |BUCLE BorraFichs;

   |DESTRUYECONTROL nGrid3;
   |FIN_CONTROL_WINDOWS nBotonSalirErr;
   |FIN_CONTROL_WINDOWS nBotonErr;

   aVent4 = nVentErr;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |FINVENTANA nVentErr;

   |MENAV "    Se han encontrado errores. Entre a modificar para subsanarlos.";
|FPRC;

|PROCESO Emite;
   || aTipo    = "EMISION"; |HAZ Lanza;
   aAlfa = "    N" + &191 + " Emitir tercera copia ?";
   |CONFI aAlfa;
   |SI FSalida = 0;
      nSwCopia = 1;
   |SINO;
      nSwCopia = 0;
   |FINSI;

   |DELINDEX #rew02001; |ABRE #rew02001;
   eaModoImpre = "I";
   eaTipoV = "N"; |BUCLE Emision;
   |HAZ Errores;
   |CIERRA #rew02001; |DELINDEX #rew02001;

   |PTEC 807;
|FPRC;

|PROCESO Previsualiza;
   |DELINDEX #rew02001; |ABRE #rew02001;
   eaModoImpre = "P";
   eaTipoV = "N"; |BUCLE Emision;
   |HAZ Errores;
   |CIERRA #rew02001; |DELINDEX #rew02001;

   |PTEC 807;
|FPRC;

|PROCESO Valida;
   || aTipo    = "BORRADOR"; |HAZ Lanza;
   aAlfa = "    N" + &191 + " Emitir copia en papel ?";
   |CONFI aAlfa;
   |SI FSalida = 0;
      nSwCopia = 1;
   |SINO;
      nSwCopia = 0;
   |FINSI;

   |DELINDEX #rew02001; |ABRE #rew02001;
   eaModoImpre = "I";
   eaTipoV = "S"; |BUCLE Emision;

   |SI nSwErrores = 0;
      aAlfa = "    Los ficheros validados se han depositado en la carpeta ";
      aAlfa1 = #reem100a#40; |QBF aAlfa1;
      aAlfa = aAlfa + aAlfa1; |MENAV aAlfa;
   |FINSI;

   |HAZ Errores;
   |CIERRA #rew02001; |DELINDEX #rew02001;

   |PTEC 807;
|FPRC;

|PROCESO TomaExplor;
   aForzExplorador = "S"; |HAZ Explorador; aForzExplorador = "N";
|FPRC;

|PROCESO TomaReader;
   aForzAcrobat = "S"; |HAZ BuscaReader;
|FPRC;

|PROCESO Lanza;
   enEmpresa = #rew00001#0;
   eaTipo = #rew00001#2; |QBF eaTipo; eaTipo = eaTipo % 0110;
   eaNif  = #rew02000#2;
   |HAZ GrabaSecuencial;

   |DBASE aDirBase; |QBF aDirBase;
   aDirServidor = aDirBase + "tmp"; |MKDIR aDirServidor;
   aDirServidor = aDirBase + "tmp/";

   aContiene = "";
   |ESPECIFICA "RBASS", aContiene;
   aDirLanza    = aContiene1; |QBF aDirLanza; aAlfa = ""; aAlfa2 = "";
   |PARA nCont = 101; |SI aAlfa2 ! "/"; |Y aAlfa2 ! "\"; |HACIENDO nCont = nCont + 100;
      aAlfa2 = aDirLanza % nCont;
      |SI aAlfa2 ! "/"; |Y aAlfa2 ! "\";
         aAlfa = aAlfa + aAlfa2;
      |FINSI;
   |SIGUE;
   aDirLanza = aAlfa + "\";
   aDirLanza = aDirLanza + "AEAT\"; |RMKDIR aDirLanza; aDirInternet = aDirLanza;
   aDirLanza = aDirLanza + "100\";  |RMKDIR aDirLanza;
   aDirLanza = aDirLanza + "2010\"; |RMKDIR aDirLanza;

   aDirInternet = aDirInternet + "INTERNET\"; |RMKDIR aDirInternet;
   aDirInternet = aDirInternet + "100\";      |RMKDIR aDirInternet;
   aDirInternet = aDirInternet + "2010\";     |RMKDIR aDirInternet;

   aAlfa = #rew00001#0; |QBF aAlfa; aAlfa = aAlfa % 0110;
   aFichero = "or" + (("00000" + aAlfa) % -105);
   aAlfa = #rew00001#2; |QBF aAlfa;
   |SI aAlfa = "CONJUNTA";  aAlfa = "A"; |FINSI;
   |SI aAlfa = "CONJUNTAE"; aAlfa = "A"; |FINSI;
   aFichero = aFichero + (aAlfa % 0101);
   || aFicheroP = "portal100.html"; |HAZ Portal;

   eaTipoE  = aFichero;
   eaTipoR  = aFichero + ".ERR";
   eaTipoP  = aFichero + ".PDF";
   eaTipoL  = #reem100a#35;
   eaTipoF  = "EMITE.TXT";
   eaPathLanza = aDirLanza;

   aOrigen  = aDirServidor + aFichero;
   aDestino = aDirLanza + aFichero;
   |HAZ CopiaFichero;

   |ABRE #rem01001;
   #rem01001#0 = #rew00001#0;
   #rem01001#1 = "";
   #rem01001#2 = #rew00001#2;
   |LEE 000#rem01001.=;
   |SI FSalida ! 0; |DDEFECTO #rem01001; |FINSI;

   |HAZ LineaShellJava;
   |SI nSwErrores = 0;
      #rem01001#0 = #rew00001#0;
      #rem01001#1 = "";
      #rem01001#2 = #rew00001#2;
      |LEE 101#rem01001.=;
      |SI FSalida = 0;
         #rem01001#6 = "S";
         |GRABA 020#rem01001.a; |LIBERA #rem01001;
      |FINSI;

      |ABRE #reacceso;
      #reacceso#0 = #rew00001#0;
      |LEE 101#reacceso.=;
      |SI FSalida = 0;
         |SI #reacceso#14 = "INACTIVO  "; #reacceso#14 = "NO IMPRESO"; |FINSI;
         |SI #rem01001#6 = "S";  |Y #reacceso#14 = "NO IMPRESO";
            #reacceso#14 = "IMPRESO";
         |FINSI;

         |SI #rem01001#6 = "N";  |Y #reacceso#14 = "IMPRESO   "; #reacceso#14 = "PARCIAL"; |FINSI;

                                           #reacceso#20 = "";
         |SI #reacceso#12 = "*";           #reacceso#20 = "18,28,245;255,255,255";      |FINSI;
         |SI #reacceso#14 = "IMPRESO   ";  #reacceso#20 = "0,185,0;255,255,255";        |FINSI;
         |SI #reacceso#19 = "S";           #reacceso#20 = "215,120,210;255,255,255";    |FINSI;
         #reacceso#17 = #reem100a#33;
         |GRABA 020#reacceso.a; |LIBERA #reacceso;
      |FINSI;
      |CIERRA #reacceso;
   |FINSI;
   |CIERRA #rem01001;
|FPRC;

|PROCESO BucleMarca;
   #rew00001#11 = aMarca;
   |GRABA 020#rew00001.a;
|FPRC;

|DEFBUCLE BucleMarca;
#rew00001#1;
;
#rew02000#0, "          ";
#rew02000#0, "zzzzzzzzzz";
be;
NULL, BucleMarca;
|FIN;

|PROCESO EvtoGrid1;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#rew02000.c;

      #rew00001#0 = #rew02000#0;
      #rew00001#1 = " ";
      |LEE 000#rew00001.];
      |PARA; |SI FSalida = 0; |Y #rew00001#0 = #rew02000#0; |HACIENDO;
         aAlfa = #rew00001#2; |QBF aAlfa;
         |SI aAlfa = "CONJUNTAE";
            enSwFalle = 1;
            |SAL;
         |SINO;
            enSwFalle = 0;
         |FINSI;
         |LEE 000#rew00001.s;
      |SIGUE;

      |REFRESCACONTROL nGrid2;
   |FINSI;

   |SI FSalida = 4;
      |SI #rew02000#3 = " ";
         #rew02000#3 = "*";
      |SINO;
         #rew02000#3 = " ";
      |FINSI;
      |GRABA 020#rew02000.a;

      aMarca = #rew02000#3; |BUCLE BucleMarca;
      |REFRESCACONTROL nGrid1;
   |FINSI;
|FPRC;

|PROCESO EvtoGrid2;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#rew00001.c;
   |FINSI;
   |SI FSalida = 4;
      |SI #rew00001#11 = " ";
         #rew00001#11 = "*";
      |SINO;
         #rew00001#11 = " ";
      |FINSI;
      |GRABA 020#rew00001.a;

      |REFRESCACONTROL nGrid2;
   |FINSI;
|FPRC;

|PROCESO EvtoGrid3;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#rew02001.c;
   |FINSI;
   |SI FSalida = 4;
   |FINSI;
|FPRC;

|PROCESO Infw001;
   #rew00001#0 = #rew02000#0;
   #rew00001#1 = " ";
|FPRC;

|PROCESO Supw001;
   #rew00001#0 = #rew02000#0;
   #rew00001#1 = "z";
|FPRC;

|PROCESO Habilita111;
   |SI #reem100a#34 = "S";
      |C_M #reem100a#38, 1, "S";
   |SINO;
      |C_M #reem100a#38, 1, "N";
      #reem100a#38 = "N"; |PINTA #reem100a#38;
   |FINSI;
   |PTEC 802; |PULSATECLA;
|FPRC;

/****************************************************************************
*****                             RUTINAS JAVA                          *****
****************************************************************************/

|PROCESO BorraPdf;
     |DBASE aPathPdf;  |QBT aPathPdf;
     aPathPdf = aPathPdf + "modelospdf";
     aPathPdf = aPathPdf + "/100";                      |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/2010";                     |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/99";                       |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/00";                       |MKDIR aPathPdf; || Complemento
     aPathPdf = aPathPdf + "/";

||     aAlfa    = aPathPdf   + "100" + (("00000" + #rew00001#0) % -105) + ".pdf";
     aAlfa    = aPathPdf   + eaTipoP;
     |FBORRA aAlfa;
|FPRC;

|PROCESO CopiaSecuencial;
  aOrigen  = eaPathLanza + aFichero;
  aDestino = #reem100a#40; |QBF aDestino;
  aAlfa1 = aDestino % -101;
  |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
     aDestino = aDestino + "/";
  |FINSI;
  aDestino = aDestino + aFichero;
  |RCOPIA_FICHERO aOrigen, aDestino;
|FPRC;

|PROCESO LineaShellJava;
     |HAZ BorraPdf;

     enBasico = 0;
     |HAZ BuscaJava;
     |SI enError = 1;  |ACABA;  |FINSI;

     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, enHandle;

     aAlfa = "CD \" + &13 + &10;                 |XGRABA enHandle, aAlfa;
     aAlfa = "CD AEAT" + &13 + &10;           |XGRABA enHandle, aAlfa;
     aAlfa = "CD 100" + &13 + &10;              |XGRABA enHandle, aAlfa;
     aAlfa = "CD 2010" + &13 + &10;             |XGRABA enHandle, aAlfa;

     |SI eaTipoR ! "";
         aAlfa = "DEL " + eaPathLanza + eaTipoR + &13 + &10;
         |XGRABA enHandle, aAlfa;
     |FINSI;

     |SI eaTipoP ! "";
         aAlfa = "DEL " + eaPathLanza + eaTipoP + &13 + &10;
         |XGRABA enHandle, aAlfa;
     |FINSI;

     aAlfa = eaDirJava + &13 + &10;
     |XGRABA enHandle, aAlfa;

     aAlfa = &34 + "%JAVA_HOME%\bin\java" + &34 + " -Xmx256m -classpath .\r10pdf.jar com.aeat.irpf2010.AEAT100j ";

     |SI eaTipoV ! "S";
        || Emision
     |SINO;
        |SI nSwCopia = 1;
           || Emision y copia de fichero
        |SINO;
           || Validacion y copia de fichero
        |FINSI;
     |FINSI;

     |SI eaTipoV ! "S";
         |SI #rem01001#9 = "D";
            aAlfa = aAlfa + "/E:" + eaTipoE + " ";
            aAlfa = aAlfa + "/V:S ";
            aAlfa = aAlfa + "/R:" + eaTipoR + " ";
         |SINO;
            |SI nSwCopia = 1; eaTipoC = "S"; |SINO; eaTipoC = "N"; |FINSI;

            aAlfa = aAlfa + "/E:" + eaTipoE + " ";
            aAlfa = aAlfa + "/R:" + eaTipoR + " ";
            aAlfa = aAlfa + "/P:" + eaTipoP + " ";
            aAlfa = aAlfa + "/C:" + eaTipoC + " ";
            aAlfa = aAlfa + "/L:" + #reem100a#35;
         |FINSI;
     |SINO;
         |SI nSwCopia = 1; |Y #rem01001#9 ! "D";
            aAlfa = aAlfa + "/E:" + eaTipoE + " ";
            aAlfa = aAlfa + "/R:" + eaTipoR + " ";
            aAlfa = aAlfa + "/P:" + eaTipoP + " ";
            aAlfa = aAlfa + "/C:N ";
            aAlfa = aAlfa + "/L:" + #reem100a#35;
         |SINO;
            aAlfa = aAlfa + "/E:" + eaTipoE + " ";
            aAlfa = aAlfa + "/V:S ";
            aAlfa = aAlfa + "/R:" + eaTipoR + " ";
         |FINSI;
     |FINSI;

     aAlfa = aAlfa + &13 + &10;
     |XGRABA enHandle, aAlfa;

     |XCIERRA enHandle;

     |HAZ TraeBasico; ||HAZ TraeModelo;

     |SI enBasico = 0;  |ACABA;  |FINSI;

     aAlfa = eaPathLanza + "imprime.bat";
     |RSYSTEM aAlfa;
     |PULSATECLA;

     aAlfa = eaPathLanza + aFichero + ".ERR";
     |XABRE "ECB", aAlfa, nHandleErr;
     |SI FSalida ] 0;   || Hay errores
        |DDEFECTO #rew02001;
        #rew02001#0 = #rew00001#0;
        #rew02001#1 = #rew00001#3;
        #rew02001#2 = #rew00001#2;
        #rew02001#3 = aAlfa;
        |GRABA 020#rew02001.n;
        nSwErrores = 1;
     |SINO;
        nSwErrores = 0;
        |SI eaTipoV ! "S";
           |HAZ PresentaJava;
        |SINO;
           |SI nSwCopia = 1; |HAZ PresentaJava; |FINSI;
           |HAZ CopiaSecuencial;
        |FINSI;
     |FINSI;

     |SI nSwErrores = 0;
        aIPRemoto = ""; |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
        aAlfa = eaPathLanza + eaTipoE;
        |SI aIPRemoto = "";
           |FBORRA aAlfa;
        |SINO;
           |RFBORRA aAlfa;
        |FINSI;
        |PULSATECLA;
     |FINSI;
|FPRC;

|PROCESO BuscaJava;
     || Cuando haya versiones de a¤os posteriores, chequeare el ejercicio
     ||     para determinar que jre necesito. De momento es fijo
     aVersionBasico = "300";
     aVersionJava   = "jre1.6.0_03";
     aEjecutaJava   = "zjava_1_6_0_03.exe";

     |HAZ LeeJava;
     |SI enError = 1;
         aAlfa = "0000 No tiene instalada la Maquina Virtual para Java Version " + aVersionJava + ". Se va a proceder a instalar";
         |MENAV aAlfa;

         aPathRenta = eaPathLanza;
         aPathLocal  = eaPathLanza;
         |HAZ TraeWait;

         |DBASE aDirectorio;  |QBT aDirectorio;
         eaFOrigen  = aDirectorio + "hacienda/" + aEjecutaJava;
         eaFDestino = aPathRenta +  aEjecutaJava;
         |HAZ FCopiaFichero;

         aAbre = aPathRenta + "Ejecuta.bat";
         |XABRE "CBW", aAbre, nHandle1;

         aAlfa = "CD \" + &13 + &10;    |XGRABA nHandle1, aAlfa;
         aAlfa = "CD AEAT" + &13 + &10; |XGRABA nHandle1, aAlfa;
         aAlfa = "CD 100" + &13 + &10;  |XGRABA nHandle1, aAlfa;
         aAlfa = "CD 2010" + &13 + &10; |XGRABA nHandle1, aAlfa;

         aAlfa = "wait " + aEjecutaJava + &13 + &10;
         |XGRABA nHandle1, aAlfa;

         |XCIERRA nHandle1;

         |RSYSTEM aAbre;
         |PULSATECLA;

         |RFBORRA aAbre;
         |RFBORRA eaFDestino;
         |PULSATECLA;

         aVersionJava   = "jre1.6.0_03";
         |HAZ LeeJava;
         |SI enError = 1;
              aAlfa = "0000 No tiene instalada la Maquina Virtual para Java Version " + aVersionJava + ". Proceso Interrumpido";
              |MENAV aAlfa;
              |ACABA;
         |FINSI;
     |FINSI;

     aAlfa  = aUnidadSistema + "\" + aProgFiles + "\Java\" + aVersionJava;
     eaDirJava = "SET JAVA_HOME=" + aAlfa;  |QBF eaDirJava;
|FPRC;

|PROCESO LeeDir;
     aDIR = aAlfa + "\*";
     |R_PDIR aDIR;
     |PARA;  |SI FSalida = 0; |HACIENDO;
         aAbre = aDIR + "\bin\java.exe";
         |XABRE "EC", aAbre, 0;
         |SI FSalida ] 0;
             aVersionJava = aDIR - aAlfa;
             aVersionJava = aVersionJava - "/";
             aVersionJava = aVersionJava - "\";
             enError      = 0;
         |FINSI;

         |R_SDIR aDIR;
     |SIGUE;
|FPRC;

|PROCESO LeeJava;
     enError = 1;
     |PARA nCaracter = 67;  |SI nCaracter [ 90;  |HACIENDO nCaracter = nCaracter + 1;
           aUnidadSistema = &nCaracter + ":";
           aAbre   = aUnidadSistema + "\Archivos de programa\Java\" + aVersionJava + "\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aProgFiles = "Archivos de programa";
               enError = 0;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Program Files\Java\" + aVersionJava + "\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aProgFiles = "Program Files";
               enError    = 0;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Archivos de programa (x86)\Java\" + aVersionJava + "\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aProgFiles = "Archivos de programa (x86)";
               enError = 0;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Program Files (x86)\Java\" + aVersionJava + "\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aProgFiles = "Program Files (x86)";
               enError    = 0;
               |SAL;
           |FINSI;
     |SIGUE;

     |SI enError = 0;  |ACABA;  |FINSI;

     |PARA nCaracter = 67;  |SI nCaracter [ 90;  |HACIENDO nCaracter = nCaracter + 1;
           aUnidadSistema = &nCaracter + ":";

           aProgFiles = "Archivos de programa";
           aAlfa      = aUnidadSistema + "\Archivos de programa\Java";
           |HAZ LeeDir;
           |SI enError = 0;  |SAL;  |FINSI;

           aProgFiles = "Program Files";
           aAlfa      = aUnidadSistema + "\Program Files\Java";
           |HAZ LeeDir;
           |SI enError = 0;  |SAL;  |FINSI;

           aProgFiles = "Archivos de programa (x86)";
           aAlfa      = aUnidadSistema + "\Archivos de programa (x86)\Java";
           |HAZ LeeDir;
           |SI enError = 0;  |SAL;  |FINSI;

           aProgFiles = "Program Files (x86)";
           aAlfa      = aUnidadSistema + "\Program Files (x86)\Java";
           |HAZ LeeDir;
           |SI enError = 0;  |SAL;  |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TraeWait;
     aPathLocal  = eaPathLanza;

     |DBASE aPathPdf;  |QBT aPathPdf;
     aPathPdf = aPathPdf + "hacienda";                    |MKDIR aPathPdf;
     aOrigen  = aPathPdf   + "/wait.exe";
     aDestino = aPathLocal + "wait.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPdf   + "/dsprint.exe";
     aDestino = aPathLocal + "dsprint.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO FCopiaFichero;
     aAlfa = "";
     |IP_REMOTO aAlfa;  |QBT aAlfa;
     |SI aAlfa ! "";
         |ENVIA_FICHERO eaFOrigen, eaFDestino;
     |SINO;
         |COPIA_FICHERO eaFOrigen, eaFDestino;
     |FINSI;
|FPRC;

|PROCESO PresentaJava;
     aPathLocal = eaPathLanza;

     eaTipoP  = aFichero + ".PDF";
     aAbre = aPathLocal + eaTipoP;
     |XABRE "EC", aAbre, nHandle1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ LocalizaAcrobat;
     |SI enError ! 0;  |ACABA;  |FINSI;

     |HAZ TraeWait;

     aAbre = aPathLocal + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = eaUnidadBasico + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aAlfa = "CD \" + &13 + &10;    |XGRABA nHandle1, aAlfa;
     aAlfa = "CD AEAT" + &13 + &10; |XGRABA nHandle1, aAlfa;
     aAlfa = "CD 100" + &13 + &10;  |XGRABA nHandle1, aAlfa;
     aAlfa = "CD 2010" + &13 + &10; |XGRABA nHandle1, aAlfa;

     |SI eaModoImpre = "I";
         || aAlfa = "wait dsprint " + eaTipoP + &13 + &10;
         aAlfa = "cmd " + &34 + "/c START /WAIT dsprint " + eaTipoP + &34 + &13 + &10;
         |XGRABA nHandle1, aAlfa;
     |FINSI;

     |SI eaModoImpre = "P";
         || aAlfa = "wait " + eaPathAcrobat + " " + eaTipoP + &13 + &10;
         aAlfa = "cmd " + &34 + "/c START /WAIT " + eaPathAcrobat + " " + eaTipoP + &34 + &13 + &10;
         |XGRABA nHandle1, aAlfa;
     |FINSI;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;
     |PULSATECLA;

     |RFBORRA aAbre;
     |PULSATECLA;

     |DBASE aPathPdf;  |QBT aPathPdf;
     aPathPdf = aPathPdf + "modelospdf";
     aPathPdf = aPathPdf + "/100";                          |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/2010";                         |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/99";                           |MKDIR aPathPdf;
     aPathPdf = aPathPdf + "/" + "00";                      |MKDIR aPathPdf; || Complemento
     aPathPdf = aPathPdf + "/";

     aOrigen  = aPathLocal + eaTipoP;
     aDestino = aPathPdf   + "100" + (("00000" + #rew00001#0) % -105) + ".pdf";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |RFBORRA aOrigen;
|FPRC;

|PROCESO TraeBasico;
     |HAZ LeeUnidadBasico;

     aPathLocal = eaUnidadBasico + "\AEAT";           |RMKDIR aPathLocal;
     aPathLocal = eaUnidadBasico + "\AEAT\100";       |RMKDIR aPathLocal;
     aPathLocal = eaUnidadBasico + "\AEAT\100\2010";  |RMKDIR aPathLocal;
     aPathLocal = eaUnidadBasico + "\AEAT\100\2010\";

     |DBASE aPathServidor;   |QBF aPathServidor;
     aPathServidor = aPathServidor + "hacienda/";

     aOrigen    = aPathServidor + "modren10.tgz";
     aDestino   = aPathLocal + "modren10.tgz";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     nCopia    = 0;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
         nCopia = 1;
     |FINSI;

     enBasico = 0;
     |XABRE "EC", aDestino, nHandleEjec;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |SI nCopia = 1;
         |RDESCOMPRIME aDestino;

         aDestino = (aDestino - ".tgz") + ".tar";
         |RDETAR aDestino, aPathLocal;

         |RFBORRA aDestino;
     |FINSI;

     enBasico = 1;
|FPRC;

|PROCESO TraeModelo;
     |SI enBasico = 0;  |ACABA;  |FINSI;

     aAlfa   = #0#6;
     aAlfa   = aAlfa % -102;

     aOrigen    = aPathServidor + "zls" + aAlfa + #0#0 + ".tgz";
     aDestino   = aPathLocal    + "zls" + aAlfa + #0#0 + ".tgz";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     nCopia    = 0;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
         nCopia = 1;
     |FINSI;

     |XABRE "EC", aDestino, nHandleEjec;
     |SI FSalida < 0;  enBasico = 0;  |ACABA;  |FINSI;

     |SI nCopia = 1;
         |RDESCOMPRIME aDestino;

         aDestino = (aDestino - ".tgz") + ".tar";
         |RDETAR aDestino, aPathLocal;

         |RFBORRA aDestino;
     |FINSI;
|FPRC;

|PROCESO BuscaReader;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |ABRE #zregubic;
     #zregubic#0 = 2010;
     #zregubic#1 = aIPRemoto;
     |LEE 101#zregubic.=;
     |SI FSalida ! 0;
         |DDEFECTO #zregubic;
         #zregubic#0 = 2010;
         #zregubic#1 = aIPRemoto;
         |GRABA 020#zregubic.b;
     |FINSI;

     eaPathAcrobat    = #zregubic#5;  |QBF eaPathAcrobat;

     |SI eaPathAcrobat = ""; |O aForzAcrobat = "S";
         |MENAV "0000Busque y pinche en la ubicacion del lector de PDFs";

         eaPathAcrobat = "F" + eaPathAcrobat;
         |BROWSE eaPathAcrobat;
         eaPathAcrobat = eaPathAcrobat % 290;  |QBF eaPathAcrobat;
     |FINSI;

     |SI eaPathAcrobat ! ""; #zregubic#5 = eaPathAcrobat; |FINSI;

     |GRABA 020#zregubic.a;
     |LIBERA #zregubic;
     |CIERRA #zregubic;
|FPRC;

|PROCESO LocalizaAcrobat;
     |IP_REMOTO aIPRemoto; |QBF aIPRemoto;

     |ABRE #zregubic;
     #zregubic#0 = 2010;
     #zregubic#1 = aIPRemoto;
     |LEE 000#zregubic.=;
     |SI FSalida ! 0;  |DDEFECTO #zregubic;  |FINSI;
     |CIERRA #zregubic;

     eaPathAcrobat = #zregubic#5;  |QBF eaPathAcrobat;

     enError  = 0;

     |SI eaPathAcrobat ! "";  |ACABA;  |FINSI;

     version1 = "AcroExch.Document";
     |ESPECIFICA "VERSION_PROGRAMA",version;
     |HAZ ExtraePath;
     |SI eaPathAcrobat = "NO LOCALIZADO";
          version1 = "AcroExch.App";
          |ESPECIFICA "VERSION_PROGRAMA",version;
          |HAZ ExtraePath;
     |FINSI;

     |SI eaPathAcrobat ! "NO LOCALIZADO";
          |HAZ CompruebaRuta;
          |SI enError = 1;          || todo ok
               |ACABA;              || hay Acrobat pero no lo encuentra
          |FINSI;
     |SINO;
          enError = 1;
     |FINSI;

     |SI enError = 0;
         |ABRE #zregubic;
         #zregubic#0 = 2010;
         #zregubic#1 = aIPRemoto;
         |LEE 101#zregubic.=;
         |SI FSalida ! 0;
             |DDEFECTO #zregubic;
             #zregubic#0 = 2010;
             #zregubic#1 = aIPRemoto;
             |GRABA 020#zregubic.b;
         |FINSI;
         #zregubic#5 = eaPathAcrobat;
         |GRABA 020#zregubic.a;
         |LIBERA #zregubic;
         |CIERRA #zregubic;
    |FINSI;
|FPRC;

|PROCESO ExtraePath;
     eaPathAcrobat = version1;
     aLongitud     = eaPathAcrobat % 0;
     nLongitud     = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nCaracter = (nPos * 100) + 1;
          aCaracter = eaPathAcrobat % nCaracter;
          |SI aCaracter = ",";
               nPos          = nLongitud - nPos;
               nPos          = nPos + 100;
               nPos          = (-1) * nPos;
               eaPathAcrobat = eaPathAcrobat % nPos;
               |SAL;
          |FINSI;
     |SIGUE;

     eaPathAcrobat = eaPathAcrobat - "[";
     eaPathAcrobat = eaPathAcrobat - "]";

     aAlfa = eaPathAcrobat;
     |XABRE "CE", aAlfa, nHandle2;
     |SI FSalida ! 0;
        eaPathAcrobat = "NO LOCALIZADO";
     |FINSI;
|FPRC;

|PROCESO CompruebaRuta;
     enError = 0;
     |QBF eaPathAcrobat;
     |XABRE "CE", eaPathAcrobat, nCanal;
     |SI eaPathAcrobat = ""; |O FSalida < 0;
          |XCIERRA nCanal;
          aAlfa = "    No se ha encontrado el directorio donde esta instalado ";
          aAlfa = aAlfa + "Adobe Acrobat Reader. ";
          |MENAV aAlfa;
          aAlfa = "    Debera instalarselo.";
          |MENAV aAlfa;

          enError = 1;
     |FINSI;
|FPRC;

/****************************************************************************
*****************************************************************************
****************************************************************************/

|PROGRAMA;
   |VENTANA 0501, 2770, -1, 16, "Emision modelo 100";
   nVent = FSalida;

   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |ABRE #zregubic;
   #zregubic#0 = 2010;
   #zregubic#1 = aIPRemoto;
   |LEE 101#zregubic.=;
   |SI FSalida ! 0;
      |DDEFECTO #zregubic;
      #zregubic#0 = 2010;
      #zregubic#1 = aIPRemoto;
      |GRABA 020#zregubic.b;
   |FINSI;
   aAlfa = #zregubic#6; |QBF aAlfa;
   |SI aAlfa = "";
      aContiene = "";
      |ESPECIFICA "RBASS", aContiene;
      aAlfa = (aContiene1 % 102) > "";
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! ":"; aAlfa = ""; |FINSI;

      aAlfa = aAlfa + "/AEAT/INTERNET/100/2010/"; |RMKDIR aAlfa;
      #zregubic#6 = aAlfa;
      |GRABA 020#zregubic.a;
   |FINSI;
   |LIBERA #zregubic; |CIERRA #zregubic;
   #reem100a#40 = #zregubic#6;

   |PINPA #0#reem100a; nPant = FSalida;
   |HAZ MiraSeleccion;

   aAlfa = "e1" + Usuario; |NOME_DAT #rew02000#aAlfa#;
   aAlfa = "e2" + Usuario; |NOME_DAT #rew00001#aAlfa#;
   aAlfa = "e3" + Usuario; |NOME_DAT #rew02001#aAlfa#;
   |DELINDEX #rew00001; |ABRE #rew00001;
   |DELINDEX #rew02000; |ABRE #rew02000;
/*
   nPos1 = 2624; nPos2 = 2639;
   |CONTROL_SIMPLE nPant, "BOTON,{{137}}Explorador", nPos1, nPos2, TomaExplor;
   nBotonExplor = FSalida;
   |ESTADO_CONTROL nBotonExplor, "DISABLE";
*/
   nPos1 = 2804; nPos2 = 2816;
   |CONTROL_SIMPLE nPant, "BOTON,{{197}}Ubica Reader", nPos1, nPos2, TomaReader;
   nBotonReader = FSalida;
   |ESTADO_CONTROL nBotonReader, "DISABLE";

   nPos1 = 2818; nPos2 = 2829;
   |CONTROL_SIMPLE nPant, "BOTON,{{205}}Emision PDF", nPos1, nPos2, Previsualiza;
   nBotonPrevis = FSalida;
   |ESTADO_CONTROL nBotonPrevis, "DISABLE";

   nPos1 = 2831; nPos2 = 2843;
   |CONTROL_SIMPLE nPant, "BOTON,{{205}}Emision Renta", nPos1, nPos2, Emite;
   nBotonImpre = FSalida;
   |ESTADO_CONTROL nBotonImpre, "DISABLE";

   nPos1 = 2845; nPos2 = 2858;
   |CONTROL_SIMPLE nPant, "BOTON,{{205}}Emision Internet", nPos1, nPos2, Valida;
   nBotonValida = FSalida;
   |ESTADO_CONTROL nBotonValida, "DISABLE";

   nPos1 = 2860; nPos2 = 2868;
   |CONTROL_SIMPLE nPant, "BOTON,{{001}}Salir", nPos1, nPos2, BotonSalir;
   nBotonSalir = FSalida;
   |ESTADO_CONTROL nBotonSalir, "DISABLE";

   nPos1 = 1846; nPos2 = 1856;
   |CONTROL_SIMPLE nPant, "BOTON,{{207}}Cancelar", nPos1, nPos2, BotonSalir;
   nBotonCancel = FSalida;

   nPos1 = 1858; nPos2 = 1868;
   |CONTROL_SIMPLE nPant, "BOTON,{{206}}Validar", nPos1, nPos2, BotonContinuar;
   nBotonOk = FSalida;

   nPos1 = 1653; nPos2 = 1668;
   |CONTROL_SIMPLE nPant, "BOTON,{{155}}Cambiar unidad", nPos1, nPos2, BotonUnidad;
   nBotonUnidad = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 1903; nPos2 = 2268;
   |LINEAL_SIMPLE #1#rew02000, nRango, nPos1, nPos2, NULL, NULL, EvtoGrid1;
   nGrid1 = FSalida;

   nPos1 = 2403; nPos2 = 2768;
   |LINEAL_SIMPLE #1#rew00001, nRango, nPos1, nPos2, Infw001, Supw001, EvtoGrid2;
   nGrid2 = FSalida;
   |PULSATECLA;

   |ENDATOS #1#reem100a;
   |SI FSalida = 0;
      |FIN_CONTROL_WINDOWS nBotonOk;
      |FIN_CONTROL_WINDOWS nBotonCancel;
      |FIN_CONTROL_WINDOWS nBotonUnidad;
      |PINPA #0#reem100a;

      |C_M #reem100a#1, 1, "N"; |C_M #reem100a#2, 1, "N";
      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         |C_M #reem100a#nCont#, 1, "N";
      |SIGUE;

      SwEstar = 0; |HAZ CargaTempo;
      |SI SwEstar = 0;
         |MENAV "    Seleccion vacia";
      |SINO;
         |ESTADO_CONTROL nBotonReader, "ENABLE";
         |ESTADO_CONTROL nBotonPrevis, "ENABLE";
         |ESTADO_CONTROL nBotonImpre, "ENABLE";
         |ESTADO_CONTROL nBotonValida, "ENABLE";
         |ESTADO_CONTROL nBotonSalir, "ENABLE";

         |REFRESCACONTROL nGrid1;

         aEsc1  = &255 + "806";
         aEsc2  = &255 + "807";
         aRetu  = &255 + "802";
         |PARA; |SI;  |HACIENDO;
            |LEETECLA aTecla;
            |SI aTecla = aEsc1; |SAL; |FINSI;
            |SI aTecla = aEsc2; |SAL; |FINSI;
            |SI aTecla = aRetu; |SAL; |FINSI;
         |SIGUE;
      |FINSI;
   |SINO;
      |FIN_CONTROL_WINDOWS nBotonOk;
      |FIN_CONTROL_WINDOWS nBotonCancel;
   |FINSI;

   |DESTRUYECONTROL nGrid1;
   |DESTRUYECONTROL nGrid2;
   |FIN_CONTROL_WINDOWS nBotonReader;
   |FIN_CONTROL_WINDOWS nBotonExplor;
   |FIN_CONTROL_WINDOWS nBotonImpre;
   |FIN_CONTROL_WINDOWS nBotonValida;
   |FIN_CONTROL_WINDOWS nBotonSalir;

   |CIERRA #rew00001; |DELINDEX #rew00001;
   |CIERRA #rew02000; |DELINDEX #rew02000;

   aVent4 = nVent;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |FINVENTANA nVent;
|FPRO;
