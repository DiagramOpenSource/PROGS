|FICHEROS;
   cubal801 #1;
   cubal802 #2;
   cubal803 #3;
   cubal804 #4;
   cubal805 #5;
   imag8v4@ #14;

   imag804@ #904;

   :/agicont/def/ca8m0000  #420;  || Def Balance
   :/agicont/def/ca8m0001  #421;  || Def Balance Textos
   :/agicont/def/ca8m0002  #422;  || Def Balance Linea Cuentas
   :/sociedad/def/soda8m02 #432;  || Def Estado del Patrimonio
|FIN;

|VARIABLES;
   &empresa  = 0;
   &anyo     = 0;
   &nombre   = "";
   &nif      = "";
   &tipo     = "";
   &unid     = "";
   &modo     = 0;
   &sw_mod   = 0;
   anyo1     = 0;
   anyo2     = 0;
   FEstado   = 0;
   nLinea    = 0;
   nCampo0   = 0;
   nCampo1   = 0;
   aCampo4   = "";
   aTipoA    = "";
   aAlfa1    = "";
   aAlfa2    = "";
   aAlfa3    = "";
   aAlfa4    = "";
   aAlfa5    = "";
   nNume1    = 0;
   nNume2    = 0;
   &enSwCero = 0;
   nPara1    = 0;
   nPara2    = 0;
   nPara3    = 0;
   nColum    = 0;
   nDLinea   = 0;
   nHLinea   = 0;
   nQueHago  = 0;
   aMas      = "";
   aDef      = "";
   aColum    = "";
   nImporte  = 0;
   nSw       = 0;
   &enDPlan  = 0;
   &wExCa8M0 = 0;
   &wPatOfi   = 0;
   &wTipoPat  = 0;
   nDEjer     = 0;
   nHEjer     = 0;
|FIN;

|INCLUYE varbal_i;

|PROCESO AltaTotal;
        |SI aTipoA = "A"; aAlfa1 = "TOTAL ACTIVO "; |FINSI;
        |SI aTipoA = "P"; aAlfa1 = "TOTAL PASIVO "; |FINSI;

         nLinea = nLinea + 1;
         |DDEFECTO #1;
         #1#0 = empresa;
         #1#1 = anyo;
         #1#2 = nLinea;
         #1#3  = aAlfa1;
         #1#4  = "S";
         #1#8  = "T";
         #1#9  = 0;
         #1#10 = aTipoA;
         #1#11 = 99;
         #1#12 = 0;
         #1#13 = 0;
         #1#14 = 0;
         #1#15 = 0;
         |SI #1#10 = "A";
             #1#16 = 10000;   ||Casilla Cuentas Anuales
             #1#17 = 180;   ||Casilla Impuesto   MODIFICAR CUANDO LO SEPA
         |SINO;
             #1#16 = 30000;   ||Casilla Cuentas Anuales
             #1#17 = 252;   ||Casilla Impuesto   MODIFICAR CUANDO LO SEPA
         |FINSI;
         |GRABA 040#1n;
|FPRC;

|PROCESO GrabaAuxiliar;

     |SI #421#1 = 0;    ||Situacion
         |SI aTipoA = ""; aTipoA = #421#3; |FINSI;
         |SI aTipoA ! #421#3;
             |HAZ AltaTotal;
             aTipoA = #421#3;
         |FINSI;
         nLinea = nLinea + 1;
         |DDEFECTO #1;
         #1#0 = empresa;
         #1#1 = anyo;
         #1#2 = nLinea;
         #1#3  = #421#9;    ||Texto

         #1#4  = "N";
         |SI #421#7 = 0; #1#4 = "G"; |FINSI;
         |SI aCampo4 = ""; aCampo4 = #1#4; |FINSI;
         #1#8  = #421#8;
         |SI #1#8 = "A"; #1#4 = aCampo4; |FINSI;

         #1#9  = #421#2;
         #1#10 = #421#3;
         #1#11 = #421#4;
         #1#12 = #421#5;
         #1#13 = #421#6;
         #1#14 = #421#7;
         #1#15 = #421#10;
         #1#16 = #421#11;   ||Casilla Cuentas Anuales
         #1#17 = #421#12;   ||Casilla Impuesto
         #1#5  = #421#13;   ||Nota Memoria
         |GRABA 040#1n;
         aCampo4 = #1#4;
    |FINSI;
    |SI #421#1 = 1;    ||Perdidas y Ganacias
         nLinea = nLinea + 1;
         |DDEFECTO #2;
         #2#0 = empresa;
         #2#1 = anyo;
         #2#2 = nLinea;
         #2#3  = #421#9;    ||Texto

         #2#4  = "G";
         |SI #421#8 = "C";
             |SI #421#5 ! 0; |O #421#7 ! 0; #2#4 = "N"; |FINSI;
         |FINSI;
         #2#8  = #421#8;
         |SI aCampo4 = ""; aCampo4 = #2#4; |FINSI;
         |SI #2#8 = "A"; #2#4 = aCampo4; |FINSI;

         #2#9  = #421#2;
         #2#10 = #421#3;
         #2#11 = #421#4;
         #2#12 = #421#5;
         #2#13 = #421#6;
         #2#14 = #421#7;
         #2#15 = #421#10;
         #2#16 = #421#11;   ||Casilla Cuentas Anuales
         #2#17 = #421#12;   ||Casilla Impuesto
         #2#5  = #421#13;   ||Nota Memoria
         |GRABA 040#2n;
         aCampo4 = #2#4;
    |FINSI;
    |SI #421#1 = 2;    ||Ingresos y Gastos
         nLinea = nLinea + 1;
         |DDEFECTO #3;
         #3#0 = empresa;
         #3#1 = anyo;
         #3#2 = nLinea;
         #3#3  = #421#9;    ||Texto

         #3#4  = "N";
         |SI #421#7 = 0; #3#4 = "G"; |FINSI;
         |SI aCampo4 = ""; aCampo4 = #3#4; |FINSI;
         #3#8  = #421#8;
         |SI #3#8 = "A"; #3#4 = aCampo4; |FINSI;

         #3#9  = #421#2;
         #3#10 = #421#3;
         #3#11 = #421#4;
         #3#12 = #421#5;
         #3#13 = #421#6;
         #3#14 = #421#7;
         #3#15 = #421#10;
         #3#16 = #421#11;   ||Casilla Cuentas Anuales
         #3#17 = #421#12;   ||Casilla Impuesto
         #3#5  = #421#13;   ||Nota Memoria
         |GRABA 040#3n;
    |FINSI;
    |SI #421#1 = 4;    ||Estado de Flujos
         nLinea = nLinea + 1;
         |DDEFECTO #5;
         #5#0 = empresa;
         #5#1 = anyo;
         #5#2 = nLinea;

         #5#3  = #421#9;    ||Texto
         #5#4  = "N"; |SI #421#7 = 0; #5#4 = "G"; |FINSI;
         |SI aCampo4 = ""; aCampo4 = #3#4; |FINSI;
         #5#8  = #421#8;
         |SI #5#8 = "A"; #5#4 = aCampo4; |FINSI;

         #5#9  = #421#2;
         #5#10 = #421#3;
         #5#11 = #421#4;
         #5#12 = #421#5;
         #5#13 = #421#6;
         #5#14 = #421#7;
         #5#15 = #421#10;
         #5#16 = #421#11;   ||Casilla Cuentas Anuales
         #5#17 = #421#12;   ||Casilla Impuesto
         #5#5  = #421#13;   ||Nota Memoria
         |GRABA 040#5n;
    |FINSI;
|FPRC;

|DEFBUCLE GrabaAuxiliar;
 #421#1;
 ;
 enEjerBal, nCampo0, nCampo1, 0, " ", 00, 0, 00, 00, 0;
 enEjerBal, nCampo0, nCampo1, 9, "z", 99, 9, 99, 99, 9;
 ;
 NULL, GrabaAuxiliar;
|FIN;

|PROCESO GrabaAux_Nuevo;
         |DDEFECTO #4;
         #4#0 = empresa;
         #4#1 = anyo;
         #4#2 = #432#1;
         #4#3 = #432#2;
         #4#4 = #432#3;
         #4#5 = #432#6;
         |HAZ CambioT;
         #4#43 = #432#21; #4#44 = #432#22; #4#45 = #432#23;
         #4#46 = #432#24; #4#47 = #432#25; #4#48 = #432#26;
         #4#49 = #432#27; #4#50 = #432#28; #4#51 = #432#29;
         #4#52 = #432#30; #4#53 = #432#31; #4#54 = #432#32;
         #4#55 = #432#33;
         |GRABA 040#4n;
|FPRC;

|PROCESO CambioT;

 aAlfa1 = #4#5-"200X";
 |SI aAlfa1 = #4#5; |ACABA; |FINSI;

 aAlfa1 = anyo;
 nNume1 = anyo - 1; aAlfa2 = nNume1;
 nNume1 = anyo - 2; aAlfa3 = nNume1;

 aAlfa4 = #4#5; |QBF aAlfa4;

 aAlfa5 = aAlfa4 - "200X-2 y anter";
 |SI aAlfa4 ! aAlfa5;
     aAlfa4 = aAlfa5 + " " + aAlfa3 + " y anteriores";
 |SINO;
     aAlfa5 = aAlfa4 - "200X-2 y anteriores";
     |SI aAlfa4 ! aAlfa5;
         aAlfa4 = aAlfa5 + " " + aAlfa3 + " y anteriores";
     |SINO;
         aAlfa5 = aAlfa4 - "200X-2";
         |SI aAlfa4 ! aAlfa5;
             aAlfa4 = aAlfa5  + aAlfa3;
         |SINO;
             aAlfa5 = aAlfa4 - "200X-1";
             |SI aAlfa4 ! aAlfa5;
                 aAlfa4 = aAlfa5 + aAlfa2;
             |SINO;
                 aAlfa5 = aAlfa4 - "200X";
                 |SI aAlfa4 ! aAlfa5;
                     aAlfa4 = aAlfa5 + aAlfa1;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;
 #4#5 = aAlfa4;
|FPRC;

|DEFBUCLE GrabaAux_Nuevo;
 #432#1;
 ;
 enEjerBal, nCampo0, 001;
 enEjerBal, nCampo0, 999;
 ;
 NULL, GrabaAux_Nuevo;
|FIN;

|PROCESO eCrearVacio;

  |SI nBalance = -1; |O nBalance = 0;
      nLinea  = 0;
      nCampo0 = nBalNum;
      nCampo1 = 0;
      |ABRE #1;
      |BUCLE GrabaAuxiliar;
      |HAZ AltaTotal;
      |CIERRA #1;
  |FINSI;

  |SI nBalance = -1; |O nBalance = 1;
      nLinea  = 0;
      nCampo0 = nCtaNum;
      nCampo1 = 1;
      |ABRE #2;
      |BUCLE GrabaAuxiliar;
      |CIERRA #2;
  |FINSI;

  |SI nBalance = -1; |O nBalance = 2;
      nLinea  = 0;
      nCampo0 = nBalNum;
      nCampo1 = 2;
      |ABRE #3;
      |BUCLE GrabaAuxiliar;
      |CIERRA #3;
  |FINSI;

  |SI nBalance = -1; |O nBalance = 4;
      nLinea  = 0;
      nCampo0 = nBalNum;
      nCampo1 = 4;
      |ABRE #5
      |BUCLE GrabaAuxiliar;
      |CIERRA #5
  |FINSI;

  |SI nBalance = -1; |O nBalance = 3;
      nLinea  = 0;
      nCampo0 = nBalNum;
      nCampo1 = 3;
      |ABRE #4;
      |BUCLE GrabaAux_Nuevo;
      |CIERRA #4;
  |FINSI;
|FPRC;

|| ------------------------------------------------------------------------
|PROCESO MiroDefinicion;
  ||... Campos "X" dejarlos a 0
  |DDEFECTO #432;
  #432#34= enEjerBal;
  #432#0 = nBalNum;
  #432#1 = nLinea;
  |LEE 041#432=;
|FPRC;

|PROCESO Total804;
 nLinea = #904#2;
 |HAZ MiroDefinicion;
 |SI #432#5 ! "S";
     |PARA nPara1 = 6; |SI nPara1 [ 42; |HACIENDO nPara1 = nPara1 + 1;
           #4nPara1 = #4nPara1 + #904nPara1;
     |SIGUE;
 |FINSI;
|FPRC;

|DEFBUCLE Total804;
 #904#1003;
 ;
 empresa, anyo, nDLinea;
 empresa, anyo, nHLinea;
 e;
 NULL, Total804;
|FIN;

|PROCESO Modifico_4;
 |SI nQueHago = 0;              ||Poner a 0 acumulado de Variaciones
     |PDEFECTO #4, 31, 43;
 |FINSI;

  |SI nQueHago = 1; |O nQueHago = 2;
      nLinea = #4#2;
      |HAZ MiroDefinicion;

     |SI nQueHago = 1;              ||Totales
         |SI #432#5 = "S";
             |SI #432#20 > 0;
                 nDLinea = nLinea + 1;
                 nHLinea = nLinea + #432#20;
             |SINO;
                 nDLinea = nLinea + #432#20;
                 nHLinea = nLinea - 1;
             |FINSI;
             |PDEFECTO #4,6,43;
             |BUCLE Total804;
         |FINSI;
     |FINSI;

     |SI nQueHago = 2;              ||Suma de Cuentas + Variaciones
         #4#18 = 0;
         |PARA nPara1 = 6; |SI nPara1 [ 17; |HACIENDO nPara1 = nPara1 + 1;
               nNume1 = nPara1 + 1;
               aColum = #432nNume1;

               nPara2 = nPara1 + 13;
               nPara3 = nPara1 + 25;

               |SI aColum ! "X";
                   #4nPara1 = #4nPara2 + #4nPara3;
                   #4#18 = #4#18 + #4nPara1;
               |SINO;
                   #4nPara1 = 0;
                   #4nPara2 = 0;
                   #4nPara3 = 0;
               |FINSI;
         |SIGUE;
     |FINSI;
 |FINSI;

 |GRABA 020#4a;
 |LIBERA #4;
|FPRC;

|DEFBUCLE Modifico_4;
 #4#1;
 ;
 empresa, anyo, 001;
 empresa, anyo, 999;
 be;
 NULL, Modifico_4;
|FIN;

|PROCESO Act_M804;
 #4#0 = empresa;
 #4#1 = anyo;
 #4#2 = nLinea;
 |LEE 101#4=;
 |SI FSalida = 0;
     nNume1 = nColum + 30;
     #4nNume1 = #4nNume1 + nImporte;
     |GRABA 020#4a;
 |FINSI;
 |LIBERA #4;
|FPRC;

|PROCESO LeeVariacion;
  nLinea = #14#4;
  nColum = #14#5;
  |HAZ MiroDefinicion;
  nNume1 = nColum + 6;
  aColum = #432nNume1;

  |SI aColum ! "X";
      nImporte = #14#6;
      |HAZ Act_M804;
  |FINSI;
|FPRC;

|DEFBUCLE LeeVariacion;
 #14#1003;
 ;
 empresa, anyo, 0001;
 empresa, anyo, 9999;
 e;
 NULL, LeeVariacion;
|FIN;

|PROCESO ElCalFinal804;
 |DBASE aMas;
 aDef = aMas + "def/cubal804";
 |CARGA_DEF aDef, imag804@;
 |SI FSalida ! 0; |ACABA; |FINSI;

 aDef = aMas + "def/cubal8v4";
 |CARGA_DEF aDef, imag8v4@;
 |SI FSalida ! 0;
     |DESCARGA_DEF #imag804@;
     |ACABA;
 |FINSI;

 |SI enSwCero = 1;
     nQueHago = 0;
     |BUCLE Modifico_4;
 |FINSI;

 |ABRE #432;
 |SI enSwCero ! 2;
     |ABRE #4;
     |BUCLE LeeVariacion;
     |CIERRA #4;
 |FINSI;

 nQueHago = 1;
 |BUCLE Modifico_4;

 nQueHago = 2;
 |BUCLE Modifico_4;
 |CIERRA #432;

 |DESCARGA_DEF #imag8v4@;
 |DESCARGA_DEF #imag804@;
|FPRC;

|PROCESO PrimeraPas;
  nSw = 1;
  |ERROR10;
|FPRC;

|DEFBUCLE PrimeraPas;
  #421#1;
  ;
  nDEjer, nBalNum, 0, 0, " ",00,00,00,00,0;
  nHEjer, nBalNum, 9, 9, "z",99,99,99,99,9;
  e;
  NULL, PrimeraPas;
|FIN;

|DEFBUCLE SegundaPas;
  #432#1;
  ;
  nDEjer, nBalNum, 001;
  nHEjer, nBalNum, 999;
  e;
  NULL, PrimeraPas;
|FIN;

|PROCESO eBorraCa8m0000;

    |SI nBalNum ! 0; |Y nBalNum ! 1; |Y nBalNum ! 10;
       |Y nBalNum ! 30; |Y nBalNum ! 31; |Y nBalNum ! 32;

         nSw = 0;
         nDEjer = 2008;
         nHEjer = 2099;
         |BUCLE PrimeraPas;
         |SI nSw = 0;
            |BUCLE SegundaPas;
         |FINSI;
         |SI nSw = 0;
             |ABRE #420;
             #420#0 = nBalNum;
             |LEE 141#420=;
             |SI FSalida = 0;
                 |BORRA 020#420a;
             |FINSI;
             |LIBERA #420;
             |CIERRA #420;
         |FINSI;
    |FINSI;
|FPRC;

|PROCESO eExisteCa8m0000;
    wExCa8M0 = 0;
    nDEjer = enDPlan;
    nHEjer = enDPlan;
    nSw = 0;
    |BUCLE PrimeraPas;
    |SI nSw = 0;
        |BUCLE SegundaPas;
    |FINSI;
    wExCa8M0 = nSw;
|FPRC;

|PROCESO eVerEsPatron;
  wPatOfi = 0;

  |SI enDPlan = 2008; |O enDPlan = 2015;
    |O enDPlan = 2016; |O enDPlan = 2018;

      |SI wTipoPat = 0;
          |SI nBalNum = 0; |O nBalNum = 1;
             |O nBalNum = 30; |O nBalNum = 31;
                wPatOfi = 1;
          |SINO;
              |SI enDPlan = 2008;
                  |SI nBalNum = 20; |O nBalNum = 21;
                      wPatOfi = 1;
                  |FINSI;
              |SINO;
                  |SI enDPlan = 2016; |O enDPlan = 2018;
                     |SI nBalNum = 40; |O nBalNum = 41;
                         wPatOfi = 1;
                     |FINSI;
                  |FINSI;
              |FINSI;
          |FINSI;
     |FINSI;

      |SI wTipoPat = 1;
          |SI nBalNum = 0; |O nBalNum = 1; |O nBalNum = 10;
             |O nBalNum = 30; |O nBalNum = 31; |O nBalNum = 32;
                wPatOfi = 1;
          |SINO;
              |SI enDPlan = 2008;
                  |SI nBalNum = 5; |O nBalNum = 6; |O nBalNum = 7;
                    |O nBalNum = 20; |O nBalNum = 21; |O nBalNum = 22;
                      wPatOfi = 1;
                  |FINSI;
              |SINO;
                  |SI enDPlan = 2016; |O enDPlan = 2018;
                      |SI nBalNum = 40; |O nBalNum = 41; |O nBalNum = 42;
                          wPatOfi = 1;
                      |FINSI;
                  |FINSI;
              |FINSI;
          |FINSI;
     |FINSI;
  |FINSI;
|FPRC;
