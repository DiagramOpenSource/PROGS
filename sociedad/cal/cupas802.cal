|FICHEROS;
    cubal800 #0;

    sodacoli #1;         || cuentas
    sodacoca #2;
    soda8w03 #3;         || Auxiliar
    cubal802 #802;       || Total

    :/agicont/def/ca8cumay #410;  || Control de Balances
    :/agicont/def/ca8m0000 #420;  || Descripcion Numero de Balance
    :/agicont/def/ca8m0001 #421;  || Def Balance Textos
    :/agicont/def/ca8m0002 #422;  || Def Balance Linea Cuentas

    soda8w07 #890;
|FIN;

|VARIABLES;
    aFichero = "";
     &empresa = 0;
     &anyo    = 0;
     &nombre  = "";
     &nif     = "";
     &unid    = "";
     &tipo    = "";
     &acabalo = 0;

   nImporte = 0;
   nImporte1= 0;
   nImporte2= 0;
   nImporte3= 0;
   nImporte4= 0;
   nImporte5= 0;
   nImporte6= 0;
   nImporte7= 0;
   nImporte8= 0;
   nImporte9= 0;
   nImpB1   = 0;
   nImpB2   = 0;
   nImpB3   = 0;
   nImpB4   = 0;
   nImpB5   = 0;
   nImpB6   = 0;
   nImpB7   = 0;
   nImpB8   = 0;
   nImpB9   = 0;
   nLong    = 0;
   &aTitulo  = "";
   &aAPR     = "";
   &aCuenta  = "";
   aAlfa1   = "";
   acumula = 0;
   acumul1 = 0;
   nCampo  = 0;
   nCampo2 = 0;
   aCampo3 = "";
   nCampo4 = 0;
   nCampo5 = 0;
   nCampo6 = 0;
   nCampo7 = 0;
   nCampo8 = 0;
   nCampo16 = 0;
   nSI     = 0;
   aDCta   = "";
   aHCta   = "";
   aCtaM   = "";
   nNivel  = 0;
   nCam1  = 0;
   nCam2  = 0;

    activo  = 0;
    pasivo  = 0;
    activ1  = 0;
    pasiv1  = 0;
    saldo   = 0;

   nHay     = 0;
   nDCampo5 = 0;
   nDCampo6 = 0;
   nDCampo7 = 0;
   nDCampo8 = 0;
   nHCampo5 = 0;
   nHCampo6 = 0;
   nHCampo7 = 0;
   nHCampo8 = 0;
   nEjer    = 0;

   nNumero  = 0;
   &eaICtas = "";
   swImp    = 0;
|FIN;

|INCLUYE varbal_i;

||**************************************
|PROCESO DetalleCta_802;  ||Carga Trabajo de Cuentas Impresion Detalle
  #890#0  = empresa;
  #890#1  = anyo;
  #890#2  = nBalance;
  #890#3  = nNumero;
  #890#4  = aCuenta;
  |LEE 101#890=;
  |SI FSalida ! 0;
      |DDEFECTO #890;
      #890#0  = empresa;
      #890#1  = anyo;
      #890#2  = nBalance;
      #890#3  = nNumero;
      #890#4  = aCuenta;
      #890#5  = aTitulo;
      |GRABA 020#890b;
  |FINSI;
  #890acumula = #890acumula + nImporte;
  |GRABA 020#890a;
  |LIBERA #890;
|FPRC;

|PROCESO cargatra_802;  ||Carga Trabajo de Cuentas
  nNumero = 0;
  #802#0  = empresa;
  #802#1  = anyo;
  #802#9  = nCampo2;
  #802#10 = aCampo3;
  #802#11 = nCampo4;
  #802#12 = nCampo5;
  #802#13 = nCampo6;
  #802#14 = nCampo7;
  #802#15 = nCampo8;
  |LEE 101#802=;
  |SI FSalida = 0; |Y #802#8 ! "A";
      #802acumula = #802acumula + nImporte;
      |GRABA 020#802a;
      nNumero = #802#2;
  |FINSI;
  |LIBERA #802;
|FPRC;

|PROCESO LosTotales_802;
  #0#6 = nEjer;   |PINTA #0#6;
  #0#7 = aCuenta; |PINTA #0#7;
  nCampo2 = #422#2;
  aCampo3 = #422#3;
  nCampo4 = #422#4;
  nCampo5 = #422#5;
  nCampo6 = #422#6;
  nCampo7 = #422#7;
  nCampo8 = #422#12;
  nCampo16 = #421#11;

  |HAZ cargatra_802;
  |SI eaICtas = "S"; |Y nNumero ! 0;
      |HAZ DetalleCta_802;
  |FINSI;

  |SI nCampo8 ! 0;    ||Subpartida (A/P = 0)
      nCampo8 = 0;
      |HAZ cargatra_802;
  |FINSI;

  |SI nCampo7 ! 0;   ||Partida
      nCampo8 = 0;
      nCampo7 = 0;
      |HAZ cargatra_802;
  |FINSI;

  saldo = (saldo + nImporte) ! 2;

/*
  |SI nCampo6 ! 0;   ||Epigrafe
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      |HAZ cargatra_802;
  |FINSI;

  |SI nCampo5 ! 0;  ||Subagrupacion
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      nCampo5 = 0;
      |HAZ cargatra_802;
  |FINSI;

  |SI nCampo4 ! 0;  ||Agrupacion
      nCampo8 = 0;
      nCampo7 = 0;
      nCampo6 = 0;
      nCampo5 = 0;
      nCampo4 = 0;
      |HAZ cargatra_802;
  |FINSI;

  |SI aCampo3 = "A";
      activo = (activo + nImporte) ! EURODB;
  |SINO;
      pasivo = (pasivo + nImporte) ! EURODB;
  |FINSI;
*/
|FPRC;

|PROCESO LeoTotales;
 |SI #802#8 = "C";
     nImporte = nImporte + #802acumula;
 |FINSI;
|FPRC;

|DEFBUCLE LeoTotales;
 #802#2;
 ;
 empresa,anyo, nCampo2, aCampo3, nCampo4, 0, 00, 00,0;
 empresa,anyo, nCampo2, aCampo3, nCampo4, 0, 99, 99,9;
 ;
 NULL, LeoTotales;
|FIN;

|PROCESO elTotal;

  |SI #421#8 = "A"; |ACABA; |FINSI;

  nImporte = 0;
  nCampo2 = #421#2;  ||Bloque
  aCampo3 = #421#3;  ||Tipo
  nCampo4 = #421#4;  ||Agrupacion
  nCampo5 = #421#5;  ||Subagrupacion
  |SI nCampo2 = 5; |Y nCampo5 = 1;
      nImpB1 = nImporte1; nImporte1 = 0;
      nImpB2 = nImporte2; nImporte2 = 0;
      nImpB3 = nImporte3; nImporte3 = 0;
      nImpB4 = nImporte4; nImporte4 = 0;
      nImpB5 = nImporte5; nImporte5 = 0;
      nImpB6 = nImporte6; nImporte6 = 0;
      nImpB7 = nImporte7; nImporte7 = 0;
      nImpB8 = nImporte8; nImporte8 = 0;
      nImpB9 = nImporte9; nImporte9 = 0;
 |FINSI;

  |SI nCampo5 ! 3;
      |BUCLE LeoTotales;
  |FINSI;
  |SI nCampo5 = 3;
      nImporte = nImporte1 + nImporte2;
  |FINSI;
  |SI nCampo5 = 4;
      nImporte = nImporte + nImporte3;
      |SI nCampo2 = 5;  nImporte = nImporte + nImpB4; |FINSI;
  |FINSI;
  |SI nCampo5 = 5;
      nImporte = nImporte + nImporte4;
  |FINSI;
  |SI nCampo5 = 6;
      nImporte = nImporte + nImporte5;
  |FINSI;
  |SI nCampo5 = 7;
      nImporte = nImporte + nImporte6;
  |FINSI;
  |SI nCampo5 = 8;
      nImporte = nImporte + nImporte7;
  |FINSI;
  |SI nCampo5 = 9;
      nImporte = nImporte + nImporte8;
  |FINSI;

  |ABRE #802;
  |SELECT #2#802;
  nCampo6 = 0;
  nCampo7 = 0;
  nCampo8 = 0;
  |HAZ cargatra_802;
  |SELECT #1#802;
  |CIERRA #802;
  |SI nCampo5 = 1; nImporte1 = nImporte; |FINSI;
  |SI nCampo5 = 2; nImporte2 = nImporte; |FINSI;
  |SI nCampo5 = 3; nImporte3 = nImporte; |FINSI;
  |SI nCampo5 = 4; nImporte4 = nImporte; |FINSI;
  |SI nCampo5 = 5; nImporte5 = nImporte; |FINSI;
  |SI nCampo5 = 6; nImporte6 = nImporte; |FINSI;
  |SI nCampo5 = 7; nImporte7 = nImporte; |FINSI;
  |SI nCampo5 = 8; nImporte8 = nImporte; |FINSI;
  |SI nCampo5 = 9; nImporte9 = nImporte; |FINSI;
|FPRC;

|DEFBUCLE elTotal;
 #421#1;
 ;
 enEjerBal, nCtaNum, nBalance, 1, "R", 00, 1, 00, 00, 0;
 enEjerBal, nCtaNum, nBalance, 5, "R", 99, 9, 00, 00, 0;
 e;
 NULL, elTotal;
|FIN;

|PROCESO ElCalculoFinal;
 |SI #0#3 = "SI";
     nImpB1 = 0; nImporte1 = 0;
     nImpB2 = 0; nImporte2 = 0;
     nImpB3 = 0; nImporte3 = 0;
     nImpB4 = 0; nImporte4 = 0;
     nImpB5 = 0; nImporte5 = 0;
     nImpB6 = 0; nImporte6 = 0;
     nImpB7 = 0; nImporte7 = 0;
     nImpB8 = 0; nImporte8 = 0;
     nImpB9 = 0; nImporte9 = 0;
     acumula   = 6;
     |BUCLE elTotal;
 |FINSI;
 |SI #0#4 = "SI";
     nImpB1 = 0; nImporte1 = 0;
     nImpB2 = 0; nImporte2 = 0;
     nImpB3 = 0; nImporte3 = 0;
     nImpB4 = 0; nImporte4 = 0;
     nImpB5 = 0; nImporte5 = 0;
     nImpB6 = 0; nImporte6 = 0;
     nImpB7 = 0; nImporte7 = 0;
     nImpB8 = 0; nImporte8 = 0;
     nImpB9 = 0; nImporte9 = 0;
     acumula   = 7;
     |BUCLE elTotal;
 |FINSI;
|FPRC;

|| ***********************************************

|PROCESO grabatra; || grabo todas
  |SI nImporte ! 0;
    nImporte = - nImporte; || (H-D)  IMPORTANTE
    |SI aAPR = "D"; |Y #422#10 = "-"; nImporte = - nImporte; |FINSI;
    |SI aAPR = "G"; |Y #422#10 = "-"; nImporte = - nImporte; |FINSI;
    |SI aAPR = "H"; |Y #422#10 = "+"; nImporte = - nImporte; |FINSI;
    |SI aAPR = "I"; |Y #422#10 = "+"; nImporte = - nImporte; |FINSI;
    |SI #422#11 ! " ";
        |SI #422#11 = "P"; |Y nImporte < 0; |ACABA; |FINSI;
        |SI #422#11 = "N"; |Y nImporte > 0; |ACABA; |FINSI;
    |FINSI;
    |HAZ LosTotales_802;
  |FINSI;
|FPRC;

|PROCESO calculit802;

  aCuenta = #1#3;
  aTitulo = #1#4;
  |HAZ MSigno08_s;

  aAlfa1 = #1#3; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #1#3;
  aTitulo = #1#4;

 |SI aLucratP ! "S";
      |SI #0#2 = "A";
          nImporte = #1#8;
          |SI nImporte !  0;
              |HAZ grabatra; || grabo todas
          |FINSI;
      |SINO;
          |SI #0#4 = "SI";
              acumula  = 7;
              nImporte = #1#8;
              |SI nImporte ! 0;
                  |HAZ grabatra;
              |FINSI;
          |FINSI;
          |SI #0#3 = "SI";
              acumula  = 6;
              nImporte = #1#9;
              |SI nImporte ! 0;
                  |HAZ grabatra;
              |FINSI;
          |FINSI;
      |FINSI;
  |SINO;
      |SI #0#2 = "A";
          aAlfa1 = aCuenta % 103;
          |SI swImp = 1;  nImporte = #1#8;        |FINSI;
          |SI swImp = 2;  nImporte = #1#6 - #1#7; |FINSI;
          |SI swImp ] 3;
              |SI swImp = 3; #1#7 = 0; |FINSI;  ||solo debe
              |SI swImp = 4; #1#6 = 0; |FINSI;  ||solo haber
              nImporte = #1#6 - #1#7;
          |FINSI;
          |SI aAlfa1 = "129";
               nImporte = nImporte - #2#6;
          |FINSI;
          |SI nImporte !  0;
              |HAZ grabatra; || grabo todas
          |FINSI;
      |SINO;
          |SI #0#4 = "SI";
              acumula = 7;
              |SI swImp = 1; nImporte = #1#8; |FINSI;
              |SI swImp = 2; nImporte = #1#6 - #1#7; |FINSI;
              |SI swImp ] 3;
                  |SI swImp = 3; #1#7 = 0; |FINSI;  ||solo debe
                  |SI swImp = 4; #1#6 = 0; |FINSI;  ||solo haber
                  nImporte = #1#6 - #1#7;
              |FINSI;
              |SI nImporte !  0;
                  |HAZ grabatra; || grabo todas
              |FINSI;
          |FINSI;
          |SI #0#3 = "SI";
              nImporte = #1#9;
              |SI swImp = 3; |Y nImporte < 0; nImporte = 0; |FINSI;
              |SI swImp = 4; |Y nImporte > 0; nImporte = 0; |FINSI;
              acumula = 6;
              |SI nImporte !  0;
                  |HAZ grabatra; || grabo todas
              |FINSI;
         |FINSI;
       |FINSI;

  |FINSI;
|FPRC;

|DEFBUCLE cabasitu802;
 #1#2;
 ;
 empresa, nEjer, aDCta;
 empresa, nEjer, aHCta;
 e;
 NULL,calculit802;
|FIN;

|PROCESO calculit2_2;
  aCuenta = #3#0;
  |HAZ MSigno08_s;

  aAlfa1 = #3#0; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #3#0;

  acumula = 6;
  nImporte = #3#2;
  |SI nImporte !  0;
      |HAZ grabatra; || grabo todas
  |FINSI;
|FPRC;

|DEFBUCLE AuxEquival2;  ||para el ejer. 2008 equivalencia
 #3#1;
 ;
 anyo, aDCta;
 anyo, aHCta;
 e;
 NULL,calculit2_2;
|FIN;

|PROCESO calculit_802;
 aAlfa1 = #422#9; |QBF aAlfa1;
 aDCta = (aAlfa1 + "            ") % 112;
 aHCta = (aAlfa1 + "zzzzzzzzzzzz") % 112;
 swImp = #422#13;

 |SI #0#2 = "A";
     |SI #0#3 = "SI";
         acumula = 6;
         |SI anyo ! 2008;    || lee el balance del ejercicio anterior
             nEjer   = anyo - 1;
             |BUCLE cabasitu802;
         |SINO;
             |BUCLE AuxEquival2;  ||para el ejer. 2008 equivalencia
         |FINSI;
     |FINSI;
     |SI #0#4 = "SI";        || lee balance del ejercicio
         acumula = 7;
         nEjer = anyo;
         |BUCLE cabasitu802;
     |FINSI;
 |SINO;
      nEjer = anyo;
      |BUCLE cabasitu802;
 |FINSI;
|FPRC;

|DEFBUCLE cabasitu4_802;
 #422#1;
 ;
 enEjerBal, nCtaNum, nBalance, 1, "R", 00, 0, 00, 00, 0, 001;
 enEjerBal, nCtaNum, nBalance, 5, "R", 99, 9, 99, 99, 9, 999;
 e;
 NULL,calculit_802;
|FIN;

|PROCESO PaseResultado;
  aFichero = "y" + Usuario;
  |NOME_DAT #3 aFichero;

  activo = 0; activ1 = 0;
  pasivo = 0; pasiv1 = 0;

  |SI PARAMETRO = "";
      |ATRI I; |PINTA 1747, "Cuenta de Resultados    "; |ATRI 0;
  |FINSI;

  |ABRE #2;
  |DDEFECTO #2;
  #2#0 = empresa;
  #2#1 = anyo;
  |LEE 040#2=;
  |CIERRA #2;

  |ABRE #802;
  |ABRE #890;
  |SELECT #2#802;
  |BUCLE cabasitu4_802;
  |SELECT #1#802;
  |CIERRA #890;
  |CIERRA #802;

  |HAZ ElCalculoFinal;
|FPRC;
