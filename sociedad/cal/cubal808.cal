|FICHEROS;
     cubal808 #0;

     cuacceso #100;

     cubal801 #801;
     cubal802 #802;
     cubal803 #803;
     cubal804 #804;
     cubal805 #805;
     cubal8v4 #814;

     :/agicont/def/ca8m0000 #420;
     :/agicont/def/ca8m0001 #421;
     soda8m01 #401;
     soda8m02 #432;

     referen0@  #900;
     referen1@  #901;
|FIN;

|VARIABLES;
     &enSwCero= 0;
     &empresa = 0;
     &anyo    = 0;
     &acabalo = 0;
     x        = 0;
     y        = 0;

     aBase     = "";
     aDef1     = "";
     aDef2     = "";
     aFichero1 = "";
     aFichero2 = "";
     nError    = 0;
     anyo1     = 0;
     nCampo0   = 0;
     nCampo1   = 0;
     nCampo2   = 0;
     aCampo3   = "";
     nCampo4   = 0;
     nCampo5   = 0;
     nCampo6   = 0;
     nCampo7   = 0;
     nCampo8   = 0;
     nSi       = 0;
     aAlfa1    = "";
     aAlfa2    = "";
     aAlfa3    = "";
     aAlfa4    = "";
     aAlfa5    = "";
     nNume1    = 0;
     nNume2    = 0;
     nPara1    = 0;
     nLinea    = 0;
     aLetra    = "";

     nBalNumA  = 0;
     nCtaNumA  = 0;
     nTBalA    = 0;
     nTCtaA    = 0;
     nSeguir   = 0;
|FIN;

|INCLUYE varbal_i;

|| ***********************************************************************
|PROCESO CargarAuxiliar;

     nError = 0;
     |DBASE aBase;   |QBF aBase;
     aDef1 = aBase + "def/" + aFichero1;
     |CARGA_DEF aDef1, referen0@;
     |SI FSalida ! 0;
         aDef1  = "";
         nError = 1;
     |FINSI;

     |SI aFichero2 ! "";
         aDef2 = aBase + "def/" + aFichero2;
         |CARGA_DEF aDef2, referen1@;
         |SI FSalida ! 0;
             aDef2  = "";
             nError = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Descargar;
     |SI aDef2 ! ""; |DESCARGA_DEF #referen1@; aDef2 = ""; |FINSI;
     |SI aDef1 ! ""; |DESCARGA_DEF #referen0@; aDef1 = ""; |FINSI;
|FPRC;

|PROCESO Leo421;
 nSi = 0;
 #421#14 = enEjerBal;
 #421#0  = nCampo0;
 #421#1  = nCampo1;
 #421#2  = nCampo2
 #421#3  = aCampo3;
 #421#4  = nCampo4;
 #421#5  = nCampo5;
 #421#6  = nCampo6;
 #421#7  = nCampo7;
 #421#10 = nCampo8;
 |LEE 040#421=;
 |SI FSalida = 0; nSi = 1; |FINSI;
|FPRC;

|PROCESO Leo432;
 nSi = 0;
 #432#34 = enEjerBal;
 #432#0  = nCampo0;
 #432#1  = nCampo1;
 |LEE 040#432=;
 |SI FSalida = 0; nSi = 1; |FINSI;
|FPRC;

|PROCESO PonaCero801;
  nCampo0 = nBalNum;
  nCampo1 = 0;
  nCampo2 = #801#9;
  aCampo3 = #801#10;
  nCampo4 = #801#11;
  nCampo5 = #801#12;
  nCampo6 = #801#13;
  nCampo7 = #801#14;
  nCampo8 = #801#15;
  |HAZ Leo421;
  |SI nSi = 1;
      #801#3  = #421#9;
      #801#8  = #421#8;
      #801#16 = #421#11;
      #801#17 = #421#12;
  |FINSI;
  #801#6 = 0;
  |GRABA 020#801a;
  |LIBERA #801;
|FPRC;

|DEFBUCLE PonaCero801;
 #801#1;
 ;
 empresa,anyo, 0001;
 empresa,anyo, 9999;
 be;
 NULL, PonaCero801;
|FIN;

|PROCESO PonaCero802;
  nCampo0 = nCtaNum;
  nCampo1 = 1;
  nCampo2 = #802#9;
  aCampo3 = #802#10;
  nCampo4 = #802#11;
  nCampo5 = #802#12;
  nCampo6 = #802#13;
  nCampo7 = #802#14;
  nCampo8 = #802#15;
  |HAZ Leo421;
  |SI nSi = 1;
      #802#3  = #421#9;
      #802#8  = #421#8;
      #802#16 = #421#11;
      #802#17 = #421#12;
  |FINSI;
  #802#6 = 0;
  |GRABA 020#802a;
  |LIBERA #802;
|FPRC;

|DEFBUCLE PonaCero802;
 #802#1;
 ;
 empresa,anyo, 0001;
 empresa,anyo, 9999;
 be;
 NULL, PonaCero802;
|FIN;

|PROCESO PonaCero803;
  nCampo0 = nBalNum;
  nCampo1 = 2;
  nCampo2 = #803#9;
  aCampo3 = #803#10;
  nCampo4 = #803#11;
  nCampo5 = #803#12;
  nCampo6 = #803#13;
  nCampo7 = #803#14;
  nCampo8 = #803#15;
  |HAZ Leo421;
  |SI nSi = 1;
      #803#3  = #421#9;
      #803#8  = #421#8;
      #803#16 = #421#11;
      #803#17 = #421#12;
  |FINSI;
  #803#6 = 0;
  |GRABA 020#803a;
  |LIBERA #803;
|FPRC;

|DEFBUCLE PonaCero803;
 #803#1;
 ;
 empresa,anyo, 0001;
 empresa,anyo, 9999;
 be;
 NULL, PonaCero803;
|FIN;

|PROCESO PonaCero805;
  nCampo0 = nBalNum;
  nCampo1 = 4;
  nCampo2 = #805#9;
  aCampo3 = #805#10;
  nCampo4 = #805#11;
  nCampo5 = #805#12;
  nCampo6 = #805#13;
  nCampo7 = #805#14;
  nCampo8 = #805#15;
  |HAZ Leo421;
  |SI nSi = 1;
      #805#3  = #421#9;
      #805#8  = #421#8;
      #805#16 = #421#11;
      #805#17 = #421#12;
  |FINSI;
  #805#6 = 0;
  |GRABA 020#805a;
  |LIBERA #805;
|FPRC;

|DEFBUCLE PonaCero805;
 #805#1;
 ;
 empresa, anyo, 0001;
 empresa, anyo, 9999;
 be;
 NULL, PonaCero805;
|FIN;

|PROCESO BorraVariacion;
  |BORRA  020#814a;
  |LIBERA #814;
|FPRC;

|DEFBUCLE BorraVariacion;
 #814#2;
 ;
 empresa,anyo, #804#2, 01;
 empresa,anyo, #804#2, 99;
 be;
 NULL, BorraVariacion;
|FIN;

|PROCESO PonaCero804;
  nCampo0 = nBalNum;
  nCampo1 = #804#2;
  |HAZ Leo432;
  |SI nSi = 1;
      #804#3 = #432#2;
      #804#4 = #432#3;
      #804#5 = #432#6;
      |HAZ CambioT0;
      #804#43 = #432#21; #804#44 = #432#22; #804#45 = #432#23;
      #804#46 = #432#24; #804#47 = #432#25; #804#48 = #432#26;
      #804#49 = #432#27; #804#50 = #432#28; #804#51 = #432#29;
      #804#52 = #432#30; #804#53 = #432#31; #804#54 = #432#32;
      #804#55 = #432#33;
  |FINSI;
  |SI #432#4 = 1; |O #432#4 = 2;
      |PDEFECTO #804, 6, 43;
      |BUCLE BorraVariacion;
  |FINSI;
  |GRABA 020#804a;
  |LIBERA #804;
|FPRC;

|DEFBUCLE PonaCero804;
 #804#1;
 ;
 empresa,anyo, 001;
 empresa,anyo, 999;
 be;
 NULL, PonaCero804;
|FIN;

|PROCESO CambioT0;

 aAlfa1 = #804#5-"200X";
 |SI aAlfa1 = #804#5; |ACABA; |FINSI;

 aAlfa1 = anyo;
 nNume1 = anyo - 1; aAlfa2 = nNume1;
 nNume1 = anyo - 2; aAlfa3 = nNume1;

 aAlfa4 = #804#5; |QBF aAlfa4;

 aAlfa5 = aAlfa4 - "200X-2 y anter";
 |SI aAlfa4 ! aAlfa5;
     aAlfa4 = aAlfa5 + " " + aAlfa3 + " y anteriores";
 |SINO;
     aAlfa5 = aAlfa4 - "200X-2 y anteriores";
     |SI aAlfa4 ! aAlfa5;
         aAlfa4 = aAlfa5 + " " + aAlfa3 + " y anteriores";
     |SINO;
         aAlfa5 = aAlfa4 - "200X-2";
         |SI aAlfa4 ! aAlfa5;
             aAlfa4 = aAlfa5  + aAlfa3;
         |SINO;
             aAlfa5 = aAlfa4 - "200X-1";
             |SI aAlfa4 ! aAlfa5;
                 aAlfa4 = aAlfa5 + aAlfa2;
             |SINO;
                 aAlfa5 = aAlfa4 - "200X";
                 |SI aAlfa4 ! aAlfa5;
                     aAlfa4 = aAlfa5 + aAlfa1;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;
 #804#5 = aAlfa4;
|FPRC;

|| ***********************************************************************
|| ***********************************************************************
|PROCESO CopioVariacion;

  #814#0 = #804#0;
  #814#1 = #804#1;
  #814#2 = 9999;
  |LEE 001#814];
  |SI FSalida = 0;
      |LEE 040#814a;
  |SINO;
      |LEE 040#814u;
  |FINSI;
  nLinea = 1;
  |SI FSalida = 0; |Y #814#0 = #804#0; |Y #814#1 = #804#1;
      nLinea = #814#2 + 1;
  |FINSI;

  #814#0 = #804#0;
  #814#1 = #804#1;
  #814#2 = nLinea;
  #814#3 = #901#3;
  #814#4 = #804#2;   ||Cambiar linea nueva en el nuevo ejercicio
  #814#5 = #901#5;
  #814#6 = #901#6;
  #814#7 = #901#7;
  #814#8 = #804#3;   ||Nueva Letra
  #814#9 = #804#4;   ||Nueva Casilla
  nNume2 = #901#5 + 42; || Casilla del Impuesto segun Columna
  #814#10 = #804nNume2;
  |GRABA 040#814n;
|FPRC;

|DEFBUCLE CopioVariacion;
 #901#2004;
 ;
 #900#0, #900#1, #900#2, 01;
 #900#0, #900#1, #900#2, 12;
 e;
 NULL, CopioVariacion;
|FIN;

|PROCESO LeeAnyoA804;
     aLetra = "";
     |SI #900#3 = "C"; aLetra = "A"; |FINSI;
     |SI #900#3 = "D"; aLetra = "B"; |FINSI;
     |SI aLetra = ""; |ACABA; |FINSI;

     #804#0 = #900#0;
     #804#1 = anyo;
     #804#3 = aLetra;
     #804#4 = #900#4;
     |LEE 101#804=;
     |SI FSalida = 0;
         |PARA nPara1 = 6; |SI nPara1 [ 42; |HACIENDO nPara1 = nPara1 + 1;
               #804nPara1 = #900nPara1;
         |SIGUE;
         |GRABA 020#804a;
         |BUCLE CopioVariacion;
    |FINSI;
    |LIBERA #804;
|FPRC;

|DEFBUCLE LeeAnyoA804;
  #900#1003;
  3;
  empresa, anyo1, 000, "C";
  empresa, anyo1, 999, "D";
  e;
  NULL, LeeAnyoA804;
|FIN;

|PROCESO LeeAnyoA804_n2;
     aLetra = "";
     |SI #900#3 = "A"; aLetra = "A"; |FINSI;
     |SI #900#3 = "B"; aLetra = "A"; |FINSI;
     |SI aLetra = ""; |ACABA; |FINSI;

     #804#0 = #900#0;
     #804#1 = anyo;
     #804#3 = "A";
     #804#4 = 511;
     |LEE 101#804=;
     |SI FSalida = 0;
         |BUCLE CopioVariacion;
    |FINSI;
    |LIBERA #804;
|FPRC;

|DEFBUCLE LeeAnyoA804_n2;
  #900#1003;
  3;
  empresa, anyo1, 000, "A";
  empresa, anyo1, 999, "B";
  e;
  NULL, LeeAnyoA804_n2;
|FIN;
|| ***********************************************************************

|PROCESO LeeAnyoAnterior;
     |SI nBalance = 0;
         #801#0 = #900#0;
         #801#1 = anyo;
         #801#16 = #900#16;
         |LEE 101#801=;
         |SI FSalida = 0;
             #801#6 = #900#7;
             |SI #0#1 = "S"; #801#5 = #900#5; |FINSI;
             |GRABA 020#801a;
         |FINSI;
         |LIBERA #801;
     |FINSI;

     |SI nBalance = 1;
         #802#0 = #900#0;
         #802#1 = anyo;
         #802#16 = #900#16;
         |LEE 101#802=;
         |SI FSalida = 0;
             #802#6 = #900#7;
             |SI #0#1 = "S"; #802#5 = #900#5; |FINSI;
             |GRABA 020#802a;
             |LIBERA #802;
         |FINSI;
     |FINSI;

     |SI nBalance = 2;
         #803#0 = #900#0;
         #803#1 = anyo;
         #803#16 = #900#16;
         |LEE 101#803=;
         |SI FSalida = 0;
             #803#6 = #900#7;
             |SI #0#1 = "S"; #803#5 = #900#5; |FINSI;
             |GRABA 020#803a;
             |LIBERA #803;
         |FINSI;
     |FINSI;

     |SI nBalance = 4;
         #805#0 = #900#0;
         #805#1 = anyo;
         #805#16 = #900#16;
         |LEE 101#805=;
         |SI FSalida = 0;
             #805#6 = #900#7;
             |SI #0#1 = "S"; #805#5 = #900#5; |FINSI;
             |GRABA 020#805a;
         |FINSI;
         |LIBERA #805;
     |FINSI;
|FPRC;

|DEFBUCLE LeeAnyoAnterior;
  #900#3003;
  ;
  empresa, anyo1, 000000;
  empresa, anyo1, 999999;
  e;
  NULL, LeeAnyoAnterior;
|FIN;

|PROCESO Traspaso;

     |HAZ CargarAuxiliar;
     |SI nError = 1;
         |MENAV "    Error Cargando Def";
         |HAZ Descargar;
         |ACABA;
     |FINSI;

     |SI nBalance ! 3;
         |ABRE #801; |SELECT #3#801;
         |ABRE #802; |SELECT #3#802;
         |ABRE #803; |SELECT #3#803;
         |ABRE #805; |SELECT #3#805;
         |BUCLE LeeAnyoAnterior;
         |SELECT #1#805; |CIERRA #805;
         |SELECT #1#803; |CIERRA #803;
         |SELECT #1#802; |CIERRA #802;
         |SELECT #1#801; |CIERRA #801;
     |FINSI;

     |SI nBalance = 3;
         |ABRE #814;
         |ABRE #804;
         |SELECT #2#804;
         |BUCLE LeeAnyoA804_n2;
         |BUCLE LeeAnyoA804;
         |SELECT #1#804;
         |CIERRA #814;
         |CIERRA #804;
         enSwCero = 1;
         |HAZ ElCalFinal804;
     |FINSI;

     |HAZ Descargar;
|FPRC;

|PROCESO pase;

     anyo1 = anyo - 1;

     |ABRE #100;
     #100#0 = empresa;
     #100#1 = anyo1;
     |LEE 000#100=;
     |SI FSalida ! 0;
         |SI acabalo = 0; |MENAV "    NO EXISTE DATOS  DEL EJERCICIO ANTERIOR. Proceso abortado"; |FINSI;
         |CIERRA #100;
         |ACABA;
     |FINSI;

     |ABRE #420;
     |DDEFECTO #420;
     #420#0 = #100#15;
     |LEE 000#420=;
     nBalNumA = #100#15;
     nTBalA   = #420#2;

     |DDEFECTO #420;
     #420#0 = #100#16;
     |LEE 000#420=;
     nCtaNumA = #100#16;
     nTCtaA   = #420#2;
     |CIERRA #420;

     #100#0 = empresa;
     #100#1 = anyo;
     |LEE 000#100=;
     |SI FSalida ! 0;  |DDEFECTO #100;  |FINSI;
     |CIERRA #100;

     |SI nBalNum ! nBalNumA; |O nCtaNum ! nCtaNumA;
         nSeguir = 0;
         |SI nTBalA ! enTBal;
             |SI nTBalA = 3; |O enTBal = 3;
                 nSeguir = 1;
             |FINSI;
         |FINSI;
         |SI nTCtaA ! enTCta;
             |SI nTCtaA = 3; |O enTCta = 3;
                 nSeguir = 1;
             |FINSI;
         |FINSI;
         |SI acabalo = 0; |Y nSeguir = 1;
             |MENAV "    NO SON LOS MISMO BALANCES DEL A¥O ANTERIOR. Proceso abortado";
         |FINSI;
         |SI nSeguir = 1; |ACABA; |FINSI;
     |FINSI;

|| .... Balance de Situacion
     nBalance = 0;
     |ABRE #801;
     #801#0 = empresa;
     #801#1 = anyo;
     #801#2 = 00000;
     |LEE 001#801];
     |SI FSalida ! 0; |O #801#0 ! empresa; |O #801#1 ! anyo;
        |CIERRA #801;
        |HAZ eCrearVacio;
     |SINO;
        |CIERRA #801;
        |ABRE #421;
        |BUCLE PonaCero801;
        |CIERRA #421;
     |FINSI;
     nBalance = 0;
     aFichero1 = "cubal801";
     aFichero2 = "";
     |HAZ Traspaso;

|| .... Balance de Cuenta de Resultado
     nBalance = 1;
     |ABRE #802;
     #802#0 = empresa;
     #802#1 = anyo;
     #802#2 = 00000;
     |LEE 001#802];
     |SI FSalida ! 0; |O #802#0 ! empresa; |O #802#1 ! anyo;
        |CIERRA #802;
        |HAZ eCrearVacio;
     |SINO;
        |CIERRA #802;
        |ABRE #421;
        |BUCLE PonaCero802;
        |CIERRA #421;
     |FINSI;
     nBalance = 1;
     aFichero1 = "cubal802";
     aFichero2 = "";
     |HAZ Traspaso;

|| .... Ingresos y Gastos
     |SI enTBal = 1; |O enTBal = 2;    ||Normal o abreviado
         nBalance = 2;
         |ABRE #803;
         #803#0 = empresa;
         #803#1 = anyo;
         #803#2 = 00000;
         |LEE 001#803];
         |SI FSalida ! 0; |O #803#0 ! empresa; |O #803#1 ! anyo;
             |CIERRA #803;
             |HAZ eCrearVacio;
         |SINO;
             |CIERRA #803;
             |ABRE #421;
             |BUCLE PonaCero803;
             |CIERRA #421;
         |FINSI;

         nBalance = 2;
         aFichero1 = "cubal803";
         aFichero2 = "";
         |HAZ Traspaso;
    |FINSI;

|| .... Estado de Cambios del Patrimonio Neto
     |ABRE #804;
     #804#0 = empresa;
     #804#1 = anyo;
     #804#2 = 000;
     |LEE 001#804];
     |SI FSalida ! 0; |O #804#0 ! empresa; |O #804#1 ! anyo;
         |CIERRA #804;
         nBalance = 3;
         |HAZ eCrearVacio;
     |SINO;
         |CIERRA #804;
         |ABRE #432;
         |BUCLE PonaCero804;
         |CIERRA #432;
     |FINSI;

     nBalance = 3;
     aFichero1 = "cubal804";
     aFichero2 = "cubal8v4";
     |HAZ Traspaso;

|| .... Flujo de Efectivos
     |SI enTBal = 1;
         nBalance = 4;
         |ABRE #805;
         #805#0 = empresa;
         #805#1 = anyo;
         #805#2 = 00000;
         |LEE 001#805];
         |SI FSalida ! 0; |O #805#0 ! empresa; |O #805#1 ! anyo;
             |CIERRA #805;
             |HAZ eCrearVacio;
         |SINO;
             |CIERRA #805;
             |ABRE #421;
             |BUCLE PonaCero805;
             |CIERRA #421;
         |FINSI;
         nBalance = 4;
         aFichero1 = "cubal805";
         aFichero2 = "";
         |HAZ Traspaso;
     |FINSI;
|FPRC;

|PROGRAMA;
     |PINPA #0#0;
     |SI acabalo = 0;
         |ENDATOS #1#0;
         |SI FSalida = 0;
             |SI #0#0 = "SI"; |HAZ pase; |FINSI;
         |FINSI;
     |SINO;
         |HAZ pase;
     |FINSI;
|FPRO;
