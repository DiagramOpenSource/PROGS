|FICHEROS;
     isom0000;
     isom0001;
     isom0009;
     isom0507;

     maempr10;
     maempr11;

     isow0014,MANTE;
|FIN;

|VARIABLES;
      nRango         = 0;
      nBotonSal      = 0;
      nBotonAnota    = -1;
      nBotonPorce    = -1;
      nTree          = 0;
      nHandle        = 0;
      nPanta         = 0;
      nBotonLabel    = 0;
      nVentana       = 0;
      nVent          = 0;
      nGrid          = 0;
      nModo          = 0;
      nLinea         = 0;
      nBase          = 0;
      nBase1         = 0;
      nCas550        = 0;
      nCas545        = 0;
      nCas1032       = 0;
      nPorce         = 0;
      nVal           = 0;
      nDiasAnyo      = 0;
      nDias          = 0;
      nOk            = 0;

      aContenido     = "";
      aTexto         = "";
      aBase          = "";
      aAlfa          = "";
      aAbre          = "";
      aEsc1          = "";
      aEsc2          = "";
      aRetu          = "";
      aTecla         = "";

      fFecha1        = @;
      fFecha2        = @;

     {-1}sTree       = 0;
     sT_nID          = 0;
     sT_nOper        = 0;
     sT_aData        = "";

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     &enEmpresa      = 0;
     &enAnyo         = 0;
     &enVal1509      = 0;
     &eaCasilla      = "";
     &eaTitCasilla   = "";
     &eaRutaOrigen   = "";
     &eaRutaDestino  = "";
     &eaFicheroTra   = "";
     &eaFicheroTxt   = "";
     &eaFicheroTgz   = "";
     &eaFicheroTar   = "";
     &eaOrigen       = "";
     &eaDestino      = "";
     &eaAlfa         = "";
     &eaTipoColor    = "";
     &eaColor        = "";
     &enModoConsulta = 0;
|FIN;

|PROCESO Tipo12;  |TIPO 12;
|FPRC;

|PROCESO Tipo1;  |TIPO 1;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;  |O nModo = 3;
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo7C8m9;  |TIPO 7;
     |SI #isom0009#7 = "     ";
         |ACABA;
     |FINSI;

     |SI #isom0009#6 < nBase;
         #isom0009#8 = #isom0009#6;
     |SINO;
         #isom0009#8 = nBase;
     |FINSI;

     |PINTA #isom0009#8;
|FPRC;

|PROCESO Tipo0C8m9;  |TIPO 0;
     |SI #isom0009#8 > nBase;
         |SI enAnyo [ 2014;
             |MENAV "0000 Lo aplicado supera a la casilla 550";
         |SINO;
             |MENAV "0000 Lo aplicado supera a la casilla (550) menos la (1032)";
         |FINSI;
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Totalm9;
     |SI enModoConsulta = 1;
         |ACABA;
     |FINSI;

     #isom0009#10 = 0;

     |SI #isom0009#7 ! "     ";
         |SI #isom0009#8 > #isom0009#6;  #isom0009#8 = #isom0009#6;   |FINSI;
     |FINSI;

     |SI #isom0009#9 ! "     ";
         #isom0009#10 = #isom0009#6 - #isom0009#8;
     |FINSI;
     |PINTA #isom0009#8;
     |PINTA #isom0009#10;
|FPRC;

|PROCESO Tipo2;  |TIPO 2;
     |HAZ Tipo1;

     nBase = (nBase -. #isom0009#8) ! 2;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     #isom0507#0 = #isom0009#1;
     #isom0507#1 = #isom0009#2;
     |LEE 000#isom0507.=;
     |SI FSalida ! 0;  |DDEFECTO #isom0507;  |FINSI;

     |SI #isom0507#8 ! "I";  |ACABA;  |FINSI;

     |GRABA 020#isom0009.a;
     |LIBERA #isom0009;

     nLinea = #isom0009#2;

     |HAZ TotalFich109;

     #isom0009#0 = #maempr10#0;
     #isom0009#1 = #maempr10#1;
     #isom0009#2 = nLinea;
     |LEE 101#isom0009.=;

     aAlfa = "|IDGRID";
     aAlfa = #isom0009#aAlfa#;
     nGrid = aAlfa;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO Tipo0;  |TIPO 0;
     |C_M #isom0009#6,  1, "N";
     |C_M #isom0009#8,  1, "N";
     |C_M #isom0009#10, 1, "N";

     #isom0507#0 = #isom0009#1;
     #isom0507#1 = #isom0009#2;
     |LEE 000#isom0507.=;
     |SI FSalida ! 0;  |DDEFECTO #isom0507;  |FINSI;

     |SI #isom0507#8 ! "I";  |ACABA;  |FINSI;

     |SI #isom0009#5 ! "     ";  |C_M #isom0009#6,  1, "S";  |FINSI;
     |SI #isom0009#7 ! "     ";  |C_M #isom0009#8,  1, "S";  |FINSI;
     |SI #isom0009#9 ! "     ";  |C_M #isom0009#10, 1, "S";  |FINSI;
|FPRC;

|PROCESO Evento109;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#isom0009.=;
     |FINSI;
|FPRC;

|PROCESO isom0507;
     #isom0009#0  = enEmpresa;
     #isom0009#1  = #isom0507#0;
     #isom0009#2  = #isom0507#1;
     |LEE 101#isom0009.=;
     |SI FSalida ! 0;
         |DDEFECTO #isom0009;
         #isom0009#0  = enEmpresa;
         #isom0009#1  = #isom0507#0;
         #isom0009#2  = #isom0507#1;
         |GRABA 020#isom0009.b;
     |FINSI;

     #isom0009#3  = #isom0507#7;
     #isom0009#4  = #isom0507#2;
     #isom0009#5  = #isom0507#4;
     #isom0009#7  = #isom0507#5;
     #isom0009#9  = #isom0507#6;

     eaTipoColor = #isom0507#9;
     |HAZ CogeColor;
     #isom0009#11     = eaColor;

     |GRABA 020#isom0009.a;
     |LIBERA #isom0009;
|FPRC;

|DEFBUCLE isom0507;
     #isom0507#1;
     ;
     enAnyo, 0000;
     enAnyo, 0999;     || Del 1 al 999 es el isom0009
     ;
     NULL, isom0507;
|FIN;

|PROCESO MontaEstructura507;
     |BUCLE isom0507;
|FPRC;

|PROCESO isom0009;
     |SI #isom0009#6  ! 0;  |ACABA;  |FINSI;
     |SI #isom0009#8  ! 0;  |ACABA;  |FINSI;
     |SI #isom0009#10 ! 0;  |ACABA;  |FINSI;

     |BORRA 020#isom0009.a;
     |LIBERA #isom0009;
|FPRC;

|DEFBUCLE isom0009;
     #isom0009#1;
     ;
     enEmpresa, enAnyo, 0000;
     enEmpresa, enAnyo, 9999;
     be;
     NULL, isom0009;
|FIN;

|PROCESO BotonSalir;
     |PTEC 807;
|FPRC;

|PROCESO BotonAnota;
     eaCasilla    = #isom0009#5;     |QBF eaCasilla;
     eaTitCasilla = #isom0009#3;     |QBF eaTitCasilla;
     eaTitCasilla = eaTitCasilla + " " + #isom0009#4;

     |SUB_EJECUTA "isom0499";

     aAlfa = "|IDGRID";
     aAlfa = #isom0009#aAlfa#;
     nGrid = aAlfa;
     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO Baja109;
     #isom0009#0  = enEmpresa;
     #isom0009#1  = enAnyo;
     #isom0009#2  = 1;
|FPRC;

|PROCESO Alta109;
     #isom0009#0  = enEmpresa;
     #isom0009#1  = enAnyo;
     #isom0009#2  = 9999;
|FPRC;

|PROCESO isom0009R;
     |SI #isom0009#6  = 0;  |ACABA;  |FINSI;

     |SI nBase = 0;
         #isom0009#8  = 0;
         #isom0009#10 = 0;

         |SI #isom0009#9 ! "     ";
             #isom0009#10 = #isom0009#6 - #isom0009#8;
         |FINSI;

         |GRABA 020#isom0009.a;
         |LIBERA #isom0009;
         |ACABA;
     |FINSI;

     nBase1 = nBase1 + #isom0009#8;

     |SI nBase1 > nBase;
         nBase1 = nBase1 - #isom0009#8;
         #isom0009#8 = nBase - nBase1;
         nBase1 = nBase1 + #isom0009#8;

         #isom0009#10 = 0;

         |SI #isom0009#9 ! "     ";
             #isom0009#10 = #isom0009#6 - #isom0009#8;
         |FINSI;

         |GRABA 020#isom0009.a;
         |LIBERA #isom0009;
     |FINSI;
|FPRC;

|DEFBUCLE isom0009R;
     #isom0009#1;
     ;
     enEmpresa, enAnyo, 0000;
     enEmpresa, enAnyo, 9999;
     be;
     NULL, isom0009R;
|FIN;

|PROCESO RecogeBase2015;
     #isom0001#0 = #maempr10#0;
     #isom0001#1 = #maempr10#1;
     #isom0001#3 = "550";
     |LEE 000#isom0001.=;
     |SI FSalida = 0;
         nBase   = #isom0001#5;
         nCas550 = nBase;
     |FINSI;

     nBase = (nBase % nPorce) ! 2;

     #isom0001#0 = #maempr10#0;
     #isom0001#1 = #maempr10#1;
     #isom0001#3 = "1032";
     |LEE 000#isom0001.=;
     |SI FSalida = 0;
         nBase = nBase - #isom0001#5;
     |FINSI;

     |SI nPorce ! 100;  |Y enAnyo ] 2014;
         #isom0001#0 = #maempr10#0;
         #isom0001#1 = #maempr10#1;
         #isom0001#3 = "545";
         |LEE 000#isom0001.=;
         |SI FSalida = 0;
             nBase = nBase - (#isom0001#5 % nPorce) ! 2;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO RecogeBase2016;
     #isom0001#0 = #maempr10#0;
     #isom0001#1 = #maempr10#1;
     #isom0001#3 = "550";
     |LEE 000#isom0001.=;
     |SI FSalida = 0;
         nCas550 = #isom0001#5;
     |FINSI;

     #isom0001#0 = #maempr10#0;
     #isom0001#1 = #maempr10#1;
     #isom0001#3 = "545";
     |LEE 000#isom0001.=;
     |SI FSalida = 0;
         nCas545 = #isom0001#5;
     |FINSI;

     #isom0001#0 = #maempr10#0;
     #isom0001#1 = #maempr10#1;
     #isom0001#3 = "1032";
     |LEE 000#isom0001.=;
     |SI FSalida = 0;
         nCas1032 = #isom0001#5;
     |FINSI;

                        nDiasAnyo = 365;
     |SI enAnyo = 2008; nDiasAnyo = 366;  |FINSI;
     |SI enAnyo = 2012; nDiasAnyo = 366;  |FINSI;
     |SI enAnyo = 2016; nDiasAnyo = 366;  |FINSI;

     fFecha1 = #maempr10#31;
     fFecha2 = #maempr10#32;
     nDias   = (fFecha2 - fFecha1) + 1;

     nBase = ((nCas550 - nCas545 - enVal1509) % nPorce) + (nCas545 + enVal1509);
     |SI nBase [ 1000000;
         nBase = 1000000;
     |FINSI;

     nBase = ((nBase * nDiasAnyo) / nDias) ! 2;

     nVal  = nCas550 - nCas1032;
     |SI nBase > nVal;
         nBase = nVal;
     |FINSI;
|FPRC;

|PROCESO RecogeBase;
     nBase = 0;

     |SI #maempr10#1 [ 2015;
         |HAZ RecogeBase2015;
     |FINSI;

     |SI #maempr10#1 ] 2016;
         |HAZ RecogeBase2016;
     |FINSI;
|FPRC;

|PROCESO TopeCompensa;
     |ABRE #isom0000;
     #isom0000#0 = enEmpresa;
     #isom0000#1 = enAnyo;
     |LEE 000#isom0000.=;
     |SI FSalida ! 0;  |DDEFECTO #isom0000;  |FINSI;
     |CIERRA #isom0000;

     |SI enAnyo [ 2011;
                                   nPorce = 100;
         |SI #isom0000#120 = "2";  nPorce = 75;  |FINSI;
         |SI #isom0000#120 = "3";  nPorce = 50;  |FINSI;
     |FINSI;

     |SI enAnyo ] 2012;
                                   nPorce = 100;
         |SI #isom0000#120 = "2";  nPorce = 50;  |FINSI;
         |SI #isom0000#120 = "3";  nPorce = 25;  |FINSI;
     |FINSI;

     |SI enAnyo = 2016;
                                   nPorce = 60;
         |SI #isom0000#120 = "2";  nPorce = 50;  |FINSI;
         |SI #isom0000#120 = "3";  nPorce = 25;  |FINSI;
     |FINSI;

     |SI enAnyo ] 2017;
                                   nPorce = 70;
         |SI #isom0000#120 = "2";  nPorce = 50;  |FINSI;
         |SI #isom0000#120 = "3";  nPorce = 25;  |FINSI;

         nOk = 0;
         |ABRE #maempr11;

         #maempr11#0 = enEmpresa;
         #maempr11#1 = enAnyo;
         #maempr11#2 = 70;
         |LEE 000#maempr11.=;
         |SI FSalida = 0;  nOk = 1;  |FINSI;

         #maempr11#0 = enEmpresa;
         #maempr11#1 = enAnyo;
         #maempr11#2 = 72;
         |LEE 000#maempr11.=;
         |SI FSalida = 0;  nOk = 1;  |FINSI;

         #maempr11#0 = enEmpresa;
         #maempr11#1 = enAnyo;
         #maempr11#2 = 47;
         |LEE 000#maempr11.=;
         |SI FSalida = 0;  nOk = 1;  |FINSI;

         |CIERRA #maempr11;

         |SI nOk = 1;
             nPorce = 100;
         |FINSI;
     |FINSI;

     |HAZ RecogeBase;

     |SELECT #2#isom0009;
     #isom0009#0 = enEmpresa;
     #isom0009#1 = enAnyo;
     #isom0009#5 = "670";
     |LEE 000#isom0009.=;
     |SI FSalida = 0;
         nBase = (nBase - #isom0009#8) ! 2;
     |FINSI;
     |LIBERA #isom0009;
     |SELECT #1#isom0009;

     |SI nBase < 0;  |O nCas550 [ 0;
         |HAZ RecogeBase;
         |SI nBase < 0;  nBase = 0;  |FINSI;

         nBase1 = 0;  |BUCLE isom0009R;

         |HAZ TotalFich109;

         nBase = 0;
     |FINSI;
|FPRC;

|PROCESO BotonPorce;
     |VENTANA 0501, 1050, -1, 16, "L¡mite compensaci¢n";
     nVentana = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |ABRE #isom0000;
     #isom0000#0 = enEmpresa;
     #isom0000#1 = enAnyo;
     |LEE 101#isom0000.=;
     |SI FSalida ! 0;
         |DDEFECTO #isom0000;
         #isom0000#0 = enEmpresa;
         #isom0000#1 = enAnyo;
         |GRABA 020#isom0000.b;
     |FINSI;

     #isow0014#0  = #isom0000#120;

     |PINPA #0#isow0014;  nPanta = FSalida;

     |SI enAnyo [ 2011;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}}100% (Cifra negocio inferior 20 millones)", 0607, 0649, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 75% (Cifra negocio entre 20 y 60 millones)", 0707, 0749, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 50% (Cifra negocio mayor de 60 millones)", 0807, 0849, NULL;
     |FINSI;

     |SI enAnyo ] 2012;  |Y enAnyo [ 2015;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}}100% (Cifra negocio inferior 20 millones)", 0607, 0649, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 50% (Cifra negocio entre 20 y 60 millones)", 0707, 0749, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 25% (Cifra negocio mayor de 60 millones)", 0807, 0849, NULL;
     |FINSI;

     |SI enAnyo = 2016;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 60% (Cifra negocio inferior 20 millones)", 0607, 0649, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 50% (Cifra negocio entre 20 y 60 millones)", 0707, 0749, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 25% (Cifra negocio mayor de 60 millones)", 0807, 0849, NULL;
     |FINSI;

     |SI enAnyo ] 2017;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 70% (Cifra negocio inferior 20 millones)", 0607, 0649, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 50% (Cifra negocio entre 20 y 60 millones)", 0707, 0749, NULL;
         |CONTROL_SIMPLE nPanta, "LABEL,{{16}} 25% (Cifra negocio mayor de 60 millones)", 0807, 0849, NULL;
     |FINSI;

     |PINDA #0#isow0014;
     |ENDATOS #1#isow0014;
     |SI FSalida = 0;
         #isom0000#120  = #isow0014#0;

         |GRABA 020#isom0000.a;
     |FINSI;

     |LIBERA #isom0000;
     |CIERRA #isom0000;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentana;

     |HAZ TopeCompensa;

     aAlfa = "|IDGRID";
     aAlfa = #isom0009#aAlfa#;
     nGrid = aAlfa;
     |REFRESCACONTROL nGrid;
     |FOCOTECLADO nGrid;
|FPRC;

|PROGRAMA;
     |ABRE #maempr10;
     #maempr10#0 = enEmpresa;
     #maempr10#1 = enAnyo;
     |LEE 000#maempr10.=;
     |SI FSalida ! 0;  |DDEFECTO #maempr10;  |FINSI;
     |CIERRA #maempr10;

     |HAZ MontaEstructura507;

     |HAZ TopeCompensa;

     #isom0009#0 = enEmpresa;
     #isom0009#1 = enAnyo;
     #isom0009#2 = 5;
     |LEE 000#isom0009.];

     |PINPA #0#isom0009;

     |CONTROL_SIMPLE 0, "BOTON,{{197}} sali&R", 3488, 3498, BotonSalir;
     nBotonSal = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}} a&Notaciones de la compesaci¢n", 3302, 3425, BotonAnota;
     nBotonAnota = FSalida;

     |SI enAnyo ] 2011;  |Y enAnyo [ 2014;
         |CONTROL_SIMPLE 0, "BOTON,{{197}} &Limite de la compesaci¢n", 3328, 3451, BotonPorce;
         nBotonPorce = FSalida;
     |FINSI;

     |SI enModoConsulta = 0;
         nRango = 1 + 2 + 4 + 8 + 16 + 128 + 256;
     |SINO;
         nRango = 4 + 8 + 16 + 128 + 256;
     |FINSI;

     |LINEAL_SIMPLE #1#isom0009, nRango, 0502, 3498, Baja109, Alta109, Evento109;

     |FIN_CONTROL_WINDOWS nBotonSal;
     |FIN_CONTROL_WINDOWS nBotonAnota;

     |BUCLE isom0009;

     |PULSATECLA;
|FPRO;

|PROCESO Tipo80m9;  |TIPO 80;
     |ABRET #isom0009;
     |ABRET #isom0507;
     |ABRE #isom0001;  |SELECT #2#isom0001;

     FSalida = 3499;
|FPRC;

|PROCESO Tipo90m9;  |TIPO 90;
     |CIERRAT #isom0009;
     |CIERRAT #isom0507;
     |CIERRA #isom0001;  |SELECT #1#isom0001;
|FPRC;
