|FICHEROS;
    cubal800 #0;

    sodacoli #1;         || cuentas
    soda8w03 #3;         || Auxiliar
    cubal805 #805;       || Total

    :/agicont/def/ca8cumay #410;  || Control de Balances
    :/agicont/def/ca8m0000 #420;  || Descripcion Numero de Balance
    :/agicont/def/ca8m0001 #421;  || Def Balance Textos
    :/agicont/def/ca8m0002 #422;  || Def Balance Linea Cuentas
|FIN;

|VARIABLES;
    aFichero = "";
     &empresa = 0;
     &anyo    = 0;
     &nombre  = "";
     &nif     = "";
     &unid    = "";
     &tipo    = "";
     &acabalo = 0;

   nImporte = 0;
   nImporte1= 0;
   nImporte2= 0;
   nImporte3= 0;
   nImporte4= 0;
   nImporte5= 0;
   nLong    = 0;
   &aTitulo  = "";
   &aAPR     = "";
   &aCuenta  = "";
   aAlfa1   = "";
   acumula = 0;
   acumul1 = 0;
   nCampo  = 0;
   nCampo2 = 0;
   aCampo3 = "";
   nCampo4 = 0;
   nCampo5 = 0;
   nCampo6 = 0;
   nCampo7 = 0;
   nCampo8 = 0;
   nCampo16 = 0;
   nSI     = 0;
   aDCta   = "";
   aHCta   = "";
   aCtaM   = "";
   nNivel  = 0;
   nCam1  = 0;
   nCam2  = 0;

    activo  = 0;
    pasivo  = 0;
    activ1  = 0;
    pasiv1  = 0;
    saldo   = 0;

   nHay     = 0;
   nDCampo4 = 0;
   nDCampo5 = 0;
   nDCampo6 = 0;
   nDCampo7 = 0;
   nDCampo8 = 0;
   nHCampo4 = 0;
   nHCampo5 = 0;
   nHCampo6 = 0;
   nHCampo7 = 0;
   nHCampo8 = 0;
   nEjer    = 0;
   swImp    = 0;
|FIN;

|INCLUYE varbal_i;

||**************************************
|PROCESO cargatra_805;  ||Carga Trabajo de Cuentas
  #805#0  = empresa;
  #805#1  = anyo;
  #805#9  = nCampo2;
  #805#10 = aCampo3;
  #805#11 = nCampo4;
  #805#12 = nCampo5;
  #805#13 = nCampo6;
  #805#14 = nCampo7;
  #805#15 = nCampo8;
  |LEE 101#805=;
  |SI FSalida = 0; |Y #805#8 ! "A";
      #805acumula = #805acumula + nImporte;
      |GRABA 020#805a;
  |FINSI;
  |LIBERA #805;
|FPRC;

|PROCESO LosTotales_805;
  #0#6 = nEjer;   |PINTA #0#6;
  #0#7 = aCuenta; |PINTA #0#7;

  nCampo2 = #422#2;
  aCampo3 = #422#3;
  nCampo4 = #422#4;
  nCampo5 = #422#5;
  nCampo6 = #422#6;
  nCampo7 = #422#7;
  nCampo8 = #422#12;
  nCampo16 = #421#11;

  |HAZ cargatra_805;

  |SI nCampo8 ! 0;    ||Subpartida (A/P = 0)
      nCampo8 = 0;
      |HAZ cargatra_805;
  |FINSI;

  |SI nCampo7 ! 0;   ||Partida
      nCampo8 = 0;
      nCampo7 = 0;
      |HAZ cargatra_805;
  |FINSI;

  saldo = (saldo + nImporte) ! 2;
|FPRC;


|PROCESO LeoTotales805;
 |SI #805#8 = "C"
     nImporte = nImporte + #805acumula;
 |FINSI;
|FPRC;

|DEFBUCLE LeoTotales805;
 #805#2;
 ;
 empresa,anyo, nCampo2, aCampo3, nDCampo4, 0, 00, 00,0;
 empresa,anyo, nCampo2, aCampo3, nHCampo4, 9, 99, 99,9;
 ;
 NULL, LeoTotales805;
|FIN;

|PROCESO elTotal805;
  |SI #421#8 = "A"; |ACABA; |FINSI;
  nImporte = 0;
  nCampo2 = #421#2;  ||Bloque
  aCampo3 = #421#3;  ||Tipo
  nCampo4 = #421#4;  ||Agrupacion
  nCampo5 = #421#5;  ||Subagrupacion

  nDCampo4 = 00; nHCampo4 = 99;
  |BUCLE LeoTotales805;
  |SI nCampo5 = 5;
      nImporte  = nImporte1  + nImporte2  + nImporte3  + nImporte4;
  |FINSI;

  |SI nCampo5 ! 4;
      |ABRE #805;
      |SELECT #2#805;
      nCampo6 = #421#6;
      nCampo7 = #421#7;
      nCampo8 = #421#10;
      |HAZ cargatra_805;
      |SELECT #1#805;
      |CIERRA #805;
  |FINSI;

  |SI nCampo5 = 1; nImporte1 = nImporte; |FINSI;
  |SI nCampo5 = 2; nImporte2 = nImporte; |FINSI;
  |SI nCampo5 = 3; nImporte3 = nImporte; |FINSI;
  |SI nCampo5 = 4; nImporte4 = nImporte; |FINSI;
  |SI nCampo5 = 5; nImporte5 = nImporte; |FINSI;
|FPRC;

|DEFBUCLE elTotal805;
 #421#1;
 ;
 enEjerBal, nCtaNum, nBalance, 7, " ", 00, 1, 00, 00, 0;
 enEjerBal, nCtaNum, nBalance, 9, "Z", 99, 9, 99, 99, 9;
 e;
 NULL, elTotal805;
|FIN;

|PROCESO ElCalculoFinal805;
|SI #0#3 = "SI";
    acumula   = 6;
    nImporte1 = 0;
    nImporte2 = 0;
    nImporte3 = 0;
    nImporte4 = 0;
    nImporte5 = 0;
    |BUCLE elTotal805;
|FINSI;
|SI #0#4 = "SI";
    acumula   = 7;
    nImporte1 = 0;
    nImporte2 = 0;
    nImporte3 = 0;
    nImporte4 = 0;
    nImporte5 = 0;
    |BUCLE elTotal805;
|FINSI;
|FPRC;

|| ***********************************************

|PROCESO grabatra805; || grabo todas
  |SI nImporte ! 0;
    |SI #422#10 = "-"; nImporte = - nImporte; |FINSI;
    |HAZ LosTotales_805;
  |FINSI;
|FPRC;

|PROCESO calculit805;

  aCuenta = #1#3;
  aTitulo = #1#4;
  |HAZ MSigno08_s;

  aAlfa1 = #1#3; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #1#3;
  aTitulo = #1#4;

  |SI #0#2 = "A";
      |SI swImp = 1; nImporte = #1#8; |FINSI;
      |SI swImp = 2; nImporte = #1#6 - #1#7; |FINSI;
      |SI swImp ] 3;
          |SI swImp = 3; #1#7 = 0; |FINSI;  ||solo debe
          |SI swImp = 4; #1#6 = 0; |FINSI;  ||solo haber
          nImporte = #1#6 - #1#7;
      |FINSI;
      |SI nImporte !  0;
         |HAZ grabatra805; || grabo todas
      |FINSI;
  |SINO;
      |SI #0#4 = "SI";
          acumula = 7;
          |SI swImp = 1; nImporte = #1#8; |FINSI;
          |SI swImp = 2; nImporte = #1#6 - #1#7; |FINSI;
          |SI swImp ] 3;
              |SI swImp = 3; #1#7 = 0; |FINSI;  ||solo debe
              |SI swImp = 4; #1#6 = 0; |FINSI;  ||solo haber
              nImporte = #1#6 - #1#7;
          |FINSI;
          |SI nImporte !  0;
             |HAZ grabatra805; || grabo todas
          |FINSI;
      |FINSI;
      |SI #0#3 = "SI";
          nImporte = #1#9;
          |SI swImp = 3; |Y nImporte < 0; nImporte = 0; |FINSI;
          |SI swImp = 4; |Y nImporte > 0; nImporte = 0; |FINSI;
          acumula = 6;
          |SI nImporte !  0;
             |HAZ grabatra805; || grabo todas
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE cabasitu805;
 #1#2;
 ;
 empresa, nEjer, aDCta;
 empresa, nEjer, aHCta;
 e;
 NULL,calculit805;
|FIN;

|PROCESO calculit2_5;
  aCuenta = #3#0;
  |HAZ MSigno08_s;

  aAlfa1 = #3#0; |QBF aAlfa1;
  aAlfa1 = aAlfa1 % 0;
  nLong  = aAlfa1;
  aCuenta = #3#0;

  acumula = 6;
  nImporte = #3#2;
  |SI nImporte !  0;
      |HAZ grabatra805; || grabo todas
  |FINSI;
|FPRC;

|DEFBUCLE AuxEquival5;  ||para el ejer. 2008 equivalencia
 #3#1;
 ;
 anyo, aDCta;
 anyo, aHCta;
 e;
 NULL,calculit2_5
|FIN;

|PROCESO calculit_805;
 aAlfa1 = #422#9; |QBF aAlfa1;
 aDCta = (aAlfa1 + "            ") % 112;
 aHCta = (aAlfa1 + "zzzzzzzzzzzz") % 112;
 swImp = #422#13;

 |SI #0#2 = "A";
     |SI #0#3 = "SI";
         acumula = 6;
         |SI anyo ! 2008;    || lee el balance del ejercicio anterior
             nEjer   = anyo - 1;
             |BUCLE cabasitu805;
         |SINO;
             |BUCLE AuxEquival5;  ||para el ejer. 2008 equivalencia
         |FINSI;
     |FINSI;
     |SI #0#4 = "SI";        || lee balance del ejercicio
         acumula = 7;
         nEjer = anyo;
         |BUCLE cabasitu805;
     |FINSI;
 |SINO;
     nEjer = anyo;      ||solo lee el balance para los dos ejercicios
     |BUCLE cabasitu805;
 |FINSI;
|FPRC;

|DEFBUCLE cabasitu4_805;
 #422#1;
 ;
 enEjerBal, nBalNum, nBalance, 7, " ", 00, 0, 00, 00, 0, 001;
 enEjerBal, nBalNum, nBalance, 8, "Z", 99, 9, 99, 99, 9, 999;
 e;
 NULL,calculit_805;
|FIN;

|PROCESO PaseFlujoEfectivos;
  aFichero = "y" + Usuario;
  |NOME_DAT #3 aFichero;

  activo = 0; activ1 = 0;
  pasivo = 0; pasiv1 = 0;

  |SI PARAMETRO = "";
      |ATRI I; |PINTA 1747, "Flujos de Efectivo      "; |ATRI 0;
  |FINSI;

  |ABRE #805;
  |SELECT #2#805;
  |BUCLE cabasitu4_805;
  |SELECT #1#805;
  |CIERRA #805;

  |HAZ ElCalculoFinal805;
|FPRC;
