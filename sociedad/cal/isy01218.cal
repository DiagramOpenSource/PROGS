|FICHEROS;
   isy01218 #0;

   ism00003 #1;
   ism00004 #2;
|FIN;

|VARIABLES;
   &EURO = 0;
   &EURODB = 0;
   &EURODV = 0;

   aEnt     = "";
   aDec     = "";
   aAlfa    = "";
   aAlfa1   = "";
   aAlfa2   = "";
   aDirec   = "";
   aFich    = "";
   aVacio   = "";
   aCaracter = "";
   aTipo    = "";
   aCadena  = "";
   aLong    = "";
   aDirOri  = "";
   aDirDes  = "";
   aOrigen  = "";
   aDestino = "";

   nPos   = 0;
   nLong  = 0;
   NDig   = 0;
   nCalc  = 0;
   nCalc1 = 0;
   Handle = 0;
|FIN;

|PROCESO TipoDecl;
   |SI #isy01218#3 = " ";
      #isy01218#4 = 0; |PINTA #isy01218#4;
      |C_M #isy01218#4,1,"N";
   |SINO;
      |C_M #isy01218#4,1,"S";
   |FINSI;
|FPRC;

|PROCESO Secuen2001;
   aCadena = "218" ;
   aAlfa = #ism00003#4;  NDig = 9;   aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#14; NDig = 5;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#1;  NDig = 4;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#2;  NDig = 2;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#5;  NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#6;  NDig = 3;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#7;  NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#8;  NDig = 3;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#9;  NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#10; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#11; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#12; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#13; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00003#17; NDig = 16;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
   aAlfa = #isy01218#5;  NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #isy01218#6;  NDig = 9;   aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = "";           NDig = 50;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
|FPRC;

|PROCESO Secuen2002;
   aCadena = "218" ;
   aAlfa = #ism00004#4;  NDig = 9;   aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#1;  NDig = 4;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#2;  NDig = 1;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = aCadena + "P";
   aAlfa = #ism00004#8; |QBF aAlfa;
   aAlfa = aAlfa % 0102; NDig = 2;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#8; |QBF aAlfa;
   aAlfa = aAlfa % 0402; NDig = 2;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#8; |QBF aAlfa;
   aAlfa = aAlfa % 0704; NDig = 4;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#9;  NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#10; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#11; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#12; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#13; NDig = 3;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#14; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#15; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#16; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;

   aAlfa = #ism00004#17; |QBF aAlfa;
   aAlfa = aAlfa - ".";
   |SI FSalida ! 0;
      nCalc = ((FSalida / 100) ! 0) + 99; aEnt = aAlfa % nCalc;
      nCalc = FSalida + 98;               aDec = aAlfa % nCalc;
   |FINSI;
   aAlfa = aEnt;         NDig = 3;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = aDec;         NDig = 2;   aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;

   aAlfa = #ism00004#18; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#19; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#20; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
   aAlfa = #ism00004#21; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#22; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#23; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#24; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#25; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#26; NDig = 13;  aTipo = "N"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#7;  NDig = 16;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa2 = #isy01218#5; |QBF aAlfa2;
   aAlfa = aAlfa2 % 0150; NDig = 50; aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = aAlfa2 % 5150; NDig = 50; aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #isy01218#6;  NDig = 9;   aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
   aAlfa = #ism00004#27; NDig = 70;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#28; NDig = 70;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#29; NDig = 70;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
   aAlfa = #ism00004#30; NDig = 70;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aAlfa = #ism00004#31; NDig = 70;  aTipo = "A"; |HAZ Formato; aCadena = aCadena + aAlfa;
   aCadena = Handle + " " + aCadena; |FGRABA aCadena; aCadena = "";
|FPRC;

|PROCESO CreaSec;
   |DBASE aDirec; |QBF aDirec;
   aDirec = aDirec + "hacienda/DIRECTA/"; |MKDIR aDirec;
   aAlfa = #isy01218#1; |QBF aAlfa; aAlfa = aAlfa % -102;
   aAlfa = (("00000" + #isy01218#0) % -105) + aAlfa;
   aFich = aAlfa;
   aAlfa = #isy01218#2;
   |SI #isy01218#2 = 10; aAlfa = "A"; |FINSI;
   |SI #isy01218#2 = 11; aAlfa = "B"; |FINSI;
   |SI #isy01218#2 = 12; aAlfa = "C"; |FINSI;
   aFich = aFich + aAlfa;

   aAlfa = aDirec + aFich;

   |ABRE #ism00004; |ABRE #ism00003;
   |SI #isy01218#1 ] 2002;
      #ism00004#0 = #isy01218#0;
      #ism00004#1 = #isy01218#1;
      #ism00004#2 = #isy01218#2;
      #ism00004#5 = #isy01218#3;
      #ism00004#6 = #isy01218#4;
      |LEE 000#ism00004.=;
   |SINO;
      #ism00003#0  = #isy01218#0;
      #ism00003#1  = #isy01218#1;
      #ism00003#2  = #isy01218#2;
      #ism00003#15 = #isy01218#3;
      #ism00003#16 = #isy01218#4;
      |LEE 000#ism00003.=;
   |FINSI;
   |SI FSalida = 0;
      aAlfa = "wb  " + aAlfa;
      |FABRE aAlfa;
      |SI FSalida ] 0;
         Handle = FSalida;
         |SI #isy01218#1 [ 2001; |HAZ Secuen2001; |FINSI;
         |SI #isy01218#1 ] 2002; |HAZ Secuen2002; |FINSI;
      |FINSI;
      FSalida = Handle; |FCIERRA FSalida;
   |SINO;
      |MENAV "    Seleccion vacia"; |ERROR; |ACABA;
   |FINSI;

   aAlfa = ""; |IP_REMOTO aAlfa;
   |DBASE aDirOri; |QBF aDirOri;
   aDirOri = aDirOri + "hacienda/DIRECTA/";
   aDirDes = "/AEAT";
   |SI aAlfa ! ""; |RMKDIR aDirDes; |SINO; |MKDIR aDirDes; |FINSI;
   aDirDes = "/AEAT/INTERNET";
   |SI aAlfa ! ""; |RMKDIR aDirDes; |SINO; |MKDIR aDirDes; |FINSI;
   aDirDes = "/AEAT/INTERNET/218";
   |SI aAlfa ! ""; |RMKDIR aDirDes; |SINO; |MKDIR aDirDes; |FINSI;
   aDirDes = "/AEAT/INTERNET/218/" + #0#1;
   |SI aAlfa ! ""; |RMKDIR aDirDes; |SINO; |MKDIR aDirDes; |FINSI;
   aDirDes = aDirDes + "/";
   aOrigen = aDirOri + aFich;
   aDestino = aDirDes + aFich;
   |SI aAlfa ! "";
      |ENVIA_FICHERO aOrigen, aDestino;
   |SINO;
      |COPIA_FICHERO aOrigen, aDestino;
   |FINSI;
   |SI FSalida = 0;
      |MENAV "    Ficheros creados satisfactoriamente";
      |HAZ PresentaAyuda;
   |SINO;
      |MENAV "    Problemas al crear los ficheros de datos";
   |FINSI;
   |CIERRA #ism00004; |CIERRA #ism00003;
|FPRC;

|PROCESO PresentaAyuda;
   |PUSHV 0501 2380;
   |BLANCO 0801 2380;
   |CUADRO 0701 1580;
   |ATRI R;
   aAlfa = " INFORMACION IMPORTANTE PARA LA PRESENTACION TELEMATICA DE DECLARACIONES      ";
   |PINTA 0702, aAlfa; |ATRI I;
   |PINTA 0804, " Los ficheros generados  para la presentacion telematica  de declaraciones";
   aAlfa1 = " del  modelo 218  podran recogerse de la carpeta 'AEAT/INTERNET/218/"+ #0#1+ "/'";
   |PINTA 0904, aAlfa1;
   |PINTA 1004, " de  la maquina desde  la que se han emitido, sabiendo que  el formato del";
   |PINTA 1104, " nombre de los ficheros es el siguiente : ";
   |PINTA 1204, " * Los cinco primeros digitos conforman el codigo de cliente ";
   |PINTA 1304, " * Los dos siguientes digitos conforman el ejercicio ";
   |PINTA 1404, " * El ultimo  digito determinara el periodo ";
   |ATRI N;
   |PAUSA; |POPV;
|FPRC;

|PROCESO Formato;
   |SI aTipo = "A";
      aVacio = " " * NDig;
      nCalc  = 100 + NDig;
      aAlfa1 = aAlfa + aVacio; aAlfa1 = aAlfa1 % nCalc;
   |SINO;
      nCalc = aAlfa;
      |SI NDig = 13; nCalc = (nCalc * 100) ! 0; aAlfa = nCalc; |FINSI;
      |SI nCalc < 0;
         NDig = NDig - 1;
         nCalc1 = 0 - nCalc;
         aAlfa2 = nCalc1;
      |SINO;
         aAlfa2 = aAlfa;
      |FINSI;
      aVacio = "0" * NDig;
      nCalc  = 0 - (100 + NDig);
      aAlfa1 = aVacio + aAlfa2; aAlfa1 = aAlfa1 % nCalc;
      nCalc = aAlfa;
      |SI nCalc < 0;
         NDig = NDig + 1;
         aAlfa1 = "N" + aAlfa1;
      |FINSI;
      aAlfa = aAlfa1;
      |ACABA;
   |FINSI;

   aAlfa = "";
   aLong = aAlfa1 % 0; nLong = aLong;
   |PARA nCalc = 1; |SI nCalc [ nLong; |HACIENDO nCalc = nCalc + 1;
      nPos = (100 * nCalc) + 1;
      aCaracter = aAlfa1 % nPos;
      |SI aCaracter = ",";  aCaracter = " ";  |FINSI;
      |SI aCaracter = ".";  aCaracter = " ";  |FINSI;
      |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
      |SI aCaracter = "¤";  aCaracter = &209; |FINSI;
      |SI aCaracter = "§";  aCaracter = &176; |FINSI;
      |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
      aAlfa = aAlfa + aCaracter;
   |SIGUE;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA "Emision modelo 218";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |HAZ CreaSec;
   |FINSI;
|FPRO;
