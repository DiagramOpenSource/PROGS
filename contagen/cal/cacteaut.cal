|FICHEROS;
   cacteaut #00;
   camaasic #02;
   camaasil #03;
   cacuenta #05;
   camautoc #06;
   camautol #07;

   catrasi1 #09,MANTE;   || Def Trabajo pase Asientos
   camandia #10;
   cacuebal #11;
   caconasi #20;
   canempre #30;
   caselem1 #998;

   caivaasi #200;

   camaniva #204;
   caivalin #205;
   calibros #206;
   caivases #207;
   caclipro #208;

   :/modelos/def/dsmom030 #4;

    caivatm4;
|FIN;

|VARIABLES;
   nInkey = 0;
   &entrada = 1;
   aParam = "";
   nParam = 0;
   aAlfa = "";
   alfa1 = "";
   alfa2 = "";
   nume1 = 0;
   nume2 = 0;
   nume3 = 0;
   nume4 = 0;
   fech1 = @;
   fech2 = @;
   para1 = 0;

   diar = 0;
   fech = @;
   asie = 0;
   apun = 0;
   cuen = "";
   digi = 0;
   sign = "";
   ptas = 0;
   conc = 0;
   desc = "";

   sw = 0;
   estado = 0;

   uno = "";
   dos = "";
   mascara = "";
   dpar = "";
   subd = "";
   swpr = 0;
   documen = 0;
   escon = 0;
   inkey = 0;
   swsel = 0;
   swContar = 0;

   swIVA = 0;
   nLibro = 0;
   nPerio = 0;
   NumDoc = 0;
   NumFactura = 0;
   eaTitCuenta = "";
   aSerie = "";
   enQSerie = 0;

   &antdia  = 0;  ||Variables para el Informe de posibles errores
   &antfec  = @;
   &antdoc  = 0;
   &antapu  = 0;
   &lerror  = 0;
   &men     = "";
   informe = "cacheapu";
   swImpresora = 0;
   aAlfa1   = "";
   aAlfa2   = "";
   aAlfa3   = "";
   nNume1   = 0;
   nNume2   = 0;
   nNume3   = 0;

   nPara1   = 0;
   nPara2   = 0;
   ffLaFecha = @;
   aAElConce = "";
   &enModelo = 0;
   nIncrApte = 0;
   aElSigno  = "";

   &eaNomFich  = "";
   nAlguno     = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoan_i;

|| ************************************************************************
|| *********** CALCULOS PANTALLA ******************************************
|| ************************************************************************
|CALCULO ATipo8; |TIPO 8;
  aParam = PARAMETRO; |QBT aParam;
  nParam = aParam;
  |HAZ inicio;
|FCAL;

|CALCULO AntesAsiento; |TIPO 7;
 |SI nParam ! 0;
     |ABRE #6;
     #6#0 = nParam;
     |LEE 001#6=;
     |SI FSalida = 0;
         #0#0 = #6#0;  |PINTA #0#0;
         #0#1 = #6#0;  |PINTA #0#1;
         #0#2 = #6#11; |PINTA #0#2;
         |C_M #0#0, 1, "N"; |C_M #0#1, 1, "N"; |C_M #0#2, 1, "N";
         |ATRI p; |PINTA 0604, #6#1; |ATRI 0;
     |FINSI;
     |CIERRA #6;
 |FINSI;
|FCAL;

|CALCULO AntesTipo; |TIPO 7;
 |SI nParam = 0;
     |C_M #0#2,1,"S";
     |PINTA 0604, "컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴";
     |SI #0#0 = #0#1;
         |ABRE #6;
         #6#0 = #0#0;
         |LEE 001#6=;
         |SI FSalida = 0;
             #0#2 = #6#11; |PINTA #0#2;
             |C_M #0#2, 1, "N";
             |ATRI p; |PINTA 0604, #6#1; |ATRI 0;
         |FINSI;
         |CIERRA #6;
     |FINSI;
 |FINSI;
|FCAL;

|PROCESO limite; |TIPO 0;
   |C_M #0Campo,0,alfa1;

   |SI alfa1 = "N"; |ACABA; |FINSI;

   |SI Campo ! 5; |Y #0Campo [ "01.01.0000"; |ACABA; |FINSI;

   |SI #0Campo < fec1; |O #0Campo > fec2;
      |MENAV "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
      |ERROR;
   |SINO;
      |SI #0Campo [ fec3;
          |MENAV "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS, NO CREARA ASIENTO";
          |SI Campo = 5;
              |ERROR;
          |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|CALCULO Cuantos; |TIPO 0;

 aAlfa1 = #0Campo; aAlfa2 = "S";
 |SI aAlfa1 = "S"; aAlfa2 = "N"; |FINSI;
 |C_M #0#5,1,aAlfa1; |C_M #0#6,1,aAlfa1;
 |C_M #0#16,1,aAlfa2; |C_M #0#28,1,aAlfa2;
 |C_M #0#17,1,aAlfa2; |C_M #0#29,1,aAlfa2;
 |C_M #0#18,1,aAlfa2; |C_M #0#30,1,aAlfa2;
 |C_M #0#19,1,aAlfa2; |C_M #0#31,1,aAlfa2;
 |C_M #0#20,1,aAlfa2; |C_M #0#32,1,aAlfa2;
 |C_M #0#21,1,aAlfa2; |C_M #0#33,1,aAlfa2;
 |C_M #0#22,1,aAlfa2; |C_M #0#34,1,aAlfa2;
 |C_M #0#23,1,aAlfa2; |C_M #0#35,1,aAlfa2;
 |C_M #0#24,1,aAlfa2; |C_M #0#36,1,aAlfa2;
 |C_M #0#25,1,aAlfa2; |C_M #0#37,1,aAlfa2;
 |C_M #0#26,1,aAlfa2; |C_M #0#38,1,aAlfa2;
 |C_M #0#27,1,aAlfa2; |C_M #0#39,1,aAlfa2;
|FCAL;

|CALCULO noentro; |TIPO 7;
 nNume1 = Campo - 12;
 |SI #0nNume1 [ "01.01.0000";
     |C_M #0Campo,1,"N";
 |SINO;
     |C_M #0Campo,1,"S";
     aAlfa1 = #0nNume1;
     aAlfa1 = aAlfa1 % 402;
     NumMes = aAlfa1;
     |HAZ NombreMes;
     #0Campo = NombreMes > "";
     |PINTA #0Campo;
 |FINSI;
|FCAL;

|CALCULO elDefec; |TIPO 7;
  |C_M #0Campo,0,aAlfa1;
  |SI aAlfa1 = "N"; |ACABA; |FINSI;

  aAlfa1 = "01";
  |SI Campo > 16;
      aAlfa1 = #0#16;
      aAlfa1 = aAlfa1 % 102;
  |FINSI;
  nNume1 = Campo - 15; aAlfa2 = nNume1; |QBF aAlfa2;
  aAlfa2 = ("00" + aAlfa2) % -102;
  aAlfa3 = enEjercicio; |QBF aAlfa3;
  |SI aAlfa1 = "31"; |O aAlfa1 = "30";
      |SI aAlfa2 = "04"; |O aAlfa2 = "06"; |O aAlfa2 = "09"; |O aAlfa2 = "11";
          aAlfa1 = "30";
      |SINO;
          aAlfa1 = "31";
      |FINSI;
      |SI aAlfa2 = "02";
          aAlfa1 = "28";
          |SI enEjercicio = 2004; |O enEjercicio = 2008; |O enEjercicio = 2012;
             |O enEjercicio = 2016; |O enEjercicio = 2020; |O enEjercicio = 2024;
                aAlfa1 = "29";
          |FINSI;
      |FINSI;
  |FINSI;
  aAlfa1 = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;
  #0Campo = aAlfa1;
  |PINTA #0Campo;
|FCAL;

|CALCULO lasFechas; |TIPO 0;
  |C_M #0Campo,0,aAlfa1;
  |SI aAlfa1 = "N";
      #0Campo = "01.01.0000"; |PINTA #0Campo;
      nNume1 = Campo + 12; #0nNume1 = ""; |PINTA #0nNume1;
  |SINO;
     nInkey = FSalida;
     |SI nInkey  = 10;
         #0Campo = "01.01.0000"; |PINTA #0Campo;
     |FINSI;

     aAlfa1 = "S";
     |SI #0Campo [ "01.01.0000";  aAlfa1 = "N"; |FINSI;
     nNume2 = Campo + 1;
     |PARA nNume1 = nNume2; |SI nNume1 [ 27; |HACIENDO nNume1 = nNume1 + 1;
               |C_M #0nNume1,1,aAlfa1;
     |SIGUE;
     |HAZ limite;
  |FINSI;
|FCAL;

|| ************************************************************************
|PROCESO leecta;
   sign = "D";
   ptas = 0;
   |ABRE #5;
   #5#0 = cuen;
   #5#1 = digi;
   |LEE 001#5=;
   |SI FSalida ! 0;
      |DDEFECTO #5;
   |FINSI;
   |SI #5#53 < 0; sign = "D"; ptas = - #5#53; #0#12 = #0#12 + ptas; |FINSI;
   |SI #5#53 ] 0; sign = "H"; ptas =   #5#53; #0#13 = #0#13 + ptas; |FINSI;
   |CIERRA #5;
|FPRC;

|PROCESO leelineas;
   ptas     = 0;
   eaCtaAna = "";

   cuen     = #7#2; eaCuenta = cuen; |HAZ SacaNivel;
   digi     = enNivel;
   aElSigno = #7#15;

   |SI enSwAna = 1;
       aAlfa1 = #7#14; |QBF aAlfa1;
       |SI aAlfa1 = "*TABLA";
           |HAZ LeeTablaAna;
       |SINO;
           |SI aAlfa1 ! "*REGIS";
               eaCtaAna = #7#14;
           |FINSI;
       |FINSI;
   |FINSI;

   conc  = #7#4;
   alfa2 = #7#5; |QBF alfa2;
   alfa1 = aAElConce;
   alfa1 = " " + alfa1;
   desc =  alfa2 + alfa1;

   |SI #6#22 = "N";
       dpar = #7#6;
   |SINO;
       dpar = eaDfDepC;
   |FINSI;
   |QBF dpar; dpar = ( "00" + dpar) % -102;

   |SI #6#23 = "N";
       subd = #7#9;
   |SINO;
       subd = eaDfSubC;
   |FINSI;

   |SI #7#7 = "D";
      sign = #7#7;
      ptas = #7#8;
      #0#12 = #0#12 + #7#8;
   |FINSI;
   |SI #7#7 = "H";
      sign = #7#7;
      ptas = #7#8;
      #0#13 = #0#13 + #7#8;
   |FINSI;
   |SI #7#7 = "S";
       |HAZ leecta;
   |FINSI;
   |SI #7#7 = "C";
      |SI #0#14 ] 0; sign = "H"; ptas = #0#14;   #0#13 = #0#13 + ptas; |FINSI;
      |SI #0#14 < 0; sign = "D"; ptas = - #0#14; #0#12 = #0#12 + ptas; |FINSI;
   |FINSI;

   |SI #7#7 = "S"; |O #7#7 = "C";
       |SI aElSigno = "+"; |Y sign = "H"; ptas = 0; |FINSI;
       |SI aElSigno = "-"; |Y sign = "D"; ptas = 0; |FINSI;
   |FINSI;

   |SI ptas = 0; |ACABA; |FINSI;

   apun  = apun + nIncrApte;
   |HAZ lineas;
   sw   = 1;
   #0#14 = #0#12 - #0#13;
|FPRC;

|| _______________________________________________

|PROCESO contab1;   || controla la grabacion de apuntes

   #0#9  = #6#10;      || Diario Nuevo Asiento
   #0#10 = ffLaFecha;  || Fecha;
   #0#11 = documen;    || Documento
   #0#12 = 0;  #0#13 = 0; #0#14 = 0;

   |SI #0#7 = "N";
       |CUADRO 2102 2379;
       |PINTA 2203, " Pasando Asiento:                               ";
       |PINTA 2221, #6#0;
       |PINTA 2227, #6#1;
   |FINSI;
   nIncrApte = #6#26; |SI nIncrApte = 0; nIncrApte = 10; |FINSI;

   |ABRE #9;
   |DDEFECTO #9;
   apun = 1 - nIncrApte;

   sw = 0;
   |BUCLELIN 2leelineas#6;
   |CIERRA #9;

   |SI sw = 1;
      |PUSHV 0901 2380;
      |SI #0#7 = "S";
          |PINPA #0#9;
          |PINTA #0#12;
          |PINTA #0#13;
          |PINTA #0#14;
          |SI enSwAna = 1;
              |PINTA 1254, ""; |PINTA 1354, ""; |PINTA 1454, "";
              |PINTA 1554, ""; |PINTA 1654, ""; |PINTA 1754, "";
              |PINTA 1854, ""; |PINTA 1954, ""; |PINTA 2054, "";
              |PINTA 2154, ""; |PINTA 2254, ""; |PINTA 2354, "";
              |ATRI R; |PINTA 1355, "CTA ANA"; |ATRI O;
          |FINSI;
          |ENTLINEAL #1#9, -4, 4, 22, 0, min1, max1;
      |SINO;
          escon = 1;
      |FINSI;
      |SI escon = 1;
          |HAZ pasa_asto;
      |FINSI;
      |POPV;
   |FINSI;
   |LIBERA #6;
   |DELINDEX #9;
|FPRC;

|| ************************
|RUTINA min1;
   #catrasi1#00 = #0#9;
   #catrasi1#01 = #0#10;
   #catrasi1#02 = #0#11;
   #catrasi1#03 = 1;
|FRUT;

|RUTINA max1;
   #catrasi1#00 = #0#9;
   #catrasi1#01 = #0#10;
   #catrasi1#02 = #0#11;
   #catrasi1#03 = 9999;
|FRUT;

|PROCESO eltip11; |TIPO 11;
   inkey = FSalida;
   |SI inkey = 1; |O inkey = 7;
      escon = 1;
      |CONFI "2451SPasar Asiento Contable S/N ";
      |SI FSalida ! 0; escon = 0; |FINSI;
   |FINSI;
|FPRC;

|| *************************

|DEFBUCLE cacteaut0;
   #6#1;
   11, 12, 21, 24;
   #0#0, #0#2, "N", 000, "N";
   #0#1, #0#2, "N", 000, "N";
   be;
   NULL, contab1;
|FIN;

|| **************************************************************************
|PROCESO GrabaDatosSii;
   #caivatm4#0 = enEmpresa;
   #caivatm4#1 = enPeriodo;
   #caivatm4#2 = #camaniva#0;
   #caivatm4#3 = #camaniva#1;
   |LEE 041#caivatm4.=;
   |SI FSalida ! 0;
       #caivatm4#0 = enEmpresa;
       #caivatm4#1 = enPeriodo;
       #caivatm4#2 = #camaniva#0;
       #caivatm4#3 = #camaniva#1;
       |GRABA 020#caivatm4.n;
       nAlguno     = 1;
   |FINSI;
|FPRC;

|PROCESO HazTodo;
   |HAZ Analitica;
   |ABRE #9;  |CIERRA #9;  |DELINDEX #9;

   |C_V #9#29, 1, "N"; |C_A #9#7, 1, 26;
   |SI enSwAna = 1; |C_V #9#29, 1, "S"; |C_A #9#7,1,18; |FINSI;
   |C_V #0#12,1,"S";
   |C_V #0#13,1,"S";
   |C_V #0#14,1,"S";

   |SI #0#15 = "S";
       nPara1 = 5;  nPara2 = 5;  nNume1 = 1;
   |SINO;
       nPara1 = 16; nPara2 = 27; nNume1 = 12;
   |FINSI;

   |HAZ eLeeParametro;

   nAlguno    = 0;
   eaNomFich  = ("0p" + Usuario) % 108;
   |NOME_DAT #caivatm4#eaNomFich#;
   |DELINDEX #caivatm4;

   |ABRE #caivatm4;
   |PARA nNume2 = nPara1; |SI nNume2 [ nPara2; |HACIENDO nNume2 = nNume2 + 1;

      ffLaFecha = #0nNume2;
      |SI ffLaFecha [ "01.01.0000"; |VETE noHago; |FINSI;
      |SI ffLaFecha [ fec3;         |VETE noHago; |FINSI;
      |SI ffLaFecha < fec1; |O ffLaFecha > fec2; |VETE noHago; |FINSI;

      nNume3    = nNume2 + nNume1;
      aAElConce = #0nNume3;

      |HAZ contador;
      documen = nDOCUMENTO;
      #0#8 = documen;

      lerror = 0;
      |BUCLE cacteaut0;
      |SI lerror ! 0;
          |SI swImpresora = 1;
              |PIEINF;
          |SINO;
              aAlfa1 = enEmpresa; aAlfa1 = ("00000" + aAlfa1) % -105;
              aAlfa1 = "    Errores en Asientos de la Empresa " + aAlfa1;
              |MENAV aAlfa1;
          |FINSI;
      |FINSI;

      |ET noHago;
   |SIGUE;
   |CIERRA #caivatm4;

   |SI nAlguno = 1; |SUB_EJECUTA_NP "caut0018;PASE"; |FINSI;
|FPRC;

|CALCULO proceso; |TIPO 3;

   |HAZ nom_usu;
   alfa1 = "l" + nom_tmp;
   |NOME_DAT #catrasi1 #alfa1#;

   |SI #48#27 = "S";
       |HAZ MultiEmpresa;
   |SINO;
       |DFICE dirfich0; |QBF dirfich0;
       |HAZ HazTodo;
   |FINSI;
   |SI swImpresora = 1;
       |FININF;
       |FINIMP;
   |FINSI;
|FCAL;

|PROCESO MultiEmp1;
   cod1 = #caselem1#1;
   cod2 = #caselem1#2;
   emEmp = 1;  || Sin mensaje
   |HAZ leelo;
   |SI swerror ! 0;  |ACABA;   |FINSI;

   |SI #0#15 = "N";
       |SI #0#5 [ fec3; |ACABA; |FINSI; || no crea asiento
       |SI #0#5 < fec1; |O #0#5 > fec2; |FINSI;
   |FINSI;

   dirfich0 = #caselem1#3;
   |QBF dirfich0;

   |PATH_DAT #2 dirfich0;
   |PATH_DAT #3 dirfich0;
   |PATH_DAT #5 dirfich0;
   |PATH_DAT #6 dirfich0;
   |PATH_DAT #7 dirfich0;
   |PATH_DAT #10 dirfich0;
   |PATH_DAT #11 dirfich0;
   |PATH_DAT #20 dirfich0;
   |PATH_DAT #200 dirfich0;
   |PATH_DAT #204 dirfich0;
   |PATH_DAT #205 dirfich0;
   |PATH_DAT #206 dirfich0;
   |PATH_DAT #207 dirfich0;
   |PATH_DAT #208 dirfich0;

   |SI #0#7 = "N";
       |ATRI N;
       |PINTA 1814, "EMPRESA: ";
       |ATRI P; |PINTA 1823, #30#2;
       |PINTA 1923, #30#1; |ATRI 0;
   |SINO;
       |ATRI N;
       |PINTA 0902, "EMPRESA: ";
       |ATRI P; |PINTA 0911, #30#2;
       |PINTA 0917, #30#1; |ATRI 0;
   |FINSI;
   |HAZ HazTodo;
|FPRC;

|DEFBUCLE MultiEmp0;
 #caselem1#1;
 ;
 000001;
 999999;
 ;
 NULL,MultiEmp1;
|FIN;

|PROCESO MultiEmpresa;
  |SUB_EJECUTA "caselemp";
  |NOME_DAT #998 eaFichsel;
  |BUCLE MultiEmp0;
  |DELINDEX #998;
|FPRC;

|| ************************************************************************
|PROCESO lineas;    || graba apunte
   |DDEFECTO #9;
   #catrasi1#00 = #0#9;
   #catrasi1#01 = #0#10;
   #catrasi1#02 = #0#11;

   #catrasi1#03 = apun;   || apunte
   #catrasi1#04 = cuen;   || cuenta
   #catrasi1#05 = digi;   || digito
   #catrasi1#06 = conc;   || concepto
   #catrasi1#07 = desc;   || descripcion
   #catrasi1#08 = sign;   || signo
   #catrasi1#09 = ptas;   || importe
   |SI #catrasi1#08 = "D";
      #catrasi1#16 = #catrasi1#4;
      #catrasi1#17 = #catrasi1#5;
      #catrasi1#10 = "";
      #catrasi1#11 = 0;
   |SINO;
      #catrasi1#16 = "";
      #catrasi1#17 = 0;
      #catrasi1#10 = #catrasi1#4;
      #catrasi1#11 = #catrasi1#5;
   |FINSI;

   |SI #6#13 = "S";  ||Si Crea IVA
       #catrasi1#12 = #6#16;        || Tipo IVA
       #catrasi1#13 = #6#17;        || Libro IVA
       #catrasi1#14 = #7#13 * 100;  || % IVA falta numero
       #catrasi1#15 = #6#18;        || Serie
       #catrasi1#19 = #7#11;        || Tipo Acumulado
       #catrasi1#20 = #7#12;        || Numero Acumulador
   |FINSI;
   #catrasi1#21 = dpar;
   #catrasi1#28 = subd;
   #catrasi1#29 = eaCtaAna;
   |GRABA 020#9n;
|FPRC;

|PROCESO pasa_asto1;    || graba apunte

   |DDEFECTO #3;
   |PARA para1 = 0; |SI para1 [ 30; |HACIENDO para1 = para1 + 1;
         #3para1 = #catrasi1#para1#;
   |SIGUE;
   #3#2  = nDOCUMENTO;
   #3#24 = nREGISTRO;
   |SI #6#13 = "S";  ||Si Crea IVA
       |SI swIVA = 0;
           |HAZ CabIvas;
       |FINSI;
       #3#12 = #camaniva#36;
       #3#13 = #camaniva#0;
       #3#14 = #camaniva#3;
       #3#15 = #camaniva#2;
   |FINSI;
   |GRABA 020#3n;
   |SI #6#13 = "S";  |HAZ ActIvas; |FINSI;
   |HAZ cabecera;           || cabecera apunte
   MasMenos     = #3#9;
   DebeHaber    = #3#8;
   aCUENTA      = #3#4;
   nREGISTRO    = #3#24;
   nDIARIO      = #3#0;
   aFECHA       = #3#1;
   nDOCUMENTO   = #3#2;
   nNIVELCUENTA = #3#5;
   |HAZ ActDiario;          || diario
   |HAZ ActCuenta;          || cuenta
   |HAZ ActTesteo;          || Para recalculo en informes

   |HAZ HazElChequeo;
|FPRC;

|DEFBUCLE pasa_asto0;
   #9#1;
   ;
   00, "01.01.1900", 000001, 0001;
   99, "31.12.2090", 999999, 9999;
   e;
   NULL, pasa_asto1;
|FIN;

|PROCESO pasa_asto;
   |HAZ Multi_contador;
   |ABRE #2;
   |ABRE #3;
   |ABRE #204;
   |ABRE #205;
   swIVA = 0;
   |BUCLE pasa_asto0;
   |CIERRA #2;
   |CIERRA #3;
   |CIERRA #204;
   |CIERRA #205;

   documen = #3#2 + 1;
   alfa1 = #3#0; alfa1 = ("00" + alfa1) % -102;
   #6#7  = alfa1;
   #6#8  = #3#1;
   alfa1  = #3#2; alfa1 = ("000000" + alfa1) % -106;
   #6#9  = alfa1;
   |GRABA 020#6a;
|FPRC;

|PROCESO cabecera;       || actualiza cabeceras
   |DDEFECTO #2;
   #camaasic#00 = #3#0; ||  diario
   #camaasic#01 = #3#1; ||  fecha
   #camaasic#02 = #3#2; ||  documento
   #camaasic#03 = #3#2; ||  asiento
   |LEE 101#2=;
   |SI FSalida ! 0;
       |DDEFECTO #2;
       #camaasic#00 = #3#0; ||  diario
       #camaasic#01 = #3#1; ||  fecha
       #camaasic#02 = #3#2; ||  documento
       #camaasic#03 = #3#2; ||  asiento
       |GRABA 020#2b;
   |FINSI;
   |SI #3#08 = "D";
       #camaasic#04 = #camaasic#04 + #3#09;
       |SI #camaasic#09 = 0; #camaasic#08 = #3#4; #camaasic#09 = #3#5; |FINSI;  || contrp.HABER
   |SINO;
       #camaasic#05 = #camaasic#05 + #3#09;
       |SI #camaasic#11 = 0; #camaasic#10 = #3#4; #camaasic#11 = #3#5; |FINSI;  || contrp.DEBE
   |FINSI;
   #camaasic#6  = #camaasic#4 - #camaasic#5;      || saldo
   #camaasic#12 = #3#24;
   |SI #3#12 = "R"; #camaasic#13 = 1; #camaasic#17 = #camaniva#22; |FINSI;
   |SI #3#12 = "S"; #camaasic#13 = 2; #camaasic#17 = #camaniva#22; |FINSI;
   |SI #3#12 = "N"; #camaasic#13 = 3; #camaasic#17 = #camaniva#22; |FINSI;

   |GRABA 020#2a;
   |LIBERA #2;
|FPRC;

|| ******************* PROCESO DE CREAR FACTURAS *************************

|PROCESO CabIvas;
  nLibro = #3#13;
  aSerie = #3#15;
  |ABRE #calibros;
  #calibros#0 = nLibro;
  |LEE 001#calibros.=;
  |SI FSalida ! 0;
      |CIERRA #calibros;
      |ACABA;
  |FINSI;
  aTipoIVA = #calibros#2;
  |CIERRA #calibros;

  enLineaIVA = 1; efFechaIVA = "01.01.2000"; |HAZ SacaIVA;

  |ABRE #caivaasi;
  |DDEFECTO #caivaasi;
  |LEE 010#caivaasi.p;
  enQSerie = 0; |SI #caivaasi#44 = "S"; enQSerie = 1; |FINSI;
  |CIERRA #caivaasi;

  aAlfa1 = #3#1;
  aAlfa1 = aAlfa1 % 402;
  nPerio = aAlfa1;
  |SI enEjercicio [ 2009;
      |SI #caivaasi#46 = "A"; nPerio = 0; |FINSI;
      |SI #caivaasi#46 = "T";
          nPerio = 1;
          |SI nume1 ] 4; nPerio = 2; |FINSI;
          |SI nume1 ] 7; nPerio = 3; |FINSI;
          |SI nume1 ] 10;nPerio = 4; |FINSI;
     |FINSI;
  |FINSI;

   NumDoc = 1;
   #camaniva#0 = nLibro;
   #camaniva#1 = 9999999999;
   |LEE 010#camaniva.];
   |SI FSalida = 0;
       |LEE 040#camaniva.a;
   |SINO;
       |LEE 040#camaniva.u;
   |FINSI;
   |SI FSalida = 0; |Y #camaniva#0 = nLibro;
       NumDoc = #camaniva#1 + 1;
   |FINSI;
   |HAZ ult_fra;

  |DDEFECTO #camaniva;
  #camaniva#0  = nLibro;
  #camaniva#1  = NumDoc;          || N de registro
  #camaniva#2  = #3#15;    || Serie
  #camaniva#3  = NumFactura;      || Factura
  #camaniva#4  = #3#1;     || Fecha factura
  #camaniva#5  = nPerio;          || Periodo
  #camaniva#7  = #3#0;     || Diario
  #camaniva#8  = #3#1;     || Fecha contable
  #camaniva#9  = #3#2;     || Documento
  #camaniva#36 = aTipoIVA;        || Tipo de IVA
  #camaniva#42 = #6#27;

  |GRABA 020#camaniva.b;
  swIVA = 1;
  |HAZ ActNumero;
  |HAZ GrabaDatosSii;
|FPRC;

|PROCESO LeeBaseIrpf;
       |ABRE #dsmom030;
       #dsmom030#0 = #caivalin#18;
       |LEE 001#dsmom030.=;
       |SI FSalida = 0;
           |SI #caivalin#21 = 0; #caivalin#21 = #dsmom030#93; |FINSI;
           aAlfa = #caivaasi#89; |SI #dsmom030#92 ! " "; aAlfa = #dsmom030#92; |FINSI;
           |SI aAlfa = "B";
               #caivalin#20 = #caivalin#6;
           |SINO;
               #caivalin#20 = #caivalin#6 + #caivalin#8 + #caivalin#10;
           |FINSI;
       |FINSI;
       |CIERRA #dsmom030;
       |SI #caivalin#20 = 0; |Y #caivalin#6 ! 0;
           #caivalin#20 = ((100 * #caivalin#22) / #caivalin#21) ! EURODB; || Base IRPF
       |FINSI;
|FPRC;

|PROCESO ActIvas;
 |SI swIVA = 0; |ACABA; |FINSI;
 |SI #3#19 = "X"; |ACABA; |FINSI;

 |SI #3#19 = "F";
     #camaniva#10 = #3#21;     || Departamento (Actividad)
     #camaniva#11 = #3#28;     || SubDepartamento (Ref.Catastral/Cultivo)
     |HAZ Departamento;
     #camaniva#24 = eaNombreAct;
     #camaniva#25 = eaNomSubdep;
     #camaniva#12 = #3#4;      || Cuenta Cli/Pro
     |HAZ LeeCliPro;
     #camaniva#13 = eaTitCuenta;
     #camaniva#14 = eaCodNif;
     #camaniva#22 = "";        || N Factura Proveedor
     |SI #caivaasi#189 = "S"; |Y aTipoIVA = "R";
         alfa1 = #camaniva#3;
         |SI #caivaasi#98 = "S";
             alfa1 = ("000000" + alfa1) % -106;
         |FINSI;
         alfa2 = #camaniva#2; |QBF alfa2;
         |SI alfa2 ! "";
             alfa1 = alfa2 + #caivaasi#97 + alfa1;
         |FINSI;
         #camaniva#22 = alfa1;
     |FINSI;

     #camaniva#27 = #3#6;      || Concepto Cli/Pro
     #camaniva#28 = #3#7;      || Descripcion Cli/Pro
     #camaniva#31 = eaDesgIVA;
     #camaniva#32 = eaDesgCTP;
     #camaniva#33 = "N";
     #camaniva#34 = eaDesgDTO;
     #camaniva#36 = aTipoIVA;
     #camaniva#38 = 1;     || Numero de Facturas
  |FINSI;
  |SI #3#19 = "I";
      #camaniva#29 = #3#6;      || Concepto IVA
      #camaniva#30 = #3#7;      || Descripcion IVA
  |FINSI;

  |GRABA 020#camaniva.a;
  |LIBERA #camaniva;

  #camaniva#0  = nLibro;          || Libro
  #camaniva#1  = NumDoc;          || N de registro
  |LEE 101#camaniva.=;

  |SI #3#20 = 0; |ACABA; |FINSI;

  #caivalin#0 = #camaniva#0;
  #caivalin#1 = #camaniva#1;
  #caivalin#2 = #3#20;
  |LEE 010#caivalin.=;
  |SI FSalida ! 0;
      |DDEFECTO #caivalin;
      #caivalin#0 = #camaniva#0;  || Libro
      #caivalin#1 = #camaniva#1;  || Documento
      #caivalin#2 = #3#20; || Linea
      |GRABA 020#caivalin.b;
  |FINSI;

  |SI #3#19 = "B";
      #caivalin#3  = #3#6;                  || Concepto
      #caivalin#4  = #3#7;                  || Descripcion
      #caivalin#6  = #caivalin#6 + #3#9;   || Base imponible
      #caivalin#12 = #3#4;                  || Contrapartida
      #caivalin#17 = #6#19;                 || Inversion
      #camaniva#19 = #camaniva#19 + #3#9;
      #camaniva#15 = #camaniva#15 + #3#9;
      #caivalin#30 = #3#21;     || Departamento (Actividad)
      #caivalin#31 = #3#28;     || SubDepartamento (Ref.Catastral/Cultivo)
      #caivalin#28 = #3#29;
  |FINSI;

  |SI #3#19 = "I";
      #caivalin#7  = (#catrasi1#14 / 100);  || Tipo de IVA
      #caivalin#8  = #caivalin#8 + #3#9;    || Cuota de IVA
      #caivalin#13 = #3#4;                  || Cuenta de IVA
      #camaniva#23 = #camaniva#23 + #3#9;
  |FINSI;

  |SI #3#19 = "R";
      #caivalin#9  = (#catrasi1#14 / 100);  || Tipo de recargo
      #caivalin#10 = #caivalin#10 + #3#9;   || Cuota de recargo
      #caivalin#14 = #3#4;                  || Cuenta de recargo
      #camaniva#23 = #camaniva#23 + #3#9;
  |FINSI;

  |SI #3#19 = "D";
      #caivalin#11 = #caivalin#11 + #3#9;  || Descuento
      #caivalin#15 = #3#4;                 || Cuenta de descuento
      #camaniva#26 = #camaniva#26 + #3#9;
  |FINSI;

  |SI #3#19 = "P";
      #caivalin#18 = #3#6;                  || Concepto IRPF
      #caivalin#19 = #3#7;                  || Descripcion concepto IRPF
      #caivalin#21 = (#catrasi1#14 / 100);  || Tipo IRPF
      #caivalin#22 = #caivalin#22 + #3#9;   || Cuota IRPF
      |HAZ LeeBaseIrpf;
      #caivalin#23 = #3#4;                  || Cuenta IRPF
      #camaniva#20 = #camaniva#20 + #3#9;
  |FINSI;

  #caivalin#5  = #6#20;             || Deducible S/N
||  #caivalin#16 = #catrasi1#14;      || Linea de tipo de iva

  efFechaIVA = #camaniva#4;
  enPorcIVA  = #caivalin#7;  enPorcREC = #caivalin#9;
  eaCtaIVA   = #caivalin#13; eaCtaREC  = #caivalin#14;
  |HAZ BuscaTipoIVA;
  #caivalin#16 = enLineaIVA;

  #camaniva#17 = #camaniva#15 %  #camaniva#16;
  #camaniva#21 = #camaniva#19 + #camaniva#23 - #camaniva#26 - #camaniva#20;

  |SI #caivalin#18 ! 0;
      |SI #caivalin#20 = 0; |O #caivalin#21 = 0;
          |HAZ LeeBaseIrpf;
      |FINSI;
  |FINSI;

  |GRABA 020#caivalin.a;
  |GRABA 020#camaniva.a;
  |LIBERA #camaniva;
  |LIBERA #caivalin;
|FPRC;

|PROCESO Departamento;
   eOpDep = 0;
   enActividad = #3#21;
   eaCodDep    = #3#21;
   |HAZ Actividad;
   eOpSub = 0;
   enConcepto  = #3#6;
   eaCodSubdep = #3#28;
   |HAZ SubActividad;
|FPRC;

|| ---------------- Proceso Lectura i actualizacion de Clientes y Proveedores
|PROCESO LeeCliPro;
  eaTitCuenta = "";
  eaCodNif    = "";
  |ABRE #caclipro;
  #caclipro#23 = "P";
  alfa1 = #3#4 % 0102; |QBF alfa1;
  |SI alfa1 = "43"; |O alfa1 = "44"; #caclipro#23 = "C"; |FINSI;
  #caclipro#10 = #3#4;
  #caclipro#11 = #3#5;
  |LEE 010#caclipro.=;
  |SI FSalida = 0;
      eaTitCuenta  = #caclipro#1;
      eaCodNif     = #caclipro#9;
  |SINO;
      |ABRE #5;
      #5#0 = #3#4;
      |LEE 001#5=;
      |SI FSalida = 0;
          eaTitCuenta = #5#2;
      |FINSI;
      |CIERRA #5;
  |FINSI;
  |CIERRA #caclipro;
|FPRC;

|PROCESO ult_fra;
 NumFactura = 1;
 |SI enQSerie = 0;
     |ABRE #calibros;
     #calibros#0 = nLibro;
     |LEE 111#calibros.=;
     |SI FSalida = 0;
         NumFactura = #calibros#4;
     |FINSI;
     |LIBERA #calibros;
     |CIERRA #calibros;
 |SINO;
     |ABRE #caivases;
     #caivases#0 = aSerie;
     #caivases#1 = aTipoIVA;
     |LEE 111#caivases.=;
     |SI FSalida = 0;
         NumFactura = #caivases#3;
     |FINSI;
     |LIBERA #caivases;
     |CIERRA #caivases;
  |FINSI;
  ||  NumFactura = NumFactura - 1; ||numero anterior
|FPRC;

|PROCESO ActNumero;
 |SI enQSerie = 0;
     |ABRE #calibros;
     #calibros#0 = nLibro;
     |LEE 111#calibros.=;
     |SI FSalida ! 0;
         |DDEFECTO #calibros;
         #calibros#0 = nLibro;
         #calibros#2 = aTipoIVA;
         #calibros#3 = 1;
         |GRABA 020#calibros.b;
     |FINSI;
     #calibros#4 = NumFactura + #calibros#3;
     |GRABA 020#calibros.a;
     |LIBERA #calibros;
     |CIERRA #calibros;
 |SINO;
     |ABRE #caivases;
      #caivases#0 = aSerie;
      #caivases#1 = aTipoIVA;
      |LEE 111#caivases.=;
      |SI FSalida ! 0;
          |DDEFECTO #caivases;
          #caivases#0 = aSerie;
          #caivases#1 = aTipoIVA;
          #caivases#4 = 1;
          |GRABA 020#caivases.b;
      |FINSI;
      #caivases#3 = NumFactura  + #caivases#4;
      |GRABA 020#caivases.a;
      |LIBERA #caivases;
      |CIERRA #caivases;
  |FINSI;
|FPRC;


|| ************************* Proceso para sacar posibles errores

|PROCESO HazElChequeo;
  eaCuenta = #3#4; |QBF eaCuenta;

  |SI eaCuenta = "";
      men = "CUENTA CONTABLE EN BLANCO";
      |HAZ HazPrint;
  |SINO;
      |HAZ SacaNivel;
      |SI enNivel = 0;
          men = "CUENTA CONTABLE FUERA DE NIVEL";
          |HAZ HazPrint;
      |FINSI;
  |FINSI;
|ABRE #cacuenta;
  #5#0 = #3#4;
  #5#1 = #3#5;
  |LEE 001#5=;
  |SI FSalida ! 0;
      men = "NO EXISTE CUENTA CONTABLE";
      |HAZ HazPrint;
  |SINO;
      |SI #5#3 = "N";
         men = "CUENTA CONTABLE SIN ASIENTO DIRECTO";
         |HAZ HazPrint;
      |FINSI;
  |FINSI;
|CIERRA #cacuenta;

  |SI #3#9 = 0;                   || Importe Cero
      men = "IMPORTE IGUAL A CERO";
      |HAZ HazPrint;
  |FINSI;

  |SI #3#6 = 0;                   || Concepto
      men = "CONCEPTO AUTOMATICO IGUAL A CERO";
      |HAZ HazPrint;
  |FINSI;
|FPRC;

|PROCESO HazPrint;
  |SI swImpresora = 0;
      swImpresora = 1;
      |IMPRE 0;
      |SI FSalida ! 0;  swImpresora = 2; |ACABA; |FINSI;
      |INFOR informe;
      |SI FSalida ! 0;  swImpresora = 3; |FINIMP;  |ACABA;  |FINSI;
 |FINSI;
 |SI swImpresora = 1;
     antdia  = #3#0;
     antfec  = #3#1;
     antdoc  = #3#2;
     antapu  = #3#3;
     |PRINT;
 |FINSI;
 lerror = lerror + 1;
|FPRC;
