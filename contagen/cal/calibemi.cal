|FICHEROS;
   calibemi #0;
   calibros #1;

   :/modelos/def/dsmom035 #2;
   :/modelos/def/dsmom036 #7;

   camaniva #3;
   caivalin #4;
|FIN;

|INCLUYE dscont_i;

|VARIABLES;

   &SwCabFac = 0; &SwLinFac = 0; &SwTotFac = 0; &SwSToFac = 0; &SwTToFac = 0;
   &SwBlanco = 0; &fecinf = @; &fecha_i = 0;
   &regis = 0; &ContLin = 0; &varalf = ""; &Pagina = 0; SwPrint = 0; &SwPinta = 0;
   &TF  = 0; &TB  = 0; &TI  = 0; &TR  = 0; &TD  = 0;
   &TLF = 0; &TLB = 0; &TLI = 0; &TLR = 0; &TLD = 0;

   modo   = 0; DiasFecha = 0; SwHayDatos = 0;
   campo  = 0;
   men1   = "    No existe empresa";
   men2   = "    NO existe el grupo de conceptos";
   mensa1 = "    ESTA FECHA NO CORRESPONDE CON EL EJERCICIO";
   alfa1  = "";

   Comodin = ""; TipoLibro = ""; Serie = ""; Factura = 0;
   SwError = 0;  Primero = 0; FechaTrab = @;

   Cont = 0; Cont1 = 0; Calc = 0;

   NumLineas = 68; NumRegis = 0;

   fDFecha    = @;
|FIN;

|PROCESO cheq_libro; |TIPO 0;
   |SI #calibros#2 ! "R";
      |MENAV "    ATENCION!!! Libro de I.V.A. Soportado ...";
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO lee_libro1;
   |ERROR10;
|FPRC;

|DEFBUCLE lee_libro;
   #calibros#1;
   2;
   1, "R";
   99, "R";
   e;
   NULL, lee_libro1;
|FIN;

|PROCESO deflib; |TIPO 7;
   |SI modo ! 0; |ACABA; |FINSI;
   |DDEFECTO #calibros;
   |BUCLE lee_libro;
   #calibemi#0 = #calibros#0;
   |PINTA #calibemi#0;
|FPRC;

|PROCESO selecci2; |TIPO 0;
   |SI #calibemi#42 = "N";
      |CAMPO_MODIFICA #calibemi#11, 1, "S";
      |CAMPO_MODIFICA #calibemi#43, 1, "N";
      |CAMPO_MODIFICA #calibemi#44, 1, "N";
      |CAMPO_MODIFICA #calibemi#45, 1, "N";
      |CAMPO_MODIFICA #calibemi#46, 1, "N";
      #calibemi#43 = 0;      |PINTA #calibemi#43;
      #calibemi#44 = 0;      |PINTA #calibemi#44;
      #calibemi#45 = 0;      |PINTA #calibemi#45;
      #calibemi#46 = 0;      |PINTA #calibemi#46;
   |SINO;
      |CAMPO_MODIFICA #calibemi#11, 1, "N";
      |CAMPO_MODIFICA #calibemi#43, 1, "S";
      |CAMPO_MODIFICA #calibemi#44, 1, "S";
      |CAMPO_MODIFICA #calibemi#45, 1, "S";
      |CAMPO_MODIFICA #calibemi#46, 1, "S";
      #calibemi#11 = "N";    |PINTA #calibemi#11;
   |FINSI;
|FPRC;

|PROCESO paso; |TIPO 0;
   |SI FSalida = 1;
      |ERROR;
      |PTEC 815;
   |FINSI;
|FPRC;

|PROCESO fechad;
   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   |SI #calibemi#Campo# < fDFecha; |O #calibemi#Campo# > fec2;
      |MENAV mensa1;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO fechah;
   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   campo = Campo - 1;
   |SI #calibemi#Campo# < fDFecha; |O #calibemi#Campo# > fec2; |O #calibemi#Campo# < #calibemi#campo#;
      |MENAV mensa1;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO no_entres;
   alfa1 = #calibemi#11;
   |PARA campo = 12;  |SI campo [ 35;  |HACIENDO campo = campo + 1;
      |CAMPO_MODIFICA #calibemi#campo#, 1, alfa1;
   |SIGUE;
   |SI alfa1 = "N";
      |PDEFECTO #0,12,36;
      |PINDA #0#0;
   |FINSI;
|FPRC;

|PROCESO nopidas;
   |SI #calibemi#Campo# ! 0;  |ACABA;  |FINSI;
   alfa1 = "N";
   |PARA campo = Campo + 1;  |SI campo [ 35;  |HACIENDO campo = campo + 1;
      |CAMPO_MODIFICA #calibemi#campo#, 1, alfa1;
      #calibemi#campo# = 0;
   |SIGUE;
   |SI Campo = 35;  |PINDA #0#0;  |FINSI;
|FPRC;

|PROCESO sacaimpo;

   |CAMPO_MODIFICA #calibemi#38 ,1, "N"; |CAMPO_MODIFICA #calibemi#39 ,1, "N";
   |CAMPO_MODIFICA #calibemi#41 ,1, "N"; |CAMPO_MODIFICA #calibemi#57 ,1, "N";
   |CAMPO_MODIFICA #calibemi#59 ,1, "N"; |CAMPO_MODIFICA #calibemi#53 ,1, "N";
   |CAMPO_MODIFICA #calibemi#54 ,1, "N"; |CAMPO_MODIFICA #calibemi#56 ,1, "N";
   |CAMPO_MODIFICA #calibemi#58 ,1, "N"; |CAMPO_MODIFICA #calibemi#60 ,1, "N";

   |SI #calibemi#37 = "S";
         |CAMPO_MODIFICA #calibemi#38, 1, "N"; #calibemi#38 = 0;    |PINTA #calibemi#38;
         |CAMPO_MODIFICA #calibemi#39, 1, "N"; #calibemi#39 = 0;    |PINTA #calibemi#39;
         |CAMPO_MODIFICA #calibemi#59, 1, "N"; #calibemi#59 = 0;    |PINTA #calibemi#59;
         #calibemi#40 = 0;    |PINTA #calibemi#40;
         |CAMPO_MODIFICA #calibemi#41, 1, "N"; #calibemi#41 = #calibemi#7; |PINTA #calibemi#41;
         |CAMPO_MODIFICA #calibemi#57, 1, "N"; #calibemi#57 = "";          |PINTA #calibemi#57;
         |CAMPO_MODIFICA #calibemi#53, 1, "N"; #calibemi#53 = 0;     |PINTA #calibemi#53;
         |CAMPO_MODIFICA #calibemi#54, 1, "N"; #calibemi#54 = 0;     |PINTA #calibemi#54;
         |CAMPO_MODIFICA #calibemi#60, 1, "N"; #calibemi#60 = 0;     |PINTA #calibemi#60;
         #calibemi#55 = 0;     |PINTA #calibemi#55;
         |CAMPO_MODIFICA #calibemi#56, 1, "N"; #calibemi#56 = #calibemi#52; |PINTA #calibemi#56;
         |CAMPO_MODIFICA #calibemi#58, 1, "N"; #calibemi#57 = "  ";         |PINTA #calibemi#58;
   |SINO;
      |SI #calibemi#49 ! "I";
         |CAMPO_MODIFICA #calibemi#38 ,1, "S";
         |CAMPO_MODIFICA #calibemi#39 ,1, "S";
         |CAMPO_MODIFICA #calibemi#41 ,1, "S";
         |CAMPO_MODIFICA #calibemi#57 ,1, "S";
         |CAMPO_MODIFICA #calibemi#59 ,1, "S";
      |FINSI;
      |SI #calibemi#49 ! "R";
         |CAMPO_MODIFICA #calibemi#53 ,1, "S";
         |CAMPO_MODIFICA #calibemi#54 ,1, "S";
         |CAMPO_MODIFICA #calibemi#56 ,1, "S";
         |CAMPO_MODIFICA #calibemi#58 ,1, "S";
         |CAMPO_MODIFICA #calibemi#60 ,1, "S";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO sumaimpo;
   #calibemi#40 = #calibemi#38 + #calibemi#39 + #calibemi#59;
   |PINTA #calibemi#40;
|FPRC;

|PROCESO sumaimpo2;
   #calibemi#55 = #calibemi#53 + #calibemi#54 + #calibemi#60;
   |PINTA #calibemi#55;
|FPRC;

|PROCESO leegrupo; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI #calibemi#Campo# = 0; |ACABA; |FINSI;
   |ABRE #dsmom035;
   #dsmom035#0 = #calibemi#Campo#;
   |LEE 001#dsmom035.=;
   salidas = FSalida;
   |CIERRA #dsmom035;
   |SI salidas ! 0;
      |MENAV men2;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO cuadro; |TIPO 7;
   |PUSHV  1721 2380;
   |CUADRO 1721 2380;
   |ATRI R;
   |PINTA 1722, " ----------- FORMATO LIBRO FACTURAS EMITIDAS ------------ ";
   |PINTA 1822, " ( 1) Descr. Fra., Nombre cliente, varias lineas          ";
   |PINTA 1922, " ( 2) Nombre y NIF cliente, una linea                     ";
   |PINTA 2022, " ( 3) Descr. Fra., Nombre cliente, una linea              ";
   |PINTA 2122, " ( 4) Nombre y NIF cliente, una linea s/recargo           ";
   |PINTA 2222, " ( 5) Descr. Fra., Nombre cliente, una linea s/recargo    ";
   |ATRI r;
|FPRC;

|PROCESO repon; |TIPO 0;
   |POPV;
|FPRC;

|PROCESO GrupoConcep;
   SwError = 1;
   |ABRE #dsmom036;
   |PARA Cont = 43; |SI Cont [ 46; |HACIENDO Cont = Cont + 1;
      |SI #calibemi#Cont# ! 0;
         #dsmom036#0 = #calibemi#Cont#;
         #dsmom036#1 = #camaniva#27;
         |LEE 010#dsmom036.=;
         |SI FSalida = 0;
             SwError = 0;
             |SAL;
         |FINSI;
      |FINSI;
   |SIGUE;
   |CIERRA #dsmom036;
|FPRC;

|PROCESO Conceptos;
   |SI #calibemi#42 = "S";
      |HAZ GrupoConcep;
      |SI SwError = 1; |ACABA; |FINSI;
   |SINO;
      |SI #calibemi#11 = "S";
         SwError = 1;
         |PARA Cont = 12; |SI Cont [ 35; |HACIENDO Cont = Cont + 1;
            |SI #camaniva#27 = #calibemi#Cont#; SwError = 0; |SAL; |FINSI;
         |SIGUE;
         |SI SwError = 1; |ACABA; |FINSI;
      |SINO;
         SwError = 0;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO LineasFactura;

   |SI #caivalin#17 = "S"; |Y TipoLibro = "R"; |ACABA; |FINSI;
   |SI #caivalin#17 = "N"; |Y TipoLibro = "I"; |ACABA; |FINSI;

   Calc = ContLin + 3;
   |SI Calc ] NumLineas;
      SwTotFac = 1;
      |SI #calibemi#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
      SwTotFac = 0;
      |HAZ VeteFinal;
      Pagina = Pagina + 1;
      SwCabFac = 1;
      |SI #calibemi#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
      SwCabFac = 0;
   |FINSI;

   SwLinFac = 1;
   |SI SwPrint = 0; |PRINT; ContLin = ContLin + 1; |FINSI;
   SwLinFac = 0;
   TB  = TB  + #caivalin#6;  TLB = TLB + #caivalin#6;
   TI  = TI  + #caivalin#8;  TLI = TLI + #caivalin#8;
   TR  = TR  + #caivalin#10; TLR = TLR + #caivalin#10;
   TD  = TD  + #caivalin#11; TLD = TLD + #caivalin#11;
   TF  = TF  + (#caivalin#6 + #caivalin#8 + #caivalin#10 - #caivalin#11);
   TLF = TLF + (#caivalin#6 + #caivalin#8 + #caivalin#10 - #caivalin#11);

   |SI #caivalin#17 = "N";
      |SI TipoLibro = "R";
         #calibemi#38 = TLB;
         #calibemi#39 = TLI;
         #calibemi#59 = TLR;
         #calibemi#40 = TLF;
      |FINSI;
   |SINO;
      |SI TipoLibro = "I";
         #calibemi#53 = TLB;
         #calibemi#54 = TLI;
         #calibemi#60 = TLR;
         #calibemi#55 = TLF;
      |FINSI;
   |FINSI;
   SwPinta = 0;

   ||SI #calibemi#47 ! 1; ContLin = ContLin - 4; |FINSI;
|FPRC;

|DEFBUCLE LineasFactura;
#caivalin#1;
;
#camaniva#0,#camaniva#1,01;
#camaniva#0,#camaniva#1,99;
;
NULL,LineasFactura;
|FIN;

|PROCESO Facturas;
   |HAZ Conceptos;
   |SI SwError = 1; |ACABA; |FINSI;

   |SI #camaniva#35 = "I"; |Y TipoLibro = "R"; |ACABA; |FINSI;
   |SI #camaniva#35 = "N"; |Y TipoLibro = "I"; |ACABA; |FINSI;

   |SI #calibemi#10 = 1; |O #calibemi#10 = 3;
      fecha_i = #camaniva#4;
   |SINO;
      fecha_i = #camaniva#8;
   |FINSI;

   |SI TipoLibro = "R";
      NumRegis = #calibemi#7;
   |SINO;
      NumRegis = #calibemi#52;
   |FINSI;

   |SI NumRegis ! 0;
      regis = regis + 1;
   |SINO;
      regis = #camaniva#3;
   |FINSI;

   |SI #calibemi#37 = "S";
      Calc = ContLin + 5;
      |SI Calc ] NumLineas;
         |HAZ VeteFinal;
         Pagina = Pagina + 1;
      |FINSI;

      |SI fecha_i < #calibemi#3;
         SwPrint = 1;
      |SINO;
         SwPrint = 0;
      |FINSI;

      |SI fecha_i > #calibemi#4; |ACABA; |FINSI;

   |SINO;
      |SI TipoLibro = "R";
         Serie = #calibemi#57; Factura = #calibemi#41;
      |SINO;
         Serie = #calibemi#58; Factura = #calibemi#56;
      |FINSI;

      |SI #camaniva#2 < Serie;
         |ACABA;
      |SINO;
         |SI #camaniva#3 < Factura;
            |ACABA;
         |SINO;
            Calc = ContLin + 5;
            |SI Calc ] NumLineas;
               |HAZ VeteFinal;
               Pagina = Pagina + 1;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   SwHayDatos = 1;
   SwCabFac = 1;
   |SI #calibemi#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
   SwCabFac = 0; SwPinta = 1;
   TF = 0; TB = 0; TI = 0; TR = 0; TD = 0;
   |BUCLE LineasFactura;
   SwTotFac = 1;
   |SI #calibemi#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
   SwTotFac = 0;
|FPRC;

|DEFBUCLE Facturas1;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#4;
|FIN;

|DEFBUCLE Facturas2;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#8;
|FIN;

|DEFBUCLE Facturas3;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#2,#camaniva#3,#camaniva#4;
|FIN;

|DEFBUCLE Facturas4;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#2,#camaniva#3,#camaniva#8;
|FIN;

|PROCESO Libros;
   |SI #calibemi#49 = "R"; |O #calibemi#49 = "D";
      SwHayDatos = 0;
      TipoLibro = "R";
      varalf = #calibemi#1;
      Pagina = #calibemi#6 + 1;
      |SI #calibemi#37 = "N";
         TLF = #calibemi#40; TLB = #calibemi#38; TLI = #calibemi#39; TLR = #calibemi#59;
      |FINSI;
      |SI #calibemi#10 = 1; |BUCLE Facturas1; |FINSI;
      |SI #calibemi#10 = 2; |BUCLE Facturas2; |FINSI;
      |SI #calibemi#10 = 3; |BUCLE Facturas3; |FINSI;
      |SI #calibemi#10 = 4; |BUCLE Facturas4; |FINSI;
      |SI SwHayDatos = 1;
         SwTToFac = 1; |PRINT; SwTToFac = 0;
         |HAZ VeteFinal;
      |FINSI;
      TF  = 0; TB  = 0; TI  = 0; TR  = 0; TD  = 0;
      TLF = 0; TLB = 0; TLI = 0; TLR = 0; TLD = 0;
   |FINSI;
   |SI #calibemi#49 = "I"; |O #calibemi#49 = "D";
      SwHayDatos = 0;
      TipoLibro = "I";
      varalf = #calibemi#50;
      Pagina = #calibemi#51 + 1;
      |SI #calibemi#37 = "N";
         TLF = #calibemi#55; TLB = #calibemi#53; TLI = #calibemi#54; TLR = #calibemi#60;
      |FINSI;
      |SI #calibemi#10 = 1; |BUCLE Facturas1; |FINSI;
      |SI #calibemi#10 = 2; |BUCLE Facturas2; |FINSI;
      |SI #calibemi#10 = 3; |BUCLE Facturas3; |FINSI;
      |SI #calibemi#10 = 4; |BUCLE Facturas4; |FINSI;
      |SI SwHayDatos = 1;
         SwTToFac = 1; |PRINT; SwTToFac = 0;
         |HAZ VeteFinal;
      |FINSI;
   |FINSI;

|FPRC;

|DEFBUCLE Libros;
#calibros#1;
2;
#calibemi#0 ,"R";
#calibemi#48,"R";
;
NULL,Libros;
|FIN;

|PROCESO VeteFinal;
   SwBlanco = 1;
   |PARA; |SI ContLin < NumLineas; |HACIENDO ContLin = ContLin + 1;
      |SI SwPrint = 0; |PRINT; |FINSI;
   |SIGUE;
   |SI SwPrint = 0; |PIEINF; |FINSI;
   SwBlanco = 0;
   |SI TLF ! 0; ContLin = 10; |SINO; ContLin = 9; |FINSI;
|FPRC;

|PROGRAMA;
   |HAZ inicio;
   |HAZ eParaModelos;

   |CLS;
   |CABEZA "Libro de facturas emitidas";
   |ABRE #calibemi;
   |LEE 010#calibemi.p;
   |SI FSalida ! 0;
      |DDEFECTO #calibemi;
      #calibemi#3 = fec1;
      #calibemi#4 = fec2;
      |GRABA 020#calibemi.n;
      |LEE 010#calibemi.p;
   |FINSI;
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      ContLin = 9;
      regis = #calibemi#7; |SI regis ! 0; regis = regis - 1; |FINSI;
      |IMPRE 0;
      |SI FSalida < 0; |ACABA; |FINSI;
      |SI #calibemi#47 = 1; |INFOR "calibem1"; |FINSI;
      |SI #calibemi#47 = 2; |INFOR "calibem2"; |FINSI;
      |SI #calibemi#47 = 3; |INFOR "calibem3"; |FINSI;
      |SI #calibemi#47 = 4; |INFOR "calibem4"; |FINSI;
      |SI #calibemi#47 = 5; |INFOR "calibem5"; |FINSI;
      |SI FSalida ] 0;
         fecinf = #calibemi#5;
         |BUCLE Libros;
         |FININF;
      |FINSI;
      |FINIMP;
      DiasFecha = #calibemi#4;
      |SI #calibemi#4 ! fec2; DiasFecha = DiasFecha + 1; |FINSI;
      #calibemi#3 = DiasFecha;
      #calibemi#4 = fec2;
      |GRABA 020#calibemi.a;
   |FINSI;
   |CIERRA #calibemi;
|FPRO;
