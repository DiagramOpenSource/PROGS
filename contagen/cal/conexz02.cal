|FICHEROS;
    conexz02 #0;       || Informe suma y saldos Analitica

    anm00005 #4;       || Selector

    conexcel #11;
    caselem1 #12;
|FIN;

|VARIABLES;
  mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
  mensa2 = "    FECHA ERRONEA !!!";
  mensa3 = "    CUENTA ANALITICA ERRONEA !!!";

  error1 = "0000Nivel repetido";
  error2 = "0000No existe informe";
  error3 = "0000El n§ niveles no coincide con el n§ niveles Analitica de la Empresa";
  error4 = "0000Nivel de Rotura erroneo !";

  nCalc1  = 0;
  nCont   = 0;
  nivel   = 0;
  alfa1 = "";
  alfa2 = "";
  alfa3 = "";
  nume1 = 0;
  nume2 = 0;

  aAlfa    = "";
  aAlfa1   = "";

  aMas     = "";
  aFichero = "";
  nNivCta  = 0;
  nLNvCta  = 0;
  nSw      = 0;

{50}&aDatos  = "";
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoan_i;
|INCLUYE digana_i;

|CALCULO comienzo; |TIPO 8;
 |HAZ InicioAna;
 |SI enSwAna = 0; |ACABA; |FINSI;

 |C_M #0#6,1,"N";
 |C_M #0#7,1,"N";
 |C_M #0#8,1,"N";
 |C_M #0#9,1,"N";
 |C_M #0#10,1,"N";

 |SI nAdig0 > 1;
     |C_M #0#6,1,"S";
 |FINSI;
|FCAL;

|CALCULO LeeSelec; |TIPO 6;
 |SI #0Campo = 0;
     #0#1 = "SIN SELECTOR DE CUENTAS";
 |SINO;
     |ABRE #4;
     #4#0 = #0Campo;
     |LEE 001#4=;
     |SI FSalida ! 0;
         #4#1 = "ERROR SELECTOR NO EXISTE";
         |ERROR;
     |FINSI;
     #0#1 = #4#1;
     |CIERRA #4;
 |FINSI;
 |PINTA #0#1;
|FCAL;

|CALCULO defecto; |TIPO 7;
 #0#2 = fec1;
 #0#3 = fec2;
 |PINTA #0#2;
 |PINTA #0#3;
 |SI dig4 [ 4; |Y dig4 ! 0; #0#41 = 1; |FINSI;
 |SI dig5 [ 4; |Y dig5 ! 0; #0#41 = 2; |FINSI;
 |SI dig6 [ 4; |Y dig6 ! 0; #0#41 = 3; |FINSI;
 |SI dig7 [ 4; |Y dig7 ! 0; #0#41 = 4; |FINSI;
 |SI dig8 [ 4; |Y dig8 ! 0; #0#41 = 5; |FINSI;
 |SI dig9 [ 4; |Y dig9 ! 0; #0#41 = 6; |FINSI;
 |PINTA #0#41;
|FCAL;

|CALCULO fecha; |TIPO 0;
  |SI #0Campo < fec1; |O #0Campo > fec2;
      |MENAV mensa1;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI Campo = 3;
      |SI #0#2 > #0#3;
          |MENAV mensa2;
          |ERROR;
      |FINSI;
  |FINSI;
|FCAL;


|CALCULO anacta; |TIPO 6;
  salidas = FSalida;
  |HAZ FPuntosAna;

  |SI Campo = 5;
      |SI #0#4 > #0#5;
          |MENAV mensa3;
          |ERROR;
      |FINSI;
  |FINSI;
|FCAL;

|CALCULO rotura;|TIPO 0;
  |SI #0Campo ] nAdig0;
      |MENAV error3;
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO nivel; |TIPO 7;
 |C_M #0Campo, 1,"S";
 |SI Campo = 7; |Y #0#6 < 1; || Si solo hemos seleccionado
     #0Campo = 0; |PINTA #0Campo;
     |C_M #0Campo, 1,"N";
 |FINSI;
 |SI Campo = 8; |Y #0#6 < 2; || Si solo hemos seleccionado
     #0Campo = 0; |PINTA #0Campo;
     |C_M #0Campo, 1,"N";
 |FINSI;
 |SI Campo = 9; |Y #0#6 < 3; || Si solo hemos seleccionado
     #0Campo = 0; |PINTA #0Campo;
     |C_M #0Campo, 1,"N";
 |FINSI;
 |SI Campo = 10; |Y #0#6 < 4; || Si solo hemos seleccionado
    #0Campo = 0; |PINTA #0Campo;
    |C_M #0Campo, 1,"N";
 |FINSI;
|FCAL;

|CALCULO nivelrep;|TIPO 0;  || Para comprobar que no repetimos los niveles
 |SI #0Campo ! 0; |Y #0Campo ] nAdig0;
      |MENAV error4;
      |ERROR;
      |ACABA;
 |FINSI;

 |SI nivel = 0;        || Buscamo el nivel mas bajo;
     nivel = #0#7;
 |FINSI;

 |SI Campo = 8;
    |SI #0#8 = #0#7; |Y #0#8 ! 0;    || Si hay dos niveles iguales error
      |MENAV error1;
      |ERROR;
      |ACABA;
    |SINO;
       |SI #0#8 < #0#7;  || Busca el nivel mas alto
           nivel = #0#8;
       |SINO;
           nivel = #0#7;
       |FINSI;
    |FINSI;
 |FINSI;

 |SI Campo = 9; |Y #0#9 ! 0;
    |SI #0#9 = #0#7; |O #0#9 = #0#8; || Si hay dos niveles iguales error
       |MENAV error1;
       |ERROR;
       |ACABA;
    |FINSI;

    |SI #0#9 < nivel;  || Busca el nivel mas alto
        nivel = #0#9;
    |FINSI;
 |FINSI;

 |SI Campo = 10; |Y #0#10 ! 0;      || Si hay dos niveles iguales error
    |SI #0#10 = #0#7; |O #0#10 = #0#8; |O #0#10 = #0#9;
       |MENAV error1;
       |ERROR;
       |ACABA;
    |FINSI;

    |SI #0#10 < nivel;  || Busca el nivel mas alto
        nivel = #0#10;
    |FINSI;
 |FINSI;
|FCAL;

|CALCULO h_concepto;
 |SI #0#17 > #0#18;
     |MENAV "    ERROR EN SELECCION DE CONCEPTOS";
     |ERROR;
 |FINSI;
|FCAL;

|CALCULO nomodi; |TIPO 0;
 |C_M #0Campo,0,alfa1;
 |SI alfa1 = "N"; |ACABA; |FINSI;
 |SI #0Campo = 0; alfa2 = "N"; |FINSI;
 |SI #0Campo ! 0; alfa2 = "S"; |FINSI;

     |PARA nume1 = Campo + 1;  |SI nume1 [ 38;  |HACIENDO nume1 = nume1 + 1;
           #0nume1 = 0;
           |C_M #0nume1, 1, alfa2;
     |SIGUE;
|FCAL;

|CALCULO seleccio_c; |TIPO 0;
 |SI #0#16 = "N";
     |PARA nume1 = 19; |SI nume1 [ 38; |HACIENDO nume1 = nume1 + 1;
           |C_M #0nume1,1,"S";
     |SIGUE;
     |C_M #0#17, 1, "N";
     |C_M #0#18, 1, "N";
     #0#17 = 1;       |PINTA #0#17;
     #0#18 = 999;     |PINTA #0#18;
 |SINO;
     |PARA nume1 = 19; |SI nume1 [ 38; |HACIENDO nume1 = nume1 + 1;
           |C_M #0nume1,1,"N";
           #0nume1 = 0; |PINTA #0nume1;
     |SIGUE;
     |C_M #0#17, 1, "S";
     |C_M #0#18, 1, "S";
 |FINSI;
|FCAL;

|CALCULO AntesDesg; |TIPO 7;
 alfa1 = #0#40; |C_M #0#41,1,alfa1;
|FCAL;

|PROCESO DespDesg; |TIPO 0;
  nNivCta = #0#41; nSw = 0;
  |SI nNivCta = 1; |Y dig4 = 0; nSw = 1; |FINSI;
  |SI nNivCta = 2; |Y dig5 = 0; nSw = 1; |FINSI;
  |SI nNivCta = 3; |Y dig6 = 0; nSw = 1; |FINSI;
  |SI nNivCta = 4; |Y dig7 = 0; nSw = 1; |FINSI;
  |SI nNivCta = 5; |Y dig8 = 0; nSw = 1; |FINSI;
  |SI nNivCta = 6; |Y dig9 = 0; nSw = 1; |FINSI;
  |SI nSw = 1;
      |MENAV "    Nivel Incorrecto";
      |ERROR;
  |FINSI;
|FPRC;

|PROCESO Multiempre;
   aAlfa = #caselem1#1; |QBF aAlfa;
   aAlfa = (("00000" + aAlfa) % -105) + #caselem1#2;
   aAlfa1 = #48#2; |QBF aAlfa1;
   aAlfa1 = (("00000" + aAlfa1) % -105) + #48#3;
   |SI aAlfa = aAlfa1;
      aDatos3 = #conexz02#2; aDatos4 = #conexz02#3;
   |SINO;
      aDatos3 = "01.01.2000"; aDatos4 = "31.12.2099";
   |FINSI;
   |SI aAlfa ! "000000";
      aAlfa = "any00005.tab;" + aAlfa; |SUB_EJECUTA aAlfa;
   |FINSI;
|FPRC;

|DEFBUCLE Multiempre;
#caselem1#1;
;
INICIO;
FINAL;
;
NULL,Multiempre;
|FIN;

|| *************************************************************************
|| ****************** COMIENZO CON TIPO 3 **********************************
|| *************************************************************************

|CALCULO tipo3; |TIPO 3;
   |PARA nCont = 0; |SI nCont [ 45; |HACIENDO nCont = nCont + 1;
      IaDatos = aDatos1<-; IaDatos = IaDatos + nCont;
      aDatos = #conexz02#nCont#;
   |SIGUE;

   |ABRE #conexcel;
   #conexcel#33 = #conexz02#46;
   |LEE 000#conexcel.=;
   |SI FSalida = 0;
      |SI #conexcel#35 = "S";

         |SUB_EJECUTA "caselemp.tab";
         |NOME_DAT #caselem1#eaFichsel#;
         |BUCLE Multiempre;
         |DELINDEX #caselem1;
      |SINO;
         |PARA nCont = 3; |SI nCont [ 30; |HACIENDO nCont = nCont + 3;
            nCalc1 = nCont + 1;
            aAlfa = #conexcel#nCont#; |QBF aAlfa;
            aAlfa = (("00000" + aAlfa) % -105) + #conexcel#nCalc1#;
            aAlfa1 = #48#2; |QBF aAlfa1;
            aAlfa1 = (("00000" + aAlfa1) % -105) + #48#3;
            |SI aAlfa = aAlfa1;
               aDatos3 = #conexz02#2; aDatos4 = #conexz02#3;
            |SINO;
               aDatos3 = "01.01.2000"; aDatos4 = "31.12.2099";
            |FINSI;
            |SI aAlfa ! "000000";
               aAlfa = "any00005.tab;" + aAlfa; |SUB_EJECUTA aAlfa;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;
   |CIERRA #conexcel;

   aAlfa = #conexz02#46; |QBF aAlfa;
   aAlfa = (("0000" + aAlfa) % -104);
   aAlfa = "conexz01.tab;" + aAlfa;
   |SUB_EJECUTA aAlfa;

   |ABRE #conexcel;
   #conexcel#33 = #conexz02#46;
   |LEE 101#conexcel.=;
   |SI FSalida = 0;
      |SI #conexcel#35 = "S";
         |PARA nCont = 3; |SI nCont [ 30; |HACIENDO nCont = nCont + 3;
            nCalc1 = nCont + 1;
            #conexcel#nCont#  = 0;
            #conexcel#nCalc1# = 0;
         |SIGUE;
         |GRABA 020#conexcel.a;
      |FINSI;
      |LIBERA #conexcel;
   |FINSI;
|FCAL;

|PROGRAMA;
  |CLS;
  |CABEZA "Balance Sumas y Saldos Ctas Analiticas";

  |HAZ inicio;
  |HAZ Analitica;
  |SI  enSwAna = 0;
       alfa1 = "    CONTABILIDAD NO ANALITICA ";
       |SI eaAnNiv = "E";
           alfa1 = "    EMPRESA NO ANALITICA ";
       |FINSI;
       |MENAV alfa1;
       |ACABA;
  |FINSI;

  |C_M #0#6,1,"N";
  |C_M #0#7,1,"N";
  |C_M #0#8,1,"N";
  |C_M #0#9,1,"N";
  |C_M #0#10,1,"N";
  |SI nAdig0 > 1; |C_M #0#6,1,"S"; |FINSI;

  |ABRE #0;
  |LEE 001#0p;
  |SI FSalida ! 0;
      |DDEFECTO #0;

      #0#2 = fec1;
      #0#3 = fec2;
      |SI dig4 [ 4; |Y dig4 ! 0; #0#41 = 1; |FINSI;
      |SI dig5 [ 4; |Y dig5 ! 0; #0#41 = 2; |FINSI;
      |SI dig6 [ 4; |Y dig6 ! 0; #0#41 = 3; |FINSI;
      |SI dig7 [ 4; |Y dig7 ! 0; #0#41 = 4; |FINSI;
      |SI dig8 [ 4; |Y dig8 ! 0; #0#41 = 5; |FINSI;
      |SI dig9 [ 4; |Y dig9 ! 0; #0#41 = 6; |FINSI;
      |GRABA 020#0c;
  |FINSI;

||  FSalida = 0;
||  |PARA;|SI FSalida = 0; |HACIENDO;
         |PINPA #0#0;
         |PINDA #0#0;                    || Pinta los datos por defecto
         |ENDATOS #1#0;                  || Seleccion informe
||  |SIGUE;

  |GRABA 020#0a;
  |CIERRA #0;

|FPRO;
