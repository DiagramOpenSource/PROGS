|FICHEROS;
  caz00004 #10;
  caw00007 #1,MANTE;

  calendar #3;
  cacalend #13;
  cavenaut #4;

  caivaasi #200;

  :/basica/def/agicen14 #114;

  caconvec #20;
  caconvel #21;
  cacuenta #22;
|FIN;

|VARIABLES;
 &enCalen = 0;
 &eSwNoCrea = 0;

 nInkey   = 0;
 nSwSal   = 0;
 aFichero = "";
 aAlfUlt  = "";
 aAlfa1   = "";
 aAlfa2   = "";
 aAlfa3   = "";
 aAlfa4   = "";
 nNume1   = 0;
 nNume2   = 0;
 nNume3   = 0;
 nNume4   = 0;
 nNume5   = 0;
 nNPeso   = 0;
 nVPeso   = 0;
 ndMes    = 0;
 nhMes    = 0;
 y        = 0;
 nT1      = 0;
 nT2      = 0;
 nDia     = 0;
 aDia     = "";
 aRV      = "";
 aRH      = "";
 nModoEntrada = 0;
 nLnEstado    = 0;

 nPara1   = 0;
 nPara2   = 0;
 nPara3   = 0;
 fFecha1  = @;
 fFecha   = @;

 nTotal   = 0;
 nMensual = 0;
 nPDSem   = 0;
 nTDMes   = 0;
 nSaldo   = 0;
 &DVentas = "";
 nsw      = 0;
|FIN;

|INCLUYE dscont_i;

|| /////////////////////// PROCESOS DE TRABAJO \\\\\\\\\\\\\\\\\\\\
|| ******************************************** Calculos Pantalla

|CALCULO TrasCalendar; |TIPO 0;
  |SI #10Campo = 0;
      aAlfa1 = "1";
      #3#13 = enEjercicio;
      #3#1  = aAlfa1 * 31;  #3#2  = aAlfa1 * 29;  #3#3  = aAlfa1 * 30;
      #3#4  = aAlfa1 * 30;  #3#5  = aAlfa1 * 31;  #3#6  = aAlfa1 * 30;
      #3#7  = aAlfa1 * 31;  #3#8  = aAlfa1 * 31;  #3#9  = aAlfa1 * 30;
      #3#10 = aAlfa1 * 31;  #3#11 = aAlfa1 * 30;  #3#12 = aAlfa1 * 31;
      |ACABA;
      #13#159 = "Sin Calendario ";
      |PINTA 0721, #13#159;
  |FINSI; ||Sin Calendario

  |ABRE #13;
  #3#0 = #10Campo;
  |LEE 001#13=;
  |SI FSalida ! 0;
      |MENAV "    Atencion. No Existe Calendario";
      |ERROR;
      |ACABA;
  |FINSI;
  |CIERRA #13;

  enCalen   = #13#0;
  eSwNoCrea = 1;
  |HAZ CreaCalend;
|FCAL;

|CALCULO wTipo12; |TIPO 12;
|FCAL;

|RUTINA ClaveBajaAxC;
 #1#0 = #10#0;
 #1#1 = #10#1;
 #1#3 = 1;
|FRUT;

|RUTINA ClaveAltaAxC;
 #1#0 = #10#0;
 #1#1 = #10#1;
 #1#3 = 12;
|FRUT;

|PROCESO wTipo3; |TIPO 11;

 nInkey = FSalida;

 |SI nInkey = 10;

     nSwSal = 0;
     |ENTLINEAL #1#1, -3, 2, 21, 0, ClaveBajaAxC, ClaveAltaAxC;
     |GRABA 020#10a;

     |CONFI "    SActualizar Ventas Contado del Departamento S/N ?";
     |SI FSalida = 0;

         |HAZ Actualizar;
         DVentas = #10#1;
         |CONFI "    SDesea Realizar La Contabilizacion Ahora ";
         |SI FSalida = 0;
              |CIERRAT #10;
              |SUB_EJECUTA_NP "capasven";
              |ABRET #10;
              |LEE 001#10=;
              |HAZ OtraVezTodo;
              |ERROR;
          |FINSI;
     |FINSI;
 |FINSI;
 |SI nInkey = 11;
     |CONFI "    SRecuperar Reparto Original del Departamento S/N";
     |SI FSalida = 0;
         |HAZ OtraVezTodo;
         |ERROR;
         |PTEC 808;
     |FINSI;
 |FINSI;
|FPRC

|CALCULO PresentaLinea;  |TIPO 7;

  |ABRE #1;
  #1#0 = #10#0;
  #1#1 = #10#1;
  #1#3 = 1;
  |LEE 001#1];
  |SI FSalida ! 0; |O #1#0 ! #10#0; |O #1#1 ! #10#1;
      |DDEFECTO #1;
  |FINSI;
  |CIERRA #1;

  |HAZ Tipo7W7;
  |PINDA #0#1;

  |ENTLINEAL #1#1, -3, 7, 21, 0, ClaveBajaAxC, ClaveAltaAxC;
|FCAL;

|CALCULO wTipo0; |TIPO 0;
  |SI #10#4 > "01.01.1900";
      aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
      |CONFI aAlfa1;
      |SI FSalida ! 0;
          |ERROR;
          |ACABA;
      |FINSI;
  |FINSI;
  |SI #10#5 = "S";
      |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Movimientos ? ";
      |SI FSalida ! 0;
         |ERROR;
         |ACABA;
      |FINSI;
  |FINSI;
|FCAL;


|PROCESO BorroMes;
 #21#11 = "N";
 #21#12 = " ";
 #21#13 = " ";
 |GRABA 020#21a;
 |LIBERA #21;
|FPRC;

|DEFBUCLE borrarMes;
 #21#1;
 ;
 #10#1,00;
 #10#1,99;
 be;
 NULL, BorroMes;
|FIN;

|PROCESO Borrolin;
 |BORRA 020#4a;
 |LIBERA #4;
|FPRC;

|DEFBUCLE borrarVentas;
 #4#1;
 ;
 00001, 1, #10#1;
 99999, 4, #10#1;
 be;
 NULL, Borrolin;
|FIN;

|PROCESO BorraElemento;
 |BORRA 020#1a;
 |LIBERA #1;
|FPRC;

|DEFBUCLE borrarElementos;
 #1#1;
 ;
 #10#0,#10#1, 1;
 #10#0,#10#1,12;
 e;
 NULL, BorraElemento;
|FIN;

|CALCULO wTipo1; |TIPO 1;
 nModoEntrada = (FEntrada / 100) ! 0;
 |SI nModoEntrada = 2;
    |ERROR;
    |PTEC 824;
 |FINSI;
 |SI nModoEntrada = 3;
     |CONFI "    NEsta Seguro de Borrar las Ventas de Este departamento ";
     |SI FSalida ! 0;
         |ERROR;
         |ACABA;
     |FINSI;
     |BUCLE borrarElementos;
     |BUCLE borrarVentas;
     |BUCLE borrarMes;
 |FINSI;
|FCAL;


|| -----------------------------------------------------------------------
|PROCESO OtraVezTodo;

 |BUCLE borrarElementos;
 nTotal = 0;
 ndMes  = 1;
 nhMes  = 12;
 |HAZ CreoMeses;

 #10#7 = nTotal;
 |GRABA 020#10a;
 |PINTA #10#7;
|FPRC;

|PROCESO OtraVezMes;

  nTotal = #10#7 - #1#46;

  |PDEFECTO #1, 4,47;

  nPara1 = #1#3;
  NumMes = #1#50;
  nPDSem = #1#47;
  nTDMes = #1#48;
  |HAZ CargaVentas;
  |GRABA 020#1a;

  #10#7 = nTotal; |PINTA #10#7;
|FPRC;
|| -----------------------------------------------------------------------
|| -----------------------------------------------------------------------

|PROCESO CreoMeses;
  |ABRE #1;

  |PARA nPara1 = ndMes; |SI nPara1 [ nhMes; |HACIENDO nPara1 = nPara1 + 1;

        NumMes = dig1 + (nPara1 - 1);
        |SI NumMes > 12; NumMes = NumMes - 12; |FINSI;
        |HAZ NombreMes;

        aAlfa1 = NumMes; |QBF aAlfa1;
        aAlfa1 = ("00" + aAlfa1) % -102;
        aAlfa2 = enEjercicio;
        aAlfa3 = "01." + aAlfa1 + "." + aAlfa2;
        fFecha = aAlfa3;
        fFecha1 = fFecha % 1;
        aAlfa3 = fFecha1 % 1102;
        |SI aAlfa3 = "Lu";  nPDSem = 1; |FINSI;
        |SI aAlfa3 = "Ma";  nPDSem = 2; |FINSI;
        |SI aAlfa3 = "Mi";  nPDSem = 3; |FINSI;
        |SI aAlfa3 = "Ju";  nPDSem = 4; |FINSI;
        |SI aAlfa3 = "Vi";  nPDSem = 5; |FINSI;
        |SI aAlfa3 = "Sa";  nPDSem = 6; |FINSI;
        |SI aAlfa3 = "Do";  nPDSem = 7; |FINSI;
        nTDMes = 31;
        |SI NumMes = 4; |O NumMes = 6; |O NumMes = 9; |O NumMes = 11;
            nTDMes = 30;
        |SINO;
            |SI NumMes = 2;
                nTDMes = 28;
                |SI enEjercicio = 1992; |O enEjercicio = 1996; |O enEjercicio = 2000;
                    |O enEjercicio = 2004; |O enEjercicio = 2008; |O enEjercicio = 2012;
                    |O enEjercicio = 2016; |O enEjercicio = 2020; |O enEjercicio = 2024;
                       nTDMes = 29;
                |FINSI;
            |FINSI;
        |FINSI;

        |DDEFECTO #1;
        #1#0 = enEmpresa;
        #1#1 = #10#1;
        #1#2 = #10#6;
        #1#3 = nPara1;
        #1#47 = nPDSem;
        #1#48 = nTDMes;
        #1#49 = NombreMes;
        #1#50 = NumMes;

        |PARA nDia = 1; |SI nDia [ nTDMes; |HACIENDO nDia = nDia + 1;
              nNPeso = nDia + 50;
              nNume5 = (nDia * 100 ) + 1;
              aAlfa4   = #3NumMes; aAlfa4 = aAlfa4 % nNume5;
              nVPeso   = aAlfa4;
              #1nNPeso = nVPeso;
        |SIGUE;

        |HAZ CargaVentas;
        |GRABA 020#1n;
  |SIGUE;

  |CIERRA #1;
|FPRC;


|PROCESO CreaAuxi;
  #10#0 = #114#0;  ||Empresa
  aAlfa1 = #114#1; |QBF aAlfa1;
  aAlfa1 = ("00" + aAlfa1) % -102;
  #10#1 = aAlfa1;  ||Actividad
  #10#2 = #114#4;  ||Descripcion
  #10#3 = #114#5;  ||Fecha Alta
  #10#4 = #114#6;  ||Fecha Baja
  #10#5 = #114#14; ||Comunero
  #10#6 = enEjercicio;

  nTotal = 0;
  ndMes  = 1;
  nhMes  = 12;
  |HAZ CreoMeses;

  #10#7 = nTotal;
  |GRABA 020#10n;

  aAlfUlt = #10#1;
|FPRC;

|DEFBUCLE caz00004;
 #114#1;
 ;
 enEmpresa, 01;
 enEmpresa, 99;
 e;
 NULL, CreaAuxi;
|FIN;

|| ************************************************************************
|RUTINA ClaveBaja10;
 #10#0 = enEmpresa;
 #10#1 = "  ";
|FRUT;

|RUTINA ClaveAlta10;
 #10#0 = enEmpresa;
 #10#1 = aAlfUlt;
|FRUT;

||  ***********************************************************************

|PROGRAMA;
 |HAZ inicial;
 |SI swerror = 2;
     |PTEC 807;
     |ACABA;
 |FINSI;
 |HAZ DirAplicSt;
 |ABRE #200;
 |DDEFECTO #200;
 |LEE 001#200p;
 |CIERRA #200;

 |CLS;
 |CABEZA "Ventas Contado";

 aFichero = ("z04" + Usuario) % 108;
 |NOME_DAT #10 aFichero;
 |ABRE #10;  |CIERRA #10;  |DELINDEX #10;

 aFichero = ("w07" + Usuario) % 108;
 |NOME_DAT #1 aFichero;
 |ABRE #1;  |CIERRA #1;  |DELINDEX #1;

 |PINPA #0#10;
 |ENCAMPO #8#10;
 |SI FSalida = 7; |O FSalida = 1; |ACABA; |FINSI;
 |C_M #10#8,1,"N";


 |ABRE #10;
 |BUCLE caz00004;
 |CIERRA #10;

 |ENTLINEAL #1#10, -2, 2, 11, 0, ClaveBaja10, ClaveAlta10;

 |DELINDEX #10;
 |DELINDEX #1;
|FPRO;

|| ************************************************************************

|| .... Procesos del Auxiliar w00007
|PROCESO Tipo7W7; |TIPO 7;

 aRV = &179;  aRH = &205;  nDia   = 1;

 nNume1 = 3 + #1#47;
 nNume2 = nNume1 + #1#48 - 1;
 |PARA nPara3 = 4; |SI nPara3 [ 45; |HACIENDO nPara3 = nPara3 + 1;
       aAlfa1 = "N";
       |SI nPara3 ] nNume1; |Y nPara3 [ nNume2;
           aAlfa1 = "S";
       |FINSI;

       |CAMPO_ATRIBUTO #1nPara3, D,0,0;
       |C_V #1nPara3, 1, aAlfa1;
       |C_M #1nPara3, 1, aAlfa1;
       |C_P #1nPara3,0,nNume4;

       nNume4 = nNume4 - 1;
       nNume5 = nNume4 - 96;
       |SI aAlfa1 = "N";
           aAlfa2 = aRV + "         "+ aRV;
           |PINTA nNume4, aAlfa2;
           aAlfa3 = aRH + aRH;
           |PINTA nNume5, aAlfa3;
       |SINO;
           aDia = nDia; |QBF aDia; aDia = ("   " + aDia) % -102;
           nNPeso = nDia + 50;
           nVPeso = #1nNPeso;

           |SI #10#8 ! 0; |Y nVPeso = 0;
               |ATRI P; |PINTA nNume5, aDia; |ATRI 0;
               |C_M #1nPara3, 1, "N";
                |CAMPO_ATRIBUTO #1nPara3, S,0,0;
           |SINO;
               |ATRI I; |PINTA nNume5, aDia; |ATRI 0;
           |FINSI;
           |PINTA #1nPara3;
           nDia = nDia + 1;
       |FINSI;
 |SIGUE;
 nTotal   = #10#7;
 nMensual = #1#46;
|FPRC;

|PROCESO NoAlta; |TIPO 0;
 nLnEstado = (FEntrada/ 100) ! 0;
 |SI nLnEstado ! 2;
     |ERROR;
 |SINO;
     |PTEC 802;
 |FINSI;
|FPRC;

|PROCESO NoBaja; |TIPO 1;
 nLnEstado = (FEntrada/ 100) ! 0;
 nTotal   = #10#7;
 nMensual = #1#46;
 |SI nLnEstado ! 2;  |ERROR; |FINSI;
|FPRC;

|PROCESO Tipo2W7; |TIPO 11;
 nInkey = FSalida;
 |SI nInkey = 1; |O nInkey = 7;
     |PTEC 806;
 |FINSI;
 |SI nInkey = 10;
     |PTEC 802;
 |FINSI;
 |SI nInkey = 11;
     |CONFI "    SRecuperar Reparto Original de Este Mes S/N";
     |SI FSalida = 0;
          |HAZ OtraVezMes;
          |PTEC 806;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO Tipo3W7; |TIPO 3;
 #10#7 = nTotal - nMensual + #1#46; |PINTA #10#7;
|FPRC;

|PROCESO LosSumo; |TIPO 0;
 #1#46 = 0;
 |PARA nPara1 = 4; |SI nPara1 [ 45; |HACIENDO nPara1 = nPara1 + 1;
       #1#46 = #1#46 + #1nPara1;
 |SIGUE;
 |PINTA #1#46;
 #10#7 = nTotal - nMensual + #1#46; |PINTA #10#7;
|FPRC;


|| ************************************************************************
|| ---------------- Utilidades
|PROCESO SacaParam;
 |SI NumMes [ 3;                  y = 1; |FINSI;
 |SI NumMes ] 4; |Y NumMes [ 6;   y = 2; |FINSI;
 |SI NumMes ] 7; |Y NumMes [ 9;   y = 3; |FINSI;
 |SI NumMes ] 10;                 y = 4; |FINSI;

 |SI NumMes = 1;  nT1 = 2;  nT2 = 32; |FINSI;
 |SI NumMes = 2;  nT1 = 33; nT2 = 61; |FINSI;
 |SI NumMes = 3;  nT1 = 62; nT2 = 92; |FINSI;

 |SI NumMes = 4;  nT1 = 2;  nT2 = 31; |FINSI;
 |SI NumMes = 5;  nT1 = 32; nT2 = 62; |FINSI;
 |SI NumMes = 6;  nT1 = 63; nT2 = 92; |FINSI;

 |SI NumMes = 7;  nT1 = 2;  nT2 = 32; |FINSI;
 |SI NumMes = 8;  nT1 = 33; nT2 = 63; |FINSI;
 |SI NumMes = 9;  nT1 = 64; nT2 = 93; |FINSI;

 |SI NumMes = 10;  nT1 = 2;  nT2 = 32; |FINSI;
 |SI NumMes = 11;  nT1 = 33; nT2 = 62; |FINSI;
 |SI NumMes = 12;  nT1 = 63; nT2 = 93; |FINSI;
|FPRC;

|PROCESO CargaVentas;

 NumMes = #1#50;
 |HAZ SacaParam;

 |ABRE #4;
 |DDEFECTO #4;
 #4#1  = y;
 #4#95 = #10#1;
 |LEE 110#4=;
 |SI FSalida ! 0;    |ACABA;  |FINSI;

 nNume4 = 3 + #1#47;
 |PARA nPara2 = nT1; |SI nPara2 [ nT2; |HACIENDO nPara2 = nPara2 + 1;
       #1#46    = #1#46  + #4nPara2;
       nTotal   = nTotal + #4nPara2;
       #1nNume4 = #4nPara2;
       nNume4   = nNume4 + 1;
 |SIGUE;

 |CIERRA #4;
|FPRC;

|| ---------------------- Actualizacion
|PROCESO  LeeIntrod0;
 NumMes = #1#50;
 |HAZ SacaParam;


|| --- Graba el Fichero Cavenaut
 |DDEFECTO #4;
 #4#1  = y;
 #4#95 = #10#1;
 |LEE 101#4=;
 |SI FSalida ! 0;
     |DDEFECTO #4;
     #4#1  = y;
     #4#95 = #10#1;
     |GRABA 020#4b;
 |FINSI;

 nsw = 0;
 nNume4 = 3 + #1#47;
 |PARA nPara2 = nT1; |SI nPara2 [ nT2; |HACIENDO nPara2 = nPara2 + 1;
       #4nPara2 = #1nNume4;
       nNume4   = nNume4 + 1;
       |SI #4nPara2 ! 0; nsw = 1; |FINSI;
 |SIGUE;
 |GRABA 020#4a;
 |LIBERA #4;

|| --- Graba Fichero Caconvel por meses

  #21#0 = #20#0;  || departamento
  #21#1 = NumMes;
  |LEE 101#21=;
  |SI FSalida ! 0;
      |DDEFECTO #21;
      #21#0 = #20#0;
      #21#1 = NumMes;
      #21#2 = #1#49;
      #21#5  = #20#4;
      |HAZ TriNuevo;
      |GRABA 020#21b;
  |FINSI;

  nNume1 = 11 + (NumMes * 3)
  nSaldo = nSaldo + #22nNume1;
  #21#3  = nSaldo;
  #21#4  = #1#46;
  |SI #21#7 > #21#4; #21#7 = 0; |FINSI;


  #21#11 = "N";
  #21#12 = " ";
  |SI nsw = 1; #21#13 = "*"; |FINSI;
  |SI nsw = 0; #21#13 = " "; |FINSI;
  |GRABA 020#21a;
  |LIBERA #21;
|FPRC;

|DEFBUCLE LeeIntrod;
 #1#1;
 ;
 #10#0,#10#1, 1;
 #10#0,#10#1,12;
 e;
 NULL, LeeIntrod0;
|FIN;

|PROCESO Actualizar;

  |BUCLE borrarVentas;  || Borro para volver a Repartir.

|| ... Crea el Reparto por Meses

  |ABRE #20;
  #20#0 = #10#1; || Departamento
  |LEE 101#20=;
  |SI FSalida ! 0;
      |DDEFECTO #20;
      #20#0 = #10#1;
      #20#1 = #10#2;

      eaCuenta = #20#2;
      salidas = 0; |HAZ FiltraPuntos;
      #20#2   = eaCuenta;

      #20#4 = #10#8;
      #20#8 = #10#6;
      |GRABA 020#20b;
  |FINSI;

|| ... lee Cuenta
  eaCuenta = #20#2; |HAZ LeeCuenta;
  #20#3  = #cacuenta#2;   ||Nombre de la Caja
  #20#5  = #cacuenta#53;
  #20#6  = #10#7;

  |GRABA 020#20a;
  |LIBERA #20;
  |CIERRA #20;

  nSaldo = #cacuenta#11;

  |ABRE #21;
  |ABRE #4;

  |BUCLE LeeIntrod;

  |CIERRA #4;
  |CIERRA #21;
|FPRC;


|PROCESO TriNuevo;
  #21#6 = NumMes;
  |SI #200#46 = "T";
      #21#6 = 1;
      |SI NumMes ] 4;  #21#6 = 2; |FINSI;
      |SI NumMes ] 7;  #21#6 = 3; |FINSI;
      |SI NumMes ] 10; #21#6 = 4; |FINSI;
  |SINO;
      |SI #200#46 = "A";
          #21#6 = 0;
      |FINSI;
  |FINSI;
|FPRC;
