|FICHEROS;
   caextraz #0;

   camaasil #1;
   cacuenta #3;
   caconimp #8;
   camaasic #11;
   caclipro #13;
   calicont #31;
   camaniva;

   canempre #30;
   caselemz #911;
   caselem1 #998;

   caextrpa #900,MANTE;
|FIN;

|VARIABLES;
   &ext1     = "";
   &ext2     = "";
   &espe1    =  @;
   &espe2    = @;
   &espe3    = 0;
   &espe4    = 0;
   &espe5    = "";
   &espe6    = "";
   &espe7    = 0;
   &espe8    = 0;
   &espe9    = 0;
   &sino     = "",
   &espe10   = "";
   &espe11   = "";
   &espe15   = "";
   &espe16   = 0;
   &enEmpOrg = 0;
   &enPerOrg = 0;
   &eaFEmp   = "";
   &swVarios = 0;
   &eaMonOrg = "";
   &eSwMul   = 0;

   aAlfa1      = "";
   aAlfa2      = "";
   aAlfa3    = "";
   aAlfa4    = "";
   aAlfa5    = "";

   fe1       = @;
   fe2       = @;
   nLinea    = 0;
   nDebe     = 0;
   nHaber    = 0;
   &nDeb1    = 0;
   &nHab1    = 0;

   &eaEspTabla = "";
   &enInkey    = 0;
   &nQuantHay  = 0;
   &enEste     = 0;

   aContrapartida = "";
   aNomContra     = "";
   hay_alguno     = 0;
   nEstado        = 0;
   &aFitxer       = "";
   &enBEjer       = 0;

   &d_abajo = 0;
   &h_abajo = 0;
   &s_abajo = 0;
   &nSwAsto = 0;
   &runnom  = "";
|FIN;

|INCLUYE dscont_i;

|| ///////////////////////////////////////////////////////////////////////
|PROCESO BuscaContra;

    #31#0 = #1#0;
    #31#1 = #1#1;
    #31#2 = #1#2;
    #31#3 = #1#3;
    |LEE 001#31=;
    |SI FSalida = 0;
        aContrapartida = #31#4;
    |SINO;
        #11#0 = #1#0;
        #11#1 = #1#1;
        #11#2 = #1#2;
        |LEE 001#11=;
        |SI FSalida = 0;
            |SI #1#8 = "D"; aContrapartida = #11#10; |FINSI;
            |SI #1#8 = "H"; aContrapartida = #11#8;  |FINSI;
        |FINSI;
   |FINSI;

   #3#0 = aContrapartida;
   |LEE 001#3=;
   |SI FSalida = 0;
       aNomContra = #3#2;
   |FINSI;
|FPRC;

|PROCESO BuscaFra;
    |SI #camaasil#12 = "R"; |O #camaasil#12 = "S"; |O #camaasil#12 = "N";
        #camaniva#0 = #camaasil#13;
        #camaniva#2 = #camaasil#15;
        #camaniva#3 = #camaasil#14;
        |LEE 041#camaniva.=;
        |SI FSalida = 0;
            #900#40 = #camaniva#22;
        |FINSI;
   |FINSI;
|FPRC;
|| ///////////////////////////////////////////////////////////////////////

|PROCESO buclepan;

  |SI #1#28 < #0#12; |O #1#28 > #0#13; |ACABA; |FINSI;

  |DDEFECTO #900;
  #900#00 = nLinea;
  #900#01 = #0#0;
  |LEE 041#900=;
  nEstado = FSalida;

  #900#48 = nLinea;
  #900#02 = #0#1;             || descripcion
  #900#03 = #0#2;             || desde fecha
  #900#04 = #0#3;             || hasta fecha
  #900#45 = #13#9;            || nif

  #900#18 = #1#0;             || diario
  #900#08 = #1#1;             || fecha
  #900#09 = #1#2;             || documento
  #900#19 = #1#3;
  aAlfa5 = #1#1;
  aAlfa2 = aAlfa5 % 102;
  aAlfa3 = aAlfa5 % 402;
  aAlfa4 = aAlfa5 % 902;
  aAlfa5 = aAlfa2 + aAlfa3 + aAlfa4;
  #900#43 = aAlfa2 + "/" + aAlfa3 + "/" + aAlfa4;

  #900#29 = #1#6;
  #900#10 = #1#7;             || descripcion
  #900#11 = #1#8;             || signo
  #900#20 = #1#21;            || Departamento
  #900#21 = #1#28;            || Subdepartamento
  #900#22 = #1#18;            || Punteado

  #900#5  = nDebe;
  #900#6  = nHaber;
  #900#7  = (nDebe - nHaber) ! 2;
  |SI #900#11 = "D";
      #900#12 = #1#9;             || importe debe
      d_abajo = d_abajo + #1#9;
      nDebe   = nDebe   + #1#9;
  |SINO;
      #900#13 = #1#9;             || importe haber
      h_abajo = h_abajo + #1#9;
      nHaber  = nHaber + #1#9;
  |FINSI;
  #900#014 = #900#7 + (#900#012 - #900#13);

  #900#15 = d_abajo;
  #900#16 = h_abajo;
  #900#017 = #900#15 - #900#016;
  s_abajo = d_abajo - h_abajo;

  ||.. grabo la Empresa
  #900#23 = enEmpresa;
  #900#24 = enPeriodo;
  #900#25 = dirfich0;
  #900#26 = enEjercicio;
  #900#27 = eaDepar;
  #900#28 = eaSubde;
  #900#44 = fec3;

  #900#30 = #1#12;
  #900#31 = #1#13;
  #900#32 = #1#14;
  #900#33 = #1#15;
  #900#34 = #1#19;
  #900#35 = #1#20;
  #900#36 = #1#22;
  #900#37 = #1#23;
  #900#38 = #1#24;
  #900#39 = #1#25;
  #900#40 = #1#26;
  #900#41 = #1#27;
  #900#42 = #1#29;
  |HAZ BuscaContra;
  #900#46 = aContrapartida;
  #900#47 = aNomContra;
  |HAZ BuscaFra;

  |SI #1#1 ] #0#2;|Y #1#1 [ #0#3;
      hay_alguno = 1;
  |FINSI;

  |SI #1#1 [ #0#3;              || fecha dentro del limite hasta
      |SI #1#1 ] #0#2;
          |SI nEstado = 0;
              |GRABA 020#900a;
          |SINO;
              |GRABA 020#900n;
          |FINSI;
          nLinea  = nLinea + 1;
      |SINO;
           |SI #900#11 = "D"; nDeb1 = nDeb1 + #1#9; |FINSI;
           |SI #900#11 = "H"; nHab1 = nHab1 + #1#9; |FINSI;
      |FINSI;
  |FINSI;
  |LIBERA #900;
|FPRC;

|DEFBUCLE caextraz00;
  #1#3;
  0, 6;
  #0#0, fe1, 000001, 0001, #0#9,  #0#4;
  #0#0, fe2, 999999, 9999, #0#10, #0#5;
  ;
  NULL, NULL, NULL, NULL, NULL, buclepan;
  #1#1,#1#0,#1#2,#1#3;
|FIN;

|PROCESO HazTodo;

   |ABRE #900;
   |ABRE #11;
   |ABRE #31;
   |ABRE #3;
   |ABRE #camaniva;
   |SELECT #3#camaniva;
   |BUCLE caextraz00;
   |SELECT #1#camaniva;
   |CIERRA #camaniva;
   |CIERRA #3;
   |CIERRA #31;
   |CIERRA #11;
   |CIERRA #900;
|FPRC;


|PROCESO MultiEmp1;
   cod1 = #caselem1#1;
   cod2 = #caselem1#2;
   emEmp = 1;  || Sin mensaje
   |HAZ leelo;
   |SI swerror ! 0;  |ACABA;   |FINSI;

   dirfich0 = #caselem1#3;
   |QBF dirfich0;
   |SI #0#2 > #caselem1#5; |O #0#3 < #caselem1#4;
       |ACABA;  || Fuera de la seleccion
   |FINSI;
   |SI #0#11 = "S";
       fe1 = fec1;
       fe2 = #0#3;
   |FINSI;

   |PATH_DAT #1 dirfich0;
   |PATH_DAT #8 dirfich0;
   |PATH_DAT #11 dirfich0;
   |PATH_DAT #31 dirfich0;

   |HAZ HazTodo;
|FPRC;

|DEFBUCLE MultiEmp0;
  #caselem1#1;
  ;
  000001;
  999999;
  ;
  NULL,MultiEmp1;
|FIN;

|PROCESO MultiEjercicio;
   eSwMul = 1;
   espe15 = #0#14;
   espe16 = #0#15;

  |SUB_EJECUTA "caselemp";
  |NOME_DAT #998 eaFichsel;

  |BUCLE MultiEmp0;
  |DELINDEX #998;
|FPRC;


|PROCESO Ordenar;
   #900#5 = nDebe;
   #900#6 = nHaber;
   #900#7 = (nDebe - nHaber) ! 2;

   nDebe   = nDebe  + #900#12;
   nHaber  = nHaber + #900#13;
   d_abajo = d_abajo + #900#12;
   h_abajo = h_abajo + #900#13;
   s_abajo = d_abajo - h_abajo;
   #900#014 = #900#7 + (#900#012 - #900#13);

   #900#15 = d_abajo;
   #900#16 = h_abajo;
   #900#17 = #900#15 - #900#016;

   #900#48 = nLinea;
   |GRABA 020#900a;

   nLinea = nLinea + 1;
|FPRC;

|DEFBUCLE Ordenar;
   #900#2;
   ;
   #0#2, #0#9,  000000, 0000, 00001, 000001;
   #0#3, #0#10, 999999, 9999, 99999, 999999;
   ;
   NULL, Ordenar;
|FIN;

|PROCESO Ordena;
  |C_V #900#23,1,"S";
  nDebe  = nDeb1;
  nHaber = nHab1;
  d_abajo = nDeb1;
  h_abajo = nHab1;
  nLinea = 1;
  |BUCLE Ordenar;
|FPRC;

|RUTINA min;
   #900#0  = 1;
   #900#8  = #0#2;
   #900#18 = #0#9;
   #900#9  = 000000;
   #900#19 = 0001;
   #900#23 = 00001;
   #900#48 = 1;
|FRUT;

|RUTINA max;
   #900#0  = 999999;
   #900#8  = #0#3;
   #900#18 = #0#10;
   #900#9  = 999999;
   #900#19 = 9999;
   #900#23 = 99999;
   #900#48 = 999999;
|FRUT;

|PROGRAMA;
   |SI runnom ! "caextrap";
       enNoBloq = 1;
       |HAZ inicio;
       enNoBloq = 0;
   |FINSI;

   |DDEFECTO #0;
   #0#0  = ext1;
   #0#1  = ext2;
   #0#2  = espe1;        || desde fecha
   #0#3  = espe2;        || hasta fecha
   #0#4  = espe3;        || desde concepto
   #0#5  = espe4;        || hasta concepto
   #0#6  = espe5;        || desde departamento
   #0#7  = espe6;        || hasta departamento
   #0#8  = 3;            || tipo de Informe
   #0#9  = espe8;        || desde Diario
   #0#10 = espe9;        || hasta Diario
   #0#11 = sino;         || Calculo anterior
   #0#12 = espe10;       || desde subdepartamento
   #0#13 = espe11;       || hasta subdepartamento
   #0#14 = espe15;
   #0#15 = espe16;

   #0#0 = ext1;
   |ABRE #3;
   #3#0 = #0#0;
   |LEE 001#3=;
   |SI FSalida ! 0;  |CIERRA #3;  |ACABA;   |FINSI;
   |CIERRA #3;

   |ABRE #13;
   |DDEFECTO #13;
   #13#23 = "C";
   #13#10 = #0#0;
   |LEE 041#13=;
   |SI FSalida ! 0;
       |DDEFECTO #13;
       #13#23 = "P";
       #13#10 = #0#0;
       |LEE 041#13=;
   |FINSI;
   |CIERRA #13;

   swVarios = 0;
   |SI #0#14 = "S"; |O #0#15 ! 0;
       swVarios = 1;
   |FINSI;
   enBEjer = enEjercicio;

   |SI #0#11 ="N";
        fe1 = #0#2;
        fe2 = #0#3;
    |SINO;
        |SI #0#14 = "S";
            aAlfa1 = #0#2;
            aAlfa1 = aAlfa1 % -104;
            aAlfa2 = dig1; aAlfa2 = ("00" + aAlfa2) % -102;
            aAlfa3 = "01.01." + aAlfa1;
            fe1   = aAlfa3;
            fe2   = #0#3;
        |SINO;
            fe1 = fec1;
            fe2 = #0#3;
        |FINSI;
    |FINSI;

    aAlfa1 = ("9a" + Usuario);
    |NOME_DAT #900 aAlfa1; |DELINDEX #900;
    aFitxer = aAlfa1;

    d_abajo = 0;
    h_abajo = 0;
    s_abajo = 0;
    nDebe   = 0;
    nHaber  = 0;
    nLinea  = 1;
    nDeb1   = 0;
    nHab1   = 0;
    hay_alguno = 0;
    |SI swVarios = 1;
        |HAZ MultiEjercicio;
    |SINO;
        |DFICE dirfich0;
        |HAZ HazTodo;
    |FINSI;

    |SI hay_alguno = 0;
        |SI eaEspTabla ! "S";
            |MENAV "    Seleccion vacia ...";
        |FINSI;
    |SINO;
        enInkey = 0;
        |SI swVarios = 0;
            |ENTLINEAL #3#900, -1, 4, 15, 1, min, max;
        |SINO;
            |HAZ Ordena;
            |PINPA #0#900;
            |SI #0#14 = "S";
                |C_P #900#43, 1, 0931;
                |C_A #900#43, 1, 8;
                |C_A #900#10, 1, 23;
                |PINTA 0830, "³";
                |ATRI R; |PINTA 0831, " Fecha  "; |ATRI 0;
            |FINSI;
            |ENTLINEAL #3#900, -1, 4, 15, 0, min, max;
        |FINSI;
        |CIERRA #900;
        |DELINDEX #900;
    |FINSI;
|FPRO;
