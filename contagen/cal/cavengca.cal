|FICHEROS;
    cavengca #0;
    cavengli #1;
    cagruiva #2;
    cacuenta #4;
    caclipro #5;
    cagruivx #6;
    caivaasi #7;
    calibros #10;
    caivases #11;
    cafantas #12;

    :/modelos/def/dsmom030 #300;
    &regisnif@ #709;
|FIN;

|VARIABLES;
    &entrada = 1;
    avisos = "";
    mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
    mensa2 = "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
    men1  = "     NO EXISTE EMPRESA !";
    men2  = "     Longitud de Cuenta Fuera de Nivel !";
    men3  = "      Esta Cuenta NO tiene Pase directo";

    NumFactura = 0;
    swp   = 0;
    estot = 0; || 0 = bases y 1 = factura
    dividit = 0;
    trim1 = @;
    trim2 = @;
    trim3 = @;
    ModoEntrada = 0;

    sw_movim = 0;

    dlibro = 0;        || libro repercutido
    ddlibro = "";      || descripcion libro
    dserie = "";       || serie
    dconc  = 0;        || concepto cliente
    ddesc  = "";       || descripcion cliente
    dbn    = "";       || bruto/neto
    ddp    = "";       || departamento
    dddp   = "";       || descripcion departamento
    dsd    = "";       || subdepartamento
    ddsd   = "";       || descripcion subdepartamento
    tope_cant = 0;     || cantidad tope de facturas englobadas
    dcta   = "";       || cuenta cliente
    ddig   = 0;        || digito cuenta
    dgru   = 0;        || grupo facturas
    dnom   = "";
    dcif   = "";

    &pepe = 0;
    para1 = 0;
    y = 0;
    sw1 = 0;
    sw2 = 0;
    sw3 = 0;
    sw4 = 0;
    sw5 = 0;
    sw6 = 0;

    tot_b = 0;
    tot_i = 0;
    tot_r = 0;
    tot_f = 0;
    salida = 0;
    num = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    nume7 = 0;
    nume8 = 0;

    num21 = 0;
    num22 = 0;
    num23 = 0;
    num24 = 0;
    num25 = 0;

     swpcta = 0;
     aAlfa1 = "";
     alfa1 = "";
     alfa2 = "";
     nume1 = 0;
     nume2 = 0;
     nYaCrea = 0;
     &eaVarDni  = "";
     &enCalcCif = 0;

     &snFiltr = "";
     &snFilAc = "";
     &snFilBa = "";
  {40}aPopup        = "";
     nID            = 0;
     aID            = "";
     aTexto         = "";

     &enSi303  = 0;
     &enSi111  = 0;
     &enPanMod = 0;
     &enEmiMod = 0;
     &eSwReten = 0;
|FIN;

|INCLUYE dscont_i;

|| *************************************************************************
|| ************************** DATOS DE CABECERA ****************************
|| *************************************************************************

|CALCULO control; |TIPO 8;

 |HAZ inicial; |SI swerror = 2; |ACABA; |FINSI;

 |ABRE #caivaasi;
 |DDEFECTO #caivaasi;
 |LEE 001#caivaasi.p;
 |SI FSalida ! 0;
     |MENAV "    Se aconseja definir 'Tratam.IVA/Ficheros Asociados/Control Entrada ...'";
 |FINSI;
 |CIERRA #caivaasi;
 snFiltr = #caivaasi#95;
 snFilAc = #caivaasi#118;
 snFilBa = #caivaasi#119;

 dlibro = #7#73;        || libro repercutido
 dserie = #7#75;        || Serie
 dconc  = #7#77;        || concepto cliente
 ddesc  = #7#79;        || descripcion
 dbn    = #7#17;        || bruto/neto
 ddp    = #7#19;        || departamento
 dsd    = #7#67;        || subddepartamento
 tope_cant = #7#38;     || cantidad tope de facturas englobadas
 dcta   = #7#39;          || cuenta cliente
 ddig   = #7#40;          || digito cuenta
 dgru   = #7#42;          || grupo facturas
 eaSobreEs = #7#155;

 |ABRE #10;
 #calibros#0 = dlibro;
 |LEE 001#10=;
 |SI FSalida ! 0; |O #calibros#2 ! "R";
      dlibro = 0;
 |SINO;
      ddlibro = #calibros#1;
 |FINSI;
 |CIERRA #10;

  |ABRE #4;
  #4#0 = dcta;
  #4#1 = ddig;
  |LEE 001#4=;
  |SI FSalida ! 0; |O #4#3 ! "S";
      dcta = doce;
      ddig = 0;
  |SINO;
      |ABRE #5;
      #5#10 = "C";
      #5#10 = dcta;   || cuenta
      #5#11 = ddig;   || digito
      |LEE 001#5=;
      |SI FSalida ! 0; |DDEFECTO #5; |FINSI;
      dnom = #4#2;        || carga el nombre del plan contable
      dcif = #5#9;        || carga el CIF del cliente
      |CIERRA #5;
  |FINSI;
  |CIERRA #4;

  alfa1 = #7#74;  |CAMPO_MODIFICA #0#01, 1, alfa1;  ||Libro
  alfa1 = #7#76;  |CAMPO_MODIFICA #0#13, 1, alfa1;  ||Serie
  alfa1 = #7#78;  |CAMPO_MODIFICA #0#06, 1, alfa1;  || concepto
  alfa1 = #7#80;  |CAMPO_MODIFICA #0#07, 1, alfa1;  || descripcion
  alfa1 = #7#18;  |CAMPO_MODIFICA #0#14, 1, alfa1;  || bruto/NETO
  |SI eaDepar = "N"; #7#20 = "N"; |FINSI;
  alfa1 = #7#20;  |CAMPO_MODIFICA #0#10, 1, alfa1;  || Departamento
  |SI eaSubde = "N"; #7#68 = "N"; |FINSI;
  alfa1 = #7#68;  |CAMPO_MODIFICA #0#20, 1, alfa1;  || subDepartamento
  alfa1 = #7#28;  |CAMPO_MODIFICA #0#12, 1, alfa1;  || periodo
  alfa1 = #7#35;  |CAMPO_MODIFICA #0#08, 1, alfa1;  || nombre
  alfa1 = #7#36;  |CAMPO_MODIFICA #0#09, 1, alfa1;  || nif
  alfa1 = #7#41;  |CAMPO_MODIFICA #0#04, 1, alfa1;  || cuenta
  alfa1 = #7#43;  |CAMPO_MODIFICA #1#02, 1, alfa1;  || codigo grupo

  dconc  = #7#77;        || concepto cliente
  ddesc  = #7#79;        || descripcion
  dbn    = #7#17;        || bruto/neto
  ddp    = #7#19;        || departamento
  dsd    = #7#67;        || subddepartamento
  |SI eaDepar = "S";
      eOpDep = 0;
      enActividad = ddp;
      eaCodDep    = ddp;
      |HAZ Actividad;
      dddp = eaNombreAct;
  |FINSI;
  |SI eaSubde = "S";
      eOpSub = 0;
      enConcepto  = dconc;
      eaCodSubdep = dsd;
      |HAZ SubActividad;
      ddsd = eaNomSubdep;
  |FINSI;
  enLibIVA  = dlibro;
  enFilConc = 2;          || Concepto de IVA
  enConcepto = dconc;
  |HAZ FiltroConcepto;

  |HAZ Consul303;
|FCAL;

|CALCULO salir; |TIPO 9;
 |SI sw_movim = 0; |ACABA; |FINSI;
 |AVISO;
 |CONFI "2400SDesea actualizar las facturas en el Libro y en el Diario S/N : ";
 |SI FSalida ! 0; |ACABA; |FINSI;
 pepe = 1;
 |SUB_EJECUTA "cavengac.tab";
|FCAL;

|CALCULO fecha1; |TIPO 1;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI #0Campo [ fec3; |Y ModoEntrada [ 2;
       |MENAV mensa2;
       |ERROR;
       |ACABA;
   |FINSI;
|FCAL;

|CALCULO fecha; |TIPO 0;
   aTipoIVA = "R";
   ModoEntrada = (FEntrada / 100) ! 0;

   |SI #0#0 < fec1; |O #0#0 > fec2;
      |MENAV mensa1;
      |ERROR;
      |ACABA;
   |SINO;
      |SI #0Campo [ fec3; |Y ModoEntrada [ 2;
          |MENAV mensa2;
          |ERROR;
          |ACABA;
      |FINSI;
   |FINSI;

 swp = 0;
 |SI ModoEntrada = 1;
     alfa1 = #0Campo;   alfa1 = alfa1 % 402;      || saca a¤o
     #0#12 = alfa1;
     |SI enEjercicio [ 2009;
         |SI #caivaasi#46 = "T";
             |SI alfa1 ] "01"; |Y alfa1 [ "03"; #0#12 = 1; |FINSI;
             |SI alfa1 ] "04"; |Y alfa1 [ "06"; #0#12 = 2; |FINSI;
             |SI alfa1 ] "07"; |Y alfa1 [ "09"; #0#12 = 3; |FINSI;
             |SI alfa1 ] "10"; |Y alfa1 [ "12"; #0#12 = 4; |FINSI;
         |SINO;
             |SI #caivaasi#46 = "A"; #0#12 = 0; |FINSI;
         |FINSI;
     |FINSI;

     |C_M #0#12,0,aAlfa1;
     |SI aAlfa1 = "N";
         |HAZ VerMod303;
         |SI enEmiMod = 1; |Y #caivaasi#167 = "N";
             |ACABA;
         |FINSI;
     |FINSI;

     #0#1  = dlibro;  |PINTA #0#1;
     #0#2  = ddlibro; |PINTA #0#2;
     #0#13 = dserie;  |PINTA #0#13;
     #0#6 = dconc;    |PINTA #0#6;
     #0#7 = ddesc;    |PINTA #0#7;
     #0#4 = dcta;     |PINTA #0#4;
     #0#5 = ddig;
     #0#8 = dnom;    |PINTA #0#8;
     #0#9 = dcif;    |PINTA #0#9;
     #0#10 = ddp;    |PINTA #0#10;
     #0#21 = dddp;   |PINTA #0#21;
     #0#20 = dsd;    |PINTA #0#20;
     #0#22 = ddsd;   |PINTA #0#22;
     #0#14 = dbn;    |PINTA #0#14;
     |PINTA #0#12;

     |HAZ ult_fra;
     #0#3 = NumFactura;
     |PINTA #0#3;
 |FINSI;
|FCAL;

|CALCULO Liq303;
  |C_M #0#12,0,aAlfa1;
  |SI FSalida = 2; |ACABA; |FINSI;

  |SI aAlfa1 = "S";
      |HAZ VerMod303;
  |FINSI;
|FCAL

|PROCESO VerMod303;
      ModoEntrada = (FEntrada / 100) ! 0;
      |SI enSi303 = 1; |Y #caivaasi#167 ! "X"; |Y ModoEntrada = 1;
          eSwReten = 0;
          enPanMod = 0;
          enPerMod = #0#12;
          |HAZ ConsulModIVA;
          |SI enEmiMod = 1; |Y #caivaasi#167 = "N";
              |ERROR;
          |FINSI;
      |FINSI;
|FPRC;

|CALCULO cabtipo3; |TIPO 3;
 sw_movim = 1;
 ModoEntrada = (FEntrada / 100) ! 0;
 |SI ModoEntrada = 3;
     |PINTA #0#0;
 |FINSI;
 swpcta = 0;
|FCAL;

||*******************************************************
|PROCESO ult_fra; || Calcular el ultimo numero de factura del libro
   |SI #caivaasi#44 = "N";
       |ABRE #calibros;
       #calibros#0 = #cavengca#1;
       |LEE 101#calibros.=;
       NumFactura  = #calibros#4;
       |CIERRA #calibros;
   |SINO;
       |ABRE #caivases;
       #caivases#0 = #cavengca#13;
       #caivases#1 = aTipoIVA;
       |LEE 101#caivases.=;
       NumFactura = #caivases#3;
       |CIERRA #caivases;
   |FINSI;
|FPRC;

|PROCESO modi_ult; |TIPO 0;
 swp = 1;
 |SI FSalida ! 9; |ACABA; |FINSI;
 |HAZ ult_fra;
 #0#3 = NumFactura;
 |PINTA #0#3;
 |ERROR;
|FPRC;
||*******************************************************

|| ----- Libro de IVA
|CALCULO cheq_libro; |TIPO 0;
   ModoEntrada  = (FEntrada / 100) ! 0;
   |ABRE #calibros;
   #calibros#0 = #0#1;
   |LEE 010#calibros.=;
   |SI FSalida ! 0;
       |MENAV "      No existe libro";
       |CIERRA #calibros;
       |C_M #0#1,1,"S";
       |ERROR;
       |ACABA;
   |FINSI;
   |CIERRA #calibros;

   |SI #calibros#2 ! aTipoIVA;
       |MENAV "     Libro de IVA No Correcto";
       |C_M #cavengca#1,1,"S";
       |ERROR;
       |ACABA;
   |FINSI;

   #0#2 = #calibros#1; |PINTA #0#2;
   |SI ModoEntrada = 1;
       |HAZ ult_fra;
       #0#3 = NumFactura;
       |PINTA #0#3;
   |FINSI;

|SI nYaCrea = 0; |O  enLibIVA ! #0#1;
   enLibIVA  = #0#1;
   enFilConc = 2;          || Conceptos de IVA
   |HAZ CreaConcepto;
   nYaCrea = 1;
|FINSI;

|FCAL;

|| ------- Cuenta
|CALCULO AntesCuenta; |TIPO 7;             ||Cuenta Cli/Pro
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada ! 1; |ACABA; |FINSI;
  |SI swpcta = 1; |ACABA; |FINSI;
  #cavengca#Campo# = #caivaasi#39;
  |PINTA #cavengca#Campo#;
  |PTEC 816;
  swpcta = 1;
|FCAL;

|CALCULO Cuenta; |TIPO 6;
   |C_M #cavengca#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

     eaCuenta = #cavengca#Campo#;
     salidas  = FSalida;
     |HAZ FiltraPuntos;
     #cavengca#Campo# = eaCuenta;
     |PINTA #cavengca#Campo#;
|FCAL;

|CALCULO TrasCuenta; |TIPO 0;
   emCta    = 1;
   eaCuenta = #cavengca#Campo#;
   |HAZ SacaNivel;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea

   nume1 = Campo + 1; #cavengca#nume1# = enNivel;
   |HAZ LeeCuenta;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
   enConcepto = #cavengca#6;
   || Leer Proveedor/Cliente
   |HAZ FiltraCtaCP;
   |SI eswLect = 0;
       |ABRE #caclipro;
       |SI aTipoIVA = "R";
            #caclipro#23 = "C";
       |SINO;
           #caclipro#23 = "P";
       |FINSI;
       #caclipro#10 = #cavengca#4;
       #caclipro#11 = enNivel;
       |LEE 000#caclipro.=;
       |SI FSalida = 0;
           #cavengca#8 = #caclipro#1;
           #cavengca#9 = #caclipro#9;
       |SINO;
           #cavengca#8 = #cacuenta#2;
           |C_M #cavengca#9,1,"S";  || No tengo el nif.
       |FINSI;
       |PINTA #cavengca#8;
       |PINTA #cavengca#9;
       |CIERRA #caclipro;
   |FINSI;
|FCAL;

||----------------------------------------------------
|CALCULO TrasConcepto;  |TIPO 0;     ||Concepto Factura
   |SI FSalida = 10;
       enConcepto = #cavengca#6;
       |HAZ VerConcepto;
       #cavengca#6 = enConcepto; |PINTA #cavengca#6;
   |FINSI;

   |SI #cavengca#6 = dconc; |ACABA; |FINSI;

   enLibIVA  = #cavengca#1;
   enFilConc = 2;          || Concepto de IVA
   enConcepto = #cavengca#6;
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;
   #cavengca#7 = #dsmom030#1; |PINTA #cavengca#7;

   |C_M #cavengca#10,0,alfa1;
   |SI alfa1 = "N";   ||no modifica Actividad
       enActividad = #cavengca#10;
       |SI Haybasica = 1;
           enFilRegIVA = 0;
           enConcepto  = #cavengca#6;
           |HAZ FilRegimenIVA;
           |SI eswLect ! 0; |Y snFiltr = "S"; |Y snFilAc = "S"; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   #cavengca#4= eaCtaIVA; |PINTA #cavengca#4;
   emCta    = 0;
   eaCuenta = #cavengca#4; |HAZ SacaNivel; #cavengca#5 = enNivel;
   |HAZ LeeCuenta;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
   #cavengca#8 = #cacuenta#2; |PINTA #cavengca#8;
|FCAL;

|CALCULO fincon; |TIPO 7;
   |C_M #cavengca#Campo#,0,alfa1;
   |SI alfa1 = "S"; |Y eaSobreEs ! "S";
       |PTEC 816;
   |FINSI;
|FCAL;

||----------------------------------------------------
|CALCULO AntesDepar; |TIPO 7;
   |C_M #cavengca#Campo#, 0, alfa1;
   |SI alfa1 = "S"
      |SI Haybasica = 1;
          |MENSA "    <F2> Consultar Actividades";
      |SINO;
          |MENSA "    <F2> Consultar Departamentos";
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesSubde; |TIPO 7;
   |C_M #cavengca#Campo#, 0, alfa1;
   |SI alfa1  = "S";
      |SI Haybasica = 1;
          |SI enArrend = 1;
              |MENSA "    Subdepartamento. <F2> Consultar Referencias Catastrales";
          |SINO;
              |MENSA "    Subdepartamento. <F2> Consultar Cultivos";
          |FINSI;
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO elDNI; |TIPO 6;
  |SI FSalida = 10;
      enCalcCif = 1;
      eaVarDni  = #cavengca#Campo#;
      |HAZ CalculoDNI;
      #cavengca#Campo# = eaVarDni;
      |PINTA #cavengca#Campo#;
      |ERROR;
      |ACABA;
    |FINSI;

     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;
     eaVarDni = (eaVarDni + "                ") % 115;
     |SI #0Campo ! eaVarDni;
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;
|FCAL;

|CALCULO TrasDepar; |TIPO 0;
   |SI eaDepar = "N"; |ACABA; |FINSI;
   eOpDep = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpDep = 1;  |FINSI;
   enActividad = #cavengca#10;
   eaCodDep    = #cavengca#10;
   |HAZ Actividad;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Actividad / Departamento";
       |ERROR;
   |SINO;
       alfa1 = enActividad;
       |SI Haybasica = 1;
           enFilRegIVA = 1;
           enConcepto  = #cavengca#6;
           |HAZ FilRegimenIVA;
           |SI eswLect ! 0; |HAZ SuboConcepto; |ACABA; |FINSI;
           alfa1 = ("00" + alfa1) % A02;
       |FINSI;
       #cavengca#10 = eaCodDep; |PINTA #cavengca#10;
       #cavengca#21 = eaNombreAct; |PINTA #cavengca#21;

      |HAZ PintaFecha;
      |SI efActFin > "01.01.1900"; |Y snFilBa = "S";
          aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
          |CONFI aAlfa1;
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
      |SI eaEsCom = "S";
          |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Facturas ? ";
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
  |FINSI;
|FCAL;

|PROCESO SuboConcepto;
   |SI snFiltr = "S"; |Y snFilAc = "S";
       |C_M #cavengca#10, 0, alfa1; |SI alfa1 = "N"; |ACABA; |FINSI;
       |PTEC 808;
       |C_M #cavengca#9, 0, alfa1; |SI alfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cavengca#8, 0, alfa1; |SI alfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cavengca#4,  0, alfa1; |SI alfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cavengca#12, 0, alfa1; |SI alfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cavengca#7,  0, alfa1; |SI alfa1 = "S"; |PTEC 808; |FINSI;
   |FINSI;
|FPRC;

|PROCESO PintaFecha;
    alfa1 = " "; alfa1 = alfa1 * 20;
    |PINTA 1226, alfa1;
    |PINTA 1326, alfa1;
    #cafantas#10 = efActIni;
    #cafantas#11 = efActFin;
    |SI efActIni > "01.01.1900";
        |ATRI S; |PINTA 1226, "F.Inicio: "; |ATRI 0;
        |PINTA 1235, #cafantas#10;
    |FINSI;
    |SI efActFin > "01.01.1900";
        |ATRI S; |PINTA 1326, "F.Fin: "; |ATRI 0;
                 |PINTA 1335, #cafantas#11;
    |FINSI;
|FPRC;

|CALCULO El13; |TIPO 13;
    alfa1 = " "; alfa1 = alfa1 * 20;
    |PINTA 1226, alfa1;
    |PINTA 1326, alfa1;
    ModoEntrada = (FEntrada / 100) ! 0;
    |SI ModoEntrada  [ 1; |ACABA; |FINSI;
    |SI eaDepar = "S";
       eOpDep = 0;
       enActividad = #0#10;
       eaCodDep    = #0#10;
       |HAZ Actividad;
       |HAZ PintaFecha;
   |FINSI;
|FCAL;

|CALCULO TrasSubde; |TIPO 0;
   |SI eaSubde = "N"; |ACABA; |FINSI;

   eOpSub = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpSub = 1;  |FINSI;
   enConcepto  = #cavengca#6;
   eaCodSubdep = #cavengca#20;
   enQue = 1;
   |HAZ SubActividad;
   enQue = 0;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe SubDepartamento";
       |ERROR;
   |SINO;
       #cavengca#20 = eaCodSubdep; |PINTA #cavengca#20;
       #cavengca#22 = eaNomSubdep; |PINTA #cavengca#22;
   |FINSI;
|FCAL;

|PROCESO Tipo7C23;  |TIPO 7;
   |SI enEjercicio > 2011;
       aAlfa1 = "<*> No se pasa al 340.";
   |SINO;
       aAlfa1 = "<X> No se pasa al 340.";
   |FINSI;
   aAlfa1 = "    <F11> para consultar Tipo Operaciones Mod. 340." + aAlfa1;
   |MENSA aAlfa1;
|FPRC;

|PROCESO Tipo66C23;  |TIPO 66;
     aAlfa1 = "|C023WID";
     aID    = #cavengca#aAlfa1#;
     nID    = aID;

     aPopup1  = nID;  || Si fuera -1 en la posicion
     |SI enEjercicio [ 2011;
         aPopup2  = 15;
     |SINO;
         aPopup2  = 21;
         |SI enEjercicio ] 2014;
             aPopup2  = 30;
         |FINSI;
     |FINSI;
     aPopup3  = "  Operación habitual";
     aPopup4  = "A Asiento resumen de facturas";
     aPopup5  = "B Asiento resumen de tiques";
     aPopup6  = "C Factura con varios asientos (varios tipo impositivos)";
     aPopup7  = "D Factura rectificativa";
     aPopup8  = "E IVA devengado pendiente de emitir factura";
     aPopup9  = "G Régimen especial de grupo de entidades en IVA o IGIC";
     aPopup10 = "H Régimen especial de oro de inversión";
     aPopup11 = "I Inversión del Sujeto pasivo (ISP)";
     aPopup12 = "J Tiques";
     aPopup13 = "K Rectificación anotaciones registrales";
     aPopup14 = "M IVA facturado pendiente de devengar (emitida factura)";
     aPopup15 = "N Facturación de las prestaciones de servicios de agencias de viaje que actúan como mediadoras en nombre y por cuenta ajena";
     aPopup16 = "O Factura emitida en sustitución de tiques facturados y declarados.";
     aPopup17 = "Q Operaciones a las que se aplique el régimen especial de bienes usados, ...";
     |SI enEjercicio > 2011;
         aPopup18 = "R Operación de arrendamiento de local de negocio.";
         aPopup19 = "S Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas.";
         aPopup20 = "T Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ...";
         aPopup21 = "U Operación de seguros.";
         aPopup22 = "V Compras de Agencias viajes: operaciones de prestación de servicios de mediación en nombre y por cuenta ajena relativos ...";
         aPopup23 = "W Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla.";
         |SI enEjercicio ] 2014;
             aPopup24 = "Z Operaciones en Régimen especial de criterio de caja";
             aPopup25 = "1 IVA criterio de caja. Asiento resumen de facturas";
             aPopup26 = "2 IVA criterio de caja. Factura con varios asientos";
             aPopup27 = "3 IVA criterio de caja. Factura rectificativa";
             aPopup28 = "4 IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes en interés del viajero";
             aPopup29 = "5 IVA criterio de caja. Factura simplificada";
             aPopup30 = "6 IVA criterio de caja. Rectificación de errores registrales";
             aPopup31 = "7 IVA criterio de caja. Facturación de las prestaciones de servicios de agencias de viajes";
             aPopup32 = "8 IVA criterio de caja. Operación de arrendamiento de local de negocio";
         |FINSI;
     |FINSI;

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida ! 0;
         IaPopup  = aPopup3  <-;
         IaPopup  = IaPopup + (FSalida - 1);

         aAlfa1 = aPopup % 101;  #cavengca#23 = aAlfa1;
     |FINSI;

     |PINTA #cavengca#23;
|FPRC;

|CALCULO Tipo0C23; |TIPO 0;

     |BLIN 4;
     aTexto = "";
     |SI #cavengca#23 = " "; aTexto = "Operaci¢n habitual"; |FINSI;
     |SI #cavengca#23 = "A"; aTexto = "Asiento resumen de facturas"; |FINSI;
     |SI #cavengca#23 = "B"; aTexto = "Asiento resumen de tiques"; |FINSI;
     |SI #cavengca#23 = "C"; aTexto = "Factura con varios asientos (varios tipo impositivos)"; |FINSI;
     |SI #cavengca#23 = "D"; aTexto = "Factura rectificativa"; |FINSI;
     |SI #cavengca#23 = "E"; aTexto = "IVA devengado pendiente de emitir factura"; |FINSI;
     |SI #cavengca#23 = "G"; aTexto = "R‚gimen especial de grupo de entidades en IVA o IGIC"; |FINSI;
     |SI #cavengca#23 = "H"; aTexto = "R‚gimen especial de oro de inversi¢n"; |FINSI;
     |SI #cavengca#23 = "I"; aTexto = "Inversi¢n del Sujeto pasivo (ISP)";|FINSI;
     |SI #cavengca#23 = "J"; aTexto = "Tiques"; |FINSI;
     |SI #cavengca#23 = "K"; aTexto = "Rectificación anotaciones registrales"; |FINSI;
     |SI #cavengca#23 = "M"; aTexto = "IVA facturado pendiente de devengar (emitida factura)"; |FINSI;
     |SI #cavengca#23 = "N"; aTexto = "Facturaci¢n de las prestaciones de servicios de agencias de viaje que actúan como mediadoras en nombre y por cuenta ajena"; |FINSI;
     |SI #cavengca#23 = "O"; aTexto = "Factura emitida en sustituci¢n de tiques facturados y declarados."; |FINSI;
     |SI #cavengca#23 = "Q"; aTexto = "Operaciones a las que se aplique el r‚gimen especial de bienes usados, ..."; |FINSI;
     |SI enEjercicio > 2011;
         |SI #cavengca#23 = "R"; aTexto = "Operación de arrendamiento de local de negocio."; |FINSI;
         |SI #cavengca#23 = "S"; aTexto = "Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas."; |FINSI;
         |SI #cavengca#23 = "T"; aTexto = "Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ..."; |FINSI;
         |SI #cavengca#23 = "U"; aTexto = "Operación de seguros."; |FINSI;
         |SI #cavengca#23 = "V"; aTexto = "Compras de Agencias viajes: operaciones de prestación de servicios de mediación en nombre y por cuenta ajena relativos ..."; |FINSI;
         |SI #cavengca#23 = "W"; aTexto = "Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla."; |FINSI;
         |SI enEjercicio ] 2014;
             |SI #cavengca#23 = "Z"; aTexto = "Operaciones en Régimen especial de criterio de caja"; |FINSI;
             |SI #cavengca#23 = "1"; aTexto = "IVA criterio de caja. Asiento resumen de facturas"; |FINSI;
             |SI #cavengca#23 = "2"; aTexto = "IVA criterio de caja. Factura con varios asientos"; |FINSI;
             |SI #cavengca#23 = "3"; aTexto = "IVA criterio de caja. Factura rectificativa"; |FINSI;
             |SI #cavengca#23 = "4"; aTexto = "IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes"; |FINSI;
             |SI #cavengca#23 = "5"; aTexto = "IVA criterio de caja. Factura simplificada"; |FINSI;
             |SI #cavengca#23 = "6"; aTexto = "IVA criterio de caja. Rectificaci¢n de errores registrales"; |FINSI;
             |SI #cavengca#23 = "7"; aTexto = "IVA criterio de caja. Facturaci¢n de las prestaciones servicios agencias viajes"; |FINSI;
             |SI #cavengca#23 = "8"; aTexto = "IVA criterio de caja. Operaci¢n de arrendamiento de local de negocio"; |FINSI;
         |FINSI;
     |FINSI;

     |SI #cavengca#23 = "C"; aTexto = ""; |FINSI; || no puede elegir C, es automatico
     |SI enEjercicio [ 2011;
         |SI #cavengca#23 = "X"; aTexto = "No pasa al 340"; |FINSI;
     |SINO;
         |SI #cavengca#23 = "*"; aTexto = "No pasa al 340"; |FINSI;
     |FINSI;

     |SI aTexto = "";
         |MENAV "0000 Clave de operaci¢n incorrecta";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #cavengca#23 ! "A"; |Y #cavengca#23 ! "B"; |Y #cavengca#23 ! "J";
         |CONFI "    NEs correcta la Clave Elegida";
         |SI FSalida ! 0;
             |ERROR;
         |FINSI;
     |FINSI;
|FCAL;

|| *************************************************************************
|| ***************** CAMPOS DE LAS LINEAS
|| *************************************************************************
|PROCESO chequeo; |TIPO 3;
 |SI #1#3 ! 0; sw_movim = 1; |ACABA; |FINSI;
 |SI #1#4 ! 0; sw_movim = 1; |ACABA; |FINSI;
 |SI #1#5 ! 0; sw_movim = 1; |ACABA; |FINSI;
 |SI #1#6 ! 0; sw_movim = 1; |ACABA; |FINSI;
 |SI #1#7 ! 0; sw_movim = 1; |ACABA; |FINSI;
 |SI #1#8 ! 0; sw_movim = 1; |ACABA; |FINSI;

 avisos = "ATENCION !!!. Importe igual a Cero ... ";
 |HAZ aviso5;
 sw_movim = 1;
|| |ERROR;
|FPRC;


|PROCESO funmodi;

 |SI Campo = 2;|Y sw6 ! 1;   |ACABA; |FINSI;
 |SI Campo < 4;
     |SI sw1 = 1; num = 1; |FINSI;
     |SI sw2 = 1; num = 2; |FINSI;
     |SI sw3 = 1; num = 3; |FINSI;
     |SI sw4 = 1; num = 4; |FINSI;
     |SI sw5 = 1; num = 5; |FINSI;
 |SINO;
     num = Campo - 3;
 |FINSI;
 |HAZ sumanume;
 |SI salida = 10; |O salida = 11; || ... BASE / IVA
     |SI #1num21 = 0; |O #1num22 = 0;
         |ERROR; |ACABA;
     |FINSI;
     |SI salida = 10;   || ... Suma base  y  Resta Iva
         #1num21 = #1num21 + 1;
         #1num23 = #1num23 - 1;
     |SINO;              || ... Resta base  y  Suma Iva
         #1num21 = #1num21 - 1;
         #1num23 = #1num23 + 1;
     |FINSI;
     |PINTA #1num21;
     |PINTA #1num23;
 |FINSI;
 |SI salida = 12; |O salida = 13; || ... IVA / RECARGO
     |SI #1num21 = 0; |O #1num22 = 0; |O #1num24 = 0;
         |ERROR; |ACABA;
     |FINSI;
     |SI salida = 12;   || ... Suma Iva  y  Resta Recargo
         #1num23 = #1num23 + 1;
         #1num25 = #1num25 - 1;
     |SINO;              || ... Resta Iva  y  Suma Recargo
         #1num23 = #1num23 - 1;
         #1num25 = #1num25 + 1;
     |FINSI;
     |PINTA #1num23;
     |PINTA #1num25;
 |FINSI;
 |PAUSA;
|FPRC;

|PROCESO totfactu;
  tot_b = #1#4  + #1#5  + #1#6  + #1#7  + #1#8
  tot_i = #1#9  + #1#10 + #1#11 + #1#12 + #1#13
  tot_r = #1#14 + #1#15 + #1#16 + #1#17 + #1#18
  tot_f = tot_b + tot_i + tot_r;
|FPRC;

|PROCESO sumar; |TIPO 2;
  |HAZ totfactu;
  || --
  #0#15 = #0#15 +. tot_b;
  #0#16 = #0#16 +. tot_i;
  #0#17 = #0#17 +. tot_r;
  || --
  #0#19 = #0#19 +. tot_f;

  |PINTA #0#15;
  |PINTA #0#16;
  |PINTA #0#17;
  |PINTA #0#19;
|FPRC;

|PROCESO def_tipo; |TIPO 0;
 ModoEntrada = (FEntrada / 100) ! 0;
 |SI ModoEntrada = 1;
     |CAMPO_MODIFICA #1#2, 1, "S";
     #1#2 = dgru; |PINTA #1#2;
 |SINO;
     |CAMPO_MODIFICA #1#2, 1, "N";
 |FINSI;
|FPRC;

|PROCESO caltot_fac;
  |SI estot = 0; |ACABA; |FINSI;

  salida = FSalida
  |SI salida ] 10; |Y salida [ 13;
      |HAZ funmodi;
      |ACABA;
  |FINSI;
  tot_f = #1#3;
  |SI sw1 = 1; num = 1; |FINSI;
  |SI sw2 = 1; num = 2; |FINSI;
  |SI sw3 = 1; num = 3; |FINSI;
  |SI sw4 = 1; num = 4; |FINSI;
  |SI sw5 = 1; num = 5; |FINSI;

  |HAZ sumanume;
  #1num21 = 0; #1num23 = 0; #1num25 = 0;
  dividit = 1;
  |SI #1num22 = 0; |Y #1num24 = 0;
      #1num21 = tot_f;
  |SINO;
      |SI #1num22 ! 0; |Y #1num24 ! 0;
          dividit = ( 100 + #1num22 + #1num24) / 100;
          #1num21 = ( tot_f / dividit ) ! EURODB;
          #1num23 = (( #1num21 * #1num22 ) / 100) ! EURODB;
          #1num25 = tot_f - ( #1num21 + #1num23 );
      |SINO;
          |SI #1num22 ! 0;
              dividit = ( 100 + #1num22 ) / 100;
              #1num21 = ( tot_f / dividit ) ! EURODB;
              #1num23 = tot_f -  #1num21;
          |SINO;
              dividit = ( 100 + #1num24 ) / 100;
              #1num21 = ( tot_f / dividit ) ! EURODB;
              #1num25 = tot_f -  #1num21;
          |FINSI;
      |FINSI;
  |FINSI;
  |PINTA #1num21;
  |PINTA #1num23;
  |PINTA #1num25;
|FPRC;

|PROCESO caltot_bas;

  |SI estot = 1; |ACABA; |FINSI;
  salida = FSalida
  |SI salida ] 10; |Y salida [ 13;
      |HAZ funmodi;
      |ACABA;
  |FINSI;

  num = Campo - 3;
  |HAZ sumanume;
  #1num23 = 0; #1num25 = 0;
  |SI #1num22 ! 0;
      #1num23 = (( #1num21 * #1num22 ) / 100) ! EURODB;
  |FINSI;
  |SI #1num24 ! 0;
      #1num25 = (( #1num21 * #1num24 ) / 100) ! EURODB;
  |FINSI;

  |HAZ totfactu;
  #1#3 = tot_f;
  |PINTA #1num23;
  |PINTA #1num25;
  |PINTA #1#3;
|FPRC;

|| --------------------- Lectura del Grupo;
|PROCESO versiexiste; |TIPO 6;
 salida = FSalida;
 |ABRE #2;
 #2#0 = #1#2;
 |LEE 001#2=;
 |SI FSalida ! 0;
     |MENAV "    No existe Grupo de IVA ";
     |ERROR;
 |FINSI;
 |CIERRA #2;
|FPRC;

|PROCESO leegrupoiva; |TIPO 0;
|| salida = FSalida;
 |ABRE #2;
 #2#0 = #1#2;
 |LEE 001#2=;
 |SI FSalida ! 0;
     |CIERRA #2;
     |ERROR;
     |ACABA;
 |FINSI;
 |SI salida = 9;
     |HAZ consul_gru;
     |ERROR;
     |ACABA;
 |FINSI;

|HAZ primero; || pone todos los campos no modificables.
 ModoEntrada = (FEntrada / 100) ! 0;
|PARA num = 1; |SI num [ 5; |HACIENDO num = num + 1;
      |HAZ sumanume;
      |SI #2nume1 > doce;
          |SI num = 1; sw1 = 1; |FINSI;
          |SI num = 2; sw2 = 1; |FINSI;
          |SI num = 3; sw3 = 1; |FINSI;
          |SI num = 4; sw4 = 1; |FINSI;
          |SI num = 5; sw5 = 1; |FINSI;
          |CAMPO_MODIFICA #1num21, 1, "S"; || Cuota Base
          |SI ModoEntrada = 1;
              #1num22 = #2nume3;  |PINTA #1num22; || % IVA;
              #1num24 = #2nume6;  |PINTA #1num24; || % Recargo
          |FINSI;
      |SINO;
          |CAMPO_MODIFICA #1num21, 1, "N"; || Cuota Base
          |SI ModoEntrada = 1;
              #1num21 = 0; |PINTA #1num21;
              #1num22 = 0; #1num23 = 0; |PINTA #1num22; |PINTA #1num23;
              #1num24 = 0; #1num25 = 0; |PINTA #1num24; |PINTA #1num25;
          |FINSI;
      |FINSI;
|SIGUE;

 sw6 = sw1 + sw2 + sw3 + sw4 + sw5;
 |SI sw6 ! 1; |ACABA; |FINSI;
 |SI #0#14 = "N";
     estot = 1;
     |CAMPO_MODIFICA #1#3, 1, "S"; || Total Factura.
     |CAMPO_MODIFICA #1#4, 1, "N"; || Cuota Base 1
     |CAMPO_MODIFICA #1#5, 1, "N"; || Cuota Base 2
     |CAMPO_MODIFICA #1#6, 1, "N"; || Cuota Base 3
     |CAMPO_MODIFICA #1#7, 1, "N"; || Cuota Base 4
     |CAMPO_MODIFICA #1#8, 1, "N"; || Cuota Base 5
 |FINSI;

 |SI salida ] 10; |Y salida [13;
     |HAZ funmodi;
 |FINSI;
|FPRC;

|PROCESO primero;
estot = 0; sw1 = 0; sw2 = 0; sw3 = 0; sw4 = 0; sw5 = 0; sw6 = 0
|PARA para1 = 3; |SI para1 [ 28; |HACIENDO para1 = para1 + 1;
  |CAMPO_MODIFICA #1para1, 1, "N";
|SIGUE;
|FPRC;

|PROCESO consul_gru;
 |DDEFECTO #6;
|PARA para1 = 0; |SI para1 [ 42; |HACIENDO para1 = para1 + 1;
      |SI para1 [ 16;            y = para1;      |FINSI;
      |SI para1 ] 17; |Y para1 [ 31; y = para1 + 15; |FINSI;
      |SI para1 ] 32;            y = para1 + 30; |FINSI;
      #6para1 = #2y;
|SIGUE;
      #6#43 = #2#74; #6#44 = #2#76;
|PUSHV 1111 2278;
|PINPA #0#6;
|PARA para1 = 0; |SI para1 [ 16; |HACIENDO para1 = para1 + 1;
      |PINTA #6para1;
|SIGUE;
|PARA para1 = 17; |SI para1 [ 41; |HACIENDO para1 = para1 + 1;
      |SI #6para1 ! 0; |PINTA #6para1; |FINSI;
|SIGUE;
|PAUSA;
|POPV;
|FPRC;

|PROCESO sumanume;
  nume1 = num + 1;
  nume2 = nume1 + 30; || concepto Base
  nume3 = nume1 + 60; || % IVA
  nume4 = nume1 +  5; || Cta IVA
  nume5 = nume1 + 35; || Concepto IVA
  nume6 = nume1 + 65; || % Recargo
  nume7 = nume1 + 10; || Cta Recargo
  nume8 = nume1 + 40; || Concepto Recargo

  num21 = num + 3;
  num22 = num21 + 15; || % IVA
  num23 = num21 +  5; || Cuota IVA
  num24 = num21 + 20; || % Recargo
  num25 = num21 + 10; || Cuota Recargo
|FPRC;

|PROCESO aviso5;
|PUSHV 09101171;
|HAZ color_f;
|CUADRO 09 10 11 71;
|HAZ color_c;
|QBF avisos;
    alfa1 = avisos % 0;  nume1 = alfa1;
    nume2 = ((60 - nume1) / 2) ! 0;     nume1 = 60 - nume1 - nume2;
    avisos = (" " * nume1) + avisos + (" " * nume2);        || lo centra
|PINTA 1011, avisos;
|ATRI 0;
|AVISO;
|PAUSA;
|POPV;
|FPRC;

|PROCESO color_c;        || activa el color caracter en avisos
|COLOR 14, 0;
|ATRI 0;
|FPRC;

|PROCESO color_f;        || activa el color graficos en avisos
|COLOR 4, 0;
|ATRI 0;
|FPRC;
