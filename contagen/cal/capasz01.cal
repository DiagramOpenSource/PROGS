|FICHEROS;
 capasz01 #0;

 camw0001 #1;
 camw0002 #2;
 camw0003 #3;
 camw0004 #4;

 camaniva #11;
 caivalin #12;
 camaasil #13;

 :/basica/def/agifigen #100;
 :/modelos/def/dsmom030 #130;

 canempre #30;
 caselem1 #998;
|FIN;

|VARIABLES;
 nVer  = 0;
 nSwAlgun = 0;
 aAlfa1 = "";
 aAlfa2 = "";
 aAlfa3 = "";
 aAlfa4 = "";
 nNume1 = 0;
 nNume2 = 0;
 nNume3 = 0;
 nNume4 = 0;

 nPara1 = 0;
 nPara2 = 0;
 nCampo = 0;
 nSwTipo  = 0;
 aDescrip = "";
 aTipoRS  = "";
 nTipoNum = 0;
 nPrimer  = 0;
 nPrimer1 = 0;
 nUltim   = 0;
 nDTipoNum = 0;
 nHTipoNum = 0;
 nDPeriodo = 0;
 nHPeriodo = 0;

 nLaEmpresa = 0;
 nSwTipoE   = 0;
 nSwNoDir   = 0;
 nPin1      = 0;

 &nConcepto  = 0;
 aDescripcion ="";
 &nNuevoCon  = 0;
 &aNuevaDes = "";
 nSwCambio  = 0;
 nSelCab1   = 0;
 nSelCab2   = 0;
 nDEmpresa  = 0;
 nHEmpresa  = 0;

 nSwDiferente = 0;
 nSwEnLinea   = 0;
 nLinea       = 0;
 aFichero     = "";

 aAcum = "";
 nDAcum = 0;
 nHAcum = 0;

 inform1 = "capasz01";
 inform2 = "capasz02";

 nImporte = 0;
 nSwOpera = 0;

 aSNCli   = "";
 aSNIVA   = "";
 nAntCli  = 0;
 nAntIVA  = 0;
 nSwGraba = 0;

 nCamDes   = 0;
 nSwPrint  = 0;
 nConPrint = 0;
 nEjer     = 0;
 aParam    = "";

 nAlguno  = 0;
 nSwBase  = 0;
 nSwIva   = 0;
 nSwRec   = 0;
  nSwDto  = 0;
|FIN;

|INCLUYE dscont_i;

|| ******************************************************************
|| **** PROCESOS DE SELECCION CAMBIO ********************************
|| ******************************************************************
|CALCULO QueCambio1; |TIPO 0;
|FCAL;

|CALCULO QueCambio; |TIPO 0;
 |C_M #0#0,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #0#0 = "A"; aAlfa1 = "S"; aAlfa2 = "S"; |FINSI;
 |SI #0#0 = "R";
     aAlfa1 = "S";
     aAlfa2 = "N"; |PDEFECTO #0,12,22;
 |FINSI;
 |SI #0#0 = "S";
     aAlfa1 = "N"; |PDEFECTO #0,2,12;
     aAlfa2 = "S";
 |FINSI;

 |PARA nPara1 = 2; |SI nPara1 [ 11; |HACIENDO nPara1 = nPara1 + 1;
       |C_M #0nPara1, 1, aAlfa1; |PINTA #0nPara1;
       nNume1 = nPara1 + 10;
       |C_M #0nNume1, 1, aAlfa2; |PINTA #0nNume1;
 |SIGUE;
|FCAL;

|CALCULO SelRep0; |TIPO 0;

 |C_M #0Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #0#2 = 0;
     #0#2 = 0;  |PINTA #0#2;
     #0#3 = 0;  |PINTA #0#3;  |C_M #0#3, 1, "N";
     |PARA nCampo = 4;  |SI nCampo [ 11;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |SINO;
     |C_M #0#3, 1, "S";
     |PARA nCampo = 4;  |SI nCampo [ 11;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "N";
           #0nCampo = 0;  |PINTA #0nCampo;
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelRep1;

 |C_M #0Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #0Campo = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 11;  |HACIENDO nCampo = nCampo + 1;
           #0nCampo = 0;  |C_M #0nCampo, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 11;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelSop0; |TIPO 0;

 |C_M #0Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #0#12 = 0;
     #0#12 = 0;  |PINTA #0#12;
     #0#13 = 0;  |PINTA #0#13;  |C_M #0#13, 1, "N";
     |PARA nCampo = 14;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |SINO;
     |C_M #0#13, 1, "S";
     |PARA nCampo = 14;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "N";
           #0nCampo = 0;  |PINTA #0nCampo;
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelSop1;

 |C_M #0Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #0Campo = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
           #0nCampo = 0;  |C_M #0nCampo, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO TipoC; |TIPO 0;
 |C_M #0Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 nTipoNum = #0Campo;
                 nNume1 = Campo + 18; aTipoRS = "R";
 |SI Campo > 11; nNume1 = Campo + 16; aTipoRS = "S"; |FINSI;
 |HAZ LeeElTipo;
 |SI nSwTipo = 1;
     |MENAV "    No existe Cambio definido ";
     |ERROR;
 |SINO;
     #0nNume1 = aDescrip; |PINTA #0nNume1;
 |FINSI;
|FCAL;

|PROCESO LeeElTipo;
 nSwTipo  = 0;
 aDescrip = "";
 |SI nTipoNum = 0; |ACABA; |FINSI;

 |ABRE #3;
 #3#0 = "A";
 #3#1 = aTipoRS;
 #3#2 = nTipoNum;
 |LEE 001#3=;
 |SI FSalida ! 0;
     nSwTipo = 1;
 |SINO;
     aDescrip = #3#3;
 |FINSI;
 |CIERRA #3;
|FPRC;

|| ***********************************************************************
|| ***********************************************************************
|| ***********************************************************************
|PROCESO CambiaApte;
 #13#6 = nNuevoCon;
 |SI nCamDes = 1;
     #13#7 = aNuevaDes;
 |FINSI;
 |GRABA 020#13a;
 |LIBERA #13;
 nAlguno = 1;
|FPRC;

|DEFBUCLE CambiaApte;
 #13#1;
 19,20;
 #11#7, #11#8, #11#9, 0001, aAcum, nDAcum;
 #11#7, #11#8, #11#9, 9999, aAcum, nHAcum;
 be;
 NULL, CambiaApte;
|FIN;

|PROCESO CambiaAsiento;
 aAcum = "F"; nDAcum = 00; nHAcum = 99; |BUCLE CambiaApte;
 aAcum = " "; nDAcum = 00; nHAcum = 99; |BUCLE CambiaApte;
|FPRC;

|| ********************************************************************
|PROCESO LineaIVA;
 |SI nVer = 1;
     |SI #12#3 ! nNuevoCon;
         nSwCambio = 0;
     |FINSI;
     |LIBERA #12;
     |ACABA;
 |FINSI;

 |SI #12#3 ! nConcepto;
     |SI nSwEnLinea = 1; |LIBERA #12; |ACABA; |FINSI;
 |FINSI;

 |SI #12#17 ! #4#5; |LIBERA #12; |ACABA; |FINSI;       || Inversion S/N
 |SI #12#25 ! #4#6; |LIBERA #12; |ACABA; |FINSI;       || Intracomunitario S/N

 |SI #4#7 ! "X";
     |SI #4#16 = "="; |Y #4#8 ! #12#21; |LIBERA #12; |ACABA; |FINSI;  ||Retencion =
     |SI #4#16 = "!"; |Y #4#8 = #12#21; |LIBERA #12; |ACABA; |FINSI;  ||Retencion !

     |SI #4#9 ! "X";
         |SI #4#9 = "B";
             |SI #12#6 ! #12#20; |LIBERA #12; |ACABA; |FINSI;    || De la base
         |SINO;
             |SI #12#6 = #12#20; |LIBERA #12; |ACABA; |FINSI;    || del total factura
         |FINSI;
     |FINSI;
 |FINSI;

 |SI #4#17 ! "X";
     |SI #4#17 = "="; |Y #4#18 ! #12#7; |LIBERA #12; |ACABA; |FINSI;
     |SI #4#17 = "!"; |Y #4#18 = #12#7; |LIBERA #12; |ACABA; |FINSI;
     |SI #4#17 = ">"; |Y #4#18 > #12#7; |LIBERA #12; |ACABA; |FINSI;
     |SI #4#17 = "<"; |Y #4#18 < #12#7; |LIBERA #12; |ACABA; |FINSI;
 |FINSI;

 nSwEnLinea = 1;

 |SI #12#3 ! nConcepto; |LIBERA #12; |ACABA; |FINSI;   || Este no cambia  el mismo concepto

 #12#3 = nNuevoCon; nSwPrint = 1; nConPrint = nConcepto;
 |SI nCamDes = 1; #12#4 = aNuevaDes; |FINSI;
 |GRABA 020#12a;
 |LIBERA #12;

|| ... Proceso para cambiar los Asientos de Base, IVA y Descuento

 nSwBase = 0; nSwIva = 0; nSwRec = 0; nSwDto = 0;
 nDAcum = #12#2; nHAcum = #12#2;
 nAlguno = 0; aAcum = "B"; |BUCLE CambiaApte; aAcum = "b"; |BUCLE CambiaApte; nSwBase = nAlguno;
 nAlguno = 0; aAcum = "I"; |BUCLE CambiaApte; aAcum = "i"; |BUCLE CambiaApte; nSwIva  = nAlguno;
 nAlguno = 0; aAcum = "R"; |BUCLE CambiaApte; aAcum = "r"; |BUCLE CambiaApte; nSwRec  = nAlguno;
 nAlguno = 0; aAcum = "D"; |BUCLE CambiaApte; aAcum = "d"; |BUCLE CambiaApte; nSwDto  = nAlguno;

 |SI nSwBase = 0; |Y #12#6 ! 0;
     nDAcum = 0; nHAcum = 0;
     aAcum = "B"; |BUCLE CambiaApte; aAcum = "b"; |BUCLE CambiaApte;
 |FINSI;

 |SI nSwIva = 0; |Y #12#8 ! 0;
     nAlguno = 0; nDAcum = 0; nHAcum = 0;
     aAcum = "I"; |BUCLE CambiaApte; aAcum = "i"; |BUCLE CambiaApte;
     |SI nAlguno = 0; |Y #1#13 = "S";
         nDAcum = 6; nHAcum = 99;
         aAcum = "I"; |BUCLE CambiaApte; aAcum = "i"; |BUCLE CambiaApte;
     |FINSI;
 |FINSI;

 |SI nSwRec = 0; |Y #12#10 ! 0;
     nAlguno = 0; nDAcum = 0; nHAcum = 0;
     aAcum = "R"; |BUCLE CambiaApte; aAcum = "r"; |BUCLE CambiaApte;
     |SI nAlguno = 0; |Y #1#13 = "S";
         nDAcum = 6; nHAcum = 99;
         aAcum = "R"; |BUCLE CambiaApte; aAcum = "r"; |BUCLE CambiaApte;
     |FINSI;
 |FINSI;

 |SI nSwDto = 0; |Y #12#11 ! 0;
     nDAcum = 0; nHAcum = 0;
     aAcum = "D"; |BUCLE CambiaApte; aAcum = "d"; |BUCLE CambiaApte;
 |FINSI;

|FPRC;


|DEFBUCLE LinIVA;
 #12#1;
 ;
 #11#0, #11#1, 01;
 #11#0, #11#1, 99;
 be;
 NULL, LineaIVA;
|FIN;

|PROCESO camw0004;

 |SI #11#35 ! "A";
     |SI #4#5 = "S"; |Y #11#35 = "N";  |ACABA; |FINSI;  || Inversio de cabecera
     |SI #4#5 = "N"; |Y #11#35 = "I";  |ACABA; |FINSI;  || Inversio de cabecera
 |FINSI;

 nSelCab1  = 1;
 |SI #4#10 ! "X";
     nSelCab1  = 0;
     nImporte = #11#21;
     |SI aMonedaC ! aMonedaA;
         impMoneda = nImporte;  |HAZ ElCambioMoneda; nImporte = impMoneda;
     |FINSI;

     |SI #4#10 = "!"; |Y #4#11 ! nImporte; nSelCab1 = 1; |FINSI;
     |SI #4#10 = "="; |Y #4#11 = nImporte; nSelCab1 = 1; |FINSI;
     |SI #4#10 = "<"; |Y #4#11 > nImporte; nSelCab1 = 1; |FINSI;
     |SI #4#10 = ">"; |Y #4#11 < nImporte; nSelCab1 = 1; |FINSI;
 |FINSI;

 nSelCab2  = 1;
 |SI #4#12 ! "X";
     nSelCab2  = 0;
     |SI #4#12 = "!"; |Y #4#13 ! #11#12; nSelCab2 = 1; |FINSI;
     |SI #4#12 = "="; |Y #4#13 = #11#12; nSelCab2 = 1; |FINSI;
     |SI #4#12 = "<"; |Y #4#13 > #11#12; nSelCab2 = 1; |FINSI;
     |SI #4#12 = ">"; |Y #4#13 < #11#12; nSelCab2 = 1; |FINSI;
 |FINSI;

 |SI nSelCab1 ! 1; |O nSelCab2 ! 1; |ACABA; |FINSI;  || Seleccion de Cantidad
                                                     || y cuenta contable

 nNuevoCon    = #4#14;
 nCamDes      = 0;
 aNuevaDes    = "";
 |HAZ NueDes;
 |SI #4#19 = "S"; nCamDes = 1; |FINSI;

 |SI nSwOpera = 0;
     nSwCambio    = 1;      || Por ahora cambiamos
     nSwEnLinea   = 0;

     |BUCLE LinIVA;
     |SI nSwEnLinea = 0;
         nSwCambio = 0;
     |SINO;
         |ERROR10;
     |FINSI;
 |SINO;
     nSwEnLinea   = 0;
     |HAZ LineaIVA;
     |SI nSwEnLinea = 0; nNuevoCon = nConcepto; |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE camw0004;
 #4#1;
 4;
 #3#0,#3#1,#3#2,001,nConcepto;
 #3#0,#3#1,#3#2,999,nConcepto;
 ;
 NULL, camw0004;
|FIN;

|PROCESO CambioLinIVA;
|| |SI #12#3 ! nAntCli;
     nVer      = 0;
     nConcepto = #12#3;
     nNuevoCon = nConcepto;
     nSwOpera  = 1;
     |BUCLE camw0004;
     |SI nNuevoCon ! nConcepto;
         nSwPrint = 1; nConPrint = nConcepto;
     |FINSI;
|| |FINSI;
|FPRC;


|DEFBUCLE CambioLinIVA;
 #12#1;
 ;
 #11#0, #11#1, 01;
 #11#0, #11#1, 99;
 be;
 NULL, CambioLinIVA;
|FIN;

|PROCESO NueDes;
 |ABRE #130;
 #130#0 = nNuevoCon;
 |LEE 000#130=;
 aNuevaDes = #130#1;
 |CIERRA #130;
|FPRC;

|PROCESO ModIVA;

 |SI aParam = "";
    |PINTA 2417, #11#0;
    |PINTA 2420, #11#1;
 |FINSI;

 nAntCli = #11#27;
 nAntIVA = #11#29;

 nSwPrint  = 0;
 nVer      = 0;
 nSwGraba  = 0;
 nSwCambio = 0;
 nSwOpera  = 0;
 nConcepto = #11#27;

 |BUCLE camw0004;
 |SI nSwCambio = 1;
     nVer   = 1;
     |BUCLE LinIVA;
 |FINSI;

 nSwOpera = 1;
 |BUCLE CambioLinIVA;
 |SI nSwPrint = 1;
     nConcepto = nConPrint;
     |PRINT;
     nSwAlgun = 1;
 |FINSI;

 |SI nSwCambio = 1;
     |SI aSNCli = "S";
         #11#27 = nNuevoCon; nSwPrint = 1; nConPrint = nConcepto;
         |SI nCamDes = 1; #11#28 = aNuevaDes; |FINSI;
     |FINSI;
     |SI aSNIVA = "S"; |Y #11#29 = nAntCli;
         #11#29 = nNuevoCon; nSwPrint = 1; nConPrint = nConcepto;
         |SI nCamDes = 1; #11#30 = aNuevaDes; |FINSI;
     |FINSI;
     nSwGraba = 1;
 |FINSI;

 |SI nAntCli ! nAntIVA; |Y aSNIVA = "S";
     nSwCambio = 0;
     nSwOpera  = 0;
     nConcepto = #11#29;
     |BUCLE camw0004;
     |SI nSwCambio = 1;
         nVer = 1;
         |BUCLE LinIVA;
     |FINSI;
     |SI nSwCambio = 1;
         |SI aSNIVA = "S";
             #11#29 = nNuevoCon; nSwPrint = 1; nConPrint = nConcepto;
             |SI nCamDes = 1; #11#30 = aNuevaDes; |FINSI;
         |FINSI;
         nSwGraba = 1;
    |FINSI;
 |FINSI;


 |SI nSwGraba = 1;
    |GRABA 020#11a;
    |HAZ CambiaAsiento;
 |FINSI;
 |LIBERA #11;
|FPRC;

|DEFBUCLE leeIVA;
 #11#1;
 36;
 00, 0000000001, aTipoRS;
 99, 9999999999, aTipoRS;
 be;
 NULL, ModIVA;
|FIN;

|PROCESO HazTodo;
   eaMoneda = "E"; |HAZ Monedas;

   |SI aParam = ""; |PINTA 2404, "En Proceso: "; |FINSI;
   |BUCLE leeIVA;

|FPRC;


|PROCESO MultiEmp1;
   cod1 = #caselem1#1;
   cod2 = #caselem1#2;
   emEmp = 1;  || Sin mensaje
   |HAZ leelo;
   |SI swerror ! 0;  |ACABA;   |FINSI;

   aMonedaC = eaMoneda;
   dirfich0 = #caselem1#3;
   |QBF dirfich0;

   |PATH_DAT #11 dirfich0;
   |PATH_DAT #12 dirfich0;
   |PATH_DAT #13 dirfich0;

   |SI aParam = "";
       |ATRI R; |PINTA 2304, "Empresa: ";      |ATRI 0;
       |PINTA 2313, #30#2; |PINTA 2319, #30#1; |ATRI 0;
   |FINSI;

   nSwAlgun = 0;
   |HAZ HazTodo;
   |SI nSwAlgun = 1;
       |PIEINF;
   |FINSI;
|FPRC;

|DEFBUCLE MultiEmp0;
 #caselem1#1;
 ;
 00001;
 99999;
 ;
 NULL,MultiEmp1;
|FIN;

|PROCESO ladefinicion;

 |SI aParam = ""; |PINTA 2204, #3#3; |FINSI;
 |HAZ SelEmpresa;
 |SI nLinea = 1;  |ACABA; |FINSI;  || no hay ninguna empresa

 |BUCLE MultiEmp0;

|FPRC;

|DEFBUCLE ladefinicion;
 #3#1;
 ;
 #1#0, aTipoRS, nDTipoNum;
 #1#0, aTipoRS, nHTipoNum;
 ;
 NULL, ladefinicion;
|FIN;

|PROCESO ElTodo;
 |SI #0nPrimer ! 0;
     nDTipoNum = #0nPrimer;
     nNume1 = nPrimer + 1;
     nHTipoNum = #0nNume1;
     |BUCLE ladefinicion;
 |SINO;
     nPrimer1 = nPrimer + 2; nUltim = nPrimer + 9;
     |PARA nPara1 = nPrimer1;  |SI nPara1 [ nUltim;  |HACIENDO nPara1 = nPara1 + 1;
           nDTipoNum = #0nPara1;
           nHTipoNum = #0nPara1;
           |BUCLE ladefinicion;
     |SIGUE;
 |FINSI;
|FPRC;

|| ................................................................./////

|| ********************************************************************
|PROCESO camw0002;
 nNuevoCon    = #2#3;
 aDescripcion = #2#4;
|FPRC;

|DEFBUCLE camw0002;
 #2#1;
 2;
 #1#0,01, #12#21;
 #1#0,99, #12#21;
 ;
 NULL, camw0002;
|FIN;

|PROCESO ModIRPF;
 |SI aParam = "";
     |PINTA 2417, #12#0;
     |PINTA 2420, #12#1;
     |PINTA 2432, #12#2;
 |FINSI;

 #11#0 = #12#0;
 #11#1 = #12#1;
 |LEE 001#11=;
 |SI FSalida ! 0;
     |ACABA;
 |FINSI;
 |SI #11#36 ! "S";  |ACABA; |FINSI;

 nConcepto = #12#18;
 nNuevoCon = #1#1;
 aDescripcion = #1#10;
 |BUCLE camw0002;

 |SI nNuevoCon ! nConcepto;

     #12#18 = nNuevoCon;
     |GRABA 020#12a;
     |LIBERA #12;

     aAcum = "P";
     nDAcum = #12#2;
     nHAcum = #12#2;
     |BUCLE CambiaApte;

     |PRINT;
     nSwAlgun = 1;
 |FINSI;
|FPRC;

|DEFBUCLE leeIRPF;
 #12#1;
 21;
 00, 0000000001, 01, 1;
 99, 9999999999, 99, 999.99;
 be;
 NULL, ModIRPF;
|FIN;

|PROCESO HazTodo1;
   eaMoneda = "E"; |HAZ Monedas;

   |SI aParam = ""; |PINTA 2404, "En Proceso: "; |FINSI;
   |ABRE #11;
   |BUCLE leeIRPF;
   |CIERRA #11;
|FPRC;


|PROCESO MultiEmp11;
   cod1 = #caselem1#1;
   cod2 = #caselem1#2;
   emEmp = 1;  || Sin mensaje
   |HAZ leelo;
   |SI swerror ! 0;  |ACABA;   |FINSI;

   aMonedaC = eaMoneda;
   dirfich0 = #caselem1#3;
   |QBF dirfich0;

   |PATH_DAT #11 dirfich0;
   |PATH_DAT #12 dirfich0;
   |PATH_DAT #13 dirfich0;

   |SI aParam = "";
       |ATRI R; |PINTA 2304, "Empresa: ";      |ATRI 0;
       |PINTA 2313, #30#2; |PINTA 2319, #30#1; |ATRI 0;
   |FINSI;
   nSwAlgun = 0;
   |HAZ HazTodo1;
   |SI nSwAlgun = 1;
       |PIEINF;
   |FINSI;
|FPRC;

|DEFBUCLE MultiEmp01;
 #caselem1#1;
 ;
 00001;
 99999;
 ;
 NULL,MultiEmp11;
|FIN;

|PROCESO CambioIRPF;  || ... Cambiar el IRPF, no tiene seleccion empresas
 |INFOR inform2;
 |SI FSalida ! 0; |ACABA; |FINSI;

 |DDEFECTO #3;
 #3#3 = "CAMBIO DE REGISTROS DE IRPF";
 |SI aParam = ""; |PINTA 2204, #3#3; |FINSI;
 |HAZ SelEmpresa;
 |SI nLinea = 1;  |ACABA; |FINSI;  || no hay ninguna empresa

 |BUCLE MultiEmp01;

 |FININF;
|FPRC;


|| ......................................................................

|CALCULO ElCambio; |TIPO 3;

 aMonedaA = "E";  ||Importe en Euros
 |HAZ DirAplicSt;

 aFichero = ("3w" + Usuario) % 108;
 |NOME_DAT #998 aFichero;

|| ... ... ... ... Lee control de Definicion
 |ABRE #1;
 |DDEFECTO #1;
 |LEE 000#1p;
 |SI FSalida ! 0;
     |MENAV "    NO EXISTE DEFINICION CAMBIO ... PROCESO ABORTADO";
     |CIERRA #1;
     |ACABA;
 |FINSI;
 |CIERRA #1;

 nDPeriodo = #0#38;
 nHPeriodo = #0#39;

 |SI aParam = "";
     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;
 |FINSI;

||  |SI #0#1 ! "N";
||      |HAZ CambioIRPF;
||  |FINSI;

 |SI #0#1 ! "S";
     |INFOR inform1;
     |SI FSalida ! 0;
         |SI aParam = ""; |FINIMP; |FINSI;
         |ACABA;
     |FINSI;

     |SI #0#0 ! "S";
         aSNCli = #1#7;
         aSNIVA = #1#8;
         aTipoRS = "R";
         nPrimer = 2;
         |HAZ ElTodo;
     |FINSI;

     |SI #0#0 ! "R";
         aSNCli = #1#3;
         aSNIVA = #1#4;
         aTipoRS = "S";
         nPrimer = 12;
         |HAZ ElTodo;
     |FINSI;

     |FININF;

 |FINSI;

 |DELINDEX #998;
 |SI aParam = ""; |FINIMP; |FINSI;
|FCAL;

|| *************************************************************************
|| PROCESO PARA SELECCIONAR EMPRESA
|| *************************************************************************
|PROCESO CalDirectorio;

  |DBASS dir_fich; |QBF dir_fich;
  dir_fich = dir_fich + "contagen/fich/";
  aAlfa1 = #998#1; |QBF aAlfa1;
  aAlfa2 = #998#2; |QBF aAlfa2;
  aAlfa1 = "00000" + aAlfa1;   aAlfa1 = aAlfa1 % -105;
  aAlfa2 = "0"     + aAlfa2;   aAlfa2 = aAlfa2 % -101;
  #998#3 = dir_fich + aAlfa1 + aAlfa2 + "/";

  nSwNoDir = 0;
  aAlfa1 = #998#3;   |QBF aAlfa1;
  |MKDIR aAlfa1;
  |SI FSalida = 0;
       nSwNoDir = 1;
       |RMDIR aAlfa1;
  |FINSI;
|FPRC;

|PROCESO ElTipoEmpresa;
    nSwTipoE = 1;
    |SI Haybasica = 0; nSwTipoE = 0; |ACABA; |FINSI;
    |ABRE #agifigen;
    #agifigen#0 = nLaEmpresa; || Empresa
    |LEE 041#agifigen.=;
    |SI FSalida ! 0;
        |DDEFECTO #agifigen;
        #agifigen#87 = 1;
    |FINSI;
    |CIERRA #agifigen;
    nPin1 = #agifigen#87;

    |SI #3#40 = "S";
        |SI nPin1 ] #3#28; |Y nPin1 [ #3#29;
            nSwTipoE = 0;
        |FINSI;
    |SINO;
        |SI nPin1 = #3#30;
            nSwTipoE = 0;
        |SINO;
            |PARA nCampo = 31;  |SI nCampo [ 39;  |HACIENDO nCampo = nCampo + 1;
                  |SI nPin1 = #3nCampo; |Y nPin1 ! 0;
                      nSwTipoE = 0;
                      |SAL;
                  |FINSI;
             |SIGUE;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO Rellena;

   |SI #3#27 = "N"; |Y #canempre#21 = "I"; |ACABA; |FINSI;

   nLaEmpresa  = #canempre#2;
   |HAZ ElTipoEmpresa;
   |SI nSwTipoE = 1; |ACABA; |FINSI;

   |DDEFECTO #998;
   #998#0 = nLinea;
   nLinea = nLinea + 1;
   #998#1 = #canempre#2;
   #998#2 = #canempre#3;
   |HAZ CalDirectorio;
   |SI nSwNoDir = 0;
       |GRABA 020#998n;
   |FINSI;
|FPRC;

|DEFBUCLE Rellena;
 #canempre#1;
 ;
 nDEmpresa,nDPeriodo;
 nHEmpresa,nHPeriodo;
 ;
 NULL,Rellena;
|FIN;


|PROCESO SelEmpresa;
 |DELINDEX #998;

 |ABRE #998;
 nLinea = 1;

 |SI #3#5 ! 0;
     nDEmpresa = #3#5;
     nHEmpresa = #3#6;
     |BUCLE Rellena;
 |SINO;
     |PARA nPara2 = 7; |SI nPara2 [ 26; |HACIENDO nPara2 = nPara2 + 1;
          nDEmpresa = #3nPara2;
          nHEmpresa = #3nPara2;
          |BUCLE Rellena;
     |SIGUE;
 |FINSI;
 |CIERRA #998;
|FPRC;


|PROGRAMA;
  aParam = PARAMETRO; |QBF aParam;

  |SI aParam = "";
      |MANTE #0;
  |SINO;
      |HAZ CreaLatabla;
      |SI #0#38 ! -1;
          |HAZ ElCambio;
      |FINSI;
  |FINSI;
|FPRO;

|| ****************** Proceso especial para cambiar del 806 y 807 a 808
|PROCESO Borrar04;
 |BORRA 020#4a;
 |LIBERA #4;
|FPRC;

|DEFBUCLE Borrar04;
 #4#1;
 ;
 #1#0, "R", 99, 001;
 #1#0, "R", 99, 999;
 be;
 NULL, Borrar04;
|FIN;

|PROCESO CreaLatabla;

    |DDEFECTO #0;
    #0#0 = "R";
    #0#2 = 99;
    #0#3 = 99;
    #0#38 = -1;

    aAlfa1 = enEjercicio;
    aAlfa1 = aAlfa1 % -102;
    nEjer = aAlfa1;
    |ABRE #30;
    |SELECT #4#30;
    #30#2  = enEmpresa;
    #30#26 = nEjer;
    |LEE 001#30=;
    |SI FSalida = 0;
        #0#38 = #30#3;
        #0#39 = #30#3;
    |FINSI;
    |SELECT #1#30;
    |CIERRA #30;

    |SI #0#38 = -1; |ACABA; |FINSI;

    |ABRE #1;
    |LEE 000#1p;
    |SI FSalida ! 0;
        |DDEFECTO #1;
        |GRABA 020#1n;
    |FINSI;
    |CIERRA #1;

    |ABRE #3;
    |DDEFECTO #3;
    #3#0 = #1#0;
    #3#1 = "R";
    #3#2 = 99;
    |LEE 000#3=;
    |SI FSalida = 0;
        |BORRA 020#3a;
    |FINSI;

        |DDEFECTO #3;
        #3#0 = #1#0;
        #3#1 = "R";
        #3#2 = 99;
        #3#4 = "REPERCUTIDO";
        #3#3 = "CAMBIO DE SUBVENCIONES DE INMOVILIZADO";
        #3#5 = enEmpresa;
        #3#6 = enEmpresa;
        #3#27 = "S";
        |GRABA 020#3n;
    |CIERRA #3;

    |BUCLE Borrar04;

    |ABRE #4;
    |PARA nPara1 = 1; |SI nPara1 [ 4; |HACIENDO nPara1 = nPara1 + 1;
          |DDEFECTO #4;
          #4#0 = #1#0;
          #4#1 = "R";
          #4#2 = 99;
          #4#3 = nPara1;
          |SI nPara1 = 1; |O nPara1 = 2; #4#4 = 806; |FINSI;
          |SI nPara1 = 3; |O nPara1 = 4; #4#4 = 807; |FINSI;

          |SI nPara1 = 1; |O nPara1 = 3; #4#5 = "N"; |FINSI;
          |SI nPara1 = 2; |O nPara1 = 4; #4#5 = "S"; |FINSI;
          #4#14 = 808;
          |GRABA 020#4n;
    |SIGUE;
    |CIERRA #4;
|FPRC;
