|FICHEROS;
  capasy02 #0;

  caivalin #1;
  camaniva #2;
  cacuenta #3;
  caivare@ #11;
  caivaso@ #12;

  caw00013 #913;

  :/basica/def/dspase00 #100;

  canempre #30;
  canempr@ #330;
  camoned@ #331;

  cam00010 #110;
  cam00011 #111;
  cam00013 #113;
|FIN;

|VARIABLES;
 informe = "";
 inform1 = "capasy02";
 inform2 = "capasy02";

 nSwPaso = 0;
 aAlfa1  = "";
 aAlfa2  = "";
 aAlfa3  = "";
 nPara1  = 0;
 nNume1  = 0;
 nNume2  = 0;
 nNume3  = 0;
 nNume4  = 0;
 nNume5  = 0;
 &r_emp  = 0;
 &r_per  = 0;

 aFichero = "";
 aDef11   = "";
 aDef12   = "";
 aDef330  = "";
 aDef331  = "";

 aDirInicio = "";
 aDirBase   = "";
 aPathDef   = "";
 aPathFic1  = "";
 aPathFic0  = "";
 aPathFic00 = "";
 aDFicEm1   = "";
 aDFicEm2   = "";
 nSwError   = 0;
 aMensa     = "";
 aQueQuiero = "";
 aNumCampos = "";
 nNumCampos = 0;

 nConta0    = 0;
 nConta1    = 0;
 nConta2    = 0;
 nSwBusco   = 0;

 nSwELin    = 0;
 nSwELin2   = 0;
 nSwW13     = 0;
 nW13Cam0   = 0;
 nW13Cam1   = 0;
 nW13Cam2   = 0;
 fW13Cam3   = @;
 nW13Cam4   = 0;
 nW13Cam5   = 0;
 fW13Cam6   = @;
 nW13Cam7   = 0;
 nW13Cam8   = 0;
 nW13Cam9   = 0;
 aW13Cam10  = "";
 aW13Cam11  = "";


 nSwAlgun  = 0;
 &aTitulo  = "";
 &nSwInf   = 0;
 fLaFec    = @;

 nInkey     = 0;
 nDEmp      = 0;
 nHEmp      = 0;

 nTipoDif   = 0;
 nDTipoDif   = 0;
 nHTipoDif   = 0;
 Comodin    = "";
 Comodin1   = "";

 &eaMonedaV = "";
 &enEmpresaV  = 0;
 &enPeriodoV  = 0;
 &eSwCambio = 0;
 aTipo  = "";
 aDTipo = "";
 aHTipo = "";
 nNCamRep = 0;
 nNCamSop = 0;
 nLibro1  = 0;
 aSerie1  = "";
 nFactu1  = 0;

 nLibro2  = 0;
 aSerie2  = "";
 nFactu2  = 0;
 fW19     = @;
 aW20     = "";
 aW21     = "";
 aW22     = "";
 nW23     = 0;
 nW24     = 0;
 nW25     = 0;
 nW26     = 0;

 nCtr1   = 0;
 nCtr2   = 0;
 aError  = "";
 nBase1  = 0;
 nTotal1 = 0;
 nCuota1 = 0;
 nReten1 = 0;
 nBase2  = 0;
 nTotal2 = 0;
 nCuota2 = 0;
 nReten2 = 0;
 aParam  = "";
 &eaPreg22_5 = "";
|FIN;

|INCLUYE dscont_i;
|| **********************************************************************
|| ***** Calculos de Pantalla
|| **********************************************************************
|CALCULO defectos; |TIPO 7;
   |SI nSwPaso = 0;
       #0#0 = enEmpresa;     |PINTA #0#0;
       #0#1 = enPeriodo;     |PINTA #0#1;
       #0#2 = eaNombreEmp;   |PINTA #0#2;
       #0#3 = #30#26;        |PINTA #0#3;
       #0#4 = eaMoneda;

       #0#5 = #0#0; |PINTA #0#5;
       #0#6 = #0#1; |PINTA #0#6;
       #0#7 = #0#2; |PINTA #0#7;
       #0#8 = #0#3; |PINTA #0#8;
       #0#9 = #0#4;

       #0#12 = fec1; |PINTA #0#12;
       #0#13 = fec2; |PINTA #0#13;
       nSwPaso = 1;
   |FINSI;
|FCAL;

|CALCULO esbuena;

  |SI FSalida = 9;
      r_emp = #0Campo;
      |SUB_EJECUTA_NP "caconemp";
      |ERROR;
      nNume1   = Campo + 1;
      #0Campo  = r_emp;
      #0nNume1 = r_per;
      |PTEC 802;
      |PTEC 802;
      |ACABA;
  |FINSI;

  |SI Campo = 0; |Y #0Campo = enEmpresa; |ACABA; |FINSI;

  |ABRE #30;
  #30#2 = #0Campo;
  #30#3 = 0;
  |LEE 011#30];
  |SI FSalida ! 0;  |O #30#2 ! #0Campo;
      |MENAV "     NO Existe la Empresa Contable";
      |ERROR;
  |SINO;
      nNume1   = Campo + 2;
      #0nNume1 = #30#1; |PINTA #0nNume1;
  |FINSI;
  |CIERRA #30;

  |SI Campo = 0;
      |SI #30#26 > 80;
          enEjercicio = 1900 + #30#26;
      |SINO;
          enEjercicio = 2000 + #30#26;
      |FINSI;
      aAlfa1 = enEjercicio;
      aAlfa2 = #0#12 % 106;
      aAlfa3 = aAlfa2 + aAlfa1; #0#12 = aAlfa3; |PINTA #0#12;
      aAlfa2 = #0#13 % 106;
      aAlfa3 = aAlfa2 + aAlfa1; #0#13 = aAlfa3; |PINTA #0#13;
  |FINSI;
|FCAL;

|CALCULO esbuena1;
  |SI FSalida = 2; |ACABA; |FINSI;

  nNume1 = Campo - 1;
  nNume2 = Campo + 1;
  nNume3 = Campo + 2;
  nNume4 = Campo + 3;
  |SI Campo = 1; |Y #0Campo = enPeriodo; |Y #0nNume1 = enEmpresa;
      |ACABA;
  |FINSI;

  |ABRE #30;
  #30#2 = #0nNume1;
  #30#3 = #0Campo;
  |LEE 011#30=;
  |SI FSalida ! 0;
      |MENAV "     NO Existe Periodo en la Empresa Contable";
      |CIERRA #30;
      |ERROR;
      |ACABA;
  |FINSI;

  #0nNume2 = #30#1;   |PINTA #0nNume2;
  #0nNume3 = #30#26;  |PINTA #0nNume3;
  #0nNume4 = #30#28;
  |CIERRA #30;
|FCAL;

|CALCULO Defecto; |TIPO 7;
    |DBASS aDirInicio; |QBF aDirInicio;
    aDirInicio = #100#0; |QBF aDirInicio;
    aDirBase = aDirInicio + "agicont/";
    #0Campo = aDirBase;
    |PINTA #0Campo;
    |HAZ DesCargaDef;
|FCAL;

|CALCULO PonBarra; |TIPO 0;
     aAlfa1 = #0Campo;
     |QBF aAlfa1;
     aAlfa2 = aAlfa1 % -101;
     |SI aAlfa2 ! "/";|Y aAlfa2 ! "\";
          #0Campo = aAlfa1 + "/";
          |PINTA #0Campo;
     |FINSI;
     |HAZ CargaEmpresa;
     |SI nSwError = 1;
         |MENAV aMensa;
         |ERROR;
     |FINSI;
|FCAL;

|RUTINA infA2;
   #330#2 = nDEmp;
   #330#3 = 0;
|FRUT;

|RUTINA supA2;
   #330#2 = nHEmp;
   #330#3 = 9;
|FRUT;


|CALCULO LeeEmpresa; |TIPO 0;
  nInkey = FSalida;

  aDirBase = #0#17; |QBF aDirBase;
  aPathFic0  = aDirBase + "fich/";
  |PATH_DAT #330 aPathFic0;

  |SI nInkey = 10;
     nDEmp = 0; nHEmp = 99999;
     |ABRE #330;
     |CONSULTA_F_CLAVE #1#330,infA2,supA2;
     #0#5 = #330#2; |PINTA #0#5;
     #0#6 = #330#3; |PINTA #0#6;
     |CIERRA #330;
     |PTEC 802;
     |ACABA;
  |FINSI;

  |ABRE #330;
  #330#2 = #0#5;
  #330#3 = 0;
  |LEE 011#330];
  |SI FSalida ! 0;  |O #330#2 ! #0#5;
      |MENAV "     NO Existe la empresa Contable";
      |ERROR;
  |SINO;
      #0#7 = #330#1; |PINTA #0#7;
  |FINSI;
  |CIERRA #330;
|FCAL;

|CALCULO LeeEmpresaP; |TIPO 0;
  nInkey = FSalida;
  |SI nInkey = 2; |ACABA; |FINSI;

  aDirBase = #0#17; |QBF aDirBase;
  aPathFic0  = aDirBase + "fich/";
  aPathFic00 = aDirBase + "fich/000000/";
  |PATH_DAT #330 aPathFic0;
  |PATH_DAT #331 aPathFic00;

  |SI nInkey = 10;
     nDEmp = #0#5; nHEmp = #0#5;
     |ABRE #330;
     |CONSULTA_F_CLAVE #1#330,infA2,supA2;
     #0#6 = #330#3; |PINTA #0#6;
     |CIERRA #330;
  |FINSI;

  aMonedaC = "E";
  |ABRE #330;
  #330#2 = #0#5;
  #330#3 = #0#6;
  |LEE 011#330=;
  |SI FSalida ! 0;
      |MENAV "     NO Existe Periodo en la Empresa Contable";
      |ERROR;
  |SINO;
      #0#7   = #330#1;  |PINTA #0#7;
      #0#8   = #330#26; |PINTA #0#8;
      #0#9 = "P";
      |SI aDef331 ! "";
          |ABRE #331;
          #331#0 = #0#5;
          #331#1 = #0#6;
          |LEE 000#331=;
          |SI FSalida = 0; #0#9 = #331#2; |FINSI;
          |CIERRA #331;
      |FINSI;
      |SI #0#3 ! #0#8;
          |MENAV "    Error. Las Empresas no pertenecen al mismo Ejercicio Contable ";
          |ERROR;
     |FINSI;
  |FINSI;
  |CIERRA #330;
|FCAL;

|CALCULO dia_h; |TIPO 0;
 |SI #0#10 > #0#11; |ERROR; |FINSI;
|FCAL;

|CALCULO fech_h; |TIPO 0;
 |SI #0#12 > #0#13; |ERROR; |FINSI;
|FCAL;

|CALCULO quetitol; |TIPO 0;
 |SI #0#14 = "S";
 |SINO;
     #0#15 = "INFORME DE DIFERENCIAS EN LIBROS DE IRPF ";
 |FINSI;
 |PINTA #0#15;
|FCAL;

|| *************************************************************************
|PROCESO DesCargaDef;
     |SI aDef11  ! "";   |DESCARGA_DEF #caivare@; aDef11  = ""; |FINSI;
     |SI aDef12  ! "";   |DESCARGA_DEF #caivaso@; aDef12  = ""; |FINSI;
     |SI aDef330 ! "";   |DESCARGA_DEF #canempr@; aDef330 = ""; |FINSI;
     |SI aDef331 ! "";   |DESCARGA_DEF #camoned@; aDef331 = ""; |FINSI;
|FPRC;
|| *************************************************************************
|PROCESO CargaEmpresa;

     nSwError = 0;
     aMensa   = "";

     aDirBase = #0#17; |QBF aDirBase;
     aPathDef = aDirBase + "def/";

     aDef330 = aPathDef + "canempre";
     |CARGA_DEF aDef330, canempr@;
     |SI FSalida ! 0;
         aMensa   = "0000Error en:" + aDef330;
         aDef330    = "";
         nSwError = 1;
         |ACABA;
     |FINSI;

|| ... Averiguar la Version de Contabilidad
|| .......................................................
     aQueQuiero = "|NC";
     aNumCampos = #canempr@#aQueQuiero#;
     nNumCampos = aNumCampos;

     aDef331 = aPathDef + "camoneda";
     |CARGA_DEF aDef331, camoned@;
     |SI FSalida ! 0;
         aMensa   = "0000Error en:" + aDef331;
         aDef331   = "";
     |FINSI;
|FPRC;

|| *************************************************************************
|| *************************************************************************
|PROCESO GrabaW13;
 |DDEFECTO #913;
 #913#0  = #0#0;
 #913#1  = #0#1;
 #913#2  = nLibro2;
 #913#3  = fW19;
 #913#4  = nFactu2;
 #913#11 = aSerie2;
 |GRABA 000#913n;
|FPRC;
|| ********************
|PROCESO Graba113_1;  || Graba Auxiliar m013
 |SI nConta2 = 0;
     nConta1 = nConta1 + 1;

     |DDEFECTO #113;
     #113#0 = #0#0;
     #113#1 = #0#1;
     #113#2 = aTipo;
     #113#3 = nLibro1;
     #113#4 = nConta1;

     #113#5  = #2#1;
     #113#6  = #2#2;
     #113#7  = #2#3;
     #113#8  = #2#4;
     #113#9  = #2#12;
     #113#10 = #2#13;
     #113#11 = #2#28;
     #113#12 = #2#19;
     #113#13 = #2#23;
     #113#14 = #2#20;
     #113#15 = #2#21;
     #113#16 = nCtr1;

     #113#17 = aSerie2;
     #113#18 = nFactu2;
     #113#19 = fW19;
     #113#20 = aW20;
     #113#21 = aW21;
     #113#22 = aW22;
     #113#23 = nW23;
     #113#24 = nW24;
     #113#25 = nW25;
     #113#26 = nW26;
     #113#27 = nCtr2;

     |GRABA 000#113n;
 |FINSI;
 |HAZ GrabaW111_1;
|FPRC;

|PROCESO GrabaW111_1;  || Graba Auxiliar m011
 nConta2 = nConta2 + 1;

 |DDEFECTO #111;
 #111#0 = #113#0;
 #111#1 = #113#1;
 #111#2 = #113#2;
 #111#3 = #113#3;
 #111#4 = #113#4;
 #111#5 = nConta2;
 #111#6 = #113#16;
 #111#7 = #113#27;
 #111#8 = aError;
 |GRABA 000#111n;
|FPRC;
|| **********************************************************************

|PROCESO BuscoC;
 nConta1 = #113#4;
|FPRC;

|DEFBUCLE BuscoC;
 #113#1;
 ;
 #0#0, #0#1, aTipo, nLibro2, 000001;
 #0#0, #0#1, aTipo, nLibro2, 999999;
 ;
 NULL, BuscoC;
|FIN;

|PROCESO GrabaW12_2;  || Graba Auxiliar 12 para Empresa 1
 nConta2 = 0;
 nConta1 = 0;
 |BUCLE BuscoC;
 nConta1 = nConta1 + 1;

 |ABRE #113;
 |DDEFECTO #113;
 #113#0 = #0#0;
 #113#1 = #0#1;
 #113#2 = aTipo;
 #113#3 = nLibro2;
 #113#4 = nConta1;
 #113#16 = nCtr1;

 #113#17 = aSerie2;
 #113#18 = nFactu2;
 #113#19 = fW19;
 #113#20 = aW20;
 #113#21 = aW21;
 #113#22 = aW22;
 #113#23 = nW23;
 #113#24 = nW24;
 #113#25 = nW25;
 #113#26 = nW26;
 #113#27 = nCtr2;
 |GRABA 000#113n;
 |CIERRA #113;
 aError = "ESTA FACTURA NO EXISTE EN LA NUEVA GESTION ";
 |HAZ GrabaW111_1;
|FPRC;

|| *************************************************************************
|PROCESO ElProcesoDos;

 #913#0 = nW13Cam0;
 #913#1 = nW13Cam1;
 #913#2 = nW13Cam2;
 #913#4 = nW13Cam4;
 #913#11 = aW13Cam11;
 |LEE 000#913=;
 |SI FSalida ! 0;
    |ATRI R;
    |PINTA 2353, nLibro2;
    |PINTA 2356, nFactu2;
    |PINTA 2367, aSerie2;
    |ATRI 0;
    |HAZ GrabaW12_2;  || Graba Auxiliar 12 para Empresa 1
 |FINSI;

 nLibro1 = nLibro2;
 nBase2  = nW23; nTotal2 = nW26;
 nCuota2 = nW24; nReten2 = nW24;
 nBase1   = 0;   nTotal1 = 0;
 nCuota1  = 0;   nReten1 = 0;
 |HAZ GrRegistro_110;
|FPRC;

|PROCESO PaseRegistro1Rep;

 |SI aMonedaC ! aMonedaA;  |HAZ CamRep; |FINSI;
 nW13Cam0  = #0#0;
 nW13Cam1  = #0#1;
 nW13Cam2  = #11#0;
 nW13Cam4  = #11#2;
 aW13Cam11 = #11#27; |QBF aW13Cam11;
 nLibro2 = #11#0;
 aSerie2 = #11#27; |QBF aSerie2;
 nFactu2 = #11#2;
 fW19    = #11#3;
 aW20    = #11#4;
 aW21    = #11#50;
 aW22    = #11#7;
 nW23    = #11#8 + #11#9 + #11#10 + #11#52 + #11#53;
 nW24    = #11#14 + #11#15 + #11#16 + #11#56 + #11#57;
 nW24    = nW24 + #11#20 + #11#21 + #11#22 + #11#60 + #11#61;
 |SI nNCamRep = 66; nW25 = #11#63; |FINSI;
 nW26    = #11#26;

 nW23 = nW23 ! EURODB;
 nW24 = nW24 ! EURODB;
 |HAZ ElProcesoDos;
|FPRC;

|PROCESO PaseRegistro1Sop;

 |SI aMonedaC ! aMonedaA;  |HAZ CamSop; |FINSI;
 nW13Cam0  = #0#0;
 nW13Cam1  = #0#1;
 nW13Cam2  = #12#0;
 nW13Cam4  = #12#2;
 aW13Cam11 = #12#27; |QBF aW13Cam11;
 nLibro2 = #12#0;
 aSerie2 = #12#27; |QBF aSerie2;
 nFactu2 = #12#2;
 fW19    = #12#3;
 aW20    = #12#4;
 aW21    = #12#50;
 aW22    = #12#7;
 nW23    = #12#8 + #12#9 + #12#10 + #12#52 + #12#53;
 nW24    = #12#14 + #12#15 + #12#16 + #12#56 + #12#57;
 nW24    = nW24 + #12#20 + #12#21 + #12#22 + #12#60 + #12#61;
 |SI nNCamSop = 66; nW25 = #12#63; |FINSI;
 nW26    = #12#26;
 nW23 = nW23 ! EURODB;
 nW24 = nW24 ! EURODB;
 |HAZ ElProcesoDos;
|FPRC;

|DEFBUCLE PaseReperc1;
 #caivare@#1003;
 3;
 #0#10, 000001, "  ", #0#12;
 #0#11, 999999, "zz", #0#13;
 ;
 NULL,PaseRegistro1Rep;
|FIN;

|DEFBUCLE PaseSoport1;
 #caivaso@#1003;
 3;
 #0#10, 000001, "  ", #0#12;
 #0#11, 999999, "zz", #0#13;
 ;
 NULL,PaseRegistro1Sop;
|FIN;

|DEFBUCLE PaseReperc2;
 #caivare@#1003;
 3;
 #0#10, "  ", 000001, #0#12;
 #0#11, "zz", 999999, #0#13;
 ;
 NULL,PaseRegistro1Rep;
|FIN;

|DEFBUCLE PaseSoport2;
 #caivaso@#1003;
 3;
 #0#10, "  ", 000001, #0#12;
 #0#11, "zz", 999999, #0#13;
 ;
 NULL,PaseRegistro1Sop;
|FIN;

|DEFBUCLE PaseSoport3;
 #caivaso@#1002;
 3;
 #0#10, 000001, #0#12;
 #0#11, 999999, #0#13;
 ;
 NULL,PaseRegistro1Sop;
|FIN;

|PROCESO  CreaAuxi2;
 nCtr1   = 0;
 nCtr2   = 1;
  |SELECT #2#913;
  |SI #0#19 ! "S";
      nTipoDif = 2;
      aTipo    = "R";
      |SI nNCamRep >  64;
          |BUCLE PaseReperc1;
      |SINO;
          |BUCLE PaseReperc2;
      |FINSI;
  |FINSI;
  |SI #0#19 ! "R";
      nTipoDif = 3;
      aTipo    = "S";
      |SI nNCamSop =  66;
          |BUCLE PaseSoport1;
      |FINSI;
      |SI nNCamSop =  62;
          |BUCLE PaseSoport2;
      |FINSI;
      |SI nNCamSop =  65;
          |BUCLE PaseSoport3;
      |FINSI;
  |FINSI;
  |SELECT #1#913;
|FPRC;

|| ==================================================================
|| ................................................
|PROCESO CompLinea;
 nNume1 = #1#2;
 |SI nNume1 > 5;
     aError = "EXISTEN MAS BASES QUE EN LA FACTURA ANTERIOR";
     |HAZ Graba113_1;
     |ERROR10;
 |FINSI;
 |SI nNume1 < 4;
     nNume1 = nNume1 + 7;
     nNume2 = nNume1 + 3;
     nNume3 = nNume1 + 6;
     nNume4 = nNume1 + 9;
     nNume5 = nNume1 + 12;
 |SINO;
     nNume1 = nNume1 + 48;
     nNume2 = nNume1 + 2;
     nNume3 = nNume1 + 4;
     nNume4 = nNume1 + 6;
     nNume5 = nNume1 + 8;
 |FINSI;

 aAlfa1 = #1#2;
 |SI aTipo = "R";
     |SI #1#6 ! #11nNume1;
         aError = "IMPORTE DE LA BASE " + aAlfa1 + " DISTINTA";
         |HAZ Graba113_1;
     |SINO;
         |SI #1#7 ! #11nNume2;
             aError = "% DE IVA EN LA LINEA " + aAlfa1 + " DISTINTO";
             |HAZ Graba113_1;
         |SINO;
             |SI #1#8 ! #11nNume3;
                 aError = "CUOTA DE IVA EN LA LINEA " + aAlfa1 + " DISTINTA";
                 |HAZ Graba113_1;
             |SINO;
                 |SI #1#9 ! #11nNume4;
                     aError = "% DE RECARGO EN LA LINEA " + aAlfa1 + " DISTINTO";
                     |HAZ Graba113_1;
                 |SINO;
                     |SI #1#10 ! #11nNume5;
                         aError = "CUOTA DE RECARGO EN LA LINEA " + aAlfa1 + " DISTINTA";
                         |HAZ Graba113_1;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
     |SI nNCamRep = 66;
         |SI #1#20 ! #11#65; |O #1#21 ! #11#64; |O #1#22 ! #11#63;
             aError = "DATOS DE RETENCION DIFERENTES ";
             |HAZ Graba113_1;
         |FINSI;
     |FINSI;
 |SINO;
     |SI #1#6 ! #12nNume1;
         aError = "IMPORTE DE LA BASE " + aAlfa1 + " DISTINTA";
         |HAZ Graba113_1;
     |SINO;
         |SI #1#7 ! #12nNume2;
             aError = "% DE IVA EN LA LINEA " + aAlfa1 + " DISTINTO";
             |HAZ Graba113_1;
         |SINO;
             |SI #1#8 ! #12nNume3;
                 aError = "CUOTA DE IVA EN LA LINEA " + aAlfa1 + " DISTINTA";
                 |HAZ Graba113_1;
             |SINO;
                 |SI #1#9 ! #12nNume4;
                     aError = "% DE RECARGO EN LA LINEA " + aAlfa1 + " DISTINTO";
                     |HAZ Graba113_1;
                 |SINO;
                     |SI #1#10 ! #12nNume5;
                         aError = "CUOTA DE RECARGO EN LA LINEA " + aAlfa1 + " DISTINTA";
                         |HAZ Graba113_1;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
     |SI nNCamRep = 66;
         |SI #1#20 ! #12#65; |O #1#21 ! #12#62; |O #1#22 ! #12#63;
             aError = "DATOS DE RETENCION DIFERENTES ";
             |HAZ Graba113_1;
         |FINSI;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE CompLinea;
 #1#1;
 ;
 #2#0, #2#1, 01;
 #2#0, #2#1, 99;
 ;
 NULL, CompLinea;
|FIN;

|PROCESO BuscoReper;
 aError = "";
 |ABRE #11;
 #11#0  = nLibro1;
 #11#2  = nFactu1;
 #11#27 = aSerie1;
 |LEE 001#11=;
 |SI FSalida ! 0;
     nSwBusco = 0;
     aError   = "NO EXISTE FACTURA EN GESTION ANTERIOR";
     |CIERRA #11;
     |HAZ Graba113_1;
     |ACABA;
 |FINSI;

 |SI aMonedaC ! aMonedaA;  |HAZ CamRep; |FINSI;

 nLibro2 = #11#0;
 aSerie2 = #11#27; |QBF aSerie2;
 nFactu2 = #11#2;
 fW19    = #11#3;
 aW20    = #11#4;
 aW21    = #11#50;
 aW22    = #11#7;
 nW23    = #11#8 + #11#9 + #11#10 + #11#52 + #11#53;
 nW24    = #11#14 + #11#15 + #11#16 + #11#56 + #11#57;
 nW24    = nW24 + #11#20 + #11#21 + #11#22 + #11#60 + #11#61;
 |SI nNCamRep = 66; nW25 = #11#63; |FINSI;
 nW26    = #11#26;

 nW23 = nW23 ! EURODB;
 nW24 = nW24 ! EURODB;

 nSwBusco = 1;
 |SI #11#3 ! #2#4;
     aError = "FECHA FACTURA DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 aAlfa1 = #11#50; |QBF aAlfa1;
 aAlfa2 = #2#13;  |QBF aAlfa2;
 |SI aAlfa1 ! aAlfa2;
     aError = "TITULAR DE LA FACTURA DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 aAlfa1 = #11#7; |QBF aAlfa1;
 aAlfa2 = #2#28;  |QBF aAlfa2;
 |SI aAlfa1 ! aAlfa2;
     aError = "DESCRIPCION DEL CONCEPTO DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nW23 ! #2#19;
     aError = "TOTAL DE BASES DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nW24 ! #2#23;
     aError = "TOTAL DE CUOTAS DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nNCamRep = 66;
     |SI nW25 ! #2#20;
         aError = "TOTAL RETENCION  DIFERENTE ";
         |HAZ Graba113_1;
     |FINSI;
 |FINSI;

  |SI nW26 ! #2#21; |Y nW23 = #2#19; |Y nW24 = #2#23;
      aError = "TOTAL FACTURA  DIFERENTE ";
      |HAZ Graba113_1;
  |FINSI;

  |SI aError = "";
      |BUCLE CompLinea;
  |FINSI;
  |CIERRA #11;
|FPRC;

|PROCESO BuscoSopor;
 aError = "";
 |ABRE #12;
 #12#0  = nLibro1;
 #12#2  = nFactu1;
 #12#27 = aSerie1;
 |LEE 001#12=;
 |SI FSalida ! 0;
     nSwBusco = 0;
     aError   = "NO EXISTE FACTURA EN GESTION ANTERIOR";
     |CIERRA #12;
     |HAZ Graba113_1;
     |ACABA;
 |FINSI;

 |SI aMonedaC ! aMonedaA;  |HAZ CamSop; |FINSI;

 nLibro2 = #12#0;
 aSerie2 = #12#27; |QBF aSerie2;
 nFactu2 = #12#2;
 fW19    = #12#3;
 aW20    = #12#4;
 aW21    = #12#50;
 aW22    = #12#7;
 nW23    = #12#8 + #12#9 + #12#10 + #12#52 + #12#53;
 nW24    = #12#14 + #12#15 + #12#16 + #12#56 + #12#57;
 nW24    = nW24 + #12#20 + #12#21 + #12#22 + #12#60 + #12#61;
 |SI nNCamSop = 66; nW25 = #12#63; |FINSI;
 nW26    = #12#26;

 nW23 = nW23 ! EURODB;
 nW24 = nW24 ! EURODB;

 nSwBusco = 1;
 |SI #12#3 ! #2#4;
     aError = "FECHA FACTURA DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 aAlfa1 = #12#50; |QBF aAlfa1;
 aAlfa2 = #2#13;  |QBF aAlfa2;
 |SI aAlfa1 ! aAlfa2;
     aError = "TITULAR DE LA FACTURA DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 aAlfa1 = #12#7; |QBF aAlfa1;
 aAlfa2 = #2#28;  |QBF aAlfa2;
 |SI aAlfa1 ! aAlfa2;
     aError = "DESCRIPCION DEL CONCEPTO DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nW23 ! #2#19;
     aError = "TOTAL DE BASES DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nW24 ! #2#23;
     aError = "TOTAL DE CUOTAS DIFERENTE ";
     |HAZ Graba113_1;
 |FINSI;

 |SI nNCamSop = 66;
     |SI nW25 ! #2#20;
         aError = "TOTAL RETENCION  DIFERENTE ";
         |HAZ Graba113_1;
     |FINSI;
 |FINSI;

  |SI nW26 ! #2#21; |Y nW23 = #2#19; |Y nW24 = #2#23;
      aError = "TOTAL FACTURA  DIFERENTE ";
      |HAZ Graba113_1;
  |FINSI;

  |SI aError = "";
      |BUCLE CompLinea;
  |FINSI;
  |CIERRA #12;
|FPRC;

|| ................................................
|PROCESO CreaAuxi1;

 |PINTA 2353, #2#0;
 |PINTA 2356, #2#1;
 |PINTA 2367, #2#2;
 |PINTA 2373, #2#3;

 aTipo   = #2#36;
 nLibro1 = #2#0;
 aSerie1 = #2#2; |QBF aSerie1;
 nFactu1 = #2#3;

 nSwBusco = 0;
 nConta2  = 0;
 nLibro2 = 0;
 aSerie2 = "";
 nFactu2 = 0;
 fW19    = @;
 aW20    = "";
 aW21    = "";
 aW22    = "";
 nW23    = 0;
 nW24    = 0;
 nW25    = 0;
 nW26    = 0;
 nCtr1   = 1;
 nCtr2   = 0;

 |SI aTipo = "R";
     nTipoDif   = 2;
     |HAZ BuscoReper;
 |FINSI;
 |SI aTipo = "S";
     nTipoDif   = 3;
     |HAZ BuscoSopor;
 |FINSI;

 |SI nSwBusco = 1;
     |HAZ GrabaW13;
 |FINSI;

  nBase1   = #2#19; nTotal1 = #2#21;
  nCuota1  = #2#23; nReten1 = #2#20;
  nBase2   = 0;     nTotal2 = 0;
  nCuota2  = 0;     nReten2 = 0;
  |HAZ GrRegistro_110;
|FPRC;

|DEFBUCLE CreaAuxi1;
 #2#1;
 4,36;
 #0#10, 0000000001, #0#12, aDTipo;
 #0#11, 9999999999, #0#13, aHTipo;
 e;
 NULL, CreaAuxi1;
|FIN;
|| *************************************************************************

|PROCESO LosErrores;
 nSwInf = 1;
 |SI aParam = ""; |PRINT; |FINSI;
|FPRC;

|DEFBUCLE LosErrores;
 #111#1;
 ;
 #113#0, #113#1, #113#2, #113#3, #113#4, 01;
 #113#0, #113#1, #113#2, #113#3, #113#4, 99;
 ;
 NULL, LosErrores;
|FIN;

|PROCESO Repe;

 |SI #0#14 = "N"; |Y #0#18 = "S";
     |HAZ GrabaRegistro;
 |FINSI;

 nSwInf   = 0;
 nSwAlgun = 1;
 |SI aParam = ""; |PRINT; |FINSI;
 |BUCLE LosErrores;
 |SI nSwInf = 1;
     nSwInf = 2;
     |SI aParam = ""; |PRINT; |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE NoRepe;
 #113#1;
 ;
 #0#0, #0#1, aTipo, #0#10, 000001;
 #0#0, #0#1, aTipo, #0#11, 999999;
 ;
 NULL, Repe;
|FIN;

|PROCESO Imprimir;
 |BLIN 23;
 |ATRI R; |PINTA 2304, " Imprimiendo ...."; |ATRI 0;

 nConta0 = 0;

 |ABRE #110;
 |SI #0#19 ! "S";
     nSwAlgun = 0;
     aTipo = "R";
     aTitulo = "FACTURAS DE REPERCUTIDO ";
     |BUCLE NoRepe;
     |SI nSwAlgun = 1; |Y aParam = "";   |PIEINF;  |FINSI;
 |FINSI;

 |SI #0#19 ! "R";
     nSwAlgun = 0;
     aTipo = "S";
     aTitulo = "FACTURAS DE SOPORTADO ";
     |BUCLE NoRepe;
     |SI nSwAlgun = 1;  |Y aParam = "";  |PIEINF;  |FINSI;
 |FINSI;

 |CIERRA #110;
|FPRC;

|| *************************************************************************
|| *************************************************************************
|| -----Crear Registro de Diferencias
|PROCESO Borra111;
 |BORRA 020#111a;
 |LIBERA #111;
|FPRC;

|DEFBUCLE Borra111;
 #111#1;
 ;
 #0#0, #0#1, aDTipo, #0#10, 000001, 00;
 #0#0, #0#1, aHTipo, #0#11, 999999, 99;
 be;
 NULL, Borra111;
|FIN;

|PROCESO Borra113;
 |BORRA 020#113a;
 |LIBERA #113;
|FPRC;

|DEFBUCLE Borra113;
 #113#1;
 ;
 #0#0, #0#1, aDTipo, #0#10, 000001;
 #0#0, #0#1, aHTipo, #0#11, 999999;
 be;
 NULL, Borra113;
|FIN;

|PROCESO Borra110;
 |BORRA 020#110a;
 |LIBERA #110;
|FPRC;

|DEFBUCLE Borra110;
 #110#1;
 ;
 #0#0, #0#1, nDTipoDif, #0#10;
 #0#0, #0#1, nHTipoDif, #0#11;
 be;
 NULL, Borra110;
|FIN;

|PROCESO GrRegistro_110;
 |ABRE #110;
 #110#0  = #0#0;
 #110#1  = #0#1;
 #110#11 = nTipoDif;
 #110#13 = nLibro1;
 |LEE 001#110=;
 |SI FSalida ! 0;
     |DDEFECTO #110;
     |PARA nPara1 = 0; |SI nPara1 [ 9; |HACIENDO nPara1 = nPara1 + 1;
           #110nPara1 = #0nPara1;
     |SIGUE;
     #110#10 = #0#17;
     #110#11 = nTipoDif;
     |SI nTipoDif = 2; #110#12 = "Fras. Venta"; |FINSI;
     |SI nTipoDif = 3; #110#12 = "Fras. Compra"; |FINSI;
     #110#13 = nLibro1;
     |GRABA 020#110b;
 |FINSI;

 #110#14 = #110#14 + nBase1;
 #110#15 = #110#15 + nTotal1;
 #110#16 = #110#16 + nCuota1;
 #110#17 = #110#17 + nReten1;
 #110#19 = #110#19 + nBase2;
 #110#20 = #110#20 + nTotal2;
 #110#21 = #110#21 + nCuota2;
 #110#22 = #110#22 + nReten2;
 |GRABA 020#110a;
 |LIBERA #110;
 |CIERRA #110;
|FPRC;

|PROCESO GrabaRegistro;
 #110#0  = #0#0;
 #110#1  = #0#1;
 |SI #113#2 = "R";
     #110#11 = 2;
 |SINO;
     #110#11 = 3;
 |FINSI;
 #110#13 = #113#3;
 |LEE 001#110=;
 |SI FSalida = 0;
     #110#24 = "X";
     |GRABA 020#110a;
 |FINSI;
 |LIBERA #110;
|FPRC;

|| *************************************************************************
|| *************************************************************************
|| *************************************************************************
|CALCULO ElInforme; |TIPO 3;

  aMonedaA = #0#4;
  aMonedaC = #0#9;

  |DBASE aDirBase; |QBF aDirBase;
  aPathFic0 = aDirBase + "fich/";  ||ficheros de esta aplicacion

  aDirBase  = #0#17; |QBF aDirBase;
  aPathDef  = aDirBase + "def/";
  aPathFic1 = aDirBase + "fich/";


  nSwError = 0;
  aDef11 = aPathDef + "caivarep";
  |CARGA_DEF aDef11, caivare@;
  |SI FSalida ! 0;
      aMensa = "0000Error en:" + aDef11;
      aDef11 = "";
      nSwError = 1;
  |SINO;
      aDef12 = aPathDef + "caivasop";
      |CARGA_DEF aDef12, caivaso@;
      |SI FSalida ! 0;
          aMensa = "0000Error en:" + aDef12;
          aDef12 = "";
          nSwError = 1;
      |FINSI;
  |FINSI;
  |SI nSwError = 1;
      aMensa = aMensa + ". Proceso Abortado";
      |MENAV aMensa;
      |HAZ DesCargaDef;
      |ACABA;
  |FINSI;

  aQueQuiero = "|NC";
  aNumCampos = #caivare@#aQueQuiero#;
  nNCamRep  = aNumCampos;
  aNumCampos = #caivaso@#aQueQuiero#;
  nNCamSop  = aNumCampos;

  aAlfa1 = #0#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
  aAlfa2 = #0#1; |QBF aAlfa2; aAlfa2 = ("0" + aAlfa2) % -101;
  aDFicEm1 = aPathFic0 + aAlfa1 + aAlfa2 + "/";

  aAlfa1 = #0#5; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
  aAlfa2 = #0#6; |QBF aAlfa2; aAlfa2 = ("0" + aAlfa2) % -101;
  aDFicEm2 = aPathFic1 + aAlfa1 + aAlfa2 + "/";

  |PATH_DAT #1 aDFicEm1;
  |PATH_DAT #2 aDFicEm1;
  |PATH_DAT #3 aDFicEm1;

  |PATH_DAT #11 aDFicEm2;
  |PATH_DAT #12 aDFicEm2;


  |SI aParam = "";
    |IMPRE 0;
    |SI FSalida ! 0;
        |HAZ DesCargaDef;
        |ACABA;
    |FINSI;
  |FINSI;

  informe = inform1;
  |SI #0#14 = "S";
      informe = inform2;
  |FINSI;

  |SI aParam = "";
    |INFOR informe;
    |SI FSalida ! 0;
        |HAZ DesCargaDef;
        |FINIMP;
        |ACABA;
    |FINSI;
  |FINSI;

  |SI #0#3 > 80;
      enEjercicio = 1900 + #0#3;
  |SINO;
      enEjercicio = 2000 + #0#3;
  |FINSI;

  nDTipoDif = 2; nHTipoDif = 3;
  |SI #0#19 = "A";
      aDTipo = "R"; aHTipo = "S";
      nDTipoDif = 2; nHTipoDif = 3;
  |SINO;
      aDTipo = #0#19; aHTipo = #0#19;
      |SI #0#19 = "R"; nDTipoDif = 2; |FINSI;
      |SI #0#19 = "S"; nDTipoDif = 3; |FINSI;
      nHTipoDif = nDTipoDif;
  |FINSI;

  |SI #0#18 = "S";   || Crear el Registro de Diferencias
      |BUCLE Borra110;
      |BUCLE Borra111;
      |BUCLE Borra113;
  |FINSI;

  aFichero = ("13w" + Usuario) % 108;
  |NOME_DAT #913 aFichero;
  |DELINDEX #913;

  |ATRI R; |PINTA 2304, "Creando temporal. Espere ... "; |ATRI 0;
  |ATRI I; |PINTA 2334, "Facturas Empresa 1: "; |ATRI 0;

  nConta0 = 0;
  nConta1 = 0;
  nConta2 = 0;

  |ABRE #111;
  |ABRE #113;
  |ABRE #913;
  |BUCLE CreaAuxi1;   || Lee Empresa Uno
  |CIERRA #113;
  |SI #0#14 = "N";
      |ATRI I; |PINTA 2334, "Factura Empresa 2: "; |ATRI 0;
      |HAZ CreaAuxi2;   || Lee Empresa Dos
  |FINSI;
  |CIERRA #913;
  |CIERRA #111;

  |SI nConta1 ! 0; |O nConta2 ! 0;
      |HAZ Imprimir;
  |FINSI;

  |SI aParam = "";
      |FININF;
      |FINIMP;
  |FINSI;

  |DELINDEX #913;
  |HAZ DesCargaDef;
|FCAL;

|| ***********************************************************************

|PROGRAMA;
     |DBASS aDirInicio; |QBF aDirInicio;
     aDirBase = aDirInicio + "basica/fich/";
     |PATH_DAT #100 aDirBase;
     |ABRE #100;
     |LEE 040#100p;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0 = aDirInicio;
     |FINSI;
     |CIERRA #100;

   Comodin = PARAMETRO; |QBF Comodin;
   |SI Comodin ! "";
       aParam = Comodin; |SI eaPreg22_5 = "S"; aParam = ""; |FINSI;
       cod1 = enEmpresa;
       cod2 = enPeriodo;
       emEmp = 1;  || Sin mensaje
       |HAZ leelo;
       |SI swerror ! 0;  |ACABA;   |FINSI;

       Comodin1 = Comodin % -101;
       |SI Comodin1 ! "/";
           Comodin = Comodin + "/agicont/";
       |SINO;
           Comodin = Comodin + "agicont/";
       |FINSI;

       |DDEFECTO #0;
       #0#17 = Comodin;

       #0#0 = enEmpresa;
       #0#1 = enPeriodo;
       #0#2 = eaNombreEmp;
       #0#3 = #30#26;
       #0#4 = eaMoneda;

       #0#5 = enEmpresaV;
       #0#6 = enPeriodoV;
       #0#7 = eaNombreEmp;
       #0#8 = #30#26;
       #0#9 = eaMonedaV;
       #0#12 = fec1;
       #0#13 = fec2;
       #0#15 = "INFORME DE DIFERENCIAS EN LIBROS DE IRPF ";
       |HAZ ElInforme;
    |SINO;
        |CLS;
        |MANTE #0;
    |FINSI;
|FPRO;
|| **************************************************************************
|PROCESO CamRep;
  impMoneda = #11#8;  |HAZ ElCambioMoneda; #11#8 = impMoneda;
  impMoneda = #11#9;  |HAZ ElCambioMoneda; #11#9 = impMoneda;
  impMoneda = #11#10; |HAZ ElCambioMoneda; #11#10 = impMoneda;
  impMoneda = #11#52; |HAZ ElCambioMoneda; #11#52 = impMoneda;
  impMoneda = #11#53; |HAZ ElCambioMoneda; #11#53 = impMoneda;

  impMoneda = #11#14; |HAZ ElCambioMoneda; #11#14 = impMoneda;
  impMoneda = #11#15; |HAZ ElCambioMoneda; #11#15 = impMoneda;
  impMoneda = #11#16; |HAZ ElCambioMoneda; #11#16 = impMoneda;
  impMoneda = #11#56; |HAZ ElCambioMoneda; #11#56 = impMoneda;
  impMoneda = #11#57; |HAZ ElCambioMoneda; #11#57 = impMoneda;

  impMoneda = #11#20; |HAZ ElCambioMoneda; #11#20 = impMoneda;
  impMoneda = #11#21; |HAZ ElCambioMoneda; #11#21 = impMoneda;
  impMoneda = #11#22; |HAZ ElCambioMoneda; #11#22 = impMoneda;
  impMoneda = #11#60; |HAZ ElCambioMoneda; #11#60 = impMoneda;
  impMoneda = #11#61; |HAZ ElCambioMoneda; #11#61 = impMoneda;

  impMoneda = #11#26; |HAZ ElCambioMoneda; #11#26 = impMoneda;

  |SI nNCamRep = 66;
      impMoneda = #11#65; |HAZ ElCambioMoneda; #11#65 = impMoneda;
      impMoneda = #11#63; |HAZ ElCambioMoneda; #11#63 = impMoneda;
  |FINSI;
|FPRC;

|PROCESO CamSop;
  impMoneda = #12#8;  |HAZ ElCambioMoneda; #12#8 = impMoneda;
  impMoneda = #12#9;  |HAZ ElCambioMoneda; #12#9 = impMoneda;
  impMoneda = #12#10; |HAZ ElCambioMoneda; #12#10 = impMoneda;
  impMoneda = #12#52; |HAZ ElCambioMoneda; #12#52 = impMoneda;
  impMoneda = #12#53; |HAZ ElCambioMoneda; #12#53 = impMoneda;

  impMoneda = #12#14; |HAZ ElCambioMoneda; #12#14 = impMoneda;
  impMoneda = #12#15; |HAZ ElCambioMoneda; #12#15 = impMoneda;
  impMoneda = #12#16; |HAZ ElCambioMoneda; #12#16 = impMoneda;
  impMoneda = #12#56; |HAZ ElCambioMoneda; #12#56 = impMoneda;
  impMoneda = #12#57; |HAZ ElCambioMoneda; #12#57 = impMoneda;

  impMoneda = #12#20; |HAZ ElCambioMoneda; #12#20 = impMoneda;
  impMoneda = #12#21; |HAZ ElCambioMoneda; #12#21 = impMoneda;
  impMoneda = #12#22; |HAZ ElCambioMoneda; #12#22 = impMoneda;
  impMoneda = #12#60; |HAZ ElCambioMoneda; #12#60 = impMoneda;
  impMoneda = #12#61; |HAZ ElCambioMoneda; #12#61 = impMoneda;

  impMoneda = #12#26; |HAZ ElCambioMoneda; #12#26 = impMoneda;

  |SI nNCamRep = 66;
      impMoneda = #12#65; |HAZ ElCambioMoneda; #12#65 = impMoneda;
      impMoneda = #12#63; |HAZ ElCambioMoneda; #12#63 = impMoneda;
  |FINSI;
|FPRC;
