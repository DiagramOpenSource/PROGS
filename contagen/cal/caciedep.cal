|FICHEROS;
   caciedep #0;
   camaasil #1;    || apuntes lins.
   camaasic #2;    || apuntes cabs.
   catracde #4;    || trabajo cierre
   cacuedep #11;   || Cuentas por departamentos

   :/modelos/def/dsmom030 #7;    || conceptos
   :/basica/def/agicen14 #114;

   caexistc #22;   || Cabeceras de Existencias
   canempre #30;
   caconasi #20;

   existen@ #89;  || Existencias
   cacambiw #90;

   ca8ctrle #400;
   ca8comay #401;
   ca8m0003 #403;
   ca8m0004 #404;
   ca8m0002 #422;
   ca8cumay #410;

   caw00011 #65;
|FIN;

|VARIABLES;
    &entrada = 1;

    &eSwSelec  = 1;
    &eaDDepar  = "";
    &eaHDepar  = "";
    &efDFecha  = @;
    &efHFecha  = @;
    &efBFecha  = @;
    &eaNomFDep = "";  ||Nombre del Fichero Creado

   VAlfa1 = "";
   VAlfa2 = "";
   VAlfa3 = "";
   VAlfa4 = "";
   VAlfa5 = "";
   swexis = 0;

   nNume = 0;
   aAlfa = "";
   alfa1 = "";
   alfa2 = "";
   alfa3 = "";
   alfa5 = "";
   nume1 = 0;
   nume2 = 0;
   nume3 = 0;
   nume4 = 0;
   nume5 = 0;
   nLong = 0;
   aLong = "";
   a_nivels = 0;
   d_nivels = 0;

   pp = 0;
   cam = 0;
   linea = 0;
   avisillo = "";
   cuenta = "";
   cuen = "";
   xxxxfiac = "  ";
   xxaponer = "  ";
   xrelleno = "                              ";
   fecalf = "";
   men2   = "    NO EXISTE CONCEPTO AUTOMATICO";
   mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
   mensa2 = "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";

   desde = "            ";
   hasta = "zzzzzzzzzzzz";
   fich = "";
   no_sigas = 0;
   cierre = "";
   apertu = "";
   FEstado = 0;
   nPOrigen = 0;

   nImpExA = 0;
   nImpEx  = 0;

   nCamp0 = 0;
   aCamp1 = "";
   aCamp2 = "";
   nCamp3 = 0;


   nSaldo = 0;
   nDDep = 0;
   nHDep = 0;
   aElDepar = "";
   aElDep   = "";
   aElSub   = "";

   &r_emp = 0;
   &r_per = 0;

   aCtaPer = "";
   nCtaPer = 0;

   fAfec1 = @;
   fAfec2 = @;
   fAfec3 = @;
   nEjer  = 0;
   &num_per     = 0;
   &enPerioOri  = 0;
   nEjerActual = 0;
   nSw116      = 0;
   aAlfa1      = "";
   aAlfa2      = "";
   aCtazzz     = "";
   nSw         = 0;
   debe        = 0;
   haber       = 0;
   nCta        = 0;
   aCta        = "";
   aCtaN       = "";
   fFecha      = @;

   nError      = 0;
   aFichero    = "";
   nNumero     = 0;
   nDebe       = 0;
   nHaber      = 0;
   nMovim      = 0;
   nMoviE      = 0;
   nMoviI      = 0;
   nMoviB      = 0;
   nAlgun      = 0;
   &eaPathO  = "";
   &eaPathI  = "";
   &enPeriodoO = 0;
   &enPeriodoD = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE copian_i;
|INCLUYE copia1_i;
|INCLUYE defec1_i;


|CALCULO BuscaDoc; |TIPO 0;
   |ABRE #2;
   |SELECT #3#2;
   |LEE 010#2u;
   |SI FSalida = 0;
      #0#3 = #2#2 + 1;
      #0#4 = #2#2 + 1;
   |SINO;
      #0#3 = 1;
      #0#4 = 1;
   |FINSI;
   |SELECT #1#2;
   |CIERRA #2;
|FCAL;

|PROGRAMA;
   |CLS;
   |CABEZA "Cierre Ejercicio";
   |PINPA #0#0;
   |DDEFECTO #0;
   |HAZ BuscaDoc;

   |PINDA #0#0;

   |HAZ DirAplicSt;
   |HAZ eLeeParametro;

   |HAZ apertu;
   |HAZ leeempre;
   |SI no_sigas = 1;  |ACABA;  |FINSI;
   |SI no_sigas = 2;
       |C_M #0#22,1,"N"; #0#22 = "N"; |PINTA #0#22;

       |C_M #0#5,1,"N"; |C_M #0#6,1,"N";
       |C_M #0#7,1,"N"; |C_M #0#8,1,"N";
       |C_M #0#9,1,"N";
       |C_M #0#14,1,"N"; |C_M #0#16,1,"N";
       |C_M #0#27,1,"N";
   |FINSI;
   |ENDATOS #1#0;
   |SI FSalida = 0;
       |HAZ cierre;
       |SI #0#22 = "N"; |ACABA; |FINSI;
       |SI nError ! 0;  |ACABA; |FINSI;

       |HAZ apertura;
       |HAZ copiaantes;
   |FINSI;
|FPRO;

|PROCESO apertu;         || calcula el periodo de la empresa nueva
   enNoBloq = 1;
   |HAZ inicio;
   enNoBloq = 0;

   efDFecha  = fec1;
   efHFecha  = fec2;
   efBFecha  = fec3;
   nEjer     = enEjercicio;
   enPeriodoO = enPeriodo;

   |DFICE eaPathI;

   num_por1 = #canempre#2; any_por1 = #canempre#26; || Datos para la Portada

   cierre = #canempre#0;  cierre = "000000" + cierre;  cierre = cierre % -106;
   cod2 = #canempre#3;
   nPOrigen = cod2;
   #0#10 = cod1;
   #0#11 = cod2 + 1;
   |SI #0#11 = 10;  #0#11 = 0;  |FINSI;
   |PINTA #0#10;
   |PINTA #0#11;
   #0#0 = fec2;
   #0#5 = #0#0 + 1;
   |PINTA #0#0;
   |PINTA #0#5;
   aMonedaC = eaMoneda;
   #0#21 = eNum2008; |PINTA #0#21;

   #90#0 = #canempre#13;   || Digitos Actuales
   #90#1 = #canempre#14;
   #90#2 = #canempre#15;
   #90#3 = #canempre#16;
   #90#4 = #canempre#17;
   #90#5 = #canempre#18;
   #90#6 = #canempre#19;

   |C_M #0#11, 1, "S";
   |ET PedirCampo;
   |ENCAMPO #11#0;
   |SI #0#11 = cod2;
       |MENAV "    ERROR. El Periodo introducido es el Actual ";
       |VETE PedirCampo;
   |FINSI;
   |C_M #0#11, 1, "N";
   enPeriodoD = #0#11;

   nEjerActual = enEjercicio + 1;
   eSwC2008    = 0;
   |SI nEjerActual ] 2008; |Y enEjercicio < 2008;  eSwC2008 = 1; |FINSI;

   |SI nEjerActual ] 2008; |HAZ LeoTabla; |FINSI;

   |C_M #0#25,1,"N";
   |SI eSwC2008 = 1; |C_M #0#25, 1, "S"; |FINSI;
   |ENCAMPO #25#0; |C_M #0#25,1,"N";
|FPRC;

|PROCESO LeoTabla;
     |ABRE #400;
     |DDEFECTO #400;
     #400#0 = enEmpresa;
     #400#1 = enPeriodo;
     |LEE 001#400=;
     |SI FSalida = 0;
         #0#25 = #400#2; |PINTA #0#25;
     |SINO;
         #400#0 = #0#10;
         #400#1 = #0#11;
         |LEE 001#400=;
         |SI FSalida = 0;
             #0#25 = #400#2; |PINTA #0#25;
         |FINSI;
     |FINSI;
     |CIERRA #400;
|FPRC;

|PROCESO leeempre;       || lee la empresa

   cod1 = #0#10;
   cod2 = #0#11;
   swOperacion = 0;
   emEmp = 1;
   |HAZ leelo;
   |SI swerror = 1;
       swOperacion = 3;
       |HAZ creacion;
       |SI no_sigas = 1; |ACABA; |FINSI;
   |FINSI;
   |BLIN 23;
   |BLIN 24;
   apertu = #canempre#0;  apertu = "000000" + apertu;  apertu = apertu % -106;
   #0#12 = #canempre#1;
   |PINTA #0#12;
   aMonedaA = #canempre#28;

   #90#10 = #canempre#13;   || Digitos Destino
   #90#11 = #canempre#14;
   #90#12 = #canempre#15;
   #90#13 = #canempre#16;
   #90#14 = #canempre#17;
   #90#15 = #canempre#18;
   #90#16 = #canempre#19;

   fAfec1 = fec1;
   fAfec2 = fec2;
   fAfec3 = fec3;
   fec1   = efDFecha;
   fec2   = efHFecha;
   fec3   = efBFecha;
   enEjercicio = nEjer;

   |SI dig3 = 1; nume1 = dig4 + 100; |FINSI;
   |SI dig3 = 2; nume1 = dig5 + 100; |FINSI;
   |SI dig3 = 3; nume1 = dig6 + 100; |FINSI;
   |SI dig3 = 4; nume1 = dig7 + 100; |FINSI;
   |SI dig3 = 5; nume1 = dig8 + 100; |FINSI;
   |SI dig3 = 6; nume1 = dig9 + 100; |FINSI;
   aCta  = ("11600000000000" % nume1);
   aCtaN = "AJUSTES";
   nCta  = dig3;
|FPRC;

*****************************************************************************
CALCULOS DESDE CAMPOS
*****************************************************************************
|PROCESO QueHago; |TIPO 0;
 alfa1 = #0#22;
 |C_M #0#5,1,alfa1;  |C_M #0#6,1,alfa1;
 |C_M #0#7,1,alfa1;  |C_M #0#8,1,alfa1;
 |C_M #0#9,1,alfa1;
 |C_M #0#14,1,alfa1; |C_M #0#16,1,alfa1;
 |C_M #0#25,1,alfa1; |C_M #0#27,1,alfa1;
|FPRC;

|PROCESO entrada; |TIPO 0;         || desde campo 'fecha de cierre'
   |HAZ contador;
   #0#3 = #caconasi#1;
   #0#4 = #0#3;
   |PINTA #0#3;
   |PINTA #0#4;
|FPRC;

|PROCESO repite; |TIPO 0;          || desde campo 'documento'
   pp = Campo + 1;
   #0pp = #0Campo;
   |PINTA #0pp;
|FPRC;

|PROCESO concepto; |TIPO 0;        || desde campo 'concepto'
   |ABRE #7;
   #dsmom030#0 = #0Campo;
   |LEE 001#7=;
   |SI FSalida ! 0;
      |MENAV men2;
      |DDEFECTO #7;
      |CIERRA #7;
      |ERROR;
      |ACABA;
   |FINSI;
   |SI #dsmom030#8 ! "S";
       |MENAV "    El concepto no corresponde al Tipo de Apunte";
       |ERROR;
   |FINSI;
   pp = Campo + 1;
   #0pp = #dsmom030#1;
   |PINTA #0pp;
   |CIERRA #7;
|FPRC;

|PROCESO final; |TIPO 7;
   |SI eaSobreEs ! "S";
       |PTEC 816;
   |FINSI;
|FPRC;

|CALCULO sipuedo; |TIPO 7;
  a_nivels = #90#0;       ||Origen
  d_nivels = #90#10 + 10; ||Destino
  |SI #90#0 ! #90#10; |O #90a_nivels ! #90d_nivels;
      #0#16 = "N"; |PINTA #0#16;
      |PTEC 802;
  |FINSI;
|FCAL;

|CALCULO pintames; |TIPO 0;
  |SI #0#18 ! 0; |Y #0#18 ! 13;
      NumMes = dig1 + (#0#18 - 1);   || Operacion para saber que mes es
      |SI NumMes > 12; NumMes = NumMes - 12; |FINSI;
  |SINO;
      NumMes = #0#18;
  |FINSI;
  |HAZ NombreMes;
  #0#19 = NombreMes; |PINTA #0#19;
|FCAL;

|CALCULO PorqueDep;
  |SI #0#20 = "N";
      |C_M #0#21,1,"N"; #0#21 = "N"; |PINTA #0#21;
      |C_M #0#23,1,"N"; #0#23 = "  "; |PINTA #0#23;
      |C_M #0#24,1,"N"; #0#24 = "zz"; |PINTA #0#24;
      |C_M #0#13,1,"S";
      |C_M #0#17,1,"S";
  |SINO;
      |C_M #0#21,1,"S";
      |C_M #0#23,1,"S";
      |C_M #0#24,1,"S";
  |FINSI;
|FCAL;

|CALCULO AntesDepar; |TIPO 7;
   |C_M #0Campo, 0, alfa1;
   |SI alfa1 = "S"
      |SI Haybasica = 1;
          |MENSA "    <F2> Consultar Actividades";
      |SINO;
          |MENSA "    <F2> Consultar Departamentos";
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO LosDep; |TIPO 0;
 |C_M #0Campo,0,alfa1;

 |SI alfa1 = "N"; |ACABA; |FINSI;

 |SI eaDepar = "S";
      eOpDep = 0; || 1 = Consulta pantalla
     |SI FSalida = 10; eOpDep = 1;  |FINSI;
     enActividad = #0Campo;
     eaCodDep    = #0Campo;
     |HAZ Actividad;
     alfa1 = enActividad;
     |SI Haybasica = 1;
         alfa1 = ("00" + alfa1) % A02;
     |FINSI;
     #0Campo = eaCodDep;  |PINTA #0Campo;
 |FINSI;

 |SI Campo = 23; #0#13 = #0#23; |PINTA #0#13; |C_M #0#13,1,"N"; |FINSI;
 |SI Campo = 24; #0#17 = #0#24; |PINTA #0#17; |C_M #0#17,1,"N"; |FINSI;
|FCAL;

|PROCESO LeeDescarga;
  aAlfa = aElDepar; |SI #0#20 = "N"; aAlfa = aElDep; |FINSI;
  |ABRE #22;
  #22#0 = aAlfa;
  |LEE 041#22=;
  aCtaPer = #22#2;
  nCtaPer = #22#3;
  |CIERRA #22;
|FPRC;


|PROCESO fecha; | TIPO 0;   || Desde/hasta fecha
  |C_M #0Campo,0,alfa1;

  |SI Campo = 0;
      |SI #0Campo < fec1; |O #0Campo > fec2;
          |MENAV mensa1;
          |ERROR;
      |SINO;
          |SI #0Campo [ fec3;
              |MENAV mensa2;
              |ERROR;
          |FINSI;
      |FINSI;
  |FINSI;
  |SI Campo = 5; |Y alfa1 = "S";
      |SI #0Campo < fAfec1; |O #0Campo > fAfec2;
          |MENAV mensa1;
          |ERROR;
      |SINO;
          |SI #0Campo [ fAfec3;
              |MENAV mensa2;
              |ERROR;
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO CodCta7; |TIPO 7;
  || |SI nEjerActual < 2008;
  ||     #0#25 = 0; |PINTA #0#25;
  ||     |ACABA;
  || |FINSI;
  || |HAZ LeoTabla;
|FPRC;

|PROCESO CodCta0; |TIPO 6;
||  |C_M #0#25, 0, alfa1;
||  |SI alfa1 = "N"; |ACABA; |FINSI;

  |ABRE #401;
  #401#0 = #0#25;
  |LEE 001#401=;
  |SI FSalida ! 0;
      |MENAV "    Error, no existe Codigo de Cuentas de Mayor";
      |ERROR;
  |SINO;
      |C_A #401#1,1,33; |PINTA 1041, #401#1;
  |FINSI;
  |CIERRA #401;
|FPRC;

*****************************************************************************
CALCULOS DE CIERRE
*****************************************************************************

|PROCESO buscalibre;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 9999;
   |LEE 001#1];
   |SI FSalida ! 0;
      |LEE 001#1u;
   |SINO;
      |LEE 001#1a;
   |FINSI;
   |SI FSalida ! 0;
       linea = 1;
   |SINO;
      |SI #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
          linea = #camaasil#3 + 1;
      |SINO;
          linea = 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO grabadia;

   |SI nSaldo = 0; |ACABA; |FINSI;

   |SI cam = 0;
       cam = 1;
       #camaasic#0 = 99;
       #camaasic#1 = #0#0;
       #camaasic#2 = #0#3;
       |LIBERA #2;
       |LEE 101#2=;
       |SI FSalida ! 0;
           |DDEFECTO #2;
           #camaasic#0 = 99;
           #camaasic#1 = #0#0;
           #camaasic#2 = #0#3;
           #camaasic#3 = #0#3;
           #camaasic#12 = nREGISTRO;
           |HAZ LeeDescarga;
           #camaasic#08 = aCtaPer; #camaasic#09 = nCtaPer;
           #camaasic#10 = aCtaPer; #camaasic#11 = nCtaPer;
           |GRABA 020#2b;
      |FINSI;
      |HAZ buscalibre;
   |FINSI;

   |DDEFECTO #camaasil;

   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = linea;
   #camaasil#4 = #cacuenta#0;
   #camaasil#5 = #cacuenta#1;
   #camaasil#6 = #0#1;
   #camaasil#7 = #0#2;
   |SI nSaldo [ 0;
      #camaasil#8 = "D";
      #camaasil#9 = -nSaldo;
   |SINO;
      #camaasil#8 = "H";
      #camaasil#9 = nSaldo;
   |FINSI;
   |SI #camaasil#8 = "D";
      #camaasil#16 = #camaasil#4;
      #camaasil#17 = #camaasil#5;
      #camaasil#10 = "";
      #camaasil#11 = 0;
   |SINO;
      #camaasil#16 = "";
      #camaasil#17 = 0;
      #camaasil#10 = #camaasil#4;
      #camaasil#11 = #camaasil#5;
   |FINSI;
   #camaasil#21 = aElDepar; |SI #0#20 = "N"; #camaasil#21 = aElDep; |FINSI;
   #camaasil#28 = aElSub;
   #camaasil#24 = nREGISTRO;

   |GRABA 020#1n;
   linea = linea + 1;
   MasMenos     = #camaasil#9;
   DebeHaber    = #camaasil#8;
   aCUENTA      = #camaasil#4;
   nREGISTRO    = #camaasil#24;
   nDIARIO      = #camaasil#0;
   aFECHA       = #camaasil#1;
   nDOCUMENTO   = #camaasil#2;
   nNIVELCUENTA = #camaasil#5;
   |HAZ ActDiario;          || diario
   |HAZ ActCuenta;

   |SI #camaasil#8 = "D";
       #camaasic#4 = #camaasic#4 + #camaasil#9;
   |SINO;
       #camaasic#5 = #camaasic#5 + #camaasil#9;
   |FINSI;
   #camaasic#6 = #camaasic#4 - #camaasic#5;
   |GRABA 020#2a;
|FPRC;


|| -------------------------------------------------------------------------
|PROCESO grabacion;
   #catracde#0 = #cacuenta#0;
   #catracde#1 = #cacuenta#1;
   #catracde#2 = #cacuenta#58;
   |SI nSaldo [ 0;
      #catracde#3 = "H";
      #catracde#4 = - nSaldo;
   |SINO;
      #catracde#3 = "D";
      #catracde#4 = nSaldo;
   |FINSI;
   #catracde#5 = #cacuenta#2;
   #catracde#6 = #cacuenta#3;
   #catracde#7 = #cacuenta#4;
   #catracde#8 = #cacuenta#5;
   #catracde#9 = #cacuenta#6;
   #catracde#10 = #cacuenta#7;
   #catracde#11 = #cacuenta#8;
   #catracde#12 = #cacuenta#54;
   #catracde#13 = #cacuenta#55;
   #catracde#18 = aElDepar;

   |HAZ carganuevas;    ||campos 14/15  16/17
   |GRABA 020#4n;
|FPRC;

|PROCESO VerCueDep0;
   aElDepar = #11#57;
   nSaldo   = #11#53;
   |HAZ grabacion;
|| ..    |SI #0#21 = "N";  ||Por ahora no separar apuntes
||        |HAZ grabadia;
|| ..   |FINSI;
|FPRC;

|DEFBUCLE VerCueDep;
 #11#1;
 ;
 #6#0, "  ";
 #6#0, "zz";
 e;
 NULL, VerCueDep0;
|FIN;

|PROCESO aceroplan;
   avisillo = "2301 Asiento de Cierre, Tratando: " + #cacuenta#0;
   |MENSA avisillo;

   |SI #cacuenta#3 = "S";
       |SI #0#20 = "S";
           |BUCLE VerCueDep;
       |SINO;
           aElDepar = "  ";
           nSaldo   = #cacuenta#53;
           |HAZ grabacion;
           |HAZ grabadia;
       |FINSI;
   |SINO;
       aElDepar = "  ";
       nSaldo   = #cacuenta#53;
       |HAZ grabacion;
   |FINSI;
||   |HAZ acerar;
   |LIBERA #6;
|FPRC;

|DEFBUCLE cacierre0;
   #6#1;
   3;
   desde, "S";
   hasta, "S";
   be;
   NULL, aceroplan;
|FIN;


|| ***************************
|PROCESO cacierreE;
 nSaldo = #4#4;
 |SI nSaldo = 0; |ACABA; |FINSI;
 aElDepar = #4#18;
 |SI #catracde#3 = "H";
      nSaldo = -nSaldo;
 |FINSI;

 |DDEFECTO #cacuenta;
 #cacuenta#0 = #4#0;
 |LEE 001#cacuenta.=;
 |HAZ grabadia;
|FPRC;

|DEFBUCLE cacierreE;
   #4#2;
   6;
   "  ", desde, "S";
   "zz", hasta, "S";
   e;
   NULL, cacierreE;
|FIN;
||****************************

|PROCESO cierre;
  eaMoneda = aMonedaC;
  |HAZ Monedas;       ||Carga Variables Moneda

  |DBASE dir_fich;
  dir_fich = dir_fich + "fich/" + cierre + "/";

  |DDEF VAlfa4; |QBF VAlfa4;
  VAlfa4 = VAlfa4   + "caexistc";   || Cabecera del Cierre
  VAlfa5 = dir_fich + "caexistc";

  |PATH_DAT #camaasil #dir_fich#;
  |PATH_DAT #camaasic #dir_fich#;
  |PATH_DAT #cacuenta #dir_fich#;
  |PATH_DAT #catracde #dir_fich#;
  |PATH_DAT #camandia #dir_fich#;
  |PATH_DAT #caexistl #dir_fich#;

  aElDep = eaDfDepC; |SI eaDepar = "N"; aElDep = "01"; |FINSI;
  aElSub = eaDfSubC; |SI eaSubde = "N"; aElSub = ""; |FINSI;
  |DELINDEX #4;

  |HAZ TesteoCierre;
  |SI nError ! 0; |ACABA; |FINSI;

  eSwSelec  = 1;
  eaDDepar  = #0#23;  eaHDepar  = #0#24;

  |SI #0#20 = "S";
      |ATRI I;
      |PINTA 2302, "Procesando Cuentas por Departamentos ... Espere ";
      |ATRI 0;
      |SUB_EJECUTA_NP "cacuedep";
      |PINTA 2302, "                                                ";
      |NOME_DAT #11 eaNomFDep;
  |FINSI;


  |ABRE #1;
  |ABRE #2;
  |ABRE #4;
  |ABRE #18;
  cam = 0;
  |BUCLE cacierre0;

  |SI #0#20 = "S";
      |ABRE #cacuenta;
      |CIERRA #4;
      |BUCLE cacierreE;
      |CIERRA #cacuenta;
      |ABRE #4;
  |FINSI;

  |CIERRA #1;
  |CIERRA #2;
  |CIERRA #4;
  |CIERRA #18;

   |SI #2#4 ! #2#5;
       |MENAV "    AVISO!!! Asiento de Cierre Descuadrado";
       |SI #0#26 = "S";
           |MENAV "    No se bloquean los datos Contables";
           #0#26 = "N";
       |FINSI;
   |FINSI;
   |SI #0#26 = "S";
       |ABRE #30;
       #30#2 = #0#10;
       #30#3 = nPOrigen;
       |LEE 141#30=;
       |SI FSalida =0;
           #30#34 = #0#0;  || fecha asiento de cierre
           |GRABA 020#30a;
       |FINSI;
       |LIBERA #30;
       |CIERRA #30;
   |FINSI;
|FPRC;
|| ***************************************************************
|PROCESO TesteoC;
  alfa1 = #cacuenta#0; |QBF alfa1;

  |SI alfa1 = "";
      |SI #cacuenta#53 ! 0; nMoviB = 1; |FINSI;
  |FINSI;

  |SI #cacuenta#3 ! "S"; |ACABA; |FINSI;

  alfa1 = alfa1 % 101;
  |SI alfa1 = "6"; |O alfa1 = "7";
      |SI #cacuenta#53 ! 0; nMoviE = 1; |FINSI;
  |FINSI;
  |SI alfa1 = "8"; |O alfa1 = "9";
      |SI #cacuenta#53 ! 0; nMoviI = 1; |FINSI;
  |FINSI;

  |SI #cacuenta#53 < 0;
      nDebe  = (nDebe - #cacuenta#53) ! EURODB;
      |SI alfa1 ! "6"; |Y alfa1 ! "7"; |Y alfa1 ! "8"; |Y alfa1 ! "9"; |Y alfa1 ! ""; nMovim = 1; |FINSI;
  |FINSI;
  |SI #cacuenta#53 > 0;
      nHaber = (nHaber + #cacuenta#53) ! EURODB;
      |SI alfa1 ! "6"; |Y alfa1 ! "7"; |Y alfa1 ! "8"; |Y alfa1 ! "9"; |Y alfa1 ! ""; nMovim = 1; |FINSI;
  |FINSI;
|FPRC;


|DEFBUCLE TesteoC;
   #6#1;
   ;
   desde;
   hasta;
   e;
   NULL, TesteoC;
|FIN;

|PROCESO Max65;
 #65#0 = 1;
|FPRC;

|PROCESO Min65;
 #65#0 = 999999;
|FPRC;

|PROCESO VerCtaP;
  nAlgun  = 1;
  nError  = 0;
  aCtaPer = #22#2;
  nCtaPer = #22#3;
  |QBF aCtaPer;
  |SI aCtaPer = "";
      nError = 7;
  |SINO;
      |ABRE #cacuenta;
      #cacuenta#0 = aCtaPer;
      |LEE 041#cacuenta.=;
      |SI FSalida ! 0;
          nError = 5;
      |FINSI;
      |CIERRA #cacuenta;
  |FINSI;
  |SI nError ! 0;
      |HAZ Error_Graba
  |FINSI;
|FPRC;

|DEFBUCLE VerCtaP;
 #22#1;
 ;
 nume1;
 nume2;
 ;
 NULL, VerCtaP;
|FIN;

|PROCESO VerCtaPer;
  nAlgun   = 0;
  nume1 = #0#23;
  nume2 = #0#24;
  |SI #0#20 = "N";
      nume1 = aElDep;
      nume2 = aElDep;
  |FINSI;
  |BUCLE VerCtaP;
  |SI nAlgun = 0;
      nError = 6;
      |HAZ Error_Graba
  |FINSI;
|FPRC;


|PROCESO TesteoCierre;
  aFichero = "w" + Usuario;
  |NOME_DAT #65 aFichero;
  |DELINDEX #65;
  |C_P #65#0, 1, 1110;
  |C_P #65#1, 1, 1117;
  |C_A #65#1, 1, 53;

  |ABRE #65;
  nNumero = 0;
  nError  = 0;
  |HAZ VerCtaPer;
  nDebe   = 0;
  nHaber  = 0;
  nMovim  = 0;
  nMoviE  = 0;
  nMoviI  = 0;
  nMoviB  = 0;
  |BUCLE TesteoC;
  |SI nMoviI ! 0;     nError = 8; |HAZ Error_Graba; |FINSI;
  |SI nMoviE ! 0;     nError = 1; |HAZ Error_Graba; |FINSI;
  |SI nMovim = 0;     nError = 2; |HAZ Error_Graba; |FINSI;
  |SI nMoviB ! 0;     nError = 3; |HAZ Error_Graba; |FINSI;
  |SI nDebe ! nHaber; nError = 4; |HAZ Error_Graba; |FINSI;
  |CIERRA #65;
  |SI nError ! 0;
      |HAZ ErrorCierre;
  |FINSI;
|FPRC;

|PROCESO Error_Graba;
  aAlfa1 = "";
  nNumero = nNumero + 1;
  #65#0 = nNumero;
  |SI nError = 1; aAlfa1= " HAY CUENTAS DE LOS GRUPOS 6 Y 7 CON SALDO"; |FINSI;
  |SI nError = 2; aAlfa1= " NO EXISTE MOVIMIENTOS DE LAS CUENTAS     "; |FINSI;
  |SI nError = 3; aAlfa1= " LA CUENTA CONTABLE EN BLANCO TIENE SALDO "; |FINSI;
  |SI nError = 4; aAlfa1= " EXISTE UN DESCUADRE EN EL BALANCE DE SUMAS Y SALDOS "; |FINSI;
  |SI nError = 5; aAlfa1= " NO EXISTE CUENTA DE PERDIDAS Y GANANCIAS (1290) "; |FINSI;
  |SI nError = 6; aAlfa1= " NO EXISTE DESCARGA DE EXISTENCIAS        "; |FINSI;
  |SI nError = 7; aAlfa1= " EN BLANCO CTA PERDIDAS Y GANANCIAS EN DESC.EXISTENCIAS"; |FINSI;
  |SI nError = 8; aAlfa1= " HAY CUENTAS DE LOS GRUPOS 8 Y 9 CON SALDO"; |FINSI;
  #65#1 = aAlfa1;
  |GRABA 020#65n;
|FPRC;

|PROCESO ErrorCierre;
      |SI nNumero = 1; |Y nError = 4;
          |CONFI "    NHay un descuadre en el Balance de Sumas y Saldos. Desea continuar. ";
          |SI FSalida = 0; nError = 0; |FINSI;
          |ACABA;
      |FINSI;

      |PUSHV 0809 2270;
      |PINTA 1110, "                                                             ";
      |PINTA 1210, "                                                             ";
      |PINTA 1310, "                                                             ";
      |PINTA 1410, "                                                             ";
      |PINTA 1510, "                                                             ";
      |ATRI R;
      |PINTA 0910, " ATENCION: NO SE VA A REALIZAR EL CIERRE, HAY ERRORES        ";
      |PINTA 1010, " ==========================================================  ";
      |ATRI S;
      |PINTA 1610, " Revise el Asiento de Explotacion y compruebe que no existe  ";
      |PINTA 1710, " otro asiento de Cierre. Para buscar el problema realice:    ";
      |PINTA 1810, " a) Testear Plan Contable                                    ";
      |PINTA 1910, " b) Chequeo General de Asientos                              ";
      |PINTA 2010, " c) Recuperacion Total Asientos                              ";
      |PINTA 2110, " d) Recuperacion de Saldos                                   ";
      |ATRI 0;
      |CUADRO 0809 2270;
      |ENTLINEAL #1#65, -1, 7, 15, 0, Max65, Min65;
      |PAUSA;
      |PAUSA;
      |PAUSA;
      |POPV;
|FPRC;

*****************************************************************************
CALCULOS DE APERTURA
*****************************************************************************

|PROCESO leeape;
  |SI #catracde#14 = "-1          "; |ACABA; |FINSI;
  avisillo = "2301 Asiento de Apertura, Tratando: " + #catracde#0;
  |MENSA avisillo;
  |SI aMonedaC ! aMonedaA;
      impMoneda = #catracde#4;
      |HAZ ElCambioMoneda;
      #4#4= impMoneda;
  |FINSI;

  eaCuenta = #catracde#14;
  enNivel  = #catracde#15;
  aCtazzz  = #catracde#16;
  eaNomCta = #catracde#5;

  |SI eSwC2008 = 0;
      |HAZ grabacuen;                    || actualiza cuenta
      |SI #catracde#4 ! 0; |Y #catracde#6 = "S";
          |HAZ grabaaper;                || graba apunte
      |FINSI;
  |SINO;
      |SI #catracde#6 = "S";
          |HAZ grabacuen08;
      |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE cacierre1;
   #4#2;
   ;
   "  ", desde;
   "zz", hasta;
   e;
   NULL, leeape;
|FIN;

|PROCESO grabacuen08;
  alfa1     = eaCuenta; |QBF alfa1;
  eaCta2008 = eaCuenta;
  eSwTabla  = 0;
  |SI alfa1 ! "";
      |HAZ CambioCta08;
  |FINSI;

  |SI eSwTabla = 0;
      eaCuenta = eaCta2008;
      alfa1    = eaCuenta; |QBF alfa1;
      aCtazzz  = (alfa1 + "zzzzzzzzzzzz" ) % 112;
      |HAZ grabacuen;
      |SI #4#4 ! 0;
           |HAZ grabaaper;                || graba apunte
           |HAZ GraboAux;
      |FINSI;
  |SINO;
      |SI #4#4 ! 0;          ||si no tenia cantidad desaparece
          eaCuenta = aCta;
          alfa1    = eaCuenta; |QBF alfa1;
          aCtazzz  = (alfa1 + "zzzzzzzzzzzz" ) % 112;
          nSw116   = 1;
          |HAZ grabacuen;
          |HAZ grabaaper;
          |HAZ GraboAux;
          nSw116   = 0;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO GraboAux;
  debe   = 0;
  haber  = 0;
  |ABRE #404;

  |DDEFECTO #404;
  #404#0  = #1#3;
  #404#10 = #1#0;
  #404#11 = #1#1;
  #404#12 = #1#2;

  #404#1 = #4#14;
  #404#7 = #4#15;
  #404#2 = #4#5;
  #404#3 = #4#3;
  |SI #404#3 = "D";
      #404#4 = #4#4;
      debe   = #4#4;
      #404#5 = 0;
  |SINO;
      #404#4 = 0;
      #404#5 = #4#4;
      haber  = #4#4;
  |FINSI;
  #404#8  = eaCuenta;
  #404#9  = enNivel;
  #404#13 = #1#21;
  |GRABA 020#404n;
  |LIBERA #404;
  |CIERRA #404;

  |SI nSw116 = 1;
      |ABRE #403;
      #403#0 = #4#14;
      |LEE 101#403=;
      |SI FSalida ! 0;
          #403#0 = #4#14;
          |GRABA 020#403b;
      |FINSI;
      #403#1 = #4#5;
      #403#4 = #403#2;
      #403#5 = #403#3;
      #403#2 = eaCuenta;
      #403#3 = #6#2;
      #403#6 = "*";
      |GRABA 020#403a;
      |LIBERA #403;
      |CIERRA #403;
  |FINSI;
|FPRC;

|PROCESO grabacuen;
   |ABRE #6;
   #cacuenta#0 = eaCuenta;
   #cacuenta#1 = enNivel;
   |LEE 101#6=;
   |SI FSalida ! 0;
      |DDEFECTO #6;
      #cacuenta#0 = eaCuenta;
      #cacuenta#1 = enNivel;
      #cacuenta#2 = #4#5;
      #cacuenta#3 = #4#6;
      |HAZ defect1;
      #cacuenta#54 = aCtazzz;
      #cacuenta#55 = enNivel;
      |GRABA 020#6b;
   |FINSI;

   #cacuenta#58 = #catracde#2;
   |SI #catracde#3 = "D";
       #cacuenta#9 = #cacuenta#9 + #catracde#4;
       #cacuenta#51 = #cacuenta#51 + #catracde#4;
   |SINO;
      #cacuenta#10 = #cacuenta#10 + #catracde#4;
      #cacuenta#52 = #cacuenta#52 + #catracde#4;
   |FINSI;
   #cacuenta#11 = #cacuenta#9 - #cacuenta#10;
   #cacuenta#53 = #cacuenta#51 - #cacuenta#52;
   |GRABA 020#6a;
   |LIBERA #6;
   |CIERRA #6;
|FPRC;

|PROCESO lee_descarga1;
   |SI #camaasil#8 = "D";     #caexistl#11 = #camaasil#9;  |FINSI;
   |SI #camaasil#8 = "H";     #caexistl#11 = -#camaasil#9; |FINSI;

   |ABRE #22;
   |DDEFECTO #22;
   #caexistc#0 = #caexistl#0;
   |LEE 001#22=;
   |SI FSalida ! 0;
       nCamp0 = #caexistl#0;
       |LEEDEDEF VAlfa4, VAlfa5, 0, nCamp0, 1, aCamp1, 2, aCamp2, 3, nCamp3;
       #caexistc#0 = nCamp0;
       #caexistc#1 = aCamp1;
       |SALVA_DATOS #catracde;
       #cacuenta#0 = aCamp2;
       #cacuenta#1 = nCamp3;
       |HAZ carganuevas;
       #caexistc#2 = #catracde#14;
       #caexistc#3 = #catracde#15;
       |REPON_DATOS #catracde;
       |GRABA 020#caexistc.n;
   |FINSI;
   |CIERRA #22;

   swexis = 1;
   pp      = #0#18 + 11;     || mes finales
  |SI aMonedaC ! aMonedaA;        ||Mirar esto
      impMoneda = #caexistl#pp#;
      |HAZ ElCambioMoneda;
      #caexistl#pp#= impMoneda;
  |FINSI;


   nImpEx  = #caexistl#pp#;         || exist. finales
   nImpExA = nImpExA + nImpEx;

   #89#0 = #caexistl#0;
   #89#1 = #caexistl#1;
   |LEE 001#89=;
   |SI FSalida ! 0;
       |DDEFECTO #89;
       #89#0 = #caexistl#0;
       #89#1 = #caexistl#1;
       #89#2 = #1#4;
       #89#3 = #1#5;
       #89#4 = #caexistl#4;
       |SALVA_DATOS #catracde;
       #cacuenta#0 = #caexistl#5;
       #cacuenta#1 = #caexistl#6;
       |HAZ carganuevas;
       #89#5 = #catracde#14;
       #89#6 = #catracde#15;
       #89#7 = #caexistl#7;
       #cacuenta#0 = #caexistl#8;
       #cacuenta#1 = #caexistl#9;
       |HAZ carganuevas;
       #89#8 = #catracde#14;
       #89#9 = #catracde#15;
       |REPON_DATOS #catracde;
       #89#10 = #caexistl#10;
       |GRABA 020#89b;
   |FINSI;
   #89#11 = nImpEx;
   |GRABA 020#89.a;
   |LIBERA #89;
|FPRC;

|DEFBUCLE lee_descarga;
   #19#2;
   ;
   nDDep, #catracde#0;
   nHDep, #catracde#0;
   ;
   NULL, lee_descarga1;
|FIN;

|PROCESO buscaaper;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 9999;
   |LEE 001#1];
   |SI FSalida ! 0;
      |LEE 001#1u;
   |SINO;
      |LEE 001#1a;
   |FINSI;
   |SI FSalida ! 0;
      linea = 1;
   |SINO;
      |SI #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
         linea = #camaasil#3 + 1;
      |SINO;
         linea = 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO grabaaper;

   |SI cam = 0;
       cam = 1;
       #camaasic#0 = 0;
       #camaasic#1 = #0#5;
       #camaasic#2 = #0#8;
       |LIBERA #2;
       |LEE 101#2=;
       |SI FSalida ! 0;
           |DDEFECTO #2;
           #camaasic#0 = 0;
           #camaasic#1 = #0#5;
           #camaasic#2 = #0#8;
           #camaasic#3 = #0#8;
           |GRABA 020#2b;
      |FINSI;
      |HAZ buscaaper;
      #camaasic#12 = nREGISTRO;
      aElDepar = #catracde#18;
      |HAZ LeeDescarga;
      #camaasic#08 = aCtaPer; #camaasic#09 = nCtaPer;
      #camaasic#10 = aCtaPer; #camaasic#11 = nCtaPer;
   |FINSI;

   |DDEFECTO #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = linea;
   #camaasil#4 = eaCuenta;
   #camaasil#5 = enNivel;
   #camaasil#6 = #0#6;
   #camaasil#7 = #0#7;
   #camaasil#8 = #catracde#3;
   #camaasil#9 = #catracde#4;
   |SI #camaasil#8 = "D";
      #camaasil#16 = #camaasil#4;
      #camaasil#17 = #camaasil#5;
      #camaasil#10 = "";
      #camaasil#11 = 0;
   |SINO;
      #camaasil#16 = "";
      #camaasil#17 = 0;
      #camaasil#10 = #camaasil#4;
      #camaasil#11 = #camaasil#5;
   |FINSI;
   |SI #0#14 = "S";
      #camaasil#18 = "û";
   |FINSI;
   #camaasil#21 = #catracde#18; |SI #0#20 = "N"; #camaasil#21 = aElDep; |FINSI;
   #camaasil#28 = aElSub;
   #camaasil#24 = nREGISTRO;
   |GRABA 020#1n;
   linea = linea + 1;

   swexis = 0;
   nImpExA = 0;
   |SI #0#20 = "N";
       nDDep = #0#13; nHDep = #0#17;
   |SINO;
       nDDep = #4#18; nHDep = #4#18;
   |FINSI;
   |BUCLE lee_descarga;
   |SI swexis = 1;
       |SI nImpExA ! #camaasil#9;
           alfa1 = #camaasil#4; alfa1 = "    Acumulado NO CORRECTO de la Cuenta de Existencias " + alfa1;
           || .. |MENAV alfa1;
       |FINSI;
   |FINSI;

   MasMenos     = #camaasil#9;
   DebeHaber    = #camaasil#8;
   aCUENTA      = #camaasil#4;
   nREGISTRO    = #camaasil#24;
   nDIARIO      = #camaasil#0;
   aFECHA       = #camaasil#1;
   nDOCUMENTO   = #camaasil#2;
   nNIVELCUENTA = #camaasil#5;
   |HAZ ActDiario;          || diario

   |SI #camaasil#8 = "D";
       #camaasic#4 = #camaasic#4 + #camaasil#9;
   |SINO;
       #camaasic#5 = #camaasic#5 + #camaasil#9;
   |FINSI;
   #camaasic#6 = #camaasic#4 - #camaasic#5;
   |GRABA 020#2a;

   nSw = 1;
|FPRC;

|PROCESO apertura;
  eaMoneda = aMonedaA;
  |HAZ Monedas;      ||Carga Variables Moneda

   nNume = enEjercicio;
   enEjercicio = nEjerActual;

   |DBASE dir_fich;
   dir_fich   = dir_fich + "fich/" + apertu + "/";
   fich_alta  = dir_fich;
   eaPath2008 = fich_alta;

   |PATH_DAT #camaasil #dir_fich#;
   |PATH_DAT #camaasic #dir_fich#;
   |PATH_DAT #cacuenta #dir_fich#;
   |PATH_DAT #camandia #dir_fich#;
   |PATH_DAT #caconasi #dir_fich#;
   |PATH_DAT #caexistc #dir_fich#;
   |PATH_DAT #102 dir_fich;
   |PATH_DAT #404 dir_fich; |DELINDEX #404;
   |PATH_DAT #403 dir_fich;

   r_emp = #0#10;
   r_per = #0#11;

   |DDEF VAlfa1; |QBF VAlfa1;
   VAlfa2 = VAlfa1 + "caexistl.mas";
   VAlfa3 = dir_fich + "caexistl";
   swexis = 0;

|| .... Aqui
   |CARGA_DEF VAlfa2, existen@;
   |SI FSalida = 0;
       |PATH_DAT #89 dir_fich;
   |SINO;
       |MENAV "    ERROR GRAVE EN CONTABILIDAD ";
       |ACABA;
   |FINSI;

|| ...hasta aqui
|| ..................................
   |SI enEjercicio ] 2008;
     |ABRE #400;
     |DDEFECTO #400;
     #400#0 = #0#10;
     #400#1 = #0#11;
     |LEE 000#400=;
     |SI FSalida ! 0;
         #400#0 = #0#10;
         #400#1 = #0#11;
         #400#2 = #0#25;
         #400#3 = enEmpresa;
         #400#4 = nPOrigen;
         #400#5 = 1;
         fFecha = ~;             #400#6 = fFecha;
         aAlfa1 = Usuario % 810; #400#7 = aAlfa1;
         |GRABA 020#400b;
     |SINO;
         #400#2 = #0#25;
         |GRABA 020#400a;
     |FINSI;
     |CIERRA #400;
   |FINSI;
|| ******************************************************************

   |HAZ NuevoDoc;
   |SI nDOCUMENTO < #0#8;
       |HAZ contador;
   |SINO;
       |HAZ NuevoRegistro;
   |FINSI;
   nDOCUMENTO = #0#8;
   |ABRE #1;
   |ABRE #2;
   |ABRE #18;
   |ABRE #89;
   cam   = 0;
   linea = 1;
   nSw   = 0;
   |BUCLE cacierre1;
   |CIERRA #1;
   |CIERRA #2;
   |CIERRA #18;
   |CIERRA #89;
   |SI #2#4 ! #2#5;
       |MENAV "    AVISO!!! Asiento de Apertura Descuadrado";
   |FINSI;
   |DELINDEX #4;
   |DESCARGA_DEF #89;
   |PATH_DAT #caexistl #dir_fich#;
   |HAZ ExisGeneral;

  |SI nSw = 1; |Y eSwC2008 = 1;
      |PUSHV 0909 1666;
      |ATRI R;
      |PINTA 1010, " ATENCION:                                               ";
      |PINTA 1110, " SE HA REALIZADO EL ASIENTO DE APERTURA EN  BASE  DE LA  ";
      |PINTA 1210, " TABLA DE EQUIVALENCIAS DE CUENTAS EXISTENTE.            ";
      |PINTA 1310, " REVISE QUE EL ASIENTO DE APERTURA CONTIENE LAS CUENTAS  ";
      |PINTA 1410, " CORRECTAS, Y, EN CASO NECESARIO, PROCEDA MANUALMENTE A  ";
      |PINTA 1510, " REALIZAR LOS CAMBIOS QUE CONSIDERE OPORTUNOS.           ";
      |ATRI 0;
      |CUADRO 0909 1666;
      |PAUSA;
      |POPV;
  |FINSI;

  |SI nSw = 1; |Y eSwC2008 = 1;
      aAlfa1 = #0#10; aAlfa1 = ("00000" + aAlfa1) % -105;
      aAlfa2 = #0#11; aAlfa2 = ("0"     + aAlfa2) % -101;
      aAlfa1 = "carecupe canempr1 " + aAlfa1 + aAlfa2 + ";F";
      |SUB_EJECUTA_NP aAlfa1;
      #48#3 = nPOrigen;
  |FINSI;

  eaPathO = fich_alta;
  |SUB_EJECUTA_NP "caz00001;Cierre";

  enEjercicio = nNume;

  |SI #0#27 = "S";
      aAlfa1 = enEjercicio;
      aAlfa1 = "camaccz3;I"+ enEjercicio;
      |SUB_EJECUTA_NP aAlfa1;
  |FINSI;
|FPRC;

*****************************************************************************
CALCULOS DE CREACION DE LA EMPRESA
*****************************************************************************

|PROCESO creacion;
   no_sigas = 0;
   |CONFI "2400S Realizar Creacion de Empresa de Apertura: ";
   |SI FSalida = 0;
      |HAZ empresa;
      |PUSHV 1801 2380;
      |HAZ jaleo;
      |POPV;
   |SINO;
      no_sigas = 1;
     |CONFI "2400S Desea Continuar con el Proceso de Cierre: ";
     |SI FSalida = 0;
         no_sigas = 2;
     |FINSI;
   |FINSI;
|FPRC;

|PROCESO empresa;             || da de alta la empresa y crea el directorio
   |DBASE dir_fich;
   dir_fich=dir_fich + "fich/";
   |PATH_DAT #canempre #dir_fich#;
   |ABRE #30;
   #canempre#2 = #0#10;
   #canempre#3 = nPOrigen;
   |LEE 001#30=;
   |SI FSalida = 0;
      #canempre#0 = (#0#10 * 10) + #0#11;
      #canempre#2 = #0#10;
      #canempre#3 = #0#11;
      #canempre#26 = #canempre#26 + 1;                     || suma un a¤o
      |SI #canempre#26 = 100;  #canempre#26 = 0;  |FINSI;  || a¤o cero
      enEmpresa = #0#10;
      enPeriodo = #0#11;
      |SUB_EJECUTA_NP "camoneda";
      #canempre#28 = eaMoneda;
      |HAZ PonTitulo;
      |GRABA 020#30n;
      |SI FSalida = 0;
          |DBASE alfa1;
          alfa2 = #canempre#0;  alfa2 = "000000" + alfa2;  alfa2 = alfa2 % -106;
          alfa1 = alfa1 + "fich/" + alfa2;
          |MKDIR alfa1;
      |FINSI;
   |FINSI;
   |CIERRA #30;

   cod1 = #0#10;
   cod2 = #0#11;
   emEmp = 1;
   |HAZ leelo;

  |SUB_EJECUTA "caw00010;crea";
|FPRC;

|PROCESO jaleo;          || copia los ficheros
   aMonedaA = #canempre#28;
   num_por  = #canempre#2;
   num_per  = #canempre#3;
   any_por  = #canempre#26;
   |DFICE dir_fich;
   |DBASE fich;
   alfa2 = #canempre#0;
   alfa2 = "000000" + alfa2;
   alfa2 = alfa2 % -106;
   fich = fich + "fich/" + alfa2 + "/";

   fich_copi = dir_fich;
   fich_alta = fich;
   eaPath2008 = fich_alta;

   |HAZ copia_maes;
   |SI eSwC2008 = 1;
       |HAZ creacion_m;   || .... Copia las estructuras
   |FINSI;
   |HAZ acerar4;
   |HAZ pone0_maes;
   |HAZ poneEP_maes;
   |HAZ ActDefecto;

   |ABRE #400;
   |DDEFECTO #400;
   #400#0 = #0#10;
   #400#1 = #0#11;
   |LEE 101#400=;
   |SI FSalida ! 0;
       #400#0 = #0#10;
       #400#1 = #0#11;
       #400#2 = #0#25;
       |SI eSwC2008 = 1;
           #400#3 = enEmpresa;
           #400#4 = enPeriodo;
           #400#5 = 1;
       |FINSI;
       fFecha = ~;
       #400#6 = fFecha;
       aAlfa1 = Usuario % 810;
       #400#7 = aAlfa1;
       |GRABA 020#400b;
   |FINSI;
   |LIBERA #400;
   |CIERRA #400;

   |SI eSwC2008 = 1;
       eNum2008   = #0#21;
       enEmpreOri = #0#10;
       enPerioOri = nPOrigen;
       |PINTA 2211, " ADAPTANDO PLAN CONTABLE 2008. Cuenta:                 ";
       eNum2208 = 1;
       |SUB_EJECUTA_NP "ca8zcamb";
   |FINSI;
|FPRC;

|PROCESO copiaantes;
   |DFICE dir_fich;
   |DBASE fich;
   alfa2 = #canempre#0;
   alfa2 = "000000" + alfa2;
   alfa2 = alfa2 % -106;
   fich = fich + "fich/" + alfa2 + "/";

   aAlfa1    = fich_alta;
   fich_copi = dir_fich;
   fich_alta = fich;

   |SI #90#0 ! #90#10; |O #90a_nivels ! #90d_nivels; |ACABA; |FINSI;
   |SI #0#16 = "S";
       traba1 = "caclipro";  |HAZ copiando;    || Clientes/Proveedores
   |FINSI;
   |SI #0#16 = "A";
       |SUB_EJECUTA_NP "caz00033;cierra";
   |FINSI;
   fich_alta = aAlfa1;
|FPRC;

|| **********************************************************************
|| Proceso para cambiar los niveles Nuevos
|PROCESO carganuevas;
  a_nivels = #90#0;       ||Origen
  d_nivels = #90#10 + 10; ||Destino

  #catracde#14 = #cacuenta#0;
  #catracde#15 = #cacuenta#1;
  #catracde#16 = #cacuenta#54;
  #catracde#17 = #cacuenta#55;
  |SI #90#0 = #90#10; |Y #90#1 = #90#11; |Y #90#2 = #90#12;
   |Y #90#3 = #90#13; |Y #90#4 = #90#14; |Y #90#5 = #90#15;
   |Y #90#6 = #90#16;
      |ACABA;
  |FINSI;

                             || #cacuenta#1 = Nivel segun la Vieja
                             || enNivel = Nivel segun la Nueva
   eaCuenta = #cacuenta#0;  |HAZ sacanivel;
   |SI enNivel = #cacuenta#1; ||/no cambia nivel, no cambia longitud
       |ACABA;
   |FINSI;

  #catracde#14 = #cacuenta#0;
  #catracde#15 = #cacuenta#1;
  #catracde#16 = #cacuenta#54;
  #catracde#17 = #cacuenta#55;
   |SI enNivel ! 0;
       #catracde#15 = enNivel;     || nivel destino
       #catracde#17 = enNivel;     || nivel destino
   |SINO;
       |SI #cacuenta#1 = #90#0;  || Es el ultimo nivel de esta
                                 || cambia nivel, cambia longitud
                                 || o  no cambia nivel, cambia longitud

           nume1 = #cacuenta#1;
           |SI #90nume1 < #90d_nivels;  || a¤adir 0
               nume3 = #cacuenta#1 - 1;    || el nivel anterior
               nume2 = #90d_nivels - #90nume1;     ||/ultimo nivel destino
               alfa1 = "0" * nume2;                || diferencia en 0;
               alfa2 = #cacuenta#0; |QBF alfa2;
               nume4 = #90nume3;             || el nivel anterior
               nume4 = 100 + nume4;
               alfa3 = nume4; |QBF alfa3;    || digitos del principio
               nume4 = #90nume3;          || el nivel anterior
               nume4 = #90nume1 - nume4;  ||Diferencia entre anterior y este
               nume4 = 0 - (100 + nume4); || parte posterior
               alfa4 = nume4;
               #catracde#14 = (alfa2 % alfa3) + alfa1 + (alfa2 % alfa4);
          |SINO;
              || Corto ???
              nume2 = #90nume1 - #90d_nivels;
              nume2 = 0 - (100 + nume2);
              alfa1 = nume2; |QBF alfa1;
              nume3 = d_nivels - 1;    || el nivel anterior  nuevo

             alfa2 = #cacuenta#0; |QBF alfa2;
             nume4 = #90nume3;  || el nivel anterior  nuevo
             nume4 = 100 + nume4;
             alfa3 = nume4; |QBF alfa3;

             nume4 = #90nume3;         || el nivel anterior
             nume4 = #90nume1 - nume4;  ||Diferencia entre anterior y este
             nume4 = 0 - (100 + nume4);
             alfa4 = nume4;
             alfa5 = (alfa2 % alfa4);
             alfa5 = (alfa5 % alfa1);
             #catracde#14 = (alfa2 % alfa3) + alfa5;
          |FINSI;

          #catracde#15 = #90#10;         || Nivel nuevo
          #catracde#17 = #90#10;         || Nivel nuevo
          alfa1 = #catracde#14; |QBF alfa1;
          alfa1 = alfa1 +"zzzzzzzzzzzz";
          alfa1 = alfa1 % 112;
          #catracde#16 = alfa1;
       |SINO;
          #catracde#14 = "-1";  || No paso esta cuenta
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO sacanivel;
   aLong = eaCuenta;
   |QBF aLong;
   aLong = aLong % 0;
   nLong = aLong;
   enNivel = 0;
   |SI nLong = #90#11; |Y #90#11 ! 0; enNivel = 1; |FINSI;
   |SI nLong = #90#12; |Y #90#12 ! 0; enNivel = 2; |FINSI;
   |SI nLong = #90#13; |Y #90#13 ! 0; enNivel = 3; |FINSI;
   |SI nLong = #90#14; |Y #90#14 ! 0; enNivel = 4; |FINSI;
   |SI nLong = #90#15; |Y #90#15 ! 0; enNivel = 5; |FINSI;
   |SI nLong = #90#16; |Y #90#16 ! 0; enNivel = 6; |FINSI;
|FPRC;

|PROCESO PonTitulo;

     aAlfa = "";
     alfa1 = #canempre#1;     |QBF alfa1;
     alfa2 = "";
     alfa3 = "";
     |SI #canempre#26 ] 80;
         nNume = 1900 + #canempre#26;
     |SINO;
         nNume = 2000 + #canempre#26;
     |FINSI;
     #canempre#34 = "01.01.0000";
     #canempre#35 = "";

     |SI Haybasica = 1;
          |ABRE #114;
          #114#0 = #canempre#2;
          #114#1 = 1;
          |LEE 040#114];
          |SI FSalida ! 0;  |O #114#0 ! #canempre#2;
              |DDEFECTO #114;
          |FINSI;
          |CIERRA #114;

          alfa2 = #114#8;   |QBF alfa2;
          alfa3 = #114#10;  |QBF alfa3;
     |FINSI;

     aAlfa =  "[" + (("00000" + #canempre#2) % -105) + "/" + nNume + "] " + alfa1 + " " + alfa2 + " " + alfa3;
     #canempre#29 = aAlfa;
|FPRC;
