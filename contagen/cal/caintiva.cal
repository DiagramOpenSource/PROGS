|FICHEROS;
   caintiva #0;
   cainliva #1,MANTE;

   calibros #3;
   caivases #4;
   caclipro,MANTE;
   cacuenta;

   ca8cumay;
   ca8m0002;
   cacuebal;
   gadm0000;

   caivaasi;

   :/modelos/def/dsmom030 #130;
   :/dsarchi/def/dpntm001 #801;
   :/dsarchi/def/dpntm100 #850;
   :/dsarchi/def/dpntm101 #851;
   :/dsarchi/def/dsarm001;

   caw00017 #17;

   lalinea@ #901;

   caintvto #110;
   cafantas #999;

   anm00012 #112;
   anm00013 #113;

   anw00012 #212;
   anw00013 #213;

   &regisnif@ #709;

   gadm0004 #1004;

   caw00102 #2000,MANTE;
   Referen@ #2001;
   Refere1@ #2002;

   camacc12;
   camaccw1;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscosi_i;
|INCLUYE dscopi_i;
|INCLUYE dscoan_i;
|INCLUYE dscoiv_i;
|INCLUYE defec1_i;
|INCLUYE modulo_i;
|INCLUYE cla340_i;

|VARIABLES;
   nSwYaTengoTipo = 0;
   nTipoIVA = 0;

   nConceIRPF = 0;
   aDesIRPF = "";
   aAux = "";
   aMensa   = "";
   mensa1   = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
   mensa2   = "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
   &enSWAut = 0;
   &enLiAut = 0;
   &enOrAut = 0;
   &eaSeAut = "";
   nInkey   = 0;
   aBlancs  = "";
   aAlfa1   = "";
   aAlfa2   = "";
   aAlfa3   = "";
   aAlfa5   = "";
   aAlfa7   = "";
   mesdes   = "";
   meshas   = "";

   nAny     = 0;
   xx       = 0;
   aDCon1   = "";
   aDCon2   = "";
   nDCon0   = 0;
   nDCon1   = 0;

   &eaVarDni  = "";
   &enCalcCif = 0;

   swNuevo  = 0;
   swRepite = 0;

   &enQSerie = 0;  || 0 Sin serie,  1 con serie
   &entrada  = 1;
   &ct1_am   = "";
   &ct2_am   = 0;
   &ct3_am   = "";
   &fec_am   = @;
   &imp_am   = 0;
   &iva_am   = 0;
   &tiva_am  = 0;
   &ref_am   = "";
   &c_am     = "";
   &prv_am   = "";
   &c_conp   = 0;
   &nLib_am  = 0;
   &aSer_am  = "";
   &nFra_am  = 0;
   &dni_am   = "";
   &clau_am  = "";
   &igic_am  = "";
   &nDoc_am  = 0;
   &nBas_am  = 0;
   &c_ctana  = "";
   &aElemento = "";
   &nNumero  = 0;

   a_param   = "";
   fFecha1   = @;
   alfa1     = "";
   alfa2     = "";
   alfa3     = "";
   alfa4     = "";
   alfa5     = "";
   alfa6     = "";
   nNume1    = 0;
   nNume2    = 0;
   nNume3    = 0;
   nNume4    = 0;
   nNume5    = 0;
   nNume6    = 0;
   muestra   = "";
   nSwLaC    = 0;
   asteris   = 0;
   longi     = 0;
   nSw       = 0;
   Comodin   = "";
   Comodin1  = "";
   ComodNum  = 0;
   nPara1    = 0;

   ModoEntrada = 0;
   factura     = 0;
   NumFactura  = 0;
   NumBase     = 0;
   SerieAnt    = "XX";
   FacturaAnt  = 0;
   nFacCon     = 0;
   aSerCon     = "";
   FechaAnt    = "";
   CuentaAnt   = "";
   DigitoAnt   = 0;
   PerioAnt    = 0;
   ClienAnt    = "";
   CifAnt      = "";
   ConceptoAnt = 0;
   DescAnt     = "";
   DeparAnt    = "";
   NDeparAnt   = "";
   SubdeAnt    = "";
   NSubdeAnt   = "";
   ReferAnt    = "";
   RefPrAnt    = "";
   aAntesDes0 = "";
   aAntesDes1 = "";
   nAnterior  = 0;
   nAnteriorIRPF = 0;
   nCamp10     = 0;
   nCamp11     = 0;
   nCamp12     = 0;
   nCamp13     = 0;
   nCamp14     = 0;
   nCamp15     = 0;
   nCamp16     = 0;
   aCamp17     = "";
   nCamp18     = 0;
   aCamp19     = "";
   aCamp28     = "";
   nCamp29     = 0;
   aCamp32     = "";
   nCamp34     = 0;
   nCamp35     = 0;
   aCamp36     = "";
   nCamp37     = 0;
   aCamp39     = "";
   fCamp73     = @;
   aCamp40     = "";
   nCamp41     = 0;
   aCamp42     = "";
   nCamp43     = 0;
   aCamp44     = "";
   aCamp49     = "";
   nCamp51     = 0;
   aCamp52     = "";
   aCamp54     = "";
   aCamp55     = "";
   aCamp56     = "";
   aCamp57     = "";
   aCamp58     = "";
   nCamp59     = 0;
   nCamp60     = 0;
   fCamp61     = @;
   aCamp62     = "";
   aCamp63     = "";
   aCamp64     = "";
   aCamp68     = "";
   aTexto      = "";

   sw     = 0;
   SwMovs = 0;
   Serie  = "";
   nTecla  = 0;

   BaseAnt = 0;
   Calc = 0;
   swpase = 0;
   swmira = 0;
   aFich1 = "";
   aFich2 = "";
   nYaCrea = 0;
   swmalo  = 0;
   swpcta = 0;
   &enModAmor = 0;

   &enSwActual = 0;
   &en0W17   = 0;
   &ef1W17   = @;
   &en2W17   = 0;
   &nSwHay17 = 0;
   &eaFitW17 = "";
   &coant      = 0;
   &deant      = "";
   &dpant      = "";
   &sdant      = "";
   &refant     = "";
   fechaW17    = @;

   aMas       = "";
   aDirInicio = "";
   nEstaLin   = 0;
   nEstado    = 0;

   aImpriSN   = "";
   nSwImp     = 0;
   aCPartida  = "";
   nCTiva     = 0;
   nSwObli    = 0;
   aPositivo  = "";
   aObligado  = "";
   aModIRPF1  = "";
   nConIRPF1  = 0;
   nConIRPF   = 0;
   swclipro   = 0;
   nOk        = 0;

   &libro     = 0;
   &serie     = "";
   &orden     = 0;
   &depart    = "";
   &pesetas   = 0;
   &cuenta    = "";
   &digito     = 0;
   &emision   = "";
   &nConcep   = 0;
   &aDesc     = "";
   &enModoEsc = 0;
   &enLinea   = 0;
   &enCyP     = "";
   aCta        = "";
   aAlfa       = "";
   &enSwBUENO = 0;

   nError = 0;
   &enDiAna = 0;
   &efFeAna = @;
   &enDoAna = 0;
   &enApAna = 0;
   &eaGrAna = "";
   &enImAna = 0;
   &enQueAna = 0;
   &nSwGrupo = 0;
   &eaFitnW12 = "";
   &eaFitnW13 = "";

   &r_entra = "";
   &r_alfa1 = "";

   nNumLin  = 0;
   aSerTot  = "";
   nFacTot  = 0;
   nLinTot  = 0;

   &ext1 = "";
   &ext2 = "";

   swAmor   = 0;
   swInve   = 0;
   nIva0    = 0;
   nPrimLin = 0;
   nMasLin  = 0;
   nSwOp    = 0;
   nswcambio = 0;
   nNoSalta  = 0;
   &enIn03   = 0;
   nSwIntra  = 0;
   nCampo    = 0;
   &enPerIntra = 0;
  {40}aPopup        = "";
     nID            = 0;
     aID            = "";
   swAmorC   = 0;

   aEjecuta          = "";
   aAbre             = "";
   aPathDefDSARCHI   = "";
   aPathFichDSARCHI  = "";
   aPathFichDESPANET = "";
   aPathDSARCHI      = "";
   nDSARCHI          = 0;
   nHandle           = 0;
   nBoton1           = 0;
   nBoton2           = 0;
   nBoton3           = 0;
   nEstadoBoton1     = 0;
   nEstadoBoton2     = 0;
   nEstadoBoton3     = 0;
   nRecoge           = 0;
   nForma            = 0;
   aValor            = "";
   aSerieArc         = "";
   nFactuArc         = 0;
   nLinea1           = 0;
   nLinea2           = 0;
   nPasada           = 0;
   nHay              = 0;

   nPulsoF9 = 0;
   aPCorreo = "";

   &eaTip349 = "";
   &eaRef    = "";
   aFraPrv   = "";
   aM030_92    = "";
   nM030_93    = 0;

     &raf_cue   = "";
     &raf_dig   = 0;
     &raf_des   = "";
     &raf_sw    = 0;
     &tipoalta  = "";
     &raf_nif   = "";
   nSwClPr = 0;

   nEsPCEG = 0;
   nResPer     = 0;

     &eaMensaCad = "";
     &enErrorCad = 0;
     aFichero    = "";
     nSwCaja     = 0;
     aModi       = "";
     &eaBloqueo  = "";
     aGuarda     = "";
     nSalir      = 0;
     nMod        = 0;
     fDFecha     = @;

     &enTipOpera = 0;
     &enEmpres   = 0;
     &enEjerci   = 0;
     &enActivi   = 0;
     &eaCodSub   = "";
     &eaSer      = "";
     &enFac      = 0;
     &eaTip      = "";
|FIN;

|| ********************************** Procesos Lineas
|| **********************************************************************
|PROCESO BuscaTotal;
  |SI nLinTot ! #901#1;
      #999#0 = #999#0 + #901#12;
      #999#1 = #999#1 + #901#14 + #901#15;
      #999#2 = #999#2 + #901#35;
      #999#3 = #999#3 + #901#29;
      nNumLin = nNumLin + 1;
  |FINSI;
|FPRC;

|DEFBUCLE BuscaTotal;
 #901#2004;
 ;
 #caintiva#0, aSerTot, nFacTot, 01;
 #caintiva#0, aSerTot, nFacTot, 99;
 ;
 NULL,BuscaTotal;
|FIN;

|PROCESO PintaTotal;

    |PINTA 2154, "                          ";
    |DDEFECTO #999;
    nFacTot = #cainliva#2;
    aSerTot = #cainliva#26;
    nLinTot = #cainliva#1;
    nNumLin = 0;
    |BUCLE BuscaTotal;
    |SI nNumLin ! 0;
        |HAZ PintaTotal1;
    |FINSI;
|FPRC;

|PROCESO PintaTotal1;
      |PINTA 2154, "                          ";
      #999#12 = #999#0 + #cainliva#12;
      #999#13 = #999#1 + #cainliva#14 + #cainliva#15;
      #999#14 = #999#2 + #cainliva#35;
      #999#17 = #999#3 + #cainliva#29;

      |ATRI P; |PINTA 2154, "TOTAL FRA.: ";
      |ATRI P; |PINTA 2166, #999#17; |ATRI 0;
|FPRC;

|PROCESO RecogeDeGAD;
     nRecoge  = 0;
     aEjecuta = "|:dsarchi/dpntz002;" + (("00000" + #801#0) % -105) + aTipoIVA;
     |SUB_EJECUTA aEjecuta;

     aAbre = aPathFichDESPANET + "recoger.txt";
     |XABRE "AB", aAbre, nHandle;
     |SI FSalida ] 0;
         |XLEE nHandle, 7, aAlfa;
     |FINSI;
     |XCIERRA nHandle;
     |FBORRA aAbre;

     |QBF aAlfa;

     |SI aAlfa = "";
         |MENAV "0000No se ha recogido ninguna factura.";
         |ERROR;
         |ACABA;
     |FINSI;

     aSerieArc = "";
     nFactuArc = 0;

     |SI aTipoIVA = "R";
         nRecoge = aAlfa;

         |SELECT #1#850;
         #850#0 = nRecoge;
         |LEE 000#850=;
         |SI FSalida = 0;
             |SI #850#44 = "N";
                 |ABRE #901;
                 |SELECT #4#901;
                 #901#0  = #1#0;
                 #901#69 = #850#45;
                 |LEE 000#901=;
                 nError = FSalida;
                 |CIERRA #901;

                 aSerieArc = #901#26;
                 nFactuArc = #901#2;

                 |SI nError ! 0;
                     nRecoge = 0;
                     |MENAV "0000Factura con varios tipos de IVA. Seleccione la primera factura";
                     |ERROR;
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI aTipoIVA = "S";
         nRecoge = aAlfa;

         |SELECT #1#851;
         #851#0 = nRecoge;
         |LEE 000#851=;
         |SI FSalida = 0;
             |SI #851#44 = "N";
                 |ABRE #901;
                 |SELECT #4#901;
                 #901#0  = #1#0;
                 #901#69 = #851#45;
                 |LEE 000#901=;
                 nError = FSalida;
                 |CIERRA #901;

                 aSerieArc = #901#26;
                 nFactuArc = #901#2;

                 |SI nError ! 0;
                     nRecoge = 0;
                     |MENAV "0000Factura con varios tipos de IVA. Seleccione la primera factura";
                     |ERROR;
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |ERROR;
     |PTEC 802;
     |PTEC 815;
     |PTEC 816;
|FPRC;

|PROCESO Tipo7C1; |TIPO 7;
  aAlfa1 = "    F2-Extracto C/P, F5-Otros Aptes para Asto, F4-Autofactura Intracomunitaria";
  |HAZ EsCaja;
  |SI nSwCaja = 1;
      aAlfa1 = "    F2-Extracto C/P, F5-Otros Aptes, F4-Auto.Intrac., F9-Consulta Cob/Pg Caja";
  |FINSI;
  |MENSA aAlfa1;

  nEstadoBoton1 = 0;
  nEstadoBoton2 = 0;

  |SI nDSARCHI = 1;
      |SI #1#69 = 0;
          |ESTADO_CONTROL nBoton2, "DISABLE";
      |SINO;
          |ESTADO_CONTROL nBoton2, "ENABLE";
          nEstadoBoton2 = 1;
      |FINSI;

      |SI aTipoIVA = "R";
          |SELECT #2#850;
          |LEE 000#850p;
          |SI FSalida = 0;  |Y #850#29 = "N";
              |ESTADO_CONTROL nBoton1, "ENABLE";
              nEstadoBoton1 = 1;
          |SINO;
              |ESTADO_CONTROL nBoton1, "DISABLE";
          |FINSI;
      |FINSI;

      |SI aTipoIVA = "S";
          |SELECT #2#851;
          |LEE 000#851p;
          |SI FSalida = 0;  |Y #851#29 = "N";
              |ESTADO_CONTROL nBoton1, "ENABLE";
              nEstadoBoton1 = 1;
          |SINO;
              |ESTADO_CONTROL nBoton1, "DISABLE";
          |FINSI;
      |FINSI;
  |FINSI;

|FPRC;

|CALCULO El11; |TIPO 11;
  nInkey   = FSalida;

  |SI nInkey = 10;
      ModoEntrada = (FEntrada / 100) ! 0;
      |SI ModoEntrada ] 2;
          ext1 = #cainliva#5;
          ext2 = #cainliva#6;
          |HAZ externos;
      |FINSI;
      |ERROR;
  |FINSI;

  |SI nInkey = 12;
      |SI #1#54 = "S"; |O #1#62 = "I";
          nSwImp = 0;
          |HAZ paraI;
          enSWAut = 1;
          enLiAut = #1#0;
          enOrAut = #1#2;
          eaSeAut = #1#26;
          |SUB_EJECUTA "cay2ivas;";
          |PTEC 806;
      |SINO;
          |ERROR;
      |FINSI;
  |FINSI;

  |SI nInkey = 13;
      ModoEntrada = (FEntrada / 100) ! 0;
      |SI ModoEntrada = 2;
          |SI #caivaasi#92 = "S";  nSwHay17 = 1; |FINSI;
          |SI nSwHay17 = 1;  |HAZ VoyaW17; |FINSI;
      |FINSI;
      |ERROR;
  |FINSI;

  |SI nInkey = 14;  |Y nEstadoBoton1 = 1;
      |HAZ RecogeDeGAD;
  |FINSI;

  |SI nInkey = 15;  |Y nEstadoBoton2 = 1;
      |HAZ Boton2;
      |PONCONTROL 23, "SI";
  |FINSI;

  |SI nInkey = 16;  |Y nEstadoBoton3 = 1;
      |HAZ Boton3;
      |PONCONTROL 23, "SI";
  |FINSI;

  |SI nInkey = 17;
      |SI enEjercicio ] 2014;
          |LEE 041#1=;
          |SI FSalida = 0;
              |HAZ EsCaja;
              |SI nSwCaja  = 1;
                  |SI #cainliva#49 = "P"; |O amCCaja = "M";
                      ModoEntrada = 4;
                      |HAZ TrataClaveZ;
                  |FINSI;
              |FINSI;
          |FINSI;
       |FINSI;
       |ERROR;
  |FINSI;

  nSwImp = 0;
  aAlfa1 = &196 * 08;
  aAlfa2 = "          " + &179
  |PINTA 0570, aAlfa1;
  |PINTA 0670, aAlfa2;
|FCAL;

|PROCESO EsCaja;
   nSwCaja = 0;
   |SI enEjercicio ] 2014;
      |SI #cainliva#62 = "Z"; |O #cainliva#62 = "1"; |O #cainliva#62 = "2";
          |O #cainliva#62 = "3"; |O #cainliva#62 = "4"; |O #cainliva#62 = "5";
          |O #cainliva#62 = "6"; |O #cainliva#62 = "7"; |O #cainliva#62 = "8";
             nSwCaja = 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BorraMacc12;
   |BORRA 020#camacc12.a;
   |LIBERA #camacc12;
|FPRC;

|DEFBUCLE BorraMacc12;
   #camacc12#1;
   ;
   #cainliva#0, #cainliva#1,01;
   #cainliva#0, #cainliva#1,99;
   be;
   NULL, BorraMacc12;
|FIN;

|PROCESO TrataClaveZ;
   |HAZ EsCaja;

   |SI ModoEntrada = 3; |O nSwCaja = 0;
       |BUCLE BorraMacc12;
       |ACABA;
   |FINSI;

   |SI nSwCaja = 1;
       |ABRE #camaccw1;
       #camaccw1#0 = #cainliva#0;
       #camaccw1#1 = #cainliva#1;
       |LEE 041#camaccw1.=;
       |SI FSalida ! 0;
           |DDEFECTO #camaccw1;
           #camaccw1#0 = #cainliva#0;
           #camaccw1#1 = #cainliva#1;
           |GRABA 020#camaccw1.c;
       |FINSI;
       eModoCaja = ModoEntrada + 10;
       #camaccw1#2    = #cainliva#02;
       #camaccw1#3    = #cainliva#26;
       #camaccw1#4    = #cainliva#04;
       #camaccw1#5    = #cainliva#05;
       #camaccw1#6    = #cainliva#07;
       #camaccw1#7    = #cainliva#08;
       #camaccw1#8    = #cainliva#12;
       #camaccw1#9    = #cainliva#14;
       #camaccw1#10   = #cainliva#29;
       #camaccw1#11   = #cainliva#27;
       #camaccw1#12   = #cainliva#30;
       #camaccw1#13   = aTipoIVA;
       #camaccw1#14   = #cainliva#49;
       #camaccw1#15   = #cainliva#73;
       #camaccw1#17   = #cainliva#31;
       |GRABA 020#camaccw1.a;
       |CIERRA #camaccw1;
       |SUB_EJECUTA_NP "camaccw1";
   |FINSI;
|FPRC;

|PROCESO ConfirmaLinea; |TIPO 3;          ||Desde Campo Linea
   nPulsoF9 = 0;
   ModoEntrada = (FEntrada / 100) ! 0;

   #cainliva#65 = #cainliva#5;  |PINTA #cainliva#65;
   #cainliva#66 = #cainliva#17; |PINTA #cainliva#66;
   #cainliva#67 = #cainliva#29; |PINTA #cainliva#67;

   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;

   swmira = 0;
   swpcta = 0;
   swpase = 0;
   swmalo = 0;
   swRepite = 0;
   || ... Para Comprobar que todo es correcto
   |SI #cainliva#17 = doce;
       swmalo = 1;
       alfa1 = "    Error. Registro no valido. No Existe Cuenta Contrapartida";
   |FINSI;
   |SI #cainliva#5 = doce;
       swmalo = 1;
       alfa1 = "    Error. Registro no valido. No Existe Cuenta Cliente/Proveeedor";
   |FINSI;
   |SI #cainliva#4 < fDFecha; |O #cainliva#4 > fec2;
       swmalo = 1;
       alfa1 = "    Error. Registro no valido. Fecha Incorrecta";
   |FINSI;
   |SI aElCero = "N"; |Y #cainliva#12 = 0; |Y  #cainliva#14 = 0;
       |Y #cainliva#16 = 0; |Y #cainliva#29 = 0; |Y #cainliva#35 = 0;
       swmalo = 1;
       alfa1 = "    Error. Factura de importe igual a 0";
   |FINSI;
   |SI swmalo = 1;
       |MENAV alfa1;
       |ERROR;
       NumFactura = #cainliva#2; |HAZ DescuentaCont;
       swAmor = 0;
       |ACABA;
   |FINSI;

   |SI swclipro = 1;
      |SI #caivaasi#128 = "S"; |O #caivaasi#129 = "S";
          |HAZ ActCliPro;
      |FINSI;
   |FINSI;
   swclipro = 0;

   |HAZ AbreAmort; swAmor = 0; swAmorC = 0;
   |SI nSwIntra = 1;
       |HAZ LaIntra;
   |SINO;
       |SI #cainliva#62 = "D"; |O #cainliva#29 < 0;
           |HAZ TrataRecti;
       |FINSI;
   |FINSI;

   |SI #caivaasi#92 = "S";
       nSwHay17 = 1;
   |FINSI;
   |SI nSwHay17 = 1;  |HAZ VoyaW17; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI enEjercicio ] 2014;
       |HAZ TrataClaveZ;
   |FINSI;

   |SI #caivaasi#1 = "S";
       enModoEsc = ModoEntrada;
       |SI #cainliva#49 = "S";
           |SI ModoEntrada = 1; |ACABA; |FINSI;
           |SI ModoEntrada = 2; enModoEsc = 3; |FINSI;
       |FINSI;
       |HAZ CreaVtos;
   |FINSI;

   swNuevo     = 0;
   |SI ModoEntrada =  1;
       NumBase = #cainliva#3 + 1;
       |HAZ DatosAnterior;
   |SINO;
       |HAZ ActualOtras;
   |FINSI;
   nSwHay17 = 0;

   |SI #1#54 = "S"; |Y nSwImp = 1;
       |PTEC 826;
       |PTEC 808;
   |FINSI;
   nPrimLin   = 0;
   nMasLin    = 0;
   nswcambio  = 0;

   |HAZ LeeDefIVA;
|FPRC;

|PROCESO LaIntra;
  enLibro    = #cainliva#0;
  enRegistro = #cainliva#1;
  eaSerie    = #cainliva#26;
  enFactura  = #cainliva#2;

  |SI enEjercicio [ 2009;
      |SI eaPer349 = #caivaasi#46;
          enPerIntra = #cainliva#31;
      |SINO;
          Comodin    = #cainliva#4; |QBF Comodin;
          Comodin    = Comodin % 0402;
          enPerIntra = Comodin;
          |SI eaPer349  = "T";
              |SI Comodin ] "01"; |Y Comodin [ "03"; enPerIntra = 1; |FINSI;
              |SI Comodin ] "04"; |Y Comodin [ "06"; enPerIntra = 2; |FINSI;
              |SI Comodin ] "07"; |Y Comodin [ "09"; enPerIntra = 3; |FINSI;
              |SI Comodin ] "10"; |Y Comodin [ "12"; enPerIntra = 4; |FINSI;
          |FINSI;
      |FINSI;
  |SINO;
       enPerIntra = #cainliva#31;
  |FINSI;
  |SI #cainliva#29 < 0; |Y #cainliva#3 = 1;
      |HAZ AltaIntra;
  |FINSI;
|FPRC;

|PROCESO TrataRecti;
    |SI #cainliva#62 ! "D"; |Y ModoEntrada = 1;
        |CONFI "    NImporte Negativo y Clave 340 diferente a <D>. Es una Factura Rectificativa ?";
        |SI FSalida = 0;
            #cainliva#62 = "D"; |PINTA #cainliva#62;
            enConcepto = #cainliva#7;
            |HAZ VeoRecti;
            |SI nSwRecti = 1;
                |MENAV "0000Repase los Conceptos de este Factura";
            |FINSI;
        |FINSI;
    |FINSI;

    |SI #cainliva#62 = "D"; |Y aTipoIVA = "R";
        |PUSHV 0501 2380;
        |BLANCO 1202 2379;
        |CUADRO 1202 2379;
        |PINTA 1318, "CLAVE DEL 340 DE FACTURA RECTIFICATIVA";
        |PINTA 1514, "Introduzca el numero de la factura rectificada";

        aAlfa = #cainliva#68;
        E_inf = "";
        E_sup = "40";
        aAlfa = 1716 ? 1;
        #cainliva#68 = aAlfa;

        |POPV;
    |FINSI;
|FPRC;

|CALCULO paraImp; |TIPO 0;
 nInkey = FSalida;
 |C_M #1Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI nInkey = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;
|FCAL;

|PROCESO paraI;
     |SI nSwImp = 0;
         nSwImp = 1;
         |ATRI P;
         |PINTA 0570, "Imprimir";
         |PINTA 0670, "Autofactura";
         |ATRI 0;
     |SINO;
         nSwImp = 0;
         aAlfa1 = &196 * 08;
         aAlfa2 = "          " + &179
         |PINTA 0570, aAlfa1;
         |PINTA 0670, aAlfa2;
     |FINSI;
|FPRC;

|| /////////////////////////////////////////
|PROCESO BorraAuxW17;
 |BORRA 020#17a;
 |LIBERA #17;
|FPRC;

|DEFBUCLE BorraAuxW17;
 #17#1;
 ;
 en0W17, fechaW17, en2W17, 0001;
 en0W17, fechaW17, en2W17, 9999;
 be;
 NULL, BorraAuxW17;
|FIN;

|PROCESO BorraResto;
     |SI #1#1 = #901#1;  |ACABA;  |FINSI;

     |BORRA 020#901a;
     |LIBERA #901;

     |SI aTipoIVA = "R";
         |SELECT #1#850;
         #850#0 = #901#69;
         |LEE 101#850=;
         |SI FSalida = 0;
             #850#29 = "N";
             |GRABA 020#850a;
             |LIBERA #850;
         |FINSI;
     |FINSI;

     |SI aTipoIVA = "S";
         |SELECT #1#851;
         #851#0 = #901#69;
         |LEE 101#851=;
         |SI FSalida = 0;
             #851#29 = "N";
             |GRABA 020#851a;
             |LIBERA #851;
         |FINSI;
     |FINSI;

     NumFactura = #901#2;
     en0W17     = #901#0;
     en2W17     = #901#1;
     |BUCLE BorraAuxW17;
|FPRC;

|DEFBUCLE BorraResto;
     #901#2004;
     ;
     #caintiva#0, aSerTot, nFacTot, 01;
     #caintiva#0, aSerTot, nFacTot, 99;
     be;
     NULL, BorraResto;
|FIN;

|PROCESO QuitaMarcaDSCOMER;
     |ABRE #caivaasi;
     |LEE 000#caivaasi.p;
     |SI FSalida ! 0; |DDEFECTO #caivaasi; |FINSI;
     |CIERRA #caivaasi;

     |SI #caivaasi#191 = "N";
         |ACABA;
     |FINSI;

     eaSer = #cainliva#26;
     enFac = #cainliva#2;
     eaTip = aTipoIVA;
     |SUB_EJECUTA "gadz0102";
|FPRC;

|PROCESO elTipo1; |TIPO 2;
   enSiiMod = 0 +. 1;
   nMod = (FEntrada / 100) ! 0;
   |SI nMod = 3;  |O enSiiMod = 1;
       |SI aTipoIVA = "R";
           |HAZ TDesglose;
       |FINSI;
   |FINSI;

   |SI #1#69 ! 0;
        nForma = 0 +. 1;

        |SI aTipoIVA = "R";
            |SELECT #1#850;
            #850#0 = #1#69;
            |LEE 101#850=;
            |SI FSalida = 0;
                |SI nForma = 1;
                    #850#29 = "S";
                |SINO;
                    #850#29 = "N";
                |FINSI;
                |GRABA 020#850a;
                |LIBERA #850;
           |FINSI;
        |FINSI;

        |SI aTipoIVA = "S";
            |SELECT #1#851;
            #851#0 = #1#69;
            |LEE 101#851=;
            |SI FSalida = 0;
                |SI nForma = 1;
                    #851#29 = "S";
                |SINO;
                    #851#29 = "N";
                |FINSI;
                |GRABA 020#851a;
                |LIBERA #851;
           |FINSI;
        |FINSI;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 3;
       |SI #1#69 ! 0;
           aSerTot = #1#26;
           nFacTot = #1#2;
           |LIBERA #1;
           |BUCLE BorraResto;
       |FINSI;

       NumFactura = #cainliva#2;
       en0W17 = #cainliva#0;
       en2W17 = #cainliva#1;
       |BUCLE BorraAuxW17;
       |SI #caivaasi#1 = "S";
           enModoEsc = ModoEntrada;
           |SI #cainliva#49 = "S";
               |SI ModoEntrada = 1; |ACABA; |FINSI;
               |SI ModoEntrada = 2; enModoEsc = 3; |FINSI;
           |FINSI;

           |HAZ CreaVtos;
       |FINSI;
       |HAZ DescuentaCont;
       SerieAnt = "XX";

       |SI ModoEntrada = 3; |Y enEjercicio ] 2014;
           |HAZ TrataClaveZ;
       |FINSI;

       |HAZ QuitaMarcaDSCOMER;

       |SI enSwAna = 0;  |ACABA; |FINSI;    || si no es analitica

        alfa1 = #1#58; alfa1 = alfa1 % 103;
        |SI alfa1 = "GRU";
            |ABRE #212;
            #212#0 = #1#0;
            #212#2 = #1#4;
            #212#3 = #1#2;
            #212#4 = #1#58;
            |LEE 101#212=;
            |SI FSalida = 0;
                |BUCLELIN 1NULL#212;
                |BORRA 020#212a;
            |FINSI;
            |LIBERA #212;
            |CIERRA #212;
       |FINSI;
  |FINSI;

  nForma = 0 +. 1;
  |SI nForma = 1;
      |SI nRecoge ! 0;
          |HAZ VariasBases;
      |FINSI;
  |FINSI;

  nRecoge = 0;
|FPRC;

/*
|| |PROCESO Tipo12inl; |TIPO 12;
||      |SI FSalida = 7;  swpase = 0; nRecoge  = 0;  |FINSI;
|| |FPRC;
*/

|CALCULO SalLineas; |TIPO 12;       ||Desde Campo Linea
     nTecla = FSalida;
     |SI nTecla = 7;
         |HAZ DescuentaCont;
         swpase  = 0;
         nRecoge = 0;
         swmira  = 0;
         |ACABA;
     |FINSI;

     |SI #cainliva#3 > 1;  |ACABA;  |FINSI;

     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;

     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     eaSiiPro  = "cainliva";
     enSiiLib  = #cainliva#0;
     enSiiDoc  = #cainliva#1;
     enSiiOpe  = (FEntrada / 100) ! 0;
     enSiiLin  = 0;
     eaSiiSer  = #cainliva#26;
     eaSiiCpt  = #cainliva#7;
     eaSiiCta  = #cainliva#5;
     eaSiiCIF  = #cainliva#30;  |QBF eaSiiCIF;
     eaSiiDes  = #cainliva#8;
     eaSiiUlt  = #cainliva#64;  |QBF eaSiiUlt;
     eaSii340  = #cainliva#62;  |QBF eaSii340;
     eaSiiEje  = #cainliva#4 % -104;
     enSiiPer  = #cainliva#31;
     enSiiRet  = #cainliva#35;
     eaSiiDep  = #cainliva#45;
     eaSiiSub  = #cainliva#47;
     eaSiiCtr  = #cainliva#28;

     |SUB_EJECUTA "casiim01";
|FCAL;

|PROCESO TDesglose;
     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;

     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     enSiiDoc = #cainliva#1;
     |SI #cainliva#3 > 1;
         |ABRE #901;
         |SELECT #2#901;
         #901#0  = #cainliva#0;
         #901#26 = #cainliva#26;
         #901#2  = #cainliva#2;
         #901#3  = 1;
         |LEE 040#901];
         |SI FSalida = 0; |Y #901#0 = #cainliva#0;
            |Y #901#26 = #cainliva#26; |Y #901#2 = #cainliva#2;
             enSiiDoc = #901#1;
         |FINSI;
         |SELECT #1#901;
         |CIERRA #901;
     |FINSI;

     eaSiiPro  = "cainliva";
     enSiiLib  = #cainliva#0;
     enSiiOpe  = (FEntrada / 100) ! 0;
     enSiiLin  = #cainliva#3;
     enSiiIva  = #cainliva#13;
     eaSiiSer  = #cainliva#26;
     eaSiiCpt  = #cainliva#7;
     eaSiiCta  = #cainliva#5;
     eaSiiCIF  = #cainliva#30;  |QBF eaSiiCIF;
     eaSiiDes  = #cainliva#8;
     eaSiiUlt  = #cainliva#64;  |QBF eaSiiUlt;
     eaSii340  = #cainliva#62;  |QBF eaSii340;
     eaSiiEje  = #cainliva#4 % -104;
     enSiiPer  = #cainliva#31;
     enSiiRet  = #cainliva#35;
     eaSiiDep  = #cainliva#45;
     eaSiiSub  = #cainliva#47;
     eaSiiCtr  = #cainliva#28;
     |SUB_EJECUTA "casiim01";
|FPRC;

|CALCULO SalirLineas; |TIPO 0;      ||Desde Campo Linea
   |BLIN 4;
   |HAZ ModLosDefectos;
|FCAL;

|PROCESO CreaCuenta;
     |MENAV "0000No existe el NIF en las cuentas contables. Elija una cuenta a crear";

     |PARA;  |SI;  |HACIENDO;
          eaCodNif  = #1#30; |QBF eaCodNif;
          eaCuenta  = "F*+";
          eaNomCta  = #709#1;
          |HAZ FiltraPuntos;
          |SI eaCuenta ! "";  |SAL;  |FINSI;

          |MENAV "0000Por favor seleccione una cuenta.";
     |SIGUE;

     |ABRE #cacuenta;
     |DDEFECTO #cacuenta;
     #cacuenta#0 = eaCuenta;
     |LEE 141#cacuenta.=;
     |SI FSalida ! 0;
         |DDEFECTO #cacuenta;
         #cacuenta#0 = eaCuenta;
         |GRABA 020#cacuenta.b;
     |FINSI;

     enNivel = dig3;
     #cacuenta#0    = eaCuenta;
     #cacuenta#1    = enNivel;
     #cacuenta#3    = "S";

     |SI aTipoIVA = "R";  #cacuenta#2 = #850#4;  |FINSI;
     |SI aTipoIVA = "S";  #cacuenta#2 = #851#4;  |FINSI;

     nMensa   = 1;
     nMensa9  = 1;
     |HAZ defect1;
     #cacuenta#56   = mesdes;
     #cacuenta#57   = meshas;

     |GRABA 020#cacuenta.a;
     |LIBERA #cacuenta;
     |CIERRA #cacuenta;

     |DDEFECTO #caclipro;
     |ABRE #caclipro;
     |SELECT #1#caclipro;

     |SI aTipoIVA = "R";  #caclipro#23 = "C";  |FINSI;
     |SI aTipoIVA = "S";  #caclipro#23 = "P";  |FINSI;
     #caclipro#10 = #cacuenta#0;
     |LEE 141#caclipro.=;
     |SI FSalida ! 0;
         |DDEFECTO #caclipro;
         |SI aTipoIVA = "R";  #caclipro#23 = "C";  |FINSI;
         |SI aTipoIVA = "S";  #caclipro#23 = "P";  |FINSI;
         #caclipro#10 = #cacuenta#0;
         |GRABA 020#caclipro.b;
     |FINSI;

     #caclipro#0  = #caclipro#10;
     #caclipro#9 = #709#0;
     #caclipro#1 = #709#1;
     Comodin = #709#9; |QBF Comodin;
     |SI Comodin = "";
         #caclipro#2 = #709#2;
     |SINO;
         #caclipro#2 = Comodin + " " + #709#2;
     |FINSI;
     Comodin = #caclipro#2; |QBF Comodin;
     #caclipro#2    = Comodin + ", " + #709#3;
     Comodin = #caclipro#2; |QBF Comodin;
     #caclipro#2    = Comodin + " " + #709#10;
     Comodin = #caclipro#2; |QBF Comodin;
     #caclipro#2    = Comodin + " " + #709#11;

     #caclipro#3    = #709#4;
     #caclipro#4    = #709#5;
     #caclipro#5    = #709#7;
     #caclipro#6    = #709#6;
     #caclipro#7    = #709#8;
     #caclipro#8    = #709#17;
     #caclipro#24   = #709#12;

     #caclipro#44 = #caclipro#2;
     #caclipro#45 = #caclipro#3;
     #caclipro#46 = #caclipro#4;
     #caclipro#47 = #caclipro#5;
     #caclipro#48 = #caclipro#6;
     #caclipro#27 = aPCorreo;
     #caclipro#49 = #caclipro#27
     #caclipro#50 = #caclipro#25;

     |GRABA 020#caclipro.a;
     |LIBERA #caclipro;
     |CIERRA #caclipro;

     |MENAV "0000Creada nueva cuenta contable, revise la cuenta";
|FPRC;

|PROCESO ActualizaNIF;
     |SI nCampo ! 4;
         aAlfa = #709nCampo;  |QBF aAlfa;
         |SI aAlfa = "";  |O aAlfa = "0";
             #709nCampo = aValor;
         |FINSI;
     |SINO;
         |SI #709#4 = 0;  |Y #709#5 = 0;
             aAlfa1 = aValor % 102;
             aAlfa2 = aValor % 303;
             #709#4 = aAlfa1;
             #709#5 = aAlfa2;

             enCodProv = #709#4;  |HAZ LeeProvincia;
             #709#7 = eaProvincia;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaNIF;
     |HAZ LeeNifs;

     |ABRE #709;
     #709#0 = #1#30;
     |LEE 101#709=;
     |SI FSalida ! 0;
         |DDEFECTO #709;
         #709#0 = #1#30;
         |GRABA 020#709b;
     |FINSI;

     |SI aTipoIVA = "R";
         nCampo = 1;   aValor = #850#4;  |HAZ ActualizaNIF;
         nCampo = 12;  aValor = #850#5;  |HAZ ActualizaNIF;
     |FINSI;

     |SI aTipoIVA = "S";
         nCampo = 1;   aValor = #851#4;   |HAZ ActualizaNIF;
         nCampo = 12;  aValor = #851#5;   |HAZ ActualizaNIF;
         nCampo = 2;   aValor = #851#51;  |HAZ ActualizaNIF;
         nCampo = 6;   aValor = #851#53;  |HAZ ActualizaNIF;
         nCampo = 8;   aValor = #851#54;  |HAZ ActualizaNIF;
         nCampo = 17;  aValor = #851#55;  |HAZ ActualizaNIF;
         nCampo = 4;   aValor = #851#52;  |HAZ ActualizaNIF;
     |FINSI;

     |GRABA 020#709a;
     |LIBERA #709;
     |CIERRA #709;
|FPRC;

|PROCESO CargaCampos;
     |ABRE #gadm0004;
     |DDEFECTO #gadm0004;
     |LEE 000#gadm0004.p;
     nConceIRPF = #gadm0004#1;
     aDesIRPF = #gadm0004#2;
     |CIERRA #gadm0004;

     |SI aTipoIVA = "R";
         |SI #850#44 = "N";
              |C_M #cainliva#26, 1, "N";
              |C_M #cainliva#2,  1, "N";

              #1#26 = aSerieArc;
              #1#2  = nFactuArc;
         |SINO;
              |C_M #cainliva#26, 1,snSerie;
              |C_M #cainliva#2,  1, "S";
         |FINSI;

         #1#7  = 700;

         |ABRE #gadm0000;
         #gadm0000#0 = #caintiva#0;
         |LEE 000#gadm0000.=;
         |SI FSalida = 0;
             #1#26     = #gadm0000#2;
             #1#7      = #gadm0000#3;
             nAnterior = #1#7;
             dConc1    = #1#7;
         |FINSI;
         |CIERRA #gadm0000;

         |PINTA #1#26;
         |PINTA #1#7;

         #1#4  = #850#15;    |PINTA #1#4;
         #1#12 = #850#21;    |PINTA #1#12;
         #1#13 = #850#22;    |PINTA #1#13;
         #1#14 = #850#23;    |PINTA #1#14;
         #1#15 = #850#24;    |PINTA #1#15;
         #1#16 = #850#25;    |PINTA #1#16;
         #1#29 = #850#28;    |PINTA #1#29;
         #1#30 = #850#2;     |PINTA #1#30;
         #1#32 = #850#18;    |PINTA #1#32;
         #1#45 = #850#1;     |PINTA #1#45;
         #1#49 = dCoPag;     |PINTA #1#49;
         #1#53 = #850#13;    |PINTA #1#53;
         #1#60 = #850#9;     |PINTA #1#60;
         #1#61 = #850#16;    |PINTA #1#61;
         #1#62 = #850#8;     |PINTA #1#62;
         #1#63 = #850#11;    |PINTA #1#63;
         #1#64 = #850#12;    |PINTA #1#64;
         #1#67 = #850#28;    |PINTA #1#67;
         #1#68 = #850#14;
         aPCorreo = "";

         |SI #850#26 ! 0;
             nAnteriorIRPF = 500;

             #1#39 = "B";       |PINTA #1#39;
             #1#59 = #1#12;     |PINTA #1#59;
             #1#34 = #850#26;   |PINTA #1#34;
             #1#35 = #850#27;   |PINTA #1#35;
             #1#51 = 500;       |PINTA #1#51;
             #1#52 = "RETENCIONES IRPF DEUDORAS";  |PINTA #1#52;
             |MENAV "0000Factura con retencion, revise el concepto.";
         |FINSI;
     |FINSI;

     |SI aTipoIVA = "S";
         |SI #851#44 = "N";
              |C_M #cainliva#26, 1, "N";
              |C_M #cainliva#2,  1, "N";

              #1#26 = aSerieArc;
              #1#2  = nFactuArc;
         |SINO;
              |C_M #cainliva#26, 1,snSerie;
              |C_M #cainliva#2,  1, "S";
         |FINSI;

         #1#7  = 600;

         |ABRE #gadm0000;
         #gadm0000#0 = #caintiva#0;
         |LEE 000#gadm0000.=;
         |SI FSalida = 0;
             #1#26     = #gadm0000#2;
             #1#7      = #gadm0000#3;
             nAnterior = #1#7;
             dConc1    = #1#7;
         |FINSI;
         |CIERRA #gadm0000;

         |PINTA #1#26;
         |PINTA #1#7;

         #1#4  = #851#15;    |PINTA #1#4;
         #1#12 = #851#21;    |PINTA #1#12;
         #1#13 = #851#22;    |PINTA #1#13;
         #1#14 = #851#23;    |PINTA #1#14;
         #1#15 = #851#24;    |PINTA #1#15;
         #1#16 = #851#25;    |PINTA #1#16;
         #1#19 = dDeduc;     |PINTA #1#19;

         ||ARA3939
         ||#1#29 = #851#28;
         #1#29 = #1#12 + #1#14 + #1#16 - #1#35;
         |PINTA #1#29;
         #1#30 = #851#2;     |PINTA #1#30;
         #1#32 = #851#18;    |PINTA #1#32;

         ||Tiquet 4082.327
         aAux = ("00" + #851#1) % -102;
         #1#45 = aAux;     |PINTA #1#45;

         #1#49 = dCoPag;     |PINTA #1#49;
         #1#53 = #851#13;    |PINTA #1#53;
         #1#60 = #851#9;     |PINTA #1#60;
         #1#61 = #851#16;    |PINTA #1#61;
         #1#62 = #851#8;     |PINTA #1#62;
         #1#63 = #851#11;    |PINTA #1#63;
         #1#64 = #851#12;    |PINTA #1#64;
         #1#68 = #851#14;
         aPCorreo = #851#56;

         |HAZ EsComersan;
         |SI FSalida = 0;
             |HAZ CalRefer; |PINTA #1#53;
             #1#72 = #851#13;
         |FINSI;

         |SI #851#26 ! 0;
             nAnteriorIRPF = nConceIRPF;

             #1#39 = #851#71;     |PINTA #1#39;
             |SI #1#39 = "F";
                  #1#59 = #1#12 + #1#14 + #1#16;
             |SINO;
                  #1#59 = #1#12;
             |FINSI;
                                  |PINTA #1#59;
             #1#34 = #851#26;     |PINTA #1#34;
             #1#35 = #851#27;     |PINTA #1#35;
             #1#51 = nConceIRPF;  |PINTA #1#51;
             #1#52 = aDesIRPF;    |PINTA #1#52;
             |MENAV "0000Factura con retencion, revise el concepto.";
         |FINSI;

         ||Lo que se llama total factura es Total Linea == 1#68
         ||#1#29 = #851#28;
         #1#29 = #1#12 + #1#14 + #1#16 - #1#35;
         |PINTA #1#29;
         #1#67 = #1#29;    |PINTA #1#67;
     |FINSI;

     nSwYaTengoTipo = 0;
     ||ARACCC
     ||Tiquet 35.835

     |ABRE #gadm0000;
     #gadm0000#0 = #caintiva#0;
     |LEE 000#gadm0000.=;
     |SI FSalida = 0;
          nTipoIVA = #gadm0000#6;
          |SI nTipoIVA ! 0;
               efFechaIVA = #1#4;
               enLineaIVA = nTipoIVA;
               |HAZ SacaIVA;
               |SI enPorcIVA = #1#13;
                    #1#10 = nTipoIVA;
                    nSwYaTengoTipo = 1;
               |FINSI;
          |FINSI;
          |SI nSwYaTengoTipo = 0;
               nTipoIVA = #gadm0000#7;
               |SI nTipoIVA ! 0;
                    efFechaIVA = #1#4;
                    enLineaIVA = nTipoIVA;
                    |HAZ SacaIVA;
                    |SI enPorcIVA = #1#13;
                         #1#10 = nTipoIVA;
                         nSwYaTengoTipo = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #gadm0000;

     |SI nSwYaTengoTipo = 0;
          efFechaIVA = #1#4;  enLineaIVA = 0;
          enPorcIVA  = #1#13; enPorcREC  = #1#15;
          |HAZ BuscaTipoIVA; #1#10 = enLineaIVA;
     |FINSI;

     |HAZ CreaNIF;

     #1#69 = nRecoge;

     |ABRE #caclipro;
     |SELECT #4#caclipro;
     #caclipro#9 = #1#30;
     |LEE 000#caclipro.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #caclipro#9 ! #1#30;  |SAL;  |FINSI;

          |SI aTipoIVA = "R";
              |SI #caclipro#23 = "C";
                  #1#5 = #caclipro#10;
                  |PINTA #1#5;
                  |SAL;
              |FINSI;
          |FINSI;

          |SI aTipoIVA = "S";
              |SI #caclipro#23 = "P";
                  #1#5 = #caclipro#10;
                  |PINTA #1#5;
                  |SAL;
              |FINSI;
          |FINSI;

          |LEE 000#caclipro.s;
     |SIGUE;

     |SELECT #1#caclipro;
     |CIERRA #caclipro;

     FechaAnt      =  #cainliva#4;
     dTiva         =  #cainliva#10;
     dInver        =  #cainliva#32;
     dDeduc        =  #cainliva#19;
     #caivaasi#19  =  #cainliva#45;
     #caivaasi#67  =  #cainliva#47;
     dCoPag        =  #cainliva#49;
     dTIrpf        =  #cainliva#39;
     eDCl340       =  #cainliva#62;
     #cainliva#7   =  nAnterior;
     swpcta        = 1;

     aAlfa         = #1#5;   |QBF aAlfa;
     |SI aAlfa = "";
         |HAZ CreaCuenta;
         #1#5 = #caclipro#10;
         |PINTA #1#5;
     |FINSI;
|FPRC;

|CALCULO AntesSerie; |TIPO 7;

   ModoEntrada = (FEntrada / 100) ! 0;

   |SI ModoEntrada = 1; |Y #cainliva#26 = "     ";
       #cainliva#26 = dSerie;
       |SI #caivaasi#184 = "S"; |Y SerieAnt ! ""; |Y SerieAnt ! "XX";
           |SI SerieAnt ! "XX";
               #cainliva#26 = SerieAnt;
           |FINSI;
       |FINSI;
       |PINTA #cainliva#26;
   |FINSI;

   #cainliva#50 = aTipoIVA;

   |SI nDSARCHI = 1;
       |ESTADO_CONTROL nBoton1, "DISABLE";
       |ESTADO_CONTROL nBoton2, "DISABLE";
   |FINSI;

   |SI nRecoge ! 0;
       |SI aSerieArc ! 0;
           #cainliva#26 = aSerieArc;
           |PINTA #cainliva#26;
           aSerieArc = "";
       |FINSI;

       |ESTADO_CONTROL nBoton2, "ENABLE";

       |SI aTipoIVA = "R";
           |SELECT #1#850;
           #850#0 = nRecoge;
           |LEE 000#850=;
           |SI FSalida ! 0;  |ACABA;  |FINSI;

           |HAZ CargaCampos;
       |FINSI;

       |SI aTipoIVA = "S";
           |SELECT #1#851;
           #851#0 = nRecoge;
           |LEE 000#851=;
           |SI FSalida ! 0;  |ACABA;  |FINSI;

           |HAZ CargaCampos;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO TrasSerie; |TIPO 0;
   aSerCon = SerieAnt;
   |C_M #cainliva#26,0,aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI aSerCon ! #cainliva#26; |Y ModoEntrada = 1;
       |SI swmira = 1;
           aAlfa1 = #cainliva#26;
           #cainliva#26 = aSerCon;
           |HAZ DescuentaCont;
           #cainliva#26 = aAlfa1;
           swpase = 0;
       |FINSI;
   |FINSI;
|FCAL;
||----------------------------------------------------
|CALCULO AntesFactura; |TIPO 7;   ||Desde Numero Orden

   |SI nFactuArc ! 0;
       #cainliva#2 = nFactuArc;
       |PINTA #cainliva#2;
       nFactuArc = 0;
       |ACABA;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1; |Y swpase = 0;
       |HAZ BuscaNumero;
       swpase = 1;
       #cainliva#2 = NumFactura;
       |PINTA #cainliva#2;
   |FINSI;

|FCAL;

|PROCESO BuscaFactAnt;
 |SI nSwOp = 0;
     |SI nEstaLin ! #901#1;
         NumBase = #901#3 + 1;
         |PARA nPara1 = 0; |SI nPara1 [ 58; |HACIENDO nPara1 = nPara1 + 1;
               #cainliva#nPara1# = #901nPara1;
         |SIGUE;
         #cainliva#72 = #901#72;
         #cainliva#61 = #901#61;
         #cainliva#62 = #901#62;
         #cainliva#63 = #901#63;
         #cainliva#64 = #901#64;
         #cainliva#60 = #901#60;
         #cainliva#68 = #901#68;
         #cainliva#69 = #901#69;
         #cainliva#73 = #901#73;
         |HAZ DatosAnterior;
      |FINSI;
  |FINSI;
  |SI nSwOp = 1;
      |SI nPrimLin = 0; nPrimLin = #901#1; |FINSI;
      nMasLin = nMasLin + 1;
  |FINSI;
  |SI nSwOp = 2;
     |SI nEstaLin ! #901#1;
         #901#4  = #cainliva#4;
         #901#31 = #cainliva#31;
         #901#5  = #cainliva#5;
         #901#6  = #cainliva#6;
         #901#30 = #cainliva#30;
         #901#27 = #cainliva#27;
         #901#45 = #cainliva#45;
         #901#46 = #cainliva#46;
         #901#47 = #cainliva#47;
         #901#48 = #cainliva#48;
         #901#53 = #cainliva#53;
         #901#61 = #cainliva#61;
         #901#62 = #cainliva#62;
         #901#63 = #cainliva#63;
         #901#64 = #cainliva#64;
         #901#65 = #cainliva#65;
         #901#72 = #cainliva#72;
         |GRABA 020#901a;
     |FINSI;
  |FINSI;

  |SI nSwOp = 3;
     |SI nEstaLin ! #901#1;
         NumBase = #901#3 + 1;

         |SI nPrimLin  = 0;
             nPrimLin  = #901#1;
             nswcambio = 0;
             |SI #cainliva#4  ! #901#4;  nswcambio = 1; |FINSI;
             |SI #cainliva#5  ! #901#5;  nswcambio = 1; |FINSI;
             |SI #cainliva#30 ! #901#30; nswcambio = 1; |FINSI;
             |SI #cainliva#31 ! #901#31; nswcambio = 1; |FINSI;
             |SI #cainliva#62 ! #901#62; nswcambio = 1; |FINSI;
             |SI nswcambio = 1;
                 |ERROR10;
             |FINSI;
         |FINSI;
     |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE BuscaFactAnt;
 #901#2004;
 ;
 #caintiva#0, Serie, factura, 01;
 #caintiva#0, Serie, factura, 99;
 e;
 NULL,BuscaFactAnt;
|FIN;

|PROCESO ActualOtras;
 |SI nPrimLin = #cainliva#1; |Y nswcambio = 1; |Y nMasLin > 1;
     nEstaLin = #cainliva#1;
     nSwOp    = 2;
     Serie    = #cainliva#26;
     factura  = #cainliva#2;
     |BUCLE BuscaFactAnt;
 |FINSI;
|FPRC;

|CALCULO TrasFactura;  |TIPO 0;
   |SI FSalida = 2;
       nFacCon = Contenido;
       #cainliva#2 = nFacCon; |PINTA #cainliva#2;
       swmira = 1;
       |ACABA;
   |FINSI;

   nFacCon     = Contenido;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada =  1;

          |SI #cainliva#2 ! NumFactura;
              |HAZ DescuentaCont;
          |FINSI;

          |SI #cainliva#26 ! SerieAnt; |O #cainliva#2 ! FacturaAnt;
              |SI swNuevo = 0;
                  nSwOp      = 0;
                  factura    = #cainliva#2;
                  Serie      = #cainliva#26;
                  nEstaLin   = #cainliva#1;
                  |SALVA_FICHA #cainliva;

                  |BUCLE BuscaFactAnt;

                  |REPON_FICHA #cainliva;
              |FINSI;
          |FINSI;

          |SI FacturaAnt = #cainliva#2; |Y SerieAnt = #cainliva#26;   ||Otra linea
              #cainliva#3 = NumBase;   |PINTA #cainliva#3;  |C_M #cainliva#3,1,"N";
              #cainliva#4 = FechaAnt;  |PINTA #cainliva#4;  |C_M #cainliva#4,1,"N";
              #cainliva#5 = CuentaAnt; |PINTA #cainliva#5;  |C_M #cainliva#5,1,"N";
              #cainliva#6 = DigitoAnt;
              #cainliva#31 = PerioAnt; |PINTA #cainliva#31; |C_M #cainliva#31,1,"N";
              #cainliva#53 = ReferAnt; |PINTA #cainliva#53; |C_M #cainliva#53,1,"N";
              #cainliva#72 = RefPrAnt;
              #cainliva#27 = ClienAnt; |PINTA #cainliva#27; |C_M #cainliva#27,1,"N";
              #cainliva#30 = CifAnt;   |PINTA #cainliva#30; |C_M #cainliva#30,1,"N";
              #cainliva#7  = ConceptoAnt; |PINTA #cainliva#7;
              #cainliva#8  = DescAnt;     |PINTA #cainliva#8;
              #cainliva#45 = DeparAnt;  |PINTA #cainliva#45; |SI eaMulDep ! "S"; |C_M #cainliva#45,1,"N"; |FINSI;
              #cainliva#46 = NDeparAnt; |PINTA #cainliva#46;
              #cainliva#47 = SubdeAnt;  |PINTA #cainliva#47; |SI eaMulDep ! "S"; |C_M #cainliva#47,1,"N"; |FINSI;
              #cainliva#48 = NSubdeAnt; |PINTA #cainliva#48;
              #cainliva#10 = dTiva;     |PINTA #cainliva#10;
              #cainliva#40 = aCamp40;   |PINTA #cainliva#40; |C_M #cainliva#40,1,"N";
              #cainliva#73 = fCamp73;   |PINTA #cainliva#73; |C_M #cainliva#73,1,"N";
              #cainliva#41 = nCamp41;
              #cainliva#42 = aCamp42;
              #cainliva#43 = nCamp43;
              #cainliva#44 = aCamp44;
              #cainliva#49 = aCamp49;   |PINTA #cainliva#49; |C_M #cainliva#49,1,"N";
              #cainliva#39 = aCamp39;   |PINTA #cainliva#39;
              #cainliva#57 = aCamp57;   |PINTA #cainliva#57;
              #cainliva#19 = aCamp19;   |PINTA #cainliva#19;
              #cainliva#60 = nCamp60;   |PINTA #cainliva#60; |C_M #cainliva#60,1,"N";
              #cainliva#61 = fCamp61;   |PINTA #cainliva#61;
              #cainliva#62 = aCamp62;   |PINTA #cainliva#62; |C_M #cainliva#62,1,"N";
              #cainliva#63 = aCamp63;   |PINTA #cainliva#63; |C_M #cainliva#63,1,"N";
              #cainliva#64 = aCamp64;   |PINTA #cainliva#64; |C_M #cainliva#64,1,"N";
              #cainliva#65 = CuentaAnt; |PINTA #cainliva#65;
              #cainliva#68 = aCamp68;

              nAnterior = #cainliva#7;
          |SINO;
              #cainliva#3 = 1;          |PINTA #cainliva#03;
              |SI FechaAnt > " "; #cainliva#4 = FechaAnt; |PINTA #cainliva#4; |FINSI;
              |HAZ DefPeriodo;
              #cainliva#31 = ComodNum;       |PINTA #cainliva#31;
              || ...  NumBase = 1;
              #cainliva#7  = dConc1;         |PINTA #cainliva#07;
              #cainliva#8  = dDesc1;         |PINTA #cainliva#08;
              #cainliva#10 = dTiva;          |PINTA #cainliva#10;
              #cainliva#32 = dInver;         |PINTA #cainliva#32;
              #cainliva#19 = dDeduc;         |PINTA #cainliva#19;
              #cainliva#45 = #caivaasi#19;   |PINTA #cainliva#45;
              #cainliva#47 = #caivaasi#67;   |PINTA #cainliva#47;
              #cainliva#49 = dCoPag;         |PINTA #cainliva#49;
              #cainliva#39 = dTIrpf;         |PINTA #cainliva#39;
              #cainliva#62 = eDCl340;        |PINTA #cainliva#62;
              nAnterior = #cainliva#7;

              |HAZ CalRefer;
          |FINSI;
   |SINO;
          |SI nFacCon ! #cainliva#2;
              |CONFI "    NHa cambiado el numero de Factura. Es correcto S/N";
              |SI FSalida ! 0;
                  #cainliva#2 = nFacCon; |PINTA #cainliva#2;
                  |ERROR;
                  |ACABA;
              |SINO;
                   |C_M #cainliva#3, 1, "S";
                   nSwOp      = 3;
                   factura    = #cainliva#2;
                   Serie      = #cainliva#26;
                   nEstaLin   = #cainliva#1;
                   nPrimLin   = 0;
                   |SALVA_FICHA #cainliva;
                   |BUCLE BuscaFactAnt;
                   |REPON_FICHA #cainliva;
                   |SI nswcambio = 1;
                       |MENAV "0000No corresponden campos con la Factura Indicada. No puede cambiar el Numero de Factura";
                       #cainliva#2 = nFacCon; |PINTA #cainliva#2;
                       |ERROR;
                       |ACABA;
                   |SINO;
                       |SI nPrimLin ! 0;
                           |C_M #cainliva#3, 1, "N";
                           #cainliva#3 = NumBase; |PINTA #cainliva#3;
                       |FINSI;
                   |FINSI;
              |FINSI;
          |FINSI;

          nSwOp      = 1;
          factura    = #cainliva#2;
          Serie      = #cainliva#26;
          nEstaLin   = #cainliva#1;

          nPrimLin   = 0;
          nMasLin    = 0;
          nswcambio  = 0;
          |SALVA_FICHA #cainliva;
          |BUCLE BuscaFactAnt;
          |REPON_FICHA #cainliva;
          |SI nPrimLin ! nEstaLin;
              |C_M #cainliva#4,1,"N";
              |C_M #cainliva#5,1,"N";
              |C_M #cainliva#31,1,"N";
              |C_M #cainliva#53,1,"N";
              |C_M #cainliva#27,1,"N";
              |C_M #cainliva#30,1,"N";
              |C_M #cainliva#60,1,"N";
              |C_M #cainliva#62,1,"N";
              |C_M #cainliva#63,1,"N";
              |C_M #cainliva#64,1,"N";
              |SI eaMulDep ! "S"; |C_M #cainliva#45,1,"N"; |FINSI;
              |SI eaMulDep ! "S"; |C_M #cainliva#47,1,"N"; |FINSI;
              |HAZ DatosAnterior;
              nAnterior  = #cainliva#7;
          ||    aAntesDes0 = #cainliva#8;
         |SINO;
              |HAZ DatosAnterior;
              nAnterior  = #cainliva#7;
         |FINSI;
   |FINSI;

   |HAZ PintaTotal;
   |HAZ PintaCobro;
   swmira = 0;
|FCAL;

|PROCESO PintaCobro;
    |SI #cainliva#49 ! "N"; |Y #cainliva#49 ! " ";
        alfa1 = "C.Cobro:"; |SI aTipoIVA = "S"; alfa1 = "C.Pago :"; |FINSI;
        |SI #cainliva#49 = "T";
            alfa1 = "Cta Ef.:";
        |FINSI;
        |ATRI S; |PINTA 1802, alfa1; |ATRI 0;
        |C_V #cainliva#40,1,"S"; |PINTA #cainliva#40;
        |ATRI S; |PINTA 1824, "a"; |ATRI 0;
        alfa1 = snFecEf; |SI #cainliva#3 > 1; alfa1 = "N"; |FINSI;
        |C_M #cainliva#73, 1, alfa1;
        |C_V #cainliva#73, 1, "S"; |PINTA #cainliva#73;
    |SINO;
        |C_V #cainliva#40,1,"N";
        |C_V #cainliva#73,1,"N";
        |C_M #cainliva#73,1,"N";
        |PINTA 1802, "";
    |FINSI;
|FPRC;

||----------------------------------------------------
|PROCESO DefPeriodo;
       Comodin = #cainliva#4; |QBF Comodin;
       Comodin = Comodin % 0402;
       |SI enEjercicio [ 2009;
           |SI #caivaasi#46 = "T";
               |SI Comodin ] "01"; |Y Comodin [ "03"; Comodin = "01"; |FINSI;
               |SI Comodin ] "04"; |Y Comodin [ "06"; Comodin = "02"; |FINSI;
               |SI Comodin ] "07"; |Y Comodin [ "09"; Comodin = "03"; |FINSI;
               |SI Comodin ] "10"; |Y Comodin [ "12"; Comodin = "04"; |FINSI;
           |SINO;
               |SI #caivaasi#46 = "A"; Comodin = "00"; |FINSI;
           |FINSI;
       |FINSI;
       ComodNum = Comodin;
|FPRC;

|CALCULO TrasFecha; |TIPO 0;   || Desde Fecha
   nInkey = FSalida;
   |C_M #cainliva#61, 1, "N";
   |SI nInkey = 10; |O #cainliva#61 ! "01.01.0000";
        |C_M #cainliva#61, 1, "S";
   |FINSI;

   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   |C_M #cainliva#4,0,alfa1;
   |SI alfa1 = "S";

       |SI #cainliva#4 < fDFecha; |O #cainliva#4 > fec2;
           |MENAV mensa1;
           |ERROR;
           |ACABA;
       |SINO;
           |SI #cainliva#4 [ fec3;
               |MENAV mensa2;
               |SI enSwSelFc = 0;
                   |ERROR;
                   |ACABA;
               |FINSI;
           |FINSI;
       |FINSI;

       |HAZ DefPeriodo;
       fFecha1 = Contenido;
       |SI fFecha1 ! #cainliva#4;
           #cainliva#31 = ComodNum; |PINTA #cainliva#31;
           nswcambio = 1;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO FechaOp; |TIPO 7;
 |SI #cainliva#3 ! 1;
     |C_M #cainliva#61,1,"N";
 |FINSI;

 |C_M #cainliva#61,0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #cainliva#61 = "01.01.0000";
     #cainliva#61 = #cainliva#4; |PINTA #cainliva#61;
 |FINSI;
|FCAL;

||----------------------------------------------------
|CALCULO AntesCuenta; |TIPO 7;             ||Cuenta Cli/Pro
   nPulsoF9 = 0;
   |C_M #cainliva#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada ! 1; |ACABA; |FINSI;
   |SI swpcta = 1; |ACABA; |FINSI;

  |SI aTipoIVA = "S";
      alfa1 = "40";
      |SI #dsmom030#18 = "S"; alfa1 = #dsmom030#62; |FINSI;
  |SINO;
      alfa1 = "43";
      |SI #dsmom030#19 = "S"; alfa1 = #dsmom030#67; |FINSI;
  |FINSI;
  |QBT alfa1;
  |SI alfa1 ! "";
      alfa2 = (alfa1 + "0000") % 104;
      alfa2 = alfa1 + ".       "
  |SINO;
      alfa2 = "";
  |FINSI;
  #cainliva#Campo# = alfa2;
  |PTEC 816;
  swpcta = 1;
|FCAL;

|CALCULO Cuenta; |TIPO 6;             || Cuenta Cli/Pro y Contrapartida
   aGuarda = eaCtaIVA;
   |SI Campo = 5; swRepite = 0; |FINSI;
   |C_M #cainliva#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   |SI FSalida = 2; |ACABA; |FINSI;

   |SI FSalida = 11; |HAZ Perepetir; |ACABA; |FINSI;

   |SI FSalida = 10; || ... extractos
       ext1 = #cainliva#5;          || cuenta
       ext2 = #cainliva#6;          || digito
       |HAZ externos;
       |ERROR;
       |ACABA;
   |FINSI;

   |SI FSalida = 15;
       |SI Campo = 5;
           #cainliva#Campo# = CuentaAnt;
       |FINSI;
       |SI Campo = 17;
           #cainliva#Campo# = aCamp17;
           #cainliva#18 = nCamp18;
       |FINSI;
       |PINTA #cainliva#Campo#;
   |FINSI;

   |SI FSalida = 9; |Y Campo = 5;
        nPulsoF9 = 1;
        aCta = #cainliva#5;
        |SUB_EJECUTA_NP "cacugen1";
        |SI enSwBUENO = 0;
            #cainliva#5 = eaCuenta;
            |PINTA #cainliva#Campo#;
        |SINO;
            nPulsoF9 = 0;
            |ERROR;
        |FINSI;
        |ACABA;
   |FINSI;


   |SI Campo = 40; |Y #cainliva#49 = "N"; |ACABA; |FINSI;

   eaCuenta = #cainliva#Campo#;
   salidas  = FSalida;
   |HAZ FiltraPuntos;
   #cainliva#Campo# = eaCuenta;
   |PINTA #cainliva#Campo#;

   |SI #cainliva#Campo# = "            ";
       |MENAV "0000Introduzca una cuenta";
       |ERROR;
   |FINSI;

   eaCtaIVA = aGuarda;
|FCAL;

|CALCULO TrasPer; |TIPO 0;
  |C_M #cainliva#Campo#,0,alfa1;
  |SI FSalida = 2; |ACABA; |FINSI;

  |SI Contenido ! #cainliva#Campo#; nswcambio = 1; |FINSI;

  ModoEntrada = (FEntrada / 100) ! 0;
  |SI enSi303 = 1; |Y #caivaasi#167 ! "X"; |Y ModoEntrada = 1;
      eSwReten = 0;
      enPanMod = 0;
      eaFecMod = "";
      enPerMod = #cainliva#31;
      |HAZ ConsulModIVA;
      |SI enEmiMod = 1; |Y #caivaasi#167 ! "S";
          |SI alfa1 = "N";
              |C_M #cainliva#Campo#,1,"S";
              |PTEC 808;
          |SINO;
              |ERROR;
          |FINSI;
      |FINSI;
  |FINSI;
|FCAL;

|CALCULO TrasCuenta; |TIPO 0;
   eaCtaIVA = aGuarda;
   |C_M #cainliva#Campo#,0,alfa1;
   |SI alfa1 = "N";
       |SI Campo = 5;
           |SI #cainliva#3 > 01;
               |HAZ LeeLaContra;
           |FINSI;
       |FINSI;
       |SI Campo ! 40;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI Contenido ! #cainliva#Campo#; nswcambio = 1; |FINSI;

   |SI swRepite = 1; |ACABA; |FINSI;

   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   emCta    = 1;
   eaCuenta = #cainliva#Campo#;
   |HAZ SacaNivel;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
   nNume1 = Campo + 1;
   #cainliva#nNume1# = enNivel;

   |HAZ LeeCuenta;
   |SI eswCta ! 0; |ACABA; |FINSI;

   enConcepto = #cainliva#7;
   |SI Campo = 5;    || Leer Proveedor/Cliente
       |HAZ FiltraCtaCP;
       |SI eswLect = 0;
           |ABRE #caclipro;
           |SI aTipoIVA = "R";
               #caclipro#23 = "C";
           |SINO;
               #caclipro#23 = "P";
           |FINSI;
           aCPartida = "";
           nCTiva    = 0;
           nConIRPF  = 0;
           swclipro  = 0;
           #caclipro#10 = #cainliva#5;
           #caclipro#11 = #cainliva#6;
           |LEE 000#caclipro.=;
           |SI FSalida = 0;
               #cainliva#27 = #caclipro#1;
               #cainliva#30 = #caclipro#9;
               aCPartida = #caclipro#21; |QBF aCPartida;
               nCTiva    = #caclipro#42;
               |SI snReten ! "N";
                   nConIRPF = #caclipro#52;
               |FINSI;
               |SI aCPartida = ""; |O nCTiva = 0; swclipro = 1; |FINSI;
           |SINO;
               #cainliva#27 = #cacuenta#2;
               #cainliva#30 = "";
               |C_M #cainliva#30,1,"S";  || No tengo el nif.
           |FINSI;
           |CIERRA #caclipro;

           |PINTA #cainliva#27;
           |PINTA #cainliva#30;
           |HAZ ImprContra;
       |FINSI;
   |SINO;
       |SI Campo = 17;
           |HAZ FiltraCtaIG;
           #cainliva#28 = #cacuenta#2; |PINTA #cainliva#28;
       |SINO;
           |HAZ CuentaCobro;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesDni;  |TIPO 7;
   |SI swRepite ! 1;
       |SI #caivaasi#35 = "F"; |Y nSwClPr = 0; |PTEC 827; |FINSI;
   |FINSI;
   |HAZ AntesQue;
   nSwClPr = 0;
|FCAL;

|CALCULO TrasNombre;
   |SI FSalida = 2;
       |SI #caivaasi#35 = "F"; nSwClPr = 1; |FINSI;
       |ACABA;
   |FINSI;
   |SI FSalida = 13;
       raf_cue = #cainliva#5;
       raf_dig = #cainliva#6;
       raf_des = #cainliva#27;
       raf_nif = #cainliva#30;
       raf_sw  = 0;
       tipoalta = "C"; |SI aTipoIVA = "S"; tipoalta = "P"; |FINSI;
       |SUB_EJECUTA_NP "caclipr1";
       #cainliva#27 = raf_des; |PINTA #cainliva#27;
       #cainliva#30 = raf_nif; |PINTA #cainliva#30;
       |SI raf_sw = 0;
           |ERROR; |PTEC 808;
       |SINO;
            |HAZ LeeLaContra;
       |FINSI;
   |FINSI;
|FCAL;

|PROCESO LeeLaContra;
     |ABRE #caclipro;
     |SI aTipoIVA = "R";
         #caclipro#23 = "C";
     |SINO;
         #caclipro#23 = "P";
     |FINSI;
     aCPartida = "";
     nCTiva    = 0;
     nConIRPF  = 0;
     swclipro  = 0;
     #caclipro#10 = #cainliva#5;
     #caclipro#11 = #cainliva#6;
     |LEE 000#caclipro.=;
     |SI FSalida = 0;
         aCPartida = #caclipro#21; |QBF aCPartida;
         nCTiva    = #caclipro#42;
         |SI snReten ! "N";
             nConIRPF = #caclipro#52;
         |FINSI;
         |SI aCPartida = ""; |O nCTiva = 0; swclipro = 1; |FINSI;
     |FINSI;
     |CIERRA #caclipro;
     |HAZ ImprContra;
|FPRC;

|PROCESO ImprContra;
       nSw = 1;
       |SI #cainliva#7 = nAnterior; |Y #cainliva#5 = CuentaAnt; nSw = 0; |FINSI;
       |SI ModoEntrada = 1; nSw = 1; |FINSI;
|SI nSw = 1;
       |QBF aCPartida;
       |SI aCPartida ! "";
           #cainliva#17 = aCPartida;
           |PINTA #cainliva#17;
           emCta    = 0;
           eaCuenta = #cainliva#17;
           |HAZ SacaNivel;
           #cainliva#18 = enNivel;
           |HAZ LeeCuenta;
       |FINSI;
       |SI eswCta ! 0; |O aCPartida = "";
           #cainliva#17 = eaCtaIVA;
           |PINTA #cainliva#17;
           emCta    = 0;
           eaCuenta = #cainliva#17;
           |HAZ SacaNivel;
           #cainliva#18 = enNivel;
           |HAZ LeeCuenta;
       |FINSI;
       |SI eswCta ! 0;
           |C_M #cainliva#17,1,"S";
       |SINO;
           #cainliva#28 = #cacuenta#2; |PINTA #cainliva#28;
       |FINSI;

       |SI nConIRPF ! 0; |O aObligado ! "S";
           #cainliva#51 = nConIRPF; |PINTA #cainliva#51;
       |FINSI;
       nAnteriorIRPF = 0;
|FINSI;
       |SI nCTiva ! 0;
           |SI #cainliva#10 ! nCTiva;
               #cainliva#10 = nCTiva; |PINTA #cainliva#10;
               nNoSalta = 1; |HAZ TrasTipoIVA; nNoSalta = 0;
           |FINSI;
       |FINSI;
|FPRC;

|| ----------------------------------------------
|PROCESO Tipo7C62;  |TIPO 7;
   |SI enEjercicio > 2011;
       aAlfa1 = "<*> No se pasa al 340.";
   |SINO;
       aAlfa1 = "<X> No se pasa al 340.";
   |FINSI;
   aAlfa1 = "    <F11> para consultar Tipo Operaciones Mod. 340." + aAlfa1;
   |MENSA aAlfa1;
|FPRC;

|PROCESO Tipo66C62;  |TIPO 66;
     aAlfa = "|C062WID";
     aID   = #cainliva#aAlfa#;
     nID   = aID;

     aPopup1  = nID;  || Si fuera -1 en la posicion
     |SI aTipoIVA = "S";
         |SI enEjercicio [ 2011;
             aPopup2  = 14;
         |SINO;
             aPopup2  = 18;
             |SI enEjercicio ] 2014;
                 aPopup2  = 27;
             |FINSI;
         |FINSI;
         aPopup3  = "  Operacin habitual";
         aPopup4  = "A Asiento resumen de facturas";
         aPopup5  = "B Asiento resumen de tiques";
         aPopup6  = "C Factura con varios asientos (varios tipo impositivos)";
         aPopup7  = "D Factura rectificativa";
         aPopup8  = "F Adquisiciones realizadas por las agencias de viajes directamente en inters del viajero ";
         aPopup9  = "G Rgimen especial de grupo de entidades en IVA o IGIC";
         aPopup10 = "H Rgimen especial de oro de inversin";
         aPopup11 = "I Inversin del Sujeto pasivo (ISP)";
         aPopup12 = "J Tiques";
         aPopup13 = "K Rectificacin anotaciones registrales";
         aPopup14 = "L Adquisiciones a comerciantes minoristas del IGIC";
         aPopup15 = "P Adquisiciones intracomunitarias de bienes.";
         aPopup16 = "Q Operaciones a las que se aplique el rgimen especial de bienes usados, ...";
         |SI enEjercicio > 2011;
             aPopup17 = "R Operacin de arrendamiento de local de negocio.";
             aPopup18 = "S Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones pblicas o entidades privadas.";
             aPopup19 = "W Operaciones sujetas al Impuesto sobre la Produccin, los Servicios y la Importacin en las Ciudades de Ceuta y Melilla.";
             aPopup20 = "X Operaciones por las que los empresarios o profesionales que satisfagan compensaciones agrcolas hayan expedido el recibo";
             |SI enEjercicio ] 2014;
                 aPopup21 = "Z Operaciones en Rgimen especial de criterio de caja";
                 aPopup22 = "1 IVA criterio de caja. Asiento resumen de facturas";
                 aPopup23 = "2 IVA criterio de caja. Factura con varios asientos";
                 aPopup24 = "3 IVA criterio de caja. Factura rectificativa";
                 aPopup25 = "4 IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes en inters del viajero";
                 aPopup26 = "5 IVA criterio de caja. Factura simplificada";
                 aPopup27 = "6 IVA criterio de caja. Rectificacin de errores registrales";
                 aPopup28 = "7 IVA criterio de caja. Facturacin de las prestaciones de servicios de agencias de viajes";
                 aPopup29 = "8 IVA criterio de caja. Operacin de arrendamiento de local de negocio";
             |FINSI;
         |FINSI;
     |SINO;
         aPopup1  = nID;  || Si fuera -1 en la posicion
         |SI enEjercicio [ 2011;
             aPopup2  = 15;
         |SINO;
             aPopup2  = 21;
             |SI enEjercicio ] 2014;
                 aPopup2  = 30;
             |FINSI;
         |FINSI;
         aPopup3  = "  Operacin habitual";
         aPopup4  = "A Asiento resumen de facturas";
         aPopup5  = "B Asiento resumen de tiques";
         aPopup6  = "C Factura con varios asientos (varios tipo impositivos)";
         aPopup7  = "D Factura rectificativa";
         aPopup8  = "E IVA devengado pendiente de emitir factura";
         aPopup9  = "G Rgimen especial de grupo de entidades en IVA o IGIC";
         aPopup10 = "H Rgimen especial de oro de inversin";
         aPopup11 = "I Inversin del Sujeto pasivo (ISP)";
         aPopup12 = "J Tiques";
         aPopup13 = "K Rectificacin anotaciones registrales";
         aPopup14 = "M IVA facturado pendiente de devengar (emitida factura)";
         aPopup15 = "N Facturacin de las prestaciones de servicios de agencias de viaje que actan como mediadoras en nombre y por cuenta ajena";
         aPopup16 = "O Factura emitida en sustitucin de tiques facturados y declarados.";
         aPopup17 = "Q Operaciones a las que se aplique el rgimen especial de bienes usados, ...";
         |SI enEjercicio > 2011;
             aPopup18 = "R Operacin de arrendamiento de local de negocio.";
             aPopup19 = "S Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones pblicas o entidades privadas.";
             aPopup20 = "T Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ...";
             aPopup21 = "U Operacin de seguros.";
             aPopup22 = "V Compras de Agencias viajes: operaciones de prestacin de servicios de mediacin en nombre y por cuenta ajena relativos ...";
             aPopup23 = "W Operaciones sujetas al Impuesto sobre la Produccin, los Servicios y la Importacin en las Ciudades de Ceuta y Melilla.";
             |SI enEjercicio ] 2014;
                 aPopup24 = "Z Operaciones en Rgimen especial de criterio de caja";
                 aPopup25 = "1 IVA criterio de caja. Asiento resumen de facturas";
                 aPopup26 = "2 IVA criterio de caja. Factura con varios asientos";
                 aPopup27 = "3 IVA criterio de caja. Factura rectificativa";
                 aPopup28 = "4 IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes en inters del viajero";
                 aPopup29 = "5 IVA criterio de caja. Factura simplificada";
                 aPopup30 = "6 IVA criterio de caja. Rectificacin de errores registrales";
                 aPopup31 = "7 IVA criterio de caja. Facturacin de las prestaciones de servicios de agencias de viajes";
                 aPopup32 = "8 IVA criterio de caja. Operacin de arrendamiento de local de negocio";
             |FINSI;
         |FINSI;
     |FINSI;

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida ! 0;
         IaPopup  = aPopup3  <-;
         IaPopup  = IaPopup + (FSalida - 1);

         aAlfa = aPopup % 101;  #cainliva#62 = aAlfa;
     |FINSI;

     |PINTA #cainliva#62;
|FPRC;


|CALCULO TOp340_i; |TIPO 0;
     nInkey = FSalida;
     |C_M #cainliva#62,0,aAlfa1;

     |BLIN 4;
     aTexto = "";
     |SI #cainliva#62 = " "; aTexto = "Operacin habitual"; |FINSI;
     |SI #cainliva#62 = "A"; aTexto = "Asiento resumen de facturas"; |FINSI;
     |SI #cainliva#62 = "B"; aTexto = "Asiento resumen de tiques"; |FINSI;
     |SI aTipoIVA = "R";
         |SI #cainliva#62 = "C"; aTexto = "Factura con varios asientos (varios tipo impositivos)"; |FINSI;
         |SI #cainliva#62 = "D"; aTexto = "Factura rectificativa"; |FINSI;
         |SI #cainliva#62 = "E"; aTexto = "IVA devengado pendiente de emitir factura"; |FINSI;
         |SI #cainliva#62 = "G"; aTexto = "Rgimen especial de grupo de entidades en IVA o IGIC"; |FINSI;
         |SI #cainliva#62 = "H"; aTexto = "Rgimen especial de oro de inversin"; |FINSI;
         |SI #cainliva#62 = "I"; aTexto = "Inversin del Sujeto pasivo (ISP)";|FINSI;
         |SI #cainliva#62 = "J"; aTexto = "Tiques"; |FINSI;
         |SI #cainliva#62 = "K"; aTexto = "Rectificacin anotaciones registrales"; |FINSI;
         |SI #cainliva#62 = "M"; aTexto = "IVA facturado pendiente de devengar (emitida factura)"; |FINSI;
         |SI #cainliva#62 = "N"; aTexto = "Facturacin de las prestaciones de servicios de agencias de viaje que actan como mediadoras en nombre y por cuenta ajena"; |FINSI;
         |SI #cainliva#62 = "O"; aTexto = "Factura emitida en sustitucin de tiques facturados y declarados."; |FINSI;
         |SI #cainliva#62 = "Q"; aTexto = "Operaciones a las que se aplique el rgimen especial de bienes usados, ..."; |FINSI;
         |SI enEjercicio > 2011;
             |SI #cainliva#62 = "R"; aTexto = "Operacin de arrendamiento de local de negocio."; |FINSI;
             |SI #cainliva#62 = "S"; aTexto = "Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones pblicas o entidades privadas."; |FINSI;
             |SI #cainliva#62 = "T"; aTexto = "Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ..."; |FINSI;
             |SI #cainliva#62 = "U"; aTexto = "Operacin de seguros."; |FINSI;
             |SI #cainliva#62 = "V"; aTexto = "Compras de Agencias viajes: operaciones de prestacin de servicios de mediacin en nombre y por cuenta ajena relativos ..."; |FINSI;
             |SI #cainliva#62 = "W"; aTexto = "Operaciones sujetas al Impuesto sobre la Produccin, los Servicios y la Importacin en las Ciudades de Ceuta y Melilla."; |FINSI;

             |SI enEjercicio ] 2014;
                 |SI #cainliva#62 = "Z"; aTexto = "Operaciones en Rgimen especial de criterio de caja"; |FINSI;
                 |SI #cainliva#62 = "1"; aTexto = "IVA criterio de caja. Asiento resumen de facturas"; |FINSI;
                 |SI #cainliva#62 = "2"; aTexto = "IVA criterio de caja. Factura con varios asientos"; |FINSI;
                 |SI #cainliva#62 = "3"; aTexto = "IVA criterio de caja. Factura rectificativa"; |FINSI;
                 |SI #cainliva#62 = "4"; aTexto = "IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes"; |FINSI;
                 |SI #cainliva#62 = "5"; aTexto = "IVA criterio de caja. Factura simplificada"; |FINSI;
                 |SI #cainliva#62 = "6"; aTexto = "IVA criterio de caja. Rectificacin de errores registrales"; |FINSI;
                 |SI #cainliva#62 = "7"; aTexto = "IVA criterio de caja. Facturacin de las prestaciones servicios agencias viajes"; |FINSI;
                 |SI #cainliva#62 = "8"; aTexto = "IVA criterio de caja. Operacin de arrendamiento de local de negocio"; |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         |SI #cainliva#62 = "C"; aTexto = "Factura con varios asientos (varios tipo impositivos)"; |FINSI;
         |SI #cainliva#62 = "D"; aTexto = "Factura rectificativa";|FINSI;
         |SI #cainliva#62 = "F"; aTexto = "Adquisiciones realizadas por las agencias de viajes directamente en inters del viajero";|FINSI;
         |SI #cainliva#62 = "G"; aTexto = "Rgimen especial de grupo de entidades en IVA o IGIC"; |FINSI;
         |SI #cainliva#62 = "H"; aTexto = "Rgimen especial de oro de inversin"; |FINSI;
         |SI #cainliva#62 = "I"; aTexto = "Inversin del Sujeto pasivo (ISP)"; |FINSI;
         |SI #cainliva#62 = "J"; aTexto = "Tiques"; |FINSI;
         |SI #cainliva#62 = "K"; aTexto = "Rectificacin anotaciones registrales"; |FINSI;
         |SI #cainliva#62 = "L"; aTexto = "Adquisiciones a comerciantes minoristas del IGIC"; |FINSI;
         |SI #cainliva#62 = "P"; aTexto = "Adquisiciones intracomunitarias de bienes."; |FINSI;
         |SI #cainliva#62 = "Q"; aTexto = "Operaciones a las que se aplique el rgimen especial de bienes usados, ..."; |FINSI;
         |SI enEjercicio > 2011;
             |SI #cainliva#62 = "R"; aTexto = "Operacin de arrendamiento de local de negocio."; |FINSI;
             |SI #cainliva#62 = "S"; aTexto = "Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones pblicas o entidades privadas."; |FINSI;
             |SI #cainliva#62 = "W"; aTexto = "Operaciones sujetas al Impuesto sobre la Produccin, los Servicios y la Importacin en las Ciudades de Ceuta y Melilla."; |FINSI;
             |SI #cainliva#62 = "X"; aTexto = "Operaciones por las que los empresarios o profesionales que satisfagan compensaciones agrcolas hayan expedido el recibo"; |FINSI;
             |SI enEjercicio ] 2014;
                 |SI #cainliva#62 = "Z"; aTexto = "Operaciones en Rgimen especial de criterio de caja"; |FINSI;
                 |SI #cainliva#62 = "1"; aTexto = "IVA criterio de caja. Asiento resumen de facturas"; |FINSI;
                 |SI #cainliva#62 = "2"; aTexto = "IVA criterio de caja. Factura con varios asientos"; |FINSI;
                 |SI #cainliva#62 = "3"; aTexto = "IVA criterio de caja. Factura rectificativa"; |FINSI;
                 |SI #cainliva#62 = "4"; aTexto = "IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes"; |FINSI;
                 |SI #cainliva#62 = "5"; aTexto = "IVA criterio de caja. Factura simplificada"; |FINSI;
                 |SI #cainliva#62 = "6"; aTexto = "IVA criterio de caja. Rectificacin de errores registrales"; |FINSI;
                 |SI #cainliva#62 = "7"; aTexto = "IVA criterio de caja. Facturacin de las prestaciones servicios agencias viajes"; |FINSI;
                 |SI #cainliva#62 = "8"; aTexto = "IVA criterio de caja. Operacin de arrendamiento de local de negocio"; |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #cainliva#62 = "C"; aTexto = ""; |FINSI; || no puede elegir C, es automatico
     |SI enEjercicio [ 2011;
         |SI #cainliva#62 = "X"; aTexto = "No pasa al 340"; |FINSI;
     |SINO;
         |SI #cainliva#62 = "*"; aTexto = "No pasa al 340"; |FINSI;
     |FINSI;

     |QBF aTexto;
     |SI aTexto = "";
         |MENAV "0000 Clave de operacin incorrecta";
         |C_M #cainliva#62,1,"S";
         |ERROR;
         |ACABA;
     |FINSI;
     || |PINTA 0540, aTexto;
     |C_M #cainliva#60, 1, "S";
     |C_M #cainliva#63, 1, "S";
     |C_M #cainliva#64, 1, "S";
     |SI #cainliva#62 ! "A";  |Y #cainliva#62 ! "B";
         |C_M #cainliva#60, 1, "N";  #cainliva#60 = 1;
         |C_M #cainliva#63, 1, "N";  #cainliva#63 = "";
         |C_M #cainliva#64, 1, "N";  #cainliva#64 = "";
     |FINSI;
     |PINTA #cainliva#61;
     |PINTA #cainliva#63;
     |PINTA #cainliva#64;

     |SI #cainliva#62 = "D";
         enConcepto = #cainliva#7;
         |HAZ VeoRecti;
         |SI nSwRecti = 1;
             |ERROR;
         |FINSI;
    |FINSI;
|FCAL;


|CALCULO Ctafras;
    |C_M #cainliva#60,0,aAlfa1;
    |SI aAlfa1 = "N"; |ACABA; |FINSI;

    |SI #cainliva#60 [ 1;
        |CONFI "    NNumero de facturas igual a 1. Es correcto";
        |SI FSalida ! 0;
            |ERROR;
        |FINSI;
    |FINSI;
|FCAL;

|| ----------------------------------------------

|CALCULO AntesAna; |TIPO 7;
 ModoEntrada = (FEntrada / 100) ! 0;
 |SI enSwAna = 1; |Y #1#58 = "       ";
     eaCuenta = #1#17; || contrapartida
     |HAZ LeeTablaAna;
     |SI swRelac = 0;
         |SI ModoEntrada = 1; #1#58 = eaCtaAna; |FINSI;
         |C_M #1#58,1,eaAnaMod;
     |SINO;
         |SI ModoEntrada = 1; #1#58 = ""; |FINSI;
         |SI eaPAna = "S";
             |C_M #1#58,1,"N";
         |SINO;
             |C_M #1#58,1,"S";
         |FINSI;
     |FINSI;
     |PINTA #1#58;
     eaCtaAna = #1#58;
     |HAZ eLimCtaAna7;
     |SI enBuenaAna ! 0; |C_M #1#58,1,"S"; |FINSI;
 |FINSI;
|FCAL;

|CALCULO anacta; |TIPO 0;
   nInkey = FSalida;
   |SI nInkey = 2;  |ACABA; |FINSI;
   |SI enSwAna = 0; |ACABA; |FINSI;

   |SI nInkey = 15;
       #1#58 = aCamp58;
       |PINTA #1#58;
       |VETE ParaSalir;
   |FINSI;

   salidas = FSalida; |HAZ FPuntosAna;

   eOpAna = 0; || 1 = Consulta pantalla
   |SI nInkey = 10; eOpAna = 1;  |FINSI;
   eaCtaAna = #1#58;
   |HAZ LeeCtaAna;
   |SI eswLect = 1;
        |MENAV "    Error.! No Existe Cuenta Analitica";
        |ERROR;
        |ACABA;
   |SINO;
       #1#58 = eaCtaAna;
       |PINTA #1#58;
       aCamp58 = #1#58;
  |FINSI;
|| ---------------------------------------------------------
 |ET ParaSalir;

|| ...  Comprobar validez de la cuenta analitica segun limites definidos
  eaCtaAna = #1#58;
  |HAZ eLimCtaAna;
  |SI enBuenaAna ! 0;
      |MENAV eaBuenaAna;
      |ERROR;
      |ACABA;
  |FINSI;

   enQueAna = 5;
   |SI nInkey = 13; enQueAna = 0; |FINSI;
   |SI nInkey = 11; enQueAna = 1; |FINSI;
   |SI nInkey = 12; enQueAna = 2; |FINSI;
   |HAZ GrupoAna;
|FCAL;

|PROCESO GrupoAna;

  |SI eaGAna = "S"; |ACABA; |FINSI; ||No existe reparto especifico

  alfa1 = #1#58; alfa1 = alfa1 % 103;
  |SI alfa1 ! "GRU";
      enQueAna = 4;
  |FINSI;

      nSwGrupo = 0;
      enDiAna = #1#0;
      efFeAna = #1#4;
      enDoAna = #1#2;
      enApAna = #1#1;
      eaGrAna = #1#58;
      enImAna = #1#12;

      |PUSHV 0622 2380;
      |SUB_EJECUTA_NP "anw00012";
      |SI nSwGrupo = 1;
          |ERROR;
      |FINSI;
      |POPV;
|FPRC;
||----------------------------------------------------
|CALCULO TrasDeduc; |TIPO 0;
  |SI #1#19 = "I"; |Y aTipoIVA = "R";
      #1#19 = "N"; |PINTA #1#19;
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO TrasConcepto1;  |TIPO 0;     ||Concepto Factura

   |SI FSalida = 10;
       eaFiCon = aFich1;
       enConcepto = #cainliva#7;
       |HAZ VerConcepto;
       #cainliva#7 = enConcepto; |PINTA #cainliva#7;
   |FINSI;

   enLibIVA   = #cainliva#0;
   enFilConc  = 2;          || Concepto de IVA
   enConcepto = #cainliva#7;
   eaReperc   = " ";
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;

   |C_M #cainliva#45,0,aAlfa1;
   |SI aAlfa1 = "N";   ||no modifica Actividad
       enActividad = #cainliva#45;
       |SI Haybasica = 1;
           enFilRegIVA = 0;
           enConcepto  = #cainliva#7;
           |HAZ FilRegimenIVA;
           |SI eswLect ! 0; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   |SI #cainliva#7 = dConc1; |Y ModoEntrada = 1;
       #dsmom030#1 = dDesc1;
   |FINSI;

   |SI #cainliva#7 ! nAnterior;
       #cainliva#8 = #dsmom030#1; |PINTA #cainliva#8;
   |FINSI;

   nSwIntra = 1;
   #cainliva#54 = #dsmom030#72; |PINTA #cainliva#54;
   |SI #cainliva#54 = "N";
      nSwImp = 0;
      aAlfa1 = &196 * 08;
      aAlfa2 = "          " + &179
      |PINTA 0570, aAlfa1;
      |PINTA 0670, aAlfa2;
      nSwIntra = 0;
   |SINO;
      |SI #dsmom030#26 = 5; eaTip349 = "AR";  |FINSI;
      |SI #dsmom030#26 = 6; eaTip349 = "IR";  |FINSI;
      |SI #dsmom030#30 = 2; eaTip349 = "AR";  |FINSI;
      |SI #dsmom030#30 = 3; eaTip349 = "IR";  |FINSI;
      |SI #dsmom030#34 = 9; eaTip349 = "ER";  |FINSI;
      |SI #dsmom030#34 = 4; eaTip349 = "SR";  |FINSI;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;

   |SI ModoEntrada = 1; |O #cainliva#Campo# ! nAnterior;
       |SI #cainliva#Campo# = nAnterior; |Y #cainliva#5 = CuentaAnt;
           aAlfa1 = aCamp17; |QBF aCamp17;
           |SI aCamp17 ! ""; eaCtaIVA = aCamp17; |FINSI;
       |FINSI;
       #cainliva#17 = eaCtaIVA; |PINTA #cainliva#17;
       emCta    = 0;
       eaCuenta = #cainliva#17; |HAZ SacaNivel; #cainliva#18 = enNivel;
       |HAZ LeeCuenta;
       |SI eswCta ! 0;
           |C_M #cainliva#17,1,"S";
       |SINO;  ||Cuenta erronea
           #cainliva#28 = #cacuenta#2; |PINTA #cainliva#28;
       |FINSI;

       |C_M #cainliva#10, 1,snTiva
       |SI eaReperc = "N";
           #cainliva#10 = enNumExe; |PINTA #cainliva#10;
           |C_M #cainliva#10, 1,"N";
       |FINSI;
   |FINSI;

   swAmorC = 0;
   |C_M #cainliva#32, 1, snInver;
   |SI aTipoIVA = "S";
       |SI #dsmom030#28 = 2; |O #dsmom030#28 = 4; |O #dsmom030#28 = 6;
           #cainliva#32 = "S"; |PINTA #cainliva#32; swAmorC = 1;
           |C_M #cainliva#32, 1, "N";
       |SINO;
           aAlfa = "N";
           |SI #dsmom030#32 = 3; aAlfa = "S"; swAmorC = 2; |FINSI;
           |SI ModoEntrada = 1; |O #cainliva#Campo# ! nAnterior;
               #cainliva#32 = aAlfa; |PINTA #cainliva#32;
           |FINSI;
       |FINSI;
   |SINO;
        |SI #dsmom030#34 = 14;
             |SI ModoEntrada = 1; |O #cainliva#Campo# ! nAnterior;
                 #cainliva#32 = "S"; |PINTA #cainliva#32;
             |FINSI;
        |FINSI;
   |FINSI;

   aClau340 = #cainliva#62;
   nNumFras = #cainliva#60;
   |HAZ ClauDefecto;
   #cainliva#62 = aClau340;
   |PINTA #cainliva#62;

   aAntesDes0 = #dsmom030#1; |QBF aAntesDes0;
   nAnterior  = #cainliva#7;

   aPositivo = #dsmom030#96;
   aObligado = #dsmom030#97;
   nConIRPF1 = #dsmom030#98;
   aModIRPF1 = #dsmom030#99;
   |SI snReten = "N";
       aModIRPF1 = " "; aObligado = " "; nConIRPF1 = 0;
   |FINSI;
   || si en el Caivaasi se informa que no hay retenciones
   || no hace caso al control del concepto.

   |C_M #cainliva#51, 1,snReten;
   |SI aObligado = "S";
       #cainliva#51 = nConIRPF1;
       |PINTA #cainliva#51;
       |SI aModIRPF1 = "N"; |C_M #cainliva#51,1,"N"; |FINSI;
   |FINSI;
   |SI aObligado = "N"; |Y snFiltr = "S";
       #cainliva#51 = 0;
       |PINTA #cainliva#51;
       |C_M #cainliva#51, 1,"N";
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI #cainliva#51 ! 0;
       |SI enSi111 = 1; |Y #caivaasi#167 ! "X"; |Y ModoEntrada = 1;
           eSwReten  = 2;
           enPanMod  = 0;
           eaFecMod  = "";
           enPerMod  = #cainliva#31;
           enConIRPF = #cainliva#51;
           |SALVA_DATOS #dsmom030;
           |HAZ ConsulModIVA;
           |REPON_DATOS #dsmom030;
           |SI enEmiMod = 1; |Y #caivaasi#167 ! "S";
               #cainliva#51 = 0;
               |PINTA #cainliva#51;
               |ERROR;
               |ACABA;
           |FINSI;
        |FINSI;
   |FINSI;
|FCAL;

|CALCULO PonloAlFinal; |TIPO 7;
   |C_M #cainliva#Campo#,0,alfa1;
   |SI alfa1 = "S";
       |SI eaSobreEs ! "S";
           |PTEC 816;
       |FINSI;
   |FINSI;
   |SI Campo !  52; |O #cainliva#51 ! 0;
       nCampo = Campo;
       |HAZ LosConceptos;
       nCampo = 0;
   |FINSI;
|FCAL;

|PROCESO LosConceptos;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI #caivaasi#131 = "S"; ||  ... Siempre por si modifica alguna cosa
       |SI nCampo ! 8; |Y nCampo ! 52; nCampo = 8; |FINSI;
       xx = 1; |SI nCampo = 52; xx = 3; |FINSI;
       |HAZ adaptaC2;
       #cainliva#nCampo# = aAlfa1;
       |PINTA #cainliva#nCampo#;
   |FINSI;
|FPRC;

|PROCESO adaptaC2;  ||El concepto en IVA

     aAlfa5 = "";
     aAlfa1 = #dsmom030#1;  |QBF aAlfa1;  || Descripcion
     |SI xx = 1; aAlfa2 = #caivaasi#45;  |FINSI;  ||Cliente
     |SI xx = 2; aAlfa2 = #caivaasi#130; |FINSI;  ||IVA
     |SI xx = 3; aAlfa2 = #caivaasi#96;  |FINSI;  ||IRPF
     |SI aAlfa2 = "=  "; aAlfa2 = #caivaasi#45; |FINSI;
     |QBF aAlfa2;  || lo que aade

     aAlfa3 = aAlfa2 % 0;
     nDCon0 = aAlfa3;
     |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
           aAlfa3 = nDCon1;
           aAlfa3 = aAlfa3 + "01";
           aDCon2 = aAlfa2 % aAlfa3;
           |HAZ adapta2_c;
           aAlfa5 = aAlfa5 + aDCon1;
     |SIGUE;
     aAlfa1  = aAlfa1 + aAlfa5;
|FPRC;

|PROCESO adapta2_c;  ||El concepto
     aDCon1 = "";
     |SI aDCon2 = "S";
         aDCon1 = #cainliva#26; |QBF aDCon1;
         |SI aDCon1 ! ""; aDCon1 = aDCon1 + aSepSer; |QBF aDCon1; |FINSI;
     |FINSI;                                         || Serie
     |SI aDCon2 = "F";
         aDCon1 = #cainliva#2; |QBF aDCon1;
         |SI aNumIzq = "S";
             aDCon1 = ("000000" + aDCon1) % -106;
         |FINSI;
     |FINSI;                                         || Factura
     |SI aDCon2 = "C";
         aDCon1 = #cainliva#5; |QBF aDCon1;
     |FINSI;                                         || Cuenta Cliente
     |SI aDCon2 = "N";
         aDCon1 = #cainliva#27; |QBF aDCon1;
     |FINSI;                                         || Nombre Cliente
     |SI aDCon2 = "R";
         |SI #cainliva#53 ! "                                                            ";
             aDCon1 = #cainliva#53; |QBF aDCon1;
         |FINSI;
     |FINSI;                                         || Referencia
     |SI aDCon2 = "P";
         aDCon1 = #cainliva#53;
         |SI aTipoIVA = "S";
             |HAZ EsComersan;
             |SI FSalida = 0; aDCon1 = #cainliva#72;  |FINSI;
         |FINSI;
         |QBF aDCon1;
     |FINSI;                                         || Referencia Comersan

     |SI aDCon1 ! "";
         |SI aDCon2 = "F";
             aAlfa7 = aAlfa2 - "S";
             |SI aAlfa7 ! aAlfa2; |Y #cainliva#26 > "     ";
                 |ACABA;
             |FINSI;
         |FINSI;
         aDCon1 = " " + aDCon1;
     |FINSI;
|FPRC;

|PROCESO FiltroObligado;
   |C_M #cainliva#Campo#,0,aAlfa;
   |SI aAlfa = "N"; |ACABA; |FINSI;

   |SI Campo = 51;
       aAlfa2 = "concepto";
   |SINO;
       aAlfa2 = "Importe";
   |FINSI;
   aAlfa1 = "sin Retencion";
   |SI aObligado = "S"; aAlfa1 = "con Retencion Obligada"; |FINSI;

   nSwObli = 0;
   |SI snFiltr ! "X";
       |SI snFiltr = "S";
           aAlfa = "    Factura " + aAlfa1;
           |SI aObligado = "S"; aAlfa = aAlfa  + ", introduzca " + aAlfa2; |FINSI;
           |MENAV aAlfa;
           nSwObli = 1;
       |SINO;
           aAlfa = "    NFactura "+ aAlfa1 + ", continuar";
           |CONFI aAlfa;
           |SI FSalida ! 0;
               nSwObli = 1;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI nSwObli = 1;
       |SI Campo = 51;
           #cainliva#51 = nConIRPF1;
           |SI nConIRPF ! 0; #cainliva#51 = nConIRPF; |FINSI;
           |SI aObligado = "N"; #cainliva#51 = 0; |FINSI;
           |PINTA #cainliva#51;
       |FINSI;
       |ERROR;
   |FINSI;
|FPRC;

|PROCESO FiltroNegativo;
   |C_M #cainliva#Campo#,0,aAlfa;
   |SI aAlfa = "N"; |ACABA; |FINSI;

   aAlfa = "negativos"; |SI aPositivo = "S"; aAlfa = "positivos"; |FINSI;

   nSwObli = 0;
   |SI snFiltr ! "X";
       |SI snFiltr = "S";
           aAlfa = "0000El Concepto NO admite " + aAlfa;
           |MENAV aAlfa;
           nSwObli = 1;
           |ERROR;
       |SINO;
           aAlfa = "0000NEl Concepto NO admite " + aAlfa + ". Continuar";
           |SI FSalida ! 0;
               nSwObli = 1;
               |ERROR;
           |FINSI;
       |FINSI;
   |FINSI;
|FPRC;

|CALCULO TrasConcepto2;  |TIPO 0;     ||Concepto IRPF

   |SI FSalida = 2; |ACABA; |FINSI;
   |C_M #cainliva#51, 0, aModi;

   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   |SI FSalida = 10;
       eaFiCon = aFich2;
       enConcepto = #cainliva#51;
       |HAZ VerConcepto;
       #cainliva#51 = enConcepto; |PINTA #cainliva#51;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI enSi111 = 1; |Y #caivaasi#167 ! "X"; |Y #cainliva#51 ! 0; |Y ModoEntrada = 1;
       eSwReten  = 2;
       enPanMod  = 0;
       eaFecMod  = "";
       enPerMod  = #cainliva#31;
       enConIRPF = #cainliva#51;
       |HAZ ConsulModIVA;
       |SI enEmiMod = 1; |Y #caivaasi#167 ! "S";
           #cainliva#51 = 0; |PINTA #cainliva#51;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI #cainliva#51 ! 0; |Y aObligado = "N";
       |HAZ FiltroObligado;
       |SI nSwObli = 1; |ACABA; |FINSI;
   |FINSI;

   |SI #cainliva#51 = 0;
       |SI aObligado = "S";
           |HAZ FiltroObligado;
           |SI nSwObli = 1; |ACABA; |FINSI;
       |FINSI;

       |C_M #cainliva#59,1,"N";
       |C_M #cainliva#55,1,"N";
       |C_M #cainliva#56,1,"N";
       |C_M #cainliva#52,1,"N";
       |C_M #cainliva#39,1,"N";
       |C_M #cainliva#34,1,"N";
       #cainliva#52 = "";  |PINTA #cainliva#52;
       #cainliva#34 = 0;   |PINTA #cainliva#34;
       #cainliva#55 = "N"; |PINTA #cainliva#55;
       #cainliva#56 = "N"; |PINTA #cainliva#56;
       #cainliva#59 = 0;   |PINTA #cainliva#59;
       nAnteriorIRPF = 0;
       |ACABA;
   |SINO;
       |C_M #cainliva#59,1,snBIrpf;
       |C_M #cainliva#52,1,snDIrpf;
       |C_M #cainliva#39,1,snTpIrpf;
       |C_M #cainliva#34,1,"S";
       |C_M #cainliva#55,1,"S";
       |C_M #cainliva#56,1,"S";
       |C_M #cainliva#35,1,snCIrpf;
   |FINSI;

   |SI #cainliva#51 < nDCIrpf; |O #cainliva#51 > nHCIrpf;
       |SI snFiltr ! "X";
           |MENAV "    Error, Concepto Contable no Correcto ";
       |FINSI;
       |SI snFiltr = "S";
           nAnteriorIRPF = 0;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   enLibIVA  = #cainliva#0;
   enFilConc = 3;        || Concepto de IRPF
   enConcepto = #cainliva#51;
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;

   |SI snFiMod = "S";
       enPanMod = 0;
       eaFecMod = "";
       enPerMod = #cainliva#31;
       |HAZ ConsulPlan;
       |SI enExiMod = 0; |Y snSeMod = "N";
           |ERROR;
           |SI aModi = "N";
               |PTEC 808;
           |FINSI;
           |ACABA;
       |FINSI;
   |FINSI;

   aM030_92 = dTIrpf;
   nM030_93 = dTpIrpf;
   |SI #dsmom030#92 ! " "; aM030_92 = #dsmom030#92; |FINSI;
   |SI #dsmom030#93 ! 0;   nM030_93 = #dsmom030#93; |FINSI;

   |SI #cainliva#51 ! nAnteriorIRPF;
       #cainliva#52 = #dsmom030#1; |PINTA #cainliva#52;
       #cainliva#34 = nM030_93;    |PINTA #cainliva#34;
       #cainliva#39 = aM030_92;    |PINTA #cainliva#39;
   |FINSI;

   #cainliva#36 = eaCtaIVA;
   emCta    = 0;
   eaCuenta = #cainliva#36; |HAZ SacaNivel; #cainliva#37 = enNivel;

   nAnteriorIRPF = #cainliva#51;

   nNume1 = enSi340;
   |HAZ Nuevo340;

   |SI #dsmom030#38 = 180; |Y aTipoIVA = "S"; |Y enEjercicio > 2011;
       |SI #cainliva#62 ! "R"; |Y #cainliva#62 ! "D"; |Y enSi340 = 1;
           |CONFI "    SFra con Retencion Mod.180 y Clave 340 diferente a <R>. Modificarla ?";
           |SI FSalida = 0;
               #cainliva#62 = "R"; |PINTA #cainliva#62;
           |FINSI;
       |FINSI;
   |FINSI;
   enSi340 = nNume1;
|FCAL;

|CALCULO AntesCuotaIRPF; |TIPO 7;
   aAlfa1 = snCIrpf;
   |SI #cainliva#51 = 0; aAlfa1 = "N"; |FINSI;
   |C_M #cainliva#35,1,aAlfa1;
   |HAZ AntesQue;
|FCAL;

|CALCULO AntesTpIRPF; |TIPO 7;
   aAlfa1 = snTpIrpf;
   |SI #cainliva#51 = 0; aAlfa1 = "N"; |FINSI;
   |C_M #cainliva#34,1,aAlfa1;

   |HAZ AntesQue;
|FCAL;

|CALCULO Trasdes; |TIPO 0;
   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   |SI FSalida = 15; |Y Campo = 8;
       #cainliva#8 = DescAnt; |PINTA #cainliva#8;
       |ERROR;
   |FINSI;
   |SI FSalida = 16; |Y Campo = 52;
          aAntesDes1 = #cainliva#8; |QBF aAntesDes1;
          aAlfa1 = aAntesDes1 - aAntesDes0;
          aAlfa2 = #dsmom030#1; |QBF aAlfa2;
          aAlfa2 = aAlfa2 + aAlfa1;
          #cainliva#Campo# = aAlfa2; |PINTA #cainliva#Campo#;
   |FINSI;
|FCAL;

|| //////////////////////////////////////////////////////////////////////////
|CALCULO A_refe; |TIPO 7;
  eaSiiRef = #cainliva#53; |QBF eaSiiRef;
  eaSiiSer = #cainliva#26; |QBF eaSiiSer;
  enSiiFra = #cainliva#2;
  |HAZ NReferencia;
  #cainliva#53 = eaSiiRef;
  |PINTA #cainliva#53;

  |C_M #cainliva#Campo#, 1, "S";
  aAlfa1 = #cainliva#Campo#; |QBF aAlfa1;
  |SI aAlfa1 = "";
     |SI #caivaasi#116 = "B"; |C_M #cainliva#Campo#,1,"N"; |FINSI;
  |FINSI;

  ModoEntrada = (FEntrada / 100) ! 0;
  |SI aAlfa1 = ""; |O  ModoEntrada = 1;
      |HAZ CalRefer;
  |FINSI;
|FCAL;

|PROCESO CalRefer;
  |HAZ EsComersan;
  |SI FSalida = 0;
      |SI eaRefer = "N"; enLgRef = #caivaasi#117; |FINSI;
      aAlfa2 = #cainliva#26; |QBF aAlfa2;
      |SI aAlfa2 ! "";
          #cainliva#53 = aAlfa2 + "-." + #cainliva#2;
      |SINO;
          #cainliva#53 = "." + #cainliva#2;
      |FINSI;
      r_entra = entrada;
      r_alfa1 = #cainliva#53;
      |HAZ r1_punto;
      #cainliva#53 = r_alfa1; |PINTA #cainliva#53;
  |FINSI;
|FPRC;

|CALCULO r_referen; |TIPO 6;
   nInkey = FSalida;
   |SI eaRefer = "N"; enLgRef = #caivaasi#117; |FINSI;
   |SI #caivaasi#116 ! "S"; |ACABA; |FINSI;

   r_entra = entrada;
   r_alfa1 = #cainliva#Campo#;
   |HAZ r1_punto;
   #cainliva#Campo# = r_alfa1;
   |PINTA #cainliva#Campo#;
|FCAL;

|CALCULO refeIVA; |TIPO 0;
 |SI FSalida = 2; |ACABA; |FINSI;

 |HAZ EsComersan;
 |SI FSalida = 0; |Y aTipoIVA = "S";
    aFraPrv = #cainliva#72;
    |PUSHV 1020 1262;
    |BLANCO 1020 1262;
    |CUADRO 1020 1262;
    |PINTA 1121, " N Fra.Proveedor: ";
    E_sup = 20; E_inf = "";
    aFraPrv = 1140 ? 0;
    |SI FSalida = 0;
        #cainliva#72 = aFraPrv;
    |FINSI;
    |POPV;
 |FINSI;

 |C_M #cainliva#45, 0, aAlfa;
 aAlfa1 = #cainliva#53; |QBF aAlfa1;
 |SI aAlfa = "N"; |Y aAlfa1 = "";
     eOpDep = 0; || 1 = Consulta pantalla
     enActividad = #cainliva#45;
     eaCodDep    = #cainliva#45;
     eSwNoalta = 1; |HAZ Actividad; eSwNoalta = 0;
     |HAZ RefBlanca;
     |SI nOk = 1;
         |ERROR;
     |FINSI;
 |FINSI;
|FCAL;

|PROCESO RefBlanca;
 |SI aTipoIVA ! "N"; |Y enEjercicio ] 2017;
     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;
     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;
     |SI nOk = 1;
         |MENAV "0000Atencion. Es OBLIGATORIO informar la Referencia ";
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO Nuevo340;
     nAny = enEjercicio;
     |SI dig1 ! 1; |Y #cainliva#31 < dig1; nAny = enEjercicio + 1; |FINSI;

     |SI nAny ] 2017;
         nOk = 0;
         |SI enTipoIva = 11;  nOk = 1;  |FINSI;
         |SI enTipoIva = 12;  nOk = 1;  |FINSI;
         |SI enTipoIva = 13;  nOk = 1;  |FINSI;
         |SI enTipoIva = 15;  nOk = 1;  |FINSI;
         |SI enTipoIva = 16;  nOk = 1;  |FINSI;
         |SI enTipoIva = 17;  nOk = 1;  |FINSI;
         |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;
         |SI nOk = 1;
             enSi340 = 1;
         |SINO;
             |SI enBaja340 ! 0;
                |SI nAny > enBajE340; enSi340 = 0; |FINSI;
                |SI nAny = enBajE340; |Y #cainliva#31 > enBaja340; enSi340 = 0; |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;
|| ------------------------------------------------------------------

|CALCULO Repite; |TIPO 0;
   |SI nInkey = 15;
       #cainliva#Campo# = ReferAnt; |PINTA #cainliva#Campo#;
       |ERROR;
       |PTEC 816;
   |FINSI;
|FCAL;

||----------------------------------------------------
|CALCULO AntesDepar; |TIPO 7;
   |C_M #cainliva#Campo#, 0, alfa1;
   |SI alfa1 = "S"
      |SI Haybasica = 1;
          |MENSA "    <F2> Consultar Actividades / <F3> Repetir Campos ";
      |SINO;
          |MENSA "    <F2> Consultar Departamentos / <F3> Repetir Campos ";
      |FINSI;
      |SI swRepite = 1; |PTEC 802; |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesSubde; |TIPO 7;
   |C_M #cainliva#Campo#, 0, alfa1;
   |SI alfa1  = "S";
      |SI Haybasica = 1;
          |SI enArrend ! 2;
              |MENSA "    Subdepar.: Ref.Catastrales <F2> Consultar <F3> Modificar, <F4> Repetir";
          |SINO;
              |MENSA "    Subdepartamento. <F2> Consultar Cultivos; <F4> Repetir";
          |FINSI;
      |FINSI;
      |SI swRepite = 1; |PTEC 802; |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesCIVA1; |TIPO 7;
 aAlfa1 = #caivaasi#87;
 |SI #cainliva#13 = 0; aAlfa1 = "N"; |FINSI;
 |C_M #cainliva#14,1,aAlfa1;
|FCAL;

|CALCULO AntesCRec1; |TIPO 7;
 aAlfa1 = #caivaasi#88;
 |SI #cainliva#15 = 0; aAlfa1 = "N"; |FINSI;
 |C_M #cainliva#16,1,aAlfa1;
|FCAL;

|CALCULO AntesQue; |TIPO 7;
  |C_M #cainliva#Campo#, 0, alfa1;
  |SI swRepite = 1; |Y alfa1 = "S"; |PTEC 802; |FINSI;
|FCAL;

|PROCESO MiroAmor;
 swInve = 0;
 aMensa = "    Entre: (S) si es un BIEN de inversion";
 |SI aTipoIVA = "S"; |Y #cainliva#12 < 3005.06;
     |SI swAmorC ! 1;
         swInve = 1;
         aMensa = "    (S) si es un Bien de Inversion, <F2> Bien Corriente con Ficha de Amortizacion";
         |SI swAmorC = 0;
             aMensa = "    Pulse <F2> Bien Corriente con Ficha de Amortizacion";
         |FINSI;
     |FINSI;
 |FINSI;
 |MENSA aMensa;
|FPRC;

|CALCULO lainversion; |TIPO 0;
 nInkey = FSalida;
 |C_M #1Campo,0,aAlfa1;

 |SI aAlfa1 = "S";
     |SI nInkey = 2; |ACABA; |FINSI;
     |SI nInkey = 12; |Y #1#54 = "S";  |HAZ paraI;  |ERROR; |ACABA; |FINSI;
     |SI nInkey = 10; |Y swInve = 0;                |ERROR; |ACABA; |FINSI;
 |FINSI;

 |SI #1Campo = "S"; |Y aTipoIVA = "S"; |Y swAmorC = 0; |Y nInkey ! 10;
      |CONFI "    NAviso. El Concepto Contable utilizado NO es de Inversion de IVA. Continuar";
      |SI FSalida ! 0;
          |C_M #1Campo,1,"S";
          #1Campo = "N"; |PINTA #1Campo;
          |SI aAlfa1 = "N";
              |PTEC 808;
          |SINO;
               |ERROR;
          |FINSI;
          |ACABA;
      |FINSI;
 |FINSI;

 |SI #1Campo = "N"; |Y aTipoIVA = "S"; |Y swAmorC = 1;
      |CONFI "    NAviso. El Concepto Contable utilizado es de Inversion de IVA. Continuar";
      |SI FSalida ! 0;
          |C_M #1Campo,1,"S";
          #1Campo = "S"; |PINTA #1Campo;
          |SI aAlfa1 = "N";
              |PTEC 808;
          |SINO;
              |ERROR;
          |FINSI;
          |ACABA;
      |FINSI;
 |FINSI;

 |SI nInkey = 10; |Y swInve = 1;
      #1Campo = "N"; |PINTA #1Campo;
      swAmor = 1;
      |ACABA;
 |FINSI;

 |SI #1Campo = "S"; |Y swAmorC = 1; |Y #cainliva#12 < 3005.06; |Y #cainliva#12 > 0;
     |CONFI  "    NBien de Inversion con Importe inferior a 3005,06. Revisar Importe y Concepto. Continuar ";
     |SI FSalida ! 0;
         |C_M #1Campo,1,"S";
         |SI aAlfa1 = "N";
             |PTEC 808;
         |SINO;
             |ERROR;
         |FINSI;
     |FINSI;
 |FINSI;

|FCAL;

|CALCULO AntesQueInv; |TIPO 7;
  |HAZ MiroAmor;
  |MENSA aMensa;
  |HAZ AntesQue;
|FCAL;

|CALCULO elDNI; |TIPO 6;
  |C_M #cainliva#Campo#,0,alfa1;
  |SI alfa1 = "N"; |ACABA; |FINSI;

  |SI FSalida = 2; |ACABA; |FINSI;
  |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;
  |SI FSalida = 13; |HAZ TrasNombre; |ACABA; |FINSI;

  |SI FSalida = 10;
      enCalcCif = 1;
      eaVarDni  = #cainliva#Campo#;
      |HAZ CalculoDNI;
      #cainliva#Campo# = eaVarDni;
      |PINTA #cainliva#Campo#;
      |ERROR;
      |ACABA;
  |FINSI;

  eaVarDni  = #cainliva#Campo#;
  enCalcCif = 0;
  |HAZ CalculoDNI;
  eaVarDni = (eaVarDni + "                ") % 115;
  |SI #cainliva#Campo# ! eaVarDni;
      |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
      |SI FSalida = 0;
          #cainliva#Campo# = eaVarDni; |PINTA #cainliva#Campo#;
          |ERROR;
          |ACABA;
      |FINSI;
  |FINSI;

  eaVarDni  = #cainliva#Campo#; |QBF eaVarDni;
  |SI eaVarDni = eaNifEmp; |Y nPulsoF9 = 0;
      |CONFI "    NIntroducido NIF de la Empresa Actual. Continuar";
      |SI FSalida ! 0;
          |ERROR;
     |FINSI;
  |FINSI;
|FCAL;

|CALCULO elDNI0; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;
   |ABRE #caclipro;
   |SI aTipoIVA = "R";
       #caclipro#23 = "C";
   |SINO;
       #caclipro#23 = "P";
   |FINSI;
   #caclipro#10 = #cainliva#5;
   |LEE 000#caclipro.=;
   |SI FSalida ! 0; |O #caclipro#15 = "               ";
       eaCodNif= #cainliva#Campo#; |QBF eaCodNif;
       |SI eaCodNif ! "";
           |HAZ LeeNifs;
           #cainliva#27 = #709#1; |PINTA #cainliva#27;
       |FINSI;
   |FINSI;
   |CIERRA #caclipro;
   |SI aTipoIVA = "S"; |Y HayAcceso = 1; |Y #cainliva#30 ! "               ";
       |SI eaTEmbargo = "F"; |O eaTEmbargo = "A";
           efFechaE = #cainliva#4;
           |HAZ eVerEmbargos;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO TrasDepar; |TIPO 0;
   |SI eaDepar = "N"; |ACABA; |FINSI;
   |SI FSalida = 2; |ACABA; |FINSI;

   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   nTecla = FSalida;

   eOpDep = 0;                            || 1 = Consulta pantalla
   |SI nTecla = 10; eOpDep = 1;  |FINSI;

   |SI nTecla = 11; |HAZ Perepetir; |ACABA; |FINSI;

   enActividad = #cainliva#45;
   eaCodDep    = #cainliva#45;
   |HAZ Actividad;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Actividad / Departamento";
       |C_M #cainliva#Campo#, 1, "S";
       |ERROR;
       |ACABA;
   |SINO;
       alfa1 = enActividad;
       |SI Haybasica = 1;
           enFilRegIVA = 1;
           enConcepto  = #cainliva#7;
           |HAZ FilRegimenIVA;
           |SI eswLect ! 0; |HAZ SuboConcepto; |ACABA; |FINSI;
           alfa1 = ("00" + alfa1) % A02;
       |FINSI;

       #cainliva#45 = eaCodDep;    |PINTA #cainliva#45;
       #cainliva#46 = eaNombreAct; ||  |PINTA #cainliva#46;
       |HAZ pintoDep;
       |SI efActFin > "01.01.1900"; |Y snFilBa = "S";
           aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
           |CONFI aAlfa1;
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
       |SI eaEsCom = "S";
           |CONFI "    NAtencion!!!. Actividad Comunera,  Desea introducir Facturas ? ";
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

   |C_M #cainliva#45, 0, aAlfa;
   aAlfa1 = #cainliva#53; |QBF aAlfa1;
   |SI aAlfa = "S"; |Y aAlfa1 = "";
       |HAZ RefBlanca;
       |SI nOk = 1;
           |ERROR;
           |PTEC 808;
           |C_M #cainliva#27, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #cainliva#30, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #cainliva#5,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|PROCESO SuboConcepto;
   |SI snFiltr = "S"; |Y snFilAc = "S";
       |C_M #cainliva#45, 0, aAlfa1;
       |SI aAlfa1 = "N"; |ACABA; |FINSI;
       |PTEC 808;
       |C_M #cainliva#27, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#30, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#5,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#53, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#62, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#63, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#64, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#60, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #cainliva#8,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
   |FINSI;
|FPRC;

|CALCULO TrasSubde; |TIPO 0;
   |SI eaSubde = "N"; |ACABA; |FINSI;

   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   eOpSub = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpSub = 1;  |FINSI;
   |SI FSalida = 11; eOpSub = 2;  |FINSI;

   |SI nTecla = 12; |HAZ Perepetir; |ACABA; |FINSI;
   enConcepto  = #cainliva#7;
   eaCodSubdep = #cainliva#47;
   enQue = 1;
   |HAZ SubActividad;
   enQue = 0;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe SubDepartamento";
       |ERROR;
   |SINO;
       #cainliva#47 = eaCodSubdep; |PINTA #cainliva#47;
       #cainliva#48 = eaNomSubdep; ||  |PINTA #cainliva#48;
       |HAZ pSubdepar;
   |FINSI;
|FCAL;

|PROCESO Perepetir;
 ModoEntrada = (FEntrada / 100) ! 0;
 |SI ModoEntrada ! 1; swRepite = 0; |ACABA; |FINSI;

 nNume1 = Campo;
 |SI nNume1 = 5;
     #cainliva#5  = CuentaAnt;  |PINTA #cainliva#5;
     #cainliva#6  = DigitoAnt;
     #cainliva#27 = ClienAnt;   |PINTA #cainliva#27;
     #cainliva#30 = CifAnt;     |PINTA #cainliva#30;
     nNume1 = 45;
 |FINSI;

 |SI nNume1 = 45;
     #cainliva#45 = DeparAnt;  |PINTA #cainliva#45;
     #cainliva#46 = NDeparAnt; |PINTA #cainliva#46;
     nNume1 = 47;
 |FINSI;

 |SI nNume1 = 47;
     #cainliva#47 = SubdeAnt;  |PINTA #cainliva#47;
     #cainliva#48 = NSubdeAnt; |PINTA #cainliva#48;
     nNume1 = 49;
 |FINSI;

 |SI nNume1 = 49;
     #cainliva#49 = aCamp49; |PINTA #cainliva#49;
     |SI #cainliva#49 ! "N";
         #cainliva#73 = #cainliva#4;
     |FINSI;
                             |PINTA #cainliva#73;
     #cainliva#40 = aCamp40; |PINTA #cainliva#40;
     #cainliva#41 = nCamp41;
     #cainliva#42 = aCamp42;
     #cainliva#43 = nCamp43;
     #cainliva#44 = aCamp44;
     nNume1 = 17;
 |FINSI;

 |SI nNume1 = 17;
     #cainliva#17 = aCamp17; |PINTA #cainliva#17;
     #cainliva#18 = nCamp18;
     #cainliva#58 = aCamp58; |SI enSwAna = 1; |PINTA #cainliva#58; |FINSI;
     #cainliva#28 = aCamp28; |PINTA #cainliva#28;
     #cainliva#55 = aCamp55; |PINTA #cainliva#55;
     #cainliva#56 = aCamp55; |PINTA #cainliva#56;
     nNume1 = 51;
 |FINSI;

 |SI nNume1 = 51;
     #cainliva#51 = nCamp51;  |PINTA #cainliva#51;
     #cainliva#52 = aCamp52;  |PINTA #cainliva#52;
     #cainliva#39 = aCamp39;  |PINTA #cainliva#39;
     #cainliva#34 = nCamp34;  |PINTA #cainliva#34;
     #cainliva#35 = nCamp35;  |PINTA #cainliva#35;
     #cainliva#59 = nCamp59;  |PINTA #cainliva#59;
     #cainliva#36 = aCamp36;
     #cainliva#37 = nCamp37;
     nAnteriorIRPF = #cainliva#51;
     nNume1 = 10;
 |FINSI;

 |SI nNume1 = 10;
     #cainliva#10 = nCamp10; |PINTA #cainliva#10;
     #cainliva#12 = nCamp12; |PINTA #cainliva#12;
     #cainliva#13 = nCamp13; |PINTA #cainliva#13;
     #cainliva#14 = nCamp14; |PINTA #cainliva#14;
     #cainliva#15 = nCamp15; |PINTA #cainliva#15;
     #cainliva#16 = nCamp16; |PINTA #cainliva#16;
     #cainliva#11 = nCamp11; |PINTA #cainliva#11;
     #cainliva#29 = nCamp29; |PINTA #cainliva#29;
     #cainliva#57 = aCamp57;  |PINTA #cainliva#57;
     #cainliva#54 = aCamp54;  |PINTA #cainliva#54;
     #cainliva#32 = aCamp32;  |PINTA #cainliva#32;
     nNume1 = 19;
 |FINSI;

 |SI nNume1 = 19;
     #cainliva#19 = aCamp19; |PINTA #cainliva#19;
 |FINSI;

 swRepite = 1;
|FPRC;

|CALCULO ElTipo13; |TIPO 7;

   |PINTA 1802, "";
   |PINTA 2154, "                          ";
   aBlancs = "";
   |PINTA 2202, aBlancs;
   aBlancs = " " * 78;
   |PINTA 2302, aBlancs;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada [ 1; |ACABA; |FINSI;

   |SI eaDepar = "S";
       eOpDep = 0;
       enActividad = #cainliva#45;
       eaCodDep    = #cainliva#45;
       |HAZ Actividad;
       |HAZ pintoDep;
   |FINSI;
   |SI eaSubde = "S";
       eOpSub = 0;
       enConcepto  = #cainliva#47;
       eaCodSubdep = #cainliva#47;
       |HAZ SubActividad;
       |HAZ pSubdepar;
   |FINSI;
   |HAZ PintaTotal;
   |HAZ PintaCobro;
|FCAL;

||----------------------------------------------------
|CALCULO TrasTipoIVA; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

   |SI FSalida = 10;
      efFechaIVA = #1#4;  |HAZ SelecTipoIVA;
      #cainliva#10 = enLineaIVA; |PINTA #cainliva#10;
      |ERROR;
   |SINO;
      efFechaIVA = #1#4; enLineaIVA = #cainliva#10;
      |HAZ SacaIVA;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1; |O #cainliva#10 ! Contenido;

      |SI nTecla = 11; |HAZ Perepetir; |FINSI;
      |SI enLineaIVA < 0;
         |MENAV "     Control de cuentas no definido";
         |ERROR; |ACABA;
      |FINSI;

      #cainliva#20 = eaCtaIVA;
      #cainliva#22 = eaCtaREC;
      #cainliva#24 = eaCtaDTO;

      #cainliva#13 = enPorcIVA;  |PINTA #cainliva#13;
      #cainliva#15 = enPorcREC;  |PINTA #cainliva#15;

      |SI #cainliva#19 = "N";

          |SI dCtaNoD ! "";
              #cainliva#20 = dCtaNoD;
              #cainliva#22 = dCtaNoD;
          |SINO;
              #cainliva#20 = #cainliva#17;
              |SI #cainliva#15 ! 0; #cainliva#22 = #cainliva#17; |FINSI;
          |FINSI;
      |SINO;
          |SI nSwCaja = 1; |Y aCCCta ! doce;
               #cainliva#20 = aCCCta;
          |FINSI;
      |FINSI;

      |SI #cainliva#19 = "I";
          #cainliva#20 = "";
          #cainliva#22 = 0;
      |FINSI;

      emCta = 0;
      eaCuenta = #cainliva#20; |HAZ SacaNivel; #cainliva#21 = enNivel;
      eaCuenta = #cainliva#22; |HAZ SacaNivel; #cainliva#23 = enNivel;
      eaCuenta = #cainliva#24; |HAZ SacaNivel; #cainliva#25 = enNivel;

      |C_M #cainliva#39,1,"S";
      |SI #cainliva#51 = 0;
          |C_M #cainliva#34,1,"N";
          |C_M #cainliva#39,1,"N";
          #cainliva#34 = 0;  |PINTA #cainliva#34;
      |FINSI;

      Calc = #cainliva#12 * #cainliva#13 / 100; #cainliva#14 = Calc ! EURODB;
      Calc = #cainliva#12 * #cainliva#15 / 100; #cainliva#16 = Calc ! EURODB;
      |HAZ PintaCalBP;

      |SI swRepite = 1; |ACABA; |FINSI;

      nError = 0;
      |SI eaReperc = "S";
          |SI #cainliva#13 = 0; |Y #cainliva#15 = 0;
              aAlfa1 = "    Este concepto Repercute, no puede informar %IVA 0. ";
              nError = 1;
          |FINSI;
      |SINO;
          |SI eaReperc = "N";
              |SI #cainliva#13 ! 0; |O #cainliva#15 ! 0;
                  aAlfa1 = "    Este concepto No Repercute, no puede informar cuota de IVA";
                  nError = 1;
              |FINSI;
          |FINSI;
      |FINSI;

      |SI eaDepar = "S"; |Y aTipoIVA = "R"; |Y snFiltr = "S"; |Y snFilAc = "S";
          |SI #cainliva#13 ! 0;
              |SI enTipoIva = 1;
                  nError = 1;
                  aAlfa1 = "IVA en Actividad Exenta.";
              |SINO;
                  |SI enTipoIva = 2;
                      |SI enTVolOpe = 12; |O enTVolOpe = 11;
                          nError = 1;
                          aAlfa1 = "IVA con un Concepto de Operacion Exenta.";
                      |FINSI;
                   |FINSI;
              |FINSI;
          |SINO;
              |SI enTipoIva = 2; |Y enTVolOpe = 1;
                      nError = 1;
                      aAlfa1 = "IVA al 0% con un Concepto de Operacion no Exenta.";
              |FINSI;
          |FINSI;
      |FINSI;

      |SI nSwCaja = 1; |Y #cainliva#15 ! 0;
          nError = 1;
          aAlfa1 = "Fra. de Criterio de Caja. No puede tener Recargo de Equivalencia";
      |FINSI;

          |SI nError = 1; |Y nNoSalta = 0;
              aAlfa1 = "    N" + aAlfa1 + " Continuar ";
              |CONFI aAlfa1;
              |SI FSalida ! 0;
                  |ERROR;
                  |PTEC 808;
                  |C_M #cainliva#56, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#55, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#52, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#51, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#58, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#28, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#17, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#19, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#73, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#40, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#49, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#47, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#45, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#27, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#30, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#5,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#53, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#62, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#63, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#64, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#60, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
                  |C_M #cainliva#8,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
              |FINSI;
          |FINSI;

   |FINSI;
|FCAL;

|| -------------------------------------------------- Calculos
|PROCESO MirCta;
   |SI FSalida = 2; |ACABA; |FINSI;

   |SI FSalida = 10;
       |SI Campo = 35;
           |HAZ PintaCalP;
       |FINSI;
       |SI Campo = 14;
           #cainliva#14  = (#cainliva#12 % #cainliva#13) ! EURODB; |PINTA #cainliva#14;
       |FINSI;
       |SI Campo = 16;
           #cainliva#16  = (#cainliva#12 % #cainliva#15) ! EURODB; |PINTA #cainliva#15;
       |FINSI;
   |FINSI;

   |SI aPositivo ! " "; |Y Campo ! 35;
       |SI aPositivo = "N"; |Y #cainliva#Campo# < 0;
           |HAZ FiltroNegativo;
           |SI nSwObli = 1;  |ACABA;  |FINSI;
       |FINSI;
       |SI aPositivo = "S"; |Y #cainliva#Campo# > 0;
           |HAZ FiltroNegativo;
           |SI nSwObli = 1;  |ACABA;  |FINSI;
       |FINSI;
   |FINSI;

   |SI Campo = 12; nNume2 = 17; aAlfa2 = "CONTRAPARTIDA"; |FINSI;
   |SI Campo = 14; nNume2 = 20; aAlfa2 = "IVA";           |FINSI;
   |SI Campo = 16; nNume2 = 22; aAlfa2 = "RECARGO";       |FINSI;
   |SI Campo = 35; nNume2 = 36; aAlfa2 = "IRPF";          |FINSI;
   |SI Campo = 11; nNume2 = 24; aAlfa2 = "DESCUENTO";     |FINSI;

   |SI Campo = 14; |O Campo = 16;
       |SI #cainliva#19 = "I";
           |ACABA;
       |FINSI;
   |FINSI;
   aAlfa1 =  #cainliva#nNume2#; |QBF aAlfa1;
   |SI aAlfa1 = ""; |Y #cainliva#Campo# ! 0;
       aMensa = "    NO EXISTE CUENTA DE " + aAlfa2;
       |MENAV aMensa;
       |ERROR;
   |FINSI;
|FPRC;

|CALCULO AntesBase; |TIPO 7;
   |SI eaIntBN = "N";
       |MENSA "    Introduzca Importe Neto. <F2> Cambiar para introducir Bases";
   |SINO;
       |MENSA "    Introduzca Base. <F12> considerar liquido, <F2> Cambiar para introducir Netos";
   |FINSI;
|FCAL;

|CALCULO PintaCalB;  |TIPO 0;

   nInkey = FSalida;

   |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;
   |SI FSalida = 2; |ACABA; |FINSI;

   |SI nInkey = 10;   || falta cambiar esto 07.03.2017
       |HAZ eAcActualiza;
       eaIntBN = #caivaasi#110;
   |FINSI;

   |SI eaIntBN = "N"; nInkey = 9; |FINSI;
   |SI #cainliva#12 = Contenido; |Y nInkey ! 9; |ACABA; |FINSI;

   |SI nInkey  = 9;
       BaseAnt = #cainliva#12;
       |SI #cainliva#51 = 0;
           #cainliva#12 = #cainliva#12 * (100 / (#cainliva#13 + #cainliva#15 + 100));
       |SINO;
           |SI #cainliva#39 = "B";
               #cainliva#12 = #cainliva#12 * (100 / (#cainliva#13 + #cainliva#15 - #cainliva#34 + 100));
           |SINO;
               #cainliva#12 = #cainliva#12 * (100 / (100 - #cainliva#34));
               #cainliva#12 = #cainliva#12 * (100 / (#cainliva#13 + #cainliva#15 + 100));
           |FINSI;
       |FINSI;
   |FINSI;

   Calc = #cainliva#12 * #cainliva#13 / 100; #cainliva#14 = Calc ! EURODB;
   Calc = #cainliva#12 * #cainliva#15 / 100; #cainliva#16 = Calc ! EURODB;
   |SI #cainliva#51 ! 0;
       |HAZ PintaCalBP;
   |FINSI;
   |HAZ PintaCalP;

   |SI nInkey  = 9;
       #cainliva#12 = #cainliva#12 + (BaseAnt - (#cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35));
       |HAZ PintaCalD;
   |FINSI;
|FCAL;

|CALCULO PintaCalBP;
 |SI #cainliva#39 = "B";
     #cainliva#59 = #cainliva#12;
 |SINO;
     #cainliva#59 = #cainliva#12 + #cainliva#14 + #cainliva#16;
 |FINSI;
 |PINTA #cainliva#59;

 |HAZ PintaCalP;
|FCAL;

|CALCULO AntesBIrpf; |TIPO 7;
 aAlfa1 = snBIrpf;
 |SI #cainliva#51 = 0; aAlfa1 = "N"; |FINSI;
 |C_M #cainliva#59,1,aAlfa1;
|FCAL;

|CALCULO TrasBIrpf; |TIPO 0;
 |SI aObligado = "S"; |Y #cainliva#Campo# = 0;
     |HAZ FiltroObligado;
     |SI nSwObli = 1; |ACABA; |FINSI;
 |FINSI;
 |SI aObligado = "N"; |Y #cainliva#Campo# ! 0;
     |HAZ FiltroObligado;
     |SI nSwObli = 1; |ACABA; |FINSI;
 |FINSI;

 |HAZ PintaCalP;
|FCAL;

|CALCULO PintaCalP;

   Calc = (#cainliva#59 % #cainliva#34) ! EURODB;
   #cainliva#35 = Calc ! EURODB;
   |HAZ PintaCalD;
|FCAL;

|CALCULO PintaCalD;

   #cainliva#29 = #cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35;
   || ... no dto 03.01.2006  ... #cainliva#29 = #cainliva#12 + #cainliva#14 + #cainliva#16 - (#cainliva#35 + #cainliva#11);

   |PINTA #cainliva#12;
   |PINTA #cainliva#14;
   |PINTA #cainliva#16;
   |PINTA #cainliva#35;
   |PINTA #cainliva#29;

    |SI nNumLin ! 0;
        |HAZ PintaTotal1;
    |FINSI;
|FCAL;

|CALCULO TotalFra; |TIPO 7;
 |SI nInkey = 5; |ACABA; |FINSI;
 |SI aElCero = "N";
    |SI #cainliva#12 = 0; |Y  #cainliva#14 = 0;
      |Y #cainliva#16 = 0; |Y #cainliva#29 = 0; |Y #cainliva#35 = 0;

        |MENAV "    Error. Factura de importe igual a 0";
        |C_M #cainliva#29, 1, "S";
        |PTEC 808;
        |C_M #cainliva#11, 0, aAlfa1; |C_V #cainliva#11,0,aAlfa2;
         |SI aAlfa1 = "S"; |Y aAlfa2 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#35, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#34, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#59, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#39, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#16, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#15, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
        |C_M #cainliva#14, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
   |FINSI;
 |FINSI;
|FCAL;

|CALCULO TotalFra0; |TIPO 0;
  |C_M #cainliva#29,1,"N";
|FCAL;
|| ----------------------------------------------------------------------

|CALCULO Repercute; |TIPO 7;
     |SI #cainliva#55 = "S";
          |C_M #cainliva#56,1,"S";
     |SINO;
          #cainliva#56 = "N"; |PINTA #cainliva#56;
          |C_M #cainliva#56,1,"N";
     |FINSI;
|FCAL;

|CALCULO TrasCobroPago;  |TIPO 0;
  |SI FSalida = 2; |ACABA; |FINSI;

  |SI FSalida = 12; |Y #1#54 = "S";  |HAZ paraI;  |FINSI;

  |SI #cainliva#49 ! "N"; |Y #caivaasi#1 = "S"; |Y #cainliva#3 = 1;
      |SI eaDscomer9 ! "S";
          |PUSHV  1123 1563;
          |CUADRO 1123 1563;
          |ATRI I;
          |PINTA 1224, " SI REALIZA EL ASIENTO DE COBRO O PAGO ";
          |PINTA 1324, " AUTOMATICO, NO CREA RECIBO EN CARTERA ";
          |ATRI P;
          |PINTA 1424, " CONTINUAR S/N                         ";
          aAlfa1 = "S";
          E_sup  = 1;
          E_inf  = "SNsn";
          aAlfa1 = 1439 ? 0; aAlfa1 = aAlfa1 > ""; |PINTA 1439, aAlfa1;
          |POPV;
          |SI aAlfa1 = "N";
              #cainliva#49 = "N"; |PINTA #cainliva#49;
              |HAZ PintaCobro;
              |ACABA;
          |FINSI;
      |FINSI;
   |FINSI;

   alfa1 = Contenido;
   |SI alfa1 ! #cainliva#49;
       #cainliva#40 = "";
   |FINSI;
   |SI #cainliva#49 ! "N"; |Y #cainliva#73 = "01.01.0000";
       #cainliva#73 = #cainliva#4;
   |FINSI;
   |HAZ PintaCobro;
   |SI #cainliva#49 = "N";
       #cainliva#40 = ""; #cainliva#41 = 0;
       #cainliva#42 = ""; #cainliva#43 = 1; #cainliva#44 = "";
       #cainliva#73 = "01.01.0000";
       |ACABA;
   |FINSI;

   alfa1 = "S";
   |SI #cainliva#49 ! "T"; alfa1 = "N"; |FINSI;
   |SI #cainliva#49 = "T"; alfa1 = snCtaEf; |FINSI;
   |SI #cainliva#49 = "P"; alfa1 = snCtaCa; |FINSI;

   |SI #cainliva#3 > 1; alfa1 = "N"; |FINSI;

   |C_M #cainliva#40, 1, alfa1;

   |SI #cainliva#49 ! "T";
       |SI #cainliva#40 = doce; #cainliva#40 = dCtaCar; |FINSI;
       |SI dCtaCar = ""; |Y snCtaCa = "N";
           |MENAV "    Error, NO esta INFORMADA LA CUENTA DE COBRO/PAGO. No puede crear Asiento. ";
           #cainliva#49 = "N"; |PINTA #cainliva#49;
           |HAZ PintaCobro;
           |ERROR;
           |ACABA;
       |FINSI;
   |SINO;
       |SI #cainliva#40 = doce;
           |HAZ CalCuenta;
       |SINO;
           |C_M #cainliva#Campo#,0,alfa1;
           |SI alfa1 = "S"; alfa1 = snCtaEf; |FINSI;
           |C_M #cainliva#40,1,alfa1;
       |FINSI;
   |FINSI;
   |PINTA #cainliva#40;
|FCAL;

|CALCULO CuentaCobro;
    |SI #cainliva#49 ! "N";
        #cainliva#41 = #cacuenta#1;
        #cainliva#42 = #cacuenta#2;
        |SI #cainliva#49 = "T";
            #cainliva#43 = dConCEf;
            #cainliva#44 = dDesCEf;
        |SINO;
            #cainliva#43 = dConCar;
            #cainliva#44 = dDesCar;
       |FINSI;
   |FINSI;
|FCAL;

|PROCESO CalCuenta;

  asteris = 0;
  muestra = dCtaCEf; |QBF muestra;
  alfa1   = dCtaCEf; |QBF alfa1;
  alfa2   = alfa1 % 0;
  longi   = alfa2;            || 'longi' sirve despues (no tocar)
  nNume3  = (longi * 100) + 1;
  alfa2   = alfa1 % nNume3;
  |SI alfa2 = "*";
      nNume3    = 99 + longi;
      muestra   = alfa1 % nNume3;
      asteris   = 1;
  |FINSI;

  nSwLaC = 0;
  |PARA nNume4 = 1; |SI nNume4 [ longi; |HACIENDO nNume4 = nNume4 + 1;
        nNume1 = (nNume4 * 100) + 1;
        alfa3  = alfa1 % nNume1;
        |SI alfa3 = "C";  nSwLaC = 1; |FINSI;
  |SIGUE;

  |SI nSwLaC = 1;
      alfa5 = muestra % 0;
      nNume5 = alfa5;
      alfa5 = "";
      |PARA nPara1 = 1; |SI nPara1 [ nNume5; |HACIENDO nPara1 = nPara1 + 1;
            nNume6 = (nPara1 * 100) + 1;
            alfa6  = muestra % nNume6;
            |SI alfa6 = "C";
                alfa6 = #cainliva#5 % nNume6;
            |FINSI;
            alfa5 = alfa5 + alfa6;
     |SIGUE;

     muestra = alfa5;
 |FINSI;

  nNume2 = MaximoDigitos - (longi - 1);
  |SI asteris = 1;
      nNume2 = (100 * longi) + nNume2;
      alfa1 = #cainliva#5 % nNume2;
      muestra = muestra + alfa1;             || si es "*"
  |FINSI;

  #cainliva#40 = muestra;
|FPRC;

|CALCULO TrasFechaC; |TIPO 0;   || Desde Fecha
   nInkey = FSalida;

   |C_M #cainliva#73,0,alfa1;
   |SI alfa1 = "S";
       |SI #cainliva#73 < fec1; |O #cainliva#73 > fec2;
           |MENAV mensa1;
           |ERROR;
      |SINO;
           |SI #cainliva#73 [ fec3;
               |MENAV mensa2;
               |ERROR;
           |SINO;
               |SI #cainliva#73 < #cainliva#4;
                   |CONFI "0000NFecha inferior a la Fecha de Factura. Continuar";
                   |SI FSalida ! 0;
                       |ERROR;
                   |FINSI;
               |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO ActCliPro;

  |ABRE #caclipro;
  |SI aTipoIVA = "R";
      #caclipro#23 = "C";
  |SINO;
      #caclipro#23 = "P";
  |FINSI;
  #caclipro#10 = #cainliva#5;
  #caclipro#11 = #cainliva#6;
  |LEE 101#caclipro.=;
  |SI FSalida = 0;
      |SI aCPartida = ""; |Y #caivaasi#128 = "S";
          #caclipro#21 = #cainliva#17;
      |FINSI;
      |SI nCTiva = 0; |Y #caivaasi#129 = "S";
          #caclipro#42 = #cainliva#10;
      |FINSI;
      |GRABA 020#caclipro.a;
  |FINSI;
  |LIBERA #caclipro;
  |CIERRA #caclipro;
|FCAL;

|CALCULO AbreAmort;

   ModoEntrada = (FEntrada / 100) ! 0;
|| ................................... |SI ModoEntrada = 1; no solo en entrada
   |SI #cainliva#32 = "S"; |O swAmor = 1;

       |SI aTipoIVA = "R"; |Y #cainliva#32 = "S";
           aAlfa1 =  "2400SFra. de Inversion. Desea reflejar la venta del Bien Amortizable : ";
           |SI ModoEntrada = 2;
               aAlfa1 =  "2400SFra. de Inversion. Desea modificar la venta en el Bien Amortizable : ";
           |FINSI;
           |AVISO;
           |CONFI aAlfa1;
           |SI FSalida ! 0; |ACABA; |FINSI;
           fec_am = #cainliva#4;
           imp_am = #cainliva#12;    ||pase a amortizacion solo la base fra.
           c_am   = #cainliva#8;
           c_conp = #cainliva#7;
           ref_am  = #cainliva#53;
           nLib_am = #cainliva#0;
           aSer_am = #cainliva#26;
           nFra_am = #cainliva#2;
           tiva_am = #cainliva#13;
           iva_am  = #cainliva#14;
           c_ctana = #cainliva#58;
           enModAmor = ModoEntrada;
           enActividad = #cainliva#45;
           |SUB_EJECUTA_NP "camocab2.tab";
       |FINSI;

       |SI aTipoIVA = "S";

           aAlfa1 =  "2400SFra. de Inversion. Desea crear el Bien Amortizable : ";
           |SI swAmor = 1; aAlfa1 = "2400SFra. Bien Corriente. Desea crear la Ficha de Amortizacion: "; |FINSI;
           |SI ModoEntrada = 2;
               aAlfa1 =  "2400SFra. de Inversion. Desea modificar la compra del Bien Amortizable : ";
               |SI swAmor = 1; aAlfa1 = "2400SFra. Bien Corriente. Desea modificar la Ficha de Amortizacion: "; |FINSI;
           |FINSI;
           |AVISO;
           |CONFI aAlfa1;
           |SI FSalida ! 0;  |ACABA; |FINSI;
           ct1_am = #cainliva#17;
           ct2_am = #cainliva#18;
           eaCuenta = #cainliva#17;
           |HAZ LeeCuenta;
           ct3_am = #cacuenta#2;
           fec_am = #cainliva#4;
           imp_am = #cainliva#12;    ||pase a amortizacion solo la base fra.
           |SI #cainliva#19 = "S";
               iva_am = #cainliva#14;    ||iva para regularizar
               tiva_am = #cainliva#13;   ||% de iva
           |SINO;
               iva_am  = 0;
               tiva_am = 0;
               |SI #cainliva#19 = "I"; |O dCtaNoD = "";
                   imp_am = #cainliva#12 + #cainliva#14;
               |FINSI;
           |FINSI;
           c_conp = #cainliva#7;
           c_am   = #cainliva#8;  |QBF c_am;
           c_am   = c_am + " " + #cainliva#53;
           prv_am = #cainliva#27;

           dni_am = #cainliva#30;
           clau_am = #cainliva#62;
           igic_am = #calibros#3;

           ref_am  = #cainliva#53;
           nLib_am = #cainliva#0;
           aSer_am = #cainliva#26;
           nFra_am = #cainliva#2;
           c_ctana = #cainliva#58;
           enModAmor = ModoEntrada;
           enActividad = #cainliva#45;
           |SUB_EJECUTA_NP "camocab1.tab";
           #cainliva#70 = aElemento;
           #cainliva#71 = nNumero;
      |FINSI;
   |FINSI;
|FCAL;

|| ******************************************************************
|PROCESO BuscaNumero;
   |SI enQSerie = 0;
       |ABRE #calibros;
       #calibros#0 = #caintiva#0;
       |LEE 101#calibros.=;
       |SI FSalida = 0;
           NumFactura  = #calibros#4;
           #calibros#4 = #calibros#4 + #calibros#3;
           |GRABA 020#calibros.a;
       |FINSI;
       |LIBERA #calibros;
       |CIERRA #calibros;
   |SINO;
       |ABRE #caivases;
       #caivases#0 = #cainliva#26;
       #caivases#1 = aTipoIVA;
       |LEE 101#caivases.=;
       |SI FSalida = 0;
           NumFactura = #caivases#3;
           #caivases#3 = #caivases#3 + #caivases#4;
           |GRABA 020#caivases.a;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
      || SerieAnt = #cainliva#26;
   |FINSI;
   #cainliva#2 = NumFactura;
|FPRC;

|PROCESO DescuentaCont;
   |SI enQSerie = 0;
       |ABRE #calibros;
       #calibros#0 = #caintiva#0;
       |LEE 101#calibros.=;
       |SI FSalida = 0;
           NumFactura = NumFactura + #calibros#3;
           |SI NumFactura = #calibros#4;
               #calibros#4 = #calibros#4 - #calibros#3;
               |GRABA 020#calibros.a;
           |FINSI;
       |FINSI;
       |LIBERA #calibros;
       |CIERRA #calibros;
   |SINO;
       |ABRE #caivases;
       #caivases#0 = #cainliva#26;
       #caivases#1 = aTipoIVA;
       |LEE 101#caivases.=;
       |SI FSalida = 0;
           NumFactura = NumFactura + #caivases#4;
           |SI #caivases#3 = NumFactura;
               #caivases#3 = #caivases#3 - #caivases#4;
               |GRABA 020#caivases.a;
           |FINSI;
       |FINSI;
       |LIBERA #caivases;
       |CIERRA #caivases;
   |FINSI;
   swpase = 0;
   swmira = 0;
|FPRC;

|| **************************************************************************
|| ====================== Calculos de Cabecera
|CALCULO TrasLibro; |TIPO 0;

   |GRABA 000#caintiva.n;          || fuerza la grabacion
                                   ||/si el libro es modificable
                                   ||/y lo cambian no se graba y despues
                                   ||/no se actualiza nada  (RPC-04.03.03)
   |ABRE #calibros;
   #calibros#0 = #caintiva#0;
   |LEE 010#calibros.=;
   |SI FSalida ! 0;
      |MENAV "     No existe el libro";
      |CIERRA #calibros;
      |PTEC 807;
      |ACABA;
   |FINSI;
   |CIERRA #calibros;

   #caintiva#1 = #calibros#1; |PINTA #caintiva#1;
   |SI a_param ! "";
      |SI #calibros#2 ! a_param;
          |MENAV "     Libro de IVA No Correcto";
          |PTEC 807;
          |ACABA;
      |FINSI;
   |FINSI;

   eDCl340 = #calibros#6;
   nIvaInc = 1;
   aTipoIVA = #calibros#2;  #cainliva#50 = aTipoIVA;
   |HAZ LeeDefIVA;
   |SI aCCCla1 ! " "; eDCl340 = aCCCla1; |FINSI;

   nIvaInc = 0;

|SI nYaCrea = 0;
   enLibIVA  = #caintiva#0;
   enFilConc = 2;          || Conceptos de IVA
   |HAZ CreaConcepto;
   aFich1 = eaFiCon;
   enFilConc = 3;          || Conceptos de IRPF
   |HAZ CreaConcepto;
   aFich2 = eaFiCon;
   nYaCrea = 1;
|FINSI;

   |ATRI I; |PINTA 2044, "Intra.    "; |ATRI 0;
   |C_M #cainliva#57, 1,"N";
   |C_V #cainliva#57, 1,"N";
   |C_P #cainliva#54, 1,2146;
   |SI aTipoIVA = "R";
      |ATRI R; |PINTA 0740, "Cliente   "; |ATRI 0;
      |ATRI I;
      |PINTA 0659, "REPERCUTIDO";
      |ATRI N;
      |PINTA 1502, "Cliente..:";
      |PINTA 1724, "Cobro: ";
   |SINO;
      |ATRI R; |PINTA 0740, "Proveedor "; |ATRI 0;
      |ATRI I;
      |PINTA 0659, "SOPORTADO";
      |ATRI N;
      |PINTA 1502, "Proveedor:";
      |PINTA 1724, "Pago.:";
      alfa1 = #caivaasi#22; |C_M #cainliva#19, 1,alfa1;
      |ATRI I; |PINTA 2044, "Comun Intr"; |ATRI 0;
      |C_P #cainliva#54,1,2151; |PINTA #cainliva#54;
      |C_V #cainliva#57, 1,"S"; |PINTA #cainliva#57;
      |SI enNumAct > 1; |C_M #cainliva#57, 1,"S"; |FINSI;
   |FINSI;

   |HAZ ModLosDefectos;
   alfa1 = #caivaasi#69;        ||Descuento
   |C_V #cainliva#11, 1, alfa1;
   |SI alfa1 = "N";
       |PINTA 1961,"                 ";
   |SINO;
       |PINTA 1961,"Dto:             ";
   |FINSI;
|FCAL;
|| /////////////////////////////////////////////////////////////////////

|RUTINA ClaveBaja1;
      #cainliva#0 = #caintiva#0;
      #cainliva#1 = 1;
|FRUT;

|RUTINA ClaveAlta1;
     #cainliva#0 = #caintiva#0;
     #cainliva#1 = 999;
|FRUT;

|CALCULO TLineas; |TIPO 3;
 |SI enSwAna = 1;
     |ATRI S; |PINTA 2120, "Analitica:"; |ATRI 0;
  |FINSI;
  |ENTLINEAL #1#cainliva, -2, 1, 11, 0, ClaveBaja1, ClaveAlta1;
  |HAZ PongoNumero;
|FCAL;

|| ***************************************************** PROGRAMA
|PROCESO MiraSiLin;
   |ERROR10; SwMovs = 1;
|FPRC;

|DEFBUCLE MiraSiLin;
 #cainliva#1;
 ;
 #caintiva#0,001;
 #caintiva#0,999;
 ;
 NULL,MiraSiLin;
|FIN;


|CALCULO Actualiza;
   |AVISO;
   |CONFI "2400SDesea actualizar las facturas en el libro y en el diario ? (S/N)";
   |SI FSalida = 0;
       enLibIVA  = #caintiva#0;
       |SUB_EJECUTA "caivaact";
   |FINSI;
|FCAL;

|PROCESO DatosAnterior;
   SerieAnt    = #cainliva#26;
   FacturaAnt  = #cainliva#2;
   FechaAnt    = #cainliva#4;
   CuentaAnt   = #cainliva#5;
   DigitoAnt   = #cainliva#6;
   PerioAnt    = #cainliva#31;
   ClienAnt    = #cainliva#27;
   CifAnt      = #cainliva#30;
   ConceptoAnt = #cainliva#7; dConc1 = ConceptoAnt;
   DescAnt     = #cainliva#8; dDesc1 = aAntesDes0;
   DeparAnt    = #cainliva#45;
   NDeparAnt   = #cainliva#46;
   SubdeAnt    = #cainliva#47;
   NSubdeAnt   = #cainliva#48;
   ReferAnt    = #cainliva#53;
   RefPrAnt    = #cainliva#72;

   nAnterior     = 0;
   nAnteriorIRPF = 0;
   aAntesDes0    = "";
   aAntesDes1    = "";

   fCamp73     = #cainliva#73;
   aCamp40     = #cainliva#40;
   nCamp41     = #cainliva#41;
   aCamp42     = #cainliva#42;
   nCamp43     = #cainliva#43;
   aCamp44     = #cainliva#44;
   aCamp49     = #cainliva#49;
   aCamp19     = #cainliva#19;

   aCamp17     = #cainliva#17;
   nCamp18     = #cainliva#18;
   aCamp28     = #cainliva#28;
   aCamp55     = #cainliva#55;
   aCamp56     = #cainliva#56;
   aCamp57     = #cainliva#57;

   nCamp51     = #cainliva#51;
   aCamp52     = #cainliva#52;
   nCamp10     = #cainliva#10;
   aCamp39     = #cainliva#39;
   nCamp34     = #cainliva#34;
   aCamp36     = #cainliva#36;
   nCamp37     = #cainliva#37;
   nCamp59     = #cainliva#59;

   nCamp35     = #cainliva#35;
   nCamp12     = #cainliva#12;
   nCamp13     = #cainliva#13;
   nCamp14     = #cainliva#14;
   nCamp15     = #cainliva#15;
   nCamp16     = #cainliva#16;
   nCamp11     = #cainliva#11;
   nCamp29     = #cainliva#29;

   aCamp54     = #cainliva#54;
   aCamp32     = #cainliva#32;
   aCamp58     = #cainliva#58;

   fCamp61     = #cainliva#61;
   aCamp62     = #cainliva#62;
   aCamp63     = #cainliva#63;
   aCamp64     = #cainliva#64;
   nCamp60     = #cainliva#60;
   aCamp68     = #cainliva#68;
|FPRC;

|PROCESO ModLosDefectos;
  |C_M #cainliva#3,1,"S";
  |C_M #cainliva#4,1,"S";
  |C_M #cainliva#5,1,"S";
  |C_M #cainliva#53,1,"S";

   #cainliva#50 = aTipoIVA;
   |C_M #cainliva#26, 1,snSerie;  || Modificables S/N
   |C_M #cainliva#7,  1,snConc1;
   |C_M #cainliva#8,  1,snDesc1;
   |C_M #cainliva#10, 1,snTiva;
   |C_M #cainliva#32, 1,snInver;
   |C_M #cainliva#19, 1,snDeduc;
   |C_M #cainliva#34, 1,snTpIrpf;
   |C_M #cainliva#35, 1,snCIrpf;
   |C_M #cainliva#51, 1,snReten;
   |C_M #cainliva#52, 1,snDIrpf;
   |C_M #cainliva#59, 1,snBIrpf;
   |SI snReten = "N"; #cainliva#51 = 0; |FINSI;

   alfa1 = #caivaasi#20;        ||Departamento
   |SI eaDepar = "N"; alfa1 = "N"; |FINSI;
   |C_M #cainliva#45, 1, alfa1;
   alfa1 = #caivaasi#68;        ||Subdepartamento
   |SI eaSubde = "N"; alfa1 = "N"; |FINSI;
   |C_M #cainliva#47, 1, alfa1;

   alfa1 = #caivaasi#28;        ||Periodo Modifica o Calcular
   |C_M #cainliva#31, 1, alfa1;

   alfa1 = #caivaasi#35;        ||Nombre Cliente / Proveedor
   |SI alfa1 ! "N"; alfa1 = "S"; |FINSI;
   |C_M #cainliva#27, 1, alfa1;
   alfa1 = #caivaasi#36;        ||CIF. Cliente / Proveedor
   |C_M #cainliva#30,1, alfa1;

   alfa1 = #caivaasi#70;        ||Cuenta Base
   |C_M #cainliva#17,1, alfa1;

   |C_M #cainliva#49,1,snCoPa;
   |HAZ PintaCobro;
   |C_M #cainliva#62,1,"S";
   |SI eDCl340 ! " ";
       |C_M #cainliva#62,1,"N";
       |SI aCCCla1 ! " ";
           |C_M #cainliva#62,1,aCCCla2;
       |FINSI;
   |FINSI;
|FPRC;

|| ***********************************************************************
|PROCESO VoyaW17;
       coant  = #cainliva#7;
       deant  = #cainliva#8;
       dpant  = #cainliva#45;
       sdant  = #cainliva#47;
       refant = #cainliva#53;
       en0W17 = #cainliva#0;
       ef1W17 = fechaW17;
       en2W17 = #cainliva#1;
       enSwActual = 1;
       |SUB_EJECUTA_NP "caw00017";
|FPRC;

|PROCESO CreaVtos;
   enLinea = #cainliva#1;
   libro   = #cainliva#0;
   serie   = #cainliva#26;
   orden   = #cainliva#2;
   emision = #cainliva#4;
   |SI #cainliva#54 = "N"; |Y #cainliva#62 ! "I";
       pesetas = #cainliva#29;
   |SINO;
       pesetas = #cainliva#12 - #cainliva#35;
   |FINSI;
   cuenta = #cainliva#5; eaCuenta = cuenta; |HAZ SacaNivel;
   digito = enNivel;
   enCyP = #cainliva#49;
   eaRef = #cainliva#53;

   |HAZ EsComersan;
   |SI FSalida = 0; |Y aTipoIVA = "S";
       aFraPrv = #cainliva#72; |QBF aFraPrv;
       |SI aFraPrv ! "";  eaRef = aFraPrv; |FINSI;
   |FINSI;
   |SUB_EJECUTA_NP "caintvto";
|FPRC;

|PROCESO externos;                      || desde calculo 'cuefin'
   |ATRI P;
   |MENSA "    Cargando Opcion ...";
   |ATRI 0;
   |SUB_EJECUTA_NP "caextrap";

   |PINTA 1180, "  "; |PINTA 1180, "";
   |PINTA 1280, "  "; |PINTA 1280, "";
   |PINTA 1380, "  "; |PINTA 1380, "";
   |PINTA 1480, "  "; |PINTA 1480, "";
   |PINTA 1580, "  "; |PINTA 1580, "";
   |PINTA 1680, "  "; |PINTA 1680, "";
   |PINTA 1780, "  "; |PINTA 1780, "";
   |PINTA 1880, "  "; |PINTA 1880, "";
   |PINTA 1980, "  "; |PINTA 1980, "";
|FPRC;

|PROCESO pintoDep;
  #cafantas#8 = eaNombreAct;
  #cafantas#10 = efActIni;
  #cafantas#11 = efActFin;
  |SI eaNombreAct ! "";
      |ATRI P; |PINTA 2202, "Depar.: "; |ATRI 0;
               |PINTA 2210, #cafantas#8;
      |SI efActIni > "01.01.1900";
          |ATRI S; |PINTA 2242, "F.Inicio: "; |ATRI 0;
                   |PINTA 2251, #cafantas#10;
      |FINSI;
      |SI efActFin > "01.01.1900";
          |ATRI S; |PINTA 2263, "F.Fin: "; |ATRI 0;
                   |PINTA 2269, #cafantas#11;
      |FINSI;
  |FINSI;
|FPRC;

|| ***************************************************** PROGRAMA

|PROCESO Boton1;
     |PTEC 828;
|FPRC;

|PROCESO Boton2;
      aEjecuta = "|:dsarchi/dpntz002;";
      aEjecuta = aEjecuta +  (("00000" + #801#0) % -105);
      aEjecuta = aEjecuta +  aTipoIVA;
      aEjecuta = aEjecuta +  (("000000" + #1#69) % -106);
      aEjecuta = aEjecuta +  "VER";
      |SUB_EJECUTA aEjecuta;
|FPRC;

|PROCESO Boton3;
   |ESTADO_CONTROL nBoton3, "DISABLE"; nEstadoBoton3 = 0;
   enLibro = #caintiva#0;
   |SUB_EJECUTA_NP "capcez01.tab";
   |ESTADO_CONTROL nBoton3, "ENABLE";  nEstadoBoton3 = 1;
   |PTEC 808; |PONCONTROL 23, "SI";
|FPRC;

|PROCESO BuscaDSARCHI;
     nDSARCHI = 0;

     |DBASS aPathDSARCHI;   |QBF aPathDSARCHI;
     aPathDefDSARCHI = aPathDSARCHI + "dsarchi/def/";
     aMas            = aPathDefDSARCHI + "dsarm001.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |SI #dsarm001#182 ! "2";
         || Desactivado se contabiliza desde una bandeja en dsarchi
         |ACABA;
     |FINSI;

     |CONTROL_SIMPLE 0, "LBOTON,F6 Recoger factura", 0543, 0557, Boton1;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON,F7 Ver en DESPANET", 0643, 0657, Boton2;
     nBoton2 = FSalida;

     |ESTADO_CONTROL nBoton1, "DISABLE";
     |ESTADO_CONTROL nBoton2, "DISABLE";

     aPathFichDSARCHI = aPathDSARCHI + "dsarchi/fich/";
     |PATH_DAT #801 aPathFichDSARCHI;
     |ABRE #801;
     #801#0 = #48#2;
     |LEE 000#801=;
     |SI FSalida = 0;
          |ATRI S;
          |PINTA 0525, "ACTIVADO DESPANET";
          |ATRI s;
     |FINSI;
     |CIERRA #801;

     nDSARCHI = 1;

     aPathFichDESPANET = aPathDSARCHI + "despanet/" + (("00000" + #801#0) % -105) + "/fich/";
     |PATH_DAT #850 aPathFichDESPANET;
     |PATH_DAT #851 aPathFichDESPANET;

     |ABRE #850;
     |ABRE #851;

     |SI aTipoIVA = "R";
         |SELECT #2#850;
         |LEE 000#850p;
         |SI FSalida = 0;  |Y #850#29 = "N";
             |ESTADO_CONTROL nBoton1, "ENABLE";
         |FINSI;
     |FINSI;

     |SI aTipoIVA = "S";
         |SELECT #2#851;
         |LEE 000#851p;
         |SI FSalida = 0;  |Y #851#29 = "N";
             |ESTADO_CONTROL nBoton1, "ENABLE";
         |FINSI;
     |FINSI;
|FPRC;

|CALCULO TrasDeparT; |TIPO 0;
   nTecla = FSalida;
   eOpDep = 0;                            || 1 = Consulta pantalla
   |SI nTecla = 10; eOpDep = 1;  |FINSI;

   enActividad = #caintiva#2;
   eaCodDep    = #caintiva#2;
   |HAZ Actividad;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Actividad / Departamento";
       |ERROR;
   |SINO;
       alfa1 = enActividad;
       #caintiva#2 = eaCodDep;    |PINTA 1017, #caintiva#2;
       #caintiva#3 = eaNombreAct; |PINTA 1020, #caintiva#3;
       |SI efActFin > "01.01.1900"; |Y snFilBa = "S";
           aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
           |CONFI aAlfa1;
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
       |SI eaEsCom = "S";
           |CONFI "    NAtencion!!!. Actividad Comunera,  Desea introducir Facturas ? ";
           |SI FSalida ! 0;
               |ERROR;
           |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|PROCESO PedirDepar;
    nSalir = 0;
    |ABRE #caivaasi;
    |DDEFECTO #caivaasi;
    |LEE 000#caivaasi.p;
    |CIERRA #caivaasi;

    |SI #caivaasi#187 = "S";

        |C_V #caintiva#2, 1, "S";
        |C_V #caintiva#3, 1, "S";
        |C_V #caintiva#4, 1, "S";
        |C_V #caintiva#5, 1, "S";
        |C_V #caintiva#6, 1, "S";
        #caintiva#2 = #caivaasi#19;
        |C_V #caintiva#0, 1, "N";
        |C_V #caintiva#1, 1, "N";

        |CLS;
        |PINPA #0#caintiva;
        |PINDA #0#caintiva;
     || |CUADRO 1015 2060;
     || |ATRI R; |PINTA 1116, " INTRODUCIR EL DEPARTAMENTO DE LAS FACTURAS "; |ATRI 0;
     ||          |PINTA 1848, "CONFORME: ";
     || |PINTA 1217, #caintiva#2;
     || |PINTA 1220, #caintiva#3;
     || |PINTA 1558, #caintiva#4;
     || |ATRI 0; |CUADRO 14461660;

  |ET Campo2;
        |ENCAMPO #2#caintiva;
        |SI FSalida = 7; nSalir = 1; |ACABA; |FINSI;

        enAParam = #caintiva#2;
        nIvaInc = 1;
        |HAZ LeeDefIVA;
        nIvaInc = 0;
        #caintiva#5 = "";
        #caintiva#6 = "";
        enConcepto  = dConc1;
        enActividad = #caintiva#2;
        eaCodSubdep = #caivaasi#67;
        |SI eaCodSubdep ! "   ";
            enQue = 0;
            |HAZ SubActividad;
            #caintiva#5 = eaCodSubdep;
            #caintiva#6 = eaNomSubdep;
        |FINSI;
        |PINTA #caintiva#5;
        |PINTA #caintiva#6;
        enTipOpera = 0;
        enEmpres = enEmpresa;
        enEjerci = enEjercicio;
        nResPer  = enPeriodo;
        enActivi = #caintiva#2;
        eaCodSub = #caintiva#5;
        |SUB_EJECUTA_NP "caz00002";
        enPeriodo = nResPer;
        |POPV;

        |ENCAMPO #4#caintiva;
        |SI FSalida = 7; nSalir = 1; |ACABA; |FINSI;
        |SI FSalida = 2; |VETE Campo2; |FINSI;

        |C_V #caintiva#2, 1, "N";
        |C_V #caintiva#3, 1, "N";
        |C_V #caintiva#4, 1, "N";
        |C_V #caintiva#5, 1, "N";
        |C_V #caintiva#6, 1, "N";
        |C_V #caintiva#0, 1, "S";
        |C_V #caintiva#1, 1, "S";

        |SI #caintiva#4 = "N"; nSalir = 1; |FINSI;
        enAParam = #caintiva#2;
        |C_M #cainliva#45,1, "N";
    |FINSI;
|FPRC;

|PROGRAMA;
   eaMensaCad = "9";
   |HAZ ControlCaducidad;
   |SI enErrorCad = 1;
       |ACABA;
   |FINSI;

   aFichero = "wc" + Usuario;
   |NOME_DAT #camaccw1# aFichero#;
   |DELINDEX #camaccw1;
   eaFicCaja = aFichero;

   |CLS;
   |CABEZA "Introduccion Fras de IVA";
   a_param = PARAMETRO; |QBT a_param;
   |SI a_param ! "";
       a_param  = a_param % 101;
       aTipoIVA = a_param;
   |FINSI;
   |HAZ inicial; |SI swerror ] 2; |ACABA; |FINSI;
   |QBF eaNifEmp;

   |HAZ Analitica;
   |SI enSwAna = 1;
       |C_V #1#58, 1, "S";
       |C_M #1#58, 1, "S";
   |FINSI;
   |HAZ CuentoActiv;
   |HAZ Consul303;

    enEmpresaPINET = enEmpresa;
    |HAZ RestriccionPINET;
    |SI enErrorPINET = 1;
        |ERROR;
        |ACABA;
    |SINO;
        |SI enModoPINET1 = 1; |O enModoPINET2 = 1;
            |MENAV "    No tiene permiso para Modificar este Registro";
            |ACABA;
        |FINSI;
    |FINSI;

   enIn03  = 1;

   |DBASE aDirInicio;
   aMas  = aDirInicio + "def/cainliva";
   |CARGA_DEF aMas, lalinea@;
   |SI FSalida ! 0;
       |MENAV "    Error Cargado Fichero de Contabilidad. Proceso Interrumpido";
       |ACABA;
   |FINSI;

   eaFitW17 = "caw00017";
  || .... ........... ...  |NOME_DAT #17 eaFitW17;
   fechaW17 = "01.01.0000";

   eaFitnW12 = "12wnliva";
   |NOME_DAT #212 eaFitnW12;
   eaFitnW13 = "13wnliva";
   |NOME_DAT #213 eaFitnW13;

   enAParam = 0;
   |DDEFECTO #caintiva;
   |SI aTipoIVA ! "";
       |HAZ PedirDepar;
       |SI nSalir = 1;
          |DESCARGA_DEF #901;
          |ACABA;
       |FINSI;

       nIvaInc = 1;
       |HAZ LeeDefIVA;
       nIvaInc = 0;
       #caintiva#0 = dLibro;
       |C_M #caintiva#0,1,snLibro;
   |FINSI;

   |PINPA #0#cainliva;
   |ABRE #caintiva;
   |LEE 001#caintiva.=;
   |SI FSalida ! 0;
       swNuevo  = 1;
       #caintiva#7 = aTipoIVA;
       |GRABA 020#caintiva.b;
   |FINSI;
   enLibIVA = #caintiva#0;

   |HAZ BuscaDSARCHI;

   |DDEF aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "capcem01.mas";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida < 0; nEsPCEG = 0; |SINO; nEsPCEG = 1; |FINSI;

   |SI PARAMETRO = "RN"; |Y nEsPCEG = 1;
      |CONTROL_SIMPLE 0, "LBOTON,F8 Importacion Facturas XML", 0559, 0575, Boton3;
      nBoton3 = FSalida; nEstadoBoton3 = 1;
   |FINSI;

   |SI a_param ! ""; |Y snLibro = "N";
       |HAZ TrasLibro;
       |HAZ TLineas;
   |SINO;
       |ENCAMPO #0#caintiva;
       |SI eaBloqueo = "3"; |ACABA; |FINSI;
       |HAZ TLineas;
   |FINSI;
   |LIBERA #caintiva;

   |DESCARGA_DEF #901;

   SwMovs = 0;
   |BUCLE MiraSiLin; ||Y numero
   |SI SwMovs = 0;
       #caintiva#0 = enLibIVA;
       |LEE 101#caintiva.=;
       |SI FSalida = 0; |BORRA 020#caintiva.a; |FINSI;
       |LIBERA #caintiva;
       |CIERRA #caintiva;
   |SINO;
       #caintiva#0 = enLibIVA;
       |LEE 141#caintiva.=;
       |SI FSalida = 0;
           #caintiva#7 = aTipoIVA;
           |GRABA 020#caintiva.a;
       |FINSI;
       |LIBERA #caintiva;
       |CIERRA #caintiva;
       |HAZ Actualiza;
   |FINSI;

   |SI PARAMETRO = "RN"; |Y nEsPCEG = 1;
      |FIN_CONTROL_WINDOWS nBoton3;
   |FINSI;

   |SI nDSARCHI = 1;
       |FIN_CONTROL_WINDOWS nBoton1;
       |FIN_CONTROL_WINDOWS nBoton2;

       |CIERRA #850;
       |CIERRA #851;
   |FINSI;
|FPRO;


|PROCESO dpntm100;
     |SI nPasada = 0;
         nHay = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     #1#69 = #850#0;
     #1#12 = #850#21;
     #1#13 = #850#22;
     #1#14 = #850#23;
     #1#15 = #850#24;
     #1#16 = #850#25;

     #cainliva#29 = #cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35;
     #cainliva#67 = #cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35;

     |SI #850#26 ! 0;
         #1#39 = "B";
         #1#59 = #1#12;
         #1#34 = #850#26;
         #1#35 = #850#27;
     |FINSI;

     nLinea1 = nLinea1 + 1;
     nLinea2 = nLinea2 + 1;

     #1#1  = nLinea1;
     #1#3  = nLinea2;
     #1#65 = #1#5;
     #1#66 = #1#17;
     #1#67 = #1#29;

     |SI swclipro = 1;
         |SI #caivaasi#128 = "S"; |O #caivaasi#129 = "S";
             |HAZ ActCliPro;
         |FINSI;
     |FINSI;

     swclipro = 0;

     |SI #caivaasi#1 = "S";
         |SI #cainliva#49 ! "S";
             enModoEsc = 1;
             |HAZ CreaVtos;
         |FINSI;
     |FINSI;

     |SI #caivaasi#131 = "S";
         |ABRE #130;
         #130#0 = #1#7;
         |LEE 000#130=;
         nCampo = 8;   xx = 1;  |HAZ adaptaC2;  #1nCampo = aAlfa1;

         #130#0 = #1#51;
         |LEE 000#130=;
         nCampo = 52;  xx = 3;  |HAZ adaptaC2;  #1nCampo = aAlfa1;
         |CIERRA #130;
     |FINSI;

     |SI #1#34 = 0;  |Y #1#35 = 0;
         #1#51 = 0;
         #1#52 = "";
     |FINSI;

     |GRABA 020#1n;
     |LIBERA #1;

     #850#29 = "S";
     |GRABA 020#850a;
     |LIBERA #850;
|FPRC;

|DEFBUCLE dpntm100;
     #850#4;
     44, 29;
     nRecoge,      1, "N", "N";
     nRecoge, 999999, "N", "N";
     be;
     NULL, dpntm100;
|FIN;

|PROCESO dpntm101;
     |SI nPasada = 0;
         nHay = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     #1#4  = #851#15;
     #1#69 = #851#0;
     #1#12 = #851#21;
     #1#13 = #851#22;
     #1#14 = #851#23;
     #1#15 = #851#24;
     #1#16 = #851#25;

     nSwYaTengoTipo = 0;
     ||ARACCC
     ||Tiquet 35.835

     |ABRE #gadm0000;
     #gadm0000#0 = #caintiva#0;
     |LEE 000#gadm0000.=;
     |SI FSalida = 0;
          nTipoIVA = #gadm0000#6;
          |SI nTipoIVA ! 0;
               efFechaIVA = #1#4;
               enLineaIVA = nTipoIVA;
               |HAZ SacaIVA;
               |SI enPorcIVA = #1#13;
                    #1#10 = nTipoIVA;
                    nSwYaTengoTipo = 1;
               |FINSI;
          |FINSI;
          |SI nSwYaTengoTipo = 0;
               nTipoIVA = #gadm0000#7;
               |SI nTipoIVA ! 0;
                    efFechaIVA = #1#4;
                    enLineaIVA = nTipoIVA;
                    |HAZ SacaIVA;
                    |SI enPorcIVA = #1#13;
                         #1#10 = nTipoIVA;
                         nSwYaTengoTipo = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #gadm0000;

     |SI nSwYaTengoTipo = 0;
          efFechaIVA = #1#4;  enLineaIVA = 0;
          enPorcIVA  = #1#13; enPorcREC  = #1#15;
          |HAZ BuscaTipoIVA; #1#10 = enLineaIVA;
     |FINSI;

     #cainliva#29 = #cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35;
     #cainliva#67 = #cainliva#12 + #cainliva#14 + #cainliva#16 - #cainliva#35;

     |SI #851#26 ! 0;
         #1#39 = #851#71;
         |SI #1#39 = "F";
              #1#59 = #1#12 + #1#14 + #1#16;
         |SINO;
             #1#59 = #1#12;
         |FINSI;
         #1#34 = #851#26;
         #1#35 = #851#27;
     |FINSI;

     nLinea1 = nLinea1 + 1;
     nLinea2 = nLinea2 + 1;

     #1#1  = nLinea1;
     #1#3  = nLinea2;
     #1#65 = #1#5;
     #1#66 = #1#17;
     #1#67 = #1#29;

     |SI swclipro = 1;
         |SI #caivaasi#128 = "S"; |O #caivaasi#129 = "S";
             |HAZ ActCliPro;
         |FINSI;
     |FINSI;

     swclipro = 0;

     |SI #caivaasi#1 = "S";
         |SI #cainliva#49 ! "S";
             enModoEsc = 1;
             |HAZ CreaVtos;
         |FINSI;
     |FINSI;

     |SI #caivaasi#131 = "S";
         |ABRE #130;
         #130#0 = #1#7;
         |LEE 000#130=;
         nCampo = 8;   xx = 1;  |HAZ adaptaC2;  #1nCampo = aAlfa1;

         #130#0 = #1#51;
         |LEE 000#130=;
         nCampo = 52;  xx = 3;  |HAZ adaptaC2;  #1nCampo = aAlfa1;
         |CIERRA #130;
     |FINSI;

     |SI #1#34 = 0;  |Y #1#35 = 0;
         #1#51 = 0;
         #1#52 = "";
     |FINSI;

     |GRABA 020#1n;
     |LIBERA #1;

     #851#29 = "S";
     |GRABA 020#851a;
     |LIBERA #851;
|FPRC;

|DEFBUCLE dpntm101;
     #851#4;
     44, 29;
     nRecoge,      1, "N", "N";
     nRecoge, 999999, "N", "N";
     be;
     NULL, dpntm101;
|FIN;

|PROCESO VariasBases;
     |SI nRecoge = 0;  |ACABA;  |FINSI;

     nHay = 0;

     |SI aTipoIVA = "R";
         nPasada = 0;   |BUCLE dpntm100;
     |FINSI;

     |SI aTipoIVA = "S";
         nPasada = 0;   |BUCLE dpntm101;
     |FINSI;

     |SI nHay = 0;  |ACABA;  |FINSI;

     |GRABA 020#1a;
     |LIBERA #1;

     |SALVA_DATOS #1;

     nLinea1 = #1#1;
     nLinea2 = #1#3;

     |SI aTipoIVA = "R";
         nPasada = 1;   |BUCLE dpntm100;
     |FINSI;

     |SI aTipoIVA = "S";
         nPasada = 1;   |BUCLE dpntm101;
     |FINSI;

     |REPON_DATOS #1;

     |LEE 101#1=;

     nRecoge  = 0;

     |MENAV "0000Factura con varios tipos de iva. Se ha introducido todos los apuntes. Revise los datos";

     |PONCONTROL 23, "SI";
     |PTEC 812;
     |PTEC 812;
|FPRC;
