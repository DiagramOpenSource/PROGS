|FICHEROS;
   caimplis #0;

   cacuenta #1;
   caclipro #2;
   caenlace #3;
   canempre #4;
|FIN;

|VARIABLES;
   Handle     = 0;
   Espacios   = 0;
   Nivel      = 0;
   Calc       = 0;
   Calc1      = 0;
   Calc2      = 0;
   nLong      = 0;
   nPosic     = 5;

   Comodin    = "";
   Comodin1   = "";
   Comodin2   = "";
   Fichero    = "";
   Cuenta     = "";
   DescCuenta = "";
   CR         = "";
   LF         = "";
   Tecla      = "";
   Vacio      = "";
   aFecha     = "";
   aLong      = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
|FIN;

|INCLUYE dscont_i;


|PROCESO PlanCuentas;
   |BLANCO 2201 2280;
   |PINTA 2201, "    Importando cuenta               Desc.";

      |ABRE #cacuenta;

      Espacios = 0; Cuenta = ""; Nivel = 0; DescCuenta = "";
      CR = &13; LF = &10; Vacio = &0;
      Fichero = #0#0; |QBF Fichero;
      Comodin = Fichero % -101;
      |SI Comodin ! "/"; Fichero = Fichero + "/"; #0#0 = Fichero; |PINTA #0#0; |FINSI;

||      ************** FICHERO PLAN CONTABLE ****************

      Comodin = Fichero + #0#1; |QBF Comodin;
      Comodin = "rb  " + Comodin; |FABRE Comodin;
      |SI FSalida ] 0;
         Handle = FSalida;
         |PARA; |SI FSalida ] 0; |HACIENDO;
            Comodin = Handle + " " + 1; |FLEE Comodin; |SI FSalida = 0; |VETE Final1; |FINSI;
            |SI Nivel ! 0; |Y Comodin ! CR; DescCuenta = DescCuenta + Comodin; |FINSI;
            |SI Comodin = " "; |Y Nivel = 0; Espacios = Espacios + 1; |FINSI;
            |SI Comodin ] "A"; |Y Comodin [ "z"; Espacios = 0; |FINSI;
            |SI Comodin ] "0"; |Y Comodin [ "9"; |Y Nivel = 0;
               || Determinamos el nivel
               |SI Espacios = 5;  Nivel = 1; Calc = 1;  |FINSI;
               |SI Espacios = 9;  Nivel = 2; Calc = 2;  |FINSI;
               |SI Espacios = 14; Nivel = 3; Calc = 5;  |FINSI;
               |SI Espacios = 22; Nivel = 4; Calc = 10; |FINSI;
               |SI Nivel ! 0;
                  Cuenta = Comodin;
                  Comodin = Handle + " " + Calc; |FLEE Comodin;
                  Cuenta = Cuenta + Comodin;
                  |SI Nivel = 3;
                     Cuenta = Cuenta - ".";
                  |FINSI;
                  |SI Nivel = 4;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     |QBT Cuenta;
                  |FINSI;
                  aLong = Cuenta % 0; nLong = aLong;
                  |SI nLong > 5; |Y nLong < 9;
                     Calc = 9 - nLong; Comodin1 = "0" * Calc;
                     Calc1 = 99 + nPosic; Calc2 = (nPosic * 100) + 99;
                     Cuenta = (Cuenta % Calc1) + Comodin1 + (Cuenta % Calc2);
                  |FINSI;
                  |SI nLong = 2; Nivel = 1; |FINSI;
                  |SI nLong = 3; Nivel = 2; |FINSI;
                  |SI nLong = 5; Nivel = 3; |FINSI;
                  |SI nLong = 9; Nivel = 4; |FINSI;
                  Comodin = Handle + " " + 2; |FLEE Comodin;
               |FINSI;
            |FINSI;
            |SI Comodin = CR;
               Comodin = Handle + " " + 1; |FLEE Comodin;
               |SI Comodin = Vacio;
                  |SAL;
               |FINSI;
               |SI Comodin = LF;
                  |SI Nivel ! 0;
                     #cacuenta#0 = Cuenta;
                     #cacuenta#1 = Nivel;
                     |LEE 000#cacuenta.=;
                     |SI FSalida ! 0;
                        |DDEFECTO #cacuenta;
                        #cacuenta#0 = Cuenta; |PINTA 2223, #cacuenta#0;
                        #cacuenta#1 = Nivel;
                        #cacuenta#2 = DescCuenta; |PINTA 2243, #cacuenta#2;
                        |SI Nivel = 4; #cacuenta#3 = "S"; |FINSI;
                        |GRABA 020#cacuenta.n;
                     |FINSI;
                  |FINSI;
                  Espacios = 0; Cuenta = ""; Nivel = 0; DescCuenta = "";
               |FINSI;
            |FINSI;
         |SIGUE;
      |FINSI;
|ET Final1;
      |SI Cuenta ! "";
         #cacuenta#0 = Cuenta;
         #cacuenta#1 = Nivel;
         |LEE 000#cacuenta.=;
         |SI FSalida ! 0;
            |DDEFECTO #cacuenta;
            #cacuenta#0 = Cuenta; |PINTA 2223, #cacuenta#0;
            #cacuenta#1 = Nivel;
            #cacuenta#2 = DescCuenta; |PINTA 2243, #cacuenta#2;
            |SI Nivel = 4; #cacuenta#3 = "S"; |FINSI;
            |GRABA 020#cacuenta.n;
         |FINSI;
      |FINSI;

      FSalida = Handle; |FCIERRA FSalida;
      |CIERRA #cacuenta;
      |ATRI I; |PINTA 2201, "    Recalculando estructura plan contable                                    "; |ATRI N;
      |SUB_EJECUTA_NP "carecepi.tab;fuera";
|FPRC;

|PROCESO ArreglaImporte;
   aLong = Comodin % 0; nLong = aLong;
   Comodin = Comodin - ".";
   |PARA; |SI FSalida ! 0; |HACIENDO;
      Comodin = Comodin - ".";
   |SIGUE;
   Comodin = Comodin - ",";
   |SI FSalida ! 0;
      Calc = ((FSalida / 100) ! 0) + 99;
      Comodin1 = Comodin % Calc;
      Calc = FSalida + 98;
      Comodin2 = Comodin % Calc;
      Comodin = Comodin1 + "." + Comodin2;
   |FINSI;
|FPRC;

|PROCESO Diario;
   |BLANCO 2201 2280;
   |PINTA 2201, "    Importando Diario     Fecha ";
   |PINTA 2244, "Asiento         Apunte";
   |ABRE #caenlace;

      Cuenta = ""; Nivel = 0;
      CR = &13; LF = &10; Vacio = &0; Tecla = &32; Comodin = "";
      Fichero = #0#0; |QBF Fichero;
||      ************** FICHERO DIARIO ****************
      Comodin = Fichero + #0#2; |QBF Comodin;
      Comodin = "rb  " + Comodin; |FABRE Comodin;
      |SI FSalida ] 0;
         Handle = FSalida;
         |PARA; |SI; |HACIENDO;
            Comodin = Handle + " " + 1; |FLEE Comodin; |SI FSalida = 0; |VETE Final2; |FINSI;
            |SI Comodin ! LF; |Y Comodin ! CR;
               Comodin1 = Handle + " " + 5; |FLEE Comodin1; Comodin = Comodin + Comodin1;
               |SI Comodin = "FECHA ";
                  Comodin = Handle + " " + 11; |FLEE Comodin;
                  |SI Comodin = "CONTABLE:  ";
                     Comodin = Handle + " " + 8; |FLEE Comodin;
                     Comodin1 = Comodin % 0102; |QBT Comodin1; Comodin1 = ("00" + Comodin1) % -102;
                     aFecha = Comodin1 + "." + (Comodin % 0402) + ".";
                     Comodin1 = Comodin % -102; Calc = Comodin1;
                     |SI Calc ] 80;
                        Calc = Calc + 1900;
                     |SINO;
                        Calc = Calc + 2000;
                     |FINSI;
                     aFecha = aFecha + Calc;
                  |FINSI;
               |SINO;
                  Comodin = Comodin - "."; Comodin2 = Comodin; |QBT Comodin2;
                  Calc = Comodin; Comodin1 = Calc;
                  |SI Comodin2 = Comodin1; || Quiere decir que es numerico
                     || GRABAR ASIENTO
                     Calc = Comodin;
                     |DDEFECTO #caenlace;
                     #caenlace#0 = 1;                        || Diario
                     #caenlace#1 = aFecha;                   || Fecha contable
                     #caenlace#2 = Comodin;
                     Comodin = Handle + " " + 7; |FLEE Comodin;
                     #caenlace#3 = Comodin;
                     Comodin = Handle + " " + 14; |FLEE Comodin; |QBT Comodin;
                     aLong = Comodin % 0; nLong = aLong;
                     |SI nLong > 5; |Y nLong < 9;
                        Calc = 9 - nLong; Comodin1 = "0" * Calc;
                        Calc1 = 99 + nPosic; Calc2 = (nPosic * 100) + 99;
                        Comodin = (Comodin % Calc1) + Comodin1 + (Comodin % Calc2);
                     |FINSI;
                     |SI nLong = 2; #caenlace#5 = 1; |FINSI;
                     |SI nLong = 3; #caenlace#5 = 2; |FINSI;
                     |SI nLong = 5; #caenlace#5 = 3; |FINSI;
                     |SI nLong = 9; #caenlace#5 = 4; |FINSI;
                     #caenlace#4 = Comodin;
                     Comodin = Handle + " " + 2; |FLEE Comodin;
                     Comodin = Handle + " " + 27; |FLEE Comodin;
                     Comodin = Handle + " " + 4; |FLEE Comodin;
                     Comodin = Handle + " " + 2; |FLEE Comodin;
                     #caenlace#6 = Comodin;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 29; |FLEE Comodin;
                     #caenlace#7 = Comodin;
                     Comodin = Handle + " " +  6; |FLEE Comodin;
                     Comodin = Handle + " " + 13; |FLEE Comodin;
                     |HAZ ArreglaImporte; Calc = Comodin;
                     |SI Calc ! 0;
                        #caenlace#8 = "D";
                        #caenlace#9 = Calc;
                     |FINSI;
                     Comodin = Handle + " " + 7;  |FLEE Comodin;
                     Comodin = Handle + " " + 13; |FLEE Comodin;
                     |HAZ ArreglaImporte; Calc = Comodin;
                     |SI Calc ! 0;
                        #caenlace#8 = "H";
                        #caenlace#9 = Calc;
                     |FINSI;
                     |PINTA 2223, #caenlace#0;
                     |PINTA 2233, #caenlace#1;
                     |PINTA 2253, #caenlace#2;
                     |PINTA 2268, #caenlace#3;
                     |GRABA 020#caenlace.n;
                  |FINSI;
               |FINSI;
|ET Lee1;
               |PARA; |SI Comodin ! CR; |Y FSalida > 0; |HACIENDO;
                  Comodin = Handle + " " + 1; |FLEE Comodin;
               |SIGUE;
               Comodin = Handle + " " + 1; |FLEE Comodin;
               |SI Comodin = Vacio; |SAL; |FINSI;
               |SI Comodin ! LF; |VETE Lee1; |FINSI;
            |FINSI;
         |SIGUE;
      |FINSI;
|ET Final2;
      FSalida = Handle; |FCIERRA FSalida;

      |BLANCO 2201 2280;
      |CIERRA #caenlace;
      |DFICE Comodin1; |QBF Comodin1;
      Comodin1 = "dsapunte.tab;" + Comodin1;
      |SUB_EJECUTA_NP Comodin1;
|FPRC;

|PROCESO Proveedores;
   |BLANCO 2201 2280;
   |PINTA 2201, "    Importando Proveedor";

      |ABRE #caclipro;

      CR = &13; LF = &10; Vacio = &0; Tecla = &32; Comodin = "";
      Fichero = #0#0; |QBF Fichero;
||      ************** FICHERO PROVEEDORES ****************
      Comodin = Fichero + #0#3; |QBF Comodin;
      Comodin = "rb  " + Comodin; |FABRE Comodin;
      |SI FSalida ] 0;
         Handle = FSalida;
         |PARA; |SI; |HACIENDO;
            Comodin = Handle + " " + 1; |FLEE Comodin;
            |SI Comodin ! LF; |Y Comodin ! CR;
               Comodin1 = Handle + " " + 1; |FLEE Comodin1; Comodin = Comodin + Comodin1;
               Comodin1 = Handle + " " + 1; |FLEE Comodin1;
               Comodin1 = Handle + " " + 4; |FLEE Comodin1; Comodin = Comodin + Comodin1;
               Comodin1 = Handle + " " + 2; |FLEE Comodin1;
               Comodin = "400" + Comodin;
               Comodin2 = Comodin; |QBT Comodin2; Calc = Comodin; Comodin1 = Calc;
               |SI Comodin1 = Comodin2;
                  #caclipro#23 = "P";
                  aLong = Comodin % 0; nLong = aLong;
                  |SI nLong > 5; |Y nLong < 9;
                     Calc = 9 - nLong; Comodin1 = "0" * Calc;
                     Calc1 = 99 + nPosic; Calc2 = (nPosic * 100) + 99;
                     Comodin = (Comodin % Calc1) + Comodin1 + (Comodin % Calc2);
                  |FINSI;
                  #caclipro#10 = Comodin;
                  |SI nLong = 2; #caclipro#11 = 1; |FINSI;
                  |SI nLong = 3; #caclipro#11 = 2; |FINSI;
                  |SI nLong = 5; #caclipro#11 = 3; |FINSI;
                  |SI nLong = 9; #caclipro#11 = 4; |FINSI;
                  |LEE 000#caclipro.=;
                  |SI FSalida ! 0;
                     |DDEFECTO #caclipro;
                     #caclipro#23 = "P";
                     aLong = Comodin % 0; nLong = aLong;
                     |SI nLong > 5; |Y nLong < 9;
                        Calc = 9 - nLong; Comodin1 = "0" * Calc;
                        Calc1 = 99 + nPosic; Calc2 = (nPosic * 100) + 99;
                        Comodin = (Comodin % Calc1) + Comodin1 + (Comodin % Calc2);
                     |FINSI;
                     #caclipro#10 = Comodin;
                     |SI nLong = 2; #caclipro#11 = 1; |FINSI;
                     |SI nLong = 3; #caclipro#11 = 2; |FINSI;
                     |SI nLong = 5; #caclipro#11 = 3; |FINSI;
                     |SI nLong = 9; #caclipro#11 = 4; |FINSI;
                     Comodin = Handle + " " + 30; |FLEE Comodin; #caclipro#1 = Comodin;
                     |PINTA 2243, #caclipro#10;
                     |PINTA 2257, #caclipro#1;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 30; |FLEE Comodin; #caclipro#2 = Comodin;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 5; |FLEE Comodin;
                     Comodin1 = Comodin % 0102; Comodin2 = Comodin % 0303;
                     #caclipro#3 = Comodin1; #caclipro#4 = Comodin2;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 30; |FLEE Comodin; #caclipro#6 = Comodin;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 12; |FLEE Comodin; #caclipro#9 = Comodin;
                     Comodin = Handle + " " + 1; |FLEE Comodin;
                     Comodin = Handle + " " + 10; |FLEE Comodin;  #caclipro#7 = Comodin;
                     |GRABA 020#caclipro.n;
                  |FINSI;
               |FINSI;
|ET Lee2;
               |PARA; |SI Comodin ! CR; |Y FSalida > 0; |HACIENDO;
                  Comodin = Handle + " " + 1; |FLEE Comodin;
               |SIGUE;
               Comodin = Handle + " " + 1; |FLEE Comodin;
               |SI Comodin = Vacio; |SAL; |FINSI;
               |SI Comodin ! LF; |VETE Lee2; |FINSI;
            |FINSI;
         |SIGUE;
      |FINSI;
      |CIERRA #caclipro;
|FPRC;

|PROCESO Niveles;
     aAlfa1 = "";
     |DFICE aAlfa1;
     aAlfa2 = aAlfa1 % -107;
     aAlfa3 = aAlfa2 % 105;   || empresa
     aAlfa4 = aAlfa2 % 601;   || periodo

     |ABRE #canempre;
     #canempre#2 = aAlfa3;
     #canempre#3 = aAlfa4;
     |LEE 101#canempre.=;
     |SI FSalida = 0;
          #canempre#13 = 4;
          #canempre#14 = 2;
          #canempre#15 = 3;   || fuerza los niveles para evitar
          #canempre#16 = 5;   ||/llamadas telefonicas
          #canempre#17 = 9;
          #canempre#18 = 0;
          #canempre#19 = 0;
          |GRABA 020#canempre.a;
     |FINSI;
     |LIBERA #canempre;
     |CIERRA #canempre;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA "Importacion desde listados";
   |PINPA #0#0;
   |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |HAZ Niveles;

      aAlfa1 = #0#1; |QBF aAlfa1; |SI aAlfa1 ! ""; |DELINDEX #cacuenta; |FINSI;
      |HAZ PlanCuentas;

      |DELINDEX #caenlace;
      |HAZ Diario;

      |HAZ Proveedores;
   |FINSI;
|FPRO;
