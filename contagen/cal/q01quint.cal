|FICHEROS;
     q01quint #0;
     cacuenta #1;   || Mayor de ctas.
     cacuebal #5;
     canempre #6;   || Empresas Contables.
     calibros #17;  || libros iva
     caenlace #50;
     caconasi #51;
     caivases #52;

     camaniva #100;
     caivalin #101;

     :/modelos/def/dsmom030 #03;        || conceptos

     ca8cumay #410;
     ca8m0002 #422;
|FIN;

|VARIABLES;
     &enNoModif = 0;

     nBase1 = 0; nTipo1 = 0; nCuota1 = 0;
     nBase2 = 0; nTipo2 = 0; nCuota2 = 0;
     nBase3 = 0; nTipo3 = 0; nCuota3 = 0;
     nBase4 = 0; nTipo4 = 0; nCuota4 = 0;
     nBase5 = 0; nTipo5 = 0; nCuota5 = 0;

     nLibro = 0; nDocum1 = 0; nHayIva = 0;
     aLong  = ""; nLong = 0; nCalc = 0;

     aDesccov = "";
     dcov     = "";

     nDiario  = 0;
     fFechDoc = @;
     nDocum   = 0;
     aTipoIva = "";
     aAlfa    = "";
     nDoc     = 0;
     i_depar  = "";

     nGuardaPos = 0;
     i_perio = 0;
     alfa1 = "";
     libro     = 0;
     i_factu   = 0;
     linea     = 0;
     contasi   = 0;
     diario    = "";
     docu      = 0;
     digi      = 0;
     n         = 0;
     f         = 0;
     sal       = 0;
     contaasi  = 0;
     alfa      = "";
     camino    = "";
     fichero   = "";
     r         = "";
     aDatos    = "";
     aempres   = "";
     periodo   = "";
     camino_e  = "";
     tipo      = "";
     cta       = "";

     aCta1     = "";
     aCta2     = "";

     long      = "";
     fecha     = "";
     t         = "";
     cadena    = "";
     aimporte  = "";
     concep    = "";
     fecha1    = @;
     nume1     = 0;
     nume2     = 0;
     nume3     = 0;
     totiva    = 0;
     hh        = "";
     h1        = "";
     h2        = "";
     div       = "";
     civ       = "";
     cov       = "";
     b1        = "";
     b2        = "";
     z         = "";
     g         = "";
     nConcepto    = 0;
     &dig3        = 0;
     &enEjercicio = 0;
     &eNum2008    = 0;
     &enEjerBal   = 0;
|FIN;

|INCLUYE defec1_i;

|PROCESO LeeLibro; |TIPO 0;
  |ABRE #17;
  #17#0 = #0Campo;
  |LEE 010#17=;
  |SI FSalida ! 0;
      |CIERRA #17;
      |MENAV "      No existe libro";
      |ERROR;
      |ACABA;
  |FINSI;
  |CIERRA #17;

  |SI Campo = 4; |Y #17#2 ! "R";
      |MENAV "     Error. El Libro no es de Repercutido";
      |ERROR;
      |ACABA;
  |FINSI;
  |SI Campo = 5; |Y #17#2 ! "S";
      |MENAV "     Error. El Libro no es de Soportado";
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|| IMPORTA LOS DATOS A LA CONTABILIDAD.--------------------------------------
|PROCESO crea_cab;
     |ABRE #caconasi;
     |LEE 101#caconasi.p;
     |SI FSalida ! 0;
        |DDEFECTO #caconasi;
        |GRABA 020#caconasi.c;
     |FINSI;
     nDocum = #caconasi#1;
     #caconasi#1 = #caconasi#1 + 1;
     |GRABA 020#caconasi.a; |LIBERA #caconasi;
     |CIERRA #caconasi;

     diario = r % 1002;

     |DDEFECTO #caenlace;
     fecha = r % 0802; |QBF fecha;
     fecha = fecha + "." + ( r % 0602 ); |QBF fecha;
     fecha = fecha + "." + ( r % 0204 ); |QBF fecha;
     aAlfa = r % 1002; nDiario  = aAlfa;
     fFechDoc = fecha;
     linea = 0;
|FPRC;

|PROCESO crea_lin;
     aCta1 = r % 0215;
     aCta2 = ".";
     cta = aCta1 - aCta2;
     |QBT cta;
     |HAZ Cuentas;

     long = cta % 0;
     digi = 0;
     |SI #6#14 = long;   digi = 1; |FINSI;
     |SI #6#15 = long;   digi = 2; |FINSI;
     |SI #6#16 = long;   digi = 3; |FINSI;
     |SI #6#17 = long;   digi = 4; |FINSI;
     |SI #6#18 = long;   digi = 5; |FINSI;
     |SI #6#19 = long;   digi = 6; |FINSI;
     |SI digi = 0;
          |ATRI P;
          cadena = "0500CUENTA " + cta + "  FUERA DE LONGITUD";
          |MENAV cadena;
          |ATRI p;
          || |ACABA;
     |FINSI;

     linea = linea + 1;

     |DDEFECTO #caenlace;
     #caenlace#0 = nDiario;
     #caenlace#1 = fFechDoc;
     #caenlace#2 = nDocum;
     #caenlace#3 = linea;
     #caenlace#37 = #48#2;
     #caenlace#38 = #48#3;
     |GRABA 020#caenlace.b;

     #caenlace#4 = cta;
     #caenlace#5 = digi;

     hh = cta % 103; h1 = cta % 101; h2 = cta % 102;
     |SI hh = "477"; |O h2 = "43"; |O h1 = "7"; aTipoIva = "R"; |FINSI;
     |SI hh = "472"; |O h2 = "40"; |O h2 = "41"; |O h1 = "6"; aTipoIva = "S"; |FINSI;

     concep = #0#6; |SI aTipoIva ! "R"; concep = #0#7; |FINSI;

     ||  concep = r % 2904;
     #caenlace#6 = concep;
     aDesccov = r % 3330;
     #caenlace#7 = r % 3330;  || Descripcion concepto.
     #caenlace#8 = r % 1701;  || Signo
     aimporte = r % 1811;
     |QBT aimporte;
     #caenlace#9 = aimporte;  || Importe..............
     |GRABA 020#caenlace.a; |LIBERA #caenlace;

     hh = cta % 103;
     |SI hh = "430"; |Y #caenlace#8 = "D";
          civ = cta; div = digi; cov = concep;
     |FINSI;
     |SI hh = "400"; |O hh = "410";
        |SI #caenlace#8 = "H";
           civ = cta; div = digi; cov = concep; dcov = aDesccov;
        |FINSI;
     |FINSI;
|FPRC;

----------------------- GRABA IVAS
|PROCESO iva;
|ABRE #camaniva; |ABRE #caivalin;

libro    = #0#4;
nConcepto = #0#6;
|SI aTipoIva ! "R"; libro = #0#5; nConcepto = #0#7; |FINSI;

|HAZ ultima;
|DDEFECTO #camaniva;
#camaniva#0 = #0#4;      || libro
|HAZ lee_libro;
#camaniva#1 = i_factu;   || factura
|GRABA 020#camaniva.b;
   fecha = r % 1802; |QBF fecha;
   fecha = fecha + "." + ( r % 1602 ); |QBF fecha;
   fecha = fecha + "." + ( r % 1204 ); |QBF fecha;
   fecha1 = fecha;
#camaniva#2 = "";     || Serie

|ABRE #caivases;
#caivases#0 = "";
#caivases#1 = aTipoIva;
|LEE 101#caivases.=;
|SI FSalida ! 0;
   |DDEFECTO #caivases;
   #caivases#0 = "";
   #caivases#1 = aTipoIva;
   |GRABA 020#caivases.b;
|FINSI;
aAlfa = #caivases#3;
#caivases#3 = #caivases#3 + #caivases#4;
|GRABA 020#caivases.a; |LIBERA #caivases;
|CIERRA #caivases;
#camaniva#3 = aAlfa;     || Factura
#camaniva#4 = fecha1;    || fecha factura

aAlfa = r % 1602; |QBF aAlfa;
#camaniva#5  = aAlfa;     || Periodo
#camaniva#7  = diario;    || Diario
#camaniva#8  = fecha1;    || Fecha asiento
#camaniva#9  = nDocum;    || Documento
#camaniva#10 = i_depar;   || Departamento
#camaniva#12 = civ;       || Cuenta
#camaniva#13 = r % 4540;  || Nombre
#camaniva#14 = r % 3609;  || Cif
#camaniva#27 = nConcepto;      || Concepto
#camaniva#28 = aDesccov;    || Descripcion Concepto Cli/Pro
#camaniva#29 = #camaniva#27;|| Concepto
#camaniva#30 = #camaniva#28;|| Descripcion concepto
#camaniva#36 = aTipoIva;  || Soportado / Repercutido
|GRABA 020#camaniva.a;

|SI aTipoIva = "R";
   aAlfa = r % 15210; nBase1  = aAlfa;
   aAlfa = r % 16205; nTipo1  = aAlfa;
   aAlfa = r % 16710; nCuota1 = aAlfa;

   aAlfa = r % 17710; nBase2  = aAlfa;
   aAlfa = r % 18705; nTipo2  = aAlfa;
   aAlfa = r % 19210; nCuota2 = aAlfa;

   aAlfa = r % 20210; nBase3  = aAlfa;
   aAlfa = r % 21205; nTipo3  = aAlfa;
   aAlfa = r % 21710; nCuota3 = aAlfa;

   aAlfa = r % 22710; nBase4  = aAlfa;
   aAlfa = r % 23705; nTipo4  = aAlfa;
   aAlfa = r % 24210; nCuota4 = aAlfa;

   aAlfa = aDatos % 0110; nBase5  = aAlfa;
   aAlfa = aDatos % 1105; nTipo5  = aAlfa;
   aAlfa = aDatos % 1610; nCuota5 = aAlfa;
|SINO;
   aAlfa = r % 13810; nBase1  = aAlfa;
   aAlfa = r % 14805; nTipo1  = aAlfa;
   aAlfa = r % 15310; nCuota1 = aAlfa;

   aAlfa = r % 17310; nBase2  = aAlfa;
   aAlfa = r % 18305; nTipo2  = aAlfa;
   aAlfa = r % 18810; nCuota2 = aAlfa;

   aAlfa = r % 20810; nBase3  = aAlfa;
   aAlfa = r % 21805; nTipo3  = aAlfa;
   aAlfa = r % 22310; nCuota3 = aAlfa;

   nBase4 = 0; nTipo4 = 0; nCuota4 = 0;
   nBase5 = 0; nTipo5 = 0; nCuota5 = 0;
|FINSI;

|DDEFECTO #caivalin;      ||Base 1
#caivalin#0 = #camaniva#0;
#caivalin#1 = #camaniva#1;
#caivalin#2 = 1;
#caivalin#3 = #camaniva#27;|| Concepto
#caivalin#4 = #camaniva#28;|| Descripcion concepto
#caivalin#6 = nBase1; #caivalin#7 = nTipo1; #caivalin#8 = nCuota1;
|SI #caivalin#6 ! 0;
   |GRABA 020#caivalin.c;
   #camaniva#19 = #camaniva#19 + #caivalin#6;
   #camaniva#23 = #camaniva#23 + #caivalin#8;
   #camaniva#21 = #camaniva#19 + #camaniva#23;
   |GRABA 020#camaniva.a;
|FINSI;

|DDEFECTO #caivalin;      ||Base 2
#caivalin#0 = #camaniva#0;
#caivalin#1 = #camaniva#1;
#caivalin#2 = 2;
#caivalin#3 = #camaniva#27;|| Concepto
#caivalin#4 = #camaniva#28;|| Descripcion concepto
#caivalin#6 = nBase2; #caivalin#7 = nTipo2; #caivalin#8 = nCuota2;
|SI #caivalin#6 ! 0;
   |GRABA 020#caivalin.c;
   #camaniva#19 = #camaniva#19 + #caivalin#6;
   #camaniva#23 = #camaniva#23 + #caivalin#8;
   #camaniva#21 = #camaniva#19 + #camaniva#23;
   |GRABA 020#camaniva.a;
|FINSI;

|DDEFECTO #caivalin;      ||Base 3
#caivalin#0 = #camaniva#0;
#caivalin#1 = #camaniva#1;
#caivalin#2 = 3;
#caivalin#3 = #camaniva#27;|| Concepto
#caivalin#4 = #camaniva#28;|| Descripcion concepto
#caivalin#6 = nBase3; #caivalin#7 = nTipo3; #caivalin#8 = nCuota3;
|SI #caivalin#6 ! 0;
   |GRABA 020#caivalin.c;
   #camaniva#19 = #camaniva#19 + #caivalin#6;
   #camaniva#23 = #camaniva#23 + #caivalin#8;
   #camaniva#21 = #camaniva#19 + #camaniva#23;
   |GRABA 020#camaniva.a;
|FINSI;

|DDEFECTO #caivalin;      ||Base 4
#caivalin#0 = #camaniva#0;
#caivalin#1 = #camaniva#1;
#caivalin#2 = 4;
#caivalin#3 = #camaniva#27;|| Concepto
#caivalin#4 = #camaniva#28;|| Descripcion concepto
#caivalin#6 = nBase4; #caivalin#7 = nTipo4; #caivalin#8 = nCuota4;
|SI #caivalin#6 ! 0;
   |GRABA 020#caivalin.c;
   #camaniva#19 = #camaniva#19 + #caivalin#6;
   #camaniva#23 = #camaniva#23 + #caivalin#8;
   #camaniva#21 = #camaniva#19 + #camaniva#23;
   |GRABA 020#camaniva.a;
|FINSI;

|DDEFECTO #caivalin;      ||Base 5
#caivalin#0 = #camaniva#0;
#caivalin#1 = #camaniva#1;
#caivalin#2 = 5;
#caivalin#3 = #camaniva#27;|| Concepto
#caivalin#4 = #camaniva#28;|| Descripcion concepto
#caivalin#6 = nBase5; #caivalin#7 = nTipo5; #caivalin#8 = nCuota5;
|SI #caivalin#6 ! 0;
   |GRABA 020#caivalin.c;
   #camaniva#19 = #camaniva#19 + #caivalin#6;
   #camaniva#23 = #camaniva#23 + #caivalin#8;
   #camaniva#21 = #camaniva#19 + #camaniva#23;
   |GRABA 020#camaniva.a; |LIBERA #camaniva;
|FINSI;

|CIERRA #caivalin; |CIERRA #camaniva;
|FPRC;

|PROCESO importa;
     tipo = r % 101;
     |SI tipo = "Z";
        civ = ""; div = 0; cov = ""; nHayIva = 0;
     |FINSI;
     |SI tipo = "H"; |HAZ crea_cab; |FINSI;
     |SI tipo = "A";
        |HAZ crea_lin;
        |SI nHayIva = 1;
           #camaniva#0 = nLibro;
           #camaniva#1 = nDocum1;
           |LEE 101#camaniva.=;
           |SI FSalida = 0;
              aAlfa = #camaniva#12; |QBF aAlfa;
              |SI aAlfa = ""; #camaniva#12 = civ; |FINSI;
              |GRABA 020#camaniva.a; |LIBERA #camaniva;
           |FINSI;
        |FINSI;
     |FINSI;
     |SI tipo = "S";
        aAlfa = r;
        r = f + " " + 51;  |FLEE r; aDatos = r;
        r = aAlfa;
        aTipoIva = "S";
        |HAZ iva;
        nHayIva = 1; nLibro = #camaniva#0; nDocum1 = #camaniva#1;
     |FINSI;
     |SI tipo = "R";
        aAlfa = r;
        r = f + " " + 51;  |FLEE r; aDatos = r;
        r = aAlfa;
        aTipoIva = "R";
        |HAZ iva;
        nHayIva = 1; nLibro = #camaniva#0; nDocum1 = #camaniva#1;
     |FINSI;
|FPRC;

|| PRINCIPIO.----------------------------------------------------------------

|PROCESO tipo3; |TIPO 3;
     |SI #0#2 = "S";
          |ABRE #1;
          aAlfa = "pu" + Usuario; |NOME_DAT #caenlace#aAlfa#;
          |DELINDEX #caenlace; |ABRE #caenlace;

          || LEE LA FICHA DE LA EMPRESA PARA SABER LOS NIVELES...............
          |DFICE aempres;
          |QBF aempres;
          |DFICB camino_e;
          |QBF camino_e;
          periodo = aempres % -201;
          aempres = aempres % -305;
          |PATH_DAT #6 camino_e;
          |ABRE #6;
          #6#2 = aempres;
          #6#3 = periodo;
          |LEE 000#6=;
          || LEE EL FICHERO TEMPORAL.........................................
          camino = #0#0;  |QBF camino;
          fichero = #0#1; |QBF fichero;
          alfa = "rt  " + camino + fichero;
          Pos = -1;
          enNoModif = 0;  || enNoModif = 101; tique 2735 _ 231 (5.10.2005)
          |FABRE alfa;
          |SI FSalida ] 0;
               f = FSalida;
               sal = 0;
               |PARA; |SI sal ] 0; |HACIENDO;
                    r = f + " " + 252;
                    |FLEE r;
                    sal = FSalida;
                    |SI sal ] 0;
                         n = n + 1;
                         |PINTA 2438,n;
                         |HAZ importa;
                    |FINSI;
               |SIGUE;
          |FINSI;
          || SALIDA..........................................................
          FSalida = f;
          |FCIERRA FSalida;
          |CIERRA #1;
          |CIERRA #caenlace;
          |CIERRA #6;
          |DFICE aAlfa; |QBF aAlfa;
          aAlfa = "dsapunte.tab;" + aAlfa + ",pu" + Usuario;
          |SUB_EJECUTA aAlfa;
     |FINSI;
|FPRC;

|PROCESO ultima;
  i_factu = 1;

  |DDEFECTO #camaniva;
  #camaniva#0 = libro;
  #camaniva#1 = 9999999999;
  |LEE 001#camaniva.];
  |SI FSalida ! 0;
     |LEE 001#camaniva.u;
     |SI FSalida = 0; |Y #camaniva#0 = libro;
        i_factu = #camaniva#1 + 1;
     |SINO;
        |HAZ anterior;
     |FINSI;
  |SINO;
     |HAZ anterior;
  |FINSI;

  |SELECT #3#camaniva;
  #camaniva#0 = libro;
  #camaniva#2 = "     ";
  #camaniva#3 = 999999;
  |LEE 000#camaniva.];
  |SI FSalida ! 0;
     |LEE 001#camaniva.u;
     |SI FSalida = 0; |Y #camaniva#0 = libro; |Y #camaniva#2 = "     ";
        nDoc = #camaniva#3 + 1;
     |SINO;
        |LEE 000#camaniva.a;
        |SI FSalida = 0; |Y #camaniva#0 = libro; |Y #camaniva#2 = "     ";
           nDoc = #camaniva#3 + 1;
        |FINSI;
     |FINSI;
  |SINO;
     |LEE 000#camaniva.a;
     nDoc = #camaniva#3 + 1;
  |FINSI;
  |SELECT #1#camaniva;
/*
  |DDEFECTO #15;
  #15#0 = libro;    || libro
  #15#2 = 999999;   || factura
  |LEE 001#15];
  |SI FSalida ! 0;
      |LEE 001#15u;
      |SI FSalida = 0; |Y #15#0 = libro;
          i_factu = #15#2 + 1;
      |SINO;
          |HAZ anterior;
      |FINSI;
  |SINO;
      |HAZ anterior;
  |FINSI;
*/
|FPRC;

|PROCESO anterior;
  |LEE 001#camaniva.a;
  |SI FSalida = 0; |Y #camaniva#0 = libro;
      i_factu = #camaniva#1 + 1;
  |FINSI;
/*
  |LEE 001#15a;
  |SI FSalida = 0;|Y #15#0 = libro;
      i_factu = #15#2 + 1;
  |FINSI;
*/
|FPRC;

|PROCESO lee_libro;
 |ABRE #17;
 #17#0 = libro;
 |LEE 001#17=;
 |SI FSalida ! 0;
     #17#1 = "<LIBRO INEXISTENTE>";
 |FINSI;
 |CIERRA #17;
|FPRC;

|PROCESO ultima2;
|FPRC;

|PROCESO periodo;
    alfa1 = fecha1;
/*
|SI #11#10 = "T";
        alfa1 = alfa1 % -104;   || saca a¤o
        alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
        alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
        alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre
    |SI i_fecha [ trim1;                     i_perio = 1;  |FINSI;
    |SI i_fecha > trim1;|Y i_fecha [ trim2;  i_perio = 2;  |FINSI;
    |SI i_fecha > trim2;|Y i_fecha [ trim3;  i_perio = 3;  |FINSI;
    |SI i_fecha > trim3;                     i_perio = 4;  |FINSI;
|SINO;
*/
        alfa1 = alfa1 % 402;    || saca mes
        i_perio = alfa1;
||FINSI;
|FPRC;

|PROCESO Cuentas;
     dig3        = #48#13;
     enEjercicio = #48#26;
     |SI enEjercicio < 80;
         enEjercicio = enEjercicio + 2000;
     |SINO;
         enEjercicio = enEjercicio + 1900;
     |FINSI;
     aAlfa = cta; |QBF aAlfa;
     aLong = aAlfa % 0; nLong = aLong;
     |SI nLong < 12;
        nCalc = 12 - nLong;
        aAlfa = (aAlfa % 0104) + ("0" * nCalc) + (aAlfa % 0599);
        cta = aAlfa;
     |FINSI;

     nGuardaPos = Pos;
     Pos = -1;
     |DDEFECTO #1;
     |ABRE #1;
     |QBF cta;
     #1#0 = cta;
     #1#1 = digi;
     |LEE 101#1=;
     |SI FSalida ! 0;
          |PUSHV 0501 2380;
          |HAZ defect1;
          |PINPA #0#1;
          |PINDA #0#1;
          |CONFI "0000SConfirma el alta?";
          |SI FSalida = 0;
               |ENDATOS #1#1;
               |SI FSalida = 0;
                    |GRABA 020#1n;
               |FINSI;
          |FINSI;
          |POPV;
     |FINSI;
     |LIBERA #1;
     |CIERRA #1;
     Pos = nGuardaPos;
|FPRC;
