|FICHEROS;
   careclpg #0;
   camaniva #1;
   caivaasi #2;

   calinpag #10;

   dscam008@ #100;
   dscam002@ #101;
   dscam042@ #102;
   dscam043@ #103;
|FIN;

|VARIABLES;
   nError = 0;
   aAlfa  = "";
   aAlfa1 = "";
|FIN;

|PROCESO AbreDsCarter;
   aAlfa1 = #caivaasi#56; |QBF aAlfa1;
   aAlfa = aAlfa1 + "def/dscam008.mas";
   |CARGA_DEF aAlfa, dscam008@;
   |SI FSalida = 0;
      aAlfa = aAlfa1 + "def/dscam042.mas";
      |CARGA_DEF aAlfa, dscam042@;

      aAlfa = aAlfa1 + "def/dscam043.mas";
      |CARGA_DEF aAlfa, dscam043@;

      aAlfa = aAlfa1 + "def/dscam002.mas";
      |CARGA_DEF aAlfa, dscam002@;

      aAlfa = #caivaasi#56; |QBF aAlfa;
      aAlfa = aAlfa + "fich/";
      |PATH_DAT #dscam042@#aAlfa#; |PATH_DAT #dscam043@#aAlfa#;
      |ABRE #dscam042@; |ABRE #dscam043@;
   |SINO;
     |MENAV "0000Error al cargar def de cartera...";
     nError = 1;
   |FINSI;
|FPRC;

|PROCESO CierraDsCarter;
   |CIERRA #dscam002@; |DESCARGA_DEF #dscam002@;
   |CIERRA #dscam043@; |DESCARGA_DEF #dscam043@;
   |CIERRA #dscam042@; |DESCARGA_DEF #dscam042@;
   |CIERRA #dscam008@; |DESCARGA_DEF #dscam008@;
|FPRC;

|PROCESO RegIva;
   #calinpag#0 = #camaniva#0; ||libro
   #calinpag#1 = #camaniva#3; ||orden=factura
   #calinpag#2 = #camaniva#2; ||serie
   #calinpag#3 = 1;
   |LEE 000#calinpag.];
   |SI FSalida = 0; |Y #calinpag#0 = #camaniva#0;
          |Y #calinpag#1 = #camaniva#3;
          |Y #calinpag#2 = #camaniva#2;
      |ACABA;
   |FINSI;

   #dscam042@#0 = #48#2;
   #dscam042@#1 = #48#3;
   |LEE 000#dscam042@.=;
   |SI FSalida = 0;
      #dscam043@#0 = #48#2;
      #dscam043@#1 = #48#3;
      #dscam043@#2 = 1;
      |LEE 000#dscam043@.];
      |PARA; |SI FSalida = 0; |Y #dscam043@#0 = #48#2; |Y #dscam043@#1 = #48#3; |HACIENDO;
         |SI #dscam043@#3 = "C";
            aAlfa = #caivaasi#56; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #dscam043@#9) % -105) + "/";
            |PATH_DAT #dscam008@#aAlfa#; |ABRE #dscam008@;
            |PATH_DAT #dscam002@#aAlfa#; |ABRE #dscam002@;
            |SELECT #2#dscam008@;

            #dscam008@#27 = #camaniva#0;
            #dscam008@#0 = #camaniva#2;
            #dscam008@#1 = #camaniva#3;
            #dscam008@#2 = 1;
            |LEE 000#dscam008@.];
            |PARA; |SI FSalida = 0; |Y #dscam008@#27 = #camaniva#0; |Y #dscam008@#0 = #camaniva#2; |Y #dscam008@#1 = #camaniva#3; |HACIENDO;
               |SI #dscam008@#4 = #camaniva#4;
                  |SI #careclpg#5 [ #dscam008@#3; |Y #careclpg#10 ] #dscam008@#3;
                     #dscam002@#0 = #dscam008@#8;
                     #dscam002@#1 = #dscam008@#9;
                     |LEE 000#dscam002@.=;
                     |SI FSalida ! 0; |DDEFECTO #dscam002@; |FINSI;

                     |DDEFECTO #calinpag;
                     #calinpag#0  = #dscam008@#27;
                     #calinpag#1  = #dscam008@#1;
                     #calinpag#2  = #dscam008@#0;
                     #calinpag#3  = #dscam008@#2;
                     #calinpag#4  = #dscam008@#5;
                     #calinpag#6  = #dscam008@#4;
                     #calinpag#7  = #dscam008@#3;
                     #calinpag#8  = #dscam008@#25;
                     #calinpag#9  = #dscam008@#24;
                     #calinpag#11 = #dscam008@#12;
                     #calinpag#13 = #dscam008@#48;
                     #calinpag#14 = #dscam008@#7;
                     #calinpag#15 = #dscam002@#3;
                     #calinpag#16 = #dscam002@#4;
                     #calinpag#17 = #dscam002@#5;
                     #calinpag#20 = #dscam002@#6;
                     |GRABA 020#calinpag.n;
                  |FINSI;
               |FINSI;
               |LEE 000#dscam008@.s;
            |SIGUE;
            |CIERRA #dscam008@; |CIERRA #dscam002@;
         |FINSI;
         |LEE 000#dscam043@.s;
      |SIGUE;
   |FINSI;
|FPRC;

|DEFBUCLE RegIva;
#camaniva#3;
4;
#careclpg#1, #careclpg#2, #careclpg#3, #careclpg#4;
#careclpg#6, #careclpg#7, #careclpg#8, #careclpg#9;
;
NULL, RegIva;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA " Recuperacion lineal pagos desde DsCarter";

   |PINPA #0#0; |PINDA #0#0;

   |ABRE #caivaasi;
   |LEE 000#caivaasi.p;
   |SI FSalida ! 0; |DDEFECTO #caivaasi; |FINSI;
   |CIERRA #caivaasi;

   aAlfa1 = #caivaasi#1; |QBF aAlfa1;
   |SI aAlfa1 ! "S"; |MENAV "Pagos a DsCarter desactivados. Proceso cancelado."; |ACABA; |FINSI;

   |HAZ AbreDsCarter;
   |SI nError = 0;
        |ENDATOS #1#0;
        |SI FSalida = 0;
           |ABRE #calinpag
           |BUCLE RegIva;
           |CIERRA #calinpag;
        |FINSI;

        |HAZ CierraDsCarter;
   |FINSI;
|FPRO;
