|FICHEROS;
  caz00011 #0;
  cam00001 #1;
  cam00002 #2;
  cam00003 #3;
  cam00004 #4;
  cam00005 #5;

  caconasi #20;
  canempre #30;

  camaasic #31;
  camaasil #32;
  camandia #33;
  cacuenta #34;
  calibros #35;
  camaniva #36;
  caivalin #37;
  caclipro #38;
  caexistl #39;
  caexistc #40;
  caivam03 #223;
  casiim01;
  casiim02;

  anm00012 #12;
  anm00013 #13;

  cacambix;
  amaasic@ #51;
  amaasil@ #52;
  amandia@ #53;
  acuenta@ #54;
  alibros@ #55;
  amaniva@ #56;
  aivalin@ #57;
  aclipro@ #58;
  aexistl@ #59;
  aexistc@ #60;
  aivam03@ #113;
  asiim01@;
  asiim02@;

  nm00012@ #22;
  nm00013@ #23;

  caw00011 #65;

 :/modelos/def/dsmom041 #141;
 :/modelos/def/dsmom042 #142;

  caw00004 #904;
  caw00049 #949;
|FIN;

|VARIABLES;
 nEstado  = 0;
 nEstado1 = 0;
 &enPor   = 0;
 &enEmpOrig = 0;
 &nMaxDes = 0;
 &eaDirDestino = "";
 &eaDirOrigen  = "";
 swOpera  = 0;
 nCalC    = 0;
 nNume    = 0;
 nNume1   = 0;
 nNume2   = 0;
 aAlfa    = "";
 aAlfa1   = "";
 aAlfa2   = "";
 aAlfa3   = "";
 ndDiario = 0;
 nhDiario = 0;
 nIncrDia = 0;
 nDiaDest = 0;
 Diario   = 0;
 aDeparta = "";
 ndConcep = 0;
 nhConcep = 0;
 ndLibro  = 0;
 nhLibro  = 0;
 nIncrLib = 0;
 nLibDest = 0;
 nSiAna   = 0;
 nSiExc   = 0;
 nSwExCta = 0;
 aCtaExc  = "";
 aH60     = "";
 aTitulo   = "";
 &nLong1   = 0;
 &nLong2   = 0;
 &nLong3   = 0;
 &nLong4   = 0;
 &nLong5   = 0;
 &nLong6   = 0;
 &aDigDif  = "";
 &aRenCta  = "";
 &nLonDif  = 0;
 &LineaErrores = 0;
 &UltNivel = 0;

 mascara = "";
 Comodin = "";
 Tipo = 0;
 Nivel = 0;
 LongAlfa = "";

 nSw  = 0;
 Long = 0;
 ComodNum  = 0;
 ComodNum1 = 0;
 ComodNum2 = 0;
 Comodin1 = "";
 Comodin2 = "";

 nSwBueno = 0;
 &pathbal = "";
 &balance = 0;
 nDoc     = 0;

 nLibroD  = 0;
 nLibroO  = 0;

 ndDepar  = 0;
 nhDepar  = 0;

 nLExi    = 0;
 nIncLExi = 0;
 nSwLExi  = 0;
 &enSwDupl = 0;
 &enSwChequeo = 0;
 &enSwProg = 0;

 nPara1  = 0;
 nAlAsto = 0;
 nAlCta  = 0;
 aFichero = "";
 nEjer    = 0;
 aMes     = "";
 aDia     = "";
 fFechaI  = @;
 fFechaF  = @;
 nReg     = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoan_i;

|| /////////////////////// PROCESOS DE TRABAJO \\\\\\\\\\\\\\\\\\\\
|PROGRAMA;
 |HAZ inicio;
 |HAZ eLeeParametro;

 |ABRE #1;
 #1#0 = enEmpresa;
 |LEE 101#1=;
 |SI FSalida ! 0;
     |SI enAutom = 0;
        |MENAV "    ERROR EN LA CONSOLIDACION ";
     |FINSI;
     |CIERRA #1;
     |ACABA;
 |FINSI;
 |CIERRA #1;

 aFichero = ("4z" + Usuario) % 108;
 |NOME_DAT #904 aFichero; |DELINDEX #904;

 aFichero = ("4w" + Usuario) % 108;
 |NOME_DAT #949 aFichero; |DELINDEX #949;

 |SI #1#2 ! 1;
     enSwChequeo = 0;
     |SI enAutom = 0;
        |CONFI "    SDesea Realizar un Chequeo de las Empresas de Fusion ?";
        |SI FSalida = 0;
            enSwProg = 1;
            |SUB_EJECUTA_NP "cay00006";
            |SI enSwChequeo = 1;
                |ACABA;
            |FINSI;
        |SINO;
            |SI #1#11 = "S";
                enSwDupl = 1;
                enSwProg = 1;
                |SUB_EJECUTA_NP "cay00006";
                enSwDupl = 0;
           |FINSI;
        |FINSI;
     |SINO;
        enSwProg = 1;
        |SUB_EJECUTA_NP "cay00006";
        |SI enSwChequeo = 1;
            || ACABA;
            || Hay errores pero continuamos, por ser automatico
        |FINSI;
     |FINSI;
 |FINSI;

 |HAZ Analitica; || Saber si he de copiar ficheros analitica

 |DFICE eaDirDestino;
 nMaxDes  = MaximoDigitos;
 #0#0  = #1#0;
 #0#1  = enPeriodo;
 #0#2  = #1#1;
 #0#3  = enEjercicio;
 #0#4  = eaMoneda;
 #0#10 = #30#26;
 aMonedaA = #0#4;

 |DBASE aAlfa1; |QBF aAlfa1;

 |PINPA #0#0;
 aAlfa2 = aAlfa1 + "def/camaasil.mas";
 |CARGA_DEF aAlfa2, amaasil@;
 |SI FSalida = 0;
     aAlfa2 = aAlfa1 + "def/camaniva.mas";
     |CARGA_DEF aAlfa2, amaniva@;
     |SI FSalida = 0;
         aAlfa2 = aAlfa1 + "def/caivalin.mas";
         |CARGA_DEF aAlfa2, aivalin@;
         |SI FSalida = 0;
             aAlfa2 = aAlfa1 + "def/camaasic.mas";
             |CARGA_DEF aAlfa2, amaasic@;
             |SI FSalida = 0;
                 aAlfa2 = aAlfa1 + "def/cacuenta.mas";
                 |CARGA_DEF aAlfa2, acuenta@;
                 |SI FSalida = 0;
                     aAlfa2 = aAlfa1 + "def/camandia.mas";
                     |CARGA_DEF aAlfa2, amandia@;
                     |SI FSalida = 0;
                         aAlfa2 = aAlfa1 + "def/calibros.mas";
                         |CARGA_DEF aAlfa2, alibros@;
                         |SI FSalida = 0;
                             aAlfa2 = aAlfa1 + "def/caclipro.mas";
                             |CARGA_DEF aAlfa2, aclipro@;
                             |SI FSalida = 0;
                                 aAlfa2 = aAlfa1 + "def/caexistl.mas";
                                 |CARGA_DEF aAlfa2, aexistl@;
                                 |SI FSalida = 0;
                                     aAlfa2 = aAlfa1 + "def/caexistc.mas";
                                     |CARGA_DEF aAlfa2, aexistc@;
                                     |SI FSalida = 0;
                                         aAlfa2 = aAlfa1 + "def/caivam03.mas";
                                         |CARGA_DEF aAlfa2, aivam03@;
                                         |SI FSalida = 0;
                                             aAlfa2 = aAlfa1 + "def/casiim01.mas";
                                             |CARGA_DEF aAlfa2, asiim01@;
                                             |SI FSalida = 0;
                                                 aAlfa2 = aAlfa1 + "def/casiim02.mas";
                                                 |CARGA_DEF aAlfa2, asiim02@;
                                                 |SI FSalida = 0;
                                                     |HAZ HazTodo;
                                                     |DESCARGA_DEF #asiim02@;
                                                 |FINSI;
                                                 |DESCARGA_DEF #asiim01@;
                                             |FINSI;
                                             |DESCARGA_DEF #aivam03@;
                                         |FINSI;
                                         |DESCARGA_DEF #aexistc@;
                                     |FINSI;
                                     |DESCARGA_DEF #aexistl@;
                                 |FINSI;
                                 |DESCARGA_DEF #aclipro@;
                             |FINSI;
                             |DESCARGA_DEF #alibros@;
                          |FINSI;
                         |DESCARGA_DEF #amandia@;
                     |FINSI;
                     |DESCARGA_DEF #acuenta@;
                 |FINSI;
                 |DESCARGA_DEF #amaasic@;
             |FINSI;
             |DESCARGA_DEF #aivalin@;
         |FINSI;
         |DESCARGA_DEF #amaniva@;
     |FINSI;
     |DESCARGA_DEF #amaasil@;
  |FINSI;

|FPRO;

|| ********************************************************************
|| ********************************************************************
|PROCESO BuscoExclusion;
 |SI #5#3 [ aCtaExc; |Y aCtaExc [ #5#4;
     nSwExCta = 1;
     |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE BuscoExclusion;
 #5#1;
 ;
 #2#0, #2#1, 001;
 #2#0, #2#1, 999;
 e;
 NULL, BuscoExclusion;
|FIN;

|PROCESO LaExclusion;
 nSwExCta = 0;
 |BUCLE BuscoExclusion;
|FPRC;


|PROCESO CopiaCliPro;
   |DDEFECTO #caclipro;
   aAlfa1 = "|NC";

   nCalC  = #caclipro#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #38nNume1 = #58nNume1;
   |SIGUE;

   eaCuenta = #38#10; |HAZ FiltroCuenta; #38#10 = eaCuenta; #38#11 = enNivel;
   eaCuenta = #38#21; |HAZ FiltroCuenta; #38#21 = eaCuenta; #38#22 = enNivel;
   |GRABA 040#38n;

   |PINTA 2202, "Codigo: ";
   |PINTA 2210, #38#23;
   |PINTA 2212, #38#10;
   |PINTA 2225, #38#1;
|FPRC;

|DEFBUCLE CliPro;
   #58#1002;
   ;
   " ","            ";
   "z","zzzzzzzzzzzz";
   e;
   NULL,CopiaCliPro;
|FIN;

|PROCESO GCtaNueva;

  |DDEFECTO #34;
  #34#0 = eaCuenta;
  |LEE 010#34=;
  nEstado = FSalida;
  #34#0 = eaCuenta;
  |HAZ SacaNivel;
  #34#1 = enNivel;
  #34#2 = #54#2; #34#3 = #54#3;
  #34#4 = #54#4; #34#5 = #54#5;
  #34#6 = #54#6; #34#7 = #54#7;
  #34#8 = #54#8;
  mascara = #34#0; |QBF mascara;
  mascara = (mascara +"zzzzzzzzzzzz") % 112;
  #34#54  = mascara;
  #34#55  = #34#1;
  |SI enNivel ! 0;
      |SI nEstado ! 0; |GRABA 040#34n; |FINSI;
      |SI nEstado = 0; |GRABA 040#34a; |FINSI;
      |SI FSalida ! 0;
          LineaErrores = LineaErrores + 1;
          #caw00011#0 = LineaErrores;
          #caw00011#1 = "Problemas escribiendo plan contable [" + Comodin + "] (" + FSalida + ")";
          |GRABA 020#caw00011.n;
      |SINO;
           nAlCta = 1;
      |FINSI;
 |FINSI;

 |PINTA 2202, "Cuenta: ";
 |PINTA 2210, #34#0;
 |PINTA 2223, #34#2;

 |SI #34#3 = "S"; |Y aRenCta = "S"; |Y enNivel ! 0; |Y #1#3 ! 0;
     #cacambix#0 = #54#0;
     #cacambix#1 = dig3;
     |LEE 041#cacambix.=;
     |SI FSalida ! 0;
         #cacambix#0 = #54#0;
         #cacambix#1 = dig3;
         |GRABA 020#cacambix.c;
     |FINSI;
     #cacambix#2 = #34#0;
     #cacambix#3 = #34#1;
     |GRABA 020#cacambix.a;
     |LIBERA #cacambix;
 |FINSI;
|FPRC;

|PROCESO Cuentas;
   |SI #54#0 = "            ";
       #34#0 = #54#0;
       |LEE 010#34=;
       |SI FSalida ! 0;
           |DDEFECTO #34;
           #34#0 = #54#0;
           |GRABA 040#34n;
       |FINSI;
       |ACABA;
   |FINSI;

   |SI #54#3 = "S";    ||de trabajo
       |SI nSiExc = 1;
           aCtaExc = #54#0;
           |HAZ LaExclusion;
           |SI nSwExCta = 1;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

   eaCuenta = #54#0;
   |SI dig4 ! 0; UltNivel = 1; |FINSI;
   |SI dig5 ! 0; UltNivel = 2; |FINSI;
   |SI dig6 ! 0; UltNivel = 3; |FINSI;
   |SI dig7 ! 0; UltNivel = 4; |FINSI;
   |SI dig8 ! 0; UltNivel = 5; |FINSI;
   |SI dig9 ! 0; UltNivel = 6; |FINSI;

   |SI #54#3 = "N";
       |HAZ GCtaNueva;
   |SINO;
       |SI #1#3 = 0;
           |HAZ GCtaNueva;    || no hay digito difenciador
       |SINO;

 || Compruebo la longitud de la cuenta y saco el tipo de cuenta :
 ||  Tipo 1 : N§ digitos de origen igual al del ultimo nivel del destino
 ||  Tipo 2 : N§ digitos de origen igual a otro nivel (no al ultimo) de destino

            Tipo = 0;
            Nivel = 0;
            Comodin = #54#0;
            |QBF Comodin;
            LongAlfa = Comodin % 0;
            Long = LongAlfa;
            |SI UltNivel = 1; |Y Long = dig4; Tipo = 1; Nivel = 1; |FINSI;
            |SI UltNivel = 2; |Y Long = dig5; Tipo = 1; Nivel = 2; |FINSI;
            |SI UltNivel = 3; |Y Long = dig6; Tipo = 1; Nivel = 3; |FINSI;
            |SI UltNivel = 4; |Y Long = dig7; Tipo = 1; Nivel = 4; |FINSI;
            |SI UltNivel = 5; |Y Long = dig8; Tipo = 1; Nivel = 5; |FINSI;
            |SI UltNivel = 6; |Y Long = dig9; Tipo = 1; Nivel = 6; |FINSI;

            |SI Tipo = 0;
                |SI Long = dig4; Tipo = 2; Nivel = 1; |FINSI;
                |SI Long = dig5; Tipo = 2; Nivel = 2; |FINSI;
                |SI Long = dig6; Tipo = 2; Nivel = 3; |FINSI;
                |SI Long = dig7; Tipo = 2; Nivel = 4; |FINSI;
                |SI Long = dig8; Tipo = 2; Nivel = 5; |FINSI;
                |SI Long = dig9; Tipo = 2; Nivel = 6; |FINSI;
            |FINSI;

            |SI Tipo = 1;
               || Tomar la primera parte segun la posicion indicada
               ComodNum = 100 + (#1#3 - 1);
               Comodin  = #54#0 % ComodNum;

               || Sumar el digito diferenciador
               |QBF Comodin;
               Comodin = Comodin + aDigDif;

               |SI nLonDif = 3;
                   ComodNum  = ((#1#3 + 3) * 100) + 99;
               |SINO;
                   |SI nLonDif = 2;
                       ComodNum  = ((#1#3 + 2) * 100) + 99;
                   |SINO;
                       ComodNum  = ((#1#3 + 1) * 100) + 99;
                   |FINSI;
               |FINSI;
               ComodNum1 = (#1#3 * 100) + nLonDif;

               nSw = 0;
               aAlfa2 = #54#0 % 102;
               aAlfa3 = #54#0 % 103;
               |SI aAlfa2 = "40"; |O aAlfa2 = "41";
                  |O aAlfa2 = "43"; |O aAlfa2 = "44";
                     nSw = 1;
               |FINSI;
               |SI aAlfa3 = "173"; |O aAlfa3 = "174";
                  |O aAlfa3 = "523"; |O aAlfa3 = "524";
                    |O aAlfa3 = "551";
                     nSw = 1;
               |FINSI;

               Comodin1 = #54#0 % ComodNum;
               aAlfa    = #54#0 % ComodNum1;
               nNume    = aAlfa;
               |SI nSw = 0; |O aRenCta ! "S";
                   Comodin = Comodin + Comodin1;
               |SINO;
                   Comodin = Comodin + ".a";
                   eaCuenta = Comodin;
                   |HAZ FiltraPuntos;
                   FSalida = 0;
                   Comodin = eaCuenta;
               |FINSI;
               |QBF Comodin;

               eaCuenta = Comodin;
               |HAZ GCtaNueva;
            |FINSI;

            |SI Tipo = 2;
               || Tomar la primera parte segun la posicion indicada
               ComodNum = 100 + (#1#3 - 1);
               Comodin  = #54#0 % ComodNum;

               || Sumar el digito diferenciador
               |QBF Comodin;
               Comodin = Comodin + aDigDif;
               |QBF Comodin;
               LongAlfa = Comodin % 0;
               Long = LongAlfa;

               || Relleno con ceros la ultima parte y ya tendremos creado la cuenta
               ||   del grupo del que deberia colgar la cuenta de trabajo que vamos
               ||   a obtener

               |SI Nivel = 1; ComodNum = dig4; |FINSI;
               |SI Nivel = 2; ComodNum = dig5; |FINSI;
               |SI Nivel = 3; ComodNum = dig6; |FINSI;
               |SI Nivel = 4; ComodNum = dig7; |FINSI;
               |SI Nivel = 5; ComodNum = dig8; |FINSI;
               |SI Nivel = 6; ComodNum = dig9; |FINSI;

               ComodNum = ComodNum - Long;
               Comodin1 = "0" * ComodNum;
               |QBF Comodin1;
               Comodin = Comodin + Comodin1;
               Comodin2 = Comodin;
               |QBF Comodin2;

               || Creo la cuenta de dicho grupo y lo grabo con "PASE DIRECTO = N"

               eaCuenta = Comodin;
               #54#3 = "N";
               |HAZ GCtaNueva;

               || y ahora creamos la cuenta de trabajo sumando la terminacion
               ||    de la cuenta

               LongAlfa = Comodin2 % 0;
               Long = LongAlfa;
               |SI UltNivel = 1; ComodNum = dig4 - Long; |FINSI;
               |SI UltNivel = 2; ComodNum = dig5 - Long; |FINSI;
               |SI UltNivel = 3; ComodNum = dig6 - Long; |FINSI;
               |SI UltNivel = 4; ComodNum = dig7 - Long; |FINSI;
               |SI UltNivel = 5; ComodNum = dig8 - Long; |FINSI;
               |SI UltNivel = 6; ComodNum = dig9 - Long; |FINSI;
               ComodNum = -(100 + ComodNum);

               Comodin1 = #54#0;
               |QBF Comodin1;
               Comodin1 = Comodin1 % ComodNum;
               Comodin = Comodin2 + Comodin1;
               |QBF Comodin;

               eaCuenta = Comodin;
               #54#3 = "S";
               |HAZ GCtaNueva;
            |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Cuentas;
 #54#1001;
 ;
 "            ";
 "zzzzzzzzzzzz";
 e;
 NULL,Cuentas;
|FIN;
|| *************************************************************************
|| *************************************************************************
|| ..................................... Existencias
|PROCESO BuscoLinea0;
 nLExi = #39#1;
 |SI #39#2 = #59#2;
     nSwLExi = 1;
     |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE BuscoLinea;
 #39#1;
 ;
 #40#0, 00;
 #40#0, 99;
 e;
 NULL, BuscoLinea0;
|FIN;

|PROCESO LineaExist0;
 eaCuenta = #59#2; |HAZ FiltroCuenta; #59#2 = eaCuenta; #59#3 = enNivel;
 eaCuenta = #59#5; |HAZ FiltroCuenta; #59#5 = eaCuenta; #59#6 = enNivel;
 eaCuenta = #59#8; |HAZ FiltroCuenta; #59#8 = eaCuenta; #59#9 = enNivel;

 |SI aMonedaC ! aMonedaA;
     |PARA nNume1 = 11; |SI nNume1 [ 24; |HACIENDO nNume1 = nNume1 + 1;
           impMoneda = #59nNume1; |HAZ ElCambioMoneda; #59nNume1 = impMoneda;
     |SIGUE;
 |FINSI;
 |SI enTP100 ! 100;
     |PARA nNume1 = 11; |SI nNume1 [ 24; |HACIENDO nNume1 = nNume1 + 1;
           impMoneda = #59nNume1; |HAZ ElCambio100; #59nNume1 = impMoneda;
     |SIGUE;
 |FINSI;

 nLExi = #59#1;
 |SI nIncLExi = 0;
    nSwLExi = 0;
    |BUCLE BuscoLinea;
    |SI nSwLExi = 0;
        nLExi = nLExi + 1;
    |FINSI;
 |FINSI;

 |ABRE #39;
 #39#0 = #59#0;
 #39#1 = nLExi;
 |LEE 040#39=;
 |SI FSalida ! 0;
     |DDEFECTO #39;
     #39#0 = #59#0;
     #39#1 = nLExi;
     #39#2 = #59#2; #39#3 = #59#3; #39#4 = #59#4;
     #39#5 = #59#5; #39#6 = #59#6; #39#7 = #59#7;
     #39#8 = #59#8; #39#9 = #59#9; #39#10= #59#10;
     |GRABA 020#39b;
 |FINSI;

 |PARA nNume1 = 11; |SI nNume1 [ 24; |HACIENDO nNume1 = nNume1 + 1;
       #39nNume1 = #39nNume1 + #59nNume1;
 |SIGUE;
 |GRABA 020#39a;
 |LIBERA #39;
 |CIERRA #39;

   |PINTA 2202, "Estructura: ";
   |PINTA 2213, #39#0;
   |PINTA 2216, #39#1;
   |PINTA 2219, #39#2;
   |PINTA 2232, #39#4;
|FPRC;

|DEFBUCLE LineaExist;
 #59#1002;
 ;
 #60#0, 00;
 #60#0, 99;
 e;
 NULL, LineaExist0;
|FIN;

|PROCESO CopiaExist;
 nIncLExi = 0;
 #40#0 = #60#0;
 |LEE 101#40=;
 |SI FSalida ! 0;
     nIncLExi = -1;
     #40#0 = #60#0;
     #40#1 = #60#1;
     eaCuenta = #60#2; |HAZ FiltroCuenta; #40#2 = eaCuenta; #40#3 = enNivel;
     |GRABA 020#40b;
 |FINSI;
 |BUCLE LineaExist;
 |LIBERA #40;
|FPRC;

|DEFBUCLE LasExistencias;
 #60#1001;
 ;
 ndDepar;
 nhDepar;
 e;
 NULL,CopiaExist;
|FIN;

|| ..................................... IVA/IRPF
|PROCESO Lcasiim02;
   aAlfa1 = "|NC";
   nCalC = #casiim02#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #casiim02#nNume1# = #asiim02@#nNume1#;
   |SIGUE;

   #casiim02#1 = #36#0;
   #casiim02#2 = #36#1;

   |GRABA 020#casiim02.n;
|FPRC;

|DEFBUCLE Lcasiim02;
   #asiim02@#1004;
   ;
   #asiim01@#0, #asiim01@#1, #asiim01@#2, "";
   #asiim01@#0, #asiim01@#1, #asiim01@#2, aH60;
   e;
   NULL, Lcasiim02;
|FIN;

|PROCESO EspecialAptes;
  |SI #32#12 ! " ";
      #32#13 = #36#0;
      #32#14 = #36#3;
      #32#15 = #36#2;
      |GRABA 020#32a;
  |FINSI;
  |LIBERA #32;
|FPRC;

|DEFBUCLE EspecialAptes;
 #32#1;
 ;
 #36#7, #36#8, #36#9, 0001;
 #36#7, #36#8, #36#9, 9999;
 be;
 NULL, EspecialAptes;
|FIN;

|PROCESO CopiaLinIVA;
   |DDEFECTO #37;

   aAlfa1 = "|NC";
   nCalC  = #caivalin#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #37nNume1 = #57nNume1;
   |SIGUE;

   #37#0  = #36#0;    || Libro
   #37#1  = #36#1;    || Registro

   |SI aMonedaC ! aMonedaA;
      impMoneda = #37#6; |HAZ ElCambioMoneda; #37#6 = impMoneda;
      impMoneda = #37#8; |HAZ ElCambioMoneda; #37#8 = impMoneda;
      impMoneda = #37#10; |HAZ ElCambioMoneda; #37#10 = impMoneda;
      impMoneda = #37#11; |HAZ ElCambioMoneda; #37#11 = impMoneda;
      impMoneda = #37#20; |HAZ ElCambioMoneda; #37#20 = impMoneda;
      impMoneda = #37#22; |HAZ ElCambioMoneda; #37#22 = impMoneda;
   |FINSI;
   |SI enTP100 ! 100;
      impMoneda = #37#6;  |HAZ ElCambio100; #37#6 = impMoneda;
      impMoneda = #37#8;  |HAZ ElCambio100; #37#8 = impMoneda;
      impMoneda = #37#10; |HAZ ElCambio100; #37#10 = impMoneda;
      impMoneda = #37#11; |HAZ ElCambio100; #37#11 = impMoneda;
      impMoneda = #37#20; |HAZ ElCambio100; #37#20 = impMoneda;
      impMoneda = #37#22; |HAZ ElCambio100; #37#22 = impMoneda;
   |FINSI;

   eaCuenta = #37#12; |HAZ FiltroCuenta; #37#12 = eaCuenta;
   eaCuenta = #37#13; |HAZ FiltroCuenta; #37#13 = eaCuenta;
   eaCuenta = #37#14; |HAZ FiltroCuenta; #37#14 = eaCuenta;
   eaCuenta = #37#15; |HAZ FiltroCuenta; #37#15 = eaCuenta;
   eaCuenta = #37#23; |HAZ FiltroCuenta; #37#23 = eaCuenta;

   |GRABA 040#37n;
   |SI FSalida ! 0;
      LineaErrores = LineaErrores + 1;
      #caw00011#0 = LineaErrores;
      #caw00011#1 = "Problemas escribiendo lineas Facturas [" + #37#0 + "/" + #37#1 + "/" + #37#2 + "/"  + "] (" + FSalida + ") Empresa " + #2#1;
      |GRABA 020#caw00011.n;
   |FINSI;

   |PINTA 2202, "Registros: ";
   |PINTA 2213, #37#0;
   |PINTA 2216, #37#1;
   |PINTA 2227, #37#2;
   |PINTA 2231, #37#4;
|FPRC;

|DEFBUCLE BuscaLinIVA;
 #57#1003;
 ;
 #56#0, #56#1, 01;
 #56#0, #56#1, 99;
 e;
 NULL, CopiaLinIVA;
|FIN;

|PROCESO CopiaFacturas;

   |SI nSiExc = 1;
       aCtaExc = #56#12;
       |HAZ LaExclusion;
       |SI nSwExCta = 1;
           |ACABA;
        |FINSI;
   |FINSI;

   |SI aDeparta ! "00";
       |SI aDeparta ! #56#10;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI nLibDest = -1;
       nLibroD  = #56#0 + nIncrLib;
   |SINO;
       nLibroD = nLibDest;
   |FINSI;
   |HAZ GrabaLibro;

   nReg = #56#1;
   |SI #1#10 = "N";
      #36#0 = nLibroD;
      #36#1 = #56#1;
      |LEE 040#36=;
      |SI FSalida = 0;
          LineaErrores = LineaErrores + 1;
          #caw00011#0  = LineaErrores;
          #caw00011#1  = "Registro IVA/IRPF No Pasado [" + #56#0 + "/" + #56#1 + "/" + #56#2 + "] de la Empresa " + #2#1;
          |GRABA 020#caw00011.n;
          |ACABA;
      |FINSI;
   |SINO;
      #36#0 = nLibroD;
      #36#1 = 9999999999;
      |LEE 010#36];
      |SI FSalida = 0;
          |LEE 040#36a;
      |SINO;
          |LEE 040#36u;
      |FINSI;
      nReg = 1;
      |SI FSalida = 0; |Y #36#0 = nLibroD;
          nReg = #36#1 + 1;
      |FINSI;
   |FINSI;

   aAlfa1 = "|NC";
   nCalC  = #camaniva#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #36nNume1 = #56nNume1;
   |SIGUE;

   #36#0 = nLibroD;
   #36#1 = nReg;

   |SI aMonedaC ! aMonedaA;
      impMoneda = #36#15; |HAZ ElCambioMoneda; #36#15 = impMoneda;
      impMoneda = #36#17; |HAZ ElCambioMoneda; #36#17 = impMoneda;
      impMoneda = #36#19; |HAZ ElCambioMoneda; #36#19 = impMoneda;
      impMoneda = #36#20; |HAZ ElCambioMoneda; #36#20 = impMoneda;
      impMoneda = #36#21; |HAZ ElCambioMoneda; #36#21 = impMoneda;
      impMoneda = #36#23; |HAZ ElCambioMoneda; #36#23 = impMoneda;
      impMoneda = #36#26; |HAZ ElCambioMoneda; #36#26 = impMoneda;
   |FINSI;

   |SI enTP100 ! 100;
      impMoneda = #36#15; |HAZ ElCambio100; #36#15 = impMoneda;
      impMoneda = #36#17; |HAZ ElCambio100; #36#17 = impMoneda;
      impMoneda = #36#19; |HAZ ElCambio100; #36#19 = impMoneda;
      impMoneda = #36#20; |HAZ ElCambio100; #36#20 = impMoneda;
      impMoneda = #36#21; |HAZ ElCambio100; #36#21 = impMoneda;
      impMoneda = #36#23; |HAZ ElCambio100; #36#23 = impMoneda;
      impMoneda = #36#26; |HAZ ElCambio100; #36#26 = impMoneda;
   |FINSI;

   eaCuenta = #36#12; |HAZ FiltroCuenta; #36#12 = eaCuenta;

   |SI #2#20 ! "N";   ||Colocar la serie en la factura
       |SI #36#36 ! "N";
           |SI #36#36 = #2#20; |O #2#20 = "A";
               #36#2  = ("00000" + #2#1) % -105;
           |FINSI;
       |FINSI;
   |FINSI;

   #904#0 = #36#7;
   #904#1 = #36#8;
   #904#2 = #36#9;
   |LEE 041#904=;
   |SI FSalida = 0;
       #36#7 = #904#3;
       #36#8 = #904#4;
       #36#9 = #904#5;
       |BUCLE EspecialAptes;
   |FINSI;

   |GRABA 040#36n;

   |ABRE #113;
   #113#0 = #56#0;
   #113#1 = #56#1;
   |LEE 001#56=;
   |SI FSalida = 0;
       |ABRE #223;
       #223#0 = #36#0;
       #223#1 = #36#1;
       |LEE 101#223=;
       |SI FSalida ! 0;
           #223#0 = #36#0;
           #223#1 = #36#1;
           |GRABA 020#223b;
       |FINSI;
       #223#2 = #36#2;
       #223#3 = #36#3;
       |PARA nPara1 = 4; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
             #223nPara1 = #113nPara1;
       |SIGUE;
       |GRABA 020#223a;
       |LIBERA #223;
       |CIERRA #223;
   |FINSI;
   |CIERRA #113;

   |BUCLE BuscaLinIVA;

   #asiim01@#0 = "camaniva";
   #asiim01@#1 = #56#0;
   #asiim01@#2 = #56#1;
   |LEE 041#asiim01@.=;
   |SI FSalida = 0;

       #casiim01#0 = "camaniva";
       #casiim01#1 = #36#0;
       #casiim01#2 = #36#1;
       |LEE 141#casiim01.=;
       nEstado = FSalida;

       aAlfa1 = "|NC";
       nCalC = #asiim01@#aAlfa1#;
       |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
             #casiim01#nNume1# = #asiim01@#nNume1#;
       |SIGUE;

       #casiim01#1 = #36#0;
       #casiim01#2 = #36#1;
       |SI nEstado = 0; |GRABA 020#casiim01.a; |FINSI;
       |SI nEstado ! 0; |GRABA 020#casiim01.n; |FINSI;
       |LIBERA #casiim01;

       |BUCLE Lcasiim02;
   |FINSI;
|FPRC;

|DEFBUCLE LasFacturas;
 #56#1002;
 27;
 ndLibro, 0000000001, ndConcep;
 nhLibro, 9999999999, nhConcep;
 e;
 NULL,CopiaFacturas;
|FIN;

|PROCESO Lcam00004p;
 ndLibro  = #4#3;
 nhLibro  = #4#3;
 nIncrLib = 0;
 nLibDest = #4#4;
 |BUCLE LasFacturas;
 |LIBERA #4;
|FPRC;

|DEFBUCLE Lcam00004;
 #4#1;
 ;
 #2#0, #2#1, 00;
 #2#0, #2#1, 99;
 be;
 NULL, Lcam00004p;
|FIN;
||  *******************************************************************
||  *******************************************************************
|PROCESO LosAstosMenos0;
  |SI aDeparta ! "00";
      |SI aDeparta ! #52#21; |ACABA; |FINSI;
  |FINSI;

  |SI nDiaDest = -1;
      |SI #52#0 = 0; |O #52#0 = 99;
          Diario = #52#0;
      |SINO;
          Diario = #52#0 + nIncrDia;
      |FINSI;
  |SINO;
      Diario = nDiaDest;
  |FINSI;

  |SI aMonedaC ! aMonedaA;
      impMoneda = #52#9; |HAZ ElCambioMoneda; #52#9 = impMoneda;
  |FINSI;
  |SI enTP100 ! 100;
      impMoneda = #52#9; |HAZ ElCambio100; #52#9 = impMoneda;
  |FINSI;
  eaCuenta = #52#4;  |HAZ FiltroCuenta; #52#4  = eaCuenta; #52#5  = enNivel;

  MasMenos     = #52#9;
  DebeHaber    = #52#8;
  aCUENTA      = #52#4;
  nREGISTRO    = #52#24;
  nDIARIO      = Diario;
  aFECHA       = #52#1;
  nDOCUMENTO   = #52#2;
  nNIVELCUENTA = #52#5;
  |HAZ ActCuenta;          || cuenta
|FPRC;

|DEFBUCLE LosAstosMenos;
 #52#1004;
 6;
 ndDiario, fec1, 000001, 0001, ndConcep;
 nhDiario, fec2, 999999, 9999, nhConcep;
 e;
 NULL, LosAstosMenos0;
|FIN;

----------------
|PROCESO LosAstosMenos_L;
   |SI swOpera = 0;       ||Comprueba que esta en la Seleccion;
       |SI nSiExc = 1;
           aCtaExc = #52#4;
           |HAZ LaExclusion;
           |SI nSwExCta = 1;
               nSwBueno = 2;  || no vale el asiento
               |ERROR10;
           |FINSI;
       |FINSI;
   |SINO;
       |SI nSiExc = 1;
           aCtaExc = #52#4;
           |HAZ LaExclusion;
           |SI nSwExCta = 1; |ACABA; |FINSI;
       |FINSI;
       |HAZ LosAstosMenos0;
   |FINSI;

|FPRC;

|DEFBUCLE LosAstosMenos_L;
 #52#1004;
 6;
 #51#0, #51#1, #51#2, 0001, ndConcep;
 #51#0, #51#1, #51#2, 9999, nhConcep;
 e;
 NULL, LosAstosMenos_L;
|FIN;

|PROCESO MiroAstos;
   |SI #2#17 = "S";
       swOpera  = 0;
       nSwBueno = 0;
       |BUCLE LosAstosMenos_L;
       |SI nSwBueno ! 0; |ACABA; |FINSI;
   |FINSI;

   swOpera = 1;
   |BUCLE LosAstosMenos_L;
|FPRC;

|DEFBUCLE LosAstosMenos_C;
 #51#1003;
 ;
 ndDiario, fec1, 000001;
 nhDiario, fec2, 999999;
 e;
 NULL,MiroAstos;
|FIN;

|| ------------------------------------------------------------
|PROCESO CopiaLineas;
   |SI swOpera = 0;       ||Comprueba que esta en la Seleccion;

       |SI nSiExc = 1;
           aCtaExc = #52#4;
           |HAZ LaExclusion;
           |SI nSwExCta = 1;
               nSwBueno = 2;  || no vale el asiento
               |ERROR10;
               |ACABA;
           |FINSI;
       |FINSI;

       |SI nSwBueno = 1;   || no esta seleccionado
           |SI #52#6 ] ndConcep; |Y #52#6 [ nhConcep;
               nSwBueno = 0;
           |SINO;
               nSwBueno = 1;
           |FINSI;
           |SI nSwBueno = 0;
               |SI aDeparta ! "00";
                   |SI aDeparta ! #52#21;
                       nSwBueno = 1;
                   |SINO;
                       nSwBueno = 0;
                   |FINSI;
               |SINO;
                    nSwBueno = 0;
               |FINSI;
           |FINSI;
       |FINSI;
       |ACABA;
   |FINSI;

   |DDEFECTO #32;

   aAlfa1 = "|NC";
   nCalC  = #camaasil#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #32nNume1 = #52nNume1;
   |SIGUE;

   #32#0  = #31#0;    ||Diario
   #32#2  = #31#2;    ||Documento
   #32#24 = #31#12;   ||Registro
   |SI aMonedaC ! aMonedaA;
       impMoneda = #32#9; |HAZ ElCambioMoneda; #32#9 = impMoneda;
   |FINSI;
   |SI enTP100 ! 100;
       impMoneda = #32#9; |HAZ ElCambio100; #32#9 = impMoneda;
   |FINSI;


   eaCuenta = #32#4;  |HAZ FiltroCuenta; #32#4  = eaCuenta; #32#5  = enNivel;
   eaCuenta = #32#10; |HAZ FiltroCuenta; #32#10 = eaCuenta; #32#11 = enNivel;
   eaCuenta = #32#16; |HAZ FiltroCuenta; #32#16 = eaCuenta; #32#17 = enNivel;


   |SI #32#12 ! " "; |Y #1#2 > 2;
       nLibroO = #32#13;
       |HAZ ElLibro;
       |SI nLibroD = -1;          ||Si no ha elegido libro borra relacion
           |PDEFECTO #32, 12, 16;
       |SINO;
           #32#13 = nLibroD;
           |SI #2#20 ! "N";   ||Colocar la serie en la factura
               |SI #32#12 = #2#20; |O #2#20 = "A";
                   #32#15 = ("00000" + #2#1) % -105;
               |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   |GRABA 040#32n;
   nAlAsto = 1;
   |SI FSalida ! 0;
      LineaErrores = LineaErrores + 1;
      #caw00011#0 = LineaErrores;
      #caw00011#1 = "Problemas escribiendo lineas asientos [" + #camaasil#0 + "/" + #camaasil#1 + "/" + #camaasil#2 + "/" + #camaasil#3 + "] (" + FSalida + ") Empresa " + #2#1;
      |GRABA 020#caw00011.n;
   |SINO;
      |HAZ AstosAnaLinea;
   |FINSI;

   |PINTA 2202, "Asiento: ";
   |PINTA 2211, #32#0;
   |PINTA 2214, #32#1;
   |PINTA 2225, #32#2;
   |PINTA 2232, #32#3;
   |PINTA 2237, #32#7;
|FPRC;

|DEFBUCLE BuscaLineas;
 #52#1004;
 ;
 #51#0, #51#1, #51#2, 0001;
 #51#0, #51#1, #51#2, 9999;
 e;
 NULL, CopiaLineas;
|FIN;


|| ------------------------------------------------------------------------
|PROCESO LesCaps0;
 nDoc = #31#2;
|FPRC;

|DEFBUCLE LesCaps;
 #31#3;
 0,1;
 000001, Diario, fec1;
 999999, Diario, fec2;
 e;
 NULL, LesCaps0;
|FIN;

|PROCESO CopiaAsientos;

   swOpera  = 0;
   nSwBueno = 1;
   |BUCLE BuscaLineas;
   |SI nSwBueno ! 0; |ACABA; |FINSI;

   |SI nDiaDest = -1;
       |SI #51#0 = 0; |O #51#0 = 99;
           Diario = #51#0;
       |SINO;
           Diario = #51#0 + nIncrDia;
       |FINSI;
   |SINO;
       Diario = nDiaDest;
   |FINSI;
   |HAZ ElDiario;

   #31#0 = Diario;
   #31#1 = #51#1;
   #31#2 = #51#2; nDoc = #31#2;
   |LEE 040#31=;
   |SI FSalida = 0;
       |SI Diario ! 00; |Y Diario ! 99;
           |SI #1#11 = "N";
               LineaErrores = LineaErrores + 1;
               #caw00011#0  = LineaErrores;
               #caw00011#1  = "Asiento No Pasado [" + #51#0 + "/" + #51#1 + "/" + #51#2 + "] de la Empresa " + #2#1;
               |GRABA 020#caw00011.n;
               |ACABA;
           |SINO;
               |HAZ UDocumento;
           |FINSI;
      |SINO;
           |CIERRA #31;
           |BUCLE LesCaps;
           |ABRE #31;
           nDoc = nDoc + 1;
      |FINSI;
   |FINSI;

   aAlfa1 = "|NC";
   nCalC  = #camaasic#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #31nNume1 = #51nNume1;
   |SIGUE;
   #31#0 = Diario;
   #31#2 = nDoc;

   |SI aMonedaC ! aMonedaA;
      impMoneda = #31#4; |HAZ ElCambioMoneda; #31#4 = impMoneda;
      impMoneda = #31#5; |HAZ ElCambioMoneda; #31#5 = impMoneda;
      impMoneda = #31#6; |HAZ ElCambioMoneda; #31#6 = impMoneda;
   |FINSI;
   |SI enTP100 ! 100;
      impMoneda = #31#4; |HAZ ElCambio100; #31#4 = impMoneda;
      impMoneda = #31#5; |HAZ ElCambio100; #31#5 = impMoneda;
      impMoneda = #31#6; |HAZ ElCambio100; #31#6 = impMoneda;
   |FINSI;

   eaCuenta = #31#8;  |HAZ FiltroCuenta; #31#8  = eaCuenta; #31#9  = enNivel;
   eaCuenta = #31#10; |HAZ FiltroCuenta; #31#10 = eaCuenta; #31#11 = enNivel;

   |HAZ NuevoRegistro;
   #31#12 = nREGISTRO;
   |GRABA 040#31n;

   |SI #51#13 ! 0;
       #904#0 = #51#0;
       #904#1 = #51#1;
       #904#2 = #51#2;
       |LEE 040#904=;
       |SI FSalida ! 0;
           #904#0 = #51#0;
           #904#1 = #51#1;
           #904#2 = #51#2;
           #904#3 = #31#0;
           #904#4 = #31#1;
           #904#5 = #31#2;
           #904#6 = #51#13;
           |GRABA 020#904n;
      |FINSI;
   |FINSI;

   swOpera = 1;
   |BUCLE BuscaLineas;
|FPRC;

|DEFBUCLE LosAsientos;
   #51#1003;
   ;
   ndDiario, fec1, 000001;
   nhDiario, fec2, 999999;
   e;
   NULL,CopiaAsientos;
|FIN;

|PROCESO Lcam00003p;
 ndDiario = #3#3;
 nhDiario = #3#3;
 nIncrDia = 0;
 nDiaDest = #3#4;
 aDeparta = #3#5;
 ndConcep = #3#6;
 nhConcep = #3#7;
 |SI #1#2 = 1;
     |SI nSiExc = 0;
         |BUCLE LosAstosMenos;
     |SINO;
         |BUCLE LosAstosMenos_C;
     |FINSI;
 |SINO;
     |BUCLE LosAsientos;
 |FINSI;
 |LIBERA #3;
|FPRC;

|DEFBUCLE Lcam00003;
 #3#1;
 ;
 #2#0, #2#1, 00;
 #2#0, #2#1, 99;
 be;
 NULL, Lcam00003p;
|FIN;

|| *********************************************************************
|PROCESO CalFechas;

   |SI #canempre#26 > 80;
       nEjer = 1900 + #canempre#26;
   |SINO;
       nEjer = 2000 + #canempre#26;
   |FINSI;
   aAlfa1 = nEjer;

   aMes    = ( "00" + #canempre#11) % -102;
   aAlfa2  = "01." + aMes + "." + aAlfa1;
   fFechaI = aAlfa2;

   aMes    = ( "00" + #canempre#12) % -102;
   |SI #canempre#11 > #canempre#12;
       nEjer  = nEjer + 1;
       aAlfa1 = nEjer;
   |FINSI;

   aDia = "31";
   |SI #canempre#12 = 4; |O #canempre#12 = 6; |O #canempre#12 = 9; |O #canempre#12 = 11;
       aDia = "30";
   |FINSI;
   |SI #canempre#12 = 2;
       aDia = "28";
       |SI nEjer = 2000; |O nEjer = 2004; |O nEjer = 2008; |O nEjer = 2012
           |O nEjer = 2016; |O nEjer = 2020;
            aDia = "29";
       |FINSI;
   |FINSI;
   aAlfa2 = aDia + "." + aMes + "." + aAlfa1;
   fFechaF = aAlfa2;
|FPRC;

|PROCESO ProcesaEmpresa_V;
   |HAZ CalFechas;
   |SI fFechaI > fec2; |ACABA; |FINSI;
   |SI fFechaF < fec1; |ACABA; |FINSI;

   #0#5 = #2#1;   |PINTA #0#5;
   #0#6 = #30#3;  |PINTA #0#6;
   #0#7 = #2#2;   |PINTA #0#7;
   #0#8 = #0#3;   |PINTA #0#8;
   #0#9 = #30#28;
   aMonedaC = #0#9;

   nLong1 = #30#14;       || 1 nivel
   nLong2 = #30#15;       || 2 nivel
   nLong3 = #30#16;       || 3 nivel
   nLong4 = #30#17;       || 4 nivel
   nLong5 = #30#18;       || 5 nivel
   nLong6 = #30#19;       || 6 nivel

   nLonDif = #2#19;
   aDigDif = #2#3; |QBF aDigDif;
   aDigDif = ("000" + aDigDif) % -103;
   |SI nLonDif = 2;
       aDigDif = aDigDif % -102;
   |SINO;
       |SI nLonDif = 1;
           aDigDif = aDigDif % -101;
      |FINSI;
   |FINSI;
   aRenCta = #2#21;

   |SI #1#2 ! 1; |O enPor = 0; #2#18 = 100; |FINSI;
   enTP100  = #2#18;

   |SI enTP100 = 0;
      |CONFI "    SEl % informado para esta Empresa es 0. Es Correcto ?";
      |SI FSalida = 0;
          |ACABA;
      |FINSI;
      |PUSHV  1046 1263;
      |CUADRO 1046 1263;
      |ATRI I; |PINTA 1147, " Nuevo % "; |ATRI 0;
      |ENCAMPO #18#2;
      |GRABA 020#2a;

      |LEE 020#2=;
      |POPV;
   |FINSI;
   enTP100  = #2#18;
   |DELINDEX #904;

   |DFICB aAlfa1;
   aAlfa2 = #30#0; |QBF aAlfa2;
   aAlfa2 = ("000000" + #30#0) % -106;
   eaDirOrigen = aAlfa1 + aAlfa2 + "/";

   |PATH_DAT #51 eaDirOrigen;
   |PATH_DAT #52 eaDirOrigen;
   |PATH_DAT #53 eaDirOrigen;
   |PATH_DAT #54 eaDirOrigen;
   |PATH_DAT #55 eaDirOrigen;
   |PATH_DAT #56 eaDirOrigen;
   |PATH_DAT #57 eaDirOrigen;
   |PATH_DAT #58 eaDirOrigen;
   |PATH_DAT #59 eaDirOrigen;
   |PATH_DAT #60 eaDirOrigen;
   |PATH_DAT #113 eaDirOrigen;
   |PATH_DAT #asiim01@#eaDirOrigen#;
   |PATH_DAT #asiim02@#eaDirOrigen#;

   nSiExc = 0; |SI #2#15 = "S"; nSiExc = 1; |FINSI;

   |DELINDEX #cacambix;
   |ABRE #cacambix;

       |ABRE #34;
       aTitulo = "Tratando Plan Contable ";
       |HAZ CuadroProc;
       |BUCLE Cuentas;
       |CIERRA #34;

   |SI #1#2 ] 3;
       |ABRE #38;
       aTitulo = "Tratando Clientes / Proveedores ";
       |HAZ CuadroProc;
       |BUCLE CliPro;
       |CIERRA #38;
  |FINSI;
|| ................... Pase de Asientos
   |ABRE #904;
    nSiAna = 0;
   |SI #1#2 ! 3;

       |SI #1#2 ! 1; |Y enSwAna = 1;
           |HAZ AstosAnaInicio;
       |FINSI;

       |ABRE #31;
       |ABRE #32;
       aTitulo = "Tratando Apuntes Contables ";
       |HAZ CuadroProc;
       |SI #2#4 = "S";
           ndDiario = #2#5;
           nhDiario = #2#6;
           nIncrDia = #2#7;
           nDiaDest = -1;
           aDeparta = #2#12;
           ndConcep = #2#13;
           nhConcep = #2#14;
           |SI #1#2 = 1;
               |SI nSiExc = 0;
                   |BUCLE LosAstosMenos;
               |SINO;
                   |BUCLE LosAstosMenos_C;
               |FINSI;
           |SINO;
               |BUCLE LosAsientos;
           |FINSI;
       |SINO;
           |BUCLE Lcam00003;
       |FINSI;
       |CIERRA #32;
       |CIERRA #31;

       |HAZ AstosAnaFin;
   |FINSI;

|| .................. Pase de Facturas
   |SI #1#2 > 2;
       |ABRE #casiim01;
       |ABRE #casiim02;
       |ABRE #asiim01@;
       |ABRE #36;
       |ABRE #37;
       aTitulo = "Tratando Registros IVA/IRPF ";
       |HAZ CuadroProc;
       aDeparta = #2#12;
       ndConcep = #2#13;
       nhConcep = #2#14;
       |SI #2#8 = "S";
           ndLibro  = #2#9;
           nhLibro  = #2#10;
           nIncrLib = #2#11;
           nLibDest = -1;
           |BUCLE LasFacturas;
       |SINO;
           |BUCLE Lcam00004;
       |FINSI;
       |CIERRA #37;
       |CIERRA #36;
       |CIERRA #asiim01@;
       |CIERRA #casiim02;
       |CIERRA #casiim01;
   |FINSI;
   |CIERRA #904;

   |SI #1#2 ! 1; |Y enSwAna = 1;
       aTitulo = "Tratando Ficheros Analitica ... ";
       |HAZ CuadroProc;
       enEmpresa = #2#0;
       enEmpOrig = #2#1;
       |CIERRA #caw00011;
       |SUB_EJECUTA_NP "anz00008";
       |ABRE #caw00011;
   |FINSI;

   |SI #1#2 = 4;
       aTitulo = "Tratando Existencias ";
       |HAZ CuadroProc;
       ndDepar = 0; nhDepar = 99;
       |SI #2#12 ! "00"; ndDepar = #2#12; nhDepar = #2#12; |FINSI;

       |ABRE #40;
       |BUCLE LasExistencias;
       |CIERRA #40;

       |SI #1#5 = "S";
           aTitulo = "Tratando Elementos de Amortizacion ";
           |HAZ CuadroProc;
           enEmpresa = #2#0;
           enEmpOrig = #2#1;
           |CIERRA #caw00011;
           |SUB_EJECUTA_NP "caz00012";
           |ABRE #caw00011;
      |FINSI;
   |FINSI;

   |CIERRA #cacambix;
|FPRC;

|DEFBUCLE LeePeriodos;
 #30#1;
 ;
 #2#1, 0;
 #2#1, 9;
 ;
 NULL, ProcesaEmpresa_V;
|FIN;

|PROCESO ProcesaEmpresa;
  |BUCLE LeePeriodos;
|FPRC;

|DEFBUCLE Lcam00002;
 #2#1;
 ;
 #1#0, 00001;
 #1#0, 99999;
 e;
 NULL, ProcesaEmpresa;
|FIN;

|| *********************************************************************
|| *********************************************************************
|| *********************************************************************
|RUTINA inf1;
   #caw00011#0 = 1;
|FRUT;

|RUTINA sup1;
   #caw00011#0 = 999999;
|FRUT;

|PROCESO HazTodo;
  aH60    = " " * 60;
  nAlAsto = 0;
  nAlCta  = 0;

  aFichero = ("x" + Usuario) % 108;
  |NOME_DAT #cacambix#aFichero#;

  |DELINDEX #caw00011;
  |ABRE #caw00011;

  |HAZ Acerar;
  |BUCLE Lcam00002;
  |SI #1#2 = 2; |O #1#2 = 4;
     || |DFICE pathbal;
     || balance = 1;
     || |SUB_EJECUTA_NP "careccue";
  |FINSI;
  |DFICE dirfich0;
  |HAZ NoTesteo;
  |SI #1#2 = 1; |Y enPor = 1;
      |SUB_EJECUTA_NP "caz00028";
      || |DFICE pathbal;
      || balance = 1;
      || |SUB_EJECUTA_NP "careccue";
  |FINSI;

  |CIERRA #caw00011;
  |SI nAlAsto = 1; |O nAlCta = 1;
      |SUB_EJECUTA_NP "catestcu;F";
      |SI #1#2 = 2; |O #1#2 = 4;
          |SI nAlAsto = 1;
              |DFICE dirfich0;
              |SUB_EJECUTA_NP "carecupe;F";
          |FINSI;
      |FINSI;
  |FINSI;

  |SI enAutom = 0;
     |ENTLINEAL #1#caw00011,-1,4,21,1,inf1,sup1;
  |FINSI;
|FPRC;

|| --------------------------------------------- Rutinas Varias
|PROCESO  BorrarLAmor0;
 |BORRA 020#dsmom042.a;
 |LIBERA #dsmom042;
|FPRC;

|DEFBUCLE BorrarLAmor;
 #dsmom042#1;
 ;
 #1#0,"        ", 00,000;
 #1#0,"zzzzzzzz", 99,999;
 be;
 NULL, BorrarLAmor0;
|FIN;

|PROCESO BorrarCAmor0;
 |BORRA 020#dsmom041.a;
 |LIBERA #dsmom041;
|FPRC;

|DEFBUCLE BorrarCAmor;
 #dsmom041#1;
 ;
 #1#0,"        ", 00;
 #1#0,"zzzzzzzz", 99;
 be;
 NULL, BorrarCAmor0;
|FIN;

|PROCESO BorraCuenta0;
 |PDEFECTO #34,9,54;
 #34#58 ="01.01.1900";
 |GRABA 020#34a;
 |LIBERA #34;
|FPRC;

|DEFBUCLE BorraCuenta;
 #34#1;
 ;
 "            ";
 "zzzzzzzzzzzz";
 be;
 NULL, BorraCuenta0;
|FIN;

|PROCESO BorraDiario0;
 |SI #33#0 = 0; |O #33#0 = 99;
     #33#2 = 0;
     #33#3 = 0;
     |GRABA 020#33a;
 |SINO;
     |BORRA 020#33a;
 |FINSI;
 |LIBERA #33;
|FPRC;

|DEFBUCLE BorraDiario;
 #33#1;
 ;
 00;
 99;
 be;
 NULL, BorraDiario0;
|FIN;

|PROCESO BorraLibro0;
 |BORRA 020#35a;
 |LIBERA #35;
|FPRC;

|DEFBUCLE BorraLibro;
 #35#1;
 ;
 00;
 99;
 be;
 NULL, BorraLibro0;
|FIN;

|PROCESO Acerar;
  |SI #1#2 = 1;
      |DELINDEX #cacuenta;
      |ABRET #cacuenta;
      |CIERRAT #cacuenta;
||      |BUCLE BorraCuenta;
  |SINO;
      |SI #1#2 ! 3;         ||Consolidar asientos
          |DELINDEX #caconasi;
          |ABRET #caconasi;
          |CIERRAT #caconasi;

          |DELINDEX #camaasic;
          |ABRET #camaasic;
          |CIERRAT #camaasic;

          |DELINDEX #camaasil;
          |ABRET #camaasil;
          |CIERRAT #camaasil;

          |SI enSwAna = 1;
              |DELINDEX #anm00012;
              |ABRET #anm00012;
              |CIERRAT #anm00012;

              |DELINDEX #anm00013;
              |ABRET #anm00013;
              |CIERRAT #anm00013;
          |FINSI;

          |BUCLE BorraDiario;
          |DELINDEX #cacuenta;
          |ABRET #cacuenta;
          |CIERRAT #cacuenta;
          ||   |BUCLE BorraCuenta;
     |FINSI;
     |SI #1#2 > 2;
          |DELINDEX #camaniva;
          |ABRET #camaniva;
          |CIERRAT #camaniva;

          |DELINDEX #caivalin;
          |ABRET #caivalin;
          |CIERRAT #caivalin;

          |DELINDEX #casiim01;
          |ABRET #casiim01;
          |CIERRAT #casiim01;

          |DELINDEX #casiim02;
          |ABRET #casiim02;
          |CIERRAT #casiim02;

          |DELINDEX #caivam03;
          |ABRET #caivam03;
          |CIERRAT #caivam03;

          |BUCLE BorraLibro;
     |FINSI;
     |SI #1#2 = 4;
          |DELINDEX #caexistc;
          |ABRET #caexistc;
          |CIERRAT #caexistc;
          |DELINDEX #caexistl;
          |ABRET #caexistl;
          |CIERRAT #caexistl;
          |SI #1#5 = "S";
             |BUCLE BorrarCAmor;
             |BUCLE BorrarLAmor;
          |FINSI;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO CuadroProc;
   aAlfa3 = " " * 78;
   |PINTA 2102, aAlfa3;
   |PINTA 2202, aAlfa3;
   |ATRI I;  |PINTA 2102, aTitulo; |ATRI N;
|FPRC;

|PROCESO FiltroCuenta;
   enNivel = 0;
   |HAZ SacaNivel;
   |SI enNivel = 0; |ACABA; |FINSI;

   |SI #1#3 = 0; |ACABA; |FINSI;

   |SI aRenCta = "S";
       #cacambix#0 = eaCuenta;
       #cacambix#1 = dig3;
       |LEE 041#cacambix.=;
       |SI FSalida = 0;
           eaCuenta = #cacambix#2;
           |ACABA;
       |FINSI;
   |FINSI;

      || Tomar la primera parte segun la posicion indicada
      ComodNum  = 100 + (#1#3 - 1);
      Comodin  = eaCuenta % ComodNum;

      || Sumar el digito diferenciador
      |QBF Comodin;
      Comodin = Comodin + aDigDif;
      |QBF Comodin;
      LongAlfa = Comodin % 0;
      Long = LongAlfa;

      || Tomar la segunda parte segun la posicion indicada
      |SI nLonDif = 3;
          ComodNum2 = ((#1#3 + 3) * 100) + 99;
      |SINO;
          |SI nLonDif = 2;
              ComodNum2 = ((#1#3 + 2) * 100) + 99;
          |SINO;
              ComodNum2 = ((#1#3 + 1) * 100) + 99;
         |FINSI;
      |FINSI;

      Comodin1 = eaCuenta % ComodNum2;
      |QBF Comodin1;
      LongAlfa = Comodin1 % 0;
      Long = Long + LongAlfa;

      || Obtengo la diferencia entre la longitud del ultimo nivel y la
      ||    longitud de la cadena que ya tengo calculada para rellenar
      ||    la cuenta con ceros (si procede)

      |SI UltNivel = 1; Long = dig4 - Long; |FINSI;
      |SI UltNivel = 2; Long = dig5 - Long; |FINSI;
      |SI UltNivel = 3; Long = dig6 - Long; |FINSI;
      |SI UltNivel = 4; Long = dig7 - Long; |FINSI;
      |SI UltNivel = 5; Long = dig8 - Long; |FINSI;
      |SI UltNivel = 6; Long = dig9 - Long; |FINSI;

      Comodin2 = "0" * Long;
      |QBF Comodin2;
      Comodin = Comodin + Comodin2 + Comodin1;
      |QBF Comodin;

      eaCuenta = Comodin;
      |HAZ SacaNivel;
|FPRC;

|| ---------------- Libros
|PROCESO ElLibro10;
 nLibroD = #4#4;
|FPRC;

|DEFBUCLE ElLibro1;
 #4#1;
 3;
 #2#0, #2#1, 01, nLibroO;
 #2#0, #2#1, 99, nLibroO;
 e;
 NULL, ElLibro10;
|FIN;

|PROCESO ElLibro;
 nLibroD = -1;
 |SI #2#8 = "N";
     |BUCLE ElLibro1;
 |SINO;
     |SI nLibroO ] #2#9; |Y nLibroO [ #2#10;
         nLibroD = nLibroO + #2#11;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO GrabaLibro;
 |ABRE #35;
 #35#0 = nLibroD;
 |LEE 040#35=;
 |SI FSalida ! 0;
     |DDEFECTO #35;
     #35#0 = nLibroD;
     |SI nLibDest ! -1;
         #35#1 = #4#5;
         #35#2 = #4#7;
         #35#3 = #4#8;
     |SINO;
         |ABRE #55;
         #55#0 = #56#0;
         |LEE 040#55=;
         |SI FSalida = 0;
             #35#1 = #55#1;
             #35#2 = #55#2;
             #35#3 = #55#3;
         |SINO;
             #35#1 = "LIBRO SIN DEFINIR";
             #35#2 = #56#36;
             #35#3 = 1;
         |FINSI;
         |CIERRA #55;
     |FINSI;
     |GRABA 020#35n;
 |FINSI;
 |CIERRA #35;
|FPRC;

|PROCESO ElDiario;
 |ABRE #33;
 #33#0 = Diario;
 |LEE 040#33=;
 |SI FSalida ! 0;
     |ABRE #53;
     #53#0 = #51#0;
     |LEE 040#53=;
     |SI FSalida ! 0;
         |DDEFECTO #53;
     |FINSI;
     |CIERRA #53;
     |DDEFECTO #33;
     #33#0 = Diario;

     aAlfa1 = #53#1; |QBF aAlfa1;
     |SI #33#0 ! 0; |Y #33#0 ! 99;
         aAlfa1 = aAlfa1 + "-Emp.: " + ("00000" + #2#1) % -105;
     |FINSI;
     #33#1 = aAlfa1;

     |GRABA 020#33n;
 |FINSI;
 |CIERRA #33;
|FPRC;

|PROCESO UDocumento;
      |ABRE #949;
      |DDEFECTO #949;
      #949#0 = Diario;
      |LEE 041#949=;
      |SI FSalida ! 0;
          |DDEFECTO #949;
          #949#0 = Diario;
          |GRABA 020#949b;
      |FINSI;
      #949#1 = #949#1 + 1;
      |GRABA 020#949a;
      nDoc   = #949#1;
      |LIBERA #949;
      |CIERRA #949;
|FPRC;


|| ........... Procesos para analitica
|PROCESO AstosAnaInicio;

 |DBASE aAlfa1; |QBF aAlfa1;
 aAlfa2 = aAlfa1 + "def/anm00012.mas";
 |CARGA_DEF aAlfa2, nm00012@;
 |SI FSalida = 0;
     aAlfa2 = aAlfa1 + "def/anm00013.mas";
     |CARGA_DEF aAlfa2, nm00013@;
     |SI FSalida = 0;
         nSiAna = 1;
         |PATH_DAT #22 eaDirOrigen;
         |PATH_DAT #23 eaDirOrigen;
     |SINO;
         |DESCARGA_DEF #nm00012@;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO AstosAnaFin;
 |SI nSiAna = 1;
     |DESCARGA_DEF #nm00013@;
     |DESCARGA_DEF #nm00012@;
 |FINSI;
|FPRC;

|PROCESO AnaLineas0;

   |DDEFECTO #13;

   aAlfa1 = "|NC";
   nCalC  = #anm00013#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #13nNume1 = #23nNume1;
   |SIGUE;

   #13#0  = #12#0;    ||Diario
   #13#1  = #12#1;    ||Fecha
   #13#2  = #12#2;    ||Documento
   #13#3  = #12#3;    ||Linea
   #13#4  = #12#4;    ||Grupo
   |SI aMonedaC ! aMonedaA;
       impMoneda = #13#9; |HAZ ElCambioMoneda; #13#9 = impMoneda;
   |FINSI;
   |SI enTP100 ! 100;
       impMoneda = #13#9; |HAZ ElCambio100; #13#9 = impMoneda;
   |FINSI;
   |GRABA 040#13n;
   |SI FSalida ! 0;
       LineaErrores = LineaErrores + 1;
       #caw00011#0 = LineaErrores;
       #caw00011#1 = "Problemas escribiendo lineas grupos Analiticos [" + #anm00012#0 + "/" + #anm00012#1 + "/" + #anm00012#2 + "/" + #anm00012#3 + "] (" + FSalida + ") Empresa " + #2#1;
       |GRABA 020#caw00011.n;
   |FINSI;
|FPRC;

|DEFBUCLE AnaLineas;
 #23#1006;
 ;
 #22#0, #22#1, #22#2, #22#3, #22#4, 001;
 #22#0, #22#1, #22#2, #22#3, #22#4, 999;
 e;
 NULL, AnaLineas0;
|FIN;

|PROCESO AstosAnaLinea;

   |SI nSiAna = 0;  |ACABA; |FINSI;                    || No existe analitica

   eaCtaAna = #52#29;
   |QBF eaCtaAna; |SI eaCtaAna = ""; |ACABA; |FINSI;   || No hay Cuenta

   |ABRE #22;
   #22#0 = #52#0;
   #22#1 = #52#1;
   #22#2 = #52#2;
   #22#3 = #52#3;
   #22#4 = #52#29;  || Cuenta Analitica
   |LEE 001#22=;
   |SI FSalida ! 0;
       |CIERRA #22;
       |ACABA;
   |FINSI;                                              || No hay lineas
   |CIERRA #22;

   |ABRE #12;
   |DDEFECTO #12;

   aAlfa1 = "|NC";
   nCalC  = #anm00012#aAlfa1#;
   |PARA nNume1 = 0; |SI nNume1 < nCalC; |HACIENDO nNume1 = nNume1 + 1;
         #12nNume1 = #22nNume1;
   |SIGUE;
   #12#0 = #32#0;
   #12#1 = #32#1;
   #12#2 = #32#2;
   #12#3 = #32#3;
   #12#4 = #32#29;
   |SI aMonedaC ! aMonedaA;
       impMoneda = #12#7; |HAZ ElCambioMoneda; #12#7 = impMoneda;
       impMoneda = #12#8; |HAZ ElCambioMoneda; #12#8 = impMoneda;
   |FINSI;
   |SI enTP100 ! 100;
       impMoneda = #12#7; |HAZ ElCambio100; #12#7 = impMoneda;
       impMoneda = #12#8; |HAZ ElCambio100; #12#8 = impMoneda;
   |FINSI;
   |GRABA 040#12n;

   |ABRE #13;
   |BUCLE AnaLineas;
   |CIERRA #13;
   |CIERRA #12;
|FPRC;
