|FICHEROS;
   dsapunte #0;

   caenlace;
   camaasic;
   camaasil;
   casiim01;
   casiim02;
   cacuenta,MANTE;
   camandia;

   camaniva;
   caivalin;
   caerpnif;

   caivaasi;
   caivases;
   calibros;
   caclipro;

   cadeflab;
   cacuebal;

   capaclpr;
   caagrupa;
   caepigra;
   camanefe;

   :/modelos/def/dsmom030;

   calicont;
   anm00001;
   anm00000;
   anm00016;

   canempre;
   caw000a0;
   caw00062;

   dscom001;
   dscom002;

   RegNifs@;
   ca8cumay;
   ca8m0002;

   caivatm4;
   camanads;
   caenlac@;
|FIN;

|INCLUYE dscont_i;
|INCLUYE defec1_i;

|VARIABLES;
   &eaFicRegNif = "";
   &eaTipoPase    = "";
   &eaProcedencia = "";
   &eaEmpProced   = "";
   &enSwMensajes  = 0;
   &enSwConfi     = 0;
   &enBase  = 0;
   &enCuota = 0;
   &PRMNT_enError = 0;
   &PRMNT_enVer = 0;
   &PRMNT_enSwTaller = 0;
   &PRMNT_enSwPCEG   = 0;
   &PRMNT_enLuxeRec = 0;
   &enCuotaREC = 0;
   &eaParam = "";
   &eaNomFich = "";

   &enPosic   = 0;
   &enSwExport = 0;

   || Las dos variables externas siguientes se pusieron para los enlaces
   || especiales del modulo de talleres de DsComer9. Sirven para forzar
   || el escribir el registro de iva y el asiento indistintamente.

   &enGenIva0 = 0;
   &enGenAsi0 = 0;

{500}nError = 0;
{500}aError = "";

   nBasesExentas = 90;
   nHay  = 0;
   aDCta = "";
   aHCta = "";
   aH    = "";

   aC23      = "";
   nSwCliPro = 0;
   nFacturaCero = 0;
   nCalcPosic = 0;
   nNoComp    = 0;
   nContError = 0;
   nTotalErr  = 0;
   nAnalitica = 0;
   nEjer      = 0;
   nBorra     = 0;
   nBorraAnt  = 0;
   nTotalIva  = 0;
   nTotalRec  = 0;
   nContIva   = 0;

   nBases     = 0;
   nIVA       = 0;
   nREC       = 0;
   nFactor    = 0;
   nIncr      = 0;
   nCuadreAsi = 0;

   nEjerc     = 0;
   nTipoIVA   = 0; nTipoREC   = 0;
   nDifIVA    = 0; nDifREC    = 0;
   nDife      = 0;
   nLinea     = 0;
   nLinea1    = 0;
   nNuevo     = 0;
   nLineaApte = 0;
   nSumoCamp9 = 0;
   nOk        = 0;
   nCuenta    = 0;
   fFechaBloq = @;
   fFecha     = @; aHora = "";
   nSwErr     = 0;
   nSwHayCif  = 0;
   aNombreCta = "";
   aNifCta    = "";
   aCodCta    = "";
   nYaTipoF   = 0;

   nSwAutoDG  = 0;
   nSwAutoDE  = 0;
   nSwRecalcIva = 0;
   nDDiario   = 0;
   fDFecha    = @;
   nDDocum    = 0;
   nHDiario   = 0;
   fHFecha    = @;
   nHDocum    = 0;

   fDFechaEmp = @;
   fHFechaEmp = @;

   nAntDia = 0; aAntFec = @; nAntDoc = 0; nTotalDoc = 0;
   aAntSer = ""; nAntFac = 0;
   nAvisos = 0; nCriticos = 0; aMensaje = "";

   nLibro = 0; nDocum = 0; nPrimero = 0;

   aNombreUsr = "";

   aCampo26 = "";
   aDef   = "";
   Path   = "";
   aAlfa  = "";
   aAlfa1 = "";
   aAlfa2 = "";
   aAlfa3 = "";
   aAlfa4 = "";
   aAlfa5 = "";
   aAlfa6 = "";
   Campo1 = 0; Campo2 = 0; Campo3 = 0;
   NumDoc = 0; NumIntr = 0; NumLinea = 0; LineaIva = 0;
   nSwCtrapD = 0; nSwCtrapH = 0; nSw = 0;
   nSwBorrado = 0;

   nEmpresa = 0; nPeriodo = 0;

   Comodin = ""; Comodin1 = ""; ComodNum = 0;
   Segundos = 0; SegundosEnl = 0; Cambiante = 0; Contador = 0;

   Libro = 0; Serie = ""; Fact = 0; NuevoNumero = 0; EmpAnt = 0; PerAnt = 0;

   Calc = 0; Calc1 = 0; Calc2 = 0;
   nLong = 0; aLong = "";
   SwNivel = 0;   Nivel = 0;      MaxNiv = 0;
   TotalBase = 0; TotalIva = 0;   TotalRec = 0;
   TotalIRPF = 0; TotalDesc = 0;  TBaseIRPF = 0;
   TotalFactura = 0;
   LibContra = 0; SerContra = ""; FacContra = 0;
   LibroAnt  = 0; SerieAnt  = "";
   LibAnt    = 0; SerAnt    = ""; NumAnt    = 0;
   nCptoAnt  = 0; aCptoAnt  = "";

   Departam  = ""; ConcepIva = 0; DescriIva = "";

   CmpDebe  = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe  = 0; TotHaber = 0; TotSaldo = 0;

   Cuenta  = ""; Cuenta1 = ""; nImporte = 0;
   aNombre = ""; ErrorDoc = 0; Respuesta = "";
   Cont = 0; nCont = 0; nCont1 = 0; nCont2 = 0; nCont3 = 0;

   nDiario = 0; fFecAsto = @; nAsto = 0;
   EnDiario = 0; EnFecha = @; EnAsto = 0; nDOCUMENTO1 = 0;
   Dig1 = 0; Dig2 = 0; Dig3 = 0; Dig4 = 0; Dig5 = 0; Dig6 = 0;
   nHandle  = 0;

   FechaEnl   = @; FechaHoy = @;
   HoraEnl    = 0; Hora     = 0;
   MinutosEnl = 0; Minutos  = 0;

   nCalc = 0; nCalc1 = 0; nCalc2 = 0;
   nNumChar = 0;

   nComp1 = 0; fComp2 = @; nComp3 = 0; nComp4 = 0; nComp5 = 0;
   nMiraApunte = 0;

   &enNoModif = 0; ||variable aplicacion Rent Car para no modificar Apunte
   &enNoCalcu = 0; ||variable aplicacion Rent Car para no calcular IVA
   &enCambioCtaIVA = 0;
   nImpor1 = 0;
   nCuotIva = 0;
   nSwFuera = 0;

   aFichero    = "";
   aDsCorreoIP = "";
   aDirOrigen  = "";
   aDirDestino = "";
   aServidor   = "";
   aAsunto     = "";
   aTexto      = "";
   nNume1      = 0;
   &raf_oper   = 0;
   &raf_desde  = 0;
   nSwVarios   = 0;
   aCtaVarios  = "";
   aCtaRVarios = "";

   aCtaMil   = "";
   aCtaRMil  = "";
   nTpIVAMil = 0;
   nTpRecMil = 0;
   nGrupoIVA = 0;
   aDeducible= "";
   &eSwPlusGes = 0;
   nSwIntra = 0;

   &enNoEndatos = 0;
   &enCaenlace  = 0;
   &eSwFicNif   = 0;
   nHago = 0;
|FIN;

|PROCESO Encripta;
   |QBF aAlfa4; aAlfa6 = "";
   aAlfa5 = aAlfa4 % 0; nNumChar = aAlfa5;
   |PARA nCont3 = 1; |SI nCont3 [ nNumChar; |HACIENDO nCont3 = nCont3 + 1;
      nCalc1 = (nCont3 * 100) + 1; aAlfa5 = aAlfa4 % nCalc1;
      nCalc1 = &aAlfa5;
      |SI nCalc1 > 79;
         nCalc1 = 79 - (nCalc1 - 79);
      |SINO;
         nCalc1 = 79 + (79 - nCalc1);
      |FINSI;
      aAlfa6 = aAlfa6 + &nCalc1;
   |SIGUE;
   aAlfa4 = aAlfa6;
|FPRC;

|PROCESO MiraTipos;
   efFechaIVA = #camaniva#4;
   aTipoIVA   = #camaniva#36;
   enLineaIVA = 0;
   enPorcIVA  = #caivalin#7;
   enPorcREC  = #caivalin#9;
||   eaCtaIVA  = "";   eaCtaREC  = "";   eaCtaDTO = "";
   eaCtaIVA  = #caivalin#13;
   eaCtaREC  = #caivalin#14;
   eaCtaDTO  = #caivalin#15;

   |HAZ BuscaTipoIVA;
   #caivalin#7  = enPorcIVA;
   #caivalin#9  = enPorcREC;
   #caivalin#13 = eaCtaIVA;
   #caivalin#14 = eaCtaREC;
   #caivalin#15 = eaCtaDTO;
   #caivalin#16 = enLineaIVA;

   |SI #caivalin#5 = "N"; |Y #camaniva#36 = "S";
       |SI #caivaasi#82 = doce;
           |SI #caivalin#8  ! 0; #caivalin#13 = #caivalin#12; |FINSI;
           |SI #caivalin#10 ! 0; #caivalin#14 = #caivalin#12; |FINSI;
       |SINO;
           |SI #caivalin#8  ! 0; #caivalin#13 = #caivaasi#82; |FINSI;
           |SI #caivalin#10 ! 0; #caivalin#14 = #caivaasi#82; |FINSI;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO CalcIVA;
     #caivalin#7  = ((#caivalin#8  * 100) / #caivalin#6) ! 0;

     nCalc      = ((#caivalin#8  * 100) / #caivalin#6) ! 1;
     enLineaIVA = 0;
     aTipoIVA   = #camaniva#36;
     aAlfa      = #caenlace#1; |QBF aAlfa;
     aAlfa      = aAlfa % -104;
     efFechaIVA = #camaniva#4;
     enPorcIVA  = nCalc;
     enPorcREC  = #caivalin#9;
     eaCtaIVA   = #caivalin#13;
     eaCtaREC   = #caivalin#14;
     eaCtaDTO   = #caivalin#15;
     enCuotaIVA = #caivalin#8;
     enCuotaREC = #caivalin#10;
     |HAZ BuscaTipoIVA;

     |SI enLineaIVA ! 0;
         #caivalin#7  = nCalc;
     |FINSI;
|FPRC;

|PROCESO casiim02;
     |BORRA 020#casiim02.a;
     |LIBERA #casiim02;
|FPRC;

|DEFBUCLE casiim02;
     #casiim02#1;
     ;
     #casiim01#0, #casiim01#1, #casiim01#2, "";
     #casiim01#0, #casiim01#1, #casiim01#2, aH;
     be;
     NULL, casiim02;
|FIN;

|PROCESO BorraSII;
     |ABRE #casiim01;
     #casiim01#0 = "camaniva";
     #casiim01#1 = #camaniva#0;
     #casiim01#2 = #camaniva#1;
     |LEE 101#casiim01.=;
     |SI FSalida = 0;
         aH = "z" * 60;
         |BUCLE casiim02;

         |BORRA 020#casiim01.a;
         |LIBERA #casiim01;
     |FINSI;
     |CIERRA #casiim01;
|FPRC;

|PROCESO LineasIva;
   |SI #caivalin#13 = "            "; |Y nSwVarios = 1;
       #caivalin#13 = aCtaVarios;
   |FINSI;

   |SI #caivalin#14 = "            "; |Y nSwVarios = 1;
       #caivalin#14 = aCtaRVarios;
   |FINSI;

   |SI enNoCalcu = 0;
      TotalBase = TotalBase + #caivalin#6;

      |SI enCaenlace ! 0;
          |SI #caivalin#8  = 0; #caivalin#7 = 0; |FINSI;
          |SI #caivalin#10 = 0; #caivalin#9 = 0; |FINSI;
      |FINSI;

      |SI #caivalin#7 = -1;
          |SI #caivalin#8 ! 0; |Y #caivalin#6 ! 0;
              |HAZ CalcIVA;
          |FINSI;
      |SINO;
          |SI #caivalin#7 ! 0;
             || ABDON 19/06/2008  Tiquet 002743/01945
             || He tenido que restringir el arreglo a Tagloma, ya que esta condicion la usa para
             ||   en caso que haya varios tipos de iva que lo reparta correctamente. Habra que ver
             ||   en caso de Tagloma que se hace.
             |DBASS aAlfa; |QBF aAlfa;
             aAlfa = aAlfa + "dscomer9/def/tagm0001.mas";
             |XABRE "E", aAlfa, 0;
             |SI FSalida = 0;
                |SI FSalida = 0; |Y #caivalin#8 = 0;  ||  ABDON 26/05/2008  Tiquet 002359/00479
                   #caivalin#8 = #caivalin#6 % #caivalin#7;
                |FINSI;
             |SINO;
                #caivalin#8 = #caivalin#6 % #caivalin#7;
             |FINSI;
          |SINO;
             |SI #caivalin#2 = 99;
                #caivalin#8 = #caivalin#6 % #caivalin#7;
             |SINO;
                nCalc = ((#caivalin#8  * 100) / #caivalin#6) ! 0;
                |SI #caivalin#7 ! nCalc; #caivalin#7 = nCalc; |FINSI;
             |FINSI;
          |FINSI;
      |FINSI;

      |SI #caivalin#8 = 0; |Y #caivalin#7 ! -1;
          #caivalin#8 = #caivalin#6 % #caivalin#7;
      |FINSI;

      |SI #caivalin#9 = -1;
         |SI #caivalin#10 ! 0; |Y #caivalin#6 ! 0;
            nCalc = ((#caivalin#10  * 100) / #caivalin#6) ! 2;
            |SI nCalc ! #caivalin#9; #caivalin#9 = nCalc; |FINSI;
            aTipoIVA = #camaniva#36; efFechaIVA = #camaniva#4;
            enBase = #caivalin#6; enCuota = #caivalin#10;
            enPorcREC = #caivalin#9; |HAZ CompruebaRecargos;
            #caivalin#9 = enPorcREC;
         |FINSI;
      |SINO;
         |SI #caivalin#9 ! 0;
            #caivalin#10 = #caivalin#6 % #caivalin#9;
         |SINO;
            || ABDON   27/02/2013  Tiquet 000035/00921
            || nCalc = ((#caivalin#10 * 100) / #caivalin#6) ! 0;
            nCalc = ((#caivalin#10 * 100) / #caivalin#6) ! 1;
            |SI #caivalin#9 ! nCalc; #caivalin#9 = nCalc; |FINSI;
         |FINSI;
      |FINSI;
      TotalIva  = TotalIva  + #caivalin#8;
      TotalRec  = TotalRec  + #caivalin#10;

      |HAZ TomaTipoIva;
      nCalc = (#caivalin#22 * 100) / #caivalin#20;
      || El porcentaje no puede ser negativo. Cambio el signo de la base
      |SI nCalc < 0;
         #caivalin#20 = -#caivalin#20;
         |GRABA 020#caivalin.a;
      |FINSI;

      TotalDesc = TotalDesc + #caivalin#11;
      TBaseIRPF = TBaseIRPF + #caivalin#20;
      TotalIRPF = TotalIRPF + #caivalin#22;
      #caivalin#21 = (#caivalin#22 * 100) / #caivalin#20;
   |SINO;
      TotalBase = TotalBase + #caivalin#6;
      TotalIva  = TotalIva  + #caivalin#8;
      TotalRec  = TotalRec  + #caivalin#10;
      |HAZ TomaTipoIva;
      TotalDesc = TotalDesc + #caivalin#11;
      TBaseIRPF = TBaseIRPF + #caivalin#20;
      TotalIRPF = TotalIRPF + #caivalin#22;
   |FINSI;

   |HAZ MiraTipos;

   |GRABA 020#caivalin.a;
|FPRC;

|DEFBUCLE LineasIva;
   #caivalin#1;
   ;
   #camaniva#0,#camaniva#1,001;
   #camaniva#0,#camaniva#1,999;
   be;
   NULL,LineasIva;
|FIN;

|PROCESO RecalculaIva;
   |SI enSwMensajes = 0;
      nCalcPosic = (enPosic * 100) + 7;
      |ATRI I; |PINTA nCalcPosic, "Recalculando campos de iva       "; |ATRI N;
   |FINSI;
   TotalBase = 0; TotalIva = 0;  TotalRec = 0;
   TotalIRPF = 0; TotalDesc = 0; TBaseIRPF = 0;

   |BUCLE LineasIva;

   |HAZ BorroCtaIVA;
|FPRC;

|PROCESO RepliLinIva;
   |SALVA_FICHA #caivalin;
   NumLinea = #caivalin#2;
   #caivalin#0 = #caenlace#34;
   #caivalin#1 = NumIntr;
   #caivalin#2 = NumLinea;
   |LEE 000#caivalin.=;
   |SI FSalida = 0;
      |BORRA 020#caivalin.a;
   |FINSI;
   |REPON_FICHA #caivalin; |SALVA_FICHA #caivalin;
   #caivalin#0 = #caenlace#34;
   #caivalin#1 = NumIntr;
   #caivalin#2 = NumLinea;
   |GRABA 020#caivalin.n;
   |REPON_FICHA #caivalin;
|FPRC;

|DEFBUCLE RepliLinIva;
   #caivalin#1;
   ;
   #caenlace#11,NumDoc,001;
   #caenlace#11,NumDoc,999;
   be;
   NULL,RepliLinIva;
|FIN;

|PROCESO TomaTipoIva;
   aTipoIVA = #camaniva#36;
   aAlfa = #caenlace#1; |QBF aAlfa; aAlfa = aAlfa % -104;
   efFechaIVA = #camaniva#4;  enLineaIVA = 0;
   enPorcIVA  = #caivalin#7;  enPorcREC = #caivalin#9;
   eaCtaIVA   = #caivalin#13; eaCtaREC  = #caivalin#14;
   eaCtaDTO   = #caivalin#15;
   enCuotaIVA = #caivalin#8;  enCuotaREC = #caivalin#10;
   |HAZ BuscaTipoIVA;
   #caivalin#16 = enLineaIVA;
   #caivalin#13 = eaCtaIVA;
   #caivalin#14 = eaCtaREC;
   #caivalin#15 = eaCtaDTO;
   |SI #caivalin#7 ! enPorcIVA; #caivalin#7 = enPorcIVA; |FINSI;
   |SI #caivalin#9 ! enPorcREC; #caivalin#9 = enPorcREC; |FINSI;
|FPRC;

|PROCESO RevisaLineas;
   |SI #caivalin#7 = -1;
      #caivalin#7 = (100 * #caivalin#8) / #caivalin#6;
      |SI #caivalin#7 ] 14; |Y #caivalin#7 [ 18; #caivalin#7 = 16; |FINSI;
      |SI #caivalin#7 ] 6;  |Y #caivalin#7 [ 9;  #caivalin#7 = 7;  |FINSI;
      |SI #caivalin#7 ] 2;  |Y #caivalin#7 [ 5;  #caivalin#7 = 4;  |FINSI;
      |SI #caivalin#7 < 1;  #caivalin#7 = 0;  |FINSI;
      |HAZ TomaTipoIva;
      |GRABA 020#caivalin.a;
   |FINSI;
   |SI #caivalin#9 = -1;
      #caivalin#9 = (100 * #caivalin#10) / #caivalin#6;
      |SI #caivalin#9 ] 3;   |Y #caivalin#9 [ 5;   #caivalin#9 = 4;   |FINSI;
      |SI #caivalin#9 ] 0.8; |Y #caivalin#9 [ 2;   #caivalin#9 = 1;   |FINSI;
      |SI #caivalin#9 ] 0.2; |Y #caivalin#9 [ 0.7; #caivalin#9 = 0.5; |FINSI;
      |SI #caivalin#9 < 0.2; #caivalin#9 = 0; |FINSI;
      |HAZ TomaTipoIva;
      |GRABA 020#caivalin.a;
   |FINSI;
   |LIBERA #caivalin;
|FPRC;

|DEFBUCLE RevisaLineas;
   #caivalin#1;
   ;
   #camaniva#0,#camaniva#1,001;
   #camaniva#0,#camaniva#1,999;
   be;
   NULL,RevisaLineas;
|FIN;

|PROCESO RevisaIva;
   |SI nSw = 1;
      nIVA = (nIVA + #caivalin#8) ! 2;
      nREC = (nREC + #caivalin#10) ! 2;
      nBases = nBases + 1;
   |FINSI;
   |SI nSw = 2; |O nSw = 3;
      nIncr = nIncr + nFactor;
      |SI nSw = 2; #caivalin#8  = #caivalin#8  + nIncr; |FINSI;
      |SI nSw = 3; #caivalin#10 = #caivalin#10 + nIncr; |FINSI;
      |GRABA 020#caivalin.a;
      |SI nIncr > 0.01; nIncr = 0; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaIva;
   #caivalin#1;
   ;
   nLibro,nContIva,001;
   nLibro,nContIva,999;
   be;
   NULL,RevisaIva;
|FIN;

|PROCESO RevisaAnt;

   || Este proceso le da un vistazo posterior a la ultima factura escrita,
   ||    para que no deje ningun dato en el aire
   #camaniva#0 = nLibro;
   #camaniva#1 = nDocum;
   |LEE 101#camaniva.=;
   |SI FSalida = 0;
      TotalFactura = #camaniva#21;
      TotalBase = 0; TotalIva = 0;  TotalRec = 0;
      TotalIRPF = 0; TotalDesc = 0; TBaseIRPF = 0;
      |BUCLE LineasIva;
      |BUCLE RevisaLineas;
      |GRABA 020#camaniva.a;
      |LIBERA #camaniva;
   |FINSI;
   |HAZ BorroCtaIVA;
|FPRC;

|PROCESO BorroCtaIVA;
   nSwVarios   = 0;
   aCtaVarios  = "";
   aCtaRVarios = "";
   aCtaMil     = "";
   aCtaRMil    = "";
   nTpIVAMil   = 0;
   nTpRecMil   = 0;
   nGrupoIVA   = -1;
   aDeducible  = "";
|FPRC;

|PROCESO NuevaCtaIVA;
   efFechaIVA = #caenlace#29;
   aTipoIVA   = #caenlace#10;
   enLineaIVA = #caclipro#42;
   |HAZ SacaIVA;
   |SI enLineaIVA ! 0;
       nTpIVAMil = enPorcIVA;
       nTpRecMil = enPorcREC;
       aCtaMil   = eaCtaIVA;
       aCtaRMil  = eaCtaREC;
       nGrupoIVA = enLineaIVA;
   |FINSI;
|FPRC;

|PROCESO GrabaCAERPNIF;
     |ABRE #caerpnif;
     #caerpnif#0 = #camaniva#0;
     #caerpnif#1 = #camaniva#1;
     |LEE 000#caerpnif.=;
     |SI FSalida = 0;
         |CIERRA #caerpnif;
         |ACABA;
     |FINSI;

     |DDEFECTO #caerpnif;
     #caerpnif#0 = #camaniva#0;
     #caerpnif#1 = #camaniva#1;
     #caerpnif#2 = #camaniva#14;
     #caerpnif#3 = #camaniva#13;
     #caerpnif#4 = #caenlace#53;

     #caerpnif#5 = "";

     |SI #caerpnif#4 = "1";
         #caerpnif#5 = "NIF";
     |FINSI;

     |SI #caerpnif#4 = "2";
         #caerpnif#5 = "NIF/IVA (NIF operador intracomunitario)";
     |FINSI;

     |SI #caerpnif#4 = "3";
         #caerpnif#5 = "Pasaporte";
     |FINSI;

     |SI #caerpnif#4 = "4";
         #caerpnif#5 = "Documento Oficial de identificacion expedido por el pais o territorio de residencia";
     |FINSI;

     |SI #caerpnif#4 = "5";
         #caerpnif#5 = "Certificado de residencia fiscal";
     |FINSI;

     |SI #caerpnif#4 = "6";
         #caerpnif#5 = "Otro documento probatorio";
     |FINSI;

     |GRABA 020#caerpnif.n;
     |LIBERA #caerpnif;

     |CIERRA #caerpnif;
|FPRC;

|PROCESO AltaenNif;
     |DBASS aAlfa; |QBF aAlfa;
     |SI HayAcceso = 1;
         aDef=  aAlfa + "integral/def/dsam0103.mas";
     |SINO;
         aDef = aAlfa + "basica/def/agim0003.mas";
     |FINSI;
     |XABRE "E", aDef, nHandle;
     |SI FSalida = 0;
         |CARGA_DEF aDef, RegNifs@;
         |SI FSalida = 0;
             |ABRE #RegNifs@;
             #RegNifs@#0 = #capaclpr#0;
             |LEE 000#RegNifs@.=;
             |SI FSalida ! 0;
                 |DDEFECTO #RegNifs@;
                 #RegNifs@#0 = #capaclpr#0;
                 #RegNifs@#1 = #capaclpr#1;
                 #RegNifs@#2 = #capaclpr#2;
                 #RegNifs@#4 = #capaclpr#3;
                 #RegNifs@#5 = #capaclpr#4;
                 #RegNifs@#6 = #capaclpr#5;
                 #RegNifs@#7 = #capaclpr#6;
                 #RegNifs@#8 = #capaclpr#7;
                 |GRABA 020#RegNifs@.n;
              |FINSI;
              |CIERRA #RegNifs@;
              |DESCARGA_DEF #RegNifs@;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO AltaCliProCta;

     |DFICB Path; |QBF Path;
     |SI eaFicRegNif = "";
         Path = Path + (("00000" + cod1) % -105) + cod2 + "/";
     |SINO;
         Path = eaFicRegNif;
     |FINSI;

     |DDEFECTO #capaclpr;
     aAlfa = Path + "p1" + Usuario + ".dat";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida ] 0;
         |PATH_DAT #capaclpr#Path#;
         aAlfa = "p1" + Usuario;
         |NOME_DAT #capaclpr#aAlfa#;

         |ABRE #capaclpr;
         #capaclpr#9 = #caenlace#4;
         |LEE 141#capaclpr.=;
         |SI FSalida = 0;
             #caclipro#1 = #capaclpr#1;
             #caclipro#2 = #capaclpr#2;
             #caclipro#3 = #capaclpr#3;
             #caclipro#4 = #capaclpr#4;
             #caclipro#5 = #capaclpr#6;
             #caclipro#6 = #capaclpr#5;
             #caclipro#7 = #capaclpr#7;
             #caclipro#8 = #capaclpr#8;
             #caclipro#9 = #capaclpr#0;

             #caclipro#29 = #capaclpr#10;
             #caclipro#30 = #capaclpr#11;
             #caclipro#31 = #capaclpr#12;
             #caclipro#32 = #capaclpr#13;
             #caclipro#38 = #capaclpr#14;
             #caclipro#39 = #capaclpr#15;
             #caclipro#40 = #capaclpr#16;
             #caclipro#41 = #capaclpr#17;

             |HAZ AltaenNif;
             |BORRA 020#capaclpr.a;
             |LIBERA #capaclpr;
         |FINSI;
         |CIERRA #capaclpr;
     |SINO;
         |SI enCaenlace = 0; |ACABA; |FINSI;
     |FINSI;

     #cacuenta#0 = #caenlace#4;
     #cacuenta#1 = Nivel;
     |LEE 141#cacuenta.=;
     |SI FSalida ! 0;
         Cuenta = #caenlace#4; |QBF Cuenta;
         |ABRE #cacuebal;
         |DDEFECTO #cacuenta;
         |PARA nCont = 6; |SI nCont ] 1; |HACIENDO nCont = nCont - 1;
               Calc = 13 + nCont;
               |SI #canempre#Calc# ! 0;
                    Calc = 100 + #canempre#Calc#;
                    Comodin = Cuenta % Calc;
                    #cacuenta#0 = Comodin;
                    #cacuenta#1 = nCont;
                    |LEE 000#cacuenta.=;
                    |SI FSalida = 0;
                        #cacuebal#0 = Comodin
                        |LEE 000#cacuebal.=;
                        |SI FSalida = 0;
                            #cacuenta#4 = #cacuebal#1;
                            #cacuenta#5 = #cacuebal#2;
                            #cacuenta#6 = #cacuebal#3;
                            #cacuenta#7 = #cacuebal#4;
                            #cacuenta#8 = #cacuebal#5;
                            |SAL;
                        |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |CIERRA #cacuebal;

          |PDEFECTO #cacuenta, 9, 54;
          #cacuenta#0 = Cuenta;
          #cacuenta#1 = Nivel;
          aAlfa = #caenlace#43; |QBF aAlfa;
          |SI aAlfa ! "";
              #cacuenta#2 = #caenlace#43;
          |SINO;
             |SI #camaasil#19 = "F";  #cacuenta#2 = #capaclpr#1; |FINSI;
          |FINSI;
          #cacuenta#3 = "S";
          |GRABA 020#cacuenta.c;
     |FINSI;
|FPRC;

|PROCESO LaFicha;
      aAlfa2 = #caenlace#4 % 102;
      aC23   = "";
      |SI aAlfa2 = "43"; |O aAlfa2 = "44"; aC23 = "C"; |FINSI;
      |SI aAlfa2 = "40"; |O aAlfa2 = "41"; aC23 = "P"; |FINSI;
      |SI aC23 ! "";
          |ABRE #caclipro;
          #caclipro#23 = aC23;
          #caclipro#10 = #caenlace#4;
          #caclipro#11 = #caenlace#5;
          |LEE 000#caclipro.=;
          |SI FSalida ! 0;
              |DDEFECTO #caclipro;
              #caclipro#23 = aC23;
              #caclipro#10 = #caenlace#4;
              #caclipro#11 = #caenlace#5;
              |GRABA 020#caclipro.b;
              eSwFicNif = 1;
              #caclipro#1 = aNombreCta;
              #caclipro#9 = aNifCta;
              |HAZ AltaCliProCta;
              |GRABA 020#caclipro.a;
              |LIBERA #caclipro;
              eSwFicNif = 1;
         |FINSI;
      |FINSI;
      |CIERRA #caclipro;
|FPRC;

|PROCESO NuevaFactura;
      |SI nLibro ! 0; |O nDocum ! 0; |HAZ RevisaAnt; |FINSI;

      |SI #caenlace#10 = "R"; |O #caenlace#10 = "S";
          |SELECT #3#camaniva;
          #camaniva#0 = #caenlace#11;
          #camaniva#2 = #caenlace#12;
          #camaniva#3 = #caenlace#13;
          |LEE 000#camaniva.=;
          |SI FSalida = 0;
              NumDoc = #camaniva#1;
          |SINO;
              NumDoc = -1;
          |FINSI;
          |SELECT #1#camaniva;
          |SI NumDoc < 0;
              #camaniva#0 = #caenlace#11;
              #camaniva#1 = 9999999999;
              |LEE 000#camaniva.];
              |SI FSalida = 0;
                  |LEE 040#camaniva.a;
              |SINO;
                  |LEE 040#camaniva.u;
              |FINSI;
              NumDoc = 1;
              |SI FSalida = 0; |Y #camaniva#0 = #caenlace#11;
                  NumDoc = #camaniva#1 + 1;
              |FINSI;

              |DDEFECTO #camaniva;
              nLibro = #caenlace#11; nDocum = NumDoc;
              #camaniva#0 = #caenlace#11;
              #camaniva#1 = NumDoc;
              #camaniva#2 = #caenlace#12;
              #camaniva#3 = #caenlace#13;
              |GRABA 020#camaniva.n;
           |FINSI;
           NuevoNumero = NumDoc;
      |FINSI;
|FPRC;

|PROCESO CreaRegistro;
   |ABRE #caivaasi;
   |LEE 000#caivaasi.p;
   |CIERRA #caivaasi;

   eaPaCTA1 = #caivaasi#135;  ||permitir alta no estructuras 2008
   eaPaCTA2 = #caivaasi#136;  ||Aviso 1990
   eaPaNif1 = #caivaasi#152;
   eaPaNif2 = #caivaasi#153;
   eaObClPr = #caivaasi#186;

   nSwRecalcIva = 1;

   |SI #caenlace#0 [ nDDiario; nDDiario = #caenlace#0; |FINSI;
   |SI #caenlace#0 ] nHDiario; nHDiario = #caenlace#0; |FINSI;
   |SI #caenlace#1 [ fDFecha;  fDFecha  = #caenlace#1; |FINSI;
   |SI #caenlace#1 ] fHFecha;  fHFecha  = #caenlace#1; |FINSI;
   |SI #caenlace#2 [ nDDocum;  nDDocum  = #caenlace#2; |FINSI;
   |SI #caenlace#2 ] nHDocum;  nHDocum  = #caenlace#2; |FINSI;

   aAlfa = #caenlace#1; |QBF aAlfa; aAlfa = aAlfa % -104;
   nCalc = aAlfa;

   |SI #caenlace#10 ! "R"; |Y #caenlace#10 ! "S";
       || ... No es una Factura
       |SI nSwCliPro ! 0;
           |HAZ LaFicha;
       |FINSI;
   |FINSI;

   |SI #caenlace#26 = "F"; |O #caenlace#26 = "f";  || Total Factura
       TotalFactura = 0;
       |SI NuevoNumero = 0;
           |SI nLibro ! 0; |O nDocum ! 0; |HAZ RevisaAnt; |FINSI;
       |FINSI;

      |SI #caenlace#26 = "F";
          TotalFactura = TotalFactura + #caenlace#9;
      |SINO;
          TotalFactura = TotalFactura - #caenlace#9;
      |FINSI;
      nContIva      = #camaniva#1;

      eSwNoalta = 1;
      enActividad = #camaniva#10;
      eaCodDep    = #camaniva#10;
      |SI #canempre#24 = "S"; |HAZ Actividad; |FINSI;

      |SI #caivaasi#44 = "S";
         |DFICB aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + (("00000" + #caenlace#37) % -105) + #caenlace#38 + "/"; |PATH_DAT #caivases#aAlfa#;
         |ABRE #caivases;
         #caivases#0 = #caenlace#12;
         #caivases#1 = #caenlace#10;
         |LEE 101#caivases.=;
         |SI FSalida = 0;
            |SI #caenlace#13 < 0;
               #caenlace#13 = #caivases#3;
               #caivases#3  = #caivases#3 + #caivases#4;
            |SINO;
               |SI #caivases#3 < #caenlace#13;
                  #caivases#3 = #caenlace#13 + #caivases#4;
               |FINSI;
            |FINSI;
            |GRABA 020#caivases.a; |LIBERA #caivases;
         |SINO;
            |DDEFECTO #caivases;
            #caivases#0 = #caenlace#12;
            #caivases#1 = #caenlace#10;
            |SI #caenlace#13 < 0;
               #caenlace#13 = 1; #caivases#3 = 2;
            |SINO;
               #caivases#3 = #caenlace#13 + #caivases#4;
            |FINSI;
            |GRABA 020#caivases.n; |LIBERA #caivases;
         |FINSI;
         |CIERRA #caivases;
      |SINO;
         |DFICB aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + (("00000" + #caenlace#37) % -105) + #caenlace#38 + "/"; |PATH_DAT #calibros#aAlfa#;
         |ABRE #calibros;
         #calibros#0 = #caenlace#11;
         |LEE 101#calibros.=;
         |SI FSalida = 0;
            |SI #caenlace#13 < 0;
               #caenlace#13 = #calibros#4;
               #calibros#4 = #calibros#4 + #calibros#3;
            |SINO;
               |SI #calibros#4 < #caenlace#13;
                  #calibros#4 = #caenlace#13 + #calibros#3;
               |FINSI;
            |FINSI;
            |GRABA 020#calibros.a; |LIBERA #calibros;
         |SINO;
            |DDEFECTO #calibros;
            #calibros#0 = #caenlace#11;
            #calibros#1 = "LIBRO " + (("00" + #caenlace#11) % -102) + " REPERCUTIDO";
            #calibros#2 = #caenlace#10;
            #calibros#3 = #caenlace#13 + 1;
            |SI #caenlace#13 < 0;
               #caenlace#13 = 1; #calibros#4 = 2;
            |SINO;
               #calibros#4 = #caenlace#13 + #calibros#3;
            |FINSI;
            |GRABA 020#calibros.n;
         |FINSI;
         |CIERRA #calibros;
      |FINSI;

      |SELECT #3#camaniva;
      #camaniva#0 = #caenlace#11;
      #camaniva#2 = #caenlace#12;
      #camaniva#3 = #caenlace#13;
      |LEE 000#camaniva.=;
      |SI FSalida = 0;
         NumDoc = #camaniva#1;
      |SINO;
         NumDoc = -1;
      |FINSI;
      |SELECT #1#camaniva;
      |SI NumDoc < 0;

         #camaniva#0 = #caenlace#11;
         #camaniva#1 = 9999999999;
         |LEE 000#camaniva.];
         |SI FSalida = 0;
             |LEE 040#camaniva.a;
         |SINO;
             |LEE 040#camaniva.u;
         |FINSI;
         NumDoc = 1;
         |SI FSalida = 0; |Y #camaniva#0 = #caenlace#11;
             NumDoc = #camaniva#1 + 1;
         |FINSI;

         |DDEFECTO #camaniva;
         nLibro = #caenlace#11; nDocum = NumDoc;

         #camaniva#0 = #caenlace#11;
         #camaniva#1 = NumDoc;
         #camaniva#2 = #caenlace#12;
         #camaniva#3 = #caenlace#13;
         |GRABA 020#camaniva.b;
      |SINO;
         #camaniva#0 = #caenlace#11;
         #camaniva#1 = NumDoc;
         |LEE 101#camaniva.=;
      |FINSI;

      #camaniva#4  = #caenlace#29;
      #camaniva#7  = #caenlace#0;
      #camaniva#8  = #caenlace#1;
      #camaniva#9  = #caenlace#2;
      #camaniva#12 = #caenlace#4;
      #camaniva#27 = #caenlace#6;
      #camaniva#28 = #caenlace#7;
      #camaniva#29 = #caenlace#6;
      #camaniva#30 = #caenlace#7;
      #camaniva#41 = #caenlace#51;
      #camaniva#42 = #caenlace#48;

      |QBF eaNombreAct;
      |SI eaNombreAct = "";
          eaNombreAct = eaDfDepN;
      |FINSI;

      Comodin = #camaniva#4;
      |SI #caivaasi#168 = "A"; Comodin = #camaniva#8; |FINSI;
      Comodin = Comodin % 0402; Calc = Comodin;
      #camaniva#5 = Calc;
      |SI enEjercicio [ 2009;
          |SI #caivaasi#46 = "T";
              |SI Calc ] 1;  |Y Calc [ 3;  #camaniva#5 = 1; |FINSI;
              |SI Calc ] 4;  |Y Calc [ 6;  #camaniva#5 = 2; |FINSI;
              |SI Calc ] 7;  |Y Calc [ 9;  #camaniva#5 = 3; |FINSI;
              |SI Calc ] 10; |Y Calc [ 12; #camaniva#5 = 4; |FINSI;
          |SINO;
               #camaniva#5 = Calc;
          |FINSI;
      |FINSI;
      aAlfa1 = #caenlace#15; |QBF aAlfa1;
      |SI aAlfa1 = "";
          #camaniva#10 = eaDfDepC;                             || Departamento
      |SINO;
          #camaniva#10 = #caenlace#15;                         || Departamento
      |FINSI;
      aAlfa1 = #caenlace#50; |QBF aAlfa1;
      |SI aAlfa1 = "";
          #camaniva#11 = eaDfSubC;                             || SubDepartamento
      |SINO;
          #camaniva#11 = #caenlace#50;                         || SubDepartamento
      |FINSI;
      #camaniva#22 = #caenlace#45;                         || Referencia
      #camaniva#24 = eaNombreAct;                          || Nombre Actividad
      #camaniva#25 = eaDfSubN;                             || Nombre SubDepartamento
      #camaniva#31 = eaDesgIVA;                            || Desglose IVA
      #camaniva#32 = "S";                                  || Desglose Bases
      #camaniva#33 = "S";                                  || Desglose IRPF
      #camaniva#34 = eaDesgDTO;                            || Desglose Descuento
      #camaniva#35 = "N";

      aAlfa  = #caenlace#43; |QBF aAlfa;
      aAlfa1 = #caenlace#44; |QBF aAlfa1;

      |ABRE #caclipro;
      |SI #caenlace#10 = "R"; #caclipro#23 = "C"; |FINSI;
      |SI #caenlace#10 = "S"; #caclipro#23 = "P"; |FINSI;
      #caclipro#10 = #caenlace#4;
      #caclipro#11 = #caenlace#5;
      |LEE 141#caclipro.=;
      |SI FSalida = 0;

         |SI aAlfa = ""; |Y aAlfa1 = "";
             aAlfa  = #caclipro#1;  #caenlace#43 = aAlfa;
             aAlfa1 = #caclipro#9;  #caenlace#44 = aAlfa1;
         |SINO;
             aAlfa2 = #caclipro#1; |QBF aAlfa2;
             aAlfa3 = #caclipro#9; |QBF aAlfa3;
             |SI aAlfa2 = ""; |O aAlfa3 = "";
                 |SI aAlfa2 = ""; #caclipro#1 = aAlfa;  |FINSI;
                 |SI aAlfa3 = ""; #caclipro#9 = aAlfa1; |FINSI;
                 |GRABA 020#caclipro.a;
             |FINSI;
         |FINSI;

      |SINO;

         |SI #caenlace#10 = "R"; |O #caenlace#10 = "S";

             |SI #caenlace#10 = "R"; #caclipro#23 = "C"; |FINSI;
             |SI #caenlace#10 = "S"; #caclipro#23 = "P"; |FINSI;
             #caclipro#10 = #caenlace#4;
             #caclipro#11 = #caenlace#5;
             |GRABA 020#caclipro.b;
             eSwFicNif = 1;
             #caclipro#1 = aNombreCta;
             #caclipro#9 = aNifCta;
             |HAZ AltaCliProCta;
             |GRABA 020#caclipro.a;
             |LIBERA #caclipro;
             eSwFicNif = 1;

             aAlfa  = #caclipro#1;  #caenlace#43 = aAlfa;
             aAlfa1 = #caclipro#9;  #caenlace#44 = aAlfa1;
         |FINSI;
      |FINSI;
      |LIBERA #caclipro;
      |CIERRA #caclipro;

|| aqui 18.04.2017
      aCtaMil    = "";
      aCtaRMil   = "";
      nTpIVAMil  = 0;
      nTpRecMil  = 0;
      nGrupoIVA  = -1;
      aDeducible = "S";
      |SI #caivaasi#21 ! "S";  aDeducible = "N"; |FINSI;
      |SI enCambioCtaIVA = 1; |Y #caclipro#42 ! 0;
          |HAZ NuevaCtaIVA;
      |FINSI;

      aAlfa  = #caenlace#43; |QBF aAlfa;
      aAlfa1 = #caenlace#44; |QBF aAlfa1;

      #camaniva#13 = aAlfa;
      #camaniva#14 = aAlfa1;
      #camaniva#36 = #caenlace#10;
      |SI #caenlace#26 = "F";
          #camaniva#21 = #camaniva#21 + #caenlace#9;
      |SINO;
          #camaniva#21 = #camaniva#21 - #caenlace#9;
      |FINSI;
      TotalFactura = #camaniva#21;

      |SI #caenlace#53 ! " ";
          |HAZ GrabaCAERPNIF;
      |FINSI;

      |GRABA 020#camaniva.a;
      |LIBERA #camaniva;
      NuevoNumero = NumDoc;

      |SI enSwMensajes = 0;
         nCalcPosic = (enPosic * 100) + 7;
         |ATRI I;|PINTA nCalcPosic, "Grabando registro de iva         ";|ATRI N;
      |FINSI;
   |FINSI;

   |SI NuevoNumero = 0;
       |HAZ NuevaFactura;
   |FINSI;

   |SI #caenlace#26 = "B"; |O #caenlace#26 = "b";    || Base imponible
      nBasesExentas = 90;
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         |SI #caenlace#27 = 0; #caenlace#27 = nBasesExentas; |FINSI;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            #caivalin#28 = #caenlace#39;
            #caivalin#3  = #caenlace#6;
            #caivalin#4  = #caenlace#7;
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |SINO;
            |SI #caivalin#6 = 0; |Y #caivalin#8 = 0; |Y #caivalin#10 = 0;
                #caivalin#3  = #caenlace#6;
                #caivalin#4  = #caenlace#7;
            |FINSI;
            |SI #caivalin#6 = 0; |Y #caivalin#22 ! 0;
                #caivalin#3  = #caenlace#6;
                #caivalin#4  = #caenlace#7;
            |FINSI;

            |SI #caivalin#28 ! #caenlace#39; |Y #caenlace#39 ! "       "; |Y enNoCalcu = 0; ||tique 1857_1099
               |SI #caivalin#28 ! "       "; |O #caivalin#6 ! 0;
                  |SI #caenlace#27 < nBasesExentas;
                     nLinea = 10 + #caenlace#27;
                  |SINO;
                     nLinea = 1 + #caenlace#27;
                  |FINSI;
                  |DDEFECTO #caivalin;
                  #caivalin#0  = #caenlace#11;
                  #caivalin#1  = NumDoc;
                  #caivalin#2  = nLinea;
                  |LEE 000#caivalin.];
                  |PARA; |SI FSalida = 0; |Y #caivalin#0  = #caenlace#11; |Y #caivalin#1  = NumDoc; |HACIENDO;
                     || Esta condicion fue colocada con el tiquet 003445/01265 para
                     ||    ajustar en caso de que hubiera varias bases exentas
                     ||    con distintas contrapartidas. Pero el hacer esta
                     ||    operacion exclusiva de las bases exentas provocaba
                     ||    el error del tiquet 003218/01819, con lo que elimino
                     ||    la condicion para que se haga en todo caso.
                     ||SI #caivalin#2 ] nBasesExentas;
                     ||   nLinea = #caivalin#2 + 1;
                     ||FINSI;

                     nLinea = #caivalin#2 + 1;
                     |LEE 000#caivalin.s;
                  |SIGUE;
                  |DDEFECTO #caivalin;
                  #caivalin#0  = #caenlace#11;
                  #caivalin#1  = NumDoc;
                  #caivalin#2  = nLinea;
                  #caivalin#28 = #caenlace#39;
                  #caivalin#3  = #caenlace#6;
                  #caivalin#4  = #caenlace#7;
                  aAlfa = #caenlace#15; |QBF aAlfa;
                  |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
                  aAlfa = #caenlace#50; |QBF aAlfa;
                  |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
                  |GRABA 020#caivalin.b;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI #caenlace#32 = " "; #caenlace#32 = "N"; |FINSI;

         |ABRET #dsmom030;
         #dsmom030#0 = #caivalin#3;
         |LEE 000#dsmom030.=;
         |SI FSalida = 0;
            |SI #caenlace#31 = " ";
               |SI #dsmom030#28 ! 0; |O #dsmom030#32 ! 0; |O #dsmom030#26 ! 0;
                |O #dsmom030#34 ! 0; |O #dsmom030#36 ! 0;
                  #caivalin#5 = "S";
               |SINO;
                  #caivalin#5 = "N";
               |FINSI;
            |SINO;
               #caivalin#5  = #caenlace#31;
            |FINSI;
            #caivalin#25  = #dsmom030#72;
         |FINSI;
         |CIERRAT #dsmom030;

         |SI enCambioCtaIVA = 1; |Y aDeducible ! "";
             #caivalin#5 = aDeducible;
         |FINSI;
         nImpor1 = #caenlace#9;
         |SI #caenlace#26 = "b"; nImpor1 = - #caenlace#9; |FINSI;
         #caivalin#6  = #caivalin#6 + nImpor1;
         #caivalin#7  = #caenlace#28;
         #caivalin#9  = #caenlace#33;

         aAlfa1 = #caivalin#12; |QBF aAlfa1;
         |SI aAlfa1 = "";
             #caivalin#12 = #caenlace#4;
         |FINSI;

         #caivalin#16 = 0;
         #caivalin#17 = #caenlace#32;
         aAlfa1 = #caenlace#39; |QBF aAlfa1;
         |SI aAlfa1 ! "";
             #caivalin#28 = #caenlace#39;
         |FINSI;
         |GRABA 020#caivalin.a; |LIBERA #caivalin;

         #camaniva#19 = #camaniva#19 + nImpor1;
         ||HAZ RecalculaIva; PEPE1
         |GRABA 020#camaniva.a; |LIBERA #camaniva;
      |FINSI;
      |SI enSwMensajes = 0;
         nCalcPosic = (enPosic * 100) + 7;
         |ATRI I;|PINTA nCalcPosic, "Actualizando bases del registro  ";|ATRI N;
      |FINSI;
   |FINSI;

   |SI #caenlace#26 = "T"; |O #caenlace#26 = "t";     || Base IRPF
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         |SI #caenlace#27 = 0; #caenlace#27 = 99; |FINSI;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |FINSI;
         #caivalin#3  = #caenlace#6;
         #caivalin#4  = #caenlace#7;
         |SI #caenlace#31 ! " ";
             #caivalin#5  = #caenlace#31;
         |FINSI;
         #caivalin#12 = #caenlace#4;
         #caivalin#16 = 0;
         #caivalin#17 = #caenlace#32;
         nNume1 = #caenlace#9;
         |SI #caenlace#26 = "t"; nNume1 = -nNume1; |FINSI;
         #caivalin#20 = #caivalin#20 + nNume1;
         |GRABA 020#caivalin.a; |LIBERA #caivalin;

         ||HAZ RecalculaIva; PEPE1
         |GRABA 020#camaniva.a; |LIBERA #camaniva;

      |FINSI;
      |SI enSwMensajes = 0;
         nCalcPosic = (enPosic * 100) + 7;
         |ATRI I;|PINTA nCalcPosic, "Actualizando bases del registro  ";|ATRI N;
      |FINSI;
   |FINSI;

   |SI #caenlace#26 = "I"; |O #caenlace#26 = "i";  || Cuota IVA

      |SI eSwPlusGes = 1;
          |SI #caenlace#30 = "S"; |O #caenlace#48 = "I";
               aAlfa3 = #caenlace#4 % 103;
               |SI aAlfa3 = "477"; |Y #caenlace#10 = "S"; nSwIntra = 1; |ACABA; |FINSI;
               |SI aAlfa3 = "472"; |Y #caenlace#10 = "R"; nSwIntra = 1; |ACABA; |FINSI;
          |FINSI;
      |FINSI;

      nTotalIva = nTotalIva + #caenlace#9;
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0; |Y #caenlace#27 ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            ||
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |FINSI;
         #caivalin#3  = #caenlace#6; #caivalin#4  = #caenlace#7;
         |SI #caenlace#26 = "I"; nCuotIva =  #caenlace#9; |FINSI;
         |SI #caenlace#26 = "i"; nCuotIva = -#caenlace#9; |FINSI;
         #caivalin#8  = #caivalin#8 + nCuotIva;

         |SI #caenlace#31 ! " "; #caivalin#5 = #caenlace#31; |FINSI;

|| Cambio esto tique 549 _ 545
         aAlfa1 = #caivalin#13; |QBF aAlfa1;
         |SI aAlfa1 = ""; #caivalin#13 = #caenlace#4; |FINSI;

         |SI #caenlace#27 ! 0; |GRABA 020#caivalin.a; |FINSI;
         |LIBERA #caivalin;

         |SI #caenlace#27 = 0; nSwVarios = 1; aCtaVarios = #caivalin#13; |FINSI;

         #camaniva#23 = #camaniva#23 + nCuotIva;
         ||HAZ RecalculaIva; PEPE1
         #camaniva#29 = #caenlace#6; #camaniva#30 = #caenlace#7;
         |GRABA 020#camaniva.a; |LIBERA #camaniva;
         |SI enSwMensajes = 0;
            nCalcPosic = (enPosic * 100) + 7;
            |ATRI I;|PINTA nCalcPosic, "Actualizando cuotas de iva       ";|ATRI N;
         |FINSI;
      |FINSI;
   |FINSI;

   |SI #caenlace#26 = "R"; |O #caenlace#26 = "r"; || Cuota REC
      nTotalRec = nTotalRec + #caenlace#9;
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0; |Y #caenlace#27 ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            ||SI #caivalin#2 = 0; #caivalin#2 = 1; |FINSI;
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |FINSI;
         #caivalin#3  = #caenlace#6; #caivalin#4  = #caenlace#7;
         nNume1 = #caenlace#9;
         |SI #caenlace#26 = "r"; nNume1 = -nNume1; |FINSI;
         #caivalin#10 = #caivalin#10 + nNume1;

|| Cambio esto  tique 549 _ 545
         aAlfa1 = #caivalin#14; |QBF aAlfa1;
         |SI aAlfa1 = ""; #caivalin#14 = #caenlace#4; |FINSI;

         |SI #caenlace#27 ! 0; |GRABA 020#caivalin.a; |FINSI;
         |LIBERA #caivalin;

         |SI #caenlace#27 = 0; nSwVarios = 1; aCtaRVarios = #caivalin#14; |FINSI;

         #camaniva#23 = #camaniva#23 + nNume1;
         ||HAZ RecalculaIva; PEPE1
         |GRABA 020#camaniva.a; |LIBERA #camaniva;
         |SI enSwMensajes = 0;
            nCalcPosic = (enPosic * 100) + 7;
            |ATRI I;|PINTA nCalcPosic, "Actualizando cuotas de recargo   ";|ATRI N;
         |FINSI;
      |FINSI;
   |FINSI;

   |SI #caenlace#26 = "D"; |O #caenlace#26 = "d";  || Descuento
      || Compruebo si a la base correspondiente se le ha incorporado el IVA,
      ||    ya que si no, hay que recalcular cuota y porcentaje

      |SI #caenlace#27 = 0; #caenlace#27 = 99; |FINSI;
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         |SI #caenlace#27 = 0; #caenlace#27 = 99; |FINSI;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |FINSI;
         #caivalin#3  = #caenlace#6; #caivalin#4  = #caenlace#7;
         nNume1 = #caenlace#9;
         |SI #caenlace#26 = "d"; nNume1 = -nNume1; |FINSI;
         #caivalin#11 = #caivalin#11 + nNume1;
         #caivalin#6  = #caivalin#6  - nNume1;

         || ABDON  15/07/2010    Tiquet 003275/00432
         || Esta condicion la pongo porque si no, se queda el calculo del
         ||    porcentaje de antes de quitar el descuento de la base, por
         ||    lo que no saldr  un tipo de iva correcto. En el enlace se
         ||    estan usando los importes de la cabecera de la factura
         ||    unicamente
         |SI #caivalin#6 ! 0; |Y #caivalin#8 ! 0; #caivalin#7  = -1; |FINSI;
         |GRABA 020#caivalin.a; |LIBERA #caivalin;

         ||HAZ RecalculaIva; PEPE1
         #camaniva#26 = #camaniva#26 + nNume1;
         #camaniva#19 = #camaniva#19 - nNume1;
         |GRABA 020#camaniva.a; |LIBERA #camaniva;
         |SI enSwMensajes = 0;
            nCalcPosic = (enPosic * 100) + 7;
            |ATRI I;|PINTA nCalcPosic, "Actualizando cuotas de descuento ";|ATRI N;
         |FINSI;
      |FINSI;
   |FINSI;

   |SI #caenlace#26 = "P"; |O #caenlace#26 = "p";     || Cuota IRPF
      #camaniva#0 = #caenlace#11;
      #camaniva#1 = NumDoc;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         |SI #caenlace#27 = 0; #caenlace#27 = 99; |FINSI;
         #caivalin#0  = #caenlace#11;
         #caivalin#1  = NumDoc;
         #caivalin#2  = #caenlace#27;
         |LEE 101#caivalin.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivalin;
            #caivalin#0  = #caenlace#11;
            #caivalin#1  = NumDoc;
            #caivalin#2  = #caenlace#27;
            aAlfa = #caenlace#15; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#30 = #camaniva#10; |SINO; #caivalin#30 = #caenlace#15; |FINSI;
            aAlfa = #caenlace#50; |QBF aAlfa;
            |SI aAlfa = ""; #caivalin#31 = #camaniva#11; |SINO; #caivalin#31 = #caenlace#50; |FINSI;
            |GRABA 020#caivalin.b;
         |FINSI;

         || No podemos grabar el codigo de IRPF en el general, ya que en una
         ||    linea de iva puede haber una cuota de IVA (que grabaria un
         ||    concepto general para modelos, etc) y una cuota de IRPF. Si
         ||    grabamos el concepto de IRPF, el de IVA desaparece, por lo que
         ||    podriamos tener problemas con los pases a modelos, etc. Para
         ||    el concepto de IRPF esta el campo n§ 18 de las lineas de iva.
         || #caivalin#3  = #caenlace#6;
         || aAlfa = #caenlace#7; |QBF aAlfa;
         || aAlfa = aAlfa + " (IRPF)";
         || #caivalin#4  = aAlfa;

         #caivalin#18 = #caenlace#6;
         #caivalin#19 = #caenlace#7;
         #caivalin#20 = #caenlace#42;
         #caivalin#21 = #caenlace#41;

         nNume1 = #caenlace#9;
         |SI #caenlace#26 = "p"; nNume1 = -nNume1; |FINSI;
         #caivalin#22 = #caivalin#22 + nNume1;
         #caivalin#23 = #caenlace#4;
         |GRABA 020#caivalin.a; |LIBERA #caivalin;

         #camaniva#20 = #camaniva#20 + nNume1;
         ||
         |GRABA 020#camaniva.a; |LIBERA #camaniva;

         |SI enSwMensajes = 0;
            nCalcPosic = (enPosic * 100) + 7;
            |ATRI I;|PINTA nCalcPosic, "Actualizando importes de IRPF    ";|ATRI N;
         |FINSI;
      |FINSI;
   |FINSI;

   |SI #caenlace#10 = "R"; |O #caenlace#10 = "S";
       |ABRE #caivatm4;
       #caivatm4#0 = enEmpresa;
       #caivatm4#1 = enPeriodo;
       |SI #caenlace#37 ! 0;
           #caivatm4#0 = #caenlace#37;
           #caivatm4#1 = #caenlace#38;
       |FINSI;
       #caivatm4#2 = #caenlace#11;
       #caivatm4#3 = NumDoc;
       |LEE 041#caivatm4.=;
       |SI FSalida ! 0;
           #caivatm4#0 = enEmpresa;
           #caivatm4#1 = enPeriodo;
           |SI #caenlace#37 ! 0;
               #caivatm4#0 = #caenlace#37;
               #caivatm4#1 = #caenlace#38;
           |FINSI;
           #caivatm4#2 = #caenlace#11;
           #caivatm4#3 = NumDoc;
           |GRABA 020#caivatm4.n;
       |FINSI;
       |CIERRA #caivatm4;
   |FINSI;

   |SI nSwAutoDE = 1;
       nSwAutoDG = 1;
   |FINSI;
|FPRC;

|PROCESO BorraIvaLin;
   |BORRA 020#caivalin.a;
|FPRC;

|DEFBUCLE BorraIvaLin;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,000;
 #camaniva#0,#camaniva#1,999;
 ;
 NULL,BorraIvaLin;
|FIN;

|PROCESO BorraLinAsto;
   |SI #camaasil#12 = "R"; |O #camaasil#12 = "S"; |O #camaasil#12 = "N";
      nSwBorrado = 1;
      |ABRE #camaniva;
      |SELECT #2#camaniva;
      #camaniva#7 = #camaasic#0;
      #camaniva#8 = #camaasic#1;
      #camaniva#9 = #camaasic#2;
      |LEE 101#camaniva.=;
      |SI FSalida = 0;
         aAlfa = #camaniva#18; |QBF aAlfa;
         aAlfa1 = aAlfa % 0102;
         |SI aAlfa1 = "**";
            |SALVA_FICHA #camaniva;
            |SELECT #3#camaniva;
            aAlfa1 = aAlfa % 0302; #camaniva#0 = aAlfa1;
            aAlfa1 = aAlfa % 0502; #camaniva#2 = aAlfa1;
            aAlfa1 = aAlfa % 0706; #camaniva#3 = aAlfa1;
            |LEE 101#camaniva.=;
            |SI FSalida = 0;
               |BUCLE BorraIvaLin;
               |BORRA 020#camaniva.a;

               |HAZ BorraSII;
            |FINSI;
            |SELECT #2#camaniva;
            |REPON_FICHA #camaniva;
         |FINSI;
         LibroAnt = #camaniva#0; SerieAnt = #camaniva#2;
         |BUCLE BorraIvaLin;
         |BORRA 020#camaniva.a;

         |HAZ BorraSII;
      |FINSI;
      |SELECT #1#camaniva;
      |LIBERA #camaniva; |CIERRA #camaniva;
   |FINSI;

   || Si tenia registro en el camanefe tambien lo borro
   |ABRE #camanefe;
   #camanefe#0 = #camaasil#0;
   #camanefe#1 = #camaasil#1;
   #camanefe#2 = #camaasil#2;
   #camanefe#3 = #camaasil#3;
   |LEE 000#camanefe.=;
   |SI FSalida = 0; |BORRA 020#camanefe.a; |FINSI;
   |CIERRA #camanefe;

   |SI enSwMensajes = 0;
      nCalcPosic = (enPosic * 100) + 7;
      |ATRI I; |PINTA nCalcPosic, "Borrando lineas de asientos      ";|ATRI N;
   |FINSI;
   Cuenta = #camaasil#4; Nivel = #camaasil#5; nImporte = 0 - #camaasil#9; |HAZ Actualiza;
   |BORRA 020#camaasil.a;
|FPRC;

|DEFBUCLE BorraLinAsto;
#camaasil#1;
;
#camaasic#0,#camaasic#1,#camaasic#2,0001;
#camaasic#0,#camaasic#1,#camaasic#2,9999;
be;
NULL,BorraLinAsto;
|FIN;

|PROCESO BorraAsto;
   #camaasic#0  = #caenlace#0;
   #camaasic#1  = #caenlace#1;
   #camaasic#2  = nDOCUMENTO1;
   |LEE 101#camaasic.=;
   |SI FSalida = 0;
      |BUCLE BorraLinAsto;
      |SI enSwMensajes = 0;
         nCalcPosic = (enPosic * 100) + 7;
         |ATRI I;|PINTA nCalcPosic, "Borrando asientos                ";|ATRI N;
      |FINSI;
      |BORRA 020#camaasic.a;
   |FINSI;
   |LIBERA #camaasic;
|FPRC;

|PROCESO BuscoCta;
   nHay = 1;
   eaCuenta    = #caclipro#10;
   #caenlace#4 = #caclipro#10;
   |ERROR10;
|FPRC;

|DEFBUCLE BuscoCta;
   #caclipro#4;
   10;
   #caenlace#44, aDCta;
   #caenlace#44, aHCta;
   ;
   NULL, BuscoCta;
|FIN;

|PROCESO BuscarCta;
      |REPON_FICHA #caenlace;

      aAlfa = #caenlace#4 % 104;
      aDCta = aAlfa + "        ";
      aHCta = aAlfa + "zzzzzzzz";

      nHay = 0;
      |BUCLE BuscoCta;
      |SI nHay = 0;
          aAlfa = #caenlace#4 % 104;
          eaCuenta = aAlfa + ".a      ";
          |HAZ FiltraPuntos;
          #caenlace#4 = eaCuenta;
      |FINSI;
      aCodCta  = eaCuenta;
      nYaTipoF = 1;
      |SALVA_FICHA #caenlace;
|FPRC;

|PROCESO VeoElRecar;
  |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
      |SI #caenlac@#27 = #caenlace#27; |Y #caenlac@#9 ! 0;
          nOk = 1;
          |ERROR10;
      |FINSI;
      nNuevo = #caenlac@#27;
  |FINSI;
|FPRC;

|DEFBUCLE VeoElRecar;
  #caenlac@#1006;
  ;
  #caenlace#0, #caenlace#1, #caenlace#2, 0001, #caenlace#37, #caenlace#38;
  #caenlace#0, #caenlace#1, #caenlace#2, 9999, #caenlace#37, #caenlace#38;
  ;
  NULL, VeoElRecar;
|FIN;

|PROCESO VeoElRecargo;
   nOk = 0;
   |BUCLE VeoElRecar;
   |SI nOk = 0; #caenlace#27 = nNuevo; |FINSI;
|FPRC;

|PROCESO BuscoApte;
   nLineaApte = #camaasil#3;
   nOk        = 1;
|FPRC;

|DEFBUCLE BuscoApte;
   #camaasil#1;
   4, 19, 20;
   #camaasic#0, #camaasic#1, #camaasic#2, 0001, #caenlace#4, aAlfa, #caenlace#27;
   #camaasic#0, #camaasic#1, #camaasic#2, 9999, #caenlace#4, aAlfa, #caenlace#27;
   ;
   NULL, BuscoApte;
|FIN;

|PROCESO BuscoApunte;

   |SI #caenlace#10 ! "R"; |Y  #caenlace#10 ! "S";
       |ACABA;
   |FINSI;
   |SI #caenlace#26 = " "; |ACABA; |FINSI;

   nSumoCamp9 = 0;
   nOk        = 0;
   aAlfa      = #caenlace#26; |SI aAlfa = "f"; aAlfa = "F"; |FINSI;

   |CIERRA #camaasil;
   |BUCLE BuscoApte;
   |ABRE #camaasil;

   |SI nOk = 1;
       #camaasil#0 = #camaasic#0;
       #camaasil#1 = #camaasic#1;
       #camaasil#2 = #camaasic#2;
       #camaasil#3 = nLineaApte;
       |LEE 141#camaasil.=;
       |SI FSalida = 0;
           nSumoCamp9 = #camaasil#9;
           |SI #camaasil#8 ! #caenlace#8;
               nSumoCamp9 = -#camaasil#9;
           |FINSI;
           |BORRA 020#camaasil.a;
       |FINSI;
       |LIBERA #camaasil;
   |FINSI;
|FPRC;

|PROCESO InitEmpresa;
   |CIERRAT #camaasic;   |PATH_DAT #camaasic#Path#;
   |CIERRA #calicont;    |PATH_DAT #calicont#Path#;
   |CIERRA #caclipro;    |PATH_DAT #caclipro#Path#;
   |CIERRA #caivaasi;    |PATH_DAT #caivaasi#Path#;
   |CIERRA #camaniva;    |PATH_DAT #camaniva#Path#;
   |CIERRA #caivalin;    |PATH_DAT #caivalin#Path#;
   |CIERRA #camandia;    |PATH_DAT #camandia#Path#;
   |CIERRA #cacuenta;    |PATH_DAT #cacuenta#Path#;
   |CIERRA #camaasil;    |PATH_DAT #camaasil#Path#;
   |CIERRA #cadeflab;    |PATH_DAT #cadeflab#Path#;

   |CIERRA #canempre;

   |PATH_DAT #casiim01#Path#;
   |PATH_DAT #casiim02#Path#;
   |PATH_DAT #caivases#Path#;
   |PATH_DAT #cacuebal#Path#;
   |PATH_DAT #caagrupa#Path#;
   |PATH_DAT #caepigra#Path#;
   |PATH_DAT #camanefe#Path#;
   |PATH_DAT #anm00001#Path#;
   |PATH_DAT #camanads#Path#;

   enNoBloq = 1;
   |HAZ inicio;
   enNoBloq = 0;

   |ABRE #camaasic;
   |ABRE #calicont;
   |ABRE #caclipro;
   |ABRE #caivaasi;
   |ABRE #camaniva;
   |ABRE #caivalin;
   |ABRE #camandia;
   |ABRE #cacuenta;
   |ABRE #camaasil;
   |ABRE #cadeflab;

   |ABRE #canempre;

   Comodin = Path; |QBF Comodin;
   Comodin = Comodin % -107; Comodin = Comodin - "/";
   Comodin1 = Comodin % 0105; #canempre#2 = Comodin1;
   Comodin1 = Comodin % -101; #canempre#3 = Comodin1;
   |LEE 000#canempre.=;
   |SI FSalida = 0;
      Dig1 = #canempre#14; Dig2 = #canempre#15; Dig3 = #canempre#16;
      Dig4 = #canempre#17; Dig5 = #canempre#18; Dig6 = #canempre#19;
   |SINO;
      nCriticos = nCriticos + 1;
      nError = 1; aError = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " no existe";
      |SI nContError < nTotalErr;
         InError = InError + 1; IaError = IaError + 1;
         nContError = nContError + 1;
      |FINSI;
   |FINSI;

   |LEE 000#cadeflab.p;
   |SI FSalida ! 0;
      |DDEFECTO #cadeflab;
      |GRABA 020#cadeflab.n;
      |LEE 000#cadeflab.p;
   |FINSI;

   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 000#caivaasi.p;
   |CIERRA #caivaasi;

   eaPaCTA1 = #caivaasi#135;  ||permitir alta no estructuras 2008
   eaPaCTA2 = #caivaasi#136;  ||Aviso 1990
   eaPaNif1 = #caivaasi#152;
   eaPaNif2 = #caivaasi#153;
   eaABanco = #caivaasi#161;
   eaObClPr = #caivaasi#186;

   nSwAutoDE = 0;
   |ABRE #camanads;
   |LEE 041#camanads.p;
   |SI FSalida = 0;
       nSwAutoDE = 1;
   |FINSI;
   |CIERRA #camanads;
|FPRC;

|PROCESO Asientos;
   aAlfa = #caenlace#18; |QBF aAlfa;
   |SI aAlfa = "S";
       |LIBERA #caenlace;
       |ACABA;
   |FINSI;

   |LEE 101#dsapunte.p; #dsapunte#5 = Contador; |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
   Contador = Contador + 1; |SI Contador > 99999999999; Contador = 0; |FINSI;

   nHago = 0;
   |SI #caenlace#37 ! 0;
       |SI EmpAnt ! #caenlace#37; |O PerAnt ! #caenlace#38;
           |SI EmpAnt ! 0;
               nHago = 1;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI Libro ! #caenlace#11; |O Serie ! #caenlace#12; |O Fact ! #caenlace#13; |O nHago = 1;
      |SI Fact ! 0; |Y Serie ! "";
         |SI Serie ! #caenlace#12; |O Fact ! #caenlace#13; |O nHago = 1;
             |HAZ RecalculaIva;
         |FINSI;
      |FINSI;
      nSwIntra = 0;
      NuevoNumero = 0;
      Libro = #caenlace#11;
      Serie = #caenlace#12;
      Fact  = #caenlace#13;
   |FINSI;
   |SI #caenlace#37 ! 0;
      |SI EmpAnt ! #caenlace#37; |O PerAnt ! #caenlace#38;
         Path = PARAMETRO;
         Path = Path - ",";
         |SI FSalida ! 0;
            nCalc = ((FSalida / 100) ! 0) + 99;
            Path = Path % nCalc;
         |FINSI;
         Comodin = Path % -107; Path = Path - Comodin;
         Path = Path + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
         fich_alta = Path; dirfich0 = Path;
         |HAZ InitEmpresa;
         EmpAnt = #caenlace#37; PerAnt = #caenlace#38;
         EnDiario = 0; EnFecha = "01.01.0000"; EnAsto = 0; nDocum   = 0;
      |FINSI;
   |FINSI;

   nSwFuera = 0; |SI #caenlace#1 < fec1; |O #caenlace#1 > fec2; nSwFuera = 1; |FINSI;

   aAlfa = #caenlace#1; |QBF aAlfa;
   aAlfa = aAlfa % 0902; nCalc = aAlfa;
   |SI nSwFuera = 1;
                           || ... |SI nCalc ! #canempre#26;
      |BORRA 020#caenlace.a;
      |LIBERA #caenlace;
      |ACABA;
   |FINSI;

   aAlfa = #caenlace#45; |QBF aAlfa;
   |SI #caivaasi#189 = "S"; |Y #caenlace#10 = "R"; |Y aAlfa = "";
       aAlfa1 = #caenlace#13;
       |SI #caivaasi#98 = "S"; aAlfa1 = ("000000" + aAlfa1) % -106; |FINSI;
       aAlfa2 = #caenlace#12; |QBF aAlfa2;
       |SI aAlfa2 ! "";  aAlfa1 = aAlfa2 + #caivaasi#97 + aAlfa1; |FINSI;
       #caenlace#45 = aAlfa1;
   |FINSI;

   |SALVA_FICHA #caenlace;

   aCampo26 = #caenlace#26 > " ";
   |SI EnDiario ! #caenlace#0; |O EnFecha ! #caenlace#1; |O EnAsto ! #caenlace#2;
      aCodCta = "";
      nYaTipoF = 0;
      |SI aCampo26 = "F";
          aNombreCta = #caenlace#43;
          aNifCta    = #caenlace#44;
          aCodCta    = #caenlace#4;
          |SI enCaenlace ! 0; |Y aNifCta ! "               ";
              |HAZ BuscarCta;
          |FINSI;
      |FINSI;
      |SI #caenlace#9 = 0; |Y aCampo26 = "F";
         nFacturaCero = 1;
      |SINO;
         nFacturaCero = 0;
      |FINSI;
      |SI LibroAnt ! #caenlace#11; |O SerieAnt ! #caenlace#12;
          LibContra = 0;
          SerContra = "";
          FacContra = 0;
          nSwIntra  = 0;
      |FINSI;
      #camaasic#0  = #caenlace#0;
      #camaasic#1  = #caenlace#1;
      #camaasic#2  = #caenlace#2; || nDOCUMENTO
      |LEE 101#camaasic.=;
      |SI FSalida = 0;
         nDOCUMENTO1 = #camaasic#2;
         nSwBorrado = 0;
         |HAZ BorraAsto;
         |SI nSwBorrado = 0;
            |ABRE #camaniva;
            |SELECT #3#camaniva;
            #camaniva#0 = #caenlace#11;
            #camaniva#2 = #caenlace#12;
            #camaniva#3 = #caenlace#13;
            |LEE 101#camaniva.=;
            |SI FSalida = 0;
               |BUCLE BorraIvaLin;
               |BORRA 020#camaniva.a;
               |LIBERA #camaniva;

               |HAZ BorraSII;
            |FINSI;
            |SELECT #1#camaniva;
            |CIERRA #camaniva;
         |FINSI;
      |SINO;
         nDOCUMENTO1 = #caenlace#2;
      |FINSI;
      |LIBERA #camaasic;
      |SI #caenlace#25 = "S";
         |ABRE #camaniva;
         |SELECT #3#camaniva;
         #camaniva#0 = #caenlace#11;
         #camaniva#2 = #caenlace#12;
         #camaniva#3 = #caenlace#13;
         |LEE 101#camaniva.=;
         |SI FSalida = 0;
            |BUCLE BorraIvaLin;
            |BORRA 020#camaniva.a;
            |LIBERA #camaniva;

            |HAZ BorraSII;
         |FINSI;
         |LIBERA #camaniva;
         |SELECT #1#camaniva;
         |CIERRA #camaniva;

         |BORRA 020#caenlace.a;
         |REPON_FICHA #caenlace;
         |LIBERA #caenlace;
         |ACABA;
      |FINSI;
      |SI nFacturaCero = 1;
         |SI enGenAsi0 = 0; |Y enGenIva0 = 0;
             |BORRA 020#caenlace.a;
             |REPON_FICHA #caenlace;
             |LIBERA #caenlace;
             |ACABA;
         |FINSI;
      |FINSI;
      |DDEFECTO #camaasic;
      #camaasic#0 = #caenlace#0;
      #camaasic#1 = #caenlace#1;
      #camaasic#2 = #caenlace#2;
      nDOCUMENTO1 = #camaasic#2;
      #camaasic#3  = nDOCUMENTO1;
      #camaasic#4 = 0; #camaasic#5 = 0; #camaasic#6 = 0; #camaasic#7 = 0;
      #camaasic#8  = ""; #camaasic#9  = 0;
      #camaasic#10 = ""; #camaasic#11 = 0;
      |SI #caenlace#10 = "S";
          #camaasic#13 = 2;
      |FINSI;
      |SI #caenlace#10 = "R";
          #camaasic#13 = 1;
      |FINSI;
      #camaasic#13 = #camaasic#13 + enNoModif;
      #camaasic#17 = #caenlace#45;
      |SI enSwMensajes = 0;
         nCalcPosic = (enPosic * 100) + 7;
         |ATRI I;|PINTA nCalcPosic, "Grabando cabeceras de asientos   ";|ATRI N;
      |FINSI;
      |SI nFacturaCero = 1;
         |SI enGenAsi0 = 1; |GRABA 020#camaasic.n; |FINSI;
      |SINO;
         |GRABA 020#camaasic.n;
      |FINSI;
      nSwCtrapD = 0; nSwCtrapH = 0;
      EnDiario = #caenlace#0;
      EnFecha  = #caenlace#1;
      EnAsto   = #caenlace#2;
      LibAnt   = #caenlace#11;
      SerAnt   = #caenlace#12;
      NumAnt   = #caenlace#13;
      nCptoAnt = #caenlace#6; aCptoAnt = #caenlace#7;
      |LIBERA #camaasic; |LEE 000#camaasic.=;
   |FINSI;

   |SI aCampo26 = "F"; |Y enCaenlace ! 0;
       |SI nYaTipoF = 0;
          aNombreCta = #caenlace#43;
          aNifCta    = #caenlace#44;
          |SI aNifCta ! "               ";
              |HAZ BuscarCta;
          |FINSI;
       |SINO;
          |SI aCodCta ! "";  #caenlace#4 = aCodCta; |FINSI;
       |FINSI;
   |FINSI;

   |SI enCaenlace ! 0; |Y #caenlace#10 ! "R"; |Y #caenlace#10 ! "S";
       nSwCliPro = 0;
       aAlfa2 = #caenlace#4 % 102;
       |SI aAlfa2 = "43"; |O aAlfa2 = "44"; |O aAlfa2 = "40"; |O aAlfa2 = "41";
           aNombreCta = #caenlace#43;
           aNifCta    = #caenlace#44;
           aCodCta    = #caenlace#4;
           |SI aNifCta ! "               ";
               |HAZ BuscarCta;
           |FINSI;
           nSwCliPro = 1;
       |FINSI;
   |FINSI;

   |SI nFacturaCero = 1;
      |SI enGenAsi0 = 0; |Y enGenIva0 = 0;
         |REPON_FICHA #caenlace;
         |LIBERA #caenlace;
         |ACABA;
      |FINSI;
   |SINO;
      |SI #caenlace#9 = 0;
         |REPON_FICHA #caenlace;
         |LIBERA #caenlace;
         |ACABA;
      |FINSI;
   |FINSI;

|| Miro de grabar el camanefe
   |SI #caivaasi#164 = "S"; |Y #caenlace#26 = " ";

      |ABRET #dsmom030;
      #dsmom030#0 = #caenlace#6;
      |LEE 000#dsmom030.=;
      |SI FSalida = 0; |Y #dsmom030#7 = "S";
         nSwHayCif = 0;
         #caclipro#23 = "C";
         #caclipro#10 = #caenlace#4;
         |LEE 000#caclipro.=;
         |SI FSalida = 0; nSwHayCif = 1; |FINSI;

         |SI nSwHayCif = 0;
            #caclipro#23 = "P";
            #caclipro#10 = #caenlace#4;
            |LEE 000#caclipro.=;
            |SI FSalida = 0; nSwHayCif = 1; |FINSI;
         |FINSI;

         |SI nSwHayCif = 1;
            |ABRE #camanefe;
            |DDEFECTO #camanefe;
            #camanefe#0 = #caenlace#0;
            #camanefe#1 = #caenlace#1;
            #camanefe#2 = #caenlace#2;
            #camanefe#3 = #caenlace#3;
            |LEE 000#camanefe.=;
            |SI FSalida ! 0;
               |DDEFECTO #camanefe;
               #camanefe#0 = #caenlace#0;
               #camanefe#1 = #caenlace#1;
               #camanefe#2 = #caenlace#2;
               #camanefe#3 = #caenlace#3;
               #camanefe#4 = #caenlace#36;
               |GRABA 020#camanefe.n;
            |FINSI;
            |CIERRA #camanefe;
         |FINSI;
      |FINSI;
      |CIERRAT #dsmom030;
   |FINSI;

   |SI #caenlace#26 = "I"; |O #caenlace#26 = "i";
         || Tique 3237_1816
         |SI enCambioCtaIVA = 1; |Y nGrupoIVA ! -1;
             |SI nTpIVAMil = #caivalin#7; |Y aCtaMil ! "";
                 #caenlace#4 = aCtaMil;
             |FINSI;
         |FINSI;
   |FINSI;

   |SI #caenlace#26 = "R"; |O #caenlace#26 = "r";
         || Tique 3237_1816
         |SI enCambioCtaIVA = 1; |Y nGrupoIVA ! -1;
             |SI nTpRecMil = #caivalin#9; |Y aCtaRMil ! "";
                 #caenlace#4 = aCtaRMil;
             |FINSI;
         |FINSI;
   |FINSI;

   |SI enCaenlace ! 0; |Y #caenlace#27 > 1;
      |SI #caenlace#26 = "R"; |O #caenlace#26 = "r";
          |HAZ VeoElRecargo;
      |FINSI;
   |FINSI;

   |SI #caenlace#10 = "R"; |O #caenlace#10 = "S";
       |SI enCaenlace ! 0; |Y #caenlace#26 = " ";
           aAlfa = #caenlace#4; aAlfa = aAlfa % 101;
           |SI aAlfa = "6"; |O aAlfa = "7";
               #caenlace#26 = "B";
               #caenlace#27 = 21;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI enCaenlace ! 0;
       |SI #caenlace#26 = "B"; |O #caenlace#26 = "I"; |O #caenlace#26 = "R";
           nOk = 0;
           aAlfa1 = #caenlace#4 % 101;
           aAlfa3 = #caenlace#4 % 103;
           |SI aAlfa1 = "7"; |Y aAlfa3 ! "706"; |Y #caenlace#8 = "D"; nOk = 1; |FINSI;
           |SI aAlfa1 = "6"; |Y aAlfa3 ! "668"; |Y aAlfa3 ! "606"; |Y #caenlace#8 = "H"; nOk = 1; |FINSI;
           |SI aAlfa3 = "477"; |Y #caenlace#8 = "D"; nOk = 1; |FINSI;
           |SI aAlfa3 = "472"; |Y #caenlace#8 = "H"; nOk = 1; |FINSI;
           |SI nOk = 1;
               aAlfa = #caenlace#26 < " ";
               #caenlace#26 = aAlfa;
           |FINSI;
       |FINSI;
       |SI #caenlace#26 = "F";
           |SI #caenlace#10 = "R"; |Y #caenlace#8 = "H";
               #caenlace#8 = "D";
               #caenlace#9 = - #caenlace#9;
           |FINSI;
           |SI #caenlace#10 = "S"; |Y #caenlace#8 = "D";
               #caenlace#8 = "H";
               #caenlace#9 = - #caenlace#9;
           |FINSI;
       |FINSI;
   |FINSI;

   nSumoCamp9 = 0;
   nLineaApte = #caenlace#3;
   |SI enCaenlace ! 0;
       |HAZ BuscoApunte;
   |FINSI;

   |DDEFECTO #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #caenlace#2 = #camaasic#2;
   #camaasil#3 = nLineaApte;
   #camaasil#4 = #caenlace#4;
   #camaasil#5 = #caenlace#5;
   #camaasil#6 = #caenlace#6;
   #camaasil#7 = #caenlace#7;
   #camaasil#8 = #caenlace#8;
   #camaasil#9 = #caenlace#9;
   |SI #camaasil#8 = "D";
      #camaasil#10 = "";          #camaasil#11 = 0;
      #camaasil#16 = #camaasil#4; #camaasil#17 = #camaasil#5;
   |SINO;
      #camaasil#10 = #camaasil#4; #camaasil#11 = #camaasil#5;
      #camaasil#16 = "";          #camaasil#17 = 0;
   |FINSI;
   #camaasil#12 = #caenlace#10;
   #camaasil#13 = #caenlace#11;
   #camaasil#14 = #caenlace#13;
   #camaasil#15 = #caenlace#12;
   |SI #caenlace#52 = "S";
      #camaasil#18 = "û";
   |SINO;
      #camaasil#18 = " ";
   |FINSI;
   #camaasil#19 = #caenlace#26;
   |SI #camaasil#19 = "f"; #camaasil#19 = "F"; |FINSI;
   #camaasil#20 = #caenlace#27;

   aAlfa1 = #caenlace#49; |QBF aAlfa1;
   |SI aAlfa1 = "";
      #camaasil#21 = #caenlace#15;
   |SINO;
      #camaasil#21 = #caenlace#49;
   |FINSI;
   aAlfa1 = #camaasil#21; |QBF aAlfa1;
   |SI aAlfa1 = ""; #camaasil#21 = eaDfDepC;|FINSI;

   #camaasil#22 = #caenlace#14;
   #camaasil#23 = "N";
   #camaasil#26 = #caenlace#45;

   aAlfa1 = #caenlace#50; |QBF aAlfa1;
   |SI aAlfa1 = "";
      #camaasil#28 = eaDfSubC;
   |SINO;
      #camaasil#28 = #caenlace#50;
   |FINSI;
   #camaasil#29 = #caenlace#39;
   |SI enSwMensajes = 0;
      nCalcPosic = (enPosic * 100) + 7;
      |ATRI I;|PINTA nCalcPosic, "Grabando lineas de asientos      ";|ATRI N;
   |FINSI;
   |SI nFacturaCero = 1;
      |SI enGenAsi0 = 1; |GRABA 020#camaasil.b; |FINSI;
   |SINO;
      |GRABA 020#camaasil.b;
   |FINSI;

   |SI nFacturaCero = 1;
      |SI enGenIva0 = 1; |HAZ CreaRegistro; |FINSI;
   |SINO;
      |HAZ CreaRegistro;
   |FINSI;

   nOk = 0;
   |SI enCaenlace ! 0; |Y nSumoCamp9 ! 0;
      nOk = 1;
      #camaasil#9 = #camaasil#9 + nSumoCamp9;
   |FINSI;
   |SI #camaasil#12 ! " "; |Y #camaasil#14 < 0;
      nOk = 1;
      #camaasil#14 = #caenlace#13;
   |FINSI;

   |SI nOk = 1;
      |SI nFacturaCero = 1;
         |SI enGenAsi0 = 1; |GRABA 020#camaasil.a; |FINSI;
      |SINO;
         |GRABA 020#camaasil.a;
      |FINSI;
   |FINSI;

   |LIBERA #camaasil;
   |SI enCaenlace ! 0; |Y nSumoCamp9 ! 0;
      #camaasil#9 = #camaasil#9 - nSumoCamp9;
   |FINSI;

   |SI #caenlace#39 ! "       ";
      |ABRE #anm00001;
      #anm00001#0 = #caenlace#39;
      |LEE 000#anm00001.=;
      |SI FSalida ! 0;
         |DDEFECTO #anm00001;
         #anm00001#0 = #caenlace#39;
         #anm00001#1 = "CUENTA ANALITICA " + #caenlace#39;
         |GRABA 020#anm00001.n;
      |FINSI;
      |CIERRA #anm00001;
   |FINSI;

   #caenlace#20 = "S"; |GRABA 020#caenlace.a;

   |SI nFacturaCero = 1;
      |SI enGenAsi0 = 1;
          Cuenta = #camaasil#4; Nivel = #camaasil#5;
          nImporte = #camaasil#9; |HAZ Actualiza;
      |FINSI;
   |SINO;
      Cuenta = #camaasil#4; Nivel = #camaasil#5;
      nImporte = #camaasil#9; |HAZ Actualiza;
   |FINSI;

   |REPON_FICHA #caenlace;
   |LIBERA #caenlace;
   nSwCliPro = 0;
|FPRC;

|DEFBUCLE Asientos1;
    #caenlace#1;
    20;
    00,"00.00.0000",000001,0000,00000,0,"N";
    99,"31.12.9999",999999,9999,99999,9,"N";
    be;
    NULL,Asientos;
|FIN;

|DEFBUCLE Asientos2;
    #caenlace#4;
    20;
    00000,0,00,"00.00.0000",000001,0000,"N";
    99999,9,99,"31.12.9999",999999,9999,"N";
    be;
    NULL,Asientos;
|FIN;

|PROCESO ComprBorradoExterno;
    || CAROLINA : 003237/
    || Este proceso se incluye porque necesitamos comprobar si el asiento que se va a eliminar es de una empresa bloqueada o cerrada
    ||    llamado desde un proceso externo. Solo se entra si la variable enSwConfi = 1 y si el asiento se va a eliminar (#caenlace#25 = "S")
    || Fecha del asiento fuera del periodo o
    ||     asiento a una contabilidad cerrada
  nBorraAnt = nBorra;
  || Asiento descuadrado
  |SI nAntDia ! #caenlace#0; |O aAntFec ! #caenlace#1; |O nAntDoc ! #caenlace#2;
     aAlfa = #caenlace#1; |QBF aAlfa;
     aAlfa = aAlfa % 0902; nCalc = aAlfa;
     nSwFuera = 0; |SI #caenlace#1 < fec1; |O #caenlace#1 > fec2; nSwFuera = 1; |FINSI;

     |SI nSwFuera = 1;
        |SI nCalc ! nEjer;
           |SI #caenlace#1 < fDFechaEmp; |O #caenlace#1 > fHFechaEmp;
              nBorra = 1;
              PRMNT_enError = -3;
           |SINO;
              |SI #caenlace#37 ! #canempre#2; |O #caenlace#38 ! #canempre#3;
                  |CIERRA #camaasic;
                  |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
                  |PATH_DAT #camaasic#aAlfa#
                  |ABRE #camaasic;
                  |DDEFECTO #camaasic;
                  #camaasic#0 = 99;
                  #camaasic#1 = "01.01.0000";
                  |LEE 000#camaasic.];
                  |SI FSalida = 0; |Y #camaasic#0 = 99;
                     nBorra = 1;
                     PRMNT_enError = -4;
                  |FINSI;
                  |CIERRA #camaasic;
                  |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
                  |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
              |FINSI;
           |FINSI;
        |SINO;
           |SI #caenlace#37 ! #canempre#2; |O #caenlace#38 ! #canempre#3;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
               |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
               |DDEFECTO #camaasic;
               #camaasic#0 = 99;
               #camaasic#1 = "01.01.0000";
               |LEE 000#camaasic.];
               |SI FSalida = 0; |Y #camaasic#0 = 99;
                  nBorra = 1;
                  PRMNT_enError = -4;
               |FINSI;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
               |PATH_DAT #camaasic#aAlfa#
               |ABRE #camaasic;
           |FINSI;
        |FINSI;
     |SINO;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
        |PATH_DAT #camaasic#aAlfa#
        |ABRE #camaasic;
        |DDEFECTO #camaasic;
        #camaasic#0 = 99;
        #camaasic#1 = "01.01.0000";
        |LEE 000#camaasic.];
        |SI FSalida = 0; |Y #camaasic#0 = 99;
           nBorra = 1;
           PRMNT_enError = -4;
        |FINSI;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
        |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
     |FINSI;

     || Fecha del asiento igual o anterior a la fecha de bloqueo
     fFechaBloq = #canempre#34;
     |SI #canempre#2 ! #caenlace#37; |O #canempre#3 ! #caenlace#38;
        |SALVA_FICHA #canempre;
        #canempre#2 = #caenlace#37;
        #canempre#3 = #caenlace#38;
        |LEE 000#canempre.=;
        |SI FSalida = 0; fFechaBloq = #canempre#34; |FINSI;
        |REPON_FICHA #canempre;
     |FINSI;

     |SI #caenlace#1 [ fFechaBloq; nBorra = 1; PRMNT_enError = -5; |FINSI;

     nAntDia = #caenlace#0;  aAntFec = #caenlace#1; nAntDoc = #caenlace#2;
     aAntSer = #caenlace#12; nAntFac = #caenlace#13;
  |SINO;
     || Si no quiere decir que la primera linea del asiento ha pasado los
     ||    filtros ..... pero hay una comprobacion que hay que hacer ....
     ||    Si la fecha de la linea es igual o anterior a la de bloqueo, tengo
     ||    que marcar esa linea como 'no pasable'
     |SI #caenlace#1 [ fFechaBloq; nBorra = 1; PRMNT_enError = -5; |FINSI;
  |FINSI;
  |SI nBorra = 0; |Y nBorraAnt = 1; nBorra = 1; |FINSI;

  |SI nBorra = 1;
     #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     || Si hay una linea que borra el asiento, debo anularla tambien ...
     |SALVA_FICHA #caenlace;
     #caenlace#3 = 0;
     |LEE 000#caenlace.=;
     |SI FSalida = 0; |Y #caenlace#25 = "S";
        #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     |FINSI;
     |REPON_FICHA #caenlace;
  |SINO;
     || Esto puede ser redundante, pero es para que marque todas las lineas
     ||    del asiento en caso de que se intente enlazar a una empresa contable
     ||    cerrada
     |CIERRA #camaasic;
     |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
     |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
     |DDEFECTO #camaasic;
     #camaasic#0 = 99;
     #camaasic#1 = "01.01.0000";
     |LEE 000#camaasic.];
     |SI FSalida = 0; |Y #camaasic#0 = 99;
        #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     |FINSI;
     |CIERRA #camaasic;
     |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
     |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
  |FINSI;
|FPRC;

|PROCESO AvisoEmp;
     aAlfa2 = "";
     |SI eaTipoPase = "S";
         aAlfa2 = "Empresa: " + (("00000" + #caenlace#37) % -105) + "/" + #caenlace#38 + " ";
     |FINSI;
|FPRC;

|PROCESO Comprobar;
  |SI enSwConfi = 1; |Y #caenlace#25 = "S";
     |HAZ ComprBorradoExterno; |ACABA;
  |FINSI;

  |SI #caenlace#25 = "S"; |ACABA; |FINSI;

  |SI nComp1 = #caenlace#0;  |Y fComp2 = #caenlace#1;
   |Y nComp3 = #caenlace#2;  |Y nComp4 = #caenlace#37;
   |Y nComp5 = #caenlace#38;
     nBorra = 1;
     nMiraApunte = 0;
  |SINO;
     nComp1 = #caenlace#0; fComp2 = #caenlace#1;
     nComp3 = #caenlace#2; nComp4 = #caenlace#37;
     nComp5 = #caenlace#38;
     nMiraApunte = 1;
     nBorra = 0;
  |FINSI;

  |SI nMiraApunte = 1;
     |SALVA_FICHA #caenlace;
     #caenlace#3 = 9999;
     |LEE 000#caenlace.];
     |SI FSalida = 0; |Y nComp1 = #caenlace#0;  |Y fComp2 = #caenlace#1;
                      |Y nComp3 = #caenlace#2;  |Y nComp4 = #caenlace#37;
                      |Y nComp5 = #caenlace#38; |Y #caenlace#3 > 9999;
        nError = 9999;
        aAlfa2 = "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
        aAlfa2 = aAlfa2 + " El asiento " + (("00" + nComp1) % -102) + "/" + fComp2 + "/";
        aAlfa2 = aAlfa2 + (("00000" + nComp3) % -105) + "(Empresa ";
        aAlfa2 = aAlfa2 + (("00000" + nComp4) % -105) + " Periodo " + nComp5 + ")";
        aAlfa2 = aAlfa2 + " ha superado el limite de apuntes. Se omitira este asiento";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nError = 9999;
        aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nBorra = 1;
     |SINO;
        nComp1 = 0; fComp2 = @; nComp3 = 0; nComp4 = 0; nComp5 = 0;
     |FINSI;
     |REPON_FICHA #caenlace;
  |FINSI;

  |SI #caenlace#37 ! 0;
      |SALVA_FICHA #canempre;
      #canempre#2 = #caenlace#37;
      #canempre#3 = #caenlace#38;
      |LEE 000#canempre.=;
      |SI FSalida = 0;
         Dig1 = #canempre#14; Dig2 = #canempre#15; Dig3 = #canempre#16;
         Dig4 = #canempre#17; Dig5 = #canempre#18; Dig6 = #canempre#19;
         MaxNiv = #canempre#13;
       |FINSI;
      |REPON_FICHA #canempre;
  |FINSI;

  || Cuentas vacias
  aAlfa = #caenlace#4; |QBF aAlfa;
  |SI aAlfa = ""; |Y #caenlace#9 ! 0;
     nError = 1001; nAvisos = nAvisos + 1;
     |HAZ AvisoEmp;
     aAlfa1 = #caenlace#3; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
     aAlfa2 = aAlfa2 + " La linea " + (("0000" + aAlfa1) % -104) + " del asiento ";
     aAlfa1 = #caenlace#0; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("00" + aAlfa1) % -102) + "/";
     aAlfa1 = #caenlace#1; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + aAlfa1 + "/";
     aAlfa1 = #caenlace#2; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " tiene la cuenta en blanco";
     aError = aAlfa2;
     |SI nContError < nTotalErr;
        InError = InError + 1; IaError = IaError + 1;
        nContError = nContError + 1;
     |FINSI;
  |FINSI;

  || Cuentas fuera de nivel
  aLong = aAlfa % 0; nLong = aLong;
  |SI nLong ! Dig1; |Y nLong ! Dig2; |Y nLong ! Dig3; |Y nLong ! Dig4;
   |Y nLong ! Dig5; |Y nLong ! Dig6; |Y #caenlace#25 ! "S"; |Y #caenlace#9 ! 0;
     nError = 1002; nAvisos = nAvisos + 1;
     |HAZ AvisoEmp;
     aAlfa1 = #caenlace#3; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
     aAlfa2 = aAlfa2 + " La linea " + (("0000" + aAlfa) % -104) + " del asiento ";
     aAlfa1 = #caenlace#0; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("00" + aAlfa1) % -102) + "/";
     aAlfa1 = #caenlace#1; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + aAlfa1 + "/";
     aAlfa1 = #caenlace#2; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " tiene una cuenta fuera de nivel";
     aError = aAlfa2;
     |SI nContError < nTotalErr;
        InError = InError + 1; IaError = IaError + 1;
        nContError = nContError + 1;
     |FINSI;
  |FINSI;

  || Cuentas analiticas vacias
  #anm00001#0 = #caenlace#39;
  |LEE 000#anm00001.=;
  |SI FSalida ! 0; |Y nAnalitica = 1; |Y #caenlace#39 ! "       ";
     nError = 1003; nAvisos = nAvisos + 1;
     |HAZ AvisoEmp;
     aAlfa1 = #caenlace#3; |QBF aAlfa1;
     aAlfa2 = "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
     aAlfa2 = aAlfa2 + " La linea " + (("0000" + aAlfa1) % -104) + " del asiento ";
     aAlfa1 = #caenlace#0; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("00" + aAlfa1) % -102) + "/";
     aAlfa1 = #caenlace#1; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + aAlfa1 + "/";
     aAlfa1 = #caenlace#2; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " tiene una cuenta analitica inexistente";
     aError = aAlfa2;
     |SI nContError < nTotalErr;
        InError = InError + 1; IaError = IaError + 1;
        nContError = nContError + 1;
     |FINSI;
  |FINSI;

  nBorraAnt = nBorra;
  || Asiento descuadrado
  |SI nAntDia ! #caenlace#0; |O aAntFec ! #caenlace#1; |O nAntDoc ! #caenlace#2;
     nBorra = 0;
     |SI nAntDoc ] 0;
        nTotalDoc = nTotalDoc ! 2;
        |SI nTotalDoc ! 0;
           nError = 1004; nAvisos = nAvisos + 1;
           |HAZ AvisoEmp;
           aAlfa1 = nAntDia; |QBF aAlfa1;
           aAlfa2 = aAlfa2 + "[" + ((aAntSer + "     ") % 0105) + "/" + (("000000" + nAntFac) % -106) + "]";
           aAlfa2 = aAlfa2 + " El asiento " + (("00" + aAlfa1) % -102) + "/";
           aAlfa1 = aAntFec; |QBF aAlfa1;
           aAlfa2 = aAlfa2 + aAlfa1 + "/";
           aAlfa1 = nAntDoc; |QBF aAlfa1;
           aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta descuadrado [ Descuadre : " + nTotalDoc + " ]";
           aError = aAlfa2;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
        |FINSI;
     |FINSI;

     |SALVA_FICHA #canempre;
     #canempre#2 = #caenlace#37;
     #canempre#3 = #caenlace#38;
     |LEE 000#canempre.=;
     |SI FSalida ! 0;
        nEjer = -1;
        fDFechaEmp = "01.01.0000"; fHFechaEmp = "01.01.0000";
     |SINO;
        nEjer = #canempre#26;

        nCalc2 = #canempre#11; aAlfa = "01." + (("00" + nCalc2) % -102);
        |SI nEjer ] 80;
           aAlfa = aAlfa + ".19"; |QBF aAlfa;
        |SINO;
           aAlfa = aAlfa + ".20"; |QBF aAlfa;
        |FINSI;
        aAlfa = aAlfa + (("00" + nEjer) % -102); |QBF aAlfa;
        fDFechaEmp = aAlfa;

        nCalc2 = #canempre#12 + 1; |SI nCalc2 > 12; nCalc2 = 1; |FINSI;
        aAlfa = "01." + (("00" + nCalc2) % -102);
        nCalc2 = nEjer + 1;
        |SI nCalc2 ] 80;
           aAlfa = aAlfa + ".19"; |QBF aAlfa;
        |SINO;
           aAlfa = aAlfa + ".20"; |QBF aAlfa;
        |FINSI;
        aAlfa = aAlfa + (("00" + nCalc2) % -102); |QBF aAlfa;
        fHFechaEmp = aAlfa; nCalc2 = fHFechaEmp;
        nCalc2 = nCalc2 - 1; fHFechaEmp = nCalc2;
     |FINSI;
     |REPON_FICHA #canempre;

     || Fecha del asiento fuera del periodo o
     ||     asiento a una contabilidad cerrada
     aAlfa = #caenlace#1; |QBF aAlfa;
     aAlfa = aAlfa % 0902; nCalc = aAlfa;
     nSwFuera = 0; |SI #caenlace#1 < fec1; |O #caenlace#1 > fec2; nSwFuera = 1; |FINSI;
                       ||  .... ... |SI nCalc ! #canempre#26; |Y nNoComp = 0;
     |SI nSwFuera = 1; |Y nNoComp = 0;
        nError = 1005; nAvisos = nAvisos + 1;
        |HAZ AvisoEmp;
        aAlfa1 = #caenlace#0; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
        aAlfa2 = aAlfa2 + " El asiento " + (("00" + aAlfa1) % -102) + "/";
        aAlfa1 = #caenlace#1; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + aAlfa1 + "/";
        aAlfa1 = #caenlace#2; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta fuera del ejercicio de esta empresa";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nError = 9999;
        |SI nCalc ! nEjer;
           |SI #caenlace#1 < fDFechaEmp; |O #caenlace#1 > fHFechaEmp;
              nError = 9999;
              aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
              aError = aAlfa2;
              |SI nContError < nTotalErr;
                 InError = InError + 1; IaError = IaError + 1;
                 nContError = nContError + 1;
              |FINSI;
              nBorra = 1;
           |SINO;
              |SI #caenlace#37 ! #canempre#2; |O #caenlace#38 ! #canempre#3;
                  |CIERRA #camaasic;
                  |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
                  |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
                  |DDEFECTO #camaasic;
                  #camaasic#0 = 99;
                  #camaasic#1 = "01.01.0000";
                  |LEE 000#camaasic.];
                  |SI FSalida = 0; |Y #camaasic#0 = 99;
                     nError = 9999;
                     |HAZ AvisoEmp;
                     aAlfa2 = aAlfa2 + "La empresa del ejercicio indicado esta cerrado. Se omitira este asiento";
                     aError = aAlfa2;
                     |SI nContError < nTotalErr;
                        InError = InError + 1; IaError = IaError + 1;
                        nContError = nContError + 1;
                     |FINSI;
                     nError = 9999;
                     aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
                     aError = aAlfa2;
                     nBorra = 1;
                  |SINO;
                     aAlfa2 = "El asiento se ubicara en la empresa " + (("00000" + #caenlace#37) % -105);
                     aAlfa2 = aAlfa2 + " periodo " + #caenlace#38;
                     aError = aAlfa2;
                  |FINSI;
                  |CIERRA #camaasic;
                  |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
                  |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
              |FINSI;
              |SI nContError < nTotalErr;
                 InError = InError + 1; IaError = IaError + 1;
                 nContError = nContError + 1;
              |FINSI;
              |SI nEjer ] 80;
                 aAlfa2 = aAlfa2 + " del a¤o 19" + nEjer;
              |SINO;
                 |SI nEjer < 10;
                    aAlfa2 = aAlfa2 + " del a¤o 200" + nEjer;
                 |SINO;
                    aAlfa2 = aAlfa2 + " del a¤o 20" + nEjer;
                 |FINSI;
              |FINSI;
           |FINSI;
        |SINO;
           |SI #caenlace#37 ! #canempre#2; |O #caenlace#38 ! #canempre#3;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
               |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
               |DDEFECTO #camaasic;
               #camaasic#0 = 99;
               #camaasic#1 = "01.01.0000";
               |LEE 000#camaasic.];
               |SI FSalida = 0; |Y #camaasic#0 = 99;
                  nError = 9999;
                  |HAZ AvisoEmp;
                  aAlfa2 = aAlfa2 + "La empresa del ejercicio indicado esta cerrado. Se omitira este asiento";
                  aError = aAlfa2;
                  |SI nContError < nTotalErr;
                     InError = InError + 1; IaError = IaError + 1;
                     nContError = nContError + 1;
                  |FINSI;
                  nError = 9999;
                  aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
                  aError = aAlfa2;
                  nBorra = 1;
               |SINO;
                  aAlfa2 = "El asiento se ubicara en la empresa " + (("00000" + #caenlace#37) % -105);
                  aAlfa2 = aAlfa2 + " periodo " + #caenlace#38;
                  aError = aAlfa2;
               |FINSI;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
               |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
           |FINSI;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
           |SI nEjer ] 80;
              aAlfa2 = aAlfa2 + " del a¤o 19" + nEjer;
           |SINO;
              |SI nEjer < 10;
                 aAlfa2 = aAlfa2 + " del a¤o 200" + nEjer;
              |SINO;
                 aAlfa2 = aAlfa2 + " del a¤o 20" + nEjer;
              |FINSI;
           |FINSI;
        |FINSI;
     |SINO;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
        |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
        |DDEFECTO #camaasic;
        #camaasic#0 = 99;
        #camaasic#1 = "01.01.0000";
        |LEE 000#camaasic.];
        |SI FSalida = 0; |Y #camaasic#0 = 99;
           |HAZ AvisoEmp;
           aAlfa2 = aAlfa2 + "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
           aAlfa2 = aAlfa2 + " La empresa del ejercicio indicado esta cerrado. Se omitira este asiento";
           aError = aAlfa2;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
           nError = 9999;
           aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
           aError = aAlfa2;
           nBorra = 1;
        |SINO;
           aAlfa2 = "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
           aAlfa2 = aAlfa2 + " El asiento se ubicara en la empresa " + (("00000" + #caenlace#37) % -105);
           aAlfa2 = aAlfa2 + " periodo " + #caenlace#38;
           aError = aAlfa2;
        |FINSI;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
        |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
     |FINSI;

     || Fecha del asiento igual o anterior a la fecha de bloqueo
     fFechaBloq = #canempre#34;
     |SI #canempre#2 ! #caenlace#37; |O #canempre#3 ! #caenlace#38;
        |SALVA_FICHA #canempre;
        #canempre#2 = #caenlace#37;
        #canempre#3 = #caenlace#38;
        |LEE 000#canempre.=;
        |SI FSalida = 0; fFechaBloq = #canempre#34; |FINSI;
        |REPON_FICHA #canempre;
     |FINSI;

     |SI #caenlace#1 [ fFechaBloq; |Y nNoComp = 0;
        nError = 1005; nAvisos = nAvisos + 1;
        aAlfa1 = #caenlace#0; |QBF aAlfa1;
        |HAZ AvisoEmp;
        aAlfa2 = aAlfa2 + "[" + #caenlace#12 + "/" + (("000000" + #caenlace#13) % -106) + "]";
        aAlfa2 = aAlfa2 + " El asiento " + (("00" + aAlfa1) % -102) + "/";
        aAlfa1 = #caenlace#1; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + aAlfa1 + "/";
        aAlfa1 = #caenlace#2; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta dentro del bloqueo de fechas de esta empresa";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nError = 9999;
        |SI #caenlace#1 [ fFechaBloq;
           aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
           aError = aAlfa2;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
           nBorra = 1;
        |FINSI;
     |FINSI;

     nTotalDoc = 0;
     nAntDia = #caenlace#0;  aAntFec = #caenlace#1; nAntDoc = #caenlace#2;
     aAntSer = #caenlace#12; nAntFac = #caenlace#13;
  |SINO;
     || Si no quiere decir que la primera linea del asiento ha pasado los
     ||    filtros ..... pero hay una comprobacion que hay que hacer ....
     ||    Si la fecha de la linea es igual o anterior a la de bloqueo, tengo
     ||    que marcar esa linea como 'no pasable'
     |SI #caenlace#1 [ fFechaBloq; nBorra = 1; |FINSI;
  |FINSI;
  |SI nBorra = 0; |Y nBorraAnt = 1; nBorra = 1; |FINSI;

  |SI nBorra = 1;
     #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     || Si hay una linea que borra el asiento, debo anularla tambien ...
     |SALVA_FICHA #caenlace;
     #caenlace#3 = 0;
     |LEE 000#caenlace.=;
     |SI FSalida = 0; |Y #caenlace#25 = "S";
        #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     |FINSI;
     |REPON_FICHA #caenlace;
  |SINO;
     || Esto puede ser redundante, pero es para que marque todas las lineas
     ||    del asiento en caso de que se intente enlazar a una empresa contable
     ||    cerrada
     |CIERRA #camaasic;
     |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
     |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
     |DDEFECTO #camaasic;
     #camaasic#0 = 99;
     #camaasic#1 = "01.01.0000";
     |LEE 000#camaasic.];
     |SI FSalida = 0; |Y #camaasic#0 = 99;
        #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     |FINSI;
     |CIERRA #camaasic;
     |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
     |PATH_DAT #camaasic#aAlfa# |ABRE #camaasic;
  |FINSI;

  |SI #caenlace#8 = "D";
     nTotalDoc = nTotalDoc + #caenlace#9;
  |SINO;
     nTotalDoc = nTotalDoc - #caenlace#9;
  |FINSI;
|FPRC;

|DEFBUCLE Comprobar;
#caenlace#1;
20;
00,"00.00.0000",000001,0000,00000,0, "N";
99,"31.12.9999",999999,9999,99999,9, "N";
;
NULL,Comprobar;
|FIN;

|PROCESO RevisaCtraps;
   #calicont#0 = #camaasil#0;
   #calicont#1 = #camaasil#1;
   #calicont#2 = #camaasil#2;
   #calicont#3 = #camaasil#3;
   |LEE 101#calicont.=;
   |SI FSalida ! 0;
      |DDEFECTO #calicont;
      #calicont#0 = #camaasil#0;
      #calicont#1 = #camaasil#1;
      #calicont#2 = #camaasil#2;
      #calicont#3 = #camaasil#3;
      |GRABA 020#calicont.b;
   |FINSI;
   |SI #camaasil#8 = "D";
      #calicont#4 = #camaasic#10;
      #calicont#5 = #camaasic#11;
   |SINO;
      #calicont#4 = #camaasic#8;
      #calicont#5 = #camaasic#9;
   |FINSI;
   |GRABA 020#calicont.a; |LIBERA #calicont;
|FPRC;

|DEFBUCLE RevisaCtraps;
#camaasil#1;
;
#camaasic#0, #camaasic#1, #camaasic#2, 0001;
#camaasic#0, #camaasic#1, #camaasic#2, 9999;
be;
NULL,RevisaCtraps;
|FIN;

|PROCESO Actualiza;
   || Actualiza la cabecera del asiento y las contrapartidas
   |SI #camaasil#8 = "D";
      #camaasic#4 = #camaasic#4 + nImporte;
      |SI #camaasic#8 = "            ";
         |SI #camaasic#13 = 0;
            #camaasic#8 = #camaasil#4; #camaasic#9 = #camaasil#5;
         |SINO;
            |SI #camaasil#19 = "F"; |O #camaasil#19 = "B"; |O #camaasil#19 = "X";
                |O #camaasil#19 = "b";
               #camaasic#8 = #camaasil#4; #camaasic#9 = #camaasil#5;
            |FINSI;
         |FINSI;
      |SINO;
         |SI #camaasic#8 ! #camaasil#4;
            |SI #camaasic#13 = 0;
               #camaasic#8 = #camaasil#4; #camaasic#9 = #camaasil#5;
            |SINO;
               |SI #camaasil#19 = "F"; |O #camaasil#19 = "B"; |O #camaasil#19 = "X";
                   |O #camaasil#19 = "b";
                  #camaasic#8 = #camaasil#4; #camaasic#9 = #camaasil#5;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      #camaasic#5 = #camaasic#5 + nImporte;
      |SI #camaasic#10 = "            ";
         |SI #camaasic#13 = 0;
            #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5;
         |SINO;
            |SI #camaasil#19 = "F"; |O #camaasil#19 = "B"; |O #camaasil#19 = "X";
                |O #camaasil#19 = "b";
               #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5;
            |FINSI;
         |FINSI;
      |SINO;
         |SI #camaasic#10 ! #camaasil#4;
            |SI #camaasic#13 = 0;
               #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5;
            |SINO;
               |SI #camaasil#19 = "F"; |O #camaasil#19 = "B"; |O #camaasil#19 = "X";
                   |O #camaasil#19 = "b";
                  #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   |SI eSwPlusGes = 1;
       |SI nSwIntra = 1;
           |SI #camaasic#13 = 1; |O #camaasic#13 = 2;
               #camaasic#13 = #camaasic#13 + 100;
           |FINSI;
       |FINSI;
   |FINSI;

   #camaasic#6 = #camaasic#4 - #camaasic#5;
   |GRABA 020#camaasic.a;

   nSw = 0;
   |LEE 000#camaasil.c;
   |SI FSalida = 0;
      |SALVA_FICHA #camaasil;
      nSw = 1;
   |FINSI;
   ||BUCLE RevisaCtraps;
   |SI nSw = 1;
      |REPON_FICHA #camaasil;
   |FINSI;

   MasMenos     = nImporte;
   DebeHaber    = #camaasil#8;
   aCUENTA      = #camaasil#4;
   nREGISTRO    = #camaasil#24;
   nDIARIO      = #camaasil#0;
   aFECHA       = #camaasil#1;
   nDOCUMENTO   = #camaasil#2;
   nNIVELCUENTA = #camaasil#5;
   |HAZ ActDiario;          || diario
   |SI PRMNT_enSwPCEG = 0;
      |HAZ ActCuenta;          || cuenta
   |FINSI;
   |HAZ ActTesteo;
|FPRC;

|PROCESO SacaNivel1;
   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   Nivel = 0;
   |SI nLong > 0;
      |SI nLong = Dig1; Nivel = 1; |FINSI;
      |SI nLong = Dig2; Nivel = 2; |FINSI;
      |SI nLong = Dig3; Nivel = 3; |FINSI;
      |SI nLong = Dig4; Nivel = 4; |FINSI;
      |SI nLong = Dig5; Nivel = 5; |FINSI;
      |SI nLong = Dig6; Nivel = 6; |FINSI;
   |FINSI;
|FPRC;

|PROCESO ActCuenta;

   #cacuenta#0 = Cuenta; ||HAZ SacaNivel1;
   #cacuenta#1 = Nivel;
   |LEE 101#cacuenta.=;
   |SI FSalida ! 0;
      |ABRE #cacuebal;

      |DDEFECTO #cacuenta;
      |PARA nCont = 6; |SI nCont ] 1; |HACIENDO nCont = nCont - 1;
         Calc = 13 + nCont;
         |SI #canempre#Calc# ! 0;
            Calc = 100 + #canempre#Calc#;
            Comodin = Cuenta % Calc;
            #cacuenta#0 = Comodin;
            #cacuenta#1 = nCont;
            |LEE 000#cacuenta.=;
            |SI FSalida = 0;
               #cacuebal#0 = Comodin
               |LEE 000#cacuebal.=;
               |SI FSalida = 0;
                  #cacuenta#4 = #cacuebal#1;
                  #cacuenta#5 = #cacuebal#2;
                  #cacuenta#6 = #cacuebal#3;
                  #cacuenta#7 = #cacuebal#4;
                  #cacuenta#8 = #cacuebal#5;
                  |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
      |SIGUE;
      |CIERRA #cacuebal;

      |PDEFECTO #cacuenta, 9, 54;

      #cacuenta#0 = Cuenta;
      #cacuenta#1 = Nivel;
      |SI #caenlace#3 = 0; |Y #caenlace#25 = "S"; || Estoy eliminando un asiento anterior ...
         nCalc = #caenlace#0; aAlfa = #caenlace#1; nCalc1 = #caenlace#2;
         |SALVA_FICHA #caenlace;
         |LEE 000#caenlace.s;
         |SI FSalida = 0; |Y nCalc = #caenlace#0; |Y aAlfa = #caenlace#1; |Y nCalc1 = #caenlace#2;
            aNombreCta = #caenlace#43;
            aNifCta    = #caenlace#44;
         |FINSI;
         |REPON_FICHA #caenlace;
      |FINSI;
      aAlfa = aNombreCta; |QBF aAlfa;
      |SI aAlfa ! ""; |Y #camaasil#19 = "F";
          #cacuenta#2 = aNombreCta;
      |FINSI;

      nNume1 = enNoEndatos;
      |SI enCaenlace ! 0; |Y nSwCliPro = 0;
          |SI #caenlace#10 ! "R"; |Y #caenlace#10 ! "S";
              #cacuenta#2 = #caenlace#43;
              enNoEndatos = 1;
          |FINSI;
      |FINSI;
      #cacuenta#3 = "S";
      |GRABA 020#cacuenta.b;

      |PUSHV 0501 2380;

      |PINPA #0#cacuenta; |PINDA #0#cacuenta;
      |SI enEjercicio ] 2008;
          nMensa9 = 1;
          |HAZ defect1;
      |FINSI;

      |SI enSwConfi ! 2; |Y enNoEndatos = 0;
          |ENDATOS #1#cacuenta;
      |SINO;
          FSalida = 0;
      |FINSI;
      |SI FSalida = 0;
         |GRABA 020#cacuenta.a;
         raf_oper  = 1;
         raf_desde = 1;
         |HAZ eOtraAlta;
         raf_desde = 0;
      |FINSI;
      |LIBERA #cacuenta;
      enNoEndatos = nNume1;
      nNume1 = enNoEndatos;
      |POPV;
   |FINSI;

   |PARA nCont = 6; |SI nCont ] 1; |HACIENDO nCont = nCont - 1;
      Calc = 13 + nCont;
      |SI #canempre#Calc# ! 0;
         Calc = 100 + #canempre#Calc#;
         Comodin = aCUENTA % Calc;
         #cacuenta#0 = Comodin;
         #cacuenta#1 = nCont;
         |LEE 101#cacuenta.=;
         |SI FSalida = 0;
            Comodin = #camaasil#1; |QBF Comodin;
            Comodin = Comodin % 0402; ComodNum = Comodin;
            CmpDebe = (ComodNum * 3) + 9;
            CmpHaber = CmpDebe + 1;
            CmpSaldo = CmpDebe + 2;
            |SI #camaasil#8 = "D";
                #cacuenta#CmpDebe# = #cacuenta#CmpDebe# + nImporte;
            |SINO;
                #cacuenta#CmpHaber# = #cacuenta#CmpHaber# + nImporte;
            |FINSI;
            #cacuenta#CmpSaldo# = #cacuenta#CmpDebe# - #cacuenta#CmpHaber#;

            CmpDebe = 0; CmpHaber = 0; CmpSaldo = 0;
            TotDebe = 0; TotHaber = 0; TotSaldo = 0;
            |PARA Cont = 12; |SI Cont [ 45; |HACIENDO Cont = Cont + 3;
                CmpDebe = Cont; CmpHaber = Cont + 1; CmpSaldo = Cont + 2;
                TotDebe  = TotDebe  + #cacuenta#CmpDebe#;
                TotHaber = TotHaber + #cacuenta#CmpHaber#;
                TotSaldo = TotSaldo + #cacuenta#CmpSaldo#;
            |SIGUE;

            #cacuenta#51 = #cacuenta#9 + TotDebe;
            #cacuenta#52 = #cacuenta#10 + TotHaber;
            #cacuenta#53 = #cacuenta#11 + TotSaldo;
            |SI #camaasic#1 > #cacuenta#58; #cacuenta#58 = #camaasic#1; |FINSI;

            |GRABA 020#cacuenta.a; |LIBERA #cacuenta;
         |FINSI;
      |FINSI;
   |SIGUE;
|FPRC;

|PROCESO BorraVacios;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 1;
   |LEE 000#camaasil.];
   |SI FSalida ! 0; |O #camaasil#0 ! #camaasic#0; |O #camaasil#1 ! #camaasic#1; |O #camaasil#2 ! #camaasic#2;
      |BORRA 020#camaasic.a;
   |FINSI;
|FPRC;

|DEFBUCLE BorraVacios;
#camaasic#1;
;
01, "01.01.0000", 000000;
99, "31.12.9999", 999999;
be;
NULL,BorraVacios;
|FIN;


|PROCESO AnadePrevios;
   aAlfa3 = "er" + Usuario; |NOME_DAT #caw000a0#aAlfa3#;
   |ABRE #caw000a0;
   |LEE 000#caw000a0.p;
   |SI FSalida ! 0;
      |CIERRA #caw000a0; |ACABA;
   |FINSI;

   nCuenta = 0;
   InError = nError1<-; IaError = aError1<-;
   |PARA; |SI nError ! 0; |HACIENDO;
      InError = InError + 1; IaError = IaError + 1;
      nCuenta = nCuenta + 1;
   |SIGUE;

   |SI nCuenta [ 499; |Y nError = 0;
      |LEE 000#caw000a0.p;
      |PARA; |SI FSalida = 0; |Y nCuenta [ 499; |HACIENDO nCuenta = nCuenta + 1;
         |SI #caw000a0#1 = "C";
            nError = 999;
            nCriticos = nCriticos + 1;
         |SINO;
            nError = 1999;
            nAvisos = nAvisos + 1;
         |FINSI;
         aError = #caw000a0#2;
         InError = InError + 1; IaError = IaError + 1;
         |LEE 000#caw000a0.s;
      |SIGUE;
   |FINSI;
   |CIERRA #caw000a0; |DELINDEX #caw000a0;
|FPRC;

|PROCESO PasaATxt;
   aAlfa1 = ("00" + #caenlace#0) % -102;        aAlfa = aAlfa1 + ";";
   aAlfa1 = #caenlace#1;                        aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000000" + #caenlace#2) % -106;    aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("0000" + #caenlace#3) % -104;      aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#4;                        aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#5;                        aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000" + #caenlace#6) % -103;       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#7;                        aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#8;                        aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = (("0" * 14) + #caenlace#9) % -114;  aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#10;                       aAlfa = aAlfa + aAlfa1 + ";";
   |XGRABA nHandle, aAlfa; aAlfa = "";

   aAlfa1 = ("00" + #caenlace#11) % -102;       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#12;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000000" + #caenlace#13) % -106;   aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000" + #caenlace#14) % -103;      aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#15;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = (("0" * 10) + #caenlace#16) % -110; aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = (("0" * 10) + #caenlace#17) % -110; aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#18;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#19;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#20;                       aAlfa = aAlfa + aAlfa1 + ";";
   |XGRABA nHandle, aAlfa; aAlfa = "";

   aAlfa1 = #caenlace#21;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#22;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#23;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#24;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#25;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#26;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("00" + #caenlace#27) % -102;       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("00000" + #caenlace#28) % -105;    aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#29;                       aAlfa = aAlfa + aAlfa1 + ";";
   |XGRABA nHandle, aAlfa; aAlfa = "";

   aAlfa1 = #caenlace#30;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#31;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#32;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("00000" + #caenlace#33) % -105;    aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("00" + #caenlace#34) % -102;       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#35;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000000" + #caenlace#36) % -106;   aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("00000" + #caenlace#37) % -105;    aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#38;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#39;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#40;                       aAlfa = aAlfa + aAlfa1 + ";";
   |XGRABA nHandle, aAlfa; aAlfa = "";

   aAlfa1 = ("00000" + #caenlace#41) % -105;    aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = (("0" * 12) + #caenlace#42) % -110; aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#43;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#44;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#45;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#46;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = ("000000" + #caenlace#47) % -106;   aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#48;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#49;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#50;                       aAlfa = aAlfa + aAlfa1 + ";";
   |XGRABA nHandle, aAlfa; aAlfa = "";

   aAlfa1 = #caenlace#51;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa1 = #caenlace#52;                       aAlfa = aAlfa + aAlfa1 + ";";
   aAlfa = aAlfa + &13 + &10;
   |XGRABA nHandle, aAlfa; aAlfa = "";
|FPRC;

|DEFBUCLE PasaATxt;
#caenlace#1;
;
INICIO;
FINAL;
;
NULL, PasaATxt;
|FIN;

|PROCESO GrabaTxt;
   |SI enSwExport = 0; |ACABA; |FINSI;

   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "enlaces/"; |MKDIR aAlfa;
   fFecha = ~; aAlfa1 = fFecha;
   ||aAlfa1 = (aAlfa1 % -104) + (aAlfa1 % 0402) + (aAlfa1 % 0102);
   aAlfa1 = (aAlfa1 % 0102) + (aAlfa1 % 0402) + (aAlfa1 % -104);
   aAlfa = aAlfa + (("00000" + #canempre#2) % -105) + #canempre#3 + aAlfa1;
   |HORA aAlfa1; |QBF aAlfa1;
   aAlfa1 = (aAlfa1 % 0102) + (aAlfa1 % 0402) + (aAlfa1 % 0702);
   aAlfa = aAlfa + aAlfa1 + ".txt";

   |XABRE "WB", aAlfa, nHandle;
   |SI FSalida ] 0; |BUCLE PasaATxt; |FINSI;
   |XCIERRA nHandle;
|FPRC;

|PROGRAMA;
   nSwAutoDG  = 0;
   nSwAutoDE  = 0;
   nSwRecalcIva = 0;
   nDDiario   = 99;
   nHDiario   = 0;
   fDFecha    = "31.12.9999";
   fHFecha    = "01.01.0000";
   nDDocum    = 999999;
   nHDocum    = 0;

   |SI PRMNT_enVer ! 2; |Y PRMNT_enVer ! 0;
      |SI enSwMensajes = 0;
          |MENAV "    Error. Necesita actualizar la version del programa que enlaza";
          |MENAV "    No se efectuara el enlace";
      |FINSI;

      PRMNT_enError = -1;
      |ERROR;
      |ACABA;
   |FINSI;

   aNombreUsr = Usuario % 0810; |QBF aNombreUsr;

   eaNomFich  = ("0p" + Usuario) % 108;
   |NOME_DAT #caivatm4#eaNomFich#;
   |DELINDEX #caivatm4;

   |HAZ DirAplicSt;

   |SI enPosic = 0; enPosic = 22; |FINSI;

   Path = PARAMETRO;
   Path = Path - ",";
   |SI FSalida ! 0;
      Calc = FSalida + 98;
      aNombre = Path % Calc; Path = Path - aNombre;
   |FINSI;

   |PATH_DAT #0  Path;
   |SI eaFicRegNif = "";
       eaFicRegNif = Path;
   |FINSI;

   |ABRET #dsapunte;
   dirfich0 = Path;
   Respuesta = "";
   |PARA; |SI; |HACIENDO;
      |LEE 000#dsapunte.p;
      |SI FSalida ! 0;
         |SI FSalida = 102; |SAL; |FINSI;
         |DDEFECTO #dsapunte;
         |GRABA 020#dsapunte.n;
         |LEE 000#dsapunte.p;
      |FINSI;
      |SI #dsapunte#1 = "N";
         |LEE 101#dsapunte.p;
         |SI FSalida = 0;
            #dsapunte#1 = "S";
            #dsapunte#2 = ~;
            |HORA Comodin; Comodin = Comodin % 0105; #dsapunte#3 = Comodin;
            Comodin = Usuario % 0810; #dsapunte#4 = Comodin;
            |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
            |SI enSwMensajes = 0;
               nCalcPosic = ((enPosic + 1) * 100) + 7;
               |ATRI N;|PINTA nCalcPosic,"                                      "; |ATRI N;
            |FINSI;
            |SAL;
         |FINSI;
      |SINO;
         FechaHoy = ~;  FechaEnl = #dsapunte#2;
         |HORA Comodin;
         Comodin1 = Comodin % 0102; Hora        = Comodin1;
         Comodin1 = Comodin % 0402; Minutos     = Comodin1;
         Comodin1 = Comodin % 0702; Segundos    = Comodin1;
         |SI HoraEnl = 0; |Y MinutosEnl = 0; |Y SegundosEnl = 0;
            |HORA Comodin; |QBF Comodin;
            Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
            Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
            Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
            SegundosEnl = SegundosEnl + 30;
            |SI SegundosEnl ] 60;
               MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
               |SI MinutosEnl ] 60;
                  HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
               |FINSI;
            |FINSI;
         |SINO;
            |SI Cambiante ! #dsapunte#5;
                Cambiante = #dsapunte#5;
                |HORA Comodin; |QBF Comodin;
                Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
                Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
                Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
                SegundosEnl = SegundosEnl + 30;
                |SI SegundosEnl ] 60;
                   MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
                   |SI MinutosEnl ] 60;
                      HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
                  |FINSI;
                |FINSI;
            |SINO;
               Comodin  = (("00" + Hora)    % -102) + (("00" + Minutos)    % -102) + (("00" + Segundos)    % -102);
               Comodin1 = (("00" + HoraEnl) % -102) + (("00" + MinutosEnl) % -102) + (("00" + SegundosEnl) % -102);
               |SI FechaHoy = FechaEnl; |Y Comodin1 ] Comodin;
                  |SI enSwMensajes = 0;
                     nCalcPosic = ((enPosic + 1) * 100) + 7;
                     |ATRI I; |PINTA nCalcPosic, "Enlace Bloqueado, Espere por favor .. "; |ATRI N;
                  |FINSI;
               |SINO;
                  |SI Respuesta = "";
                     |PUSHV 0501 2380;
                     |DDEFECTO #caw00062;
                     #caw00062#0 = #dsapunte#2;
                     #caw00062#1 = #dsapunte#3;
                     #caw00062#2 = #dsapunte#4;
                     |PINPA #0#caw00062; |PINDA #0#caw00062;
                     |ENDATOS #1#caw00062;
                     |SI FSalida = 0;
                        |SI #caw00062#3 = "SI";
                           #dsapunte#1 = "S";
                           #dsapunte#2 = ~;
                           |HORA Comodin; Comodin = Comodin % 0105;
                           #dsapunte#3 = Comodin;
                           #dsapunte#4 = Usuario % 0810;
                           |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
                           |SAL;
                           Respuesta = "SI";
                        |SINO;
                           Respuesta = "";
                        |FINSI;
                     |SINO;
                        Respuesta = "";
                     |FINSI;
                     |POPV;
                  |SINO;
                     |SI enSwMensajes = 0;
                        nCalcPosic = ((enPosic + 1) * 100) + 7;
                        |ATRI I; |PINTA nCalcPosic, "Enlace Bloqueado, Espere por favor .. "; |ATRI N;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SIGUE;

   |PATH_DAT #caenlace#Path#;
   |PATH_DAT #camaasic#Path#;
   |PATH_DAT #camaasil#Path#;
   |PATH_DAT #cacuenta#Path#;
   |PATH_DAT #camandia#Path#;

   |PATH_DAT #camaniva#Path#;
   |PATH_DAT #caivalin#Path#;
   |PATH_DAT #casiim01#Path#;
   |PATH_DAT #casiim02#Path#;
   |PATH_DAT #caivaasi#Path#;
   |PATH_DAT #calibros#Path#;
   |PATH_DAT #caclipro#Path#;
   |PATH_DAT #cadeflab#Path#;
   |PATH_DAT #cacuebal#Path#;
   |PATH_DAT #caagrupa#Path#;
   |PATH_DAT #caepigra#Path#;
   |PATH_DAT #anm00001#Path#;
   |PATH_DAT #caw000a0#Path#;
   |PATH_DAT #camanads#Path#;

   Comodin = Path % -107;
   Path = Path - Comodin;
   |PATH_DAT #canempre#Path#;
   Path = PARAMETRO; Path = Path - ","; Path = Path - aNombre;

   nContError = 0; nTotalErr = 499;
   |PARA nCalc = 0; |SI nCalc [ 19; |HACIENDO nCalc = nCalc + 1;
      InError = nError1<-;       IaError = aError1<-;
      InError = InError + nCalc; IaError = IaError + nCalc;
      nError = 0; aError = "";
   |SIGUE;
   InError = nError1<-; IaError = aError1<-;

   enNoBloq = 1;
   Comodin = fich_alta; |QBF Comodin;
   |SI Comodin = "";
      fich_alta = Path;
      |HAZ inicio;
      fich_alta = "";
   |SINO;
      |HAZ inicio;
   |FINSI;
   dirfich0 = Path;
   enNoBloq = 0;

   |SI aNombre ! ""; |NOME_DAT #caenlace#aNombre#; |FINSI;

   |ABRE #caenlace;

/*
   |CONSULTA_CLAVE #1#caenlace;
*/

   |ABRE #camaasic;
   |ABRE #calicont;
   |ABRE #camaasil;
   |ABRE #cacuenta;
   |ABRE #camandia;
   |ABRE #canempre;
   |ABRE #camaniva;
   |ABRE #caivalin;
   ||ABRE #caivases;
   |ABRE #cadeflab;

   Comodin = PARAMETRO; |QBF Comodin;
   |SI aNombre ! ""; Comodin = Comodin - ","; Comodin = Comodin - aNombre; |FINSI;
   Comodin = Comodin % -107;
   Comodin = Comodin - "/";
   |SI Comodin ! "000000";
      nNoComp = 0;
      Comodin1 = Comodin % 0105; #canempre#2 = Comodin1;
      Comodin1 = Comodin % -101; #canempre#3 = Comodin1;
      |LEE 000#canempre.=;
      |SI FSalida = 0;
         Dig1 = #canempre#14; Dig2 = #canempre#15; Dig3 = #canempre#16;
         Dig4 = #canempre#17; Dig5 = #canempre#18; Dig6 = #canempre#19;
         MaxNiv = #canempre#13;
      |SINO;
         nCriticos = nCriticos + 1;
         nError = 1; aAlfa = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " no existe";
         aError = aAlfa;
         |SI nContError < nTotalErr;
            InError = InError + 1; IaError = IaError + 1;
            nContError = nContError + 1;
         |FINSI;
      |FINSI;
   |SINO;
      nNoComp = 1;
   |FINSI;

   |LEE 000#cadeflab.p;
   |SI FSalida ! 0;
      |DDEFECTO #cadeflab;
      |GRABA 020#cadeflab.n;
      |LEE 000#cadeflab.p;
   |FINSI;

   Contador = 0;

   PRMNT_enError = 0;

   |SI PRMNT_enError = 0;
      |ABRE #anm00001; |ABRE #anm00000;

      |LEE 000#anm00000.p;
      |SI FSalida ! 0; |DDEFECTO #anm00000; |FINSI;
      |SI #anm00000#1 = "N";
          nAnalitica = 0;
      |SINO;
          nAnalitica = 1;
          |SI #anm00000#11 = "E";
             |ABRE #anm00016;
             #anm00016#0 = enEmpresa;
             |LEE 001#anm00016.=;
             |SI FSalida ! 0;
                 nAnalitica = 0;
             |FINSI;
             |CIERRA #anm00016;
         |FINSI;
      |FINSI;

      nAntDia = 0; aAntFec = "01.01.0000"; nAntDoc = -1;
      nComp1 = 0; fComp2 = @; nComp3 = 0; nComp4 = 0; nComp5 = 0;
      |BUCLE Comprobar; nTotalDoc = nTotalDoc ! 2;
      |SI nTotalDoc ! 0;
         |SI PRMNT_enSwTaller = 1; |Y nTotalDoc [ 0.02;
               ||Es correcto. Descuadre menor o igual a 2 centimos.
         |SINO;
              nError = 1004; nAvisos = nAvisos + 1;
              |HAZ AvisoEmp;
              aAlfa1 = nAntDia; |QBF aAlfa1;
              aAlfa2 = aAlfa2 + "El asiento " + (("00" + aAlfa1) % -102) + "/";
              aAlfa1 = aAntFec; |QBF aAlfa1;
              aAlfa2 = aAlfa2 + aAlfa1 + "/";
              aAlfa1 = nAntDoc; |QBF aAlfa1;
              aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta descuadrado [ Descuadre : " + nTotalDoc + " ]";
              aError = aAlfa2;
              |SI nContError < nTotalErr;
                 InError = InError + 1; IaError = IaError + 1;
                 nContError = nContError + 1;
              |FINSI;
         |FINSI;
         || Fecha del asiento fuera del periodo
         aAlfa = #caenlace#1; |QBF aAlfa;
         aAlfa = aAlfa % 0902; nCalc = aAlfa;
         nSwFuera = 0; |SI #caenlace#1 < fec1; |O #caenlace#1 > fec2; nSwFuera = 1; |FINSI;
                         ||  .... ... |SI nCalc ! #canempre#26; |Y nNoComp = 0;
         |SI nSwFuera = 1; |Y nNoComp = 0;
            nError = 1005; nAvisos = nAvisos + 1;
            |HAZ AvisoEmp;
            aAlfa1 = #caenlace#0; |QBF aAlfa1;
            aAlfa2 = aAlfa2 + "El asiento " + (("00" + aAlfa1) % -102) + "/";
            aAlfa1 = #caenlace#1; |QBF aAlfa1;
            aAlfa2 = aAlfa2 + aAlfa1 + "/";
            aAlfa1 = nAntDoc; |QBF aAlfa1;
            aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta fuera del ejercicio de esta empresa";
            aError = aAlfa2;
            |SI nContError < nTotalErr;
               InError = InError + 1; IaError = IaError + 1;
               nContError = nContError + 1;
            |FINSI;
            nError = 9999;
            aAlfa2 = " En caso de seguir adelante con el enlace no se pasara este asiento ";
            aError = aAlfa2;
            |SI nContError < nTotalErr;
               InError = InError + 1; IaError = IaError + 1;
               nContError = nContError + 1;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #anm00000; |CIERRA #anm00001;

      |HAZ AnadePrevios;

      |PATH_DAT #dscom001#Path#; |PATH_DAT #dscom002#Path#;
      |ABRE #dscom001; |ABRE #dscom002;
      |LEE 000#dscom002.p;
      |SI FSalida ! 0; |DDEFECTO #dscom002; |FINSI;
      |SI #dscom002#1 = "S";
         |SI nCriticos > 0; |O nAvisos > 0;
            fFecha = ~; |HORA aHora; |QBF aHora;
            aAlfa1 = fFecha; |QBF aAlfa1;
            aAlfa1 = (aAlfa1 % 0704) + (aAlfa1 % 0402) + (aAlfa1 % 0102);
            aAlfa1 = aAlfa1 + (aHora % 0102) + (aHora % 0402) + (aHora % 0702);
            aAlfa = Path; |QBF aAlfa;
            aAlfa = aAlfa + "Notif"; |MKDIR aAlfa;
            aAlfa = aAlfa + "/" + aAlfa1 + ".txt"; aFichero = aAlfa;
            |XABRE "A", aAlfa, nHandle;
            |SI FSalida ] 0;
               aMensaje = " " + ("*" * 78); |XGRABA nHandle, aMensaje;
               aMensaje = "                    ERRORES ENCONTRADOS EN EL ENLACE                    ";
               |XGRABA nHandle, aMensaje;
               aMensaje = " " + ("*" * 78); |XGRABA nHandle, aMensaje;
               aMensaje = " "; |XGRABA nHandle, aMensaje;
               |QBF eaEmpProced;
               |SI eaEmpProced ! "";
                  aMensaje = eaEmpProced; |XGRABA nHandle, aMensaje;
                  aMensaje = " "; |XGRABA nHandle, aMensaje;
               |FINSI;
               |SI nAvisos > 0;
                  aMensaje = "      Errores de aviso "; |XGRABA nHandle, aMensaje;
                  aMensaje = "      ---------------- "; |XGRABA nHandle, aMensaje;
                  InError = nError1<-; IaError = aError1<-;
                  |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO nContError = nContError + 1;
                     |SI nError = 0; |O nContError > 499; |SAL; |FINSI;
                     |SI nError ] 1000;
                        |SI nError ! 9999;
                            aMensaje = "        " + (("00000" + nError) % -105);
                        |SINO;
                            aMensaje = "             ";
                        |FINSI;
                        aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                        |XGRABA nHandle, aMensaje;
                     |FINSI;
                     InError = InError + 1; IaError = IaError + 1;
                  |SIGUE;
                  aMensaje = " "; |XGRABA nHandle, aMensaje;
               |FINSI;
               |SI nCriticos > 0;
                  aMensaje = "      Errores criticos "; |XGRABA nHandle, aMensaje;
                  aMensaje = "      ---------------- "; |XGRABA nHandle, aMensaje;
                  InError = nError1<-; IaError = aError1<-;
                  |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO nContError = nContError + 1;
                     |SI nError = 0; |O nContError > 499; |SAL; |FINSI;
                     |SI nError < 1000; |Y nError > 0;
                        |SI nError ! 9999;
                            aMensaje = "        " + (("00000" + nError) % -105);
                        |SINO;
                            aMensaje = "             ";
                        |FINSI;
                        aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                        |XGRABA nHandle, aMensaje;
                     |FINSI;
                     InError = InError + 1; IaError = IaError + 1;
                  |SIGUE;
               |FINSI;
            |FINSI;
            |XCIERRA nHandle;

            aDsCorreoIP = #dscom002#7 + "." + #dscom002#8 + "." + #dscom002#9 + "." + #dscom002#10;
            aDirOrigen  = #dscom002#15;
            |SI #dscom002#11 = "S";
               aAlfa4 = #dscom002#14; |HAZ Encripta; |QBF aAlfa4;
               aAlfa4 = aAlfa4 + ":";
               aAlfa4 = aAlfa4 + #dscom002#12; |QBF aAlfa4;
               aAlfa4 = aAlfa4 + ":";
               aDirOrigen = aAlfa4 + aDirOrigen;
            |FINSI;
            aServidor   = #dscom002#16; |QBF aServidor;
            aAsunto     = " Notificacion avisos en enlace contable ";
            aTexto      = "$$$$" + aFichero;
            nSwErr      = -1;

            |PARA nCont2 = 2; |SI nCont2 [ 6; |HACIENDO nCont2 = nCont2 + 1;
               aAlfa = #dscom002#nCont2#; |QBF aAlfa;
               |SI aAlfa ! "";
                  aDirDestino = #dscom002#nCont2#;
                  |DSCORREO_ENVIA aDsCorreoIP, aServidor, aDirOrigen, aDirDestino, aAsunto, aTexto, aFichero;
                  |SI FSalida < 0;
                     |SI enSwMensajes = 0;
                         |MENAV "    Problemas al enviar correo";
                     |FINSI;
                     |SI nSwErr ! 0; nSwErr = 1; |FINSI;
                  |SINO;
                     nSwErr = 0;
                  |FINSI;
               |FINSI;
            |SIGUE;

            fFecha = ~; |HORA aAlfa; |QBF aAlfa; aAlfa = aAlfa % 0105;
            |LEE 000#dscom001.u; nLinea1 = #dscom001#0 + 1;

            |DDEFECTO #dscom001;
            #dscom001#0 = nLinea1;
            |GRABA 020#dscom001.b;

            #dscom001#1 = fFecha;
            #dscom001#2 = aAlfa;
            #dscom001#3 = Usuario % 0810;
            #dscom001#4 = aFichero;
            |SI nSwErr = 0;
               #dscom001#5 = "S";
            |SINO;
               #dscom001#5 = "N";
            |FINSI;
            |GRABA 020#dscom001.a; |LIBERA #dscom001;
         |FINSI;
      |FINSI;
      |CIERRA #dscom002;

      |SI nCriticos > 0;
         |SI aNombreUsr ! "batch"; |Y enSwConfi = 0;
            |CONFI "    NSe han encontrado errores criticos. Imprimirlos ?";
         |SINO;
            FSalida = 1;
         |FINSI;
         |SI FSalida = 0;
            |SI enSwConfi ! 2;
                |IMPRE 0;
                |SI FSalida ! 0; |VETE Final; |FINSI;
            |FINSI;
            || Imprime el informe
            aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
            aMensaje = "                    ERRORES ENCONTRADOS EN EL ENLACE                    ";
            |IMPRIME aMensaje;
            aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
            aMensaje = ""; |IMPRIME aMensaje;
            |QBF eaEmpProced;
            |SI eaEmpProced ! "";
               aMensaje = eaEmpProced; |IMPRIME aMensaje;
               aMensaje = " "; |IMPRIME aMensaje;
            |FINSI;
            |SI nAvisos > 0;
               aMensaje = "      Errores de aviso "; |IMPRIME aMensaje;
               aMensaje = "      ---------------- "; |IMPRIME aMensaje;
               InError = nError1<-; IaError = aError1<-;
               |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO nContError = nContError + 1;
                  |SI nError = 0; |O nContError > 499; |SAL; |FINSI;
                  |SI nError ] 1000;
                     |SI nError ! 9999;
                         aMensaje = "        " + (("00000" + nError) % -105);
                     |SINO;
                         aMensaje = "             ";
                     |FINSI;
                     aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                     |IMPRIME aMensaje;
                  |FINSI;
                  InError = InError + 1; IaError = IaError + 1;
               |SIGUE;
               aMensaje = ""; |IMPRIME aMensaje;
            |FINSI;
            aMensaje = "      Errores criticos "; |IMPRIME aMensaje;
            aMensaje = "      ---------------- "; |IMPRIME aMensaje;
            InError = nError1<-; IaError = aError1<-;
            |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO nContError = nContError + 1;
               |SI nError = 0; |O nContError > 499; |SAL; |FINSI;
               |SI nError < 1000; |Y nError > 0;
                  |SI nError ! 9999;
                      aMensaje = "        " + (("00000" + nError) % -105);
                  |SINO;
                      aMensaje = "             ";
                  |FINSI;
                  aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                  |IMPRIME aMensaje;
               |FINSI;
               InError = InError + 1; IaError = IaError + 1;
            |SIGUE;
            |SI enSwConfi ! 2;
                |FINIMP;
            |FINSI;
         |FINSI;
         PRMNT_enError = -1;

         |SI enSwMensajes = 0;
             |MENAV "    No se efectuara el enlace"; |VETE Final;
         |FINSI;
      |SINO;
         |SI nAvisos > 0;
            |SI aNombreUsr ! "batch"; |Y enSwConfi = 0;
               |SI enCaenlace < 2;
                   |CONFI "    NImprimir los errores de aviso encontrados ?";
               |SINO;
                   FSalida = 1;
               |FINSI;
            |SINO;
               FSalida = 1;
            |FINSI;
            |SI FSalida = 0;
               |SI enSwConfi ! 2;
                   |IMPRE 0;
                   |SI FSalida ! 0; |VETE Final; |FINSI;
               |FINSI;
               || Imprime el informe
               aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
               aMensaje = "                    ERRORES ENCONTRADOS EN EL ENLACE                    ";
               |IMPRIME aMensaje;
               aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
               aMensaje = ""; |IMPRIME aMensaje;
               |QBF eaEmpProced;
               |SI eaEmpProced ! "";
                  aMensaje = eaEmpProced; |IMPRIME aMensaje;
                  aMensaje = " "; |IMPRIME aMensaje;
               |FINSI;
               aMensaje = "      Errores de aviso "; |IMPRIME aMensaje;
               aMensaje = "      ---------------- "; |IMPRIME aMensaje;
               InError = nError1<-; IaError = aError1<-;
               |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO nContError = nContError + 1;
                  |SI nError = 0; |O nContError > 499; |SAL; |FINSI;
                  |SI nError ! 9999;
                      aMensaje = "        " + (("00000" + nError) % -105);
                  |SINO;
                      aMensaje = "             ";
                  |FINSI;
                  aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                  |IMPRIME aMensaje;
                  InError = InError + 1; IaError = IaError + 1;
               |SIGUE;
               |SI enSwConfi ! 2;
                   |FINIMP;
               |FINSI;
            |FINSI;
            |SI aNombreUsr ! "batch"; |Y enSwConfi = 0;
                |SI enCaenlace < 2;
                    |CONFI "    NContinuar con el enlace ?";
                |SINO;
                    FSalida = 0;
                |FINSI;
            |SINO;
               |SI enSwConfi = 1;
                  FSalida = 1;
               |SINO;
                  FSalida = 0;
               |FINSI;
            |FINSI;
            |SI FSalida ! 0;
               enNoEndatos = 100;   || Salida para Mantas Mora
               PRMNT_enError = -2; |VETE Final;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

  |SI enCaenlace = 1; |VETE Final; |FINSI;

   |DBASE aAlfa; |QBF aAlfa;
   aDef = aAlfa + "def/caenlace.mas";
   |CARGA_DEF aDef, caenlac@;
   |SI FSalida ! 0;
       |SI enSwMensajes = 0;
           |MENAV "0000Error al Cargar el Def Caenlace.";
       |FINSI;
       |ACABA;
   |FINSI;
   |PATH_DAT #caenlac@#Path#;

   |SI aNombre ! "";
       |NOME_DAT #caenlac@#aNombre#;
   |FINSI;

  |ABRE #camanads;
  |LEE 041#camanads.p;
  |SI FSalida = 0;
      nSwAutoDE = 1;
  |FINSI;
  |CIERRA #camanads;
  |ABRE #caivaasi;
  |DDEFECTO #caivaasi;
  |LEE 000#caivaasi.p;
  |CIERRA #caivaasi;

  |PATH_DAT #camaasic#Path#;
  |ABRE #camaasic;

   nPrimero = 1;
   |SI eaProcedencia = "FACTURAR";
      |BUCLE Asientos2;
      |SI nLibro ! 0; |O nDocum ! 0; |HAZ RevisaAnt; |FINSI;
      |HAZ NuevoDoc;
   |SINO;
      |BUCLE Asientos1;
      |SI nLibro ! 0; |O nDocum ! 0; |HAZ RevisaAnt; |FINSI;
   |FINSI;

   |HAZ GrabaTxt;

   |DESCARGA_DEF #caenlac@;

|ET Final;

   |CIERRA #cadeflab;
   |CIERRA #caivases;
   |CIERRA #caivalin;
   |CIERRA #camaniva;
   |CIERRA #canempre;
   |CIERRA #camandia;
   |CIERRA #cacuenta;
   |CIERRA #camaasil;
   |CIERRA #calicont;
   |CIERRA #camaasic;
   |CIERRA #caenlace;

   |SI nSwRecalcIva = 1;
      |ABRE #caivaasi; |LEE 000#caivaasi.p; |CIERRA #caivaasi;
      |SI #caivaasi#148 = "S";
         aAlfa = "caz00036.tab;" + (("00" + nDDiario) % -102);
         aAlfa = aAlfa + fDFecha + (("000000" + nDDocum) % -106);
         aAlfa = aAlfa + (("00" + nHDiario) % -102);
         aAlfa = aAlfa + fHFecha + (("000000" + nHDocum) % -106);
         |SUB_EJECUTA aAlfa;
      |FINSI;
   |FINSI;

   |SI nSwAutoDG = 1;
       |SUB_EJECUTA_NP "caut0017;PASE";
   |FINSI;

   |SUB_EJECUTA_NP "caut0018;PASE";

   |SI PRMNT_enLuxeRec = 1;
      eaParam = PARAMETRO;
      |SUB_EJECUTA "caz00041";
   |FINSI;

   |LEE 101#dsapunte.p;
   |SI FSalida = 0;
      #dsapunte#1 = "N";
      |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
   |FINSI;
   |CIERRAT #dsapunte;
|FPRO;
