|FICHEROS;
   capasvip #0;
   capasvtm #10;
   capasvt1 #11;
|FIN;

|VARIABLES;
   aAlfa     = "";
   aAlfa1    = "";
   aChar     = "";
   aMes      = "";
   aFecha    = "";
   aContCol  = "";
   aIP       = "";

   nContador = 0;
   nAsiento  = 0;
   nHandle   = 0;
   nContFila = 0;
   nBlancos  = 0;
   nPrimero  = 0;
|FIN;

|PROCESO MiraFichero;
   |SI FSalida = 2; |ACABA; |FINSI;
   aAlfa = #0Campo; |QBF aAlfa;
   |XABRE "CE", aAlfa, nHandle;
   |SI FSalida < 0;
      |MENAV "    Fichero inexistente"; |ERROR;
   |FINSI;
|FPRC;

|PROCESO CopiaFichero;
   aIP = ""; |IP_REMOTO aIP;
   |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "vacia.xls";
   aAlfa1 = "c:\temp"; |RMKDIR aAlfa1;
   aAlfa1 = "c:\temp\vacia.xls"; |QBF aAlfa1;
   |SI aIP ! "";
      |ENVIA_FICHERO aAlfa, aAlfa1;
   |SINO;
      |COPIA_FICHERO aAlfa, aAlfa1;
   |FINSI;
|FPRC;

|PROCESO LeeDiario;
   aAlfa = "    Leyendo mes de " + aMes; |MENSA aAlfa;

   |ALFACALLDLL "agixl97.dll", "selecciona_hoja", aMes;

   nContFila = 1; nBlancos = 0; nContador = 1;
   aFecha = ""; nAsiento = 0;

   |PARA; |SI; |HACIENDO;
      aAlfa = "A" + nContFila;
      |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
      aAlfa1 = aAlfa % 0106;
      |SI aAlfa1 = "Fecha:";
         aAlfa1 = aAlfa - "Fecha: "; aFecha = aAlfa1;
         aAlfa = "G" + nContFila;
         |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
         aAlfa1 = aAlfa - "NO.ASIENTO: ";
         nAsiento = aAlfa1;
         nContador = 1;
      |SINO;
         |SI aAlfa = "";
            nBlancos = nBlancos + 1;
            |SI nBlancos > 10; |SAL; |FINSI;
         |SINO;
            nBlancos = 0;
            |SI aFecha ! "";
               |DDEFECTO #capasvtm;
               #capasvtm#0 = aFecha;
               #capasvtm#1 = nAsiento;
               #capasvtm#2 = nContador; nContador = nContador + 1;
               aAlfa = "A" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#3 = aAlfa;
               aAlfa = "B" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#4 = aAlfa;
               aAlfa = "C" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#5 = aAlfa;
               aAlfa = "D" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#6 = aAlfa;
               aAlfa = "E" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#7 = aAlfa;
               aAlfa = "F" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#8 = aAlfa;
               aAlfa = "G" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#9 = aAlfa;
               aAlfa = "H" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#10 = aAlfa;
               aAlfa = "I" + nContFila; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
               #capasvtm#11 = aAlfa;
               |GRABA 020#capasvtm.n;
            |FINSI;
         |FINSI;
      |FINSI;
      nContFila = nContFila + 1;
   |SIGUE;
|FPRC;

|PROCESO GrabaDiario;
   aAlfa1 = #capasvtm#0; |QBF aAlfa1;
   aAlfa1 = (aAlfa1 % 0102) + "." + (aAlfa1 % 0402) + "." + (aAlfa1 % 0704);
   aAlfa = "A" + nContFila + "," + aAlfa1;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "B" + nContFila + "," + #capasvtm#1;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "C" + nContFila + "," + #capasvtm#2;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "D" + nContFila + "," + #capasvtm#3;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "E" + nContFila + "," + #capasvtm#4;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "F" + nContFila + "," + #capasvtm#5;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "G" + nContFila + "," + #capasvtm#6;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "H" + nContFila + "," + #capasvtm#7;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "I" + nContFila + "," + #capasvtm#8;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "J" + nContFila + "," + #capasvtm#9;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "K" + nContFila + "," + #capasvtm#10;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "M" + nContFila + "," + #capasvtm#11;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;

   |SI #capasvtm#11 ! 0;
      aAlfa = "H";
   |SINO;
      aAlfa = #capasvtm#4; |QBF aAlfa;
      |SI aAlfa = "HABER";
         aAlfa = "H";
      |SINO;
         aAlfa = "D";
      |FINSI;
   |FINSI;
   aAlfa = "N" + nContFila + "," + aAlfa;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = #capasvtm#7; |QBF aAlfa;
   |SI aAlfa = "";
      aAlfa = #capasvtm#8; |QBF aAlfa;
   |FINSI;
   aAlfa = "O" + nContFila + "," + aAlfa;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;

   nContFila = nContFila + 1;
|FPRC;

|DEFBUCLE GrabaDiario;
#capasvtm#1;
;
INICIO;
FINAL;
;
NULL,GrabaDiario;
|FIN;

|PROCESO GrabaCliPro;
   aAlfa1 = #capasvt1#0; |QBF aAlfa1;
   aAlfa = "A" + nContFila + "," + aAlfa1;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "B" + nContFila + "," + #capasvt1#1;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "C" + nContFila + "," + #capasvt1#2;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "D" + nContFila + "," + #capasvt1#3;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "E" + nContFila + "," + #capasvt1#4;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "F" + nContFila + "," + #capasvt1#5;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "G" + nContFila + "," + #capasvt1#6;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "H" + nContFila + "," + #capasvt1#7;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "I" + nContFila + "," + #capasvt1#8;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "J" + nContFila + "," + #capasvt1#9;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "K" + nContFila + "," + #capasvt1#10;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;
   aAlfa = "M" + nContFila + "," + #capasvt1#11;
   |ALFACALLDLL "agixl97.dll", "poke_dato", aAlfa;

   nContFila = nContFila + 1;
|FPRC;

|DEFBUCLE GrabaCliPro;
#capasvt1#1;
;
INICIO;
FINAL;
;
NULL,GrabaCliPro;
|FIN;

|PROCESO Tipo3;
   |DELINDEX #capasvtm; |ABRE #capasvtm;
   |DELINDEX #capasvt1; |ABRE #capasvt1;
   |HAZ CopiaFichero;

   |CARGADLL "agixl97.dll";
   |SI FSalida < 0;
      |MENAV "0000No se puede usar agixl97.dll";
   |SINO;
      aAlfa = #capasvip#0; |QBF aAlfa;
      |ALFACALLDLL "agixl97.dll", "carga_book", aAlfa;
      aMes = "Enero";      |HAZ LeeDiario;
      aMes = "Febrero";    |HAZ LeeDiario;
      aMes = "Marzo";      |HAZ LeeDiario;
      aMes = "Abril";      |HAZ LeeDiario;
      aMes = "Mayo";       |HAZ LeeDiario;
      aMes = "Junio";      |HAZ LeeDiario;
      aMes = "Julio";      |HAZ LeeDiario;
      aMes = "Agosto";     |HAZ LeeDiario;
      aMes = "Septiembre"; |HAZ LeeDiario;
      aMes = "Octubre";    |HAZ LeeDiario;
      aMes = "Noviembre";  |HAZ LeeDiario;
      aMes = "Diciembre";  |HAZ LeeDiario;
      |ALFACALLDLL "agixl97.dll", "fin_book", "salva";

      aAlfa = "c:\temp\vacia.xls"; |QBF aAlfa;
      |ALFACALLDLL "agixl97.dll", "carga_book", aAlfa;
      |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";
      |SI FSalida = 0;
         nContFila = 1;
         |MENSA "    Grabando temporal";
         |BUCLE GrabaDiario;
         aAlfa1 = #0#1; |QBF aAlfa1; |RFBORRA aAlfa1;
         |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa1;
         |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
      |FINSI;

      |HAZ CopiaFichero;
      aAlfa = #capasvip#3; |QBF aAlfa;
      |ALFACALLDLL "agixl97.dll", "carga_book", aAlfa;
      |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";

      nContFila = 1; nPrimero = 1; nBlancos = 0;
      |PARA; |SI nBlancos [ 10; |HACIENDO nContFila = nContFila + 1;
         aAlfa = "A" + nContFila;
         |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa;
         |QBF aAlfa;
         |SI aAlfa ! "";
            aAlfa = aAlfa - "Codigo ";
            |SI FSalida ! 0;
               |SI nPrimero = 1;
                  nPrimero = 0;
               |SINO;
                  |GRABA 020#capasvt1.n;
               |FINSI;

               |DDEFECTO #capasvt1;
               #capasvt1#0 = nContador; nContador = nContador + 1;
               aChar = aAlfa % 0101; |QBF aChar;
               aAlfa1 = aChar; aAlfa = aAlfa % 0299;
               |PARA; |SI aChar ! ""; |HACIENDO;
                  aChar = aAlfa % 0101; |QBF aChar;
                  aAlfa1 = aAlfa1 + aChar; aAlfa = aAlfa % 0299;
               |SIGUE;
               #capasvt1#1 = aAlfa1;
               #capasvt1#2 = aAlfa;
               aAlfa = "    Pasando datos " + aAlfa1 + " " + aAlfa; |MENSA aAlfa;
            |FINSI;
            aAlfa = aAlfa - "N.I.F. ";
            |SI FSalida ! 0; #capasvt1#3 = aAlfa; |FINSI;
            aAlfa = aAlfa - "Direccion ";
            |SI FSalida ! 0; #capasvt1#4 = aAlfa; |FINSI;
            aAlfa = aAlfa - "Poblacion ";
            |SI FSalida ! 0;
               aChar = aAlfa % 0101; |QBF aChar;
               aAlfa1 = aChar; aAlfa = aAlfa % 0299;
               |PARA; |SI aChar ! ""; |HACIENDO;
                  aChar = aAlfa % 0101; |QBF aChar;
                  aAlfa1 = aAlfa1 + aChar; aAlfa = aAlfa % 0299;
               |SIGUE;
               #capasvt1#6 = aAlfa1;

               aChar = aAlfa % 0101; |QBF aChar;
               aAlfa1 = aChar; aAlfa = aAlfa % 0299;
               |PARA; |SI aChar ! ""; |HACIENDO;
                  aChar = aAlfa % 0101; |QBF aChar;
                  aAlfa1 = aAlfa1 + aChar; aAlfa = aAlfa % 0299;
               |SIGUE;
               #capasvt1#5 = aAlfa1;
               #capasvt1#7 = aAlfa;
            |FINSI;
            aAlfa = aAlfa - "Cuenta/cte. ";
            |SI FSalida ! 0; #capasvt1#8 = aAlfa; |FINSI;
            aAlfa = aAlfa - "Telefono ";
            |SI FSalida ! 0; #capasvt1#9 = aAlfa; |FINSI;
            aAlfa = aAlfa - "Fax ";
            |SI FSalida ! 0; #capasvt1#10 = aAlfa; |FINSI;
            aAlfa = aAlfa - "E-Mail ";
            |SI FSalida ! 0; #capasvt1#11 = aAlfa; |FINSI;
         |SINO;
            nBlancos = nBlancos + 1;
         |FINSI;
      |SIGUE;
      |GRABA 020#capasvt1.n;
      |ALFACALLDLL "agixl97.dll", "fin_book", "salva";

      aAlfa = "c:\temp\vacia.xls"; |QBF aAlfa;
      |ALFACALLDLL "agixl97.dll", "carga_book", aAlfa;
      |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";
      |SI FSalida = 0;
         nContFila = 1;
         |MENSA "    Grabando temporal";
         |BUCLE GrabaCliPro;
         aAlfa1 = #0#4; |QBF aAlfa1; |RFBORRA aAlfa1;
         |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa1;
         |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
      |FINSI;

      |DESCARGADLL "agixl97.dll";
   |FINSI;

   |CIERRA #capasvt1; |CIERRA #capasvtm;
|FPRC;

|PROGRAMA;
   |ABRE #capasvip;
   |LEE 000#capasvip.p;
   |SI FSalida ! 0;
      |DDEFECTO #capasvip;
      |GRABA 000#capasvip.c;
   |FINSI;

   |CLS;
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |GRABA 000#capasvip.a;

      |HAZ Tipo3;
   |FINSI;

   |CIERRA #capasvip;
|FPRO;
