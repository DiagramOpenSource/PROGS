|FICHEROS;
    caivaact #0;

    camaasic #1;
    camaasil #2;
    cacuenta #3;

    camaniva;
    caivalin #5;
    casiim01;
    casiim02;

    calibros #6;

    caintiva #7;
    cainliva;
    caw00017 #17;

    caivaasi #200;

    :/modelos/def/dsmom030 #130;
    :/modelos/def/dsmom041 #41;

    :/dsarchi/def/dpntm100;
    :/dsarchi/def/dpntm101;
    :/dsarchi/def/dpntm102;
    :/dsarchi/def/dpntm103;
    :/dsarchi/def/dsarm005;

    caivam03 #223;
    aivam03@ #113;

    referen@ #999;
    trabajo1@;
    trabajo2@;
    camanref #1002;

    carbuw02 #99;

    anm00012 #12;
    anm00013 #13;
    anw00012 #212;
    anw00013 #213;

    camacc01 #501;
    camacc02 #502;
    camacc03 #503;
    camacc12 #512;
|FIN;

|VARIABLES;
   &eaNombre = "";

   nEsComersan = 0;
   aBaseA = "";
   aMensaje = "";
   nEmpresaConta = 0;
   aEmpresa = "";
   aPeriodo = "";
   nPeriodo = 0;
   nLibroConta = 0;
   nLineaConta = 0;
   nRegFactura = 0;

   nSwContaArchi = 0;
   aPathDatos = "";
   aFicDsarchi = "";
   aDSERP = "";

   aAux = "";
   &enDiarioNivel = 0;
   &enSwFiltroOK = 0;
   &enSwVerbose = 0;

   nRepetido = 0;
   nLibro = 0;
   a_param = "";
   swError = 0;
   swEF1   = 0;
   swEF2   = 0;
   LibroAnt = 0;
   SerieAnt = "";
   FactAnt  = 0;
   SerieAntC = "";
   FactAntC  = 0;
   LibroAntC = 0;
   aDepAnt  = "";
   aSubAnt  = "";
   aRefAnt  = "";
   aCliPro  = "";
   aCliPro1 = "";
   ClPrAnt  = "";
   FechaAnt = @;
   LinAnt   = 0;
   linea    = 0;
   lineaIVA = 0;
   lineaRec = 0;
   lineaDto = 0;
   swNuevo  = 0;
   diario   = 0;
   fecha    = @;
   docume   = 0;
   aTipo    = "";

   TotalFactura = 0;
   Cta_cob1  = "";
   dig_cob1  = 0;
   Cta_cob2  = "";
   dig_cob2 = 0;
   Con_cob1 = 0;
   Con_cob2 = "";
   fCampo73 = @;

   Comodin = "";
   Comodin1 = "";
   NumDocum = 0;

   Primero = 0;
   FEstado = 0;

   importe = 0;
   import1 = 0;
   import2 = 0;
   imporcp = 0;
   aSigno  = "";

   aAlfa  = "";
   aAlfa1 = "";
   aAlfa2 = "";
   aAlfa3 = "";
   aAlfa4 = "";
   aAlfa5 = "";
   aAlfa7 = "";
   fechaW17 = @;
   nNumApte = 0;
   nPara1   = 0;
   en0W17   = 0;
   en2W17   = 0;
   fDFecha  = @;
   aSigAn   = "";

   nSwHay = 0;
   nOk    = 0;

   aDeMas    = "";
   aCtaDebe  = "";
   aCtaHaber = "";

   &libro     = 0;
   &serie     = "";
   &orden     = 0;
   &depart    = "";
   &eaRef     = "";
   &enModoEsc = 0;
   &enAux     = 0;
   &nConcep   = 0;
   &aDesc     = "";
   &pesetas   = 0;
   &cuenta    = "";
   &digito    = 0;
   &emision   = "";
   &repres    = "";

   aLasBl     = "";
   fFechaN    = @;
   fFechaA    = @;
   nSi        = 0;
   nBase      = 0;
   nSumaTipo  = 0;

   nLlegoa9   = 0;
   nNum9      = 0;
   nError     = 0;
    aDCon1 = "";
    aDCon2 = "";
    nDCon0 = 0;
    nDCon1 = 0;
    aDef   = "";
    aMas   = "";
    nConte = 0;
    nume1  = 0;
    nume2  = 0;
   aCampo49 = "";
   aCampo62 = "";
   aTipoIVA1 = "";
   aTipoIVA2 = "";
   aH60      = "";

   aPathDSARCHI = "";
   nReg         = 0;
   nEmpresa     = 0;
   nCampo       = 0;
   nCampo1      = 0;

   aQueQuiero   = "";
   aNumCampos   = "";
   nNumCampos   = 0;

   &eaFichCab   = "";
   &eaFichLin   = "";
   nREBUReg     = 0;
   nREBU        = 0;
   aFichero     = "";
   nCopia       = 0;
   aSiNo        = "";
   nNumero      = 0;
   nNumBase     = 0;

   nNumReg           = 0;
   nCampoC           = 0;
   nCampoE           = 0;
   nNumCampo         = 0;
   nNumCampo2        = 0;
   nLetra            = 0;
   nSaca             = 0;
   nLong             = 0;

   aValorConta       = "";
   aActual           = "";
   aAuxActual        = "";
   aTextoActual      = "";
   aSaca             = "";
   aLong             = "";
   aLetra            = "";
   &eaFitnW12        = "";
   &eaFitnW13        = "";

   nSwError = 0;
   nSwOp    = 0;
   aCaja    = "";
   nSwCaja  = 0;
   nLineaUlt = 0;
   nSuma1    = 0;
   nSuma2    = 0;
   nSuma3    = 0;
   nTp       = 0;
   nYahePreguntado = 0;

   &enDFra   = 0;
   &enHFra   = 0;
   &eaDSerie = "";
   &eaHSerie = "";
   &efDFecha = @;
   &efHFecha = @;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoiv_i;
|INCLUYE modulo_i;

|| ********************** Calculos de Pantalla
|CALCULO LaFechaN; |TIPO 0;
   swError = 0;
   |SI #0#8 < fec1; |O #0#8 > fec2;
      |MENAV "    ESTA FECHA NO CORRESPONDE AL EJERCICIO";
      swError = 1;
   |SINO;
      |SI #0#8 [ fec3;
          |MENAV "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
          swError = 1;
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO TrasLibro; |TIPO 0;
   |ABRE #6;
   #6#0 = #0#0;
   |LEE 010#6=;
   |SI FSalida ! 0;
      |MENAV "     No existe el libro";
      |CIERRA #6;
      |C_M #0#0,1,"S";
      |ERROR;
      |ACABA;
   |FINSI;
   |CIERRA #6;
   |PINTA 1028, #6#1;
   |SI a_param ! "";
      |SI #6#2 ! a_param;
          |MENAV "     Libro de IVA No Correcto";
          || |C_M #0#0,1,"S";
          |PTEC 807;
          |ACABA;
      |FINSI;
   |FINSI;

   aTipoIVA = #6#2;
   |HAZ LeeDefIVA;
   |SI aTipoIVA = "R";
      |ATRI R;
      |PINTA 0630, "EMITIDAS ";
      |ATRI N;
   |SINO;
      |ATRI R;
      |PINTA 0630, "RECIBIDAS ";
      |ATRI N;
   |FINSI;

   |C_M #0#11,1,snSerie; #0#11 = dSerie;
   |C_M #0#12,1,snSerie; #0#12 = dSerie;
   |SI #200#44 = "S"; |O dSerie = "     ";
       #0#11 = "     ";
       #0#12 = "zzzzz";
   |FINSI;
   |PINTA #0#11;
   |PINTA #0#12;

   |ABRE #caintiva;
   #caintiva#0 = #caivaact#0;
   |LEE 041#caintiva.=;
   |SI FSalida ! 0;
       |MENAV "0000No hay Facturas para actualizar";
       |CIERRA #caintiva;
       |SI a_param ! "";
           |PTEC 807;
       |SINO;
           |C_M #0#0,1,"S";
           |ERROR;
       |FINSI;
       |ACABA;
   |FINSI;
   |SI #caintiva#7 = "R"; |O #caintiva#7 = "S";
       aTipoIVA = #caintiva#7;
   |FINSI;
   |CIERRA #caintiva;
|FCAL;

|CALCULO fecha;
   |C_M #0Campo, 0, aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   |SI Campo = 8;
       |HAZ LaFechaN;
       |SI swError !  0;
           |ERROR;
       |FINSI;
       |ACABA;
   |FINSI;

   |SI #0Campo < fDFecha; |O #0Campo > fec2;
      |MENAV "     Fecha ERRONEA ";
      |ERROR;
      |ACABA;
   |FINSI;
   |SI Campo = 5; |Y #0#4 > #0#5;
       |MENAV "     Fecha ERRONEA ";
       |ERROR;
   |FINSI;
|FCAL;

|CALCULO  LaFecha;
   |SI #0#6 = "F";
       #0#8 = "01.01.0000"; |PINTA #0#8;
       |C_M #0#8,1,"N";
   |SINO;
       |C_M #0#8,1,"S";
       |SI #0#8 [ "01.01.0000";
           #0#8 = ~; |PINTA #0#8;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO BuscaDoc; |TIPO 0;
   |HAZ contador;
   #0#9 = nDOCUMENTO;
   #0#10 = #0#9;

   |C_M #0#9, 1, "S";
   |SI eaPaDOM1 = "S";
       |C_M #0#9, 1, "N"; |PINTA #0#9;
   |FINSI;
|FCAL;

|PROCESO RepDoc; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;

   nConte = Contenido;
   |SI #0#9 ! nConte;
       |SI eaPaDOM3 ! "S";
           nume1 = nConte + 1;
           |SI nume1 < #0#9;
               nume1 = 0;
               |SI eaPaDOM3 = "A";
                   |CONFI "    NNumero Documento superior al Ultimo + 1, Continuar";
                   |SI FSalida = 0;
                       nume1 = 1;
                   |FINSI;
               |SINO;
                   |MENAV "    Error. Numero Documento superior al Ultimo + 1";
               |FINSI;
               |SI nume1 = 0;
                   #0#9 = nConte;
                   |ERROR;
                   |ACABA;
                |FINSI;
            |FINSI;
         |FINSI;
    |FINSI;

    nError = 0;
    |SI eaPaDOM2 = "S"; |ACABA; |FINSI;  || no mira

    |ABRE #1;
    |SELECT #3#1;
    #1#2 = #0#9;
    |LEE 000#1=;
    |SI FSalida = 0;
        nError = 1;
        |SI eaPaDOM2 = "A";
           |CONFI "    NAtencion, Ya existe numero de Documento. Continuar";
           |SI FSalida = 0;
               nError = 0;
               |ACABA;
           |FINSI;
        |FINSI;
    |FINSI;
    |SELECT #1#1;
    |CIERRA #1;
    |SI nError = 1;
        |ERROR;
        #0#9 = nConte;
    |FINSI;
|FPRC;

|PROCESO BuscaUlt;
   |SI nLlegoa9 = 0;
       |SELECT #3#1;
       |LEE 010#1u;
       |SI FSalida = 0;
           docume  = #1#2 + 1;
           |SI docume > 999999;
              |SI nLlegoa9 = 0;
                  |HAZ PreguntoSeguir;
                  |SI nError = 1; |ACABA; |FINSI;
              |FINSI;
              nLlegoa9 = 1;
          |FINSI;
       |SINO;
           docume  = 1;
       |FINSI;
       |SELECT #1#1;
   |FINSI;

   |SI nLlegoa9 = 1;
       |PARA; |SI; |HACIENDO;
              nNum9 = nNum9 + 1;
              |SI nNum9 > 999999;
                  |HAZ ErrorNumero;
                  |SAL;
              |FINSI;
              #1#0 = diario;
              #1#1 = fecha;
              #1#2 = nNum9;
              |LEE 001#1=;
              |SI FSalida !  0; |SAL; |FINSI;
       |SIGUE;
       docume = nNum9;
   |FINSI;
|FPRC;

|PROCESO PreguntoSeguir;
  |CONFI "    SSe ha superado el Numero de Documento 999999, Desea empezar por 000001";
  |SI FSalida ! 0;
      nError = 1;
  |FINSI;
|FPRC;

|PROCESO ErrorNumero;
  |MENAV "    SNo puedo continuar creando Documentos, superados los 999999";
   nError = 1;
|FPRC;

|| **************************************************************************
|| ***** Chequea los posibles errores en Facturas antes de Actualizar *******
|| **************************************************************************
|PROCESO LeeFechas;

  |SI #0#6 = "F";
      |SI #cainliva#4 [ fec3; |Y fec3 > "01.01.0000"; swError = 1; |FINSI;
      |SI #cainliva#4 < fec1; swError = 2; |FINSI;
      swEF1 = 1;
  |FINSI;

  |SI #cainliva#73 > "01.01.0000";
      |SI #cainliva#73 [ fec3; |Y fec3 > "01.01.0000"; swError = 1; |FINSI;
      |SI #cainliva#73 < fec1; swError = 2; |FINSI;
      swEF2 = 1;
  |FINSI;

|FPRC;

|DEFBUCLE LeeFechas;
   #cainliva#3;
   ;
   #0#0, #0#4, #0#11, #0#2;
   #0#1, #0#5, #0#12, #0#3;
   e;
   NULL, LeeFechas;
|FIN;


|PROCESO MiraErrores;
                      || ... Duplicados en Lineas de Introduccion
 |SI LibroAnt  = #cainliva#0; |Y SerieAnt = #cainliva#26;
     |Y FactAnt = #cainliva#2; |Y LinAnt = #cainliva#3;
      |MENAV "    Lineas duplicadas. Se Aborta la actualizacion";
      swError = 1;
      |ERROR10;
      |ACABA;
 |SINO;
      |SI LibroAnt = #cainliva#0; |Y SerieAnt = #cainliva#26;
          |Y FactAnt = #cainliva#2;
             |SI #cainliva#4 ! FechaAnt;
                 |MENAV "    ­ Error ! Existe lineas de la misma Factura con distinta fecha";
                 swError = 1;
                 |ERROR10;
                 |ACABA;
             |FINSI;
             |SI #cainliva#5 ! ClPrAnt;
                 |MENAV "    ­ Error ! Existe lineas de la misma Factura con distinto Cliente/Proveedor";
                 swError = 1;
                 |ERROR10;
                 |ACABA;
             |FINSI;

      |FINSI;

       LibroAnt = #cainliva#0;
       SerieAnt = #cainliva#26;
       FactAnt  = #cainliva#2;
       LinAnt   = #cainliva#3;
       FechaAnt = #cainliva#4;
       ClPrAnt  = #cainliva#5;
 |FINSI;
                      || ... Facturas Ya existentes en Mantenimiento IVA

  |SI PARAMETRO ! "GAD";  |Y PARAMETRO ! "CSV";
      #camaniva#0 = #cainliva#0;
      #camaniva#2 = #cainliva#26;
      #camaniva#3 = #cainliva#2;
      |LEE 010#camaniva.=;
      |SI FSalida = 0; |Y nYahePreguntado = 0;
          Comodin1 = ("00" + #cainliva#0) % -102;
          Comodin = Comodin1;
          Comodin1 = ("     " + #cainliva#26) % -105;
          Comodin = Comodin + "/" + Comodin1;
          Comodin1 = ("000000" + #cainliva#2) % -106;
          Comodin = Comodin + "/" + Comodin1;
          Comodin = "    La Factura " + Comodin + " ya existe. Se anula la actualizacion";

          nYahePreguntado = 1;
          Comodin = "    SHay Factura(s) duplicada(s). Anular actualizacion ";
          |CONFI Comodin;
          |SI FSalida = 0;
              swError = 1;
              |ERROR10;
              |ACABA;
          |FINSI;
      |FINSI;
   |FINSI;

  ||TIQUET. 2775/180
  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#5;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#17;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#20;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#22;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#24;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#36;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;

  enSwFiltroOK = 1;
  enSwVerbose = 1;
  enDiarioNivel = #caivaact#7;
  eaCuenta = #cainliva#40;
  aAux = eaCuenta;
  |QBF aAux;
  |SI aAux ! "";
       |HAZ SacaNivel;
       |SI enSwFiltroOK = 0;
            swError = 1;
            |ERROR10;
       |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE MiraErrores0;
   #cainliva#2;
   4;
   #0#0,#0#11,#0#2, 01, #0#4;
   #0#1,#0#12,#0#3, 99, #0#5;
   ;
   NULL,MiraErrores;
|FIN;

||***************************************************************************
|| ************* Actualizacion
||***************************************************************************
|PROCESO LeeApuntea0;
 |SI #2#9 = 0;
     |BORRA 020#2a;
 |SINO;
     nSi = 1;
     |ERROR10;
 |FINSI;
 |LIBERA #2;
|FPRC;

|DEFBUCLE LeeApuntea0;
 #2#1;
 ;
 diario,fecha,docume,0001;
 diario,fecha,docume,9999;
 be;
 NULL, LeeApuntea0;
|FIN;

|PROCESO NoAsiento0;
 |SI aElCero = "S"; |ACABA; |FINSI;

 nSi = 0;
 |CIERRAT #2;
 |BUCLE LeeApuntea0;
 |SI nSi = 0;
     #camaasic#0 = diario;
     #camaasic#1 = fecha;
     #camaasic#2 = docume;
     |LEE 101#1=;
     |SI FSalida = 0;
         |BORRA 020#1a;
         #0#9 = #0#9 - 1;
     |FINSI;
     |SELECT #1#camaniva;
     #camaniva#0 = nLibro;
     #camaniva#1 = NumDocum;
     |LEE 141#camaniva.=;
     |SI FSalida = 0;
         #camaniva#9 = 0;
         |GRABA 020#camaniva.a;
     |FINSI;
     |LIBERA #camaniva;
 |FINSI;
 |ABRET #2;
|FPRC;

|PROCESO CobroPago;
 |HAZ NoAsiento0;

 |SI TotalFactura = 0; |ACABA; |FINSI;  || No hay cobro automatico

    #0#9   = #0#9 + 1;
    linea  = -9;
    docume = #0#9;
    fecha  = fCampo73;
    |HAZ cabecera;
    |SI nError = 1; |ACABA; |FINSI;
 || Apunte Cliente / Proveedor
     linea = linea + 10;
     |DDEFECTO #2;
     #2#0 = diario;               || Diario
     #2#1 = fecha;                || Fecha Contable
     #2#2 = docume;               || Documento
     #2#3 = linea;
     |LEE 101#2=;
     |SI FSalida ! 0;
         |DDEFECTO #2;
         #2#0 = diario;               || Diario
         #2#1 = fecha;                || Fecha Contable
         #2#2 = docume;               || Documento
         #2#3 = linea;

         #2#4 = Cta_cob1;          || Cuenta Cliente
         #2#5 = dig_cob1;          || digito
         #2#6 = Con_cob1;          || Concepto
         #2#7 = Con_cob2;          || Descripcion
         |SI aTipoIVA = "R";
             #2#8 = "H";
             #2#12 = "C";
         |SINO;
             #2#8 = "D";
             #2#12 = "P";
         |FINSI;
         #2#19 = "";
         #2#20 = "";
         #2#24 = nREGISTRO;
         |GRABA 020#2b;
     |FINSI;

    importe = TotalFactura;
    #2#9  = #2#9 + TotalFactura;
    |SI #2#9 < 0; |Y snAbono = "S";
        importe = - importe;
        #2#9 = - #2#9;
        |SI #2#8 = "D";
            #2#8 = "H";
        |SINO;
            #2#8 = "D";
        |FINSI;
    |FINSI;
    |HAZ adapta4;
    |GRABA 020#2a;
    |SI #2#8 = "D"; aCtaDebe  = #2#4; |FINSI;
    |SI #2#8 = "H"; aCtaHaber = #2#4; |FINSI;

    |HAZ act_cabecera;
    |HAZ Actualiza;
    |LIBERA #2;

 || Apunte Cuenta Cobro / Pago
     linea = linea + 10;
     |DDEFECTO #2;
     #2#0 = diario;               || Diario
     #2#1 = fecha;                || Fecha Contable
     #2#2 = docume;               || Documento
     #2#3 = linea;
     |LEE 101#2=;
     |SI FSalida ! 0;
         |DDEFECTO #2;
         #2#0 = diario;               || Diario
         #2#1 = fecha;                || Fecha Contable
         #2#2 = docume;               || Documento
         #2#3 = linea;

         #2#4 = Cta_cob2;          || Cuenta Cobro/pago
         #2#5 = dig_cob2;         || digito
         #2#6 = Con_cob1;          || Concepto
         #2#7 = Con_cob2;          || Descripcion
         |SI aTipoIVA = "R";
             #2#8 = "D";
             #2#12 = "C";
         |SINO;
             #2#8 = "H";
             #2#12 = "P";
         |FINSI;
         #2#19 = "";
         #2#20 = "";
         #2#24 = nREGISTRO;
         |GRABA 020#2b;
     |FINSI;

    importe = TotalFactura;
    #2#9  = #2#9 + TotalFactura;
    |SI #2#9 < 0; |Y snAbono = "S";
        importe = - importe;
        #2#9 = - #2#9;
        |SI #2#8 = "D";
            #2#8 = "H";
        |SINO;
            #2#8 = "D";
        |FINSI;
    |FINSI;
    |HAZ adapta4;
    |GRABA 020#2a;
    |SI #2#8 = "D"; aCtaDebe  = #2#4; |FINSI;
    |SI #2#8 = "H"; aCtaHaber = #2#4; |FINSI;

    |HAZ act_cabecera;
    |HAZ Actualiza;
    |LIBERA #2;

    aCaja = aCampo62; |HAZ EsCaja;
    |SI aCampo49 = "P"; |Y nSwCaja = 1;
        |ABRE #502;
        #502#0 = #camaniva#0;
        #502#1 = #camaniva#1;
        #502#2 = 1;
        |LEE 041#502=;
        |SI FSalida = 0;
            #502#3 = #2#0;
            #502#4 = #2#1;
            #502#5 = #2#2;
            #502#6 = #2#3 - 10;
            |GRABA 020#502a;
        |FINSI;
        |LIBERA #502;
        |CIERRA #502;
    |FINSI;
|FPRC;

||**************************************************************************
||**************************************************************************
|PROCESO Recojo17;
  |DDEFECTO #2;
  #2#0 = diario;              || Diario
  #2#1 = fecha;               || Fecha Contable
  #2#2 = docume;              || Documento
  #2#3 = nNumApte;
  |PARA nPara1 = 4; |SI nPara1 [ 30; |HACIENDO nPara1 = nPara1 + 1;
       #2nPara1 = #17nPara1;
  |SIGUE;
  #2#12 = aTipoIVA;
  #2#13 = #cainliva#0;
  #2#14 = #cainliva#2;
  #2#15 = #cainliva#26;
  #2#19 = "X";
  #2#20 = 0;
  #2#24 = nREGISTRO;
  #2#26 = #cainliva#53;
  Comodin = Usuario % 1099;
  #2#27 = Comodin;

  importe = #2#9;
  |SI #2#9 ! 0;
      |HAZ adapta1;
      |GRABA 020#2n;
      |HAZ act_cabecera;
      |HAZ Actualiza;
      linea = nNumApte;
      nNumApte = nNumApte + 10;
  |FINSI;

  |BORRA 020#17a;
  |LIBERA #17;
|FPRC;

|DEFBUCLE ElCaw00017;
 #17#1;
 ;
 en0W17, fechaW17, en2W17, 0001;
 en0W17, fechaW17, en2W17, 9999;
 be;
 NULL, Recojo17;
|FIN;

||**************************************************************************
|PROCESO BuscaLinea;
   |SI aTipo = "I";lineaIVA = #2#3; |FINSI;
   |SI aTipo = "R";lineaRec = #2#3; |FINSI;
   |SI aTipo = "D";lineaDto = #2#3; |FINSI;
   |ERROR10;
|FPRC;

|DEFBUCLE BuscaLinea;
 #2#1;
 4,19;
 #camaasic#0,#camaasic#1,#camaasic#2,0001,eaCuenta,aTipo;
 #camaasic#0,#camaasic#1,#camaasic#2,9999,eaCuenta,aTipo;
 ;
 NULL,BuscaLinea;
|FIN;

|PROCESO ContaIVA;
       |SI eaDesgIVA = "N";  || no desglosar iva
           aTipo    = "I";
           lineaIVA = 0;
           |BUCLE BuscaLinea;
           |SI lineaIVA = 0;
               linea    = linea + 10;
               lineaIVA = linea;
           |FINSI;
       |SINO;
            linea = linea + 10;
            lineaIVA  = linea;
       |FINSI;

       |SI aTipoIVA1 = "R";
           aSigno = "H";     || Signo logico Cliente
       |SINO;
           aSigno = "D";     || Signo Proveedor
       |FINSI;
       aSigAn = "";
       |DDEFECTO #2;
       #2#0 = diario;               || Diario
       #2#1 = fecha;                || Fecha Contable
       #2#2 = docume;               || Documento
       #2#3 = lineaIVA;
       |LEE 101#2=;
       |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = diario;               || Diario
            #2#1 = fecha;                || Fecha Contable
            #2#2 = docume;               || Documento
            #2#3 = lineaIVA;
            #2#4 = eaCuenta;             || Cuenta IVA
            #2#5 = #cainliva#21;         || digito
            #2#6 = #cainliva#7;          || Concepto
            #2#7 = #cainliva#8;          || Descripcion
            #2#8 = aSigno;
            #2#12 = aTipoIVA;
            #2#19 = "I";
            #2#20 = #cainliva#3;
            #2#24 = nREGISTRO;
            |HAZ adapta2;
            |GRABA 020#2b;
       |SINO;
            aSigAn = #2#8;
       |FINSI;

       importe = #cainliva#14;
       |HAZ adapta3;
       #2#9  = #2#9 + importe;

       |HAZ adapta1;
       |GRABA 020#2a;
       |HAZ act_cabecera;
       |HAZ Actualiza;
       |LIBERA #2;
|FPRC;

|PROCESO ContaRec;
       |SI eaDesgIVA = "N";  || no desglosar iva
           aTipo = "R";
           lineaRec = 0;
           |BUCLE BuscaLinea;
           |SI lineaRec = 0;
               linea    = linea + 10;
               lineaRec = linea;
           |FINSI;
       |SINO;
            linea = linea + 10;
            lineaRec  = linea;
       |FINSI;

       |SI aTipoIVA1 = "R";
           aSigno = "H";     || Signo logico Cliente
       |SINO;
           aSigno = "D";     || Signo Proveedor
       |FINSI;
       aSigAn = "";
       |DDEFECTO #2;
       #2#0 = diario;               || Diario
       #2#1 = fecha;               || Fecha Contable
       #2#2 = docume;               || Documento
       #2#3 = lineaRec;
       |LEE 101#2=;
       |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = diario;               || Diario
            #2#1 = fecha;                || Fecha Contable
            #2#2 = docume;               || Documento
            #2#3 = lineaRec;
            #2#4 = eaCuenta;             || Cuenta Recargo
            #2#5 = #cainliva#23;         || digito
            #2#6 = #cainliva#7;          || Concepto
            #2#7 = #cainliva#8;          || Descripcion
            #2#8 = aSigno;
            #2#12 = aTipoIVA;
            #2#19 = "R";
            #2#20 = #cainliva#3;
            #2#24 = nREGISTRO;
            |HAZ adapta2;
            |GRABA 020#2b;
       |SINO;
            aSigAn = #2#8;
       |FINSI;

       importe = #cainliva#16;
       |HAZ adapta3;
       #2#9  = #2#9 + importe;

       |HAZ adapta1;
       |GRABA 020#2a;
       |HAZ act_cabecera;
       |HAZ Actualiza;
       |LIBERA #2;
|FPRC;

||**************************************************************************
|PROCESO CambioCta;
  aTipoIVA2 = aTipoIVA;
  aTipoIVA  = aTipoIVA1;
  efFechaIVA = #cainliva#4; enLineaIVA = #cainliva#10; |HAZ SacaIVA;
  |SI enLineaIVA = -1; |ACABA; |FINSI;

  |SI aTipo = "I"; eaCuenta = eaCtaIVA; |FINSI;
  |SI aTipo = "R"; eaCuenta = eaCtaREC; |FINSI;

  emCta = 0; |HAZ SacaNivel;
  aTipoIVA = aTipoIVA2;
|FPRC;

||**************************************************************************
||**************************************************************************
|PROCESO CreaAsiento;
                            ||Siempre Actualizacion por Registro
  |SI SerieAnt ! #cainliva#26;  |O FactAnt !  #cainliva#2; |O LibroAnt ! #cainliva#0;
      |SI Primero = 1;
          |HAZ CobroPago;
          #0#9  = #0#9 + 1;
          swNuevo      = 0;
          TotalFactura = 0;
          Cta_cob1     = "";
          dig_cob1     = 0;
          Cta_cob2     = "";
          dig_cob2     = 0;
          Con_cob1     = 0;
          Con_cob2     = "";
          aCampo49     = "N";
          aCampo62     = "";
          fCampo73     = "01.01.0000";
      |FINSI;

      |SI #0#6 = "F";
          |SI #cainliva#4 [ fec3; |O #cainliva#4 < fec1;
              #0#8 = fFechaN;
          |SINO;
              #0#8 = #cainliva#4;           || Fecha Contable
          |FINSI;
      |SINO;
          #0#8 = fFechaA;
      |FINSI;

      aDepAnt  = #cainliva#45;
      aSubAnt  = #cainliva#47;
  |FINSI;

  Primero  = 1;
  SerieAnt = #cainliva#26;
  FactAnt  = #cainliva#2;
  LibroAnt = #cainliva#0;
  || aDepAnt  = #cainliva#45;
  || aSubAnt  = #cainliva#47;
  aRefAnt  = #cainliva#53;
  aCliPro  = #cainliva#5;
  aCliPro1 = #cainliva#27;

  enAParam = #cainliva#45;
  |HAZ eActivParam;

  diario = #0#7;
  fecha  = #0#8;
  docume = #0#9;
  |SI swNuevo = 0;
      |HAZ cabecera;   ||Primera Linea
      |SI nError = 1; |ACABA; |FINSI;  || no puedo seguir
      swNuevo = 1;
  |FINSI;

  |SI aTipoIVA = "R";
      aSigno = "D";     || Signo logico Cliente
  |SINO;
      aSigno = "H";     || Signo Proveedor
  |FINSI;
  aSigAn = "";
  #2#0 = diario;              || Diario
  #2#1 = fecha;               || Fecha Contable
  #2#2 = docume;              || Documento
  #2#3 = 1;                   || Apunte del total factura
  |LEE 010#2=;
  |SI FSalida ! 0;
      |DDEFECTO #2;
      #2#0 = diario;
      #2#1 = fecha;
      #2#2 = docume;
      #2#3 = 1;
      #2#4 = #cainliva#5;  || Cuenta
      #2#5 = #cainliva#6;  || Digito
      #2#6 = #cainliva#7;  || Concepto
      #2#7 = #cainliva#8;  || Descripcion
      #2#8 = aSigno;
      #2#12 = aTipoIVA;
      #2#19 = "F";
      #2#20 = 0;
      #2#24 = nREGISTRO;
      |HAZ adapta2;
      |GRABA 020#2b;
   |SINO;
      aSigAn = #2#8;
   |FINSI;

   importe = #cainliva#29;
   |SI #cainliva#54 = "S"; importe = #cainliva#29 - (#cainliva#14 + #cainliva#16); |FINSI;
   |SI #cainliva#62 = "I"; importe = #cainliva#29 - (#cainliva#14 + #cainliva#16); |FINSI;
   imporcp = importe;

   |HAZ adapta3;
   #2#9 = #2#9 + importe;

   |HAZ adapta1;
   |GRABA 020#2a;
   |LIBERA #2;
   |HAZ act_cabecera;
   |HAZ Actualiza;

|SI #cainliva#49 ! "N";
   TotalFactura = TotalFactura + imporcp;
   Cta_cob1     = #cainliva#5;
   eaCuenta     = Cta_cob1; |HAZ SacaNivel;
   dig_cob1     = enNivel;
   Cta_cob2     = #cainliva#40;
   eaCuenta     = Cta_cob2; |HAZ SacaNivel;
   dig_cob2     = enNivel;
   Con_cob1     = #cainliva#43;
   Con_cob2     = #cainliva#44; |QBF Con_cob2;
   aCampo49     = #cainliva#49;
   aCampo62     = #cainliva#62;
   |SI #cainliva#73 = "01.01.0000";#cainliva#73 = #cainliva#4; |FINSI;
   fCampo73     = #cainliva#73;

   nOk = 0;
   |SI fCampo73 [ fec3; |Y fec3 > "01.01.0000"; nOk = 1; |FINSI;
   |SI fCampo73 < fec1;                         nOk = 1; |FINSI;
   |SI fCampo73 > fec2;                         nOk = 1; |FINSI;

   |SI nOk = 1;
       |SI #0#6 = "F";
           fCampo73 = fFechaN;
       |SINO;
           fCampo73 = fFechaA;
       |FINSI;
   |FINSI;
|FINSI;

   || .............................. Registros IVA

|SI #cainliva#54 = "S"; |Y #200#150 ! "S"; |Y #cainliva#62 ! "I";
    |VETE voyalabase;
|FINSI;
|SI #cainliva#62 = "I"; |Y #200#151 ! "S";
    |VETE voyalabase;
|FINSI;
|SI #cainliva#19 = "I";
    |VETE voyalabase;
|FINSI;

   |SI #cainliva#14 ! 0;     || Existe Cuota de IVA
       eaCuenta  = #cainliva#20;
       aTipo     = "I";
       aTipoIVA1 = aTipoIVA;
       |HAZ ContaIVA;

       |SI #cainliva#54 = "S"; |O #cainliva#62 = "I"; ||intracomunitarias o ISP
                                                      ||con asto Ctas IVA
            |SI aTipoIVA = "R"; aTipoIVA1 = "S"; |SINO; aTipoIVA1 = "R"; |FINSI;
                 |HAZ CambioCta;
                 |HAZ ContaIVA;
       |FINSI;
   |FINSI;

   || .............................. Registros Recargo IVA

   |SI #cainliva#16 ! 0;     || Existe Cuota de Recargo
       eaCuenta  = #cainliva#22;
       aTipo     = "R";
       aTipoIVA1 = aTipoIVA;
       |HAZ ContaRec;
       |SI #cainliva#54 = "S"; |O #cainliva#62 = "I"; ||intracomunitarias o ISP
                                                      ||con asto Ctas IVA
            |SI aTipoIVA = "R"; aTipoIVA1 = "S"; |SINO; aTipoIVA1 = "R"; |FINSI;
                 |HAZ CambioCta;
                 |HAZ ContaRec;
       |FINSI;
   |FINSI;

|ET voyalabase;

   nBase = #cainliva#12;
   |SI #cainliva#19 = "I";
       nBase = #cainliva#12 + #cainliva#14 + #cainliva#16;
       nSumaTipo = 100;
       #cainliva#19 = "N";
   |FINSI;
   || .............................. Registros de contrapartida
   |SI nBase ! 0;     || Existe Base Imponible
       linea = linea + 10;
       |SI aTipoIVA = "R";
           aSigno = "H";     || Signo logico Cliente
       |SINO;
           aSigno = "D";     || Signo Proveedor
       |FINSI;
       aSigAn = "";
       |DDEFECTO #2;
       #2#0 = diario;               || Diario
       #2#1 = fecha;                || Fecha Contable
       #2#2 = docume;               || Documento
       #2#3 = linea;
       |LEE 101#2=;
       |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = diario;               || Diario
            #2#1 = fecha;                || Fecha Contable
            #2#2 = docume;               || Documento
            #2#3 = linea;
            #2#4 = #cainliva#17;         || Cuenta Recargo
            #2#5 = #cainliva#18;         || digito
            #2#6 = #cainliva#7;          || Concepto
            #2#7 = #cainliva#8;          || Descripcion
            #2#8 = aSigno;
            #2#12 = aTipoIVA;
            #2#19 = "B";
            #2#20 = #cainliva#3;
            #2#24 = nREGISTRO;
            #2#29 = #cainliva#58;  ||cuenta analitica
            |HAZ Grupo_Recarga;
            |HAZ adapta2;
            |GRABA 020#2b;
       |SINO;
            aSigAn = #2#8;
       |FINSI;

       importe = nBase + #cainliva#11;  || sumo el dtos
       |HAZ adapta3;
       #2#9  = #2#9 + importe;

       |HAZ adapta1;
       |GRABA 020#2a;
       |HAZ act_cabecera;
       |HAZ Actualiza;
       |LIBERA #2;
   |FINSI;

   || Grabo la linea de IRPF
   |SI #cainliva#35 ! 0;     || Existe Cuota de IRPF
       linea = linea + 10;
       |SI aTipoIVA = "R";
           aSigno = "D";
       |SINO;
           aSigno = "H";
       |FINSI;
       aSigAn = "";
       |DDEFECTO #2;
       #2#0 = diario;               || Diario
       #2#1 = fecha;                || Fecha Contable
       #2#2 = docume;               || Documento
       #2#3 = linea;
       |LEE 101#2=;
       |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = diario;               || Diario
            #2#1 = fecha;                || Fecha Contable
            #2#2 = docume;               || Documento
            #2#3 = linea;
            #2#4 = #cainliva#36;         || Cuenta IRPF
            #2#5 = #cainliva#37;         || digito
            #2#6 = #cainliva#51;          || Concepto
            #2#7 = #cainliva#52;          || Descripcion
            #2#8 = aSigno;
            #2#12 = aTipoIVA;
            #2#19 = "P";
            #2#20 = #cainliva#3;
            #2#24 = nREGISTRO;
            |HAZ adapta2;
            |GRABA 020#2b;
       |SINO;
            aSigAn = #2#8;
       |FINSI;

       importe = #cainliva#35;
       |HAZ adapta3;
       #2#9  = #2#9 + importe;

       |HAZ adapta1;
       |GRABA 020#2a;
       |HAZ act_cabecera;
       |HAZ Actualiza;
       |LIBERA #2;
   |FINSI;

   || Grabo la linea de Descuento
   |SI #cainliva#11 ! 0;     || Existe Cuota de IVA
       |SI eaDesgDTO = "N"; || no desglosar descuento
           aTipo = "D";
           lineaDto = 0;
           eaCuenta = #cainliva#24;
           |BUCLE BuscaLinea;
           |SI lineaDto = 0;
               linea    = linea + 10;
               lineaDto = linea;
           |FINSI;
       |SINO;
            linea = linea + 10;
            lineaDto  = linea;
       |FINSI;

       |SI aTipoIVA = "R";
           aSigno = "D";
       |SINO;
           aSigno = "H";
       |FINSI;
       aSigAn = "";
       |DDEFECTO #2;
       #2#0 = diario;               || Diario
       #2#1 = fecha;               || Fecha Contable
       #2#2 = docume;               || Documento
       #2#3 = lineaDto;
       |LEE 101#2=;
       |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = diario;               || Diario
            #2#1 = fecha;                || Fecha Contable
            #2#2 = docume;               || Documento
            #2#3 = lineaDto;
            #2#4 = #cainliva#24;         || Cuenta Dto
            #2#5 = #cainliva#25;         || digito
            #2#6 = #cainliva#7;          || Concepto
            #2#7 = #cainliva#8;          || Descripcion
            #2#8 = aSigno;
            #2#12 = aTipoIVA;
            #2#19 = "D";
            #2#20 = #cainliva#3;
            #2#24 = nREGISTRO;
            |HAZ adapta2;
            |GRABA 020#2b;
       |SINO;
            aSigAn = #2#8;
       |FINSI;

       importe = #cainliva#11;
       |HAZ adapta3;
       #2#9  = #2#9 + importe;

       |HAZ adapta1;
       |GRABA 020#2a;
       |HAZ act_cabecera;
       |HAZ Actualiza;
       |LIBERA #2;
   |FINSI;


   nNumApte = linea + 10;
   en0W17 = #cainliva#0;
   en2W17 = #cainliva#1;
   |BUCLE ElCaw00017;
|FPRC;

|PROCESO LaIntracomun;
 |ABRE #113;
 #113#0 = #cainliva#0;
 #113#1 = #cainliva#1;
 |LEE 001#113=;
 |SI FSalida = 0;
     |ABRE #223;
     #223#0 = #camaniva#0;
     #223#1 = #camaniva#1;
     |LEE 101#223=;
     |SI FSalida ! 0;
         #223#0 = #camaniva#0;
         #223#1 = #camaniva#1;
         |GRABA 020#223b;
     |FINSI;

     aQueQuiero = "|NC";
     aNumCampos = #223#aQueQuiero#;
     nNumCampos = aNumCampos;
     nNumCampos = nNumCampos - 1;
     |PARA nPara1 = 2; |SI nPara1 [ nNumCampos; |HACIENDO nPara1 = nPara1 + 1;
           #223nPara1 = #113nPara1;
     |SIGUE;
     |GRABA 020#223a;
     |LIBERA #223;
     |CIERRA #223;
     |BORRA 040#113a;
 |FINSI;
 |CIERRA #113;
|FPRC;

|PROCESO LaInversion;
 |SI #cainliva#70 ! "        ";
     |ABRE #41;
     #41#0 = enEmpresa;
     #41#2 = #cainliva#70;
     #41#3 = #cainliva#71;
     |LEE 141#41=;
     |SI FSalida = 0;
         aAlfa   = (("00" + #camaniva#0) % -102) + "-" + (("0000000000" + #camaniva#1) % -110) + " / ";
         |SI #camaniva#2 ! "     ";
             aAlfa   = aAlfa + #camaniva#2 + "-" + (("000000" + #camaniva#3) % -106);
         |SINO;
              aAlfa   = aAlfa + (("000000" + #camaniva#3) % -106);
         |FINSI;
         |SI #camaniva#36 = "S";
             #dsmom041#49 = aAlfa;
             #dsmom041#60 = #camaniva#1;
         |FINSI;
         |SI #camaniva#36 = "R";
             #dsmom041#50 = aAlfa;
             #dsmom041#64 = #camaniva#1;
         |FINSI;
         |GRABA 020#41a;
     |FINSI;
     |LIBERA #41;
     |CIERRA #41;
 |FINSI;
|FPRC;

|PROCESO LaReferencia;
   |SI nEsComersan = 1; |Y #camaniva#36 = "S";
       aAlfa1 = #cainliva#72; |QBF aAlfa1;
       |SI aAlfa1 ! "";
           |ABRE #1002;
           #1002#0 = #camaniva#0;
           #1002#1 = #camaniva#1;
           |LEE 141#1002=;
           |SI FSalida ! 0;
               #1002#0 = #camaniva#0;
               #1002#1 = #camaniva#1;
               |GRABA 020#1002b;
           |FINSI;
           #1002#2 = #cainliva#72;
           |GRABA 020#1002a;
           |LIBERA #1002;
           |CIERRA #1002;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO EsCaja;
   nSwCaja = 0;
   |SI enEjercicio ] 2014;
      |SI aCaja = "Z"; |O aCaja = "1"; |O aCaja = "2";
         |O aCaja = "3"; |O aCaja = "4"; |O aCaja = "5";
         |O aCaja = "6"; |O aCaja = "7"; |O aCaja = "8";
         nSwCaja = 1;
      |FINSI;
  |FINSI;
|FPRC;

|| nuevo recalculo para las lineas

|PROCESO LeoMacc03;
     nNumBase = #503#3;
     #caivalin#0 = #503#0;
     #caivalin#1 = #503#1;
     #caivalin#2 = nNumBase;
     |LEE 141#caivalin.=;
     |SI FSalida ! 0;
         |BORRA 020#503a;
         |LIBERA #503;
         |ACABA;
     |SINO;
         |SI #503#3 = nLineaUlt;
             #503#4 = #503#4 + (#502#10 - nSuma1);
             #503#5 = #503#5 + (#502#11 - nSuma2);
             #503#6 = #503#6 + (#502#12 - nSuma3);
             |GRABA 020#503a;
             || hacer cuadre
         |FINSI;
     |FINSI;
     |LIBERA #503;
|FPRC;

|DEFBUCLE LeoMacc03;
    #503#1;
    ;
    #502#17, #502#0, #502#1, #502#2, 01;
    #502#17, #502#0, #502#1, #502#2, 99;
    be;
    NULL, LeoMacc03;
|FIN;

|PROCESO LeoLineaIVA;
     nNumBase = #caivalin#2;
     |DDEFECTO #503;
     #503#0 = #502#0;
     #503#1 = #502#1;
     #503#2 = #502#2;
     #503#3 = nNumBase;
     #503#7 = 0;
     |LEE 141#503=;
     |SI FSalida ! 0;
         |DDEFECTO #503;
         #503#0 = #502#0;
         #503#1 = #502#1;
         #503#2 = #502#2;
         #503#3 = nNumBase;
         #503#7 = 0;
         |GRABA 020#503b;
     |FINSI;

|| .. asi el calcul
     #503#4 = ((#caivalin#6 + #caivalin#8 - #caivalin#22) % #502#13) ! 2;
     #503#5 = (#caivalin#6 % #502#13) ! 2;
     #503#6 = (#caivalin#8 % #502#13) ! 2;

     nSuma1 = (nSuma1 + #503#4) ! 2;
     nSuma2 = (nSuma2 + #503#5) ! 2;
     nSuma3 = (nSuma3 + #503#6) ! 2;
     nLineaUlt = #caivalin#2;

     |GRABA 020#503a;
     |LIBERA #503;
|FPRC;

|DEFBUCLE LeoLineaIVA;
       #caivalin#1;
       ;
       #501#0, #501#1, 01;
       #501#0, #501#1, 99;
       e;
       NULL, LeoLineaIVA;
|FIN;

|PROCESO AuxClaveZ02;
      |SI #camaniva#21 = #502#10;
          nTp = 100;
      |SINO;
          nTp   = ((#502#10 * 100) / #camaniva#21) ! 4;
      |FINSI;
      #502#13 = nTp;

      nSuma1 = 0;
      nSuma2 = 0;
      nSuma3 = 0;
      nLineaUlt = 0;
      |CIERRA #caivalin;
      |ABRE #503;      |BUCLE LeoLineaIVA; |CIERRA #503;
      |ABRE #caivalin; |BUCLE LeoMacc03;

      #501#16 = #501#16 + #502#13;

      |GRABA 020#502a;
      |LIBERA #502;
|FPRC;

|DEFBUCLE AuxClaveZ02;
  #502#1;
  ;
  #501#17, #501#0, #501#1, 01;
  #501#17, #501#0, #501#1, 99;
  be;
  NULL, AuxClaveZ02;
|FIN;

|| ...............................

|PROCESO LaLineaAux;
     |DDEFECTO #503;
     #503#0 = #502#0;
     #503#1 = #502#1;
     #503#2 = #502#2;
     #503#3 = nNumBase;
     #503#7 = 0;
     |LEE 141#503=;
     |SI FSalida ! 0;
         |DDEFECTO #503;
         #503#0 = #502#0;
         #503#1 = #502#1;
         #503#2 = #502#2;
         #503#3 = nNumBase;
         #503#7 = 0;
         |GRABA 020#503b;
     |FINSI;
     #503#4 = #503#4 + #512#5;   ||Total
     #503#5 = #503#5 + #512#6;   ||Base
     #503#6 = #503#6 + #512#7;   ||Cuota
     |GRABA 020#503a;
     |LIBERA #503;
|FPRC;

|PROCESO GrabaAuxClaveZ;
      nSwError = 1;
      |DDEFECTO #502;
      #502#0 = #camaniva#0;
      #502#1 = #camaniva#1;
      #502#2 = nNumero;
      #502#17 = 0;
      |LEE 141#502=;
      |SI FSalida ! 0;
          |DDEFECTO #502;
          #502#0 = #camaniva#0;
          #502#1 = #camaniva#1;
          #502#2 = nNumero;    || Linea de Cobro
          #502#4 = #512#3;     || Fecha Cobro
          #502#7 = #512#4;     || Periodo
          #502#17 = 0;
          |GRABA 020#502b;
      |FINSI;
      |SI #502#4 = #512#3;
          #502#10 = #502#10 + #512#5;
          #502#11 = #502#11 + #512#6;
          #502#12 = #502#12 + #512#7;
          #502#13 = #512#8;
          #502#14 = #512#9;
          #502#15 = #512#10;
          |GRABA 020#502a;
          nSwError = 0;
          #501#6  = #501#6  + #512#6;
          #501#7  = #501#7  + #512#7;
          #501#12 = #501#12 + #512#5;
          |HAZ LaLineaAux;
      |FINSI;
      |LIBERA #502;
|FPRC;

|PROCESO AuxClaveZ;
   nNumBase = #cainliva#3;   || Numero de la base
   |SI nSwOp = 1;            || Graba segun el numero de cobro
      nNumero = #512#2;
      |HAZ GrabaAuxClaveZ;
      |SI nSwError = 0;
          |BORRA 020#512a;
      |FINSI;
   |FINSI;
   |SI nSwOp =2;
       |DDEFECTO #502;
       #502#0  = #camaniva#0;
       #502#1  = #camaniva#1;
       #502#2  = 99;
       #502#17 = 0;
       |LEE 141#502];
       |SI FSalida = 0;
           |LEE 041#502a;
       |SINO;
           |LEE 041#502u;
       |FINSI;
       nNumero = 1;
       |SI FSalida = 0; |Y #502#0 = #camaniva#0; |Y #502#1 = #camaniva#1;
           nNumero = #502#2 + 1;
       |FINSI;
       |HAZ GrabaAuxClaveZ;
       |BORRA 020#512a;
   |FINSI;
   |LIBERA #512;
|FPRC;

|DEFBUCLE AuxClaveZ;
  #512#1;
  ;
  #cainliva#0, #cainliva#1, 01;
  #cainliva#0, #cainliva#1, 99;
  be;
  NULL, AuxClaveZ;
|FIN;

|PROCESO LaClaveZ14;
   aCaja = #camaniva#42;
   |HAZ EsCaja;
   |SI nSwCaja = 1;

       |ABRE #501;
       #501#0  = #camaniva#0;
       #501#1  = #camaniva#1;
       #501#17 = 0;
       |LEE 141#501=;
       |SI FSalida ! 0;
           |DDEFECTO #501;
           #501#0 = #camaniva#0;
           #501#1 = #camaniva#1;
           #501#17 = 0;
           |GRABA 020#501b;
       |FINSI;
       #501#2 = #camaniva#7;
       #501#3 = #camaniva#8;
       #501#4 = #camaniva#9;

       #501#13 = #camaniva#36;
       #501#14 = #camaniva#2;
       #501#15 = #camaniva#3;

       |SI #camaniva#39 = "P"; |O amCCaja = "M";
           |ABRE #502;
           |ABRE #503;
           nSwOp = 1; |BUCLE AuxClaveZ;
           nSwOp = 2; |BUCLE AuxClaveZ;
           |CIERRA #503;
           |CIERRA #502;

           #501#16 = 0;
           |BUCLE AuxClaveZ02;
       |FINSI;

       |GRABA 020#501a;
       |LIBERA #501;
       |CIERRA #501;
   |FINSI;
|FPRC;

|PROCESO OperacionRebu;

   |ABRE #dsmom030;
   |DDEFECTO #dsmom030;
   #dsmom030#0 = #2#6;
   |LEE 001#dsmom030.=;
   |CIERRA #dsmom030;

   nREBUReg = 0;
   |SI #dsmom030#24 = 5; |O #dsmom030#24 = 6;
       nREBUReg = 1;
   |SINO;
       |PARA nume2 = 78; |SI nume2 [ 101; |HACIENDO nume2 = nume2 + 1;
             |SI #dsmom030#nume2# = 5; |O #dsmom030#nume2# = 6;
                 nREBUReg = 1;
                 |SAL;
             |FINSI;
             |SI nume2 = 89; nume2 = 93; |FINSI;
             |SI nume2 = 95; nume2 = 99; |FINSI;
       |SIGUE;
   |FINSI;

   |SI nREBUReg = 0;  |ACABA; |FINSI;  || no es un concepto de REBU

   nCopia = 0;
   |SI aTipoIVA = "R"; |Y #dsmom030#34 = 5; nCopia = 1; |FINSI;
   |SI aTipoIVA = "S"; |Y #dsmom030#36 = 4; nCopia = 1; |FINSI;

   |SI nCopia = 1;
       |ABRE #99;
       |SELECT #2#99;
       #99#2 = #camaniva#0;
       #99#3 = #camaniva#1;
       |LEE 041#99=;
       |SI FSalida = 0;
           nNumero = #99#0;
       |SINO;
           nREBU = nREBU + 1;
           nNumero = nREBU;
       |FINSI;
       |SELECT #1#99;
       |DDEFECTO #99;
       #99#0  = nNumero;
       |LEE 041#99=;
       |SI FSalida ! 0;
           #99#0 = nNumero;
           |GRABA 020#99c;
       |FINSI;
       #99#1  = aTipoIVA;
       #99#2  = #camaniva#0;
       #99#3  = #camaniva#1;
       #99#4  = #camaniva#2;
       #99#5  = #camaniva#3;
       #99#6  = #camaniva#27;
       #99#7  = #camaniva#28;
       #99#8  = #camaniva#19;
       #99#9  = #camaniva#23;
       #99#10 = #camaniva#21;
       #99#11 = #camaniva#4;
       #99#12 = #camaniva#12;
       #99#13 = #camaniva#13;
       #99#14 = #camaniva#22;
       |GRABA 020#99a;
       |CIERRA #99;
   |FINSI;
|FPRC;

|PROCESO LeeAuxiRebu;
 |PRINT;
 nCopia = 1;
|FPRC;

|DEFBUCLE LeeAuxiRebu;
  #99#1;
  ;
  0000001;
  9999999;
  ;
  NULL, LeeAuxiRebu;
|FIN;

|PROCESO ImprRebu;
  |IMPRE 0;
  |SI FSalida ! 0;
      |MENAV "    Proceso abortado ";
      |ACABA;
  |FINSI;

  |INFOR "carbuyac";
  |SI FSalida ! 0;
      |MENAV "    No existe informe";
      |FINIMP;
      |ACABA;
  |FINSI;

  nCopia = 0;
  |BUCLE LeeAuxiRebu;
  |SI nCopia = 1;
      |PIEINF;
  |FINSI;
  |FININF;
  |FINIMP;
|FPRC;

|PROCESO casiim02;
     #casiim02#0 = "camaniva";
     #casiim02#1 = #cainliva#0;
     #casiim02#2 = NumDocum;
     |GRABA 020#casiim02.n;
     |LIBERA #casiim02;
|FPRC;

|DEFBUCLE casiim02;
     #casiim02#1;
     ;
     #casiim01#0, #casiim01#1, #casiim01#2, "";
     #casiim01#0, #casiim01#1, #casiim01#2, aH60;
     be;
     NULL, casiim02;
|FIN;

|PROCESO casiim02B;
     |BORRA 040#casiim02.a;
     |LIBERA #casiim02;
|FPRC;

|DEFBUCLE casiim02B;
     #casiim02#1;
     ;
     #casiim01#0, #casiim01#1, #casiim01#2, "";
     #casiim01#0, #casiim01#1, #casiim01#2, aH60;
     be;
     NULL, casiim02B;
|FIN;

|PROCESO DefPeriodo;
   Comodin = #camaniva#8;
   |QBF Comodin;
   Comodin = Comodin % 0402;
   #camaniva#5 = Comodin;
|FPRC;

|PROCESO CreaIva;
   |SELECT #3#camaniva;
   #camaniva#0 = #cainliva#0;
   #camaniva#2 = #cainliva#26;
   #camaniva#3 = #cainliva#2;
   |LEE 010#camaniva.=;
   |SI FSalida ! 0;

        nLibro = #cainliva#0;
        |SELECT #1#camaniva;

        NumDocum = 1;
        #camaniva#0 = nLibro;
        #camaniva#1 = 9999999999;
        |LEE 010#camaniva.];
        |SI FSalida = 0;
            |LEE 040#camaniva.a;
        |SINO;
            |LEE 040#camaniva.u;
        |FINSI;
        |SI FSalida = 0; |Y #camaniva#0 = nLibro;
            NumDocum = #camaniva#1 + 1;
        |FINSI;

        |ABRE #casiim01;
        #casiim01#0 = "camaniva";
        #casiim01#1 = #cainliva#0;
        #casiim01#2 = NumDocum;
        |LEE 041#casiim01.=;
        |SI FSalida = 0;
            |BORRA 040#casiim01.a;
            |BUCLE casiim02B;
        |FINSI;
        |LIBERA #casiim01;

        |DDEFECTO #casiim01;
        #casiim01#0 = "cainliva";
        #casiim01#1 = #cainliva#0;
        #casiim01#2 = #cainliva#1;
        |LEE 000#casiim01.=;
        |SI FSalida = 0;
            aH60 = "z" * 60;
            |BUCLE casiim02;

            #casiim01#0 = "camaniva";
            #casiim01#1 = #cainliva#0;
            #casiim01#2 = NumDocum;
            |GRABA 020#casiim01.n;
            |LIBERA #casiim01;
        |FINSI;
        |CIERRA #casiim01;

        |DDEFECTO #camaniva;
        #camaniva#0  = #cainliva#0;      || Libro
        #camaniva#1  = NumDocum;         || N§ de registro
        #camaniva#2  = #cainliva#26;     || Serie
        #camaniva#3  = #cainliva#2;      || Factura

       #camaniva#4  = #cainliva#4;      || Fecha factura
       #camaniva#5  = #cainliva#31;     || Periodo
       #camaniva#7  = #0#7;      || Diario
       #camaniva#8  = #0#8;      || Fecha contable
       #camaniva#9  = #0#9;      || Documento

       |SI #caivaasi#168 = "A"; |HAZ DefPeriodo; |FINSI;

       #camaniva#10 = #cainliva#45;     || Departamento (Actividad)
       #camaniva#11 = #cainliva#47;     || SubDepartamento (Ref.Catastral/Cultivo)
       #camaniva#12 = #cainliva#5;      || Cuenta Cli/Pro
       #camaniva#13 = #cainliva#27;     || Nombre Cli/Pro
       #camaniva#14 = #cainliva#30;     || Cif Cli/Pro
       #camaniva#22 = #cainliva#53;     || N§ Factura
       #camaniva#24 = #cainliva#46;     || Descripcion Departamento (Actividad)
       #camaniva#25 = #cainliva#48;     || Descripcion SubDepartamento (Ref.Catastral/Cultivo)
       #camaniva#27 = #cainliva#7;      || Concepto Cli/Pro
       #camaniva#28 = #cainliva#8;      || Descripcion Cli/Pro
       #camaniva#29 = #cainliva#7;      || Concepto IVA
       #camaniva#30 = #0#18;            || Descripcion IVA
       #camaniva#31 = eaDesgIVA;        || Desglose IVA en Asiento
       #camaniva#34 = eaDesgDTO;        || Desglose Descuento
       #camaniva#36 = aTipoIVA;         || Soportado/Repercutido
       #camaniva#37 = "N";              || No Exportado
       #camaniva#38 = #cainliva#60;     || Numero Facturas 1
       #camaniva#39 = #cainliva#49;     || Cobro / Pago
       #camaniva#40 = 0;                || Liquidacion
       #camaniva#41 = #cainliva#61;     || Fecha Operacion
       #camaniva#42 = #cainliva#62;     || Clave 340
       #camaniva#43 = #cainliva#63;     || Primer Numero
       #camaniva#44 = #cainliva#64;     || Ultimo Numero
       #camaniva#45 = #cainliva#68;     || Rectificativa
       |GRABA 020#camaniva.b;

       |SI #200#1 = "S";
           |HAZ CreaVtosN;
       |FINSI;
       |HAZ LaIntracomun;
       |HAZ LaInversion;
       |HAZ LaReferencia;
   |FINSI;
   NumDocum = #camaniva#1;        || N§ de registro

   #camaniva#15 = #camaniva#15 + #cainliva#59;
   #camaniva#19 = #camaniva#19 + #cainliva#12;     || Total Bases   *************
   #camaniva#20 = #camaniva#20 + #cainliva#35;     || Total IRPF    *************
   #camaniva#17 = #camaniva#20;
   #camaniva#21 = #camaniva#21 + #cainliva#29;     || Total Factura *************
   #camaniva#23 = #camaniva#23 + (#cainliva#14 + #cainliva#16); || Total Cuotas **********
   #camaniva#26 = #camaniva#26 + #cainliva#11;     || Total Descuentos ************

   |SI #camaniva#35 = "I";
       |SI #cainliva#32 = "N";
           #camaniva#35 = "A";
       |FINSI;
   |SINO;
       |SI #camaniva#35 = " ";
           |SI #cainliva#32 = "S";
               #camaniva#35 = "I";
           |SINO;
               #camaniva#35 = "N";
           |FINSI;
      |SINO;
          |SI #cainliva#32 = "S";
              #camaniva#35 = "A";
          |FINSI;
      |FINSI;
   |FINSI;
   |GRABA 020#camaniva.a;
   |LIBERA #camaniva;


   |HAZ OperacionRebu;

   |DDEFECTO #caivalin;
   #caivalin#0  = #cainliva#0;                  || Libro
   #caivalin#1  = NumDocum;                     || Documento
   #caivalin#2  = #cainliva#3;                  || N§ de base
   #caivalin#3  = #cainliva#7;                  || Concepto
   #caivalin#4  = #0#18;                        || Descripcion
   #caivalin#5  = #cainliva#19;                 || Deducible S/N ????????
   #caivalin#6  = #cainliva#12;                 || Base imponible
   #caivalin#7  = #cainliva#13;                 || Tipo de IVA
   #caivalin#8  = #cainliva#14;                 || Cuota de IVA
   #caivalin#9  = #cainliva#15;                 || Tipo de recargo
   #caivalin#10 = #cainliva#16;                 || Cuota de recargo
   #caivalin#11 = #cainliva#11;                 || Descuento
   #caivalin#12 = #cainliva#17;                 || Contrapartida
   #caivalin#13 = #cainliva#20;                 || Cuenta de IVA
   #caivalin#14 = #cainliva#22;                 || Cuenta de recargo
   #caivalin#15 = #cainliva#24;                 || Cuenta de descuento
   #caivalin#16 = #cainliva#10;                 || Linea de tipo de iva
   #caivalin#17 = #cainliva#32;                 || Inversion
   #caivalin#18 = #cainliva#51;                 || Concepto IRPF
   #caivalin#19 = #cainliva#52;                 || Descripcion concepto IRPF
   #caivalin#25 = #cainliva#54;                 || Intracomunitaria
   #caivalin#26 = #cainliva#55;                 || En Especie
   #caivalin#27 = #cainliva#56;                 || Repercute
   #caivalin#28 = #cainliva#58;                 || Cuenta Analitica
   #caivalin#29 = #cainliva#57;                 || IVA Soportado Comun
   |SI #cainliva#59 = 0; |Y #cainliva#51 ! 0;
      |SI #cainliva#39 = "B";
          #cainliva#59 = #cainliva#12;                 || Base IRPF
      |SINO;
          #cainliva#59 = #cainliva#12 + #cainliva#14 + #cainliva#16;  || Base IRPF
      |FINSI;
   |FINSI;
   #caivalin#20 = #cainliva#59;
   |SI #cainliva#34 = 0; #caivalin#20 = 0;|FINSI;
   #caivalin#21 = #cainliva#34;                 || Tipo IRPF
   #caivalin#22 = #cainliva#35;                 || Cuota IRPF
   #caivalin#23 = #cainliva#36;                 || Cuenta IRPF
   #caivalin#30 = #cainliva#45;                 || Departamento (Actividad)
   #caivalin#31 = #cainliva#47;                 || SubDepartamento (Ref.Catastral/Cultivo)
   |GRABA 020#caivalin.n;
   |LIBERA #caivalin;

   |HAZ LaClaveZ14;
|FPRC;

|PROCESO QuitaHasta2Puntos;
     ||aTextoActual

     aAuxActual = "";
     aLong = aTextoActual % A0;
     nLong = aLong;
     |PARA nLetra = 1; |SI nLetra [ nLong; |HACIENDO nLetra = nLetra + 1;
          nSaca = (100 * nLetra) + 1;
          aSaca = nSaca;
          aLetra = aTextoActual % aSaca;
          |SI aLetra = ":";
               aAuxActual = aAuxActual + aLetra;
               |SAL;
          |SINO;
               aAuxActual = aAuxActual + aLetra;
          |FINSI;
     |SIGUE;
     aTextoActual = aAuxActual;
|FPRC;

|PROCESO Autorrelleno;
     aDef = aFicDsarchi + "dsarchi/def/dsarm004.mas";
     |CARGA_DEF aDef, trabajo1@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aDef = aFicDsarchi + "dsarchi/def/dsarm065.mas";
     |CARGA_DEF aDef, trabajo2@;
     |SI FSalida ! 0;
        |DESCARGA_DEF #trabajo1@;
        |ACABA;
     |FINSI;

     |PATH_DAT #trabajo1@#aPathDatos#;
     |PATH_DAT #trabajo2@#aPathDatos#;

     |ABRE #trabajo1@;
     |ABRE #trabajo2@;

     #trabajo1@#0 = #referen@#1;
     #trabajo1@#1 = #referen@#2;
     #trabajo1@#2 = #referen@#3;
     |LEE 000#trabajo1@.=;
     |SI FSalida = 0;  |Y #trabajo1@#88 ! 0;
         #trabajo2@#0 = #trabajo1@#88;
         |LEE 000#trabajo2@.=;
         |SI FSalida = 0;
             |PARA nCampoC = 2; |SI nCampoC [ 47; |HACIENDO nCampoC = nCampoC + 5;
                   nCampoE = nCampoC + 2;
                   nNumCampo  = #trabajo2@#nCampoC#;
                   nNumCampo2 = #trabajo2@#nCampoE#;
                   |SI nNumCampo ! 0; |Y nNumCampo2 ! 0;
                       |SI nNumCampo = 99;
                           aValorConta = "";

                           |ABRE #1002;
                           #1002#0 = #camaniva#0;
                           #1002#1 = #camaniva#1;
                           |LEE 000#1002=;
                           |SI FSalida = 0;
                               aValorConta = #1002#2;
                           |FINSI;
                           |CIERRA #1002;
                       |SINO;
                           aValorConta = #camaniva#nNumCampo#;
                       |FINSI;
                       |QBF aValorConta;
                       |SI aValorConta ! "";
                           aActual = #referen@#nNumCampo2#;  |QBF aActual;
                           |SI aActual ! "";
                               |SI nNumCampo2 ] 23; |Y nNumCampo2 [ 37;
                                   aTextoActual = aActual;
                                   |HAZ QuitaHasta2Puntos;
                                   aActual = aTextoActual;
                                   aActual = aActual + " " + aValorConta;
                                   #referen@#nNumCampo2# = aActual;
                               |SINO;
                                   |SI nNumCampo2 ] 60; |Y nNumCampo2 [ 64;
                                       aTextoActual = aActual;
                                       |HAZ QuitaHasta2Puntos;
                                       aActual = aTextoActual;
                                       aActual = aActual + " " + aValorConta;
                                       #referen@#nNumCampo2# = aActual;
                                   |SINO;
                                       #referen@#nNumCampo2# = aValorConta;
                                   |FINSI;
                               |FINSI;
                           |SINO;
                               #referen@#nNumCampo2# = aValorConta;
                           |FINSI;
                       |FINSI;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;
     |CIERRA #trabajo2@;
     |CIERRA #trabajo1@;

     |DESCARGA_DEF #trabajo2@;
     |DESCARGA_DEF #trabajo1@;
|FPRC;

|PROCESO GrabaDSARM005;
     aDef = aFicDsarchi + "dsarchi/def/dsarm005.mas";
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |PATH_DAT #999#aPathDatos#;
     nEmpresaConta = #48#0;
     aAux          = ("000000" + nEmpresaConta) % -106;
     aEmpresa      = aAux % 105;
     nEmpresaConta = aEmpresa;
     aPeriodo      = aAux % -101;
     nPeriodo      = aPeriodo;
     nLibroConta   = #cainliva#0;
     nLineaConta   = #cainliva#1;
     nRegFactura   = 100000000 + (nLibroConta * 1000) + nLineaConta;

     |ABRE #referen@;
     |SELECT #11#referen@;
     |PARA; |SI; |HACIENDO;
          #referen@#67 = nEmpresaConta;
          #referen@#68 = nPeriodo;
          #referen@#72 = nLibroConta;
          #referen@#73 = nRegFactura;
          |LEE 101#referen@.=;
          |SI FSalida ! 0;  |SAL;  |FINSI;

          #referen@#69 = #camaniva#7;
          #referen@#70 = #camaniva#8;
          #referen@#71 = #camaniva#9;
          #referen@#72 = #camaniva#0;
          #referen@#73 = #camaniva#1;

          |HAZ Autorrelleno;

          |GRABA 020#referen@.a;
          |LIBERA #referen@;
     |SIGUE;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO GrabaGAD;
     |DBASS aBaseA;
     |QBF aBaseA;
     aBaseA = aBaseA + "dsarchi/fich/";
     |PATH_DAT #dsarm005#aBaseA#;

                          nNumReg = 0;
     |SI aTipoIVA = "R";  nNumReg = #dpntm100#50;  |FINSI;
     |SI aTipoIVA = "S";  nNumReg = #dpntm101#50;  |FINSI;

     |SI nNumReg =  0;  |ACABA;  |FINSI;

     |ABRE #dsarm005;
     #dsarm005#0 = nNumReg;
     |LEE 101#dsarm005.=;
     |SI FSalida = 0;
         nEmpresaConta = #48#0;
         aAux = ("000000" + nEmpresaConta) % -106;
         aEmpresa = aAux % 105;
         nEmpresaConta = aEmpresa;
         aPeriodo = aAux % -101;
         nPeriodo = aPeriodo;

         #dsarm005#67 = nEmpresaConta;
         #dsarm005#68 = nPeriodo;
         #dsarm005#69 = #camaniva#7;
         #dsarm005#70 = #camaniva#8;
         #dsarm005#71 = #camaniva#9;
         #dsarm005#72 = #camaniva#0;
         #dsarm005#73 = #camaniva#1;
         #dsarm005#74 = #camaniva#12;
         #dsarm005#10 = #camaniva#14;
         #dsarm005#38 = #camaniva#13;
         |GRABA 020#dsarm005.a;
         |LIBERA #dsarm005;
     |FINSI;
     |CIERRA #dsarm005;
|FPRC;

|PROCESO ActLineas;
   |SI #0#6 =  "F";
       |SI #cainliva#4 [ fec3; |O #cainliva#4 < fec1;
           |SI aLasBl ! "S";
              |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

|SI PARAMETRO ! "GAD";  |Y PARAMETRO ! "CSV";
   |SI SerieAntC ! #cainliva#26; |O FactAntC !  #cainliva#2; |O LibroAntC ! #cainliva#0;
       nRepetido = 0;
       SerieAntC = #cainliva#26;
       FactAntC  = #cainliva#2;
       LibroAntC = #cainliva#0;
       |SELECT #3#camaniva;
       #camaniva#0 = #cainliva#0;
       #camaniva#2 = #cainliva#26;
       #camaniva#3 = #cainliva#2;
       |LEE 041#camaniva.=;
       |SI FSalida = 0;
           nRepetido = 1;
       |FINSI;
       |SELECT #1#camaniva;
       |DDEFECTO #camaniva;
   |FINSI;

   |SI nRepetido = 1; |ACABA; |FINSI;
|FINSI;

   |HAZ Recalculo;  ||para volver a recalcular las cuentas de IVA
   |SI #cainliva#11 = 0; |Y #cainliva#12 = 0; |Y #cainliva#14 = 0; |Y #cainliva#16 = 0; |Y #cainliva#35 = 0;
||       |ACABA;
   |FINSI;

   #0#18 = #cainliva#8;
   |HAZ CreaAsiento;
   |SI nError = 1;
       |ERROR10;
       |ACABA;          ||no puedo seguir
   |FINSI;

   |HAZ CreaIva;
   LibroAnt = #cainliva#0;
   SerieAnt = #cainliva#26;
   FactAnt  = #cainliva#2;
   aDepAnt  = #cainliva#45;
   aSubAnt  = #cainliva#47;
   aRefAnt  = #cainliva#53;
   aCliPro  = #cainliva#5;
   aCliPro1 = #cainliva#27;
   Primero  = 1;

   |BORRA 020#cainliva.a;

   || anotacion para Carlos Cortes (21.04.2010)
   ||TODO CCC.
   ||SI TENGO INSTALADO DSARCHI Y ACTIVADO EL CONTAGEN
   ||BUSCAR EN REGISTRO LAS FACTURAS Y ACTUALIZAR.

   |DBASS aFicDsarchi;
   |QBF aFicDsarchi;
   aDSERP = aFicDsarchi + "dsarchi/def/dsarm001.mas";
   |XABRE "E", aDSERP, 0;
   |SI FSalida = 0;
       aPathDatos = aFicDsarchi + "dsarchi/fich/";
       nSwContaArchi = 0;
       aDef = aFicDsarchi + "dsarchi/def/dsarm001";
       |CARGA_DEF aDef, referen@;
       |SI FSalida = 0;
           |PATH_DAT #999#aPathDatos#;
           |ABRE #referen@;
           |LEE 000#referen@.p;
           |SI FSalida = 0;
               |SI #referen@#9 = "S";
                   nSwContaArchi = 1;
               |FINSI;
           |FINSI;
           |CIERRA #referen@;
           |DESCARGA_DEF #referen@;

           |SI nSwContaArchi = 1;
               |HAZ GrabaDSARM005;
           |FINSI;
       |FINSI;
   |FINSI;

   |LIBERA #cainliva;

   |SI #cainliva#69 ! 0;
       nEmpresa = #48#2;
       |DBASS aPathDSARCHI;   |QBF aPathDSARCHI;
       aPathDSARCHI = aPathDSARCHI + "despanet/" + (("00000" + nEmpresa) % -105) + "/fich/";

       |SI aTipoIVA = "R";
           |PATH_DAT #dpntm100#aPathDSARCHI#;
           |PATH_DAT #dpntm102#aPathDSARCHI#;

           |ABRE #dpntm100;
           |ABRE #dpntm102;
           #dpntm100#0 = #cainliva#69;
           |LEE 101#dpntm100.=;
           |SI FSalida = 0;
               |SI #dpntm100#44 = "S";
                   |LEE 000#dpntm102.u;
                   |SI FSalida ! 0;  #dpntm102#0 = 0;  |FINSI;
                   nReg = #dpntm102#0 + 1;

                   |DDEFECTO #dpntm102;
                   #dpntm102#0 = nReg;

                   |PARA nCampo = 1;  |SI nCampo [ 28;  |HACIENDO nCampo = nCampo + 1;
                         #dpntm102#nCampo# = #dpntm100#nCampo#;
                   |SIGUE;

                   #dpntm102#29 = #camaniva#0;
                   #dpntm102#30 = #camaniva#1;

                   |PARA nCampo = 30;  |SI nCampo [ 43;  |HACIENDO nCampo = nCampo + 1;
                         nCampo1 = nCampo + 1;
                         #dpntm102#nCampo1# = #dpntm100#nCampo#;
                   |SIGUE;

                   |GRABA 020#dpntm102.n;
                   |LIBERA #dpntm102;

                   |HAZ GrabaGAD;
               |FINSI;

               |BORRA 020#dpntm100.a;
               |LIBERA #dpntm100;
           |FINSI;
           |CIERRA #dpntm100;
           |CIERRA #dpntm102;
       |FINSI;

       |SI aTipoIVA = "S";
           |PATH_DAT #dpntm101#aPathDSARCHI#;
           |PATH_DAT #dpntm103#aPathDSARCHI#;

           |ABRE #dpntm101;
           |ABRE #dpntm103;
           #dpntm101#0 = #cainliva#69;
           |LEE 101#dpntm101.=;
           |SI FSalida = 0;
               |SI #dpntm101#44 = "S";
                   |LEE 000#dpntm103.u;
                   |SI FSalida ! 0;  #dpntm103#0 = 0;  |FINSI;
                   nReg = #dpntm103#0 + 1;

                   |DDEFECTO #dpntm103;
                   #dpntm103#0 = nReg;

                   |PARA nCampo = 1;  |SI nCampo [ 28;  |HACIENDO nCampo = nCampo + 1;
                         #dpntm103#nCampo# = #dpntm101#nCampo#;
                   |SIGUE;

                   #dpntm103#15 = #camaniva#4;
                   #dpntm103#29 = #camaniva#0;
                   #dpntm103#30 = #camaniva#1;

                   |PARA nCampo = 30;  |SI nCampo [ 43;  |HACIENDO nCampo = nCampo + 1;
                         nCampo1 = nCampo + 1;
                         #dpntm103#nCampo1# = #dpntm101#nCampo#;
                   |SIGUE;

                   |GRABA 020#dpntm103.n;
                   |LIBERA #dpntm103;

                   |HAZ GrabaGAD;
               |FINSI;

               |BORRA 020#dpntm101.a;
               |LIBERA #dpntm101;
           |FINSI;
           |CIERRA #dpntm101;
           |CIERRA #dpntm103;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE ActLineas;
 #cainliva#2;
 4;
 #caintiva#0,#0#11,#0#2,01, #0#4;
 #caintiva#0,#0#12,#0#3,99, #0#5;
 e;
 NULL,ActLineas;
|FIN;

|PROCESO Tipo15Fm5;
     ||VACIO
|FPRC;
|PROCESO Tipo16Fm5;
     ||VACIO
|FPRC;

|PROCESO Tipo17Fm5;
     ||VACIO
|FPRC;

|PROCESO Actualizacion1;
   nRepetido = 0;
   SerieAntC = "";
   FactAntC  = 0;
   LibroAntC = 0;

   |BUCLE ActLineas;
   |SI Primero = 1; |Y nError = 0; |HAZ CobroPago; |FINSI;

   |ABRE #cainliva;
   |DDEFECTO #cainliva;
   #cainliva#0 = #caintiva#0;
   |LEE 010#cainliva.];
   |SI FSalida = 0;
      |SI #cainliva#0 ! #caintiva#0;
          |BORRA 020#caintiva.a;
      |FINSI;
   |SINO;
      |BORRA 020#caintiva.a;
   |FINSI;
   |LIBERA #caintiva;
   |CIERRA #cainliva;
|FPRC;

|DEFBUCLE Actualizacion;
 #caintiva#1;
 ;
 #0#0;
 #0#1;
 e;
 NULL,Actualizacion1;
|FIN;

|PROCESO PidoFecha;

     |PUSHV  0823 1271;
     |BLANCO 0823 1271;
     |CUADRO 0823 1271;

     |SI swEF1 = 1;
         aAlfa1 = " EXISTEN FACTURAS CON FECHA INFERIOR O ";
         aAlfa2 = " IGUAL A LA FECHA DE BLOQUEO DE DATOS. ";
         |SI swError = 2;
             aAlfa1 = " HAY FACTURAS QUE NO SE PUEDEN CONTABILIZAR ";
             aAlfa2 = " A FECHA FACTURA, ES INFERIOR AL EJERCICIO  ";
         |FINSI;
     |FINSI;

     aAlfa  = "COBROS"; |SI aTipoIVA = "S"; aAlfa = "PAGOS"; |FINSI;
     |SI swEF2 = 1;
         aAlfa1 = " EXISTEN " + aAlfa + " CON FECHA INFERIOR O ";
         aAlfa2 = " IGUAL A LA FECHA DE BLOQUEO DE DATOS. ";
         |SI swError = 2;
             aAlfa1 = " HAY " + aAlfa + " QUE NO SE PUEDEN CONTABILIZAR ";
             aAlfa2 = " A SU FECHA, ESTAN FUERA DEL EJERCICIO ";
         |FINSI;
     |FINSI;

     |SI swEF2 = 1; |Y swEF1 = 1;
         aAlfa1 = " EXISTEN FACTURAS Y " + aAlfa + " CON FECHA    ";
         aAlfa2 = " INFERIOR O IGUAL A LA FECHA DE BLOQUEO DE DATOS. ";
         |SI swError = 2;
             aAlfa1 = " HAY FACTURAS Y " + aAlfa + " QUE NO SE PUEDEN CONTA-";
             aAlfa2 = " BILIZAR A SU FECHA, ESTAN FUERA DEL EJERCICIO ";
         |FINSI;
     |FINSI;

     |ATRI I;
     |PINTA 0924, aAlfa1;
     |PINTA 1024, aAlfa2;

     |ATRI P;
     |PINTA 1124, " CONTINUAR S/N                         ";
      E_sup  = 1;
      E_inf  = "SNsn";
      aAlfa1 = 1139 ? 0; aAlfa1 = aAlfa1 > ""; |PINTA 1139, aAlfa1;
      |SI aAlfa1 = "N";
          swError = -1;
          |POPV;
          |ACABA;
      |FINSI;

 |SI #0#6 = "F";
      |PINTA 1124, " ACTUALIZARLAS CON OTRA FECHA S/N      ";
      |ATRI 0;
       E_sup  = 1;
       E_inf  = "SNsn";
       aLasBl = 1158 ? 0; aLasBl = aLasBl > ""; |PINTA 1158, aLasBl;
       |SI aLasBl = "S";
           |PINTA 1224, "                                       ";

           |C_M #0#8,1,"S"; |C_P #0#8,1,1441;
           |SI swError = 1; #0#8 = fec3 + "01.00.0000"; |FINSI;
           |SI swError = 2; #0#8 = ~;                   |FINSI;
           |CUADRO 1323 1563;
           |PINTA 1424, " Fecha Asiento :                       ";
           |ET camp;
               |ENCAMPO #8#0;
               |HAZ LaFechaN;
               |SI swError = 1;
                   |VETE camp;
               |FINSI;
           fFechaN = #0#8;
       |FINSI;
  |SINO;
      |PINTA 1124, " SE ACTUALIZAR CON LA FECHA DE LA PANTALLA";
      |PAUSA;
      aLasBl = "S";
   |FINSI;

   |POPV;
|FPRC;
|| ******************************************************************

|PROCESO PaseFacturas;
  |HAZ Analitica;
  |SI enSwAna = 1;
      eaFitnW12 = "12wnliva"; |NOME_DAT #212 eaFitnW12;
      eaFitnW13 = "13wnliva"; |NOME_DAT #213 eaFitnW13;
  |FINSI;

  #0#1 = #0#0;  ||Solo un libro

  efFechaIVA = ~; enLineaIVA = 1; |HAZ SacaIVA;

  fFechaA = "01.01.0000";
  |SI #0#6 ! "F"; fFechaA = #0#8; |FINSI;

  |ABRE #camaniva;
  |SELECT #3#camaniva;
  swError = 0;
  |BUCLE MiraErrores0;
  |SELECT #1#camaniva;

  |SI swError = 1;                || No actualizo, existen errores
      |CIERRA #camaniva;
      |CONFI "    SDesea obtener un Listado con los Errores detectados";
      |SI FSalida = 0;
          enLibro  = #0#0;
          enDFra   = #0#2;
          enHFra   = #0#3;
          eaDSerie = #0#11;
          eaHSerie = #0#12;
          efDFecha = #0#4;
          efHFecha = #0#5;
          aAlfa    = "cay0ivas;" + aTipoIVA;
          |SUB_EJECUTA_NP aAlfa;
      |FINSI;
      |ACABA;
  |FINSI;

||  |SI #0#6 = "F";
      |BUCLE LeeFechas;
      |SI swError ! 0;
          |HAZ PidoFecha;
          |SI swError = -1;
               |CIERRA #camaniva;
               |ACABA;
          |FINSI;
/*
           |PUSHV  0823 1268;
           |BLANCO 0823 1268;
           |CUADRO 0823 1268;
           aAlfa1 = " EXISTEN FACTURAS CON FECHA INFERIOR O ";
           aAlfa2 = " IGUAL A LA FECHA DE BLOQUEO DE DATOS. ";
           |SI swError = 2;
               aAlfa1 = " HAY FACTURAS QUE NO SE PUEDEN CONTABILIZAR ";
               aAlfa2 = " A FECHA FACTURA, ES INFERIOR AL EJERCICIO  ";
           |FINSI;
           |ATRI I;
           |PINTA 0924, aAlfa1;
           |PINTA 1024, aAlfa2;

           |ATRI P;
           |PINTA 1124, " CONTINUAR S/N                         ";
           E_sup  = 1;
           E_inf  = "SNsn";
           aAlfa1 = 1139 ? 0; aAlfa1 = aAlfa1 > ""; |PINTA 1139, aAlfa1;
           |SI aAlfa1 = "N";
               |CIERRA #camaniva;
               |POPV;
               |ACABA;
           |FINSI;

           |PINTA 1124, " ACTUALIZARLAS CON OTRA FECHA S/N      ";
           |ATRI 0;
           E_sup  = 1;
           E_inf  = "SNsn";
           aLasBl = 1158 ? 0; aLasBl = aLasBl > ""; |PINTA 1158, aLasBl;
           |SI aLasBl = "S";
               |PINTA 1224, "                                       ";

               |C_M #0#8,1,"S"; |C_P #0#8,1,1441;
               |SI swError = 1; #0#8 = fec3 + "01.00.0000"; |FINSI;
               |SI swError = 2; #0#8 = ~;                   |FINSI;
               |CUADRO 1323 1563;
               |PINTA 1424, " Fecha Asiento :                       ";
               |ET camp;
                   |ENCAMPO #8#0;
                   |HAZ LaFechaN;
                   |SI swError = 1;
                       |VETE camp;
                   |FINSI;
               fFechaN = #0#8;
           |FINSI;
           |POPV;
*/

       |FINSI;
||   |FINSI;

   |DBASE aMas;
   aDef = aMas + "def/caivam03";
   |CARGA_DEF aDef, aivam03@;
   |SI FSalida ! 0;
       aDef  = "";
       |MENAV "    Error Cargando def caivam03";
       |ACABA;
   |FINSI;
   |NOME_DAT #113 "m03caiva";

   fechaW17 = "01.01.0000";

   nEsComersan = 0;
   |HAZ EsComersan;
   |SI FSalida = 0; nEsComersan = 1; |FINSI;

   aFichero = "1z" + Usuario;
   |NOME_DAT #99 aFichero;
   |DELINDEX #99;

   |ABRE #caivalin;
   |ABRE #camaasic;
   |ABRET #2;

   nREBU  = 0;
   nSwHay = 0;
   Primero = 0;
   SerieAnt = "";
   FactAnt  = 0;
   LibroAnt = 0;
   nRepetido = 0;
   SerieAntC = "";
   FactAntC  = 0;
   LibroAntC = 0;
   aDepAnt  = "";
   aSubAnt  = "";
   aRefAnt  = "";
   aCliPro  = "";
   aCliPro1 = "";
   swNuevo      = 0;
   TotalFactura = 0;
   Cta_cob1     = "";
   dig_cob1     = 0;
   Cta_cob2     = "";
   dig_cob2     = 0;
   Con_cob1     = 0;
   Con_cob2     = "";
   nLlegoa9     = 0;
   nNum9        = 0;
   nError       = 0;
   |BUCLE Actualizacion;

   |CIERRAT #2;
   |CIERRA #camaasic;
   |CIERRA #caivalin;
   |CIERRA #camaniva;

   |SI aDef ! ""; |DESCARGA_DEF #aivam03@; |FINSI;

   |SI nSwHay = 1;
       |HAZ ActContador;
       |SI #200#120 = "S";  |Y PARAMETRO ! "GAD";  |Y PARAMETRO ! "CSV";
          |CONFI "    SDESEA REALIZAR LA BUSQUEDA DE FACTURAS DUPLICADAS S/N ?";
          |SI FSalida = 0;
              aAlfa1 = #0#0; aAlfa1 = ("00" + aAlfa1) % -102;
              aAlfa1 = "cacherep;" + aTipoIVA + aAlfa1;
              |SUB_EJECUTA_NP aAlfa1;
          |FINSI;
       |FINSI;
   |SINO;
       |MENAV "0000Seleccion vacia";
   |FINSI;

   |SI nREBU ! 0;
       |BLANCO 0906 1676;
       |CUADRO 0906 1676;
       |ATRI P;
       |PINTA 1107, " Se han actualizado Facturas en el Regimen Especial de Bienes Usados ";
       |PINTA 1207, " Complete los datos de las operaciones REBU modificando las facturas ";
       |PINTA 1307, " o desde el Mantenimiento de dichas operaciones.                     ";
       |PINTA 1407, " Desea obtener un listado de las facturas S/N:                       ";
       |ATRI 0;
        E_sup  = 1;
        E_inf  = "SNsn";
        aSiNo  = 1454 ? 0;
        aSiNo  = aSiNo > " "; |ATRI P; |PINTA 1454, aSiNo; |ATRI 0;
        |SI aSiNo = "S";
            |HAZ ImprRebu;
        |FINSI;
   |FINSI;
   |DELINDEX #99;
|FPRC;

|| ***************************************************** PROGRAMA
|PROGRAMA;
    |SI PARAMETRO = "GAD";
        |DDEFECTO #0;

        |ABRE #200;
        |LEE 000#200p;
        |CIERRA #200;

        aElCero  = #200#115;
        eaMulDep = #200#132;
        eaPaDOM1 = #200#114;
        eaPaDOM2 = #200#133;
        eaPaDOM3 = #200#134;
        eaPaCTA1 = #200#135;  ||permitir alta no estructuras 2008
        eaPaCTA2 = #200#136;  ||Aviso 1990
        eaPaNif1 = #200#152;
        eaPaNif2 = #200#153;
        eaABanco = #200#161;
        eaObClPr = #200#186;

        #0#0 = enLibro;
        #0#4 = fec1;
        #0#5 = fec2;
        #0#6 = "F";
        #0#8 = "01.01.0000";

        |HAZ BuscaDoc;

        |NOME_DAT #caintiva#eaFichCab#;
        |NOME_DAT #cainliva#eaFichLin#;

        |HAZ PaseFacturas;

        |ACABA;
    |FINSI;

    |SI PARAMETRO = "CSV";
        |DDEFECTO #0;

        |ABRE #200;
        |LEE 000#200p;
        |CIERRA #200;

        aElCero  = #200#115;
        eaMulDep = #200#132;
        eaPaDOM1 = #200#114;
        eaPaDOM2 = #200#133;
        eaPaDOM3 = #200#134;
        eaPaCTA1 = #200#135;  ||permitir alta no estructuras 2008
        eaPaCTA2 = #200#136;  ||Aviso 1990
        eaPaNif1 = #200#152;
        eaPaNif2 = #200#153;
        eaABanco = #200#161;
        eaObClPr = #200#186;

        #0#0 = enLibro;
        #0#4 = "01.01.0000";
        #0#5 = "31.12.9999";
        #0#6 = "F";
        #0#8 = "01.01.0000";

        |HAZ BuscaDoc;

        |HAZ PaseFacturas;

        |ACABA;
    |FINSI;

   |CLS;
   a_param = PARAMETRO;
   a_param = a_param % 101; |QBF a_param;
   |SI a_param ! "";
       a_param = a_param % 101;
       aTipoIVA = a_param;
   |FINSI;

   |HAZ inicial; |SI swerror = 2; |ACABA; |FINSI;

   |ABRE #200;
   |LEE 000#200p;
   |CIERRA #200;
   aElCero  = #200#115;
   eaMulDep = #200#132;
   eaPaDOM1 = #200#114;
   eaPaDOM2 = #200#133;
   eaPaDOM3 = #200#134;
   eaPaCTA1 = #200#135;  ||permitir alta no estructuras 2008
   eaPaCTA2 = #200#136;  ||Aviso 1990
   eaPaNif1 = #200#152;
   eaPaNif2 = #200#153;
   eaABanco = #200#161;
   eaObClPr = #200#186;

   |DDEFECTO #0;
   |SI aTipoIVA ! "";
       |SI enLibIVA = 0;
           |HAZ LeeDefIVA;
           #0#0 = dLibro;
           |C_M #0#0,1,snLibro;
       |SINO;
           #0#0 = enLibIVA; |C_M #0#0,1,"N";
           |HAZ LeeDefIVA;
           a_param = aTipoIVA;
       |FINSI;
   |FINSI;

   |CABEZA "Actualizacion Facturas de IVA";

   |PINPA #0#0;

   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.2000"; |FINSI;
   #0#4 = fDFecha;
   #0#5 = fec2;
   |HAZ BuscaDoc;

   |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
       |HAZ PaseFacturas;
   |FINSI;
|FPRO;


|| ***********************************************************************
|| ............ Subrutina de Asientos
|PROCESO adapta1;
  #2#13 = #cainliva#0;
  #2#14 = #cainliva#2;
  #2#15 = #cainliva#26;
  #2#21 = #cainliva#45;
  #2#26 = #cainliva#53;
  Comodin = Usuario % 0810;
  #2#27 = Comodin;
  #2#28 = #cainliva#47;

   |SI #2#8 = "D";
      #2#16 = #2#4;
      #2#17 = #2#5;
      #2#10 = "";
      #2#11 = 0;
   |SINO;
      #2#16 = "";
      #2#17 = 0;
      #2#10 = #2#4;
      #2#11 = #2#5;
   |FINSI;
   |SI #2#19 = "F"; |O #2#19 = "B";
       |SI #2#8 = "D"; aCtaDebe  = #2#4; |FINSI;
       |SI #2#8 = "H"; aCtaHaber = #2#4; |FINSI;
   |FINSI;

   aAlfa1 = #2#4; |QBF aAlfa1;
   |SI aAlfa1= "";
       |MENAV "    Atencion. Asiento con Cuenta en Blanco. Repasar";
   |FINSI;
|FPRC;

|PROCESO adapta2;

   aDeMas = "";
   |SI #2#12 = "C"; |O #2#12 = "P";
       |SI #2#12 = "C"; aDeMas = #200#99;  |FINSI;
       |SI #2#12 = "P"; aDeMas = #200#100; |FINSI;
       |SI aCampo49 = "P"; aDeMas = dAnyCar; |FINSI;
       |SI aCampo49 = "T"; aDeMas = dAnyCEf; |FINSI;
   |FINSI;
   |SI #2#12 ! "C"; |Y #2#12 ! "P";
       |SI #2#19 ! "P";
           aDeMas = #200#45;
           |SI #2#19 = "B"; |O #2#19 = "I"; |O #2#19 = "R";
               |O #2#19 = "b"; |O #2#19 = "i"; |O #2#19 = "r";
               |SI #200#130 ! "=  ";
                   aDeMas = #200#130;
               |FINSI;
           |FINSI;
           |SI #200#131 = "S"; |Y aDeMas = #200#45; |ACABA; |FINSI;
       |SINO;
           aDeMas = #200#96;
           |SI #200#131 = "S"; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   |QBF aDeMas; |SI aDeMas = ""; |ACABA; |FINSI;

   aAlfa5 = "";
   aAlfa1 = #2#7;
   |SI #200#131 = "S";
       |ABRE #dsmom030;
       |DDEFECTO #dsmom030;
       #dsmom030#0 = #2#6;
       |LEE 001#dsmom030.=;
       |CIERRA #dsmom030;
       aAlfa1 = #dsmom030#1;
   |FINSI;
   |QBF aAlfa1;  || Descripcion
   aAlfa2 = aDeMas;

   |QBF aAlfa2;  || lo que a¤ade
   aAlfa3 = aAlfa2 % 0;
   nDCon0 = aAlfa3;
   |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
         aAlfa3 = nDCon1;
         aAlfa3 = aAlfa3 + "01";
         aDCon2 = aAlfa2 % aAlfa3;
         |HAZ adapta2_c;
         aAlfa5 = aAlfa5 + aDCon1;
  |SIGUE;
  #2#7 = aAlfa1 + aAlfa5;

  |SI #2#12 ! "C"; |Y #2#12 ! "P";
      |SI #200#131 = "S";
          |SI #2#19 = "B"; |O #2#19 = "b";
              #0#18 = #2#7;
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO adapta2_c;  ||El concepto

    aDCon1 = "";
    |SI aDCon2 = "S";
         aDCon1 = #cainliva#26; |QBF aDCon1;
         |SI aDCon1 ! ""; aDCon1 = aDCon1 + aSepSer; |QBF aDCon1; |FINSI;
     |FINSI;                                         || Serie
     |SI aDCon2 = "F";
         aDCon1 = #cainliva#2; |QBF aDCon1;
         |SI aNumIzq = "S";
             aDCon1 = ("000000" + aDCon1) % -106;
         |FINSI;
     |FINSI;                                         || Factura

     |SI aDCon2 = "C";
         aDCon1 = #cainliva#5; |QBF aDCon1;
     |FINSI;                                         || Cuenta Cliente

     |SI aDCon2 = "N";
         aDCon1 = #cainliva#27; |QBF aDCon1;
     |FINSI;                                         || Nombre Cliente

     |SI aDCon2 = "R";
         |SI #cainliva#53 ! "                    ";
             aDCon1 = #cainliva#53; |QBF aDCon1;
         |FINSI;
     |FINSI;                                         || Referencia

     |SI aDCon2 = "P";
         aDCon1 = #cainliva#53;
         |SI aTipoIVA = "S";
             |HAZ EsComersan;
             |SI FSalida = 0; aDCon1 = #cainliva#72;  |FINSI;
         |FINSI;
         |QBF aDCon1;
     |FINSI;                                         || Referencia Comersan

     |SI aDCon1 ! "";
         |SI aDCon2 = "F";
             aAlfa7 = aAlfa2 - "S";
             |SI aAlfa7 ! aAlfa2; |Y #cainliva#26 > "     ";
                 |ACABA;
             |FINSI;
         |FINSI;
         aDCon1 = " " + aDCon1;
     |FINSI;
|FPRC;

|PROCESO adapta3;       || cambios de signos en ABONOS

   |SI snAbono ! "S";   || ...  No cambiar signo en Abonos Salir
       |ACABA;
   |FINSI;

   |SI aSigAn = "";     || Es la primera linea de este
       |SI importe < 0;
           |HAZ CambiaSigno;
       |FINSI;
       |ACABA;
   |FINSI;

|| ----------------------------------------------------------

   |SI aSigno = aSigAn;      ||Por ahora es signo sin abono

       import2 = #2#9 + importe;
       |SI import2 ] 0;
           |ACABA;           ||Queda positivo
       |SINO;
           import1 = #2#9;   ||Queda negativo
           import2 = importe;
           importe = -#2#9;   ||Desactualiza
           |HAZ act_cabecera;
           |HAZ Actualiza;

           #2#9 = 0;
           importe = import1 + import2;
           |HAZ CambiaSigno;
      |FINSI;

   |SINO;

       || ............ Ya era Abono
       |SI importe < 0;   || Es negativo ahora tambien
           importe = -importe;
           |ACABA;
       |FINSI;


       import1 = #2#9;   ||Queda negativo
       import2 = importe;
       importe = -#2#9;
       |HAZ act_cabecera;
       |HAZ Actualiza;

       importe = import2 - #2#9;
       #2#8    = aSigno;
       #2#9    = 0;
       |SI importe ] 0;
           |ACABA;           ||Queda positivo
       |SINO;
           |HAZ CambiaSigno;
       |FINSI;

   |FINSI;
|FPRC;

|PROCESO adapta4;

  #2#13 = LibroAnt;
  #2#14 = FactAnt;
  #2#15 = SerieAnt;
  #2#21 = aDepAnt;
  #2#26 = aRefAnt;
  Comodin = Usuario % 0810;
  #2#27 = Comodin;
  #2#28 = aSubAnt;

  |SI #2#8 = "D";
      #2#16 = #2#4;
      #2#17 = #2#5;
      #2#10 = "";
      #2#11 = 0;
   |SINO;
      #2#16 = "";
      #2#17 = 0;
      #2#10 = #2#4;
      #2#11 = #2#5;
   |FINSI;

   aDeMas = "";
   |SI #2#12 = "C"; |O #2#12 = "P";
       || .. |SI #2#12 = "C"; aDeMas = #200#99;  |FINSI;
       || .. |SI #2#12 = "P"; aDeMas = #200#100; |FINSI;
       |SI aCampo49 = "P"; aDeMas = dAnyCar; |FINSI;
       |SI aCampo49 = "T"; aDeMas = dAnyCEf; |FINSI;
   |FINSI;

   |QBF aDeMas; |SI aDeMas = ""; |ACABA; |FINSI;

   aAlfa5 = "";
   aAlfa1 = #2#7;   |QBF aAlfa1;  || Descripcion
   aAlfa2 = aDeMas;

   aAlfa3 = aAlfa2 % 0;
   nDCon0 = aAlfa3;
   |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
         aAlfa3 = nDCon1;
         aAlfa3 = aAlfa3 + "01";
         aDCon2 = aAlfa2 % aAlfa3;
         |HAZ adapta4_c;
         aAlfa5 = aAlfa5 + " " + aDCon1;
  |SIGUE;

   #2#7 = aAlfa1 + aAlfa5;
|FPRC;

|PROCESO adapta4_c;
   aDCon1 = "";
   |SI aDCon2 = "S";
        aDCon1 = SerieAnt; |QBF aDCon1;
        aDCon1 = aDCon1 + aSepSer; |QBF aDCon1;
   |FINSI;                                         || Serie

   |SI aDCon2 = "F";
       aDCon1 = FactAnt; |QBF aDCon1;
       |SI aNumIzq = "S";
           aDCon1 = ("000000" + aDCon1) % -106;
       |FINSI;
   |FINSI;                                         || Factura

   |SI aDCon2 = "C";
       aDCon1 = aCliPro; |QBF aDCon1;
   |FINSI;                                         || Cuenta Cliente

   |SI aDCon2 = "N";
       aDCon1 = aCliPro1; |QBF aDCon1;
   |FINSI;                                         || Nombre Cliente

   |SI aDCon2 = "R";
       |SI #2#26 ! "                    ";
           aDCon1 = #2#26; |QBF aDCon1;
       |FINSI;
   |FINSI;                                         || Referencia
|FPRC;

|PROCESO CambiaSigno;
 |SI #2#8 = "D";
     #2#8 = "H";
 |SINO;
     #2#8 = "D";
 |FINSI;
 importe = -importe;
|FPRC;


|PROCESO cabecera; || lee la cabecera.

   nError = 0;
   |SI docume > 999999; |O nLlegoa9 = 1;
       nNum9 = nNum9 + 1;
       |SI nLlegoa9 = 0;
           |HAZ PreguntoSeguir;
           |SI nError = 1; |ACABA; |FINSI;
       |FINSI;
       nLlegoa9 = 1;
       docume = nNum9;
       #0#9   = docume;
   |FINSI;

   |DDEFECTO #1;
   #1#0 = diario;
   #1#1 = fecha;
   #1#2 = docume;
   #1#3 = docume;
   linea = 1;
   |LEE 040#1=;
   |SI FSalida = 0;
       |HAZ BuscaUlt;
       |SI nError = 1; |ACABA; |FINSI;  ||no puedo seguir
       |DDEFECTO #1;
       #0#9 = docume;
   |FINSI;
   #1#0 = diario;
   #1#1 = fecha;
   #1#2 = docume;
   #1#3 = docume;
   linea = 1;
   |HAZ NuevoRegistro;
   #camaasic#12 = nREGISTRO;
   |GRABA 020#1n;

   lineaIVA = 0;
   lineaRec = 0;
   lineaDto = 0;
   aCtaDebe  = "";
   aCtaHaber = "";
   nSumaTipo = 0;
|FPRC;

|PROCESO act_cabecera;

   #camaasic#0 = diario;
   #camaasic#1 = fecha;
   #camaasic#2 = docume;
   |LEE 101#1=;

   |SI #2#12 = "R";  #camaasic#13 = 1 + nSumaTipo;  |FINSI;
   |SI #2#12 = "S";  #camaasic#13 = 2 + nSumaTipo;  |FINSI;
   |SI #2#12 = "N";  #camaasic#13 = 3;  |FINSI;

   |SI #2#8 = "D";
       #camaasic#4 = #camaasic#4 + importe;
   |SINO;
      #camaasic#5 = #camaasic#5 + importe;
   |FINSI;
   #camaasic#6 = #camaasic#4 - #camaasic#5;        || saldo
   #camaasic#17 = aRefAnt;

   |SI #camaasic#9 = 0;
       |SI aCtaDebe ! "";
           eaCuenta = aCtaDebe; |HAZ SacaNivel;
           #camaasic#8 = aCtaDebe;
           #camaasic#9 = enNivel;
       |FINSI;
   |FINSI;
   |SI #camaasic#11 = 0;
       |SI aCtaHaber ! "";
           eaCuenta = aCtaHaber; |HAZ SacaNivel;
           #camaasic#10 = aCtaHaber;
           #camaasic#11 = enNivel;
       |FINSI;
   |FINSI;

   |GRABA 020#1a;
   |LIBERA #1;
|FPRC;

|PROCESO ReGrabaL;
 #13#0 = #12#0;
 #13#1 = #12#1;
 #13#2 = #12#2;
 #13#3 = #12#3;
 #13#4 = #12#4;
 #13#5 = #213#5;

 #13#6 = #213#6;
 #13#7 = #213#7;
 #13#8 = #213#8;
 #13#9 = #213#9;
 |GRABA 040#13n;

 |BORRA 020#213a;
 |LIBERA #213;
|FPRC;

|PROCESO Grupo_Recarga;
  |SI enSwAna = 0;  |ACABA; |FINSI;  || No hay analitica

  |ABRE #212;
  #212#0 = #cainliva#0;
  #212#2 = #cainliva#2;
  #212#3 = #cainliva#1;
  #212#4 = #cainliva#58;
  |LEE 101#212=;
  |SI FSalida = 0;
      |ABRE #12;
      #12#0 = #camaasil#0;
      #12#1 = #camaasil#1;
      #12#2 = #camaasil#2;
      #12#3 = #camaasil#3;
      #12#4 = #camaasil#29;
      #12#5 = #212#5;
      #12#6 = #212#6;
      #12#7 = #212#7;
      #12#8 = #212#8;
      |GRABA 040#12n;
      |SI FSalida = 0;
          |ABRE #13;
          |BUCLELIN 2ReGrabaL#212;
          |CIERRA #13;
      |FINSI;
      |CIERRA #12;
      |BORRA 020#212a;
  |FINSI;
  |LIBERA #212;
  |CIERRA #212;
|FPRC;

|PROCESO Actualiza;
   MasMenos     = importe;
   DebeHaber    = #2#8;
   aCUENTA      = #2#4;
   nREGISTRO    = #2#24;
   nDIARIO      = #2#0;
   aFECHA       = #2#1;
   nDOCUMENTO   = #2#2;
   nNIVELCUENTA = #2#5;

   |HAZ ActDiario;          || diario
   |HAZ ActCuenta;          || cuenta
   |HAZ ActTesteo;          || cuenta
   nSwHay = 1;
|FPRC;

|PROCESO Recalculo;
 efFechaIVA = #cainliva#4; enLineaIVA = #cainliva#10; |HAZ SacaIVA;
 |SI enLineaIVA < 0; |ACABA; |FINSI;

 #cainliva#20 = eaCtaIVA;
 #cainliva#22 = eaCtaREC;
 #cainliva#24 = eaCtaDTO;

 |SI #cainliva#19 = "N";
     |SI dCtaNoD ! "";
         #cainliva#20 = dCtaNoD;
         #cainliva#22 = dCtaNoD;
     |SINO;
         #cainliva#20 = #cainliva#17;
         |SI #cainliva#15 ! 0; #cainliva#22 = #cainliva#17; |FINSI;
     |FINSI;
 |SINO;
     aCaja = #cainliva#62; |HAZ EsCaja;
     |SI nSwCaja = 1; |Y aCCCta ! doce;
         #cainliva#20 = aCCCta;
     |FINSI;
 |FINSI;

 emCta = 0;
 eaCuenta = #cainliva#20; |HAZ SacaNivel; #cainliva#21 = enNivel;
 eaCuenta = #cainliva#22; |HAZ SacaNivel; #cainliva#23 = enNivel;
 eaCuenta = #cainliva#24; |HAZ SacaNivel; #cainliva#25 = enNivel;
|FPRC;

|PROCESO CreaVtosN;
   |SI #camaniva#39 ! "N"; |ACABA; |FINSI;

   libro   = #camaniva#0;
   serie   = #camaniva#2;
   orden   = #camaniva#3;
   depart  = #camaniva#10;
   eaRef   = #camaniva#22;
   |SI nEsComersan = 1;      || ABDON 26/07/2011 Tiquet 000035/00669
      eaRef = #cainliva#72;
   |FINSI;
   nConcep = #camaniva#27;
   aDesc   = #camaniva#28;
   emision = #camaniva#4;
   cuenta  = #camaniva#12; eaCuenta = cuenta; |HAZ SacaNivel;
   digito  = enNivel;
   eaNombre = #camaniva#13;

   enModoEsc = 1;
   enAux     = 1;
   |SI #camaniva#36 = "R"; aAlfa1 = "calincob.tab"; |FINSI;
   |SI #camaniva#36 = "S"; aAlfa1 = "calinpag.tab"; |FINSI;
   |SUB_EJECUTA_NP aAlfa1;
   enAux     = 0;
|FPRC;
