|FICHEROS;
     gadz0003;

     gadm0002;
     gadm0003;

     gadw0004,MANTE;

     cacuenta;

     :/dsarchi/def/dpntm100;
     :/dsarchi/def/dpntm101;
     :/modelos/def/dsmom030;
|FIN;

|VARIABLES;
     ||DESCUADRE
     nEmp48 = 0;
     aTextoDescuadre = "";

     nLbl1  = -1;
     nLbl2  = -1;
     nLbl3  = -1;

     nResta = 0;
     nBase  = 0;
     nBase1 = 0;
     nBase2 = 0;
     nBase3 = 0;
     nBase4 = 0;
     nBase5 = 0;

     nSuma  = 0;
     nSuma1 = 0;
     nSuma2 = 0;
     nSuma3 = 0;
     nSuma4 = 0;
     nSuma5 = 0;

     &eaFichIVA = "";
     aAlfa1     = "";
     nContenido = 0;
     nEmpr      = 0;

     ||MIAS
     &enLibroFac = 0;

     nLinea = 0;
     nModoDes = 0;
     nBotonDesglose1 = 0;
     nBotonDesglose2 = 0;
     nBotonDesglose3 = 0;

     nCampoD = 0;
     nCampo = 0;

     nPantalla = 0;
     nPantalla2 = 0;

     aMensaje = "";

     nRango = 0;
     nGrid  = 0;
     nVent  = 0;
     nVent2 = 0;
     nHandle= 0;

     aEsc1  = "";
     aEsc2  = "";
     aRetu  = "";
     aTecla = "";
     aAlfa  = "";

     {-1}aVent     = "";
         aVent1    = 0;
         aVent2    = 0;
         aVent3    = 0;
         aVent4    = 0;
         aVent5    = "";

     &eaPathDPNTM     = "";
     &enSwDescuadre   = 0;
     &enSwHayDesglose = 0;
     &enNumRegistro   = 0;
|FIN;

|INCLUYE dscoiv_i;
|INCLUYE dscont_i;

|PROCESO gadm0003_suma;
     enSwHayDesglose = 1;

     |SI #gadm0003#8 = 1;
          nSuma1 = nSuma1 + #gadm0003#9;
     |FINSI;

     |SI #gadm0003#8 = 2;
          nSuma2 = nSuma2 + #gadm0003#9;
     |FINSI;

     |SI #gadm0003#8 = 3;
          nSuma3 = nSuma3 + #gadm0003#9;
     |FINSI;

     |SI #gadm0003#8 = 4;
          nSuma4 = nSuma4 + #gadm0003#9;
     |FINSI;

     |SI #gadm0003#8 = 5;
          nSuma5 = nSuma5 + #gadm0003#9;
     |FINSI;
|FPRC;

|DEFBUCLE gadm0003_suma;
     #gadm0003#1;
     ;
     nEmp48, enNumRegistro, 01;
     nEmp48, enNumRegistro, 99;
     ;
     NULL, gadm0003_suma;
|FIN;

|PROCESO ControlDescuadre;
     nEmpr = #48#2;
     |SI eaPathDPNTM ! "";
          |SI aTipoIVA = "R";  nEmpr = 1;  |FINSI;
          |SI aTipoIVA = "S";  nEmpr = 2;  |FINSI;
     |FINSI;

     |SI aTipoIVA = "R";
         |SELECT #1#dpntm100;
         #dpntm100#0 = enNumRegistro;
         |LEE 000#dpntm100.=;
         |SI FSalida ! 0;  |DDEFECTO #dpntm100;  |FINSI;

         nBase1 = #dpntm100#21;
         nBase2 = #dpntm100#30;
         nBase3 = #dpntm100#37;
         nBase4 = #dpntm100#57;
         nBase5 = #dpntm100#64;
     |FINSI;

     |SI aTipoIVA = "S";
         |SELECT #1#dpntm101;
         #dpntm101#0 = enNumRegistro;
         |LEE 000#dpntm101.=;
         |SI FSalida ! 0;  |DDEFECTO #dpntm101;  |FINSI;

         nBase1 = #dpntm101#21;
         nBase2 = #dpntm101#30;
         nBase3 = #dpntm101#37;
         nBase4 = #dpntm101#57;
         nBase5 = #dpntm101#64;
     |FINSI;

     nSuma1 = 0;
     nSuma2 = 0;
     nSuma3 = 0;
     nSuma4 = 0;
     nSuma5 = 0;

     enSwDescuadre   = 0;
     enSwHayDesglose = 0;
     nEmp48          = nEmpr;
     |BUCLE gadm0003_suma;

     nBase1 = nBase1 ! 2;  nSuma1 = nSuma1 ! 2;
     nBase2 = nBase2 ! 2;  nSuma2 = nSuma2 ! 2;
     nBase3 = nBase3 ! 2;  nSuma3 = nSuma3 ! 2;
     nBase4 = nBase4 ! 2;  nSuma4 = nSuma4 ! 2;
     nBase5 = nBase5 ! 2;  nSuma5 = nSuma5 ! 2;

     |SI nBase1 ! nSuma1;
         enSwDescuadre = 1;
         aTextoDescuadre = "Base 1";
         |ACABA;
     |FINSI;

     |SI nBase2 ! nSuma2;
         enSwDescuadre = 1;
         aTextoDescuadre = "Base 2";
         |ACABA;
     |FINSI;

     |SI nBase3 ! nSuma3;
         enSwDescuadre = 1;
         aTextoDescuadre = "Base 3";
         |ACABA;
     |FINSI;

     |SI nBase4 ! nSuma4;
         enSwDescuadre = 1;
         aTextoDescuadre = "Base 4";
         |ACABA;
     |FINSI;

     |SI nBase5 ! nSuma5;
         enSwDescuadre = 1;
         aTextoDescuadre = "Base 5";
     |FINSI;
|FPRC;

|PROCESO PonTotales;
     |HAZ  ControlDescuadre;

     nBase = nBase1 + nBase2 + nBase3 + nBase4 + nBase5;
     nSuma = nSuma1 + nSuma2 + nSuma3 + nSuma4 + nSuma5;

     |SI nLbl1 ! -1;
         |FIN_CONTROL_WINDOWS nLbl1;  nLbl1 = -1;
         |FIN_CONTROL_WINDOWS nLbl2;  nLbl2 = -1;
         |FIN_CONTROL_WINDOWS nLbl3;  nLbl3 = -1;
     |FINSI;

     nBase  = nBase ! 2;
     nSuma  = nSuma ! 2;
     nResta = (nBase - nSuma) ! 2;

     aAlfa = "LABEL,{{16}} " + (("          " + nBase) % -110);
     |CONTROL_SIMPLE nPantalla, aAlfa, 0580, 0598, NULL;
     nLbl1 = FSalida;

     aAlfa = "LABEL,{{16}} " + (("          " + nSuma) % -110);
     |CONTROL_SIMPLE nPantalla, aAlfa, 0680, 0698, NULL;
     nLbl2 = FSalida;

     aAlfa = "LABEL,{{16}} " + (("          " + nResta) % -110);
     |CONTROL_SIMPLE nPantalla, aAlfa, 0780, 0798, NULL;
     nLbl3 = FSalida;
|FPRC;

|PROCESO Tipo12_w0004; |TIPO 12;
|FPRC;

|PROCESO Tipo0C4_w0004; |TIPO 0;
     eaCuenta = #gadw0004#4;
     |HAZ FiltraPuntos;
     #gadw0004#4 = eaCuenta;
     |PINTA #gadw0004#4;

     |SI #gadw0004#4 = "            ";
         |MENAV "0000Introduzca una cuenta";
         |ERROR;
     |SINO;
          |ABRE #cacuenta;
          #cacuenta#0 = #gadw0004#4;
          |LEE 000#cacuenta.=;
          |SI FSalida ! 0;
               |MENAV "0000No existe la cuenta en el Plan Contable";
               |ERROR;
          |FINSI;
          |CIERRA #cacuenta;
     |FINSI;
|FPRC;

||F11. Conceptos
|PROCESO Tipo66C2_w0004;  |TIPO 66;
     eaFiCon = eaFichIVA;
     enConcepto = #gadw0004#2;
     |HAZ VerConcepto;
     #gadw0004#2 = enConcepto;
     |PINTA #gadw0004#2;
|FPRC;

|PROCESO Tipo0C2_w0004;  |TIPO 0
     |SI Campo = 2;
         nContenido = Contenido;
         |SI #gadw0004#2 = nContenido;  |ACABA;  |FINSI;
     |FINSI;

     enLibIVA   = enLibroFac;
     enFilConc  = 2;
     enConcepto = #gadw0004#2;
     eaReperc   = " ";
     |HAZ FiltroConcepto;
     |SI eswLect ! 0; |ACABA; |FINSI;

     |C_M #gadw0004#6,0,aAlfa1;
     |SI aAlfa1 = "N";   ||no modifica Actividad
         enActividad = #gadw0004#6;
         |SI Haybasica = 1;
             enFilRegIVA = 0;
             enConcepto  = #gadw0004#2;
             |HAZ FilRegimenIVA;
             |SI eswLect ! 0; |ACABA; |FINSI;
         |FINSI;
     |FINSI;

     |SI #gadw0004#2 = dConc1;
         #dsmom030#1 = dDesc1;
     |FINSI;

     #gadw0004#3 = #dsmom030#1; |PINTA #gadw0004#3;
|FPRC;

|PROCESO Min3;
     #gadm0003#15 = nEmpr;
     #gadm0003#0  = enNumRegistro;
     #gadm0003#1  = 01;
|FPRC;

|PROCESO Max3;
     #gadm0003#15 = nEmpr;
     #gadm0003#0 = enNumRegistro;
     #gadm0003#1 = 99;
|FPRC;

|PROCESO Evento_gadm3;
     |SI FSalida = 0; |O FSalida = 1;
          |LEE 000#gadm0003.=;
          |SI FSalida ! 0;
               |ESTADO_CONTROL nBotonDesglose2, "DISABLE";
               |ESTADO_CONTROL nBotonDesglose3, "DISABLE";
          |SINO;
               |ESTADO_CONTROL nBotonDesglose2, "ENABLE";
               |ESTADO_CONTROL nBotonDesglose3, "ENABLE";
          |FINSI;
     |FINSI;
     |SI FSalida = 4;
          |LEE 000#gadm0003.=;
          |SI FSalida = 0;
               |HAZ BotonDesglose2;          ||Modificar
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MeteBasesRec;
     |SELECT #1#dpntm101;
     #dpntm101#0 = enNumRegistro;
     |LEE 000#dpntm101.=;
     |SI FSalida ! 0;  |DDEFECTO #dpntm101;  |FINSI;

     |DDEFECTO #gadz0003;
     |PARA nCampo = 21;  |SI nCampo [ 27;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 20;
           #gadz0003#nCampoD# = #dpntm101#nCampo#;
     |SIGUE;

     |PARA nCampo = 30;  |SI nCampo [ 43;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 22;
           #gadz0003#nCampoD# = #dpntm101#nCampo#;
     |SIGUE;
     |PARA nCampo = 57;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 35;
           #gadz0003#nCampoD# = #dpntm101#nCampo#;
     |SIGUE;
|FPRC;

|PROCESO MeteBasesEmi;
     |SELECT #1#dpntm100;
     #dpntm100#0 = enNumRegistro;
     |LEE 000#dpntm100.=;
     |SI FSalida ! 0;  |DDEFECTO #dpntm100;  |FINSI;

     |DDEFECTO #gadz0003;
     |PARA nCampo = 21;  |SI nCampo [ 27;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 20;
           #gadz0003#nCampoD# = #dpntm100#nCampo#;
     |SIGUE;
     |PARA nCampo = 30;  |SI nCampo [ 43;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 22;
           #gadz0003#nCampoD# = #dpntm100#nCampo#;
     |SIGUE;
     |PARA nCampo = 57;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
           nCampoD = nCampo - 35;
           #gadz0003#nCampoD# = #dpntm100#nCampo#;
     |SIGUE;
|FPRC;

|PROCESO DameUltimaLinea;
     #gadm0003#15 = nEmpr;
     #gadm0003#0 = enNumRegistro;
     #gadm0003#1 = 99;
     |LEE 000#gadm0003.];
     |SI FSalida = 0;
          |LEE 000#gadm0003.a;
     |SINO;
          |LEE 000#gadm0003.u;
     |FINSI;
     |SI FSalida = 0; |Y #gadm0003#0 = enNumRegistro; |Y #gadm0003#15 = nEmpr;
          nLinea = #gadm0003#1 + 1;
     |SINO;
          nLinea = 1;
     |FINSI;
|FPRC;

|PROCESO EditaDesglose;
     |VENTANA 0501, 2699, -1, 16, "Linea de Desglose Base";
     nVent2 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent2;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#gadw0004;
     nPantalla2 = FSalida;

     |SI nModoDes = 1;
          nLinea = 1;
          |HAZ DameUltimaLinea;
          |DDEFECTO #gadw0004;
          #gadw0004#15 = nEmpr;
          #gadw0004#0 = enNumRegistro;
          #gadw0004#1 = nLinea;

          ||Cargo los datos por defecto que ya tenemos en el gadw0004
          #gadw0004#2 = #gadm0002#7;
          #gadw0004#3 = #gadm0002#8;
          #gadw0004#4 = #gadm0002#17;
          #gadw0004#5 = #gadm0002#33;
          #gadw0004#6 = #gadm0002#45;
          #gadw0004#13 = #gadm0002#46;
          #gadw0004#7 = #gadm0002#47;
          #gadw0004#14 = #gadm0002#48;
          #gadw0004#10 = #gadm0002#55;
          #gadw0004#11 = #gadm0002#56;
          #gadw0004#12 = #gadm0002#28;
     |SINO;
          #gadw0004#0 = #gadm0003#0;
          #gadw0004#1 = #gadm0003#1;
          #gadw0004#2 = #gadm0003#2;
          #gadw0004#3 = #gadm0003#3;
          #gadw0004#4 = #gadm0003#4;
          #gadw0004#5 = #gadm0003#5;
          #gadw0004#6 = #gadm0003#6;
          #gadw0004#7 = #gadm0003#7;
          #gadw0004#8 = #gadm0003#8;
          #gadw0004#9 = #gadm0003#9;
          #gadw0004#10 = #gadm0003#10;
          #gadw0004#11 = #gadm0003#11;
          #gadw0004#12 = #gadm0003#12;
          #gadw0004#13 = #gadm0003#13;
          #gadw0004#14 = #gadm0003#14;
          #gadw0004#15 = #gadm0003#15;
     |FINSI;

     |SI #gadz0003#8 = 0;
          |C_M #gadw0004#8, 1, "N";          ||SOLO HAY UNA BASE (BASE 1)
     |SINO;
          |C_M #gadw0004#8, 1, "S";
     |FINSI;

     |PINDA #0#gadw0004;

     |ENDATOS #1#gadw0004;
     |SI FSalida = 0;
          #gadm0003#15 = #gadw0004#15;
          #gadm0003#0 = #gadw0004#0;
          #gadm0003#1 = #gadw0004#1;
          |LEE 101#gadm0003.=;
          |SI FSalida ! 0; |GRABA 020#gadm0003.b; |FINSI;
          #gadm0003#2  = #gadw0004#2;
          #gadm0003#3  = #gadw0004#3;
          #gadm0003#4  = #gadw0004#4;
          #gadm0003#5  = #gadw0004#5;
          #gadm0003#6  = #gadw0004#6;
          #gadm0003#7  = #gadw0004#7;
          #gadm0003#8  = #gadw0004#8;
          #gadm0003#9  = #gadw0004#9;
          #gadm0003#10 = #gadw0004#10;
          #gadm0003#11 = #gadw0004#11;
          #gadm0003#12 = #gadw0004#12;
          #gadm0003#13 = #gadw0004#13;
          #gadm0003#14 = #gadw0004#14;
          |GRABA 020#gadm0003.a;
          |LIBERA #gadm0003;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent2;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINVENTANA nVent2;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |HAZ PonTotales;
|FPRC;

|PROCESO BotonDesglose1;         ||Alta
     nModoDes = 1;
     |HAZ EditaDesglose;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO BotonDesglose2;         ||Mod
     nModoDes = 2;
     |HAZ EditaDesglose;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO BotonDesglose3;         ||Baja
     |LEE 000#gadm0003.=;
     |SI FSalida = 0;
          |LEE 101#gadm0003.=;
          |BORRA 020#gadm0003.a;
          |LIBERA #gadm0003;
          |ESTADO_CONTROL nBotonDesglose2, "DISABLE";
          |ESTADO_CONTROL nBotonDesglose3, "DISABLE";
          |REFRESCACONTROL nGrid;

          |HAZ PonTotales;
     |FINSI;
|FPRC;

|PROCESO Botones;
     |CONTROL_SIMPLE nPantalla, "BOTON,{{193}}Alta ", 2653, 2663, BotonDesglose1;
     nBotonDesglose1 = FSalida;

     |CONTROL_SIMPLE nPantalla, "BOTON,{{197}}Modificar ", 2665, 2675, BotonDesglose2;
     nBotonDesglose2 = FSalida;

     |CONTROL_SIMPLE nPantalla, "BOTON,{{199}}Baja ", 2677, 2687, BotonDesglose3;
     nBotonDesglose3 = FSalida;
|FPRC;


|PROCESO DesgloseBase;
     |VENTANA 0501, 2699, -1, 16, "Desglose Bases";
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     nEmpr = #48#2;
     |SI eaPathDPNTM ! "";
          |SI aTipoIVA = "R";  nEmpr = 1;  |FINSI;
          |SI aTipoIVA = "S";  nEmpr = 2;  |FINSI;
     |FINSI;

     |ABRE #gadm0003;

     |PINPA #0#gadz0003;
     nPantalla = FSalida;

     |SI aTipoIVA = "R";  |HAZ MeteBasesEmi;  |FINSI;
     |SI aTipoIVA = "S";  |HAZ MeteBasesRec;  |FINSI;

     |PINDA #0#gadz0003;

     nRango = 4 + 8 + 16 + 32;

     |CONTROL_SIMPLE nPantalla, "LABEL,{{16}}Total bases factura ", 0550, 0575, NULL;
     |CONTROL_SIMPLE nPantalla, "LABEL,{{16}}Total bases desglose", 0650, 0675, NULL;
     |CONTROL_SIMPLE nPantalla, "LABEL,{{16}}Diferencia",           0750, 0775, NULL;

     |HAZ Botones;
     |HAZ PonTotales;

     |ESTADO_CONTROL nBotonDesglose2, "DISABLE";
     |ESTADO_CONTROL nBotonDesglose3, "DISABLE";

     |LINEAL_SIMPLE #1#gadm0003, nRango, 1602, 2598, Min3, Max3, Evento_gadm3;
     nGrid = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Salir," + nGrid;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |O aTecla = aEsc2; |O aTecla = aRetu;
             enSwDescuadre = 0;
             aTextoDescuadre = "";
             |HAZ ControlDescuadre;
             |SI enSwDescuadre = 1;  |Y enSwHayDesglose = 1;
                  aMensaje = "0000NExiste un descuadre en " + aTextoDescuadre;
                  aMensaje = aMensaje + ". Si sale NO se aplicara el desglose." + &13 + "Salir del desglose?";
                  |CONFI aMensaje;
                  |SI FSalida = 0;
                       |SAL;
                  |FINSI;
             |SINO;
                 |SAL;
             |FINSI;
         |FINSI;
     |SIGUE;

     |CIERRA #gadm0003;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent;
|FPRC;
