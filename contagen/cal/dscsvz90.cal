|FICHEROS;
     dscsvz90;
     caxsecfi;

     canempre;
     cacuenta;
     caclipro;
     caivaasi;
     calibros;
     caivases;
     camaniva;
     calinpag;
     calincob;
     caenlace;

     :modelos/dsmom030;

     dscsvw91;
     dscsvw92;
     dscsvw93;

     &regisnif@;
     &sgpaises@;
     &Puente@;
|FIN;

|VARIABLES;
     nDigiOrigen     = 0;
     nDigiDestino    = 0;
     nOrden1         = 0;
     nOrden2         = 0;
     nPausa          = 0;
     nImpor          = 0;

     aNombre1        = "";
     aNombre2        = "";
     aNombre3        = "";
     aNombre4        = "";
     aModificaAsiIva = "";
     aFichero        = "";
     aFicheroLCK     = "";
     aPathContagen   = "";
     aBorra          = "";
     aEjecuta        = "";
     aMensaje        = "";
     aFicheroMDB     = "";
     aFicheroAux     = "";
     nBtnInfo        = -1;
     aPathDavid      = "";
     aTextoVentana   = "";
     aDRef           = "";
     aHRef           = "";
     aLee1           = "";
     aLee2           = "";
     aLee3           = "";

     n0Vent          = -1;
     n1Vent          = -1;
     n2Vent          = -1;
     nBtnUni         = -1;
     nBtnCan         = -1;
     nBtnPat1        = -1;
     nBtnCar1        = -1;
     nBtnCar2        = -1;
     nBtnCar3        = -1;
     nLblReg1        = -1;
     nLblReg2        = -1;
     nLblReg3        = -1;
     nLblReg4        = -1;
     nLblReg5        = -1;

     nRango          = 0;
     nHandle         = 0;
     nIde            = 0;
     nDCampo         = 0;
     nCampo          = 0;
     nPanta          = 0;
     nLong           = 0;
     nCarac          = 0;
     nPos            = 0;
     nFSalida        = 0;
     nColum          = 0;
     nNume1          = 0;
     nNume2          = 0;
     nRam1           = 0;
     nRam2           = 0;
     nPide           = 0;
     nFila           = 0;
     nCargar         = 0;
     nPosi           = 0;
     nTotCmp         = 0;
     nTCampos        = 0;
     nTValor         = 0;
     nReg            = 0;
     nPorce          = 0;
     nError          = 0;
     nCmp            = 0;
     nLongVar        = 0;
     nCarVar         = 0;
     nPosVar         = 0;
     nDife           = 0;
     nDesdeCar       = 0;
     nPos1           = 0;
     nPos2           = 0;
     nChequeo        = 0;
     nDocu           = 0;
     nApun           = 0;
     nBarra          = 0;
     nDia            = 0;
     nMes            = 0;
     nAny            = 0;
     nLibro          = 0;
     nIBas           = 0;
     nIIva           = 0;
     nITot           = 0;
     nIRet           = 0;
     nConcep         = 0;
     nBuscoCli       = 0;
     nPrint          = 0;
     nDiario         = 0;
     nDocum          = 0;
     nCamp25         = 0;
     nCamp26         = 0;
     nCamp27         = 0;
     nCamp31         = 0;
     nCamp32         = 0;
     nCamp33         = 0;
     nCamp50         = 0;
     nCamp51         = 0;
     nCamp54         = 0;
     nCamp55         = 0;
     nConcepto       = 0;
     nSw             = 0;
     nSwAlguno       = 0;
     nSwPaso         = 0;
     nSwCab          = 0;
     nIvas           = 0;
     nApunte         = 0;
     nUltDoc         = 0;
     nDocumSec       = 0;
     nPara1          = 0;
     nNumDoc         = 0;

     aCtaBas         = "";
     aCtaIva         = "";
     aCtaTot         = "";
     aCtaRet         = "";
     aAlfa           = "";
     aAlfa1          = "";
     aAlfa2          = "";
     aAlfa3          = "";
     aAlfa4          = "";
     aAlfa5          = "";
     aFecha          = "";
     aEsc1           = "";
     aEsc2           = "";
     aRetu           = "";
     aTecla          = "";
     aPathLocal      = "";
     aPathTmp        = "";
     aFicTree        = "";
     aAbre           = "";
     aTabla          = "";
     aTablaTree      = "";
     aFilaTree       = "";
     aDescri         = "";
     aRuta           = "";
     aLong           = "";
     aCadena         = "";
     aOrigen         = "";
     aDestino        = "";
     aDTabla         = "";
     aHTabla         = "";
     aBuscar         = "";
     aRefresca       = "";
     aCarac          = "";
     aContenido      = "";
     a100            = "";
     aVar            = "";
     aLee            = "";
     aC10            = "";
     aC13            = "";
     aFicTmp         = "";
     aLongVar        = "";
     aComilla        = "";
     aCarVar         = "";
     aTipo           = "";
     aAsiento        = "";
     aLibro          = "";
     aParam1         = "";
     aParam2         = "";
     aParam3         = "";
     aProg           = "";
     aFicBrowse      = "";
     aVer1           = "";
     aVer2           = "";
     aModAsiento     = "";
     aSerie          = "";
     aNumFactura     = "";
     aNumFra         = "";
     aNumFraAnt      = "";
     aPasar          = "";
     aAnyo           = "";

     fFecha          = @;

     {1}aConte       = "";

     {-1}sTree       = 0;
         sT_nID      = 0;
         sT_nOper    = 0;
         sT_aData    = "";

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     &eaUnidadBasico = "";
     &eaIP           = "";
     &eaModoImpo     = "";
     &eaRepeSopo     = "";
     &eaFicheroCSV   = "";
     &eaTipoCSV      = "";
     &eaFicheroIVA   = "";
     &eaFicheroDatos = "";
     &eaNombreDatos  = "";
     &eaBinarioConve = "";
     &eaNombrePDF    = "";
     &HayBasica      = 0;
     &enDnDIARIO     = 0;
     &enHnDIARIO     = 0;
     &efDFechas      = @;
     &efHFechas      = @;
     &enDDocume      = 0;
     &enHDocume      = 0;
     &enBorraAu      = 0;
     &enNoModif      = 0;
     &eaPath         = "";
     &eaRetorno      = "";
     &enNoEndatos    = 0;
|FIN;

|INCLUYE dscont_i;
||INCLUYE carter_i;

|PROCESO CalculaCuenta;
     |QBF eaCuenta;
     |SI eaCuenta = "";  |ACABA;  |FINSI;

     aLongVar = eaCuenta % 0;
     nLongVar = aLongVar;

     |SI nLongVar ! MaximoDigitos;
         nDife = MaximoDigitos - nLongVar;
         |SI nDife < 0;  |ACABA;  |FINSI;

         nDesdeCar = 4;

         nPos1    = 100 + nDesdeCar;
         nPos2    = (100 * (nDesdeCar + 1)) + 99;
         aAlfa    = (eaCuenta % nPos1) + ("0" * nDife) + (eaCuenta % nPos2);
         eaCuenta = aAlfa;
     |FINSI;

     |HAZ SacaNivel;
|FPRC;

|PROCESO GrabaCaclipro;
     eaCuenta = aLee1  % 19312;
     |HAZ CalculaCuenta;

     #caclipro#23 = aLee2 % 11101;
     #caclipro#10 = eaCuenta;
     |LEE 101#caclipro.=;
     |SI FSalida ! 0;
        |DDEFECTO #caclipro;
         #caclipro#23 = aLee2 % 11101;
         #caclipro#10 = eaCuenta;
         |GRABA 020#caclipro.b;
     |FINSI;

     aAlfa  = aLee1  % 0112;  #caclipro#0  = aAlfa;
     aAlfa  = aLee1  % 1340;  #caclipro#1  = aAlfa;

     aAlfa  = "";
     aAlfa1 = "";
     aAlfa1 = aLee1 % 5302;  aAlfa  = aAlfa + aAlfa1;
     aAlfa1 = aLee1 % 5535;  aAlfa  = aAlfa + aAlfa1;

     aAlfa1 = aLee1 % 9004;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         aAlfa = aAlfa + ", ";
     |FINSI;
     aAlfa  = aAlfa + aAlfa1;

     aAlfa1 = aLee1 % 9403;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         aAlfa = aAlfa + ", ";
     |FINSI;
     aAlfa  = aAlfa + aAlfa1;

     aAlfa1 = aLee1 % 9703;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         aAlfa = aAlfa + ", ";
     |FINSI;
     aAlfa  = aAlfa + aAlfa1;

     aAlfa1 = aLee1 % 10003; |QBF aAlfa1;
     |SI aAlfa1 ! "";
         aAlfa = aAlfa + ", ";
     |FINSI;
     aAlfa  = aAlfa + aAlfa1;

                              #caclipro#2  = aAlfa;
     aAlfa = aLee1  % 10302;  #caclipro#3  = aAlfa;
     aAlfa = aLee1  % 10503;  #caclipro#4  = aAlfa;
     aAlfa = aLee1  % 10815;  #caclipro#5  = aAlfa;
     aAlfa = aLee1  % 12325;  #caclipro#6  = aAlfa;
     aAlfa = aLee1  % 14815;  #caclipro#7  = aAlfa;
     aAlfa = aLee1  % 16315;  #caclipro#8  = aAlfa;
     aAlfa = aLee1  % 17815;  #caclipro#9  = aAlfa;
     aAlfa = aLee1  % 20501;  #caclipro#11 = aAlfa;
     aAlfa = aLee1  % 20601;  #caclipro#12 = aAlfa;
     aAlfa = aLee1  % 20730;  #caclipro#13 = aAlfa;

     aAlfa = aLee2  % 0130;   #caclipro#14 = aAlfa;
     aAlfa = aLee2  % 3102;   #caclipro#15 = aAlfa;
     aAlfa = aLee2  % 3303;   #caclipro#16 = aAlfa;
     aAlfa = aLee2  % 3620;   #caclipro#17 = aAlfa;
     aAlfa = aLee2  % 5615;   #caclipro#18 = aAlfa;
     aAlfa = aLee2  % 7125;   #caclipro#19 = aAlfa;
     aAlfa = aLee2  % 9602;   #caclipro#20 = aAlfa;
     aAlfa = aLee2  % 9812;   #caclipro#21 = aAlfa;
     aAlfa = aLee2  % 11001;  #caclipro#22 = aAlfa;
     aAlfa = aLee2  % 11101;  #caclipro#23 = aAlfa;
     aAlfa = aLee2  % 11203;  #caclipro#24 = aAlfa;
     aAlfa = aLee2  % 11505;  #caclipro#25 = aAlfa;
     aAlfa = aLee2  % 12005;  #caclipro#26 = aAlfa;
     aAlfa = aLee2  % 12506;  #caclipro#27 = aAlfa;
     aAlfa = aLee2  % 13103;  #caclipro#28 = aAlfa;
     aAlfa = aLee2  % 13404;  #caclipro#29 = aAlfa;
     aAlfa = aLee2  % 13804;  #caclipro#30 = aAlfa;
     aAlfa = aLee2  % 14202;  #caclipro#31 = aAlfa;
     aAlfa = aLee2  % 14410;  #caclipro#32 = aAlfa;
     aAlfa = aLee2  % 15405;  #caclipro#33 = aAlfa;
     aAlfa = aLee2  % 15902;  #caclipro#34 = aAlfa;
     aAlfa = aLee2  % 16102;  #caclipro#35 = aAlfa;
     aAlfa = aLee2  % 16302;  #caclipro#36 = aAlfa;
     aAlfa = aLee2  % 16501;  #caclipro#37 = aAlfa;
     aAlfa = aLee2  % 16608;  #caclipro#38 = aAlfa;
     aAlfa = aLee2  % 17411;  #caclipro#39 = aAlfa;
     aAlfa = aLee2  % 18534;  #caclipro#40 = aAlfa;
     aAlfa = aLee2  % 21911;  #caclipro#41 = aAlfa;
     aAlfa = aLee2  % 23002;  #caclipro#42 = aAlfa;

     aAlfa = aLee3  % 0110;   #caclipro#43 = aAlfa;
     aAlfa = aLee3  % 1150;   #caclipro#44 = aAlfa;
     aAlfa = aLee3  % 6102;   #caclipro#45 = aAlfa;
     aAlfa = aLee3  % 6303;   #caclipro#46 = aAlfa;
     aAlfa = aLee3  % 6615;   #caclipro#47 = aAlfa;
     aAlfa = aLee3  % 8125;   #caclipro#48 = aAlfa;
     aAlfa = aLee3  % 10606;  #caclipro#49 = aAlfa;
     aAlfa = aLee3  % 11205;  #caclipro#50 = aAlfa;
     aAlfa = aLee3  % 11780;  #caclipro#51 = aAlfa;
     aAlfa = aLee3  % 19703;  #caclipro#52 = aAlfa;

     |GRABA 020#caclipro.a;
     |LIBERA #caclipro;

     #cacuenta#0 = #caclipro#10;
     |LEE 101#cacuenta.=;
     |SI FSalida ! 0;
         |DDEFECTO #cacuenta;
         #cacuenta#0  = #caclipro#10;
         #cacuenta#1  = dig3;
         #cacuenta#2  = aLee1 % 1340;
         #cacuenta#3  = "S";
         #cacuenta#55 = dig3;
         |GRABA 020#cacuenta.n;
     |FINSI;

     aAlfa = aLee1 % 17815; #regisnif@#0 = aAlfa;
     |LEE 000#regisnif@.=;
     |SI FSalida ! 0;
         |DDEFECTO #regisnif@;
         aAlfa = aLee1 % 17815; #regisnif@#0  = aAlfa;
         aAlfa = aLee1 % 1340;  #regisnif@#1  = aAlfa;
         aAlfa = aLee1 % 5535;  #regisnif@#2  = aAlfa;
         aAlfa = aLee1 % 9004;  #regisnif@#3  = aAlfa;
         aAlfa = aLee1 % 10302; #regisnif@#4  = aAlfa;
         aAlfa = aLee1 % 10503; #regisnif@#5  = aAlfa;
         aAlfa = aLee1 % 12325; #regisnif@#6  = aAlfa;
         aAlfa = aLee1 % 10815; #regisnif@#7  = aAlfa;
         aAlfa = aLee1 % 14815; #regisnif@#8  = aAlfa;
         aAlfa = aLee1 % 5302;  #regisnif@#9  = aAlfa;
         aAlfa = aLee1 % 9703;  #regisnif@#10 = aAlfa;
         aAlfa = aLee1 % 10003; #regisnif@#11 = aAlfa;
         aAlfa = aLee2 % 11203;#regisnif@#12  = aAlfa;

        |SI HayBasica = 1;
            #sgpaises@#0 = #regisnif@#12;
            |LEE 000#sgpaises@.=;
            |SI FSalida ! 0; |DDEFECTO #sgpaises@; |FINSI;
            #regisnif@#13 = #sgpaises@#1;
        |FINSI;

        |SI HayBasica = 0;
            #sgpaises@#0 = #regisnif@#4;
            #sgpaises@#1 = #regisnif@#5;
            |LEE 000#sgpaises@.=;
            |SI FSalida ! 0; |DDEFECTO #sgpaises@; |FINSI;
            |SI #regisnif@#12 ! #sgpaises@#6;
                #regisnif@#12 = #sgpaises@#6;
            |FINSI;
            #regisnif@#13 = #sgpaises@#7;
            #regisnif@#14 = #sgpaises@#4;
            #regisnif@#15 = #sgpaises@#5;
        |FINSI;

        aAlfa = aLee1 % 9403;  #regisnif@#16 = aAlfa;
        |GRABA 020#regisnif@.n;
        |LIBERA #regisnif@;
     |FINSI;
|FPRC;

|PROCESO ImportaCuentas;
     aAlfa = "Procesando fichero Clientes y Proveedores";
     |VENTANA 0501, 3599, -1, 16, aAlfa;
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |ABRE #regisnif@;
     |ABRE #sgpaises@;

     |XABRE "B", aFicTmp, nHandle;

     |PARA; |SI; |HACIENDO;
            |XLEE nHandle, 236, aLee1;
            |SI FSalida ! 236;   |SAL;   |FINSI;

            |XLEE nHandle, 231, aLee2;
            |SI FSalida ! 231;   |SAL;   |FINSI;

            |XLEE nHandle, 200, aLee3;
            |SI FSalida ! 200;   |SAL;   |FINSI;

            |HAZ GrabaCaclipro;
     |SIGUE;

     |XCIERRA nHandle;

     |CIERRA #regisnif@;
     |CIERRA #sgpaises@;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO CambioConcepto;
     #dsmom030#0 = nConcepto;
     |LEE 001#dsmom030.=;
     |SI FSalida ! 0; |O #dsmom030#4 ! "S";
         |SI #dscsvw91#13 = "R"; #dscsvw91#9 = #caivaasi#5;  |FINSI;
         |SI #dscsvw91#13 = "S"; #dscsvw91#9 = #caivaasi#31; |FINSI;
     |FINSI;
|FPRC;

|PROCESO Negativo;
     aAlfa3 = aAlfa2 - "-";
     |SI aAlfa3 ! aAlfa2;
        aAlfa3 = aAlfa2 % 0;
        nNume1 = aAlfa3;

        aAlfa3 = "";
        nSw    = 0;
        |PARA nNume2 = 1; |SI nNume2 [ nNume1; |HACIENDO nNume2 = nNume2 + 1;
              aAlfa4 = nNume2;
              aAlfa4 = aAlfa4 + "01";
              aAlfa4 = aAlfa2 % aAlfa4;
              |SI aAlfa4 = "-"; nSw = 1; |FINSI;
              |SI nSw = 1;
                  aAlfa3 = aAlfa3 + aAlfa4;
              |FINSI;
        |SIGUE;
        nNume1 = aAlfa3;
        aAlfa2 = nNume1;
    |FINSI;
|FPRC;

|PROCESO BuscaNumero;
     |SI #caivaasi#44 = "N";
         #calibros#0 = nLibro;
         |LEE 101#calibros.=;
         |SI FSalida ! 0;
             |DDEFECTO #calibros;
             #calibros#0 = nLibro;
             #calibros#2 = aTipoIVA;
             |GRABA 020#calibros.b;
         |FINSI;

         aNumFactura  = #calibros#4;
         #calibros#4 = #calibros#4 + #calibros#3;
         |GRABA 020#calibros.a;
         |LIBERA #calibros;
     |SINO;
         |ABRE #caivases;
         #caivases#0 = aSerie;
         #caivases#1 = aTipoIVA;
         |LEE 101#caivases.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivases;
            #caivases#0 = aSerie;
            #caivases#1 = aTipoIVA;
            |GRABA 020#caivases.b;
         |FINSI;
         aNumFactura  = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.a;
         |LIBERA #caivases;
     |FINSI;

     #dscsvw91#16 = aNumFactura;
|FPRC;

|PROCESO Facturas;
     |DDEFECTO #dscsvw91;
     aAlfa2 = aLee1 % 102;   #dscsvw91#0  = aAlfa2;  || diario
     aAlfa2 = aLee1 % 310;   #dscsvw91#1  = aAlfa2;  || fecha
     aAlfa2 = aLee1 % 1306;  #dscsvw91#2  = aAlfa2;  || documento
     aAlfa2 = aLee1 % 1906;  #dscsvw91#3  = aAlfa2;  || asiento
     aAlfa2 = aLee1 % 2504;  #dscsvw91#4  = aAlfa2;  || apunte
     aAlfa2 = aLee1 % 2912;  #dscsvw91#5  = aAlfa2;  || cuenta debe
     aAlfa2 = aLee1 % 4112;  #dscsvw91#6  = aAlfa2;  || cuenta haber
     aAlfa2 = aLee1 % 5301;  #dscsvw91#7  = aAlfa2;  || nivel debe
     aAlfa2 = aLee1 % 5401;  #dscsvw91#8  = aAlfa2;  || nivel haber
     aAlfa2 = aLee1 % 5503;  #dscsvw91#9  = aAlfa2;  || concepto
     aAlfa2 = aLee1 % 5830;  #dscsvw91#10 = aAlfa2;  || descripcion
     aAlfa2 = aLee1 % 8801;  #dscsvw91#11 = aAlfa2;  || signo

     aAlfa2 = aLee1 % 8911;  |HAZ Negativo;
                             #dscsvw91#12 = aAlfa2;  || importe
     aAlfa2 = aLee1 % 10001; #dscsvw91#13 = aAlfa2;  || iva sop./rep.
     aAlfa2 = aLee1 % 10102; #dscsvw91#14 = aAlfa2;  || libro  (el campo #dscsvw91#15 no hace falta)
     aAlfa2 = aLee1 % 10306; #dscsvw91#16 = aAlfa2;  || factura/orden
                             aNumFra = aAlfa2;
     aAlfa2 = aLee1 % 10905; #dscsvw91#17 = aAlfa2;  || serie

     |SI #dscsvw91#13 = " ";
         #dscsvw91#13 = "R";
     |FINSI;

     |SI #dscsvw91#13 = "R";
         |SI #dscsvw91#14 = 0;
             #dscsvw91#14 = 1;
         |FINSI;
     |FINSI;

     |SI #dscsvw91#13 = "S";
         |SI #dscsvw91#14 = 0;
             #dscsvw91#14 = 2;
         |FINSI;

         aAlfa5 = "S/FRA. " + #dscsvw91#17 + "/" + (("000000" + aNumFra) % -106);
         #dscsvw91#59 = aAlfa5;
         |SI aNumFraAnt ! aNumFra;
             aNumFraAnt = aNumFra;
             aTipoIVA   = #dscsvw91#13;
             nLibro     = #dscsvw91#14;
             aSerie     = #dscsvw91#17;
             |HAZ BuscaNumero;
         |SINO;
             #dscsvw91#16 = aNumFactura;
         |FINSI;
     |FINSI;

     aAlfa2 = aLee1 % 11403; #dscsvw91#18 = aAlfa2;  || concepto iva
     aAlfa2 = aLee1 % 11730; #dscsvw91#19 = aAlfa2;  || descripcion iva
     aAlfa2 = aLee1 % 14712; #dscsvw91#20 = aAlfa2;  || cuenta cliente/proveedor
     aAlfa2 = aLee1 % 15901; #dscsvw91#21 = aAlfa2;  || nivel cuenta
     aAlfa2 = aLee1 % 16010; |HAZ Negativo;
                             #dscsvw91#22 = aAlfa2;  || base imp. 1
     aAlfa2 = aLee1 % 17010; |HAZ Negativo;
                             #dscsvw91#23 = aAlfa2;  || base imp. 2
     aAlfa2 = aLee1 % 18010; |HAZ Negativo;
                             #dscsvw91#24 = aAlfa2;  || base imp. 3
     aAlfa2 = aLee1 % 19005; #dscsvw91#25 = aAlfa2;  || (%) iva 1
     aAlfa2 = aLee1 % 19505; #dscsvw91#26 = aAlfa2;  || (%) iva 2
     aAlfa2 = aLee1 % 20005; #dscsvw91#27 = aAlfa2;  || (%) iva 3

     aAlfa2 = aLee2 % 110;   |HAZ Negativo;
                             #dscsvw91#28 = aAlfa2;  || cuota iva 1
     aAlfa2 = aLee2 % 1110;  |HAZ Negativo;
                             #dscsvw91#29 = aAlfa2;  || cuota iva 2
     aAlfa2 = aLee2 % 2110;  |HAZ Negativo;
                             #dscsvw91#30 = aAlfa2;  || cuota iva 3
     aAlfa2 = aLee2 % 3105;  #dscsvw91#31 = aAlfa2;  || (%) rec 1
     aAlfa2 = aLee2 % 3605;  #dscsvw91#32 = aAlfa2;  || (%) rec 2
     aAlfa2 = aLee2 % 4105;  #dscsvw91#33 = aAlfa2;  || (%) rec 3
     aAlfa2 = aLee2 % 4610;  |HAZ Negativo;
                             #dscsvw91#34 = aAlfa2;  || cuota rec 1
     aAlfa2 = aLee2 % 5610;  |HAZ Negativo;
                             #dscsvw91#35 = aAlfa2;  || cuota rec 2
     aAlfa2 = aLee2 % 6610;  |HAZ Negativo;
                             #dscsvw91#36 = aAlfa2;  || cuota rec 3
     aAlfa2 = aLee2 % 7610;  |HAZ Negativo;
                             #dscsvw91#37 = aAlfa2;  || total factura
     aAlfa2 = aLee2 % 8601;  #dscsvw91#38 = aAlfa2;  || inversion
     aAlfa2 = aLee2 % 8701;  #dscsvw91#39 = aAlfa2;  || deducible
     aAlfa2 = aLee2 % 8802;  #dscsvw91#40 = aAlfa2;  || departamento
     aAlfa2 = aLee2 % 9010;  #dscsvw91#41 = aAlfa2;  || fecha iva
     aAlfa2 = aLee2 % 10001; #dscsvw91#42 = aAlfa2;  || tipo acumulador iva
     aAlfa2 = aLee2 % 10101; #dscsvw91#43 = aAlfa2;  || nro. acumulador iva
     aAlfa2 = aLee2 % 10202; #dscsvw91#44 = aAlfa2;  || periodo
     aAlfa2 = aLee2 % 10403; #dscsvw91#45 = aAlfa2;  || empresa contable
     aAlfa2 = aLee2 % 10701; #dscsvw91#46 = aAlfa2;  || periodo     (el campo #dscsvw91#47 no hace falta)
     aAlfa2 = aLee2 % 10810; |HAZ Negativo;
                             #dscsvw91#48 = aAlfa2;  ||base -4-
     aAlfa2 = aLee2 % 11810; |HAZ Negativo;
                             #dscsvw91#49 = aAlfa2;  ||base -5-
     aAlfa2 = aLee2 % 12805; #dscsvw91#50 = aAlfa2;  ||Iva -4-
     aAlfa2 = aLee2 % 13305; #dscsvw91#51 = aAlfa2;  ||Iva -5-
     aAlfa2 = aLee2 % 13810; |HAZ Negativo;
                             #dscsvw91#52 = aAlfa2;  ||cuota -4-
     aAlfa2 = aLee2 % 14810; |HAZ Negativo;
                             #dscsvw91#53 = aAlfa2;  ||cuota -5-
     aAlfa2 = aLee2 % 15805; #dscsvw91#54 = aAlfa2;  ||Rec -4-
     aAlfa2 = aLee2 % 16305; #dscsvw91#55 = aAlfa2;  ||Rec -5-
     aAlfa2 = aLee2 % 16810; |HAZ Negativo;
                             #dscsvw91#56 = aAlfa2;  ||Cuota rec -4-
     aAlfa2 = aLee2 % 17810; |HAZ Negativo;
                             #dscsvw91#57 = aAlfa2;  ||Cuota rec -5-

     eaCuenta = #dscsvw91#5;  |HAZ CalculaCuenta;  #dscsvw91#5  = eaCuenta;
     eaCuenta = #dscsvw91#6;  |HAZ CalculaCuenta;  #dscsvw91#6  = eaCuenta;
     eaCuenta = #dscsvw91#20; |HAZ CalculaCuenta;  #dscsvw91#20 = eaCuenta;

     |SI #dscsvw91#2 ! nDocum;
         nCamp25 = 0;
         nCamp26 = 0;
         nCamp27 = 0;
         nCamp31 = 0;
         nCamp32 = 0;
         nCamp33 = 0;
         nCamp50 = 0;
         nCamp51 = 0;
         nCamp54 = 0;
         nCamp55 = 0;
         nDocum  = #dscsvw91#2;

         |SI #dscsvw91#13 = "R"; |O #dscsvw91#13 = "S";
             nCamp25 = #dscsvw91#25;
             nCamp26 = #dscsvw91#26;
             nCamp27 = #dscsvw91#27;
             nCamp31 = #dscsvw91#31;
             nCamp32 = #dscsvw91#32;
             nCamp33 = #dscsvw91#33;
             nCamp50 = #dscsvw91#50;
             nCamp51 = #dscsvw91#51;
             nCamp54 = #dscsvw91#54;
             nCamp55 = #dscsvw91#55;
        |FINSI;
     |FINSI;

     |SI #dscsvw91#42 = " ";
         |SI #dscsvw91#13 = "R"; |O #dscsvw91#13 = "S";
             eaCuenta = "";
             aAlfa1   = #dscsvw91#5; |QBF aAlfa1; |SI aAlfa1 ! ""; eaCuenta = aAlfa1; |FINSI;
             aAlfa2   = #dscsvw91#6; |QBF aAlfa2; |SI aAlfa2 ! ""; eaCuenta = aAlfa2; |FINSI;
             |SI eaCuenta ! "";
                 aAlfa1 = eaCuenta % 102;
                 |SI aAlfa1 = "47";
                     #dscsvw91#42 = "I";
                 |SINO;
                     aAlfa1 = eaCuenta % 101;
                     |SI aAlfa1 = "4"; #dscsvw91#42 = "F"; |FINSI;
                     |SI aAlfa1 = "6"; |O aAlfa1 = "7"; #dscsvw91#42 = "B"; |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     aAlfa1 = #dscsvw91#5; |QBF aAlfa1;
     aAlfa2 = #dscsvw91#6; |QBF aAlfa2;
     |SI aAlfa1 = ""; |Y aAlfa2 = "";
         |SI #dscsvw91#4 > 1; #dscsvw91#4 = 0; |FINSI;
     |FINSI;

     |SI #dscsvw91#13 = "R"; |O #dscsvw91#13 = "S";
         nConcepto = #dscsvw91#9; |HAZ CambioConcepto;

         |SI #dscsvw91#25 = 0; |Y #dscsvw91#26 = 0; |Y #dscsvw91#27 = 0; |Y #dscsvw91#50 = 0;
             |Y #dscsvw91#51 = 0;
             #dscsvw91#25 = nCamp25;
             #dscsvw91#26 = nCamp26;
             #dscsvw91#27 = nCamp27;
             #dscsvw91#31 = nCamp31;
             #dscsvw91#50 = nCamp50;
             #dscsvw91#51 = nCamp51;
         |FINSI;

         |SI #dscsvw91#31 = 0; |Y #dscsvw91#32 = 0;
          |Y #dscsvw91#33 = 0; |Y #dscsvw91#54 = 0;
          |Y #dscsvw91#54 = 0;
             #dscsvw91#31 = nCamp31;
             #dscsvw91#32 = nCamp32;
             #dscsvw91#33 = nCamp33;
             #dscsvw91#54 = nCamp54;
             #dscsvw91#55 = nCamp55;
        |FINSI;
     |SINO;
        #dscsvw91#37 = 0; || total factura
     |FINSI;

     |SI #dscsvw91#22 ! 0; |O #dscsvw91#23 ! 0; |O #dscsvw91#24 ! 0;
                           |O #dscsvw91#48 ! 0; |O #dscsvw91#49 ! 0;        || si es asiento de iva
         #dscsvw92#0 = #dscsvw91#13;        || tipo de iva
         #dscsvw92#1 = #dscsvw91#14;        || libro
         #dscsvw92#2 = #dscsvw91#16;        || fra./orden
         #dscsvw92#3 = #dscsvw91#17;        || serie
         |LEE 000#dscsvw92.=;
         |SI FSalida = 0;
            |SI #dscsvw92#4 ! aNumFraAnt;   || fra./orden segun historico
               aAlfa = "    ATENCION!!! Registro de IVA duplicado en Secuencial ...";
               aAlfa = aAlfa + "(" + FSalida + ") [";
               |SI #dscsvw91#13 = "S";
                  aAlfa = aAlfa + #dscsvw91#59; |QBF aAlfa;
                  aAlfa = aAlfa + "]";
               |SINO;
                  aAlfa = aAlfa + (("00" + #dscsvw91#14) % -102) + "/" + #dscsvw91#17 + "/" + (("000000" + #dscsvw91#16) % -106)+ "]";
               |FINSI;
               |MENAV aAlfa;
            |FINSI;
         |SINO;
            #dscsvw92#0 = #dscsvw91#13;        || tipo de iva
            #dscsvw92#1 = #dscsvw91#14;        || libro
            #dscsvw92#2 = #dscsvw91#16;        || fra./orden
            #dscsvw92#3 = #dscsvw91#17;        || serie
            #dscsvw92#4 = aNumFraAnt;   || fra./orden segun historico
            |GRABA 000#dscsvw92.n;
            |LIBERA #dscsvw92;
         |FINSI;
     |FINSI;
     |GRABA 020#dscsvw91.n;
     |LIBERA #dscsvw91;

     nSwAlguno = 1;

     |PULSATECLA;
|FPRC;

|PROCESO BorroAntes;
     enDnDIARIO = #camaniva#7;     || diario
     enHnDIARIO = #camaniva#7;
     efDFechas  = #camaniva#8;     || fecha
     efHFechas  = #camaniva#8;
     enDDocume  = #camaniva#9;     || documento
     enHDocume  = #camaniva#9;     || documento
     enBorraAu  = 3;

     |SUB_EJECUTA_NP "caborasi;NOMEQUITESQUETECORTOLOSGUEVOS";
|FPRC;

|PROCESO VerFactura;
     nSwPaso = 0;
     |SELECT #3#camaniva;
     #camaniva#0 = #dscsvw91#14;    || Libro
     #camaniva#2 = #dscsvw91#17;    || Serie
     #camaniva#3 = #dscsvw91#16;    || Numero Factura
     |LEE 041#camaniva.=;
     |SI FSalida = 0;
         aAlfa  = ("00" + #camaniva#0) % -102;
         aAlfa1 = #camaniva#2; |QBF aAlfa1;
         |SI aAlfa1 ! "";
             aAlfa1 = aAlfa1 + "/";
         |FINSI;

         aAlfa2 = ("000000" + #camaniva#3) % -106;
         aAlfa1 = aAlfa + "-" + aAlfa1 + aAlfa2;
         aAlfa  = "    "+ aPasar  + "La Factura " + aAlfa1 + " ya existe. (S) Pasar otra vez o (N) ignorar";
         aPasar = "N";
         |CONFI aAlfa;
         |SI FSalida = 0;
             aPasar = "S";
         |FINSI;

         |SI aPasar = "N";
             nSwPaso = 1;
         |SINO;
             |HAZ BorroAntes;
         |FINSI;
         |SELECT #1#camaniva;
     |FINSI;
|FPRC;

|PROCESO CargoDatos;
     nSwCab = 1;
     nIvas  = 0;

     #caxsecfi#10 = #dscsvw91#22;
     #caxsecfi#15 = #dscsvw91#25;
     #caxsecfi#20 = #dscsvw91#28;
     #caxsecfi#25 = #dscsvw91#31;
     #caxsecfi#30 = #dscsvw91#34;
     #caxsecfi#11 = #dscsvw91#23;
     #caxsecfi#16 = #dscsvw91#26;
     #caxsecfi#21 = #dscsvw91#29;
     #caxsecfi#26 = #dscsvw91#32;
     #caxsecfi#31 = #dscsvw91#35;
     #caxsecfi#12 = #dscsvw91#24;
     #caxsecfi#17 = #dscsvw91#27;
     #caxsecfi#22 = #dscsvw91#30;
     #caxsecfi#27 = #dscsvw91#33;
     #caxsecfi#32 = #dscsvw91#36;
     #caxsecfi#13 = #dscsvw91#48;
     #caxsecfi#18 = #dscsvw91#50;
     #caxsecfi#23 = #dscsvw91#52;
     #caxsecfi#28 = #dscsvw91#54;
     #caxsecfi#33 = #dscsvw91#56;
     #caxsecfi#14 = #dscsvw91#49;
     #caxsecfi#19 = #dscsvw91#51;
     #caxsecfi#24 = #dscsvw91#53;
     #caxsecfi#29 = #dscsvw91#55;
     #caxsecfi#34 = #dscsvw91#57;

     |SI #caxsecfi#10 ! 0; |O #caxsecfi#15 ! 0; |O #caxsecfi#25 ! 0;
         nIvas = nIvas + 1;
     |FINSI;

     |SI #caxsecfi#11 ! 0; |O #caxsecfi#16 ! 0; |O #caxsecfi#26 ! 0;
         nIvas = nIvas + 1;
     |FINSI;

     |SI #caxsecfi#12 ! 0; |O #caxsecfi#17 ! 0; |O #caxsecfi#27 ! 0;
         nIvas = nIvas + 1;
     |FINSI;

     |SI #caxsecfi#13 ! 0; |O #caxsecfi#18 ! 0; |O #caxsecfi#28 ! 0;
         nIvas = nIvas + 1;
     |FINSI;

     |SI #caxsecfi#14 ! 0; |O #caxsecfi#19 ! 0; |O #caxsecfi#29 ! 0;
         nIvas = nIvas + 1;
     |FINSI;

     #caxsecfi#35 = #dscsvw91#38;  || inversion
     #caxsecfi#36 = #dscsvw91#39;  || deducible
     #caxsecfi#37 = #dscsvw91#41;  || fecha factura
     #caxsecfi#38 = #dscsvw91#58;  || DNI
     #caxsecfi#39 = #dscsvw91#59;  || Referencia
     #caxsecfi#40 = #dscsvw91#60;  || Cuenta Analitica

     |HAZ VerFactura;
|FPRC;

|PROCESO DevuelvoDatos;
     #dscsvw91#22 = #caxsecfi#10;
     #dscsvw91#25 = #caxsecfi#15;
     #dscsvw91#28 = #caxsecfi#20;
     #dscsvw91#31 = #caxsecfi#25;
     #dscsvw91#34 = #caxsecfi#30;
     #dscsvw91#23 = #caxsecfi#11;
     #dscsvw91#26 = #caxsecfi#16;
     #dscsvw91#29 = #caxsecfi#21;
     #dscsvw91#32 = #caxsecfi#26;
     #dscsvw91#35 = #caxsecfi#31;
     #dscsvw91#24 = #caxsecfi#12;
     #dscsvw91#27 = #caxsecfi#17;
     #dscsvw91#30 = #caxsecfi#22;
     #dscsvw91#33 = #caxsecfi#27;
     #dscsvw91#36 = #caxsecfi#32;
     #dscsvw91#48 = #caxsecfi#13;
     #dscsvw91#50 = #caxsecfi#18;
     #dscsvw91#52 = #caxsecfi#23;
     #dscsvw91#54 = #caxsecfi#28;
     #dscsvw91#56 = #caxsecfi#33;
     #dscsvw91#49 = #caxsecfi#14;
     #dscsvw91#51 = #caxsecfi#19;
     #dscsvw91#53 = #caxsecfi#24;
     #dscsvw91#55 = #caxsecfi#29;
     #dscsvw91#57 = #caxsecfi#34;

     |SI #caxsecfi#35 > " ";
         #dscsvw91#38 = #caxsecfi#35;
     |FINSI;

     |SI #caxsecfi#36 > " ";
         #dscsvw91#39 = #caxsecfi#36;
     |FINSI;

     |SI #caxsecfi#37 > "01.01.0000";
         #dscsvw91#41 = #caxsecfi#37;
     |FINSI;

     |SI #caxsecfi#38 > "               ";
         #dscsvw91#58 = #caxsecfi#38;
     |FINSI;

     |SI #caxsecfi#39 > "          ";
         #dscsvw91#59 = #caxsecfi#39;
     |FINSI;

     |SI #caxsecfi#40 > "       ";
         #dscsvw91#60 = #caxsecfi#40;
     |FINSI;
|FPRC;

|PROCESO GrabaCaenlace;
     #caenlace#0 = nDiario;   || Diaro
     #caenlace#1 = fFecha;    || Fecha
     #caenlace#2 = nDocum;    || Documento
     #caenlace#3 = nApunte;
     #caenlace#37 = enEmpresa;
     #caenlace#38 = enPeriodo;
     |LEE 001#caenlace.=;
     |SI FSalida ! 0;
         |DDEFECTO #caenlace;
         #caenlace#0 = nDiario;   || Diaro
         #caenlace#1 = fFecha;    || Fecha
         #caenlace#2 = nDocum;    || Documento
         #caenlace#3 = nApunte;
         #caenlace#37 = enEmpresa;
         #caenlace#38 = enPeriodo;
         |GRABA 020#caenlace.c;
     |FINSI;
|FPRC;

|PROCESO GraboLinea;
     nApunte = nApunte + 10;
     |HAZ GrabaCaenlace;

     |SI #dscsvw91#11 = "D";
         eaCuenta = #dscsvw91#5;
     |SINO;
         eaCuenta = #dscsvw91#6;
     |FINSI;

     #caenlace#4 = eaCuenta;
     |HAZ SacaNivel;
     #caenlace#5 = enNivel;
     #caenlace#6 = #dscsvw91#9;      || Concepto
     #caenlace#7 = #dscsvw91#10;     || Descripcion
     #caenlace#8 = #dscsvw91#11;     || Signo
     #caenlace#9 = #dscsvw91#12;     || Importe

     |SI #dscsvw91#14 = 0;
         |SI #dscsvw91#13 = "R"; #dscsvw91#14 = #caivaasi#3;  |FINSI;
         |SI #dscsvw91#13 = "S"; #dscsvw91#14 = #caivaasi#29; |FINSI;
     |FINSI;
     #caenlace#10 = #dscsvw91#13;    || Soportado/Repercutido
     #caenlace#11 = #dscsvw91#14;    || Libro
     #caenlace#12 = #dscsvw91#17;    || Serie
     #caenlace#13 = #dscsvw91#16;    || Numero Factura
     #caenlace#14 = 0;               || Recibo 0

     #caenlace#15 = #dscsvw91#40;    || Departamento
     #caenlace#19 = Usuario;         || Usuario

     #caenlace#26 = #dscsvw91#42;    || Tipo Acumulador
     #caenlace#27 = #dscsvw91#43;    || Numero

     |SI #caenlace#10 ! "R"; |Y #caenlace#10 ! "S";
         #caenlace#11 = 0;
         #caenlace#12 = "";
         #caenlace#13 = 0;
         #caenlace#26 = "";
         #caenlace#27 = 0;
     |FINSI;

     aAlfa1 = #caenlace#26; aAlfa1 = aAlfa1 > " ";
     |SI aAlfa1 = "B"; |O aAlfa1 = "I"; |O aAlfa1 = "R";
         |SI #caenlace#27 [ 1; nNume1 = 25; |FINSI;
         |SI #caenlace#27 = 2; nNume1 = 26; |FINSI;
         |SI #caenlace#27 = 3; nNume1 = 27; |FINSI;
         |SI #caenlace#27 = 4; nNume1 = 50; |FINSI;
         |SI #caenlace#27 = 5; nNume1 = 51; |FINSI;
         #caenlace#28 = #dscsvw91#nNume1#;

         |SI #caenlace#27 [ 1; nNume1 = 31; |FINSI;
         |SI #caenlace#27 = 2; nNume1 = 32; |FINSI;
         |SI #caenlace#27 = 3; nNume1 = 33; |FINSI;
         |SI #caenlace#27 = 4; nNume1 = 54; |FINSI;
         |SI #caenlace#27 = 5; nNume1 = 55; |FINSI;
         #caenlace#33 = #dscsvw91#nNume1#;
     |FINSI;

     #caenlace#29 = #dscsvw91#41;  || Fecha Factura
     |SI #caenlace#10 = "R"; |O #caenlace#10 = "S";
         |SI #dscsvw91#41 [ "01.01.1000";
             #caenlace#29 = #dscsvw91#1;  || Fecha Asiento
         |FINSI;
     |FINSI;
     #caenlace#31 = #dscsvw91#39;  || Deducible
     #caenlace#32 = #dscsvw91#38;  || Inversion

     #caenlace#44 = #dscsvw91#58; || NIF
     |GRABA 020#caenlace.a;

     |SI nUltDoc < nDocum; nUltDoc = nDocum; |FINSI;
|FPRC;

|PROCESO dscsvw91;
     |SI #dscsvw91#0 ! nDiario; |O fFecha ! #dscsvw91#1; |O nDocumSec ! #dscsvw91#2;
         nSwCab     = 0;
         nDiario    = #dscsvw91#0;
         fFecha     = #dscsvw91#1;
         nDocumSec  = #dscsvw91#2;
         nApunte    = -9;
         |SI #caxsecfi#9 = 0;
             nDocum = nDocumSec;
         |SINO;
             nDocum = #caxsecfi#9;
             #caxsecfi#9   = #caxsecfi#9 + 1;
         |FINSI;

         nSwPaso = 0;
         nIvas   = 0;
         |PDEFECTO #caxsecfi, 10, 41;

         aAlfa1 = #dscsvw91#5; |QBF aAlfa1;
         aAlfa2 = #dscsvw91#6; |QBF aAlfa2;
         |SI aAlfa1 = ""; |Y aAlfa2 = "";
             |SI #dscsvw91#13 = "R";  |O #dscsvw91#13 = "S";
                 |HAZ CargoDatos;
                 |ACABA;
             |FINSI;
         |SINO;
             |SI #dscsvw91#13 = "R";  |O #dscsvw91#13 = "S";
                 |HAZ VerFactura;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSwPaso = 1; |ACABA; |FINSI;

     |SI #dscsvw91#13 ! "R"; |Y #dscsvw91#13 ! "S";   ||Este Apunte no es de IVA
         |HAZ GraboLinea;
         |ACABA;
     |FINSI;

     |SI nSwCab = 1; |HAZ DevuelvoDatos; |FINSI;

     |SI #dscsvw91#42 = " "; |O #dscsvw91#42 = "F";   || Linea del total factura
         |HAZ GraboLinea;
     |SINO;
         |SI nIvas [ 1;
             |HAZ GraboLinea;
         |SINO;
             |SI #dscsvw91#43 = 0;
                 |PARA nPara1 = 1; |SI nPara1 [ nIvas; |HACIENDO nPara1 = nPara1 + 1;
                       #dscsvw91#43 = nPara1;
                       |SI #dscsvw91#42 = "B"; nNume2 = nPara1 + 9;  |FINSI;
                       |SI #dscsvw91#42 = "I"; nNume2 = nPara1 + 19; |FINSI;
                       |SI #dscsvw91#42 = "R"; nNume2 = nPara1 + 29; |FINSI;

                       #dscsvw91#12 = #caxsecfi#nNume2#;

                       |HAZ GraboLinea;
                 |SIGUE;
             |SINO;
                 |HAZ GraboLinea;
             |FINSI;
         |FINSI;
     |FINSI;

     |PULSATECLA;
|FPRC;

|DEFBUCLE dscsvw91;
     #dscsvw91#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dscsvw91;
|FIN;

|PROCESO ImportaFacturas;
     aAlfa = "Procesando fichero de facturas";
     |VENTANA 0501, 3599, -1, 16, aAlfa;
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     aAlfa = "dscsvw91" + Usuario;
     |NOME_DAT #dscsvw91#aAlfa#;
     |ABRE #dscsvw91;   |CIERRA #dscsvw91;   |DELINDEX #dscsvw91;

     aAlfa = "dscsvw92" + Usuario;
     |NOME_DAT #dscsvw92#aAlfa#;
     |ABRE #dscsvw92;   |CIERRA #dscsvw92;   |DELINDEX #dscsvw92;

     aAlfa = "caenlace" + Usuario;
     |NOME_DAT #caenlace#aAlfa#;
     |ABRE #caenlace;   |CIERRA #caenlace;   |DELINDEX #caenlace;

     nSwAlguno = 0;
     |ABRE #dscsvw91;
     |ABRE #dscsvw92;
     |XABRE "B", aFicTmp, nHandle;
     |PARA; |SI; |HACIENDO;
            |XLEE nHandle, 204, aLee1;
            |SI FSalida ! 204;   |SAL;   |FINSI;

            |XLEE nHandle, 188, aLee2;
            |SI FSalida ! 188;   |SAL;   |FINSI;

            |HAZ Facturas;
     |SIGUE;
     |XCIERRA nHandle;

     |CIERRA #dscsvw91;
     |CIERRA #dscsvw92;

     |SI nSwAlguno = 1;
         nSwPaso = 0;
         aPasar  = "N";
         |ABRE #caenlace;
         |BUCLE dscsvw91;
         |CIERRA #caenlace;

         nDOCUMENTO = nUltDoc;
         |HAZ ActContador;
         enNoModif = 0;
         |SI aModAsiento = "N";
             enNoModif = 100;  || para que no se modifiquen los apuntes
         |FINSI;

         |DFICE aAlfa1; |QBF aAlfa1;
         enNoEndatos = 1;
         aAlfa  = "caenlace" + Usuario;
         aAlfa1 = "dsapunte.tab;" + aAlfa1 + "," + aAlfa;
         |SUB_EJECUTA_NP aAlfa1;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO Cobros;
                             #calincob#0  = 1;
     aAlfa1 = aLee1 % 606;   #calincob#1  = aAlfa1;
     aAlfa1 = aLee1 % 105;   #calincob#2  = aAlfa1;
     aAlfa1 = aLee1 % 1203;  #calincob#3  = aAlfa1;
     |LEE 000#calincob.=;
     |SI FSalida = 0;
         aAlfa = "Cobro del recibo ";
         aAlfa = aAlfa + #calincob#2 + "  / " + #calincob#1 + " / " + #calincob#3;
         aAlfa = aAlfa + " ya existe";

         #dscsvw93#0 = aAlfa;
         |GRABA 000#dscsvw93.n;
         |LIBERA #dscsvw93;

         |ACABA;
     |FINSI;

     |SELECT #3#camaniva;
     #camaniva#0  = #calincob#0;
     #camaniva#2  = #calincob#2;
     #camaniva#3  = #calincob#1;
     |LEE 000#camaniva.=;
     |SI FSalida ! 0;
         |SELECT #1#camaniva;
         aAlfa = "Cobro del recibo ";
         aAlfa = aAlfa + #calincob#2 + "  / " + #calincob#1 + " / " + #calincob#3;
         aAlfa = aAlfa + " no est  en el registro de IVA.";

         #dscsvw93#0 = aAlfa;
         |GRABA 000#dscsvw93.n;
         |LIBERA #dscsvw93;

         |ACABA;
     |FINSI;
     |SELECT #1#camaniva;

     |DDEFECTO #calincob;

                             #calincob#0  = 1;
     aAlfa1 = aLee1 % 606;   #calincob#1  = aAlfa1;
     aAlfa1 = aLee1 % 105;   #calincob#2  = aAlfa1;
     aAlfa1 = aLee1 % 1203;  #calincob#3  = aAlfa1;
                             #calincob#4  = #camaniva#12;
     aAlfa1 = aLee1 % 1510;  #calincob#6  = aAlfa1;
     aAlfa1 = aLee1 % 2510;  #calincob#7  = aAlfa1;
     aAlfa1 = aLee1 % 3510;  #calincob#8  = aAlfa1;
     aAlfa1 = aLee1 % 4510;  #calincob#9  = aAlfa1;
                             #calincob#14 = #calincob#7;
     |GRABA 020#calincob.n;
     |LIBERA #calincob;

     nNumDoc = nNumDoc + 1;

     #caclipro#23 = "C";
     #caclipro#10 = #calincob#4;
     |LEE 000#caclipro.=;

     |DDEFECTO #Puente@;
     #Puente@#0  = #calincob#0;            || Libro
     #Puente@#1  = #calincob#2;            || Serie
     #Puente@#2  = #calincob#1;            || Factura
     #Puente@#3  = #calincob#3;            || Numero recibo
     #Puente@#4  = #calincob#7;            || Fecha vto.
     #Puente@#5  = #calincob#6;            || Fecha emision
     #Puente@#6  = #calincob#4;            || Cuenta Cliente
     #Puente@#7  = #camaniva#13;           || Nombre Cliente
     #Puente@#8  = #calincob#15;           || Nombre Banco
     #Puente@#9  = #caclipro#29;           || Entidad
     #Puente@#10 = #caclipro#30;           || Sucursal
     #Puente@#11 = #caclipro#31;           || DC
     #Puente@#12 = #caclipro#32;           || N§ Cuenta
     #Puente@#13 = #calincob#11;           || Tipo de recibo
     #Puente@#14 = "";                     || Departamento
     #Puente@#15 = #calincob#8;            || Importe Recibo
     #Puente@#16 = "";                     || A Aceptar
     #Puente@#17 = "";                     || Aceptado
     #Puente@#18 = "";                     || Codigo Cliente (GESTION)
     #Puente@#19 = #calincob#28;           || Representante
     #Puente@#21 = "";                     || Zona
     #Puente@#22 = nNumDoc;                || N§ Documento
     #Puente@#23 = enEmpresa;              || Codigo Empresa
     #Puente@#24 = enPeriodo;              || Periodo Empresa
     #Puente@#25 = "";                     || Empresa gestion
     #Puente@#26 = "N";                    || Recibo a cuenta
     #Puente@#27 = "V";                    || Tipo de recibo
     #Puente@#28 = "A";
     #Puente@#29 = "EUR";               || Divisa
     #Puente@#30 = "EURO";              || Nombre Divisa
     #Puente@#31 = 1;                   || Cambio Divisa en EUROS
     #Puente@#32 = 1;                   || Cambio M.Base en EUROS
     #Puente@#33 = #caclipro#28;
     #Puente@#40 = #caclipro#20;
     #Puente@#48 = #caclipro#40;
     #Puente@#49 = #caclipro#41;

     |GRABA 020#Puente@.n;

     |PULSATECLA;
|FPRC;

|PROCESO Pagos;
                             #calinpag#0  = 2;
     aAlfa1 = aLee1 % 606;   #calinpag#1  = aAlfa1;
     aAlfa1 = aLee1 % 105;   #calinpag#2  = aAlfa1;
     aAlfa1 = aLee1 % 1203;  #calinpag#3  = aAlfa1;
     |LEE 000#calinpag.=;
     |SI FSalida = 0;
         aAlfa = "Pago del recibo ";
         aAlfa = aAlfa + #calinpag#2 + "  / " + #calinpag#1 + " / " + #calinpag#3;
         aAlfa = aAlfa + " ya existe";

         #dscsvw93#0 = aAlfa;
         |GRABA 000#dscsvw93.n;
         |LIBERA #dscsvw93;
         |ACABA;
     |FINSI;

     |SELECT #3#camaniva;
     #camaniva#0  = #calinpag#0;
     #camaniva#2  = #calinpag#2;
     #camaniva#3  = #calinpag#1;
     |LEE 000#camaniva.=;
     |SI FSalida ! 0;
         |SELECT #1#camaniva;
         aAlfa = "Pago del recibo ";
         aAlfa = aAlfa + #calinpag#2 + "  / " + #calinpag#1 + " / " + #calinpag#3;
         aAlfa = aAlfa + " no est  en el registro de IVA.";

         #dscsvw93#0 = aAlfa;
         |GRABA 000#dscsvw93.n;
         |LIBERA #dscsvw93;

         |ACABA;
     |FINSI;
     |SELECT #1#camaniva;

     |DDEFECTO #calinpag;

                             #calinpag#0  = 2;
     aAlfa1 = aLee1 % 606;   #calinpag#1  = aAlfa1;
     aAlfa1 = aLee1 % 105;   #calinpag#2  = aAlfa1;
     aAlfa1 = aLee1 % 1203;  #calinpag#3  = aAlfa1;
                             #calinpag#4  = #camaniva#12;
     aAlfa1 = aLee1 % 1510;  #calinpag#6  = aAlfa1;
     aAlfa1 = aLee1 % 2510;  #calinpag#7  = aAlfa1;
     aAlfa1 = aLee1 % 3510;  #calinpag#8  = aAlfa1;
     aAlfa1 = aLee1 % 4510;  #calinpag#9  = aAlfa1;

     |GRABA 020#calinpag.n;
     |LIBERA #calinpag;

     |PULSATECLA;
|FPRC;

|PROCESO Vencimientos;
     aTipo = aLee1 % 5501;

     |SI aTipo = "C";  |HAZ Cobros;  |FINSI;
     |SI aTipo = "P";  |HAZ Pagos;   |FINSI;
|FPRC;

|PROCESO ImportaVencimientos;
     eaPath = #caivaasi#56; |QBF eaPath;
     |SI eaPath = "";
         |MENAV "0000Configure la aplicaci¢n de cartera en Control Defecto Entrada de IVA, no puedo importar vencimientos.";
         |ACABA;
     |FINSI;

     |HAZ CreaPuente;

     |SI eaRetorno = "ERROR";
         |MENAV "0000No est  la cartera instalada, no puedo importar vencimientos";
         |ACABA;
     |FINSI;

     aAlfa = "Procesando fichero de Vencimientos";
     |VENTANA 0501, 3599, -1, 16, aAlfa;
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     aAlfa = "dscsvw93" + Usuario;
     |NOME_DAT #dscsvw93#aAlfa#;
     |ABRE #dscsvw93;   |CIERRA #dscsvw93;   |DELINDEX #dscsvw93;

     |ABRE #dscsvw93;

     |XABRE "B", aFicTmp, nHandle;

     nNumDoc = 0;
     |PARA; |SI; |HACIENDO;
            |XLEE nHandle, 56, aLee1;
            |SI FSalida ! 56;   |SAL;   |FINSI;

            |HAZ Vencimientos;
     |SIGUE;

     |SI nNumDoc ! 0;
         |HAZ CierraPuente;
     |FINSI;

     |SI nNumDoc = 0;
         |HAZ CiePuente2;
     |FINSI;

     |LEE 000#dscsvw93.p;
     |SI FSalida = 0;
         |MENAV "0000Han habido errores en la importaci¢n de recibos. A continuaci¢n informamos de los recibos afectados";

         |PARA;  |SI;  |HACIENDO;
              |CONSULTA_CLAVE #1#dscsvw93;
              |CONFI "0000SQuiere salir de la consulta";
              |SI FSalida = 0;  |SAL;  |FINSI;
         |SIGUE;
     |FINSI;

     |CIERRA #dscsvw93;
     |DELINDEX #dscsvw93;

     |XCIERRA nHandle;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO Importacion;
     aFicTmp = #dscsvz90#2;   |QBF aFicTmp;
     |SI aFicTmp ! "";
         |HAZ ImportaCuentas;
     |FINSI;

     aFicTmp = #dscsvz90#3;  |QBF aFicTmp;
     |SI aFicTmp ! "";
         |HAZ ImportaFacturas;
     |FINSI;
     |SI enNoEndatos = 100;  |ACABA;  |FINSI;

     aFicTmp = #dscsvz90#4;  |QBF aFicTmp;
     |SI aFicTmp ! "";
         |HAZ ImportaVencimientos;
     |FINSI;
|FPRC;

|PROCESO CopiaFichero;
     |SI eaIP   = "";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         |RECIBE_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO RecogePath;
     nFSalida = FSalida;

     |ESTADO_CONTROL nBtnPat1, "DISABLE";
     |ESTADO_CONTROL nBtnCar1, "DISABLE";
     |ESTADO_CONTROL nBtnCar2, "DISABLE";
     |ESTADO_CONTROL nBtnCar3, "DISABLE";

     aFicBrowse = "D" + #dscsvz90#1;  |QBF aFicBrowse;
     |BROWSE aFicBrowse;

     aAlfa      = aFicBrowse;   |QBF aAlfa;
     aFicBrowse = "";
     aLong      = aAlfa % 0;
     nLong      = aLong;
     |PARA nCarac = 2;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos  = (nCarac * 100) + 1;
           aFicBrowse = aFicBrowse + (aAlfa % nPos);
     |SIGUE;

     |ESTADO_CONTROL nBtnPat1, "ENABLE";
     |ESTADO_CONTROL nBtnCar1, "ENABLE";
     |ESTADO_CONTROL nBtnCar2, "ENABLE";
     |ESTADO_CONTROL nBtnCar3, "ENABLE";

     |SI aFicBrowse = "";  |ACABA;  |FINSI;

     #dscsvz90#1 = aFicBrowse + "\";  |PINTA #dscsvz90#1;
|FPRC;

|PROCESO RecogeDoc;
     nFSalida = FSalida;

     |ESTADO_CONTROL nBtnPat1, "DISABLE";
     |ESTADO_CONTROL nBtnCar1, "DISABLE";
     |ESTADO_CONTROL nBtnCar2, "DISABLE";
     |ESTADO_CONTROL nBtnCar3, "DISABLE";

     aAlfa = "F" + #dscsvz90#1;  |QBF aAlfa;
     aFicBrowse = aAlfa + "*.*";
     |BROWSE aFicBrowse;

     aAlfa      = aFicBrowse;   |QBF aAlfa;
     aFicBrowse = "";
     aLong      = aAlfa % 0;
     nLong      = aLong;
     |PARA nCarac = 2;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos  = (nCarac * 100) + 1;
           aFicBrowse = aFicBrowse + (aAlfa % nPos);
     |SIGUE;

     |ESTADO_CONTROL nBtnPat1, "ENABLE";
     |ESTADO_CONTROL nBtnCar1, "ENABLE";
     |ESTADO_CONTROL nBtnCar2, "ENABLE";
     |ESTADO_CONTROL nBtnCar3, "ENABLE";

     |SI aFicBrowse = "";  |ACABA;  |FINSI;

     |SI nFSalida = nBtnCar1;
         aAlfa = aPathTmp + "cuentas.txt";         |FBORRA aAlfa;

         aOrigen    = aFicBrowse;
         aDestino   = aPathTmp + "cuentas.txt";
         |HAZ CopiaFichero;

         #dscsvz90#2 = aDestino;  |PINTA #dscsvz90#2;
     |FINSI;

     |SI nFSalida = nBtnCar2;
         aAlfa = aPathTmp + "facturas.txt";        |FBORRA aAlfa;

         aOrigen    = aFicBrowse;
         aDestino   = aPathTmp + "facturas.txt";
         |HAZ CopiaFichero;

         #dscsvz90#3 = aDestino;  |PINTA #dscsvz90#3;
     |FINSI;

     |SI nFSalida = nBtnCar3;
         aAlfa = aPathTmp + "vencimientos.txt";    |FBORRA aAlfa;

         aOrigen    = aFicBrowse;
         aDestino   = aPathTmp + "vencimientos.txt";
         |HAZ CopiaFichero;

         #dscsvz90#4 = aDestino;  |PINTA #dscsvz90#4;
     |FINSI;
|FPRC;

|PROCESO Cancelar;
     |PTEC 807;
|FPRC;

|PROCESO ModAsiento;
     |FIN_CONTROL_WINDOWS nBtnUni;

     |SI aModAsiento = "SI";
         aModAsiento = "NO";
     |SINO;
         aModAsiento = "SI";
     |FINSI;

     aAlfa = "BOTON," + aModAsiento;
     |CONTROL_SIMPLE nPanta, aAlfa, 2116, 2319, ModAsiento; nBtnUni = FSalida;
|FPRC;

|PROGRAMA;
     aTextoVentana = "Importaci¢n MANTAS MORA";
     |VENTANA 0501, 3599, -1, 16, aTextoVentana;
     n0Vent = FSalida;

     |PINPA #0#dscsvz90;  nPanta = FSalida;
     |PINDA #0#dscsvz90;

     aModAsiento = "NO";

     |CONTROL_SIMPLE nPanta, "LABEL,{{15}}Asientos e IVA", 2202, 2215, NULL;
     |CONTROL_SIMPLE nPanta, "LABEL,{{15}}se dejan modificables", 2221, 2240, NULL;

     aAlfa = "BOTON," + aModAsiento;
     |CONTROL_SIMPLE nPanta, aAlfa, 2116, 2319, ModAsiento; nBtnUni = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}", 0642, 0648, RecogePath; nBtnPat1 = FSalida;
     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}", 0942, 0948, RecogeDoc;  nBtnCar1 = FSalida;
     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}", 1242, 1248, RecogeDoc;  nBtnCar2 = FSalida;
     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}", 1542, 1548, RecogeDoc;  nBtnCar3 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{207}}Cancelar", 3570, 3582, Cancelar;
     nBtnCan = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{230}}Continuar";
          |LEETECLA aTecla;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
          |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBtnPat1;
     |FIN_CONTROL_WINDOWS nBtnCar1;
     |FIN_CONTROL_WINDOWS nBtnCar2;
     |FIN_CONTROL_WINDOWS nBtnCar3;
     |FIN_CONTROL_WINDOWS nBtnCan;

     |SI aTecla = aEsc2;
         |MENAV "0000Proceso cancelado.";

         |FINVENTANA n0Vent;

         |PULSATECLA;
         |PULSATECLA;
         |PULSATECLA;
         |ACABA;
     |FINSI;

     |HAZ Importacion;

     |FINVENTANA n0Vent;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRO;

|PROCESO Tipo80;  |TIPO 80;
     |ABRE #dscsvz90;
     |LEE 101#dscsvz90.p;
     |SI FSalida ! 0;
         |DDEFECTO #dscsvz90;
         |GRABA 020#dscsvz90.b;
     |FINSI;

     nChequeo = 0;
     eaIP     = "";  |IP_REMOTO eaIP;

     |HAZ LeeUnidadBasico;

     aPathLocal = eaUnidadBasico + "\documentos";   |RMKDIR aPathLocal;
     aPathLocal = aPathLocal + "\tmp";              |RMKDIR aPathLocal;
     aPathLocal = aPathLocal + "\";

     |DBASE aBase;
     aPathTmp   = aBase     + "tmp";           |MKDIR aPathTmp;
     aPathTmp   = aPathTmp  + "/" + Usuario;   |MKDIR aPathTmp;
     aPathTmp   = aPathTmp  + "/";

     aPathContagen = eaUnidadBasico + "\documentos";   |RMKDIR aPathContagen;
     aPathContagen = aPathContagen + "\contagen\";     |RMKDIR aPathContagen;

     aAlfa = aPathTmp + "cuentas.txt";         |FBORRA aAlfa;
     aAlfa = aPathTmp + "facturas.txt";        |FBORRA aAlfa;
     aAlfa = aPathTmp + "vencimientos.txt";    |FBORRA aAlfa;

     |ABRET #cacuenta;

     |HAZ inicio;
     |HAZ DirAplicSt;
     |HAZ Referencias;

     |ABRET #caclipro;
     |ABRET #camaniva;
     |ABRET #calincob;
     |ABRET #calinpag;
     |ABRET #calibros;
     |ABRET #caivases;
     |ABRET #dsmom030;

     |ABRE #caivaasi;
     |LEE 000#caivaasi.p;
     |SI FSalida ! 0;  |DDEFECTO #caivaasi;  |FINSI;
     |CIERRA #caivaasi;

     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     aAlfa = aPathTmp + "cuentas.txt";         |FBORRA aAlfa;
     aAlfa = aPathTmp + "facturas.txt";        |FBORRA aAlfa;
     aAlfa = aPathTmp + "vencimientos.txt";    |FBORRA aAlfa;

     |CIERRAT #cacuenta;
     |CIERRAT #caclipro;
     |CIERRAT #camaniva;
     |CIERRAT #calincob;
     |CIERRAT #calinpag;
     |CIERRAT #calibros;
     |CIERRAT #caivases;
     |CIERRAT #dsmom030;

     #dscsvz90#2 = "";
     #dscsvz90#3 = "";
     #dscsvz90#4 = "";

     |GRABA 020#dscsvz90.a;
     |LIBERA #dscsvz90;
     |CIERRA #dscsvz90;

     |PULSATECLA;
     |PULSATECLA;
|FPRC;
