|FICHEROS;
   caipcbox #0;

   caenlace #10;
   caconasi #11;
|FIN;

|VARIABLES;
   &PRMNT_enError = 0;

   nHandle  = 0;
   nNivel   = 0;
   nLinAsto = 0;
   nDocAnt  = 0;
   nNumDoc  = 0;
   nNumero  = 0;
   nSw      = 0;
   nSwApunte = 0;
   nCont     = 0;
   nCalc     = 0;
   nNumChar  = 0;

   nLong    = 0;
   aLong    = "";
   aAlfa    = "";
   aAlfa1   = "";
   aAlfa2   = "";
   aIP      = "";

   aCadena1 = "";
   aCadena2 = "";

   aCuenta  = "";
   aTipo    = "";
   aSopRep  = "";
   aCpto    = "";

   fUltFecha  = @;
   fFechaAnt  = @;
   fFechaAsto = @;
|FIN;

|PROCESO Contador;

   |HAZ contador;
   nNumDoc = #caconasi#1;

/*
   |ABRE #caconasi;
   |LEE 101#caconasi.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconasi;
      |GRABA 020#caconasi.n;
      |LEE 101#caconasi.p;
   |FINSI;

   #caconasi#1 = #caconasi#1 + 1;
   aAlfa = "|NC"; nCalc = #caconasi#aAlfa#;
   |SI nCalc > 2; #caconasi#2 = #caconasi#2 + 1; |FINSI;
   nNumDoc = #caconasi#1;

   |GRABA 020#caconasi.a;
   |LIBERA #caconasi;
   |CIERRA #caconasi;
*/
|FPRC;

|PROCESO MiraFichero;
   |SI FSalida = 2; |ACABA; |FINSI;

   aAlfa = #caipcbox#2; |QBF aAlfa;
   |SI aAlfa = "";
      aAlfa = "F";
      |BROWSE aAlfa;
      aAlfa = aAlfa %0299;

      |XABRE "CE", aAlfa, nHandle;
      |SI FSalida < 0;
         |MENAV "    No encuentro el fichero seleccionado";
         |ERROR; |ACABA;
      |FINSI;
      aAlfa1 = ""; aAlfa2 = "";
      aAlfa2 = aAlfa % -101;
      |PARA nCont = 2; |SI aAlfa2 ! "\"; |Y aAlfa2 ! "/"; |HACIENDO nCont = nCont + 1;
         aAlfa1 = aAlfa2 + aAlfa1;
         nCalc = 0 - ((nCont * 100) + 1);
         aAlfa2 = aAlfa % nCalc;
      |SIGUE;

      #caipcbox#2 = aAlfa1; |PINTA #caipcbox#2;
      aAlfa2 = #caipcbox#1; |QBF aAlfa2;
      aAlfa1 = aAlfa2 + #caipcbox#2; |QBF aAlfa1;

      aIP = ""; |IP_REMOTO aIP;
      |SI aIP = "";
         |COPIA_FICHERO aAlfa, aAlfa1;
      |SINO;
         |RECIBE_FICHERO aAlfa, aAlfa1;
      |FINSI;
   |FINSI;

   aAlfa = #caipcbox#1; |QBF aAlfa;
   aAlfa = aAlfa + #caipcbox#2; |QBF aAlfa;
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida < 0;
      |MENAV "    Fichero inexistente en el camino o con el nombre indicados";
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO MiraNivel;
   |QBF aCuenta; aLong = aCuenta % 0;
   nLong = aLong;

   nNivel = 0;
   |SI nLong = #48#14; nNivel = 1; |FINSI;
   |SI nLong = #48#15; nNivel = 2; |FINSI;
   |SI nLong = #48#16; nNivel = 3; |FINSI;
   |SI nLong = #48#17; nNivel = 4; |FINSI;
   |SI nLong = #48#18; nNivel = 5; |FINSI;
   |SI nLong = #48#19; nNivel = 6; |FINSI;
|FPRC;

|PROCESO GrabaComun;
   aAlfa = aCadena1 % 10306;  nCalc = aAlfa;
   |SI nDocAnt ! nCalc;
      nLinAsto = 1; nDocAnt = nCalc;
      |HAZ Contador;
   |FINSI;

   aAlfa = aCadena1 % 0102;  #caenlace#0 = aAlfa; || Diario
   aAlfa = aCadena1 % 0310;  #caenlace#1 = aAlfa; || Fecha asiento
   fUltFecha = #caenlace#1;
                             #caenlace#2 = nNumDoc;  || Documento
                             #caenlace#3 = nLinAsto; || Asiento
                             nLinAsto = nLinAsto + 1;
   aAlfa = aCadena1 % 11103; #caenlace#6 = aAlfa; || Codigo Concepto
   aAlfa = aCadena1 % 11430; #caenlace#7 = aAlfa; || Descripcion Concepto
   aAlfa = aCadena1 % 10001; #caenlace#10 = aAlfa;|| Repercutido/Soportado
   aAlfa = aCadena1 % 10102; #caenlace#11 = aAlfa; || Libro   factura
   aAlfa = aCadena1 % 10902; #caenlace#12 = aAlfa; || Serie   factura
   aAlfa = aCadena1 % 10306; #caenlace#13 = aAlfa; || Factura factura
   aAlfa = aCadena2 % 9010;  #caenlace#29 = aAlfa; || Fecha Factura
                             #caenlace#51 = aAlfa; || Fecha operacion
   aAlfa = aCadena2 % 8701;  #caenlace#31 = aAlfa; || Deducible
   aAlfa = aCadena2 % 8601;  #caenlace#32 = aAlfa; || Inversion
                             #caenlace#37 = #48#2;
                             #caenlace#38 = #48#3;
|FPRC;

|PROCESO RellenaDatos;
   |SI #caenlace#26 = aTipo; |Y #caenlace#4 = "            ";
      #caenlace#4 = aCuenta;
      #caenlace#5 = nNivel;
      |GRABA 020#caenlace.a;
   |FINSI;
|FPRC;

|DEFBUCLE RellenaDatos;
#caenlace#1;
10;
00,fUltFecha, 000000, 0000, 00000, 0, aSopRep;
99,fUltFecha, 999999, 9999, 99999, 9, aSopRep;
;
NULL, RellenaDatos;
|FIN;

|PROCESO Interpreta;
   aAlfa = aCadena1 % 14412; |QBF aAlfa;
   |SI aAlfa ! "";
      || Factura
      || Grabo el total factura
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      aAlfa = aCadena1 % 14412; #caenlace#4 = aAlfa; || Cuenta
      aAlfa = aCadena1 % 15601; #caenlace#5 = aAlfa; || Nivel
      |SI #caenlace#10 = "R";
         #caenlace#8 = "D";
      |SINO;
         #caenlace#8 = "H";
      |FINSI;
      aAlfa = aCadena2 % 7610;  #caenlace#9  = aAlfa; || Importe Total Factura
                                #caenlace#26 = "F";   || Total Factura
                                #caenlace#27 = 0;
      aAlfa = aCadena2 % 18830; #caenlace#43 = aAlfa; || Nombre cliente
      aAlfa = aCadena2 % 22415; #caenlace#44 = aAlfa; || Nif cliente
      |GRABA 020#caenlace.n;

      || Grabo la Base 1
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena1 % 15710; #caenlace#9  = aAlfa; || Importe Base 1
                                #caenlace#26 = "B";   || Base 1
                                #caenlace#27 = 1;
      aAlfa = aCadena1 % 18705; #caenlace#28  = aAlfa;|| Tipo IVA Base 1
      aAlfa = aCadena2 % 3105;  #caenlace#33  = aAlfa;|| Tipo REC Base 1
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Base 2
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena1 % 16710; #caenlace#9  = aAlfa; || Importe Base 2
                                #caenlace#26 = "B";   || Base 2
                                #caenlace#27 = 2;
      aAlfa = aCadena1 % 19205; #caenlace#28  = aAlfa;|| Tipo IVA Base 2
      aAlfa = aCadena2 % 3605;  #caenlace#33  = aAlfa;|| Tipo REC Base 2
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Base 3
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena1 % 17710; #caenlace#9  = aAlfa; || Importe Base 3
                                #caenlace#26 = "B";   || Base 3
                                #caenlace#27 = 3;
      aAlfa = aCadena1 % 19705; #caenlace#28  = aAlfa;|| Tipo IVA Base 3
      aAlfa = aCadena2 % 4105;  #caenlace#33  = aAlfa;|| Tipo REC Base 3
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Base 4
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 10810; #caenlace#9  = aAlfa; || Importe Base 4
                                #caenlace#26 = "B";   || Base 4
                                #caenlace#27 = 4;
      aAlfa = aCadena2 % 12805; #caenlace#28  = aAlfa;|| Tipo IVA Base 4
      aAlfa = aCadena2 % 15805; #caenlace#33  = aAlfa;|| Tipo REC Base 4
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Base 5
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 11810; #caenlace#9  = aAlfa; || Importe Base 5
                                #caenlace#26 = "B";   || Base 5
                                #caenlace#27 = 5;
      aAlfa = aCadena2 % 13305; #caenlace#28  = aAlfa;|| Tipo IVA Base 5
      aAlfa = aCadena2 % 16305; #caenlace#33  = aAlfa;|| Tipo REC Base 5
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota IVA 1
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 110;   #caenlace#9  = aAlfa; || Importe Cuota IVA 1
                                #caenlace#26 = "I";   || Cuota IVA 1
                                #caenlace#27 = 1;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota IVA 2
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 1110;  #caenlace#9  = aAlfa; || Importe Cuota IVA 2
                                #caenlace#26 = "I";   || Cuota IVA 2
                                #caenlace#27 = 2;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota IVA 3
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 2110;  #caenlace#9  = aAlfa; || Importe Cuota IVA 3
                                #caenlace#26 = "I";   || Cuota IVA 3
                                #caenlace#27 = 3;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota IVA 4
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 13810; #caenlace#9  = aAlfa; || Importe Cuota IVA 4
                                #caenlace#26 = "I";   || Cuota IVA 4
                                #caenlace#27 = 4;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota IVA 5
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 14810;  #caenlace#9  = aAlfa; || Importe Cuota IVA 5
                                #caenlace#26 = "I";   || Cuota IVA 5
                                #caenlace#27 = 5;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota REC 1
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 4610;  #caenlace#9  = aAlfa; || Importe Cuota REC 1
                                #caenlace#26 = "R";   || Cuota REC 1
                                #caenlace#27 = 1;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota REC 2
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 5610;  #caenlace#9  = aAlfa; || Importe Cuota REC 2
                                #caenlace#26 = "R";   || Cuota IVA 2
                                #caenlace#27 = 2;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota REC 3
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 6610;  #caenlace#9  = aAlfa; || Importe Cuota REC 3
                                #caenlace#26 = "R";   || Cuota REC 3
                                #caenlace#27 = 3;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota REC 4
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 16810; #caenlace#9  = aAlfa; || Importe Cuota REC 4
                                #caenlace#26 = "R";   || Cuota IVA 4
                                #caenlace#27 = 4;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;

      || Grabo la Cuota REC 5
      |DDEFECTO #caenlace; |HAZ GrabaComun;
      |SI #caenlace#10 = "R";
         #caenlace#8 = "H";
      |SINO;
         #caenlace#8 = "D";
      |FINSI;
      aAlfa = aCadena2 % 17810; #caenlace#9  = aAlfa; || Importe Cuota REC 5
                                #caenlace#26 = "R";   || Cuota REC 5
                                #caenlace#27 = 5;
      |SI #caenlace#9 ! 0; |GRABA 020#caenlace.n; |FINSI;
      nSw = 0;
   |SINO;
      || Asiento
      aAlfa = aCadena1 % 0310;
      fFechaAsto = aAlfa;
      aAlfa = aCadena1 % 10001;                   || Repercutido/Soportado
      aCpto = aCadena1 % 5503;                   || Codigo concepto
      aAlfa = aCadena1 % 2903;                    || Grupo Cuenta DEBE

      |SI aAlfa = "600"; |Y aCpto = "003";
         aSopRep = "S";
         aTipo = "B"; aCuenta = aCadena1 % 2912; nNumero = 0;
         aAlfa = aCadena1 % 5301; nNivel = aAlfa;
         |BUCLE RellenaDatos;
         aAlfa = "600";
      |FINSI;
      |SI aAlfa = "472"; |Y aCpto = "003";
         aSopRep = "S";
         aTipo = "I"; aCuenta = aCadena1 % 2912; nNumero = 0;
         aAlfa = aCadena1 % 5301; nNivel = aAlfa;
         |BUCLE RellenaDatos;
         aAlfa = "472";
      |FINSI;

      nSwApunte = 0;
      |SI aAlfa ! "600"; |Y aAlfa ! "472"; |Y aAlfa ! "430"; |Y aAlfa ! "   ";
         nSwApunte = 1;
      |SINO;
         |SI aCpto ! "003";
            |SI aAlfa = "600"; |O aAlfa = "472"; nSwApunte = 1; |FINSI;
         |FINSI;
      |FINSI;

      |SI nSwApunte = 1;
         |SI nSw = 0; |O fFechaAnt ! fFechaAsto;
            |HAZ Contador; nSw = 1;
            nLinAsto = 1;
            fFechaAnt = fFechaAsto;
         |FINSI;

         |DDEFECTO #caenlace;
         aAlfa = aCadena1 % 0102;  #caenlace#0 = aAlfa; || Diario
         aAlfa = aCadena1 % 0310;  #caenlace#1 = aAlfa; || Fecha asiento
         #caenlace#2 = nNumDoc;  || Documento
         #caenlace#3 = nLinAsto; || Asiento
         nLinAsto = nLinAsto + 1;
         aAlfa = aCadena1 % 2912;  #caenlace#4 = aAlfa; || Cuenta
         aAlfa = aCadena1 % 5301;  #caenlace#5 = aAlfa; || Nivel
         aAlfa = aCadena1 % 5503;  #caenlace#6 = aAlfa; || Codigo Concepto
         aAlfa = aCadena1 % 5830;  #caenlace#7 = aAlfa; || Descripcion Concepto
                                   #caenlace#37 = #48#2;
                                   #caenlace#38 = #48#3;
                                   #caenlace#8 = "D";
         aAlfa = aCadena1 % 8910;  #caenlace#9  = aAlfa;|| Importe
         |GRABA 020#caenlace.n;
      |FINSI;

      aAlfa = aCadena1 % 4103;                    || Grupo Cuenta HABER
      |SI aAlfa = "700"; |Y aCpto = "002";
         aSopRep = "R";
         aTipo = "B"; aCuenta = aCadena1 % 4112; nNumero = 0;
         aAlfa = aCadena1 % 5401; nNivel = aAlfa;
         |BUCLE RellenaDatos;
         aAlfa = "700";
      |FINSI;
      |SI aAlfa = "477"; |Y aCpto = "002";
         aSopRep = "R";
         aTipo = "I"; aCuenta = aCadena1 % 4112; nNumero = 0;
         aAlfa = aCadena1 % 5401; nNivel = aAlfa;
         |BUCLE RellenaDatos;
         aAlfa = "477";
      |FINSI;

      nSwApunte = 0;
      |SI aAlfa ! "700"; |Y aAlfa ! "477"; |Y aAlfa ! "400"; |Y aAlfa ! "   ";
         nSwApunte = 1;
      |SINO;
         |SI aCpto ! "002";
            |SI aAlfa = "700"; |O aAlfa = "477"; nSwApunte = 1; |FINSI;
         |FINSI;
      |FINSI;

      |SI nSwApunte = 1;
         |SI nSw = 0; |O fFechaAnt ! fFechaAsto;
            |HAZ Contador; nSw = 1;
            nLinAsto = 1;
            fFechaAnt = fFechaAsto;
         |FINSI;

         |DDEFECTO #caenlace;
         aAlfa = aCadena1 % 0102;  #caenlace#0 = aAlfa; || Diario
         aAlfa = aCadena1 % 0310;  #caenlace#1 = aAlfa; || Fecha asiento
         #caenlace#2 = nNumDoc;  || Documento
         #caenlace#3 = nLinAsto; || Asiento
         nLinAsto = nLinAsto + 1;
         aAlfa = aCadena1 % 4112;  #caenlace#4 = aAlfa; || Cuenta
         aAlfa = aCadena1 % 5401;  #caenlace#5 = aAlfa; || Nivel
         aAlfa = aCadena1 % 5503;  #caenlace#6 = aAlfa; || Codigo Concepto
         aAlfa = aCadena1 % 5830;  #caenlace#7 = aAlfa; || Descripcion Concepto
                                   #caenlace#37 = #48#2;
                                   #caenlace#38 = #48#3;
                                   #caenlace#8 = "H";
         aAlfa = aCadena1 % 8910;  #caenlace#9  = aAlfa;|| Importe
         |GRABA 020#caenlace.n;
      |FINSI;
   |FINSI;

|FPRC;

|PROCESO Importacion;
   aAlfa = #caipcbox#1; |QBF aAlfa;
   aAlfa = aAlfa + #caipcbox#2; |QBF aAlfa;
   |XABRE "B", aAlfa, nHandle;
   |SI FSalida ] 0;
      nNumChar = 1;
      |PARA; |SI nNumChar > 0; |HACIENDO;
         |XLEE nHandle, 201, aCadena1;
         |XLEE nHandle, 241, aCadena2; nNumChar = FSalida;
         |SI nNumChar ] 239; |HAZ Interpreta; |FINSI;
      |SIGUE;
      |XCIERRA nHandle;
   |FINSI;
|FPRC;

|PROGRAMA;
   |ABRE #caipcbox;
   |LEE 000#caipcbox.p;
   |SI FSalida ! 0;
      |DDEFECTO #caipcbox;
      |GRABA 020#caipcbox.c;
   |FINSI;

   |CLS;
   |CABEZA "Importacion PC BOX";
   |PINPA #0#0; |PINDA #0#0;

   |ENDATOS #1#caipcbox;
   |SI FSalida = 0; |Y #0#3 = "S";
      |GRABA 020#caipcbox.a;

      aAlfa = "pu" + Usuario; |NOME_DAT #caenlace#aAlfa#;
      |DELINDEX #caenlace; |ABRE #caenlace;
      |HAZ Importacion;

      |DFICE aAlfa; |QBF aAlfa;
      aAlfa = "dsapunte.tab;" + aAlfa + ",pu" + Usuario;
      |SUB_EJECUTA aAlfa;

      |SI #caipcbox#4 = "S";
         |SI PRMNT_enError = 0;
            aAlfa = #caipcbox#1; |QBF aAlfa;
            aAlfa = aAlfa + #caipcbox#2; |QBF aAlfa;
            |FBORRA aAlfa;
         |SINO;
            aAlfa = "    Se han encontrado errores." + &191 + " Desea eliminar los ficheros origen del enlace ?";
            |CONFI aAlfa;
            |SI FSalida = 0;
               aAlfa = #caipcbox#1; |QBF aAlfa;
               aAlfa = aAlfa + #caipcbox#2; |QBF aAlfa;
               |FBORRA aAlfa;
            |FINSI;
         |FINSI;
      |FINSI;

      |CIERRA #caenlace;   |DELINDEX #caenlace;
   |FINSI;

   |CIERRA #caipcbox;
|FPRO;
