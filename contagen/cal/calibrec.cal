|FICHEROS;
   calibrec #0;
   calibros #1;

   :/modelos/def/dsmom035 #2;
   :/modelos/def/dsmom036 #7;

   camaniva #3;
   caivalin #4;
|FIN;

|INCLUYE dscont_i;

|VARIABLES;

   &SwCabFac = 0; &SwLinFac = 0; &SwTotFac = 0; &SwSToFac = 0; &SwTToFac = 0;
   &SwBlanco = 0; &fecinf = @; &fecha_i = 0;
   &regis = 0; &ContLin = 0; &varalf = ""; &Pagina = 0; SwPrint = 0; &SwPinta = 0;
   &TF  = 0; &TB  = 0; &TI  = 0; &TR  = 0; &TD  = 0;
   &TLF = 0; &TLB = 0; &TLI = 0; &TLR = 0; &TLD = 0;


   SwHayDatos = 0;
   modo   = 0; DiasFecha = 0;
   campo  = 0;
   men1   = "    No existe empresa";
   men2   = "    NO existe el grupo de conceptos";
   mensa1 = "    ESTA FECHA NO CORRESPONDE CON EL EJERCICIO";
   alfa1  = "";

   Comodin = ""; TipoLibro = ""; Serie = ""; Factura = 0;
   SwError = 0;  Primero = 0; FechaTrab = @;

   Cont = 0; Cont1 = 0; Calc = 0;

   NumLineas = 68; NumRegis = 0;
   fDFecha    = @;
|FIN;

|PROCESO cheq_libro; |TIPO 0;
   |SI #calibros#2 ! "S";
      |MENAV "    ATENCION!!! Libro de I.V.A. Repercutido ...";
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO lee_libro1;
   |ERROR10;
|FPRC;

|DEFBUCLE lee_libro;
   #calibros#1;
   2;
   1, "S";
   99, "S";
   e;
   NULL, lee_libro1;
|FIN;

|PROCESO deflib; |TIPO 7;
   |SI modo ! 0; |ACABA; |FINSI;
   |DDEFECTO #calibros;
   |BUCLE lee_libro;
   #calibrec#0 = #calibros#0;
   |PINTA #calibrec#0;
|FPRC;

|PROCESO selecci2; |TIPO 0;
   |SI #calibrec#42 = "N";
      |CAMPO_MODIFICA #calibrec#11, 1, "S";
      |CAMPO_MODIFICA #calibrec#43, 1, "N";
      |CAMPO_MODIFICA #calibrec#44, 1, "N";
      |CAMPO_MODIFICA #calibrec#45, 1, "N";
      |CAMPO_MODIFICA #calibrec#46, 1, "N";
      #calibrec#43 = 0;      |PINTA #calibrec#43;
      #calibrec#44 = 0;      |PINTA #calibrec#44;
      #calibrec#45 = 0;      |PINTA #calibrec#45;
      #calibrec#46 = 0;      |PINTA #calibrec#46;
   |SINO;
      |CAMPO_MODIFICA #calibrec#11, 1, "N";
      |CAMPO_MODIFICA #calibrec#43, 1, "S";
      |CAMPO_MODIFICA #calibrec#44, 1, "S";
      |CAMPO_MODIFICA #calibrec#45, 1, "S";
      |CAMPO_MODIFICA #calibrec#46, 1, "S";
      #calibrec#11 = "N";    |PINTA #calibrec#11;
   |FINSI;
|FPRC;

|PROCESO paso; |TIPO 0;
   |SI FSalida = 1;
      |ERROR;
      |PTEC 815;
   |FINSI;
|FPRC;

|PROCESO fechad;
   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   |SI #calibrec#Campo# < fDFecha; |O #calibrec#Campo# > fec2;
      |MENAV mensa1;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO fechah;
   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   campo = Campo - 1;
   |SI #calibrec#Campo# < fDFecha; |O #calibrec#Campo# > fec2; |O #calibrec#Campo# < #calibrec#campo#;
      |MENAV mensa1;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO no_entres;
   alfa1 = #calibrec#11;
   |PARA campo = 12;  |SI campo [ 35;  |HACIENDO campo = campo + 1;
      |CAMPO_MODIFICA #calibrec#campo#, 1, alfa1;
   |SIGUE;
   |SI alfa1 = "N";
      |PDEFECTO #0,12,36;
      |PINDA #0#0;
   |FINSI;
|FPRC;

|PROCESO nopidas;
   |SI #calibrec#Campo# ! 0;  |ACABA;  |FINSI;
   alfa1 = "N";
   |PARA campo = Campo + 1;  |SI campo [ 35;  |HACIENDO campo = campo + 1;
      |CAMPO_MODIFICA #calibrec#campo#, 1, alfa1;
      #calibrec#campo# = 0;
   |SIGUE;
   |SI Campo = 35;  |PINDA #0#0;  |FINSI;
|FPRC;

|PROCESO sacaimpo;

   |CAMPO_MODIFICA #calibrec#38 ,1, "N"; |CAMPO_MODIFICA #calibrec#39 ,1, "N";
   |CAMPO_MODIFICA #calibrec#41 ,1, "N"; |CAMPO_MODIFICA #calibrec#57 ,1, "N";
   |CAMPO_MODIFICA #calibrec#59 ,1, "N"; |CAMPO_MODIFICA #calibrec#53 ,1, "N";
   |CAMPO_MODIFICA #calibrec#54 ,1, "N"; |CAMPO_MODIFICA #calibrec#56 ,1, "N";
   |CAMPO_MODIFICA #calibrec#58 ,1, "N"; |CAMPO_MODIFICA #calibrec#60 ,1, "N";

   |SI #calibrec#37 = "S";
         |CAMPO_MODIFICA #calibrec#38, 1, "N"; #calibrec#38 = 0;    |PINTA #calibrec#38;
         |CAMPO_MODIFICA #calibrec#39, 1, "N"; #calibrec#39 = 0;    |PINTA #calibrec#39;
         |CAMPO_MODIFICA #calibrec#59, 1, "N"; #calibrec#59 = 0;    |PINTA #calibrec#59;
         #calibrec#40 = 0;    |PINTA #calibrec#40;
         |CAMPO_MODIFICA #calibrec#41, 1, "N"; #calibrec#41 = #calibrec#7; |PINTA #calibrec#41;
         |CAMPO_MODIFICA #calibrec#57, 1, "N"; #calibrec#57 = "";          |PINTA #calibrec#57;
         |CAMPO_MODIFICA #calibrec#53, 1, "N"; #calibrec#53 = 0;     |PINTA #calibrec#53;
         |CAMPO_MODIFICA #calibrec#54, 1, "N"; #calibrec#54 = 0;     |PINTA #calibrec#54;
         |CAMPO_MODIFICA #calibrec#60, 1, "N"; #calibrec#60 = 0;     |PINTA #calibrec#60;
         #calibrec#55 = 0;     |PINTA #calibrec#55;
         |CAMPO_MODIFICA #calibrec#56, 1, "N"; #calibrec#56 = #calibrec#52; |PINTA #calibrec#56;
         |CAMPO_MODIFICA #calibrec#58, 1, "N"; #calibrec#58 = "     ";      |PINTA #calibrec#58;
   |SINO;
      |SI #calibrec#49 ! "I";
         |CAMPO_MODIFICA #calibrec#38 ,1, "S";
         |CAMPO_MODIFICA #calibrec#39 ,1, "S";
         |CAMPO_MODIFICA #calibrec#41 ,1, "S";
         |CAMPO_MODIFICA #calibrec#57 ,1, "S";
         |CAMPO_MODIFICA #calibrec#59 ,1, "S";
      |FINSI;
      |SI #calibrec#49 ! "S";
         |CAMPO_MODIFICA #calibrec#53 ,1, "S";
         |CAMPO_MODIFICA #calibrec#54 ,1, "S";
         |CAMPO_MODIFICA #calibrec#56 ,1, "S";
         |CAMPO_MODIFICA #calibrec#58 ,1, "S";
         |CAMPO_MODIFICA #calibrec#60 ,1, "S";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO sumaimpo;
   #calibrec#40 = #calibrec#38 + #calibrec#39 + #calibrec#59;
   |PINTA #calibrec#40;
|FPRC;

|PROCESO sumaimpo2;
   #calibrec#55 = #calibrec#53 + #calibrec#54 + #calibrec#60;
   |PINTA #calibrec#55;
|FPRC;

|PROCESO leegrupo; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI #calibrec#Campo# = 0; |ACABA; |FINSI;
   |ABRE #dsmom035;
   #dsmom035#0 = #calibrec#Campo#;
   |LEE 001#dsmom035.=;
   salidas = FSalida;
   |CIERRA #dsmom035;
   |SI salidas ! 0;
      |MENAV men2;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO cuadro; |TIPO 7;
   |PUSHV  1521 2380;
   |CUADRO 1521 2380;
   |ATRI R;
   |PINTA 1622, " --------- FORMATO LIBRO FACTURAS RECIBIDAS ------------- ";
   |PINTA 1722, " ( 1) Descr. Fra., Nombre proveedor, varias lineas        ";
   |PINTA 1822, " ( 2) Nombre y NIF proveedor, una linea                   ";
   |PINTA 1922, " ( 3) Descr. Fra., Nombre proveedor, una linea            ";
   |PINTA 2022, " ( 4) Nombre y NIF proveedor, una linea s/recargo         ";
   |PINTA 2122, " ( 5) Descr. Fra., Nombre proveedor, una linea s/recargo  ";
   |PINTA 2222, " ( 6) Descr. Fra., Nombre proveedor, apaisado, s/recargo  ";
   |ATRI r;
|FPRC;

|PROCESO repon; |TIPO 0;
   |POPV;
|FPRC;

|PROCESO GrupoConcep;
   SwError = 1;
   |ABRE #dsmom036;
   |PARA Cont = 43; |SI Cont [ 46; |HACIENDO Cont = Cont + 1;
         |SI #calibrec#Cont# ! 0;
             #dsmom036#0 = #calibrec#Cont#;
             #dsmom036#1 = #camaniva#27;
             |LEE 010#dsmom036.=;
             |SI FSalida = 0;
                 SwError = 0;
                 |SAL;
             |FINSI;
         |FINSI;
   |SIGUE;
   |CIERRA #dsmom036;
|FPRC;

|PROCESO Conceptos;
   |SI #calibrec#42 = "S";
      |HAZ GrupoConcep;
      |SI SwError = 1; |ACABA; |FINSI;
   |SINO;
      |SI #calibrec#11 = "S";
         SwError = 1;
         |PARA Cont = 12; |SI Cont [ 35; |HACIENDO Cont = Cont + 1;
            |SI #camaniva#27 = #calibrec#Cont#; SwError = 0; |SAL; |FINSI;
         |SIGUE;
         |SI SwError = 1; |ACABA; |FINSI;
      |SINO;
         SwError = 0;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO LineasFactura;

   |SI #caivalin#17 = "S"; |Y TipoLibro = "S"; |ACABA; |FINSI;
   |SI #caivalin#17 = "N"; |Y TipoLibro = "I"; |ACABA; |FINSI;

   Calc = ContLin + 3;
   |SI Calc ] NumLineas;
      SwTotFac = 1;
      |SI #calibrec#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
      SwTotFac = 0;
      |HAZ VeteFinal;
      Pagina = Pagina + 1;
      SwCabFac = 1;
      |SI #calibrec#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
      SwCabFac = 0;
   |FINSI;

   SwLinFac = 1;
   |SI SwPrint = 0; |PRINT; ContLin = ContLin + 1; |FINSI;
   SwLinFac = 0;
   TB  = TB  + #caivalin#6;  TLB = TLB + #caivalin#6;
   TI  = TI  + #caivalin#8;  TLI = TLI + #caivalin#8;
   TR  = TR  + #caivalin#10; TLR = TLR + #caivalin#10;
   TD  = TD  + #caivalin#11; TLD = TLD + #caivalin#11;
   TF  = TF  + (#caivalin#6 + #caivalin#8 + #caivalin#10 - #caivalin#11);
   TLF = TLF + (#caivalin#6 + #caivalin#8 + #caivalin#10 - #caivalin#11);

   |SI #caivalin#17 = "N";
      |SI TipoLibro = "S";
         #calibrec#38 = TLB;
         #calibrec#39 = TLI;
         #calibrec#59 = TLR;
         #calibrec#40 = TLF;
      |FINSI;
   |SINO;
      |SI TipoLibro = "I";
         #calibrec#53 = TLB;
         #calibrec#54 = TLI;
         #calibrec#60 = TLR;
         #calibrec#55 = TLF;
      |FINSI;
   |FINSI;
   SwPinta = 0;

   ||SI #calibrec#47 ! 1; ContLin = ContLin - 4; |FINSI;
|FPRC;

|DEFBUCLE LineasFactura;
#caivalin#1;
;
#camaniva#0,#camaniva#1,01;
#camaniva#0,#camaniva#1,99;
;
NULL,LineasFactura;
|FIN;

|PROCESO Facturas;
   |HAZ Conceptos;
   |SI SwError = 1; |ACABA; |FINSI;

   |SI #camaniva#35 = "I"; |Y TipoLibro = "S"; |ACABA; |FINSI;
   |SI #camaniva#35 = "N"; |Y TipoLibro = "I"; |ACABA; |FINSI;

   |SI #calibrec#10 = 1; |O #calibrec#10 = 3;
      fecha_i = #camaniva#4;
   |SINO;
      fecha_i = #camaniva#8;
   |FINSI;

   |SI TipoLibro = "S";
      NumRegis = #calibrec#7;
   |SINO;
      NumRegis = #calibrec#52;
   |FINSI;

   |SI NumRegis ! 0;
      regis = regis + 1;
   |SINO;
      regis = #camaniva#3;
   |FINSI;

   |SI #calibrec#37 = "S";
      Calc = ContLin + 5;
      |SI Calc ] NumLineas;
         |HAZ VeteFinal;
         Pagina = Pagina + 1;
      |FINSI;

      |SI fecha_i < #calibrec#3;
         SwPrint = 1;
      |SINO;
         SwPrint = 0;
      |FINSI;

      |SI fecha_i > #calibrec#4; |ACABA; |FINSI;

   |SINO;
      |SI TipoLibro = "S";
         Serie = #calibrec#57; Factura = #calibrec#41;
      |SINO;
         Serie = #calibrec#58; Factura = #calibrec#56;
      |FINSI;

      |SI #camaniva#2 < Serie;
         |ACABA;
      |SINO;
         |SI #camaniva#3 < Factura;
            |ACABA;
         |SINO;
            Calc = ContLin + 5;
            |SI Calc ] NumLineas;
               |HAZ VeteFinal;
               Pagina = Pagina + 1;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   SwHayDatos = 1;
   SwCabFac = 1;
   |SI #calibrec#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
   SwCabFac = 0; SwPinta = 1;
   TF = 0; TB = 0; TI = 0; TR = 0; TD = 0;
   |BUCLE LineasFactura;
   SwTotFac = 1;
   |SI #calibrec#47 = 1; |SI SwPrint = 0; |PRINT; ContLin= ContLin + 2; |FINSI; |FINSI;
   SwTotFac = 0;
|FPRC;

|DEFBUCLE Facturas1;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#4;
|FIN;

|DEFBUCLE Facturas2;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#8;
|FIN;

|DEFBUCLE Facturas3;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#2,#camaniva#3,#camaniva#4;
|FIN;

|DEFBUCLE Facturas4;
#camaniva#1;
;
#calibros#0,0000000001;
#calibros#0,9999999999;
;
NULL,NULL,NULL,NULL,NULL,Facturas;
#camaniva#2,#camaniva#3,#camaniva#8;
|FIN;

|PROCESO Libros;
   |SI #calibrec#49 = "S"; |O #calibrec#49 = "D";
      SwHayDatos = 0;
      TipoLibro = "S";
      varalf = #calibrec#1;
      Pagina = #calibrec#6 + 1;
      |SI #calibrec#37 = "N";
         TLF = #calibrec#40; TLB = #calibrec#38; TLI = #calibrec#39; TLR = #calibrec#59;
      |FINSI;
      |SI #calibrec#10 = 1; |BUCLE Facturas1; |FINSI;
      |SI #calibrec#10 = 2; |BUCLE Facturas2; |FINSI;
      |SI #calibrec#10 = 3; |BUCLE Facturas3; |FINSI;
      |SI #calibrec#10 = 4; |BUCLE Facturas4; |FINSI;
      |SI SwHayDatos = 1;
         SwTToFac = 1; |PRINT; SwTToFac = 0;
         |HAZ VeteFinal;
      |FINSI;
      TF  = 0; TB  = 0; TI  = 0; TR  = 0; TD  = 0;
      TLF = 0; TLB = 0; TLI = 0; TLR = 0; TLD = 0;
   |FINSI;
   |SI #calibrec#49 = "I"; |O #calibrec#49 = "D";
      SwHayDatos = 0;
      TipoLibro = "I";
      varalf = #calibrec#50;
      Pagina = #calibrec#51 + 1;
      |SI #calibrec#37 = "N";
         TLF = #calibrec#55; TLB = #calibrec#53; TLI = #calibrec#54; TLR = #calibrec#60;
      |FINSI;
      |SI #calibrec#10 = 1; |BUCLE Facturas1; |FINSI;
      |SI #calibrec#10 = 2; |BUCLE Facturas2; |FINSI;
      |SI #calibrec#10 = 3; |BUCLE Facturas3; |FINSI;
      |SI #calibrec#10 = 4; |BUCLE Facturas4; |FINSI;
      |SI SwHayDatos = 1;
         SwTToFac = 1; |PRINT; SwTToFac = 0;
         |HAZ VeteFinal;
      |FINSI;
   |FINSI;

|FPRC;

|DEFBUCLE Libros;
#calibros#1;
2;
#calibrec#0 ,"S";
#calibrec#48,"S";
;
NULL,Libros;
|FIN;

|PROCESO VeteFinal;
   SwBlanco = 1;
   |PARA; |SI ContLin < NumLineas; |HACIENDO ContLin = ContLin + 1;
      |SI SwPrint = 0; |PRINT; |FINSI;
   |SIGUE;
   |SI SwPrint = 0; |PIEINF; |FINSI;
   SwBlanco = 0;
   |SI TLF ! 0; ContLin = 10; |SINO; ContLin = 9; |FINSI;
|FPRC;

|PROGRAMA;
   |HAZ inicio;
   |HAZ eParaModelos;

   |CLS;
   |CABEZA "Libro de facturas emitidas";
   |ABRE #calibrec;
   |LEE 010#calibrec.p;
   |SI FSalida ! 0;
      |DDEFECTO #calibrec;
      #calibrec#3 = fec1;
      #calibrec#4 = fec2;
      |GRABA 020#calibrec.n;
      |LEE 010#calibrec.p;
   |FINSI;
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      ContLin = 9;
      regis = #calibrec#7; |SI regis ! 0; regis = regis - 1; |FINSI;
      |IMPRE 0;
      |SI FSalida < 0; |ACABA; |FINSI;
      |SI #calibrec#47 = 1; |INFOR "calibem1"; |FINSI;
      |SI #calibrec#47 = 2; |INFOR "calibem2"; |FINSI;
      |SI #calibrec#47 = 3; |INFOR "calibem3"; |FINSI;
      |SI #calibrec#47 = 4; |INFOR "calibem4"; |FINSI;
      |SI #calibrec#47 = 5; |INFOR "calibem5"; |FINSI;
      |SI FSalida ] 0;
         fecinf = #calibrec#5;
         |BUCLE Libros;
         |FININF;
      |FINSI;
      |FINIMP;
      DiasFecha = #calibrec#4;
      |SI #calibrec#4 ! fec2; DiasFecha = DiasFecha + 1; |FINSI;
      #calibrec#3 = DiasFecha;
      #calibrec#4 = fec2;
      |GRABA 020#calibrec.a;
   |FINSI;
   |CIERRA #calibrec;
|FPRO;
