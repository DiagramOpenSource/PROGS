|FICHEROS;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aLinea = "";
     nLinea = 0;
     aValor = "";
     aCampo = "";
     &aArchivo = "";
     aArchivoPDF = "";
     aArchivoFDF = "";
     aPathLocPDF = "";
     aPathSerPDF = "";
     aPathLocFDF = "";
     aPathSerFDF = "";
     aPathReader = "";
     aPathDestino = "";
     &aID = "";
     aOrigen = "";
     aDestino = "";
     nCanal = 0;
     aSystem = "";
     aDirBase = "";
     aLongitud = "";
     nLongitud = "";
     aCaracter = "";
     aCaracterSal = "";
     aCadena = "";
     aCadenaSal = "";
     nPos = 0;
     nBusca = 0;
     nAscii = 0;

     &enWeb = 0;
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     &eaWebDirPDF = "";
     nTipo = 0;
     aIP = "";
     &swCopia = 0;
     &aProcedencia = "";
     &aListaFich = "";
     &aListaFichNor = "";
     &aListaFichCop = "";
     &aListaImpares = "";
     &swDondeEstoy = 0;
     aUsuario = "";
     &nTipoSalida = 0;
     &nTipoImpre = 0;
     &nNroCopias = 0;
     aParametros = "";
     i = 0;
     aFicheroBAT = "";
     &aVengoDe = "";
     aMiCaracter = "";
     nCaracter = 0;
     nPorDonde = 0;
     aEjecutable = "";
     aUnidad = "";
     aMatador = "";
     aElUltimo = "";
     aElUltimo2 = "";
     &swPDFMasivo = 0;
     &nContador = 0;
     j = 0;
     aOrigenS = "";
     aDestinoS = "";
     aRetardo = "";
     nPosicion = 0;
     aPosicion = "";
     aListaTmp = "";
     &eaDSMAC = "";
     &swAvisado = 0;
     {1}aContiene = "";
     aBusca = "";
     aCambia = "";
     {1}aRutaLocal = "";
     aLocal = "";
     aServidor = "";
     &enEmp = 0;
     &enTra = 0;
     nNume = 0;
     aFicheroUni = "";

     aRuta = "";
     aRutaSal = "";
     aLon = "";
     nLon = 0;
     nPunt = 0;
     aUnion = "";
     aCarpetaCont = "";
     aRutaOriCont = "";
     aRutaDesCont = "";
     FEstado = 0;
     &nNroProrr = 0;

     &nArchi = 0;
     &eaVengoDe = "";
     swSigue = 0;
     nHandle = 0;
     &enSwDesde9 = 0;
     &enSwMeteGrupoSubTipo = 0;
     &enSwErrorRecDoc = 0;
     &eaOrig = "";
     &eaObservaciones = "";
     &eaFechaAlta = "";
     &enMes = 0;
     &enAny = 0;
     &swEsProrroga = 0;
     &enSwSoloArchivo = 0;
     nDoc = 0;
     aDoc = "";
     aDocFDF = "";
     nCopia = 0;
     nCopias = 0;
     &swImpMasiva = 0;
     &aRutaExt    = "";
     &aFichExt    = "";
     &enArchivar  = 0;
     &eaTipoImpresion = "";
     &eaUsaGADSiExiste = "";
     aFich = "";
     &swETT = 0;

     aDocRemoto = "";
     aDocServidor = "";
     aNif = "";
     aFirma = "";
     aLista = "";
     aListaPDFs = "";
     aLanza = "";
     aDestinoFirma = "";
     nPagina = 0;
     aPagina = "";
     nTotalDocs = 0;
     aAlfa4 = "";
     aExtension = "";
|FIN;

|PROCESO control;
     |ABRE #nomcontr;
     |LEE 000#nomcontr.p;
     |SI FSalida = 0;
          aRetardo = #nomcontr#36;
     |FINSI;
     |CIERRA #nomcontr;

     |ABRE #labcontr;
     |LEE 000#labcontr.p;
     |CIERRA #labcontr;

     |SI swImpMasiva = 1;
          #labcontr#79 = 1;
          |SI eaTipoImpresion = "C";
               #labcontr#37 = 0;
          |FINSI;
          |SI eaTipoImpresion = "B";
               #labcontr#81 = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO sustituye;
     || aCadena es la cadena a buscar un caracter
     || aBusca es el caracter a buscar
     || aCambia es por el que lo queremos cambiar

     aCadenaSal = "";
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nBusca = (nPos * 100) + 1;
          aCaracter = aCadena % nBusca;
          |SI aCaracter = aBusca;
               aCadenaSal = aCadenaSal + aCambia;
          |SINO;
               aCadenaSal = aCadenaSal + aCaracter;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CargaInicial;
     |DBASE aDirBase;
     aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)
     aPathLocFDF = "C:\ds\spoolpdf\";  || aqui va la plantilla y el FDF local
     aPathSerPDF = aDirBase + "pdf/";  || aqui van todas las plantillas PDF
     aPathSerFDF = aDirBase + "fich/"; || aqui va el FDF en el servidor

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aPathDestino = aContiene1;
     |QBF aPathDestino;
     aPathDestino = aPathDestino + "spoolpdf/";
     |RMKDIR aPathDestino;       || lo creo primero de nada, por si no hubiera

     aPathLocFDF = aPathDestino;  || aqui va la plantilla y el FDF local
     || aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)

     aCadena = aPathDestino;
     aBusca = "\";
     aCambia = "/";
     |HAZ sustituye;
     aCadena = aCadenaSal;
     aBusca = ":";
     aCambia = "";
     |HAZ sustituye;
     aPathLocPDF = aCadenaSal;
     aPathLocPDF = "/" + aPathLocPDF;

     |SI #labcontr#65 = 0;    || como siempre
          aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)
          aPathLocFDF = "C:\ds\spoolpdf\";  || aqui va la plantilla y el FDF local
     |FINSI;
|FPRC;

|PROCESO BuscaMata;          || ME TRAIGO EL mata.exe DEL SERVIDOR A LOCAL
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "pdf/mata.exe";
     aDestino = "C:\ds\spoolpdf\mata.exe";
     |QBF aOrigen;
     |QBF aDestino;
     ||XABRE "CE", aDestino, nCanal;
     ||SI FSalida < 0;         || FSalida = 0: no existe el mata.exe en C:\ds\spoolpdf
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     ||FINSI;
     aMatador = aDestino;
     ||XCIERRA nCanal;
|FPRC;

|PROCESO BuscaWait;          || ME TRAIGO EL mata.exe DEL SERVIDOR A LOCAL
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "pdf/wait.exe";
     aDestino = aPathDestino + "wait.exe";
     |QBF aOrigen;
     |QBF aDestino;
     ||XABRE "CE", aDestino, nCanal;
     ||SI FSalida < 0;         || FSalida = 0: no existe el mata.exe en C:\ds\spoolpdf
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     ||FINSI;
     ||XCIERRA nCanal;
|FPRC;

|PROCESO BuscaFirmador;
     || primero me traigo la dll

     swSigue = 0;

     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "ejecutables/debenupdflibrarylite1114.dll";
     aDestino = aPathDestino - "spoolpdf/" + "bin/" + "debenupdflibrarylite1114.dll";
     |QBF aOrigen;
     |QBF aDestino;
     |XABRE "CE", aDestino, nCanal;
     |SI FSalida < 0;         || FSalida < 0: no existe la dll
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
               swSigue = swSigue + 1;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
               swSigue = swSigue + 1;
          |FINSI;
     |FINSI;
     |XCIERRA nCanal;

     || ahora me traigo el exe para registrar la dll

     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "ejecutables/dsregsvr32.exe";
     aDestino = aPathDestino - "spoolpdf/" + "bin/" + "dsregsvr32.exe";
     |QBF aOrigen;
     |QBF aDestino;
     |XABRE "CE", aDestino, nCanal;
     |SI FSalida < 0;
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
               swSigue = swSigue + 1;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
               swSigue = swSigue + 1;
          |FINSI;
     |FINSI;
     |XCIERRA nCanal;

     || ahora a registrar la dll

     |SI swSigue = 2;
          |DBASE aOrigen;
          aOrigen = aDirBase + "ejecutables/debenupdflibrarylite1114.dll";
          aAlfa1 = aPathDestino - "spoolpdf/" + "bin/" + "dsregsvr32.exe";
          aAlfa2 = aPathDestino - "spoolpdf/" + "bin/" + "debenupdflibrarylite1114.dll";
          aAlfa = aAlfa1 + " " + aAlfa2;
          |RSYSTEM aAlfa;
     |FINSI;

     || por ultimo me traigo el firmador, si no existe o ha cambiado

     |DBASE aOrigen;
     aOrigen = aDirBase + "ejecutables/dspdfimage.exe";
     aDestino = aPathDestino + "dspdfimage.exe";

     |XABRE "CE", aDestino, nCanal;
     |SI FSalida < 0;
          || no existe

          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |SINO;
          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aDocRemoto = FSalida;  |QBF aDocRemoto;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aDocServidor = FSalida;  |QBF aDocServidor;

          |SI aDocRemoto ! aDocServidor; |O aDocRemoto = "";
               |RFBORRA aDestino;
               |SI aIP ! "";
                    |ENVIA_FICHERO aOrigen, aDestino;
               |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
               |FINSI;
          |FINSI;
     |FINSI;

     |XCIERRA nCanal;

     || aprovecho y me traigo aqui mismo el dsmini

     |DBASE aOrigen;
     aOrigen = aDirBase + "ejecutables/dsmini.exe";
     aDestino = aPathDestino + "dsmini.exe";

     |SI aIP ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO BuscaRuta;
     |HAZ CogeMac;

     aIP = "";  |IP_REMOTO aIP;  |QBF aIP;

     |ABRE #pdfcontr;
     #pdfcontr#0 = eaDSMAC;
     |LEE 000#pdfcontr.=;
     |SI FSalida ! 0;
         #pdfcontr#0 = aIP;
         |LEE 000#pdfcontr.=;
         |SI FSalida = 0;
             #pdfcontr#0 = eaDSMAC;
             |GRABA 020#pdfcontr.n;
             |LIBERA #pdfcontr;
         |SINO;
             |DDEFECTO #pdfcontr;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaCaracter;
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nCaracter = ((nPos * 100) + 1) * nPorDonde;
          aCaracter = aCadena % nCaracter;
          |SI aCaracter = aMiCaracter;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO imprime_nomina;
     aParametros = " /h /p";         || Impresora por defecto
     || aDestino = "start " + aEjecutable + aParametros + aListaFich;
     aDestino = aEjecutable + aParametros + aListaFich;
     aFicheroBAT = aPathLocFDF + Usuario + ".bat";
     |XABRE "CBW", aFicheroBAT, nCanal;
     |SI FSalida ] 0;
          aAlfa = "@echo off" + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aUnidad = aPathReader % 102;
          aAlfa = aUnidad + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aAlfa = "cd " + &34 + aPathReader + &34 + &13 + &10;
          aAlfa = aAlfa - aUnidad;
          |XGRABA nCanal, aAlfa;
          |PARA i = 1; |SI i [ nContador; |HACIENDO i = i + 1;
               |PARA j = 1; |SI j [ nNroCopias; |HACIENDO j = j + 1;
                    aAlfa = i; aAlfa = "000" + aAlfa; aAlfa = aAlfa % -103;
                    aAlfa = "a" + aAlfa + ".fdf";
                    aUsuario = Usuario;
                    || aAlfa = " " + &34 + "C:\ds\spoolpdf\" + Usuario + "\" + aAlfa + &34;
                    aAlfa = " " + &34 + aPathLocFDF + Usuario + "\" + aAlfa + &34;
                    aAlfa = "wait -" + aRetardo + " " + aEjecutable + aParametros + aAlfa;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nCanal, aAlfa;
               |SIGUE;
          |SIGUE;
     |FINSI;
     |XCIERRA nCanal;
|FPRC;

|PROCESO ArchivaContrato;
     |SI #labcontr#82 = "N"; |ACABA; |FINSI;

     nArchi = 0;
     |HAZ MiraSiArchiva;

     |SI nArchi ! 1;
         |ACABA;
     |FINSI;

     swSigue = 1;

     aRutaDesCont = aRutaDesCont - "start ";
     aAlfa = aRutaDesCont;

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     |SI swSigue = 0;
          |SI swEsProrroga = 1;
               aAlfa = " la prórroga ";
          |SINO;
               aAlfa = " el contrato de trabajo ";
          |FINSI;

          aAlfa = "    No se ha encontrado" + aAlfa + "para archivar";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     aAlfa = eaFechaAlta;
     aAlfa = aAlfa % 402;
     enMes = aAlfa;
     aAlfa = eaFechaAlta;
     aAlfa = aAlfa % -104;
     enAny = aAlfa;

     || aqui le tengo que poner el nombre de los archivos para enviar uno y
     || despues el otro

     eaOrig = aRutaDesCont;
     |SI swEsProrroga = 1;
          eaObservaciones = "Prórroga";
     |SINO;
          eaObservaciones = "Contrato de trabajo";
     |FINSI;

     |SI eaUsaGADSiExiste ! "N";
          |HAZ Archivando;

          || AQUIIIIIIIIIIIIIIIIIIII
          aAlfa = ":dsarchi/dpntz001;CLI";
          |SUB_EJECUTA aAlfa;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
     |FINSI;
|FPRC;

|PROCESO ArchivaCertificado;
     swSigue = 1;

     aAlfa = aPathLocFDF + aFicheroUni;

     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida < 0;
          swSigue = 0;
     |FINSI;
     |XCIERRA nHandle;

     |SI swSigue = 0;
         aAlfa = " el certificado ";

         aAlfa = "    No se ha encontrado" + aAlfa + "para archivar";
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     eaOrig = aPathLocFDF + aFicheroUni;
     eaObservaciones = "Certificado de empresa";

     |HAZ Archivando;

     aAlfa = "    El certificado de empresa se ha archivado en ";
     aAlfa = aAlfa + "la Gestión del Archivo Documental (GAD).";
     |MENAV aAlfa;

     aAlfa = ":dsarchi/dpntz001;CLI";
     |SUB_EJECUTA aAlfa;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO DSArchi;
/*
     |SI swImpMasiva = 1;
          |ACABA;
     |FINSI;
*/
     |SI eaVengoDe = "contrato";  |HAZ ArchivaContrato;     |FINSI;
     |SI eaVengoDe = "labcerti";  |HAZ ArchivaCertificado;  |FINSI;
|FPRC;

|PROCESO TraeProgramas;
     |ESPECIFICA "RBASS", aRutaLocal;
     |QBF aRutaLocal1;

     aAlfa = aRutaLocal1 + "spoolpdf\dsarchi\";
     |RMKDIR aAlfa;      || por si no existiera

     aLocal = aAlfa;

     aIP = "";
     |IP_REMOTO aIP;  |QBT aIP;

     |DBASS aOrigen; |QBF aOrigen;      || busco patrones
     aServidor = aOrigen;

     aOrigen = aServidor + "laboral/ejecutables/dsfdf.exe";
     aDestino = aLocal + "dsfdf.exe";

     |SI aIP ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aOrigen = aServidor + "laboral/ejecutables/libiconv2.dll";
     aDestino = aLocal + "libiconv2.dll";

     |SI aIP ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aOrigen = aServidor + "laboral/ejecutables/pdftk.exe";
     aDestino = aLocal + "pdftk.exe";

     |SI aIP ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO Borrador;
     |R_PDIR aAlfa;
     |SI FSalida = 0;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aAlfa1 = aAlfa;

               aAlfa2 = aAlfa1 % -105;
               |SI aAlfa2 = "u.pdf"; |Y swImpMasiva = 1;
                    || no me borres
               |SINO;
                    |RFBORRA aAlfa1;
               |FINSI;

               |R_SDIR aAlfa;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO CompRuta;
     aRutaSal = "";
     |QBF aRuta;
     aLon = aRuta % 0;
     nLon = aLon;
     |PARA nPunt = 1; |SI nPunt [ nLon; |HACIENDO nPunt = nPunt + 1;
          nPos = (nPunt * 100) + 1;
          aCaracter = aRuta % nPos;
          |SI aCaracter = "/";
               aRutaSal = aRutaSal + "\";
          |SINO;
               aRutaSal = aRutaSal + aCaracter;
          |FINSI;
     |SIGUE;
     aRuta = aRutaSal;
|FPRC;

|PROCESO Renombra;
     aListaTmp = aListaTmp - " ";
     aPosicion = FSalida;
     |SI FSalida ! 0;
          aPosicion = ("0000" + aPosicion) % -104;
          aPosicion = aPosicion % 102;
          nPosicion = aPosicion;
          nPosicion = nPosicion - 1;
          nPosicion = nPosicion + 100;
          aAlfa = aListaTmp % nPosicion;
     |SINO;
          aAlfa = aListaTmp;
     |FINSI;

     aDocFDF = aAlfa;    || me hara falta despues para lo de los impares

     aAlfa = aAlfa - &34 - &34;

     aAlfa1 = aPathLocFDF + "contrato_" + aAlfa;
     aAlfa1 = aAlfa1 - ".fdf" + ".pdf";
     aAlfa2 = aAlfa - "a";
     nDoc = nDoc + 1;
     aDoc = nDoc;
     |QBF aDoc;
     aDoc = ("000" + aDoc) % -103;
     aAlfa2 = aPathLocFDF + "contrato_b" + aDoc + ".pdf";
     |RCOPIA_FICHERO aAlfa1, aAlfa2;

     aListaTmp = aListaTmp - &34 - aAlfa - &34;

     |QBF aListaTmp;

     aAlfa3 = aListaImpares - aDocFDF;
     |SI aAlfa3 ! aListaImpares;
          aAlfa1 = aPathLocFDF + "no.pdf";
          aAlfa2 = aPathLocFDF + "contrato_b" + aDoc + ".pdf";
          aAlfa2 = aAlfa2 - ".pdf" + "w" + ".pdf";
          |RCOPIA_FICHERO aAlfa1, aAlfa2;
     |FINSI;
|FPRC;

|PROCESO Ordena;
     nDoc = 0;

     || Copia "normal"

     nCopias = #labcontr#81;

     |PARA nCopia = 1; |SI nCopia [ nCopias; |HACIENDO nCopia = nCopia + 1;
          aListaTmp = aListaFichNor;
          |QBF aListaTmp;
          |PARA; |SI aListaTmp ! ""; |HACIENDO;
               |HAZ Renombra;
          |SIGUE;
     |SIGUE;

     || Copia basica

     |SI #labcontr#37 ! 0;
          aListaTmp = aListaFichCop;
          |QBF aListaTmp;
          |PARA; |SI aListaTmp ! ""; |HACIENDO;
               |HAZ Renombra;
          |SIGUE;
     |FINSI;

     || Copia basica para el representante sindical si este existe en el centro

     |ABRE #labtraba;
     |ABRE #labcentr;

     #labtraba#0 = enEmp;
     #labtraba#1 = enTra;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          aNif = #labtraba#7;
          |QBF aNif;

          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
              aAlfa = #labcentr#12;
              |QBF aAlfa;
              |SI aAlfa ! "NO EXISTE"; |Y aAlfa ! ""; |Y #labcontr#4 = 1;
                    || Otra copia basica (para el representante sindical)
                    aListaTmp = aListaFichCop;
                    |QBF aListaTmp;
                    |PARA; |SI aListaTmp ! ""; |HACIENDO;
                         |HAZ Renombra;
                    |SIGUE;
              |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #labcentr;
     |CIERRA #labtraba;
|FPRC;

|PROCESO Firma;
     || primero compruebo si existe la firma en laboral/firmas

     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aAlfa1 = aDirBase + "firmas/" + aNif;
     aAlfa2 = aPathDestino + aNif;
     |QBF aAlfa1;
     |QBF aAlfa2;

     |PARA i = 1; |SI i [ 3; |HACIENDO i = i + 1;
          |SI i = 1; aExtension = ".jpg"; |FINSI;
          |SI i = 2; aExtension = ".png"; |FINSI;
          |SI i = 3; aExtension = ".bmp"; |FINSI;

          aOrigen = aAlfa1 + aExtension;
          aDestinoFirma = aAlfa2 + aExtension;
          |XABRE "E", aOrigen, nCanal;
          |SI FSalida ] 0;         || Existe la firma!! Me la traigo
               |SI aIP ! "";
                    |ENVIA_FICHERO aOrigen, aDestinoFirma;
               |SINO;
                    |COPIA_FICHERO aOrigen, aDestinoFirma;
               |FINSI;
               swSigue = 1;
               aFirma = aDestinoFirma;
               aCadena = aFirma; aBusca = "/"; aCambia = "\"; |HAZ sustituye; aFirma = aCadenaSal;
               |XCIERRA nCanal;
               |SAL;
          |FINSI;
          |XCIERRA nCanal;
     |SIGUE;

     |SI swSigue = 1;
          || existe la firma, continuo, creo el lista.txt
          || para el fichero con la union de todos los PDFs
          || lo que tengo que saber es cuantas paginas tiene, para poner la
          || firma en cada una
          || se supone que un contrato tiene 4 paginas, tengo que saber
          || cuantas copias basicas o normales, tenemos

          aCadena = aPathDestino;
          aBusca = "/"; aCambia = "\"; |HAZ sustituye; aPathDestino = aCadenaSal;

          aLista = aPathDestino + "lista.txt";
          |XABRE "CBW", aLista, nCanal;
          |SI FSalida ] 0;

               || bueno en principio lo mismo para los tres

               aAlfa1 = "0 655 25 100 270";
               aAlfa2 = "85 695 100 25";

               nPagina = 0;
               nTotalDocs = nDoc;
               ||PARA nDoc = 1; |SI nDoc [ nTotalDocs; |HACIENDO nDoc = nDoc + 1;
               || solo firma el trabajador el primer documento
                    nPagina = nPagina + 1; aPagina = nPagina; |QBF aPagina; aPagina = " " + aPagina + " ";
                    aAlfa = aFirma + aPagina + aAlfa1 + &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    nPagina = nPagina + 1; aPagina = nPagina; |QBF aPagina; aPagina = " " + aPagina + " ";
                    aAlfa = aFirma + aPagina + aAlfa1 + &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    nPagina = nPagina + 1; aPagina = nPagina; |QBF aPagina; aPagina = " " + aPagina + " ";
                    aAlfa = aFirma + aPagina + aAlfa1 + &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    nPagina = nPagina + 1; aPagina = nPagina; |QBF aPagina; aPagina = " " + aPagina + " ";
                    aAlfa = aFirma + aPagina + aAlfa2 + &13 + &10;
                    |XGRABA nCanal, aAlfa;
               ||SIGUE;

               |XCIERRA nCanal;
          |FINSI;

          || una vez creado el lista.txt con los parametros,
          || creo y ejecuto el firmador

          || el lanza.bat ya no me hace falta
/*
          aLanza = aPathDestino + "lanza.bat";
          |XABRE "CBW", aLanza, nCanal;
          aCadena = "@echo off" + &13 + &10;
          |XGRABA nCanal, aCadena;
          aCadena = (aPathDestino % 102) + &13 + &10;;
          |XGRABA nCanal, aCadena;
          aCadena = (aPathDestino % 102);
          aCadena = "cd " + (aPathDestino - aCadena) + &13 + &10;
          aBusca = "/"; aCambia = "\"; |HAZ sustituye; aCadena = aCadenaSal;
          |XGRABA nCanal, aCadena;
          |SI FSalida ] 0;
*/
               || aListaPDFs = aPathDestino + "contrato_b*";
               aListaPDFs = aRuta;

               aAlfa1 = aPathDestino + "dspdfimage.exe";
               aAlfa2 = aListaPDFs; |QBF aAlfa2;
               aAlfa3 = aPathDestino + "lista.txt";
               aAlfa = "wait.exe " + aAlfa1 + " " + aAlfa2 + " " + aAlfa3
               aAlfa4 = aPathDestino + aAlfa;
               aAlfa = aAlfa + &13 + &10;

               aCadena = aAlfa;
               aBusca = "/";
               aCambia = "\";
               |HAZ sustituye;
               aCadena = aCadenaSal;
/*
               |XGRABA nCanal, aCadena;

               |XCIERRA nCanal;

               aLanza = aPathDestino + "dsmini.exe";
               aLanza = aLanza + " ";
               aLanza = aLanza + aPathDestino + "lanza.bat";

               |RSYSTEM aLanza;
*/
               aCadena = aAlfa4;
               aBusca = "/";
               aCambia = "\";
               |HAZ sustituye;
               aCadena = aCadenaSal;
               |RSYSTEM aCadena;
          ||FINSI;
          |XCIERRA nCanal;
     |FINSI;
|FPRC;

|PROCESO EnUnoSolo;
     || Primero me traigo el dsfdf.exe a local, a donde esta el dsarchi

     |HAZ TraeProgramas;

     aAlfa1 = enEmp; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = enTra; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;

     |SI eaVengoDe = "contrato";  aFicheroUni = "contrato_";     |FINSI;
     |SI eaVengoDe = "labcerti";  aFicheroUni = "certificado_";  |FINSI;

     aFicheroUni = aFicheroUni + aAlfa1 + "_" + aAlfa2;
     swEsProrroga = 0;
     |SI nNroProrr ! 0;
          swEsProrroga = 1;
          aAlfa = nNroProrr;
          |QBF aAlfa;
          aAlfa = "P" + aAlfa;
          aFicheroUni = aFicheroUni + "_" + aAlfa;
     |FINSI;
     aFicheroUni = aFicheroUni + ".pdf";

     || ahora borro restos de contratos anteriores, todo lo que empiece por
     || "contrato" y tambien por "certificado"

     aAlfa = aPathLocFDF + "contrato*";
     |HAZ Borrador;
     aAlfa = aPathLocFDF + "certificado*";
     |HAZ Borrador;
     aAlfa = aPathLocFDF + "*.jpg"; |HAZ Borrador;
     aAlfa = aPathLocFDF + "*.bmp"; |HAZ Borrador;
     aAlfa = aPathLocFDF + "*.png"; |HAZ Borrador;
     aAlfa = aPathLocFDF + "lista.txt";
     |HAZ Borrador;
     aAlfa = aPathLocFDF + "lanza.bat";
     |HAZ Borrador;

     || en tercer lugar uso lo de David para pasarlos a PDF

     aAlfa = aDestino - "pdftk.exe" + "dsfdf.exe " + aFicheroBAT;

     |RSYSTEM aAlfa;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |SI eaVengoDe ! "contrato";
         aOrigen  = aPathLocFDF + "contrato_a001.pdf";
         aDestino = aPathLocFDF + aFicheroUni;
         |RRENOMBRA_FICHERO aOrigen, aDestino;

         |ACABA;
     |FINSI;

     || por ultimo los uno todos en un PDF
     |HAZ Ordena;

     aAlfa1 = aDestino + " " + aPathLocFDF + "contrato_b*.pdf cat output ";
     aRuta = aAlfa1; |HAZ CompRuta;
     aUnion = aRuta;

     |SI swImpMasiva = 1;
          aFicheroUni = aFicheroUni - ".pdf" + "_U" + ".pdf";
          aRutaExt = aDestino + " " + aPathLocFDF;
          aRutaExt = aRutaExt + "contrato_?????_?????_U.pdf cat output "
          aRutaExt = aRutaExt + aPathLocFDF + "contratos_masivo.pdf";
          aRuta = aRutaExt;
          |HAZ CompRuta;
          aRutaExt = aRuta;

          aFichExt = aPathLocFDF + "contratos_masivo.pdf";
          aRuta = aFichExt;
          |HAZ CompRuta;
          aFichExt = aRuta;
     |FINSI;

     aAlfa2 = aPathLocFDF + aFicheroUni;
     aRuta = aAlfa2; |HAZ CompRuta;
     aRutaOriCont = aRuta;
     aUnion = aUnion + " " + aRuta;
     |RSYSTEM aUnion;

     |ABRE #nomcont1; |LEE 000#nomcont1.p; |CIERRA #nomcont1;
     |SI #nomcont1#9 = 6554;
          |HAZ Firma;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     || Ahora lo dejo en la carpeta que me indiquen en el control de la
     || aplicacion, para guarar contratos
/*
     aCarpetaCont = "c:\contratos";
     aRuta = aCarpetaCont;
     |HAZ CompRuta;
     aCaracter = aRuta % -101;
     |SI aCaracter ! "\";
          aRuta = aRuta + "\";
     |FINSI;
     aCarpetaCont = aRuta;
     |RMKDIR aCarpetaCont;      || por si no existiera

     aRutaDesCont = aCarpetaCont + aFicheroUni;

     |RCOPIA_FICHERO aRutaOriCont, aRutaDesCont;
     FEstado = FSalida;
*/
     || esto no lo hago, el que quiera que se guarden los contratos,
     || que se ponga el GAD

     || asi que igualo la ruta origen a la ruta destino

     aRutaDesCont = aRutaOriCont;
|FPRC;

|PROCESO MuestraContrato;
     |SI swImpMasiva = 1;
          |ACABA;
     |FINSI;
     aRutaDesCont = "start " + aRutaDesCont;
     |RSYSTEM aRutaDesCont;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO FabricaLista;
     aListaTmp = aListaTmp - " ";
     aPosicion = FSalida;
     |SI FSalida ! 0;
          aPosicion = ("0000" + aPosicion) % -104;
          aPosicion = aPosicion % 102;
          nPosicion = aPosicion;
          nPosicion = nPosicion - 1;
          nPosicion = nPosicion + 100;
          aAlfa = aListaTmp % nPosicion;
     |SINO;
          aAlfa = aListaTmp;
     |FINSI;

     aAlfa = aAlfa - &34 - &34;
     aAlfa = "start " + aAlfa;
     |XGRABA nCanal, aAlfa;
     aAlfa = aAlfa - "start ";
     aListaTmp = aListaTmp - &34 - aAlfa - &34;
     aAlfa = &13 + &10;
     |XGRABA nCanal, aAlfa;

     |QBF aListaTmp;
|FPRC;

|PROCESO ListaFicherosBAT;
     |SI #labcontr#65 = 0;    || como siempre
          aAlfa = "start " + aEjecutable + aParametros;
          |XGRABA nCanal, aAlfa;
          |PARA i = 1; |SI i [ nNroCopias; |HACIENDO i = i + 1;
               aAlfa = aListaFich;
               |XGRABA nCanal, aAlfa;
          |SIGUE;
          |SI nTipoSalida ! 0;
               aAlfa = " " + &34 + "no.pdf" + &34;
               |XGRABA nCanal, aAlfa;
          |FINSI;
          aAlfa = &13 + &10;
          |XGRABA nCanal, aAlfa;
     |SINO;
          |PARA i = 1; |SI i [ nNroCopias; |HACIENDO i = i + 1;
               aListaTmp = aListaFich;
               aListaTmp = aListaTmp - " ";
               |QBF aListaTmp;
               |PARA; |SI aListaTmp ! ""; |HACIENDO;
                    |HAZ FabricaLista;
               |SIGUE;

               |XGRABA nCanal, aAlfa;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO GeneraBAT;
     aDestino = "start " + aEjecutable + aParametros + aListaFich;
     aFicheroBAT = aPathLocFDF + Usuario + ".bat";
     |XABRE "CBW", aFicheroBAT, nCanal;
     |SI FSalida ] 0;
          aAlfa = "@echo off" + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aUnidad = aPathDestino % 102;
          aAlfa = aUnidad + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aAlfa = "cd " + &34 + aPathDestino + &34 + &13 + &10;
          aAlfa = aAlfa - aUnidad;

          aCadena = aAlfa; aBusca = "/"; aCambia = "\";
          |HAZ sustituye;
          aAlfa = aCadenaSal;

          |XGRABA nCanal, aAlfa;

          |HAZ ListaFicherosBAT;

          |SI nTipoSalida ! 0;
               aAlfa = aMatador + &13 + &10;
               |XGRABA nCanal, aAlfa;
          |FINSI;
          |XCIERRA nCanal;
     |FINSI;
|FPRC;

|PROCESO Rutas;
     || el programa esta linkado a la ett, pongo esto, para hacer los PATH_DAT
     |DBASS aFich;
     |QBF aFich;
     aFich = aFich + "laboral/fich/";
     |PATH_DAT #pdfcontr#aFich#;
     |PATH_DAT #labcontr#aFich#;
     |PATH_DAT #labcentr#aFich#;
     |PATH_DAT #labtraba#aFich#;
     |PATH_DAT #nomcontr#aFich#;
|FPRC;


|PROCESO aPDFTK;
     |HAZ Rutas;

     |HAZ control;
     |HAZ BuscaRuta;
     |HAZ CargaInicial;
     |HAZ BuscaMata;

     aPathReader = #pdfcontr#1;
     |QBF aPathReader;
     aCadena = aPathReader;
     aMiCaracter = "\";
     nPorDonde = -1;
     |HAZ BuscaCaracter;
     nPos = nPos -1;
     nPos = nPos + 100;
     nPos = (-1) * nPos;
     aEjecutable = aPathReader % nPos;
     aPathReader = aPathReader - aEjecutable;
     |SI #labcontr#65 = 0;    || como siempre
          aPathDestino = aPathReader;
     |FINSI;

     |HAZ BuscaWait;
     |ABRE #nomcont1; |LEE 000#nomcont1.p; |CIERRA #nomcont1;
     |SI #nomcont1#9 = 6554;
          |HAZ BuscaFirmador;
     |FINSI;

     |SI nTipoSalida = 0; |Y aProcedencia ! "nomrecib"; || Solo Vista Previa
          aParametros = "";
          nNroCopias = 1;
     |FINSI;

     |SI nTipoSalida = 1;                    || Impresion
          #labcontr#65 = 0;
          |SI nTipoImpre = 1;
               aParametros = " /p";            || Muesta cuadro impresion
               nNroCopias = 1;
          |SINO;
               aParametros = " /h /p /n";         || Impresora por defecto
               nNroCopias = nNroCopias;
          |FINSI;
     |FINSI;

     |HAZ GeneraBAT;

     |SI #labcontr#65 = 0;
          |RSYSTEM aFicheroBAT;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;
     |SINO;
          |SI swETT = 1;
               eaVengoDe = "contrato";
          |FINSI;
          |SI #labcontr#79 = 1; |Y eaVengoDe = "contrato";
               |HAZ EnUnoSolo;
               |SI enSwSoloArchivo ! 1;
                    |HAZ MuestraContrato;
               |FINSI;
               |HAZ DSArchi;
          |SINO;
               |SI eaVengoDe = "labcerti";
                    |HAZ EnUnoSolo;
                    |SI enArchivar = 0;
                         aAlfa = "START " + aPathLocFDF + aFicheroUni;
                         |RSYSTEM aAlfa;
                         |PULSATECLA;
                         |PULSATECLA;
                         |PULSATECLA;
                         |PULSATECLA;
                         |PULSATECLA;
                    |FINSI;

                    |SI enArchivar = 1;
                         |HAZ DSArchi;
                    |FINSI;

                    enSwSoloArchivo = 1;
               |FINSI;

               |SI enSwSoloArchivo ! 1;
                    |RSYSTEM aFicheroBAT;
                    |PULSATECLA;
                    |PULSATECLA;
                    |PULSATECLA;
                    |PULSATECLA;
                    |PULSATECLA;
               |FINSI;

               |SI eaVengoDe = "contrato";
                    nArchi = 0;
                    |HAZ MiraSiArchiva;
                    |SI nArchi = 1;
                         |HAZ EnUnoSolo;
                         |HAZ DSArchi;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     aAlfa = aPathSerFDF + aArchivoFDF;
     |FBORRA aAlfa;

     aListaFich = "";
     aListaFichNor = "";
     aListaFichCop = "";
     |CIERRA #pdfcontr;
|FPRC;
