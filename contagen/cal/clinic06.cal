|FICHEROS;
   clinic06 #0;
   caenlace #1;

   caclipro #2;
   caforpag #3;

   camoneda #6;
|FIN;

|VARIABLES;
   &enAux = 0;
   &libro = 0;
   &orden = 0;
   &serie = "";
   &pesetas = 0;
   &cuenta = "";
   &digito = 0;
   &emision = "";
   &i_serie = "";
   &eaCuenta = "";
   &enNivel = 0;

   aLong   = "";
   aAlfa   = "";
   Cadena  = "";
   Comodin1 = "";
   fFecha  = @;
   nLong   = 0;
   Handle  = 0;
   Handle1 = 0;
   SwError = 0;
   nCont   = 0;
   nCalc   = 0;
   nAcum   = 0;

   aTipoF  = "";
   aTipo   = "";
   aLibro  = "";
   aEjerc  = "";
   aNumFac = "";
   aNumDoc = "";
   aFecFac = "";
   aFecCon = "";
   aCodCon = "";
   aDescr  = "";
   aCuenta = "";
   aSigno  = "";
   aImport = "";
   aMoneda = "";

   nNumDocAnt = 0;
   nNumBase   = 0;
   nApunte    = 0;
   nNivel     = 0;

   nNumVtos = 0;
   nDiasAnt = 0;
   nIncDias = 0;
   Linea    = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "AIC";
    Menu5 = " Anular ";
    Menu6 = " Ignorar ";
    Menu7 = " Continuar ";
|FIN;

|PROCESO MiraFichero;
   aAlfa = #0#1; |QBF aAlfa;
   |XABRE "E",aAlfa,Handle1;
   |SI FSalida < 0;
      |MENAV "    Fichero no existente"; |ERROR;
   |FINSI;
   |XCIERRA Handle1;
|FPRC;

|PROCESO MiraNivel;
   aAlfa = aCuenta; |QBF aAlfa; aLong = aAlfa % 0; nLong = aLong;
   nNivel = 0;
   |SI nLong = #48#14; nNivel = 1; |FINSI;
   |SI nLong = #48#15; nNivel = 2; |FINSI;
   |SI nLong = #48#16; nNivel = 3; |FINSI;
   |SI nLong = #48#17; nNivel = 4; |FINSI;
   |SI nLong = #48#18; nNivel = 5; |FINSI;
   |SI nLong = #48#19; nNivel = 6; |FINSI;
   |SI nNivel = 0;
      aAlfa = aCuenta; |QBF aAlfa;
      aAlfa = "    Cuenta " + aAlfa + " con longitud fuera de nivel";
      |MENAV aAlfa;
   |FINSI;
|FPRC;

|PROCESO EscribeDatos;
   |SI nNumDocAnt ! aNumDoc;
      nNumDocAnt = aNumDoc;
      nApunte = 1; nNumBase = 1;
      Linea = 2;
   |FINSI;

   |DDEFECTO #caenlace;
   #caenlace#0  = #0#2;
   #caenlace#1  = aFecCon;
   #caenlace#2  = aNumDoc;
   #caenlace#4  = aCuenta; aAlfa = aCuenta; |QBF aAlfa; |HAZ MiraNivel;
   #caenlace#5  = nNivel;
   #caenlace#6  = aCodCon;
   #caenlace#7  = aDescr;
   #caenlace#8  = aSigno;
   #caenlace#9  = aImport;
   |SI aTipo ! "C";
      #caenlace#10 = aTipo
      #caenlace#11 = aLibro;
      #caenlace#12 = aEjerc % -102;
      #caenlace#13 = aNumFac;
   |FINSI;
   #caenlace#15 = "01";
   #caenlace#19 = Usuario % 0810;
   #caenlace#20 = "N";
   |SI aTipo ! "C";
      aAlfa = aCuenta; |QBF aAlfa; aAlfa = aAlfa % 0103;
      |SI aAlfa = "400"; |O aAlfa = "430"; #caenlace#26 = "F"; #caenlace#3 = 1; |FINSI;
      |SI aAlfa = "600"; |O aAlfa = "700"; #caenlace#26 = "B";                  |FINSI;
      |SI #caenlace#26 = "B";
         #caenlace#27 = nNumBase; #caenlace#3 = nNumBase * 10;
         nNumBase = nNumBase + 1;
      |SINO;
         #caenlace#3 = Linea; Linea = Linea + 1;
      |FINSI;
      #caenlace#29 = aFecFac;
   |SINO;
      #caenlace#3 = Linea; Linea = Linea + 1;
   |FINSI;
   |GRABA 020#caenlace.c;

   |SI #caenlace#26 = "F";
      |SI aTipo = "R"; #caclipro#23 = "C"; |SINO; #caclipro#23 = "P"; |FINSI;
      #caclipro#10 = aCuenta;
      #caclipro#11 = nNivel;
      |LEE 000#caclipro.=;
      |SI FSalida ! 0;
         |DDEFECTO #caclipro;
         |SI aTipo = "R"; Alfa = " cliente "; |SINO; aAlfa = " proveedor "; |FINSI;
         aAlfa = "    No se encontro la ficha del" + aAlfa + aCuenta; |QBF aAlfa;
         aAlfa = aAlfa + ". Se generara un solo vencimiento";
         |MENAV aAlfa;
         nNumVtos = 1; nDiasAnt = 0; nIncDias = 0;
      |SINO;
         #caforpag#0 = #caclipro#20;
         |LEE 000#caforpag.=;
         |SI FSalida = 0;
            nNumVtos = #caforpag#2;
            nDiasAnt = #caforpag#3;
            nIncDias = #caforpag#4;
         |SINO;
            |SI aTipo = "R"; Alfa = " cliente"; |SINO; aAlfa = " proveedor"; |FINSI;
            aAlfa = "    No se encontro la forma de pago del" + aAlfa + ". Se generara un solo vencimiento";
            nNumVtos = 1; nDiasAnt = 0; nIncDias = 0;
         |FINSI;
      |FINSI;

      |SI aTipo = "R";
      |SINO;
         enAux = 1;
         libro = aLibro;
         i_serie = aEjerc % -102;
         orden = aNumFac;
         emision = aFecFac;
         cuenta = aCuenta; eaCuenta = cuenta; |HAZ SacaNivel;
         digito = enNivel;
         pesetas = aImport;
         |SUB_EJECUTA "calinpag";
      |FINSI;
   |FINSI;

/*
      nAcum   = 0;
      |PARA nCont = 1; |SI nCont < nNumVtos; |HACIENDO nCont = nCont + 1;
         |SI aTipo = "R";
         |SINO;
            |SI aMoneda = "E"; nCalc = nCalc / 100; |FINSI;
            #camanpag#8 = nCalc;
            |GRABA 020#camanpag.n;
         |FINSI;
      |SIGUE;

      |SI aMoneda = "E"; nAcum = nAcum / 100; |FINSI;
      fFecha = aFecFac; nCalc = fFecha; nCalc = nCalc + (((nNumVtos - 1) * nIncDias) + nDiasAnt);
      fFecha = nCalc;
      |SI aTipo = "R";
      |SINO;
         |REPON_DATOS #camanpag;
         #camanpag#3 = nNumVtos;
         #camanpag#7 = fFecha;
         nCalc = aImport; nCalc = nCalc - nAcum;
         #camanpag#8 = nCalc;
         |GRABA 020#camanpag.n;
      |FINSI;
   |FINSI;
*/
|FPRC;

|PROCESO Importa;
   aAlfa = #0#1; |QBF aAlfa;
   aAlfa = "rb  " + aAlfa;
   |FABRE aAlfa;
   |SI FSalida < 0;
      SwError = 1;
      |MENAV "Problemas al abrir el fichero secuencial. Se aborta el proceso"; |ACABA;
   |FINSI;
   Handle = FSalida;

   Cadena = Handle + " 101"; |FLEE Cadena;
   |PARA; |SI FSalida = 101; |HACIENDO;
      aTipo   = Cadena % 0101;                  || Soportado/Repercutido
      aLibro  = Cadena % 0202;                  || Libro de IVA
      aEjerc  = Cadena % 0404;                  || Ejercicio
      aNumFac = Cadena % 1006;                  || N§ Factura
      aNumDoc = Cadena % 1606;                  || N§ Documento
      aFecFac = Cadena % 2210;                  || Fecha de factura
      aFecCon = Cadena % 3210;                  || Fecha contable
      aCodCon = Cadena % 4202;                  || Codigo concepto
      aDescr  = Cadena % 4430;                  || Descripcion
      aCuenta = Cadena % 7412;                  || Cuenta
      aSigno  = Cadena % 8601;                  || Signo
      aImport = Cadena % 8712;                  || Importe

      |QBT aCuenta; aCuenta = (aCuenta + (" " * 12)) % 0112;
      |HAZ EscribeDatos;
      Cadena = Handle + " 101"; |FLEE Cadena;
   |SIGUE;

   FSalida = Handle; |FCIERRA FSalida;
|FPRC;

|PROGRAMA;

   |ABRE #camoneda;
   #camoneda#0 = #48#2;
   #camoneda#1 = #48#3;
   |LEE 000#camoneda.=;
   |SI FSalida = 0;
      aMoneda = #camoneda#2;
   |FINSI;
   |CIERRA #camoneda;

   |CLS;
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      aAlfa = "cl" + Usuario;
      |NOME_DAT #1 aAlfa; |DELINDEX #caenlace; |ABRE #caenlace;
      |ABRE #caclipro; |ABRE #caforpag;
      SwError = 0;
      |HAZ Importa;
      |CIERRA #caclipro; |CIERRA #caforpag; |CIERRA #caenlace;
      |SI SwError = 1; |ACABA; |FINSI;
      |DFICE aAlfa; |QBF aAlfa; || aAlfa = aAlfa + "/";
      aAlfa = aAlfa + "," + ("cl" + Usuario);
      aAlfa = "dsapunte.tab;" + aAlfa; |SUB_EJECUTA_NP aAlfa;
   |FINSI;
|FPRO;
