|FICHEROS;
 caut0018;

 camaniva;
 caivalin;
 caivaasi;
 caivam01;
 cacuenta;
 caclipro;
 caerpnif;

 casiim01;
 casiim02;
 casiim03;

 caivatm4;

 :/modelos/def/dsmom030;
 :/basica/def/agicen17;

 &regisnif@;
|FIN;

|VARIABLES;
 aAlfa      = "";
 aAlfa1     = "";
 aAlfa2     = "";
 nNume1     = 0;
 nNume2     = 0;
 nPara1     = 0;
 nPara2     = 0;
 fDFecha    = @;
 aDTipo     = "";
 aHTipo     = "";
 aH60       = "";
 nBorro     = 0;

 &snFilBa   = "";
 &eaMulDep  = "";
 &eaNomFich = "";
 &enQSerie  = 0;
 nUno       = 0;
 aParam     = "";
 nEmpresa   = 0;
 nPeriodo   = 0;
 nOk        = 0;
 a340        = "";
 aPais       = "";
 aClvPais    = "";
 &eaIdenPais = "";
 &enGrabaSii = 0;

 nNumLin     = 0;
 &eaTConfig  = "";
 &enTConLin  = 0;
 &SwCambia   = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscosi_i;

|| **********************************************************************

|CALCULO libroh; | TIPO 0;   ||  hasta diario
   |SI #caut0018#2 < #caut0018#1;  |ERROR;  |FINSI;
|FCAL;

|CALCULO hque; |TIPO 7;
 |SI enQSerie = 0; |O #caut0018#21 = "X";
     |C_M #caut0018#3,1,"N"; #caut0018#3 = "";      |PINTA #caut0018#3;
     |C_M #caut0018#4,1,"N"; #caut0018#4 = "zzzzz"; |PINTA #caut0018#4;
 |SINO;
     |C_M #caut0018#3,1,"S";
     |C_M #caut0018#4,1,"S";
 |FINSI;
|FCAL;

|CALCULO serieh; | TIPO 0;   ||  hasta documento
   |SI #caut0018#4 < #caut0018#3;  |ERROR;  |FINSI;
|FCAL;

|CALCULO facturah; | TIPO 0;   ||  hasta documento
   |SI #caut0018#6 < #caut0018#4;  |ERROR;  |FINSI;
|FCAL;

|CALCULO LaFecha; |TIPO 0;
 fDFecha = fec1;
 |SI enSwSelFc = 1; fDFecha = "01.01.2000"; |FINSI;
 |SI #caut0018#Campo# < fDFecha; |O #caut0018#Campo#  > fec2;
     |MENAV "    Error, Fecha Incorrecta ";
     |ERROR;
     |ACABA;
 |FINSI;
 |SI Campo = 8; |Y #caut0018#7 > #caut0018#8;
     |MENAV "    Error, Fecha Incorrecta ";
     |ERROR;
 |FINSI;
|FCAL;

|CALCULO SoloBorro; |TIPO 0;
  aAlfa1 = "S";
  |SI #caut0018#21 = "X";
      aAlfa1 = "N";
      #caut0018#0  = "A";           |PINTA #caut0018#0;
      #caut0018#3  = "     ";       |PINTA #caut0018#3;
      #caut0018#4  = "zzzzz";       |PINTA #caut0018#4;
      #caut0018#5  = 000001;        |PINTA #caut0018#5;
      #caut0018#6  = 999999;        |PINTA #caut0018#6;
      #caut0018#7  = "01.01.2000";  |PINTA #caut0018#7;
      #caut0018#8  = fec2;          |PINTA #caut0018#8;
      #caut0018#18 = 01;            |PINTA #caut0018#18;
      #caut0018#19 = 12;            |PINTA #caut0018#19;
      #caut0018#20 = "N";           |PINTA #caut0018#20;
  |FINSI;
  |C_M #caut0018#0,  1, aAlfa1;
  |C_M #caut0018#3,  1, aAlfa1;
  |C_M #caut0018#4,  1, aAlfa1;
  |C_M #caut0018#5,  1, aAlfa1;
  |C_M #caut0018#6,  1, aAlfa1;
  |C_M #caut0018#7,  1, aAlfa1;
  |C_M #caut0018#8,  1, aAlfa1;
  |C_M #caut0018#18, 1, aAlfa1;
  |C_M #caut0018#19, 1, aAlfa1;
  |C_M #caut0018#20, 1, aAlfa1;
|FCAL;

|| **********************************************************************
|PROCESO LeeCliPro;
     aClvPais = "";
     |ABRE #caerpnif;
     #caerpnif#0 = #camaniva#0;
     #caerpnif#1 = #camaniva#1;
     |LEE 000#caerpnif.=;
     |SI FSalida = 0;
         aClvPais = #caerpnif#4;
     |FINSI;
     |CIERRA #caerpnif;

     eaSiiCIF = #camaniva#14;  |QBF eaSiiCIF;
     eaSiiUlt = #camaniva#44;  |QBF eaSiiUlt;
     a340 = #camaniva#42;  |QBF a340;
     eaSiiEje = #camaniva#4 % -104;
     enSiiPer = #camaniva#5;
     enSiiRet = #camaniva#20;

     |ABRE #caclipro;
     |SI aTipoIVA = "R";
         #caclipro#23 = "C";
     |SINO;
         #caclipro#23 = "P";
     |FINSI;
     #caclipro#10 = #camaniva#12;
     |LEE 000#caclipro.=;
     |SI FSalida ! 0;  |DDEFECTO #caclipro;  |FINSI;

     aPais     = #caclipro#24;
     eaIdenPais = "01";

     eaCodNif = #caclipro#9;
     |HAZ LeeNifs;
     |SI ewNif = 0;
         aPais = #regisnif@#12;
     |FINSI;
     |QBF aPais;

     |SI aPais = "";    aPais = "ES"; |FINSI;
     |SI aPais = "ESP"; aPais = "ES"; |FINSI;
     |CIERRA #caclipro;
|FPRC;

|PROCESO LeenConcepto;
     |ABRE #dsmom030;
     #dsmom030#0 = enSiiCon;
     |LEE 001#dsmom030.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom030;  |FINSI;
     |CIERRA #dsmom030;

     |SI aPais ! "ES";
         aAlfa   = aPais;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

                            eaIdenPais = "06";
         |SI aAlfa = "DE";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "AT";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "BE";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "BG";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "CY";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "DK";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "SI";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "EE";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "FI";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "FR";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "EL";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "GB";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "NL";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "HU";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "IT";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "IE";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "LV";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "LT";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "LU";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "MT";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "PL";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "PT";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "CZ";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "SK";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "RO";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "SE";  eaIdenPais = "02";  |FINSI;
         |SI aAlfa = "HR";  eaIdenPais = "02";  |FINSI;
     |FINSI;

     |SI #dsmom030#30 = 9;
         aAlfa   = aPais;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         eaIdenPais = "02";
     |FINSI;

     |SI #dsmom030#30 = 10;
         aAlfa = aPais;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         eaIdenPais = "04";

         aAlfa   = eaSiiCIF;   |QBF aAlfa;
         |SI aAlfa = "";  eaIdenPais = "06";  |FINSI;
     |FINSI;

     |SI aClvPais ! "";
         eaIdenPais = aClvPais;
     |FINSI;
|FPRC;

|PROCESO Defectos;

     |HAZ LeenConcepto;

     |DDEFECTO #casiim03;

     |SI nNumLin = 0;
         #casiim03#6 = "F1";

         |SI eaSiiCIF = "";
             #casiim03#6 = "F2";
         |FINSI;

         |SI eaSiiUlt ! "";
             #casiim03#6 = "F4";
         |FINSI;

         |SI a340 = "D";
             #casiim03#6  = "R4";
             #casiim03#13 = "I";

             |SI eaSiiCIF = "";
                 #casiim03#6 = "R5";
             |FINSI;
         |FINSI;

         |SI aTipoIVA = "S";
             |SI #dsmom030#28 = 3;
                 #casiim03#6 = "F5";
             |FINSI;

             |SI #dsmom030#28 = 4;
                 #casiim03#6 = "F5";
             |FINSI;

             |SI #dsmom030#28 = 7;
                 #casiim03#6 = "F6";
             |FINSI;
         |FINSI;

         || Clave operacion

         #casiim03#7 = "01";

         |SI aTipoIVA = "R";
             |SI #dsmom030#30 = 10;
                 #casiim03#7 = "02";
             |FINSI;

             |SI #dsmom030#30 = 5;
                 #casiim03#7 = "03";
             |FINSI;

             |SI #dsmom030#30 = 6;
                 #casiim03#7 = "05";
             |FINSI;

             nOk = 0;
             |SI a340 = "Z";  nOk = 1;  |FINSI;
             |SI a340 = "0";  nOk = 1;  |FINSI;
             |SI a340 = "1";  nOk = 1;  |FINSI;
             |SI a340 = "2";  nOk = 1;  |FINSI;
             |SI a340 = "3";  nOk = 1;  |FINSI;
             |SI a340 = "4";  nOk = 1;  |FINSI;
             |SI a340 = "5";  nOk = 1;  |FINSI;
             |SI a340 = "6";  nOk = 1;  |FINSI;
             |SI a340 = "7";  nOk = 1;  |FINSI;
             |SI a340 = "8";  nOk = 1;  |FINSI;
             |SI a340 = "9";  nOk = 1;  |FINSI;

             |SI nOk = 1;
                 #casiim03#7 = "07";
             |FINSI;

             |SI eaSiiEje = "2017";  |Y enSiiPer [ 6; |Y enEjercicio < 2018;
                 #casiim03#7 = "16";
             |FINSI;

             |SI enSiiCon = 704;  |Y enSiiRet ! 0;
                 #casiim03#7 = "11";
             |FINSI;

             |SI enSiiCon = 704;  |Y enSiiRet = 0;
                 #casiim03#7 = "12";
             |FINSI;

             |SI #dsmom030#49 = "X";
                 #casiim03#7 = "12";
             |FINSI;
         |FINSI;

         |SI aTipoIVA = "S";
             || Clave operacion

             |SI #dsmom030#28 = 7;
                 #casiim03#7 = "02";
             |FINSI;

             nOk = 0;
             |SI a340 = "Z";  nOk = 1;  |FINSI;
             |SI a340 = "0";  nOk = 1;  |FINSI;
             |SI a340 = "1";  nOk = 1;  |FINSI;
             |SI a340 = "2";  nOk = 1;  |FINSI;
             |SI a340 = "3";  nOk = 1;  |FINSI;
             |SI a340 = "4";  nOk = 1;  |FINSI;
             |SI a340 = "5";  nOk = 1;  |FINSI;
             |SI a340 = "6";  nOk = 1;  |FINSI;
             |SI a340 = "7";  nOk = 1;  |FINSI;
             |SI a340 = "8";  nOk = 1;  |FINSI;
             |SI a340 = "9";  nOk = 1;  |FINSI;

             |SI nOk = 1;
                 #casiim03#7 = "07";
             |FINSI;

             |SI #dsmom030#28 = 5;
                 #casiim03#7 = "09";
             |FINSI;

             |SI #dsmom030#28 = 6;
                 #casiim03#7 = "09";
             |FINSI;

             |SI #dsmom030#28 = 13;
                 #casiim03#7 = "09";
             |FINSI;

             |SI #dsmom030#28 = 17;
                 #casiim03#7 = "09";
             |FINSI;

             |SI #dsmom030#38 = 180;  |Y #dsmom030#40 = 1;
                 #casiim03#7 = "12";
             |FINSI;

             |SI eaSiiEje = "2017";  |Y enSiiPer [ 6; |Y enEjercicio < 2018;
                 #casiim03#7 = "14";
             |FINSI;

         |FINSI;

         #casiim01#67 = "N";
         |SI #casiim01#3 = "F2";  |O #casiim01#3 = "F4";
              |O #casiim01#3 = "R5";
                #casiim01#67 = "S";
         |FINSI;
    |FINSI;

    |SI nNumLin ! 0;
        aAlfa = #caclipro#9 % 101;

                                                  nOk = 1;
        |SI eaIdenPais  = "01";  |Y aAlfa ! "N";  nOk = 0;  |FINSI;
        |SI eaIdenPais  = "07";  |Y aAlfa ! "N";  nOk = 0;  |FINSI;
        |SI #casiim01#3 = "F2";                   nOk = 0;  |FINSI;
        |SI #casiim01#3 = "F4";                   nOk = 0;  |FINSI;
        |SI #casiim01#3 = "R5";                   nOk = 0;  |FINSI;

        |SI nOk = 1;
            |SI eaIdenPais ! "01";
                #casiim03#10 = "E";
                |SI #dsmom030#30 = 16;
                    #casiim03#10 = "P";
                |FINSI;
            |FINSI;
        |FINSI;

        |SI enSiiIva > 0;
            #casiim03#11 = "S1";

            |SI #dsmom030#30 = 4;
                 #casiim03#11 = "S2";
            |FINSI;
        |SINO;
            |SI #casiim01#4 = "02";
                #casiim03#11 = "E2";
            |FINSI;

            |SI #dsmom030#30 = 9;
                 #casiim03#11 = "E5";
            |FINSI;

            |SI #casiim03#11 ! "E2";  |Y #casiim03#11 ! "E5";
                #casiim03#11 = "E6";
            |FINSI;

            |SI #dsmom030#30 = 16;
                #casiim03#11 = "N2";
            |FINSI;
        |FINSI;
    |FINSI;
    |HAZ LosCamposNuevos;
|FPRC;
|| //////////////////////////////////////////////////////////////
|PROCESO Inmuebles;

     |SI #casiim01#3 = "XX";  |ACABA;  |FINSI;
     |SI aTipoIVA ! "R";      |ACABA;  |FINSI;

     nOk = 0;
     |SI #casiim01#4 = "12";  nOk = 1;  |FINSI;
     |SI #casiim01#4 = "13";  nOk = 1;  |FINSI;
     |SI #casiim01#5 = "12";  nOk = 1;  |FINSI;
     |SI #casiim01#5 = "13";  nOk = 1;  |FINSI;
     |SI #casiim01#6 = "12";  nOk = 1;  |FINSI;
     |SI #casiim01#6 = "13";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         |PDEFECTO #casiim01,19,49;
         |ACABA;
     |FINSI;

     aAlfa = #casiim01#19 + #casiim01#20;  |QBF aAlfa;

     |SI aAlfa = ""; |O #caut0018#20 = "S";
         |ABRE #agicen17;
         |DDEFECTO #agicen17;
         #agicen17#0 = enEmpresa;
         #agicen17#1 = eaSiiDep;
         #agicen17#2 = eaSiiSub;
         |LEE 000#agicen17.=;
         |SI FSalida = 0;
             #casiim01#19 = #agicen17#17;
             #casiim01#20 = #agicen17#3;
         |FINSI;
         |CIERRA #agicen17;
     |FINSI;
|FPRC;

|| //////////////////////////////////////////////////////////////

|PROCESO CampoDesdeM03;

  |ABRE #casiim03;
  |DDEFECTO #casiim03;
  #casiim03#15 = eaTConfig;
  #casiim03#0  = enTConLin;
  |LEE 041#casiim03.=
  |CIERRA #casiim03;

  |SI eaSiiEje = "2017"; |Y enSiiPer [ 6; |Y enEjercicio < 2018;
      |SI aTipoIVA = "R";
          |SI #casiim03#7 ! "11"; |Y #casiim03#7 ! "12"; |Y #casiim03#7 ! "13";
              #casiim03#7 = "16";
          |FINSI;
      |SINO;
          #casiim03#7 = "14";
      |FINSI;
  |FINSI;

  |HAZ LosCamposNuevos;
|FPRC;

|PROCESO LosCamposNuevos;

  #casiim01#0 = "camaniva";
  #casiim01#1 = #camaniva#0;
  #casiim01#2 = #camaniva#1;
  |LEE 101#casiim01.=;
  |SI FSalida ! 0;
      |DDEFECTO #casiim01;
      #casiim01#0 = "camaniva";
      #casiim01#1 = #camaniva#0;
      #casiim01#2 = #camaniva#1;

      |GRABA 020#casiim01.b;
  |FINSI;

  |SI nNumLin = 0;
      #casiim01#3 = #casiim03#6;
      #casiim01#4 = #casiim03#7;
      #casiim01#5 = #casiim03#8;
      #casiim01#6 = #casiim03#9;
      #casiim01#7 = #casiim03#10;  || Tipo 1
      #casiim01#8 = #casiim03#11;  || Nivel 1

      aAlfa = "";
      |SI #casiim03#14 ! "C";
          |SI #casiim03#14 ! "D";
              aAlfa = #camaniva#28; |QBF aAlfa;
              aAlfa = aAlfa + " ";
          |FINSI;
          |SI #casiim03#14 ! "F";
              aAlfa1 = #casiim03#12; |QBF aAlfa1;
              aAlfa = aAlfa + aAlfa1;
              |QBF aAlfa;
          |FINSI;
          #casiim01#13 = aAlfa;
      |SINO;
          |HAZ eDesSiim01;
          #casiim01#13 = eaSiiDes;
      |FINSI;
      #casiim01#15 = #casiim03#13;
      #casiim01#10 = #casiim03#18;
      #casiim01#67 = #casiim03#19;
      #casiim01#68 = #casiim03#20;

      |PDEFECTO #casiim01, 50, 66;

      |HAZ Inmuebles;
  |FINSI;

  |SI nNumLin = 1;
      #casiim01#7  = #casiim03#10;  || Tipo 1
      #casiim01#8  = #casiim03#11;  || Nivel 1
      #casiim01#50 = #caivalin#2;   || Base 1
  |FINSI;

  |SI nNumLin = 2;
      #casiim01#51 = #caivalin#2;   || Base  2
      #casiim01#52 = #casiim03#10;  || Tipo  2
      #casiim01#53 = #casiim03#11;  || Nivel 2
  |FINSI;

  |SI nNumLin = 3;
      #casiim01#54 = #caivalin#2;   || Base  3
      #casiim01#55 = #casiim03#10;  || Tipo  3
      #casiim01#56 = #casiim03#11;  || Nivel 3
  |FINSI;

  |SI nNumLin = 4;
      #casiim01#57 = #caivalin#2;   || Base  4
      #casiim01#58 = #casiim03#10;  || Tipo  4
      #casiim01#59 = #casiim03#11;  || Nivel 4
  |FINSI;

  |SI nNumLin = 5;
      #casiim01#60 = #caivalin#2;   || Base  5
      #casiim01#61 = #casiim03#10;  || Tipo  5
      #casiim01#62 = #casiim03#11;  || Nivel 5
  |FINSI;

  |SI nNumLin = 6;
      #casiim01#63 = #caivalin#2;   || Base  6
      #casiim01#64 = #casiim03#10;  || Tipo  6
      #casiim01#65 = #casiim03#11;  || Nivel 6
  |FINSI;

  |GRABA 020#casiim01.a;
  |LIBERA #casiim01;

|FPRC;

|| ////////////////////////////////////////////////////////////////////////
|PROCESO PorLinea;
  |HAZ ePorLinea;
  |SI SwCambia ! 0;
      |HAZ CampoDesdeM03;
  |SINO;
      |HAZ Defectos;
  |FINSI;
|FPRC;

|PROCESO LineaIVA0;
  enSiiIva  = #caivalin#7;
  enSiiCon  = #caivalin#3;
  nNumLin   = nNumLin + 1;

  |SI nNumLin > 6;
      |ERROR10;
  |SINO;
      |HAZ PorLinea;
  |FINSI;
|FPRC;

|DEFBUCLE LineaIVA;
  #caivalin#1;
  ;
  #camaniva#0, #camaniva#1, 01;
  #camaniva#0, #camaniva#1, 99;
  e;
  NULL, LineaIVA0;
|FIN;

|PROCESO CabecIVA0;
  |SI #caut0018#20 = "N";
      #casiim01#0 = "camaniva";
      #casiim01#1 = #camaniva#0;
      #casiim01#2 = #camaniva#1;
      |LEE 040#casiim01.=;
      |SI FSalida = 0;
          nUno = 0;
          |SI #caut0018#3 ! "F1";
              nUno = 1;
          |SINO;
              |PARA nPara1 = 4; |SI nPara1 [ 8; |HACIENDO nPara1 = nPara1 + 1;
                    aAlfa = #caut0018#nPara1#; |QBF aAlfa;
                    |SI aAlfa ! "";
                        nUno = 1;
                    |FINSI;
              |SIGUE;
          |FINSI;
          aAlfa = #caut0018#13; |QBF aAlfa;
          |SI aAlfa ! ""; nUno = 1; |FINSI;
          |SI nUno = 1; |ACABA; |FINSI;
      |FINSI;
  |FINSI;

  aTipoIVA = #camaniva#36;
  eaSiiSer = #camaniva#2;
  enSiiLib = #camaniva#0;
  enSiiDoc = #camaniva#1;
  enSiiRet = #camaniva#20;

  |SI aTipoIVA = "N"; |ACABA; |FINSI;
  |SI #camaniva#8 < "01.01.2017"; |ACABA; |FINSI;

  eOpDep      = 0;
  eSwNoalta   = 1;
  enActividad = #camaniva#10;
  eaCodDep    = #camaniva#10;
  |HAZ Actividad;
  eSwNoalta   = 0;
  |SI eswLect = 1; |Y #caivaasi#188 ! "S"; |ACABA; |FINSI;
  eaSiiDep = #camaniva#10;
  eaSiiSub = #camaniva#11;

  nOk = 0;
  |SI enTipoIva = 11;  nOk = 1;  |FINSI;
  |SI enTipoIva = 12;  nOk = 1;  |FINSI;
  |SI enTipoIva = 13;  nOk = 1;  |FINSI;
  |SI enTipoIva = 15;  nOk = 1;  |FINSI;
  |SI enTipoIva = 16;  nOk = 1;  |FINSI;
  |SI enTipoIva = 17;  nOk = 1;  |FINSI;

  |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;

  |SI nOk = 0;  |ACABA;  |FINSI;

  |HAZ LeeCliPro;
  nNumLin  = 0;
  enSiiCon = #camaniva#27;
  |HAZ PorLinea;

  |SI aTipoIVA = "R";
      |BUCLE LineaIVA;
  |FINSI;

  |LIBERA #camaniva;

  enGrabaSii = 1;
|FPRC;

|DEFBUCLE CabecIVA;
  #camaniva#3;
  4,5,36;
  #caut0018#1, #caut0018#3, #caut0018#5, #caut0018#7, #caut0018#18, aDTipo;
  #caut0018#2, #caut0018#4, #caut0018#6, #caut0018#8, #caut0018#19, aHTipo;
  be;
  NULL, CabecIVA0;
|FIN;
|| ////////////////////////////////////////////////////////////////////

|PROCESO IniEmpresa;
    |SI #caivatm4#0 ! 0;
        cod1 = #caivatm4#0;
        cod2 = #caivatm4#1;
        emEmp = 1;  || Sin mensaje
        |HAZ leelo;
        |SI swerror ! 0;  |ACABA;   |FINSI;
    |FINSI;

    |SI nEmpresa ! -1;
        |CIERRA #camaniva;
        |CIERRA #casiim01;
    |FINSI;

    |SI #caivatm4#0 ! 0;
        |DBASE dirfich0; |QBF dirfich0;
        dirfich0 = dirfich0 + "fich/";
        aAlfa1   = ("00000" + #caivatm4#0) % -105;
        aAlfa2   = ("0"     + #caivatm4#1) % -101;
        dirfich0 = dirfich0 + aAlfa1 + aAlfa2 + "/";
        |QBF dirfich0;
    |SINO;
        |DFICE dirfich0; |QBF dirfich0;
    |FINSI;

    |PATH_DAT #camaniva#dirfich0#;
    |PATH_DAT #caivalin#dirfich0#;
    |PATH_DAT #caivaasi#dirfich0#;
    |PATH_DAT #cacuenta#dirfich0#;
    |PATH_DAT #caclipro#dirfich0#;
    |PATH_DAT #casiim03#dirfich0#;
    |PATH_DAT #casiim01#dirfich0#;

    |ABRE #caivaasi;
    |DDEFECTO #caivaasi;
    |LEE 001#caivaasi.p;
    |CIERRA #caivaasi;
    snFilBa  = #caivaasi#119;
    eaMulDep = #caivaasi#132;
    enQSerie = 0;
    |SI #caivaasi#44 = "S"; enQSerie = 1;|FINSI;
    #caut0018#7 = "01.01.2000";
    #caut0018#8 = fec2;

    |HAZ CojoConfig;

    enGrabaSii = 0;
    |ABRE #camaniva;
    |ABRE #casiim01;
|FPRC;

|PROCESO PorAuxiliar;
  |SI nEmpresa ! #caivatm4#0; |O nPeriodo ! #caivatm4#1;
      |HAZ IniEmpresa;
      |SI swerror ! 0;  |ACABA;   |FINSI;
      nEmpresa = #caivatm4#0;
      nPeriodo = #caivatm4#1;
  |FINSI;

  #camaniva#0 = #caivatm4#2;
  #camaniva#1 = #caivatm4#3;
  |LEE 141#camaniva.=;
  |SI FSalida = 0;
      |HAZ CabecIVA0;
  |SINO;
      |LIBERA #camaniva;
  |FINSI;
|FPRC;

|DEFBUCLE PorAuxiliar;
  #caivatm4#1;
  ;
  00000, 0, 01, 0000000001;
  99999, 9, 99, 9999999999;
  e;
  NULL, PorAuxiliar;
|FIN;

|| /////////////////////////////////////////////////////////////////////
|PROCESO casiim02B;
     |BORRA 020#casiim02.a;
     |LIBERA #casiim02;
|FPRC;

|DEFBUCLE LeeCasim02;
     #casiim02#1;
     ;
     #casiim01#0, #casiim01#1, #casiim01#2, "";
     #casiim01#0, #casiim01#1, #casiim01#2, aH60;
     be;
     NULL, casiim02B;
|FIN;

|PROCESO PorSiim01;
  nBorro = 0;
  #camaniva#0 = #casiim01#1;
  #camaniva#1 = #casiim01#2;
  |LEE 041#camaniva.=;
  |SI FSalida = 0;
      |SI #camaniva#36 = "N"; nBorro = 1; |FINSI;
  |SINO;
      nBorro = 1;
  |FINSI;
  |SI nBorro = 1;
      |BORRA 020#casiim01.a;
      |BUCLE LeeCasim02;
  |FINSI;
  |LIBERA #casiim01;
|FPRC;

|DEFBUCLE LeeSiim01;
  #casiim01#1;
  ;
  "camaniva", #caut0018#1, 0000000001;
  "camaniva", #caut0018#2, 9999999999;
  be;
  NULL, PorSiim01;
|FIN;

|| /////////////////////////////////////////////////////////////////////
|CALCULO ElCambio; |TIPO 12;

  |SI #caut0018#17 = "N";
      |ACABA;
  |FINSI;

  aH60 = "z" * 60;
  |SI aParam = "";
      aDTipo = " "; aHTipo = "z";
      |SI #caut0018#0 ! "A";
          aDTipo = #caut0018#0;
          aHTipo = #caut0018#0;
      |FINSI;

      |SI #caut0018#21 ! "X";
          |ABRE #casiim01;
          |BUCLE CabecIVA;
          |CIERRA #casiim01;
      |FINSI;

      |SI #caut0018#21 ! "N";
          |ABRE #camaniva;
          |BUCLE LeeSiim01;
          |CIERRA #camaniva;
      |FINSI;
  |SINO;

      |NOME_DAT #caivatm4#eaNomFich#;
      nEmpresa = -1;
      nPeriodo = -1;
      |BUCLE PorAuxiliar;
      |SI nEmpresa ! -1;
          |CIERRA #camaniva;
          |CIERRA #casiim01;
      |FINSI;
      |DELINDEX #caivatm4;
  |FINSI;
|FCAL;

|PROGRAMA;
   aParam = PARAMETRO;
   |QBF aParam;

   |SI aParam = "";
       |HAZ inicio;
       |HAZ DirAplicSt;
       |SI enEjercicio < 2017;
           |MENAV "0000Ejercicio No Correcto";
           |ACABA;
       |FINSI;
   |FINSI;

   |DDEFECTO #caut0018;

   |SI aParam = "";

       |HAZ CojoConfig;

       |ABRE #caivaasi;
       |DDEFECTO #caivaasi;
       |LEE 001#caivaasi.p;
       |CIERRA #caivaasi;
       snFilBa  = #caivaasi#119;
       eaMulDep = #caivaasi#132;
       enQSerie = 0;
       |SI #caivaasi#44 = "S"; enQSerie = 1;|FINSI;
       |HAZ eParaModelos;
       fDFecha = fec1;
       |SI enSwSelFc = 1; fDFecha = "01.01.2000"; |FINSI;
       #caut0018#7 = fDFecha;
       #caut0018#8 = fec2;

       |CLS;
       |CABEZA "Asig.Auto Depar/Subdepar";
       |PINPA #0#caut0018;
       |PINDA #0#caut0018;
       |ENDATOS #1#caut0018;

   |SINO;

        #caut0018#17 = "S";
        |HAZ ElCambio;

   |FINSI;
|FPRO;
|| **************************************************************************
