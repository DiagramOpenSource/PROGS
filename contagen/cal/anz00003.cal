|FICHEROS;
  anz00003 #0;
  anm00008 #1;  || Empresas Analiticas
  anm00009 #2;  || Lineas
  anw00001 #4;  || Lineal de Empresas Analiticas
  cacuepre #9;
  caagrupr #10;

  canempre #30;
|FIN;

|VARIABLES;
  aAlfa1 = "";
  aAlfa2 = "";
  aAlfa3 = "";
  nNume1 = 0;
  VAlfa0 = "";
  VAlfa1 = "";
  VAlfa2 = "";
  VAlfa3 = "";
  VAlfa4 = "";

  aFichero = "";
  r_emp    = 0;
  r_per    = 0;
  swalta   = 0;
  contador = 0;
  noCALCULO= 0;
  nEjerActual = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoan_i;
|INCLUYE copian_i;

|| ******************************************************************
|| ************ CALCULO Campos en Pantalla

|CALCULO InicioAnz3; |TIPO 8;
 |HAZ InicioAna;
 |SI  enSwAna = 0; |ACABA;  |FINSI;

 aMonedaC = eaMoneda;
 |DBASE dir_fich;
 dir_fich = dir_fich + "fich/";
 aAlfa1 = ("000000" + #30#0) % -106;
 fich_copi = dir_fich + aAlfa1 + "/";
|FCAL;

|CALCULO consulta; |TIPO 0;
  |SI FSalida ! 9;  |ACABA;  |FINSI;
  |SUB_EJECUTA "caconemp";
  |SI r_emp ! 0;
      |ERROR;
      nNume1 = Campo + 2;
      #0Campo  = r_emp; |PINTA #0Campo;
      #0nNume1 = r_per; |PINTA #0nNume1;
      |PTEC 802;
  |SINO;
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO defectos; |TIPO 7;
  #0#2 = enPeriodo; |PINTA #0#2;
  #0#3 = enPeriodo; |PINTA #0#3;
|FCAL;

|| **************************************************************************
|| **************************************************************************
|| **************************************************************************

|CALCULO borrala;
 |BORRA 020#9a;
|FCAL;

|DEFBUCLE borrapresu;
 #9#1;
 ;
 #4#8, "            ", 0;
 #4#8, "zzzzzzzzzzzz", 9;
 e;
 NULL, borrala;
|FIN;

|CALCULO creala;
 |PARA nPara1 = 4; |SI nPara1 [ 16; |HACIENDO nPara1 = nPara1 + 1;
       impMoneda = #9nPara1; |HAZ ElCambioMoneda; #9nPara1 = impMoneda;
 |SIGUE;

 |GRABAENDEF VAlfa1, VAlfa2, 0,#9#0, 1,#9#1, 2,#9#2, 3,#9#3, 4,#9#4, 5,#9#5, 6,#9#6, 7,#9#7, 8,#9#8, 9,#9#9, 10,#9#10, 19,#9#19;
 |GRABAENDEF VAlfa1, VAlfa2, 0,#9#0, 1,#9#1, 11,#9#11, 12,#9#12, 13,#9#13, 14,#9#14, 15,#9#15, 16,#9#16, 17,#9#17, 18,#9#18, 19,#9#19;
 |PINTA 2248, #9#19;
 |PINTA 2251, #9#0;
|FCAL;

|DEFBUCLE creapresu;
 #9#1;
 ;
 #4#8,"            ", 0;
 #4#8,"zzzzzzzzzzzz", 9;
 e;
 NULL, creala;
|FIN;

|CALCULO pasapresu;
 |SI #0#5 = "N";
     |PINTA  2210, " Borrando Fichas Cuentas Presupuestos ...                      ";
     |PATH_DAT #9 fich_alta;
     |ABRET #9;
     |BUCLE borrapresu;
     |CIERRAT #9;
 |FINSI;

 |PATH_DAT #9  fich_copi;
 |PATH_DAT #10 fich_copi;
 |PINTA  2210, " Pasando Fichas Cuentas Presupuestos:                          ";

 |DDEF VAlfa0; |QBF VAlfa0;
 VAlfa1 = VAlfa0 + "cacuepre";      || DEF
 VAlfa2 = fich_alta + "cacuepre";   || Fichero de Datos
 VAlfa3 = VAlfa0 + "caagrupr";
 VAlfa4 = fich_alta + "caagrupr";

 |ABRE #10;
 |DDEFECTO #10;
 #10#0 = #4#8;
 |LEE 001#10=;
 |GRABAENDEF VAlfa3, VAlfa4, 0,#10#0, 1,#10#1;
 |CIERRA #10;

 |ABRET #9;
 |BUCLE creapresu;
 |CIERRAT #9;
|FCAL;

|| **********************************************************************
|CALCULO haztodo;
 swprogra = 1;
 |PINTA  2110, " Empresa:                                                      ";
 |PINTA  2210, "                                                               ";

 |PINTA 2120, #4#1;
 |PINTA 2126, #4#2;
 |PINTA 2128, #4#5;

 swalta = 0;
 |DBASE dir_fich;
 dir_fich = dir_fich + "fich/";
 aAlfa1 = #4#1; aAlfa1 = ("000000" + aAlfa1) % -105;
 aAlfa2 = #4#2; aAlfa2 =      ("0" + aAlfa2) % -101;
 fich_alta = dir_fich + aAlfa1 + aAlfa2 + "/";
 || ................ Solo en alta

 |SALVA_DATOS #30;
 |ABRE #30;
 |DDEFECTO #30;
 #30#2 = #4#1;
 #30#3 = #4#2;
 |LEE 001#30=;
 |SI FSalida ! 0;
     swalta = 1;
 |FINSI;
 |CIERRA #30;
 |REPON_DATOS #30;
 |SI swalta = 1; |HAZ altaEmp; |FINSI;
 aMonedaA = #canempre#28;

 |PINTA  2210, "                                                               ";

 |HAZ pasapresu;
|FCAL;

|DEFBUCLE creaEmpresa;
 #4#1;
 7;
 001,      "S";
 contador, "S";
 e;
 NULL, haztodo;
|FIN;

|| **************************************************************************
|| ************* Crea el Lineal para seleccion de Empresas
|PROCESO pasalo;
 |SI #1#7 ! 0;
     contador = contador + 1;
     #4#0 = contador;
     #4#1 = #1#0;
     #4#2 = #1#1;
     #4#3 = #1#2;
     #4#4 = #1#3;
     #4#5 = #1#4;
     #4#6 = #1#5;
     #4#7 = #0#4;
     #4#8 = #1#7;

     |GRABA 040#4n;
 |FINSI;
|FPRC;

|DEFBUCLE createmp;
 #1#1;
 ;
 #0#0, #0#2;
 #0#1, #0#3;
 e;
 NULL, pasalo;
|FIN;

|| *********** CALCULO dentro del Entlineal
|CALCULO pidetecla; |TIPO 11;
 |SI FSalida ! 9; |ACABA; |FINSI;
 |LIBERA #4;
 |LEE 110#4=;
 |SI #4#7 = "S";
     #4#7 = "N";
 |SINO;
     #4#7 = "S";
 |FINSI;
 |PINTA #4#7;
 |GRABA 020#4a;
 |PTEC  809;
|FCAL;

|RUTINA inferior;
 #4#0 = 1;
|FRUT;

|RUTINA superior;
 #4#0 = contador;
|FRUT;

|PROCESO linealEmp;
 noCALCULO = 0;
 |PINPA #0#4;
 |ENTLINEAL #1#4, -1, 4, 21, 0, inferior, superior;
 |SI FSalida ! 0; noCALCULO = 1; |ACABA; |FINSI;

 |CONFI "2400SDesea ejecutar el CALCULO : ";
 |SI FSalida ! 0; noCALCULO = 1; |FINSI;
|FPRC;


|| ***********************************************************************
|CALCULO pase; |TIPO 3;
  contador = 0;

  aFichero = ("zn" + Usuario) % 108;
  |NOME_DAT #4 aFichero;

  |ABRE #4;  |CIERRA #4;  |DELINDEX #4;

  |ABRE #4;
  |BUCLE createmp;
  |CIERRA #4;
  |SI contador  ! 0;
      |PUSHV 0501 2380;
      |HAZ linealEmp;
      |POPV;
      |SI noCALCULO = 0;
         |D_CUADRO 2009, 2373;
         |BUCLE creaEmpresa;
      |FINSI;
  |SINO;
      |MENAV "      No hay Empresas Analiticas Definidas ";
  |FINSI;
  |DELINDEX #4;
|FCAL;

|| ***********************************************************************
|| ........... Calculos Alta Empresa
|CALCULO altaEmp;
 |SI swalta = 0; |ACABA; |FINSI;
 |SALVA_DATOS #30;
 |ABRE #30;
 |PUSHV 2301 2380;
 #30#1  = #4#4;
 #30#2  = #4#1;
 #30#3  = #4#2;
 #30#26 = #4#3;
 nEjerActual = #30#26;
 || .................. clave
 nNume1 = ((#30#2*10) + #30#3);
 aAlfa1 = nNume1;
 aAlfa1 = ( "0000000" + aAlfa1 ) % -106;
 #30#0 = aAlfa1;

 #1#0 = #4#1; #1#1 = #4#2;
 #1#2 = #4#3; #1#3 = #4#4; #1#4 = #4#5;
 |HAZ CambiaNombre;

 |GRABA 020#30n;
 enEmpresa = #30#2;
 enPeriodo = #30#3;
 swOperacion = 3;
 eaMoneda = aMonedaC;
 |SUB_EJECUTA "camoneda";

|| .................................... mkdirector;
 |DBASE dir_fich;
 dir_fich = dir_fich + "fich/";
 aAlfa1 = ("000000" + #30#0) % -106;
 aAlfa3 = dir_fich + aAlfa1;
 |MKDIR aAlfa3;
 fich_alta = aAlfa3 + "/";
 dirfich0 = fich_alta;
 |CIERRA #30;

 eaCopiar = "M";
 |HAZ copia_maes;
 |HAZ acerar4;
 |HAZ pone0_maes;
 |HAZ ActDefecto;
 |HAZ NoTesteo;
 |HAZ AnaAltaEmp;
 |POPV;

 |REPON_DATOS #30;
|FCAL;
