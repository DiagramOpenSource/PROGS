|FICHEROS;
     dscsvm01;
     dscsvm02;
     dscsvm03;
     dscsvm04;
     dscsvm05;

     canempre;

     dscsvw01,MANTE;
     dscsvw02,MANTE;
     dscsvw04,MANTE;
     dscsvw06;
     dscsvw07;
     dscsvw10;

     camaasil;
     cacuenta;

     csvm03@;

     tmplec@ #0;
     tmpgra@ #1;
|FIN;

|VARIABLES;
     aAbre           = "";
     aLee            = "";
     aLong           = "";
     aLongVar        = "";
     aC10            = "";
     aC13            = "";
     aCarac          = "";
     aCarVar         = "";
     aVar            = "";
     aFicTmp         = "";
     aOrigen         = "";
     aDestino        = "";
     aIP             = "";
     aPathTmp        = "";
     aBase           = "";
     aCadena1        = "";
     aCadena2        = "";
     aMas            = "";
     aAlfa           = "";
     aAlfa1          = "";
     aAlfa2          = "";
     aAlfa3          = "";
     aTabla          = "";
     aFecha          = "";
     aContenido      = "";

     nLong           = 0;
     nLongVar        = 0;
     nCarac          = 0;
     nPos            = 0;
     nTotCmp         = 0;
     nCmp            = 0;
     nHandle         = 0;
     nAscci          = 0;
     nSacaInfor      = 0;
     nEncontrado     = 0;
     nError          = 0;
     nTCampos        = 0;
     nTValor         = 0;
     nPorce          = 0;
     nReg            = 0;
     nCampo          = 0;
     nDCampo         = 0;
     nDife           = 0;
     nPos1           = 0;
     nPos2           = 0;
     nPosVar         = 0;
     nCarVar         = 0;
     nBarra          = 0;
     nDia            = 0;
     nMes            = 0;
     nAny            = 0;
     nMasFilas       = 0;
     nHay            = 0;
     nDocu           = 0;
     nApun           = 0;
     nCancela        = 0;
     nNume           = 0;

     &enColum        = 0;
     &eaColum        = "";
     &eaCuenta       = "";
     &MaximoDigitos  = 0;
     &dig3           = 0;
|FIN;

|PROCESO SacaFilas;
     |SI #dscsvw02#2 = 0;  |Y #dscsvw02#5 = 0;  |Y #dscsvw02#8 = 0;
         |ACABA;
     |FINSI;

     |SI #dscsvw02#2 ! 0;
         #dscsvw10#0 = #dscsvw02#2;
         |LEE 000#dscsvw10.=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         aCadena1 = #dscsvw10#1;  |QBF aCadena1;
         aCadena2 = #dscsvw02#1;  |QBF aCadena2;
         |SI aCadena1 ! aCadena2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #dscsvw02#5 ! 0;
         #dscsvw10#0 = #dscsvw02#5;
         |LEE 000#dscsvw10.=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         aCadena1 = #dscsvw10#1;  |QBF aCadena1;
         aCadena2 = #dscsvw02#4;  |QBF aCadena2;
         |SI aCadena1 ! aCadena2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #dscsvw02#8 ! 0;
         #dscsvw10#0 = #dscsvw02#8;
         |LEE 000#dscsvw10.=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         aCadena1 = #dscsvw10#1;  |QBF aCadena1;
         aCadena2 = #dscsvw02#7;  |QBF aCadena2;
         |SI aCadena1 ! aCadena2;
             |ACABA;
         |FINSI;
     |FINSI;

     |LEE 000#dscsvw10.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          enColum     = #dscsvw10#0;  |HAZ SacaLetra;

          |DDEFECTO #dscsvm03;
          #dscsvm03#0 = #dscsvm02#0;
          #dscsvm03#1 = #dscsvm02#1;
          #dscsvm03#2 = #dscsvm02#2;
          #dscsvm03#3 = eaColum;
          #dscsvm03#4 = #dscsvw10#1;
          #dscsvm03#5 = enColum;
          |GRABA 020#dscsvm03.n;
          |LIBERA #dscsvm03;

          |LEE 000#dscsvw10.s;
     |SIGUE;

     nEncontrado = 1;
|FPRC;

|PROCESO dscsvw10Campos;
     nTCampos  = nTCampos + 1;
|FPRC;

|DEFBUCLE dscsvw10Campos;
     #dscsvw10#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dscsvw10Campos;
|FIN;

|PROCESO csvm03;
     #dscsvw10#0 = #csvm03@#5;
     |LEE 000#dscsvw10.=;
     |SI FSalida ! 0;
         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     aAlfa = #dscsvw10#1;  |QBF aAlfa;
     |SI aAlfa ! "";
         nTValor = nTValor + 1;
     |FINSI;

     |PULSATECLA;
|FPRC;

|DEFBUCLE csvm03;
     #csvm03@#2004;
     ;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 000;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 999;
     ;
     NULL, csvm03;
|FIN;

|PROCESO SacaDatosCond;
     #dscsvw10#0 = #dscsvm03#5;
     |LEE 000#dscsvw10.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aCadena1 = #dscsvw10#1;  |QBF aCadena1;
     aCadena2 = #dscsvm03#4;  |QBF aCadena2;
     |SI aCadena1 = aCadena2;
         |ACABA;
     |FINSI;

     nTCampos  = 0;
     |BUCLE dscsvw10Campos;

     nError   = 0;
     nTValor  = 0;
     |BUCLE csvm03;
     |SI nError = 1;           |ACABA;  |FINSI;
     |SI nTCampos < nTValor;   |ACABA;  |FINSI;

     nPorce = ((nTValor * 100) / nTCampos) ! 0;
     |SI nPorce < 70;  |ACABA;  |FINSI;

     #dscsvw10#0 = #dscsvm03#5;
     |LEE 000#dscsvw10.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aCadena1 = #dscsvw10#1;   |QBF aCadena1;
     aCadena2 = #dscsvm03#17;  |QBF aCadena2;
     aAlfa    = aCadena1 - aCadena2;

     #dscsvm04#0 = #dscsvm03#0;
     #dscsvm04#1 = #dscsvm03#1;
     #dscsvm04#2 = #dscsvm03#2;
     #dscsvm04#3 = #dscsvm03#3;
     #dscsvm04#4 = aAlfa;
     |LEE 000#dscsvm04.=;
     |SI FSalida ! 0;
         |DDEFECTO #dscsvm04;
         #dscsvm04#0 = #dscsvm03#0;
         #dscsvm04#1 = #dscsvm03#1;
         #dscsvm04#2 = #dscsvm03#2;
         #dscsvm04#3 = #dscsvm03#3;
         #dscsvm04#4 = aAlfa;

         |GRABA 020#dscsvm04.n;
         |LIBERA #dscsvm04;
     |FINSI;
|FPRC;

|PROCESO CalculaCuenta;
     |QBF eaCuenta;
     |SI eaCuenta = "";  |ACABA;  |FINSI;

     aLongVar = eaCuenta % 0;
     nLongVar = aLongVar;

     |SI nLongVar ! MaximoDigitos;
         nDife = MaximoDigitos - nLongVar;
         |SI nDife < 0;  |ACABA;  |FINSI;

         |SI #dscsvm03#15 = 0;
             eaCuenta = eaCuenta + ("0" * nDife);
         |SINO;
             nPos1 = 100 + #dscsvm03#15;
             nPos2 = (100 * (#dscsvm03#15 + 1)) + 99;
             aAlfa = (eaCuenta % nPos1) + ("0" * nDife) + (eaCuenta % nPos2);
             eaCuenta = aAlfa;
         |FINSI;
     |FINSI;

     |HAZ SacaNivel;
|FPRC;

|PROCESO CalculaFecha;
     |QBT aFecha;
     aLongVar = aFecha % 0;
     nLongVar = aLongVar;
     nBarra   = 0;
     aAlfa1   = "";
     aAlfa2   = "";
     aAlfa3   = "";
     |PARA nCarVar = 1;  |SI nCarVar [ nLongVar;  |HACIENDO nCarVar = nCarVar + 1;
           nPosVar = (nCarVar * 100) + 1;
           aCarVar = aFecha % nPosVar;

           |SI  aCarVar = "0"; |O aCarVar = "1"; |O aCarVar = "2";
             |O aCarVar = "3"; |O aCarVar = "4"; |O aCarVar = "5";
             |O aCarVar = "6"; |O aCarVar = "7"; |O aCarVar = "8";
             |O aCarVar = "9";
                |SI nBarra = 0;  aAlfa1 = aAlfa1 + aCarVar;  |FINSI;
                |SI nBarra = 1;  aAlfa2 = aAlfa2 + aCarVar;  |FINSI;
                |SI nBarra = 2;  aAlfa3 = aAlfa3 + aCarVar;  |FINSI;
           |SINO;
                |SI aCarVar = ".";  |O aCarVar = "/";  |O aCarVar = "\";
                    nBarra = nBarra + 1;
               |FINSI;
           |FINSI;
      |SIGUE;

      |QBF aAlfa1;
      |QBF aAlfa2;
      |QBF aAlfa3;

      nDia = 0;
      nMes = 0;
      nAny = 0;

      aAlfa = #dscsvm03#8 + #dscsvm03#9;  |QBF aAlfa;
      |SI aAlfa = "DD";  nDia = aAlfa1;  |FINSI;
      |SI aAlfa = "MM";  nMes = aAlfa1;  |FINSI;
      |SI aAlfa = "AA";  nAny = aAlfa1;  |FINSI;

      aAlfa = #dscsvm03#10 + #dscsvm03#11;  |QBF aAlfa;
      |SI aAlfa = "DD";  nDia = aAlfa2;  |FINSI;
      |SI aAlfa = "MM";  nMes = aAlfa2;  |FINSI;
      |SI aAlfa = "AA";  nAny = aAlfa2;  |FINSI;

      aAlfa = #dscsvm03#12 + #dscsvm03#13;  |QBF aAlfa;
      |SI aAlfa = "DD";  nDia = aAlfa3;  |FINSI;
      |SI aAlfa = "MM";  nMes = aAlfa3;  |FINSI;
      |SI aAlfa = "AA";  nAny = aAlfa3;  |FINSI;

      |SI #dscsvm03#14 = "2";  |Y nAny ! 0;
          nAny = 2000 + nAny;
      |FINSI;

      |SI nDia = 0;  nDia = 1;                    |FINSI;
      |SI nMes = 0;  nMes = 1;                    |FINSI;
      |SI nAny = 0;  nAny = 2000 + #canempre#26;  |FINSI;

      aFecha = (("00" + nDia) % -102);
      aFecha = aFecha + "." + (("00" + nMes) % -102);
      aFecha = aFecha + "." + (("0000" + nAny) % -104);
|FPRC;

|PROCESO QuitaPuntos;
     |QBT aAlfa;
     aLongVar = aAlfa % 0;
     nLongVar = aLongVar;
     aAlfa1   = "";
     |PARA nCarVar = 1;  |SI nCarVar [ nLongVar;  |HACIENDO nCarVar = nCarVar + 1;
           nPosVar = (nCarVar * 100) + 1;
           aCarVar = aAlfa % nPosVar;

           |SI  aCarVar ! ".";
                aAlfa1 = aAlfa1 + aCarVar;
           |FINSI;
      |SIGUE;

      aAlfa = aAlfa1;
|FPRC;

|PROCESO DatosCacuenta;
     |SI nCampo = 1;
         eaCuenta = #dscsvw07#1;  |HAZ CalculaCuenta;

         #dscsvw07#1 = eaCuenta;
         #dscsvw07#2 = dig3;
     |FINSI;
|FPRC;

|PROCESO DatosCamaasil;
     |SI nCampo = 2;  |O nCampo = 31;
         aFecha = #dscsvw06#nCampo#;  |HAZ CalculaFecha;

         #dscsvw06#nCampo# = aFecha;
     |FINSI;

     |SI nCampo = 5;
         eaCuenta = #dscsvw06#5;  |HAZ CalculaCuenta;

         #dscsvw06#5 = eaCuenta;
         #dscsvw06#6 = dig3;
     |FINSI;

     |SI nCampo = 30;
         eaCuenta = #dscsvw06#30;  |HAZ CalculaCuenta;

         #dscsvw06#30 = eaCuenta;
     |FINSI;

     |SI nCampo = 10;
         |SI #dscsvm03#16 = "D";  #dscsvw06#9 = "D";  |FINSI;
         |SI #dscsvm03#16 = "H";  #dscsvw06#9 = "H";  |FINSI;
     |FINSI;
|FPRC;

|PROCESO dscsvm05Imp;
     nHay   = 1;
     nCampo = #dscsvm05#5 + 1;

     |SI #dscsvm03#1 = "camaasil";
         #dscsvw06#nCampo# = #dscsvm05#7;
     |FINSI;

     |SI #dscsvm03#1 = "cacuenta";
         #dscsvw07#nCampo# = #dscsvm05#7;
     |FINSI;
|FPRC;

|DEFBUCLE dscsvm05Imp;
     #dscsvm05#1;
     ;
     #dscsvm04#0, #dscsvm04#1, #dscsvm04#2, #dscsvm04#3, #dscsvm04#4, 000;
     #dscsvm04#0, #dscsvm04#1, #dscsvm04#2, #dscsvm04#3, #dscsvm04#4, 999;
     ;
     NULL, dscsvm05Imp;
|FIN;

|PROCESO LeeContenido;
     #dscsvm04#0 = #dscsvm03#0;
     #dscsvm04#1 = #dscsvm03#1;
     #dscsvm04#2 = #dscsvm03#2;
     #dscsvm04#3 = #dscsvm03#3;
     #dscsvm04#4 = aContenido;
     |LEE 000#dscsvm04.=;
     |SI FSalida = 0;
         |BUCLE dscsvm05Imp;
     |FINSI;
|FPRC;

|PROCESO Contenidos;
     nHay   = 0;

     aContenido = aAlfa;  |QBF aContenido;
     |HAZ LeeContenido;
     |SI nHay = 1;  |ACABA;  |FINSI;

     aLongVar = aAlfa % 0;
     nLongVar = aLongVar;
     aAlfa1   = "";
     |PARA nCarVar = 1;  |SI nCarVar [ nLongVar;  |HACIENDO nCarVar = nCarVar + 1;
           nPosVar = (nCarVar * 100) + 1;
           nPosVar = -nPosVar;
           aCarVar = aAlfa % nPosVar;

           |SI aCarVar = " ";
                nPosVar    = (nCarVar * 100) + 99;
                nPosVar    = -nPosVar;
                aContenido = aAlfa % nPosVar;
                |QBF aContenido;
                |HAZ LeeContenido;
                |SI nHay = 1;  |SAL;  |FINSI;
           |FINSI;
     |SIGUE;

     |SI nHay = 1;  |ACABA;  |FINSI;

     aContenido = " *GENERICO";  |QBF aContenido;
     |HAZ LeeContenido;
|FPRC;

|PROCESO dscsvm03Imp;
     #dscsvw10#0 = #dscsvm03#5;
     |LEE 000#dscsvw10.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     aAlfa = #dscsvw10#1;  |QBF aAlfa;
     |SI aAlfa = "";
         |ACABA;
     |FINSI;

     aAlfa = #dscsvm03#6;  |QBF aAlfa;
     |SI aAlfa = "";
         |ACABA;
     |FINSI;

     aCadena1 = #dscsvw10#1;  |QBF aCadena1;
     aCadena2 = #dscsvm03#4;  |QBF aCadena2;
     |SI aCadena1 = aCadena2;
         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     aCadena1 = #dscsvw10#1;   |QBF aCadena1;
     aCadena2 = #dscsvm03#17;  |QBF aCadena2;
     aAlfa    = aCadena1 - aCadena2;

     nCampo = #dscsvm03#7 + 1;

     |SI #dscsvm03#1 = "camaasil";
         |SI nCampo = 10;
             |HAZ QuitaPuntos;
             nNume = aAlfa;
             |SI nNume = 0;  |ACABA;  |FINSI;
         |FINSI;

         #dscsvw06#nCampo# = aAlfa;
         |HAZ Contenidos;
         |HAZ DatosCamaasil;
     |FINSI;

     |SI #dscsvm03#1 = "cacuenta";
         #dscsvw07#nCampo# = aAlfa;
         |HAZ Contenidos;
         |HAZ DatosCacuenta;
     |FINSI;

     |PULSATECLA;
|FPRC;

|DEFBUCLE dscsvm03Imp;
     #dscsvm03#2;
     ;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 000;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 999;
     ;
     NULL, dscsvm03Imp;
|FIN;

|PROCESO SacaDatosPuente;
     nTCampos  = 0;
     |BUCLE dscsvw10Campos;

     nError   = 0;
     nTValor  = 0;
     |BUCLE csvm03;
     |SI nError = 1;           |ACABA;  |FINSI;
     |SI nTCampos < nTValor;   |ACABA;  |FINSI;

     nPorce = ((nTValor * 100) / nTCampos) ! 0;
     |SI nPorce < 70;  |ACABA;  |FINSI;

     |SI #dscsvm02#1 = "camaasil";
         |SI #dscsvm02#3 = "S";
             |DDEFECTO #dscsvw06;

             nError = 0;
             |BUCLE dscsvm03Imp;
             |SI nError = 1;  |ACABA;  |FINSI;

             #dscsvw06#0 = nReg;
             #dscsvw06#32 = #dscsvm02#2;
             |GRABA 020#dscsvw06.n;
             |LIBERA #dscsvw06;
         |FINSI;
     |FINSI;

     |SI #dscsvm02#1 = "cacuenta";
         |SI #dscsvm02#3 = "S";
             |DDEFECTO #dscsvw07;

             nError = 0;
             |BUCLE dscsvm03Imp;
             |SI nError = 1;  |ACABA;  |FINSI;

             #dscsvw07#0 = nReg;
             #dscsvw07#4 = #dscsvm02#2;
             |GRABA 020#dscsvw07.n;
             |LIBERA #dscsvw07;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaDatosOtrasFilas;
     nTCampos  = 0;
     |BUCLE dscsvw10Campos;

     nError   = 0;
     nTValor  = 0;
     |BUCLE csvm03;
     |SI nError = 1;           |ACABA;  |FINSI;
     |SI nTCampos < nTValor;   |ACABA;  |FINSI;

     nPorce = ((nTValor * 100) / nTCampos) ! 0;
     |SI nPorce < 70;  |ACABA;  |FINSI;

     |SI #dscsvm02#1 = "camaasil";
         |DDEFECTO #dscsvw06;

         nError = 0;
         |BUCLE dscsvm03Imp;
         |SI nError = 1;  |ACABA;  |FINSI;

         #dscsvw06#0  = nReg;
         #dscsvw06#32 = #dscsvm02#2;
         |GRABA 020#dscsvw06.n;
         |LIBERA #dscsvw06;
     |FINSI;

     |SI #dscsvm02#1 = "cacuenta";
         |DDEFECTO #dscsvw07;

         nError = 0;
         |BUCLE dscsvm03Imp;
         |SI nError = 1;  |ACABA;  |FINSI;

         #dscsvw07#0  = nReg;
         #dscsvw07#4  = #dscsvm02#2;
         |GRABA 020#dscsvw07.n;
         |LIBERA #dscsvw07;
     |FINSI;
|FPRC;

|PROCESO GrabaDatos;
     |SI nSacaInfor = 1;
         |HAZ SacaFilas;
     |FINSI;

     |SI nSacaInfor = 2;
         |HAZ SacaDatosCond;
     |FINSI;

     |SI nSacaInfor = 3;
         nReg = nReg + 1;
         |HAZ SacaDatosPuente;
     |FINSI;

     |SI nSacaInfor = 4;
         nReg = nReg + 1;
         |HAZ SacaDatosOtrasFilas;
     |FINSI;

     |CIERRA #dscsvw10;  |DELINDEX #dscsvw10;
|FPRC;

|PROCESO Grabaw10;
     |OEM_ANSI aVar, aVar;

     |SI nSacaInfor > 1;
         |SELECT #2#csvm03@;
         #csvm03@#0 = #dscsvm02#0;
         #csvm03@#1 = #dscsvm02#1;
         #csvm03@#2 = #dscsvm02#2;
         #csvm03@#5 = nCmp;
         |LEE 000#csvm03@.=;
         |SI FSalida ! 0;
             |SI aVar = "";
                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     #dscsvw10#0 = nCmp;
     #dscsvw10#1 = aVar;
     |GRABA 020#dscsvw10.n;
     |LIBERA #dscsvw10;
|FPRC;

|PROCESO SacaDatos;
     aLong  = aLee % 0;
     nLong  = aLong;
     aC10   = &10;
     aC13   = &13;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac = aLee % nPos;

           |SI aCarac = aC13;
               aCarac = ";";
           |FINSI;

           |SI aCarac = ";";
               nCmp   = nCmp + 1;
               |HAZ Grabaw10;

               aVar   = "";
               aCarac = "";
           |FINSI;

           |SI aCarac = aC10;
               |SI nTotCmp = 0;  |Y nCmp ! 0;
                   nTotCmp = nCmp;
               |FINSI;

               aCarac = "";
           |FINSI;

           |SI nCmp = nTotCmp;  |Y nCmp ! 0;
               |HAZ GrabaDatos;

               |CIERRA #dscsvw10;
               |DELINDEX #dscsvw10;

               |ABRE #dscsvw10;

               nCmp = 0;
           |FINSI;

           aVar = aVar + aCarac;
      |SIGUE;
|FPRC;

|PROCESO LeeCSV;
     |ABRE #dscsvw10;  |CIERRA #dscsvw10;  |DELINDEX #dscsvw10;
     |ABRE #dscsvw10;

     nCmp       = 0;
     aVar       = "";
     nSacaInfor = 3;

     #dscsvm02#0 = #dscsvm01#0;
     #dscsvm02#1 = aTabla;
     #dscsvm02#2 = 50;
     |LEE 000#dscsvm02.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nReg     = 0;
     nTotCmp  = 0;

     |XABRE "B", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 255, aLee;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |HAZ SacaDatos;
     |SIGUE;
     |XCIERRA nHandle;

     |LEE 000#dscsvw10.p;
     |SI FSalida = 0;
         nCmp   = nCmp + 1;
         |HAZ Grabaw10;
         |HAZ GrabaDatos;
     |FINSI;

     |ABRE #dscsvw10; |CIERRA #dscsvw10; |DELINDEX #dscsvw10;

     nMasFilas  = 0;
     nSacaInfor = 4;
     nReg       = 0;

     #dscsvm02#0 = #dscsvm01#0;
     #dscsvm02#1 = aTabla;
     #dscsvm02#2 = 1;
     |LEE 000#dscsvm02.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #dscsvm02#0 ! #dscsvm01#0;  |SAL;  |FINSI;
          |SI #dscsvm02#1 ! aTabla;       |SAL;  |FINSI;
          |SI #dscsvm02#2 ! 50;
              nMasFilas  = 1;
              |ABRE #dscsvw10;

              nReg     = 0;
              nTotCmp  = 0;

              |XABRE "B", aAbre, nHandle;
              |PARA;  |SI;  |HACIENDO;
                   |XLEE nHandle, 255, aLee;
                   |SI FSalida [ 0;  |SAL;  |FINSI;

                   |HAZ SacaDatos;
              |SIGUE;
              |XCIERRA nHandle;

              |LEE 000#dscsvw10.p;
              |SI FSalida = 0;
                  nCmp   = nCmp + 1;
                  |HAZ Grabaw10;
                  |HAZ GrabaDatos;
              |FINSI;

              |ABRE #dscsvw10; |CIERRA #dscsvw10; |DELINDEX #dscsvw10;
          |FINSI;

          |LEE 000#dscsvm02.s;
     |SIGUE;
|FPRC;

|PROCESO dscsvm03Ref;
     aAlfa = #dscsvm03#6;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     nCampo = #dscsvm03#7 + 1;

     |SI #dscsvm02#1 = "camaasil";
         #tmpgra@#nCampo# = #dscsvw06#nCampo#;
     |FINSI;

     |SI #dscsvm02#1 = "cacuenta";
         #tmpgra@#nCampo# = #dscsvw07#nCampo#;
     |FINSI;
|FPRC;

|DEFBUCLE dscsvm03Ref;
     #dscsvm03#2;
     ;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 000;
     #dscsvm02#0, #dscsvm02#1, #dscsvm02#2, 999;
     ;
     NULL, dscsvm03Ref;
|FIN;

|PROCESO dscsvw06Ref;
     |SI #dscsvw06#32 = 50;
         |ACABA;
     |FINSI;

     #dscsvm02#0 = #dscsvm01#0;
     #dscsvm02#1 = aTabla;
     #dscsvm02#2 = #dscsvw06#32;
     |LEE 000#dscsvm02.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #dscsvw06#32 < 50;
         |BORRA 020#dscsvw06.a;
         |LIBERA #dscsvw06;
     |FINSI;

     |LEE 000#tmplec@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #tmplec@#32 ! 50;
              |SAL;
          |FINSI;

          |PARA nCampo = 0;  |SI nCampo [ 32;  |HACIENDO nCampo = nCampo + 1;
                 #tmpgra@#nCampo# = #tmplec@#nCampo#
          |SIGUE;

          |BUCLE dscsvm03Ref;

          |GRABA 020#tmpgra@.n;
          |LIBERA #tmpgra@;

          |BORRA 020#tmplec@.a;
          |LIBERA #tmplec@;

          |LEE 000#tmplec@.s;
     |SIGUE;

     |SI #dscsvw06#32 > 50;
         |BORRA 020#dscsvw06.a;
         |LIBERA #dscsvw06;
     |FINSI;
|FPRC;

|PROCESO RefundeFilasW06;
     |DDEF aMas;
     aMas = aMas + "dscsvw06.mas";
     |CARGA_DEF aMas, tmplec@;
     |CARGA_DEF aMas, tmpgra@;

     aFicTmp = "dscsvw06" + Usuario;  |NOME_DAT #tmplec@#aFicTmp#;
     aFicTmp = "grcsvw06" + Usuario;  |NOME_DAT #tmpgra@#aFicTmp#;

     |ABRE #tmplec@;
     |ABRE #tmpgra@;
     |ABRE #dscsvw06;

     |LEE 000#dscsvw06.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
             |HAZ dscsvw06Ref;

             |LEE 000#dscsvw06.s;
     |SIGUE;

     |CIERRA #dscsvw06;
     |CIERRA #tmplec@;
     |CIERRA #tmpgra@;

     |DELINDEX #dscsvw06;

     |DESCARGA_DEF #tmpgra@;
     |DESCARGA_DEF #tmplec@;

     aFicTmp = "grcsvw06" + Usuario;  |NOME_DAT #dscsvw06#aFicTmp#;
|FPRC;

|PROCESO dscsvw06Cheq;
     aAlfa = #dscsvw06#2;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Registros con fecha de apunte sin contenido. Cancelamos la importaci¢n";

         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI #dscsvw06#3 = 0;
         |MENAV "0000Registros con n£mero documento a cero. Cancelamos la importaci¢n";

         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     aAlfa = #dscsvw06#5;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Registros con cuentas sin contenido. Cancelamos la importaci¢n";

         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI #dscsvw06#9 = " ";
         |MENAV "0000Registros sin signo en la cuenta. Cancelamos la importaci¢n";

         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI #dscsvw06#9 = "D";
         #dscsvw06#17 = #dscsvw06#5;
         #dscsvw06#18 = #dscsvw06#6;
     |FINSI;

     |SI #dscsvw06#9 = "H";
         #dscsvw06#11 = #dscsvw06#5;
         #dscsvw06#12 = #dscsvw06#6;
     |FINSI;

     |SI #dscsvw06#22 = "  ";
         #dscsvw06#22 = "01";
     |FINSI;

     |SI nDocu ! #dscsvw06#3;
         nApun = 0;
     |FINSI;

     nApun = nApun + 1;
     #dscsvw06#4 = nApun;
     |GRABA 020#dscsvw06.a;
     |LIBERA #dscsvw06;

     nDocu = #dscsvw06#3;
|FPRC;

|DEFBUCLE dscsvw06Cheq;
     #dscsvw06#2;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dscsvw06Cheq;
|FIN;

|PROCESO dscsvw06Gra;
     |PARA nCampo = 1;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
           nDCampo = nCampo - 1;
           #camaasil#nDCampo# = #dscsvw06#nCampo#
     |SIGUE;

     |GRABA 020#camaasil.n;
     |LIBERA #camaasil;
|FPRC;

|DEFBUCLE dscsvw06Gra;
     #dscsvw06#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dscsvw06Gra;
|FIN;

|PROCESO TrataCamaasil;
     nCancela = 1;

     aAbre = #dscsvw01#1;  |QBF aAbre;
     |SI aAbre = "";  |ACABA;  |FINSI;

     |ABRE #dscsvw06;
     aTabla = "camaasil";
     |HAZ LeeCSV;
     |CIERRA #dscsvw06;

     |SI nMasFilas = 1;
         |HAZ RefundeFilasW06;
     |FINSI;

     nError = 0;
     |BUCLE dscsvw06Cheq;
     |SI nError = 1;
         aAlfa =  "0000SNo puedo realizar la importaci¢n ya que hay ";
         aAlfa = aAlfa + "campos importantes sin contenido. ";
         aAlfa = aAlfa + "Quiere consultar los registros. ";
         |CONFI aAlfa;
         |SI FSalida = 0;
            |ABRE #dscsvw06;
            |CONSULTA_CLAVE #1#dscsvw06;
            |CIERRA #dscsvw06;
         |FINSI;
         |DELINDEX #dscsvw06;

         |ACABA;
     |FINSI;

     |CONFI "0000SRegistro de movimientos preparados para importar. Quiere consultarlos antes?";
     |SI FSalida = 0;
         |ABRE #dscsvw06;
         |CONSULTA_CLAVE #1#dscsvw06;
         |CIERRA #dscsvw06;

         |CONFI "0000SContinuamos con la importaci¢n?";
         |SI FSalida ! 0;
             |CIERRA #dscsvw06;  |DELINDEX #dscsvw06;
         |FINSI;
     |FINSI;

     |BUCLE dscsvw06Gra;

     |CIERRA #dscsvw06;  |DELINDEX #dscsvw06;

     nCancela = 0;
|FPRC;

|PROCESO dscsvw07Ref;
     |SI #dscsvw06#4 = 50;
         |ACABA;
     |FINSI;

     #dscsvm02#0 = #dscsvm01#0;
     #dscsvm02#1 = aTabla;
     #dscsvm02#2 = #dscsvw07#4;
     |LEE 000#dscsvm02.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #dscsvw07#4 < 50;
         |BORRA 020#dscsvw07.a;
         |LIBERA #dscsvw07;
     |FINSI;

     |LEE 000#tmplec@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #tmplec@#4 ! 50;
              |SAL;
          |FINSI;

          |PARA nCampo = 0;  |SI nCampo [ 4;  |HACIENDO nCampo = nCampo + 1;
                 #tmpgra@#nCampo# = #tmplec@#nCampo#
          |SIGUE;

          |BUCLE dscsvm03Ref;

          |GRABA 020#tmpgra@.n;
          |LIBERA #tmpgra@;

          |BORRA 020#tmplec@.a;
          |LIBERA #tmplec@;

          |LEE 000#tmplec@.s;
     |SIGUE;

     |SI #dscsvw07#4 > 50;
         |BORRA 020#dscsvw07.a;
         |LIBERA #dscsvw07;
     |FINSI;
|FPRC;

|PROCESO RefundeFilasW07;
     |DDEF aMas;
     aMas = aMas + "dscsvw07.mas";
     |CARGA_DEF aMas, tmplec@;
     |CARGA_DEF aMas, tmpgra@;

     aFicTmp = "dscsvw07" + Usuario;  |NOME_DAT #tmplec@#aFicTmp#;
     aFicTmp = "grcsvw07" + Usuario;  |NOME_DAT #tmpgra@#aFicTmp#;

     |ABRE #tmplec@;
     |ABRE #tmpgra@;
     |ABRE #dscsvw07;

     |LEE 000#dscsvw07.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
             |HAZ dscsvw07Ref;

             |LEE 000#dscsvw07.s;
     |SIGUE;

     |CIERRA #dscsvw07;
     |CIERRA #tmplec@;
     |CIERRA #tmpgra@;

     |DELINDEX #dscsvw07;

     |DESCARGA_DEF #tmpgra@;
     |DESCARGA_DEF #tmplec@;

     aFicTmp = "grcsvw07" + Usuario;  |NOME_DAT #dscsvw07#aFicTmp#;
|FPRC;

|PROCESO dscsvw07Cheq;
     aAlfa = #dscsvw07#0;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Registros con cuentas sin contenido. Cancelamos la importaci¢n";

         nError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE dscsvw07Cheq;
     #dscsvw07#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dscsvw07Cheq;
|FIN;

|PROCESO dscsvw07Gra;
     #cacuenta#0 = #dscsvw07#1;
     |LEE 000#cacuenta.=;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     #cacuenta#0 = #dscsvw07#1;
     #cacuenta#1 = #dscsvw07#2;
     #cacuenta#2 = #dscsvw07#3;

     |GRABA 020#cacuenta.n;
     |LIBERA #cacuenta;
|FPRC;

|DEFBUCLE dscsvw07Gra;
     #dscsvw07#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dscsvw07Gra;
|FIN;

|PROCESO TrataCacuenta;
     aAbre = #dscsvw01#0;  |QBF aAbre;
     |SI aAbre = "";  |ACABA;  |FINSI;

     nCancela = 1;

     |ABRE #dscsvw07;
     aTabla = "cacuenta";
     |HAZ LeeCSV;
     |CIERRA #dscsvw07;

     |SI nMasFilas = 1;
         |HAZ RefundeFilasW07;
     |FINSI;

     nError = 0;
     |BUCLE dscsvw07Cheq;
     |SI nError = 1;
         aAlfa =  "0000SNo puedo realizar la importaci¢n ya que hay ";
         aAlfa = aAlfa + "campos importantes sin contenido. ";
         aAlfa = aAlfa + "Quiere consultar los registros. ";
         |CONFI aAlfa;
         |SI FSalida = 0;
            |ABRE #dscsvw07;
            |CONSULTA_CLAVE #1#dscsvw07;
            |CIERRA #dscsvw07;
         |FINSI;
         |DELINDEX #dscsvw07;

         |ACABA;
     |FINSI;

     |CONFI "0000SRegistro de cuentas preparados para importar. Quiere consultarlos antes?";
     |SI FSalida = 0;
         |ABRE #dscsvw07;
         |CONSULTA_CLAVE #1#dscsvw07;
         |CIERRA #dscsvw07;

         |CONFI "0000SContinuamos con la importaci¢n?";
         |SI FSalida ! 0;
             |CIERRA #dscsvw07;  |DELINDEX #dscsvw07;
         |FINSI;
     |FINSI;

     |BUCLE dscsvw07Gra;

     |CIERRA #dscsvw07;  |DELINDEX #dscsvw07;

     nCancela = 0;
|FPRC;

|PROCESO Importacion;
     |ABRET #camaasil;
     |LEE 000#camaasil.p;
     |SI FSalida = 0;
         |MENAV "0000Ya existe movimientos en esta empresa/periodo. Cancelamos la importaci¢n";
         |CIERRAT #camaasil;
         |ACABA;
     |FINSI;

     |ABRET #cacuenta;

     |HAZ inicio;

     aIP = "";
     |IP_REMOTO aIP;

     aFicTmp = "dscsvw10" + Usuario;  |NOME_DAT #dscsvw10#aFicTmp#;
     aFicTmp = "dscsvw06" + Usuario;  |NOME_DAT #dscsvw06#aFicTmp#;
     aFicTmp = "dscsvw07" + Usuario;  |NOME_DAT #dscsvw07#aFicTmp#;

     |ABRE #dscsvw06;  |CIERRA #dscsvw06;  |DELINDEX #dscsvw06;
     |ABRE #dscsvw07;  |CIERRA #dscsvw07;  |DELINDEX #dscsvw07;

     |DBASE aBase;  |QBF aBase;
     aPathTmp = aBase + "tmp";  |MKDIR aPathTmp;
     aPathTmp = aBase + "tmp/";

     |DDEF aMas;
     aMas = aMas + "dscsvm03.mas";
     |CARGA_DEF aMas, csvm03@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nCancela = 0;
     |ABRET #csvm03@;
     |HAZ TrataCacuenta;

     |SI nCancela = 0;
         |HAZ TrataCamaasil;
     |FINSI;

     |CIERRAT #csvm03@;
     |DESCARGA_DEF #csvm03@;

     |CIERRAT #cacuenta;
     |CIERRAT #camaasil;

     |SI nCancela = 0;
         aAlfa = "*:contagen/careccab canempr1 " + (("00000" + #48#2) % -105) + #48#3 + ";" + "CREA";
         |SUB_EJECUTA aAlfa;

         aAlfa = "*:contagen/carecupe canempr1 " + (("00000" + #48#2) % -105) + #48#3 + ";" + "CREA";
         |SUB_EJECUTA aAlfa;
     |FINSI;
|FPRC;

|PROCESO LeeFichero;
     |SI #dscsvm02#1 = "cacuenta";  aAbre = #dscsvm01#2;  |FINSI;
     |SI #dscsvm02#1 = "camaasil";  aAbre = #dscsvm01#3;  |FINSI;

     |QBF aAbre;
     |SI aAbre = "";  |ACABA;  |FINSI;

     aFicTmp = "dscsvw10" + Usuario;
     |NOME_DAT #dscsvw10#aFicTmp#;

     |ABRE #dscsvw10;  |CIERRA #dscsvw10;  |DELINDEX #dscsvw10;
     |ABRE #dscsvw10;

     nCmp = 0;
     aVar = "";

     eaColum = #dscsvw02#0;  |HAZ SacaNumero;  #dscsvw02#2 = enColum;
     eaColum = #dscsvw02#3;  |HAZ SacaNumero;  #dscsvw02#5 = enColum;
     eaColum = #dscsvw02#6;  |HAZ SacaNumero;  #dscsvw02#8 = enColum;

     nEncontrado = 0;
     nReg        = 0;
     nTotCmp     = 0;

     |XABRE "B", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 255, aLee;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |HAZ SacaDatos;

          |SI nEncontrado = 1;  |SAL;  |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |ABRE #dscsvw10; |CIERRA #dscsvw10; |DELINDEX #dscsvw10;
|FPRC;

|PROCESO CargaAut;
     nSacaInfor = 1;
     |HAZ LeeFichero;
|FPRC;

|PROCESO RellenaCondicion;
     |DDEF aMas;
     aMas = aMas + "dscsvm03.mas";
     |CARGA_DEF aMas, csvm03@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |ABRET #csvm03@;

     nSacaInfor = 2;
     |HAZ LeeFichero;

     |CIERRAT #csvm03@;
     |DESCARGA_DEF #csvm03@;
|FPRC;
