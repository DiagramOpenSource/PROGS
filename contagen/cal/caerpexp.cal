|FICHEROS;
   caerpexp #0;
   caerpnif;
   caerptmp #10;
   caerptm1 #11;
   caerpcfg #12;
   caerpcf1 #13;
   caerpcf2 #14;
   caerpcf3 #15;

   caenlace #50;
   caconasi #51;
   camaasic #52;
   camaniva #53;
   caclipro #54;
   caw00046 #55,MANTE;
   caw00047 #56,MANTE;
   caw00048 #57,MANTE;
   caivaasi #58;
   calincob #59;
   calinpag #60;
   &Puente@ #61;
   caforpag #62;

   FCaenla@ #1000;
   FConasi@ #1001;
   canempr@ #1110;
   Referen@ #1200;

   &regisnif@ #709;
   :/basica/def/agim0003  #710;
   :/integral/def/dsam0103 #711;
   &sgpaises@ #718;

     agifa024@;
     dsam052@;
     agifa041@;
     agifa142@;
     dsm00225@;
     dsm00003@;
     :/modelos/def/dsmom030;

     caenlace@;

    cacuenta;
    ca8cumay;
    cacuebal;
    ca8m0002;
|FIN;

|VARIABLES;
   &enEmpresa   = 0;
   &eNum2008    = 0;
   &enEjercicio = 0;
   &enEjerBal   = 0;
   &emEmp       = 0;
   &cod1        = 0;
   &cod2       = 0;
   mascara      = "";

   &decim_base     = 0; || Decimales de la moneda base
   &precio_base    = 0; || Decimales del precio en moneda base
   &decim_divisa   = 0; || Decimales de la divisa
   &precio_divisa  = 0; || Decimales del precio en divisa
   &nDeci_Base     = 0; || Decimales en Totales de la moneda base
   &nDeci_PreBase  = 0; || Decimales en el Precio en moneda base
   &nDeci_BaseMx   = 0; || Decimales en Totales de la moneda base
   &nDeci_PreBaseMx= 0; || Decimales en el Precio en moneda base
   &nDeci_DivF     = 0; || Decimales en Totales de la divisa
   &nDeci_PreDivF  = 0; || Decimales en el Precio en divisa
   &nDeci_TotVisF  = 0; || Decimales en Totales visibles (el de la moneda de trabajo)
   &nDeci_TotNoVisF= 0; || Decimales en Totales no visibles (el de la otra moneda)
   &nDeci_PreVisF  = 0; || Decimales en el Precio visual. (lineas)
   &nDeci_ImpVisF  = 0; || Decimales en el Importe visual. (lineas)
   &nDeci_Div      = 0; || Decimales en Totales de la divisa
   &nDeci_PreDiv   = 0; || Decimales en el Precio en divisa
   &nDeci_TotVis   = 0; || Decimales en Totales visibles (el de la moneda de trabajo)
   &nDeci_TotNoVis = 0; || Decimales en Totales no visibles (el de la otra moneda)
   &nDeci_PreVis   = 0; || Decimales en el Precio visual. (lineas)
   &nDeci_ImpVis   = 0; || Decimales en el Importe visual. (lineas)
   &nDeci_IVADiv   = 0;
   &nDeci_IVAImp   = 0;
   &nDeci_IVA      = 0;
   &nDeci_IVACDiv  = 0;
   &nDeci_IVACImp  = 0;
   &nDeci_IVAC     = 0;
   &nDeci_TBas     = 0;
   &nDeci_TDiv     = 0;
   &nDeci_PBas     = 0;
   &nDeci_PDiv     = 0;
   &nDeci_VTot     = 0;

   &PRMNT_enError = 0;

   &aRPath = "";
   &aRNome = "";
   &aCPath = "";
   &aCNome = "";

   &eaRetorno = "";

   nNume1     = 0;
   nNume2     = 0;
   nNume3     = 0;
   aAlfa      = "";
   aAlfa1     = "";
   aAlfa2     = "";
   aAlfa3     = "";
   aAlfa4     = "";
   aAlfa5     = "";
   aAlfaP1    = "";
   aAlfaP2    = "";
   aDivisa    = "";
   aMas       = "";
   aQueQuiero = "";
   aDirectorio = "";

   fFecha      = @;
   fFecha1     = @;

   aPath       = "";
   aFichero    = "";
   aRaizClave  = "";
   aRaizClave1 = "";

   nHandle    = 0;
   nHandleLec = 0;
   nHandleEsc = 0;
   nSwDatos   = 0;
   nNumItem   = 0;
   nNumItem1  = 0;

   nCalc      = 0;
   nCalc1     = 0;
   nCalc2     = 0;
   nCalc3     = 0;
   nCalc4     = 0;
   nCalc5     = 0;
   nCalcP1    = 0;
   nCalcP2    = 0;
   nPosic     = 0;
   nCampo     = 0;
   nCampEnlace = 0;

   nProceso = 0;
   nEmpGestion  = 0;
   nEmpCartera  = 0;
   nEmpContable = 0;
   nPerContable = 0;

   aSeccionAnt = "";
   aSeccionAct = "";
   aClaveAct   = "";

   aResultado  = "";
   aInicio     = "";
   aFinal      = "";
   nContador   = 0;
   nSwError    = 0;

   nAnyo       = 0;
   nAnyo1      = 0;
   nSw         = 0;
   nCliente    = 0;

   aProceso    = "";
   aClave      = "";
   aValor      = "";
   aMrc        = "";

   nPuntos     = 0;
   nCont       = 0;
   nDig        = 0;
   nPeriodo    = 0;

   nDiario     = 0;
   fFechaAsto  = @;
   nDocumento  = 0;
   nAsiento    = 0;
   nSwCargado  = 0;

   nDig1       = 0;
   nDig2       = 0;
   nDig3       = 0;
   nDig4       = 0;
   nDig5       = 0;
   nDig6       = 0;

   nLinea      = 0;
   nLinCb      = 0;
   aTipoRie    = "";
   aSerie      = "";
   aCliente    = "";
   aProveed    = "";
   nFactura    = 0;
   fFechaFac   = @;
   nNumDocum   = 0;
   aClvPais    = "";

/*
{300}aSeccion  = "";
{300}aValorSec = "";
*/
   aCadena   = "";
   aChar1    = "";
   aChar2    = "";

   aParte1   = "";
   aParte2   = "";

   aAlfaX    = "";
   aAlfaX1   = "";
   nCalcX    = 0;
   nCalcX1   = 0;

   aSw        = "";
   aTab       = "";
   aComienzo  = "";

   aClaveAnt  = "";
   aClaveLin  = "";
   aClaveLinAnt  = "";

   fFecha_asto     = @;
   fFecha_factura  = @;
   fFecha_registro = @;
   nNumAsto     = 0;
   nNumAstoAnt  = 0;
   aSerFactura  = "";
   nNumFactura  = 0;

   aDesdeLin = "";
   aHastaLin = "";

   nMaxDig = 0;
   aCodCliente = "";
   aNomCliente = "";
   aCifCliente = "";
   aCtaCliente = "";
   aCtaBase    = "";
   aCtaIva     = "";
   aCtaRec     = "";
   nNivCliente = 0;
   aDirCliente = "";
   aCPoCliente = "";
   aPobCliente = "";
   aProCliente = "";
   aTelCliente = "";
   aFaxCliente = "";
   aEMaCliente = "";
   nNumLinea   = 0;
   nBaseLinea  = 0;
   nRetAnt     = 0;
   aRefFactura = "";
   nTotalFra   = 0;
   nBrutoFra   = 0;
   nTotalIVA   = 0;
   nTotalBase  = 0;
   nPorcIVA    = 0;
   nNivel      = 0;
   aCta2       = "";
   aCta3       = "";
   aNameCta    = "";
   aCuenta     = "";
   aClvasto    = "";
   aClv        = "";
   aNomCuenta  = "";
   aSigno      = "";
   nImporteL   = 0;
   nNumDoc     = 0;
   nNumDocAnt  = 0;
   nNumLin     = 0;
   aFormaPago  = "";

   aDAlfa      = "";
   aHAlfa      = "";

   nPorcIva = 0;
   nPorcRec = 0;
   nPorcBaseI = 0;
   nPorcBaseR = 0;

   nSwAsto = 0;
   nImpIva = 0;

   aCodCta = "";

   nTipoIva = 0;
   nTipoRec = 0;
   aTipoRec = "";

   nPorc = 0;
   nLineaAsto = 0;
   aCta  = "";
   aTipo = "";

   aMarca  = "";

   aCtaBanco = "";
   aRS      = "";
   aRefer   = "";
   aRefProv = "";
   aCodImpuesto = "";
   nNumero = 0;
   nSwSerie = 0;
   NumDoc = 0;

   aIBAN       = "";
   aBIC        = "";
   aEntidad    = "";
   aSucursal   = "";
   aDC         = "";
   aCuentaB    = "";
   aNomBanco   = "";
   nLibro      = 0;

   aSwCS       = "";
   aDirDestino = "";

   &ewNif = 0;
   &enSwDeDonde = 0;
   &eaCodPais   = "";
   &eaCuenta    = "";
   &eaPath      = "";
   &enNivel     = 0;
   &HayAcceso   = 0;
   &Haybasica   = 0;

   nMulti       = 0;
   nDsComer     = 0;
   nSwCarter    = 0;
   nError       = 0;
   &enSwConfi   = 0;
   &enSwMensajes = 0;
   &nPIDECUENTA  = 0;

   nSwEste   = 0;
   aAcum     = "";
   aClau340  = "";
   aCtaRet   = "";
   nPorcRet  = 0;
   nPorcDes  = 0;
   aCtaDes   = "";
   aDescripcion = "";
   nConcepto    = 0;
   nConceptoIVA = 0;

   &eaAlfa = "";
   aInver = "";
   aIntra = "";

   aNumCampos = "";
   nNumCampos = 0;
|FIN;

|INCLUYE defect_i;

|PROCESO BuscaRaro;
   aParte1 = ""; aParte2 = "";

   aAlfaX = aCadena; aAlfaX = aAlfaX - aChar1;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      nCalcX = FSalida; nCalcX1 = (nCalcX / 100) ! 0; nCalcX = nCalcX1;
      |PARA; |SI nCalcX1 > 99; |HACIENDO;
         aAlfaX1 = aAlfaX % 0199; aAlfaX = aAlfaX - aAlfaX1;
         aParte1 = aParte1 + aAlfaX1;
         nCalcX1 = nCalcX1 - 99;
      |SIGUE;
      nCalcX1 = nCalcX1 + 99; aParte1 = aAlfaX % nCalcX1;

      aAlfaX1 = aParte1 + aChar1; aParte2 = aCadena - aAlfaX1;
      aCadena = aParte1 + aChar2 + aParte2;

      aAlfaX = aCadena; aAlfaX = aAlfaX - aChar1;
   |SIGUE;
|FPRC;

|PROCESO FiltraRaros;
   aChar1 = &209;   aChar2 = "¥"; |HAZ BuscaRaro;
   aChar1 = "Ã‘";   aChar2 = "¥"; |HAZ BuscaRaro;
   aChar1 = &9;     aChar2 = ""; |HAZ BuscaRaro;
   aChar1 = "Ã±";   aChar2 = "¤"; |HAZ BuscaRaro;
   aChar1 = "Ã¡";   aChar2 = &160; |HAZ BuscaRaro;
   aChar1 = "Ã©";   aChar2 = &130; |HAZ BuscaRaro;
   aChar1 = "Ã­";   aChar2 = &237; |HAZ BuscaRaro;
   aChar1 = "Ã³";   aChar2 = &243; |HAZ BuscaRaro;
   aChar1 = "Ãº";   aChar2 = &250; |HAZ BuscaRaro;
   aChar1 = "Âº";   aChar2 = "§"; |HAZ BuscaRaro;
   aChar1 = "Âª";   aChar2 = "¦"; |HAZ BuscaRaro;
   aChar1 = &196;  aChar2 = "_";  |HAZ BuscaRaro;
   aChar1 = "Ã„";  aChar2 = "_";  |HAZ BuscaRaro;
|FPRC;

/****************************************************************************
******                        LECTURA DE UN FICHERO XML                ******
****************************************************************************/

|PROCESO MiraSiItem;
   aAlfa = #caerptmp#0; |QBF aAlfa;
   aAlfa = aAlfa - aClaveAct;
   |SI FSalida ! 0;
      aAlfa = aAlfa - ".";
   |FINSI;
|FPRC;

|DEFBUCLE MiraSiItem;
#caerptmp#1;
;
INICIO;
FINAL;
;
NULL, MiraSiItem;
|FIN;

|PROCESO RevisaCadena;
   |BLIN 23;
   aAlfa1 = "Procesando cadena : " + aAlfa % 0158;
   |PINTA 2301, aAlfa1;

   || Quitamos los espacios y tabuladores por delante
   nSw    = 0;
   aTab   = &9;
   aAlfa1 = aAlfa % 0;
   nNume1 = aAlfa1;
   aAlfa2 = "";
   aAlfa1 = aAlfa % 0101;
   |SI aAlfa1 = " "; |O aAlfa1 = aTab;
       |PARA nNume2 = 1; |SI nNume2 [ nNume1; |HACIENDO nNume2 = nNume2 + 1;
             nNume3 = (nNume2 * 100 + 1);
             aAlfa1 = aAlfa % nNume3;
             |SI aAlfa1 ! " "; |Y aAlfa1 ! aTab; nSw = 1; |FINSI;
             |SI nSw = 1;
                 aAlfa2 = aAlfa2 + aAlfa1;
             |FINSI;
      |SIGUE;
      aAlfa = aAlfa2;
   |FINSI;

   || Hay varias posibilidades :
   || 1 - Solo está parte del comienzo de la etiqueta en la cadena
   || 2 - Solo está el comienzo de la etiqueta en la cadena
   || 3 - Está el comienzo y parte o todo el resultado de la etiqueta
   || 4 - Está parte o todo el resultado de la etiqueta
   || 5 - Está parte o todo el resultado y el final de la etiqueta
   || 6 - Está sólo el final de la etiqueta
   || 7 - Solo hay una parte del final de la etiqueta

   aSw = "";  aAlfa2 = ""; aClaveAct = "";
   |PARA; |SI aAlfa ! ""; |HACIENDO;
      aAlfa1 = aAlfa % 0101; aAlfa = aAlfa - aAlfa1;
      |SI aAlfa1 = "<";
         |SI aSw = "I"; || ... está esperando el final de la etiqueta
            aClave = aClave + "." + aAlfa2; aAlfa2 = "";
         |FINSI;
         aSw = "I";
         aAlfa1 = aAlfa % 0101; aAlfa = aAlfa - aAlfa1;
         |SI aAlfa1 = "/";
            aSw = "F";
            aResultado = aResultado + aAlfa2; aAlfa2 = ""; aAlfa1 = "";
         |FINSI;
      |FINSI;

      |SI aAlfa1 = ">";
         |SI aSw = ""; aSw = "F";  aComienzo  = "";  |FINSI;

         |SI aSw = "I"; || Ha acabado el comienzo de la etiqueta ...
            |SI aComienzo ! "";
               |SI aClave ! ""; aClave = aClave + "."; |FINSI;
               aClave = aClave + aComienzo;
            |FINSI;
            aComienzo = aAlfa2; aAlfa2 = ""; aSw = "";
         |FINSI;

         |SI aSw = "F"; || Ha acabado el final de la etiqueta ...
            aFinal = aAlfa2; aSw = "";
            |SI aFinal = aComienzo;
               |SI aClave ! "";
                  aAlfa2 = aClave + ".";
               |SINO;
                  aAlfa2 = "";
               |FINSI;
               aAlfa2 = aAlfa2 + aFinal;
               #caerptmp#0 = aAlfa2;
               |LEE 000#caerptmp.=;
               |SI FSalida = 0; || Hay que incorporar el nº de item
                  aAlfa3 = aClave % -101;
                  |PARA; |SI aAlfa3 ] "0"; |Y aAlfa3 [ "9"; |HACIENDO;
                     aClave = aClave % -299;
                     aAlfa3 = aClave % -101;
                  |SIGUE;

                  aAlfa3 = aClave;
                  |PARA nNumItem = 1; |SI; |HACIENDO nNumItem = nNumItem + 1;
                     |SI aAlfa3 ! "";
                        aAlfa4 = aAlfa3 + (("0000" + nNumItem) % -104) + ".";
                     |SINO;
                        aAlfa4 = "";
                     |FINSI;
                     aAlfa4 = aAlfa4 + aFinal;
                     #caerptmp#0 = aAlfa4;
                     |LEE 000#caerptmp.=;
                     |SI FSalida ! 0;
                        aClave = aClave + (("0000" + nNumItem) % -104);
                        |SAL;
                     |FINSI;
                  |SIGUE;
                  aAlfa2 = aClave + "." + aFinal;
               |FINSI;
               #caerptmp#0 = aAlfa2;
               #caerptmp#1 = aResultado;
               |GRABA 020#caerptmp.n;
               aComienzo = ""; aFinal = ""; aResultado = "";
            |SINO;
               |SI aComienzo = "";
                  aAlfa3 = aClave; nCalc = 0; FSalida = 1;
                  |PARA; |SI FSalida ! 0; |HACIENDO;
                     aAlfa3 = aAlfa3 - ".";
                     |SI FSalida ! 0; nCalc = FSalida; |FINSI;
                  |SIGUE;
                  |SI nCalc = 0;
                     aAlfa3 = aClave;
                  |SINO;
                     nCalc = nCalc + 98;
                     aAlfa3 = aAlfa3 % nCalc;
                  |FINSI;

                  aAlfa5 = aAlfa3;
                  aAlfa4 = aAlfa5 % -101;
                  |PARA; |SI aAlfa4 ] "0"; |Y aAlfa4 [ "9"; |HACIENDO;
                     aAlfa5 = aAlfa5 % -299;
                     aAlfa4 = aAlfa5 % -101;
                  |SIGUE;

                  |SI aFinal = aAlfa5;
                     |SI nCalc ! 0; aAlfa3 = "." + aAlfa3; |FINSI;
                     aClave = aClave - aAlfa3;
                     aFinal = "";
                  |FINSI;
               |FINSI;
            |FINSI;
            aAlfa2 = "";
         |FINSI;
      |FINSI;

      |SI aAlfa1 ! "<"; |Y aAlfa1 ! ">";
         aAlfa2 = aAlfa2 + aAlfa1;
      |FINSI;
   |SIGUE;

   |SI aComienzo ! ""; |Y aFinal = ""; |Y aAlfa2 ! "";
      aResultado = aResultado + aAlfa2;
   |FINSI;
|FPRC;

|PROCESO ProcesaXML;
   nContador   = 0;

   aAlfa = aPath + aFichero;
   |XABRE "", aAlfa, nHandleLec;
   |SI FSalida ] 0;
      |XLEE nHandleLec, 250, aAlfa;
      |PARA; |SI FSalida ] 0; |HACIENDO;
         |HAZ RevisaCadena; |PULSATECLA;
         |XLEE nHandleLec, 250, aAlfa;
      |SIGUE;
      |XCIERRA nHandleLec;
   |FINSI;

/*
   |SI nSwDatos = 1;
      |CONSULTA_CLAVE #1#caerptmp;
   |FINSI;
*/
|FPRC;

/****************************************************************************
******            PROCESOS DE CARGA DE VARIABLES DE DECIMALES          ******
****************************************************************************/

|PROCESO CargaDiv;
   nDeci_Div       = 2;
   nDeci_Base      = 2;
|FPRC;

|PROCESO BuscaValor;
   #caerptmp#0 = aClave;
   |LEE 000#caerptmp.=;
   |SI FSalida ! 0;
      aValor = ""; aMrc = "ERROR";
   |SINO;
      aValor = #caerptmp#1; |QBF aValor;
      aMrc = #caerptmp#2;
   |FINSI;
|FPRC;

|PROCESO BuscaPeriodo;
   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "contagen/def/canempre.mas";
   |CARGA_DEF aAlfa, canempr@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/fich/";
      |PATH_DAT #canempr@#aAlfa#;
      |ABRE #canempr@;
      nDig1 = 0; nDig2 = 0; nDig3 = 0;
      nDig4 = 0; nDig5 = 0; nDig6 = 0;
      #canempr@#2 = nEmpContable;
      #canempr@#3 = 0;
      |LEE 000#canempr@.];
      |PARA; |SI FSalida = 0; |Y #canempr@#2 = nEmpContable; |HACIENDO;
         nCalc = #canempr@#26;
         |SI nCalc ] 80;
            nCalc = nCalc + 1900;
         |SINO;
            nCalc = nCalc + 2000;
         |FINSI;
         |SI nAnyo = nCalc;
            enEmpresa = #canempr@#2;
            nPeriodo  = #canempr@#3;
            nDig1 = #canempr@#14; nDig2 = #canempr@#15;
            nDig3 = #canempr@#16; nDig4 = #canempr@#17;
            nDig5 = #canempr@#18; nDig6 = #canempr@#19;
            nCalc = #canempr@#3;  |SAL;
         |FINSI;
         |LEE 000#canempr@.s;
      |SIGUE;
      |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

      cod1 = enEmpresa;
      cod2 = nPeriodo;
      emEmp = 1;
      |HAZ leelo;
      emEmp = 0;
   |FINSI;

|FPRC;

|PROCESO CargaDefs;
   nError = 1;
   |DBASS aAlfa2; |QBF aAlfa2;
   aAlfa = aAlfa2 + "contagen/def/caenlace.mas";
   |CARGA_DEF aAlfa, FCaenla@;
   |SI FSalida = 0;
      aAlfa = aAlfa2 + "contagen/def/caconasi.mas";
      |CARGA_DEF aAlfa, FConasi@;
      |SI FSalida = 0;
         || fFecha = ~; aAlfa = fFecha; |QBF aAlfa; aAlfa = aAlfa % -104;
         nAnyo = 2000 + #48#26;
         enEjercicio = nAnyo;
         nEmpContable = #48#2; |HAZ BuscaPeriodo;
         nPerContable = nPeriodo;

         aAlfa = aAlfa2 + "contagen/fich/" + (("00000" + nEmpContable) % -105) + nPeriodo + "/";
         |PATH_DAT #FCaenla@#aAlfa#; |ABRE #FCaenla@;
         |PATH_DAT #FConasi@#aAlfa#; |ABRE #FConasi@;

         nError = 0;
         |HAZ BuscaDscomer;
      |SINO;
         |DESCARGA_DEF #FCaenla@;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO DescargaDefs;
   |CIERRA #FConasi@; |DESCARGA_DEF #FConasi@;
   |CIERRA #FCaenla@; |DESCARGA_DEF #FCaenla@;
|FPRC;

|PROCESO CambiaFecha;
   aAlfaP1 = aValor - "/";
   |PARA; |SI FSalida ! 0; |HACIENDO;
      nCalcP1 = ((FSalida / 100) ! 0) + 99; aAlfaP1 = aValor % nCalcP1;
      nCalcP2 = FSalida + 198;              aAlfaP2 = aValor % nCalcP2;
      aValor = aAlfaP1 + "." + aAlfaP2;
      aAlfaP1 = aValor - "/";
   |SIGUE;
|FPRC;

|PROCESO MarcaDescartados;
   #caerptmp#2 = "*";
   |GRABA 020#caerptmp.a;
|FPRC;

|DEFBUCLE MarcaDescartados;
#caerptmp#1;
;
aInicio;
aFinal;
;
NULL, MarcaDescartados;
|FIN;

|PROCESO CompruebaDatosFra;
|FPRC;

|PROCESO LeeDato;
   #caerptmp#0 = aAlfa;
   |LEE 000#caerptmp.=;
   |SI FSalida = 0;
      aAlfa = #caerptmp#1; |QBF aAlfa;
   |SINO;
      aAlfa = "";
   |FINSI;
   |SI aAlfa = "False"; aAlfa = ""; |FINSI;
|FPRC;

|PROCESO AltaCuenta;

  |HAZ SacaNivel;
  |ABRE #cacuenta;
  #cacuenta#0 = eaCuenta;
  |LEE 041#cacuenta.=;
  |SI FSalida ! 0;
      |DDEFECTO #cacuenta;
      #cacuenta#0 = eaCuenta;
      #cacuenta#1 = enNivel;
      #cacuenta#2 = aNomCliente;
      #cacuenta#3 = "S";

      |HAZ defect;

      || la 3a clave esta formada por la cta + zzzz y el campo fantasma del nivel;
      mascara = #cacuenta#0;
      |QBF mascara;
      mascara = mascara +"zzzzzzzzzzzz";
      mascara = mascara % 112;
      #cacuenta#54    = mascara;
      #cacuenta#55    = enNivel;

      |GRABA 041#cacuenta.n;
   |FINSI;

   |CIERRA #cacuenta;
|FPRC;

|PROCESO CargaVariables1;
    aAlfa = aClave; aAlfa = aAlfa % -299;
    aAlfa1 = aAlfa % -101; aAlfa = aAlfa % -299;
    |PARA; |SI aAlfa1 ] "0"; |Y aAlfa1 [ "9"; |HACIENDO;
      aAlfa2 = aAlfa1 + aAlfa2;
      aAlfa1 = aAlfa % -101; aAlfa = aAlfa % -299;
   |SIGUE;
   nNumAsto = aAlfa2;
   nNumAsto = nNumAsto + 1;

   aAlfa = aClave + "date_invoice"; |HAZ LeeDato;
   |SI aAlfa = "";
       |ACABA;
   |FINSI;

   aAlfa = (aAlfa % 0902) + "." + (aAlfa % 0602) + "." + (aAlfa % 0104);
   fFecha_factura  = aAlfa;
   fFecha_registro = aAlfa;

|| ... Tarea 12616
   aAlfa  = aClave + "period_id"; |HAZ LeeDato;  |QBT aAlfa;
   aAlfa2 = aAlfa % -107;
   aAlfa2 = ("0000000" + aAlfa2) % -107;
   aAlfa2 = aAlfa2 - "/"; aAlfa2 = aAlfa2 - ",";
   aAlfa2 = (aAlfa2 % 102) + "/" + (aAlfa2 % -104);

   aAlfa1 = (fFecha_factura % 402) + "/" + (fFecha_factura % 704);
   |SI aAlfa1 ! aAlfa2;
       aAlfa1 =  aAlfa2 % 102;
       nNume1 = aAlfa1;
       |SI nNume1 ] 1; |Y nNume1 [ 12;
           aAlfa  =  "01." + (aAlfa2 % 102) + "." + (aAlfa2 % -104);
           fFecha_registro = aAlfa;
       |FINSI;
   |FINSI;

   |SI fFecha_factura > fFecha_registro;
       fFecha_registro = fFecha_factura;
   |FINSI;

   aAlfa = aClave + "number"; |HAZ LeeDato;
   aAlfa1 = aAlfa;
   FSalida = 1;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      aAlfa1 = aAlfa1 - "/";
      |SI FSalida > 0; nCalc = FSalida; |FINSI;
   |SIGUE;
   nCalc = nCalc + 98; aAlfa1 = aAlfa1 % nCalc; |QBF aAlfa1;
   aAlfa1 = ("000000" + aAlfa1) % -106; nNumFactura = aAlfa1;

   aAlfa1 = aAlfa - "/";
   nCalc = FSalida; nCalc = ((nCalc / 100) ! 0) + 99;
   aAlfa1 = aAlfa % nCalc; aSerFactura = aAlfa1;

   aCodCliente = "";
   aNomCliente = "";
   aCifCliente = "";
   aCtaCliente = "";
   aDirCliente = "";
   aCPoCliente = "";
   aPobCliente = "";
   aProCliente = "";
   aTelCliente = "";
   aFaxCliente = "";
   aEMaCliente = "";
   nNivCliente = 0;
   aFormaPago  = "";
   nBaseLinea  = 0;
   nRetAnt     = 0;

   aAlfa = aClave + "amount_total";      |HAZ LeeDato; nTotalFra = aAlfa;
   aAlfa = aClave + "amount_untaxed";    |HAZ LeeDato; nBrutoFra = aAlfa;
   aAlfa = aClave + "amount_tax";        |HAZ LeeDato; nTotalIVA = aAlfa;
   aAlfa = aClave + "partner_vat";       |HAZ LeeDato; aCifCliente = aAlfa;

|| Nuevos campos 4919_82
   aAlfa = aClave + "partner_street";    |HAZ LeeDato; aDirCliente = aAlfa;
   aAlfa = aClave + "partner_zip";       |HAZ LeeDato; aCPoCliente = aAlfa;
   aAlfa = aClave + "partner_city";      |HAZ LeeDato; aPobCliente = aAlfa;
   aAlfa = aClave + "partner_state";     |HAZ LeeDato; aProCliente = aAlfa;
   aAlfa = aClave + "partner_phone";     |HAZ LeeDato; aTelCliente = aAlfa;
   aAlfa = aClave + "partner_fax";       |HAZ LeeDato; aFaxCliente = aAlfa;
   aAlfa = aClave + "partner_email";     |HAZ LeeDato; aEMaCliente = aAlfa;

   aAlfa = aClave + "type";              |HAZ LeeDato; aTipo = aAlfa;
   aAlfa = aClave + "tax_code_id";       |HAZ LeeDato; aCodImpuesto = aAlfa;
   aAlfa = aClave + "supplier_invoice_number"; |HAZ LeeDato; aRefProv = aAlfa;
   aAlfa = aClave + "payment_type";      |HAZ LeeDato; aTipoRec = aAlfa;
   aAlfa = aClave + "partner_bank_id";   |HAZ LeeDato; aFormaPago = aAlfa;
   |QBF aCifCliente;

   aAlfa1 = aTipoRec; |QBF aAlfa1;
   aAlfa  = aAlfa1 - ", ";
   |SI FSalida ! 0;
      nCalc    = ((FSalida / 100) ! 0) + 99;
      aAlfa1   = aAlfa % nCalc;
      nTipoRec = aAlfa1;

      aAlfa1   = aAlfa - aAlfa1;
      aTipoRec = aAlfa1;
   |SINO;
      nTipoRec = 0;
      aTipoRec = "";
   |FINSI;

   aAlfa = aTipo - "out";
   |SI FSalida = 0;
      aRS = "S";
   |SINO;
      aRS = "R";
   |FINSI;
   nMulti = 1;
   aAlfa = aTipo - "refund";
   |SI FSalida ! 0; nMulti = -1; |FINSI;

   |SI #caerpcfg#1 = "S";
      #caerpcf1#0 = aSerFactura;
      #caerpcf1#1 = aRS;
      |LEE 000#caerpcf1.=;
      |SI FSalida = 0;
         nLibro = #caerpcf1#2;
      |SINO;
         |PUSHV 0501 2380;
         |DDEFECTO #caw00047;
         |PINPA #0#caw00046;
         |PINDA #0#caw00046;
         aAlfa = aSerFactura;
         |SI aRS = "R";
            aAlfa = aAlfa + " Repercutido";
         |SINO;
            aAlfa = aAlfa + " Soportado";
         |FINSI;
         |ATRI I; |PINTA 1327, aAlfa; |ATRI N;
   |ET Sigue2a;
         |ENDATOS #1#caw00046;
         |SI FSalida = 0;
            |DDEFECTO #caerpcf1;
            #caerpcf1#0 = aSerFactura;
            #caerpcf1#1 = aRS;
            #caerpcf1#2 = #caw00046#0;
            #caerpcf1#3 = #caw00046#1;
            |GRABA 020#caerpcf1.c;

            nLibro = #caw00046#0;
         |SINO;
            |VETE Sigue2a;
         |FINSI;
         |POPV;
      |FINSI;
   |SINO;
      |SI aRS = "R";
         nLibro = #caivaasi#3;
      |SINO;
         nLibro = #caivaasi#29;
      |FINSI;
   |FINSI;

   #caerpcf3#0 = nTipoRec;
   |LEE 000#caerpcf3.=;
   |SI FSalida = 0;
      nTipoRec = #caerpcf3#2;
   |SINO;
      |SI aTipoRec ! "";
         |PUSHV 0501 2380;
         |PINPA #0#caw00048; |PINDA #0#caw00048;
         aAlfa = aTipoRec; aAlfa = aAlfa % 0140;
         |ATRI I; |PINTA 1323, aAlfa; |ATRI N;
|ET Sigue3;
         |ENDATOS #1#caw00048;
         |SI FSalida = 0;
            |DDEFECTO #caerpcf3;
            #caerpcf3#0 = nTipoRec;
            #caerpcf3#1 = aTipoRec;
            #caerpcf3#2 = #caw00048#0;
            #caerpcf3#3 = #caw00048#1;
            |GRABA 020#caerpcf3.c;

            nTipoRec = #caw00048#0;
         |SINO;
            |VETE Sigue3;
         |FINSI;
         |POPV;
      |SINO;
         nTipoRec = 0;
      |FINSI;
   |FINSI;

   nSwEste = 0;
   aAlfa = aCifCliente % 0399;
   aAlfa = (aAlfa + "               ") % 0115;
   #caclipro#9 = aAlfa;
   |LEE 000#caclipro.=;
   |SI FSalida = 0;
       |SI aRS = "R"; |Y #caclipro#23 = "C"; nSwEste = 1; |FINSI;
       |SI aRS = "S"; |Y #caclipro#23 = "P"; nSwEste = 1; |FINSI;
       |SI nSwEste ! 1;
           |PARA; |SI #caclipro#9 = aAlfa; |HACIENDO;
                  |LEE 000#caclipro.s;
                  |SI FSalida = 0; |Y #caclipro#9 = aAlfa;
                      |SI aRS = "R"; |Y #caclipro#23 = "C"; nSwEste = 1; |FINSI;
                      |SI aRS = "S"; |Y #caclipro#23 = "P"; nSwEste = 1; |FINSI;
                      |SI nSwEste = 1;
                          |SAL;
                      |FINSI;
                  |FINSI;
           |SIGUE;
       |FINSI;
   |FINSI;

   |SI nSwEste = 1;
      aCtaCliente = #caclipro#10;
      aNomCliente = #caclipro#2;
   |SINO;
      |SELECT #1#caclipro;

      nMaxDig = 0;
      |SI nDig1 ! 0; |Y nDig1 > nMaxDig; nMaxDig = nDig1; |FINSI;
      |SI nDig2 ! 0; |Y nDig2 > nMaxDig; nMaxDig = nDig2; |FINSI;
      |SI nDig3 ! 0; |Y nDig3 > nMaxDig; nMaxDig = nDig3; |FINSI;
      |SI nDig4 ! 0; |Y nDig4 > nMaxDig; nMaxDig = nDig4; |FINSI;
      |SI nDig5 ! 0; |Y nDig5 > nMaxDig; nMaxDig = nDig5; |FINSI;
      |SI nDig6 ! 0; |Y nDig6 > nMaxDig; nMaxDig = nDig6; |FINSI;
      nCalc1 = nMaxDig - 4;
      aAlfa = "9" * nCalc1;
      |SI aRS = "R";
         eaCuenta = "4300.a";
         aAlfa = "4300" + aAlfa;
         #caclipro#23 = "C";
      |SINO;
         eaCuenta = "4000.a";
         aAlfa = "4000" + aAlfa;
         #caclipro#23 = "P";
      |FINSI;
      |HAZ FiltraPuntos;
      aCtaCliente = eaCuenta;

      aAlfa = aClave + "commercial_partner_id"; |HAZ LeeDato;
      aAlfa1 = aAlfa - ", ";
      |SI FSalida ! 0;
         nCalc = FSalida + 97; aAlfa = aAlfa1 % nCalc;
      |FINSI;
      aNomCliente = aAlfa;

      |HAZ AltaCuenta;

      |DDEFECTO #caclipro;
      |SI aRS = "R";
         #caclipro#23 = "C";
      |SINO;
         #caclipro#23 = "P";
      |FINSI;
      #caclipro#10 = aCtaCliente;
      |GRABA 020#caclipro.b;

      #caclipro#1  = aNomCliente;
      aAlfa = aCifCliente % 0399; #caclipro#9 = aAlfa;
      aAlfa = aCifCliente % 0102; #caclipro#24 = aAlfa;
      #caclipro#2  = aDirCliente;
      aAlfa = aCPoCliente; |QBF aAlfa;
      |SI aAlfa ! "";
          aAlfa = ("00000" + aAlfa) % -105;
          aAlfa1 = aAlfa % 102; #caclipro#3  = aAlfa1;
          aAlfa1 = aAlfa % 303; #caclipro#4  = aAlfa1;
          #caclipro#25 = aAlfa;
      |FINSI;
      #caclipro#5  = aProCliente;
      #caclipro#6  = aPobCliente;
      #caclipro#7  = aTelCliente;
      #caclipro#8  = aFaxCliente;
      #caclipro#51 = aEMaCliente;
      #caclipro#44 = #caclipro#2;
      #caclipro#45 = #caclipro#3;
      #caclipro#46 = #caclipro#4;
      #caclipro#47 = #caclipro#5;
      #caclipro#48 = #caclipro#6;
      #caclipro#49 = #caclipro#27;
      #caclipro#50 = #caclipro#25;

      |GRABA 020#caclipro.a; |LIBERA #caclipro;
      |HAZ ActuAgifa024;

      |SELECT #4#caclipro;

      |SI enSwDeDonde ! -1; |Y aCifCliente ! "";
         aAlfa = aCifCliente % 0399;
         |ABRE #709;
         #709#0 = aAlfa;
         |LEE 000#709=;
         |SI FSalida ! 0;
            |DDEFECTO #709;
            #709#0 = aAlfa;
            #709#1 = aNomCliente;       || Nombre y Apellidos
            aAlfa = aCifCliente % 0102;
            #709#12 = aAlfa;            || Codigo Pais
            eaCodPais = aAlfa;
            |HAZ LeePais;
            #709#13 = #718#1;           || Nombre Pais
            #709#2  = #caclipro#2;
            #709#4  = #caclipro#3;
            #709#5  = #caclipro#4;
            #709#7  = #caclipro#5;
            #709#6  = #caclipro#6;
            #709#8  = #caclipro#7;
            #709#17  = #caclipro#8;
            |GRABA 020#709n;
         |FINSI;
         |CIERRA #709;
      |FINSI;
   |FINSI;

   aAlfa = aClave + "partner_id";        |HAZ LeeDato;
   aAlfa1 = aAlfa; |QBF aAlfa1;
   aAlfa1 = aAlfa1 - ", ";
   |SI FSalida ! 0;
      nCalc = ((FSalida / 100) ! 0) + 99;
      aAlfa1 = aAlfa % nCalc;
      aCodCliente = aAlfa1;
      nCalc = FSalida + 297; aAlfa1 = aAlfa % nCalc;
      aNomCliente = aAlfa1;

      nMaxDig = nDig6; nNivCliente = 6;
      |SI nMaxDig = 0; nMaxDig = nDig5; nNivCliente = 5; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig4; nNivCliente = 4; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig3; nNivCliente = 3; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig2; nNivCliente = 2; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig1; nNivCliente = 1; |FINSI;
      |SI nMaxDig = 0; nNivCliente = 0; |FINSI;

      aAlfa1 = aCodCliente % 0; nCalc = aAlfa1;
      nCalc = nCalc + 2; nCalc = nMaxDig - nCalc;
      aCtaCliente = "43" + ("0" * nCalc) + aCodCliente;
   |FINSI;

   aCtaCliente = #caclipro#10; |QBF aCtaCliente;
   |SI aCtaCliente = "";
      aAlfa = aClave + "account_id";       |HAZ LeeDato; aCtaCliente = aAlfa;
   |FINSI;

   aAlfa = aCtaCliente;
   aAlfa1 = aAlfa; |QBF aAlfa1;
   aAlfa1 = aAlfa1 - ", ";
   |SI FSalida ! 0;
      nCalc = FSalida + 297; aAlfa1 = aAlfa % nCalc;
      aAlfa2 = aAlfa1 % 0101; aAlfa1 = aAlfa1 % 0299;
      aCtaCliente = "";
      |PARA; |SI aAlfa2 ! " "; |HACIENDO;
         aCtaCliente = aCtaCliente + aAlfa2;
         aAlfa2 = aAlfa1 % 0101; aAlfa1 = aAlfa1 % 0299;
         aNomCliente = aAlfa1;
      |SIGUE;
   |FINSI;

   aRefFactura = "";
   aAlfa = aClave + "account_id"; |HAZ LeeDato; aAlfa1 = aAlfa - ", ";
   nCalc = FSalida + 97; aAlfa = aAlfa1 % nCalc;
   aAlfa1 = aAlfa % 0102;
   |SI aAlfa1 = "47"; || Cuenta de IVA
      nSwSerie = 0;
      |SI #caivaasi#131 = "S";
         aAlfa = #caivaasi#45; |QBF aAlfa;
      |SINO;
         aAlfa = #caivaasi#130; |QBF aAlfa;
      |FINSI;
   |SINO;
      aAlfa = #caivaasi#45; |QBF aAlfa;
   |FINSI;
   |PARA; |SI aAlfa ! ""; |HACIENDO;
      |QBF aRefFactura;
      |SI aRefFactura ! ""; aRefFactura = aRefFactura + "/"; |FINSI;

      aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      |SI aAlfa1 = "S"; nSwSerie = 1; aRefFactura = aRefFactura + aSerFactura; |FINSI;
      |SI aAlfa1 = "F";
         |SI nSwSerie = 1;
            |QBF aRefFactura;
            aRefFactura = aRefFactura + #caivaasi#97;
            |QBF aRefFactura;
         |FINSI;
         |SI #caivaasi#98 = "S";
            aRefFactura = aRefFactura + nNumFactura;
         |SINO;
            nCalc = nNumFactura;
            aRefFactura = aRefFactura + nCalc;
         |FINSI;
      |FINSI;
      |SI aAlfa1 = "C"; aRefFactura = aRefFactura + aCtaCliente; |FINSI;
      |SI aAlfa1 = "N"; aRefFactura = aRefFactura + aNomCliente; |FINSI;
      |SI aAlfa1 = "R";
         |SI aRS = "R";
            aAlfa1 = aSerFactura + "-" + (("000000" + nNumFactura) % -106);
         |SINO;
            aAlfa1 = aAlfa;
            aAlfa = aClave + "supplier_invoice_number"; |HAZ LeeDato; |QBF aAlfa;
            aAlfa2 = aAlfa; aAlfa = aAlfa1; aAlfa1 = aAlfa2;
         |FINSI;
         aRefFactura = aRefFactura + aAlfa1;
      |FINSI;
   |SIGUE;
|FPRC;

|PROCESO CargaVariables2;
   aAlfa = aClvasto; aAlfa = aAlfa % -299;
   aAlfa1 = aAlfa % -101; aAlfa = aAlfa % -299;
   |PARA; |SI aAlfa1 ] "0"; |Y aAlfa1 [ "9"; |HACIENDO;
      aAlfa2 = aAlfa1 + aAlfa2;
      aAlfa1 = aAlfa % -101; aAlfa = aAlfa % -299;
   |SIGUE;
   nNumAsto = aAlfa2;

   aAlfa = aClvasto + "date"; |HAZ LeeDato;
   aAlfa = (aAlfa % 0902) + "." + (aAlfa % 0602) + "." + (aAlfa % 0104);
   fFecha_asto = aAlfa;

   aAlfa = aClave + "date_invoice"; |HAZ LeeDato;
   aAlfa = (aAlfa % 0902) + "." + (aAlfa % 0602) + "." + (aAlfa % 0104);
   fFecha_factura = aAlfa;
   fFecha_registro = aAlfa;
/*
   aAlfa  = aClave + "period_id"; |HAZ LeeDato;  |QBF aAlfa;
   aAlfa1 = (fFecha_factura % 402) + "/" + (fFecha_factura % 704);
   aAlfa2 = aAlfa % -107;
   |SI aAlfa1 ! aAlfa2;
       aAlfa = "01." + (aAlfa2 % 102) + "." + (aAlfa2 % -104);
       fFecha = aAlfa; |SI fFecha > "01.01.1900";
                           fFecha_registro = aAlfa;
                       |FINSI;
   |FINSI;
*/

   aAlfa  = aClave + "period_id"; |HAZ LeeDato;  |QBT aAlfa;
   aAlfa2 = aAlfa % -107;
   aAlfa2 = ("0000000" + aAlfa2) % -107;
   aAlfa2 = aAlfa2 - "/"; aAlfa2 = aAlfa2 - ",";
   aAlfa2 = (aAlfa2 % 102) + "/" + (aAlfa2 % -104);

   aAlfa1 = (fFecha_factura % 402) + "/" + (fFecha_factura % 704);
   |SI aAlfa1 ! aAlfa2;
       aAlfa1 =  aAlfa2 % 102;
       nNume1 = aAlfa1;
       |SI nNume1 ] 1; |Y nNume1 [ 12;
           aAlfa  =  "01." + (aAlfa2 % 102) + "." + (aAlfa2 % -104);
           fFecha_registro = aAlfa;
       |FINSI;
   |FINSI;

   |SI fFecha_factura > fFecha_registro;
       fFecha_registro = fFecha_factura;
   |FINSI;

   aAlfa = aClave + "number"; |HAZ LeeDato;
   aAlfa1 = aAlfa;
   FSalida = 1;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      aAlfa1 = aAlfa1 - "/";
      |SI FSalida > 0; nCalc = FSalida; |FINSI;
   |SIGUE;
   nCalc = nCalc + 98; aAlfa1 = aAlfa1 % nCalc; |QBF aAlfa1;
   aAlfa1 = ("000000" + aAlfa1) % -106; nNumFactura = aAlfa1;

   aAlfa1 = aAlfa - "/";
   nCalc = FSalida; nCalc = ((nCalc / 100) ! 0) + 99;
   aAlfa1 = aAlfa % nCalc; aSerFactura = aAlfa1;

   aCodCliente = "";
   aNomCliente = "";
   aCifCliente = "";
   aCtaCliente = "";
   nNivCliente = 0;

   aDirCliente = "";
   aCPoCliente = "";
   aPobCliente = "";
   aProCliente = "";
   aTelCliente = "";
   aFaxCliente = "";
   aEMaCliente = "";

   aCuenta     = "";
   aNomCuenta  = "";
   nNivel      = 0;
   aSigno      = "";
   nImporteL   = 0;
   aNameCta    = "";

   aAlfa = aClave + "type";              |HAZ LeeDato; aTipo = aAlfa;
   aAlfa = aClave + "amount_total";      |HAZ LeeDato; nTotalFra = aAlfa;
   aAlfa = aClave + "amount_untaxed";    |HAZ LeeDato; nBrutoFra = aAlfa;
   aAlfa = aClave + "amount_tax";        |HAZ LeeDato; nTotalIVA = aAlfa;
   aAlfa = aClave + "partner_vat";       |HAZ LeeDato; aCifCliente = aAlfa;

   aAlfa = aClave + "partner_street";    |HAZ LeeDato; aDirCliente = aAlfa;
   aAlfa = aClave + "partner_zip";       |HAZ LeeDato; aCPoCliente = aAlfa;
   aAlfa = aClave + "partner_city";      |HAZ LeeDato; aPobCliente = aAlfa;
   aAlfa = aClave + "partner_state";     |HAZ LeeDato; aProCliente = aAlfa;
   aAlfa = aClave + "partner_phone";     |HAZ LeeDato; aTelCliente = aAlfa;
   aAlfa = aClave + "partner_fax";       |HAZ LeeDato; aFaxCliente = aAlfa;
   aAlfa = aClave + "partner_email";     |HAZ LeeDato; aEMaCliente = aAlfa;

   aAlfa = aClave + "tax_code_id";       |HAZ LeeDato; aCodImpuesto = aAlfa;
   aAlfa = aClave + "supplier_invoice_number"; |HAZ LeeDato; aRefProv = aAlfa;
   |QBF aCifCliente; |QBF aCodImpuesto;


   aAlfa = aCodImpuesto;
   aAlfa1 = aAlfa - ", ";
   |SI FSalida ! 0;
      nCalc = FSalida + 97; aCodImpuesto = aAlfa1 % nCalc;
   |FINSI;

   nSwEste = 0;
   aAlfa = aCifCliente % 0399;
   aAlfa = (aAlfa + "               ") % 0115;
   #caclipro#9 = aAlfa;
   |LEE 000#caclipro.=;
   |SI FSalida = 0;
       |SI aRS = "R"; |Y #caclipro#23 = "C"; nSwEste = 1; |FINSI;
       |SI aRS = "S"; |Y #caclipro#23 = "P"; nSwEste = 1; |FINSI;
       |SI nSwEste ! 1;
           |PARA; |SI #caclipro#9 = aAlfa; |HACIENDO;
                  |LEE 000#caclipro.s;
                  |SI FSalida = 0; |Y #caclipro#9 = aAlfa;
                      |SI aRS = "R"; |Y #caclipro#23 = "C"; nSwEste = 1; |FINSI;
                      |SI aRS = "S"; |Y #caclipro#23 = "P"; nSwEste = 1; |FINSI;
                      |SI nSwEste = 1;
                          |SAL;
                      |FINSI;
                  |FINSI;
           |SIGUE;
       |FINSI;
   |FINSI;

   |SI nSwEste = 1;
      aCtaCliente = #caclipro#10;
      aNomCliente = #caclipro#1;
   |SINO;
      |SELECT #1#caclipro;

      aAlfa = aTipo - "out";
      |SI FSalida = 0; aRS = "S"; |SINO; aRS = "R"; |FINSI;
      nMulti = 1;
      aAlfa  = aTipo - "refund";
      |SI FSalida ! 0; nMulti = -1; |FINSI;

      nMaxDig = 0;
      |SI nDig1 ! 0; |Y nDig1 > nMaxDig; nMaxDig = nDig1; |FINSI;
      |SI nDig2 ! 0; |Y nDig2 > nMaxDig; nMaxDig = nDig2; |FINSI;
      |SI nDig3 ! 0; |Y nDig3 > nMaxDig; nMaxDig = nDig3; |FINSI;
      |SI nDig4 ! 0; |Y nDig4 > nMaxDig; nMaxDig = nDig4; |FINSI;
      |SI nDig5 ! 0; |Y nDig5 > nMaxDig; nMaxDig = nDig5; |FINSI;
      |SI nDig6 ! 0; |Y nDig6 > nMaxDig; nMaxDig = nDig6; |FINSI;
      nCalc1 = nMaxDig - 4;
      aAlfa = "9" * nCalc1;
      |SI aRS = "R";
         aAlfa = "4300" + aAlfa;
         #caclipro#23 = "C";
      |SINO;
         aAlfa = "4000" + aAlfa;
         #caclipro#23 = "P";
      |FINSI;
      #caclipro#10 = aAlfa;
      |LEE 000#caclipro.];
      |SI FSalida = 0;
         |LEE 000#caclipro.a;
      |SINO;
         |LEE 000#caclipro.u;
      |FINSI;
      |SI FSalida = 0;
         |SI aRS = "R";
            |SI #caclipro#23 = "C";
               aAlfa = #caclipro#10; aAlfa = aAlfa % 0508;
               nNumero = aAlfa; nNumero = nNumero + 1;
            |SINO;
               nNumero = 1;
            |FINSI;
         |SINO;
            |SI #caclipro#23 = "P";
               aAlfa = #caclipro#10; aAlfa = aAlfa % 0508;
               nNumero = aAlfa; nNumero = nNumero + 1;
            |SINO;
               nNumero = 1;
            |FINSI;
         |FINSI;
      |SINO;
         nNumero = 1;
      |FINSI;

      |SI aRS = "R"; aAlfa = "4300"; |SINO; aAlfa = "4000"; |FINSI;
      nCalc = -((nMaxDig - 4) + 100);
      aAlfa1 = nNumero;
      aAlfa1 = ("000000000000" + aAlfa1) % nCalc;
      aAlfa = aAlfa + aAlfa1;
      || aAlfa = aAlfa + ((("0" * nMaxDig) + nNumero) % nCalc);
      aCtaCliente = aAlfa;
      aAlfa = aClave + "commercial_partner_id"; |HAZ LeeDato;
      aAlfa1 = aAlfa - ", ";
      |SI FSalida ! 0;
         nCalc = FSalida + 97; aAlfa = aAlfa1 % nCalc;
      |FINSI;
      aNomCliente = aAlfa;

      |DDEFECTO #caclipro;
      |SI aRS = "R";
         #caclipro#23 = "C";
      |SINO;
         #caclipro#23 = "P";
      |FINSI;
      #caclipro#10 = aCtaCliente;
      |GRABA 020#caclipro.b;

      #caclipro#1  = aNomCliente;
      aAlfa = aCifCliente % 0399; #caclipro#9  = aAlfa;
      aAlfa = aCifCliente % 0102; #caclipro#24 = aAlfa;
      #caclipro#2  = aDirCliente;
      aAlfa = aCPoCliente; |QBF aAlfa;
      |SI aAlfa ! "";
          aAlfa = ("00000" + aAlfa) % -105;
          aAlfa1 = aAlfa % 102; #caclipro#3  = aAlfa1;
          aAlfa1 = aAlfa % 303; #caclipro#4  = aAlfa1;
          #caclipro#25 = aAlfa;
      |FINSI;
      #caclipro#5  = aProCliente;
      #caclipro#6  = aPobCliente;
      #caclipro#7  = aTelCliente;
      #caclipro#8  = aFaxCliente;
      #caclipro#51 = aEMaCliente;

      |GRABA 020#caclipro.a; |LIBERA #caclipro;
      |HAZ ActuAgifa024;

      |SELECT #4#caclipro;

      |SI enSwDeDonde ! -1; |Y aCifCliente ! "";
         aAlfa = aCifCliente % 0399;
         |ABRE #709;
         #709#0 = aAlfa;
         |LEE 000#709=;
         |SI FSalida ! 0;
            |DDEFECTO #709;
            #709#0 = aAlfa;
            #709#1 = aNomCliente;       || Nombre y Apellidos
            aAlfa = aCifCliente % 0102;
            #709#12 = aAlfa;            || Codigo Pais
            eaCodPais = aAlfa;
            |HAZ LeePais;
            #709#13 = #718#1;           || Nombre Pais
            #709#2  = #caclipro#2;
            #709#4  = #caclipro#3;
            #709#5  = #caclipro#4;
            #709#7  = #caclipro#5;
            #709#6  = #caclipro#6;
            #709#8  = #caclipro#7;
            #709#17  = #caclipro#8;
            |GRABA 020#709n;
         |FINSI;
         |CIERRA #709;
      |FINSI;
   |FINSI;

   aAlfa = aClave + "partner_id";        |HAZ LeeDato;
   aAlfa1 = aAlfa; |QBF aAlfa1;
   aAlfa1 = aAlfa1 - ", ";
   |SI FSalida ! 0;
      nCalc = ((FSalida / 100) ! 0) + 99;
      aCodCliente = aAlfa % nCalc;
      nCalc = nCalc + 297; aAlfa1 = aAlfa % nCalc;
      aNomCliente = aAlfa1;

      aAlfa = aClave + "account_id"; |HAZ LeeDato; aCtaCliente = aAlfa;
      nMaxDig = nDig6; nNivel = 6;
      |SI nMaxDig = 0; nMaxDig = nDig5; nNivCliente = 5; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig4; nNivCliente = 4; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig3; nNivCliente = 3; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig2; nNivCliente = 2; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig1; nNivCliente = 1; |FINSI;
      |SI nMaxDig = 0; nNivel = 0; |FINSI;
   |FINSI;

   aCuenta = #caclipro#10; |QBF aCuenta;
   |SI aCuenta = "";
      aAlfa = aClvasto + "account_id";      |HAZ LeeDato; aCuenta     = aAlfa;
   |FINSI;

   aAlfa1 = aCuenta; |QBF aAlfa1;
   aAlfa1 = aAlfa1 - ", ";
   |SI FSalida ! 0;
      nCalc = FSalida + 97;
      aAlfa1 = aAlfa1 % nCalc;

      aAlfa = aAlfa1 - " ";
      |SI FSalida ! 0;
         nCalc = ((FSalida / 100) ! 0) + 99;
         aCuenta = aAlfa % nCalc;
         aAlfa = aAlfa - aCuenta;
         aNomCuenta = aAlfa;
      |SINO;
         aNomCuenta = aAlfa1;
      |FINSI;

      nMaxDig = nDig6; nNivel = 6;
      |SI nMaxDig = 0; nMaxDig = nDig5; nNivel = 5; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig4; nNivel = 4; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig3; nNivel = 3; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig2; nNivel = 2; |FINSI;
      |SI nMaxDig = 0; nMaxDig = nDig1; nNivel = 1; |FINSI;
      |SI nMaxDig = 0; nNivel = 0; |FINSI;
   |FINSI;

   aAlfa = aClvasto + "debit";      |HAZ LeeDato; nCalc = aAlfa;
   |SI nCalc ! 0; aSigno = "D"; nImporteL = nCalc; |FINSI;
   aAlfa = aClvasto + "credit";     |HAZ LeeDato; nCalc = aAlfa;
   |SI nCalc ! 0; aSigno = "H"; nImporteL = nCalc; |FINSI;

|FPRC;

|PROCESO LinAsto;
   |SALVA_FICHA #caerptmp;
   aAlfa = aDAlfa; |QBF aAlfa;
   aAlfa1 = #caerptmp#0; |QBF aAlfa1;
   aAlfa1 = aAlfa1 - aAlfa;

   aAlfa = "";
   aAlfa2 = aAlfa1 % 0101; aAlfa1 = aAlfa1 % 0299;
   |PARA; |SI aAlfa2 ! "."; |HACIENDO;
      aAlfa = aAlfa + aAlfa2;
      aAlfa2 = aAlfa1 % 0101; aAlfa1 = aAlfa1 % 0299;
   |SIGUE;
   nNumAsto = aAlfa;

   |SI nNumAsto = nNumAstoAnt; |REPON_FICHA #caerptmp; |ACABA; |FINSI;
   nNumAstoAnt = nNumAsto;

   aAlfa = aTipo - "out";
   |SI FSalida = 0; aRS = "S"; |SINO; aRS = "R"; |FINSI;
   nMulti = 1;
   aAlfa = aTipo - "refund";
   |SI FSalida ! 0; nMulti = -1; |FINSI;

   aAlfa = aDAlfa; |QBF aAlfa;
   |SI nNumAsto > 0;
      aAlfa = aAlfa + (("0000" + nNumAsto) % -104);
   |FINSI;
   aClvasto = aAlfa + ".";
   |HAZ CargaVariables2;

   |DDEFECTO #caenlace;
   #caenlace#0 = #caerpexp#1;
   #caenlace#1 = fFecha_asto;
   #caenlace#2 = nNumDoc;
   #caenlace#3 = nNumLin; nNumLin = nNumLin + 10;
   #caenlace#4 = aCuenta;
   #caenlace#5 = nNivel;

|| ...................
   |HAZ ElCodImpuesto;
   #caenlace#6 = nConcepto;
   #caenlace#7 = aDescripcion;
   |HAZ LeeConcepto;
   #caenlace#30 = aIntra;
   #caenlace#32 = aInver;
   nConceptoIVA = nConcepto;

   nConcepto = #caenlace#6;
   |HAZ LeeConcepto;
   #caenlace#30 = aIntra;
   #caenlace#32 = aInver;

   #caenlace#8 = aSigno;
   #caenlace#9 = nMulti * nImporteL;
   #caenlace#10 = aRS;
   |SI aRS = "R";
      aRefer = aSerFactura + "/" + (("000000" + nNumFactura) % -106);
   |SINO;
      aRefer = aRefProv;
   |FINSI;

   |SI #caerpcfg#1 = "S";
      #caerpcf1#0 = aSerFactura;
      #caerpcf1#1 = #caenlace#10;
      |LEE 000#caerpcf1.=;
      |SI FSalida = 0;
         #caenlace#11 = #caerpcf1#2;
      |SINO;
         |PUSHV 0501 2380;
         |PINPA #0#caw00046; |PINDA #0#caw00046;
         aAlfa = aSerFactura;
         |SI aRS = "R";
            aAlfa = aAlfa + " Repercutido";
         |SINO;
            aAlfa = aAlfa + " Soportado";
         |FINSI;
         |ATRI I; |PINTA 1327, aAlfa; |ATRI N;
|ET Sigue2;
         |ENDATOS #1#caw00046;
         |SI FSalida = 0;
            |DDEFECTO #caerpcf1;
            #caerpcf1#0 = aSerFactura;
            #caerpcf1#1 = #caenlace#10;
            #caerpcf1#2 = #caw00046#0;
            #caerpcf1#3 = #caw00046#1;
            |GRABA 020#caerpcf1.c;

            #caenlace#11 = #caw00046#0;
         |SINO;
            |VETE Sigue2;
         |FINSI;
         |POPV;
      |FINSI;
   |SINO;
      |SI #caenlace#10 = "R";
         #caenlace#11 = #caivaasi#3;
      |SINO;
         #caenlace#11 = #caivaasi#29;
      |FINSI;
   |FINSI;
   #caenlace#12 = aSerFactura;
   #caenlace#13 = nNumFactura;

   aNameCta = "";
   aAlfa = aCuenta; |QBF aAlfa;
   aCta2 = aAlfa % 0102; aCta3 = aAlfa % 0103;
   |SI aCta2 = "43"; |O aCta2 = "40";
      #caenlace#26 = "F"; #caenlace#27 = 0;
      nPorcIva = 0; nPorcBaseI = 0;
      nPorcRec = 0; nPorcBaseR = 0;
   |FINSI;
   |SI aCta3 = "477"; |O aCta3 = "472";
      aAlfa = aClvasto + "name";            |HAZ LeeDato; aNameCta    = aAlfa;

      #caenlace#26 = "I"; #caenlace#27 = 0;
      aAlfa = aNameCta; |QBF aAlfa;
      aAlfa2 = "";
      aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      |PARA; |SI aAlfa1 ! "%"; |HACIENDO;
         aAlfa2 = aAlfa2 + aAlfa1;
         aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      |SIGUE;
      nPorcIva = aAlfa2;
   |FINSI;
   |SI aCta3 = "475";
      #caenlace#26 = "R"; #caenlace#27 = 0;
      aAlfa = aClvasto + "name";            |HAZ LeeDato; aNameCta    = aAlfa;

      aAlfa = aNameCta; |QBF aAlfa;
      aAlfa2 = "";
      aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      |PARA; |SI aAlfa1 ! "%"; |HACIENDO;
         aAlfa2 = aAlfa2 + aAlfa1;
         aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      |SIGUE;
      nPorcRec = aAlfa2;
   |FINSI;
   |SI aCta2 = "70"; |O aCta2 = "60";
      #caenlace#26 = "B"; #caenlace#27 = 0;

      aAlfa = aClvasto + "tax_code_id"; |HAZ LeeDato;
      aAlfa1 = aAlfa % 0404;
      |SI aAlfa1 = "-- -"; nPorcBaseI = nPorcIva; |FINSI;
      |SI aAlfa1 = "[16]"; nPorcBaseR = nPorcRec; |FINSI;

      |SI #caenlace#9 ! 0;
         |SI nPorcBaseI ! 0;
            #caenlace#28 = nPorcBaseI;
         |FINSI;
         |SI nPorcBaseR ! 0; #caenlace#33 = nPorcBaseR; |FINSI;
         nPorcBaseI = 0; nPorcBaseR = 0;
      |FINSI;
   |FINSI;

   #caenlace#20 = aMarca;
   #caenlace#29 = fFecha_factura;
   #caenlace#37 = nEmpContable;
   #caenlace#38 = nPerContable;
   #caenlace#43 = aNomCliente;
   aAlfa = aCifCliente % 0399;
   #caenlace#44 = aAlfa;
   #caenlace#45 = aRefer;

   |GRABA 020#caenlace.c;

   |REPON_FICHA #caerptmp;
|FPRC;

|DEFBUCLE LinAsto;
   #caerptmp#1;
   ;
   aDAlfa;
   aHAlfa;
   ;
   NULL, LinAsto;
|FIN;

|PROCESO PasaAsiento;
   aAlfa = aClave + "asiento.linea_asiento";
   aDAlfa = (aAlfa + (" " * 80)) % 0180;
   aHAlfa = (aAlfa + ("z" * 80)) % 0180;
   nNumAstoAnt = -1; nNumLin = 10;
   |BUCLE LinAsto;
   nNumDoc = nNumDoc + 10;
|FPRC;

|PROCESO LineTax;
     |PARA; |SI FSalida ! 0; |HACIENDO;
         nCalc = ((FSalida / 100) ! 0) + 99;
         aAlfa2 = aAlfa1 % nCalc;
         aAlfa3 = aAlfa2 + ";"; aAlfa1 = aAlfa1 - aAlfa3;

         aAlfa4 = "";
         |PARA; |SI aAlfa2 ! ""; |HACIENDO;
             aAlfa3 = aAlfa2 % 0101; aAlfa2 = aAlfa2 % 0299;
             |SI aAlfa3 ! ",";
                 |SI aAlfa3 ! " ";
                     aAlfa4 = aAlfa4 + aAlfa3;
                 |FINSI;
             |SINO;
                 |SI nPorc = -1;
                     nPorc = aAlfa4; aAlfa4 = "";
                 |SINO;
                     |SI aCodCta = "";
                         aCodCta = aAlfa4; aAlfa4 = "";
                     |FINSI;
                 |FINSI;
             |FINSI;
         |SIGUE;

         |SI nPorc ! -1;
             |SI nPorc < 0;  nPorc = -nPorc;  |FINSI;
         |FINSI;

         |SI aAlfa4 ! "";
            aCta = aAlfa4;

            aAlfa4 = aCta % 0103;
            aAlfa5 = aCta % 0104;

            |SI aAlfa4 = "477";
                |SI nPorcIva = -1; nPorcIva = nPorc; |FINSI;
                aCtaIva = aCta;
            |FINSI;

            |SI aAlfa4 = "472";
                |SI nPorcIva = -1; nPorcIva = nPorc; |FINSI;
                aCtaIva = aCta;
            |FINSI;

            |SI aAlfa4 = "475"; |Y aAlfa5 ! "4751";
                |SI nPorcRec = -1; nPorcRec = nPorc; |FINSI;
                aCtaRec = aCta;
            |FINSI;

            |SI aAlfa4 = "473"; |Y aRS = "R";
                |SI nPorcRet = -1; nPorcRet = nPorc; |FINSI;
                aCtaRet = aCta;
                aAcum   = "P";
            |FINSI;

            |SI aAlfa5 = "4751"; |Y aRS = "S";
                |SI nPorcRet = -1; nPorcRet = nPorc; |FINSI;
                aCtaRet = aCta;
                aAcum   = "P";
            |FINSI;

            nPorc = -1; aCta = ""; aCodCta = "";
            aAlfa4 = "";
         |FINSI;

         aAlfa2 = aAlfa1 - ";";
     |SIGUE;
|FPRC;

|PROCESO LineasFactura;
     aAlfa  = aClave + "lineas_factura";
     aAlfa1 = #caerptmp#0; |QBF aAlfa1;
     aAlfa  = aAlfa1 - aAlfa;
     aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     aAlfa2 = "";
     |PARA; |SI aAlfa1 ! "."; |Y aAlfa ! ""; |HACIENDO;
         aAlfa2 = aAlfa2 + aAlfa1;
         aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     |SIGUE;

     nNumLinea = aAlfa2;
     |SI nNumLinea = 0;
        aClaveLin = aClave + "lineas_factura" + ".";
     |SINO;
        aClaveLin = aClave + "lineas_factura" + (("0000" + nNumLinea) % -104) + ".";
     |FINSI;

     |SI aClaveLinAnt = aClaveLin;
         |ACABA;
     |FINSI;

     aClaveLinAnt = aClaveLin;

     nNumLinea = nNumLinea + 1;

     |SALVA_FICHA #caerptmp;

  || ... Nuevo
     aAlfa = aClaveLin + "tax_code_id"; |HAZ LeeDato;
     aCodImpuesto = aAlfa;
     aAlfa = aCodImpuesto;
     aAlfa1 = aAlfa - ", ";
     |SI FSalida ! 0;
         nCalc = FSalida + 97; aCodImpuesto = aAlfa1 % nCalc;
     |FINSI;
     |HAZ ElCodImpuesto;

     aAlfa = aClaveLin + "account_id"; |HAZ LeeDato;
     aAlfa1 = aAlfa - ", "; nCalc = FSalida;
     |SI nCalc > 0;
        nCalc = nCalc + 297;
        aAlfa = aAlfa % nCalc;
     |FINSI;

     aAlfa2 = "";
     aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     |PARA; |SI aAlfa ! ""; |Y aAlfa1 ! " "; |HACIENDO;
        aAlfa2 = aAlfa2 + aAlfa1;
        aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     |SIGUE;
     aCtaBase = aAlfa2;

     aAlfa = aClaveLin + "invoice_account_tax"; |HAZ LeeDato;
     aAlfa2 = "";
     aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     |PARA; |SI aAlfa ! ""; |Y aAlfa1 ! " "; |HACIENDO;
        aAlfa2 = aAlfa2 + aAlfa1;
        aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
     |SIGUE;
     aCtaIva = aAlfa2;

     aAlfa = aClaveLin + "price_subtotal"; |HAZ LeeDato;
     nTotalBase = aAlfa;

     nPorcIva = -1; aCtaIva  = "";
     nPorcRec = -1; aCtaRec  = "";
     nPorc    = -1; aCta     = "";
     nPorcRet = -1; aCtaRet  = "";
                    aCtaDes  = "";
                    aClvPais = "";

     aAlfa    = aClave + "partner_vat_type";  |HAZ LeeDato;
     aClvPais = aAlfa % 101;  |QBF aClvPais;

     aAlfa = aClaveLin + "invoice_line_tax"; |HAZ LeeDato;
     |SI aAlfa ! "";
         aAlfa1 = aAlfa + ";";
         aAlfa2 = aAlfa1 - ";";
         |SI FSalida ! 0;
             |HAZ LineTax;
         |FINSI;
     |FINSI;

     aAlfa2 = aAlfa1;
     aAlfa4 = "";
     |PARA; |SI aAlfa2 ! ""; |HACIENDO;
        aAlfa3 = aAlfa2 % 0101; aAlfa2 = aAlfa2 % 0299;
        |SI aAlfa3 ! ",";
           |SI aAlfa3 ! " ";
              aAlfa4 = aAlfa4 + aAlfa3;
           |FINSI;
        |SINO;
           |SI nPorc = -1;
              nPorc = aAlfa4; aAlfa4 = "";
           |SINO;
              |SI aCodCta = "";
                 aCodCta = aAlfa4; aAlfa4 = "";
              |FINSI;
           |FINSI;
        |FINSI;
     |SIGUE;

     |SI aAlfa4 ! "";
        aCta = aAlfa4;

        aAlfa4 = aCta % 0103;
        |SI aAlfa4 = "477"; |O aAlfa4 = "472";
           |SI nPorcIva = -1; nPorcIva = nPorc; |FINSI;
           aCtaIva = aCta;
        |FINSI;
        |SI aAlfa4 = "475";
           |SI nPorcRec = -1; nPorcRec = nPorc; |FINSI;
           aCtaRec = aCta;
        |FINSI;
        aAlfa4 = "";
        nPorc = -1; aCta = ""; aCodCta = "";
     |FINSI;

     |SI nPorcIva > 0;
        |SALVA_FICHA #caenlace;
        nLineaAsto = 20;
        #caenlace#3 = 20; || Linea de IVA
        |LEE 000#caenlace.];
        |PARA; |SI FSalida = 0; |Y #caenlace#3 < 49; |Y #caenlace#0 = nDiario; |Y #caenlace#1 = fFechaAsto; |Y #caenlace#2 = nDocumento; |HACIENDO;
           |SI aCtaIva = #caenlace#4;
              nLineaAsto = #caenlace#3; |SAL;
           |SINO;
              nLineaAsto = nLineaAsto + 1;
           |FINSI;
           |LEE 000#caenlace.s;
        |SIGUE;
        |REPON_FICHA #caenlace;

        |SALVA_FICHA #caenlace;
        #caenlace#3 = nLineaAsto;
        |LEE 000#caenlace.=;
        |SI FSalida ! 0;
           #caenlace#3 = nLineaAsto;
           #caenlace#4 = aCtaIva; aAlfa = aCtaIva; |HAZ SacaNivel;
           #caenlace#5 = nNivel;
           #caenlace#6 = nConcepto;
           #caenlace#7 = aDescripcion;
           |SI aRS = "R";
               #caenlace#8 = "H";
           |SINO;
               #caenlace#8 = "D";
           |FINSI;
           #caenlace#9 = 0;
           |GRABA 020#caenlace.c;
        |FINSI;
        nConcepto = #caenlace#6;
        |HAZ LeeConcepto;
        #caenlace#30 = aIntra;
        #caenlace#32 = aInver;
        nConceptoIVA = nConcepto;

        #caenlace#9 = #caenlace#9 + nMulti * (nTotalBase * nPorcIva);
        #caenlace#20 = aMarca;
        #caenlace#26 = "I";
        #caenlace#27 = nNumLinea;
        #caenlace#28 = 0;
        #caenlace#33 = 0;

        |GRABA 020#caenlace.a;
        |REPON_FICHA #caenlace;
     |FINSI;

     |SI aAcum = "R";  |O aAcum = "I";
         |SI nPorcRec > 0;
            |SALVA_FICHA #caenlace;
            nLineaAsto = 50;
            #caenlace#3 = 50; || Linea de REC
            |LEE 000#caenlace.];
            |PARA; |SI FSalida = 0; |Y #caenlace#3 < 79; |Y #caenlace#0 = nDiario; |Y #caenlace#1 = fFechaAsto; |Y #caenlace#2 = nDocumento; |HACIENDO;
               |SI aCtaIva = #caenlace#4;
                  nLineaAsto = #caenlace#3; |SAL;
               |SINO;
                  nLineaAsto = nLineaAsto + 1;
               |FINSI;
               |LEE 000#caenlace.s;
            |SIGUE;
            |REPON_FICHA #caenlace;

            |SALVA_FICHA #caenlace;
            #caenlace#3 = nLineaAsto;
            |LEE 000#caenlace.=;
            |SI FSalida ! 0;
               #caenlace#3 = nLineaAsto;
               #caenlace#4 = aCtaRec; aAlfa = aCtaRec; |HAZ SacaNivel;
               #caenlace#5 = nNivel;
               #caenlace#6 = nConcepto;
               #caenlace#7 = aDescripcion;
               |SI aRS = "R";
                   #caenlace#8 = "H";
               |SINO;
                   #caenlace#8 = "D";
               |FINSI;
               #caenlace#9 = 0;
               #caenlace#20 = aMarca;
               |GRABA 020#caenlace.c;
            |FINSI;

            nConcepto = #caenlace#6;
            |HAZ LeeConcepto;
            #caenlace#30 = aIntra;
            #caenlace#32 = aInver;

            #caenlace#9 = #caenlace#9 + nMulti * (nTotalBase * nPorcRec);
            #caenlace#26 = "R";
            #caenlace#27 = nNumLinea;
            #caenlace#28 = 0;
            #caenlace#33 = 0;
            |GRABA 020#caenlace.a;
            |REPON_FICHA #caenlace;
         |FINSI;
     |FINSI;

     |SI nPorcRet > 0;
        |SALVA_FICHA #caenlace;
        nLineaAsto = 70;
        #caenlace#3 = 70; || Linea de RET
        |LEE 000#caenlace.];
        |PARA; |SI FSalida = 0; |Y #caenlace#3 < 99; |Y #caenlace#0 = nDiario; |Y #caenlace#1 = fFechaAsto; |Y #caenlace#2 = nDocumento; |HACIENDO;
           |SI aCtaRet = #caenlace#4;
              nLineaAsto = #caenlace#3; |SAL;
           |SINO;
              nLineaAsto = nLineaAsto + 1;
           |FINSI;
           |LEE 000#caenlace.s;
        |SIGUE;
        |REPON_FICHA #caenlace;

        |SALVA_FICHA #caenlace;
        #caenlace#3 = nLineaAsto;
        |LEE 000#caenlace.=;
        |SI FSalida ! 0;
           #caenlace#3 = nLineaAsto;
           #caenlace#4 = aCtaRet; aAlfa = aCtaRet; |HAZ SacaNivel;
           #caenlace#5 = nNivel;
           #caenlace#6 = nConcepto;
           #caenlace#7 = aDescripcion;
           |SI aRS = "D";
               #caenlace#8 = "D";
           |SINO;
               #caenlace#8 = "H";
           |FINSI;
           #caenlace#9 = 0;
           #caenlace#20 = aMarca;
           |GRABA 020#caenlace.c;
        |FINSI;
        nConcepto = #caenlace#6;
        |HAZ LeeConcepto;
        #caenlace#30 = aIntra;
        #caenlace#32 = aInver;

        #caenlace#9 = #caenlace#9 + nMulti * (nTotalBase * nPorcRet);
        #caenlace#26 = "P";
        #caenlace#27 = nNumLinea;
        #caenlace#28 = 0;
        #caenlace#33 = 0;
        #caenlace#41 = nPorcRet;
        #caenlace#42 = nTotalBase;
        |SI nPorcIva < 0;  |Y nPorcRec < 0;  |Y nNumLinea > 1;  |Y nRetAnt = 0;
            #caenlace#27 = nBaseLinea;
        |FINSI;

        |GRABA 020#caenlace.a;
        |REPON_FICHA #caenlace;

        |SI nPorcIva < 0;  |Y nPorcRec < 0;  |Y nNumLinea > 1;  |Y nRetAnt = 0;
            |REPON_FICHA #caerptmp;

            |ACABA;
        |FINSI;
     |FINSI;

     #caenlace#3 = #caenlace#3 + 10;
     #caenlace#4 = aCtaBase; aAlfa = aCtaBase; |HAZ SacaNivel;
     #caenlace#5 = nNivel;
     |SI aRS = "R";
        #caenlace#8 = "H";
     |SINO;
        #caenlace#8 = "D";
     |FINSI;
     #caenlace#6 = nConceptoIVA;
     #caenlace#9 = nMulti * nTotalBase;
     #caenlace#20 = aMarca;
     #caenlace#26 = "B";
     #caenlace#27 = nNumLinea;
     |SI nPorcIva > 0;
        #caenlace#28 = nPorcIva * 100;
     |SINO;
        #caenlace#28 = 0;
     |FINSI;
     |SI nPorcRec > 0;
        #caenlace#33 = nPorcRec * 100;
     |SINO;
        #caenlace#33 = 0;
     |FINSI;
     |SI nPorcRet > 0;
        #caenlace#41 = nPorcRet * 100;
        #caenlace#42 =#caenlace#9;
     |FINSI;
     |SI aAcum = "B";
         #caenlace#48 = aClau340;
     |FINSI;
     #caenlace#30 = aIntra;
     #caenlace#32 = aInver;
     #caenlace#53 = aClvPais;

     nBaseLinea = nNumLinea;
     nRetAnt    = nPorcRet;

     |GRABA 020#caenlace.c;

     |SALVA_FICHA #caenlace;
     #caenlace#3 = 10;
     |LEE 000#caenlace.=;
     |SI FSalida = 0;
         |SI aAcum = "B";
             #caenlace#6  = nConceptoIVA;
             #caenlace#30 = aIntra;
             #caenlace#32 = aInver;
             #caenlace#48 = aClau340;
         |FINSI;

         #caenlace#53 = aClvPais;
         |GRABA 020#caenlace.a;
         |LIBERA #caenlace;
     |FINSI;
     |REPON_FICHA #caenlace;

     |REPON_FICHA #caerptmp;
|FPRC;

|DEFBUCLE LineasFactura;
   #caerptmp#1;
   ;
   aDesdeLin;
   aHastaLin;
   ;
   NULL, LineasFactura;
|FIN;

|PROCESO GrabaPuente;
   #caenlace#0 = #caerptm1#17;
   #caenlace#1 = #caerptm1#18;
   #caenlace#2 = #caerptm1#19;
   #caenlace#3 = 1;
   #caenlace#37 = #48#2;
   #caenlace#38 = #48#3;
   |LEE 000#caenlace.];
   |SI FSalida = 0; |Y #caenlace#0 = #caerptm1#17; |Y #caenlace#1 = #caerptm1#18;
    |Y #caenlace#2 = #caerptm1#19;  |Y #caenlace#37 = #48#2;  |Y #caenlace#38 = #48#3;
       |SI #caenlace#18 = "S"; |ACABA; |FINSI;
   |FINSI;

   |SELECT #1#caclipro;
   #caclipro#10 = #caerptm1#4;
   #caclipro#11 = #caerptm1#5;
   |SI #caerptm1#0 = "R";
      #caclipro#23 = "C";
   |SINO;
      #caclipro#23 = "P";
   |FINSI;
   |LEE 101#caclipro.=;
   |SI FSalida = 0;
      aAlfa1 = #caclipro#29; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#29 = #caerptm1#9;  |FINSI;
      aAlfa1 = #caclipro#30; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#30 = #caerptm1#10; |FINSI;
      aAlfa1 = #caclipro#31; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#31 = #caerptm1#11; |FINSI;
      aAlfa1 = #caclipro#32; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#32 = #caerptm1#12; |FINSI;
      aAlfa1 = #caclipro#40; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#40 = #caerptm1#20; |FINSI;
      aAlfa1 = #caclipro#41; |QBF aAlfa1;
      |SI aAlfa1 = ""; #caclipro#41 = #caerptm1#21; |FINSI;
      |GRABA 020#caclipro.a; |LIBERA #caclipro;
      |HAZ ActuAgifa024;
   |SINO;
      |DDEFECTO #caclipro;
   |FINSI;

   aQueQuiero = "|NC";
   aNumCampos = #Puente@#aQueQuiero#;
   nNumCampos = aNumCampos;
   nNumCampos = nNumCampos - 1;

   aAlfa1 = #caclipro#10; |QBF aAlfa1;
   aAlfa1 = aAlfa1 % -106;

   #caforpag#0 = #caclipro#20;
   |LEE 000#caforpag.=;
   |SI FSalida ! 0; |DDEFECTO #caforpag; |FINSI;

   nMulti = #caerptm1#22;
   |DDEFECTO #Puente@;
   #Puente@#0  = #caerptm1#15;           || Libro
   #Puente@#1  = #caerptm1#1;            || Serie
   #Puente@#2  = #caerptm1#2;            || Factura
   #Puente@#3  = #caerptm1#3;            || Numero recibo
   #Puente@#4  = #caerptm1#7;            || Fecha vto.
   #Puente@#5  = #caerptm1#6;            || Fecha emision
   #Puente@#6  = #caerptm1#4;            || Cuenta Cliente
   #Puente@#7  = #caclipro#1;            || Nombre Cliente
   #Puente@#8  = #caerptm1#8;            || Nombre Banco
   #Puente@#9  = #caerptm1#9;            || Entidad
   #Puente@#10 = #caerptm1#10;           || Sucursal
   #Puente@#11 = #caerptm1#11;           || DC
   #Puente@#12 = #caerptm1#12;           || N§ Cuenta
   #Puente@#13 = #caerptm1#14;           || Tipo de recibo
   #Puente@#14 = "";                     || Departamento
   #Puente@#15 = nMulti * #caerptm1#13;  || Importe Recibo
   #Puente@#16 = "";                     || A Aceptar
   #Puente@#17 = "";                     || Aceptado
   #Puente@#18 = aAlfa1;                 || Codigo Cliente (GESTION)
   #Puente@#21 = "";                     || Zona
   #Puente@#22 = NumDoc;                 || N§ Documento
   #Puente@#23 = #48#2;                  || Codigo Empresa
   #Puente@#24 = #48#3;                  || Periodo Empresa
   |SI nDsComer = 0;
       #Puente@#25 = #48#2;                  || Empresa gestion
   |FINSI;
   #Puente@#26 = "N";                    || Recibo a cuenta
   |SI #caerptm1#0 = "R";
      #Puente@#27 = "V";                 || Tipo de recibo
   |SINO;
      #Puente@#27 = "C";                 || Tipo de recibo
   |FINSI;
   #Puente@#28 = "A";
   #Puente@#29 = "EUR";               || Divisa
   #Puente@#30 = "EURO";              || Nombre Divisa
   #Puente@#31 = 1;                   || Cambio Divisa en EUROS
   #Puente@#32 = 1;                   || Cambio M.Base en EUROS
   #Puente@#33 = #caclipro#28;
   #Puente@#37 = #caerptm1#16;
   #Puente@#40 = #caclipro#20;
   #Puente@#41 = #caforpag#1;

   |SI nNumCampos ] 44;
       #Puente@#44 = #caclipro#37;           || Forma pago confirming
   |FINSI;
   |SI nNumCampos ] 49;
       #Puente@#48 = #caclipro#40;
       #Puente@#49 = #caclipro#41;
   |FINSI;
   |SELECT #4#caclipro;

   |SI #Puente@#15 ! 0;
      |GRABA 020#Puente@.n;
      NumDoc = NumDoc + 1;
   |FINSI;

   |SI #caerptm1#0 = "R";
      #calincob#0  = #caerptm1#15;
      #calincob#1  = #caerptm1#2;
      #calincob#2  = #caerptm1#1;
      #calincob#3  = #caerptm1#3;
      #calincob#4  = #caerptm1#4;
      |LEE 101#calincob.=;
      |SI FSalida ! 0;
          |DDEFECTO #calincob;
          #calincob#0  = #caerptm1#15;
          #calincob#1  = #caerptm1#2;
          #calincob#2  = #caerptm1#1;
          #calincob#3  = #caerptm1#3;
          #calincob#4  = #caerptm1#4;
          #calincob#5  = #caerptm1#5;
          #calincob#6  = #caerptm1#6;
          #calincob#7  = #caerptm1#7;
          #calincob#8  = nMulti * #caerptm1#13;
          #calincob#11 = #caerptm1#14;
          #calincob#14 = #caerptm1#7;
          #calincob#15 = #caerptm1#8;
          #calincob#29 = #caerptm1#9;
          #calincob#30 = #caerptm1#10;
          #calincob#31 = #caerptm1#11;
          #calincob#32 = #caerptm1#12;
          |GRABA 020#calincob.n;
          |LIBERA #calincob;
      |FINSI;
   |SINO;
      #calinpag#0  = #caerptm1#15;
      #calinpag#1  = #caerptm1#2;
      #calinpag#2  = #caerptm1#1;
      #calinpag#3  = #caerptm1#3;
      |LEE 101#calinpag.=;
      |SI FSalida ! 0;
          |DDEFECTO #calinpag;
          #calinpag#0  = #caerptm1#15;
          #calinpag#1  = #caerptm1#2;
          #calinpag#2  = #caerptm1#1;
          #calinpag#3  = #caerptm1#3;
          #calinpag#4  = #caerptm1#4;
          #calinpag#5  = #caerptm1#5;
          #calinpag#6  = #caerptm1#6;
          #calinpag#7  = #caerptm1#7;
          #calinpag#8  = nMulti * #caerptm1#13;
          #calinpag#11 = #caerptm1#14;
          #calinpag#14 = #caerptm1#8;
          #calinpag#29 = #caerptm1#9;
          #calinpag#30 = #caerptm1#10;
          #calinpag#31 = #caerptm1#11;
          #calinpag#32 = #caerptm1#12;
          |GRABA 020#calinpag.n;
          |LIBERA #calinpag;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE GrabaPuente;
   #caerptm1#1;
   ;
   INICIO;
   FINAL;
   ;
   NULL, GrabaPuente;
|FIN;

|PROCESO BucleVtos;
   aAlfa = #caerptmp#0; |QBF aAlfa;
   aAlfa = aAlfa - ".account_id";
   |SI FSalida = 0; |ACABA; |FINSI;

   |SALVA_FICHA #caerptmp;

   aAlfa = #caerptmp#0; |QBF aAlfa;
   aClv = aAlfa - "account_id";

   aAlfa = aClv + "date_maturity"; |HAZ LeeDato;
   |SI aAlfa = "False"; |O aAlfa = "";
      |REPON_FICHA #caerptmp;
      |ACABA;
   |FINSI;

   |SI aFormaPago = "";
       aAlfa = aClv + "partner_bank_id"; |HAZ LeeDato;
   |SINO;
       aAlfa = aFormaPago;
   |FINSI;

   aAlfa1 = aAlfa - ", ";
   |SI FSalida ! 0;
      nCalc = FSalida + 97; aAlfa = aAlfa1 % nCalc;
   |FINSI;

   aAlfa1 = aAlfa - ": "; nCalc = 0;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      nCalc = FSalida + 97;
      aAlfa1 = aAlfa1 - ": ";
   |SIGUE;

   |SI nCalc ! 0;
      aAlfa1 = aAlfa1 % nCalc; aAlfa2 = ": " + aAlfa1;
      aNomBanco = aAlfa - aAlfa2;
      aAlfa = aAlfa1;
   |FINSI;

   aEntidad  = "";
   aSucursal = "";
   aDC       = "";
   aCuentaB  = "";
   aIBAN     = "";
   aBIC      = "";
   |SI #caerpcfg#6 = "N";
        nCalc = (#caerpcfg#2 * 100) + 4;  aAlfa1 = aAlfa % nCalc;
        aEntidad = aAlfa1;
        nCalc = (#caerpcfg#3 * 100) + 4;  aAlfa1 = aAlfa % nCalc;
        aSucursal = aAlfa1;
        nCalc = (#caerpcfg#4 * 100) + 2;  aAlfa1 = aAlfa % nCalc;
        aDC = aAlfa1;
        nCalc = (#caerpcfg#5 * 100) + 10; aAlfa1 = aAlfa % nCalc;
        aCuentaB = aAlfa1;
   |SINO;
        aAlfa1 = aAlfa % 0; nNume1 = aAlfa1;
        nSw    = 0;
        aAlfa2 = "";
        |PARA nNume2 = 1; |SI nNume2 [ nNume1; |HACIENDO nNume2 = nNume2 + 1;

              nNume3 = (nNume2 * 100 + 1);
              aAlfa1 = aAlfa % nNume3;
              |SI aAlfa1 ! " "; |Y aAlfa1 ! "-";
                  aAlfa2 = aAlfa2 + aAlfa1;
              |FINSI;
              |SI aAlfa1 = "-";
                  aAlfa2 = "";
                  nSw    = 0;
              |SINO;
                  |SI aAlfa2 = "IBAN"; |O aAlfa2 = "BIC"
                      |SI aAlfa2 = "IBAN"; nSw = 1; |FINSI;
                      |SI aAlfa2 = "BIC";  nSw = 2; |FINSI;
                      aAlfa2 = "";
                  |FINSI;
                  |SI nSw = 1;  aIBAN = aAlfa2; |FINSI;
                  |SI nSw = 2;  aBIC  = aAlfa2; |FINSI;
              |FINSI;
        |SIGUE;
        aAlfa2 = aIBAN % 102;
        |SI aAlfa2 = "ES";
            aEntidad  = aIBAN % 0504;
            aSucursal = aIBAN % 0904;
            aDC       = aIBAN % 1302;
            aCuentaB  = aIBAN % 1510;
        |FINSI;
   |FINSI;
   |SALVA_DATOS #caerptm1;

   #caerptm1#3 = nLinCb; nLinCb = nLinCb + 1;
   aAlfa = aClv + "date_maturity"; |HAZ LeeDato;
   aAlfa = (aAlfa % 0902) + "." + (aAlfa % 0602) + "." + (aAlfa % 0104);
   #caerptm1#7 = aAlfa;
   |SI aRS = "R"; #caerptm1#8 = aNomBanco; |FINSI;
   #caerptm1#20 = aIBAN;
   #caerptm1#21 = aBIC;
   #caerptm1#9  = aEntidad;
   #caerptm1#10 = aSucursal;
   #caerptm1#11 = aDC;
   #caerptm1#12 = aCuentaB;
   |SI aRS = "R";
      aAlfa = aClv + "debit"; |HAZ LeeDato; nNume1 = aAlfa;
      |SI nNume1 = 0; |Y nMulti = -1;
          aAlfa = aClv + "credit"; |HAZ LeeDato;
      |FINSI;
   |SINO;
      aAlfa = aClv + "credit"; |HAZ LeeDato; nNume1 = aAlfa;
      |SI nNume1 = 0; |Y nMulti = -1;
          aAlfa = aClv + "debit"; |HAZ LeeDato;
      |FINSI;
   |FINSI;
   #caerptm1#13 = aAlfa;
   |GRABA 020#caerptm1.c;

   |REPON_DATOS #caerptm1;
   |REPON_FICHA #caerptmp;
|FPRC;

|DEFBUCLE BucleVtos;
   #caerptmp#1;
   ;
   aDesdeLin;
   aHastaLin;
   ;
   NULL, BucleVtos;
|FIN;

|PROCESO GuardaVtos;
   |DDEFECTO #caerptm1;
   aAlfa = aTipo - "out";
   |SI FSalida ! 0;
      #caerptm1#0 = "R";
   |SINO;
      #caerptm1#0 = "S";
   |FINSI;
   nMulti = 1;
   aAlfa  = aTipo - "refund";
   |SI FSalida ! 0; nMulti = -1; |FINSI;

   #caerptm1#15 = #caenlace#11;
   #caerptm1#1  = #caenlace#12;
   #caerptm1#2  = #caenlace#13;
   #caerptm1#3  = 0;
   #caerptm1#4  = aCtaCliente;
   #caerptm1#5  = nNivCliente;
   #caerptm1#6  = fFecha_factura;
   #caerptm1#14 = nTipoRec;
   #caerptm1#16 = aRefer;
   #caerptm1#17 = #caenlace#0;
   #caerptm1#18 = #caenlace#1;
   #caerptm1#19 = #caenlace#2;
   #caerptm1#22 = nMulti;
   aDesdeLin = (aClave + "asiento.linea_asiento" + (" " * 80)) % 0180;
   aHastaLin = (aClave + "asiento.linea_asiento" + ("z" * 80)) % 0180;
   nLinCb = 1; NumDoc = 1;
   |BUCLE BucleVtos;
|FPRC;

|PROCESO CargaDatosCartera;
   nEmpCartera = -1;
   nSwCargado = 0;
   aAlfa = #caivaasi#56; |QBF aAlfa; |SI aAlfa = ""; |ACABA; |FINSI;
   aAlfa = aAlfa + "def/dscam043.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #caivaasi#56; |QBF aAlfa;
      aAlfa = aAlfa + "fich/"; |PATH_DAT #Referen@#aAlfa#;
      |ABRE #Referen@; |DDEFECTO #Referen@;
      #Referen@#0 = #48#2;
      #Referen@#1 = #48#3;
      |LEE 000#Referen@.];
      |PARA; |SI FSalida = 0; |HACIENDO;
         |SI aRS = "R"; |Y #Referen@#3 = "V";
            |SI #Referen@#5 [ nLibro; |Y #Referen@#6 ] nLibro;
               |SI #Referen@#7 [ aSerFactura; |Y #Referen@#8 ] aSerFactura;
                  nEmpCartera = #Referen@#9; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI aRS = "S"; |Y #Referen@#3 = "C";
            |SI #Referen@#5 [ nLibro; |Y #Referen@#6 ] nLibro;
               |SI #Referen@#7 [ aSerFactura; |Y #Referen@#8 ] aSerFactura;
                  nEmpCartera = #Referen@#9; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |LEE 000#Referen@.s;
      |SIGUE;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
   |SI nEmpCartera < 0; |ACABA; |FINSI;

   aAlfa = #caivaasi#56; |QBF aAlfa;
   aAlfa = aAlfa + "def/dscam003.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #caivaasi#56; |QBF aAlfa;
      aPath = aAlfa + "fich/" + (("00000" + nEmpCartera) % -105) + "/";
      |PATH_DAT #Referen@#aPath#; |ABRE #Referen@;
      nSwCargado = 1;
      |SI aRS = "R"; |SELECT #9#Referen@; |FINSI;
      |SI aRS = "S"; |SELECT #2#Referen@; |FINSI;
   |FINSI;
|FPRC;

|PROCESO DescargaDatosCartera;
   |SI nSwCargado = 1;
      |SELECT #1#Referen@;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
|FPRC

|PROCESO ElCodImpuesto;
   eaAlfa = aCodImpuesto; |HAZ QuitaRaros_Acentos; aCodImpuesto = eaAlfa;
   |QBF aCodImpuesto;

   #caerpcf2#0 = aCodImpuesto;
   |SI aCodImpuesto = "";
       |DDEFECTO #caerpcf2;
       #caerpcf2#1 = #caivaasi#5;
       #caerpcf2#2 = #caivaasi#7;
       #caerpcf2#4 = #caivaasi#31;
       #caerpcf2#5 = #caivaasi#33;
       #caerpcf2#7 = " ";
   |SINO;
       |LEE 041#caerpcf2.=;
       |SI FSalida ! 0;
           |DDEFECTO #caerpcf2;
           |HAZ PideAlta;
       |FINSI;
    |FINSI;

    aAcum = #caerpcf2#7;
    |SI aRS = "R";
        nConcepto = #caerpcf2#1;
        aAlfa = #caerpcf2#2; |QBF aAlfa;
        aAlfa = aAlfa + " " + aRefFactura;
        aDescripcion = aAlfa;
        |SI #caerpcf2#7 = "B"; aClau340 = #caerpcf2#3; |FINSI;
    |SINO;
        nConcepto = #caerpcf2#4;
        aAlfa = #caerpcf2#5; |QBF aAlfa;
        aAlfa = aAlfa + " " + aRefFactura;
        aDescripcion = aAlfa;
        |SI #caerpcf2#7 = "B"; aClau340 = #caerpcf2#6; |FINSI;
    |FINSI;
|FPRC;

|PROCESO LeeConcepto;
    |ABRE #dsmom030;
    |DDEFECTO #dsmom030;
    #dsmom030#0 = nConcepto;
    |LEE 041#dsmom030.=;
    aIntra = #dsmom030#72;
    aInver = "N";
    |SI aRS = "S";
        |SI #dsmom030#28 = 2; |O #dsmom030#28 = 4; |O #dsmom030#28 = 6;
            aInver = "S";
        |SINO;
            aInver = "N";
            |SI #dsmom030#32 = 3; aInver= "S"; |FINSI;
        |FINSI;
    |SINO;
        |SI #dsmom030#34 = 14;
            aInver = "S";
        |FINSI;
    |FINSI;
    |CIERRA #dsmom030;
|FPRC;

|PROCESO PideAlta;
        |PUSHV 0501 2380;
        |PINPA #0#caw00047;
        |PINDA #0#caw00047;
        aAlfa = aCodImpuesto; aAlfa = aAlfa % 0145;
        |ATRI P; |PINTA 1118, aAlfa; |ATRI N;
        aAlfa = aCodImpuesto; aAlfa = aAlfa % 4635;
        |ATRI P; |PINTA 1218, aAlfa; |ATRI N;

|ET Sigue1a;
        |ENDATOS #1#caw00047;
        |SI FSalida = 0;
            |DDEFECTO #caerpcf2;
            #caerpcf2#0 = aCodImpuesto;
            #caerpcf2#1 = #caw00047#0;
            #caerpcf2#2 = #caw00047#1;
            #caerpcf2#3 = #caw00047#2;
            #caerpcf2#4 = #caw00047#3;
            #caerpcf2#5 = #caw00047#4;
            #caerpcf2#6 = #caw00047#5;
            #caerpcf2#7 = #caw00047#6;
            |GRABA 020#caerpcf2.c;
        |SINO;
            |VETE Sigue1a;
        |FINSI;
        |POPV;
|FPRC;

|PROCESO PasaFactura;
   aMarca = "S";
   |HAZ CargaVariables1;

   aAlfa = aTipo - "out";
   |SI FSalida = 0; aRS = "S"; |SINO; aRS = "R"; |FINSI;
   nMulti = 1;
   aAlfa  = aTipo - "refund";
   |SI FSalida ! 0; nMulti = -1; |FINSI;

   |SELECT #3#camaniva;
   #camaniva#0 = nLibro;
   #camaniva#2 = aSerFactura;
   #camaniva#3 = nNumFactura;
   |LEE 000#camaniva.=;
   |SI FSalida = 0;
      aAlfa1 = #camaniva#14; |QBF aAlfa1;
      aAlfa2 = aCifCliente;  |QBF aAlfa2; aAlfa2 = aAlfa2 % 0399;
      |SI aAlfa1 = aAlfa2;
         |DDEFECTO #caenlace;
         #caenlace#0 = #camaniva#7;
         #caenlace#1 = #camaniva#8;
         #caenlace#2 = #camaniva#9;
         #caenlace#25 = "S";
         |GRABA 020#caenlace.c;
         aMarca = "N";
         nNumAsto = #camaniva#9;
      |FINSI;

      |SI #caivaasi#1 = "S";
          |HAZ CargaDatosCartera;
          |HAZ CreaPuente;

          |SI aRS = "R";
             #calincob#0 = nLibro;
             #calincob#1 = nNumFactura;
             #calincob#2 = aSerFactura; aSerFactura = #calincob#2;
             #calincob#3 = 1;
             |LEE 000#calincob.];
             |SI FSalida = 0; |Y #calincob#0 = nLibro; |Y #calincob#1 = nNumFactura; |Y #calincob#2 = aSerFactura;
                |PARA; |SI FSalida = 0; |Y #calincob#0 = nLibro; |Y #calincob#1 = nNumFactura; |Y #calincob#2 = aSerFactura; |HACIENDO;
                   #Referen@#27 = #calincob#0;
                   #Referen@#0  = #calincob#2;
                   #Referen@#1  = #calincob#1;
                   #Referen@#2  = #calincob#3;
                   |LEE 000#Referen@.];
                   |PARA; |SI FSalida = 0; |Y #Referen@#27 = #calincob#0; |Y #Referen@#0  = #calincob#2;
                    |Y #Referen@#1  = #calincob#1; |Y #Referen@#2  = #calincob#3; |HACIENDO;
                      |SI #Referen@#4 = #calincob#6; |BORRA 020#Referen@.a; |FINSI;
                      |LEE 000#Referen@.s;
                   |SIGUE;

                   |BORRA 020#calincob.a;
                   |LEE 000#calincob.s;
                |SIGUE;
             |FINSI;
          |SINO;
             #calinpag#0 = nLibro;
             #calinpag#1 = nNumFactura;
             #calinpag#2 = aSerFactura; aSerFactura = #calinpag#2;
             #calinpag#3 = 1;
             |LEE 000#calinpag.];
             |SI FSalida = 0; |Y #calinpag#0 = nLibro; |Y #calinpag#1 = nNumFactura; |Y #calinpag#2 = aSerFactura;
                |PARA; |SI FSalida = 0; |Y #calinpag#0 = nLibro; |Y #calinpag#1 = nNumFactura; |Y #calinpag#2 = aSerFactura; |HACIENDO;
                   #Referen@#27 = #calinpag#0;
                   #Referen@#0  = #calinpag#2;
                   #Referen@#1  = #calinpag#1;
                   #Referen@#2  = #calinpag#3;
                   |LEE 000#Referen@.];
                   |PARA; |SI FSalida = 0; |Y #Referen@#27 = #calinpag#0; |Y #Referen@#0  = #calinpag#2;
                    |Y #Referen@#1  = #calinpag#1; |Y #Referen@#2  = #calinpag#3; |HACIENDO;
                      |SI #Referen@#4 = #calinpag#6; |BORRA 020#Referen@.a; |FINSI;
                      |LEE 000#Referen@.s;
                   |SIGUE;

                   |BORRA 020#calinpag.a;
                   |LEE 000#calinpag.s;
                |SIGUE;
             |FINSI;
          |FINSI;

          |SI eaRetorno ! "ERROR";
              |HAZ CierraPuente;
          |FINSI;

          |HAZ DescargaDatosCartera;
      |FINSI;
   |FINSI;

   |DDEFECTO #caenlace;
   #caenlace#0 = #caerpexp#1;
   #caenlace#1 = fFecha_registro;
   #caenlace#2 = nNumAsto;
   #caenlace#3 = 10;
   #caenlace#37 = nEmpContable;
   #caenlace#38 = nPerContable;
   |LEE 101#caenlace.=;
   |SI FSalida ! 0;
       |DDEFECTO #caenlace;
       #caenlace#0 = #caerpexp#1;
       #caenlace#1 = fFecha_registro;
       #caenlace#2 = nNumAsto;
       #caenlace#3 = 10;
       #caenlace#37 = nEmpContable;
       #caenlace#38 = nPerContable;
       |GRABA 020#caenlace.b;
   |FINSI;

   #caenlace#4 = aCtaCliente;
   #caenlace#5 = nNivCliente;

|| ...................
   |HAZ ElCodImpuesto;
   #caenlace#6 = nConcepto;
   #caenlace#7 = aDescripcion;
   |HAZ LeeConcepto;
   #caenlace#30 = aIntra;
   #caenlace#32 = aInver;
   nConceptoIVA = nConcepto;
|| ..................................

   |SI aRS = "R";
      #caenlace#8 = "D";
      aRefer = aSerFactura + "/" + (("000000" + nNumFactura) % -106);
   |SINO;
      #caenlace#8 = "H";
      aRefer = aRefProv;
   |FINSI;
   #caenlace#9 = nMulti * nTotalFra;
   #caenlace#10 = aRS;
   |SI aRS = "R";
      #caenlace#10 = "R";
      aRefer = aSerFactura + "/" + (("000000" + nNumFactura) % -106);
   |SINO;
      #caenlace#10 = "S";
      aRefer = aRefProv;
   |FINSI;

   |SI #caerpcfg#1 = "S";
       #caerpcf1#0 = aSerFactura;
       #caerpcf1#1 = #caenlace#10;
       |LEE 000#caerpcf1.=;
       |SI FSalida = 0;
           #caenlace#11 = #caerpcf1#2;
       |SINO;
           |PUSHV 0501 2380;
           |PINPA #0#caw00046; |PINDA #0#caw00046;
           aAlfa = aSerFactura;
           |SI aRS = "R";
               aAlfa = aAlfa + " Repercutido";
           |SINO;
               aAlfa = aAlfa + " Soportado";
           |FINSI;
           |ATRI I; |PINTA 1327, aAlfa; |ATRI N;
|ET Sigue2aa;
         |ENDATOS #1#caw00046;
         |SI FSalida = 0;
            |DDEFECTO #caerpcf1;
            #caerpcf1#0 = aSerFactura;
            #caerpcf1#1 = #caenlace#10;
            #caerpcf1#2 = #caw00046#0;
            #caerpcf1#3 = #caw00046#1;
            |GRABA 020#caerpcf1.c;

            #caenlace#11 = #caw00046#0;
         |SINO;
            |VETE Sigue2aa;
         |FINSI;
         |POPV;
      |FINSI;
   |SINO;
      |SI #caenlace#10 = "R";
         #caenlace#11 = #caivaasi#3;
      |SINO;
         #caenlace#11 = #caivaasi#29;
      |FINSI;
   |FINSI;

   #caenlace#12 = aSerFactura;
   #caenlace#13 = nNumFactura;
   #caenlace#20 = aMarca;
   #caenlace#26 = "F";
   #caenlace#27 = 0;
   #caenlace#29 = fFecha_factura;
   #caenlace#43 = aNomCliente;
   aAlfa = aCifCliente % 0399;
   #caenlace#44 = aAlfa;
   #caenlace#45 = aRefer;

   |GRABA 020#caenlace.a;
   |LIBERA #caenlace;

   nTipoIva = 0;
   aDesdeLin = (aClave + "lineas_factura" + (" " * 80)) % 0180;
   aHastaLin = (aClave + "lineas_factura" + ("z" * 80)) % 0180;

   nDiario = #caerpexp#1;
   fFechaAsto = fFecha_registro;
   nDocumento = nNumAsto;
   #caenlace#3 = 100; || Me reservo de la linea 20 a la 99 para las cuotas de iva y recargo

/*
   |ABRE #caerptmp;
   |CONSULTA_CLAVE #1#caerptmp;
   |CIERRA #caerptmp;
*/

   aClaveLinAnt = "";
   |BUCLE LineasFactura;

   |SI #caivaasi#1 = "S"; |HAZ GuardaVtos; |FINSI;
|FPRC;

|PROCESO BucleFacturas;
   || Normalmente va a venir como primer dato siempre un dato de la cabecera
   ||    de la factura, por lo que debo quedarme con el prefijo hasta el n§
   ||    de factura.

   aAlfa = #caerptmp#0; |QBF aAlfa; FSalida = 1;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      aAlfa = aAlfa - ".";
      |SI FSalida > 0; nCalc = FSalida; |FINSI;
   |SIGUE;
   nCalc = nCalc + 98; aAlfa = aAlfa % nCalc;
   aAlfa1 = #caerptmp#0; |QBF aAlfa1; aAlfa = aAlfa1 - aAlfa;

   aAlfa = aAlfa - aClave;
   |SI FSalida ! 0;
      |ACABA;
   |FINSI;

   aClave   = aAlfa;
   nSwError = 0;
   |HAZ CompruebaDatosFra; || Comprueba los datos aportados de la factura.
                           ||     Si hay errores, incluyo en el fichero de
                           ||     respuesta el error y continuo. Si no hay
                           ||     errores incluyo la factura en el temporal
                           ||     de importacion

   |SI nSwError = 0;
      |SALVA_FICHA #caerptmp;
      |SI nSwAsto = 1;
         |HAZ PasaAsiento;
      |SINO;
         |HAZ PasaFactura;
      |FINSI;

      |REPON_FICHA #caerptmp;
   |FINSI;
|FPRC;

|DEFBUCLE BucleFacturas;
   #caerptmp#1;
   ;
   INICIO;
   FINAL;
   ;
   NULL, BucleFacturas;
|FIN;

|PROCESO GrabaDocumento;
   |SI #caenlace#20 = "N";
       |ACABA;
   |FINSI;

   nNumDoc = #caenlace#2;
   |SI nNumDocAnt ! nNumDoc;
      |HAZ Contador;
      nNumDocAnt = nNumDoc;
   |FINSI;

   |PARA nCampo = 0;  |SI nCampo [ nCampEnlace;  |HACIENDO nCampo = nCampo + 1;
         #caenlace@#nCampo# = #caenlace#nCampo#;
   |SIGUE;

   #caenlace@#2  = nNumDocum;
   #caenlace@#20 = "N";
   |GRABA 020#caenlace@.n;
   |LIBERA #caenlace@;

   |BORRA 020#caenlace.a;

   |SELECT #2#caerptm1;
   #caerptm1#17 = #caenlace#0;
   #caerptm1#18 = #caenlace#1;
   #caerptm1#19 = nNumDoc;
   |LEE 000#caerptm1.];
   |PARA; |SI FSalida = 0; |Y #caerptm1#17 = #caenlace#0; |Y #caerptm1#18 = #caenlace#1; |Y #caerptm1#19 = nNumDoc; |HACIENDO;
      |SALVA_FICHA #caerptm1;

      #caerptm1#19 = nNumDocum;
      |GRABA 020#caerptm1.a;

      |REPON_FICHA #caerptm1;

      |LEE 000#caerptm1.s;
   |SIGUE;
   |SELECT #1#caerptm1;
|FPRC;

|PROCESO Renumera;
   nNumDocAnt = -1;

   |DDEF aMas;
   aMas = aMas + "caenlace.mas";
   |CARGA_DEF aMas, caenlace@;

   aAlfa = "pu" + Usuario; |NOME_DAT #caenlace@#aAlfa#;

   aQueQuiero  = "|NC";
   aAlfa       = #caenlace#aQueQuiero#;
   nCampEnlace = aAlfa;
   nCampEnlace = nCampEnlace - 1;

   |ABRE #caenlace@;
   |ABRE #caenlace;
   |LEE 101#caenlace.p;
   |PARA;  |SI FSalida = 0;  |HACIENDO;
        |HAZ GrabaDocumento;
        |LIBERA #caenlace;

        |LEE 101#caenlace.s;
   |SIGUE;
   |CIERRA #caenlace@;
   |CIERRA #caenlace;

   |DESCARGA_DEF #caenlace@;
|FPRC;

|PROCESO CreaVtos;
   eaPath = #caivaasi#56; |QBF eaPath;
   |HAZ CreaPuente;

   |SI eaRetorno ! "ERROR";
      |BUCLE GrabaPuente;
      |HAZ CierraPuente;
   |FINSI;
|FPRC;

|| ... Proceso nuevos en dscomer

|PROCESO BuscaDscomer;

     nDsComer = 0;
     |DBASS aPath; |QBF aPath;
     aPath = aPath + "dscomer9/";
     aAlfa = aPath + "def/agifa041";
     |CARGA_DEF aAlfa, agifa041@;
     |SI FSalida ! 0;
          nDsComer = 1;
     |SINO;
          aAlfa = aPath + "def/agifa024";
          |CARGA_DEF aAlfa, agifa024@;
          |SI FSalida = 0;
               aAlfa = aPath + "def/dsm00225";
               |CARGA_DEF aAlfa, dsm00225@;

               aAlfa = aPath + "def/dsm00003";
               |CARGA_DEF aAlfa, dsm00003@;

               aAlfa = aPath + "def/agifa142";
               |CARGA_DEF aAlfa, agifa142@;

               aAlfa = aPath + "fich/";
               |PATH_DAT #agifa041@#aAlfa#;
               |ABRE #agifa041@;
               aAlfa = aAlfa + (("00000" + nEmpContable) % -105) + "/";
               |PATH_DAT #agifa024@#aAlfa#;
               |PATH_DAT #dsm00225@#aAlfa#;
               |PATH_DAT #dsm00003@#aAlfa#;
               |PATH_DAT #agifa142@#aAlfa#;

               |ABRE #agifa142@;
               |DDEFECTO #agifa142@;
               |LEE 041#agifa142@.p;
               |CIERRA #agifa142@;
               nSwCarter = 0; |SI #agifa142@#222 = "S"; nSwCarter = 1; |FINSI;
          |SINO;
               nDsComer = 1;
               |DESCARGA_DEF #agifa041@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SalDscomer;
    |SI nDsComer = 0;
        |CIERRA #agifa041@;
        |DESCARGA_DEF #agifa142@;
        |DESCARGA_DEF #dsm00003@;
        |DESCARGA_DEF #dsm00225@;
        |DESCARGA_DEF #agifa024@;
        |DESCARGA_DEF #agifa041@;
    |FINSI;
|FPRC;

|PROCESO ActuAgifa024;
    |SI #caclipro#23 = "C"; |Y nDsComer = 0;
        |ABRE #agifa024@;
        aAlfa = #caclipro#10; |QBF aAlfa;
        aAlfa = aAlfa %  -106;

        |DDEFECTO #agifa024@;
        #agifa024@#0 = aAlfa;
        |LEE 101#agifa024@.=;
        |SI FSalida ! 0;
            #agifa024@#0 = aAlfa;
            |GRABA 020#agifa024@.b;
        |FINSI;
        #agifa024@#1 = #caclipro#1;
        #agifa024@#2 = #caclipro#1;

        #agifa024@#5 = #caclipro#2;
        #agifa024@#6 = #caclipro#6;
        #agifa024@#7 = #caclipro#5;
        #agifa024@#178 = #caclipro#3;
        #agifa024@#179 = #caclipro#4;
        #agifa024@#180 = #caclipro#25;

        #agifa024@#8 = #caclipro#2;
        #agifa024@#9 = #caclipro#6;
        #agifa024@#10 = #caclipro#5;
        #agifa024@#181 = #caclipro#3;
        #agifa024@#182 = #caclipro#4;
        #agifa024@#183 = #caclipro#25;

        #agifa024@#11 = #caclipro#2;
        #agifa024@#12 = #caclipro#6;
        #agifa024@#13 = #caclipro#5;
        #agifa024@#184 = #caclipro#3;
        #agifa024@#185 = #caclipro#4;
        #agifa024@#186 = #caclipro#25;

        #agifa024@#205 = #caclipro#24;
        #agifa024@#17 = #caclipro#7;
        #agifa024@#18 = #caclipro#8;
        #agifa024@#15 = #caclipro#9;
        #agifa024@#16 = #caclipro#10;
        #agifa024@#29 = #caclipro#13;
        #agifa024@#34 = #caclipro#14;
        #agifa024@#30 = #caclipro#17;
        #agifa024@#162 = #caclipro#19;
        #agifa024@#20 = #caclipro#20;
        #agifa024@#203 = #caclipro#28;
        #agifa024@#3 = #caclipro#33;
        #agifa024@#32 = #caclipro#29;
        #agifa024@#33 = #caclipro#30;
        #agifa024@#31 = #caclipro#31;
        #agifa024@#30 = #caclipro#32;
        #agifa024@#22 = #caclipro#34;
        #agifa024@#23 = #caclipro#35;
        #agifa024@#24 = #caclipro#36;
        #agifa024@#27 = #caclipro#49;
        #agifa024@#215 = #caclipro#40;
        #agifa024@#216 = #caclipro#41;

        #dsm00225@#0 = #agifa024@#205;
        |LEE 000#dsm00225@.=;
        |SI FSalida ! 0; |DDEFECTO #dsm00225@; |FINSI;
        #agifa024@#14 = #dsm00225@#1;

        |GRABA 020#agifa024@.a;
        |LIBERA #agifa024@;

        |CIERRA #agifa024@;

        |ABRE #dsm00003@;
        |DDEFECTO #dsm00003@;
        #dsm00003@#0  = #agifa024@#0;
        #dsm00003@#1  = 1;
        |LEE 101#dsm00003@.=;
        |SI FSalida ! 0; |GRABA 021#dsm00003@.b; |FINSI;
        #dsm00003@#2  = #agifa024@#5;
        #dsm00003@#3  = #agifa024@#6;
        #dsm00003@#4  = #agifa024@#178;
        #dsm00003@#5  = #agifa024@#179;
        #dsm00003@#6  = #agifa024@#180;
        #dsm00003@#7  = #agifa024@#7;
        #dsm00003@#8  = #agifa024@#14;
        #dsm00003@#10 = #agifa024@#2;
        #dsm00003@#11 = #agifa024@#3;
       || ..  #dsm00003@#12 = #101#1;
        #dsm00003@#13 = #agifa024@#17;
        #dsm00003@#14 = #agifa024@#25;
       || ..  #dsm00003@#15 = #25#1;
        #dsm00003@#16 = #agifa024@#189;
       || .. #dsm00003@#17 = #102#1;
        #dsm00003@#19 = #agifa024@#205;
        #dsm00003@#20 = #agifa024@#196;
        #dsm00003@#21 = #agifa024@#18;
        #dsm00003@#22 = #agifa024@#36;
        #dsm00003@#23 = #agifa024@#211;
        #dsm00003@#24 = #agifa024@#197;
        |GRABA 021#dsm00003@.a;
        |CIERRA #dsm00003@;

        |SI nSwCarter = 1;
            |HAZ ReplicaCartera;
        |FINSI;
   |FINSI;
|FPRC;

|PROCESO ReplicaCartera;
   nEmpCartera = -1;
   nSwCargado  = 0;
   aAlfa = #caivaasi#56; |QBF aAlfa;
   |SI aAlfa = ""; |ACABA; |FINSI;

   aAlfa = aAlfa + "def/dscam043.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #caivaasi#56; |QBF aAlfa;
      aAlfa = aAlfa + "fich/"; |PATH_DAT #Referen@#aAlfa#;
      |ABRE #Referen@; |DDEFECTO #Referen@;
      #Referen@#0 = #48#2;
      #Referen@#1 = #48#3;
      |LEE 000#Referen@.];
      |PARA; |SI FSalida = 0; |HACIENDO;
         |SI aRS = "R"; |Y #Referen@#3 = "V";
            |SI #Referen@#5 [ nLibro; |Y #Referen@#6 ] nLibro;
               |SI #Referen@#7 [ aSerFactura; |Y #Referen@#8 ] aSerFactura;
                  nEmpCartera = #Referen@#9; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI aRS = "S"; |Y #Referen@#3 = "C";
            |SI #Referen@#5 [ nLibro; |Y #Referen@#6 ] nLibro;
               |SI #Referen@#7 [ aSerFactura; |Y #Referen@#8 ] aSerFactura;
                  nEmpCartera = #Referen@#9; |SAL;
               |FINSI;
            |FINSI;
         |FINSI;
         |LEE 000#Referen@.s;
      |SIGUE;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
   |SI nEmpCartera < 0; |ACABA; |FINSI;

   aAlfa = #caivaasi#56; |QBF aAlfa;
   aPath = aAlfa + "fich/" + (("00000" + nEmpCartera) % -105) + "/";

   aAlfa = aAlfa + "def/dscam052.mas";
   |CARGA_DEF aAlfa, dsam052@;
   |SI FSalida = 0;
       |PATH_DAT #dsam052@#aPath#;
       |ABRE #dsam052@;
       #dsam052@#0 = #agifa024@#0;
       |LEE 141#dsam052@.=;
       |SI FSalida ! 0;
           |DDEFECTO #dsam052@;
           #dsam052@#0 = #agifa024@#0;
           |GRABA 020#dsam052@.b;
       |FINSI;
       aAlfa = "|NC"; aAlfa = #dsam052@#aAlfa#;
       nCalc = aAlfa; nCalc = nCalc - 1;
       aAlfa1 = "|NC"; aAlfa1 = #agifa024@#aAlfa1#;
       nCalc1 = aAlfa1; nCalc1 = nCalc1 - 1;
       |SI nCalc ! nCalc1;
           ||  |MENAV "    Diferencia de campos en replica con cartera";
       |FINSI;

       |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
             #dsam052@#nCont# = #agifa024@#nCont#;
       |SIGUE;
       |GRABA 020#dsam052@.a;
       |LIBERA #dsam052@;
       |CIERRA #dsam052@;
       |DESCARGA_DEF #dsam052@;
   |FINSI;
|FPRC;
|| /////////////////////////////////////////////////

|PROCESO ExportaFras;
   |HAZ CargaDefs;
   |SI nError = 1;
       |MENAV "    Error al cargar datos de la empresa Contable";
       |ACABA;
   |FINSI;

   aAlfa = "pu" + Usuario; |NOME_DAT #caenlace#aAlfa#;
   |DELINDEX #caenlace; |ABRE #caenlace;

   |ABRE #camaniva;
   |ABRE #caforpag;
   |ABRE #caclipro; |SELECT #4#caclipro;

   nSwError = 0; nNumDoc = 1;

/*
   |ABRE #caerptmp;
   |CONSULTA_CLAVE #1#caerptmp;
   |CIERRA #caerptmp;
*/

   |BUCLE BucleFacturas;

   |HAZ Renumera;

   |CIERRA #camaniva;

/*
   |ABRE #caenlace;
   |CONSULTA_CLAVE #1#caenlace;
   |CIERRA #caenlace;
*/

   enSwConfi    = 2;
   enSwMensajes = 1;
   nPIDECUENTA  = 1;
   |DFICE aAlfa; |QBF aAlfa;
   aAlfa = "dsapunte.tab;" + aAlfa + ",pu" + Usuario;
   |SUB_EJECUTA aAlfa;
   enSwConfi    = 0;
   nPIDECUENTA  = 0;
   enSwMensajes = 0;

   |SI PRMNT_enError = 0; |Y #caivaasi#1 = "S"; |HAZ CreaVtos; |FINSI;

   |HAZ SalDscomer;
   |CIERRA #caforpag;
   |SELECT #1#caclipro; |CIERRA #caclipro;
   |CIERRA #caenlace;
   |DELINDEX #caenlace;

   |HAZ DescargaDefs;
|FPRC;

|PROCESO TrataOperacion;
   |HAZ ProcesaXML;

   aAlfa = aPath; |QBF aAlfa;
   aAlfa = aAlfa + "respuestas/"; |MKDIR aAlfa;
   aAlfa = aAlfa + aFichero; |QBF aAlfa;
   |XABRE "WB", aAlfa, nHandleEsc;
   |SI FSalida ] 0;
      aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "UTF-8"+ &34 + "?>" + &13 + &10;
      |XGRABA nHandleEsc, aAlfa;

      aAlfa = "<datos>" + &13 + &10; |XGRABA nHandleEsc, aAlfa;
      |XCIERRA nHandleEsc;
   |FINSI;

   |HAZ ExportaFras;

   aAlfa = aPath; |QBF aAlfa;
   aAlfa = aAlfa + "respuestas/"; |MKDIR aAlfa;
   aAlfa = aAlfa + aFichero; |QBF aAlfa;
   |XABRE "AB", aAlfa, nHandleEsc;
   |SI FSalida ] 0;
      aAlfa = "</datos>" + &13 + &10;      |XGRABA nHandleEsc, aAlfa;
      |XCIERRA nHandleEsc;
   |FINSI;

   aAlfa = aPath; |QBF aAlfa;
   aAlfa = aAlfa + aFichero;
   aAlfa1 = aPath; |QBF aAlfa1;
   aAlfa1 = aAlfa1 + "procesados/"; |MKDIR aAlfa1;
   aAlfa1 = aAlfa1 + aFichero;

   |COPIA_FICHERO aAlfa, aAlfa1; |FBORRA aAlfa;
|FPRC;

|PROCESO Contador;
   |ABRE #caconasi;
   |LEE 101#caconasi.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconasi;
      |GRABA 020#caconasi.n;
      |LEE 101#caconasi.p;
   |FINSI;

   #caconasi#1 = #caconasi#1 + 1; nNumDocum = #caconasi#1;
   aAlfa = "|NC"; nCalc = #caconasi#aAlfa#;
   |SI nCalc > 2; #caconasi#2 = #caconasi#2 + 1; |FINSI;

   |GRABA 020#caconasi.a;
   |LIBERA #caconasi; |CIERRA #caconasi;

|ET FinContador;
   |ABRE #camaasic;
   #camaasic#0 = #caenlace#0;
   #camaasic#1 = #caenlace#1;
   #camaasic#2 = nNumDocum;
   |LEE 000#camaasic.=;
   |SI FSalida = 0;
      |PARA; |SI FSalida = 0; |Y #camaasic#0 = #caenlace#0; |HACIENDO;
         nNumDocum = #camaasic#2 + 1;
         |LEE 000#camaasic.s;
      |SIGUE;
   |FINSI;
   |CIERRA #camaasic;
|FPRC;

|PROCESO BuscaCamino;
   |SI FSalida = 10;
      aAlfa = #caerpexp#0; |QBF aAlfa;
      |SI aAlfa = ""; aAlfa = "*"; |FINSI;
      aAlfa = "D" + aAlfa; |BROWSE aAlfa;
      aAlfa = aAlfa - "D";
      #caerpexp#0 = aAlfa;
      |ERROR;
   |FINSI;
   |SI FSalida = 11;
      aAlfa = #caerpexp#0; |QBF aAlfa;
      |SI aAlfa = ""; aAlfa = "*"; |FINSI;
      aAlfa = "F" + aAlfa; |BROWSE aAlfa;
      aAlfa = aAlfa - "F";
      #caerpexp#0 = aAlfa;
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO PreparaDirectorio;
         |DBASE aAlfa1; |QBF aAlfa1;
         aAlfa1 = aAlfa1 + "tmp/";        |MKDIR aAlfa1;
         aAlfa1 = aAlfa1 + Usuario + "/"; |MKDIR aAlfa1;
         aDirDestino = aAlfa1;       |QBF aDirDestino;

      aDirectorio = aDirDestino + "*";
      |_PDIR aDirectorio;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa2 = aDirectorio; |QBF aAlfa2;
         aAlfa1 = aAlfa2 % -104;
         |SI aAlfa1 = ".xml";
             |FBORRA aAlfa2;
         |FINSI;
         |_SDIR aDirectorio;
      |SIGUE;
      aDirectorio = aDirDestino + "respuestas/*";
      |_PDIR aDirectorio;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa2 = aDirectorio; |QBF aAlfa2;
         aAlfa1 = aAlfa2 % -104;
         |SI aAlfa1 = ".xml";
             |FBORRA aAlfa2;
         |FINSI;
         |_SDIR aDirectorio;
      |SIGUE;
|FPRC;

|PROGRAMA;
   |ABRE #caerpexp;
   |LEE 000#caerpexp.p;
   |SI FSalida ! 0;
      |DDEFECTO #caerpexp;
      |GRABA 020#caerpexp.c;
   |FINSI;

   ewNif = 0;
   enSwDeDonde = -1;
   |HAZ DirAplicSt;
   |SI HayAcceso = 1;
       enSwDeDonde = 1;
       |REFERENCIA_DEF regisnif@, #711;
   |SINO;
       |SI Haybasica = 1;
           enSwDeDonde = 0;
           |REFERENCIA_DEF regisnif@, #710;
       |FINSI;
   |FINSI;

   aAlfa = PARAMETRO; aAlfa = aAlfa - ",VERDATOS";
   |SI FSalida ! 0;
      nSwDatos = 1;
   |SINO;
      nSwDatos = 0;
   |FINSI;
   PARAMETRO = aAlfa;

   |ABRE #caerpcfg;
   |DDEFECTO #caerpcfg;
   |LEE 041#caerpcfg.p;
   |CIERRA #caerpcfg;

   |ABRE #caerpcf1;
   |ABRE #caerpcf2;
   |ABRE #caerpcf3;

   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 041#caivaasi.p;
   |CIERRA #caivaasi;

   |ABRE #calincob;
   |ABRE #calinpag;

   |SI PARAMETRO ! "";
      aAlfa = "tm" + Usuario; |NOME_DAT #caerptmp#aAlfa#;
      aAlfa = "t1" + Usuario; |NOME_DAT #caerptm1#aAlfa#;
      aAlfa = PARAMETRO; |QBF aAlfa;
   |SINO;
      |CLS;
      |CABEZA "Importacion facturas OpenERP";
      |PINPA #0#caerpexp; |PINDA #0#caerpexp;
      |ENDATOS #1#caerpexp;
      |SI FSalida ! 0; |ACABA; |FINSI;

      |GRABA 020#caerpexp.a;
      aAlfa = #caerpexp#0; |QBF aAlfa;
   |FINSI;

   aAlfa = aAlfa < aAlfa;

   |HAZ PreparaDirectorio;

   |IMPRE 0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   || Primero compruebo si lo que voy a procesar es un solo fichero o todo
   ||    lo que haya en el camino (si tiene en el camino la subcadena '.xml'
   ||     es procesar solo un fichero)
   aAlfa1 = aAlfa % -104;
   |SI aAlfa1 ! ".xml";
      |QBF aAlfa;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
         aAlfa = aAlfa + "/";
      |FINSI;
      #caerpexp#0 = aAlfa;

      || Primero compruebo si el camino que he dado ha sido un camino en
      ||    local. Si es asi, copio los xml de la carpeta local a una carpeta
      ||    remota por usuario. Hecho esto, pongo en el path dicha carpeta
      ||    y dejo seguir el proceso ...

      aSwCS = ""; aAlfa = #caerpexp#0; |QBF aAlfa;
      aDirectorio = aAlfa + "*";
      |_PDIR aDirectorio;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa = aDirectorio; |QBF aAlfa;
         aAlfa1 = aAlfa % -104;
         |SI aAlfa1 = ".xml"; aSwCS = "S"; |SAL; |FINSI;
         |_SDIR aDirectorio;
      |SIGUE;

      |SI aSwCS = "";
         aAlfa = #caerpexp#0; |QBF aAlfa;
         aDirectorio = aAlfa + "*";
         |R_PDIR aDirectorio;
         |PARA; |SI FSalida = 0; |HACIENDO;
            aAlfa = aDirectorio; |QBF aAlfa;
            aAlfa1 = aAlfa % -104;
            |SI aAlfa1 = ".xml"; aSwCS = "C"; |SAL; |FINSI;
            |R_SDIR aDirectorio;
         |SIGUE;
      |FINSI;

      |SI aSwCS = "C";
         |DBASE aAlfa1; |QBF aAlfa1;
         aAlfa1 = aAlfa1 + "tmp/";        || |MKDIR aAlfa1;
         aAlfa1 = aAlfa1 + Usuario + "/"; || |MKDIR aAlfa1;
         aDirDestino = aAlfa1;       |QBF aDirDestino;

         aAlfa = #caerpexp#0; |QBF aAlfa; aAlfa2 = aAlfa;
         aDirectorio = aAlfa + "*";
         |R_PDIR aDirectorio;
         |PARA; |SI FSalida = 0; |HACIENDO;
            aAlfa = aDirectorio; |QBF aAlfa;
            aAlfa1 = aAlfa % -104;
            |SI aAlfa1 = ".xml";
               aAlfa1 = aAlfa - aAlfa2;
               aAlfa1 = aDirDestino + aAlfa1;
               |RECIBE_FICHERO aAlfa, aAlfa1;
            |FINSI;
            |R_SDIR aDirectorio;
         |SIGUE;
         #caerpexp#0 = aDirDestino;
      |FINSI;
      |SI aSwCS = ""; |ACABA; |FINSI;

      aAlfa = #caerpexp#0; |QBF aAlfa;
      aDirectorio = aAlfa + "*";
      |_PDIR aDirectorio;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa = aDirectorio; |QBF aAlfa;
         aAlfa1 = aAlfa % -104;
         |SI aAlfa1 = ".xml";
            aPath = #caerpexp#0; |QBF aPath; aFichero = aDirectorio - aPath;
            |DELINDEX #caerptmp; |ABRE #caerptmp;
            |DELINDEX #caerptm1; |ABRE #caerptm1;
            |HAZ TrataOperacion;
            |CIERRA #caerptm1; |DELINDEX #caerptm1;
            |CIERRA #caerptmp; |DELINDEX #caerptmp;
         |FINSI;

         |_SDIR aDirectorio;
      |SIGUE;
   |SINO;
      aSwCS = "";
      |XABRE "E", aAlfa, nHandle;
      |SI FSalida ] 0;
         aSwCS = "S";
      |SINO;
         |XABRE "CE", aAlfa, nHandle;
         |SI FSalida ] 0; aSwCS = "C"; |FINSI;
      |FINSI;

      |SI aSwCS = "C";
         |DBASE aAlfa1; |QBF aAlfa1;
         aAlfa1 = aAlfa1 + "tmp/";        || |MKDIR aAlfa1;
         aAlfa1 = aAlfa1 + Usuario + "/"; || |MKDIR aAlfa1;
         aDirDestino = aAlfa1;       |QBF aDirDestino;

         nCalc = 0;
         aAlfa1 = aAlfa; |QBF aAlfa1;
         aAlfa1 = aAlfa1 - "/";
         |PARA; |SI FSalida ! 0; |HACIENDO;
            nCalc = FSalida + 98;
            aAlfa1 = aAlfa1 - "/";
         |SIGUE;
         |SI nCalc ! 0; aAlfa1 = aAlfa1 % nCalc; |FINSI;

         aAlfa1 = aAlfa1 - "\";
         |PARA; |SI FSalida ! 0; |HACIENDO;
            nCalc = FSalida + 98;
            aAlfa1 = aAlfa1 - "\";
         |SIGUE;
         |SI nCalc ! 0; aAlfa1 = aAlfa1 % nCalc; |FINSI;

         aAlfa1 = aDirDestino + aAlfa1;

         |RECIBE_FICHERO aAlfa, aAlfa1;
         #caerpexp#0 = aAlfa1; aAlfa = aAlfa1;
      |FINSI;

      aAlfa1 = aAlfa - ".xml"; nPosic = 0;
      aAlfa2 = aAlfa1 - "/"; nCalc = 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         nCalc1 = FSalida + nCalc;
         |SI nCalc1 > nPosic; nPosic = nCalc1; |FINSI;
         nCalc = nCalc + 100; aAlfa2 = aAlfa2 - "/";
      |SIGUE;
      aAlfa1 = aAlfa - ".xml"; nCalc = 0;
      aAlfa2 = aAlfa1 - "\";
      |PARA; |SI FSalida ! 0; |HACIENDO;
         nCalc1 = FSalida + nCalc;
         |SI FSalida > nPosic; nPosic = FSalida; |FINSI;
         nCalc = nCalc + 100; aAlfa2 = aAlfa2 - "\";
      |SIGUE;

      |DELINDEX #caerptmp; |ABRE #caerptmp;
      |DELINDEX #caerptm1; |ABRE #caerptm1;

      nCalc = nPosic + 198;
      aFichero = aAlfa % nCalc; aPath = aAlfa - aFichero;
      |HAZ TrataOperacion;
      |CIERRA #caerptm1; |DELINDEX #caerptm1;
      |CIERRA #caerptmp; |DELINDEX #caerptmp;
   |FINSI;

   |CIERRA #calinpag;
   |CIERRA #calincob;

   |CIERRA #caerpcf3;
   |CIERRA #caerpcf2;
   |CIERRA #caerpcf1;

   |CIERRA #caerpexp;

   |FINIMP;
|FPRO;
