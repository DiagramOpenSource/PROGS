|FICHEROS;
   cajaactu #0;
   camaasic #1;
   camaasil #2;
   cajainca #4;
   cajainli #5;
   :/modelos/def/dsmom030 #6;
   cacuenta #3;
   camandia #10;
   calicont #31;
   camanefe #347;
   cajasald #90;
   caconasi #20;

   dscam003@ #2000;
   dscam004@ #2001;
   dscam043@ #2002;
   dscam008@ #2003;
   dscam009@ #2004;
|FIN;

|VARIABLES;
   &entrada = 1;
   &modcon = 0;

   diario = 0;
   fecha  = @;
   docume = 0;
   asient = 0;
   linea  = 0;
   nHandle = 0;

   aAlfa  = "";
   aAlfa1 = "";
   aAlfa2 = "";

   fFecInicio = @;
   fFecFinal  = @;

   cobro = 0;
   pagos = 0;
   tot_cobro = 0;
   tot_pagos = 0;

   afecha = @;
   f1 = @;
   f2 = @;

   cam = 0;
   error = 0;
   signo = "";
   impor = 0;
   conce = 0;
   aun_hay = 0;
   fecinicio = @;
   aUltDes = "";
   aParam  = "";

   aCampo1 = "";
   aCampo2 = "";

   nSwErr  = 0;
   nSwLuxe = 0;
|FIN;

|INCLUYE dscont_i;

|| *********************************************
|PROCESO cuadre; || Cuadrar a Debe y Haber la Caja
   |SI pagos ! 0;
       signo  = "H";
       impor  = pagos;
       conce  = #cajasald#5;
       |HAZ caja_apunte;
   |FINSI;
   |SI cobro ! 0;
       signo = "D";
       impor = cobro;
       conce = #cajasald#4;
       |HAZ caja_apunte;
   |FINSI;
|FPRC;

|PROCESO RevisaRecs;

   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dscarter/def/dscam043.mas";
   |CARGA_DEF aAlfa, dscam043@;
   |SI FSalida = 0;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscarter/fich/";
      |PATH_DAT #dscam043@#aAlfa#;
      |ABRE #dscam043@;
      #dscam043@#0 = #48#2;
      #dscam043@#1 = #48#3;
      #dscam043@#2 = 1;
      |LEE 000#dscam043@.];
      |PARA; |SI FSalida = 0; |Y #dscam043@#0 = #48#2; |Y #dscam043@#1 = #48#3; |HACIENDO;

         |SI #cajainli#8 = "C";
            |SI #dscam043@#3 = "V"; |SAL; |FINSI;
         |FINSI;
         |SI #cajainli#8 = "P";
            |SI #dscam043@#3 = "C"; |SAL; |FINSI;
         |FINSI;
         |LEE 000#dscam043@.s;
      |SIGUE;

      nSwErr = 0;
      |SI FSalida = 0; |Y #dscam043@#0 = #48#2; |Y #dscam043@#1 = #48#3;

         |SI #cajainli#8 = "C";

            |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscarter/def/dscam003.mas";
            |CARGA_DEF aAlfa, dscam003@;

            |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscarter/def/dscam004.mas";
               |CARGA_DEF aAlfa, dscam004@;

               |SI FSalida = 0;
                  |DBASS aAlfa; |QBF aAlfa;
                  aAlfa = aAlfa + "dscarter/fich/" + (("00000" + #dscam043@#9) % -105) + "/";
                  |PATH_DAT #dscam003@#aAlfa#; |PATH_DAT #dscam004@#aAlfa#;
                  |ABRE #dscam003@; |ABRE #dscam004@;
                  |SELECT #7#dscam004@;
                  #dscam004@#6 = #cajainli#1;
                  #dscam004@#40 = " ";
                  |LEE 000#dscam004@.];
                  |PARA; |SI FSalida = 0; |Y #dscam004@#6 = #cajainli#1; |HACIENDO;
                     |SI #dscam004@#55 = "S"; |Y #dscam004@#56 = #cajainli#3; |SAL; |FINSI;
                     |LEE 000#dscam004@.s;
                  |SIGUE;

                  |SI FSalida = 0; |Y #dscam004@#6 = #cajainli#1; |Y #dscam004@#55 = "S"; |Y #dscam004@#56 = #cajainli#3;
                     || Este es .... lo borro y actualizo el recibo
                     |SELECT #1#dscam004@;
                     |LEE 000#dscam004@.=;
                     |SI FSalida = 0;

                        #dscam003@#40 = #dscam004@#17;
                        |LEE 000#dscam003@.=;
                        |SI FSalida = 0;
                           |SI #dscam003@#14 ! "L"; |Y #dscam003@#14 ! "C"; |Y #dscam003@#14 ! "e";
                               |Y #dscam003@#14 ! "A"; |Y #dscam003@#14 ! "D"; |Y #dscam003@#14 ! "E";
                                  nSwErr = 1;
                           |FINSI;
                          ||  |FINSI;
                        |SINO;
                           nSwErr = 2;
                        |FINSI;

                     |FINSI;
                  |FINSI;
                  |DESCARGA_DEF #dscam004@;
               |FINSI;
               |DESCARGA_DEF #dscam003@;
            |FINSI;
         |FINSI;

         |SI #cajainli#8 = "P";

            |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscarter/def/dscam008.mas";
            |CARGA_DEF aAlfa, dscam008@;

            |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscarter/def/dscam009.mas";
               |CARGA_DEF aAlfa, dscam009@;
               |SI FSalida = 0;
                  |DBASS aAlfa; |QBF aAlfa;
                  aAlfa = aAlfa + "dscarter/fich/" + (("00000" + #dscam043@#9) % -105) + "/";
                  |PATH_DAT #dscam008@#aAlfa#; |PATH_DAT #dscam009@#aAlfa#;
                  |ABRE #dscam008@; |ABRE #dscam009@;
                  |SELECT #4#dscam009@;
                  #dscam009@#6 = #cajainli#1;
                  |LEE 000#dscam009@.];
                  |PARA; |SI FSalida = 0; |Y #dscam009@#6 = #cajainli#1; |HACIENDO;
                     |SI #dscam009@#37 = "S"; |Y #dscam009@#38 = #cajainli#3; |SAL; |FINSI;
                     |LEE 000#dscam009@.s;
                  |SIGUE;
                  |SI FSalida = 0; |Y #dscam009@#6 = #cajainli#1; |Y #dscam009@#37 = "S"; |Y #dscam009@#38 = #cajainli#3;
                     #dscam008@#40 = #dscam009@#14;
                     |LEE 000#dscam008@.=;
                     |SI FSalida = 0;
                        |SI #dscam008@#14 ! "L"; |Y #dscam008@#14 ! "C"; |Y #dscam003@#14 ! "e";
                        |Y #dscam008@#14 ! "A"; |Y #dscam008@#14 ! "D";
                           nSwErr = 1;
                        |FINSI;
                     |SINO;
                        nSwErr = 2;
                     |FINSI;
                  |FINSI;
                  |DESCARGA_DEF #dscam009@;
               |FINSI;
               |DESCARGA_DEF #dscam008@;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #dscam043@;
      |DESCARGA_DEF #dscam043@;
   |FINSI;

   |SI nSwErr = 1;
      aAlfa = "    La caja del dia " + #cajainca#1 + " tiene recibos a contabilizar no liquidados. No se actualizara esta relacion";
      |MENAV aAlfa;
      |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaRecs;
#cajainli#1;
;
#cajainca#1, 0001;
#cajainca#1, 9999;
;
NULL, RevisaRecs;
|FIN;

|PROCESO caja_apunte;

   |DDEFECTO #2;
   #camaasil#24 = #camaasic#12;
   #camaasil#0 = diario;
   #camaasil#1 = fecha;
   #camaasil#2 = docume;
   linea = linea + 10;
   #camaasil#3 = linea;
   #camaasil#4 = #cajasald#2;
   eaCuenta = #cajasald#2; |HAZ SacaNivel; #cajasald#3 = enNivel;
   #camaasil#5 = #cajasald#3;

   |DDEFECTO #6;
   #dsmom030#0 = conce;
   |LEE 000#6=;

   #camaasil#6 = conce;
   #camaasil#7 = #dsmom030#1;
   |SI #0#2 = "S"; #camaasil#7 = aUltDes; |FINSI;

   #camaasil#8 = signo;
   #camaasil#9 = impor;
   |HAZ adapta;
   #camaasil#21 = #cajasald#6;
   #camaasil#28 = #cajasald#8;
   |GRABA 020#2n;
   |LIBERA #2;
   |SI FSalida = 0;
      |HAZ act_cabecera;
      MasMenos     = #camaasil#9;
      DebeHaber    = #camaasil#8;
      aCUENTA      = #camaasil#4;
      nREGISTRO    = #camaasil#24;
      nDIARIO      = #camaasil#0;
      aFECHA       = #camaasil#1;
      nDOCUMENTO   = #camaasil#2;
      nNIVELCUENTA = #camaasil#5;
      |HAZ ActDiario;          || diario
      |HAZ ActCuenta;          || cuenta
      |HAZ ActTesteo;          || cuenta
   |FINSI;
|FPRC;

|PROCESO lineas;
   |SI #cajainli#9 = 0; |ACABA; |FINSI;

   |SI cam = 0;
      |HAZ cabecera;
      cam = 1;
   |FINSI;

   |DDEFECTO #2;
   #camaasil#24 = nREGISTRO;
   #camaasil#0 = diario;
   #camaasil#1 = fecha;
   #camaasil#2 = docume;
   linea = linea + 10;
   #camaasil#3 = linea;
   #camaasil#4 = #cajainli#4;
   eaCuenta = #cajainli#4; |HAZ SacaNivel; #cajainli#5 = enNivel;
   #camaasil#5 = #cajainli#5;
   #camaasil#6 = #cajainli#6;
   #camaasil#7 = #cajainli#7;
   |SI #cajainli#8 = "P"; #camaasil#8 = "D"; |FINSI;   || contrapartidas de caja
   |SI #cajainli#8 = "C"; #camaasil#8 = "H"; |FINSI;   || cobro(haber),pago(debe)
   #camaasil#9  = #cajainli#9;
   |HAZ adapta;
   #camaasil#21 = #cajainli#12;
   #camaasil#28 = #cajainli#18;
   #camaasil#12 = #cajainli#13;         || Cobro/Pago
   #camaasil#13 = #cajainli#14;         || libro
   #camaasil#14 = #cajainli#15;         || factura
   #camaasil#15 = #cajainli#16;         || serie (inhibida)
   #camaasil#22 = #cajainli#17;         || N§ recibo
   |GRABA 020#2n;
   |SI FSalida = 0;
      aUltDes = #camaasil#7;
      |SI #cajainli#8 = "P";
          pagos = pagos + #cajainli#9;
          tot_pagos = tot_pagos + #cajainli#9;
      |SINO;
          cobro = cobro + #cajainli#9;
          tot_cobro = tot_cobro + #cajainli#9;
      |FINSI;
      |HAZ act_cabecera;
      MasMenos     = #camaasil#9;
      DebeHaber    = #camaasil#8;
      aCUENTA      = #camaasil#4;
      nREGISTRO    = #camaasil#24;
      nDIARIO      = #camaasil#0;
      aFECHA       = #camaasil#1;
      nDOCUMENTO   = #camaasil#2;
      nNIVELCUENTA = #camaasil#5;
      |HAZ ActDiario;          || diario
      |HAZ ActCuenta;          || cuenta
      |HAZ ActTesteo;          || cuenta

      |SI eaCP347 = "S"; |HAZ Para347; |FINSI;
      |HAZ a_contrapart;
      |BORRA 020#5a;
      |LIBERA #5;

      |SI #0#2 = "S";
          |HAZ cuadre;
          cobro = 0;
          pagos = 0;
          cam   = 0;
     |FINSI;
  |FINSI;
  |LIBERA #2;
|FPRC;

|PROCESO apuntes; || desde el bucle de Cabeceras Caja
   cobro = 0;
   pagos = 0;
   cam   = 0;

   diario = #cajainca#0;
   fecha  = #cajainca#1;
   docume = #cajainca#4 - 1;
   nSwErr = 0;

   |SI nSwLuxe = 0;
      nSwErr = 0;
      |BUCLE RevisaRecs;
      |SI nSwErr = 0;
         |BUCLELIN 0lineas#4;
         |SI cam = 1;
            |HAZ cuadre;
            afecha = fecha;
         |FINSI;
      |FINSI;
   |SINO;
      |BUCLELIN 0lineas#4;
      |SI cam = 1;
         |HAZ cuadre;
         afecha = fecha;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO actsaldo;
   |SI nSwErr = 0;
      #cajasald#7 = afecha;
      #cajasald#1 = #cajasald#1 + tot_cobro - tot_pagos;
      |GRABA 020#90a;
      |LIBERA #90;
   |FINSI;
|FPRC;

|DEFBUCLE contabiliza;
   #4#1;
   ;
   fecinicio;
   fec2;
   e;
   NULL, apuntes, NULL, NULL, actsaldo;
|FIN;

|DEFBUCLE contabiliza2;
   #4#1;
   ;
   fFecInicio;
   fFecFinal;
   e;
   NULL, apuntes, NULL, NULL, actsaldo;
|FIN;

|PROCESO si_quedan;
   aun_hay = 1;
   |SI #cajainli#8 = "P";
      #cajainca#2 = #cajainca#2 + #cajainli#9;
   |SINO;
      #cajainca#3 = #cajainca#3 + #cajainli#9;
   |FINSI;
|FPRC;

|PROCESO borra_cab1;
   aun_hay = 0;
   #cajainca#2 = 0;
   #cajainca#3 = 0;
   |BUCLELIN 2si_quedan#4;
   |SI aun_hay = 0;
      |BORRA 020#4a;
   |SINO;
      |GRABA 020#4a;
      |LIBERA #4;
   |FINSI;
|FPRC;

|DEFBUCLE borra_cab;
   #4#1;
   ;
   f1;
   f2;
   e;
   NULL, borra_cab1;
|FIN;

|| **************************************************************************

|PROCESO actual; |TIPO 3;

   |SI aParam = "eN"; aParam = ""; |FINSI;

   |SI #0#0 = "N"; |ACABA; |FINSI;

   |SI aParam ! "";
       aAlfa = aParam;
       aAlfa = aAlfa - ",";
       |SI FSalida ! 0;
          aAlfa1 = aAlfa % 0110; aAlfa2 = aAlfa % 1110;
       |SINO;
         aAlfa1 = aAlfa; aAlfa2 = aAlfa;
      |FINSI;
      fFecInicio = aAlfa1;
      fFecFinal  = aAlfa2;
   |FINSI;

   || .................. Abrir fichero Saldo Dia Anterior
   |ABRE #90;
   |LEE 101#90p;
   |SI FSalida ! 0;
      |MENAV "    Error, no Existe fichero <Saldo Dia Anterior> ";
      |LIBERA #90;
      |CIERRA #90;
      |ACABA;
   |FINSI;
   |HAZ eLeeParametro;

   |SI fec3 > "01.01.0000";
       |ABRE #4;
       |DDEFECTO #4;
       |SI aParam = "";
           |LEE 001#4p;
       |SINO;
           #4#1 = fFecInicio;
           |LEE 001#4];
       |FINSI;
       |SI #4#1 [ fec3; |Y FSalida = 0;
           |CUADRO 1617 2057;
           |ATRI P;
           |PINTA 1718, " Existen Asientos con Fecha Inferior o ";
           |PINTA 1818, " Igual a la Fecha de Bloqueo de Datos. ";
           |PINTA 1918, " ESTOS ASIENTOS NO SE ACTUALIZARAN     ";
           |ATRI 0;
           |PAUSA;
           |CONFI "    SContinuar el Proceso de Actualizacion ";
           |SI FSalida ! 0;
               |CIERRA #4;
               |ACABA;
           |FINSI;
       |FINSI;
       |CIERRA #4;
   |FINSI;

   |ABRE #1;
   |ABRE #2;
   |ABRE #6;
   |ABRE #31;
   |ABRE #347;

   afecha = #cajasald#7;
   tot_cobro = 0;
   tot_pagos = 0;
   |SI aParam = "";
      f1 = fec3 + "01.00.0000"; fecinicio = f1;
      f2 = "31.12.9999";
      |BUCLE contabiliza;
   |SINO;
      |BUCLE contabiliza2;
      f1 = fFecInicio;
      f2 = fFecFinal;
   |FINSI;

   |CIERRA #1;
   |CIERRA #2;
   |CIERRA #6;

   |CIERRA #10;
   |CIERRA #31;
   |CIERRA #347;
   |CIERRA #90;

   |BUCLE borra_cab;
|FPRC;

|| **************************************************************************

|| ............ Subrutina de Asientos
|PROCESO adapta;
   |SI #camaasil#8 = "D";
      #camaasil#16 = #camaasil#4;
      #camaasil#17 = #camaasil#5;
      #camaasil#10 = "";
      #camaasil#11 = 0;
   |SINO;
      #camaasil#16 = "";
      #camaasil#17 = 0;
      #camaasil#10 = #camaasil#4;
      #camaasil#11 = #camaasil#5;
   |FINSI;
|FPRC;

|PROCESO cabecera; || lee la cabecera.

   |SI  #0#1 = "S";
        |HAZ contador;
        docume = #caconasi#1;
   |SINO;
        docume = docume + 1;
        |HAZ NuevoRegistro;
   |FINSI;
   asient = docume;

   |DDEFECTO #1;
   #camaasic#0 = diario;
   #camaasic#1 = fecha;
   #camaasic#2 = docume;
   #camaasic#3 = asient;
   linea = -9;
   |LEE 110#camaasic.=;
   |SI FSalida = 0;
      #camaasil#0 = #camaasic#0;
      #camaasil#1 = #camaasic#1;
      #camaasil#2 = #camaasic#2;
      #camaasil#3 = 9999;
      |LEE 040#2];
      |SI FSalida = 0;
         |LEE 040#2a;
         |SI #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
            linea = #camaasil#3;
         |FINSI;
      |SINO;
         |LEE 040#2u;
         |SI FSalida = 0; |Y  #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
            linea = #camaasil#3;
         |FINSI;
      |FINSI;
      nREGISTRO = #camaasic#12;
   |SINO;
      |DDEFECTO #1;
      #camaasic#0 = diario;
      #camaasic#1 = fecha;
      #camaasic#2 = docume;
      #camaasic#3 = asient;
      #camaasic#12=nREGISTRO;

      |DDEF aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "luxeg001.mas";
      |XABRE "E", aAlfa, nHandle;
      |SI FSalida = 0; #camaasic#13 = 105; |FINSI;
      |GRABA 020#camaasic.n;
   |FINSI;
   |LIBERA #camaasic;
|FPRC;

|PROCESO act_cabecera;
   #camaasic#0 = #camaasil#0;
   #camaasic#1 = #camaasil#1;
   #camaasic#2 = #camaasil#2;
   |LEE 101#1=;
   |SI #camaasil#8 = "D";
      #camaasic#4 = #camaasic#4 + #camaasil#9;
      |SI #camaasic#09 = 0; #camaasic#08 = #camaasil#4; #camaasic#09 = #camaasil#5; |FINSI;  || contrp.HABER
   |SINO;
      #camaasic#5 = #camaasic#5 + #camaasil#9;
      |SI #camaasic#11 = 0; #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5; |FINSI;  || contrp.DEBE
   |FINSI;
   #camaasic#6 = #camaasic#4 - #camaasic#5;        || saldo
   #camaasic#12 = nREGISTRO;
   |GRABA 020#1a;
   |LIBERA #1;
|FPRC;

|PROCESO a_contrapart;
   #calicont#0 = #camaasil#0;
   #calicont#1 = #camaasil#1;
   #calicont#2 = #camaasil#2;
   #calicont#3 = #camaasil#3;
   |LEE 101#31=;
   |SI FSalida ! 0;
      #calicont#0 = #camaasil#0;
      #calicont#1 = #camaasil#1;
      #calicont#2 = #camaasil#2;
      #calicont#3 = #camaasil#3;
      |GRABA 020#31b;
   |FINSI;
   #calicont#4 = #cajasald#2;
   #calicont#5 = #cajasald#3;
   |GRABA 020#31a;
   |LIBERA #31;
|FPRC;

|PROCESO Para347;
   |SI #cajainli#19 > 0;
       #camanefe#0 = #camaasil#0;
       #camanefe#1 = #camaasil#1;
       #camanefe#2 = #camaasil#2;
       #camanefe#3 = #camaasil#3;
       |LEE 101#347=;
       |SI FSalida ! 0;
           #camanefe#0 = #camaasil#0;
           #camanefe#1 = #camaasil#1;
           #camanefe#2 = #camaasil#2;
           #camanefe#3 = #camaasil#3;
           |GRABA 020#347b;
       |FINSI;
       #camanefe#4 = #cajainli#19;
       #camanefe#5 = 99;
       #camanefe#6 = #camaasil#24;
       |GRABA 020#347a;
       |LIBERA #347;
   |FINSI;
|FPRC;


|PROGRAMA;

   |HAZ inicial; |SI swerror = 2; |ACABA; |FINSI;
   aParam = PARAMETRO; |QBF aParam;

   |HAZ EsLuxe; nSwLuxe = FSalida;

   |ABRE #0;
   #0#3 = "A";
   |LEE 041#0=;
   |SI FSalida ! 0;
       |DDEFECTO #0;
       #0#3 = "A";
       |GRABA 020#0n;
   |FINSI;

   |CLS;
   |CABEZA "Actualizacion Caja";

   |PINPA #0#0;
   |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
       aCampo1 = #0#1;
       aCampo2 = #0#2;
       #0#3 = "A";
       |LEE 141#0=;
       |SI FSalida ! 0;
           #0#3 = "A";
           |GRABA 020#0b;
       |FINSI;
       #0#0 = "N";
       #0#1 = aCampo1;
       #0#2 = aCampo2;
       |GRABA 020#0a;
       |LIBERA #0;
   |FINSI;
   |CIERRA #0;
|FPRO;
