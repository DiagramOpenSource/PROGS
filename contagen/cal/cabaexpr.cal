|FICHEROS;
   cabaexpr #0;
   cacuentm #1;    || temporal cuentas presupuestos
   caparexp #2;
   cabaexp0 #3;
   cabaexp1 #4;
   caexistc #6;
   caexistl #7;
   cacuenta #10;   || plan contable
   cacuepre #11;   || fichas presupuestarias
   canempre #30;
|FIN;

|VARIABLES;
   &entrada = 1;
   nNume1 = 0;
   mes = 0;
   campito = 0;
   nivel = 0;
   sw_pasa = 0;
   linea = 0;
   FEstado = 0;
   posici = 0;
   debe1 = 0;
   de_p1 = 0;
   x = 0;
   eldesde = 0;
   eldes_p = 0;
   elhasta = 0;
   elhas_p = 0;
   sw_d1 = 0;
   debe2 = 0;
   de_p2 = 0;
   sw_d2 = 0;
   debe3 = 0;
   de_p3 = 0;
   sw_d3 = 0;
   debe4 = 0;
   de_p4 = 0;
   sw_d4 = 0;
   haber1 = 0;
   hab_p1 = 0;
   sw_h1 = 0;
   haber2 = 0;
   hab_p2 = 0;
   sw_h2 = 0;
   haber3 = 0;
   hab_p3 = 0;
   sw_h3 = 0;
   sw = 0;
   bloque = 0;
   agrupaci = 0;
   epigrafe = 0;
   partida = 0;
   bloque1 = 0;
   H = 0;
   sw_epi = 0;
   sw_d21 = 0;
   sw_d31 = 0;
   sw_h21 = 0;
   sw_h31 = 0;
   sw_h32 = 0;
   punto_h1 = 0;
   punto_d1 = 0;
   punto_h2 = 0;
   punto_d2 = 0;
   punto_h3 = 0;
   punto_d3 = 0;
   punto_h4 = 0;
   punto_d4 = 0;
   punto_h5 = 0;
   punto_d5 = 0;
   xxxxfiac = "  ";          || Variables para no modificable
   xxaponer = "  ";
   xrelleno = "                              ";
   informe  = "cabaexpr";
   d = "D";
   h = "H";
   tipo = "";
   tipo1 = "";
   &sw_inf = 0;
   &cantidad = 0;
   &cantidad_p = 0;
   &variable = "";
   &canti = 0;
   &canti_p = 0;
   &doh = "";
   mes_fin = 0;
   runnom = "cabaexpr";
   descar = 0;
   traraf = 0;
   &r_eje = 0;
   &r_nom = "";
   &d_mes = 0;
   &h_mes = 0;
   &estru = 0;
   &r_emp = 0;
   &r_per = 0;
   &aparam = "";
   nume1 = 0;
   nume2 = 0;
   des_pre = " ";
   has_pre = "z";
   t_agrupa = 0;
   aFichero = "";
   nSw      = 0;
   &eaTexto = "";
|FIN;

|INCLUYE dscont_i;
|INCLUYE digito_i;

|CALCULO inicio_b; |TIPO 8;
  |HAZ inicio;
  |HAZ DirAplicSt;
|FCAL;

|CALCULO estruc7; |TIPO 7;
 #0#6 = 1;
 |SI Haybasica = 1; |Y eaDepar = "S";
     #0#6 = 0;
 |FINSI;
 |PINTA #0#6;
|FCAL

|PROCESO LeeAgrupa;
    |SI t_agrupa ! #0#12; |O nSw = 0;
        #0#15 = "M";
        |ABRE #11;
        #11#19 = #0#12;
        #11#0  = doce;
        #11#1  = 0;
        |LEE 041#11];
        |SI FSalida = 0; |Y #11#19 = #0#12;
            #0#15 = #11#3;
        |FINSI;
        |CIERRA #11;
        |PINTA #0#15;
        nSw = 1;
        t_agrupa = #0#12;
    |FINSI;
|FPRC;

|PROCESO presup2;    || si no esta como ficha presupuestaria no sale SI

   |DDEFECTO #11;
   #cacuepre#19 = t_agrupa;
   #cacuepre#0 = #cacuenta#0;
   #cacuepre#1 = #cacuenta#1;
   |LEE 001#11=;

   |PARA nume1 = 0; |SI nume1 [ 58; |HACIENDO nume1 = nume1 + 1;
      #cacuentm#nume1# = #cacuenta#nume1#;
   |SIGUE;

   |PARA nume1 = 59; |SI nume1 [ 70; |HACIENDO nume1 = nume1 + 1;
      nume2 = nume1 - 55;
      #cacuentm#nume1# = #cacuepre#nume2#;
   |SIGUE;
   #cacuentm#71 = #cacuepre#02;  || signo
   |GRABA 020#1n;
|FPRC;

|DEFBUCLE bu_pres2;   || balances situacion y explotacion
   #10#4;
   ;
   des_pre, 0,  0,  0,  0;
   has_pre, 4, 99, 99, 99;
   e;
   NULL, presup2;
|FIN;

|PROCESO presup0; |TIPO 0;
   |SI FSalida = 0;

      |HAZ pre_aviso;
      aFichero = ("9p" + Usuario) % 108;
      |NOME_DAT #1 aFichero;
      |DELINDEX #1;

      |ABRE #1;
      |ABRE #11;
      |SI runnom ! "caybalpr";   |BUCLE bu_pres2;   |FINSI;
      |CIERRA #1;
      |CIERRA #11;
      |POPV;
   |FINSI;

|FPRC;

|PROCESO pre_aviso;
   |PUSHV 11181760;
   |ATRI P;
   |CUADRO 11 18 15 60;
   |ATRI R;
   |CUADRO 12 19 14 59;
   |ATRI 0;
   |ATRI R;
   |ATRI I;
   |PINTA 1320, " Procesando Fichas Presupuestarias ... ";
   |ATRI 0;
|FPRC;


|PROCESO antesque;
   aparam = PARAMETRO;
   |QBF aparam; |SI aparam = " N"; aparam = ""; |FINSI;
   |SI aparam = "fech";
      |NOME_DAT #10 "cabalano";
      |NOME_DAT #11 "cabalpre";
   |FINSI;
|FPRC;

|| ========================================================================
||                        CALCULOS PANTALLA
|| ========================================================================

|PROCESO pintames; |TIPO 0;
  nNume1 = Campo + 2;
  |SI #0Campo ! 0; |Y #0Campo ! 13;
      NumMes = dig1 + (#0Campo - 1);
      |SI NumMes > 12;
          NumMes = NumMes - 12;
      |FINSI;
  |SINO;
      NumMes = #0Campo;
  |FINSI;
  |HAZ NombreMes;
  #0nNume1 = NombreMes; |PINTA #0nNume1;

   |SI Campo = 1;
      |SI #cabaexpr#0 > #cabaexpr#1;
         |MENAV "    Error de Entrada ...";
         |ERROR;
      |FINSI;                           || Si el mes hasta es menor al desde
   |FINSI;
|FPRC;

|PROCESO pintames2; |TIPO 0;
  |SI #0Campo ! 0; |Y #0Campo ! 13;
      NumMes = dig1 + (#0Campo - 1);
      |SI NumMes > 12;
          NumMes = NumMes - 12;
      |FINSI;
  |SINO;
      NumMes = #0Campo;
  |FINSI;
  |HAZ NombreMes;
   |ATRI I;
   |SI Campo = 10;  |PINTA 1727, NombreMes;  |FINSI;
   |SI Campo = 11;  |PINTA 1827, NombreMes;  |FINSI;
   |ATRI 0;
|FPRC;

|PROCESO nivel; |TIPO 7;
   |SI #cabaexpr#4 = "N";
      |CAMPO_MODIFICA #cabaexpr#5,1,"N";
      #cabaexpr#5 = dig3;
   |SINO;
      |CAMPO_MODIFICA #cabaexpr#5,1,"S";
   |FINSI;
|FPRC;

|PROCESO miraniv; |TIPO 0;
   nivel = #cabaexpr#5;
   |SI nivel = 1;|Y dig4 = 0;  |AVISO;  |ERROR;  |FINSI;
   |SI nivel = 2;|Y dig5 = 0;  |AVISO;  |ERROR;  |FINSI;
   |SI nivel = 3;|Y dig6 = 0;  |AVISO;  |ERROR;  |FINSI;
   |SI nivel = 4;|Y dig7 = 0;  |AVISO;  |ERROR;  |FINSI;
   |SI nivel = 5;|Y dig8 = 0;  |AVISO;  |ERROR;  |FINSI;
   |SI nivel = 6;|Y dig9 = 0;  |AVISO;  |ERROR;  |FINSI;
|FPRC;

|PROCESO estruct; |TIPO 0;
   |SI #cabaexpr#6 = 0;  |ACABA;  |FINSI;
   |ABRE #6;
   #caexistc#0 = #cabaexpr#6;
   |LEE 040#6=;
   |SI FSalida ! 0;
      |MENAV "    No existe la estructura de descarga.";
      |CIERRA #6;
      |ERROR;
      |ACABA;
   |FINSI;
   |CIERRA #6;
|FPRC;

|PROCESO nomodifi;             || RUTINA DE CONVERSION A NO MODIFICABLES
   xxaponer = Anono;
   xxxxfiac = Control % A1001;
   Control = Control + xxxxfiac;
   Control = Control + xrelleno;
   Control = Control % A120;
   Control = Control + xxaponer;
|FPRC;

|| ========================================================================
||                        CALCULOS INFORME
|| ========================================================================

|PROCESO calculit;
   |HAZ digitos2;
   |SI d_error ! 0;  |ACABA;  |FINSI;
   |SI #cabaexpr#4 = "S";
      |SI #cacuentm#55 [ nivel;
         |SI #cacuentm#3 = "S";
            |HAZ grabatra;
         |SINO;
            |SI #cacuentm#55 = nivel; |HAZ grabatra; |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      |SI #cacuentm#3 = "S"; |HAZ grabatra; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE cabaexpr0;
   #1#4;
   ;
   d, 0, 01, 00, 00;
   h, 4, 99, 99, 99;
   e;
   NULL,calculit;
|FIN;

|PROCESO impresio;
   |SI sw = 0;
      bloque = #cabaexp0#1;
      tipo = #cabaexp0#0;
      agrupaci = #cabaexp0#2;
      epigrafe = #cabaexp0#3;
      partida = #cabaexp0#4;
      |SI #cabaexp0#0 = "D"; doh = "DEBE";  |FINSI;
      |SI #cabaexp0#0 = "H"; doh = "HABER"; |FINSI;
      sw_inf = 0;
      |PRINT;
      sw = 1;
   |FINSI;

   |SI bloque = #cabaexp0#1; |Y tipo = #cabaexp0#0;
      |HAZ epigraf;
   |SINO;
      |SI tipo ! #cabaexp0#0;                    || ruptura por tipo
         bloque1 = bloque;
         bloque = 4;
         |HAZ mirablo;
         doh = "HABER";
         |PIEINF;
         sw_inf = 0;
         |PRINT;
         |HAZ epigraf;
         bloque = bloque1;
      |SINO;                              || ruptura por bloque
         |HAZ mirablo;
         |HAZ epigraf;
      |FINSI;
      bloque = #cabaexp0#1;
      tipo = #cabaexp0#0;
   |FINSI;
|FPRC;

|DEFBUCLE cabaexpr1;
   #3#1;
   ;
   d, 0, 01, 00, 00;
   h, 4, 99, 99, 99;
   e;
   NULL,impresio;
|FIN;

|PROCESO miracuen;
   |SI #cabaexp1#6 = #cacuentm#0;
      cantidad = cantidad + (#cabaexp1#4 - #cabaexp1#5);
      sw_pasa = 1;
   |FINSI;
|FPRC;

|DEFBUCLE cabaexpr4;
   #4#1;
   ;
   #0#6, 001;
   #0#6, 999;
   e;
   NULL,miracuen;
|FIN;

|PROCESO cuentas;
   |HAZ digitos2;
   |SI d_error ! 0;  |ACABA;  |FINSI;
   sw_pasa = 0;
   cantidad = 0;
   cantidad_p = 0;
   sw_inf = 6;
   |SI #cabaexpr#4 = "S";
      |SI #cacuentm#55 [ nivel;
         |SI #cacuentm#3 = "S";
            |BUCLE cabaexpr4;
            |SI sw_pasa = 1;
               |SI cantidad ! 0; |PRINT; |FINSI;
            |SINO;
               |HAZ recuenta;
            |FINSI;
         |SINO;
            |SI #cacuentm#55 = nivel;
               |BUCLE cabaexpr4;
               |SI sw_pasa = 1;
                  |SI cantidad ! 0; |PRINT; |FINSI;
               |SINO;
                  |HAZ recuenta;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      |SI #cacuentm#3 = "S";
         |BUCLE cabaexpr4;
         |SI sw_pasa = 1;
            |SI cantidad ! 0; |PRINT; |FINSI;
         |SINO;
            |HAZ recuenta;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE cabaexpr2;
   #1#4;
   ;
   #3#0, #3#1, #3#2, #3#3, #3#4;
   #3#0, #3#1, #3#2, #3#3, #3#4;
   e;
   NULL, NULL, NULL, NULL, NULL, cuentas;
   #1#0, #1#1;
|FIN;

|PROCESO descarg;
   |HAZ digitos2;
   |SI d_error ! 0;  |ACABA;  |FINSI;
   linea = linea + 1;
   #cabaexp1#0 = linea;
   #cabaexp1#8 = #cabaexpr#6;
   |LEE 001#4=;
   |SI FSalida = 0;  |BORRA 020#4a;  |FINSI;
   |DDEFECTO #4;
   #cabaexp1#0 = linea;    || linea
   #cabaexp1#8 = #cabaexpr#6;     || estructura
   #cabaexp1#1 = #cacuentm#0;     || cuenta
   #cabaexp1#2 = #cacuentm#1;     || digito
   #cabaexp1#3 = #cacuentm#2;     || descripcion
   mes_fin = #cabaexpr#10 + 11;              || mes iniciales
   #cabaexp1#4 = #caexistl#mes_fin#;                  || exist. iniciales
   mes_fin = #cabaexpr#11 + 11;              || mes finales
   #cabaexp1#5 = #caexistl#mes_fin#;                  || exist. finales
   descar = #cabaexp1#4 - #cabaexp1#5;
   |SI descar ] 0;
      #cabaexp1#6 = #caexistl#5;     || cuenta descarga D
      #cabaexp1#7 = #caexistl#6;     || digito descarga D
   |SINO;
      #cabaexp1#6 = #caexistl#8;     || cuenta descarga H
      #cabaexp1#7 = #caexistl#9;     || digito descarga H
   |FINSI;
   |SI nivel < #cabaexp1#7;
      |SI nivel = 1;  traraf = 100 + dig4;  |FINSI;
      |SI nivel = 2;  traraf = 100 + dig5;  |FINSI;
      |SI nivel = 3;  traraf = 100 + dig6;  |FINSI;
      |SI nivel = 4;  traraf = 100 + dig7;  |FINSI;
      |SI nivel = 5;  traraf = 100 + dig8;  |FINSI;
      #cabaexp1#6 = #cabaexp1#6 % traraf;
      #cabaexp1#7 = nivel;
      #cabaexp1#6 = #cabaexp1#6 + "              ";
      #cabaexp1#6 = #cabaexp1#6 % 112;
   |FINSI;
   |GRABA 020#4n;
   |HAZ grabatr1;
|FPRC;

|DEFBUCLE cabaexpr3;
   #1#1;
   ;
   #7#2, #7#3;
   #7#2, #7#3;
   e;
   NULL,descarg;
|FIN;

|PROCESO grabatra;
   #cabaexp0#0 = #cacuentm#5;
   #cabaexp0#1 = #cacuentm#4;
   #cabaexp0#2 = #cacuentm#6;
   #cabaexp0#3 = #cacuentm#7;
   #cabaexp0#4 = #cacuentm#8;
   |LEE 101#3=;
   FEstado = FSalida;
   |SI FEstado ! 0;
      |DDEFECTO #3;
      #cabaexp0#0 = #cacuentm#5;
      #cabaexp0#1 = #cacuentm#4;
      #cabaexp0#2 = #cacuentm#6;
      #cabaexp0#3 = #cacuentm#7;
      #cabaexp0#4 = #cacuentm#8;
   |FINSI;
   |HAZ leexplot;
   #cabaexp0#5 = #caparexp#3;
   #cabaexp0#6 = #caparexp#5;
   #cabaexp0#7 = #caparexp#7;
   sw_pasa = 0;
   |SI #cabaexp0#9 = 1;
      |BUCLE cabaexpr4;
      #cabaexp0#9 = 1;
   |SINO;
      #cabaexp0#9 = 0;
   |FINSI;
   |SI sw_pasa = 0;
      |HAZ resulta;
      #cabaexp0#9 = 0;
      |SI #cabaexp0#8 ! 0;|O #cabaexp0#10 ! 0;
         |SI FEstado = 0; |GRABA 020#3a; |SINO; |GRABA 020#3n; |FINSI;
      |FINSI;
   |FINSI;
   |LIBERA #3;
|FPRC;

|PROCESO grabatr1;
   |ABRE #1;
   #cacuentm#0 = #cabaexp1#6;
   #cacuentm#1 = #cabaexp1#7;
   |LEE 040#1=;
   |SI FSalida = 0;
      #cabaexp0#0 = #cacuentm#5;
      #cabaexp0#1 = #cacuentm#4;
      #cabaexp0#2 = #cacuentm#6;
      #cabaexp0#3 = #cacuentm#7;
      #cabaexp0#4 = #cacuentm#8;
      |LEE 101#3=;
      FEstado = FSalida;
      |SI FEstado ! 0;
         |DDEFECTO #3;
         #cabaexp0#0 = #cacuentm#5;
         #cabaexp0#1 = #cacuentm#4;
         #cabaexp0#2 = #cacuentm#6;
         #cabaexp0#3 = #cacuentm#7;
         #cabaexp0#4 = #cacuentm#8;
      |FINSI;
      |HAZ leexplot;
      #cabaexp0#5 = #caparexp#3;
      #cabaexp0#6 = #caparexp#5;
      #cabaexp0#7 = #caparexp#7;
      #cabaexp0#8 = #cabaexp0#8 + (#cabaexp1#4 - #cabaexp1#5);
      #cabaexp0#9 = 1;
      |SI #cabaexp0#8 ! 0;
         |SI FEstado = 0; |GRABA 020#3a; |SINO; |GRABA 020#3n; |FINSI;
      |FINSI;
      |LIBERA #3;
      |HAZ sumasal;
   |FINSI;
   |CIERRA #1;
|FPRC;

|PROCESO resulta;    || Calculamos cada cuenta
   |SI #cabaexp0#0 = "D"; |Y #cabaexp0#1 = 1;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8 = #cabaexp0#8   + #cacuentm#x#;
         debe1 = debe1 + #cacuentm#x#;
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + #cacuentm#x#;
         de_p1 = de_p1 + #cacuentm#x#;
      |SIGUE;
      sw_d1 = 1;
   |FINSI;

   |SI #cabaexp0#0 = "D"; |Y #cabaexp0#1 = 2;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8 = #cabaexp0#8   + #cacuentm#x#;
         debe2 = debe2 + #cacuentm#x#;
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + #cacuentm#x#;
         de_p2 = de_p2 + #cacuentm#x#;
      |SIGUE;
      sw_d2 = 1;
   |FINSI;

   |SI #cabaexp0#0 = "D"; |Y #cabaexp0#1 = 3;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8 = #cabaexp0#8   + #cacuentm#x#;
         debe3 = debe3 + #cacuentm#x#;
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + #cacuentm#x#;
         de_p3 = de_p3 + #cacuentm#x#;
      |SIGUE;
      sw_d3 = 1;
   |FINSI;

   |SI #cabaexp0#0 = "D"; |Y #cabaexp0#1 = 4;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8 = #cabaexp0#8   + #cacuentm#x#;
         debe4 = debe4 + #cacuentm#x#;
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + #cacuentm#x#;
         de_p4 = de_p4 + #cacuentm#x#;
      |SIGUE;
      sw_d4 = 0;
   |FINSI;

   |SI #cabaexp0#0 = "H"; |Y #cabaexp0#1 = 1;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8   = #cabaexp0#8   + (#cacuentm#x# * -1);
         haber1 = haber1 + (#cacuentm#x# * -1);
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + (#cacuentm#x# * -1);
         hab_p1 = hab_p1 + (#cacuentm#x# * -1);
      |SIGUE;
      sw_h1 = 1;
   |FINSI;

   |SI #cabaexp0#0 = "H"; |Y #cabaexp0#1 = 2;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8   = #cabaexp0#8   + (#cacuentm#x# * -1);
         haber2 = haber2 + (#cacuentm#x# * -1);
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + (#cacuentm#x# * -1);
         hab_p2 = hab_p2 + (#cacuentm#x# * -1);
      |SIGUE;
      sw_h2 = 1;
   |FINSI;

   |SI #cabaexp0#0 = "H"; |Y #cabaexp0#1 = 3;
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         #cabaexp0#8   = #cabaexp0#8   + (#cacuentm#x# * -1);
         haber3 = haber3 + (#cacuentm#x# * -1);
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         #cabaexp0#10 = #cabaexp0#10 + (#cacuentm#x# * -1);
         hab_p3 = hab_p3 + (#cacuentm#x# * -1);
      |SIGUE;
      sw_h3 = 1;
   |FINSI;

|FPRC;

|PROCESO sumasal;    || Calculamos cada cuenta
   |SI #cabaexp0#0 = "D"; |Y #cabaexp0#1 = 1;
      debe1 = debe1 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "D"; |Y #cacuentm#4 = 2;
      debe2 = debe2 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "D"; |Y #cacuentm#4 = 3;
      debe3 = debe3 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "D"; |Y #cacuentm#4 = 4;
      debe4 = debe4 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "H"; |Y #cacuentm#4 = 1;
      haber1 = haber1 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "H"; |Y #cacuentm#4 = 2;
      haber2 = haber2 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;

   |SI #cacuentm#5 = "H"; |Y #cacuentm#4 = 3;
      haber3 = haber3 + (#cabaexp1#4 - #cabaexp1#5);
   |FINSI;
|FPRC;

|PROCESO epigraf;
   |SI epigrafe = #cabaexp0#3;
      |HAZ rotura;
   |SINO;
      sw_epi = 0;
      |HAZ rotura;
      epigrafe = #cabaexp0#3;
   |FINSI;
|FPRC;

|PROCESO rotura;
   |SI #cabaexp0#4 = 0;
      sw_inf = 2;
      |PRINT;
      |SI #cabaexpr#4 = "S";
         |BUCLE cabaexpr2;
         sw_inf = 5; |PRINT;
      |FINSI;
   |SINO;
      |SI sw_epi = 0;
         sw_inf = 3;
         |PRINT;
         sw_epi = 1;
      |FINSI;
      sw_inf = 4;
      |PRINT;
      |SI #cabaexpr#4 = "S";
         |BUCLE cabaexpr2;
         sw_inf = 5; |PRINT;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO leexplot;  || Lee el fichero de explotacion
   #caparexp#0 = #cabaexp0#1;
   #caparexp#1 = #cabaexp0#0;
   #caparexp#2 = #cabaexp0#2;
   #caparexp#4 = #cabaexp0#3;
   #caparexp#6 = #cabaexp0#4;
   |LEE 040#2=; |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
|FPRC;

|PROCESO final;    || Para cuando acaba el defbucle
   |SI tipo = "D"; bloque = 4; |FINSI;
   |SI tipo = "H"; bloque = 3; |FINSI;
   |HAZ mirablo;
|FPRC;

|PROCESO recuenta;    || Calculamos cada cuenta
   |SI #cabaexp0#0 =  "D";
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         cantidad = cantidad + #cacuentm#x#;
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         cantidad_p = cantidad_p + #cacuentm#x#;
      |SIGUE;
   |FINSI;

   |SI #cabaexp0#0 = "H";
      |PARA x = eldesde; |SI x [ elhasta; |HACIENDO x = x + 3;
         cantidad = cantidad + (#cacuentm#x# * -1);
      |SIGUE;
      |PARA x = eldes_p; |SI x [ elhas_p; |HACIENDO x = x + 1;
         cantidad_p = cantidad_p + (#cacuentm#x# * -1);
      |SIGUE;
   |FINSI;

   |SI cantidad ! 0;|O cantidad_p ! 0;   |PRINT;   |FINSI;
|FPRC;

|PROCESO mirablo;
   sw_inf = 1;
   |SI tipo = "D";
      |SI bloque = 4;
         |HAZ bloqued1;
         |HAZ bloqued2;
         |HAZ bloqued3;
         |HAZ bloqued4;
      |FINSI;
      |SI bloque = 3;
         |HAZ bloqued1;
         |HAZ bloqued2;
         |HAZ bloqued3;
      |FINSI;
      |SI bloque = 2;
         |HAZ bloqued1;
         |HAZ bloqued2;
         |SI #cabaexp0#1 > 3;
            |HAZ bloqued3;   || si no hay del bloque 3
         |FINSI;
      |FINSI;
      |SI bloque = 1;          || anterior a la ruptura
         |HAZ bloqued1;
         |SI #cabaexp0#1 > 2;
            |HAZ bloqued2;   || si no hay del bloque 2
            |SI #cabaexp0#1 > 3;
               |HAZ bloqued3;    || si no hay del bloque 3
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI tipo = "H";
      |SI bloque = 3;
         |HAZ bloqueh1;
         |HAZ bloqueh2;
         |HAZ bloqueh3;
      |FINSI;
      |SI bloque = 2;
         |HAZ bloqueh1;
         |HAZ bloqueh2;
      |FINSI;
      |SI bloque = 1;
         |HAZ bloqueh1;
         |SI #cabaexp0#1 > 2;
            |HAZ bloqueh2;   || si no hay del bloque 2
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO bloqued1;
   |SI sw_d1 = 1; |O sw_h1 = 1; |HAZ tipod1;  |FINSI;      || I
|FPRC;

|PROCESO bloqued2;
   |SI sw_d2 = 1; |O sw_h2 = 1; |HAZ tipod2;  |FINSI;      || II
   |SI sw_d21 = 0;              |HAZ tipod21; |FINSI;      || III
|FPRC;

|PROCESO bloqued3;
   |SI sw_d3 = 1; |O sw_h3 = 1; |HAZ tipod3;  |FINSI;      || IV
   |SI sw_d31 = 0;              |HAZ tipod31; |FINSI;      || V
|FPRC;

|PROCESO bloqued4;
   |SI sw_d4 = 0;               |HAZ tipod4;  |FINSI;      || VI
|FPRC;

|PROCESO bloqueh1;
   |SI sw_d1 = 1; |O sw_h1 = 1; |HAZ tipoh1;  |FINSI;      || I
|FPRC;

|PROCESO bloqueh2;
   |SI sw_d2 = 1; |O sw_h2 = 1; |HAZ tipoh2;  |FINSI;      || II
   |SI sw_h21 = 0;              |HAZ tipoh21; |FINSI;      || III
|FPRC;

|PROCESO bloqueh3;
   |SI sw_d3 = 1; |O sw_h3 = 1; |HAZ tipoh3;  |FINSI;      || IV
   |SI sw_h31 = 0;              |HAZ tipoh31; |FINSI;      || V
   |SI sw_h32 = 0;              |HAZ tipoh32; |FINSI;      || VI
|FPRC;

|PROCESO tipod1;
   variable = "  I. BENEFICIOS DE EXPLOTACION ..........................";
   canti = haber1 - debe1;
   |SI canti < 0;
      punto_h1 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d1 = 0;
      sw_h1 = 0;
      punto_d1 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh1;
   variable = "  I. PERDIDAS DE EXPLOTACION ............................";
   canti = debe1 - haber1;
   |SI canti [ 0;
      punto_d1 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d1 = 0;
      sw_h1 = 0;
      punto_h1 = canti;
   |FINSI;
|FPRC;

|PROCESO tipod2;
   variable = " II. RESULTADOS FINANCIEROS POSITIVOS ...................";
   canti = haber2 - debe2;
   |SI canti < 0;
      punto_h2 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d2 = 0;
      sw_h2 = 0;
      punto_d2 = canti;
   |FINSI;
|FPRC;

|PROCESO tipod21;
   variable = "III. BENEFICIOS DE LAS ACTIVIDADES ORDINARIAS ...........";
   canti = punto_d1 + punto_d2 - punto_h1 - punto_h2;
   |SI canti < 0;
      punto_h3 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d21 = 1;
      punto_d3 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh2;
   variable = " II. RESULTADOS FINANCIEROS NEGATIVOS ...................";
   canti = debe2 - haber2;
   |SI canti [ 0;
      punto_d2 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d2 = 0;
      sw_h2 = 0;
      punto_h2 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh21;
   variable = "III. PERDIDAS DE LAS ACTIVIDADES ORDINARIAS .............";
   canti = punto_h1 + punto_h2 - punto_d1 - punto_d2;
   |SI canti [ 0;
      punto_d3 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_h21 = 1;
      punto_h3 = canti;
   |FINSI;
|FPRC;

|PROCESO tipod3;
   variable = " IV. RESULTADOS EXTRAORDINARIOS POSITIVOS ...............";
   canti = haber3 - debe3;
   |SI canti < 0;
      punto_h4 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d3 = 0;
      sw_h3 = 0;
      punto_d4 = canti;
   |FINSI;
|FPRC;

|PROCESO tipod31;
   variable = "  V. BENEFICIO ANTES DE IMPUESTOS .......................";
   canti = punto_d3 + punto_d4 - punto_h3 - punto_h4;
   |SI canti < 0;
      punto_h5 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d31 = 1;
      punto_d5 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh3;
   variable = " IV. RESULTADOS EXTRAORDINARIOS NEGATIVOS ...............";
   canti = debe3 - haber3;
   |SI canti [ 0;
      punto_d5 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d3 = 0;
      sw_h3 = 0;
      punto_h4 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh31;
   variable = "  V. PERDIDAS ANTES DE IMPUESTOS ........................";
   canti = punto_h3 + punto_h4 - punto_d3 - punto_d4;
   |SI canti [ 0;
      punto_d5 = canti * -1;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_h31 = 1;
      punto_h5 = canti;
   |FINSI;
|FPRC;

|PROCESO tipoh32;
   variable = " VI. RESULTADO DEL EJERCICO (PERDIDAS) ..................";
   ||canti = punto_h5 + debe4;
   canti = punto_h5;
   |SI punto_h5 > 0;
      canti = canti + debe4;
   |FINSI;
   |SI canti [ 0;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_h32 = 1;
   |FINSI;
|FPRC;

|PROCESO tipod4;
   variable = " VI. RESULTADO DEL EJERCICIO (BENEFICIOS) ...............";
   ||canti = punto_d5 - debe4;
   canti = punto_d5;
   |SI debe4 > 0;
      canti = canti - debe4;
   |FINSI;
   |SI canti [ 0;
      canti = 0;
   |SINO;
      sw_inf = 5; |PRINT;
      sw_inf = 1; |PRINT;
      sw_inf = 5; |PRINT;
      sw_d4 = 1;
   |FINSI;
|FPRC;

|PROCESO conexi; |TIPO 0;
   enTExi = 1;
   d_mes = #cabaexpr#10;
   h_mes = #cabaexpr#11;
   estru = #cabaexpr#6;
   r_emp = empre;
   r_per = ejerc;
   r_eje = #canempre#26;
   r_nom = #canempre#1;
   |SUB_EJECUTA "caexicon.run";
|FPRC;

|PROCESO impre; |TIPO 3;
   |HAZ antesque;

   |SI #0#14 = "S"; |HAZ conexi; |FINSI;

   |DELINDEX #3;
   |DELINDEX #4;

   sw_d1 = 0; sw_d2 = 0; sw_d3 = 0; sw_d4 = 0;
   sw_h1 = 0; sw_h2 = 0; sw_h3 = 0;

   |IMPRE 0;
   |SI FSalida ! 0;
       |ACABA;
   |FINSI;

   |INFOR informe;
   |SI FSalida ! 0;
       |MENAV "0000No existe Informe";
       |FINIMP;
       |ACABA;
   |FINSI;

   eaTexto = "Presupuesto Mensual";
   |SI #0#15 = "A";
       eaTexto = "Presupuesto Anual";
   |FINSI;

   t_agrupa = #cabaexpr#12;
   |HAZ presup0;
   sw = 0;

   |HAZ sabercam; || Calculo para saber los campos de los saldos

   |ABRE #2;
   |ABRE #3;
   |ABRE #4;
   |HAZ pidepan;
   |BUCLE cabaexpr0;      || Bucle de Calculos
   |CIERRA #2;
   |CIERRA #3;
   |BUCLE cabaexpr1;      || Bucle de impresion
   |HAZ final;
   |PIEINF;
   |FININF;
   |CIERRA #4;
   |FINIMP;
   |DELINDEX #3;
   |DELINDEX #4;
|FPRC;

|PROCESO sabercam;
   |SI #cabaexpr#0 = 0;  eldesde = 11; |FINSI;
   |SI #cabaexpr#0 = 1;  eldesde = 14; |FINSI;
   |SI #cabaexpr#0 = 2;  eldesde = 17; |FINSI;
   |SI #cabaexpr#0 = 3;  eldesde = 20; |FINSI;
   |SI #cabaexpr#0 = 4;  eldesde = 23; |FINSI;
   |SI #cabaexpr#0 = 5;  eldesde = 26; |FINSI;
   |SI #cabaexpr#0 = 6;  eldesde = 29; |FINSI;
   |SI #cabaexpr#0 = 7;  eldesde = 32; |FINSI;
   |SI #cabaexpr#0 = 8;  eldesde = 35; |FINSI;
   |SI #cabaexpr#0 = 9;  eldesde = 38; |FINSI;
   |SI #cabaexpr#0 = 10; eldesde = 41; |FINSI;
   |SI #cabaexpr#0 = 11; eldesde = 44; |FINSI;
   |SI #cabaexpr#0 = 12; eldesde = 47; |FINSI;
   |SI #cabaexpr#0 = 13; eldesde = 50; |FINSI;

   |SI #cabaexpr#1 = 0;  elhasta = 11; |FINSI;
   |SI #cabaexpr#1 = 1;  elhasta = 14; |FINSI;
   |SI #cabaexpr#1 = 2;  elhasta = 17; |FINSI;
   |SI #cabaexpr#1 = 3;  elhasta = 20; |FINSI;
   |SI #cabaexpr#1 = 4;  elhasta = 23; |FINSI;
   |SI #cabaexpr#1 = 5;  elhasta = 26; |FINSI;
   |SI #cabaexpr#1 = 6;  elhasta = 29; |FINSI;
   |SI #cabaexpr#1 = 7;  elhasta = 32; |FINSI;
   |SI #cabaexpr#1 = 8;  elhasta = 35; |FINSI;
   |SI #cabaexpr#1 = 9;  elhasta = 38; |FINSI;
   |SI #cabaexpr#1 = 10; elhasta = 41; |FINSI;
   |SI #cabaexpr#1 = 11; elhasta = 44; |FINSI;
   |SI #cabaexpr#1 = 12; elhasta = 47; |FINSI;
   |SI #cabaexpr#1 = 13; elhasta = 50; |FINSI;

   |SI #0#15 = "M";
       |SI #cabaexpr#0 = 0;  eldes_p = 59; |FINSI;
       |SI #cabaexpr#0 = 1;  eldes_p = 59; |FINSI;
       |SI #cabaexpr#0 = 2;  eldes_p = 60; |FINSI;
       |SI #cabaexpr#0 = 3;  eldes_p = 61; |FINSI;
       |SI #cabaexpr#0 = 4;  eldes_p = 62; |FINSI;
       |SI #cabaexpr#0 = 5;  eldes_p = 63; |FINSI;
       |SI #cabaexpr#0 = 6;  eldes_p = 64; |FINSI;
       |SI #cabaexpr#0 = 7;  eldes_p = 65; |FINSI;
       |SI #cabaexpr#0 = 8;  eldes_p = 66; |FINSI;
       |SI #cabaexpr#0 = 9;  eldes_p = 67; |FINSI;
       |SI #cabaexpr#0 = 10; eldes_p = 68; |FINSI;
       |SI #cabaexpr#0 = 11; eldes_p = 69; |FINSI;
       |SI #cabaexpr#0 = 12; eldes_p = 70; |FINSI;
       |SI #cabaexpr#0 = 13; eldes_p = 70; |FINSI;

       |SI #cabaexpr#1 = 0;  elhas_p = 59; |FINSI;
       |SI #cabaexpr#1 = 1;  elhas_p = 59; |FINSI;
       |SI #cabaexpr#1 = 2;  elhas_p = 60; |FINSI;
       |SI #cabaexpr#1 = 3;  elhas_p = 61; |FINSI;
       |SI #cabaexpr#1 = 4;  elhas_p = 62; |FINSI;
       |SI #cabaexpr#1 = 5;  elhas_p = 63; |FINSI;
       |SI #cabaexpr#1 = 6;  elhas_p = 64; |FINSI;
       |SI #cabaexpr#1 = 7;  elhas_p = 65; |FINSI;
       |SI #cabaexpr#1 = 8;  elhas_p = 66; |FINSI;
       |SI #cabaexpr#1 = 9;  elhas_p = 67; |FINSI;
       |SI #cabaexpr#1 = 10; elhas_p = 68; |FINSI;
       |SI #cabaexpr#1 = 11; elhas_p = 69; |FINSI;
       |SI #cabaexpr#1 = 12; elhas_p = 70; |FINSI;
       |SI #cabaexpr#1 = 13; elhas_p = 70; |FINSI;
   |SINO;
       eldes_p = 59;
       elhas_p = 70;
   |FINSI;
|FPRC;

|PROCESO lineades;
   |BUCLE cabaexpr3;
|FPRC;

|PROCESO pidepan;
   |ABRE #6;
   posici = 100;
   linea = 0;
   #caexistc#0 = #cabaexpr#6;
   |LEE 001#6=;
   |BUCLELIN 2lineades#6;
   |CIERRA #6;
|FPRC;
