|FICHEROS;
   camaasil #00;   || apuntes lins.
   camaasic #01;   || apuntes cabs.
   cafantas #02;   || 'pintas' de acumulados diario

   camandia #10;   || diarios
   casieaca #11;   || predefinidos cabs.
   casieali #12;   || predefinidos lins.
   casieaax #13;   || consulta predefinido formato asiento

   caextras #23;   || anotaciones extracontables
   caextral #25;   || anotaciones extracontables Lineas
   camemori #24;   || ultimas tres operaciones
   caconasi #20;
   camaniva #500;
   caivalin #501;

   &Puente@ #398;
   caivaasi #399;

   calincob #1000;
   calinpag #1001;
   calicont;

   dscam043@ #100;
   dscam00x@ #101;

   caivam01 #123;

   camaref@ #5000;

   caivatm1 #900;  || cabecera iva
   caivalit #901;  || linea iva
|FIN;

|VARIABLES;
   &enPulPre = 0;
   &NumDocum = 0;
   &enERP = 0;
   &enDesdeGrid = 0;
   {1}nPuntero   = 0;
     || NO PONER NINGUNA VARIABLE ENTRE ESTAS DOS ..... SE USAN COMO PUNTEROS
      aNume      = "";

   nCont = 0;
   aBlancs = "";
   sumaasi = 0;
   nConte = 0;
   swcontador = 0;
   xx = 0;
   anter = 0;
   men1  = "     NO EXISTE EMPRESA !";
   men2  = "     Longitud de Cuenta Fuera de Nivel !";
   fecalf = "";
   mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
   mensa2 = "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
   &modcon = 0;
   traba1 = "";

   aAlfa  = "";
   aAlfa1 = "";
   aAlfa2 = "";

   mas = 0;
   &entrada = 1;
   &inkey = 0;
   &coant = 0;
   &deant = "";
   &dhant = "";
   &imant = 0;
   &dpant = "";
   &sdant = "";
   &nsant = "";
   &refant = "";
   &ext1 = "";
   &ext2 = "";
   &ext3 = "";
   &ext4 = "";
   &ext5 = "";
   &ext10 = "";
   &ext11 = "";
   &ext21 = "";
   &ext13 = 0;
   &ext38 = 1;
   &ext42 = "";
   &ext43 = "";
   &ext44 = "";
   &ext00 = "";
   &ext01 = "";
   &ext02 = "";

   &eaCobPag = "";
   &predefine = 0;
   &predefine2 = 0;
   &sw_debe = 0;
   &sw_habe = 0;
   &j_d = 0;
   &j_h = 0;
   &i_activ = "";
   &i_serie = "";
   &i_factu = 0;
   &i_fecha = @;
   &i_perio = 0;
   &i_perli = 0;
   &aferlamar = 0;
   relacion = 0;
   alfa1 = "";
   alfa2 = "";
   alfa3 = "";
   alfa4 = "";
   nume1 = 0;
   nume2 = 0;
   nume3 = 0;
   nume4 = 0;
   &p_tabla = 0;
   &sw_tabla = 0;
   &sw_ptec = 0;
   posic = 0;
   lin_con = 0;
   m_c = 0;
   &enSwBaja   = 0;
   &sw_ivamerr = 0;
   &avisos = "";
   &f1auto = 0;
   &clau = "";
   ant_ref  = "";
   &ant_dia = 1;
   &ant_fec = @;
   &ant_doc = 0;
   &ctab1 = "";
   &ctab2 = 0;
   ult_pre = 0;
   l_alfa1 = "";

   Comodin = ""; Comodin1 = "";
   Libro = 0;
   Serie = "";
   Factura = 0;
   nDiario = 0;

   SinTocar = 0;
   Cont = 0;
   FechaUlt = @;

   Empresa11 = 0;
   anyo11 = 0;
   acti11 = 0;

   aMas   = "";
   aDef   = "";

   &eaPath = "";
   &eaRetorno = "";
   &swVPuente = 0;

   &enDiario      = 0;
   &efFecha       = @;
   &enDocumento   = 0;

   &r_entra  = "";
   &r_alfa1  = "";
   &enPred   = 0;
   nSwUlt    = 0;
   &swVarios = 0;
   &ivacomun = "";
   &snFiltrA = "";
   &snFiltr  = "";
   &snFilAc  = "";
   &snFilBa  = "";
   &snDescua = "";

   nDocum = 0;
   fFecha = @;
   nError = 0;
   aFichero = "";
   aQueQuiero = "";
   aNumCampos = "";
   nNumCampos = 0;
   nPara1     = 0;
   &nModPred  = 0;
     nYaPinta = 0;
    nSwSalir  = 0;
   &enSi340   = 0;
   &enSi303   = 0;
   &enSi111   = 0;
   &eSwReten  = 0;
   nCampo0 = 0;
   fCampo1 = @;
   nCampo2 = 0;
   &enDiarioDentro    = 0;
   &efFechaDentro     = @;
   &enDocumentoDentro = 0;

   &enSwErrIVA = 0;
   nEmpr = 0;

     &eaMensaCad       = "";
     &enErrorCad       = 0;

     &enSwSalir = 0;
     &eModoCaja = 0;
     &nMenCaja  = 0;
     &aMenCaja  = "";

     &enDiaGAD     = 0;
     &efFecGAD     = @;
     &enDocGAD     = 0;
     &enLibGAD     = 0;
     &enRegGAD     = 0;
     &eaExiGAD     = "";

     &enConIRPF    = 0;
|FIN;

|INCLUYE dscoan_i;
|INCLUYE dscont_i;

||  El campo camaasic#13 = 0 (asiento normal) = 1/2/3 con registro de IVA/IRPF
||                       = 101/102 con registro de IVA de Gestion No modificable
||                       = 103     con registro de Nominas No modificable
||                       = 110 si registro IVA de Gestion No modificable
||                       = 150 de cartera No modificable
||                       = 190 Seguros Sociales desde laboral, no modificables

/*
|PROCESO Tipo20camaasic; |TIPO 20;
     aAlfa1 = FSalida;
     |SI aAlfa1 = "OPCION";
         FSalida = "GAD";
         |ACABA;
     |FINSI;

     |ABRE #0;
     |LEE 000#0=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |HAZ BotonD;
     |CIERRA #0;
|FPRC;
*/

|PROCESO Tipo14GAD;  |TIPO 14;
     enDiaGAD     = #camaasic#0;
     efFecGAD     = #camaasic#1;
     enDocGAD     = #camaasic#2;
     |HAZ EnGadDiario;

     |ATRI P;
     |PINTA 0625, eaExiGAD;
     |ATRI I;
|FPRC;

|| *********************************************************************
|CALCULO Tecla;TIPO 6;
   |SI FSalida = 1; |Y enDesdeGrid = 0;
       |PTEC 807;
       |ERROR;
       |ACABA;
   |FINSI;
|FCAL;

||\\\\\\\\\\\\\\\\\\\\\\\\  Borro facturas de este Asiento
|PROCESO BorraIvaLin;
 |BORRA 020#caivalin.a;
|FPRC;

|DEFBUCLE BorraIvaLin;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,01;
 #camaniva#0,#camaniva#1,99;
 ;
 NULL,BorraIvaLin;
|FIN;

|PROCESO BorraCobCa;
     |DDEFECTO #Puente@;
     #Puente@#0  = #calincob#0;
     #Puente@#1  = #calincob#2;
     #Puente@#2  = #calincob#1;
     #Puente@#3  = #calincob#3;
     #Puente@#5  = #calincob#6;
     #Puente@#22 = nCont;
     #Puente@#23 = #48#2;
     #Puente@#24 = #48#3;
     #Puente@#27 = "V";
     #Puente@#28 = "B";
     #Puente@#35 = " ";
     |GRABA 020#Puente@.n;
     nCont = nCont + 1;
     |BORRA 020#calincob.a;
     |LIBERA #calincob;
|FPRC;

|DEFBUCLE BorraCobCa;
 #calincob#1;
 ;
 #camaniva#0,#camaniva#2,#camaniva#3,001;
 #camaniva#0,#camaniva#2,#camaniva#3,999;
 be;
 NULL,BorraCobCa;
|FIN;

|PROCESO BorraPagCa;
     |DDEFECTO #Puente@;
     #Puente@#0  = #calinpag#0;
     #Puente@#1  = #calinpag#2;
     #Puente@#2  = #calinpag#1;
     #Puente@#3  = #calinpag#3;
     #Puente@#5  = #calinpag#6;
     #Puente@#22 = nCont;
     #Puente@#23 = #48#2;
     #Puente@#24 = #48#3;
     #Puente@#27 = "C";
     #Puente@#28 = "B";
     #Puente@#35 = " ";
     |GRABA 020#Puente@.n;
     nCont = nCont + 1;
     |BORRA 020#calinpag.a;
     |LIBERA #calinpag;
|FPRC;

|DEFBUCLE BorraPagCa;
 #calinpag#1;
 ;
 #camaniva#0,#camaniva#2,#camaniva#3,001;
 #camaniva#0,#camaniva#2,#camaniva#3,999;
 be;
 NULL,BorraPagCa;
|FIN;

|PROCESO BorraIvaCab;
   nCont = 1;
   |HAZ VerPuente;
   |SI swVPuente = 1;
       |SI #camaniva#36 = "R"; |BUCLE BorraCobCa; |FINSI;
       |SI #camaniva#36 = "S"; |BUCLE BorraPagCa; |FINSI;
       |HAZ CierraPuente;
   |FINSI;

   |BUCLE BorraIvaLin;

   |DBASE aMas; |QBF aMas;
   aDef = aMas + "def/camanref.mas";
   |CARGA_DEF aDef, camaref@;
   |SI FSalida = 0;
      |ABRE #camaref@;
      #camaref@#0 = #camaniva#0;
      #camaref@#1 = #camaniva#1;
      |LEE 101#camaref@.=;
      |SI FSalida = 0;
         |BORRA 020#camaref@.a; |LIBERA #camaref@;
      |FINSI;
      |CIERRA #camaref@; |DESCARGA_DEF #camaref@;
   |FINSI;

   |BORRA 020#camaniva.a;
   |LIBERA #camaniva;

   |HAZ DesactualizaDSarchi;
|FPRC;

|DEFBUCLE BorraIvaCab;
 #camaniva#2;
 ;
 #camaasic#0,#camaasic#1,#camaasic#2;
 #camaasic#0,#camaasic#1,#camaasic#2;
 be;
 NULL,BorraIvaCab;
|FIN;

||///////////////////////////////////////////////////////////
|PROCESO BuscoConIRPF;
   |SI #caivalin#18 ! 0;
       enConIRPF= #caivalin#18;
       |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE BuscoConIRPF;
 #caivalin#1;
 ;
 #camaniva#0, #camaniva#1, 01;
 #camaniva#0, #camaniva#1, 99;
 e;
 NULL, BuscoConIRPF;
|FIN;

|PROCESO CargoLinIVA;
   aQueQuiero = "|NC";
   aNumCampos = #caivalin#aQueQuiero#;
   nNumCampos = aNumCampos; nNumCampos = nNumCampos - 1;
   |PARA nPara1 = 0; |SI nPara1 [ nNumCampos; |HACIENDO nPara1 = nPara1 + 1;
         #901nPara1 = #caivalin#nPara1#;
   |SIGUE;
   |GRABA 040#901n;
|FPRC;

|DEFBUCLE CargoLinIVA;
 #caivalin#1;
 ;
 #camaniva#0, #camaniva#1, 01;
 #camaniva#0, #camaniva#1, 99;
 e;
 NULL, CargoLinIVA;
|FIN;

|PROCESO CargoDefectos;
  |SI #casieaca#2 = "S";  || Cargo la factura anterior
      |ABRE #camaniva;
      |SELECT #2#camaniva;
      #camaniva#7 = #camaasic#0;
      #camaniva#8 = #camaasic#1;
      #camaniva#9 = #camaasic#2;
      |LEE 010#camaniva.=;
      |SI FSalida ! 0;
          |MENAV "    Error No existe Registro de IVA. Borre el asiento";
          |SELECT #1#camaniva;
          |CIERRA #camaniva;
          |ERROR;
          |ACABA;
      |SINO;
          |SI #camaniva#36 ! "N";
              |SI enSi340 = 1; |O enSi303 = 1; |O enSi111 = 1;
                  nMenCaja  = 1;
                  eModoCaja = xx;
                  eSwReten = 0;
                  |SI #camaniva#20 ! 0;
                      eSwReten = 1;
                      enConIRPF = 0;
                      |BUCLE BuscoConIRPF;
                  |FINSI;
                  |HAZ eElCtrlModIVA;
                  |SI enSwSalir ! 0;
                      |MENAV aMenCaja;
                      |SELECT #1#camaniva;
                      |CIERRA #camaniva;
                      |ERROR;
                      |ACABA;
                  |FINSI;
              |FINSI;
          |FINSI;
          || Comprobamos que los recibos de la factura a modificar no
          ||     tengan movimientos
          eaProg = "camaniva";
          eaVC   = #camaniva#36;
          |HAZ MiraRecibos;
          |SI enErrCarte ! 0;
             aAlfa1 = "0000Recibos con movimientos, NO SE PUEDE MODIFICAR LA FACTURA";
             |MENAV aAlfa1;
             |CIERRA #camaniva;
             |ERROR; |ACABA;
          |FINSI;
      |FINSI;
      aQueQuiero = "|NC";
      aNumCampos = #camaniva#aQueQuiero#;
      nNumCampos = aNumCampos; nNumCampos = nNumCampos - 1;
      |PARA nPara1 = 0; |SI nPara1 [ nNumCampos; |HACIENDO nPara1 = nPara1 + 1;
            #900nPara1 = #camaniva#nPara1#;
      |SIGUE;
      |CIERRA #camaniva;
      NumDocum =#camaniva#1;
      |ABRE #901;
      |BUCLE CargoLinIVA;
      |CIERRA #901;
      || |BUCLE BorraIvaCab;  Lo borro cuando este ya en el predefinido
      || Otras variables
      ext38    = #900#38;
      ext42    = #900#42;
      ext43    = #900#43;
      ext44    = #900#44;
      eaCobPag = #casieaca#6;
  |FINSI;
  |HAZ carga_con;
  nModPred = 1;
  |ATRI I; |PINTA 0928, #casieaca#1; |ATRI 0;
  predefine  = 1;
  predefine2 = 1;
  |SI #casieaca#2 = "S";
      i_serie = #900#2;
      i_factu = #900#3;
      i_fecha = #900#4;
      i_perio = #900#5;
      i_perli = #900#40;
      i_activ = #900#10;  |QBF i_activ;
      sw_ptec = 0;                      ||/este 'PTEC' sobra
      eaCobPag = #casieaca#6;
  |FINSI;
  #casieali#1 = 0;
|FPRC;

||///////////////////////////////////////////////////////////
|CALCULO modbaj; |TIPO 1;

   xx = (FEntrada / 100) ! 0;
   enSwAgr = 0;
   enModoEnt = xx;
   |SI xx ! 4;
       |SI #camaasic#1 [ fec3;
           |MENAV mensa2;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   enTipoAsto = #camaasic#13;
|| ... ... ... ... BAJA DE ASIENTO
   |SI #camaasic#13 > 100; |Y xx = 3;
       enSwDejar = 0;
       aAlfa = "    FACTURA DESDE PASE DE GESTION. NO PUEDE DAR DE BAJA EN CONTABILIDAD";
       |SI #camaasic#13 = 103; aAlfa = "    NOMINA DESDE PASE DE LABORAL. NO PUEDE DAR DE BAJA EN CONTABILIDAD"; |FINSI;
       |SI #camaasic#13 = 104; aAlfa = "    NOMINA DE RETRIBUCIONES ADMINISTRADORES. NO PUEDE DAR DE BAJA EN CONTABILIDAD"; |FINSI;
       |SI #camaasic#13 = 105; aAlfa = "    ASTO DE CAJA. NO PUEDE DAR DE BAJA EN CONTABILIDAD"; |FINSI;
       |SI #camaasic#13 = 106; aAlfa = "    ASTO DE PRESTAMOS DE SOCIOS. NO PUEDE DAR DE BAJA EN CONTABILIDAD"; |FINSI;
       |SI #camaasic#13 = 190; aAlfa = "    ASTO SEG.SOCIALES DESDE PASE LABORAL. NO PUEDE DAR DE BAJA EN CONTABILIDAD"; |FINSI;
       |SI #camaasic#13 ] 110; |Y #camaasic#13 ! 190;
           |HAZ eDejarModificar;
           |SI enSwDejar = 0;
               |SI #camaasic#13 = 110; aAlfa = "    ASIENTO DESDE PASE DE GESTION. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 150; aAlfa = "    ASIENTO DESDE PASE DE CARTERA. NO MODIFICABLE "; |FINSI;
           |SINO;
               enSwBaja = 1;
               ant_dia = #camaasic#0;
               ant_fec = #camaasic#1;
               ant_ref = #camaasic#17;
               ant_doc = #camaasic#2;
               |HAZ eGrabaModificar;
               enSwBaja = 0;
           |FINSI;
       |FINSI;
       |SI enSwDejar = 0;
           |MENAV aAlfa;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI xx = 3;
       || Comprobamos si el asiento es de IVA y si lo es, comprobamos si
       ||   tiene recibos en cartera y si se pueden eliminar
       |ABRE #camaniva;
       |SELECT #2#camaniva;
       #camaniva#7 = #camaasic#0;
       #camaniva#8 = #camaasic#1;
       #camaniva#9 = #camaasic#2;
       |LEE 000#camaniva.=;
       |SI FSalida = 0;
            || ... ... Comprobamos primero el Modelo 340, para la baja
          |SI #camaniva#36 ! "N";
              |SI enSi340 = 1; |O enSi303 = 1; |O enSi111 = 1;
                  nMenCaja  = 1;
                  eModoCaja = xx;
                  eSwReten = 0;
                  |SI #camaniva#20 ! 0;
                      eSwReten = 1;
                      enConIRPF = 0;
                      |BUCLE BuscoConIRPF;
                  |FINSI;
                  |HAZ eElCtrlModIVA;
                  |SI aMenCaja ! "";  |MENAV aMenCaja;  |FINSI;
                  |SI enSwSalir = 1;
                      |SELECT #1#camaniva;
                      |CIERRA #camaniva;
                      |ERROR; |ACABA;
                  |FINSI;
              |FINSI;
          |FINSI;

          eaProg = "camaniva";
          eaVC   = #camaniva#36;
          |HAZ MiraRecibos;
          |SI enErrCarte ! 0;
             aAlfa1 = "0000NRecibos con movimientos, NO SE PUEDE DAR DE BAJA FACTURA";
             |MENAV aAlfa1;
             |SELECT #1#camaniva; |CIERRA #camaniva;
             |ERROR; |ACABA;
          |SINO;
             |SI #camaasic#13 ! 0; |Y #camaasic#13 ! 110; |Y #camaasic#13 ! 150; |Y #camaasic#13 ! 190;
                |HAZ extraco;        || borra anotaciones extracontables
                |BUCLE BorraIvaCab;
                |HAZ PongoNumFra;
             |FINSI;
          |FINSI;
       |FINSI;
       |SELECT #1#camaniva; |CIERRA #camaniva;
   |FINSI;

||... ... ... MODIFICACION DE ASIENTO
   enTipoAsto = #camaasic#13;
   enSwDejar  = 0;
   ||... Si modificable el predefinido antes
   enPred = #camaasic#7;
   |SI #camaasic#7 ! 0; |Y xx = 2;
       |ABRE #casieaca;
       |DDEFECTO #casieaca;
       #casieaca#0 = #camaasic#7;
       |LEE 001#casieaca.=;
       |CIERRA #casieaca;
       |SI #casieaca#17 = "N";
           |MENAV "    ATENCION!. ASIENTO NO MODIFICABLE ";
           |ERROR;
           |ACABA;
       |FINSI;
       |SI #casieaca#17 = "X";  ||modificacion especial
           |HAZ CargoDefectos;
           |ACABA;
       |FINSI;
   |FINSI;

   enTipoAsto = #camaasic#13;
   enSwDejar  = 0;
||No dejo modificar facturas de pase de Gestion un poco especiales. Ej: Rent a Car
   |SI #camaasic#13 > 100; |Y xx = 2;
       |HAZ eDejarModificar;
       |SI enSwDejar = 0;
           |SI eaTexError = "";
               aAlfa = "    FACTURA DESDE PASE DE GESTION. NO MODIFICABLE ";
               |SI #camaasic#13 = 103; aAlfa = "    ASTO NOMINAS DESDE PASE DE LABORAL. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 104; aAlfa = "    ASTO NOMINAS DE RETRIBUCION ADMINITRADORES. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 105; aAlfa = "    ASTO DE CAJA. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 106; aAlfa = "    ASTO DE PRESTAMOS A SOCIOS. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 110; aAlfa = "    ASIENTO DESDE PASE DE GESTION. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 150; aAlfa = "    ASIENTO DESDE PASE DE CARTERA. NO MODIFICABLE "; |FINSI;
               |SI #camaasic#13 = 190; aAlfa = "    ASTO SEG.SOCIALES DESDE PASE DE LABORAL. NO MODIFICABLE "; |FINSI;
           |SINO;
               aAlfa = eaTexError;
           |FINSI;
           |MENAV aAlfa;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;
|| ..........................................

   |SI #camaasic#13 ! 0; |Y xx = 2; |Y #camaasic#13 ! 110; |Y #camaasic#13 ! 150; |Y #camaasic#13 ! 190;
       || ...
       nDIARIO    = #camaasic#0;
       aFECHA     = #camaasic#1;
       nDOCUMENTO = #camaasic#2;
       |HAZ SwAgrupada;
       |SI enSwAgr = 1;

           |ABRE #camaniva;
           |SELECT #2#camaniva;
           #camaniva#7 = #camaasic#0;
           #camaniva#8 = #camaasic#1;
           #camaniva#9 = #camaasic#2;
           |LEE 010#camaniva.=;
           |SI FSalida = 0;
               |SI #camaniva#36 ! "N";
                   |SI enSi340 = 1; |O enSi303 = 1; |O enSi111 = 1;
                       nMenCaja = 1;
                       eModoCaja = xx;
                       |HAZ eElCtrlModIVA;
                       |SI enSwSalir ! 0;
                           |MENAV aMenCaja;
                           |SI enSwSalir = 1;
                               |SELECT #1#camaniva;
                               |CIERRA #camaniva;
                               |ERROR; |ACABA;
                           |FINSI;
                       |FINSI;
                   |FINSI;
               |FINSI;


               || Comprobamos que los recibos de la factura a modificar no
               ||     tengan movimientos
               eaProg = "camaniva";
               eaVC   = #camaniva#36;
               |HAZ MiraRecibos;

               |SI enErrCarte ! 0;
                  aAlfa1 = "0000NRecibos con movimientos, NO SE PUEDE MODIFICAR LA FACTURA. CONTINUAR ?";
                  |CONFI aAlfa1;
                  |SI FSalida ! 0;
                      |SELECT #1#camaniva; |CIERRA #camaniva;
                      |ERROR; |ACABA;
                  |SINO;
                       enErrCarte = 9;
                  |FINSI;

               ||    aAlfa1 = "0000Recibos con movimientos, NO SE PUEDE MODIFICAR LA FACTURA. ";
               ||    |MENAV aAlfa1;
               ||    |SELECT #1#camaniva; |CIERRA #camaniva;
               ||    |ERROR; |ACABA;
               |FINSI;

                  l_alfa1 = "camaniva.tab;"; |QBF l_alfa1;
                  l_alfa1 = l_alfa1 + #camaniva#36 + ",";
                  Comodin = ("00" + #camaasic#0) % -102;
                  l_alfa1 = l_alfa1 + Comodin + "," + #camaasic#1 + ",";
                  Comodin = ("000000" + #camaasic#2) % -106;
                  l_alfa1 = l_alfa1 + Comodin;
                  |SELECT #1#camaniva;
                  |CIERRA #camaniva;

                  |LIBERA #camaasic;
                  |CIERRAT #camaasic;
                  |SUB_EJECUTA l_alfa1;
                  |ABRET #camaasic;
                  |LEE 101#camaasic.=;
                  |ENTLINEAL #1#camaasil,-4,7,19,0,inf1,sup1; |HAZ el_di;
                  |PINTA #camaasic#4;
                  |PINTA #camaasic#5;
                  |PINTA #camaasic#6;
                  |PTEC 807;
           |SINO;
               |SELECT #1#camaniva;
               |CIERRA #camaniva;
           |FINSI;

       |SINO;
           |SI enSwAgr = 2;
               |SI #camaniva#36 ! "N";
                   |MENAV "    ATENCION !!!. Asiento de Varias Facturas, No se modificaran los Registros relacionados";
               |SINO;
                    |MENAV "    ATENCION !!!. Asiento de Varias Nominas, No se modificaran los Registros relacionados";
               |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI xx = 2;
      |HAZ carga_con;
   |FINSI;
|FCAL;

|CALCULO f1automa; |TIPO 7;             || desde el campo 'diario'
   enDesdeGrid = 0;
   |SI f1auto = 1; |O f1auto = 3;
      #camaasic#0  = ant_dia; |PINTA #camaasic#0;
      #camaasic#17 = ant_ref;
      |SI f1auto = 1;
          |PTEC 823;
          f1auto = 0;
      |FINSI;
   |FINSI;
   |SI nSwUlt = 1;
      #camaasic#0 = ant_dia; |PINTA #camaasic#0;
   |FINSI;
   |SI aferlamar = 1;
      #camaasic#0  = ant_dia; |PINTA #camaasic#0;
      #camaasic#17 = ant_ref;
      |PTEC 824;
      aferlamar = 0;
   |FINSI;
   |SI aferlamar = 2;
      #camaasic#0  = ant_dia; |PINTA #camaasic#0;
      #camaasic#1  = ant_fec; |PINTA #camaasic#1;
      #camaasic#2  = ant_doc; |PINTA #camaasic#2;
      aferlamar = 0;
   |FINSI;
|FCAL;

|CALCULO el_di; |TIPO 13;  || desde campo 'diario' y calculo 'asie_nue'
   |DDEFECTO #10;
   |ABRE #10;
   #camandia#0 = #camaasic#0;
   |LEE 101#10=;                 || lee el diario
   |CIERRA #10;
   #cafantas#0 = #camandia#2;           || diario debe
   #cafantas#1 = #camandia#3;           || diario haber
   #cafantas#2 = #cafantas#0 - #cafantas#1;     || diario saldo
   #cafantas#8 = #camandia#1;           || descripcion diario
   |ATRI I;
   |PINTA 0639, #cafantas#0;
   |PINTA 0653, #cafantas#1;
   |PINTA 0667, #cafantas#2;
   |PINTA 0850, #cafantas#8;
   |ATRI 0;
   aBlancs = " "* 78;
   |PINTA 2202, aBlancs;
   |PINTA 2302, aBlancs;
   aBlancs = " "* 44;
   |PINTA 0926, aBlancs;

   |SI nYaPinta = 0;
       |SI eaSubde = "N";
           |PINTA 1061, "ÄÄÄÄÂÄÄ";
           |PINTA 1161, "    ³  ";
           |PINTA 1261, "    ³  ";
           |PINTA 1361, "    ³  ";
           |PINTA 1461, "    ³  ";
           |PINTA 1561, "    ³  ";
           |PINTA 1661, "    ³  ";
           |PINTA 1761, "    ³  ";
           |PINTA 1861, "    ³  ";
           |PINTA 1961, "    ³  ";
           |PINTA 2061, "ÄÄÄÄÄÄÄ";
           |ATRI R; |PINTA 1161, "    "; |PINTA 1166, "Dp"; |ATRI 0;
       |SINO;
           |SI enSubde = 1; |Y eaDepar = "N";
               |PINTA 1060, "ÄÄÄÄ";
               |PINTA 1160, "    ";
               |PINTA 1260, "    ";
               |PINTA 1360, "    ";
               |PINTA 1460, "    ";
               |PINTA 1560, "    ";
               |PINTA 1660, "    ";
               |PINTA 1760, "    ";
               |PINTA 1860, "    ";
               |PINTA 1960, "    ";
               |PINTA 2060, "ÄÄÄÄ";
               |ATRI R; |PINTA 1160, "    "; |ATRI 0;
           |FINSI;
        |FINSI;
        nYaPinta = 1;
   |FINSI;
|FCAL;

|PROCESO entrada; |TIPO 0;              || desde el campo 'diario'

   ant_dia = #camaasic#0;
   inkey = FSalida;
   |HAZ asie_nue;
   xx = (FEntrada / 100) ! 0;
   |SI xx = 1; |Y inkey ! 11;              || en <F3> no

      |SI #1#0 = 0;
          |CONFI "    SATENCION. ESTA CREANDO EL ASIENTO EN EL DIARIO DE APERTURA. CONTINUAR ";
          |SI FSalida ! 0;
              |ERROR;
              |ACABA;
          |FINSI;
      |FINSI;
      |HAZ NuevoDoc;

      |HAZ NuevoRegistro;
      anter = #camaasic#0;
      #camaasic#12 = nREGISTRO;
      #camaasic#0 = anter;         || diario
      #camaasic#2 = #caconasi#1;   || documento
      #camaasic#3 = #camaasic#2;   || asiento
      #camaasic#7 = 0;             || asiento predefinido
      ||#camaasic#17 = ant_ref;

      || ....    |PINTA #camaasic#12;
      |HAZ asie_nue;
   |FINSI;

   |SI inkey = 9;
      |PTEC 802;
      |PTEC 802;
      |PTEC 802;
      |PTEC 802;
      |SI eaPtec  = "N"; |PTEC 802; |FINSI;
      |SI eaRefer = "S"; |PTEC 802; |FINSI;
   |FINSI;
   |SI inkey = 10;
      |PTEC 802;
      |PTEC 802;
      |SI eaPtec  = "N"; |PTEC 802; |FINSI;
      |SI eaRefer = "S"; |PTEC 802; |FINSI;
   |FINSI;
   |SI inkey = 11;
      |SUB_EJECUTA_NP "camemori.tab";
      |ERROR;
   |FINSI;
   |SI inkey = 17; |Y xx ! 1; |Y eaRefer = "S";
       #1#1 = fec1;
       |CONSULTA_CLAVE #5#1;
       |SI FSalida ! 0;
           |ERROR;
       |SINO;
           |PTEC 802;
           |PTEC 802;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO fecha; |TIPO 0;                || desde campo 'fecha'
   inkey = FSalida;
   xx = (FEntrada / 100) ! 0;

   |SI xx ! 4;
       |SI #camaasic#1 [ fec3;
           |MENAV mensa2;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI #camaasic#1 < fec1; |O #camaasic#1 > fec2;
      |MENAV mensa1;
      |ERROR;
      |ACABA;
   |SINO;
      |SI inkey = 9;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |SI eaPtec  = "N"; |PTEC 802; |FINSI;
         |SI eaRefer = "S"; |PTEC 802; |FINSI;
      |FINSI;
      |SI inkey = 10;
         |PTEC 802;
         |SI eaPtec  = "N"; |PTEC 802; |FINSI;
         |SI eaRefer = "S"; |PTEC 802; |FINSI;
      |FINSI;
      |SI inkey = 11;
         |SUB_EJECUTA_NP "camemori.tab";
         |ERROR;
      |FINSI;
      |SI inkey = 17; |Y xx ! 1; |Y eaRefer = "S";
          #1#1 = fec1;
          |CONSULTA_CLAVE #5#1;
          |SI FSalida ! 0;
              |ERROR;
          |SINO;
              |PTEC 802;
          |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO AntDocument; |TIPO 7;
   xx = (FEntrada / 100) ! 0;
   |SI xx = 1; |Y eaPtec = "S";
       |PTEC 802;
   |FINSI;
|FPRC;

|PROCESO document; |TIPO 0;             || desde campo 'documento'
   inkey = FSalida;
   nConte = Contenido;
   xx = (FEntrada / 100) ! 0;
   |SI xx = 1;
      |SI #camaasic#2 ! nConte; |Y inkey ! 2;
         |SI eaPaDOM3 ! "S";
             nume1 = #caconasi#1 + 1;
             |SI nume1 < #1#2;
                 nume1 = 0;
                 |SI eaPaDOM3 = "A";
                     |CONFI "    NNumero Documento superior al Ultimo + 1, Continuar";
                     |SI FSalida = 0;
                         nume1 = 1;
                     |FINSI;
                 |FINSI;
                 |SI nume1 = 0;
                     #1#2 = nConte;
                     |ERROR;
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI swcontador = 0;
             swcontador = 1;
             sumaasi = #camaasic#2;
             |SI sumaasi > #caconasi#1;
                 nDOCUMENTO = sumaasi;
                 |HAZ ActContador;
             |FINSI;
         |SINO;
            swcontador = 0;
            sumaasi = 0;
         |FINSI;
      |FINSI;
   |FINSI;
   xx = (FEntrada / 100) ! 0;

   |SI xx = 1; |Y inkey ! 2;
      #camaasic#3 = #camaasic#2;
      |PINTA #camaasic#3;
      |HAZ RepiteDoc;
      |SI nError = 1; |ERROR; |ACABA; |FINSI;
   |FINSI;

   |SI inkey < 11;  |O inkey > 16;
       |ACABA;
   |FINSI;

   |SI inkey = 11;       || modificacion de asientos
      |SI #caivaasi#1 = "S";
         enSwErrIVA = 0;
         || Primero miro si tiene registro de IVA ...
         |ABRE #camaniva;
         |SELECT #2#camaniva;
         #camaniva#7 = #camaasic#0;
         #camaniva#8 = #camaasic#1;
         #camaniva#9 = #camaasic#2;
         |LEE 000#camaniva.=;
         |SI FSalida = 0;
            || ... y si lo tiene, compruebo los vencimientos ...
            aAlfa = #caivaasi#56; |QBF aAlfa;
            aAlfa1 = aAlfa % 0201; |SI aAlfa1 = ":"; aAlfa = aAlfa % 0399; |FINSI;
            aAlfa1 = aAlfa + "def/dscam043.mas";
            |CARGA_DEF aAlfa1, dscam043@;
            |SI FSalida = 0;
               aAlfa1 = aAlfa + "fich/"; |PATH_DAT #100 aAlfa1;
               |SI #camaniva#36 = "R"; aAlfa1 = aAlfa + "def/dscam003.mas"; |FINSI;
               |SI #camaniva#36 = "S"; aAlfa1 = aAlfa + "def/dscam008.mas"; |FINSI;
               |CARGA_DEF aAlfa1, dscam00x@;

               nEmpr = -1;
               |ABRE #dscam043@;
               #dscam043@#0 = #48#2;
               #dscam043@#1 = #48#3;
               #dscam043@#2 = 1;
               |LEE 000#dscam043@.];
               |PARA; |SI FSalida = 0; |Y #dscam043@#0 = #48#2; |Y #dscam043@#1 = #48#3; |HACIENDO;
                  |SI #camaniva#36 = "S"; |Y #dscam043@#3 = "C";
                     |SI #camaniva#0 ] #dscam043@#5; |Y #camaniva#2 [ #dscam043@#6;
                     |Y  #camaniva#2 ] #dscam043@#7; |Y #camaniva#2 [ #dscam043@#8;
                        nEmpr = #dscam043@#9; |SAL;
                     |FINSI;
                  |FINSI;
                  |SI #camaniva#36 = "R"; |Y #dscam043@#3 = "V";
                     |SI #camaniva#0 ] #dscam043@#5; |Y #camaniva#2 [ #dscam043@#6;
                     |Y  #camaniva#2 ] #dscam043@#7; |Y #camaniva#2 [ #dscam043@#8;
                        nEmpr = #dscam043@#9; |SAL;
                     |FINSI;
                  |FINSI;
                  |LEE 000#dscam043@.s;
               |SIGUE;
               |SI nEmpr ] 0;
                  aAlfa = #caivaasi#56; |QBF aAlfa;
                  aAlfa1 = aAlfa + "fich/" + (("00000" + nEmpr) % -105) + "/";
                  |PATH_DAT #dscam00x@#aAlfa1#;
                  |ABRE #dscam00x@;
                  |SI #camaniva#36 = "R"; |SELECT #9#dscam00x@; |FINSI;
                  |SI #camaniva#36 = "S"; |SELECT #2#dscam00x@; |FINSI;
                  #dscam00x@#27 = #camaniva#0;
                  #dscam00x@#0  = #camaniva#2;
                  #dscam00x@#1  = #camaniva#3;
                  #dscam00x@#2  = 1;
                  |LEE 000#dscam00x@.];
                  |PARA; |SI FSalida = 0; |Y #dscam00x@#27 = #camaniva#0;  |Y #dscam00x@#0  = #camaniva#2;
                   |Y #dscam00x@#1  = #camaniva#3; |HACIENDO;
                     |SI #dscam00x@#4  = #camaniva#4;
                              |Y #dscam00x@#44 = #dscam043@#0;
                              |Y #dscam00x@#45 = #dscam043@#1;
                        |SI #dscam00x@#14 ! "P"; enSwErrIVA = -1; |SAL; |FINSI;
                     |FINSI;
                     |LEE 000#dscam00x@.s;
                  |SIGUE;
                  |CIERRA #dscam00x@;
               |FINSI;
               |DESCARGA_DEF #dscam00x@;
               |CIERRA #dscam043@; |DESCARGA_DEF #dscam043@;
            |FINSI;
         |FINSI;
      |FINSI;

/*
         aAlfa1 = aAlfa + "fich/"; |PATH_DAT #100 aAlfa1;
         aAlfa1 = aAlfa + "def/dscam067.mas"; |CARGA_DEF aAlfa1, dscam067@;
         |DBASE aAlfa; |QBF aAlfa;
         |ABRE #dscam000@;
         #dscam000@#0 = 1;
         |LEE 000#dscam000@.];
         |PARA; |SI FSalida = 0; |HACIENDO;
            aAlfa1 = #dscam000@#16; |QBF aAlfa1;
            aAlfa2 = aAlfa1 % 0201; |SI aAlfa2 = ":"; aAlfa1 = aAlfa1 % 0399; |FINSI;
            |SI #dscam000@#14 = #48#2; |Y #dscam000@#19 = #48#3; |Y aAlfa = aAlfa1;
               |SAL;
            |FINSI;
            |LEE 000#dscam000@.s;
         |SIGUE;
         |SI #dscam000@#14 = #48#2; |Y #dscam000@#19 = #48#3; |Y aAlfa = aAlfa1;
            |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscarter/";
            aAlfa1 = aAlfa + "fich/" + (("00000" + #dscam000@#0) % -105) + "/";
            |PATH_DAT #101 aAlfa1;
            |ABRE #dscam067@; |SELECT #2#dscam067@;
            #dscam067@#4 = #camaasic#0;
            #dscam067@#5 = #camaasic#1;
            #dscam067@#6 = #camaasic#2;
            #dscam067@#7 = 1;
            #dscam067@#8 = #48#2;
            #dscam067@#9 = #48#3;
            |LEE 000#dscam067@.];
            |SI FSalida = 0; |Y #dscam067@#4 = #camaasic#0; |Y #dscam067@#5 = #camaasic#1;
             |Y #dscam067@#6 = #camaasic#2; |Y #dscam067@#8 = #48#2; |Y #dscam067@#9 = #48#3;
                aAlfa = "    Este asiento es la contabilizacion de";
                |SI #dscam067@#0 = "CB"; aAlfa = aAlfa + " un cobro."; |FINSI;
                |SI #dscam067@#0 = "PG"; aAlfa = aAlfa + " un pago.";  |FINSI;
                |SI #dscam067@#0 = "RM";
                   aAlfa1 = #dscam067@#3; |QBF aAlfa1;
                   |SI aAlfa1 = "E";
                      aAlfa = aAlfa + " la emision de una remesa.";
                   |FINSI;
                   |SI aAlfa1 = "V";
                      aAlfa = aAlfa + "l vencimiento de una remesa.";
                   |FINSI;
                |FINSI;
                |SI #dscam067@#0 = "PA";
                   aAlfa1 = #dscam067@#3; |QBF aAlfa1;
                   |SI aAlfa1 = "E";
                      aAlfa = aAlfa + " la emision de un pagare.";
                   |FINSI;
                   |SI aAlfa1 = "V";
                      aAlfa = aAlfa + "l vencimiento de un pagare.";
                   |FINSI;
                |FINSI;
                |SI #dscam067@#0 = "TA";
                   aAlfa1 = #dscam067@#3; |QBF aAlfa1;
                   |SI aAlfa1 = "E";
                      aAlfa = aAlfa + " la emision de un talon.";
                   |FINSI;
                |FINSI;
                |SI #dscam067@#0 = "CF";
                   aAlfa1 = #dscam067@#3; |QBF aAlfa1;
                   |SI aAlfa1 = "E";
                      aAlfa = aAlfa + " la emision de un confirme.";
                   |FINSI;
                   |SI aAlfa1 = "V";
                      aAlfa = aAlfa + "l vencimiento de un confirme.";
                   |FINSI;
                |FINSI;
                aAlfa = aAlfa + "Entre a cartera y modifique desde la opcion correspondiente";
                |MENAV aAlfa;
                |SELECT #1#dscam067@; |CIERRA #dscam067@; |DESCARGA_DEF #dscam067@;
                |CIERRA #dscam000@; |DESCARGA_DEF #dscam000@;
                |ERROR; |ACABA;
            |FINSI;
            |SELECT #1#dscam067@; |CIERRA #dscam067@;
         |FINSI;
         |DESCARGA_DEF #dscam067@;
         |CIERRA #dscam000@;
*/
      |SI xx ! 2; |ACABA; |FINSI;

      |ATRI P;  |MENSA "    Cargando Opcion ...";  |ATRI 0;
      ext1 = #camaasic#0;          || diario viejo
      ext2 = #camaasic#1;          || fecha viejo
      ext3 = #camaasic#2;          || documento viejo
      ext4 = #camaasic#3;          || asiento viejo
      |CIERRAT #0;
      |CIERRAT #1;
      |SUB_EJECUTA_NP "camoddi0.tab";
      |ABRET #0;
      |ABRET #1;
      #camaasic#0 = ext1;          || diario nuevo
      #camaasic#1 = ext2;          || fecha nueva
      #camaasic#2 = ext3;          || documento nuevo
      #camaasic#3 = ext4;          || asiento nuevo
      |PINTA #camaasic#0;
      |PINTA #camaasic#1;
      |PINTA #camaasic#2;
      |PINTA #camaasic#3;
      |SI sw_ivamerr ! 0;  |ERROR;  |FINSI;
      |ACABA;
   |FINSI;

   |SI xx ! 1;
      |MENAV "    Este tipo de contabilizacion esta limitado al ALTA ...";
      |ACABA;
   |FINSI;
   |ATRI P;  |MENSA "    Cargando Opcion ...";  |ATRI 0;

   |SI inkey = 12;|O inkey = 13; |O inkey = 14;    || iva reperc./soport. manuales

       ext1 = ("00" + #camaasic#0) % -102;
       ext2 = #camaasic#1;
       ext3 = ("000000" + #camaasic#2) % -106;
       l_alfa1 = "camaniva.tab;"; |QBF l_alfa1;
       |SI inkey = 12; l_alfa1 = l_alfa1 + "R,"; |FINSI;
       |SI inkey = 13; l_alfa1 = l_alfa1 + "S,"; |FINSI;
       |SI inkey = 14; l_alfa1 = l_alfa1 + "N,"; |FINSI;
       l_alfa1 = l_alfa1 + ext1 + "," + ext2 + "," + ext3;

       |GRABA 020#1n;
       |SI FSalida ! 0;
           |ERROR;
           |ACABA;
       |FINSI;
       |LIBERA #1;  ||Prueba

       |SUB_EJECUTA_NP l_alfa1;
       #camaasic#0 = ext1;
       #camaasic#1 = ext2;
       #camaasic#2 = ext3;
       |SI sw_ivamerr ! 0;
           |LEE 121#1=;
           |BORRA 000#1a;
           |ERROR;
       |SINO;
          |ABRET #0;
          |ABRET #1;
          |LEE 121#1=;
          |PINDA #0#camaasic;
          ant_dia = #camaasic#0;
          ant_fec = #camaasic#1;
          ant_ref = #camaasic#17;
          ant_doc = #camaasic#2;
          enPred = 0;
          nSwUlt = 1;
          ivacomun = "";
          NumDocum = 0;
          |PTEC 806;
          |PTEC 815;
          |ACABA;
       |FINSI;
   |FINSI;

   |ABRET #0;
   |ABRET #1;

   |SI sw_ivamerr ! 0;
     |ERROR;
   |FINSI;
|FPRC;

|PROCESO RepiteDoc;
   nError = 0;
   |SI eaPaDOM2 = "S"; |ACABA; |FINSI;  || no mira

   |SALVA_DATOS #1;
   |SELECT #3#1;
   nDocum  = #1#2;
   fFecha  = #1#1;
   nDiario = #1#0;
   #1#0 = 0;
   #1#1 = "01.01.1900";
   |LEE 000#1=;
   |SI FSalida = 0;
       |SI #1#0 ! nDiario; |O #1#1 ! fFecha;
           nError = 1;
       |FINSI;
   |FINSI;
   |SELECT #1#1;
   |REPON_DATOS #1;
   |SI nError = 1;
      |SI eaPaDOM2 = "A";
          |CONFI "    NAtencion, Ya existe numero de Documento. Continuar";
          |SI FSalida = 0;
              nError = 0;
              |ACABA;
          |FINSI;
      |FINSI;
      |HAZ NuevoDoc;
      #1#2 = #caconasi#1; |PINTA #1#2;
      #1#3 = #caconasi#1; |PINTA #1#3;
  |FINSI;
|FPRC;

|CALCULO DesdeExt; |TIPO 7;
   |SI enDocumento = 0; |ACABA; |FINSI;
   |SI Campo = 17;
       |SI eaRefer = "N"; |ACABA; |FINSI;
   |FINSI;
   |PTEC 802;
|FCAL;

|CALCULO r_referen; |TIPO 6;
   |SI eaRefer = "N"; |ACABA; |FINSI;
   inkey = FSalida;
   r_entra = entrada;
   r_alfa1 = #1Campo;
   |HAZ r1_punto;
   #1Campo = r_alfa1;
   |PINTA #1Campo;
|FCAL;

|CALCULO referen; |TIPO 0;
 ant_ref = #1#17;
 refant = #1#17;
 |SI inkey ! 1; |ACABA; |FINSI;

 xx = (FEntrada / 100) ! 0;
 |SI xx = 2; |Y nModPred = 1;
     |BUCLE BorraIvaCab;  ||borre anterior
 |FINSI;
|FCAL;

|CALCULO asinumero; |TIPO 0;
 inkey = FSalida;
 |SI inkey ! 1; |ACABA; |FINSI;

 xx = (FEntrada / 100) ! 0;
 |SI xx = 2; |Y nModPred = 1;
     |BUCLE BorraIvaCab;  ||borre anterior
 |FINSI;
|FCAL;

|PROCESO enalta; |TIPO 7;          || desde campo 'asiento predefinido'
   xx = (FEntrada / 100) ! 0;
   |SI xx = 1;
      |CAMPO_MODIFICA #camaasic#7, 1, "S";
   |SINO;
      |CAMPO_MODIFICA #camaasic#7, 1, "N";
   |FINSI;
|FPRC;

|PROCESO ver_guard; |TIPO 7;
   |SI xx = 1;
      #camaasic#7 = ult_pre; |PINTA #camaasic#7;
   |FINSI;
|FPRC;

|PROCESO guard_pr; |TIPO 0
   ult_pre = #camaasic#7;
|FPRC;

|PROCESO siesta; |TIPO 6;          || desde campo 'asiento predefinido'
   inkey = FSalida;
   |SI inkey = 1;|Y sw_ptec ! 0;  |ACABA;  |FINSI;  || ESC-ESC en repeticion
   ||/desde 'ENCAMPO' 'camaasil'
   |SI sw_ptec ! 0;
       |SI inkey ! 0; |Y inkey ! 10; |Y inkey ! 9;
           |ERROR; ||  #camaasic#7 = 0; |PINTA #camaasic#7;
           |ACABA;
       |FINSI;
   |FINSI;
   |SI inkey = 10; |Y sw_ptec ! 1;
      |ERROR;
      |SI sw_ptec = 2; |PTEC 802; |PTEC 807; |FINSI;
      |SI sw_ptec = 0;            |PTEC 807; |FINSI;
      |ACABA;
   |FINSI;

   xx = (FEntrada / 100) ! 0;
   predefine = 0;

   |ABRE #11;
   #casieaca#0 = #camaasic#7;
   |LEE 001#11=;
   |SI FSalida ! 0;
      |SI #camaasic#7 = 0;
          |DDEFECTO #11;
          |GRABA 020#11n;       || graba la clave 'cero'
      |FINSI;
      |ATRI I; |PINTA 0928, #casieaca#1; |ATRI 0;
      |CIERRA #11;
      |ACABA;
   |SINO;
      |SI #casieaca#2 = "S";
          |SI #casieaca#15 < 2;
              #casieaca#15 = 3;
              |GRABA 020#casieaca.a;
          |FINSI;
      |FINSI;
   |FINSI;

   |ATRI I; |PINTA 0928, #casieaca#1; |ATRI 0;
   |SI #camaasic#7 = 0;  |CIERRA #11;  |ACABA;  |FINSI;  ||NO ES OPERATIVO EL CERO

   |SI xx ! 1; |Y #casieaca#17 ! "X";  |CIERRA #11;  |ACABA;  |FINSI;


   |SI inkey ! 9;|Y inkey ! 10; || en <F1> presenta el asiento
       predefine = 1;           || en <F2> sube al diario
       predefine2 = 1;          ||/(cuando se esta a¤adiendo)
       |SI #casieaca#2 = "S";
           |SI #casieaca#17 = "X"; |Y xx ! 1;
               i_serie = #900#2;
               i_factu = #900#3;
               i_fecha = #900#4;
               sw_ptec = 0;                      ||/este 'PTEC' sobra
               eaCobPag = #casieaca#6;
               |BUCLE BorraIvaCab;  ||borre anterior
           |SINO;
               |HAZ pide_iva;
           |FINSI;
       |FINSI;
   |SINO;
      |SI inkey = 9;               || presenta el asiento
          |HAZ consulta;
          |ERROR;
      |FINSI;
   |FINSI;
   |CIERRA #11;
   #casieali#1 = 0;
|FPRC;

|PROCESO cargconDos;
   |SI #camaasil#8 = "D";
       |SI j_d = 0; j_d = #camaasil#3; |FINSI;
       sw_debe = sw_debe + 1;
   |SINO;
       |SI j_h = 0; j_h = #camaasil#3; |FINSI;
       sw_habe = sw_habe + 1;
   |FINSI;

   |SI sw_debe > 1; |O sw_habe > 1;
       |ERROR10;
   |FINSI;
|FPRC;

|PROCESO VerContra;
   sw_debe = 0; j_d = 0;
   sw_habe = 0; j_h = 0;
   |BUCLELIN 2cargconDos#1;

   |SI sw_debe = 1; |Y sw_habe = 1;
       |ABRE #calicont;

       #calicont#0 = #camaasic#0;
       #calicont#1 = #camaasic#1;
       #calicont#2 = #camaasic#2;
       #calicont#3 = j_d;
       |LEE 141#calicont.=;
       |SI FSalida = 0;
           #calicont#4 = #camaasic#10;
           |GRABA 020#calicont.a;
       |FINSI;
       |LIBERA #calicont;

       #calicont#0 = #camaasic#0;
       #calicont#1 = #camaasic#1;
       #calicont#2 = #camaasic#2;
       #calicont#3 = j_h;
       |LEE 141#calicont.=;
       |SI FSalida = 0;
           #calicont#4 = #camaasic#8;
           |GRABA 020#calicont.a;
       |FINSI;
       |LIBERA #calicont;

       |CIERRA #calicont;
   |FINSI;
|FPRC;

|PROCESO descuadre; |TIPO 3;
   |SI #camaasic#6 ! 0; |Y #camaasic#7 = 0;
      avisos = "AVISO!!! Asiento Descuadrado";
      |HAZ aviso5;
      |PAUSA;
      |HAZ aviso9;
   |FINSI;
   ant_dia = #camaasic#0;
   ant_fec = #camaasic#1;
   ant_ref = #camaasic#17;
   ant_doc = #camaasic#2;
   enPred = 0;
   nSwUlt = 1;
   ivacomun = "";
   NumDocum = 0;

   |HAZ VerContra;

   xx = (FEntrada / 100) ! 0;
   |SI xx = 1; |Y #camaasic#7 ! 0;
       |SI #camaasic#13 = 1; |O #camaasic#13 = 2;
           |SI enPulPre = 0; |Y #casieaca#17 ! "N";
               enLibro    = #camaniva#0;
               enRegistro = #camaniva#1;

               |HAZ eRSChequeo;
           |FINSI;
       |FINSI;
   |FINSI;
   |SI xx = 2;
       |SI #camaasic#13 > 106; |Y #camaasic#13 ! 190; |Y enSwDejar = 1;
           |HAZ eGrabaModificar;
       |FINSI;
   |FINSI;
   enPulPre  = 0;
   enSwDejar = 0;
|FPRC;

****************************************************************************
RUTINAS VARIAS
****************************************************************************

|PROCESO asie_nue;            || calculo 'entrada' /prepara un nuevo asiento
   #camaasic#4 = 0;       || asiento debe
   #camaasic#5 = 0;       || asiento haber
   #camaasic#6 = 0;       || asiento saldo
   |PINTA #camaasic#4;
   |PINTA #camaasic#5;
   |PINTA #camaasic#6;
   coant = 0;
   deant = "";
   dhant = "";
   imant = 0;
   dpant = eaDfDepC;
   sdant = eaDfSubC;
   refant = "";
   predefine2 = 0;
   sw_debe = 0;
   sw_habe = 0;
   j_d = 0;
   j_h = 0;
   ctab1 = "";
   ctab2 = 0;
   ivacomun = "";
   |HAZ el_di;
   nModPred = 0;
   enEmbImp = 0;
   |DDEFECTO #900;
   |DELINDEX #901;
|FPRC;

|PROCESO aviso5;         || desde calculo 'c_importe' (camaasil)
   |PUSHV 09101171;
   |HAZ color_f;
   |CUADRO 09 10 11 71;
   ||            123456789012345678901234567890123456789012345678901234567890
   |HAZ color_c;

   |QBF avisos;
   alfa1 = avisos % 0;  nume1 = alfa1;
   nume2 = ((60 - nume1) / 2) ! 0;     nume1 = 60 - nume1 - nume2;
   avisos = (" " * nume1) + avisos + (" " * nume2);        || lo centra

   |PINTA 1011, avisos;
   |ATRI 0;
   |AVISO;
|FPRC;

|PROCESO aviso9;         || desde calculo 'descuadre', 'modbaj'
   |ATRI 0;
   |POPV;
|FPRC;

|PROCESO color_c;        || activa el color caracter en avisos
   |COLOR 14, 0;
   |ATRI 0;
|FPRC;

|PROCESO color_f;        || activa el color graficos en avisos
   |COLOR 4, 0;
   |ATRI 0;
|FPRC;

|PROCESO pide_iva;       || desde calculo 'siesta' / pide datos ivas
   ext00 = #camaasic#0;
   ext01 = #camaasic#1;
   ext02 = #camaasic#2;
   ext1  = #camaasic#1;        || fecha del asiento
   ext2  = #casieaca#4;        || libro iva
   ext4  = #casieaca#16;       || serie Factura
   ext10 = #camaasic#17;
   ext11 = #casieaca#3;
   ext42 = #casieaca#18;
   eaCobPag = #casieaca#6;
   ext13 = #camaasic#7;
   |SUB_EJECUTA_NP "camaasiv.tab";
   nume1 = ext3;
   |SI nume1 ! 0;                || esto es el FSalida
       predefine = 0;
       predefine2 = 0;
      |ERROR;
   |SINO;
      |QBF ext21;
      i_serie = ext4;
      i_factu = ext5;
      i_fecha = ext1;
      i_activ = ext21; |QBF i_activ;
      |SI ext21 ! ""; dpant = ext21; |FINSI;
      sw_ptec = 0;                      ||/este 'PTEC' sobra
   |FINSI;
   #camaasic#17 = ext10; |PINTA #camaasic#17;
|FPRC;

|PROCESO bor_cobros;          || desde rutina 'a_busca' (camaasil)
   |HAZ VerPuente;
   |SI swVPuente = 1;
       |DDEFECTO #Puente@;
       #Puente@#0 = #camaniva#0;
       #Puente@#1 = #camaniva#2;
       #Puente@#2 = #camaniva#3;
       #Puente@#3 = 0;
       #Puente@#27 = "V";
       #Puente@#28 = "B";
       |GRABA 020#Puente@.n;
       |HAZ CierraPuente;
  |FINSI;
|FPRC;

|PROCESO bor_pagos;           || desde rutina 'a_busca' (camaasil)
   |HAZ VerPuente;
   |SI swVPuente = 1;
       |DDEFECTO #Puente@;
       #Puente@#0 = #camaniva#0;
       #Puente@#1 = #camaniva#2;
       #Puente@#2 = #camaniva#3;
       #Puente@#3 = 0;
       #Puente@#27 = "C";
       #Puente@#28 = "B";
       |GRABA 020#Puente@.n;
       |HAZ CierraPuente;
   |FINSI;
|FPRC;

|PROCESO borraextra;
   |BORRA 020#25a;
   |LIBERA #25;
|FPRC;

|PROCESO extraco;        || desde calculo 'modbaj'  /borra anotaciones
   |ABRE #23;
   #caextras#0 = #camaasil#0;
   #caextras#1 = #camaasil#1;
   #caextras#2 = #camaasil#2;
   |LEE 001#23=;
   |SI FSalida = 0;
      |BUCLELIN 0borraextra#23;
      |BORRA 020#23a;
   |FINSI;
   |CIERRA #23;

   enTipoEx   = 3;
   enDiarioEx = #camaasic#0;
   efFechaEx  = #camaasic#1;
   enDocumEx  = #camaasic#2;
   |HAZ eBorraExtras;
|FPRC;

|PROCESO situate;        || desde rutina 'consulta'
   |CAMPO_POSICION #casieaax#0,1,0847;
   |CAMPO_POSICION #casieaax#1,1,0860;
|FPRC;

|PROCESO correte;        || desde subrutina 'consulta2'
   |CAMPO_POSICION #casieaax#0,0,posic; posic=posic+m_c; |CAMPO_POSICION #casieaax#0,1,posic;
   |CAMPO_POSICION #casieaax#1,0,posic; posic=posic+m_c; |CAMPO_POSICION #casieaax#1,1,posic;
|FPRC;

|PROCESO consulta2;      || desde rutina 'consulta' /BUCLELIN
   lin_con = lin_con + 1;
   |SI #casieali#2 = "D";  #casieaax#0 = #casieali#3;  #casieaax#1 = "     --     ";  |FINSI;
   |SI #casieali#2 = "H";  #casieaax#0 = "     --     ";  #casieaax#1 = #casieali#3;  |FINSI;
   |PINDA #0#13;
   |SI lin_con < 12;
      m_c = 100;
   |SINO;
      m_c = -1100;
      lin_con = 0;
      |PAUSA;
      |PINPA #0#13;
   |FINSI;
   |HAZ correte;
|FPRC;

|PROCESO consulta;       || desde calculo 'siesta' /presenta predefinido
   |HAZ situate;
   |PUSHV 05451974;
   |PUSHV 19292374;
   lin_con = 0;
   |DDEFECTO #13;
   |PINPA #0#13;
   |PINPA #1#13;
   |SI #casieaca#2 = "S";
      |SI #casieaca#3 = "R";  #casieaax#2 = "IVA REPERCUTIDO ";  |FINSI;
      |SI #casieaca#3 = "S";  #casieaax#2 = "IVA SOPORTADO   ";  |FINSI;
      |SI #casieaca#3 = "N";  #casieaax#2 = "REGISTRO SIN IVA";  |FINSI;
      |SI #casieaca#3 = "R";|Y #casieaca#6 = "S";  #casieaax#3 = "/COBROS";  |FINSI;
      |SI #casieaca#3 = "S";|Y #casieaca#6 = "S";  #casieaax#3 = "/PAGOS ";  |FINSI;
   |FINSI;
   |PINDA #1#13;
   |BUCLELIN 2consulta2#11;
   |SI lin_con = 0;
      |MENAV "    ATENCION!!! Cabecera sin lineas ...";
   |SINO;
      |PAUSA;
   |FINSI;
   |POPV;
   |POPV;
|FPRC;

|PROCESO cargcon;
   |SI #camaasil#8 = "D";
      |SI j_d = 0; j_d = #camaasil#3; |FINSI;
   |SINO;
      |SI j_h = 0; j_h = #camaasil#3; |FINSI;
   |FINSI;
   |SI j_d ! 0; |Y j_h ! 0; |ERROR; |FINSI;
|FPRC;

|PROCESO carga_con;
   sw_debe = 0; j_d = 0;
   sw_habe = 0; j_h = 0;
   |SI #camaasic#8  ! doce; sw_debe = 1; |FINSI;
   |SI #camaasic#10 ! doce; sw_habe = 1; |FINSI;
   |SI sw_debe = 0; |Y sw_habe = 0; |ACABA; |FINSI;
   |BUCLELIN 2cargcon#1;
|FPRC;

|RUTINA inf1;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 1;
|FRUT;

|RUTINA sup1;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 9999;
|FRUT;

|PROCESO EligeLinea;
   |ENTLINEAL #1#camaasil,4,1,19,0,inf1,sup1;
|FPRC;

|PROCESO UltimaFecha; |TIPO 7;
  |SI f1auto = 3; |O nSwUlt = 1;
      #camaasic#1 = ant_fec;
      |PINTA #camaasic#1;
      f1auto = 0;
      |ACABA;
  |FINSI;

  |SALVA_DATOS #camaasic;
  nDiario = #camaasic#0;
  #camaasic#0 = nDiario;
  #camaasic#1 = "31.12.2999";
  #camaasic#2 = 999999;
  |LEE 000#camaasic.];
  |SI FSalida = 0;
     |SI #camaasic#0 ! nDiario;
        |LEE 000#camaasic.a;
        |SI #camaasic#0 ! nDiario;
           #camaasic#1 = ~;
        |FINSI;
     |FINSI;
  |SINO;
     #camaasic#1 = ~;
  |FINSI;
  FechaUlt = #camaasic#1;
  |REPON_DATOS #camaasic;
  #camaasic#1 = FechaUlt;
  |SI #camaasic#1 [ fec3; #camaasic#1 = (fec3 + "01.00.0000"); |FINSI;
|FPRC;


|PROCESO VerPuente;
   swVPuente = 0;
   |ABRE #caivaasi;
   |LEE 000#caivaasi.p;
   |SI FSalida ! 0;
      |DDEFECTO #caivaasi;
      |GRABA 020#caivaasi.b;
   |FINSI;
   Comodin = #caivaasi#56; |QBF Comodin;
   |CIERRA #caivaasi;
   |SI Comodin = ""; |ACABA; |FINSI;

   eaPath = Comodin;
   |HAZ CreaPuente;
   |SI eaRetorno = "ERROR"; |ACABA; |FINSI;
   swVPuente = 1;
|FPRC;

|PROCESO Modificacion;
   |ABRE #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 9999;
   |LEE 041#camaasil.];
   |SI FSalida = 0;
       |LEE 041#camaasil.a;
   |SINO;
       |LEE 041#camaasil.u;
   |FINSI;
   |SI FSalida = 0; |Y #camaasil#0 = #camaasic#0;
      |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
         coant = #camaasil#6;
         deant = #camaasil#7;
         imant = #camaasil#9;
         dpant = #camaasil#21;
         sdant = #camaasil#28;
         refant = #camaasil#26;
   |FINSI;
   |CIERRA #camaasil;
|FPRC;

|PROGRAMA;
     eaMensaCad = "9";
     |HAZ ControlCaducidad;
     |SI enErrorCad = 1;
         |ACABA;
     |FINSI;

    nCampo0 = enDiarioDentro;
    fCampo1 = efFechaDentro;
    nCampo2 = enDocumentoDentro;

    |SI enERP ! 0;
        |ABRE #camaasic; |ABRE #camaasil;

        InPuntero = nPuntero1<-;
        |REFERENCIA_DEF nPuntero1, #1;
        |ESPECIFICA "X_POP_ERP", nPuntero;

        |PINPA #0#camaasic; |PINDA #0#camaasic;
        |PUSHV 0501 2380;
        |PTEC 801;
        |ENDATOS #4#camaasic;
        |PAUSA;
        |CIERRA #camaasic;
        |ACABA;
     |FINSI;

     |SI enDocumento = 0;
         swVarios = 0;
         enNoBloq = 1;
         |HAZ inicio;
         enNoBloq = 0;
         |HAZ Analitica;
         |SI enSwAna = 1;
             aAlfa1 = "    NCONTABILIDAD ANALITICA. CONTINUAR ";
             |SI eaAnNiv = "E";
                 aAlfa1 = "    NEMPRESA ANALITICA. CONTINUAR ";
             |FINSI;
             |CONFI aAlfa1;
             |SI FSalida ! 0;
                 |ACABA;
             |FINSI;
         |FINSI;
         |MANTE #1;
     |SINO;
         |SI swVarios = 1;
             |PATH_DAT #0  dirfich0;
             |PATH_DAT #1  dirfich0;
             |PATH_DAT #10 dirfich0;
             |PATH_DAT #11 dirfich0;
             |PATH_DAT #12 dirfich0;
             |PATH_DAT #23 dirfich0;
             |PATH_DAT #25 dirfich0;
             |PATH_DAT #24 dirfich0;
             |PATH_DAT #20 dirfich0;
             |PATH_DAT #500 dirfich0;
             |PATH_DAT #501 dirfich0;
             |PATH_DAT #399 dirfich0;
             |PATH_DAT #1000 dirfich0;
             |PATH_DAT #1001 dirfich0;
             fich_alta = dirfich0;
         |FINSI;

         |ABRET #1;
         |HAZ Atipo8;
         #1#0 = enDiario;
         #1#1 = efFecha;
         #1#2 = enDocumento;
         |LEE 121#1=;
         |SI FSalida = 0;
             |HAZ Modificacion;
             |PINPA #0#1;
             |PINDA #0#1;

             |ENDATOS #2#1;
             |SI FSalida = 0;
                 |GRABA 020#1a;
             |FINSI;
             |LIBERA #1;
         |FINSI;
         |CIERRAT #1;
     |FINSI;

    enDiarioDentro    = nCampo0;
    efFechaDentro     = fCampo1;
    enDocumentoDentro = nCampo2;
|FPRO;

|PROCESO Atipo8; |TIPO 8;
  |HAZ inicial;
  |SI swerror = 2; |PTEC 807; |ACABA; |FINSI;
  |SI swerror = 3; |PTEC 831; |PTEC 807; |ACABA; |FINSI;

  |HAZ DirAplicSt;
  enM349 = 1; |HAZ Consul303; enM349 = 0;
  |HAZ Analitica;
  |C_M #1#17, 1, eaRefer;
  |C_V #1#17, 1, eaRefer;
  |C_V #0#26, 1, eaRefer; |C_M #0#26, 1, eaLnRef;
  |SI eaRefer = "S";   |C_A #casieaca#1,1,27; |FINSI;

  |SI eaSubde = "N";
      |C_A #0#7,  1, 29;
      |C_P #0#21, 1, 1266;
      |C_V #0#28, 1, "N";
  |SINO;
      |SI enSubde = 1; |Y eaDepar = "N";
          |C_A #0#7,  1, 28;
          |C_V #0#21, 1, "N";
      |FINSI;
  |FINSI;

  |ABRE #caivaasi;
  |DDEFECTO #caivaasi;
  |LEE 000#caivaasi.p;
  |CIERRA #caivaasi;
  eaPtec  = #caivaasi#114;
  eaPaDOM2= #caivaasi#133;
  eaPaDOM3= #caivaasi#134;
  eaPaCTA1 = #caivaasi#135;
  eaPaCTA2 = #caivaasi#136;
  eaPaNif1 = #caivaasi#152;
  eaPaNif2 = #caivaasi#153;
  eaABanco = #caivaasi#161;
  eaCP347  = #caivaasi#164;
  eaTEmbargo = #caivaasi#165;
  enCEmbargo = #caivaasi#166;
  eaObClPr   = #caivaasi#186;

  snFiltrA   = #caivaasi#185;
  snFiltr    = #caivaasi#95;
  snFilAc    = #caivaasi#118;
  snFilBa    = #caivaasi#119;
  eaSobreEs  = #caivaasi#155;
  eaDscomer9 = #caivaasi#191;

  |ABRE #123;
  |DDEFECTO #123;
  #123#0 = enEmpresa;
  |LEE 000#123=;
  |CIERRA #123;
  snDescua = #123#5;

  aFichero = "1a" + Usuario; |NOME_DAT #901 aFichero; |DELINDEX #901;

|FPRC;
