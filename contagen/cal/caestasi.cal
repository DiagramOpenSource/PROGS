|FICHEROS;
     caestasi;
     camaasic;
     camaasil;
     calibros;
     canempre;

     caw00053;
     caw00054;
     caw00055;

     :/basica/def/agifigen;
     :/integral/def/dsam0000;
     :/integral/def/dsam0012;
|FIN;

|VARIABLES;
     fFecha   = @;
     aAlfa1   = "";
     aAlfa2   = "";
     aAlfa3   = "";
     nNume1   = 0;
     nNume2   = 0;
     nPara1   = 0;
     nSwMen   = 0;

     nDEmpresa  = 0;
     nHEmpresa  = 0;
     fDFecha    = @;
     fHFecha    = @;
     nDatos     = 0;

     nLaEmpresa = 0;
     nSwTipoE   = 0;
     nSwNoDir   = 0;
     nPin1      = 0;
     aFichero   = "";
     informe    = "";

     aPathTmp            = "";
     aHora               = "";
     aFic                = "";
     aAbre               = "";
     aOri                = "";
     aDes                = "";
     aAlfa               = "";
     aLon                = "";
     aCad                = "";
     aCar                = "";

     nHandle             = 0;
     nGraba              = 0;
     nCmp                = 0;
     nTCmp               = 0;
     nLon                = 0;
     nCar                = 0;
     nPue                = 0;
     nCab                = 0;
     nLibro              = 0;
     nAcum               = 0;
     nAg                 = 0;
     nCmp2               = 0;
     nCmp3               = 0;
     nCmp4               = 0;
     nCmp5               = 0;
     nCmp6               = 0;
     nCmp7               = 0;
     nCmp8               = 0;
     nCmp9               = 0;
     nCmp10              = 0;
     nCmp11              = 0;
     nCmp12              = 0;
     nCmp13              = 0;
     nCmp14              = 0;

 {50}aCmp                = "";

     &nUnMes    = 0;
     &nAgente   = 0;
     &aAgente   = "";
     &eSwLinea  = 0;
     &enTAsto   = 0;
     &enTApte   = 0;
     &enTTAsto  = 0;
     &enTTApte  = 0;

     &eaUnidadBasico = "";
     &eaCadena       = "";
     &enLinLib       = 0;
     &eaNomLib       = "";
|FIN;

|INCLUYE dscont_i;
|INCLUYE util01_i;

|| **** PROCESOS DE SELECCION

|PROCESO NoSirvePaNa;
     |HAZ MensaCliente;
     |HAZ Cacuenta_15;
|FPRC;

|PROCESO VerAgentes; |TIPO 7;
     |HAZ DirAplicSt;
     |SI HayAcceso = 0;
         |C_M #caestasi#41,1,"N";
         |C_M #caestasi#42,1,"N";
         |C_M #caestasi#43,1,"N";
         #caestasi#43 = "N"; |PINTA #caestasi#43;
     |FINSI;
|FPRC;

|PROCESO defectos; |TIPO 7;
     fFecha = ~;
     aAlfa1 = fFecha;
     aAlfa1 = aAlfa1 % -104;
     #caestasi#40 = aAlfa1;
     |PINTA #caestasi#40;
|FPRC;

|PROCESO Parrilla; |TIPO 0;
     |SI #caestasi#2 = 0;
         #caestasi#2 = 0;  |PINTA #caestasi#2;
         #caestasi#3 = 0;  |PINTA #caestasi#3;  |C_M #caestasi#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #caestasi#2, 1, "S";
             |C_M #caestasi#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "N";
               #caestasi#nCampo# = 0;  |PINTA #caestasi#nCampo#;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas; |TIPO 0;
     |SI #caestasi#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #caestasi#nCampo# = 0;  |C_M #caestasi#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO SelTipo0; |TIPO 0;
     |SI #caestasi#37 = "N";
         #caestasi#25 = 0;   |PINTA #caestasi#25;  |C_M #caestasi#25, 1, "N";
         #caestasi#26 = 99;  |PINTA #caestasi#26;  |C_M #caestasi#26, 1, "N";
         |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #caestasi#25, 1, "S";
         |C_M #caestasi#26, 1, "S";
         |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "N";
               #caestasi#nCampo# = 0;  |PINTA #caestasi#nCampo#;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO SelTipo1;
     |SI #caestasi#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
               #caestasi#nCampo# = 0;  |C_M #caestasi#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
               |C_M #caestasi#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO pintames; |TIPO 0;
     nCampo = Campo + 38;
     NumMes = #caestasi#Campo#;
     |HAZ NombreMes;
     #caestasi#nCampo# = NombreMes;
     |PINTA #caestasi#nCampo#;

     aAlfa1 = "S";
     |SI Campo = 1;
         nNume1 = #caestasi#1 - #caestasi#0;
         |SI nNume1 = 0;
             aAlfa1 = "N";
             #caestasi#44 = "S";
             |PINTA #caestasi#44;
         |FINSI;
     |FINSI;
     |C_M #caestasi#44, 1, aAlfa1;

     |SI Campo = 1; |Y  #caestasi#0 > #caestasi#1;
         |SI nSwMen = 0;
             |MENAV "    Error de Entrada ...";
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO T0C118;
     |C_M #caestasi#43, 1, "S";
     |C_M #caestasi#44, 1, "S";

     |SI #caestasi#118 = "C";
         |C_M #caestasi#43, 1, "N";  #caestasi#43 = "N";
         |C_M #caestasi#44, 1, "N";  #caestasi#44 = "N";
     |FINSI;

     |PINTA #caestasi#43;
     |PINTA #caestasi#44;
|FPRC;

|| ***********************************************************************
|PROCESO CalFechas;
     cod2 = #canempre#26;
     tra1 = 100 + cod2;
     clave2 = tra1 % -102;
     tra1 = 100 + #canempre#11;
     mes1 = tra1 % -102;
     |SI cod2 < 80;
        work1 = "01." + mes1 + ".20" + clave2;
     |SINO;
        work1 = "01." + mes1 + ".19" + clave2;
     |FINSI;
     enAny = #canempre#26;
     fec1 = work1;
     tra1 = 100 + #canempre#12;
     mes1 = tra1 % -102;
     |SI #canempre#11 > #canempre#12;
        cod2 = cod2 + 1;
        |SI cod2 > 99; cod2 = cod2 - 100;    |FINSI;
     |FINSI;
     dia1 = "31";
     |SI #canempre#12 = 4; |O #canempre#12 = 6; |O #canempre#12 = 9; |O #canempre#12 = 11;
        dia1 = "30";
     |FINSI;
     |SI #canempre#12 = 2;
        dia1 = "28";
        |SI cod2 = 88; |O cod2 = 92; |O cod2 = 96; |O cod2 = 0; |O cod2 = 4; |O cod2 = 8;
            |O cod2 = 12; |O cod2 = 16; |O cod2 = 20; |O cod2 = 24;
           dia1 = "29";
        |FINSI;
     |FINSI;
     tra1 = 100 + cod2;
     clave2 = tra1 % -102;
     |SI cod2 < 80;
        work1 = dia1 + "." + mes1 + ".20" + clave2;
     |SINO;
        work1 = dia1 + "." + mes1 + ".19" + clave2;
     |FINSI;
     fec2 = work1;
|FPRC;

|PROCESO CalDirectorio;
     |DBASS dir_fich; |QBF dir_fich;
     dir_fich = dir_fich + "contagen/fich/";
     aAlfa1 = #canempre#2; |QBF aAlfa1;
     aAlfa2 = #canempre#3; |QBF aAlfa2;
     aAlfa1 = "00000" + aAlfa1;   aAlfa1 = aAlfa1 % -105;
     aAlfa2 = "0"     + aAlfa2;   aAlfa2 = aAlfa2 % -101;
     dirfich0 = dir_fich + aAlfa1 + aAlfa2 + "/";

     nSwNoDir = 0;
     |MKDIR dirfich0;
     |SI FSalida = 0;
         nSwNoDir = 1;
         |RMDIR dirfich0;
     |FINSI;
|FPRC;

|PROCESO CogerAgente;
     nSwTipoE = 1;
     |DDEFECTO #dsam0000;
     #dsam0000#0 = nLaEmpresa;
     |LEE 041#dsam0000.=;
     nAgente = #dsam0000#72;
     aAgente = #dsam0000#52;

     #dsam0012#0 = nLaEmpresa;
     #dsam0012#1 = 1;
     |LEE 041#dsam0012.=;
     |SI FSalida = 0;
         nAgente = #dsam0012#2;
         aAgente = #dsam0012#3;
     |FINSI;

     |SI nAgente ] #caestasi#41; |Y nAgente [ #caestasi#42;
         nSwTipoE = 0;
     |FINSI;
|FPRC;

|PROCESO ElTipoEmpresa;
     nSwTipoE = 1;

     nPin1 = #agifigen#87;
     |SI #caestasi#37 = "S";
         |SI nPin1 ] #caestasi#25; |Y nPin1 [ #caestasi#26;
             nSwTipoE = 0;
         |FINSI;
     |SINO;
         |SI nPin1 = #caestasi#27;
             nSwTipoE = 0;
         |SINO;
             |PARA nCampo = 28;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                   |SI nPin1 = #caestasi#nCampo#; |Y nPin1 ! 0;
                       nSwTipoE = 0;
                       |SAL;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO CuentoAptes;
     |SI nLibro = 0;
         |SI #camaasil#12 = "R"; |O #camaasil#12 = "S"; |O #camaasil#12 = "N";
             nLibro = #camaasil#13;
         |FINSI;
     |FINSI;

     #caestasi#nNume2# = #caestasi#nNume2# + 1;
|FPRC;

|DEFBUCLE CuentoAptes;
     #camaasil#1;
     ;
     #camaasic#0, #camaasic#1, #camaasic#2, 0001;
     #camaasic#0, #camaasic#1, #camaasic#2, 9999;
     ;
     NULL, CuentoAptes;
|FIN;

|PROCESO camaasil;
     |SI nLibro = 0;
         |SI #camaasil#12 = "R"; |O #camaasil#12 = "S"; |O #camaasil#12 = "N";
             nLibro = #camaasil#13;
         |FINSI;
     |FINSI;

     |SI nLibro ! 0;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE camaasil;
     #camaasil#1;
     ;
     #camaasic#0, #camaasic#1, #camaasic#2, 0001;
     #camaasic#0, #camaasic#1, #camaasic#2, 9999;
     ;
     NULL, camaasil;
|FIN;

|PROCESO CargaLibro;
     #calibros#0 = nLibro;
     |LEE 000#calibros.=;
     |SI FSalida ! 0;  |DDEFECTO #calibros;  |FINSI;

     nAcum = nAgente;
     |SI #caestasi#43 = "N";
         nAcum = 999;
     |FINSI;

     #calibros#2 = #calibros#2 > "";

     |SI #calibros#2 = "R";  #caw00053#32 = #caw00053#32 + 1;  |FINSI;
     |SI #calibros#2 = "S";  #caw00053#33 = #caw00053#33 + 1;  |FINSI;
     |SI #calibros#2 = "N";  #caw00053#34 = #caw00053#34 + 1;  |FINSI;

     #caw00054#0 = nAcum;
     #caw00054#1 = #calibros#2 > "";
     |LEE 101#caw00054.=;
     |SI FSalida ! 0;
         |DDEFECTO #caw00054;
         #caw00054#0 = nAcum;
         #caw00054#1 = #calibros#2 > "";
         |GRABA 020#caw00054.b;
     |FINSI;

     nNume2 = nNume1 - 43;
     #caw00054#nNume2# = #caw00054#nNume2# + 1;
     #caw00054#14      = #caw00054#14 + 1;

     |GRABA 020#caw00054.a;
     |LIBERA #caw00054;

     |SI nAcum ! 999;
         #caw00054#0 = 999;
         #caw00054#1 = #calibros#2 > "";
         |LEE 101#caw00054.=;
         |SI FSalida ! 0;
             |DDEFECTO #caw00054;
             #caw00054#0 = 999;
             #caw00054#1 = #calibros#2 > "";
             |GRABA 020#caw00054.b;
         |FINSI;

         nNume2 = nNume1 - 43;
         #caw00054#nNume2# = #caw00054#nNume2# + 1;
         #caw00054#14      = #caw00054#14 + 1;

         |GRABA 020#caw00054.a;
         |LIBERA #caw00054;
     |FINSI;

     #caw00055#0 = #canempre#2;
     #caw00055#1 = #calibros#2 > "";
     |LEE 101#caw00055.=;
     |SI FSalida ! 0;
         |DDEFECTO #caw00055;
         #caw00055#0 = #canempre#2;
         #caw00055#1 = #calibros#2 > "";
         |GRABA 020#caw00055.b;
     |FINSI;

     nNume2 = nNume1 - 43;
     #caw00055#nNume2# = #caw00055#nNume2# + 1;
     #caw00055#14      = #caw00055#14 + 1;

     |GRABA 020#caw00055.a;
     |LIBERA #caw00055;

     #caw00055#0 = #canempre#2;
     #caw00055#1 = "Z";
     |LEE 101#caw00055.=;
     |SI FSalida ! 0;
         |DDEFECTO #caw00055;
         #caw00055#0 = #canempre#2;
         #caw00055#1 = "Z";
         |GRABA 020#caw00055.b;
     |FINSI;

     nNume2 = nNume1 - 43;
     #caw00055#nNume2# = #caw00055#nNume2# - 1;
     #caw00055#14      = #caw00055#14 - 1;

     |GRABA 020#caw00055.a;
     |LIBERA #caw00055;
|FPRC;

|PROCESO LeeAsientos;
     nLibro = 0;
     aAlfa1 = #camaasic#1;
     aAlfa1 = aAlfa1 % 402;
     NumMes = aAlfa1;

     |SI #caestasi#118 = "I";
         nNume1 = -1;
         |PARA nCampo = 45; |SI nCampo [ 56; |HACIENDO nCampo = nCampo + 1;
             |SI NumMes = #caestasi#nCampo#;
                  nNume1 = nCampo;
                  |SAL;
             |FINSI;
         |SIGUE;
     |FINSI;

     |SI #caestasi#118 = "C";
         nNume1 = 44 + NumMes;
     |FINSI;

     |SI nNume1 ! -1;
         nNume2 = nNume1 + 24;
         #caestasi#nNume2# = #caestasi#nNume2# + 1;
         |SI #caestasi#44 = "S";
              nNume2 = nNume2 + 12;
              |BUCLE CuentoAptes;
         |FINSI;

         |SI #caestasi#44 = "N";
              |BUCLE camaasil;
         |FINSI;

         #caw00055#0 = #canempre#2;
         #caw00055#1 = "Z";
         |LEE 101#caw00055.=;
         |SI FSalida ! 0;
             |DDEFECTO #caw00055;
             #caw00055#0 = #canempre#2;
             #caw00055#1 = "Z";
             |GRABA 020#caw00055.b;
         |FINSI;

         nNume2 = nNume1 - 43;
         #caw00055#nNume2# = #caw00055#nNume2# + 1;
         #caw00055#14      = #caw00055#14 + 1;

         |GRABA 020#caw00055.a;
         |LIBERA #caw00055;

         |SI nLibro ! 0;
             |HAZ CargaLibro;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LeeAsientos;
     #camaasic#1;
     ;
     00, fDFecha, 000001;
     99, fHFecha, 999999;
     e;
     NULL, LeeAsientos;
|FIN;

|PROCESO canempre;
     |HAZ CalFechas;
     |SI fec1 > fHFecha; |O fec2 < fDFecha; |ACABA; |FINSI;
     |SI #caestasi#24 = "N"; |Y #canempre#21 = "I";
         |ACABA;
     |FINSI;

     |HAZ CalDirectorio;
     |SI nSwNoDir = 1;
         |ACABA;
     |FINSI;
     |PATH_DAT #calibros#dirfich0#;
     |PATH_DAT #camaasic#dirfich0#;
     |PATH_DAT #camaasil#dirfich0#;

     |ABRE #calibros;
     |BUCLE LeeAsientos;
     |CIERRA #calibros;

     nDatos = 1;
|FPRC;

|DEFBUCLE canempre;
     #canempre#1;
     ;
     nLaEmpresa, 0;
     nLaEmpresa, 9;
     ;
     NULL, canempre;
|FIN;

|PROCESO Rellena;
     |PDEFECTO #caestasi, 69, 93;
     nAgente    = 0;
     aAgente    = "";
     nLaEmpresa = #agifigen#0;

     |HAZ ElTipoEmpresa;
     |SI nSwTipoE = 1; |ACABA; |FINSI;

     |SI HayAcceso = 1;
         |HAZ CogerAgente;
         |SI nSwTipoE = 1; |ACABA; |FINSI;
     |FINSI;

     |DDEFECTO #caw00053;
     #caw00053#0 = nLaEmpresa;
     |LEE 101#caw00053.=;
     |SI FSalida ! 0;
         |DDEFECTO #caw00053;
         #caw00053#0 = nLaEmpresa;
         #caw00053#1 = #caestasi#40;
         #caw00053#2 = nAgente;
         #caw00053#3 = #agifigen#1;
         #caw00053#4 = #agifigen#13;
         #caw00053#5 = aAgente;
         |GRABA 020#caw00053.b;
     |FINSI;

     nDatos = 0;
     |BUCLE canempre;

     |SI nDatos = 0;
         |BORRA 020#caw00053.a;

         |ACABA;
     |FINSI;

     #caw00053#30 = 0;
     #caw00053#31 = 0;
     |PARA nCampo = 6; |SI nCampo [ 29; |HACIENDO nCampo = nCampo + 1;
           nNume1 = nCampo + 63;
           #caw00053#nCampo# = #caw00053#nCampo# + #caestasi#nNume1#;

           |SI nCampo [ 17;
               #caw00053#30 = #caw00053#30 + #caw00053#nCampo#;
           |FINSI;

           |SI nCampo ] 18;
               #caw00053#31 = #caw00053#31 + #caw00053#nCampo#;
           |FINSI;
     |SIGUE;

     #caw00053#35 = #caw00053#30 - #caw00053#32 - #caw00053#33 - #caw00053#34;

     |GRABA 020#caw00053.a;
     |LIBERA #caw00053;
|FPRC;

|DEFBUCLE Rellena;
     #agifigen#1;
     ;
     nDEmpresa;
     nHEmpresa;
     ;
     NULL,Rellena;
|FIN;

|PROCESO ElNomMes;
     |SI NumMes = 1;  NombreMes = "  Enero"; |FINSI;
     |SI NumMes = 2;  NombreMes = "Febrero"; |FINSI;
     |SI NumMes = 3;  NombreMes = "  Marzo"; |FINSI;
     |SI NumMes = 4;  NombreMes = "  Abril"; |FINSI;
     |SI NumMes = 5;  NombreMes = "   Mayo"; |FINSI;
     |SI NumMes = 6;  NombreMes = "  Junio"; |FINSI;
     |SI NumMes = 7;  NombreMes = "  Julio"; |FINSI;
     |SI NumMes = 8;  NombreMes = " Agosto"; |FINSI;
     |SI NumMes = 9;  NombreMes = "Septbre"; |FINSI;
     |SI NumMes = 10; NombreMes = "Octubre"; |FINSI;
     |SI NumMes = 11; NombreMes = "Novmbre"; |FINSI;
     |SI NumMes = 12; NombreMes = "Dicmbre"; |FINSI;
|FPRC;

|PROCESO NombreMeses;
     nUnMes = 0;
     aAlfa1 = "";
     |PDEFECTO #caestasi, 45, 69;
     nNume1 = 44;
     |PARA NumMes = #caestasi#0; |SI NumMes [ #caestasi#1; |HACIENDO NumMes = NumMes + 1;
           nNume1 = nNume1 + 1;
           nNume2 = nNume1 + 12;
           |HAZ ElNomMes;
           #caestasi#nNume1# = NumMes;
           #caestasi#nNume2# = NombreMes
           aAlfa1 = aAlfa1 + "========";
           nUnMes = nUnMes + 1;
     |SIGUE;

     #caestasi#93 = aAlfa1;
|FPRC;

|PROCESO caw00054;
     nCmp2  = nCmp2  - #caw00054#2;
     nCmp3  = nCmp3  - #caw00054#3;
     nCmp4  = nCmp4  - #caw00054#4;
     nCmp5  = nCmp5  - #caw00054#5;
     nCmp6  = nCmp6  - #caw00054#6;
     nCmp7  = nCmp7  - #caw00054#7;
     nCmp8  = nCmp8  - #caw00054#8;
     nCmp9  = nCmp9  - #caw00054#9;
     nCmp10 = nCmp10 - #caw00054#10;
     nCmp11 = nCmp11 - #caw00054#11;
     nCmp12 = nCmp12 - #caw00054#12;
     nCmp13 = nCmp13 - #caw00054#13;
     nCmp14 = nCmp14 - #caw00054#14;

     |SI #caw00054#1 = "R";  eaNomLib = "Total Libro Emitidas";   |FINSI;
     |SI #caw00054#1 = "S";  eaNomLib = "Total Libro Recibidas";  |FINSI;
     |SI #caw00054#1 = "N";  eaNomLib = "Total Libro No IVA";     |FINSI;

     |SI informe = "caesta11";  |O informe = "caesta13";
         #caw00054#2  = 0;
     |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE caw00054;
     #caw00054#1;
     ;
     nAg, "";
     nAg, "z";
     ;
     NULL, caw00054;
|FIN;

|PROCESO caw00055;
     |SI #caw00055#1 = "R";  eaNomLib = "      Libro Emitidas";   |FINSI;
     |SI #caw00055#1 = "S";  eaNomLib = "      Libro Recibidas";  |FINSI;
     |SI #caw00055#1 = "N";  eaNomLib = "      Libro No IVA";     |FINSI;
     |SI #caw00055#1 = "Z";  eaNomLib = "      Resto";            |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE caw00055;
     #caw00055#1;
     ;
     #caw00053#0, "";
     #caw00053#0, "z";
     ;
     NULL, caw00055;
|FIN;

|PROCESO TotalAgente;
     eSwLinea = 2;  |PRINT;

     nCmp2  = #caestasi#69;
     nCmp3  = #caestasi#70;
     nCmp4  = #caestasi#71;
     nCmp5  = #caestasi#72;
     nCmp6  = #caestasi#73;
     nCmp7  = #caestasi#74;
     nCmp8  = #caestasi#75;
     nCmp9  = #caestasi#76;
     nCmp10 = #caestasi#77;
     nCmp11 = #caestasi#78;
     nCmp12 = #caestasi#79;
     nCmp13 = #caestasi#80;
     nCmp14 = enTAsto;

     |LEE 000#caw00054.p;
     |SI FSalida = 0;
         nAg      = nAgente;
         eSwLinea = 4;  |BUCLE caw00054;
     |FINSI;

     eaNomLib = "Total Resto   ";
     #caw00054#2  = nCmp2;
     #caw00054#3  = nCmp3;
     #caw00054#4  = nCmp4;
     #caw00054#5  = nCmp5;
     #caw00054#6  = nCmp6;
     #caw00054#7  = nCmp7;
     #caw00054#8  = nCmp8;
     #caw00054#9  = nCmp9;
     #caw00054#10 = nCmp10;
     #caw00054#11 = nCmp11;
     #caw00054#12 = nCmp12;
     #caw00054#13 = nCmp13;
     #caw00054#14 = nCmp14;

     eSwLinea = 4;  |PRINT;

     |SI #caestasi#44 = "S";
         eSwLinea = 22;
         |PRINT;
     |FINSI;
|FPRC;

|PROCESO Imprimir;
     enLinLib = 0;
     |SI nAgente ! #caw00053#2; |Y #caestasi#43 = "S";
         |SI nAgente ! -1;
             |HAZ TotalAgente;
         |FINSI;

         nAgente = #caw00053#2;
         aAgente = #caw00053#5;
         eSwLinea = 0;
         |PDEFECTO #caestasi, 69, 93;
         enTAsto = 0;
         enTApte = 0;
     |FINSI;

     |PRINT;
     eSwLinea = 1;

     enTAsto  = enTAsto  + #caw00053#30;
     enTTAsto = enTTAsto + #caw00053#30;
     enTApte  = enTApte  + #caw00053#31;
     enTTApte = enTTApte + #caw00053#31;
     |PARA nCampo = 6; |SI nCampo [ 29; |HACIENDO nCampo = nCampo + 1;
           nNume1 = nCampo + 63;
           #caestasi#nNume1# = #caestasi#nNume1# + #caw00053#nCampo#;
           nNume1 = nCampo + 88;
           #caestasi#nNume1# = #caestasi#nNume1# + #caw00053#nCampo#;
     |SIGUE;

     |SI HayAcceso ! 0;
         enLinLib = 3;
         eSwLinea = 7;
         |BUCLE caw00055;

         |SI #caestasi#44 = "S";
             enLinLib = 10;
             eSwLinea = 11;  |PRINT;
         |FINSI;

         enLinLib = 11;
         eSwLinea = 12;  |PRINT;

         eSwLinea = 1;
     |FINSI;
|FPRC;

|DEFBUCLE Imprimir_E;
     #caw00053#1;
     ;
     00001;
     99999;
     ;
     NULL, Imprimir;
|FIN;

|DEFBUCLE Imprimir_A;
     #caw00053#2;
     ;
     00, 00001;
     99, 99999;
     ;
     NULL, Imprimir;
|FIN;

|PROCESO PorImpresora;
     |IMPRE 0;
     |SI FSalida ! 0;
         |MENAV "0000Impresora no valida. Proceso interrumpido";
         |ACABA;
     |FINSI;

     informe = "caestas1";
     |SI nUnMes = 1; informe = "caesta11"; |FINSI;
     |SI HayAcceso = 0;
         informe = "caestas2";
         |SI nUnMes = 1; informe = "caesta12"; |FINSI;
     |FINSI;

     |SI #caestasi#43 = "S";
         informe = "caestas3";
         |SI nUnMes [ 4; informe = "caestas4"; |FINSI;
         |SI nUnMes = 1; informe = "caesta13"; |FINSI;
     |FINSI;

     |INFOR informe;
     |SI FSalida ! 0;
         |MENAV "0000No existe Informe. Proceso interrumpido";
         |FINIMP;
         |ACABA;
     |FINSI;

     |PDEFECTO #caestasi, 69, 93;
     |PDEFECTO #caestasi, 94, 118;

     enTAsto = 0;
     enTApte = 0;
     nAgente = -1;
     aAgente = "";
     |SI #caestasi#43 = "N"; |BUCLE Imprimir_E; |FINSI;

     |SI #caestasi#43 = "S";
         |BUCLE Imprimir_A;
         |SI nAgente ! -1;
             enLinLib = 0;

             |HAZ TotalAgente;
         |FINSI;
     |FINSI;

     |SI informe = "caestas1"; |O informe = "caesta11";
         enLinLib = 1;  |PRINT;

         enLinLib = 2;
         eaNomLib = "Total Asientos";

         #caw00054#14 = enTTAsto;
         #caw00054#2  = #caestasi#94;
         #caw00054#3  = #caestasi#95;
         #caw00054#4  = #caestasi#96;
         #caw00054#5  = #caestasi#97;
         #caw00054#6  = #caestasi#98;
         #caw00054#7  = #caestasi#99;
         #caw00054#8  = #caestasi#100;
         #caw00054#9  = #caestasi#101;
         #caw00054#10 = #caestasi#102;
         #caw00054#11 = #caestasi#103;
         #caw00054#12 = #caestasi#104;
         #caw00054#13 = #caestasi#105;

         |SI informe = "caesta11";
             #caw00054#2  = #caestasi#106;
         |FINSI;

         |PRINT;

         nCmp2  = #caw00054#2;
         nCmp3  = #caw00054#3;
         nCmp4  = #caw00054#4;
         nCmp5  = #caw00054#5;
         nCmp6  = #caw00054#6;
         nCmp7  = #caw00054#7;
         nCmp8  = #caw00054#8;
         nCmp9  = #caw00054#9;
         nCmp10 = #caw00054#10;
         nCmp11 = #caw00054#11;
         nCmp12 = #caw00054#12;
         nCmp13 = #caw00054#13;
         nCmp14 = #caw00054#14;

         |LEE 000#caw00054.p;
         |SI FSalida = 0;
             nAg      = 999;
             enLinLib = 2;  |BUCLE caw00054;

             eaNomLib = "Total Resto   ";
             #caw00054#2  = nCmp2;
             #caw00054#3  = nCmp3;
             #caw00054#4  = nCmp4;
             #caw00054#5  = nCmp5;
             #caw00054#6  = nCmp6;
             #caw00054#7  = nCmp7;
             #caw00054#8  = nCmp8;
             #caw00054#9  = nCmp9;
             #caw00054#10 = nCmp10;
             #caw00054#11 = nCmp11;
             #caw00054#12 = nCmp12;
             #caw00054#13 = nCmp13;
             #caw00054#14 = nCmp14;

             |SI informe = "caesta11";
                 #caw00054#2  = 0;
             |FINSI;

             |PRINT;
         |FINSI;
     |FINSI;

     |SI #caestasi#43 = "S";
         eaNomLib     = "Total Asientos";

         #caw00054#14 = enTTAsto;
         #caw00054#2  = #caestasi#94;
         #caw00054#3  = #caestasi#95;
         #caw00054#4  = #caestasi#96;
         #caw00054#5  = #caestasi#97;
         #caw00054#6  = #caestasi#98;
         #caw00054#7  = #caestasi#99;
         #caw00054#8  = #caestasi#100;
         #caw00054#9  = #caestasi#101;
         #caw00054#10 = #caestasi#102;
         #caw00054#11 = #caestasi#103;
         #caw00054#12 = #caestasi#104;
         #caw00054#13 = #caestasi#105;

         nCmp2  = #caestasi#94;
         nCmp3  = #caestasi#95;
         nCmp4  = #caestasi#96;
         nCmp5  = #caestasi#97;
         nCmp6  = #caestasi#98;
         nCmp7  = #caestasi#99;
         nCmp8  = #caestasi#100;
         nCmp9  = #caestasi#101;
         nCmp10 = #caestasi#102;
         nCmp11 = #caestasi#103;
         nCmp12 = #caestasi#104;
         nCmp13 = #caestasi#105;
         nCmp14 = enTTAsto;

         |SI informe = "caesta13";
             #caw00054#2  = #caestasi#106;
         |FINSI;

         eSwLinea = 5;  |PRINT;
         eSwLinea = 6;  |PRINT;

         |LEE 000#caw00054.p;
         |SI FSalida = 0;
             nAg      = 999;
             eSwLinea = 6;  |BUCLE caw00054;
         |FINSI;

         eaNomLib = "Total Resto   ";
         #caw00054#2  = nCmp2;
         #caw00054#3  = nCmp3;
         #caw00054#4  = nCmp4;
         #caw00054#5  = nCmp5;
         #caw00054#6  = nCmp6;
         #caw00054#7  = nCmp7;
         #caw00054#8  = nCmp8;
         #caw00054#9  = nCmp9;
         #caw00054#10 = nCmp10;
         #caw00054#11 = nCmp11;
         #caw00054#12 = nCmp12;
         #caw00054#13 = nCmp13;
         #caw00054#14 = nCmp14;

         |SI informe = "caesta13";
             #caw00054#2  = 0;
         |FINSI;

         eSwLinea = 6;  |PRINT;
     |FINSI;

     |PIEINF;
     |FININF;
     |FINIMP;
|FPRC;

|PROCESO PonComas;
     aLon = aAlfa % 0;
     nLon = aLon;
     aCad = "";
     |PARA nCar = 1;  |SI nCar [ nLon;  |HACIENDO nCar = nCar + 1;
           nPue = (100 * nCar) + 1;
           aCar = aAlfa % nPue;

           |SI aCar = ".";
               aCar = ",";
           |FINSI;

           aCad = aCad + aCar;
     |SIGUE;

     aAlfa = aCad;
|FPRC;

|PROCESO LimpiaCmp;
     IaCmp = aCmp1 <-;
     |PARA nCmp = 1;  |SI nCmp [ 40;  |HACIENDO nCmp = nCmp + 1;
           aCmp = "";
           IaCmp = IaCmp + 1;
     |SIGUE;
|FPRC;

|PROCESO GrabaCSV;
     IaCmp = aCmp1 <-;
     |PARA nCmp = 1;  |SI nCmp [ nTCmp;  |HACIENDO nCmp = nCmp + 1;
           eaCadena = aCmp; |QBF eaCadena;  |HAZ QuitaRaros_D;
           |XGRABA nHandle, eaCadena;

           |SI nCmp ! nTCmp;
               |XGRABA nHandle, ";";
           |FINSI;

           aCmp  = "";
           IaCmp = IaCmp + 1;
     |SIGUE;

     aAlfa = &13 + &10;
     |XGRABA nHandle, aAlfa;

     nGraba = 1;
|FPRC;

|PROCESO CSV_ConAgente;
     nTCmp = 21;

     |SI nCab = 0;
         aCmp10 = "Asientos por meses";
         |HAZ GrabaCSV;

         aCmp1  = "Cod.Empresa";
         aCmp2  = "Nombre Empresa";
         aCmp3  = "Cod.Agente";
         aCmp4  = "Nombre Agente";
         aCmp5  = "Total";
         aCmp6  = "Libro Emitidas";
         aCmp7  = "Libro Recibidas";
         aCmp8  = "Libro No IVA";
         aCmp9  = "Resto";
         aCmp10 = "Enero";
         aCmp11 = "Febrero";
         aCmp12 = "Marzo";
         aCmp13 = "Abril";
         aCmp14 = "Mayo";
         aCmp15 = "Junio";
         aCmp16 = "Julio";
         aCmp17 = "Agosto";
         aCmp18 = "Septiembre";
         aCmp19 = "Octubre";
         aCmp20 = "Noviembre";
         aCmp21 = "Diciembre";

         |HAZ GrabaCSV;
         |HAZ LimpiaCmp;

         nCab = 1;
     |FINSI;

     aCmp1  = ("00000" + #caw00053#0) % -105;
     aCmp2  = #caw00053#3;
     aCmp3  = #caw00053#2;
     aCmp4  = #caw00053#5;
     aCmp5  = #caw00053#30;
     aCmp6  = #caw00053#32;
     aCmp7  = #caw00053#33;
     aCmp8  = #caw00053#34;
     aCmp9  = #caw00053#35;

     IaCmp  = aCmp10 <-;
     |PARA nCmp = 6;  |SI nCmp [ 17;  |HACIENDO nCmp = nCmp + 1;
           aAlfa  = #caw00053#nCmp#;  |HAZ PonComas;  aCmp = aAlfa;

           IaCmp  = IaCmp + 1;
     |SIGUE;

     |HAZ GrabaCSV;
|FPRC;

|PROCESO CSV_SinAgente;
     nTCmp = 19;

     |SI nCab = 0;
         aCmp8 = "Asientos por meses";
         |HAZ GrabaCSV;

         aCmp1  = "Cod.Empresa";
         aCmp2  = "Nombre Empresa";
         aCmp3  = "Total";
         aCmp4  = "Libro Emitidas";
         aCmp5  = "Libro Recibidas";
         aCmp6  = "Libro No IVA";
         aCmp7  = "Resto";
         aCmp8  = "Enero";
         aCmp9  = "Febrero";
         aCmp10 = "Marzo";
         aCmp11 = "Abril";
         aCmp12 = "Mayo";
         aCmp13 = "Junio";
         aCmp14 = "Julio";
         aCmp15 = "Agosto";
         aCmp16 = "Septiembre";
         aCmp17 = "Octubre";
         aCmp18 = "Noviembre";
         aCmp19 = "Diciembre";

         |HAZ GrabaCSV;
         |HAZ LimpiaCmp;

         nCab = 1;
     |FINSI;

     aCmp1  = ("00000" + #caw00053#0) % -105;
     aCmp2  = #caw00053#3;
     aCmp3  = #caw00053#30;
     aCmp4  = #caw00053#32;
     aCmp5  = #caw00053#33;
     aCmp6  = #caw00053#34;
     aCmp7  = #caw00053#35;

     IaCmp  = aCmp8 <-;
     |PARA nCmp = 6;  |SI nCmp [ 17;  |HACIENDO nCmp = nCmp + 1;
           aAlfa  = #caw00053#nCmp#;  |HAZ PonComas;  aCmp = aAlfa;

           IaCmp  = IaCmp + 1;
     |SIGUE;

     |HAZ GrabaCSV;
|FPRC;

|PROCESO caw00053CSV;
     |HAZ LimpiaCmp;

     |SI HayAcceso ! 0;
         |HAZ CSV_ConAgente;
     |FINSI;

     |SI HayAcceso = 0;
         |HAZ CSV_SinAgente;
     |FINSI;
|FPRC;

|DEFBUCLE caw00053CSV_1;
     #caw00053#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, caw00053CSV;
|FIN;

|PROCESO PorCSV;
     nCab = 0;

     |DBASE aBase;
     aPathTmp = aBase + "tmp";             |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/" + Usuario;  |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/";

     fFecha = ~;
     |HORA aHora;

     aFic = fFecha % -104;
     aFic = aFic + (fFecha % 402);
     aFic = aFic + (fFecha % 102);
     aFic = aFic + (aHora  % 102);
     aFic = aFic + (aHora  % 402);
     aFic = aFic + (aHora  % 702);
     aFic = aFic + ".csv";

     aAbre = aPathTmp + aFic;
     |XABRE "WB", aAbre, nHandle;

     nAgente = -1;

     |BUCLE caw00053CSV_1;

     |XCIERRA nHandle;

     |SI nGraba = 0;
         aAbre = aPathTmp + aFic;   |FBORRA aAbre;
         |MENAV "0000Selecci¢m vacia.";
         |ACABA;
     |FINSI;

     |HAZ LeeUnidadBasico;
     aDes = eaUnidadBasico + "/DOCUMENTOS";  |RMKDIR aDes;
     aDes = aDes + "/CSV";                   |RMKDIR aDes;
     aDes = aDes + "/";

     aOri = aPathTmp + aFic;
     aDes = aDes     + aFic;
     |ENVIA_FICHERO aOri, aDes;
     |SI FSalida = 0;
         |BLANCO 0501 2380;
         |CUADRO 0501 2380;

         |ATRI I;
         |PINTA 1002, "El CSV generado se encuentra en";
         |ATRI 0;

         |ATRI P;
         |PINTA 1202, aDes;
         |ATRI 0;

         |LEETECLA aAlfa;
     |FINSI;

     |FBORRA aOri;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     aAlfa1 = #caestasi#40;
     aAlfa2 = ("00" + #caestasi#0) % -102;
     aAlfa2 = "01." + aAlfa2 + "." + aAlfa1; fDFecha = aAlfa2;

     aAlfa2 = ("00" + #caestasi#1) % -102;
     aAlfa3 = "31.";
     |SI #caestasi#1 = 4; |O #caestasi#1 = 6;
      |O #caestasi#1 = 9; |O #caestasi#1 = 11;
         aAlfa3 = "30.";
     |FINSI;

     |SI #caestasi#1 = 2;
         aAlfa3 = "28.";
         |SI #caestasi#40 = 2012; |O #caestasi#40 = 2016; |O #caestasi#40 = 2020;
          |O #caestasi#40 = 2024; |O #caestasi#40 = 2028; |O #caestasi#40 = 2032;
             aAlfa3 = "29.";
         |FINSI;
     |FINSI;
     aAlfa2 = aAlfa3 + aAlfa2 + "." + aAlfa1; fHFecha = aAlfa2;

     |HAZ NombreMeses;

     |SI HayAcceso = 1;
         |ABRE #dsam0000;
         |ABRE #dsam0012;
     |FINSI;

     |SI #caestasi#2 ! 0;
         nDEmpresa = #caestasi#2;
         nHEmpresa = #caestasi#3;
         |BUCLE Rellena;
     |SINO;
         |PARA nPara1 = 4; |SI nPara1 [ 23; |HACIENDO nPara1 = nPara1 + 1;
               |SI #caestasi#nPara1# ! 0;
                   nDEmpresa = #caestasi#nPara1#;
                   nHEmpresa = #caestasi#nPara1#;
                   |BUCLE Rellena;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI HayAcceso = 1;
         |CIERRA #dsam0012;
         |CIERRA #dsam0000;
     |FINSI;

     |LEE 000#caw00053.p;
     |SI FSalida ! 0;
         |MENAV "0000Seleccion vacia";
         |ACABA;
     |FINSI;

     |SI #caestasi#118 = "I";
         |HAZ PorImpresora;
     |FINSI;

     |SI #caestasi#118 = "C";
         |HAZ PorCSV;
     |FINSI;
|FPRC;

|PROCESO T80;  |TIPO 80;
     aFichero = "caw00053" + Usuario;  |NOME_DAT #caw00053#aFichero#;
     aFichero = "caw00054" + Usuario;  |NOME_DAT #caw00054#aFichero#;
     aFichero = "caw00055" + Usuario;  |NOME_DAT #caw00055#aFichero#;

     |ABRE #caw00053;  |CIERRA #caw00053;  |DELINDEX #caw00053;
     |ABRE #caw00054;  |CIERRA #caw00054;  |DELINDEX #caw00054;
     |ABRE #caw00055;  |CIERRA #caw00055;  |DELINDEX #caw00055;

     |ABRET #caw00053;
     |ABRET #caw00054;
     |ABRET #caw00055;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #caw00053;  |DELINDEX #caw00053;
     |CIERRAT #caw00054;  |DELINDEX #caw00054;
     |CIERRAT #caw00055;  |DELINDEX #caw00055;
|FPRC;
