|FICHEROS;
   cacuiv2c #10;
   cacuiv2l #11;
|FIN;

|VARIABLES;
   &enBase = 0;
   &enCuota = 0;

   fDFecha = @;
   fHFecha = @;
   fFecha  = @;
   nSwLinea = 0;
   nSw      = 0;

   nMargen   = 0;
   nDCalc    = 0;
   nHCalc    = 0;
   nDCalcREC = 0;
   nHCalcREC = 0;

   nPorcIva  = 0;
   nPorcRec  = 0;

   aAlfa1    = "";
   aAlfa2    = "";

   nCalc     = 0;
   nCalc1    = 0;
   nCalc2    = 0;
   nSwEncontrado = 0; nInc = 0;
|FIN;

|INCLUYE dscont_i;

|PROCESO SacaIVA;
   nSwLinea = 0;

   |ABRE #cacuiv2c;
   |ABRE #cacuiv2l;
   #cacuiv2c#20 = enEjercicio;
   #cacuiv2c#0  = aTipoIVA; aTipoIVA = #cacuiv2c#0;
   #cacuiv2c#21 = "01.01.0000";
   |LEE 000#cacuiv2c.];
   |PARA; |SI FSalida = 0; |Y #cacuiv2c#20 = enEjercicio; |Y #cacuiv2c#0 = aTipoIVA; |HACIENDO;
      |SI efFechaIVA ] #cacuiv2c#21;
         eaDesgIVA = #cacuiv2c#2;
         |SI eaDesgIVA = "N";
            eaCtaIVA = #cacuiv2c#6;
            eaCtaREC = #cacuiv2c#7;
         |FINSI;
         eaDesgDTO = #cacuiv2c#17;
         |SI eaDesgDTO = "N";
            eaCtaDTO = #cacuiv2c#18;
         |FINSI;

         #cacuiv2l#0  = #cacuiv2c#0;
         #cacuiv2l#12 = #cacuiv2c#20;
         #cacuiv2l#13 = #cacuiv2c#21;
         #cacuiv2l#1  = enLineaIVA;
         |LEE 000#cacuiv2l.];
         |PARA; |SI FSalida = 0; |Y #cacuiv2l#12 = #cacuiv2c#20; |Y #cacuiv2l#13 = #cacuiv2c#21;
          |Y #cacuiv2l#0 = #cacuiv2c#0; |Y #cacuiv2l#1 = enLineaIVA; |HACIENDO;
            |SI efFechaIVA ] #cacuiv2c#21;
               nSwLinea = 1;
               |SI eaDesgIVA = "S";
                  eaCtaIVA   = #cacuiv2l#3;
                  eaCtaREC   = #cacuiv2l#5;
               |FINSI;
               enPorcIVA  = #cacuiv2l#2;
               enPorcREC  = #cacuiv2l#4;
               |SI eaDesgDTO = "S";
                  eaCtaDTO  = #cacuiv2l#7;
               |FINSI;
               enPorcIRPF = #cacuiv2l#11;
               eaIVADeduc = #cacuiv2l#8;
               eaIVAInver = #cacuiv2l#9;
            |FINSI;

            |LEE 000#cacuiv2l.s;
         |SIGUE;
      |FINSI;
      |LEE 000#cacuiv2c.s;
   |SIGUE;

   |SI nSwLinea = 0; enLineaIVA = -1; |FINSI;
|FPRC;

|PROCESO BuscaTipoIva;
     |SI #cacuiv2l#2 > 1;
          nMargen = 0.05 + (nInc * 0.05);
          |SI enCuotaIVA ! 0; |Y enCuotaIVA < 0.5; |Y enCuotaIVA > -0.5;
               nMargen = 1 + nInc;
          |FINSI;
     |SINO;
           nMargen = 0;
     |FINSI;

     |SI nSw = 0;
          nHCalc = enPorcIVA;
          nDCalc = nHCalc - nMargen;
          nHCalc = nHCalc + nMargen;

          |SI #cacuiv2l#4 > 1;
               nMargen = 0.05 + (nInc * 0.05);
          |SINO;
               nMargen = 0;
          |FINSI;

          |SI enPorcREC ] 0;
               nDCalcREC = enPorcREC - nMargen;
               nHCalcREC = enPorcREC + nMargen;
          |SINO;
               nDCalcREC = 0; nHCalcREC = 0;
          |FINSI;
     |SINO;
          nDCalc = nPorcIva;
          nHCalc = nPorcIva;
          nDCalcREC = nPorcRec;
          nHCalcREC = nPorcRec;
     |FINSI;

     |SI #cacuiv2l#2 ] nDCalc; |Y #cacuiv2l#2 [ nHCalc;
               |Y #cacuiv2l#4 ] nDCalcREC; |Y #cacuiv2l#4 [ nHCalcREC;

          nSwEncontrado = 1;

          fFecha  = #cacuiv2l#13;
          |SI #cacuiv2l#2 ! enPorcIVA;
               enPorcIVA = #cacuiv2l#2;
          |FINSI;
          |SI #cacuiv2l#4 ! enPorcREC;
               enPorcREC = #cacuiv2l#4;
          |FINSI;

          enLineaIVA = #cacuiv2l#1;
          nSw = 1;
          eaIVADeduc = #cacuiv2l#8; eaIVAInver = #cacuiv2l#9;
          |SI eaCtaIVA = "";
               eaCtaIVA = #cacuiv2l#3; |QBF eaCtaIVA;
          |FINSI;
          |SI eaCtaREC = "";
               eaCtaREC = #cacuiv2l#5; |QBF eaCtaREC;
          |FINSI;
          |SI eaCtaDTO = "";
               eaCtaDTO = #cacuiv2l#7;
               |QBF eaCtaDTO;
          |FINSI;

          aAlfa1 = #cacuiv2l#3; |QBF aAlfa1;
          aAlfa2 = #cacuiv2l#5; |QBF aAlfa2;
          |SI aAlfa1 = eaCtaIVA; |Y aAlfa2 = eaCtaREC;
              |ERROR10;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTipoIva;
 #cacuiv2l#1;
 ;
 aTipoIVA, enEjercicio, fDFecha,      01;
 aTipoIVA, enEjercicio, efFechaIVA  , 99;
 ;
 NULL,BuscaTipoIva;
|FIN;

|PROCESO BuscaTipoIVA;

   fDFecha = "01.01.0000";
   |SI efFechaIVA > "01.01.0000";
       |ABRE #cacuiv2c;
       #cacuiv2c#20 = enEjercicio;
       #cacuiv2c#0  = aTipoIVA;
       #cacuiv2c#21 = "01.01.0000";
       |LEE 000#cacuiv2c.];
       |PARA; |SI FSalida = 0; |Y #cacuiv2c#20 = enEjercicio; |Y #cacuiv2c#0 = aTipoIVA; |HACIENDO;
              |SI efFechaIVA ] #cacuiv2c#21;
                  fDFecha = #cacuiv2c#21;
              |FINSI;
              |LEE 000#cacuiv2c.s;
       |SIGUE;
       |CIERRA #cacuiv2c;
   |FINSI;

   |QBF eaCtaIVA; |QBF eaCtaREC; |QBF eaCtaDTO;
   nPorcIva = enPorcIVA; nPorcRec = enPorcREC;
   nSw = 0; fFecha = "01.01.0000"; enLineaIVA = 0;
   nSwEncontrado = 0; nInc = 0;
   |PARA; |SI nSwEncontrado = 0; |Y nInc [ 5; |HACIENDO;
        |BUCLE BuscaTipoIva;
        nInc = nInc + 1;
   |SIGUE;


   |ABRE #cacuiv2c;
   #cacuiv2c#20 = enEjercicio;
   #cacuiv2c#0  = aTipoIVA;
   #cacuiv2c#21 = fFecha;
   |LEE 000#cacuiv2c.=;
   |SI FSalida = 0;
      eaDesgIVA = #cacuiv2c#2;
      |SI eaDesgIVA = "N";
         eaCtaIVA = #cacuiv2c#6;
         eaCtaREC = #cacuiv2c#7;
      |FINSI;
      eaDesgDTO = #cacuiv2c#17;
      |SI eaDesgDTO = "N";
         eaCtaDTO = #cacuiv2c#18;
      |FINSI;
   |FINSI;
   |CIERRA #cacuiv2c;
|FPRC;

|RUTINA inf2;
   #cacuiv2l#12 = enEjercicio;
   #cacuiv2l#13 = fDFecha;
   #cacuiv2l#0 = aTipoIVA;
   #cacuiv2l#1 = 01;
|FRUT;

|RUTINA sup2;
   #cacuiv2l#12 = enEjercicio;
   #cacuiv2l#13 = fHFecha;
   #cacuiv2l#0 = aTipoIVA;
   #cacuiv2l#1 = 99;
|FRUT;

|PROCESO SelecTipoIVA;
   fFecha = "01.01.0000";
   |ABRE #cacuiv2l; |ABRE #cacuiv2c;
   #cacuiv2c#0  = aTipoIVA;
   #cacuiv2c#20 = enEjercicio;
   #cacuiv2c#21 = "01.01.0000";
   |LEE 000#cacuiv2c.];
   |PARA; |SI FSalida = 0; |Y #cacuiv2c#20 = enEjercicio; |Y #cacuiv2c#0 = aTipoIVA; |HACIENDO;
      |SI efFechaIVA ] #cacuiv2c#21; fFecha = #cacuiv2c#21; |FINSI;
      |LEE 000#cacuiv2c.s;
   |SIGUE;
   |SI fFecha = "01.01.0000"; enLineaIVA = -1; |ACABA; |FINSI;
   fDFecha = fFecha;
   fHFecha = fFecha;
   |SI enIvaTot = 1; fDFecha = "01.01.2000"; fHFecha = "31.12.2999"; |FINSI;

   |CONSULTA_F_CLAVE #1#cacuiv2l,inf2,sup2;

   |SI enIvaTot = 1; efFechaIVA = fFecha; |FINSI;
   enLineaIVA = #cacuiv2l#1;
   eaIVADeduc = #cacuiv2l#8;
   eaIVAInver = #cacuiv2l#9;
   eaDesgCTP  = #cacuiv2c#4;
   eaDesgIVA  = #cacuiv2c#2;
   |SI eaDesgIVA = "N";
      eaCtaIVA = #cacuiv2c#6;
      eaCtaREC = #cacuiv2c#7;
   |SINO;
      eaCtaIVA = #cacuiv2l#3;
      eaCtaREC = #cacuiv2l#5;
   |FINSI;
   enPorcIVA  = #cacuiv2l#2;
   enPorcREC  = #cacuiv2l#4;
   eaDesgDTO = #cacuiv2c#17;
   |SI eaDesgDTO = "N";
      eaCtaDTO = #cacuiv2c#18;
   |SINO;
      eaCtaDTO = #cacuiv2l#7;
   |FINSI;
   enPorcIRPF = #cacuiv2l#11;

   |CIERRA #cacuiv2c; |CIERRA #cacuiv2l;
|FPRC;

|PROCESO BuscaCtaIva;
   nSwLinea = 0;
   |SI eaCtaIVA ! "            ";
      |SI #cacuiv2l#3 = eaCtaIVA; nSwLinea = 1; |SINO; nSwLinea = 0; |FINSI;
   |FINSI;
   |SI eaCtaREC ! "            ";
      |SI #cacuiv2l#5 = eaCtaREC; nSwLinea = 1; |SINO; nSwLinea = 0; |FINSI;
   |FINSI;
   |SI eaCtaREC ! "            ";
      |SI #cacuiv2l#7 = eaCtaDTO; nSwLinea = 1; |SINO; nSwLinea = 0; |FINSI;
   |FINSI;

   |SI nSwLinea = 1;
      enLineaIVA = #cacuiv2l#1;
      enPorcIVA  = #cacuiv2l#2;
      enPorcREC  = #cacuiv2l#4;
      |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaCtaIva;
 #cacuiv2l#1;
 ;
 aTipoIVA, enEjercicio, "01.01.0000", 01;
 aTipoIVA, enEjercicio, efFechaIVA  , 99;
 ;
 NULL,BuscaCtaIva;
|FIN;

|PROCESO BuscaCtaIVA;
   |QBF eaCtaIVA; |QBF eaCtaREC; |QBF eaCtaDTO;
   #cacuiv2l#3 = eaCtaIVA; eaCtaIVA = #cacuiv2l#3;
   #cacuiv2l#5 = eaCtaREC; eaCtaREC = #cacuiv2l#3;
   #cacuiv2l#7 = eaCtaDTO; eaCtaDTO = #cacuiv2l#7;
   enLineaIVA = 0; |BUCLE BuscaCtaIva;
   |SI enLineaIVA = 0;
      enPorcIVA = 0; enPorcREC = 0;
   |FINSI;
|FPRC;

|PROCESO BucleRecargos;
   nCalc = (enBase % #cacuiv2l#4) ! 2;
   |SI nCalc = enCuota; enPorcREC = #cacuiv2l#4; |FINSI;
/*
   |SI #cacuiv2l#4 ] nCalc1; |Y #cacuiv2l#4 [ nCalc2;
      |SI enPorcREC ! #cacuiv2l#4; enPorcREC = #cacuiv2l#4; |FINSI;
   |FINSI;
*/
|FPRC;

|DEFBUCLE BucleRecargos;
 #cacuiv2l#1;
 ;
 aTipoIVA, enEjercicio, fDFecha,      01;
 aTipoIVA, enEjercicio, efFechaIVA  , 99;
 ;
 NULL,BucleRecargos;
|FIN;

|PROCESO CompruebaRecargos;
   fDFecha = "01.01.0000";
   |SI efFechaIVA > "01.01.0000";
       |ABRE #cacuiv2c;
       #cacuiv2c#20 = enEjercicio;
       #cacuiv2c#0  = aTipoIVA;
       #cacuiv2c#21 = "01.01.0000";
       |LEE 000#cacuiv2c.];
       |PARA; |SI FSalida = 0; |Y #cacuiv2c#20 = enEjercicio; |Y #cacuiv2c#0 = aTipoIVA; |HACIENDO;
              |SI efFechaIVA ] #cacuiv2c#21;
                  fDFecha = #cacuiv2c#21;
              |FINSI;
              |LEE 000#cacuiv2c.s;
       |SIGUE;
       |CIERRA #cacuiv2c;
   |FINSI;

   nCalc1 = enPorcREC - 0.02; nCalc2 = enPorcREC + 0.02;
   |SI enPorcREC < 1;
      nCalc1 = enPorcREC - 0.45; nCalc2 = enPorcREC + 0.45;
      |SI nCalc1 < 0; |Y enPorcREC ! 0; nCalc1 = 0.05; |FINSI;
   |FINSI;
   |BUCLE BucleRecargos;
|FPRC;
