|FICHEROS;
    pacontam #0;

    camaasic #2;    || apuntes cabs.
    camaasil #3;    || apuntes lins.
    cacuenta #4;    || plan contable

    camandia #10;

    cacuebal #15;   || cuentas de balance
    caclipro #16;   || clientes/proveedores

    pacontmp #17;   || Temporal Libros Iva.

    camaniva #18;   || IVA Cabeceras
    caivalin #19;   || Iva Lineas
    calibros #20;   || Libros IVA.
    caivases #21;   || Series IVA
    caivaasi #200;  || Control

    :/modelos/def/dsmom030 #330;        || conceptos
    ca8m0002 #422;
    ca8cumay #410;
|FIN;

|VARIABLES;
    &eaOrigen  = "";
    &eaDestino = "";
    &enErrPas  = 0;
    nCopio   = 0;
    aFichero = "";
    aTipo    = "";
    conte    = "";
    aTIva    = "";
    nNumDoc  = 0;
    nLinBase = 0;
    nEstLin  = 0;

    nDocumto = 0;
    nSw      = 0;

    esAbono = "";
    fiche = "";
    handle = 0;
    varalfa = "";
    varalfa2 = "";
    varalfa3 = "";
    varalfa4 = "";
    varalfa5 = "";
    varalfa6 = "";
    varalfa7 = "";
    varalfa8 = "";

    trabajo = "";
    trabaj1 = "";
    traba   = "";
    alfa1   = "";
    alfa2   = "";
    alfa3   = "";
    alfa4   = "";
    alfa5   = "";
    nume1   = 0;
    nume2   = 0;
    nume3   = 0;
    nume4   = 0;
    nume5   = 0;

    sw      = 0;
    nCalc   = 0;
    nCalcD  = 0;
    nCalcH  = 0;
    nNume1  = 0;
    nNume2  = 0;
    nNume5  = 0;
    nSwBarra = 0;
    ult_apunt = 0;
    docum   = 0;
    documN  = 0;
    nRegi   = 0;
    FEstado = 0;
    para1   = 0;
    para2   = 0;
    para3   = 0;
    para4   = 0;

    nada    = "";
    fichero = "";
    top     = 0;
    resto   = 0;
    fecha   = @;
    descr   = "";
    signe   = "";
    impor   = 0;
    impoi   = 0;
    iva     = 0;
    rec     = 0;
    cotra   = "";
    queiv   = "";
    ivcon   = "";
    sumar   = 0;
    nConta  = 0;
    nPepe1  = 0;
    nPepe2  = 0;
    nPepe3  = 0;
    nPepe4  = 0;
    nPepe5  = 0;
    aCual   = "";
    trim1   = "";
    trim2   = "";
    trim3   = "";
    swVic   = 0;
    nGrup   = 0;
    qConta  = 0;
    nIs1    = 0;
    nIs2    = 0;
    nIs3    = 0;
    nIs4    = 0;
    nIs5    = 0;
    nIr1    = 0;
    nIr2    = 0;
    nIr3    = 0;
    nIr4    = 0;
    nIr5    = 0;
    nSwMalo   = 0;
    nDocumAnt = 0;

     nLeeUno = 0;
     nLeeCuantos = 0;
     nLeeNume = 0;
     aLeeAlfa = "";
     aLeeTodo = "";
     nLeeSalida = 0;

     nNuevo = 0;
     aContra = "";
     nCtrCon = 0;
     nDocu   = 0;
     nD      = 0;
     sw1     = 0;

     Ulqueiv = "";
     Ulcotra = "";
     impob   = 0;
     impoiva = 0;
     nAqui   = 0;
     aAnAbono = "";
     Uliva   = 0;
     Ulivcon = "";
     Ulrec   = 0;
     nConce  = 0;
     aCtaIva = "";
     aCtaRec = "";
     nCuotaIva = 0;

     &libro = 0;
     &orden = 0;
     &serie = "";
     &pesetas = 0;
     &cuenta = "";
     &digito = 0;
     &emision = "";
     &enAux   = 0;

   aSerie   = "";
   aFactura = "";
   nFactura = 0;
   nEste    = 0;
   nLibro   = 0;
   aS       = "";
   aAntSe   = "";
   nF       = 0;
   nAntFr   = 0;

   nLaLin   = 0;
   nAlgun   = 0;
   nLaBase  = 0;
   nUliva   = 0;
   nUlrec   = 0;
   mascara  = "";
|FIN;

|INCLUYE dscont_i;
|INCLUYE defect_i;

____________________________________/ CALCULOS DESDE PANTALLA
|CALCULO Alprincio; |TIPO 8;
   |HAZ inicio;
   |ABRE #200;
   |DDEFECTO #200;
   |LEE 000#200p;
   |CIERRA #200;
   eaPaCTA1 = #caivaasi#135;  ||permitir alta no estructuras 2008
   eaPaCTA2 = #caivaasi#136;  ||Aviso 1990
   eaPaNif1 = #caivaasi#152;
   eaPaNif2 = #caivaasi#153;
   eaABanco = #caivaasi#161;
   eaObClPr = #caivaasi#186;
   |SI eaPaCTA2 = "N"; nMensa9 = 1; |FINSI;
|FCAL;

|CALCULO ElDefecto; |TIPO 7;
 #0#7 = #200#3;   |PINTA #0#7;
 #0#8 = #200#29;  |PINTA #0#8;

 #0#11 = #200#5;  |PINTA #0#11;
 #0#12 = #200#31; |PINTA #0#12;
|FCAL;

|CALCULO libros; |TIPO 0;
     |SI #0#6 = "N";
          |C_M #0#7 , 1 , "N";
          |C_M #0#8 , 1 , "N";
          |C_M #0#11 , 1 , "N";
          |C_M #0#12 , 1 , "N";
          |C_M #0#13 , 1 , "N";
          |C_M #0#14 , 1 , "N";
     |SINO;
          |C_M #0#7 , 1 , "S";
          |C_M #0#8 , 1 , "S";
          |C_M #0#11 , 1 , "S";
          |C_M #0#12 , 1 , "S";
          |C_M #0#13 , 1 , "S";
          |C_M #0#14 , 1 , "S";
     |FINSI;

     |SI #0#5 = 9;
         #0#13 = "S";
     |SINO;
         #0#13 = "N";
     |FINSI;

     |PINTA #0#13;
|FCAL;

|| /////////////////////////////////////////////////////////////////////
|| /////////////////////////////////////////////////////////////////////

|PROCESO nombre;  || nombre del fichero
    Pos   = -1;
    alfa1 = #0#1;
    |QBF alfa1;

    fichero = "x" + fichero;
    alfa1 = alfa1 + fichero;
    |QBF alfa1;
    alfa1 = alfa1 + ".txt";
    aFichero = fichero + ".txt";
    fiche = alfa1;

    nCopio = 0;
    |XABRE "UB", fiche, handle;
    |SI FSalida < 0;
        |XABRE "CUB", fiche, handle;
        |SI FSalida = 0; nCopio = 1; |FINSI;
    |FINSI;
    |XCIERRA handle;

|SI nCopio = 1;
    |DFICE aBase;
    eaOrigen  = fiche;
    eaDestino = aBase + aFichero;
    |HAZ eReciboFich;
    |SI enErrPas = 0; fiche = eaDestino; |FINSI;
|FINSI;
|FPRC;

|| //////////////////////////////////////////////////////////////////

|PROCESO IvaRepSop;

     |DDEFECTO #18;

     #18#0  = qConta;
     #18#1  = nNumDoc;
     |LEE 001#18=;
     FEstado = FSalida;

     alfa2 = #18#12; |QBF alfa2;
     |SI alfa2 = "";
         #18#2 = aSerie; || Serie.
         #18#3 = nConta; || Orden.
         #18#4 = #17#7;  || Fecha

         alfa1 = #17#7; alfa1 = alfa1 % 0402; nume1 = alfa1;
         #18#5 = nume1;
         |SI #200#46 = "T"; |Y enEjercicio [ 2009;
             #18#5 = 1;
             |SI nume1 > 3; #18#5 = 2; |FINSI;
             |SI nume1 > 6; #18#5 = 3; |FINSI;
             |SI nume1 > 9; #18#5 = 4; |FINSI;
         |FINSI;

         #18#7 = 1;               || diario
         #18#8 = #17#7;           || fecha
         #18#9 = #17#1;           || Documento

         #18#12 = #17#3;          || Cuenta
         #16#23 = aTipo;
         #16#10 = #18#12;
         |LEE 000#16=;
         |SI FSalida = 0;
             #18#13 = #16#1;
             #18#14 = #16#9;
         |FINSI;

         |SI aTIva = "R";
             #18#27 = #200#5;
             #18#29 = #200#13;
         |SINO;
             #18#27 = #200#31;
             #18#29 = #200#57;
         |FINSI;
         #18#27  = nConce;
         #18#28  = #17#6;  || Descrip. Concepto
         #18#29  = nConce;
         #18#30  = #17#6;  || Descrip. Concepto

         #18#36  = aTIva;
    |FINSI;
    alfa1 = #17#3; |QBF alfa1;
    |SI alfa1 = "";
         nAlgun = 1;
         nLaLin = nLinBase + 1;
         nLaBase = #17#13;
    |FINSI;
    nLinBase = nLinBase + 1;
    |DDEFECTO #19;
    #19#0 = #18#0;
    #19#1 = #18#1;
    #19#2 = nLinBase;
    |LEE 001#19=;
    nEstLin = FSalida;

    #19#0 = #18#0;
    #19#1 = #18#1;
    #19#2 = nLinBase;
    #19#3 = #18#27;
    #19#4 = #18#28;

    #19#6 = #17#13;  ||base
    #19#7 = #17#5;  ||% iva
    #19#9 = #17#8;  ||% rec

    #19#8  = ((#19#6  * #19#7) /100) ! EURODB;  ||Cuota Iva
    #19#10 = ((#19#6  * #19#9) /100) ! EURODB;  ||Cuota Rec

    |SI #17#9 = "S";
        nCalc = -1;
    |SINO;
       nCalc = 1;
    |FINSI;

    |SI #17#9 = "S";
       |SI #19#06 > 0; #19#06 = #19#06 * -1; |FINSI;
       |SI #19#08 > 0; #19#08 = #19#08 * -1; |FINSI;
       |SI #19#10 > 0; #19#10 = #19#10 * -1; |FINSI;
    |FINSI;

    efFechaIVA = #camaniva#4; enLineaIVA = 0;
    enPorcIVA = #caivalin#7; enPorcREC = #caivalin#9;
    eaCtaIVA = #caivalin#13; eaCtaREC = #caivalin#14;
    |HAZ BuscaTipoIVA;
    #19#16 = enLineaIVA;

    alfa1 = #17#10; |QBF alfa1;
    |SI alfa1 ! ""; #19#12 = alfa1; |FINSI;
    alfa1 = #17#11; |QBF alfa1;
    |SI alfa1 ! ""; #19#13 = alfa1; |FINSI;
    alfa1 = #17#12; |QBF alfa1;
    |SI alfa1 ! ""; #19#14 = alfa1; |FINSI;

    #18#19 = #18#19 + #19#6;
    #18#15 = #18#15 + #19#6;
    #18#17 = #18#15 % #18#16;
    #18#20 = #18#20 + #19#22;
    || #18#23 = #18#23 + (#19#8 + #19#10);
    nCuotaIva = (nCuotaIva + (#19#8 + #19#10) ) ! EURODB;
    #18#23 = #18#23 + #17#14;
    #18#26 = #18#26 + #19#11;
    #18#21 = #18#19 + #18#23 - #18#26 - #18#20;

    |SI FEstado = 0; |GRABA 020#18a; |FINSI;
    |SI FEstado ! 0; |GRABA 020#18b; |FINSI;
    |LIBERA #18;

    |SI nEstLin = 0; |GRABA 020#19a; |FINSI;
    |SI nEstLin ! 0; |GRABA 020#19b; |FINSI;
    |LIBERA #19;

    nUliva = #19#7;
    nUlrec = #19#9;
|FPRC;

|PROCESO pacontmp;

     |SI swVic = 0;
          swVic = 1;
          nGrup = #17#1;
          aCual = #17#0;
          |SI #17#0 = "472";
               aTIva = "S"; aTipo = "P";
               qConta = #0#8;
               nConce = #0#12;
               |HAZ LeeConta;
          |FINSI;
          |SI #17#0 = "477";
               aTIva = "R"; aTipo = "C";
               qConta = #0#7;
               nConce = #0#11;
               |HAZ LeeConta;
          |FINSI;
     |FINSI;
     |SI nGrup ! #17#1; |O aCual ! #17#0;
          |HAZ ElAnterior;
          nGrup = #17#1;
          aCual = #17#0;
          |SI #17#0 = "472";
               aTIva = "S"; aTipo = "P";
               qConta = #0#8;
               nConce = #0#12;
               |HAZ LeeConta;
          |FINSI;
          |SI #17#0 = "477";
               aTIva = "R"; aTipo = "C";
               qConta = #0#7;
               nConce = #0#11;
               |HAZ LeeConta;
          |FINSI;
     |FINSI;

     |HAZ IvaRepSop;

     |SI #0#13 = "S";

         nDocumto = #pacontmp#1; nSw = 0;
         |SALVA_FICHA #pacontmp;
         |LEE 000#pacontmp.s;
         |SI FSalida ! 0; |O nDocumto ! #pacontmp#1; nSw = 1; |FINSI;
         |REPON_FICHA #pacontmp;
         |SI nSw = 1;
            libro   = #camaniva#0;
            serie   = #camaniva#2;
            orden   = #camaniva#3;
            emision = #camaniva#4;
            pesetas = #camaniva#21;
            cuenta  = #camaniva#12;
            enAux   = 2;

            eaCuenta = #camaniva#12; |HAZ SacaNivel;
            digito   = enNivel;

            |SUB_EJECUTA "calincob";
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE pacontmp;
     #17#1;
     ;
     "   ",000001,1;
     "zzz",999999,9999;
     ;
     NULL,pacontmp;
|FIN;


|PROCESO GrabaIva;
   |SI sw1 = 1; |Y nCtrCon = 1;  || Por si se escapa el ultimo
       queiv  = Ulqueiv;
       cotra  = Ulcotra;
       nD     = docum;
       docum  = nDocu;
       impoi  = impob;      ||Importe.
       iva    = Uliva;
       rec    = Ulrec;
       ivcon  = Ulivcon;
       impoiva = 0;
       nAqui = 1;
       |ABRE #17;
       |HAZ RegIva;
       |CIERRA #17;
       nAqui = 0;
    |FINSI;

     swVic = 0;
     nAlgun = 0;
     |ABRE #16;
     |ABRE #18;
     |ABRE #19;
     |ABRE #20;
     |BUCLE pacontmp;
     |HAZ ElAnterior;

     |CIERRA #16;
     |CIERRA #18;
     |CIERRA #19;
     |CIERRA #20;
|FPRC;

|PROCESO LasLineas;
 alfa1 = #3#4;
 alfa1 = alfa1 % 103;

 #3#6  = #18#27;
 #3#12 = #18#36;
 #3#13 = #18#0;
 #3#14 = #18#3;
 #3#15 = #18#2;

 #3#19 = "F";
 alfa1 = #3#4;alfa1 = alfa1 % 103;
 |SI alfa1 = "477"; |O alfa1 = "472";
     #3#19 = "I";
     nNume2 = nNume2 + 1
     #3#20 = nNume2;
     |SI nLinBase > 1; |Y #3#9 = #18#23;
         #3#20 = 0;
     |FINSI;
 |FINSI;
 alfa1 = #3#4;alfa1 = alfa1 % 101;
 |SI alfa1 = "6"; |O alfa1 = "7";
     #3#19 = "B";
     nNume1 = nNume1 + 1;
     #3#20 = nNume1;
 |FINSI;

 |GRABA 020#3a;
 |LIBERA #3;
|FPRC;

|DEFBUCLE LasLineas;
 #3#1;
 ;
 #2#0, #2#1, #2#2, 0001;
 #2#0, #2#1, #2#2, 9999;
 be;
 NULL, LasLineas;
|FIN;

|PROCESO ElAnterior;

 |SI #18#23 ! nCuotaIva;
     nNume1 = (#18#23 - nCuotaIva) ! EURODB;
     |SI nAlgun ! 0;
         nNume2 = (nLaBase % nUliva) ! EURODB;
         |SI nNume1   = nNume2;
             nLinBase = nLaLin;
         |FINSI;
     |FINSI;
     #19#0 = #18#0;
     #19#1 = #18#1;
     #19#2 = nLinBase;
     |LEE 141#19=;
     |SI FSalida = 0;
         |SI nAlgun = 1; |Y #19#7 = 0;
             efFechaIVA = #camaniva#4; enLineaIVA = 0;
             enPorcIVA = #caivalin#7; enPorcREC = #caivalin#9;
             eaCtaIVA = #caivalin#13; eaCtaREC = #caivalin#14;
             |HAZ BuscaTipoIVA;
             alfa1 = #19#13; |QBF alfa1;
             |SI alfa1 = ""; #19#13 = enLineaIVA; |FINSI;
         |FINSI;
         #19#8 = #19#8 + nNume1;
         |SI #19#8 = 0;
             #19#7 = 0;
         |FINSI;
         |GRABA 020#19a;
     |FINSI;
     |LIBERA #19;
 |FINSI;

 |ABRE #2;
 #2#0 = #18#7;
 #2#1 = #18#8;
 #2#2 = #18#9;
 |LEE 001#2=;
 |SI FSalida = 0;
     |SI #18#36 = "R"; #2#13 = 1; |FINSI;
     |SI #18#36 = "S"; #2#13 = 2; |FINSI;
     |GRABA 020#2a;
     nNume1 = 0;
     nNume2 = 0;
     |BUCLE LasLineas;
 |FINSI;
 |CIERRA #2;
 nLaLin   = 0;
 nAlgun   = 0;
 nLaBase  = 0;
|FPRC;

|PROCESO LeeConta;

     #18#0 = qConta;
     #18#1 = 9999999999;
     |LEE 010#18];
     |SI FSalida = 0;
         |LEE 040#18a;
     |SINO;
         |LEE 040#18u;
     |FINSI;

     nNumDoc = 1;
     |SI FSalida = 0; |Y #18#0 = qConta;
         nNumDoc = #18#1 + 1;
     |FINSI;

     aSerie = #17#15;
     |SI #200#44 = "N";
         |ABRE #20;
         #20#0 = qConta;
         |LEE 110#20=;
         |SI FSalida = 0;
              |SI #0#14 = "S"; |O #17#16 = 0;
                  nConta = #20#4;
              |SINO;
                  nConta = #17#16;
              |FINSI;
              |SI nConta ] #20#4;
                  #20#4 = nConta + #20#3;
              |FINSI;
              |GRABA 020#20a;
              |LIBERA #20;
          |FINSI;
          |CIERRA #20;
      |SINO;
          |ABRE #21;
          #21#0 = aSerie;
          #21#1 = aTIva;
          |LEE 110#21=;
          |SI FSalida ! 0;
              |DDEFECTO #21;
               #21#0 = aSerie;
               #21#1 = aTIva;
               |GRABA 020#21b;
          |FINSI;
          |SI #0#14 = "S"; |O #17#16 = 0;
               nConta= #21#3;
          |SINO;
               nConta= #17#16;
          |FINSI;
          |SI nConta ] #21#3;
              #21#3 = nConta + #21#4;
          |FINSI;
          |GRABA 020#21a;
          |LIBERA #21;
          |CIERRA #21;
       |FINSI;

     |DDEFECTO #18;
     #18#0 = qConta;
     #18#1 = nNumDoc;
     #18#2 = aSerie;
     #18#3 = nConta;
     |GRABA 020#18b;
     nLinBase  = 0;
     nCuotaIva = 0;
|FPRC;

|PROCESO RegIva;

  |SI queiv [ "   "; |ACABA; |FINSI;
  esAbono = "N";
  nEste = 0;
  #17#0 = queiv;
  #17#1 = docum;      ||N§Documento.
  #17#2 = 1;
  |LEE 000#17];
  |PARA; |SI FSalida = 0; |Y #17#0 = queiv; |Y #17#1 = docum; |HACIENDO;
         |SI #17#10 [ "            "; nEste = #17#2; |FINSI;
         |SI #17#9 = "S"; esAbono = "S"; |FINSI;
         |LEE 000#17s;
  |SIGUE;

  |SI nEste ! 0;
      #17#0 = queiv;
      #17#1 = docum;
      #17#2 = nEste;
      |LEE 001#17=;
  |SINO;
      |DDEFECTO #17;
      sumar = sumar + 1;
      #17#0 = queiv;      ||Que Iva 477 Repercutido 472 Soportado.
      #17#1 = docum;      ||N§Documento.
      #17#2 = sumar;      ||Sumador Registros.
  |FINSI;

  #17#3 = cotra;      ||Cuenta.
  #17#4 = #17#4 + impoi;  ||Importe.
  #17#5 = iva;        ||Porcentaje Iva.
  #17#6 = ivcon;      ||Concepto.
  #17#7 = fecha;      ||Fecha.
  #17#8 = rec;        ||Porcentaje Rec.

  |SI esAbono = "N";
     |SI #17#0 = "477";
         alfa1 = varalfa % 3916;  nCalc = alfa1;
         |SI nCalc = 0;
             #17#9 = "N";        || Abono S/N
        |SINO;
             #17#9 = "S";        || Abono S/N
        |FINSI;
     |FINSI;

     |SI #17#0 = "472";
         alfa1 = varalfa % 8016;  nCalc = alfa1;
         |SI nCalc = 0;
             #17#9 = "N";        || Abono S/N
         |SINO;
             #17#9 = "S";        || Abono S/N
         |FINSI;
     |FINSI;
     |SI nAqui = 1;
         #17#9 = aAnAbono;
     |FINSI;
  |SINO;
      #17#9 = "S";
  |FINSI;

  #17#10 = aContra;
  #17#13 = impob;
  |SI nEste = 0;
      #17#14 = impoiva;
      #17#11 = aCtaIva;
      #17#12 = aCtaRec;
      #17#15 = aSerie;
      #17#16 = nFactura;
  |FINSI;
  nCtrCon = 0;

  Ulqueiv  = queiv;      ||El ultimo
  Ulcotra  = cotra;      ||Cuenta.
  Uliva    = iva;        ||Porcentaje Iva.
  Ulivcon  = ivcon;      ||Concepto.
  Ulrec    = rec;        ||Porcentaje Rec.
  aAnAbono = #17#9;

  |SI nEste = 0;
      |GRABA 020#17n;
  |SINO;
      |GRABA 020#17a;
  |FINSI;
  |LIBERA #17;
|FPRC;


|PROCESO GraboBaseIva;
       nD      = docum;
       docum   = nDocu;
       nAqui   = 1;
       impoiva = 0;
       |SI Ulqueiv = "";
           alfa1 = aContra % 101;
           queiv = "477"; |SI alfa1 = "6"; queiv = "472"; |FINSI;
       |SINO;
           queiv    = Ulqueiv;
           cotra    = Ulcotra;
           iva      = Uliva;
           rec      = Ulrec;
           ivcon    = Ulivcon;
       |FINSI;
       |HAZ RegIva;
       nAqui = 0;
       docum = nD;
       nDocu = docum;
|FPRC;

|| ..................................................................
|PROCESO BorrarVar;
       nCtrCon   = 0;
       aContra   = "";
       Ulqueiv   = "";
       Ulcotra   = "";
       Uliva     = 0;
       Ulivcon   = "";
       Ulrec     = 0;
       aAnAbono  = "N";
       aCtaIva   = "";
       aCtaRec   = "";
       cotra     = "";
       iva       = 0;
       rec       = 0;
       queiv     = "";
       impob     = 0;
       impoiva   = 0;
       aCtaIva   = "";
       aCtaRec   = "";;
|FPRC;

|PROCESO ultimo;

   |SI sw1 = 0
       nDocu     = docum;
       sw1       = 1;
       |HAZ BorrarVar;
   |FINSI;

   |SI nDocu ! docum; |Y nCtrCon = 1;
       aS = aSerie;   aSerie   = aAntSe;
       nF = nFactura; nFactura = nAntFr;
       |HAZ GraboBaseIva;
       aSerie   = aS;
       nFactura = nF;
       |HAZ BorrarVar;
   |FINSI;

    #3#3 = 9999;
    |LEE 000#3];
    |SI FSalida = 0;
        |LEE 000#3a;
    |SINO;
        |LEE 000#3u;
    |FINSI;
    |SI FSalida = 0;|Y #3#0 = 1;|Y #3#1 = fecha;|Y #3#2 = docum;
        ult_apunt = #3#3 + 2;
    |SINO;
        ult_apunt = 1;
        |HAZ BorrarVar;
    |FINSI;

    |DDEFECTO #3;
    #3#0 = 1;
    #3#1 = fecha;
    #3#2 = docum;
    nDocu = docum;
|FPRC;

|PROCESO cabecera;

    |DDEFECTO #2;
    #2#0 = #3#0;
    #2#1 = #3#1;
    #2#2 = #3#2;
    |LEE 101#2=;
    FEstado = FSalida;
    #2#0 = #3#0;         || diario
    #2#1 = #3#1;         || fecha
    #2#2 = #3#2;         || documento
    #2#3 = #2#2;         || asiento
    |SI #3#8 = "D";
        #2#4 = #2#4 + #3#9;
        |SI #2#09 = 0; #2#08 = #3#4; #2#09 = #3#5; |FINSI;      || contrp.HABER
    |FINSI;
    |SI #3#8 = "H";
        #2#5 = #2#5 + #3#9;
       |SI #2#11 = 0; #2#10 = #3#4; #2#11 = #3#5; |FINSI;      || contrp.DEBE
    |FINSI;
    #2#6 = #2#4 - #2#5;
    #2#12 = #3#24;
    |SI FEstado = 0;  |GRABA 020#2a;  |FINSI;
    |SI FEstado ! 0;  |GRABA 020#2n;  |FINSI;
    |LIBERA #2;
|FPRC;

|PROCESO Actualiza;
     |ATRI I;
     |PINTA 2221, #3#1;
     |PINTA 2234, #3#4;
     |ATRI 0;

     |HAZ cabecera;

      MasMenos     = #3#9;
      DebeHaber    = #3#8;
      aCUENTA      = #3#4;
      nREGISTRO    = #3#24;
      nDIARIO      = #3#0;
      aFECHA       = #3#1;
      nDOCUMENTO   = #3#2;
      nNIVELCUENTA = #3#5;

      |HAZ ActDiario;          || diario
      |HAZ ActCuenta;          || cuenta
      |HAZ ActTesteo;          || cuenta
|FPRC;
||**********************************************************************
||**********************************************************************
|PROCESO MiroFactura;
     aSerie   = "";
     nFactura = 0;

     alfa1 = varalfa % 5525; |QBF alfa1;
     alfa5  = alfa1 % 0; nNume5 = alfa5;
     alfa5 = "";
     nSwBarra = 0;
     |PARA nNume1 = nNume5; |SI nNume1 ] 1; |HACIENDO nNume1 = nNume1 - 1;
           nNume2 = nNume1 * 100 + 1; alfa2  = nNume2;
           alfa3 = alfa1 % alfa2;
           |SI alfa3 = " ";
               |SAL;
           |FINSI;
           alfa5 = alfa3 + alfa5;
    |SIGUE;

    alfa3 = alfa5;
    alfa4 = alfa3 % 101;
    |SI alfa4 = "A";
        alfa3 = alfa3 - alfa4;
    |SINO;
        alfa4 = "";
    |FINSI;

    alfa5  = alfa3 % 0; nNume5 = alfa5;
    alfa5 = "";
    nSwBarra = 0;
    |PARA nNume1 = nNume5; |SI nNume1 ] 1; |HACIENDO nNume1 = nNume1 - 1;
          nNume2 = nNume1 * 100 + 1; alfa2  = nNume2;
          alfa1 = alfa3 % alfa2;
          alfa5 = alfa1 + alfa5;
          |SI alfa1 = "/";
              nSwBarra = 1;
              |SAL;
          |FINSI;
    |SIGUE;
    |SI nSwBarra = 1;
        alfa3 = alfa3 - alfa5;
        alfa5 = alfa5 - "/";
    |FINSI;
    alfa5 = alfa4 + alfa5;

    aSerie   = alfa5;
    nFactura = alfa3;

    |SI nFactura ! 0;

        alfa1 = conte % 101;
        alfa2 = conte % 102;
        alfa3 = conte % 103;

        |SI alfa1 = "7"; nLibro = #0#7; |FINSI;
        |SI alfa1 = "6"; nLibro = #0#8; |FINSI;
        |SI alfa2 = "43"; |O alfa2 = "44";
            nLibro = #0#7;
        |FINSI;
        |SI alfa2 = "40"; |O alfa2 = "41"; |O alfa2 = "52"; |O alfa2 = "17";
            nLibro = #0#8;
        |FINSI;
        |SI alfa3 = "477"; nLibro = #0#7; |FINSI;
        |SI alfa3 = "472"; nLibro = #0#8; |FINSI;

        |ABRE #18;
        |SELECT #3#18;
        #18#0 = nLibro;
        #18#2 = aSerie;
        #18#3 = nFactura;
        |LEE 001#18=;
        |SI FSalida = 0;
            aFactura = nFactura; aFactura = ("000000" + aFactura) % -106;
            alfa1 = "    FACTURA " + aSerie + "/" + aFactura + " EXISTENTE. NO SE IMPORTARA";
            |MENAV alfa1;
            nSwMalo = 1;
        |FINSI;
        |SELECT #1#18;
        |CIERRA #18;
    |FINSI;

|FPRC;

|PROCESO apuntes_9;
     conte = varalfa % 1512;   |QBF conte;

     |SI conte = "";   |ACABA;  |FINSI;

     alfa1  = varalfa % 0106;
     documN = alfa1;

     alfa1 = varalfa % 708;
     alfa1 = (alfa1 % -102) + "." + (alfa1 % 502) + "." + (alfa1 % 104);
     fecha = alfa1;

     |SI nDocumAnt = 0;  |O documN ! nDocumAnt;
         docum   = docum + 1;
         nSwMalo = 0;
         #2#0    = 1;
         #2#1    = fecha;
         #2#2    = docum;
         |LEE 000#2=;
         |SI FSalida = 0;  nSwMalo = 1;  |FINSI;
         |SI #0#14 = "N"; |HAZ MiroFactura; |FINSI;
         nDocumAnt = documN;
     |FINSI;

     |SI nSwMalo = 1;  |ACABA;  |FINSI;

     |DDEFECTO #3;
     #3#00 = 1;          || diario
     #3#01 = fecha;      || fecha
     #3#02 = docum;      || documento

     |HAZ ultimo;
     #3#03 = ult_apunt;  || apunte

     eaCuenta = conte;
     |HAZ nuSacaNivel;

     conte = eaCuenta;
     #3#04 = conte;      || cuenta
     #3#05 = enNivel;    || digito cuenta
     #3#06 = 001;        || concepto
     alfa1 = varalfa % 5525;
     #3#07 = alfa1;      || descripcion

     alfa1 = (varalfa % 23911) + (varalfa2 % 105);        || DEBE euros
     nume1 = alfa1;
     alfa1 = varalfa2 % 0616;        || HABER euros
     nume2 = alfa1;

     signe = "";
     impor = 0;

     alfa1 = varalfa2 % 2216;   ||Base Imponible en EUROS
     impoi = alfa1;
     |SI impoi ! 0;
         alfa1 = varalfa % 12005; ||% Iva.
         iva   = alfa1;
         alfa1 = varalfa % 12505; ||% Rec.
         rec   = alfa1;
         cotra = varalfa % 2712;  ||Contrapartida.
         queiv = conte % 103;     ||Para Saber que Tipo Iva.
     |FINSI;

     |SI nume1 ! 0; signe = "D";   impor = nume1; |FINSI;
     |SI nume2 ! 0; signe = "H";   impor = nume2; |FINSI;

     #3#08 = signe;      || signo
     #3#09 = impor;      || importe
     |SI #3#08 = "D";
         #3#16 = #3#4;
         #3#17 = #3#5;
     |SINO;
         #3#10 = #3#4;
         #3#11 = #3#5;
     |FINSI;

     #3#12 = "";           || cobros/pagos
     #3#13 = 0;            || libro
     #3#14 = 0;            || orden
     #3#15 = "";           || serie
     #3#22 = 0;            || nro.recibo
     #3#19 = "";           || tipo acumulador
     #3#20 = 0;            || numero acumulador
     #3#21 = "";           || departamento

     alfa1 = #3#4;
     alfa1 = alfa1 % 101;
     |SI alfa1 = "6"; |O alfa1 = "7";
         |SI nCtrCon = 1;
             |HAZ GraboBaseIva;
         |FINSI;
         aContra  = #3#4;
         nCtrCon  = 1;
         impob    = #3#9;
         Ulivcon = ivcon;
     |FINSI;

     ivcon = #3#07;
     alfa1 = #3#4;
     alfa1 = alfa1 % 103;
     |SI alfa1 = "477"; |O alfa1 = "472";
         aCtaIva = #3#4;
         impoiva = #3#9;
     |FINSI;

     |SI impor ! 0;
         |GRABA 020#3n;
         |SI FSalida = 0;
             |HAZ Actualiza;
             |SI impoi ! 0;      || Si base Imponible ! 0; Carga Iva.
                 |HAZ RegIva;
             |FINSI;
         |FINSI;
     |SINO;
         |SI impoi ! 0;      || Si base Imponible ! 0; Carga Iva.
             |HAZ RegIva;
         |FINSI;
     |FINSI;

     aAntSe = aSerie;
     nAntFr = nFactura;
|FPRC;


|PROCESO diario_t09;
    |DELINDEX #17;

    |ABRE #17;
    trabaj1 = #0#2;
    fichero = "diario";
    |HAZ nombre;

    nDocumAnt = 0;
    |XABRE "UB", fiche, handle;
    |SI FSalida < 0;
        |XABRE "CUB", fiche, handle;
    |FINSI;
    |SI FSalida ] 0;
        sw = 0;
        |PARA; |SI sw = 0; |HACIENDO;
               |XLEE handle, 249, varalfa;
               |SI FSalida = 249;
                   |XLEE handle, 50, varalfa2;
                   |SI FSalida = 50;
                       alfa1 = varalfa % 101;
                       |SI alfa1 ! "*";             || registros borrados
                          |HAZ apuntes_9;
                       |FINSI;
                   |SINO;
                       sw = 1;
                   |FINSI;
               |SINO;
                   sw = 1;
               |FINSI;
        |SIGUE;
        |XCIERRA handle;
    |FINSI;
    Pos = -1;
    |CIERRA #17;

|FPRC;

||/////////////////////////////////////////////////////////////////////////////

|| ************************************************************************
|| .... Proceso de la alta de cuentas
|| ************************************************************************

____________________________________/ CALCULOS DEL PASE DE CUENTAS
|PROCESO cli_prov_09;
  #16#0 = #4#0;              || codigo (cuenta)
  #16#1 = #4#2;              || nombre
  #16#9 = varalfa % 5315;    || cif
  #16#2 = varalfa % 6835;    || direccion
  #16#6 = varalfa % 10325;   || poblacion
  #16#5 = varalfa % 12825;   || provincia

  alfa1 = varalfa % 14802;   || cp 1
  #16#3 = alfa1;
  alfa1 = varalfa % 15003;   || cp 2
  #16#4 = alfa1;
  #16#25 = varalfa % 14805;
|FPRC;

|PROCESO Cli_Prov;

   alfa1 = #4#0 % 103;
   |SI alfa1 ! "430";  |Y alfa1 ! "440";  |Y alfa1 ! "400";  |Y alfa1 ! "410";
       |ACABA;
   |FINSI;

   |DDEFECTO #16;
   aTipo = "P";
   |SI alfa1 = "430";|O alfa1 = "440";
       aTipo =  "C";
   |FINSI;
   #16#23 = aTipo;
   #16#10 = #4#0;             || cuenta contable
   #16#11 = #4#1;             || digito
   |LEE 101#16=;
   FEstado = FSalida;

   #16#23 = aTipo;
   #16#10 = #4#0;
   #16#11 = #4#1;

   |HAZ cli_prov_09;

   |SI FEstado ! 0;  |GRABA 020#16n;     |FINSI;
   |SI FEstado = 0;  |GRABA 020#16a;     |FINSI;
   |LIBERA #16;
|FPRC;

|PROCESO cuentas;

    |DDEFECTO #4;
    #4#0     = varalfa % 112;     || cuenta
    eaCuenta = #4#0;
    |HAZ nuSacaNivel;
    #4#0 = eaCuenta;
    |SI enNivel ! 0;

        #4#1 = enNivel;           || digito
        #4#2 = varalfa % 1330;    || Titulo
        |SI #0#5 = 8; |Y #0#10 = 3;
            #4#2 = varalfa % 1340;    || Titulo
        |FINSI;
        |SI #0#5 = 9;
            #4#2 = varalfa % 1340;    || Titulo
        |FINSI;
        #4#3 = "S";               || pase directo

        |ATRI I;
        |PINTA 2221, #4#0;
        |PINTA 2234, #4#2;
        |ATRI 0;

        mascara = #4#0;
        |QBF mascara;
        mascara = mascara +"zzzzzzzzzzzz";
        mascara = mascara % 112;

        #4#54 = mascara;
        #4#55 = #4#1;

        |HAZ defect;

        |GRABA 000#4n;
        |SI FSalida = 0;
            |HAZ Cli_Prov;
        |FINSI;
   |SINO;
        |MENAV "    No corresponden los Niveles; proceso interrumpido ...";
        sw = 1;
   |FINSI;
|FPRC;

|PROCESO subcta_t09;  ||Nuevo
    |ABRET #4;
    |ABRET #16;

    trabaj1 = #0#2;
    fichero = "subcta";
    |HAZ nombre;

    |XABRE "UB", fiche, handle;
    |SI FSalida < 0;
        |XABRE "CUB", fiche, handle;
    |FINSI;
    |SI FSalida ] 0;
        sw = 0;
        |PARA; |SI sw = 0; |HACIENDO;
               |XLEE handle, 163, varalfa;
               |SI FSalida = 163;
                   |HAZ cuentas;
               |SINO;
                   sw = 1;
               |FINSI;
        |SIGUE;
        |XCIERRA handle;
     |FINSI;
     Pos = -1;
     |CIERRAT #4;
     |CIERRAT #16;
|FPRC;


____________________________________/ CALCULO PRINCIPAL
|PROCESO pasa;  |TIPO 3;
    aFichero = "p" + Usuario;
    |NOME_DAT #17 aFichero;
    |DELINDEX #17;
#0#15 = "Fact. Resi. n§";
    |SI #0#0 = "S";

        |SI #0#3 = "S";
            |HAZ subcta_t09;
        |FINSI;

        |PINTA 2221, "                                                  ";
        |SI #0#4 = "S";
            |HAZ contador;
            docum = nDOCUMENTO - 1;
            nRegi = nREGISTRO;
            sw1   = 0;
            |ABRE #2;
            |ABRE #3;
            |HAZ diario_t09;
            |CIERRA #3;
            |CIERRA #2;
            |SI nDocumAnt = 0; docum = docum + 1; |FINSI;
            nDOCUMENTO = docum;
            nREGISTRO  = nRegi;
            |HAZ ActContador;
        |FINSI;
        |SI sumar ! 0;
            |HAZ GrabaIva;
        |FINSI;

        |DELINDEX #17;
    |FINSI;
|FPRC;

|PROCESO nuSacaNivel;

 |QBF eaCuenta;
 alfa1 = eaCuenta % 0;
 nNume1 = alfa1;
 |SI nNume1 < MaximoDigitos;
     nNume2 = MaximoDigitos - nNume1;
     alfa4 = "0" * nNume2;

     alfa1 = eaCuenta % 104;
     alfa2 = eaCuenta % 505;
     alfa3 = alfa1 + alfa4 + alfa2;
     eaCuenta = alfa3;
 |FINSI;

 |HAZ SacaNivel;
|FPRC;
