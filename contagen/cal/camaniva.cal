|FICHEROS;
   camaniva #0;
   caivalin #1,MANTE;
   cacuenta #2;
   calibros #3;
   caivases #5;
   caclipro #8,MANTE;
   camaasic #11;
   camaasil #12;
   catmpasi #14;
   calicont #31;
   casiim01;

   casieaca #111;

   caivaasi;
   caivaaxx;
   cadeflab #202;

   :/modelos/def/dsmom030 #130;
   &regisnif@ #709;

   concept@ #15;
   &Puente@ #18;

   calincob #1000;
   calinpag #1001;
   camanref #1002;

   HistEnl@ #1100;
   Control1@ #1101;
   Control2@ #1102;
   Control3@ #1103;
   caivalin@ #1104;

   caliniv0 #900,MANTE;
   caliniva #901,MANTE;
   calinivr #902,MANTE;

   caw00017 #917;

   anm00001 #110;
   anm00012 #112;
   anm00013 #113;

   anw00012 #212;
   anw00013 #213;

   caivalit #100;
   cafantas #101;

   camaasiv #220;

   catmpvto #990;

   Referen@ #5000;

   camacc01 #501;
   camacc02 #502;
   camacc03 #503;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoan_i;
|INCLUYE dscola_i;
|INCLUYE dscoiv_i;
|INCLUYE dscosi_i;
|INCLUYE modulo_i;
|INCLUYE cla340_i;

|VARIABLES;
   nBtnItemDoc = -1;
   &eaNombre = "";

   nDesNom = 0;
   nMod    = 0;
   &enLibroOTP = 0;
   &enRgIVAOTP = 0;
   &eaSerieOTP = "";
   &enNumFcOTP = 0;
   &eaReferOTP = "";
   &eaECEBIOTP = "";

   &enDiarioNivel = -1;
   nSalir = 0;
   aFichero = "";
   nSi = 0;
   mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
   mensa2 = "    ERROR FECHA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
   mensa4 = "    ATENCION. FECHA FACTURA INFERIOR O IGUAL AL BLOQUEO DE DATOS";
   &enSWAut = 0;
   &enLiAut = 0;
   &enOrAut = 0;
   &eaSeAut = "";

   &en0W17 = 0;
   &ef1W17 = @;
   &en2W17 = 0;

   nSwErr     = 0;
   aFraPrv    = "";
   nNume1     = 0;
   nNume2     = 0;
   &aAntesDes0 = "";
   &aAntesDes1 = "";
   nAnterior27 = 0;
   nAnterior = 0;
   nAnteriorIRPF = 0;
   nSwIntra = 0;
   &eaRef = "";
   &ct1_am = "";
   &ct2_am = 0;
   &ct3_am = "";
   &fec_am = @;
   &ref_am = "";
   &imp_am = 0;
   &iva_am  = 0;
   &tiva_am = 0;
   &nLib_am = 0;
   &aSer_am = "";
   &nFra_am = 0;
   &nDoc_am = 0;
   &nBas_am = 0;
   &nSwFra  = 0;
   &dni_am = "";
   &clau_am = "";
   &igic_am = "";
   nMiraDoc = 0;

   &enModAmor = 0;
   &c_ctana = "";
   &c_conp = 0;
   &c_am   = "";
   &prv_am = "";
   &enQSerie = 0;
   &entrada   = 1;
   nAhora1 = 0;
   nAhora2 = 0;
   &aDescAnt   = "";
   a_Param    = "";
   aDiario    = "";
   nDiario    = 0;
   aFecha     = "";
   fFecha     = @;
   fDFecha    = @;
   aDocumento = "";
   nDocumento = 0;
   nRegistro  = 0;
   nLibro     = 0;
   nCont      = 0;
   Modo       = 0;
   nImpAnt    = 0;
   fFecAnt    = @;
   aNomAnt    = "";
   &sw_ivamerr = 0;
   &esVarDni  = "";

   nAny       = 0;
   FechaAnt   = @;
   Tecla      = 0;

   aParam = "";
   ModoEntrada = 0;
   ModoEntrLin = 0;
   inkey = 0;

   nTipoAnt = 0;
   aTipo = "";
   SerieAnt = "  XX";
   FactuAnt = 0;
   RegisAnt = 0;
   caant = "";
   NumFactura  = 0;
   Comodin  = "";
   Comodin1 = "";
   Clave    = 0;      Opcion  = 0;
   NumDoc   = 0;      SinAsto = 0;

   Desc = "";
   nHandle  = 0;
   nHandle1 = 0;

   aDirec = ""; Handle = 0;
   NumApunte = 0; NumApunteAnt = 0; NumLinea = 0; SwError = 0; Busca = 0;

   ConcepAnt = 0; Campo1 = 0;
   Calc = 0; Cont = 0;
   swpase = 0;

   &libro = 0;   &serie = "";   &orden = 0;   &depart = "";  &pesetas = 0;
   &cuenta = ""; &emision = ""; &nConcep = 0; &aDesc   = ""; &digito = 0;
   &enModoEsc = 0; &eaPath = ""; &eaRetorno = ""; &numdocum = 0;
   &enPCAut = 0;
   nContador = 0;
{50}&enTipoRec = 0;

   &aFich1 = "";
   aFich2 = "";
   nYaCrea = 0;
   swmalo  = 0;
   impoa   = 0;
   importe = 0;
   import1 = 0;
   import2 = 0;
   aSigno = "";
   aSigAn = "";

   nSwAltaAhora = 0;
   nSwGest = 0;

    alfa1 = "";
    alfa2 = "";
    aTipoDoc = "";
    aAlfaNOME = "";
    aAlfa  = "";
    aAlfa1 = "";
    aAlfa2 = "";
    aAlfa3 = "";
    aAlfa4 = "";
    aAlfa5 = "";
    aAlfa6 = "";
    aAlfa7 = "";

    aDCon1 = "";
    aDCon2 = "";
    nDCon0 = 0;
    nDCon1 = 0;

    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    swpcta = 0;
    nGuarda = 0;
    nImporResta = 0;

    &eaVarDni  = "";
    &enCalcCif = 0;
    &enPred    = 0;
    &nSwHay17   = 0;
    nPara1     = 0;
    &eaFitW17  = "";
    &swEstado  = 0;
    &coant      = 0;
    &deant      = "";
    &dpant      = "";
    &sdant      = "";
    &refant     = "";
    SwNoMod     = 0;

   &enDiAna = 0;
   &efFeAna = @;
   &enDoAna = 0;
   &enApAna = 0;
   &eaGrAna = "";
   &enImAna = 0;
   &enQueAna = 0;
   &nSwGrupo = 0;
   &eaFitnW12 = "";
   &eaFitnW13 = "";

   &ext1 = "";
   &ext2 = "";

   nswclipro  = 0;
   &aCPartida  = "";
   nCTiva     = 0;
   aPositivo  = "";
   aObligado  = "";
   aModIRPF1  = "";
   nConIRPF1  = 0;
   nConIRPF   = 0;
   nCGuarda   = 0;
   aCtaDebe  = "";
   aCtaHaber = "";

   &enSwNoAlta = 0;
   &enSwBUENO  = 0;
   nError      = 0;
   aAbo        = "";
   aMod9       = "";
   &r_entra = "";
   &r_alfa1 = "";
   ant_ref  = "";

   aMensa = "";

   nDLinea = 0;
   nHLinea = 0;
   swAmor  = 0;
   swAmorC = 0;
   swInve  = 0;
   &enSwEncuentro = 0;
   xx = 0;
   &enIn03  = 0;

   aUsu = "";
   aUsf = "";
   nExiste = 0;
   &enPerIntra = 0;

   aDep  = "";
   aSub  = "";
   aDep1 = "";
   aSub1 = "";
   n     = 0;
   &enNoHay = 0;

  {40}aPopup        = "";
     nID            = 0;
     aID            = "";
     aTexto         = "";

     nReserva  = 0;

   nCalc       = 0;
   &eaCtaIVAEs = "";
   nPulsoF9    = 0;

   &eaTip349   = "";
   aM030_92    = "";
   nM030_93    = 0;

     &raf_cue   = "";
     &raf_dig   = 0;
     &raf_des   = "";
     &raf_sw    = 0;
     &tipoalta  = "";
     &raf_nif   = "";

     nCAJA    = 0;
     nREBUReg = 0;
     nREBU    = 0;
     nIva     = 0;
     &enDesglose = 0;

   aSerOrig  = "";
   nFacOrig  = 0;
   &swVarios = 0;
   nNumero   = 0;
   nSwOp     = 0;
   nSwObli     = 0;
   nPrimer   = 0;
   aModi     = "";

   aNIFProv    = "";
   aPreven     = "";
   aMasPreven  = "";
   aFicPreven  = "";
   aZona       = "";
   aFechaBaja  = "";
   aEmbargo    = "";
   aAsesPas    = "";
   aAgrupar    = "";
   aCadena     = "";
   aFic        = "";
   nSPA        = 0;
   nSuperUsu   = 0;
   nOk         = 0;
   aBlanc60    = "                                                            ";

     &eaMensaCad   = "";
     &enErrorCad   = 0;
     &eSwCambio    = 0;

     &enDiaGAD     = 0;
     &efFecGAD     = @;
     &enDocGAD     = 0;
     &enLibGAD     = 0;
     &enRegGAD     = 0;
     &eaExiGAD     = "";

     &eaSer              = "";
     &enFac              = 0;
     &eaTip              = "";
|FIN;

|PROCESO T12lin;  |TIPO 12;
     |SI aTipoIVA = "N"; |ACABA; |FINSI;
     |SI aTipoIVA = "S"; |ACABA; |FINSI;

     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;

     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     eaSiiPro = "camaniva";
     enSiiLib = #camaniva#0;
     enSiiDoc = #camaniva#1;
     enSiiOpe = (FEntrada / 100) ! 0;
     enSiiLin = #caivalin#2;
     enSiiIva = #caivalin#7;
     enSiiL   = 0;
     enSiiLCp = #caivalin#3;
     eaSiiSer = #camaniva#2;
     enSiiFra = #camaniva#3;
     eaSiiCpt = #caivalin#3;
     eaSiiCta = #camaniva#12;
     eaSiiCIF = #camaniva#14;  |QBF eaSiiCIF;
     eaSiiDes = #camaniva#28;
     eaSiiRef = #camaniva#22;
     eaSiiUlt = #camaniva#44;  |QBF eaSiiUlt;
     eaSii340 = #camaniva#42;  |QBF eaSii340;
     eaSiiEje = #camaniva#4 % -104;
     enSiiPer = #camaniva#5;
     enSiiRet = #caivalin#22;
     eaSiiDep = #camaniva#10;
     eaSiiSub = #camaniva#11;

     |SUB_EJECUTA "casiim01";
|FPRC;

|PROCESO T12man;  |TIPO 12;
     |SI FSalida = 7;    |ACABA; |FINSI;
     |SI aTipoIVA = "N"; |ACABA; |FINSI;

     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;

     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     nSwAltaAhora = 1;

     eaSiiPro = "camaniva";
     enSiiLib = #camaniva#0;
     enSiiDoc = #camaniva#1;
     enSiiOpe = (FEntrada / 100) ! 0;
     enSiiLin = 0;
     enSiiLCp = 0;
     eaSiiSer = #camaniva#2;
     enSiiFra = #camaniva#3;
     eaSiiCpt = #camaniva#27;
     eaSiiCta = #camaniva#12;
     eaSiiCIF = #camaniva#14;  |QBF eaSiiCIF;
     eaSiiDes = #camaniva#28;
     eaSiiRef = #camaniva#22;
     eaSiiUlt = #camaniva#44;  |QBF eaSiiUlt;
     eaSii340 = #camaniva#42;  |QBF eaSii340;
     eaSiiEje = #camaniva#4 % -104;
     enSiiPer = #camaniva#5;
     enSiiRet = #camaniva#20;
     eaSiiDep = #camaniva#10;
     eaSiiSub = #camaniva#11;

     |SUB_EJECUTA "casiim01";
     enSiiL = 0;

|FPRC;

|PROCESO Tipo14GAD;  |TIPO 14;
     enLibGAD     = #camaniva#0;
     enRegGAD     = #camaniva#1;
     |HAZ EnGadFactura;

     |ATRI P;
     |PINTA 0557, eaExiGAD;
     |ATRI I;
|FPRC;

|| ****** Calculos de Camaniva ( Cabecera IVA)

|PROCESO MiraSiOTP;
   |DBASE aAlfa6; |QBF aAlfa6;
   aAlfa6 = aAlfa6 + "bin/otp00004.tab";
   |XABRE "E", aAlfa6, nHandle1;
|FPRC;

|CALCULO TrasLibro; |TIPO 0;
   ModoEntrada  = (FEntrada / 100) ! 0;
   |ABRE #calibros;
   #calibros#0 = #camaniva#0;
   |LEE 010#calibros.=;
   |SI FSalida ! 0;
       |MENAV "      No existe libro";
       |CIERRA #calibros;
       |C_M #camaniva#0#,1,"S";
       |ERROR;
       |ACABA;
   |FINSI;
   |CIERRA #calibros;

   |SI aParam ! "";  |Y #calibros#2 ! aTipoIVA;
       |MENAV "     Libro de IVA No Correcto";
       |C_M #camaniva#0,1,"S";
       |ERROR;
       |ACABA;
   |FINSI;

   aTipoIVA     = #calibros#2;
   #camaniva#36 = aTipoIVA;
   eDCl340      = #calibros#6;
   enAParam     = #camaniva#10;
   |HAZ LeeDefIVA;
   nCGuarda = dTiva;

|SI nYaCrea = 0; |O  enLibIVA ! #camaniva#0;
   enLibIVA  = #camaniva#0;
   enFilConc = 2;          || Conceptos de IVA
   |HAZ CreaConcepto;
   aFich1    = eaFiCon;
   enFilConc = 3;          || Conceptos de IRPF
   |HAZ CreaConcepto;
   aFich2 = eaFiCon;
   nYaCrea = 1;
|FINSI;

   |C_M #caivalin#29,1,"N";
   |ATRI I;
   |SI aTipoIVA = "R";
      |PINTA 0537, " IVA REPERCUTIDO ";
   |SINO;
      |SI aTipoIVA = "S";
          |PINTA 0537, " IVA SOPORTADO   ";
          |SI enNumAct > 1; |C_M #caivalin#29,1,"S"; |FINSI;
      |SINO;
          |PINTA 0537, " REGISTRO SIN IVA";
      |FINSI;
   |FINSI;
   |ATRI N;

   |HAZ TomaDefectos;
   |HAZ Mensaje;

   |SI #camaniva#36 = "S";
      |HAZ MiraSiOTP;
      |SI FSalida ] 0;
         |HAZ PintaExpCEBI;
      |FINSI;
   |FINSI;
|FCAL;


|CALCULO Tipo13_C; |TIPO 13;

   enModoEsc = Modo;
   |SI enModoEsc = 0;
       enModoEsc = (FEntrada / 100) ! 0;
   |FINSI;
   |SI enModoEsc > 0;
        nImpAnt = #camaniva#21;
        fFecAnt = #camaniva#4;
        aNomAnt = #camaniva#13;
   |FINSI;

   |SI aTipoIVA = ""; aTipoIVA = #camaniva#36; |FINSI;
   |ATRI I;
   |SI #camaniva#36 = "R";
          |PINTA 0537, " IVA REPERCUTIDO  ";
   |SINO;
      |SI #camaniva#36 = "S";
          |PINTA 0537, " IVA SOPORTADO    ";
      |SINO;
          |PINTA 0537, " REGISTRO SIN IVA ";
      |FINSI;
   |FINSI;
   |ATRI N;
   |HAZ Mensaje;
|FCAL;

|PROCESO BorraAsiento;

 |SI #camaasil#19 = "X"; |Y swEstado = 2;  ||modificacion
     || no actualizo datos
 |SINO;
   MasMenos     = 0 - #camaasil#9;
   DebeHaber    = #camaasil#8;
   aCUENTA      = #camaasil#4;
   nNIVELCUENTA = #camaasil#5;
   nREGISTRO    = #camaasil#24;
   nDIARIO      = #camaasil#0;
   aFECHA       = #camaasil#1;
   nDOCUMENTO   = #camaasil#2;

   |HAZ ActDiario;
   |HAZ ActCuenta;
   |HAZ ActTesteo;
 |FINSI;

 |BORRA 020#camaasil.a;
  SinAsto = 0;
|FPRC;

|DEFBUCLE BorraAsiento;
 #camaasil#1;
 ;
 #camaniva#7,#camaniva#8,#camaniva#9,0000;
 #camaniva#7,#camaniva#8,#camaniva#9,9999;
 ;
 NULL,BorraAsiento;
|FIN;

|PROCESO BorraContra;
 |BORRA 020#31a;
 |LIBERA #31;
|FPRC;

|DEFBUCLE BorraContra;
 #calicont#1;
 ;
 #camaniva#7,#camaniva#8,#camaniva#9,0000;
 #camaniva#7,#camaniva#8,#camaniva#9,9999;
 be;
 NULL,BorraContra;
|FIN;

|PROCESO BorraLineas;
  |BORRA 020#caivalin.a;
|FPRC;

|DEFBUCLE BorraLineas;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,01;
 #camaniva#0,#camaniva#1,99;
 ;
 NULL,BorraLineas;
|FIN;

|PROCESO MiraEmpresas;
   |SI #Control1@#5 [ #camaniva#0; |Y #camaniva#0 [ #Control1@#6;
      |SI #Control1@#7 [ #camaniva#2; |Y #camaniva#2 [ #Control1@#8;
          #Control2@#6 = #Control1@#9;
          |LEE 000#Control2@.=;
          |PARA; |SI FSalida = 0; |Y #Control2@#6 = #Control1@#9; |HACIENDO;
                 #Control3@#0 = #Control2@#0;
                 |LEE 000#Control3@.=;
                 |SI FSalida = 0;
                     aAlfa = #Control3@#1; |QBF aAlfa;
                     aAlfa = aAlfa + "def/agifa722.mas";
                     |CARGA_DEF aAlfa, HistEnl@;
                     |SI FSalida = 0;
                         aAlfa = #Control3@#1; |QBF aAlfa;
                         aAlfa = aAlfa + "fich/" + (("00000" + #Control3@#0) % -105) + "/";
                         |PATH_DAT #1100 aAlfa;
                         |ABRE #HistEnl@;
                         |SELECT #2#HistEnl@;
                         #HistEnl@#8 = #Control1@#0;
                         #HistEnl@#9 = #Control1@#1;
                         #HistEnl@#4 = #camaniva#7;
                         #HistEnl@#5 = #camaniva#8;
                         #HistEnl@#6 = #camaniva#9;
                         #HistEnl@#7 = 1;
                         |LEE 000#HistEnl@.];
                         |SI FSalida = 0; |Y #HistEnl@#8 = #Control1@#0; |Y #HistEnl@#9 = #Control1@#1;
                             |Y #HistEnl@#4 = #camaniva#7; |Y #HistEnl@#5 = #camaniva#8; |Y #HistEnl@#6 = #camaniva#9;
                             nSwGest = 1;
                             |CIERRA #HistEnl@;
                             |DESCARGA_DEF #HistEnl@;
                             |SAL;
                         |FINSI;
                         |CIERRA #HistEnl@;
                         |DESCARGA_DEF #HistEnl@;
                     |FINSI;
                 |FINSI;
                 |LEE 000#Control2@.s;
          |SIGUE;
          |SI nSwGest = 1; |ERROR10; |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE MiraEmpresas;
   #Control1@#1003;
   3;
   #48#2, #48#3, 001, aTipoDoc;
   #48#2, #48#3, 999, aTipoDoc;
   ;
   NULL,MiraEmpresas;
|FIN;

|PROCESO MiraSiGestion;
   enAParam = #camaniva#10;
   |HAZ eActivParam;

   aAlfa = #caivaasi#56; |QBF aAlfa; aAlfa1 = aAlfa;
   aAlfa = aAlfa1 + "def/dscam043.mas";
   |CARGA_DEF aAlfa, Control1@;
   |SI FSalida = 0;
      aAlfa = aAlfa1 + "def/dscam045.mas"; |CARGA_DEF aAlfa, Control2@;
      aAlfa = aAlfa1 + "def/dscam044.mas"; |CARGA_DEF aAlfa, Control3@;
      aAlfa = #caivaasi#56; |QBF aAlfa; aAlfa = aAlfa + "fich/";
      |PATH_DAT #1101 aAlfa; |PATH_DAT #1102 aAlfa; |PATH_DAT #1103 aAlfa;

      |SI #camaniva#36 = "R"; aTipoDoc = "V"; |FINSI;
      |SI #camaniva#36 = "S"; aTipoDoc = "C"; |FINSI;
      |ABRE #Control2@; |SELECT #2#Control2@;
      |ABRE #Control3@;
      |BUCLE MiraEmpresas;
      |SELECT #1#Control2@;

      |CIERRA #Control3@; |DESCARGA_DEF #Control3@;
      |CIERRA #Control2@; |DESCARGA_DEF #Control2@;
      |CIERRA #Control1@; |DESCARGA_DEF #Control1@;
   |FINSI;
|FPRC;

|PROCESO BorraRecsV;
   |SI nSwOp = 1;
       nNumero = nNumero + 1;
       |ACABA;
   |FINSI;

   |DDEFECTO #catmpvto;
   #catmpvto#0 = #calincob#0;
   #catmpvto#1 = #calincob#2;
   #catmpvto#2 = #calincob#1;
   #catmpvto#3 = #calincob#3;
   #catmpvto#4 = #calincob#7;
   #catmpvto#5 = #calincob#8;
   #catmpvto#6 = #camaniva#21;
   |GRABA 020#catmpvto.n;

   |BORRA 020#calincob.a;
   |LIBERA #calincob;
|FPRC;

|DEFBUCLE BorraRecsV;
  #calincob#1;
  ;
  #camaniva#0,#camaniva#2,#camaniva#3,001;
  #camaniva#0,#camaniva#2,#camaniva#3,999;
  be;
  NULL,BorraRecsV;
|FIN;

|PROCESO BorraRecsC;
   |SI nSwOp = 1;
       nNumero = nNumero + 1;
       |ACABA;
   |FINSI;

   |DDEFECTO #catmpvto;
   #catmpvto#0 = #calinpag#0;
   #catmpvto#1 = #calinpag#2;
   #catmpvto#2 = #calinpag#1;
   #catmpvto#3 = #calinpag#3;
   #catmpvto#4 = #calinpag#7;
   #catmpvto#5 = #calinpag#8;
   #catmpvto#6 = #camaniva#21;
   |GRABA 020#catmpvto.n;

   |BORRA 020#calinpag.a;
   |LIBERA #calinpag;
|FPRC;

|DEFBUCLE BorraRecsC;
#calinpag#1;
;
#camaniva#0,#camaniva#2,#camaniva#3,001;
#camaniva#0,#camaniva#2,#camaniva#3,999;
be;
NULL,BorraRecsC;
|FIN;

|PROCESO LeoAsto;
       |ABRE #camaasic;
       #camaasic#0 = #camaniva#7;
       #camaasic#1 = #camaniva#8;
       #camaasic#2 = #camaniva#9;
       |LEE 010#camaasic.=;
       |SI FSalida = 0;
           enPred     = #camaasic#7;
           enTipoAsto = #camaasic#13;
       |FINSI;
       |CIERRA #camaasic;
|FPRC;

|PROCESO EsCajaIva;
   enSwCaja = 0;
   |SI enEjercicio ] 2014; |Y #camaniva#36 ! "N";
      |SI #camaniva#42 = "Z"; |O #camaniva#42 = "1"; |O #camaniva#42 = "2";
          |O #camaniva#42 = "3"; |O #camaniva#42 = "4"; |O #camaniva#42 = "5";
          |O #camaniva#42 = "6"; |O #camaniva#42 = "7"; |O #camaniva#42 = "8";
             enSwCaja = 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BuscoConIRPF;
   |SI #caivalin#18 ! 0;
       enConIRPF= #caivalin#18;
       |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE BuscoConIRPF;
 #caivalin#1;
 ;
 #camaniva#0, #camaniva#1, 01;
 #camaniva#0, #camaniva#1, 99;
 e;
 NULL, BuscoConIRPF;
|FIN;

|CALCULO Baja; |TIPO 1;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1;
       nSwAltaAhora = 1;
   |FINSI;

   |HAZ EsCajaIva;

   |SI #camaniva#36 ! "N";
       |SI enSi340 = 1; |O enSi303 = 1; |O enSi111 = 1;
           SwNoMod   = 0;
           eModoCaja = ModoEntrada;
           eSwReten = 0;
           |SI #camaniva#20 ! 0;
                eSwReten = 1;
                enConIRPF = 0;
                |BUCLE BuscoConIRPF;
           |FINSI;
           |HAZ eElCtrlModIVA;
           |SI enSwSalir = 1;
               SwNoMod = 1;
               |ERROR;
               |ACABA;
           |FINSI;
           |SI enSwSalir = 2;
               enErrCarte = 9; enSwDejar = 1;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI ModoEntrada = 2; |O ModoEntrada = 3;
       || Compruebo para el modulo de Vilami¤o si la factura esta visada para
       ||    avisar

       |SI #camaniva#36 = "S";
          |DDEF aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "cavilm01.mas";
          |XABRE "E", aAlfa, nHandle;
          |SI FSalida ] 0;                || Es el modulo de Vilami¤o
             |CARGA_DEF aAlfa, Referen@;
             |SI FSalida = 0;
                |ABRE #Referen@;
                #Referen@#0 = #camaniva#0;
                #Referen@#1 = #camaniva#1;
                |LEE 000#Referen@.=;
                |SI FSalida = 0;
                   |SI ModoEntrada = 2;
                      aAlfa = "    NSe modificará una factura visada. Si continua se anulará el visado. " + &191 + " Conforme ? ";
                   |FINSI;
                   |SI ModoEntrada = 3;
                      aAlfa = "    NVa a dar de baja una factura visada. " + &191 + " Conforme ? ";
                   |FINSI;
                   |CONFI aAlfa;
                   |SI FSalida = 0;
                      |BORRA 020#Referen@.a;
                   |SINO;
                      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                      |ERROR; |ACABA;
                   |FINSI;
                |FINSI;
                |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
             |FINSI;
          |FINSI;
       |FINSI;

       |SI #camaniva#8 [ fec3;
           |MENAV mensa2;
           SwNoMod = 1;
           |ERROR;
           |ACABA;
       |SINO;
           SwNoMod = 0;
       |FINSI;
   |FINSI;

   |SI ModoEntrada = 2; |Y enSwDejar = 1;
          enErrCarte = 9;
          |PTEC 806;
          |ACABA;
   |FINSI;

   |SI ModoEntrada = 3;
       nSwGest = 0;
       |HAZ MiraSiGestion;     || Compruebo si la factura ha sido enlazada desde
       |SI nSwGest = 1;
           |MENAV "    Factura enlazada desde gestion. No se puede dar de Baja";
           |ERROR;
           |ACABA;
       |SINO;
           |HAZ LeoAsto;
           |SI enTipoAsto > 100;
               |SI #camaniva#36 ! "N";
                   |MENAV "    Factura enlazada desde Gestion. No se puede dar de Baja";
               |SINO;
                   |MENAV "    Nomina enlazada desde Laboral. No se puede dar de Baja";
               |FINSI;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;

       |HAZ QuitaMarcaDSCOMER;
   |FINSI;

   |SI ModoEntrada = 2;
       nSwGest = 0;
       |HAZ MiraSiGestion;     || Compruebo si la factura ha sido enlazada desde
       |SI nSwGest = 1;
           enSwDejar = 0;
           |HAZ eDejarModificar;
           |SI enSwDejar = 0;
               |MENAV "    Factura enlazada desde gestion. Modificar desde la factura original y reenlazar";
               enErrCarte = 1;  ||o 9
               |ERROR;
               |ACABA;
           |SINO;
               |HAZ LeoAsto;
               |PTEC 806;
               enErrCarte = 9;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI ModoEntrada = 2;
       |SI #camaniva#9 = "-1";
           SwNoMod = 1;
           |MENAV "    Factura Especial, no crea ni modifica Asiento ";
           |C_M #camaniva#9,1,"N";
       |SINO;
           SwNoMod = 0;
           |SI #camaniva#9 = 0;
               |C_M #camaniva#9,1, aMod9;
           |FINSI;
       |FINSI;
   |FINSI;

   enErrCarte = 0;
|| Mirar si existen Recibos en Cartera.
   |SI #camaniva#36 ! "N";
       |PARA nContador = 0; |SI nContador < 50; |HACIENDO nContador = nContador + 1;
          IenTipoRec = enTipoRec1<-; IenTipoRec = IenTipoRec + nContador;
          enTipoRec = 0;
       |SIGUE;
       eaProg = "camaniva";
       eaVC   = #camaniva#36;
       |HAZ MiraRecibos;
       |SI enErrCarte ! 0;
           |SI ModoEntrada = 3;
               aAlfa1 = "0000Recibos con movimientos, NO SE PUEDE DAR DE BAJA FACTURA";
               |MENAV aAlfa1;
               |ERROR;
               |ACABA;
           |FINSI;

           |SI ModoEntrada = 2;
               aAlfa1 = "    NRecibos con movimientos, NO SE PUEDE MODIFICAR FACTURA. CONTINUAR";
               |CONFI aAlfa1;
               |SI FSalida ! 0;
                   |PTEC 807;
               |SINO;
                   |HAZ ElAuxW17;
                   |HAZ ElGrupo_Rec;
                   |PTEC 806;
                   enErrCarte = 9;
               |FINSI;

               |ACABA;
           |FINSI;
       |SINO;
           |SI #camaniva#36 = "S";
              nSwErr = 0;
              |PARA nContador = 0; |SI nContador < 50; |HACIENDO nContador = nContador + 1;
                 IenTipoRec = enTipoRec1<-; IenTipoRec = IenTipoRec + nContador;
                 |SI enTipoRec ] 1;
                    |SI enTipoRec ! 98; |Y enTipoRec ! 99; nSwErr = 1; |FINSI;
                 |FINSI;
              |SIGUE;

              |SI nSwErr ! 0;
                 |SI ModoEntrada = 3;
                    aAlfa = "    NFra.con recibos ya aceptados. Si continua se eliminar n dichos recibos. " + &191 + " Continuar ?";
                 |FINSI;
                 |SI ModoEntrada = 2;
                    aAlfa = "    NFra.con recibos ya aceptados. Si continua se crear n de nuevo los recibos. " + &191 + " Continuar ?";
                 |FINSI;
                 |CONFI aAlfa;
                 |SI FSalida ! 0;
                    |SI ModoEntrada = 3; enErrCarte = -1; |ERROR; |ACABA; |FINSI;
                    |SI ModoEntrada = 2;
                       enSwDejar = 1;     || No dejo que se modifique
                       enErrCarte = 9;    || No deshago los vencimientos
                       |PTEC 806; |ACABA; || Salgo del endatos de la cabecera
                    |FINSI;
                 |FINSI;
              |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

|| ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ...
   |SI ModoEntrada = 2;

       enPred = 0;
       |ABRE #camaasic;
       #camaasic#0 = #camaniva#7;
       #camaasic#1 = #camaniva#8;
       #camaasic#2 = #camaniva#9;
       |LEE 010#camaasic.=;
       |SI FSalida = 0;
           enPred  = #camaasic#7;
           enSwDejar = 0;
           |SI #camaasic#13 > 100;
               enTipoAsto = #camaasic#13;
               |HAZ eDejarModificar;
               |SI enSwDejar = 0;
                   |SI #camaasic#13 < 103;
                       |MENAV "    FACTURA NO MODIFICABLE ";
                   |SINO;
                       |MENAV "    NOMINA NO MODIFICABLE ";
                   |FINSI;
                   |PTEC 807;
                   enErrCarte = 1;
                   |CIERRA #camaasic;
                   |ACABA;
               |SINO;
                   |PTEC 806;
                   enErrCarte = 9;
                   |CIERRA #camaasic;
                   |ACABA;
               |FINSI;
           |FINSI;
       |FINSI;
       |CIERRA #camaasic;
       |SI enPred ! 0;
           |ABRE #casieaca;
           |DDEFECTO #casieaca;
           #casieaca#0 = enPred;
           |LEE 001#casieaca.=;
           |CIERRA #casieaca;
           |SI #casieaca#17 ! "S";
               aAlfa1 = "    ATENCION!. FACTURA NO MODIFICABLE ";
               |SI #casieaca#17 = "X";
                   aAlfa1 = "    ATENCION!. FACTURA MODIFICABLE SOLO POR ENTRADA DE APUNTES";
               |FINSI;
               |MENAV aAlfa1;
               |PTEC 807;
               enErrCarte = 1;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;
|| ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ...

   aSerOrig = #camaniva#2;
   nFacOrig = #camaniva#3;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada ! 3;
       |HAZ ElAuxW17;
       |HAZ ElGrupo_Rec;
       |ACABA;
   |FINSI;

   |BUCLE BorraLineas;
   |SI #camaniva#36 ! "N";
       enLibro    = #camaniva#0;
       enRegistro = #camaniva#1;
       eaSerie    = #camaniva#2;
       enFactura  = #camaniva#3;
       |HAZ BajaIntra;

       |SI enSwCaja = 1;
           eModoCaja = ModoEntrada;
           eDevenCaja = 0;
           |HAZ eTrataClaveZ;
       |FINSI;
   |FINSI;

   |HAZ DesactualizaDSarchi;

   nDIARIO    = #camaniva#7;
   aFECHA     = #camaniva#8;
   nDOCUMENTO = #camaniva#9;
   |HAZ SwAgrupada;
   |SI enSwAgr = 2; |Y nDOCUMENTO ! 0;
       |MENAV "    ATENCION !!!. El Asiento de este registro NO se BORRARA ni se MODIFICARA";
   |FINSI;
   |SI enSwAgr = 1;
       swEstado = 3;  ||la baja
       |BUCLE BorraAsiento;
       |BUCLE BorraContra;
       nDLinea = 1; nHLinea = 9999;
       |HAZ ElGrupo_Bor;

       |SI #camaniva#36 ! "N";
           |HAZ BorraRecibos;
           aAlfaNOME = "tv" + Usuario; |NOME_DAT #catmpvto#aAlfaNOME#;
           |DELINDEX #catmpvto;
           |ABRE #catmpvto;
           |SI #camaniva#36 = "R"; |BUCLE BorraRecsV; |FINSI;
           |SI #camaniva#36 = "S"; |BUCLE BorraRecsC; |FINSI;
           |CIERRA #catmpvto;
       |FINSI;
       |ABRE #camaasic;
       #camaasic#0 = #camaniva#7;
       #camaasic#1 = #camaniva#8;
       #camaasic#2 = #camaniva#9;
       |LEE 010#camaasic.=;
       |SI FSalida = 0;
           nDIARIO      = #camaasic#0;
           aFECHA       = #camaasic#1;
           nDOCUMENTO   = #camaasic#2;
           enPred       = #camaasic#7;
           |BORRA 020#camaasic.a;
       |FINSI;
       |CIERRA #camaasic;
  |FINSI;
|FCAL;

|| ------------------------------------------------------------------
|PROCESO BInversion;
 |SI #caivalin#17 = "S";
     |SI #camaniva#35 = " ";
         #camaniva#35 = "I";
     |SINO;
         |SI #camaniva#35 = "N";
             #camaniva#35 = "A";
         |FINSI;
      |FINSI;
  |SINO;
      |SI #camaniva#35 = " ";
          #camaniva#35 = "N";
      |SINO;
         |SI #camaniva#35 = "I";
             #camaniva#35 = "A";
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE BInversion;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,01;
 #camaniva#0,#camaniva#1,99;
 ;
 NULL,BInversion;
|FIN;

|| ...........

|PROCESO Posible;

     |ABRE #camaasil;
     NumApunte = NumLinea;
     #camaasil#0 = #camaasic#0;
     #camaasil#1 = #camaasic#1;
     #camaasil#2 = #camaasic#2;
     #camaasil#3 = NumApunte;
     |LEE 010#camaasil.=;
     |SI FSalida = 0;
         aAlfa = #camaasil#19; aAlfa = aAlfa > " ";
         |SI aAlfa ! "B"; |O #camaasil#9 ! #caivalin#6;
             |SI aAlfa ! "B";
                 aAlfa1 = "    Linea Incorrecta, no corresponde a una Cuenta de Base";
             |SINO;
                 aAlfa1 = "    No coincide el Importe del Apunte con el de la Base ";
             |FINSI;
             |MENAV aAlfa1;
             |CIERRA #camaasil;
             |ACABA;
         |FINSI;

         |CONFI "    SNumero de Linea Correcto ?";
         |SI FSalida = 0;
             nSalir = 1;
         |FINSI;
     |FINSI;
     |CIERRA #camaasil;
|FPRC;

|PROCESO ModiPan_4;
   |SI eaSubde = "N";
        |C_A #catmpasi#7, 1, 80;
        |C_P #14#21,1, 1467;
        |C_V #14#28,1, "N";
        |PINTA 1162, "ÄÄÄÄÂÄÄ";
        |PINTA 1262, "    ³  ";
        |PINTA 1362, "ÄÄÄÄÅÄÄ";
        |PINTA 1462, "    ³  ";
        |PINTA 1562, "    ³  ";
        |PINTA 1662, "    ³  ";
        |PINTA 1762, "    ³  ";
        |PINTA 1862, "    ³  ";
        |PINTA 1962, "    ³  ";
        |PINTA 2062, "    ³  ";
        |PINTA 2162, "    ³  ";
        |PINTA 2262, "    ³  ";
        |ATRI R; |PINTA 1262, "    "; |PINTA 1267, "Dp"; |ATRI 0;
   |FINSI;
|FPRC;

|PROCESO PreguntoLinea;

 |ABRE #100;
 #100#0 = #caivalin#0;
 #100#1 = #caivalin#1;
 #100#2 = #caivalin#2;
 |LEE 001#100=;
 |SI FSalida ! 0; |CIERRA #100; |ACABA; |FINSI;
 |CIERRA #100;

 |SI #100#12 = #caivalin#12; |Y #100#28 = #caivalin#28; |ACABA; |FINSI;

 |PUSHV 05012380;

 |PINPA #0#14; |HAZ ModiPan_4;
 |BLANCO 0901 1079;
 |ATRI I;
 |PINTA 0902, "Linea IVA:    Contrapartida Anterior:              Importe:              ";
 |PINTA 1002, "INDIQUE EL NUMERO DE APUNTE QUE CORRESPONDE A ESTA BASE ";
 |PINTA 0913, #caivalin#2;
 |PINTA 0940, #100#12;
 |PINTA 0961, #caivalin#6;
 |SI enSwAna = 1;
     |SI #100#28 = #caivalin#28;
         aAlfa = "Cta Analitica de la Linea " +  #100#28;
     |SINO;
         aAlfa = "Cta Analitica Anterior " +  #100#28 + ". Cta Analica Nueva " + #caivalin#28;
     |FINSI;
     |PINTA 1102, aAlfa;
 |FINSI;
 |ATRI 0;

 |SI enSwAna = 1;
     |C_V #catmpasi#26,1,"S";
     |C_V #catmpasi#29,1,"S";
 |FINSI;
 |ENTLINEAL #1#catmpasi,-4,7,22,0,Asiinf2,Asisup2;
 |C_P #101#7,1,1060;
 nSalir = 0;
 |PARA; |SI nSalir = 0; |HACIENDO;

        |ENCAMPO #7#101;
        |SI FSalida = 7; SwError = 1; |SAL; |FINSI;
        NumLinea = #101#7;
        |HAZ Posible;
        |SI nSalir = 1; SwError = 0; |FINSI;
 |SIGUE;
 |POPV;
 |SI SwError = 1;
     |MENAV "    LA LINEA DEL IVA NO SE MODIFICA ";
     #caivalin#12 = #100#12;
     #caivalin#28 = #100#28;
     |GRABA 020#caivalin.a;
 |FINSI;
|FPRC;

|| ..... Repasar
|PROCESO BuscaLinea;
   NumLinea = #camaasil#3; SwError = 0;
   |ERROR10;
|FPRC;

|PROCESO BuscaLinea_v;

   |SI #camaasil#19 ! "B"; |Y #camaasil#19 ! "b"; |ACABA; |FINSI;

   |SI #caivalin#2 = #camaasil#20;
       NumLinea = #camaasil#3; SwError = 0;
       |ERROR10;
   |SINO;
       |SI #caivalin#6 = #camaasil#9;
           #101#7 = #camaasil#3;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaLinea;
 #camaasil#1;
 4,19,29,21,28;
 #camaasic#0,#camaasic#1,#camaasic#2,0001,eaCuenta,aTipo,#caivalin#28,aDep,aSub;
 #camaasic#0,#camaasic#1,#camaasic#2,9999,eaCuenta,aTipo,#caivalin#28,aDep,aSub;
 ;
 NULL,BuscaLinea;
|FIN;

|DEFBUCLE BuscaLinea_V;  ||solo contrapartidas
 #camaasil#1;
 ;
 #camaasic#0,#camaasic#1,#camaasic#2,0001;
 #camaasic#0,#camaasic#1,#camaasic#2,9999;
 ;
 NULL,BuscaLinea_v;
|FIN;

|PROCESO CreaLineas_V;

  SwError = 1; |BUCLE BuscaLinea_V;
  |SI SwError = 1;
      |HAZ PreguntoLinea;
  |FINSI;
  |SI SwError = 0;
     |ABRE #camaasil;
     NumApunte = NumLinea;
     #camaasil#0 = #camaasic#0;
     #camaasil#1 = #camaasic#1;
     #camaasil#2 = #camaasic#2;
     #camaasil#3 = NumApunte;
     |LEE 010#camaasil.=;
     |SI FSalida ! 0;
         |CIERRA #camaasil;
         |ACABA;
     |FINSI;
     aSigno = #camaasil#8;
     |SI #camaasil#4 ! #caivalin#12;
         importe = -#camaasil#9;
         |HAZ Actualiza;
         #camaasil#4   = #caivalin#12;
         enDiarioNivel = #camaasil#0;
         eaCuenta = #camaasil#4; |HAZ SacaNivel;
         #camaasil#5 = enNivel;
         importe  =  #camaasil#9;
         |HAZ Actualiza;
     |FINSI;
     |SI enErrCarte = 9; |Y #caivaasi#131 = "S";
         #camaasil#7 = #caivalin#4;
     |FINSI;
     nDLinea = #camaasil#3; nHLinea = #camaasil#3;
     |HAZ ElGrupo_Bor;
     #camaasil#29 = #caivalin#28;
     |HAZ adapta1;
     |GRABA 020#camaasil.a;
     |LIBERA #camaasil;
     |CIERRA #camaasil;
  |FINSI;
  |LIBERA #caivalin;
|FPRC;

|PROCESO CambioCuenta;
    efFechaIVA = #camaniva#4;
    enLineaIVA = #caivalin#16;
    |HAZ SacaIVA;

    #caivalin#13 = eaCtaIVA;
    #caivalin#14 = eaCtaREC;
|FPRC;

|PROCESO CreaLineas;

   aDep = #caivalin#30; |QBF aDep;
   |SI eaMulDep ! "S"; |O aDep = "";
       #caivalin#30 = #camaniva#10;
       aSub = #caivalin#31; |QBF aSub;
       |SI eaMulDep ! "S"; |O aSub = ""; #caivalin#31 = #camaniva#11; |FINSI;
   |FINSI;
   aDep = #caivalin#30;
   aSub = #caivalin#31;

   |SI enSwDejar = 1;
       |HAZ CreaLineas_V;
       |ACABA;
   |FINSI;

   |SI aTipoIVA = "N";
       |SI aTipo = "B"; |Y #caivalin#6  = 0; |ACABA; |FINSI;
       |SI aTipo = "D"; |Y #caivalin#11 = 0; |ACABA; |FINSI;
       |SI aTipo = "P"; |Y #caivalin#22 = 0; |ACABA; |FINSI;
   |FINSI;

   |SI aTipo = "I"; importe = #caivalin#8;  |FINSI;
   |SI aTipo = "R"; importe = #caivalin#10; |FINSI;
   |SI aTipo = "B";
       importe = #caivalin#6;
       |SI aTipoIVA = "N";
           |SI #caivalin#6 = 0; |Y #caivalin#20 ! 0;
               importe = #caivalin#20;
           |FINSI;
      |SINO;
           importe = importe + #caivalin#11; ||sumo dto 03.01.2006
      |FINSI;
   |FINSI;
   |SI aTipo = "D"; importe = #caivalin#11; |FINSI;
   |SI aTipo = "P";
       importe = #caivalin#22;
       |SI aTipoIVA = "N";
||           |SI #caivalin#22 = 0; importe = #caivalin#6; |FINSI;
       |FINSI;
   |FINSI;
   |SI importe = 0;   |ACABA; |FINSI;

   |SI #caivalin#25 = "S"; |Y nReserva = 0; |Y #camaniva#42 ! "I";
       nSwIntra = 1;
       |SI aTipo = "I"; |O aTipo = "R";

           |SI snAbono = "S";
               |SI #caivalin#8  < 0; #caivalin#8  = - #caivalin#8; |FINSI;
               |SI #caivalin#10 < 0; #caivalin#10 = - #caivalin#10; |FINSI;
           |FINSI;

           |SI aTipo = "I"; nImporResta = nImporResta + #caivalin#8; |FINSI;
           |SI aTipo = "R"; nImporResta = nImporResta + #caivalin#10; |FINSI;

           |SI #caivaasi#150 ! "S"; |ACABA; |FINSI;

       |FINSI;
   |FINSI;
   |SI #camaniva#42 = "I"; |Y nReserva = 0;
       |SI #caivalin#25 = "S"; nSwIntra = 1; |FINSI;
       |SI aTipo = "I"; |O aTipo = "R";
           |SI snAbono = "S";
               |SI #caivalin#8  < 0; #caivalin#8  = - #caivalin#8; |FINSI;
               |SI #caivalin#10 < 0; #caivalin#10 = - #caivalin#10; |FINSI;
           |FINSI;
           |SI aTipo = "I"; nImporResta = nImporResta + #caivalin#8; |FINSI;
           |SI aTipo = "R"; nImporResta = nImporResta + #caivalin#10; |FINSI;

           |SI #caivaasi#151 ! "S"; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   Busca = 0;
   |SI aTipo = "I";
      |SI Modo = 1;
         |SI eaDesgIVA  = "N"; Busca = 1; |FINSI;
      |SINO;
         |SI #camaniva#31 = "N"; Busca = 1; |FINSI;
      |FINSI;
   |FINSI;
   |SI aTipo = "R";
      |SI Modo = 1;
         |SI eaDesgIVA = "N"; Busca = 1; |FINSI;
      |SINO;
         |SI #camaniva#31 = "N"; Busca = 1; |FINSI;
      |FINSI;
   |FINSI;
   |SI aTipo = "D";
      |SI Modo = 1;
         |SI eaDesgDTO = "N"; Busca = 1; |FINSI;
      |SINO;
         |SI #camaniva#34 = "N"; Busca = 1; |FINSI;
      |FINSI;
   |FINSI;
   |SI aTipo = "P";
      |SI Modo = 1;
         |SI eaDesgIVA = "N"; Busca = 1; |FINSI;
      |SINO;
         |SI #camaniva#33 = "N"; Busca = 1; |FINSI;
      |FINSI;
   |FINSI;

   |SI nReserva = 1; |HAZ CambioCuenta; |FINSI;

   |SI Busca = 1;
      |SI aTipoIVA ! "N";
          |SI aTipo = "I"; eaCuenta = #caivalin#13; |FINSI;
          |SI aTipo = "R"; eaCuenta = #caivalin#14; |FINSI;
          |SI aTipo = "D"; eaCuenta = #caivalin#15; |FINSI;
          |SI aTipo = "P"; eaCuenta = #caivalin#23; |FINSI;
      |SINO;
          eaCuenta = #caivalin#23;
      |FINSI;
      SwError = 1; |BUCLE BuscaLinea;
      |SI SwError = 0;
          NumApunteAnt = NumApunte;
          NumApunte    = NumLinea;
      |FINSI;
   |FINSI;

   aSigAn = "";
   |SI aTipoIVA = "R";      || ... Iva Repercutido
       |SI aTipo = "D"; |O aTipo = "P";
            aSigno = "D";
       |SINO;
            aSigno = "H";
       |FINSI;
   |FINSI;
   |SI aTipoIVA = "S";       || ... Iva Soportado
       |SI aTipo = "D"; |O aTipo = "P";
           aSigno = "H";
       |SINO;
           aSigno = "D";
       |FINSI;
   |FINSI;
   |SI aTipoIVA = "N";        || ... No IVA
       |SI aTipo = "B";
           aSigno = "D";
       |SINO;
           aSigno = "H";
       |FINSI;
   |FINSI;

   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = NumApunte;
   |LEE 010#camaasil.=;
   |SI FSalida ! 0;
      |DDEFECTO #camaasil;
       #camaasil#0 = #camaasic#0;
       #camaasil#1 = #camaasic#1;
       #camaasil#2 = #camaasic#2;
       #camaasil#3 = NumApunte;
       |SI aTipoIVA ! "N";
          |SI aTipo = "I"; #camaasil#4 = #caivalin#13; |FINSI;
          |SI aTipo = "R"; #camaasil#4 = #caivalin#14; |FINSI;
          |SI aTipo = "B"; #camaasil#4 = #caivalin#12; |FINSI;
          |SI aTipo = "D"; #camaasil#4 = #caivalin#15; |FINSI;
          |SI aTipo = "P"; #camaasil#4 = #caivalin#23; |FINSI;
       |SINO;
          #camaasil#4 = #caivalin#23;
       |FINSI;
       enDiarioNivel = #camaasil#0;
       eaCuenta = #camaasil#4; |HAZ SacaNivel;
       #camaasil#5 = enNivel;

       |SI aTipo = "I"; |O aTipo = "R";
           #camaasil#6 = #camaniva#29;
           #camaasil#7 = #camaniva#30;
       |SINO;
           |SI aTipo = "P";
               |SI aTipoIVA ! "N";
                   #camaasil#6 = #caivalin#18;
                   #camaasil#7 = #caivalin#19;
               |SINO;
                   #camaasil#6 = #caivalin#3;
                   #camaasil#7 = #caivalin#4;
               |FINSI;
           |SINO;
               #camaasil#6 = #caivalin#3;
               #camaasil#7 = #caivalin#4;
           |FINSI;
       |FINSI;
       #camaasil#8  = aSigno;
       #camaasil#19 = aTipo;
       #camaasil#20 = #caivalin#2;
       #camaasil#22 = 0;
       #camaasil#23 = "N";
       #camaasil#24 = nREGISTRO;
       |GRABA 020#camaasil.b;
   |SINO;
       aSigAn       = #camaasil#8;
       #camaasil#20 = 0;
   |FINSI;

   |HAZ adapta3;
   #camaasil#9 = #camaasil#9 + importe;

   |HAZ adapta1;
   |HAZ adapta2;
   |GRABA 020#camaasil.a;
   |HAZ Actualiza;
   NumApunte = NumApunte + 10;
   |LIBERA #camaasil;

   |SI NumApunteAnt ! 0;
       NumApunte = NumApunteAnt;
       NumApunteAnt = 0;
   |FINSI;

   |LIBERA #caivalin;
|FPRC;

|DEFBUCLE CreaLineas;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,01;
 #camaniva#0,#camaniva#1,99;
 be;
 NULL,CreaLineas;
|FIN;

|PROCESO VeoOtraVezDoc;
     nExiste = 0;
     |ABRE #camaasic;
     #camaasic#0 = #camaniva#7;
     #camaasic#1 = #camaniva#8;
     #camaasic#2 = #camaniva#9;
     |LEE 041#camaasic.=;
     |SI FSalida = 0;
         nExiste = 1;
     |SINO;
         |SELECT #3#camaasic;
         #camaasic#2 = #camaniva#9;
         |LEE 041#camaasic.=;
         |SI FSalida = 0;
             nExiste = 2;
         |FINSI;
         |SELECT #1#camaasic;
     |FINSI;
     |CIERRA #camaasic;

     |SI nExiste ! 0;
        |SI nExiste = 2; |Y eaPaDOM2 = "S"; |ACABA; |FINSI;  || no mira

        |HAZ NuevoDoc;
        #camaniva#9 = nDOCUMENTO; |PINTA #camaniva#9;
    |FINSI;
|FPRC;

|PROCESO AbreRebu;

   |SI #camaniva#36 = "N";  |ACABA; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI #camaniva#36 = "R";
       aAlfa1 =  "2400SFra. de REBU. Desea reflejar la venta en el Registro de Operaciones REBU: ";
       |SI ModoEntrada = 2;
           aAlfa1 =  "2400SFra. de REBU. Desea modificar la venta en el Registro de Op. REBU: ";
       |FINSI;
       |AVISO;
       |CONFI aAlfa1;
       |SI FSalida ! 0; |ACABA; |FINSI;
       fec_am  = #camaniva#4;
       imp_am  = #camaniva#21;
       c_am    = #camaniva#22;
       nLib_am = #camaniva#0;
       aSer_am = #camaniva#2;
       nFra_am = #camaniva#3;
       enModAmor = ModoEntrada;
       iva_am  = #camaniva#23;
       tiva_am = nIva;
       nDoc_am   = #camaniva#1;
       |SUB_EJECUTA_NP "carbuz02";
   |FINSI;

   |SI #camaniva#36 = "S";
       aAlfa1 =  "2400SFra. de REBU. Desea crear el Registro de la Operacion";
       |SI ModoEntrada = 2;
           aAlfa1 =  "2400SFra. de REBU. Desea modificar el Registro de la Operacion";
       |FINSI;
       |AVISO;
       |CONFI aAlfa1;
       |SI FSalida ! 0;  |ACABA; |FINSI;
       fec_am  = #camaniva#4;
       imp_am  = #camaniva#21;
       c_am    = #camaniva#22;
       nLib_am = #camaniva#0;
       aSer_am = #camaniva#2;
       nFra_am = #camaniva#3;
       enModAmor = ModoEntrada;
       nDoc_am = #camaniva#1;
       |SUB_EJECUTA_NP "carbuz02";
   |FINSI;
   aTipoIVA = #camaniva#36;
|FPRC;


|PROCESO Tipo3; |TIPO 3;
   nPulsoF9 = 0;
   |SI enErrCarte = 1; |VETE ElFinal; |FINSI; || PEPE

   |SI #camaniva#36 = "N";
       #camaniva#21 = #camaniva#19 + #camaniva#23 - #camaniva#26 - #camaniva#20;
   |SINO;
       #camaniva#21 = #camaniva#19 + #camaniva#23 - #camaniva#20;
   |FINSI;
   |PINTA #camaniva#21;

   aCtaDebe  = "";
   aCtaHaber = "";
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI enErrCarte ! 0; |Y enErrCarte ! 9;
       enErrCarte = 0;
       |VETE ElFinal;
   |FINSI;

   |SI SwNoMod = 1;  |VETE ElFinal; |FINSI;

   |SI enErrCarte = 9; |Y enSwDejar = 1; |Y ModoEntrada = 2;
      |HAZ EspecialMod;
      |VETE ElFinal;
   |FINSI;

   |SI #caivaasi#92 = "S"; |Y nSwHay17 = 0;
       en0W17 = #camaniva#7;
       ef1W17 = #camaniva#8;
       en2W17 = #camaniva#9;
       nSwHay17 = 1;
   |FINSI;
   |SI nSwHay17 = 1;  |HAZ VoyaW17; |FINSI;

   SinAsto = 0; swpcta  = 0; swpase = 0;

   #camaniva#35 = " ";
   |BUCLE BInversion;      || Mira si hay en la factura alguna base de inversion
                           ||  para marcarlo en el campo 35 de la factura;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI enErrCarte ! 9;
       |HAZ CreaVtos;
   |FINSI;
   #camaniva#36 = aTipoIVA;
   #camaniva#37 = "N";

   |SI nREBU = 1;
       |HAZ AbreRebu;
   |FINSI;

   |SI enEjercicio ] 2014; |Y #camaniva#36 ! "N";
       |HAZ EsCajaIva;
       eModoCaja  = ModoEntrada;
       eDevenCaja = 0;
       |HAZ eTrataClaveZ;
   |FINSI;

   nPrimer = 0;
   |ABRE #camaasic;
   |LEE 041#camaasic.p;
   |SI FSalida ! 0;
       nPrimer = 1;
   |FINSI;
   |CIERRA #camaasic;

   |SI nPrimer = 0;

       nDIARIO    = #camaniva#7;
       aFECHA     = #camaniva#8;
       nDOCUMENTO = #camaniva#9;
       |HAZ SwAgrupada;
       |SI ModoEntrada = 1; |Y enSwAgr = 1;
           |SI nSwAltaAhora = 0;
               enSwAgr = 2;
           |FINSI;
       |FINSI; ||ya existe este asto.
       |SI enSwAgr = 2; |Y nDOCUMENTO ! 0;
           |MENAV "    ATENCION !!!. El Asiento de este registro NO se MODIFICARA";
           |VETE ElFinal;
       |FINSI;
   |FINSI;

   |SI ModoEntrada = 1; |Y #camaniva#9 > 0; |Y aParam = "";
       |HAZ VeoOtraVezDoc;
   |FINSI;
   || ....              Borro el asiento  .. Por si existe
   ||                   Solo si es una factura
   |ABRE #camaasic;
   |ABRE #camaasil;
   |SI ModoEntrada = 2;
       swEstado = 2;
       |BUCLE BorraAsiento;
       nDLinea = 1; nHLinea = 9999;
       |HAZ ElGrupo_Bor;

       #camaasic#0 = #camaniva#7;
       #camaasic#1 = #camaniva#8;
       #camaasic#2 = #camaniva#9;
       |LEE 000#camaasic.=;
       |SI FSalida = 0;
           nDIARIO      = #camaasic#0;
           aFECHA       = #camaasic#1;
           nDOCUMENTO   = #camaasic#2;
           enPred       = #camaasic#7;
           |BORRA 020#camaasic.a;
       |FINSI;
   |FINSI;

   nDIARIO    = #camaniva#7;
   aFECHA     = #camaniva#8;
   nDOCUMENTO = #camaniva#9;

   |HAZ cabecera;
   NumApunte = 1;
   #camaniva#7 = nDIARIO;     |PINTA #camaniva#7;
   #camaniva#8 = aFECHA;      |PINTA #camaniva#8;
   #camaniva#9 = nDOCUMENTO;  |PINTA #camaniva#9;

   || Creo la linea del Total Factura

   |SI #camaniva#21 = 0; |Y #camaniva#36 = "N";
       NumApunte = -9;
       |VETE SinTotal;
   |FINSI;

   aSigAn = "";
   aSigno = "D";
   |SI aTipoIVA = "R";
       aSigno = "D";
   |SINO;
       aSigno = "H";
   |FINSI;
   |DDEFECTO #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #camaasil#3 = 1;   || NumApunte;    NumApunte = NumApunte + 10;
   |LEE 010#camaasil.=;
   |SI FSalida ! 0;
       |DDEFECTO #camaasil;
       #camaasil#0 = #camaasic#0;
       #camaasil#1 = #camaasic#1;
       #camaasil#2 = #camaasic#2;
       #camaasil#3 = 1;
       #camaasil#4 = #camaniva#12;
       enDiarioNivel = #camaasil#0;
       eaCuenta = #camaasil#4; |HAZ SacaNivel;
       #camaasil#5 = enNivel;
       #camaasil#6 = #camaniva#27;
       #camaasil#7 = #camaniva#28;
       #camaasil#8 = aSigno;
       #camaasil#19 = "F";
       #camaasil#20 = 0;
       #camaasil#24 = nREGISTRO;
       |GRABA 020#camaasil.b;
   |FINSI;

   importe = #camaniva#21;
   |HAZ adapta3;

   #camaasil#9 = #camaasil#9 + importe;
   aDep = #camaniva#10;
   aSub = #camaniva#11;

   |HAZ adapta1;
   |HAZ adapta2;

   |GRABA 020#camaasil.a;
   |LIBERA #camaasil;
   |HAZ Actualiza;

|ET SinTotal;
    nImporResta = 0;
    NumApunte = NumApunte + 10;

    nReserva = 0;
    |SI aTipoIVA ! "N";
        aTipo = "I"; |BUCLE CreaLineas;        || Creo las lineas del IVA
        aTipo = "R"; |BUCLE CreaLineas;        || Creo las lineas del Recargo
        |SI nSwIntra = 1; |Y #caivaasi#150 = "S"; |Y #camaniva#42 ! "I";
            |SI aTipoIVA = "R"; aTipoIVA = "S"; |SINO; aTipoIVA = "R"; |FINSI;
                nReserva = 1;
                aTipo = "I"; |BUCLE CreaLineas;        || Creo las lineas del IVA
                aTipo = "R"; |BUCLE CreaLineas;        || Creo las lineas del Recargo
            |SI aTipoIVA = "R"; aTipoIVA = "S"; |SINO; aTipoIVA = "R"; |FINSI;
        |SINO;
            |SI #camaniva#42 = "I"; |Y #caivaasi#151 = "S";
                |SI aTipoIVA = "R"; aTipoIVA = "S"; |SINO; aTipoIVA = "R"; |FINSI;
                    nReserva = 1;
                    aTipo = "I"; |BUCLE CreaLineas;        || Creo las lineas del IVA
                    aTipo = "R"; |BUCLE CreaLineas;        || Creo las lineas del Recargo
                |SI aTipoIVA = "R"; aTipoIVA = "S"; |SINO; aTipoIVA = "R"; |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
    nReserva = 0;
    aTipo = "B"; |BUCLE CreaLineas;        || Creo las lineas de las bases
    aTipo = "D"; |BUCLE CreaLineas;        || Creo las lineas de los descuentos
    aTipo = "P"; |BUCLE CreaLineas;        || Creo las lineas del IRPF

|SI nImporResta ! 0;
    #camaasil#0 = #camaasic#0;
    #camaasil#1 = #camaasic#1;
    #camaasil#2 = #camaasic#2;
    #camaasil#3 = 1;
    |LEE 010#camaasil.=;
    #camaasil#9 = #camaasil#9 - nImporResta;
    |GRABA 020#camaasil.a;
    |LIBERA #camaasil;

    importe = -nImporResta;
    |HAZ Actualiza;
|FINSI;

   |HAZ RecogeW17;

   |ABRE #dsmom030;
   |DDEFECTO #dsmom030;
   #dsmom030#0 = #camaniva#27;
   |LEE 041#dsmom030.=;
   |CIERRA #dsmom030;
   |HAZ Tipo349;

   |SI #camaniva#36 ! "N"; |Y nSwIntra = 1;
        |HAZ LaIntra;
   |SINO;
       |SI #camaniva#42 = "D"; |O #camaniva#21 < 0;
           |HAZ TrataRecti;
       |SINO;
           #camaniva#45 = "";
       |FINSI;
   |FINSI;
   |SI ModoEntrada = 2;
       |SI nSwIntra = 0; |Y #camaniva#36 ! "N"; |HAZ LaIntra; |FINSI;
   |FINSI;

   |CIERRA #camaasil;
   |LIBERA #camaasic;
   |CIERRA #camaasic;
   |HAZ Grupo_Recarga1;

   |HAZ NoAsiento0;

|ET ElFinal;
   enPred        = 0;
   nSwIntra      = 0;
   aAntesDes0    = "";
   aAntesDes1    = "";
   nAnterior27   = 0;
   nAnterior     = 0;
   nAnteriorIRPF = 0;
   nSwHay17      = 0;
   SwNoMod       = 0;
   dTiva         = nCGuarda;
   enSwDejar     = 0;
   enTipoAsto    = 0;
   swAmor        = 0;
   swInve        = 0;
   swAmorC       = 0;
   nREBU         = 0;
   nIva          = 0;
   nFacOrig      = 0;
   aSerOrig      = "";
   enErrCarte    = 0;
   enSwCaja      = 0;
   eSwCambio     = 0;
   nSwAltaAhora  = 0;
   |DELINDEX #212;
   |DELINDEX #213;
   |DELINDEX #100;

   eaSerie = "";
   NumFactura = 0;
   |HAZ ActCamaasiv;
|FPRC;

|PROCESO LaIntra;
  enIn03     = 0;
  enLibro    = #camaniva#0;
  enRegistro = #camaniva#1;
  eaSerie    = #camaniva#2;
  enFactura  = #camaniva#3;

  |SI enEjercicio [ 2009;
      |SI eaPer349 = #caivaasi#46;
          enPerIntra = #camaniva#5;
      |SINO;
          Comodin    = #camaniva#4; |QBF Comodin;
          Comodin    = Comodin % 0402;
          enPerIntra = Comodin;
          |SI eaPer349  = "T";
              |SI Comodin ] "01"; |Y Comodin [ "03"; enPerIntra = 1; |FINSI;
              |SI Comodin ] "04"; |Y Comodin [ "06"; enPerIntra = 2; |FINSI;
              |SI Comodin ] "07"; |Y Comodin [ "09"; enPerIntra = 3; |FINSI;
              |SI Comodin ] "10"; |Y Comodin [ "12"; enPerIntra = 4; |FINSI;
          |FINSI;
      |FINSI;
  |SINO;
      enPerIntra = #camaniva#5;
      || falta mirar
  |FINSI;

  |SI #camaniva#21 < 0; |Y nSwIntra = 1;
      |HAZ AltaIntra;
  |SINO;
      |HAZ BajaIntra;
  |FINSI;
|FPRC;

|PROCESO TrataRecti;

    |SI #camaniva#42 ! "D"; |Y ModoEntrada = 1;
        |CONFI "    NImporte Negativo y Clave 340 diferente a <D>. Es una Factura Rectificativa ?";
        |SI FSalida = 0;
            #camaniva#42 = "D"; |PINTA #camaniva#42;
            enConcepto = #camaniva#27;
            |HAZ VeoRecti;
            |SI nSwRecti = 1;
                |MENAV "0000Repase los Conceptos de este Factura";
            |FINSI;
        |FINSI;
    |FINSI;

    |SI #camaniva#42 = "D"; |Y aTipoIVA = "R";
        |PUSHV 0501 2380;
        |BLANCO 1202 2379;
        |CUADRO 1202 2379;
        |PINTA 1318, "CLAVE DEL 340 DE FACTURA RECTIFICATIVA";
        |PINTA 1514, "Introduzca el numero de la factura rectificada";

        aAlfa = #camaniva#45;
        E_inf = "";
        E_sup = "40";
        aAlfa = 1716 ? 1;
        #camaniva#45 = aAlfa;

        |POPV;
    |FINSI;
|FPRC;


|PROCESO T30ManIVA; |TIPO 30;
  enLibro    = #camaniva#0;
  enRegistro = #camaniva#1;
  || ... NO solo en predefinidos |HAZ eRSChequeo;
  raf_nif = "";
|FPRC;

|PROCESO EspecialMod;
   nDIARIO    = #camaniva#7;
   aFECHA     = #camaniva#8;
   nDOCUMENTO = #camaniva#9;

   |ABRE #camaasic;
   #camaasic#0 = #camaniva#7;
   #camaasic#1 = #camaniva#8;
   #camaasic#2 = #camaniva#9;
   |LEE 001#camaasic.=;
   |SI FSalida = 0;
       enPred     = #camaasic#7;
       enTipoAsto = #camaasic#13;
   |FINSI;

   aTipo = "B"; |BUCLE CreaLineas;        || Creo las lineas de las bases
   |LIBERA #camaasic;
   |CIERRA #camaasic;
   |HAZ Grupo_Recarga1;
|FPRC;

|| .... los 0 no
|PROCESO LeeApuntea0;
 |SI #camaasil#9 = 0;
     |BORRA 020#camaasil.a;
 |SINO;
     nSi = 1;
     |ERROR10;
 |FINSI;
 |LIBERA #camaasil;
|FPRC;

|DEFBUCLE LeeApuntea0;
 #camaasil#1;
 ;
 #camaniva#7,#camaniva#8,#camaniva#9,0001;
 #camaniva#7,#camaniva#8,#camaniva#9,9999;
 be;
 NULL, LeeApuntea0;
|FIN;

|PROCESO NoAsiento0;
 |SI aElCero = "S"; |ACABA; |FINSI;

 nSi = 0;
 |BUCLE LeeApuntea0;
 |SI nSi = 0;
     |ABRE #camaasic;
     #camaasic#0 = #camaniva#7;
     #camaasic#1 = #camaniva#8;
     #camaasic#2 = #camaniva#9;
     |LEE 101#camaasic.=;
     |SI FSalida = 0;
         |BORRA 020#camaasic.a;
     |FINSI;
     |LIBERA #camaasic;
     |CIERRA #camaasic;
     #camaniva#9 = 0;
 |FINSI;
|FPRC;

|| ------------------------------------------------------------------
|| ------------------------------------------------------------------
|PROCESO NumDoc;
   |SALVA_DATOS #camaniva;
   nLibro = #camaniva#0;
   #camaniva#0 = nLibro;
   #camaniva#1 = 9999999999;
   |LEE 010#0];
   |SI FSalida = 0;
       |LEE 040#0a;
   |SINO;
       |LEE 040#0u;
   |FINSI;

   NumDoc = 1;
   |SI FSalida = 0; |Y #0#0 = nLibro;
       NumDoc = #camaniva#1 + 1;
   |FINSI;

   |REPON_DATOS #camaniva;
   #camaniva#1 = NumDoc; |PINTA #camaniva#1;
|FPRC;

|CALCULO BuscaDoc; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada ! 1;
      |MENSA "    <F2> Busqueda por serie+factura";
      |ACABA;
   |FINSI;

   |HAZ NumDoc;
|FCAL;

|CALCULO MiraDoc;  |TIPO 0;
   nMiraDoc = 0;
   |PINTA 0420, "                                       ";
   |SI FSalida = 10; |Y Modo ! 1;
      nMiraDoc = 1;
      |SELECT #3#camaniva;

      |ENCAMPO #2#camaniva;
      |SI FSalida ! 0;
         nMiraDoc = 0;
         |ERROR;
         |ACABA;
      |FINSI;
      |ENCAMPO #3#camaniva;
      |SI FSalida ! 0;
          nMiraDoc = 0;
          |ERROR;
          |ACABA;
      |FINSI;
      |LEE 000#camaniva.];
      NumDoc = #camaniva#1;
      |SELECT #1#camaniva;
      #camaniva#1 = NumDoc;
      |LEE 000#camaniva.=; |PINDA #0#camaniva;
      |HAZ Mensaje;
      |ENTLINEAL #1#caivalin, -3, 7, 22,1,inf,sup;
      |HAZ Mensaje;
      nMiraDoc = 0;
      |ERROR;
      |ACABA;
   |FINSI;

   |SI Modo = 1; |Y FSalida ! 2;
      |SALVA_FICHA #camaniva;
      |LEE 010#camaniva.=;
      |SI FSalida = 0;
         |MENAV "    Factura Existente";
         |ERROR;
      |FINSI;
      |REPON_FICHA #camaniva;
   |FINSI;
   ModoEntrada = (FEntrada / 100) ! 0;
   SerieAnt = "  XX";
   FactuAnt = 0;
   |SI ModoEntrada = 2;
       SerieAnt = #camaniva#2; ||    gestion y si es asi, no dejo modificar ....
       FactuAnt = #camaniva#3;
   |FINSI;
|FCAL;

||------------------------------------------------------------------
|CALCULO AntesSerie; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1;
       #camaniva#2 = dSerie;
       |PINTA #camaniva#2;
   |SINO;
       |SI ModoEntrada = 2;
           SerieAnt = #camaniva#2;
       |FINSI;
   |FINSI;
   aAlfa = "    Pulse <F4> para imprimir Autofactura Intracomunitaria";
   |HAZ EsCajaIva;
   |SI enSwCaja = 1;
       aAlfa = "    Pulse <F4> imprimir Autofra.Intracomunitaria, <F9> Consulta Cobros/Pagos";
   |FINSI;
   |MENSA aAlfa;
|FCAL;

|CALCULO ParaImp; |TIPO 0;
  |BLIN 4;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI FSalida = 12;
       |SI ModoEntrada = 2; |O ModoEntrada = 4;
           |HAZ Autofactura;
       |FINSI;
   |FINSI;
   |SI FSalida = 17;
       |SI ModoEntrada = 2; |O ModoEntrada = 4;
           |SI enSwCaja  = 1;
               eModoCaja  = 4;
               eDevenCaja = 0;
               |HAZ eTrataClaveZ;
           |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO TrasSerie; |TIPO 0;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1; |Y #camaniva#2 ! Contenido;
       swpase = 0;
   |FINSI;
   |SI nMiraDoc = 0;
       |HAZ ParaImp;
   |FINSI;
|FCAL;

|CALCULO AntesFactura;  |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1; |Y swpase = 0;
       |HAZ BuscaNumero;
       swpase = 1;
       #camaniva#3 = NumFactura;
       |PINTA #camaniva#3;
   |SINO;
       |SI ModoEntrada = 2; |Y nMiraDoc = 0;
           FactuAnt    = #camaniva#3;
           nAnterior27 = #camaniva#27;
       |FINSI;
   |FINSI;
   |C_M #camaniva#3,1,"S";
   |SI #caivaasi#25 = "N";
       |C_M #camaniva#3,1,"N";
   |FINSI;
   aAlfa = "    Pulse <F4> para imprimir Autofactura Intracomunitaria";
   |SI enSwCaja = 1;
       aAlfa = "    Pulse <F4> imprimir Autofra.Intracomunitaria, <F9> Consulta Cobros/Pagos";
   |FINSI;
   |MENSA aAlfa;
|FCAL;

|PROCESO ActCamaasiv;
   |ABRE #220;
   #220#6 = #camaniva#0;
   #220#7 = aUsu;
   |LEE 101#220=;
   |SI FSalida ! 0;
       |DDEFECTO #220;
       #220#3 = #camaniva#36;
       #220#6 = #camaniva#0;
       #220#7 = aUsu;
       |GRABA 020#220b;
   |FINSI;
   #220#0 = NumFactura;
   #220#1 = eaSerie;
   |GRABA 020#220a;
   |LIBERA #220;
   |CIERRA #220;
|FPRC;

|PROCESO MiroCamaasiv;
 |SI #220#7 ! aUsu;
     |SI #camaniva#2 = #220#1; |Y #camaniva#3 = #220#0;
         nExiste = 1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE MiroCamaasiv;
 #220#1;
 ;
 "        ", #camaniva#0;
 "zzzzzzzz", #camaniva#0;
 ;
 NULL, MiroCamaasiv;
|FIN;

|PROCESO BorroCamaasiv;
 |BORRA 020#220a;
 |LIBERA #220;
|FPRC;

|DEFBUCLE BorroCamaasiv;
 #220#1;
 ;
 aUsu, 00;
 aUsu, 99;
 ;
 NULL, BorroCamaasiv;
|FIN;

|CALCULO TrasFactura;  |TIPO 0;
   |BLIN 4;
   ModoEntrada = (FEntrada / 100) ! 0;

   |SI nMiraDoc = 1;  |ACABA; |FINSI;

   |SI FSalida = 12;
       |SI ModoEntrada = 2; |O ModoEntrada = 4;
           |HAZ Autofactura;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI FSalida = 17;
       |SI ModoEntrada = 2; |O ModoEntrada = 4;
           |SI enSwCaja  = 1;
               eModoCaja  = 4;
               eDevenCaja = 0;
               |HAZ eTrataClaveZ;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI ModoEntrada = 2;
       |SI #camaniva#2 = SerieAnt; |Y #camaniva#3 = FactuAnt;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI ModoEntrada ! 1; |Y ModoEntrada ! 2; |ACABA; |FINSI;

   nAhora1 =  #camaniva#0;
   nAhora2 =  #camaniva#1;
   |SALVA_FICHA #camaniva;
   |SELECT #3#camaniva;
   |LEE 010#camaniva.=;
   |SI FSalida = 0;
       |SI nAhora1 ! #camaniva#0; |O nAhora2 ! #camaniva#1;
           |MENAV "    Factura Existente";
           |ERROR;
           |SELECT #1#camaniva;
           |REPON_FICHA #camaniva;
           |ACABA;
       |FINSI;
   |FINSI;

   |SELECT #1#camaniva;
   |REPON_FICHA #camaniva;

   |SI ModoEntrada ! 1; |ACABA; |FINSI;

   nExiste = 0;
   |SI #camaniva#36 ! "N";
       |BUCLE MiroCamaasiv;
       |SI nExiste = 1;
           |MENAV "0400La Factura ya existe";
           |ERROR;
           |ACABA;
       |FINSI;

       eaSerie = #camaniva#2;
       |HAZ ActCamaasiv;
   |FINSI;

   |SI #camaniva#3 ! NumFactura;
       |HAZ DescuentaCont;
   |FINSI;

   aTipoIVA = #calibros#2;
   |SI FechaAnt > " "; #camaniva#4 = FechaAnt; |PINTA #camaniva#4; |FINSI;
   |SI #caivaasi#168 ! "A";
       |HAZ DefPeriodo;
       #camaniva#5 = Comodin; |PINTA #camaniva#5;
   |FINSI;
   #camaniva#27  = dConc1;         |PINTA #camaniva#027;
   #camaniva#28  = dDesc1;         |PINTA #camaniva#028;
   #camaniva#29  = dConc2;         |PINTA #camaniva#029;
   #camaniva#30  = dDesc2;         |PINTA #camaniva#030;
   #camaniva#42  = eDCl340;        |PINTA #camaniva#042;

||   #camaniva#39 = #caivaasi#48; ||  |PINTA #camaniva#39;

|SI #camaniva#36 ! "N";
   #camaniva#10 = #caivaasi#19;   |PINTA #camaniva#10;  ||Departa
   #camaniva#11 = #caivaasi#67;   |PINTA #camaniva#11;  ||Subdep
|SINO;
   #camaniva#10 = #cadeflab#22;   |PINTA #camaniva#10;  ||Departa
   #camaniva#11 = #cadeflab#57;   |PINTA #camaniva#11;  ||Subdep
|FINSI;

   |SI a_Param ! "";
       #camaniva#7 = nDiario;    |PINTA #camaniva#7;
       #camaniva#8 = fFecha;     |PINTA #camaniva#8;
       #camaniva#9 = nDocumento; |PINTA #camaniva#9;
       #camaniva#4 = fFecha;     |PINTA #camaniva#4;
   |FINSI;
   nAnterior27 = #camaniva#27;
|FCAL;

|| ---------------------------------------------------------
|CALCULO AntesEnglo; |TIPO 7;
  aAlfa1 = #caivaasi#126;
  |C_M #camaniva#38, 1, aAlfa1;
  |SI aAlfa1 = "N"; #camaniva#38 = 1; |PINTA #camaniva#38; |FINSI;
|FCAL;

|CALCULO TrasFecha; |TIPO 0;
 |C_M #camaniva#8,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #camaniva#8 < fec1; |O #camaniva#8 > fec2;
     |MENAV "    Fecha Erronea";
     |ERROR;
     |ACABA;
 |FINSI;

 ModoEntrada = (FEntrada / 100) ! 0;
 |SI Modo = 0; |Y ModoEntrada = 1;
     |SI #camaniva#8 [ fec3;
         |MENAV mensa2;
         |ERROR;
     |SINO;
         #camaniva#4 = #camaniva#8; |PINTA #camaniva#4;
         |HAZ NuevoDoc;
         #camaniva#9 = nDOCUMENTO; |PINTA #camaniva#9;
     |FINSI;
 |FINSI;

 |SI #caivaasi#168 = "A";
     |HAZ DefPeriodo;
     #camaniva#5 = Comodin; |PINTA #camaniva#5;
 |FINSI;
|FCAL;

|CALCULO AntesDiario; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 1;
       |C_M #camaniva#7,1,aMod9;
       |C_M #camaniva#8,1,aMod9;
       |C_M #camaniva#9,1,aMod9;
   |SINO;
       |C_M #camaniva#7,1,"N";
       |C_M #camaniva#8,1,"N";
       |C_M #camaniva#9,1,"N";
       |SI #camaniva#9 = 0;
           |C_M #camaniva#9,1,"S";
       |FINSI;
   |FINSI;
   aAlfa = "    Pulse <F4> para imprimir Autofactura Intracomunitaria";
   |SI enSwCaja = 1;
       aAlfa = "    Pulse <F4> imprimir Autofra.Intracomunitaria, <F9> Consulta Cobros/Pagos";
   |FINSI;
   |MENSA aAlfa;
|FCAL;

|CALCULO AntDocumento; |TIPO 7;
   |C_M #camaniva#9,0,aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI eaPaDOM1 = "S"; |Y ModoEntrada = 1;
       |C_M #0#9,1, "N";
   |FINSI;
   aAlfa = "    Pulse <F4> para imprimir Autofactura Intracomunitaria";
   |SI enSwCaja = 1;
       aAlfa = "    Pulse <F4> imprimir Autofra.Intracomunitaria, <F9> Consulta Cobros/Pagos";
   |FINSI;
   |MENSA aAlfa;
|FCAL;

|CALCULO TrasDocumento; |TIPO 0;
 |C_M #camaniva#9,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |BLIN 4;
 ModoEntrada = (FEntrada / 100) ! 0;
 |SI #camaniva#9 = 0;
     |SI Modo = 0; |Y ModoEntrada = 1;
         |ERROR;
     |SINO;
         |SI #camaniva#21 !  0; |ERROR; |FINSI;
     |FINSI;
 |FINSI;

 |SI #camaniva#9 ! 0;
     nExiste = 0;
     |ABRE #camaasic;
     #camaasic#0 = #camaniva#7;
     #camaasic#1 = #camaniva#8;
     #camaasic#2 = #camaniva#9;
     |LEE 041#camaasic.=;
     |SI FSalida = 0;
         |MENAV "    Error. El Asiento YA existe ...";
         nExiste = 1;
         |ERROR;
     |SINO;
         |SELECT #3#camaasic;
         #camaasic#2 = #camaniva#9;
         |LEE 041#camaasic.=;
         |SI FSalida = 0;
             |CONFI "    NAtencion, Ya existe numero de Documento. Continuar";
             |SI FSalida ! 0;
                 nExiste = 1;
                 |ERROR;
             |FINSI;
         |FINSI;
         |SELECT #1#camaasic;
     |FINSI;

     |CIERRA #camaasic;
 |FINSI;
|FCAL;

|PROCESO DefPeriodo;
   |SI aTipoIVA ! "N"; nNume1 = 46; |SINO; nNume1 = 149; |FINSI;
   Comodin = #camaniva#4;
   |SI #caivaasi#168 = "A"; Comodin = #camaniva#8; |FINSI;
   |QBF Comodin;
   Comodin = Comodin % 0402;
   |SI enEjercicio [ 2009;
       |SI #caivaasi#nNume1# = "T";
           |SI Comodin ] "01"; |Y Comodin [ "03"; Comodin = "01"; |FINSI;
           |SI Comodin ] "04"; |Y Comodin [ "06"; Comodin = "02"; |FINSI;
           |SI Comodin ] "07"; |Y Comodin [ "09"; Comodin = "03"; |FINSI;
           |SI Comodin ] "10"; |Y Comodin [ "12"; Comodin = "04"; |FINSI;
       |SINO;
           |SI #caivaasi#nNume1# = "A"; Comodin = "00"; |FINSI;
       |FINSI;
  |FINSI;
|FPRC;

|CALCULO CalcPeriodo;  |TIPO 0;
   fDFecha = fec1;
   |SI enSwSelFc = 1; fDFecha = "01.01.0000"; |FINSI;
   |SI #camaniva#Campo# < fDFecha; |O #camaniva#Campo# > fec2;
       |MENAV "    Error. Fecha Incorrecta";
       |ERROR;
       |ACABA;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI Modo = 0; |Y ModoEntrada = 1;
       || ..   #camaniva#8 = #camaniva#4; |PINTA #camaniva#8;
   |FINSI;

   |SI #camaniva#Campo# [ fec3;
       |MENAV mensa4;
   |FINSI;

   |HAZ DefPeriodo;
   fFecha = Contenido;
   |SI fFecha ! #camaniva#4; |Y #caivaasi#168 ! "A";
       #camaniva#5 = Comodin;
       |PINTA #camaniva#5;
   |FINSI;
   FechaAnt = #camaniva#4;
|FCAL;

|CALCULO Liq303;
  |C_M #camaniva#5,0,aAlfa1;
  |SI FSalida = 2; |ACABA; |FINSI;

  |SI #camaniva#36 ! "N";
      ModoEntrada = (FEntrada / 100) ! 0;
      |SI enSi303 = 1; |Y #caivaasi#167 ! "X"; |Y ModoEntrada = 1;
          eSwReten = 0;
          enPanMod = 0;
          enPerMod = #camaniva#5;
          |HAZ ConsulModIVA;
          |SI enEmiMod = 1; |Y #caivaasi#167 ! "S";
              |SI aAlfa1 = "N";
                  |C_M #camaniva#5,1,"S";
                  |PTEC 808;
              |SINO;
                  |ERROR;
              |FINSI;
          |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntFOp; |TIPO 0;
 inkey = FSalida;
 |C_M #camaniva#41, 1, "N";
 |SI aTipoIVA ! "R"; |Y aTipoIVA ! "S"; |ACABA; |FINSI;

 |SI inkey = 10; |O #camaniva#41 ! "01.01.0000";
     |C_M #camaniva#41, 1, "S";
 |FINSI;
|FCAL;

|CALCULO FechaOpe; |TIPO 7;
 |C_M #camaniva#41,0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #camaniva#41 = "01.01.0000";
     #camaniva#41 = #camaniva#4; |PINTA #camaniva#41;
 |FINSI;
|FCAL;

|PROCESO Tipo7C42;  |TIPO 7;
   |SI enEjercicio > 2011;
       aAlfa1 = "<*> No se pasa al 340.";
   |SINO;
       aAlfa1 = "<X> No se pasa al 340.";
   |FINSI;
   aAlfa1 = "    <F11> para consultar Tipo Operaciones Mod. 340." + aAlfa1;
   |MENSA aAlfa1;
|FPRC;

|PROCESO Tipo66C42;  |TIPO 66;
     |C_M #camaniva#42,0,aAlfa1;
     |SI aAlfa1 = "N"; |ACABA; |FINSI;
     |SI aTipoIVA ! "R"; |Y aTipoIVA ! "S"; |ACABA; |FINSI;

     aAlfa = "|C042WID";
     aID   = #camaniva#aAlfa#;
     nID   = aID;

     aPopup1  = nID;  || Si fuera -1 en la posicion
     |SI aTipoIVA = "S";
         |SI enEjercicio [ 2011;
             aPopup2  = 14;
         |SINO;
             aPopup2  = 18;
             |SI enEjercicio ] 2014;
                 aPopup2  = 27;
             |FINSI;
         |FINSI;
         aPopup3  = "  Operación habitual";
         aPopup4  = "A Asiento resumen de facturas";
         aPopup5  = "B Asiento resumen de tiques";
         aPopup6  = "C Factura con varios asientos (varios tipo impositivos)";
         aPopup7  = "D Factura rectificativa";
         aPopup8  = "F Adquisiciones realizadas por las agencias de viajes directamente en interés del viajero ";
         aPopup9  = "G Régimen especial de grupo de entidades en IVA o IGIC";
         aPopup10 = "H Régimen especial de oro de inversión";
         aPopup11 = "I Inversión del Sujeto pasivo (ISP)";
         aPopup12 = "J Tiques";
         aPopup13 = "K Rectificación anotaciones registrales";
         aPopup14 = "L Adquisiciones a comerciantes minoristas del IGIC";
         aPopup15 = "P Adquisiciones intracomunitarias de bienes.";
         aPopup16 = "Q Operaciones a las que se aplique el régimen especial de bienes usados, ...";
         |SI enEjercicio > 2011;
             aPopup17 = "R Operación de arrendamiento de local de negocio.";
             aPopup18 = "S Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas.";
             aPopup19 = "W Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla.";
             aPopup20 = "X Operaciones por las que los empresarios o profesionales que satisfagan compensaciones agrícolas hayan expedido el recibo";
             |SI enEjercicio ] 2014;
                 aPopup21 = "Z Operaciones en Régimen especial de criterio de caja";
                 aPopup22 = "1 IVA criterio de caja. Asiento resumen de facturas";
                 aPopup23 = "2 IVA criterio de caja. Factura con varios asientos";
                 aPopup24 = "3 IVA criterio de caja. Factura rectificativa";
                 aPopup25 = "4 IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes en interés del viajero";
                 aPopup26 = "5 IVA criterio de caja. Factura simplificada";
                 aPopup27 = "6 IVA criterio de caja. Rectificación de errores registrales";
                 aPopup28 = "7 IVA criterio de caja. Facturación de las prestaciones de servicios de agencias de viajes";
                 aPopup29 = "8 IVA criterio de caja. Operación de arrendamiento de local de negocio";
             |FINSI;
         |FINSI;
     |SINO;
         aPopup1  = nID;  || Si fuera -1 en la posicion
         |SI enEjercicio [ 2011;
             aPopup2  = 15;
         |SINO;
             aPopup2  = 21;
             |SI enEjercicio ] 2014;
                 aPopup2  = 30;
             |FINSI;
         |FINSI;
         aPopup3  = "  Operación habitual";
         aPopup4  = "A Asiento resumen de facturas";
         aPopup5  = "B Asiento resumen de tiques";
         aPopup6  = "C Factura con varios asientos (varios tipo impositivos)";
         aPopup7  = "D Factura rectificativa";
         aPopup8  = "E IVA devengado pendiente de emitir factura";
         aPopup9  = "G Régimen especial de grupo de entidades en IVA o IGIC";
         aPopup10 = "H Régimen especial de oro de inversión";
         aPopup11 = "I Inversión del Sujeto pasivo (ISP)";
         aPopup12 = "J Tiques";
         aPopup13 = "K Rectificación anotaciones registrales";
         aPopup14 = "M IVA facturado pendiente de devengar (emitida factura)";
         aPopup15 = "N Facturación de las prestaciones de servicios de agencias de viaje que actúan como mediadoras en nombre y por cuenta ajena";
         aPopup16 = "O Factura emitida en sustitución de tiques facturados y declarados.";
         aPopup17 = "Q Operaciones a las que se aplique el régimen especial de bienes usados, ...";
         |SI enEjercicio > 2011;
             aPopup18 = "R Operación de arrendamiento de local de negocio.";
             aPopup19 = "S Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas.";
             aPopup20 = "T Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ...";
             aPopup21 = "U Operación de seguros.";
             aPopup22 = "V Compras de Agencias viajes: operaciones de prestación de servicios de mediación en nombre y por cuenta ajena relativos ...";
             aPopup23 = "W Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla.";
             |SI enEjercicio ] 2014;
                 aPopup24 = "Z Operaciones en Régimen especial de criterio de caja";
                 aPopup25 = "1 IVA criterio de caja. Asiento resumen de facturas";
                 aPopup26 = "2 IVA criterio de caja. Factura con varios asientos";
                 aPopup27 = "3 IVA criterio de caja. Factura rectificativa";
                 aPopup28 = "4 IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes en interés del viajero";
                 aPopup29 = "5 IVA criterio de caja. Factura simplificada";
                 aPopup30 = "6 IVA criterio de caja. Rectificación de errores registrales";
                 aPopup31 = "7 IVA criterio de caja. Facturación de las prestaciones de servicios de agencias de viajes";
                 aPopup32 = "8 IVA criterio de caja. Operación de arrendamiento de local de negocio";
             |FINSI;
         |FINSI;
     |FINSI;

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida ! 0;
         IaPopup  = aPopup3  <-;
         IaPopup  = IaPopup + (FSalida - 1);

         aAlfa = aPopup % 101;  #camaniva#42 = aAlfa;
     |FINSI;

     |PINTA #camaniva#42;
|FPRC;

|CALCULO TOp340; |TIPO 0;
     |C_M #camaniva#42,0,aAlfa1;
     |SI aTipoIVA ! "R"; |Y aTipoIVA ! "S"; |ACABA; |FINSI;

     |BLIN 4;
     aTexto = "";
     |SI #camaniva#42 = " "; aTexto = "Operaci¢n habitual"; |FINSI;
     |SI #camaniva#42 = "A"; aTexto = "Asiento resumen de facturas"; |FINSI;
     |SI #camaniva#42 = "B"; aTexto = "Asiento resumen de tiques"; |FINSI;
     |SI aTipoIVA = "R";
         |SI #camaniva#42 = "C"; aTexto = "Factura con varios asientos (varios tipo impositivos)"; |FINSI;
         |SI #camaniva#42 = "D"; aTexto = "Factura rectificativa"; |FINSI;
         |SI #camaniva#42 = "E"; aTexto = "IVA devengado pendiente de emitir factura"; |FINSI;
         |SI #camaniva#42 = "G"; aTexto = "Rgimen especial de grupo de entidades en IVA o IGIC"; |FINSI;
         |SI #camaniva#42 = "H"; aTexto = "Rgimen especial de oro de inversi¢n"; |FINSI;
         |SI #camaniva#42 = "I"; aTexto = "Inversi¢n del Sujeto pasivo (ISP)";|FINSI;
         |SI #camaniva#42 = "J"; aTexto = "Tiques"; |FINSI;
         |SI #camaniva#42 = "K"; aTexto = "Rectificación anotaciones registrales"; |FINSI;
         |SI #camaniva#42 = "M"; aTexto = "IVA facturado pendiente de devengar (emitida factura)"; |FINSI;
         |SI #camaniva#42 = "N"; aTexto = "Facturaci¢n de las prestaciones de servicios de agencias de viaje que actúan como mediadoras en nombre y por cuenta ajena"; |FINSI;
         |SI #camaniva#42 = "O"; aTexto = "Factura emitida en sustituci¢n de tiques facturados y declarados."; |FINSI;
         |SI #camaniva#42 = "Q"; aTexto = "Operaciones a las que se aplique el rgimen especial de bienes usados, ..."; |FINSI;
         |SI enEjercicio > 2011;
             |SI #camaniva#42 = "R"; aTexto = "Operaci¢n de arrendamiento de local de negocio."; |FINSI;
             |SI #camaniva#42 = "S"; aTexto = "Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas."; |FINSI;
             |SI #camaniva#42 = "T"; aTexto = "Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados ..."; |FINSI;
             |SI #camaniva#42 = "U"; aTexto = "Operación de seguros."; |FINSI;
             |SI #camaniva#42 = "V"; aTexto = "Compras de Agencias viajes: operaciones de prestación de servicios de mediación en nombre y por cuenta ajena relativos ..."; |FINSI;
             |SI #camaniva#42 = "W"; aTexto = "Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla."; |FINSI;
             |SI enEjercicio ] 2014;
                 |SI #camaniva#42 = "Z"; aTexto = "Operaciones en Régimen especial de criterio de caja"; |FINSI;
                 |SI #camaniva#42 = "1"; aTexto = "IVA criterio de caja. Asiento resumen de facturas"; |FINSI;
                 |SI #camaniva#42 = "2"; aTexto = "IVA criterio de caja. Factura con varios asientos"; |FINSI;
                 |SI #camaniva#42 = "3"; aTexto = "IVA criterio de caja. Factura rectificativa"; |FINSI;
                 |SI #camaniva#42 = "4"; aTexto = "IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes"; |FINSI;
                 |SI #camaniva#42 = "5"; aTexto = "IVA criterio de caja. Factura simplificada"; |FINSI;
                 |SI #camaniva#42 = "6"; aTexto = "IVA criterio de caja. Rectificaci¢n de errores registrales"; |FINSI;
                 |SI #camaniva#42 = "7"; aTexto = "IVA criterio de caja. Facturaci¢n de las prestaciones servicios agencias viajes"; |FINSI;
                 |SI #camaniva#42 = "8"; aTexto = "IVA criterio de caja. Operaci¢n de arrendamiento de local de negocio"; |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         |SI #camaniva#42 = "C"; aTexto = "Factura con varios asientos (varios tipo impositivos)"; |FINSI;
         |SI #camaniva#42 = "D"; aTexto = "Factura rectificativa";|FINSI;
         |SI #camaniva#42 = "F"; aTexto = "Adquisiciones realizadas por las agencias de viajes directamente en inters del viajero";|FINSI;
         |SI #camaniva#42 = "G"; aTexto = "Rgimen especial de grupo de entidades en IVA o IGIC"; |FINSI;
         |SI #camaniva#42 = "H"; aTexto = "Rgimen especial de oro de inversi¢n"; |FINSI;
         |SI #camaniva#42 = "I"; aTexto = "Inversi¢n del Sujeto pasivo (ISP)"; |FINSI;
         |SI #camaniva#42 = "J"; aTexto = "Tiques"; |FINSI;
         |SI #camaniva#42 = "K"; aTexto = "Rectificación anotaciones registrales"; |FINSI;
         |SI #camaniva#42 = "L"; aTexto = "Adquisiciones a comerciantes minoristas del IGIC"; |FINSI;
         |SI #camaniva#42 = "P"; aTexto = "Adquisiciones intracomunitarias de bienes."; |FINSI;
         |SI #camaniva#42 = "Q"; aTexto = "Operaciones a las que se aplique el rgimen especial de bienes usados, ..."; |FINSI;
         |SI enEjercicio > 2011;
             |SI #camaniva#42 = "R"; aTexto = "Operaci¢n de arrendamiento de local de negocio."; |FINSI;
             |SI #camaniva#42 = "S"; aTexto = "Subvenciones, auxilios o ayudas satisfechas o recibidas, tanto por parte de Administraciones públicas o entidades privadas."; |FINSI;
             |SI #camaniva#42 = "W"; aTexto = "Operaciones sujetas al Impuesto sobre la Producción, los Servicios y la Importación en las Ciudades de Ceuta y Melilla."; |FINSI;
             |SI #camaniva#42 = "X"; aTexto = "Operaciones por las que los empresarios o profesionales que satisfagan compensaciones agrícolas hayan expedido el recibo"; |FINSI;
             |SI enEjercicio ] 2014;
                 |SI #camaniva#42 = "Z"; aTexto = "Operaciones en Régimen especial de criterio de caja"; |FINSI;
                 |SI #camaniva#42 = "1"; aTexto = "IVA criterio de caja. Asiento resumen de facturas"; |FINSI;
                 |SI #camaniva#42 = "2"; aTexto = "IVA criterio de caja. Factura con varios asientos"; |FINSI;
                 |SI #camaniva#42 = "3"; aTexto = "IVA criterio de caja. Factura rectificativa";|FINSI;
                 |SI #camaniva#42 = "4"; aTexto = "IVA criterio de caja. Adqusiciones realizadas por las agencias de viajes"; |FINSI;
                 |SI #camaniva#42 = "5"; aTexto = "IVA criterio de caja. Factura simplificada"; |FINSI;
                 |SI #camaniva#42 = "6"; aTexto = "IVA criterio de caja. Rectificaci¢n de errores registrales"; |FINSI;
                 |SI #camaniva#42 = "7"; aTexto = "IVA criterio de caja. Facturaci¢n de las prestaciones servicios agencias viajes"; |FINSI;
                 |SI #camaniva#42 = "8"; aTexto = "IVA criterio de caja. Operaci¢n de arrendamiento de local de negocio"; |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #camaniva#42 = "C"; aTexto = ""; |FINSI; || no puede elegir C, es automatico
     |SI enEjercicio [ 2011;
         |SI #camaniva#42 = "X"; aTexto = "No pasa al 340"; |FINSI;
     |SINO;
         |SI #camaniva#42 = "*"; aTexto = "No pasa al 340"; |FINSI;
     |FINSI;

     |SI aTexto = "";
         |MENAV "0000 Clave de operaci¢n incorrecta";
         |ERROR;
         |ACABA;
     |FINSI;

     || |PINTA 0540, aTexto;

     |C_M #camaniva#43, 1, "S";
     |C_M #camaniva#44, 1, "S";
     |SI #camaniva#42 ! "A";  |Y #camaniva#42 ! "B";
         |C_M #camaniva#43, 1, "N";  #camaniva#43 = "";
         |C_M #camaniva#44, 1, "N";  #camaniva#44 = "";
     |FINSI;
     |PINTA #camaniva#43;|PINTA #camaniva#44;

     |HAZ EsCajaIva;
     |SI enSwCaja = 1; |Y aClau340 ! " "; |Y aClau340 ! #camaniva#42;
         |CONFI "    NFras en R.E.C.C. no es compatible con el Concepto Contable. Continuar";
         |SI FSalida ! 0;
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #camaniva#42 = "D";
         enConcepto = #camaniva#27;
         |HAZ VeoRecti;
         |SI nSwRecti = 1;
             |ERROR;
         |FINSI;
    |FINSI;
|FCAL;

|CALCULO Ant_refe; |TIPO 7;
  eaSiiRef = #camaniva#22; |QBF eaSiiRef;
  eaSiiSer = #camaniva#2;  |QBF eaSiiSer;
  enSiiFra = #camaniva#3;
  |HAZ NReferencia;
  #camaniva#22 = eaSiiRef;
  |PINTA #camaniva#22;

  |C_M #camaniva#22, 1, "S";
  aAlfa1 = #camaniva#22; |QBF aAlfa1;
  |SI aAlfa1 = "";
     |SI #caivaasi#116 = "B"; |C_M #camaniva#22,1,"N"; |FINSI;
  |FINSI;

  |HAZ EsComersan;
  |SI FSalida = 0; |C_M #camaniva#22,1,"N"; |FINSI;
|FCAL;

|CALCULO r_refeIVA; |TIPO 6;
   |SI eaRefer = "N"; enLgRef = #caivaasi#117; |FINSI;
   |SI #caivaasi#116 ! "S"; |ACABA; |FINSI;
   r_entra = entrada;
   r_alfa1 = #0Campo;
   |HAZ r1_punto;
   #0Campo = r_alfa1;
   |PINTA #0Campo;
|FCAL;


|CALCULO refeIVA; |TIPO 0;
 ant_ref = #0Campo;

 |HAZ EsComersan;
 |SI FSalida = 0; |Y #camaniva#36 = "S";
    |SI dirfich0 ! ""; |Y swVarios = 1; |PATH_DAT #100 dirfich0; |FINSI;
    |ABRE #camanref;
    #camanref#0 = #camaniva#0;
    #camanref#1 = #camaniva#1;
    |LEE 000#camanref.=;
    |SI FSalida ! 0; |DDEFECTO #camanref; |FINSI;
    |PUSHV 1020 1262;
    |BLANCO 1020 1262;
    |CUADRO 1020 1262;
    |PINTA 1121, " N§ Fra.Proveedor: ";
    E_sup = 20; E_inf = ""; aFraPrv = #camanref#2;
    aFraPrv = 1140 ? 0;
    |SI FSalida = 0;
       #camanref#0 = #camaniva#0;
       #camanref#1 = #camaniva#1;
       |LEE 101#camanref.=;
       |SI FSalida ! 0;
          |DDEFECTO #camanref;
          #camanref#0 = #camaniva#0;
          #camanref#1 = #camaniva#1;
          |GRABA 020#camanref.b;
       |FINSI;
       #camanref#2 = aFraPrv;
       |GRABA 020#camanref.a; |LIBERA #camanref;
    |SINO;
       |ERROR;
    |FINSI;
    |CIERRA #camanref;
    |POPV;
 |FINSI;

 |C_M #camaniva#10, 0, aAlfa;
 aAlfa1 = #camaniva#22; |QBF aAlfa1;
 |SI aAlfa = "N"; |Y aAlfa1 = "";
     eOpDep = 0; || 1 = Consulta pantalla
     enActividad = #camaniva#10;
     eaCodDep    = #camaniva#10;
     eSwNoalta = 1; |HAZ Actividad; eSwNoalta = 0;
     |HAZ RefBlanca;
     |SI nOk = 1;
         |ERROR;
     |FINSI;
 |FINSI;
|FCAL;

|PROCESO RefBlanca;
 |SI aTipoIVA ! "N"; |Y enEjercicio ] 2017;
     nOk = 0;
     |SI enTipoIva = 11;  nOk = 1;  |FINSI;
     |SI enTipoIva = 12;  nOk = 1;  |FINSI;
     |SI enTipoIva = 13;  nOk = 1;  |FINSI;
     |SI enTipoIva = 15;  nOk = 1;  |FINSI;
     |SI enTipoIva = 16;  nOk = 1;  |FINSI;
     |SI enTipoIva = 17;  nOk = 1;  |FINSI;
     |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;
     |SI nOk = 1;
         |MENAV "0000Atencion. Es OBLIGATORIO informar la Referencia ";
     |FINSI;
 |FINSI;
|FPRC;
|| ------------------------------------------------------------------

|CALCULO AntesDepar; |TIPO 7;
   aDep1    = #camaniva#10;
   aDescAnt = #camaniva#28;
   |C_M #camaniva#Campo#, 0, alfa1;
   |SI alfa1 = "S"
      |SI Haybasica = 1;
          |MENSA "    <F2> Consultar Actividades";
      |SINO;
          |MENSA "    <F2> Consultar Departamentos";
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesSubde; |TIPO 7;
   aSub1 = #camaniva#11;
   |C_M #camaniva#Campo#, 0, alfa1;
   |SI alfa1  = "S";
      |SI Haybasica = 1;
          |SI enArrend ! 2;
              |MENSA "    Subdepartamento: Referencias Catastrales <F2> Consultar <F3> Modificar";
          |SINO;
              |MENSA "    Subdepartamento. <F2> Consultar Cultivos";
          |FINSI;
      |FINSI;
   |FINSI;
|FCAL;

|CALCULO elDNI; |TIPO 6;

  |SI FSalida = 2; |ACABA; |FINSI;
  |SI FSalida = 10;
      enCalcCif = 1;
      eaVarDni  = #camaniva#Campo#;
      |HAZ CalculoDNI;
      #camaniva#Campo# = eaVarDni;
      |PINTA #camaniva#Campo#;
      |ERROR;
      |ACABA;
  |FINSI;

     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;
     eaVarDni = (eaVarDni + "                ") % 115;
     |SI #0Campo ! eaVarDni;
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;

    eaVarDni = #0Campo; |QBF eaVarDni; |QBF eaNifEmp;
    |SI eaVarDni = eaNifEmp; |Y nPulsoF9 = 0;
        |CONFI "    NIntroducido NIF de la Empresa Actual. Continuar";
        |SI FSalida ! 0;
            |ERROR;
        |FINSI;
    |FINSI;
|FCAL;

|CALCULO elDNI0; |TIPO 0;
  |SI FSalida = 2; |ACABA; |FINSI;

  |SI #camaniva#36 = "N";
      eaCodNif = #camaniva#Campo#; |HAZ LeeNifs;
      |SI ewNif = 0; #camaniva#13 = #709#1; |PINTA #camaniva#13; |FINSI;
  |SINO;
      |ABRE #caclipro;
      |SI aTipoIVA = "R";
           #caclipro#23 = "C";
      |SINO;
           #caclipro#23 = "P";
      |FINSI;
      #caclipro#10 = #camaniva#12;
      |LEE 000#caclipro.=;
      |SI FSalida ! 0; |O #caclipro#15 = "               ";
          eaCodNif= #camaniva#Campo#; |QBF eaCodNif;
          |SI eaCodNif ! "";
              |HAZ LeeNifs;
              |SI ewNif = 0; #camaniva#13 = #709#1; |PINTA #camaniva#13; |FINSI;
          |FINSI;
      |FINSI;
      |CIERRA #caclipro;
      |SI aTipoIVA = "S"; |Y HayAcceso = 1; |Y #camaniva#14 ! "               ";
          |SI eaTEmbargo = "F"; |O eaTEmbargo = "A";
              efFechaE = #camaniva#4;
              |HAZ eVerEmbargos;
          |FINSI;
      |FINSI;
   |FINSI;
|FCAL;

|PROCESO PintaExpCEBI;
   |DDEF aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "otp00004.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |ABRE #Referen@;
      #Referen@#0 = #camaniva#0;
      #Referen@#1 = #camaniva#1;
      |LEE 000#Referen@.=;
      |SI FSalida ! 0; |DDEFECTO #Referen@; |FINSI;
      |PINTA 1131, "Exp.CEBI";
      |PINTA 1140, #Referen@#5;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
|FPRC;

|PROCESO ExpCEBI;
   |SI #camaniva#36 = "S";
      |HAZ MiraSiOTP;
      |SI FSalida ] 0;
         enLibroOTP = #camaniva#0; enRgIVAOTP = #camaniva#1;
         eaSerieOTP = #camaniva#2; enNumFcOTP = #camaniva#3;
         eaReferOTP = #camaniva#22;
         |SUB_EJECUTA "otp00004.tab";
         |HAZ PintaExpCEBI;
      |FINSI;
   |FINSI;
|FPRC;

|CALCULO Tipo7C46; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI aTipoIVA = "N";
       efRNomina  = #0#4;
       enRLaboral = #0#46;
       eaTrans    = #0#47;
       |SI HayLaboral = 1;
           eaCodNif = #0#14;
           |HAZ eBuscaRLaboral;
           |SI ModoEntrada = 1;
               #0#46 = enRLaboral; |PINTA #0#46;
               #0#47 = eaTrans;    |PINTA #0#47;
           |FINSI;
      |FINSI;
   |FINSI;
|FCAL;


|PROCESO Canvids0;
 |SI Campo = 10; |Y aDep1 = #caivalin#30;
     #caivalin#30 = #camaniva#10;
     |GRABA 020#caivalin.a;
 |FINSI;
 |SI Campo = 11; |Y aSub1 = #caivalin#31;
     #caivalin#31 = #camaniva#11;
     |GRABA 020#caivalin.a;
 |FINSI;
 |LIBERA #caivalin;
|FPRC;

|DEFBUCLE Canvids;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,01;
 #camaniva#0,#camaniva#1,99;
 be;
 NULL,Canvids0;
|FIN;

|PROCESO CanviDS;
  n = 0;
  |SI eaMulDep = "S";
      aAlfa1 = "Departamento "; |SI Campo = 11; aAlfa1 = "Subdepartamento"; |FINSI;
      aAlfa1 = "    NModificar en las Lineas del mismo " + aAlfa1;
      |CONFI aAlfa1;
      n = FSalida;
  |FINSI;
  |SI n = 0;
      |BUCLE Canvids;
  |FINSI;
|FPRC;

|CALCULO TrasDepar; |TIPO 0;
   |SI eaDepar = "N"; |ACABA; |FINSI;
   |SI FSalida = 2;   |ACABA;  |FINSI;

   ModoEntrada  = (FEntrada / 100) ! 0;
   eOpDep = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpDep = 1;  |FINSI;
   enActividad = #camaniva#10;
   eaCodDep    = #camaniva#10;
   |HAZ Actividad;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Actividad / Departamento";
       |C_M #camaniva#10, 1, "S";
       |ERROR;
       |ACABA;
   |SINO;
       alfa1 = enActividad;
       |SI Haybasica = 1;
           alfa1 = ("00" + alfa1) % A02;
           |SI aTipoIVA ! "N";
               enFilRegIVA = 1;
               enConcepto  = #camaniva#27;
               |HAZ FilRegimenIVA;
               |SI eswLect ! 0; |HAZ SuboConcepto; |ACABA; |FINSI;
           |FINSI;
       |FINSI;

       #camaniva#10 = eaCodDep;    |PINTA #camaniva#10;
       #camaniva#24 = eaNombreAct; |PINTA #camaniva#24;
       |SI efActFin > "01.01.1900"; |Y snFilBa = "S";
           aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
           |CONFI aAlfa1;
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
       |SI eaEsCom = "S";
           |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Facturas ? ";
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;

       |SI ModoEntrada = 2;
           |SI #camaniva#10 ! aDep1;
               |HAZ CanviDS;
           |FINSI;
       |FINSI;
   |FINSI;

   |C_M #camaniva#10, 0, aAlfa;
   aAlfa1 = #camaniva#22; |QBF aAlfa1;
   |SI aAlfa = "S"; |Y aAlfa1 = "";
       |HAZ RefBlanca;
       |SI nOk = 1;
           |ERROR;
           |PTEC 808;
           |C_M #camaniva#30, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#29, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#14, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#13, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#12, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#44, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#43, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#42, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#28, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |C_M #camaniva#27, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|PROCESO SuboConcepto;

   |SI snFiltr = "S"; |Y snFilAc = "S";
       |C_M #camaniva#10, 0, aAlfa1;
       |SI aAlfa1 = "N"; |ACABA; |FINSI;
       |PTEC 808;
       |C_M #camaniva#30, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#29, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#14, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#13, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#12,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#44,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#43,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#42,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
       |C_M #camaniva#28,  0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
   |FINSI;
|FPRC;

|CALCULO TrasSubde; |TIPO 0;
   |SI eaSubde = "N"; |ACABA; |FINSI;

   eOpSub = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpSub = 1;  |FINSI;
   |SI FSalida = 11; eOpSub = 2;  |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   enConcepto  = #camaniva#27;
   eaCodSubdep = #camaniva#11;
   enQue = 1;
   |HAZ SubActividad;
   enQue = 0;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Subdepartamento";
       |ERROR;
   |SINO;
       #camaniva#11 = eaCodSubdep; |PINTA #camaniva#11;
       #camaniva#25 = eaNomSubdep; |PINTA #camaniva#25;

       |SI ModoEntrada = 2;
           |SI #camaniva#11 ! aSub1;
               |HAZ CanviDS;
           |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

||-----------------------------------------------------------------
|CALCULO AntesConcep1; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;
  |SI snConc2 = "R";
      #camaniva#29 = #camaniva#27; |PINTA #camaniva#29;
      #camaniva#30 = #camaniva#28; |PINTA #camaniva#30;
  |FINSI;
|FCAL;

|PROCESO Tipo349;
       eaTip349 = "";
       |SI #dsmom030#72 = "S";
           nSwIntra = 1;
           |SI #dsmom030#26 = 5; eaTip349 = "AR";  |FINSI;
           |SI #dsmom030#26 = 6; eaTip349 = "IR";  |FINSI;
           |SI #dsmom030#30 = 2; eaTip349 = "AR";  |FINSI;
           |SI #dsmom030#30 = 3; eaTip349 = "IR";  |FINSI;
           |SI #dsmom030#34 = 9; eaTip349 = "ER";  |FINSI;
           |SI #dsmom030#34 = 4; eaTip349 = "SR";  |FINSI;
       |FINSI;
|FPRC;

|CALCULO TrasConcepto1;  |TIPO 0;     ||Concepto Factura / IVA
   |SI Campo = 27; nSwIntra = 0; |FINSI;

   |C_M #camaniva#Campo#,0,alfa1;

   ModoEntrada = (FEntrada / 100 ) ! 0;

   |SI FSalida = 10;
       eaFiCon = aFich1;
       |SI aTipoIVA = "N"; eaFiCon = aFich2; |FINSI;
       enConcepto = #camaniva#Campo#;
       |HAZ VerConcepto;
       #camaniva#Campo# = enConcepto; |PINTA #camaniva#Campo#;
   |FINSI;

   enLibIVA  = #camaniva#0;
   enFilConc = 2;          || Concepto de IVA
   |SI aTipoIVA = "N"; enFilConc = 1; |FINSI;
   eaCuenta = #camaniva#12;
   eaReperc = " ";
   enConcepto = #camaniva#Campo#;
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;

   nume1 = Campo + 1;
   |SI #camaniva#Campo# ! nAnterior27;
       #camaniva#nume1# = #dsmom030#1; |PINTA #camaniva#nume1#;
   |FINSI;

   |SI nume1 = 30; |Y snConc2 = "R";
       #camaniva#30 = #camaniva#28; |PINTA #camaniva#30;
   |FINSI;

   |SI Campo = 27;
       |HAZ Tipo349;

       |C_M #camaniva#10,0,aAlfa1;
       |SI aAlfa1 = "N";   ||no modifica Actividad
           enActividad = #camaniva#10;
           |SI Haybasica = 1; |Y aTipoIVA ! "N";
               enFilRegIVA = 0;
               enConcepto  = #camaniva#27;
               |HAZ FilRegimenIVA;
          |FINSI;
       |FINSI;
   |FINSI;

   aClau340 = #camaniva#42;
   nNumFras = #camaniva#38;
   |HAZ ClauDefecto;
   #camaniva#42 = aClau340;
   |PINTA #camaniva#42;

   aAntesDes0  = #dsmom030#1;  |QBF aAntesDes0;
   aAntesDes1  = #camaniva#28; |QBF aAntesDes1;
   nAnterior27 = #camaniva#Campo#;

   eaCtaIVAEs  = eaCtaIVA;

   nREBUReg = 0;
   |SI #dsmom030#24 = 5; |O #dsmom030#24 = 6;
        nREBUReg = 1;
   |SINO;
        |PARA nNume1 = 78; |SI nNume1 [ 101; |HACIENDO nNume1 = nNume1 + 1;
              |SI #dsmom030#nNume1# = 5; |O #dsmom030#nNume1# = 6;
                  nREBUReg = 1;
                  |SAL;
              |FINSI;
              |SI nNume1 = 89; nNume1 = 93; |FINSI;
              |SI nNume1 = 95; nNume1 = 99; |FINSI;
        |SIGUE;
   |FINSI;
   |SI nREBUReg = 1;
       |SI aTipoIVA = "R"; |Y #dsmom030#34 = 5; nREBU = 1; |FINSI;
       |SI aTipoIVA = "S"; |Y #dsmom030#36 = 4; nREBU = 1; |FINSI;
   |FINSI;
|FCAL;

|CALCULO PonloAlFinal; |TIPO 7;
   ModoEntrada = (FEntrada / 100) ! 0;

   |C_M #camaniva#Campo#,0,alfa1;
   |SI alfa1 = "S";
       |SI eaSobreEs ! "S";
           |PTEC 816;
       |FINSI;
   |FINSI;

   |SI aDescAnt ! "";
       |MENSA "    <F7> Descripcion anterior, <F8> Recoger A¤adido";
   |SINO;
       |PINTA 0420, "                                 ";
   |FINSI;

   |SI #caivaasi#131 = "S";
       || ..  siempre por si cambia algo
           xx = 1; |SI Campo = 30; xx = 2; |FINSI;
           |HAZ adaptaC2;
           #camaniva#Campo# = aAlfa1; |PINTA #camaniva#Campo#;
           |SI Campo = 30;
               xx = 1;
               |HAZ adaptaC2;
               #camaniva#28 = aAlfa1; |PINTA #camaniva#28;
          |FINSI;
   |FINSI;
|FCAL;

|CALCULO TrasDescr_C; |TIPO 0;
   |SI FSalida = 15; |Y aDescAnt ! "";
       #camaniva#Campo# = aDescAnt; |PINTA #camaniva#Campo#;
       |ERROR;
   |FINSI;
   |SI FSalida = 16; |Y Campo ! 28;
       aAntesDes1 = #camaniva#28; |QBF aAntesDes1;
       aAlfa1 =  aAntesDes1 - aAntesDes0;
       aAlfa2 = #dsmom030#1; |QBF aAlfa2;
       aAlfa2 = aAlfa2 + aAlfa1;
       #camaniva#Campo# = aAlfa2; |PINTA #camaniva#Campo#;
   |FINSI;
   aDescAnt = #camaniva#Campo#;
|FCAL;

|CALCULO AntesCuenta; |TIPO 7;             ||Cuenta Cli/Pro
  nPulsoF9 = 0;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada ! 1; |ACABA; |FINSI;
  |SI swpcta = 1; |ACABA; |FINSI;

  |SI aTipoIVA = "S";
      alfa1 = "40";
      |SI #dsmom030#18 = "S"; alfa1 = #dsmom030#62; |FINSI;
  |SINO;
      |SI aTipoIVA = "R";
          alfa1 = "43";
          |SI #dsmom030#19 = "S"; alfa1 = #dsmom030#67; |FINSI;
      |SINO;
          alfa1 = "64";
      |FINSI;
  |FINSI;
  |QBT alfa1;
  |SI alfa1 ! "";
      alfa2 = (alfa1 + "0000") % 104;
      alfa2 = alfa1 + ".       "
  |SINO;
      alfa2 = "";
  |FINSI;
  #camaniva#Campo# = alfa2;
  |PTEC 816;
  swpcta = 1;
|FCAL;

|CALCULO Cuenta_C; |TIPO 6;             || Cuenta Cli/Pro
   |C_M #camaniva#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   |SI FSalida = 2; |ACABA; |FINSI;

   |SI FSalida = 10; || ... extractos
       ext1 = #camaniva#12;       || cuenta
       |HAZ externos;
       |ERROR;
       |ACABA;
   |FINSI;

   |SI FSalida = 14;
       |HAZ extracon;
       |ACABA;
   |FINSI;

   |SI FSalida = 9;
       nPulsoF9 = 1;
       |SUB_EJECUTA_NP "cacugen1";
       |SI enSwBUENO = 0;
           #camaniva#Campo# = eaCuenta;
           |PINTA #camaniva#Campo#;
       |SINO;
           nPulsoF9 = 0;
           |ERROR;
           |ACABA;
      |FINSI;
   |FINSI;

   eaCuenta = #camaniva#Campo#;
   salidas  = FSalida;
   |HAZ FiltraPuntos;
   #camaniva#Campo# = eaCuenta;
   |PINTA #camaniva#Campo#;

   |SI #camaniva#Campo# = "            ";
       |MENAV "0000Introduzca una cuenta";
       |ERROR;
   |FINSI;
|FCAL;

|PROCESO DatosCaclipro;
       nConIRPF = 0;
       |SI #camaniva#36 ! "N";
           nCTiva   = 0;
           |ABRE #caclipro;
           |SI aTipoIVA = "R";
               #caclipro#23 = "C";
           |SINO;
               #caclipro#23 = "P";
           |FINSI;
           #caclipro#10 = #camaniva#12;
           #caclipro#11 = enNivel;
           |LEE 000#caclipro.=;
           |SI FSalida = 0;
               #camaniva#13 = #caclipro#1;
               #camaniva#14 = #caclipro#9;
               nCTiva       = #caclipro#42;
               aCPartida    = #caclipro#21; |QBF aCPartida;
               |SI snReten ! "N";
                   nConIRPF     = #caclipro#52;
               |FINSI;
               |SI nCTiva = 0; |O aCPartida = ""; nswclipro = 1; |FINSI;
           |SINO;
               #camaniva#13 = #cacuenta#2;
               #camaniva#14 = "";
               |C_M #camaniva#14,1,"S";  || No tengo el nif.
           |FINSI;
           |PINTA #camaniva#13;
           |PINTA #camaniva#14;
           |CIERRA #caclipro;
       |SINO;
            #camaniva#13 = #cacuenta#2; |PINTA #camaniva#13;
            |C_M #camaniva#14,1,"S";  || No tengo el nif.
       |FINSI;
|FPRC;

|PROCESO SuperUsu;
     nSuperUsu = 0;
     aFic      =  aAsesPas + "superusuarios_proveedores.txt";
     |XABRE "", aFic, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aUsu = Usuario % 810;  |QBF aUsu;

     |PARA;  |SI;  |HACIENDO;
             |XLEE nHandle, 250, aCadena;
             |SI FSalida < 0;  |SAL;  |FINSI;
             |QBF aCadena;

             |SI aCadena = aUsu;
                 nSuperUsu = 1;
                 |SAL;
             |FINSI;
     |SIGUE;

     |XCIERRA nHandle;
|FPRC;

|PROCESO ProvOTP;
     eswCta     = 0;
     |HAZ MiraSiOTP;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aNIFProv   = "";
     aFechaBaja = "";
     |DBASS aPreven;   |QBF aPreven;

     aAlfa    = aPreven % -204;
     nSPA     = aAlfa;

     aAlfa1   = "";
     aAlfa2   = "";
     aAlfa    = aPreven % -299;
     |PARA; |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\"; |HACIENDO;
          aAlfa1 = aAlfa % -101;
          aAlfa  = aAlfa % -299;
     |SIGUE;

     aAsesPas   = aAlfa + "/asespas/";
     aPreven    = aPreven + "dspreven/";
     aMasPreven = aPreven + "def/";

     aAlfa = aMasPreven + "pycm0072.mas";
     |XABRE "E", aAlfa, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |CARGA_DEF aAlfa, Referen@;

     aFicPreven = aPreven + "fich/";
     |PATH_DAT #Referen@#aFicPreven#;

     aZona = ("00000" + #48#2) % -105;

     |ABRE #Referen@;
     |SELECT #4#Referen@;
     #Referen@#1 = aZona;
     #Referen@#4 = #camaniva#12;
     |LEE 000#Referen@.=;
     |SI FSalida ! 0;
         |SELECT #5#Referen@;
         #Referen@#1 = aZona;
         #Referen@#9 = #camaniva#12;
         |LEE 000#Referen@.=;
         |SI FSalida = 0;
             aNIFProv = #Referen@#0;
         |FINSI;
     |SINO;
         aNIFProv = #Referen@#0;
     |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;

     |SI aNIFProv = "";
         |ACABA;
     |FINSI;

     aAlfa = aMasPreven + "ctrlspas.mas";
     |CARGA_DEF aAlfa, Referen@;
     |PATH_DAT #Referen@#aAsesPas#;
     |ABRE #Referen@;
     #Referen@#0 = nSPA;
     |LEE 000#Referen@.=;
     |SI FSalida ! 0;  |DDEFECTO #Referen@;  |FINSI;

     aAgrupar = #Referen@#4;

     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;

     aAlfa = aMasPreven + "pycm0070.mas";
     |CARGA_DEF aAlfa, Referen@;

     |SI aAgrupar = "N";
         |PATH_DAT #Referen@#aFicPreven#;
     |SINO;
         |PATH_DAT #Referen@#aAsesPas#;
     |FINSI;

     aEmbargo = "N";
     |ABRE #Referen@;
     #Referen@#0 = aNIFProv;
     |LEE 000#Referen@.=;
     |SI FSalida = 0;
         |SI #Referen@#109 > "01.01.0000";
             aFechaBaja = #Referen@#109;
         |FINSI;
         aEmbargo = #Referen@#114;
     |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;

     |SI aFechaBaja ! "";
         |HAZ SuperUsu;

         |SI nSuperUsu = 0;
             aAlfa = "0000El proveedor esta dado de baja desde el dia " + aFechaBaja;
             |MENAV aAlfa;
             |ERROR;
             eswCta = 1;

             |ACABA;
         |FINSI;

         |SI nSuperUsu = 1;
             aAlfa = "0000NEl proveedor esta dado de baja desde el dia " + aFechaBaja + " Continuar";
             |CONFI aAlfa;
             |SI FSalida ! 0;
                 |ERROR;
                 eswCta = 1;

                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI aEmbargo = "S";
         |HAZ SuperUsu;

         |SI nSuperUsu = 0;
             aAlfa = "0000El proveedor tiene embargo administrativo.";
             |MENAV aAlfa;
             |ERROR;
             eswCta = 1;

             |ACABA;
         |FINSI;

         |SI nSuperUsu = 1;
             aAlfa = "0000NEl proveedor tiene embargo administrativo. Continuar";
             |CONFI aAlfa;
             |SI FSalida ! 0;
                 |ERROR;
                 eswCta = 1;

                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|CALCULO TrasCuenta_C; |TIPO 0;
   |HAZ ProvOTP;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea

   emCta    = 1;
   enDiarioNivel = #camaniva#7;
   eaCuenta = #camaniva#Campo#;
   |HAZ SacaNivel;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea

   |HAZ LeeCuenta;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
   enConcepto = #camaniva#27;

   nswclipro = 0;
   aCPartida = "";
   nCTiva    = 0;
   nConIRPF  = 0;
   || Leer Proveedor/Cliente
   |HAZ FiltraCtaCP;
   |SI eswLect = 0;
       |HAZ DatosCaclipro;
   |FINSI;

   |SI nCTiva ! 0;
       dTiva    = nCTiva;
   |SINO;
       dTiva    = nCGuarda;
   |FINSI;
   nDesNom = 1;
|FCAL;

|CALCULO AntesNombre;  |TIPO 7;
   |SI #caivaasi#35 = "F"; |Y aTipoIVA ! "N";
       |SI nDesNom= 1;
           |PTEC 827;
       |SINO;
           |PTEC 808;
       |FINSI;
   |FINSI;
   nDesNom = 0;
|FCAL;

|CALCULO TrasNombre;
   |SI FSalida = 13; |Y aTipoIVA ! "N";
       raf_cue = #camaniva#12;
       raf_dig = enNivel;
       raf_des = #camaniva#13;
       raf_nif = #camaniva#14;
       raf_sw  = 0;
       tipoalta = "C"; |SI aTipoIVA = "S"; tipoalta = "P"; |FINSI;
       |SUB_EJECUTA_NP "caclipr1";
       #camaniva#13 = raf_des; |PINTA #camaniva#13;
       #camaniva#14 = raf_nif; |PINTA #camaniva#14;
       |SI raf_sw = 0;
           |ERROR; |PTEC 808;
       |SINO;
           |HAZ DatosCaclipro;
       |FINSI;
   |FINSI;
|FCAL;

|| *************************************************************************
|| ............
|| Proceso de lineas

|PROCESO MiroAmor;
 swInve = 0;
 impoa  = #0#19 + #1#6;
 aMensa = "    Entre: (S) si es un BIEN de inversion";
 |SI aTipoIVA = "S"; |Y impoa < 3005.06; |Y swAmorC = 0; ||Soportado base menor a 500.000 ptas
     swInve = 1;
     aMensa = "    Pulse <F2> Bien Corriente con Ficha de Amortizacion";
 |SINO;
     |SI aTipoIVA = "S"; |Y impoa < 3005.06; |Y swAmorC = 2; ||Soportado base menor a 500.000 ptas
         swInve = 1;
         aMensa = "    (S) si es un Bien de Inversion, <F2> Bien Corriente con Ficha de Amortizacion";
     |SINO;
         |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
     |FINSI;
 |FINSI;
|FPRC;

|CALCULO DesInv; |TIPO 0;
 inkey = FSalida;
 ModoEntrada = (FEntrada / 100) ! 0;
 |C_M #1Campo,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 |SI #1Campo = "S"; |Y aTipoIVA = "S"; |Y swAmorC = 0; |Y inkey ! 10;
      |SI snFiltr ! "X";
          |MENAV "    Atencion. El Concepto Contable utilizado no es de Inversion de IVA.";
      |FINSI;
      |SI snFiltr = "S";
          |ERROR;
          |ACABA;
      |FINSI;
 |FINSI;

 |SI swInve = 0;
     swAmor = 0;
     |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
     |SI inkey = 10; FSalida = 0; inkey = 0; |ERROR; |FINSI;
     |ACABA;
 |FINSI;

 |SI inkey = 10;
     |ATRI P; |PINTA 1544, "Amortizacion"; |ATRI 0;
      #1Campo = "N"; |PINTA #1Campo;
      swAmor  = 1;
      FSalida = 0;
      |ACABA;
 |FINSI;

 |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
 swAmor = 0;
 |SI ModoEntrada = 2;
     |SI enSwEncuentro = 1;
         |ATRI P; |PINTA 1544, "Amortizacion"; |ATRI 0;
         #1Campo = "N"; |PINTA #1Campo;
         swAmor = 1;
     |FINSI;
 |FINSI;
 inkey = 0;
|FCAL;

|CALCULO AntesInv; |TIPO 7;
      |HAZ MiroAmor;
      |MENSA aMensa;
|FCAL;

|CALCULO AntesDesc; |TIPO 7;
  enSwEncuentro = 0;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada = 1; |ACABA; |FINSI;

  |HAZ MiroAmor;
  |SI swInve = 1;
     nLib_am = #camaniva#0;
     aSer_am = #camaniva#2;
     nFra_am = #camaniva#3;
     |SUB_EJECUTA_NP "camocab5";
     |SI enSwEncuentro = 1;
         |ATRI P; |PINTA 1544, "Amortizacion"; |ATRI 0;
         swAmor = 1;
     |FINSI;
  |FINSI;
|FCAL;


|CALCULO ActCliPro;
   |SI #camaniva#36 = "N"; |ACABA; |FINSI;

   |ABRE #caclipro;
   |SI aTipoIVA = "R";
       #caclipro#23 = "C";
   |SINO;
       #caclipro#23 = "P";
   |FINSI;
   #caclipro#10 = #camaniva#12;
   |LEE 101#caclipro.=;
   |SI FSalida = 0;
       |SI aCPartida = ""; |Y #caivaasi#128 = "S";
           #caclipro#21 = #caivalin#12;
           aCPartida = #caclipro#21; |QBF aCPartida;
       |FINSI;
       |SI nCTiva = 0; |Y #caivaasi#129 = "S";
           #caclipro#42 = #caivalin#16;
           nCTiva = #caclipro#42;
       |FINSI;
       |GRABA 020#caclipro.a;
       |SI aCPartida ! ""; |Y nCTiva ! 0; nswclipro = 0; |FINSI;
   |FINSI;
   |LIBERA #caclipro;
   |CIERRA #caclipro;
|FCAL;

|CALCULO AbreAm;  |TIPO 3;
   |SI #camaniva#36 = "N";
       |SI #caivalin#6 = 0; |Y #caivalin#20 ! 0;
           #caivalin#18 = #caivalin#3;
       |FINSI;
       |ACABA;
   |FINSI;

   |SI nswclipro = 1; |Y #camaniva#36 ! "N";
      |SI #caivaasi#128 = "S"; |O #caivaasi#129 = "S";
          |HAZ ActCliPro;
      |FINSI;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI #caivalin#17 = "S"; |O swAmor = 1;

       |SI #camaniva#36 = "R"; |Y #caivalin#17 = "S";
           aAlfa1 =  "2400SFra. de Inversion. Desea reflejar la venta del Bien Amortizable : ";
           |SI ModoEntrada = 2;
               aAlfa1 =  "2400SFra. de Inversion. Desea modificar la venta en el Bien Amortizable : ";
           |FINSI;
           |AVISO;
           |CONFI aAlfa1;
           |SI FSalida ! 0; |ACABA; |FINSI;
           fec_am  = #camaniva#4;
           imp_am  = #caivalin#6;    ||pase a amortizacion solo la base fra.
           c_am    = #caivalin#4;
           c_conp  = #caivalin#3;
           ref_am  = #camaniva#22;
           nLib_am = #camaniva#0;
           aSer_am = #camaniva#2;
           nFra_am = #camaniva#3;
           c_ctana = #caivalin#28;
           enModAmor = ModoEntrada;
           iva_am    = #caivalin#8;   || cuota
           tiva_am   = #caivalin#7;   || % IVA
           nDoc_am   = #caivalin#1;
           |SI imp_am ! 0; |SUB_EJECUTA_NP "camocab2.tab"; |FINSI;
       |FINSI;

       |SI #camaniva#36 = "S";
           aAlfa1 =  "2400SFra. de Inversion. Desea crear el Bien Amortizable : ";
           |SI swAmor = 1; aAlfa1 = "2400SFra. Bien Corriente. Desea crear la Ficha de Amortizacion: "; |FINSI;
           |SI ModoEntrada = 2;
               aAlfa1 =  "2400SFra. de Inversion. Desea modificar la compra del Bien Amortizable : ";
               |SI swAmor = 1; aAlfa1 = "2400SFra. Bien Corriente. Desea modificar la Ficha de Amortizacion: "; |FINSI;
           |FINSI;
           |AVISO;
           |CONFI aAlfa1;
           |SI FSalida ! 0;  |ACABA; |FINSI;
           enDiarioNivel = #camaniva#7;
           ct1_am = #caivalin#12; eaCuenta = #caivalin#12; |HAZ SacaNivel;
           ct2_am = enNivel;
           |HAZ LeeCuenta;
           ct3_am = #cacuenta#2;
           fec_am = #camaniva#4;
           imp_am = #caivalin#6;    ||pase a amortizacion solo la base fra.
           |SI #caivalin#5 = "S";
               iva_am    = #caivalin#8;   || cuota
               tiva_am   = #caivalin#7;   || % IVA
           |SINO;
               iva_am  = 0;
               tiva_am = 0;
               |SI dCtaNoD = "";
                   imp_am = #caivalin#6 + #caivalin#8;
               |FINSI;
           |FINSI;
           c_conp = #caivalin#3;
           c_am   = #caivalin#4;  |QBF c_am;
           c_am   = c_am + " " + #camaniva#22;
           prv_am = #camaniva#13;

           dni_am = #camaniva#14;
           clau_am = #camaniva#42;
           igic_am = #calibros#3;

           ref_am  = #camaniva#22;
           nLib_am = #camaniva#0;
           aSer_am = #camaniva#2;
           nFra_am = #camaniva#3;
           c_ctana = #caivalin#28;
           enModAmor = ModoEntrada;
           nDoc_am = #caivalin#1;
           nBas_am = #caivalin#2;
           nSwFra  = 1;
           |SI imp_am ! 0; |SUB_EJECUTA_NP "camocab1.tab"; |FINSI;
           nSwFra  = 0;
      |FINSI;
   |FINSI;
   |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
   swAmor  = 0;
   swInve  = 0;

   |SI ModoEntrada = 1; eSwCambio = 1; |FINSI;
|FCAL;

|CALCULO ActLinea; |TIPO 2;
   #caivalin#24 = "N";
   #camaniva#19 = #camaniva#19 +. #caivalin#6;  |PINTA #camaniva#19;
   #camaniva#15 = #camaniva#15 +. #caivalin#6;  |PINTA #camaniva#15;
   #camaniva#17 = #camaniva#15 %  #camaniva#16; |PINTA #camaniva#17;
   #camaniva#20 = #camaniva#20 +. #caivalin#22; |PINTA #camaniva#20;
   #camaniva#23 = #camaniva#23 +. (#caivalin#8 + #caivalin#10); |PINTA #camaniva#23;
   #camaniva#26 = #camaniva#26 +. #caivalin#11; |PINTA #camaniva#26;

  || ... quito el dto del total factura en Repercutido y Soportado
  || ... tique 218 del cliente 3238 03.01.2006 R/S
   |SI #camaniva#36 = "N";
       #camaniva#21 = #camaniva#19 + #camaniva#23 - #camaniva#26 - #camaniva#20;
   |SINO;
       #camaniva#21 = #camaniva#19 + #camaniva#23 - #camaniva#20;
   |FINSI;
   |PINTA #camaniva#21;

   enSiiMod = 0 +. 1;
   nMod = (FEntrada / 100) ! 0;
   |SI nMod = 3;  |O enSiiMod = 1;
       |HAZ T12lin;
   |FINSI;
|FCAL;

|RUTINA Asiinf2;
   #catmpasi#0 = #camaniva#7;
   #catmpasi#1 = #camaniva#8;
   #catmpasi#2 = #camaniva#9;
   #catmpasi#3 = 0001;
|FRUT;

|RUTINA Asisup2;
   #catmpasi#0 = #camaniva#7;
   #catmpasi#1 = #camaniva#8;
   #catmpasi#2 = #camaniva#9;
   #catmpasi#3 = 9999;
|FRUT;

|RUTINA Asiinf17;
   #917#0 = 0;
   #917#1 = "01.01.0000";
   #917#2 = 000001;
   #917#3 = 0001;
|FRUT;

|RUTINA Asisup17;
   #917#0 = 99;
   #917#1 = "31.12.2099";
   #917#2 = 999999;
   #917#3 = 9999;
|FRUT;

|CALCULO El7L; |TIPO 7;
  |PINTA 2344, "ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ";

  |HAZ EsCajaIva;
  enDesglose = 0;
  aAlfa1 = "0000<F3> Consulta Asiento, <F5> Consulta Otros Aptes del Asto, <F6> Anot. Extra.";
  |SI enSwCaja = 1;
      aAlfa1 = "    F3- Cons.Asto, F5- Cons.Otros Aptes Asto, F6- An.Extra., F9- Cons.Cobro/Pago";
  |FINSI;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI #caivalin#2 = 1; |Y #camaniva#36 ! "N";
      |SI ModoEntrada = 1; |O ModoEntrada = 2;
          enDesglose = 1;
          |SI ModoEntrada = 2;
              enDesglose = 2;
              |DBASE aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + "def/caivalin.mas";
              |CARGA_DEF aAlfa, caivalin@;
              |SI FSalida = 0;
                  |SI dirfich0 ! ""; |Y swVarios = 1;
                      |PATH_DAT #1104 dirfich0;
                  |FINSI;
                  |ABRE #caivalin@;
                  #caivalin@#0 = #caivalin#0;
                  #caivalin@#1 = #caivalin#1;
                  #caivalin@#2 = 2;
                  |LEE 001#caivalin@.];
                  |SI FSalida = 0; |Y #caivalin@#0 = #caivalin#0;
                                   |Y #caivalin@#1 = #caivalin#1;
                       enDesglose = 0;
                  |FINSI;
                  |CIERRA #caivalin@;
                  |DESCARGA_DEF #caivalin@;
              |FINSI;
          |FINSI;
      |FINSI;
  |FINSI;
  |SI enDesglose ! 0;
      aAlfa1 = "    F2- Por desglose base, F3- Cons.Asto, F5- Cons.Otros Aptes Asto, F6-An.Extra.";
      |SI enSwCaja = 1;
          aAlfa1 = "    F2-Por Desgl., F3-Cons.Asto, F5-Cons.Otros Aptes, F6-An.Ext.,F9-Cons.Cob/Pag";
      |FINSI;
  |FINSI;
  |MENSA aAlfa1;

  |SI ModoEntrada > 1;
      nNume1 = 12; |SI aTipoIVA = "N"; nNume1 = 23; |FINSI;
      aAlfa = #caivalin#nNume1#; |QBF aAlfa;
      |SI aAlfa ! "";
         emCta  = 0;
         eaCuenta = #caivalin#nNume1#;
         |HAZ LeeCuenta;
         |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
         |QBF eaNomCta;
         |ATRI S; |PINTA 2344, eaNomCta; |ATRI 0;
     |FINSI;
  |FINSI;
|FCAL;

|CALCULO El11L; |TIPO 11;

   inkey = FSalida;
   |SI inkey = 11;
       |PUSHV 05012380;
       |SI enSwAna = 1;
           |C_V #catmpasi#26,1,"S";
           |C_V #catmpasi#29,1,"S";
       |FINSI;
       |PINPA #0#14; |HAZ ModiPan_4;
       |ENTLINEAL #1#14,-4,4,22,0,Asiinf2,Asisup2;
       |POPV;
       |ERROR;
   |FINSI;
   |SI inkey = 13;
       |SI ModoEntrada = 4;
            |HAZ ElAuxW17;
       |FINSI;
       |PUSHV 05012380;
       |ENTLINEAL #1#caw00017,-4,4,19,1,Asiinf17,Asisup17;
     ||  |HAZ VoyaW17;
       |POPV;
       |ERROR;
   |FINSI;

   |SI inkey = 14;
       |HAZ extracon;
   |FINSI;

   |SI inkey = 17;
       |SI enSwCaja  = 1;
           eModoCaja  = 4;
           eDevenCaja = 0;
           |HAZ eTrataClaveZ;
       |FINSI;
   |FINSI;

   |SI inkey = 10; |Y enDesglose ! 0;
       |SI enTipoAsto > 100;
           |CONFI "    NATENCION. SI CONTINUA SE MODIFICARA EL ASIENTO (FRA DESDE GESTION)";
           |SI FSalida ! 0;
               |ACABA;
           |FINSI;
           enSwDejar  = 0;    || dejo que se modifique
           enErrCarte = 0;    || No deshago los vencimientos
       |FINSI;
       |HAZ PorDesglose;
       |SI enNoHay = 0;
           |ERROR;
       |SINO;
           |PONCONTROL 23, "SI";
       |FINSI;
   |FINSI;
   inkey = 0;
|FCAL;

|CALCULO El13L; |TIPO 13;
   |SI aTipoIVA = "N";
      |HAZ Pantalla3;
   |SINO;
      |HAZ Pantalla1;
   |FINSI;
   |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
   |SI enSwAna = 1;
       |ATRI S; |PINTA 1558, "Analitica:"; |ATRI 0;
       |PINTA 1568, #caivalin#28;
   |FINSI;
|FCAL;

|CALCULO Mensaje;
   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 4; |O ModoEntrada = 2;
       |ABRE #caivalin;
       |DDEFECTO #caivalin;
       #caivalin#0 = #camaniva#0;
       #caivalin#1 = #camaniva#1;
       #caivalin#2 = 99;
       |LEE 000#caivalin.];
       |SI FSalida = 0;
            |LEE 000#caivalin.a;
       |SINO;
            |LEE 000#caivalin.u;
       |FINSI;
       |SI FSalida = 0; |Y #caivalin#0 = #camaniva#0; |Y #caivalin#1 = #camaniva#1;
            |LEE 000#caivalin.=;
       |SINO;
            |DDEFECTO #caivalin;
            #caivalin#0 = #camaniva#0;
            #caivalin#1 = #camaniva#1;
       |FINSI;
       |CIERRA #caivalin;
   |SINO;
      ||  |DDEFECTO #caivalin;
      |SI ModoEntrada = 1; |DDEFECTO #caivalin; |FINSI;
   |FINSI;

   |SI aTipoIVA = "N";
      |HAZ Pantalla3;
   |SINO;
      |HAZ Pantalla1;
   |FINSI;
   |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
   |SI enSwAna = 1;
       |ATRI S; |PINTA 1558, "Analitica:"; |ATRI 0;
       |PINTA 1568, #caivalin#28;
   |FINSI;

   |C_V #camaniva#46, 1, "N";  |C_M #camaniva#46, 1, "N";
   |C_V #camaniva#47, 1, "N";  |C_M #camaniva#47, 1, "N";
   |SI aTipoIVA = "N";
       |C_V #camaniva#46, 1, "S";  |C_M #camaniva#46, 1, "S";
       |C_V #camaniva#47, 1, "S";  |C_M #camaniva#47, 1, "S";
       |PINTA 1130, "Rel.Laboral: "; |PINTA #0#46;
       |PINTA 1145, "Trans.: ";      |PINTA #0#47;
   |FINSI;
|FCAL;

|CALCULO NoMensaje; |TIPO 0;

  ModoEntrada = (FEntrada / 100) ! 0;
  |SI enErrCarte = 9;
      |SI ModoEntrada ! 2; |ERROR; |ACABA; |FINSI;
  |FINSI;

  |HAZ TomaDefectos_L;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada = 1;
       #caivalin#3  = dConc1;        |PINTA #caivalin#03;
       #caivalin#4  = dDesc1;        |PINTA #caivalin#04;
       |SI aTipoIVA ! "N";
           #caivalin#5  = dDeduc;         |PINTA #caivalin#5;
           #caivalin#16 = dTiva;          |PINTA #caivalin#16;
           #caivalin#17 = dInver;         |PINTA #caivalin#17;
           #caivalin#18 = nConIRPF;       |PINTA #caivalin#18;
      |FINSI;
      #caivalin#30 = #camaniva#10; |PINTA #caivalin#30;
      #caivalin#31 = #camaniva#11; |PINTA #caivalin#31;
  |FINSI;
  nAnterior     = #caivalin#3;
  |SI ModoEntrada ! 1;
      nAnteriorIRPF = #caivalin#18;
  |SINO;
      nAnteriorIRPF = 0;
  |FINSI;

 alfa1 = #caivalin#30; |QBF alfa1;
 |SI alfa1 = "";
     #caivalin#30 = #camaniva#10; |PINTA #caivalin#30;
     alfa1 = #caivalin#31; |QBF alfa1;
     |SI alfa1 = ""; #caivalin#31 = #camaniva#11; |PINTA #caivalin#31; |FINSI;
 |FINSI;
|FCAL;

|PROCESO extracon;
    enDiarioEx = #0#7;
    efFechaEx  = #0#8;
    enDocumEx  = #0#9;
    eaLaCtaEx  = #0#12;
    eaCtaDeEx  = #0#13;
    enConNuEx  = #0#27;
    eaConDeEx  = #0#28;
    enTipoEx   = 0;
    enPerEx    = enPeriodo;
    |SUB_EJECUTA_NP "caextmz1";
|FPRC;

|PROCESO externos;                      || desde calculo 'cuefin'
   |ATRI P;
   |MENSA "    Cargando Opcion ...";
   |ATRI 0;
   |SUB_EJECUTA_NP "caextrap";
|FPRC;
||------------------------------------------------------------------
|CALCULO ACarte_L; |TIPO 7;
  |SI enErrCarte ! 9; |ACABA; |FINSI;

  |C_M #caivalin#Campo#,0,aAlfa1;
  |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |SI Campo ! 12; |Y Campo ! 28; |Y Campo ! 4;
      |C_M #caivalin#Campo#,1,"N";
  |FINSI;

|FCAL;
||------------------------------------------------------------------
|CALCULO AntesConcep2; |TIPO 7;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada = 1; |Y aTipoIVA ! "N";
      #caivalin#3 = #camaniva#27; |PINTA #caivalin#3;
      #caivalin#4 = #camaniva#28;
      |SI #caivaasi#131  = "S"; |Y #caivaasi#130 ! "=  ";
          |ABRE #dsmom030;
          #dsmom030#0 = #caivalin#3;
          |LEE 000#dsmom030.=;
          |CIERRA #dsmom030;
          #caivalin#4 = #dsmom030#1;
      |FINSI;
      |PINTA #caivalin#4;
  |FINSI;
  |SI enErrCarte = 9; |Y aTipoIVA ! "N";
      |ABRE #dsmom030;
      #dsmom030#0 = #caivalin#3;
      |LEE 000#dsmom030.=;
      |CIERRA #dsmom030;
  |FINSI;
  nAnterior = #caivalin#3;
|FCAL;

|CALCULO MiraConcepto1;  |TIPO 0;  ||Concepto Base/ IVA

   |C_M #caivalin#Campo#,0,alfa1;

   |SI enErrCarte = 9; |ACABA; |FINSI;

   |SI FSalida = 2; |ACABA; |FINSI;

   |SI FSalida = 13;  |HAZ VoyaW17; |ERROR; |ACABA; |FINSI;

   |SI FSalida = 10;
       eaFiCon = aFich1;
       |SI aTipoIVA = "N"; eaFiCon = aFich2; |FINSI;
       enConcepto = #caivalin#Campo#;
       |HAZ VerConcepto;
       #caivalin#Campo# = enConcepto; |PINTA #caivalin#Campo#;
   |FINSI;
   enLibIVA  = #camaniva#0;

   |SI #camaniva#36 = "N";
      enFilConc = 3;          || Concepto de IRPF
      |HAZ NoIrpf;
   |SINO;
      enFilConc = 2;          || Concepto de IVA
   |FINSI;
   eaReperc = " ";
   |SI aTipoIVA = "N"; eaCuenta = #camaniva#12; enFilConc = 1; |FINSI;
   enConcepto = #caivalin#Campo#;
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;

   |SI eaDepar = "S";
       |SI Haybasica = 1; |Y aTipoIVA ! "N";
           enFilRegIVA = 1;
           |HAZ FilRegimenIVA;
           |SI eswLect ! 0; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   |SI #camaniva#42 = "D"; |Y aTipoIVA ! "N";
       enConcepto = #caivalin#Campo#;
       |HAZ VeoRecti;
       |SI nSwRecti = 1;
           |ERROR;
           |ACABA;
       |FINSI;
    |FINSI;

   nume1 = Campo + 1;
   |SI #caivalin#Campo# ! nAnterior;
       #caivalin#nume1# = #dsmom030#1; |PINTA #caivalin#nume1#;
       |SI aTipoIVA ! "N";
           #caivalin#25 = #dsmom030#72; |PINTA #caivalin#25;
       |FINSI;
   |FINSI;

|SI aTipoIVA ! "N"; |Y ModoEntrada = 1;
   #caivalin#25 = #dsmom030#72; |PINTA #caivalin#25;

   #caivalin#12 = eaCtaIVA; |PINTA #caivalin#12;
   |SI aCPartida ! "";
       #caivalin#12 = aCPartida;
   |FINSI;
   |PINTA #caivalin#12;

   emCta    = 0;
   enDiarioNivel = #camaniva#7;
   eaCuenta = #caivalin#12; |HAZ SacaNivel;
   |HAZ LeeCuenta;
||     |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea, pero no sale
|FINSI;

   swAmorC = 0;
   |SI aTipoIVA ! "N";
       |C_M #caivalin#16, 1,snTiva
       |SI eaReperc = "N";
           #caivalin#16 = enNumExe; |PINTA #caivalin#16;
           |C_M #caivalin#16, 1,"N";
       |FINSI;

       |C_M #caivalin#17, 1,snInver;
       |SI aTipoIVA = "S";
           |SI #dsmom030#28 = 2; |O #dsmom030#28 = 4; |O #dsmom030#28 = 6;
               |C_M #caivalin#17, 1, "N"; swAmorC = 1;
               #caivalin#17 = "S"; |PINTA #caivalin#17;
           |SINO;
               aAlfa = "N";
               |SI #dsmom030#32 = 3; aAlfa = "S"; swAmorC = 2; |FINSI;

               |SI ModoEntrada = 1; |O #caivalin#Campo# ! nAnterior;
                   #caivalin#17 = aAlfa; |PINTA #caivalin#17;
               |FINSI;
           |FINSI;
       |SINO;
           |SI #dsmom030#34 = 14;
               |SI ModoEntrada = 1; |O #caivalin#Campo# ! nAnterior;
                   #caivalin#17 = "S"; |PINTA #caivalin#17;
               |FINSI;
           |FINSI;
      |FINSI;
  |FINSI;

  |SI aTipoIVA ! "N";
      aPositivo = #dsmom030#96;
      aObligado = #dsmom030#97;
      nConIRPF1 = #dsmom030#98;
      aModIRPF1 = #dsmom030#99;
      |SI snReten = "N";
          aObligado = " ";
          nConIRPF1 = 0;
          aModIRPF1 = " ";
      |FINSI;
      || si en el Caivaasi se informa que no hay retenciones
      || no hace caso al control del concepto.

      |C_M #caivalin#18, 1, snReten;
      |SI aObligado = "S";
          |SI nConIRPF ! 0;
              #caivalin#18 = nConIRPF;
          |SINO;
              #caivalin#18 = nConIRPF1;
          |FINSI;
          |PINTA #caivalin#18;
          |SI aModIRPF1 = "N"; |C_M #caivalin#18, 1, "N"; |FINSI;
      |FINSI;

      |SI aObligado = "N"; |Y snFiltr = "S";
          #caivalin#18 = 0; |PINTA #caivalin#18;
          |C_M #caivalin#18, 1, "N";
      |FINSI;
  |FINSI;
|FCAL;

|CALCULO PonAlFinal; |TIPO 7;
   |C_M #caivalin#Campo#,0,alfa1;
   |SI alfa1 = "S";
       |SI eaSobreEs ! "S";
           |PTEC 816;
       |FINSI;
   |FINSI;

   |SI Campo = 19; |Y #caivalin#18 = 0; |ACABA; |FINSI;

   |SI aDescAnt ! "";
       |SI Campo = 4;
           |MENSA "    <F7> Descripcion anterior, <F8> Recoger A¤adido";
       |SINO;
           |MENSA "    <F8> Recoger A¤adido";
       |FINSI;
   |SINO;
      |PINTA 0420, "                                 ";
   |FINSI;
   |SI #caivaasi#131 = "S"; |Y enErrCarte ! 9;
       || ... Cambio siempre por si modifica alguna cosa
          xx = 2; |SI Campo = 19; xx = 3; |FINSI;
          |HAZ adaptaC2;
          #caivalin#Campo# = aAlfa1;
          |PINTA #caivalin#Campo#;
   |FINSI;
|FCAL;

|CALCULO TrasDescr; |TIPO 0;

   |SI FSalida = 15; |Y Campo = 4;
       #caivalin#4 = aDescAnt; |PINTA #caivalin#4;
       |ERROR;
   |FINSI;
   |SI FSalida = 16;
       aAntesDes1 = #camaniva#28; |QBF aAntesDes1;
       aAlfa1 =  aAntesDes1 - aAntesDes0;
       aAlfa2 = #dsmom030#1; |QBF aAlfa2;
       aAlfa2 = aAlfa2 + aAlfa1;
       #caivalin#Campo# = aAlfa2; |PINTA #caivalin#Campo#;
   |FINSI;
   |SI Campo = 4; aDescAnt = #caivalin#Campo#; |FINSI;
|FCAL;

|| ----------------------------
|CALCULO CalculaCuotas;  |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;

   impoa = #camaniva#19 + #caivalin#6;
   |SI impoa ] 3005.06; |Y swAmor = 1;
       |SI snFiltr ! "X";
           |MENAV "    Error. Bien Corriente de Ficha de Amortizacion con Importe superior a 3005,06. Revisar Importe y Concepto";
       |FINSI;
       |SI snFiltr = "S";
           swInve = 0;
           swAmor = 0;
           |PINTA 1544, "ÍÍÍÍÍÍÍÍÍÍÍÍ";
           |ERROR;
       |FINSI;
   |FINSI;
   |SI impoa < 3005.06; |Y impoa > 0; |Y aTipoIVA = "S"; |Y #caivalin#17 = "S"; |Y swAmorC ! 2;
       |CONFI  "    NBien de Inversion con Importe inferior a 3005,06. Revisar Importe y Concepto. Continuar ";
       |SI FSalida ! 0;
           |ERROR;
       |FINSI;
   |FINSI;

   |SI #caivalin#6 = Contenido; |ACABA; |FINSI;

   #caivalin#8  = (#caivalin#6 % #caivalin#7) ! EURODB; |PINTA #caivalin#8;
   #caivalin#10 = (#caivalin#6 % #caivalin#9) ! EURODB; |PINTA #caivalin#10;
   eSwCambio = 1;
|FCAL;

|PROCESO MirCta;
   |SI FSalida = 2; |ACABA; |FINSI;

   |SI aTipoIVA = "N"; |ACABA; |FINSI;

   |SI FSalida = 10;
       |SI Campo = 22;
           |HAZ CalculaIRPF;
       |FINSI;
       |SI Campo = 8;
           #caivalin#8  = (#caivalin#6 % #caivalin#7) ! EURODB; |PINTA #caivalin#8;
           eSwCambio = 1;
       |FINSI;
       |SI Campo = 10;
           #caivalin#10 = (#caivalin#6 % #caivalin#9) ! EURODB; |PINTA #caivalin#10;
           eSwCambio = 1;
       |FINSI;
   |FINSI;

   |SI aPositivo ! " "; |Y Campo ! 22;
       |SI aPositivo = "N"; |Y #caivalin#Campo# < 0;
           |HAZ FiltroNegativo;
           |SI nSwObli = 1;  |ACABA;  |FINSI;
       |FINSI;
       |SI aPositivo = "S"; |Y #caivalin#Campo# > 0;
           |HAZ FiltroNegativo;
           |SI nSwObli = 1;  |ACABA;  |FINSI;
       |FINSI;
   |FINSI;

   |SI Campo = 6;  nNume2 = 12; aAlfa2 = "CONTRAPARTIDA"; |FINSI;
   |SI Campo = 8;  nNume2 = 13; aAlfa2 = "IVA";           |FINSI;
   |SI Campo = 10; nNume2 = 14; aAlfa2 = "RECARGO";       |FINSI;
   |SI Campo = 22; nNume2 = 23; aAlfa2 = "IRPF";          |FINSI;
   |SI Campo = 11; nNume2 = 15; aAlfa2 = "DESCUENTO";     |FINSI;

   aAlfa1 =  #caivalin#nNume2#; |QBF aAlfa1;
   |SI aAlfa1 = ""; |Y #caivalin#Campo# ! 0;
       aMensa = "    NO EXISTE CUENTA DE " + aAlfa2;
       |MENAV aMensa;
       |ERROR;
   |FINSI;
|FPRC;

|CALCULO AntesCIVA; |TIPO 7;
    |SI nIva = 0; nIva = #caivalin#7; |FINSI;
    |SI enErrCarte = 9; |ACABA; |FINSI;
    aAlfa1 = #caivaasi#87;
    |SI #caivalin#7 = 0; aAlfa1 = "N"; |FINSI;
    |C_M #caivalin#8,1,aAlfa1;
|FCAL;

|CALCULO AntesCRec; |TIPO 7;
    |SI enErrCarte = 9; |ACABA; |FINSI;
    aAlfa1 = #caivaasi#88;
    |SI #caivalin#9 = 0; aAlfa1 = "N"; |FINSI;
    |C_M #caivalin#10,1,aAlfa1;
|FCAL;

|CALCULO NoIrpf; |TIPO 0;
   |SI aTipoIVA = "N";
      |SI #caivalin#6 ! 0;
         |C_M #caivalin#20,1,"N"; |C_M #caivalin#21,1,"N"; |C_M #caivalin#22,1,"N";
      |SINO;
         |C_M #caivalin#20,1,"S"; |C_M #caivalin#21,1,"S"; |C_M #caivalin#22,1,"S";
      |FINSI;
   |FINSI;
|FCAL;

||----------------------------------------------------
|CALCULO TrasTipoIVA; |TIPO 0;
   |SI FSalida = 2; |ACABA; |FINSI;

   |SI aTipoIVA = "N"; |ACABA; |FINSI;

   |SI FSalida = 10;
      efFechaIVA = #camaniva#4; |HAZ SelecTipoIVA;
      #caivalin#16 = enLineaIVA; |PINTA #caivalin#16;
      |ERROR;
   |SINO;
      efFechaIVA = #camaniva#4; enLineaIVA = #caivalin#16;
      |HAZ SacaIVA;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   nTipoAnt = Contenido;

   |SI enLineaIVA < 0;
      |MENAV "    Control de cuentas no definido";
      #caivalin#16 = 1; |PINTA #caivalin#16;
      |ERROR; |ACABA;
   |FINSI;

   #caivalin#13 = eaCtaIVA;
   #caivalin#14 = eaCtaREC;
   #caivalin#15 = eaCtaDTO;

   #caivalin#7 = enPorcIVA;  |PINTA #caivalin#7;
   #caivalin#9 = enPorcREC;  |PINTA #caivalin#9;

   #camaniva#31 = eaDesgIVA;
   #camaniva#32 = eaDesgCTP;
   #camaniva#33 = "N";
   #camaniva#34 = eaDesgDTO;

   |SI #caivalin#5  = "N";
      |SI dCtaNoD ! "";
         #caivalin#13 = dCtaNoD;
         #caivalin#14 = dCtaNoD;
      |SINO;
         #caivalin#13 = #caivalin#12;
         |SI #caivalin#9 ! 0; #caivalin#14 = #caivalin#12; |FINSI;
      |FINSI;
   |SINO;
      |SI enSwCaja = 1; |Y aCCCta ! doce;
          #caivalin#13 = aCCCta;
      |FINSI;
   |FINSI;

   |SI ModoEntrada = 1; |O #caivalin#16 ! nTipoAnt;
       #caivalin#8  = (#caivalin#6 % #caivalin#7) ! EURODB; |PINTA #caivalin#8;
       #caivalin#10 = (#caivalin#6 % #caivalin#9) ! EURODB; |PINTA #caivalin#10;
   |FINSI;

   |SI ModoEntrada = 1; |O #caivalin#16 ! Contenido;
      nError = 0;
      |SI eaReperc = "S";
          |SI #caivalin#7 = 0; |Y #caivalin#9 = 0;
             aAlfa1 = "    Este concepto Repercute, no puede informar %IVA 0. ";
             nError = 1;
          |FINSI;
      |SINO;
          |SI eaReperc = "N";
             |SI #caivalin#7 ! 0; |O #caivalin#9 ! 0;
                 aAlfa1 = "    Este concepto No Repercute, no puede informar cuota de IVA";
                 nError = 1;
             |FINSI;
          |FINSI;
      |FINSI;

      |SI eaDepar = "S"; |Y aTipoIVA = "R"; |Y snFiltr = "S"; |Y snFilAc = "S";
          || nError = 0;
          |SI #caivalin#7 ! 0;
             |SI enTipoIva = 1;
                 nError = 1;
                 aAlfa1 = "IVA en Actividad Exenta.";
             |SINO;
                |SI enTipoIva = 2;
                   |SI enTVolOpe = 12; |O enTVolOpe = 11;
                      nError = 1;
                      aAlfa1 = "IVA con un Concepto de Operacion Exenta.";
                   |FINSI;
                |FINSI;
             |FINSI;
          |SINO;
             |SI enTipoIva = 2; |Y enTVolOpe = 1;
                nError = 1;
                aAlfa1 = "IVA al 0% con un Concepto de Operacion no Exenta.";
             |FINSI;
          |FINSI;
      |FINSI;

      |SI enSwCaja = 1; |Y #caivalin#10 ! 0;
          nError = 1;
          aAlfa1 = "Fra. en Criterio de Caja. No puede tener Recargo de Equivalencia";
      |FINSI;

      |SI nError = 1;
           aAlfa1 = "    N" + aAlfa1 + " Continuar ";
           |CONFI aAlfa1;
           |SI FSalida ! 0;
               |ERROR;
               |PTEC 808;
               |C_M #caivalin#25, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
               |C_M #caivalin#17, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
               |C_M #caivalin#29, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
               |C_M #caivalin#5, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
               |C_M #caivalin#4, 0, aAlfa1; |SI aAlfa1 = "S"; |PTEC 808; |FINSI;
           |FINSI;
      |FINSI;
   |FINSI;
|FCAL;
|| ---------------------------------------------------------------

|CALCULO AntesCta_L; |TIPO 7;
   |C_M #caivalin#Campo#,0, aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada = 2; |Y enSwDejar = 1;
       |ABRE #100;
       #100#0 = #caivalin#0;
       #100#1 = #caivalin#1;
       #100#2 = #caivalin#2;
       |LEE 001#100=;
       |SI FSalida ! 0;
           |DDEFECTO #100;
           #100#0 = #caivalin#0;
           #100#1 = #caivalin#1;
           #100#2 = #caivalin#2;
           |GRABA 020#100b;
       |FINSI;
       |SI Campo = 12; |Y #100#24 = "N";
           #100#24 = "S";
           #100#12 = #caivalin#12;
           |GRABA 020#100a;
       |FINSI;
       |SI Campo = 28; |Y  #100#25 = "N";
            #100#28 = #caivalin#28;
            #100#25 = "S";
            |GRABA 020#100a;
       |FINSI;
       |CIERRA #100;
   |FINSI;
|FCAL;

|CALCULO Cuenta_L; |TIPO 6;             || Contrapartida
   |C_M #caivalin#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   |HAZ NoBlanca;

   eaCuenta = #caivalin#Campo#;
   salidas  = FSalida;
   |HAZ FiltraPuntos;
   #caivalin#Campo# = eaCuenta;
   |PINTA #caivalin#Campo#;
|FCAL;

|CALCULO TrasCuenta_L; |TIPO 0;
   |C_M #caivalin#Campo#,0,alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   emCta    = 1;
   enDiarioNivel = #camaniva#7;
   eaCuenta = #caivalin#Campo#;
   |HAZ SacaNivel;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea
   |HAZ LeeCuenta;
   |SI eswCta ! 0;  |ACABA; |FINSI;  ||Cuenta erronea

   |SI Campo = 12; |O aTipoIVA = "N";
       |PINTA 2344, "ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ";
       |QBF eaNomCta;
       |ATRI S; |PINTA 2344, eaNomCta; |ATRI 0;
       |SI Campo = 12; eaSiiCtr = eaNomCta; |FINSI;
   |FINSI;

   enConcepto = #caivalin#3;
   |SI aTipoIVA ! "N"; |Y Campo = 23;
       enConcepto = #caivalin#18;
   |FINSI;
   |HAZ FiltraCtaIG;

   |SI Campo = 12; |Y #caivalin#5 = "N";
      |SI dCtaNoD ! "";
         #caivalin#13 = dCtaNoD;
         #caivalin#14 = dCtaNoD;
      |SINO;
         #caivalin#13 = #caivalin#12;
         |SI #caivalin#9 ! 0; #caivalin#14 = #caivalin#12; |FINSI;
      |FINSI;
   |FINSI;
|FCAL;

|PROCESO FiltroObligado;
   |C_M #caivalin#Campo#,0,aAlfa;
   |SI aAlfa = "N"; |ACABA; |FINSI;

   |SI Campo = 18;
       aAlfa2 = "concepto";
   |SINO;
       aAlfa2 = "Importe";
   |FINSI;
   aAlfa1 = "sin Retencion";
   |SI aObligado = "S"; aAlfa1 = "con Retencion Obligada"; |FINSI;

   nSwObli = 0;
   |SI snFiltr ! "X";
       |SI snFiltr = "S";
           aAlfa = "    Factura " + aAlfa1;
           |SI aObligado = "S"; aAlfa = aAlfa  + ", introduzca " + aAlfa2; |FINSI;
           |MENAV aAlfa;
           nSwObli = 1;
       |SINO;
           aAlfa = "    NFactura "+ aAlfa1 + ", continuar";
           |CONFI aAlfa;
           |SI FSalida ! 0;
               nSwObli = 1;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI nSwObli = 1;
       |SI Campo = 18;
           #caivalin#18 = nConIRPF1;
           |SI nConIRPF ! 0; #caivalin#18 = nConIRPF; |FINSI;
           |SI aObligado = "N"; #caivalin#18 = 0; |FINSI;
           |PINTA #caivalin#18;
       |FINSI;
       |ERROR;
   |FINSI;
|FPRC;

|PROCESO FiltroNegativo;
   |C_M #caivalin#Campo#,0,aAlfa;
   |SI aAlfa = "N"; |ACABA; |FINSI;

   aAlfa = "negativos"; |SI aPositivo = "S"; aAlfa = "positivos"; |FINSI;

   nSwObli = 0;
   |SI snFiltr ! "X";
       |SI snFiltr = "S";
           aAlfa = "0000El Concepto NO admite " + aAlfa;
           |MENAV aAlfa;
           nSwObli = 1;
           |ERROR;
       |SINO;
           aAlfa = "0000NEl Concepto NO admite " + aAlfa + ". Continuar";
           |CONFI aAlfa;
           |SI FSalida ! 0;
               nSwObli = 1;
               |ERROR;
           |FINSI;
       |FINSI;
   |FINSI;
|FPRC;

|| ---------------------------------------
|CALCULO TrasConcepto2;  |TIPO 0;     ||Concepto IRPF
   |SI FSalida = 2; |ACABA; |FINSI;

   |C_M #caivalin#Campo#,0,aModi;

   |SI #camaniva#36 = "N"; |ACABA; |FINSI;

   |SI FSalida = 10;
       eaFiCon = aFich2;
       enConcepto = #caivalin#18;
       |HAZ VerConcepto;
       #caivalin#18 = enConcepto; |PINTA #caivalin#18;
   |FINSI;

   |SI enSi111 = 1; |Y #caivaasi#167 ! "X"; |Y #caivalin#18 ! 0; |Y ModoEntrLin = 1;
       eSwReten = 2;
       enPanMod = 0;
       eaFecMod = #camaniva#4;
       enPerMod = #camaniva#5;
       enConIRPF = #caivalin#18;
       |HAZ ConsulModIVA;
       |SI enEmiMod = 1; |Y #caivaasi#167 ! "S";
           #caivalin#18 = 0; |PINTA #caivalin#18;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   |SI #caivalin#18 ! 0; |Y aObligado = "N";
       |HAZ FiltroObligado;
       |SI nSwObli = 1; |ACABA; |FINSI;
   |FINSI;

   |SI #caivalin#18 = 0;
       |SI aObligado = "S";
           |HAZ FiltroObligado;
           |SI nSwObli = 1; |ACABA; |FINSI;
       |FINSI;

       |C_M #caivalin#19,1,"N";
       |C_M #caivalin#20,1,"N";
       |C_M #caivalin#21,1,"N";
       |C_M #caivalin#22,1,"N";
       |C_M #caivalin#23,1,"N";
       #caivalin#19 = "";  |PINTA #caivalin#19;
       #caivalin#20 = 0;   |PINTA #caivalin#20;
       #caivalin#21 = 0;   |PINTA #caivalin#21;
       #caivalin#22 = 0;   |PINTA #caivalin#22;
       #caivalin#23 = "";
       nAnteriorIRPF = 0;
       |ACABA;
   |SINO;
       |C_M #caivalin#19,1, snDIrpf;
       |C_M #caivalin#20,1, snBIrpf;
       |C_M #caivalin#21,1, snTpIrpf;
       |C_M #caivalin#22,1, snCIrpf;
       |C_M #caivalin#23,1,"S";
   |FINSI;

   |SI #caivalin#18 < nDCIrpf; |O #caivalin#18 > nHCIrpf;
       |SI snFiltr ! "X";
           |MENAV "    Error, Concepto Contable no Correcto ";
       |FINSI;
       |SI snFiltr = "S";
           nAnteriorIRPF = 0;
           |ERROR;
           |ACABA;
       |FINSI;
   |FINSI;

   enLibIVA  = #camaniva#0;
   enFilConc = 3;        || Concepto de IRPF
   enConcepto = #caivalin#18;
   |HAZ FiltroConcepto;  |SI eswLect ! 0; |ACABA; |FINSI;

   |SI snFiMod = "S";
       enPanMod = 0;
       eaFecMod  = #camaniva#4;
       enPerMod = #camaniva#5;
       |HAZ ConsulPlan;
       |SI enExiMod = 0; |Y snSeMod = "N";
           |ERROR;
           |SI aModi = "N";
               |PTEC 808;
           |FINSI;
           |ACABA;
       |FINSI;
   |FINSI;

   aM030_92 = dTIrpf;
   nM030_93 = dTpIrpf;
   |SI #dsmom030#92 ! " "; aM030_92 = #dsmom030#92; |FINSI;
   |SI #dsmom030#93 ! 0;   nM030_93 = #dsmom030#93; |FINSI;

   |SI #caivalin#18 ! nAnteriorIRPF;
       #caivalin#19 = #dsmom030#1; |PINTA #caivalin#19;
       #caivalin#21 = nM030_93;    |PINTA #caivalin#21;
   |FINSI;
   |SI ModoEntrada = 1; |O #caivalin#18 ! nAnteriorIRPF;
       #caivalin#23 = eaCtaIVA;    |PINTA #caivalin#23;
   |FINSI;
   nAnteriorIRPF = #caivalin#18;

   nNume1 = enSi340;
   |HAZ Nuevo340;

   |SI #dsmom030#38 = 180; |Y aTipoIVA = "S"; |Y enEjercicio > 2011;
       |SI #camaniva#42 ! "R"; |Y #camaniva#42 ! "D"; |Y enSi340 = 1;
           |CONFI "    SFra con Retencion Mod.180 y Clave 340 diferente a <R>. Modificarla ?";
           |SI FSalida = 0;
               #camaniva#42 = "R"; |PINTA #camaniva#42;
           |FINSI;
       |FINSI;
   |FINSI;
   enSi340 = nNume1;
|FCAL;

|PROCESO Nuevo340;
     nAny = enEjercicio;
     |SI dig1 ! 1; |Y #camaniva#5 < dig1; nAny = enEjercicio + 1; |FINSI;

     |SI nAny ] 2017;
         nOk = 0;
         |SI enTipoIva = 11;  nOk = 1;  |FINSI;
         |SI enTipoIva = 12;  nOk = 1;  |FINSI;
         |SI enTipoIva = 13;  nOk = 1;  |FINSI;
         |SI enTipoIva = 15;  nOk = 1;  |FINSI;
         |SI enTipoIva = 16;  nOk = 1;  |FINSI;
         |SI enTipoIva = 17;  nOk = 1;  |FINSI;
         |SI #caivaasi#188 = "S";  nOk = 1; |FINSI;
         |SI nOk = 1;
             enSi340 = 1;
         |SINO;
             |SI enBaja340 ! 0;
                |SI nAny > enBajE340; enSi340 = 0; |FINSI;
                |SI nAny = enBajE340; |Y #camaniva#5 > enBaja340; enSi340 = 0; |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|CALCULO AntesBIrpf; |TIPO 7;

 |SI aTipoIVA = "N"; |ACABA; |FINSI;

 ModoEntrada = (FEntrada / 100) ! 0;
 |SI #caivalin#18 ! 0;   ||  |Y #caivalin#20 = 0;

     |SI aM030_92 = "B";
         #caivalin#20 = #caivalin#6;
     |SINO;
         #caivalin#20 = #caivalin#6 + #caivalin#8 + #caivalin#10;
     |FINSI;
     |PINTA #caivalin#20;
 |FINSI;
|FCAL;

|CALCULO TrasBIrpf; |TIPO 0;

 |SI aTipoIVA = "N"; |ACABA; |FINSI;
 inkey = FSalida;

 |C_M #caivalin#20,0,aAlfa1;
 |SI aAlfa1 = "S";
       |SI inkey = 10; |O inkey = 11;
           |SI inkey = 10;
               #caivalin#20 = #caivalin#6;
           |SINO;
               #caivalin#20 = #caivalin#6 + #caivalin#8 + #caivalin#10;
           |FINSI;
           |PINTA #caivalin#20;
       |FINSI;
 |FINSI;

 |SI aObligado = "S"; |Y #caivalin#20 = 0;
     |HAZ FiltroObligado;
     |SI nSwObli = 1; |ACABA; |FINSI;
 |FINSI;
 |SI aObligado = "N"; |Y #caivalin#20 ! 0;
     |HAZ FiltroObligado;
     |SI nSwObli = 1; |ACABA; |FINSI;
 |FINSI;

 |HAZ CalculaIRPF;

|FCAL;

|PROCESO CalculaIRPF;
   #caivalin#22 = (#caivalin#20 % #caivalin#21) ! EURODB;
   |PINTA #caivalin#22;
   eSwCambio = 1;
|FPRC;

|| ----------------------------------------------
|CALCULO AntesAna; |TIPO 7;
 ModoEntrLin = (FEntrada / 100) ! 0;

 alfa1 = "    <F2> Consulta Cta Analitica";
 alfa2 = #caivalin#Campo#; alfa2 = alfa2 % 103;
 |SI alfa2 = "GRU"; |Y eaGAna ! "S";
      alfa1 = "    <F2>Consulta Cta Analitica, Grupo:<F3>Modificar,<F4>Recalcular,<F5>Consulta";
 |FINSI;
 |MENSA alfa1;

 |SI enSwAna = 1;

     |HAZ AntesCta_L; ||para grabar lo que habia

     eaCuenta = #caivalin#12;
     |HAZ LeeTablaAna;
     |SI swRelac = 0;
         |SI ModoEntrLin = 1; #caivalin#28 = eaCtaAna; |FINSI;
         |C_M #caivalin#28,1,eaAnaMod;
     |SINO;
         |SI ModoEntrLin = 1; #caivalin#28 = ""; |FINSI;
         |SI eaPAna = "S";
             |C_M #caivalin#28,1,"N";
         |SINO;
             |C_M #caivalin#28,1,"S";
         |FINSI;
     |FINSI;
     |PINTA #caivalin#28;
     eaCtaAna = #caivalin#28;
     |HAZ eLimCtaAna7;
     |SI enBuenaAna ! 0; |C_M #caivalin#28,1,"S"; |FINSI;
 |FINSI;
|FCAL;

|CALCULO anacta; |TIPO 0;

   inkey = FSalida;
   |SI inkey = 2;   |ACABA; |FINSI;
   |SI enSwAna = 0; |ACABA; |FINSI;

   |SI inkey = 15;
       #caivalin#28 = caant;
       |PINTA #caivalin#28;
       |VETE ParaSalir;
   |FINSI;

   salidas = FSalida; |HAZ FPuntosAna;

   eOpAna = 0; || 1 = Consulta pantalla
   |SI inkey = 10; eOpAna = 1;  |FINSI;
   eaCtaAna = #caivalin#28;
   |HAZ LeeCtaAna;
   |SI eswLect = 1;
        |MENAV "    Error.! No Existe Cuenta Analitica";
        |ERROR;
        |ACABA;
   |SINO;
       #caivalin#28 = eaCtaAna;
       |PINTA #caivalin#28;
       caant = #caivalin#28;

  |FINSI;
|| ---------------------------------------------------------
 |ET ParaSalir;
|| ...  Comprobar validez de la cuenta analitica segun limites definidos
  eaCtaAna = #1#28;
  |HAZ eLimCtaAna;
  |SI enBuenaAna ! 0;
      |MENAV eaBuenaAna;
      |ERROR;
      |ACABA;
  |FINSI;

   enQueAna = 5;
   |SI inkey = 13; enQueAna = 0; |FINSI;
   |SI inkey = 11; enQueAna = 1; |FINSI;
   |SI inkey = 12; enQueAna = 2; |FINSI;
   |HAZ GrupoAna;
|FCAL;

|PROCESO GrupoAna;

  |SI eaGAna = "S"; |ACABA; |FINSI; ||No existe reparto especifico

  alfa1 = #1#28; alfa1 = alfa1 % 103;
  |SI alfa1 ! "GRU";
      enQueAna = 4;
  |FINSI;

      nSwGrupo = 0;
      enDiAna = #camaniva#0;
      efFeAna = #camaniva#4;
      enDoAna = #camaniva#1;
      enApAna = #caivalin#2;
      eaGrAna = #caivalin#28;
      enImAna = #caivalin#6;

      |PUSHV 0622 2380;
      |SUB_EJECUTA_NP "anw00012";
      |POPV;
      |SI nSwGrupo = 1;
          |ERROR;
      |FINSI;
      |SI aTipoIVA = "N"; |PONCONTROL 23, "si"; |FINSI;
|FPRC;

|PROCESO QuitaMarcaDSCOMER;
     |ABRE #caivaasi;
     |LEE 000#caivaasi.p;
     |SI FSalida ! 0; |DDEFECTO #caivaasi; |FINSI;
     |CIERRA #caivaasi;

     |SI #caivaasi#191 = "N";
         |ACABA;
     |FINSI;

     eaSer = #camaniva#2;
     enFac = #camaniva#3;
     eaTip = #camaniva#36;
     |SUB_EJECUTA "gadz0102";
|FPRC;

|PROCESO El1L;  |TIPO 1;
  ModoEntrLin = (FEntrada / 100) ! 0;
  |SI ModoEntrLin = 3; |Y enTipoAsto > 100;
      |MENAV "    IMPORTES DE LA FACTURA NO MODIFICABLES. NO PUEDE BORRAR LAS LINEA DE BASE";
      |ERROR;
      |ACABA;
  |FINSI;

  eSwCambio = 1;

  |SI enSwAna = 0;  |ACABA; |FINSI;    || si no es analitica

  |SI ModoEntrLin = 3;
      alfa1 = #1#28; alfa1 = alfa1 % 103;
      |SI alfa1 = "GRU";
          |ABRE #212;
          #212#0 = #camaniva#0;
          #212#2 = #camaniva#1;
          #212#3 = #1#2;
          #212#4 = #1#28;
          |LEE 101#212=;
          |SI FSalida = 0;
              |BUCLELIN 1NULL#212;
              |BORRA 020#212a;
          |FINSI;
          |LIBERA #212;
          |CIERRA #212;
       |FINSI;
       eSwCambio = 1;
  |FINSI;
|FPRC;

|CALCULO AntesDepar_l; |TIPO 7;
   |C_M #caivalin#Campo#, 0, alfa1;
   |SI alfa1 = "S"
      |SI Haybasica = 1;
          |MENSA "    <F2> Consultar Actividades";
      |SINO;
          |MENSA "    <F2> Consultar Departamentos";
      |FINSI;
   |FINSI;

   alfa1 = #caivalin#Campo#; |QBF alfa1;
   |SI alfa1 = "";
       #caivalin#Campo# = #camaniva#10; |PINTA #caivalin#Campo#;
   |FINSI;
|FCAL;

|PROCESO SuboConcepto_l;
 ||aqui
|FPRC;

|CALCULO TrasDepar_l; |TIPO 0;
   |SI eaDepar = "N"; |ACABA; |FINSI;
   |SI FSalida = 2;   |ACABA;  |FINSI;

   |C_M #caivalin#Campo#, 0, alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   eOpDep = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpDep = 1;  |FINSI;
   |SI eOpDep = 0; |Y #caivalin#30 = #camaniva#10; |ACABA; |FINSI;

   enActividad = #caivalin#30;
   eaCodDep    = #caivalin#30;
   |HAZ Actividad;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Actividad / Departamento";
       |C_M #caivalin#30, 1, "S";
       |ERROR;
   |SINO;
       alfa1 = enActividad;
       |SI Haybasica = 1;
           alfa1 = ("00" + alfa1) % A02;
           |SI aTipoIVA ! "N";
               enFilRegIVA = 1;
               enConcepto  = #caivalin#3;
               |HAZ FilRegimenIVA;
               |SI eswLect ! 0; |HAZ SuboConcepto_l; |ACABA; |FINSI;
           |FINSI;
       |FINSI;

       #caivalin#30 = eaCodDep;    |PINTA #caivalin#30;
       |SI efActFin > "01.01.1900"; |Y snFilBa = "S";
           aAlfa1 = "    NAtencion!!!. Actividad con Fecha de BAJA " + efActFin + ", Desea introducir Facturas ? ";
           |CONFI aAlfa1;
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
       |SI eaEsCom = "S";
           |CONFI "    NAtencion!!!. Actividad Comunera, ¨ Desea introducir Facturas ? ";
           |SI FSalida ! 0;
               |ERROR;
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;
|FCAL;

|CALCULO AntesSubde_l; |TIPO 7;
   |C_M #caivalin#Campo#, 0, alfa1;
   |SI alfa1  = "S";
      |SI Haybasica = 1;
          |SI enArrend ! 2;
              |MENSA "    Subdepartamento. <F2> Consultar Referencias Catastrales";
          |SINO;
              |MENSA "    Subdepartamento. <F2> Consultar Cultivos";
          |FINSI;
      |FINSI;
   |FINSI;
   alfa1 = #caivalin#Campo#; |QBF alfa1;
   |SI alfa1 = "";
       #caivalin#Campo# = #camaniva#11; |PINTA #caivalin#Campo#;
   |FINSI;
|FCAL;

|CALCULO TrasSubde_l; |TIPO 0;
   |SI eaSubde = "N"; |ACABA; |FINSI;

   |C_M #caivalin#Campo#, 0, alfa1;
   |SI alfa1 = "N"; |ACABA; |FINSI;

   eOpSub = 0; || 1 = Consulta pantalla
   |SI FSalida = 10; eOpSub = 1;  |FINSI;
   |SI FSalida = 11; eOpSub = 2;  |FINSI;

   |SI eOpSub = 0; |Y #caivalin#31 = #camaniva#11; |ACABA; |FINSI;
   enConcepto  = #caivalin#3;
   eaCodSubdep = #caivalin#31;
   enQue = 1;
   |HAZ SubActividad;
   enQue = 0;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Subdepartamento";
       |ERROR;
   |SINO;
       #caivalin#31 = eaCodSubdep; |PINTA #caivalin#31;
   |FINSI;
|FCAL;
|| ---------------------------------------------------------
|PROCESO Pantalla1;
   |ATRI R;

   |PINTA 1602, "Li Con Descripcion               D C I IC";
   |ATRI 0;
   |PINTA 1644, "Tipo IVA:      Contrap.:             ";
   |PINTA 1744, "IRPF.:                               ";
   |PINTA 1844, "Base Impo.:               E:    R:   ";
   |PINTA 1944, "IVA :      %              Descuentos ";
   |PINTA 2044, "Rec.:      %                         ";
   |PINTA 2144, "IRPF:              Cta:              ";
   |PINTA 2244, "      %               Dp:    Sd:     ";
   |PINTA 2344, "ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ";

   |ATRI I;
   |PINTA 2144, "IRPF:";
   |PINTA 2163, "Cta:";
   |ATRI N;

   |ATRI P;
   |PINTA 2266, "Dp:";
   |PINTA 2273, "Sd:";
   |ATRI N;

   alfa1 = &186;
   |PINTA 1680, alfa1; |PINTA 1780, alfa1;
   |PINTA 1880, alfa1; |PINTA 1980, alfa1;
   |PINTA 2080, alfa1; |PINTA 2180, alfa1;
   |PINTA 2243, alfa1; |PINTA 2280, alfa1;

   |PINTA 1734, " "; |PINTA 1736, " "; |PINTA 1738, " "; |PINTA 1740, "  ";
   |PINTA 1834, " "; |PINTA 1836, " "; |PINTA 1838, " "; |PINTA 1840, "  ";
   |PINTA 1934, " "; |PINTA 1936, " "; |PINTA 1938, " "; |PINTA 1940, "  ";
   |PINTA 2034, " "; |PINTA 2036, " "; |PINTA 2038, " "; |PINTA 2040, "  ";
   |PINTA 2134, " "; |PINTA 2136, " "; |PINTA 2138, " "; |PINTA 2140, "  ";
   |PINTA 2234, " "; |PINTA 2236, " "; |PINTA 2238, " "; |PINTA 2240, "  ";

   alfa1 = #caivaasi#69;        ||Descuento
   |C_M #caivalin#11, 1, alfa1; |C_V #caivalin#11, 1, alfa1;
   |C_P #caivalin#11,1,2070; |SI alfa1 = "S"; |PINTA 2070, #caivalin#11; |FINSI;

   |C_A #caivalin#4,1,25;
   |C_V #caivalin#5 ,1,"S"; |C_M #caivalin#5 ,1,"S";
   |C_V #caivalin#6 ,1,"S"; |C_M #caivalin#6 ,1,"S"; |C_P #caivalin#6 ,1,1857; |PINTA 1857, #caivalin#6;
   |C_V #caivalin#7 ,1,"S";                          |C_P #caivalin#7 ,1,1950; |PINTA 1950, #caivalin#7;
   |C_V #caivalin#8 ,1,"S";                          |C_P #caivalin#8 ,1,1957; |PINTA 1957, #caivalin#8;
   |C_V #caivalin#9 ,1,"S";                          |C_P #caivalin#9 ,1,2050; |PINTA 2050, #caivalin#9;
   |C_V #caivalin#10,1,"S";                          |C_P #caivalin#10,1,2057; |PINTA 2057, #caivalin#10;
   |C_V #caivalin#12,1,"S"; |C_M #caivalin#12,1,"S"; |C_P #caivalin#12,1,1668; |PINTA 1668, #caivalin#12;

   |C_V #caivalin#16,1,"S"; |C_M #caivalin#16,1,"S"; |C_P #caivalin#16,1,1654; |PINTA 1654, #caivalin#16;
   |C_V #caivalin#17,1,"S"; |C_M #caivalin#17,1,"S"; |C_P #caivalin#17,1,1739;|| |PINTA 1739, #caivalin#17;
   |C_V #caivalin#18,1,"S"; |C_M #caivalin#18,1,"S"; |C_P #caivalin#18,1,1751; |PINTA 1751, #caivalin#18;
   |C_V #caivalin#19,1,"S"; |C_M #caivalin#19,1,"S"; |C_P #caivalin#19,1,1755; |PINTA 1755, #caivalin#19;
   |C_V #caivalin#20,1,"S"; |C_M #caivalin#20,1,"S"; |C_P #caivalin#20,1,2150; |PINTA 2150, #caivalin#20;
   |C_V #caivalin#21,1,"S"; |C_M #caivalin#21,1,"S"; |C_P #caivalin#21,1,2244; |PINTA 2244, #caivalin#21;
   |C_V #caivalin#22,1,"S";                          |C_P #caivalin#22,1,2252; |PINTA 2252, #caivalin#22;
   |C_V #caivalin#23,1,"S";                          |C_P #caivalin#23,1,2168; |PINTA 2168, #caivalin#23;
                                                     |C_P #caivalin#26,1,1873; |PINTA 1873, #caivalin#26;
                                                     |C_P #caivalin#27,1,1879; |PINTA 1879, #caivalin#27;
                                                     |C_P #caivalin#30,1,2270; |PINTA 2270, #caivalin#30; ||nuevos
                                                     |C_P #caivalin#31,1,2277; |PINTA 2277, #caivalin#31;
   |C_V #caivalin#25,1,"S";

   |C_V #caivalin#29,1,"S"; |C_M #caivalin#29,1,"N";
   |SI aTipoIVA = "S"; |Y enNumAct > 1; |C_M #caivalin#29,1,"S"; |FINSI;

   |HAZ TomaDefectos_L;
|FPRC;

|PROCESO Pantalla3;
   |ATRI R;
   |PINTA 1602, "Li Con Descripcion                       ";
   |PINTA 1644, " I.R.P.F.                            ";
   |ATRI N;
   |PINTA 1744, " Base Imponible:                       ";
   |PINTA 1844, " Descuentos ...:                       ";
   |PINTA 1944, " Base I.R.P.F..:                       ";
   |PINTA 2044, " IRPF %                                ";
   |PINTA 2144, " Contrapartida.:                       ";
   |PINTA 2244, " En Especie ...:      Repercute:       ";
   |PINTA 2344, "ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ";
   alfa1 = &186;
   |PINTA 1680, alfa1; |PINTA 1780, alfa1;
   |PINTA 1880, alfa1; |PINTA 1980, alfa1;
   |PINTA 2080, alfa1; |PINTA 2180, alfa1;
   |PINTA 2243, alfa1; |PINTA 2280, alfa1;

|| |ATRI P;
|| |PINTA 1774, "Dp:"
|| |PINTA 1874, "Sd:"
|| |ATRI 0;

   |C_A #caivalin#4,1,34;
   |C_V #caivalin#5 ,1,"N"; |C_M #caivalin#5 ,1,"N";
   |C_V #caivalin#6 ,1,"S"; |C_M #caivalin#6 ,1,"S"; |C_P #caivalin#6 ,1,1761; |PINTA 1761, #caivalin#6;
   |C_V #caivalin#7 ,1,"N"; |C_M #caivalin#7 ,1,"N";
   |C_V #caivalin#8 ,1,"N"; |C_M #caivalin#8 ,1,"N";
   |C_V #caivalin#9 ,1,"N"; |C_M #caivalin#9 ,1,"N";
   |C_V #caivalin#10,1,"N"; |C_M #caivalin#10,1,"N";
   |C_V #caivalin#11,1,"S"; |C_M #caivalin#11,1,"S"; |C_P #caivalin#11,1,1863; |PINTA 1863, #caivalin#11;
   |C_V #caivalin#12,1,"N"; |C_M #caivalin#12,1,"N";
   |C_V #caivalin#16,1,"N"; |C_M #caivalin#16,1,"N";
   |C_V #caivalin#17,1,"N"; |C_M #caivalin#17,1,"N";
   |C_V #caivalin#18,1,"N"; |C_M #caivalin#18,1,"N";
   |C_V #caivalin#19,1,"N"; |C_M #caivalin#19,1,"N";
   |C_V #caivalin#20,1,"S"; |C_M #caivalin#20,1,"S"; |C_P #caivalin#20,1,1961; |PINTA 1961, #caivalin#20;
   |C_V #caivalin#21,1,"S"; |C_M #caivalin#21,1,"S"; |C_P #caivalin#21,1,2053; |PINTA 2053, #caivalin#21;
   |C_V #caivalin#22,1,"S"; |C_M #caivalin#22,1,"S"; |C_P #caivalin#22,1,2061; |PINTA 2061, #caivalin#22;
   |C_V #caivalin#23,1,"S"; |C_M #caivalin#23,1,"S"; |C_P #caivalin#23,1,2161; |PINTA 2161, #caivalin#23;

   |C_V #caivalin#25,1,"N";
                                                     |C_P #caivalin#26,1,2261; |PINTA 2261, #caivalin#26;
                                                     |C_P #caivalin#27,1,2277; |PINTA 2277, #caivalin#27;

   |C_V #caivalin#30,1,"N"; |C_M #caivalin#30,1,"N"; |C_P #caivalin#30,1,1777; || |PINTA 1777, #caivalin#30;
   |C_V #caivalin#31,1,"N"; |C_M #caivalin#31,1,"N"; |C_P #caivalin#31,1,1877; || |PINTA 1877, #caivalin#31;

   |C_V #caivalin#29,1,"N"; |C_M #caivalin#29,1,"N";
   Comodin = "|NC";
   Calc = #camaniva#Comodin# - 1;
   |PARA Cont = 0; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
      |C_V #camaniva#Cont#,0,Comodin;
      |SI Comodin = "S"; |Y Cont ! 39;
         |PINTA #camaniva#Cont#;
      |FINSI;
   |SIGUE;
|FPRC;

|| ************ Calculos de Lineas
|RUTINA inf;
   #caivalin#0 = #camaniva#0;
   #caivalin#1 = #camaniva#1;
   #caivalin#2 = 01;
|FRUT;

|RUTINA sup;
   #caivalin#0 = #camaniva#0;
   #caivalin#1 = #camaniva#1;
   #caivalin#2 = 99;
|FRUT;

|RUTINA infer;
   #caivalin@#0 = #camaniva#0;
   #caivalin@#1 = #camaniva#1;
   #caivalin@#2 = 01;
|FRUT;

|RUTINA super;
   #caivalin@#0 = #camaniva#0;
   #caivalin@#1 = #camaniva#1;
   #caivalin@#2 = 99;
|FRUT;

|PROCESO BorraCob;
     |DDEFECTO #Puente@;
     #Puente@#0  = #calincob#0;
     #Puente@#1  = #calincob#2;
     #Puente@#2  = #calincob#1;
     #Puente@#3  = #calincob#3;
     #Puente@#5  = #calincob#6;
     #Puente@#22 = nCont;
     #Puente@#23 = #48#2;
     #Puente@#24 = #48#3;
     #Puente@#27 = "V";
     #Puente@#28 = "B";
     #Puente@#35 = " ";
     |GRABA 020#Puente@.n;
     nCont = nCont + 1;
     |BORRA 020#calincob.a;
     |LIBERA #calincob;
|FPRC;

|DEFBUCLE BorraCob;
 #calincob#1;
 ;
 #camaniva#0,#camaniva#2,#camaniva#3,001;
 #camaniva#0,#camaniva#2,#camaniva#3,999;
 be;
 NULL,BorraCob;
|FIN;

|PROCESO BorraPag;
     |DDEFECTO #Puente@;
     #Puente@#0  = #calinpag#0;
     #Puente@#1  = #calinpag#2;
     #Puente@#2  = #calinpag#1;
     #Puente@#3  = #calinpag#3;
     #Puente@#5  = #calinpag#6;
     #Puente@#22 = nCont;
     #Puente@#23 = #48#2;
     #Puente@#24 = #48#3;
     #Puente@#27 = "C";
     #Puente@#28 = "B";
     #Puente@#35 = " ";
     |GRABA 020#Puente@.n;
     nCont = nCont + 1;
     |BORRA 020#calinpag.a;
     |LIBERA #calinpag;
|FPRC;

|DEFBUCLE BorraPag;
#calinpag#1;
;
#camaniva#0,#camaniva#2,#camaniva#3,001;
#camaniva#0,#camaniva#2,#camaniva#3,999;
;
NULL,BorraPag;
|FIN;

|| ***********************************************************************
|| *************************************** Programa
|PROGRAMA;
     eaMensaCad = "9";
     |HAZ ControlCaducidad;
     |SI enErrorCad = 1;
         |ACABA;
     |FINSI;

   |HAZ inicio;
   |HAZ Analitica;
   |SI enSwAna = 1;
       |C_V #1#28,1,"S";
       |C_M #1#28,1,"S";
   |FINSI;
   |HAZ CuentoActiv;

   aUsu = Usuario % 108;
   aUsu = (aUsu + "        ") % 108;

   eaFitW17 = ("7w" + Usuario) % 108;
   |NOME_DAT #917 eaFitW17;

   eaFitnW12 = ("2w" + Usuario) % 108;
   |NOME_DAT #212 eaFitnW12;
   eaFitnW13 = ("3w" + Usuario) % 108;
   |NOME_DAT #213 eaFitnW13;

   aFichero = "11" + Usuario;
   |NOME_DAT #100 aFichero;
   |DELINDEX #100;

   aFichero = ("z" + Usuario) %108;
   |NOME_DAT #902 aFichero;
   |DELINDEX #902;

         |SI swVarios = 1; |Y dirfich0 ! "";
             |PATH_DAT #0  dirfich0;
             |PATH_DAT #1  dirfich0;
             |PATH_DAT #2  dirfich0;
             |PATH_DAT #3  dirfich0;
             |PATH_DAT #5  dirfich0;
             |PATH_DAT #8  dirfich0;
             |PATH_DAT #11 dirfich0;
             |PATH_DAT #12 dirfich0;
             |PATH_DAT #31 dirfich0;
             |PATH_DAT #111 dirfich0;
             |PATH_DAT #caivaasi#dirfich0#;
             |PATH_DAT #caivaaxx#dirfich0#;
             |PATH_DAT #202 dirfich0;
             |PATH_DAT #1000 dirfich0;
             |PATH_DAT #1001 dirfich0;
             |PATH_DAT #900 dirfich0;
             |PATH_DAT #901 dirfich0;
             |PATH_DAT #902 dirfich0;
             |PATH_DAT #917 dirfich0;
             |PATH_DAT #990 dirfich0;
             |PATH_DAT #110 dirfich0;
             |PATH_DAT #112 dirfich0;
             |PATH_DAT #113 dirfich0;
             |PATH_DAT #212 dirfich0;
             |PATH_DAT #213 dirfich0;
             |PATH_DAT #100 dirfich0;
             |PATH_DAT #220 dirfich0;

             |PATH_DAT #501 dirfich0;
             |PATH_DAT #502 dirfich0;
             |PATH_DAT #503 dirfich0;
             fich_alta = dirfich0;
         |FINSI;

   |HAZ Consul303;
   |HAZ eLeeParametro;

   nMenCaja = 0;
   |ABRE #camaniva;
   |PONCONTROL 23, "si";
   aParam = PARAMETRO; |QBF aParam;
   |SI aParam ! "";
      |SI enSwSalir = 2; nMenCaja = 1; |FINSI;
      enErrCarte = 0;
      aTipoIVA   = aParam % 0101;
      aDiario    = aParam % 0302; nDiario = aDiario;
      aFecha     = aParam % 0610; fFecha  = aFecha;
      aDocumento = aParam % 1706; nDocumento = aDocumento;
      FechaAnt = fFecha;
      |SELECT #2#camaniva;
      #camaniva#7 = nDiario;
      #camaniva#8 = fFecha;
      #camaniva#9 = nDocumento;
      |LEE 010#camaniva.=;
      |SI FSalida = 0;
          nLibro    = #camaniva#0;
          nRegistro = #camaniva#1;
          Modo = 2;
      |SINO;
         |DDEFECTO #camaniva;
         |DDEFECTO #caivalin;
         #camaniva#36 = aTipoIVA;
         #camaniva#7  = nDiario;
         #camaniva#8  = fFecha;
         #camaniva#9  = nDocumento;
         #camaniva#4  = fFecha;
         |HAZ DefPeriodo;
         #camaniva#5 = Comodin;
         Modo = 1;
      |FINSI;
   |SINO;
      |DDEFECTO #camaniva;
      |DDEFECTO #caivalin;
      Modo = 0;
   |FINSI;
   |SELECT #1#camaniva;

   |SI aTipoIVA ! "";
       enAParam = #camaniva#10;
       |HAZ LeeDefIVA;
       |SI Modo ! 2; #camaniva#0 = dLibro; |FINSI;
       |C_M #camaniva#0,1,snLibro;
       |SI Modo = 1; |HAZ NumDoc; |FINSI;
   |FINSI;

   sw_ivamerr = 0;
   |ABRE #caclipro;

   |SI aParam = "";
      |C_M #camaniva#7,1,"S";
      |C_M #camaniva#8,1,"S";
      |C_M #camaniva#9,1,"S";
      aMod9 = "S";
      |MANTE #camaniva;
   |SINO;
      |C_M #camaniva#7,1,"N";
      |C_M #camaniva#8,1,"N";
      |C_M #camaniva#9,1,"N";
      aMod9 = "N";
      |CLS;
      |CABEZA "Mantenimiento Registros IVA/IRPF";
      |PINPA #0#0;
      |PINDA #0#0;
      |SI Modo = 1;
          |DDEFECTO #caivalin;
          Clave = 0;
          |ENCLAVE #camaniva,Clave,1;
          |SI Clave ! 0;
              sw_ivamerr = -1;
              |CIERRA #camaniva;
              |CIERRA #caclipro;
              |ACABA;
         |FINSI;
         |GRABA 020#camaniva.b;
         nSwAltaAhora = 1;
      |SINO;
         #camaniva#0 = nLibro;
         #camaniva#1 = nRegistro;
         |LEE 010#camaniva.=;
      |FINSI;
      |HAZ TomaDefectos;
      |SI Modo = 1; |ENDATOS #1#0; |SINO; |ENDATOS #2#0; |FINSI;
      |SI FSalida = 0;
          ModoEntrada = (FEntrada / 100) ! 0;
          #camaniva#31 = eaDesgIVA;
          #camaniva#32 = eaDesgCTP;
          #camaniva#33 = "N";
          #camaniva#34 = eaDesgDTO;
          |GRABA 020#camaniva.a;
          |LIBERA #camaniva;
          |ENTLINEAL #1#caivalin, -3, 7, 22,1,inf,sup;

          |HAZ T30ManIVA;
      |SINO;
          |SI Modo = 1; |BORRA 020#camaniva.a; |FINSI;
          |LIBERA #camaniva;
          sw_ivamerr = -1;
      |FINSI;
   |FINSI;

   |CIERRA #caclipro;
   |CIERRA #camaniva;
   |DELINDEX #917;
   |DELINDEX #212;
   |DELINDEX #213;
   |DELINDEX #100;
   |DELINDEX #902;

   |HAZ PongoNumFra;
   |BUCLE BorroCamaasiv;
|FPRO;

|| ***********************************************************************
|| ***********************************************************************
|PROCESO TomaDefectos;
   |SI #caivaasi#26 = "S";
      |C_M #camaniva#4,1,"S";
   |SINO;
      |C_M #camaniva#4,1,"N";
   |FINSI;

   |C_M #camaniva#2,  1,snSerie;  || Modificables S/N
   |C_M #camaniva#27, 1,snConc1;
   |C_M #camaniva#28, 1,snDesc1;

   alfa1 = snConc2;
   |SI snConc2 = "R"; alfa1 = "N"; |FINSI;
   |C_M #camaniva#29, 1,alfa1;   ||Concepto IVA
   alfa1 = snDesc2;
   |SI snDesc2 = "R"; alfa1 = "N"; |FINSI;
   |C_M #camaniva#30, 1,alfa1;

   |SI #camaniva#36 ! "N";
       alfa1 = #caivaasi#20;        ||Departamento
   |SINO;
       alfa1 = #cadeflab#52;        ||Departamento
   |FINSI;
   |SI eaDepar = "N"; alfa1 = "N"; |FINSI;
   |C_M #camaniva#10, 1, alfa1;

   |SI #camaniva#36 ! "N";
       alfa1 = #caivaasi#68;        ||Subdepartamento
   |SINO;
       alfa1 = #cadeflab#59;        ||Subdepartamento
   |FINSI;
   |SI eaSubde = "N"; alfa1 = "N"; |FINSI;
   |C_M #camaniva#11, 1, alfa1;

   alfa1 = #caivaasi#28;        ||Periodo Modifica o Calcular
   |C_M #camaniva#5, 1, alfa1;

|SI #camaniva#36 ! "N";
   alfa1 = #caivaasi#35;        ||Nombre Cliente / Proveedor
   |SI alfa1 ! "N"; alfa1 = "S"; |FINSI;
   |C_M #camaniva#13, 1, alfa1;
   alfa1 = #caivaasi#36;        ||CIF. Cliente / Proveedor
   |C_M #camaniva#14,1, alfa1;
|SINO;
   alfa1 = #cadeflab#53;        ||Nombre Cliente / Proveedor
   |C_M #camaniva#13, 1, alfa1;
   alfa1 = "S";                 ||CIF. Cliente / Proveedor
   |C_M #camaniva#14,1, alfa1;
|FINSI;
   ConcepAnt   = #camaniva#27;

   |C_M #camaniva#42,1,"S";
   |SI eDCl340 ! " "; |C_M #camaniva#42,1,"N"; |FINSI;
|FPRC;

|PROCESO TomaDefectos_L;

   |SI #camaniva#36 ! "N";
       alfa1 = #caivaasi#20;        ||Departamento
   |SINO;
       alfa1 = "N";  || #cadeflab#52;        ||Departamento
   |FINSI;
   |SI eaMulDep ! "S"; alfa1 = "N"; |FINSI;
   |SI eaDepar  = "N"; alfa1 = "N"; |FINSI;
   |C_M #caivalin#30, 1, alfa1;
   |SI #camaniva#36 ! "N";
       alfa1 = #caivaasi#68;        ||Subdepartamento
   |SINO;
       alfa1 = #cadeflab#59;        ||Subdepartamento
       alfa1 = "N";
   |FINSI;
   |SI eaMulDep ! "S"; alfa1 = "N"; |FINSI;
   |SI eaSubde  = "N"; alfa1 = "N"; |FINSI;
   |C_M #caivalin#31, 1, alfa1;

   |SI aTipoIVA = "N"; |ACABA; |FINSI;

   |C_M #caivalin#16, 1,snTiva;
   |C_M #caivalin#17, 1,snInver;
   |C_M #caivalin#5,  1,snDeduc;

   alfa1 = #caivaasi#70;        ||Cuenta Base
   |C_M #caivalin#12,1, alfa1;

   alfa1 = #caivaasi#69;        ||Descuento
   |C_M #caivalin#11, 1, alfa1;
   |C_V #caivalin#11, 1, alfa1;
   |SI alfa1 = "N";
       |PINTA 1970,"          ";
       |PINTA 2070,"          ";
   |SINO;
       |PINTA 1970,"Descuentos";
   |FINSI;

   |C_M #caivalin#18, 1, snReten;
   || |SI snReten = "N"; #caivalin#18 = 0; |FINSI;
|FPRC;

|PROCESO BuscaNumero;

   |SI #caivaasi#44 = "N";
       |ABRE #calibros;
       #calibros#0 = #camaniva#0;
       |LEE 101#calibros.=;
       |SI FSalida = 0;
           NumFactura  = #calibros#4;
           #calibros#4 = #calibros#4 + #calibros#3;
           |GRABA 020#calibros.a;
           |LIBERA #calibros;
       |FINSI;
       |CIERRA #calibros;
   |SINO;
       |ABRE #caivases;
       #caivases#0 = #camaniva#2;
       #caivases#1 = aTipoIVA;
       |LEE 101#caivases.=;
       |SI FSalida = 0;
           NumFactura = #caivases#3;
           #caivases#3 = #caivases#3 + #caivases#4;
           |GRABA 020#caivases.a;
           |LIBERA #caivases;
      |FINSI;
      |CIERRA #caivases;
   |FINSI;
   #camaniva#3 = NumFactura;
|FPRC;


|| *****************
|PROCESO BorraRecibos;

   Comodin = #caivaasi#56; |QBF Comodin;
   |SI Comodin = ""; |ACABA; |FINSI;

   eaPath = Comodin;
   |HAZ CreaPuente;
   |SI eaRetorno = "ERROR"; |ACABA; |FINSI;

   |DDEFECTO #Puente@;
   #Puente@#0 = #camaniva#0;
   #Puente@#1 = #camaniva#2;
   #Puente@#2 = #camaniva#3;
   #Puente@#3 = 0;
   #Puente@#5 = #camaniva#4;
   |DFICE Comodin; |QBF Comodin;
   Comodin = Comodin % -107; Comodin = Comodin % 106;
   Comodin1 = Comodin % 0105; #Puente@#23 = Comodin1;
   Comodin1 = Comodin % -101; #Puente@#24 = Comodin1;
   |SI #camaniva#36 = "R"; #Puente@#27 = "V"; |FINSI;
   |SI #camaniva#36 = "S"; #Puente@#27 = "C"; |FINSI;
   #Puente@#28 = "B";
   |GRABA 020#Puente@.n;

   |HAZ CierraPuente;
|FPRC;


|PROCESO CreaVtos;
   |SI #camaniva#36 = "N"; |ACABA; |FINSI;

   |SI ModoEntrada = 2;
       |SI aSerOrig ! #camaniva#2; |O nFacOrig ! #camaniva#3;
           |SALVA_DATOS #camaniva;
           #camaniva#2 = aSerOrig;
           #camaniva#3 = nFacOrig;
           #camaniva#4 = fFecAnt;
           |HAZ BorraRecibos;
           |REPON_DATOS #camaniva;
       |FINSI;
   |FINSI;

   enPCAut = 0;
   |SI #camaniva#39 ! "N"; enPCAut = 1; |FINSI;

   numdocum = #camaniva#1;
   libro = #camaniva#0;
   serie = #camaniva#2;
   orden = #camaniva#3;
   emision = #camaniva#4;
   |SI nSwIntra = 0; |Y #camaniva#42 ! "I";
       pesetas = #camaniva#21;
   |SINO;
       pesetas = #camaniva#21 - #camaniva#23;
   |FINSI;
   enDiarioNivel = #camaniva#7;
   cuenta = #camaniva#12; eaCuenta = cuenta; |HAZ SacaNivel;
   digito = enNivel;
   depart = #camaniva#10;

   |HAZ EsComersan;
   |SI FSalida = 0;
      |SI dirfich0 ! ""; |Y swVarios = 1; |PATH_DAT #100 dirfich0; |FINSI;
      |ABRE #camanref;
      #camanref#0 = #camaniva#0;
      #camanref#1 = #camaniva#1;
      |LEE 000#camanref.=;
      |SI FSalida = 0; eaRef = aFraPrv; |FINSI;
      |CIERRA #camanref;
   |SINO;
      eaRef  = #camaniva#22;
   |FINSI;
   enModoEsc = Modo;
   |SI enModoEsc = 0;
       enModoEsc = (FEntrada / 100) ! 0;
   |FINSI;

   |SI #camaniva#36 = "R"; aAlfa = "calincob.tab"; |FINSI;
   |SI #camaniva#36 = "S"; aAlfa = "calinpag.tab"; |FINSI;
   |SI enModoEsc = 2;
      nSwOp   = 1;
      nNumero = 0;
      |SI #camaniva#36 = "R"; |BUCLE BorraRecsV; |FINSI;
      |SI #camaniva#36 = "S"; |BUCLE BorraRecsC; |FINSI;
      nSwOp = 0;
      |SI nNumero = 0;
          |HAZ BorraRecibos;   || puede que el calinpag no tenga registros
                               || pero si existan en cartera
                               || Tiquet 160/977
          enModoEsc = 1;
      |SINO;
         |SI nImpAnt ! #camaniva#21; |O fFecAnt ! #camaniva#4; |O aNomAnt ! #camaniva#13;
             |SALVA_DATOS #camaniva;
             #camaniva#4 = fFecAnt;
             |HAZ BorraRecibos;
             |REPON_DATOS #camaniva;
             aAlfaNOME = "tv" + Usuario; |NOME_DAT #catmpvto#aAlfaNOME#;
             |DELINDEX #catmpvto;
             |ABRE #catmpvto;
             |SI #camaniva#36 = "R"; |BUCLE BorraRecsV; |FINSI;
             |SI #camaniva#36 = "S"; |BUCLE BorraRecsC; |FINSI;
             |CIERRA #catmpvto;
            aAlfa = aAlfa + ";NUEVO";
         |FINSI;
      |FINSI;
   |FINSI;
   |SI #camaniva#36 = "R"; |O #camaniva#36 = "S";
       eaNombre = #camaniva#13;
       |SUB_EJECUTA_NP aAlfa;
   |FINSI;
|FPRC;

|| ***********************************************************************
|| ............ Subrutina de Asientos
|PROCESO adapta1;
  #camaasil#12 = #camaniva#36; ||... aTipoIVA;
  #camaasil#13 = #camaniva#0;
  #camaasil#14 = #camaniva#3;
  #camaasil#15 = #camaniva#2;
  #camaasil#21 = aDep; || #camaniva#10;
  #camaasil#28 = aSub; || #camaniva#11;

  #camaasil#26 = #camaniva#22;  ||referencia
  |SI aTipoIVA ! "N";
      |SI #camaasil#4  = #caivalin#12;
          #camaasil#29 = #caivalin#28;  ||Cuenta Analitica
          |HAZ Grupo_Recarga;
      |FINSI;
  |SINO;
      |SI #camaasil#4 = #caivalin#23;
          #camaasil#29 = #caivalin#28;  ||Cuenta Analitica
          |HAZ Grupo_Recarga;
      |FINSI;
  |FINSI;
  #camaasil#30 = #camaniva#4;   ||fecha linea

  Comodin = Usuario % 0810;
  #camaasil#27 = Comodin;

  |SI #camaasil#8 = "D";
      #camaasil#16 = #camaasil#4;
      #camaasil#17 = #camaasil#5;
      #camaasil#10 = "";
      #camaasil#11 = 0;
  |SINO;
      #camaasil#16 = "";
      #camaasil#17 = 0;
      #camaasil#10 = #camaasil#4;
      #camaasil#11 = #camaasil#5;
  |FINSI;

  |SI #camaasil#19 = "F"; |O #camaasil#19 = "B";
      |SI #camaasil#8 = "D";
          |SI aCtaDebe = ""; aCtaDebe = #camaasil#4; |FINSI;
      |FINSI;
      |SI #camaasil#8 = "H";
          |SI aCtaHaber = ""; aCtaHaber = #camaasil#4; |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO adapta2;  ||El concepto

   |SI #camaasil#12 ! "C"; |Y #camaasil#12 ! "P";
       |SI #caivaasi#131 = "S"; |ACABA; |FINSI;

       |SI #camaasil#19 ! "P";
           aAlfa5 = "";
           aAlfa1 = #camaasil#7;  |QBF aAlfa1;  || Descripcion

           aAlfa2 = #caivaasi#45;
           |SI #camaasil#19 = "I"; |O #camaasil#19 = "R"; |O #camaasil#19 = "B";
               |O #camaasil#19 = "i"; |O #camaasil#19 = "r"; |O #camaasil#19 = "b";
               |SI #caivaasi#130 ! "=  ";
                   aAlfa2 = #caivaasi#130;
               |FINSI;
           |FINSI;
           |QBF aAlfa2;  || lo que a¤ade

           aAlfa3 = aAlfa2 % 0;
           nDCon0 = aAlfa3;
           |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
                 aAlfa3 = nDCon1;
                 aAlfa3 = aAlfa3 + "01";
                 aDCon2 = aAlfa2 % aAlfa3;
                 |HAZ adapta2_c;
                 aAlfa5 = aAlfa5 + aDCon1;
           |SIGUE;
           #camaasil#7 = aAlfa1 + aAlfa5;
       |SINO;
           aAlfa5 = "";
           aAlfa1 = #camaasil#7;  |QBF aAlfa1;  || Descripcion
           aAlfa2 = #caivaasi#96; |QBF aAlfa2;  || lo que a¤ade

           aAlfa3 = aAlfa2 % 0;
           nDCon0 = aAlfa3;
           |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
                 aAlfa3 = nDCon1;
                 aAlfa3 = aAlfa3 + "01";
                 aDCon2 = aAlfa2 % aAlfa3;
                 |HAZ adapta2_c;
                 aAlfa5 = aAlfa5 + aDCon1;
           |SIGUE;
           #camaasil#7 = aAlfa1 +  aAlfa5;
       |FINSI;

   |FINSI;
|FPRC;

|PROCESO adaptaC2;  ||El concepto en IVA
     aAlfa5 = "";
     aAlfa1 = #dsmom030#1;  |QBF aAlfa1;  || Descripcion
     |SI xx = 1; aAlfa2 = #caivaasi#45;  |FINSI;  ||Cliente
     |SI xx = 2; aAlfa2 = #caivaasi#130; |FINSI;  ||IVA
     |SI xx = 3; aAlfa2 = #caivaasi#96;  |FINSI;  ||IRPF
     |SI aAlfa2 = "=  "; aAlfa2 = #caivaasi#45; |FINSI;
     |QBF aAlfa2;  || lo que a¤ade

     aAlfa3 = aAlfa2 % 0;
     nDCon0 = aAlfa3;
     |PARA nDCon1 = 1; |SI nDCon1 [ nDCon0; |HACIENDO nDCon1 = nDCon1 + 1;
           aAlfa3 = nDCon1;
           aAlfa3 = aAlfa3 + "01";
           aDCon2 = aAlfa2 % aAlfa3;
           |HAZ adapta2_c;
           aAlfa5 = aAlfa5 + aDCon1;
     |SIGUE;
     aAlfa1  = aAlfa1 + aAlfa5;
|FPRC;

|PROCESO adapta2_c;  ||El concepto
     aDCon1 = "";
     |SI aDCon2 = "S";
         aDCon1 = #camaniva#2; |QBF aDCon1;
         |SI aDCon1 ! ""; aDCon1 = aDCon1 + aSepSer; |QBF aDCon1; |FINSI;
     |FINSI;                                         || Serie
     |SI aDCon2 = "F";
         aDCon1 = #camaniva#3; |QBF aDCon1;
         |SI aNumIzq = "S";
             aDCon1 = ("000000" + aDCon1) % -106;
         |FINSI;
     |FINSI;                                         || Factura
     |SI aDCon2 = "C";
         aDCon1 = #camaniva#12; |QBF aDCon1;
     |FINSI;                                         || Cuenta Cliente
     |SI aDCon2 = "N";
         aDCon1 = #camaniva#13; |QBF aDCon1;
     |FINSI;                                         || Nombre Cliente
     |SI aDCon2 = "R";
         |SI #camaniva#22 ! aBlanc60;
             aDCon1 = #camaniva#22; |QBF aDCon1;
         |FINSI;
     |FINSI;
                                     || Referencia
     |SI aDCon2 = "P";
         aDCon1 = #camaniva#22;
         |SI #camaniva#36 = "S";
             |HAZ EsComersan;
             |SI FSalida = 0;
                 |SI dirfich0 ! ""; |Y swVarios = 1; |PATH_DAT #100 dirfich0; |FINSI;
                 |ABRE #camanref;
                 |DDEFECTO  #camanref;
                 #camanref#0 = #camaniva#0;
                 #camanref#1 = #camaniva#1;
                 |LEE 000#camanref.=;
                 aDCon1 = #camanref#2;
                 |CIERRA #camanref;
             |FINSI;
         |FINSI;
         |QBF aDCon1;
     |FINSI;                                         || Referencia Comersan

     |SI aDCon1 ! "";
         |SI aDCon2 = "F";
             aAlfa7 = aAlfa2 - "S";
             |SI aAlfa7 ! aAlfa2; |Y #camaniva#2 > "     ";
                 |ACABA;
             |FINSI;
         |FINSI;
         aDCon1 = " " + aDCon1;
     |FINSI;
|FPRC;

|PROCESO cabecera; || lee la cabecera.
   |DDEFECTO #camaasic;
   #camaasic#0  = nDIARIO;
   #camaasic#1  = aFECHA;
   #camaasic#2  = nDOCUMENTO;
   #camaasic#3  = nDOCUMENTO;
   #camaasic#17 = #camaniva#22;
   #camaasic#7  = enPred;
   NumApunte    = 1;
   |GRABA 000#camaasic.b;
   |SI FSalida ! 0;
      #camaasil#0 = #camaasic#0;
      #camaasil#1 = #camaasic#1;
      #camaasil#2 = #camaasic#2;
      #camaasil#3 = 9999;
      |LEE 040#2];
      |SI FSalida = 0;
         |LEE 040#2a;
         |SI #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
             NumApunte = #camaasil#3;
         |FINSI;
      |SINO;
         |LEE 040#2u;
         |SI FSalida = 0; |Y  #camaasil#0 = #camaasic#0; |Y #camaasil#1 = #camaasic#1; |Y #camaasil#2 = #camaasic#2;
             NumApunte = #camaasil#3;
         |FINSI;
      |FINSI;
      nREGISTRO = #camaasic#12;  ||si ya existia cabecera, modificamos nREGISTRO para actual. ctas y diario
   |SINO;
      nGuarda = nDOCUMENTO;
      |HAZ NuevoRegistro;
      #camaasic#12 = nREGISTRO;
      #camaasic#17 = #camaniva#22;
      nDOCUMENTO = nGuarda;
      #camaasic#7 = enPred;
      |GRABA 020#camaasic.a;
   |FINSI;
   |LIBERA #camaasic;
   |SI enPred ! 0;
       |ABRE #casieaca;
       |DDEFECTO #casieaca;
       #casieaca#0 = enPred;
       |LEE 001#casieaca.=;
       |CIERRA #casieaca;
   |FINSI;
|FPRC;

|PROCESO act_cabecera;
   #camaasic#0 = nDIARIO;
   #camaasic#1 = aFECHA;
   #camaasic#2 = nDOCUMENTO;
   |LEE 101#camaasic.=;
   |SI #camaasil#12 = "R";  #camaasic#13 = 1;  |FINSI;
   |SI #camaasil#12 = "S";  #camaasic#13 = 2;  |FINSI;
   |SI #camaasil#12 = "N";  #camaasic#13 = 3;  |FINSI;

   |SI #camaasil#8 = "D";
       #camaasic#4 = #camaasic#4 + importe;
   |SINO;
      #camaasic#5 = #camaasic#5 + importe;
   |FINSI;
   #camaasic#6  = #camaasic#4 - #camaasic#5;        || saldo
   #camaasic#17 = #camaniva#22;
   |SI #camaasic#9 = 0;
       |SI aCtaDebe ! "";
           enDiarioNivel = #camaniva#7;
           eaCuenta = aCtaDebe; |HAZ SacaNivel;
           #camaasic#8 = aCtaDebe;
           #camaasic#9 = enNivel;
       |FINSI;
   |FINSI;
   |SI #camaasic#11 = 0;
       |SI aCtaHaber ! "";
           enDiarioNivel = #camaniva#7;
           eaCuenta = aCtaHaber; |HAZ SacaNivel;
           #camaasic#10 = aCtaHaber;
           #camaasic#11 = enNivel;
       |FINSI;
   |FINSI;
   |SI enTipoAsto ! 0;
       || |SI #camaasil#12 = "R";  |O #camaasil#12 = "S";
           #camaasic#13 = enTipoAsto;
       || |FINSI;
   |FINSI;
   |GRABA 020#camaasic.a;
   |LIBERA #camaasic;
|FPRC;

|PROCESO Actualiza;
   MasMenos     = importe;
   DebeHaber    = #camaasil#8;
   aCUENTA      = #camaasil#4;
   nREGISTRO    = #camaasil#24;
   nDIARIO      = #camaasil#0;
   aFECHA       = #camaasil#1;
   nDOCUMENTO   = #camaasil#2;
   nNIVELCUENTA = #camaasil#5;

|| ...................................   importe = #camaasil#9;
   |HAZ act_cabecera;
   |SI #camaasil#19 ! "X";
       |HAZ ActDiario;          || diario
       |HAZ ActCuenta;          || cuenta
       |HAZ ActTesteo;
   |FINSI;
|FPRC;

|PROCESO DescuentaCont;

   |SI #caivaasi#44 = "N";
       |ABRE #calibros;
       #calibros#0 = #camaniva#0;
       |LEE 101#calibros.=;
       |SI FSalida = 0;
           NumFactura = NumFactura + #calibros#3;
           |SI NumFactura = #calibros#4;
               #calibros#4 = #calibros#4 - #calibros#3;
               |GRABA 020#calibros.a;
           |FINSI;
       |FINSI;
       |LIBERA #calibros;
       |CIERRA #calibros;
   |SINO;
       |ABRE #caivases;
       #caivases#0 = #camaniva#2;
       #caivases#1 = aTipoIVA;
       |LEE 101#caivases.=;
       |SI FSalida = 0;
           NumFactura = NumFactura + #caivases#4;
           |SI #caivases#3 = NumFactura;
               #caivases#3 = #caivases#3 - #caivases#4;
               |GRABA 020#caivases.a;
           |FINSI;
       |FINSI;
       |LIBERA #caivases;
       |CIERRA #caivases;
   |FINSI;
|FPRC;

|| ***********************************************************************
|PROCESO LeeLineas;
 |PARA nPara1 = 0; |SI nPara1 [ 30; |HACIENDO nPara1 = nPara1 + 1;
       #917nPara1 = #camaasil#nPara1#;
 |SIGUE;
 |GRABA 020#917n;
 nSwHay17= 1;
 en0W17 = #917#0;
 ef1W17 = #917#1;
 en2W17 = #917#2;
|FPRC;

|DEFBUCLE LeeLineas;
 #camaasil#1;
 19;
 #camaniva#7,#camaniva#8,#camaniva#9,0000,"X";
 #camaniva#7,#camaniva#8,#camaniva#9,9999,"X";
 ;
 NULL,LeeLineas;
|FIN;

|PROCESO ElAuxW17;
  |DELINDEX #917;
  |ABRE #917;
  nSwHay17= 0;
  en0W17 = #camaniva#7;
  ef1W17 = #camaniva#8;
  en2W17 = #camaniva#9;
  |BUCLE LeeLineas;
  |CIERRA #917;
  |SI #caivaasi#92 = "S"; nSwHay17 = 1; |FINSI;
|FPRC;

|PROCESO Recojo17;
  |DDEFECTO #camaasil;
  #camaasil#0 = #camaasic#0;
  #camaasil#1 = #camaasic#1;
  #camaasil#2 = #camaasic#2;
  #camaasil#3 = NumApunte;
  |PARA nPara1 = 4; |SI nPara1 [ 30; |HACIENDO nPara1 = nPara1 + 1;
       #camaasil#nPara1# = #917nPara1;
  |SIGUE;
  #camaasil#12 = aTipoIVA;
  #camaasil#13 = #camaniva#0;
  #camaasil#14 = #camaniva#3;
  #camaasil#15 = #camaniva#2;
  #camaasil#19 = "X";
  #camaasil#20 = 0;
  #camaasil#24 = nREGISTRO;
  #camaasil#26 = #camaniva#22;
  Comodin = Usuario % 1099;
  #camaasil#27 = Comodin;

  |SI #camaasil#9 ! 0;
      |GRABA 020#camaasil.n;
      importe = #camaasil#9;
      |HAZ Actualiza;
      NumApunte = NumApunte + 10;
  |FINSI;
|FPRC;

|DEFBUCLE Recojo17;
 #917#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, Recojo17;
|FIN;

|PROCESO RecogeW17;
  |BUCLE Recojo17;
|FPRC;

|PROCESO VoyaW17;

   |SI #camaniva#36 ! "N";

       coant  = #camaniva#27;
       deant  = #camaniva#28;
       dpant  = #camaniva#10;
       sdant  = #camaniva#11;
       refant = #camaniva#22;
       |SI nSwHay17 = 0;
           en0W17 = #camaniva#7;
           ef1W17 = #camaniva#8;
           en2W17 = #camaniva#9;
       |FINSI;
       |SUB_EJECUTA_NP "caw00017";
  |FINSI;
|FPRC;


|PROCESO adapta3;       || cambios de signos en ABONOS
   aAbo = snAbono;
   |SI enPred ! 0;
       |SI #111#9 = 1; snAbono = "S"; |FINSI;
       |SI #111#9 = 0; snAbono = "N"; |FINSI;
   |FINSI;

   |SI snAbono ! "S";   || ...  No cambiar signo en Abonos Salir
       snAbono = aAbo;
       |ACABA;
   |FINSI;

   |SI aSigAn = "";     || Es la primera linea de este
       |SI importe < 0;
           |HAZ CambiaSigno;
       |FINSI;
       snAbono = aAbo;
       |ACABA;
   |FINSI;

|| ----------------------------------------------------------

   |SI aSigno = aSigAn;      ||Por ahora es signo sin abono

       import2 = #camaasil#9 + importe;
       |SI import2 ] 0;
           snAbono = aAbo;
           |ACABA;           ||Queda positivo
       |SINO;

           import1 = #camaasil#9;   ||Queda negativo
           import2 = importe;
           importe = -#camaasil#9;   ||Desactualiza
           |HAZ Actualiza;

           #camaasil#9 = 0;
           importe = import1 + import2;
           |HAZ CambiaSigno;
      |FINSI;

   |SINO;

       || ............ Ya era Abono
       |SI importe < 0;   || Es negativo ahora tambien
           importe = -importe;
           snAbono = aAbo;
           |ACABA;
       |FINSI;

      import1 = #camaasil#9;   ||Queda negativo
      import2 = importe;
      importe = - #camaasil#9;   ||Desactualiza
      |HAZ Actualiza;

      importe = import2 - #camaasil#9;
      #camaasil#8 = aSigno;
      #camaasil#9 = 0;
      |SI importe ] 0;
           snAbono = aAbo;
           |ACABA;           ||Queda positivo
       |SINO;
           |HAZ CambiaSigno;
      |FINSI;

   |FINSI;
   snAbono = aAbo;
|FPRC;

|PROCESO CambiaSigno;
 |SI #camaasil#8 = "D";
     #camaasil#8 = "H";
 |SINO;
     #camaasil#8 = "D";
 |FINSI;
 importe = -importe;
|FPRC;

|PROCESO Autofactura;
  ModoEntrada = (FEntrada / 100) ! 0;
  |SI ModoEntrada ! 2; |ACABA; |FINSI;
  enSWAut = 2;
  enLiAut = #camaniva#0;
  enOrAut = #camaniva#3;
  eaSeAut = #camaniva#2;
  |SUB_EJECUTA_NP "cay2ivas";
|FPRC;

|| ----------------------------------------------------------------
|| ----- Procesos especiales para los grupos analiticas
|PROCESO BorraGrupos;
 |BUCLELIN 1NULL#112;
 |BORRA 020#112a;
 |LIBERA #112;
|FPRC;

|DEFBUCLE BorraGrupos;
 #112#1;
 ;
 #camaniva#7,#camaniva#8,#camaniva#9,nDLinea, "       ";
 #camaniva#7,#camaniva#8,#camaniva#9,nHLinea, "zzzzzzz";
 be;
 NULL,BorraGrupos;
|FIN;

|PROCESO ElGrupo_Bor;
  |SI enSwAna = 1;
      |BUCLE BorraGrupos;
  |FINSI;
|FPRC;

|| .....

|PROCESO GrabaLGrupo;
 #213#0 = #212#0;
 #213#1 = #212#1;
 #213#2 = #212#2;
 #213#3 = #212#3;
 #213#4 = #212#4;
 #213#10 = #212#10;

 #213#5 = #113#5;
 #213#6 = #113#6;
 #213#7 = #113#7;
 #213#8 = #113#8;
 #213#9 = #113#9;
 |GRABA 020#213n;
 |LIBERA #113;
|FPRC;

|PROCESO LLineasGr;

 alfa1 = #camaasil#29; alfa1 = alfa1 % 103;
 |SI alfa1 = "GRU";

      |ABRE #112;
      #112#0 = #camaasil#0;
      #112#1 = #camaasil#1;
      #112#2 = #camaasil#2;
      #112#3 = #camaasil#3;
      #112#4 = #camaasil#29;
      |LEE 101#112=;
      |SI FSalida = 0;
          || .....  CopiarGrupo;
          #212#0 = #camaniva#0;   || Libro
          #212#1 = #camaasil#1;   || Fecha
          #212#2 = #camaniva#1;   || Documento Factura
          #212#3 = #camaasil#20;  || Base
          #212#4 = #112#4;        ||
          #212#5 = #112#5;
          #212#6 = #112#6;
          #212#7 = #112#7;
          #212#8 = #112#8;
          #212#9 = #112#3;         || Linea Original
          #212#10 = #camaasil#19;  ||Tipo
          |SI #camaasil#20 ! 0;             || Base
              #212#3 = #camaasil#20;
          |SINO;
              #212#3 = #camaasil#3 + 1000;
          |FINSI;
          |GRABA 020#212n;
          |BUCLELIN 2GrabaLGrupo#112;
      |FINSI;
      |LIBERA #112;
      |CIERRA #112;
  |FINSI;
|FPRC;

|DEFBUCLE LLineasGr;
 #camaasil#1;
 ;
 #camaniva#7,#camaniva#8,#camaniva#9,0000;
 #camaniva#7,#camaniva#8,#camaniva#9,9999;
 ;
 NULL,LLineasGr;
|FIN;

|PROCESO ElGrupo_Rec;
  |SI enSwAna = 0;  |ACABA; |FINSI;  || No hay analitica

  |DELINDEX #212;
  |DELINDEX #213;

  |ABRE #212;
  |ABRE #213;
  |BUCLE LLineasGr;
  |CIERRA #213;
  |CIERRA #212;
|FPRC;

|| .... ...

|PROCESO ReGrabaL;
 #113#0 = #112#0;
 #113#1 = #112#1;
 #113#2 = #112#2;
 #113#3 = #112#3;
 #113#4 = #112#4;
 #113#5 = #213#5;

 #113#6 = #213#6;
 #113#7 = #213#7;
 #113#8 = #213#8;
 #113#9 = #213#9;
 |GRABA 040#113n;

 |BORRA 020#213a;
 |LIBERA #213;
|FPRC;

|PROCESO Grupo_Recarga;
  |SI enSwAna = 0;  |ACABA; |FINSI;  || No hay analitica

  |ABRE #212;
  #212#0 = #0#0;
  #212#2 = #0#1;
  #212#3 = #1#2;
  #212#4 = #1#28;
  |LEE 101#212=;
  |SI FSalida = 0;
      |ABRE #112;
      #112#0 = #camaasil#0;
      #112#1 = #camaasil#1;
      #112#2 = #camaasil#2;
      #112#3 = #camaasil#3;
      #112#4 = #1#28;
      #112#5 = #212#5;
      #112#6 = #212#6;
      #112#7 = #212#7;
      #112#8 = #212#8;
      |GRABA 040#112n;
      |SI FSalida = 0;
          |ABRE #113;
          |BUCLELIN 2ReGrabaL#212;
          |CIERRA #113;
      |FINSI;
      |CIERRA #112;
      |BORRA 020#212a;
  |FINSI;
  |LIBERA #212;
  |CIERRA #212;
|FPRC;

|PROCESO LosQueQuedan;

  |ABRE #camaasil;
  #camaasil#0 = #camaniva#7;
  #camaasil#1 = #camaniva#8;
  #camaasil#2 = #camaniva#9;
  #camaasil#3 = #212#9;
  |LEE 001#camaasil.=;
  |SI FSalida = 0; |Y #camaasil#29 = #112#4;
      |HAZ LoPaso;
  |FINSI;
  |CIERRA #camaasil;
|FPRC;

|PROCESO LoPaso;
  |ABRE #112;
  #112#0 = #camaniva#7;
  #112#1 = #camaniva#8;
  #112#2 = #camaniva#9;
  #112#3 = #camaasil#3;
  #112#4 = #1#28;
  #112#5 = #212#5;
  #112#6 = #212#6;
  #112#7 = #212#7;
  #112#8 = #212#8;
  |GRABA 040#112n;
  |SI FSalida = 0;
      |ABRE #113;
      |BUCLELIN 2ReGrabaL#212;
      |CIERRA #113;
  |FINSI;
  |CIERRA #112;
|FPRC;

|DEFBUCLE LosQueQuedan;
 #212#1;
 ;
 #0#0, #0#1, 0001, "        ";
 #0#0, #0#1, 9999, "zzzzzzzz";
 ;
 NULL, LosQueQuedan;
|FIN;

|PROCESO Grupo_Recarga1;
  |SI enSwAna = 0;  |ACABA; |FINSI;  || No hay analitica

  |BUCLE LosQueQuedan;
|FPRC;

|PROCESO Camaiva9; |TIPO 9;
     |SI nBtnItemDoc ! -1; |FIN_CONTROL_WINDOWS nBtnItemDoc; |FINSI;
|FPRC;

|PROCESO BtnItemDoc;
     aAlfa = "tagz0001;IVA" + (("00" +#0#0)%-102)+#0#1;
     |SUB_EJECUTA_NP aAlfa;
|FPRC;

|PROCESO Camaiva8; |TIPO 8;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          |CONTROL_SIMPLE 0, "BOTON, ItemDoc", 0471, 0479, BtnItemDoc;
          nBtnItemDoc = FSalida;
     |FINSI;
|FPRC;

|PROCESO T20man;  |TIPO 20;
     aAlfa = FSalida;
     |SI aAlfa = "OPCION";
         |ABRE #casiim01;
         |LEE 000#casiim01.p;
         |SI FSalida ! 0;
             |CIERRA #casiim01;
             FSalida = "";
             |ACABA;
         |FINSI;
         |CIERRA #casiim01;

         FSalida = "Datos SII";

         |ACABA;
     |FINSI;

     |SI #camaniva#12 = "            ";
         |ACABA;
     |FINSI;
     |SI #camaniva#36 = "N"; |ACABA; |FINSI;

     |LEE 000#camaniva.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     enActividad = #camaniva#10;
     eaCodDep    = #camaniva#10;
     |HAZ Actividad;

     enSiiL = 1;
     |HAZ T12man;
     enSiiL = 0;

     |HAZ LeoAsto;
     |SI enTipoAsto ! 101;
      |Y enTipoAsto ! 102;
      |Y enTipoAsto ! 110;
         |ACABA;
     |FINSI;

     |ABRE #dsmom030;
     |DDEFECTO #dsmom030;
     #dsmom030#0 = #camaniva#27;
     |LEE 000#dsmom030.=;
     |CIERRA #dsmom030;
     |HAZ Tipo349;

     |SI #camaniva#21 < 0; |Y nSwIntra = 1;  |Y #camaniva#36 ! "N";
         |HAZ LaIntra;
     |FINSI;
|FPRC;
