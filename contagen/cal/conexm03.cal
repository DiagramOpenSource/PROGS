
|FICHEROS;
  conexm03 #0;
  cacuenta@#3;
  cacuent1@#4;
  cacuent2@#5;
  cacuent3@#6;
  cacuent4@#7;
  cacuent5@#8;
  cacuent6@#4;
  cacuent7@#5;
  cacuent8@#6;
  cacuent9@#7;
  cacuent0@#8;
  canempre@#30;
|FIN;


|VARIABLES;
  auto = 0;
  mante = 0;

  aDirDef = "";
  aDirFich = "";

    dig1 = 0;
    dig3 = 0;
    dig4 = 0;
    dig5 = 0;
    dig6 = 0;
    dig7 = 0;
    dig8 = 0;
    dig9 = 0;

  UsandoDLL = 0;
  tmp_i = 0;
  hora1 = "";
  hora2 = "";
  E_FILA = "F";
  E_COLUMNA = "C";
  i = 0;
  j = 0;
  ultima_linea = 0;
  trobada = 0;
  nivel = 0;
  n = 0;
  nn = 0;
  pempre = 0;
  alfa1 = "";
  alfa2 = "";
  alfa3 = "";
  alfa4 = "";
  alfax = "";
  letra = "";
  hoja = "";
  mihoja = "";
  dempre = "";
  negativo = 0;
  saldo = 0;
  superior = 0;
  limite1 = "";
  limite2 = "";
  dir_excel = "Excel.EXE";
  {-1}pp = 0;
  &con_co_excel = "";
  nombrehoja = "Hoja";
  jj = 0;
  plasmar = 0;
  iniformula = "";
  finformula = "";
  f_ini = 0;
  c_ini = 0;
  f_fin = 0;
  c_fin = 0;
  elsigno = 0;
  no_hay_nada = 0;
  campo_saldo = 53;
  ppp = 0;
  me_lo_sumas = 0;
  punto_int = 0;
  punto_no_int = 0;
  punto_fin_int = 0;
  alfa7 = "";
  alfa8 = "";
  cuentae = 0;
  alfax1 = "";
  alfax2 = "";
|FIN;

|PROCESO cons;|TIPO 66;
  j = Campo + 1;
  #canempre@#2 = #conexm03#Campo#;
  #canempre@#3 = #conexm03#j#;
  |CONSULTA_CLAVE #3#canempre@;
  |SI FSalida ] 0;
        #conexm03#Campo# = #canempre@#2;
        |PINTA #conexm03#Campo#;
        #conexm03#j# = #canempre@#3;
        |PINTA #conexm03#j#;
        j = Campo + 2;
        #conexm03#j# = #canempre@#1;
        |PINTA #conexm03#j#;
  |SINO;
        |ERROR;
  |FINSI;
|FPRC;

|PROCESO perio;|TIPO 7;
  j = Campo - 1;
  |SI #conexm03#j# = 0;
     #conexm03#Campo# = 0;
     |C_M #conexm03#Campo#,1,"N";
  |SINO;
     |C_M #conexm03#Campo#,1,"S";
  |FINSI;
|FPRC;

|PROCESO descri;|TIPO 0;
  j = Campo + 1;
  |SI #conexm03#Campo# = 0;
     #conexm03#j# = "*Datos en blanco*";
     |PINTA #conexm03#j#;
     |ACABA;
  |FINSI;
  j = Campo - 1;
  #canempre@#2 = #conexm03#j#;
  #canempre@#3 = #conexm03#Campo#;
  |LEE 010#canempre@.=;
  |SI FSalida ! 0;
     |CONSULTA_CLAVE #3#canempre@;
     |SI FSalida ] 0;
        #conexm03#j# = #canempre@#2;
        |PINTA #conexm03#j#;
        #conexm03#Campo# = #canempre@#3;
        |PINTA #conexm03#Campo#;
        j = Campo + 1;
        #conexm03#j# = #canempre@#1;
        |PINTA #conexm03#j#;
     |SINO;
        |ERROR;
     |FINSI;
  |SINO;
     j = Campo + 1;
     #conexm03#j# = #canempre@#1;
     |PINTA #conexm03#j#;
  |FINSI;
|FPRC;

|PROCESO acumula;
   alfa7 = #cacuenta@#0;
   |QBF alfa7;
   ppp = (A\ alfa7 % 0);
   |SI ppp < nivel;|O ppp > superior;
      |ACABA;
   |FINSI;
   |SI punto_int > 0;
       ppp = punto_no_int * 100 + 1;
       |PARA;|SI ppp [ punto_fin_int;|HACIENDO ppp = ppp + 100;
           alfa7 = alfa2 % ppp;
           alfa8 = #cacuenta@#0 % ppp;
           |SI alfa7 ! "?";|Y alfa7 ! alfa8;
               |ACABA;
           |FINSI;
       |SIGUE;
   |FINSI;
   |SI me_lo_sumas = 1;
       |PARA ppp = 11;|SI ppp [ campo_saldo;|HACIENDO ppp = ppp + 3;
           saldo = saldo + #cacuenta@#ppp#;
       |SIGUE;
   |SINO;
       saldo = saldo + #cacuenta@#campo_saldo#;
   |FINSI;
|FPRC;

|PROCESO acumular;
  |DDEFECTO #cacuenta@;
  #cacuenta@#0 = limite1;
  #cacuenta@#1 = 0; || intentamos obviar el digito de control
  |LEE 010#cacuenta@.];
  |PARA;|SI FSalida = 0;|Y #cacuenta@#0 ] limite1;|Y #cacuenta@#0 [ limite2;|HACIENDO;
     |LEE 111#cacuenta@.=;
     |HAZ acumula;
     |LIBERA #cacuenta@;
     #cacuenta@#1 = 0;
     |LEE 010#cacuenta@.>;
  |SIGUE;
|FPRC;

|PROCESO LaCuenta;
  elsigno = 0
  alfa1 = alfa2 % 201;
  |SI alfa1 = "$";   || Quitar signo
      alfa1 = alfa2 % 101;
      |SI alfa1 = "+";
          elsigno = 1;
      |FINSI;
      |SI alfa1 = "-";
          elsigno = 2;
      |FINSI;
      alfa2 = alfa2 % 399;
  |FINSI;

  alfa1 = alfa2 % 101;
  |SI alfa1 = "-"; || Negativo?
      negativo = -1;
      alfa2 = alfa2 % 299;
    |SINO;
       negativo = 1;
  |FINSI;

  alfa1 = alfa2 % 102;
  me_lo_sumas = 0;
  |SI alfa1 = "D.";|O alfa1 = "H."
      |SI alfa1 = "D."
          campo_saldo = 9;
        |SINO;
           campo_saldo = 10;
      |FINSI;
      alfa2 = alfa2 % 399;
    |SINO;
       campo_saldo = 11;
  |FINSI;

  alfa1 = alfa2 % 101;
  alfax1 = alfa2 % 201;
  alfax2 = alfa2 % 301;
  |SI alfax1 = ".";|Y alfa1 ] "0";|Y alfa1 [ "9";
      alfa2 = alfa2 % 299;
      |SI alfa1 = "0";
          alfa1 = "M";
       |SINO;
           alfa1 = &(N\ 64 + alfa1 );
      |FINSI;
    |SINO;
     |SI alfax2 = ".";|Y alfa1 ] "0";|Y alfa1 [ "1";|Y alfax1 ] "0";|Y alfax1 [ "9";
         alfax1 = alfax1 + alfa1;
         |SI alfax1 [ "12"
             alfa1 = &(N\ 64 + alfax1 );
          |SINO;
             alfa1 = "L";
         |FINSI;
         alfa2 = alfa2 % 399;
     |FINSI;
  |FINSI;

  |SI alfa1 ] "a";|Y alfa1 [ "l";
      campo_saldo = ((&alfa1 - 97) * 3) + 3 + campo_saldo;
   |SINO;
       |SI alfa1 ] "A";|Y alfa1 [ "L";
           me_lo_sumas = 1;
           campo_saldo = ((&alfa1 - 65) * 3) + 3 + campo_saldo;
         |SINO;
            |SI alfa1 ! "M";|Y alfa1 ! "m";
                campo_saldo = campo_saldo + 42;
            |FINSI;
       |FINSI;
  |FINSI;

  |SI alfa1 ! "?"
      |SI alfa1 < "0";|O alfa1 > "9";
          alfa2 = alfa2 % 299;
      |FINSI;
  |FINSI;
  |QBF alfa2;

  nivel = (A\ alfa2 % 0);
  Ipp = dig3<-;
  superior = 0;
  |PARA j = 0;|SI j < dig3;|HACIENDO j = j + 1;
     Ipp = Ipp + 1;
     |SI nivel = pp;
         superior = nivel;
         |SAL;
     |FINSI;
     |SI superior = 0;|Y nivel < pp;
         superior = pp;
     |FINSI;
  |SIGUE;

  |SI #conexm03#i# ! 0;
    |DDEFECTO #cacuenta@;
    #cacuenta@#0 = alfa2;
    alfax = #cacuenta@#0;
    #cacuenta@#1 = 0;
    |LEE 010#cacuenta@.];
    |SI FSalida ! 0;|O #cacuenta@#0 ! alfax;
        #cacuenta@#2 = "Sin definir "+#cacuenta@#0;
        FSalida = -1;
    |FINSI;
  |FINSI;

  |SI #conexm03#i# ! 0;
      punto_int = 0;
      punto_no_int = 0;
      punto_fin_int = nivel * 100 + 1;
      |PARA ppp = 101;|SI ppp [ punto_fin_int;|HACIENDO ppp = ppp + 100;
          alfa7 = alfa2 % ppp;
          |SI alfa7 = "?";
              punto_int = (ppp-1) / 100;
              punto_no_int = punto_int + 1;
              |SAL;
          |FINSI;
      |SIGUE;

      |SI j < dig3;|Y punto_int = 0;
          |SI me_lo_sumas = 1;
              saldo = 0;
              |PARA ppp = 11;|SI ppp [ campo_saldo;|HACIENDO ppp = ppp + 3;
                  saldo = saldo + #cacuenta@#ppp#;
              |SIGUE;
            |SINO;
               saldo = #cacuenta@#campo_saldo#;
          |FINSI;
        |SINO;
           || Hay que acumular !!!
           saldo = 0;
           || nivel superior inmediato
           |SI superior = 0;
               superior = nivel;
           |FINSI;

           |SI punto_int > 0;
               j = superior - punto_int + 1;
               |SI punto_int = 1;
                   limite1 = "";
                   limite2 = "";
                 |SINO;
                    limite1 = alfa2 % (N\100+punto_int-1);
                    limite2 = alfa2 % (N\100+punto_int-1);
               |FINSI;
               limite1 = limite1 + "0" * j + "                 ";
               limite1 = limite1 % 112;
               limite2 = limite2 + "9" * j + "                 ";
               limite2 = limite2 % 112;
            |SINO;
                j = superior - nivel;
                limite1 = alfa2 + "0" * j + "                 ";
                limite1 = limite1 % 112;
                limite2 = alfa2 + "9" * j + "                 ";
                limite2 = limite2 % 112;
           |FINSI;
           |HAZ acumular;
           || ********************
      |FINSI;
      saldo = saldo * negativo;
      |SI elsigno = 1;
          |SI saldo < 0;
              saldo = 0;
          |FINSI;
        |SINO;
           |SI elsigno = 2;
               |SI saldo > 0;
                   saldo = 0;
                 |SINO;
                    saldo = saldo * -1;
               |FINSI;
           |FINSI;
      |FINSI;
  |FINSI;

  |SI #conexm03#i# ! 0;
      alfa1 = saldo;
    |SINO;
       alfa1 = "";
  |FINSI;
|FPRC;

|PROGRAMA;
  |DBASS aDirDef;
  aDirFich = aDirDef + "contagen/fich/";
  aDirDef = aDirDef + "contagen/def/";
  alfa1 = aDirDef + "cacuenta";
  |CARGA_DEF alfa1,cacuent1@;
  |SI FSalida < 0;
      |MENAV "0000Para esta opcion debe tener instalado el programa CONTAGEN";
      |ACABA;
  |FINSI;
  |CARGA_DEF alfa1,cacuent2@;
  |CARGA_DEF alfa1,cacuent3@;
  |CARGA_DEF alfa1,cacuent4@;
  |CARGA_DEF alfa1,cacuent5@;
  |CARGA_DEF alfa1,cacuent6@;
  |CARGA_DEF alfa1,cacuent7@;
  |CARGA_DEF alfa1,cacuent8@;
  |CARGA_DEF alfa1,cacuent9@;
  |CARGA_DEF alfa1,cacuent0@;
  |CARGA_DEF alfa1,cacuenta@;
  alfa1 = aDirDef + "canempre";
  |CARGA_DEF alfa1,canempre@;
  |SI FSalida < 0;
      |MENAV "0000Para esta opcion debe tener instalado el programa IPCONT08";
      |ACABA;
  |FINSI;
  |PATH_DAT #canempre@#aDirFich#;
  auto = 0;
  mante = 0;
  |ABRET #conexm03;
  |SI PARAMETRO ] "0000";|Y PARAMETRO [ "9999";
      #conexm03#33 = PARAMETRO;
      |LEE 000#conexm03.=;
      |SI FSalida = 0;
          auto = 1;
      |FINSI;
  |FINSI;
  |SI PARAMETRO = "MANTE";
      mante = 1;
  |FINSI;
  |ABRET #canempre@;
  |SI auto = 1;
      |CLS;
      |CABEZA "Balance Excel";
      |PINPA #0#conexm03;
      |PINDA #0#conexm03;
      FSalida = 0;
    |SINO;
       |SI mante = 1;
            |MANTE #conexm03;
            FSalida = "-1";
         |SINO;
            |CLS;
            |CABEZA "Balance Excel";
            |PINPA #0#conexm03;
            |LEE 010#conexm03.p;
            |SI FSalida = 0;
                |CONSULTA_CLAVE #2#conexm03;
              |SINO;
                 FSalida = 0;
            |FINSI;
            |SI FSalida ] 0;
                |PINDA #0#conexm03;
                |ENDATOS #1#conexm03;
            |FINSI;
       |FINSI;
  |FINSI;
  |SI FSalida ] 0;
      |CARGADLL "agixl97.dll";
      |SI FSalida < 0;
          |MENAV "0000No se puede usar agixl97.dll";
          |VETE Final;
      |FINSI;
      alfa1 = #conexm03#0;
      |QBF alfa1;
      n = (A\ alfa1 % 0);
      hoja = "";
      nombrehoja = "";
      |PARA i = 1;|SI i [ n;|HACIENDO i = i + 1;
          j = i * 100 + 1;
          alfa2 = alfa1 % j;
          |SI alfa2 = ","
              i = i + 1;
              |PARA;|SI i [ n;|HACIENDO i = i + 1;
                  j = i * 100 + 1;
                  alfa2 = alfa1 % j;
                  nombrehoja = nombrehoja + alfa2;
              |SIGUE;
              |SAL;
          |FINSI;
          hoja = hoja + alfa2;
      |SIGUE;
      dempre = aDirFich;
      |QBF hoja;
      |QBF nombrehoja;
      alfa2 = #conexm03#1;
      |QBF alfa2;
      alfa4 = hoja;
      |ALFACALLDLL "agixl97.dll","carga_book",alfa4;
      |SI alfa4 = hoja;
          FSalida = -1;
        |SINO;
           |ALFACALLDLL "agixl97.dll","fichero_destino",alfa2; || fichero de trabajo
           alfa4 = nombrehoja; || si es "" seleccionara la activa
           |ALFACALLDLL "agixl97.dll","selecciona_hoja",alfa4;
           FSalida = 0;
      |FINSI;
      |SI FSalida ] 0;
         |SI #conexm03#3 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#3 + #conexm03#4 ) % -106) + "/";
           |PATH_DAT #cacuent1@#alfa4#;
           |ABRET #cacuent1@;
         |FINSI;
         |SI #conexm03#6 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#6 + #conexm03#7 ) % -106) + "/";
           |PATH_DAT #cacuent2@#alfa4#;
           |ABRET #cacuent2@;
         |FINSI;
         |SI #conexm03#9 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#9 + #conexm03#10 ) % -106) + "/";
           |PATH_DAT #cacuent3@#alfa4#;
           |ABRET #cacuent3@;
         |FINSI;
         |SI #conexm03#12 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#12 + #conexm03#13 ) % -106) + "/";
           |PATH_DAT #cacuent4@#alfa4#;
           |ABRET #cacuent4@;
         |FINSI;
         |SI #conexm03#15 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#15 + #conexm03#16 ) % -106) + "/";
           |PATH_DAT #cacuent5@#alfa4#;
           |ABRET #cacuent5@;
         |FINSI;
         |SI #conexm03#18 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#18 + #conexm03#19 ) % -106) + "/";
           |PATH_DAT #cacuent6@#alfa4#;
           |ABRET #cacuent6@;
         |FINSI;
         |SI #conexm03#21 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#21 + #conexm03#22 ) % -106) + "/";
           |PATH_DAT #cacuent7@#alfa4#;
           |ABRET #cacuent7@;
         |FINSI;
         |SI #conexm03#24 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#24 + #conexm03#25 ) % -106) + "/";
           |PATH_DAT #cacuent8@#alfa4#;
           |ABRET #cacuent8@;
         |FINSI;
         |SI #conexm03#27 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#27 + #conexm03#28 ) % -106) + "/";
           |PATH_DAT #cacuent9@#alfa4#;
           |ABRET #cacuent9@;
         |FINSI;
         |SI #conexm03#30 ! 0;
           alfa4 = dempre + (( "00000" + #conexm03#30 + #conexm03#31 ) % -106) + "/";
           |PATH_DAT #cacuent0@#alfa4#;
           |ABRET #cacuent0@;
         |FINSI;
         || |ALFACALLDLL "agixl97.dll","ejecuta_macro",alfa2;
         |PINTA 2223,">                      <";
         |PARA;|SI;|HACIENDO;
            alfa2 = "&*";
            |ALFACALLDLL "agixl97.dll","busca_dato",alfa2;
            |SI alfa2 = "";
               |SAL;
            |FINSI;
             || |PINTA 501,alfa2;
           alfa3 = alfa2 % 101;
           alfa4 = alfa2 % 201;
           alfa1 = alfa2 % 301;
           |SI alfa4 ] "0";|Y alfa4 [ "9";|Y alfa3 = "&";|Y alfa1 = "!";|O alfa1 = "&";
               |SI alfa4 = 0;
                   i = 30;
                 |SINO;
                    i = ((N\alfa4) * 3);
               |FINSI;
               j = i + 1;
               |DDEFECTO #canempre@;
               |SI #conexm03#i# ! 0;
                   |PINTA 2224,"                    ";
                   |PINTA 2225,alfa2;
                   #canempre@#2 = #conexm03#i#;
                   #canempre@#3 = #conexm03#j#;
                   |LEE 010#canempre@.=;
                   |SI FSalida ] 0;
                       dig1 = #canempre@#11;       || desde mes
                       dig3 = #canempre@#13;       || nro. niveles
                       dig4 = #canempre@#14;       || 1 nivel
                       dig5 = #canempre@#15;       || 2 nivel
                       dig6 = #canempre@#16;       || 3 nivel
                       dig7 = #canempre@#17;       || 4 nivel
                       dig8 = #canempre@#18;       || 5 nivel
                       dig9 = #canempre@#19;       || 6 nivel
                       |SI alfa4 = 1;
                           cacuenta@ = cacuent1@;
                       |FINSI;
                       |SI alfa4 = 2;
                           cacuenta@ = cacuent2@;
                       |FINSI;
                       |SI alfa4 = 3;
                           cacuenta@ = cacuent3@;
                       |FINSI;
                       |SI alfa4 = 4;
                           cacuenta@ = cacuent4@;
                       |FINSI;
                       |SI alfa4 = 5;
                           cacuenta@ = cacuent5@;
                       |FINSI;
                       |SI alfa4 = 6;
                           cacuenta@ = cacuent6@;
                       |FINSI;
                       |SI alfa4 = 7;
                           cacuenta@ = cacuent7@;
                       |FINSI;
                       |SI alfa4 = 8;
                           cacuenta@ = cacuent8@;
                       |FINSI;
                       |SI alfa4 = 9;
                           cacuenta@ = cacuent9@;
                       |FINSI;
                       |SI alfa4 = 0;
                           cacuenta@ = cacuent0@;
                       |FINSI;
                       alfa3 = alfa2 % 4;
                       |QBF alfa3;
                       |SI alfa1 = "&";
                           |SI alfa3 > 0;|Y alfa3 < 6;|| Periodo
                              |SINO;                     || Nombre de la cuenta
                                alfa1 = "No hay nombre";
                           |FINSI;
                         |SINO;
                            alfa2 = alfa3;
                            |HAZ LaCuenta;
                            || |PINTA 601,alfa1;
                       |FINSI;
                 |SINO;
                   alfa1 = "";
               |FINSI;
               |SINO;
                 alfa1 = "";
               |FINSI;
               |ALFACALLDLL "agixl97.dll","reemplaza_dato",alfa1;
               |SI FSalida < 0;
                  cuentae = cuentae + 1;
               |SINO;
                  cuentae = 0;
               |FINSI;
             |FINSI;
      |SIGUE;
      || |ALFACALLDLL "agixl97.dll","ejecuta_macro",alfa2;
      |SI #conexm03#3 ! 0;
          |CIERRAT #cacuent1@;
      |FINSI;
      |SI #conexm03#6 ! 0;
          |CIERRAT #cacuent2@;
      |FINSI;
      |SI #conexm03#9 ! 0;
          |CIERRAT #cacuent3@;
      |FINSI;
      |SI #conexm03#12 ! 0;
          |CIERRAT #cacuent4@;
      |FINSI;
      |SI #conexm03#15 ! 0;
          |CIERRAT #cacuent5@;
      |FINSI;
      |SI #conexm03#18 ! 0;
          |CIERRAT #cacuent6@;
      |FINSI;
      |SI #conexm03#21 ! 0;
          |CIERRAT #cacuent7@;
      |FINSI;
      |SI #conexm03#24 ! 0;
          |CIERRAT #cacuent8@;
      |FINSI;
      |SI #conexm03#27 ! 0;
          |CIERRAT #cacuent9@;
      |FINSI;
      |SI #conexm03#30 ! 0;
          |CIERRAT #cacuent0@;
      |FINSI;
      |SI #conexm03#2 ! "N";|Y #conexm03#2 ! "n";
          alfa4 = "imprime";
        |SINO;
           alfa4 = "";
      |FINSI;
      |ALFACALLDLL "agixl97.dll","fin_book",alfa4;
  |FINSI;
  |DESCARGADLL "agixl97.dll";
  |FINSI;
  |CIERRAT #canempre@;
  |CIERRAT #conexm03;

|ET Final;
  |DESCARGA_DEF #canempre@;
  |DESCARGA_DEF #cacuenta@;
  |DESCARGA_DEF #cacuent0@;
  |DESCARGA_DEF #cacuent9@;
  |DESCARGA_DEF #cacuent8@;
  |DESCARGA_DEF #cacuent7@;
  |DESCARGA_DEF #cacuent6@;
  |DESCARGA_DEF #cacuent5@;
  |DESCARGA_DEF #cacuent4@;
  |DESCARGA_DEF #cacuent3@;
  |DESCARGA_DEF #cacuent2@;
  |DESCARGA_DEF #cacuent1@;
|FPRO;
