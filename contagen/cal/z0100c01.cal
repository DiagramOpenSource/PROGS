|FICHEROS;
     gadz0100;
     gadm0003;
     gadm0005;
     gadm0006;

     gadw0006;
     gadw0007,MANTE;

     :dsarchi/dpntm100;
     :dsarchi/dpntm101;
     :dsarchi/dsarw114;

     &agifa041@;   || Acceso
     &agifa024@;   || Clientes
     &agifa112@;   || Proveedores

     &agifa060@ #60;   || Cuentas por familias
     &agifa724@ #724;   || Cuentas por articulos

     &agifa084@;   || Facturas contado cabecera
     &agifa069@ #69;   || Facturas contado linea

     &agifa134@;   || Facturas ventas cabecera
     &agifa059@;   || Facturas ventas lineas
     &agifa071@;   || Albaranes ventas lineas

     &agifa079@;   || Facturas compras cabecera
     &agifa072@;   || Facturas compras lineas
     &agifa080@;   || Albaranes compras lineas
     &agifa091@;   || Forma de pago
|FIN;

|INCLUYE z0100var;

|PROCESO GrabaFPago;
     #gadm0006#0 = aFPago;
     |LEE 000#gadm0006.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #agifa091@#0 = aFPago;
     |LEE 000#agifa091@.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa091@;  |FINSI;

     |DDEFECTO #gadm0006;
     #gadm0006#0  = aFPago;
     #gadm0006#1  = #agifa091@#1;
     |GRABA 020#gadm0006.n;
     |LIBERA #gadm0006;
|FPRC;

|PROCESO GrabaDesglose;
     |SI nBase = 0;
         |ACABA;
     |FINSI;

     nLinDes = 0;

     |SELECT #3#gadm0003;
     #gadm0003#15 = nEmpr;
     #gadm0003#0  = nRegi;
     #gadm0003#8  = nLinea;
     #gadm0003#4  = aCtaDes;
     |LEE 000#gadm0003.=;
     |SI FSalida = 0;
         nLinDes = #gadm0003#1;
     |FINSI;

     |SELECT #1#gadm0003;
     |SI nLinDes = 0;
         #gadm0003#15 = nEmpr;
         #gadm0003#0  = nRegi;
         #gadm0003#1  = 99;
         |LEE 000#gadm0003.];
         |SI FSalida = 0;
             |LEE 000#gadm0003.a;
         |SINO;
             |LEE 000#gadm0003.u;
         |FINSI;

         nLinDes = 1;
         |SI FSalida = 0;  |Y #gadm0003#15 = nEmpr;
                           |Y #gadm0003#0  = nRegi;
             nLinDes = #gadm0003#1 + 1;
         |FINSI;
     |FINSI;

     #gadm0003#15 = nEmpr;
     #gadm0003#0  = nRegi;
     #gadm0003#1  = nLinDes;
     |LEE 101#gadm0003.=;
     |SI FSalida ! 0;
         |DDEFECTO #gadm0003;
         #gadm0003#15 = nEmpr;
         #gadm0003#0  = nRegi;
         #gadm0003#1  = nLinDes;
         #gadm0003#4  = aCtaDes;
         #gadm0003#8  = nLinea;

         |GRABA 020#gadm0003.b;
     |FINSI;

     #gadm0003#9  = #gadm0003#9 + nBase;
     |GRABA 020#gadm0003.a;
     |LIBERA #gadm0003;
|FPRC;

|PROCESO agifa071;
     aCtaDes = "";

     |SI #gadz0100#4 = "2";
         #agifa060@#0 = #agifa071@#13;
         |LEE 000#agifa060@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa060@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en la familia " + #agifa071@#13;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #gadz0100#4 = "3";
         #agifa724@#0 = #agifa071@#2;
         |LEE 000#agifa724@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa724@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             #agifa060@#0 = #agifa071@#13;
             |LEE 000#agifa060@.=;
             |SI FSalida = 0;
                 aCtaDes = #agifa060@#2;  |QBF aCtaDes;
             |FINSI;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en el art¡culo " + #agifa071@#2;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     enTIVA = #agifa071@#11;

     |SI enTIVA = enLin1; nLinea = 1;  |FINSI;
     |SI enTIVA = enLin2; nLinea = 2;  |FINSI;
     |SI enTIVA = enLin3; nLinea = 3;  |FINSI;
     |SI enTIVA = enLin4; nLinea = 4;  |FINSI;
     |SI enTIVA = enLin5; nLinea = 5;  |FINSI;

     nBase = #agifa071@#9;
     nRegi = #dpntm100#0;
     nEmpr = 1;
     |HAZ GrabaDesglose;
|FPRC;

|DEFBUCLE agifa071;
     #agifa071@#1003;
     ;
     #agifa059@#15, #agifa059@#2, 001;
     #agifa059@#15, #agifa059@#2, 999;
     ;
     NULL, agifa071;
|FIN;

|PROCESO agifa059;
     |BUCLE agifa071;
|FPRC;

|DEFBUCLE agifa059;
     #agifa059@#1003;
     ;
     #agifa134@#49, #agifa134@#0, 001;
     #agifa134@#49, #agifa134@#0, 999;
     ;
     NULL, agifa059;
|FIN;

|PROCESO agifa069;
     aCtaDes = "";
     |SI #gadz0100#4 = "2";
         #agifa060@#0 = #agifa069@#13;
         |LEE 000#agifa060@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa060@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en la familia " + #agifa071@#13;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #gadz0100#4 = "3";
         #agifa724@#0 = #agifa069@#2;
         |LEE 000#agifa724@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa724@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             #agifa060@#0 = #agifa069@#13;
             |LEE 000#agifa060@.=;
             |SI FSalida = 0;
                 aCtaDes = #agifa060@#2;  |QBF aCtaDes;
             |FINSI;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en el art¡culo " + #agifa071@#2;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     enTIVA = #agifa069@#11;

     |SI enTIVA = enLin1; nLinea = 1;  |FINSI;
     |SI enTIVA = enLin2; nLinea = 2;  |FINSI;
     |SI enTIVA = enLin3; nLinea = 3;  |FINSI;
     |SI enTIVA = enLin4; nLinea = 4;  |FINSI;
     |SI enTIVA = enLin5; nLinea = 5;  |FINSI;

     nBase = #agifa069@#9;
     nRegi = #dpntm100#0;
     nEmpr = 1;
     |HAZ GrabaDesglose;
|FPRC;

|DEFBUCLE agifa069;
     #agifa069@#1003;
     ;
     #agifa084@#48, #agifa084@#0, 001;
     #agifa084@#48, #agifa084@#0, 999;
     ;
     NULL, agifa069;
|FIN;

|PROCESO agifa080;
     aCtaDes = "";

     |SI #gadz0100#4 = "2";
         #agifa060@#0 = #agifa080@#13;
         |LEE 000#agifa060@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa060@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en la familia " + #agifa071@#13;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #gadz0100#4 = "3";
         #agifa724@#0 = #agifa080@#2;
         |LEE 000#agifa724@.=;
         |SI FSalida = 0;
             aCtaDes = #agifa724@#2;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             #agifa060@#0 = #agifa080@#13;
             |LEE 000#agifa060@.=;
             |SI FSalida = 0;
                 aCtaDes = #agifa060@#2;  |QBF aCtaDes;
             |FINSI;
         |FINSI;

         |SI aCtaDes = "";
             aCtaDes = #gadm0005#6;  |QBF aCtaDes;
         |FINSI;

         |SI aCtaDes = "";
             aAlfa = "0000No existe configuraci¢n de cuentas en el art¡culo " + #agifa071@#2;
             |MENAV aAlfa;

             nErrorDes = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     enTIVA = #agifa080@#11;

     |SI enTIVA = enLin1; nLinea = 1;  |FINSI;
     |SI enTIVA = enLin2; nLinea = 2;  |FINSI;
     |SI enTIVA = enLin3; nLinea = 3;  |FINSI;
     |SI enTIVA = enLin4; nLinea = 4;  |FINSI;
     |SI enTIVA = enLin5; nLinea = 5;  |FINSI;

     nBase = #agifa080@#9;
     nRegi = #dpntm101#0;
     nEmpr = 2;
     |HAZ GrabaDesglose;
|FPRC;

|DEFBUCLE agifa080;
     #agifa080@#1003;
     ;
     #agifa072@#17, #agifa072@#2, 001;
     #agifa072@#17, #agifa072@#2, 999;
     ;
     NULL, agifa080;
|FIN;

|PROCESO agifa072;
     |BUCLE agifa080;
|FPRC;

|DEFBUCLE agifa072;
     #agifa072@#1003;
     ;
     #agifa079@#66, #agifa079@#0, 001;
     #agifa079@#66, #agifa079@#0, 999;
     ;
     NULL, agifa072;
|FIN;

|PROCESO BuscaSerie;
     nOk = 0;

     |SELECT #3#gadm0005;
     #gadm0005#5 = aClv1;
     #gadm0005#1 = aClv2;
     |LEE 000#gadm0005.=;
     |SI FSalida = 0;
         |SI #gadm0005#16 = "N";
             |ACABA;
         |FINSI;

         nOk = 1;
         |ACABA;
     |FINSI;

     aAlfa = aClv2;  |QBF aAlfa;
     aAlfa = aAlfa % -3;
     aAlfa = aAlfa + "XX";
     #gadm0005#5 = aClv1;
     #gadm0005#1 = aAlfa;
     |LEE 000#gadm0005.=;
     |SI FSalida = 0;
         |SI #gadm0005#16 = "N";
             |ACABA;
         |FINSI;

         nOk = 1;
     |FINSI;
|FPRC;

|PROCESO agifa134;
     aClv1 = "R";
     aClv2 = #agifa134@#49;
     |HAZ BuscaSerie;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |LEE 000#dpntm100.u;
     |SI FSalida ! 0;  #dpntm100#0 = 0;  |FINSI;
     enReg = #dpntm100#0 + 1;

     enNumEmi = enNumEmi + 1;

     #agifa024@#0 = #agifa134@#2;
     |LEE 000#agifa024@.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa024@;  |FINSI;

     |DDEFECTO #dpntm100;

     aSer = #agifa134@#49;  |QBF aSer;
     |SI aSer = "";
         aFac = ("000000" + #agifa134@#0) % -106;
     |SINO;
         aFac = aSer + "/" + ("000000" + #agifa134@#0) % -106;
     |FINSI;

     #dpntm100#0  = enReg;
     #dpntm100#1  = #48#30;
     #dpntm100#2  = #agifa024@#15;
     #dpntm100#4  = #agifa024@#1;
     #dpntm100#5  = #agifa024@#205;
     #dpntm100#6  = "1";
     #dpntm100#7  = "NIF";
     #dpntm100#8  = "";
     #dpntm100#49 = "Operaci¢n habitual";
     #dpntm100#9  = 1;
     #dpntm100#10 = 0;
     #dpntm100#11 = "";
     #dpntm100#12 = "";

     |SI #agifa134@#101 ] 0;
         #dpntm100#13 = aFac;
     |FINSI;

     |SI #agifa134@#101 < 0;
         #dpntm100#14 = aFac;
     |FINSI;

     #dpntm100#15 = #agifa134@#1;

     enContIva = 0;
     enTBas    = #agifa134@#21 + #agifa134@#24 + #agifa134@#27;
     enTBas    = enTBas + #agifa134@#33 + #agifa134@#36;
     enTCuI    = #agifa134@#22 + #agifa134@#25 + #agifa134@#28;
     enTCuI    = enTCuI + #agifa134@#34 + #agifa134@#37;
     enTCuR    = #agifa134@#23 + #agifa134@#26 + #agifa134@#54;
     enTCuR    = enTCuR + #agifa134@#35 + #agifa134@#38;

     enTRet    = 0;
     enRet     = 0;
     enDRet    = 0;
     enLin1    = 0;
     enLin2    = 0;
     enLin3    = 0;
     enLin4    = 0;
     enLin5    = 0;

     |SI #agifa134@#55 ! 0;
         |SI #gadz0100#1 ! "dscomer7";
             enTRet    = #agifa134@#55;
             enRet     = #agifa024@#206;
             eaSobre   = #agifa024@#207;
         |FINSI;

         |SI #gadz0100#1 = "dscomer7";
             enTRet    = #agifa134@#55;
             enRet     = (enTRet * 100) / enTBas;
             eaSobre   = "B";
         |FINSI;
     |FINSI;

     |SI #agifa134@#119 ! 0;
         |SI #gadz0100#1 = "dscomer9";
             enTRet    = #agifa134@#119;
             enRet     = #agifa134@#122;
             eaSobre   = "B";
         |FINSI;
     |FINSI;

     |SI #agifa134@#21 ! 0;
         enBas  = #agifa134@#21;
         enIva  = #agifa134@#39;
         enCuI  = #agifa134@#22;
         enRec  = #agifa134@#40;
         enCuR  = #agifa134@#23;
         enTIVA = 1;

         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa134@#24 ! 0;
         enBas  = #agifa134@#24;
         enIva  = #agifa134@#41;
         enCuI  = #agifa134@#25;
         enRec  = #agifa134@#42;
         enCuR  = #agifa134@#26;
         enTIVA = 2;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa134@#27 ! 0;
         enBas  = #agifa134@#27;
         enIva  = #agifa134@#43;
         enCuI  = #agifa134@#28;
         enRec  = #agifa134@#44;
         enCuR  = #agifa134@#54;
         enTIVA = 3;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa134@#33 ! 0;
         enBas = #agifa134@#33;
         enIva = #agifa134@#50;
         enCuI = #agifa134@#34;
         enRec = #agifa134@#51;
         enCuR = #agifa134@#35;
         enTIVA = 4;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa134@#36 ! 0;
         enBas  = #agifa134@#36;
         enIva  = #agifa134@#52;
         enCuI  = #agifa134@#37;
         enRec  = #agifa134@#53;
         enCuR  = #agifa134@#38;
         enTIVA = 5;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa134@#47 ! 0;
         enBas  = #agifa134@#47;
         enIva  = 0;
         enCuI  = 0;
         enRec  = 0;
         enCuR  = 0;
         enTIVA = 0;

         |HAZ GrabaBloque100;
     |FINSI;

     nDif = enDRet - enTRet;
     |SI nDif ! 0;
         #dpntm100#27 = #dpntm100#27 + nDif;
     |FINSI;

     #dpntm100#28 = #agifa134@#31;
     #dpntm100#51 = #agifa024@#8;
     #dpntm100#52 = (("00" + #agifa024@#181) % -102) + (("000" + #agifa024@#182) % -103);
     #dpntm100#53 = #agifa024@#9;
     #dpntm100#54 = #agifa024@#17;
     #dpntm100#55 = #agifa024@#18;
     #dpntm100#80 = #agifa024@#16;

     #dpntm100#44 = "S";
     #dpntm100#76 = #gadz0100#1;
     #dpntm100#77 = "agifa134";
     #dpntm100#78 = #agifa134@#49;
     #dpntm100#79 = #agifa134@#0;
     #dpntm100#56 = #agifa134@#11;

     |GRABA 020#dpntm100.n;
     |LIBERA #dpntm100;

     |SI #gadz0100#4 ! "1";
         |BUCLE agifa059;
     |FINSI;

     |PARA nCampo = 0;  |SI nCampo [ 79;  |HACIENDO nCampo = nCampo + 1;
           #dsarw114#nCampo# = #dpntm100#nCampo#;
     |SIGUE;

     |SI #dpntm100#30 ! 0;  |O #dpntm100#37 ! 0; |O #dpntm100#57 ! 0; |O #dpntm100#64 ! 0;
         enRegPrimerIVA = #dpntm100#0;
         |HAZ RestoBases100;
     |FINSI;

     aFPago = #agifa134@#11;
     |HAZ GrabaFPago;
|FPRC;

|DEFBUCLE agifa134D8;
     #agifa134@#1002;
     48, 1;
     aDSer, 000001, "N", aDFec;
     aHSer, 999999, "N", aHFec;
     ;
     NULL, agifa134;
|FIN;

|DEFBUCLE agifa134D9;
     #agifa134@#5003;
     1;
     "N", aDSer, 000001, aDFec;
     "N", aHSer, 999999, aHFec;
     ;
     NULL, agifa134;
|FIN;

|PROCESO LeeAgifa134;
     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa134.mas";
     |CARGA_DEF aMas, agifa134@;
     |PATH_DAT #agifa134@#eaPathComer#;

     |SI #gadz0100#4 ! "1";
         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa059.mas";
         |CARGA_DEF aMas, agifa059@;
         |PATH_DAT #agifa059@#eaPathComer#;

         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa071.mas";
         |CARGA_DEF aMas, agifa071@;
         |PATH_DAT #agifa071@#eaPathComer#;
     |FINSI;

     aDFec   = #gadw0007#2;
     aHFec   = #gadw0007#3;
     aDSer   = #gadw0007#0;
     aHSer   = #gadw0007#1;
     |SI #gadz0100#1 = "dscomer7";
         aDSer = aDSer % 102;
         aHSer = aHSer % 102;
     |FINSI;

     |SI #gadz0100#1 = "dscomer9";  |BUCLE agifa134D9;  |FINSI;
     |SI #gadz0100#1 ! "dscomer9";  |BUCLE agifa134D8;  |FINSI;

     |SI #gadz0100#4 ! "1";
         |DESCARGA_DEF #agifa071@;
         |DESCARGA_DEF #agifa059@;
     |FINSI;

     |DESCARGA_DEF #agifa134@;
|FPRC;

|PROCESO agifa084;
     aClv1 = "R";
     aClv2 = #agifa084@#48;
     |HAZ BuscaSerie;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |LEE 000#dpntm100.u;
     |SI FSalida ! 0;  #dpntm100#0 = 0;  |FINSI;
     enReg = #dpntm100#0 + 1;

     enNumEmi = enNumEmi + 1;

     #agifa024@#0 = #agifa084@#3;
     |LEE 000#agifa024@.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa024@;  |FINSI;

     |DDEFECTO #dpntm100;

     aSer = #agifa084@#48;  |QBF aSer;
     |SI aSer = "";
         aFac = ("000000" + #agifa084@#0) % -106;
     |SINO;
         aFac = aSer + "/" + ("000000" + #agifa084@#0) % -106;
     |FINSI;

     #dpntm100#0  = enReg;
     #dpntm100#1  = #48#30;
     #dpntm100#2  = #agifa024@#15;
     #dpntm100#4  = #agifa024@#1;
     #dpntm100#5  = #agifa024@#205;
     #dpntm100#6  = "1";
     #dpntm100#7  = "NIF";
     #dpntm100#8  = "";
     #dpntm100#49 = "Operaci¢n habitual";
     #dpntm100#9  = 1;
     #dpntm100#10 = 0;
     #dpntm100#11 = "";
     #dpntm100#12 = "";

     |SI #agifa084@#41 ] 0;
         #dpntm100#13 = aFac;
     |FINSI;

     |SI #agifa084@#41 < 0;
         #dpntm100#14 = aFac;
     |FINSI;

     #dpntm100#15 = #agifa084@#1;

     enContIva = 0;

     enTBas    = #agifa084@#16 + #agifa084@#19 + #agifa084@#22;
     enTBas    = enTBas + #agifa084@#42 + #agifa084@#45;
     enTCuI    = #agifa084@#17 + #agifa084@#20 + #agifa084@#23;
     enTCuI    = enTCuI + #agifa084@#43 + #agifa084@#46;
     enTCuR    = #agifa084@#18 + #agifa084@#21 + #agifa084@#49;
     enTCuR    = enTCuR + #agifa084@#44 + #agifa084@#47;

     enTRet    = 0;
     enRet     = 0;
     enDRet    = 0;
     enLin1    = 0;
     enLin2    = 0;
     enLin3    = 0;
     enLin4    = 0;
     enLin5    = 0;

     |SI #gadz0100#1 ! "dscomer7";
         enTRet    = #agifa084@#96;
         enRet     = #agifa024@#206;
         eaSobre   = #agifa024@#207;
     |FINSI;

     |SI #agifa084@#16 ! 0;
         enBas  = #agifa084@#16;
         enIva  = #agifa084@#50;
         enCuI  = #agifa084@#17;
         enRec  = #agifa084@#51;
         enCuR  = #agifa084@#18;
         enTIVA = 1;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa084@#19 ! 0;
         enBas  = #agifa084@#19;
         enIva  = #agifa084@#52;
         enCuI  = #agifa084@#20;
         enRec  = #agifa084@#53;
         enCuR  = #agifa084@#21;
         enTIVA = 2;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa084@#22 ! 0;
         enBas  = #agifa084@#22;
         enIva  = #agifa084@#54;
         enCuI  = #agifa084@#23;
         enRec  = #agifa084@#55;
         enCuR  = #agifa084@#49;
         enTIVA = 3;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa084@#42 ! 0;
         enBas  = #agifa084@#42;
         enIva  = #agifa084@#56;
         enCuI  = #agifa084@#43;
         enRec  = #agifa084@#57;
         enCuR  = #agifa084@#44;
         enTIVA = 4;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa084@#45 ! 0;
         enBas  = #agifa084@#45;
         enIva  = #agifa084@#58;
         enCuI  = #agifa084@#46;
         enRec  = #agifa084@#59;
         enCuR  = #agifa084@#47;
         enTIVA = 5;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI #agifa084@#28 ! 0;
         enBas  = #agifa084@#28;
         enIva  = 0;
         enCuI  = 0;
         enRec  = 0;
         enCuR  = 0;
         enTIVA = 0;
         |HAZ GrabaBloque100;
     |FINSI;

     nDif = enDRet - enTRet;
     |SI nDif ! 0;
         #dpntm100#27 = #dpntm100#27 + nDif;
     |FINSI;

     #dpntm100#28 = #agifa084@#41;
     #dpntm100#51 = #agifa024@#8;
     #dpntm100#52 = (("00" + #agifa024@#181) % -102) + (("000" + #agifa024@#182) % -103);
     #dpntm100#53 = #agifa024@#9;
     #dpntm100#54 = #agifa024@#17;
     #dpntm100#55 = #agifa024@#18;
     #dpntm100#80 = #agifa024@#16;

     #dpntm100#44 = "S";
     #dpntm100#76 = #gadz0100#1;
     #dpntm100#77 = "agifa084";
     #dpntm100#78 = #agifa084@#48;
     #dpntm100#79 = #agifa084@#0;
     #dpntm100#56 = #agifa084@#8;

     |GRABA 020#dpntm100.n;
     |LIBERA #dpntm100;

     |SI #gadz0100#4 ! "1";
         |BUCLE agifa069;
     |FINSI;

     |PARA nCampo = 0;  |SI nCampo [ 79;  |HACIENDO nCampo = nCampo + 1;
           #dsarw114#nCampo# = #dpntm100#nCampo#;
     |SIGUE;

     |SI #dpntm100#30 ! 0;  |O #dpntm100#37 ! 0; |O #dpntm100#57 ! 0; |O #dpntm100#64 ! 0;
         enRegPrimerIVA = #dpntm100#0;
         |HAZ RestoBases100;
     |FINSI;

     aFPago = #agifa084@#8;
     |HAZ GrabaFPago;
|FPRC;

|DEFBUCLE agifa084;
     #agifa084@#4003;
     39;
     aDSer, aDFec, 000001, "N";
     aHSer, aHFec, 999999, "N";
     ;
     NULL, agifa084;
|FIN;

|PROCESO LeeAgifa084;
     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa084.mas";
     |CARGA_DEF aMas, agifa084@;
     |PATH_DAT #agifa084@#eaPathComer#;

     |SI #gadz0100#4 ! "1";
         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa069.mas";
         |CARGA_DEF aMas, agifa069@;
         |PATH_DAT #agifa069@#eaPathComer#;
     |FINSI;

     aDFec   = #gadw0007#2;
     aHFec   = #gadw0007#3;
     aDSer   = #gadw0007#0;
     aHSer   = #gadw0007#1;
     |SI #gadz0100#1 = "dscomer7";
         aDSer = aDSer % 102;
         aHSer = aHSer % 102;
     |FINSI;

     |BUCLE agifa084;

     |SI #gadz0100#4 ! "1";
         |DESCARGA_DEF #agifa069@;
     |FINSI;

     |DESCARGA_DEF #agifa084@;
|FPRC;

|PROCESO agifa079;
     aClv1 = "S";
     aClv2 = #agifa079@#66;
     |HAZ BuscaSerie;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |LEE 000#dpntm101.u;
     |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
     enReg = #dpntm101#0 + 1;

     enNumRec = enNumRec + 1;

     #agifa112@#0 = #agifa079@#2;
     |LEE 000#agifa112@.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa112@;  |FINSI;

     |DDEFECTO #dpntm101;

     aFac = #agifa079@#74;  |QBF aFac;
     |SI aFac = "";
         aSer = #agifa079@#66;  |QBF aSer;
         |SI aSer = "";
             aFac = ("000000" + #agifa079@#0) % -106;
         |SINO;
             aFac = aSer + "/" + ("000000" + #agifa079@#0) % -106;
         |FINSI;
     |FINSI;

     #dpntm101#0  = enReg;
     #dpntm101#2  = #agifa112@#9;
     #dpntm101#4  = #agifa112@#1;
     #dpntm101#5  = #agifa112@#89;
     #dpntm101#6  = "1";
     #dpntm101#7  = "NIF";
     #dpntm101#8  = "";
     #dpntm101#49 = "Operaci¢n habitual";
     #dpntm101#9  = 1;
     #dpntm101#10 = 0;
     #dpntm101#11 = "";
     #dpntm101#12 = "";

     |SI #agifa079@#31 ] 0;
         #dpntm101#13 = aFac;
     |FINSI;

     |SI #agifa079@#31 < 0;
         #dpntm101#14 = aFac;
     |FINSI;

     #dpntm101#15 = #agifa079@#1;

     enContIva = 0;

     enTBas    = #agifa079@#21 + #agifa079@#24 + #agifa079@#27;
     enTBas    = enTBas + #agifa079@#49 + #agifa079@#52;
     enTCuI    = #agifa079@#22 + #agifa079@#25 + #agifa079@#28;
     enTCuI    = enTCuI + #agifa079@#50 + #agifa079@#53;
     enTCuR    = #agifa079@#23 + #agifa079@#26 + #agifa079@#55;
     enTCuR    = enTCuR + #agifa079@#51 + #agifa079@#54;

     enTRet    = 0;
     enRet     = 0;
     enDRet    = 0;
     enLin1    = 0;
     enLin2    = 0;
     enLin3    = 0;
     enLin4    = 0;
     enLin5    = 0;

     |SI #agifa134@#67 ! 0;
         enTRet    = #agifa079@#67;
         enRet     = #agifa112@#78;
         eaSobre   = #agifa112@#86;
     |FINSI;

     |SI #agifa079@#21 ! 0;
         enBas  = #agifa079@#21;
         enIva  = #agifa079@#56;
         enCuI  = #agifa079@#22;
         enRec  = #agifa079@#57;
         enCuR  = #agifa079@#23;
         enTIVA = 1;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI #agifa079@#24 ! 0;
         enBas  = #agifa079@#24;
         enIva  = #agifa079@#58;
         enCuI  = #agifa079@#25;
         enRec  = #agifa079@#59;
         enCuR  = #agifa079@#26;
         enTIVA = 2;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI #agifa079@#27 ! 0;
         enBas  = #agifa079@#27;
         enIva  = #agifa079@#60;
         enCuI  = #agifa079@#28;
         enRec  = #agifa079@#61;
         enCuR  = #agifa079@#55;
         enTIVA = 3;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI #agifa079@#49 ! 0;
         enBas  = #agifa079@#49;
         enIva  = #agifa079@#62;
         enCuI  = #agifa079@#50;
         enRec  = #agifa079@#63;
         enCuR  = #agifa079@#51;
         enTIVA = 4;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI #agifa079@#52 ! 0;
         enBas  = #agifa079@#52;
         enIva  = #agifa079@#64;
         enCuI  = #agifa079@#53;
         enRec  = #agifa079@#65;
         enCuR  = #agifa079@#54;
         enTIVA = 5;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI #agifa079@#47 ! 0;
         enBas  = #agifa079@#47;
         enIva  = 0;
         enCuI  = 0;
         enRec  = 0;
         enCuR  = 0;
         enTIVA = 0;
         |HAZ GrabaBloque101;
     |FINSI;

     nDif = enDRet - enTRet;
     |SI nDif ! 0;
         #dpntm100#27 = #dpntm100#27 + nDif;
     |FINSI;

     #dpntm101#28 = #agifa079@#31;
     #dpntm101#51 = #agifa112@#3;
     #dpntm101#52 = (("00" + #agifa112@#74) % -102) + (("000" + #agifa112@#75) % -103);
     #dpntm101#53 = #agifa112@#4;
     #dpntm101#54 = #agifa112@#6;
     #dpntm101#55 = #agifa112@#7;
     #dpntm101#80 = #agifa112@#10;

     #dpntm101#44 = "S";
     #dpntm101#76 = #gadz0100#1;
     #dpntm101#77 = "agifa079";
     #dpntm101#78 = #agifa079@#66;
     #dpntm101#79 = #agifa079@#0;
     #dpntm101#56 = #agifa079@#11;

     |GRABA 020#dpntm101.n;
     |LIBERA #dpntm101;

     |SI #gadz0100#4 ! "1";
         |BUCLE agifa072;
     |FINSI;

     |PARA nCampo = 0;  |SI nCampo [ 79;  |HACIENDO nCampo = nCampo + 1;
           #dsarw114#nCampo# = #dpntm101#nCampo#;
     |SIGUE;

     |SI #dpntm101#30 ! 0;  |O #dpntm101#37 ! 0; |O #dpntm101#57 ! 0; |O #dpntm101#64 ! 0;
         enRegPrimerIVA = #dpntm101#0;
         |HAZ RestoBases101;
     |FINSI;

     aFPago = #agifa079@#11;
     |HAZ GrabaFPago;
|FPRC;

|DEFBUCLE agifa079D8;
     #agifa079@#1002;
     48, 1;
     aDSer, 000001, "N", aDFec;
     aHSer, 999999, "N", aHFec;
     ;
     NULL, agifa079;
|FIN;

|DEFBUCLE agifa079D9;
     #agifa079@#5003;
     1;
     "N", aDSer, 000001, aDFec;
     "N", aHSer, 999999, aHFec;
     ;
     NULL, agifa079;
|FIN;

|PROCESO LeeAgifa079;
     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa079.mas";
     |CARGA_DEF aMas, agifa079@;
     |PATH_DAT #agifa079@#eaPathComer#;

     |SI #gadz0100#4 ! "1";
         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa072.mas";
         |CARGA_DEF aMas, agifa072@;
         |PATH_DAT #agifa072@#eaPathComer#;

         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa080.mas";
         |CARGA_DEF aMas, agifa080@;
         |PATH_DAT #agifa080@#eaPathComer#;
     |FINSI;

     aDFec   = #gadw0007#2;
     aHFec   = #gadw0007#3;
     aDSer   = #gadw0007#0;
     aHSer   = #gadw0007#1;
     |SI #gadz0100#1 = "dscomer7";
         aDSer = aDSer % 102;
         aHSer = aHSer % 102;
     |FINSI;

     |SI #gadz0100#1 = "dscomer9";  |BUCLE agifa079D9;  |FINSI;
     |SI #gadz0100#1 ! "dscomer9";  |BUCLE agifa079D8;  |FINSI;

     |SI #gadz0100#4 ! "1";
         |DESCARGA_DEF #agifa080@;
         |DESCARGA_DEF #agifa072@;
     |FINSI;

     |DESCARGA_DEF #agifa079@;
|FPRC;

|PROCESO RecogeCOMER;
     |SI #gadz0100#2 = 0;  |ACABA;  |FINSI;

     aCod = (("00000" + #gadz0100#2) % -105);
     |SI #gadz0100#1 = "dscomer7";
         aCod = (("00" + #gadz0100#2) % -102);
     |FINSI;

     |DFICE eaPathDPNTM;

     eaPathComer = eaBase + #gadz0100#1;  |QBF eaPathComer;
     eaPathComer = eaPathComer + "/fich/" + aCod + "/";

     |PATH_DAT #dpntm100#eaPathDPNTM#;
     |PATH_DAT #dpntm101#eaPathDPNTM#;

     |ABRE #dpntm100;  |CIERRA #dpntm100;  |DELINDEX #dpntm100;
     |ABRE #dpntm101;  |CIERRA #dpntm101;  |DELINDEX #dpntm101;
     |ABRE #gadm0003;  |CIERRA #gadm0003;  |DELINDEX #gadm0003;

     |ABRE #dpntm100;
     |ABRE #dpntm101;
     |ABRE #gadm0003;

     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa024.mas";
     |CARGA_DEF aMas, agifa024@;
     |PATH_DAT #agifa024@#eaPathComer#;

     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa112.mas";
     |CARGA_DEF aMas, agifa112@;
     |PATH_DAT #agifa112@#eaPathComer#;

     aMas = eaBase + #gadz0100#1;  |QBF aMas;
     aMas = aMas + "/def/agifa091.mas";
     |CARGA_DEF aMas, agifa091@;
     |PATH_DAT #agifa091@#eaPathComer#;

     |SI #gadz0100#4 ! "1";
         aMas = eaBase + #gadz0100#1;  |QBF aMas;
         aMas = aMas + "/def/agifa060.mas";
         |CARGA_DEF aMas, agifa060@;
         |PATH_DAT #agifa060@#eaPathComer#;
         |ABRE #agifa060@;

         |SI #gadz0100#4 = "3";
             aMas = eaBase + #gadz0100#1;  |QBF aMas;
             aMas = aMas + "/def/agifa724.mas";
             |CARGA_DEF aMas, agifa724@;
             |PATH_DAT #agifa724@#eaPathComer#;
             |ABRE #agifa724@;
         |FINSI;
     |FINSI;

     |ABRE #agifa024@;
     |ABRE #agifa112@;
     |ABRE #agifa091@;

     |VENTANA 0501, 0540, -1, 16, "Buscando facturas ...";
     n0Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |ABRET #gadm0005;  |SELECT #3#gadm0005;
     |ABRET #gadm0006;

     nErrorDes  = 0;
     |HAZ LeeAgifa134;
     |HAZ LeeAgifa084;
     |HAZ LeeAgifa079;

     |SELECT #1#gadm0005;
     |CIERRAT #gadm0005;
     |CIERRAT #gadm0006;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n0Vent;

     |CIERRA #agifa024@;
     |CIERRA #agifa112@;
     |CIERRA #agifa091@;
     |CIERRA #dpntm100;
     |CIERRA #dpntm101;
     |CIERRA #gadm0003;

     |SI #gadz0100#4 ! "1";
         |CIERRA #agifa060@;
         |SI #gadz0100#4 = "3";
             |CIERRA #agifa724@;
             |DESCARGA_DEF #agifa724@;
         |FINSI;

         |DESCARGA_DEF #agifa060@;
     |FINSI;

     |SI nErrorDes = 1;
         aAlfa = "0000No se ha podido recoger los datos por " + #gadz0100#5;  |QBF aAlfa;
         aAlfa = aAlfa + " . Se dejan los datos por Total factura".

         #gadz0100#4 = "1";
         #gadz0100#5 = "Total factura";  |PINTA #gadz0100#5;

         |DELINDEX #gadm0003;
     |FINSI;

     |DESCARGA_DEF #agifa091@;
     |DESCARGA_DEF #agifa112@;
     |DESCARGA_DEF #agifa024@;
|FPRC;
