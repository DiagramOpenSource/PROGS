|| ............... Defectos de IVA y Contador IVA
|FICHEROS;

   cainliva;
   calibros;
   caivases;
   camaasiv;
   camaniv@ #10;

   caivaasi;
   caivaaxx;

   cadeflab;
   cacuiv2c;
   cacuiv2l;

   :/contagen/def/canempre #30;
   :/modelos/def/dsmom107;
   :/modelos/def/dsmom002;
   :/modelos/def/dsmom004;
   :/modelos/def/dsmom006;
   :/modelos/def/dsmom030;
   :/modelos/def/dsmom026;

   :/basica/def/agitab99;
|FIN;

|VARIABLES;
 aDSerie     = "";
 aHSerie     = "";
 nDLib       = 0;
 nHLib       = 0;

 suma        = 0;
 factura     = 0;
 sw          = 0;
 NumFactura  = 0;
 Serie       = "";
 &enQSerie   = 0;

 aAlfa     = "";
 aAlfa1    = "";
 aAlfa2    = "";
 aTipPer   = "";
 nSw1      = 0;
 nNume1    = 0;
 nAny      = 0;
 nPerio    = 0;
 nModelo   = 0;

 &eswNoLab = 0;
 &eswNoIva = 0;
 nSwGraba  = 0;
 nDif      = 0;
 aTPerio   = "";
 aMPerio   = "";
 aPath     = "";

 &eaErrorMod = "";
 &enMensaMod = 0;
 &enPerSCAN  = 0;

  aQueQuiero = "";
  aNumCampos = "";
  nNumCampos = 0;
  nPara1     = 0;
  aIDCampo   = "";
  nLeo       = 0;
  nSwGrupo   = 0;
  nEmpresa   = 0;
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscoiv_i;

|PROCESO eAcActualiza;
   nLeo = 0;
   |SI #caivaasi#187 = "S"; |Y enAParam ! 0;
       |ABRE #caivaaxx;
       #caivaaxx#0 = enAParam;
       |LEE 041#caivaaxx.=;
       |SI FSalida = 0;
           |SI #caivaaxx#73 = "N";
               #caivaaxx#73 = "B";
           |SINO;
               #caivaaxx#73 = "N";
           |FINSI;
           |GRABA 020#caivaaxx.a;
           |LIBERA #caivaaxx;
           |CIERRA #caivaaxx;
           nLeo = 1;
           #caivaasi#110 = #caivaaxx#73;
       |FINSI;
   |FINSI;
   |SI nLeo = 0;
       |ABRE #caivaasi;
       |LEE 101#caivaasi.p;
       |SI FSalida = 0;
           |SI #caivaasi#110 = "N";
               #caivaasi#110 = "B";
           |SINO;
               #caivaasi#110 = "N";
           |FINSI;
           |GRABA 020#caivaasi.a;
       |FINSI;
       |LIBERA #caivaasi;
       |CIERRA #caivaasi;
   |FINSI;
|FPRC;

|PROCESO eActivParam;
   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 041#caivaasi.p;
   |SI FSalida ! 0;
       |GRABA 040#caivaasi.n;
   |FINSI;
   |CIERRA #caivaasi;

   |SI enAParam ! 0; |Y #caivaasi#187 = "S";
      aQueQuiero = "|NC";
      aNumCampos = #caivaaxx#aQueQuiero#;
      nNumCampos = aNumCampos;
      nNumCampos = nNumCampos - 1;

      |ABRE #caivaaxx;
      #caivaaxx#0 = enAParam;
      |LEE 041#caivaaxx.=;
      |SI FSalida = 0;
          |PARA nPara1 = 2; |SI nPara1 [ nNumCampos; |HACIENDO nPara1 = nPara1 + 1;
                aAlfa = ("000" + nPara1) % -103;
                aQueQuiero = "|C" + aAlfa + "IDCAMPO";
                aIDCampo = #caivaaxx#aQueQuiero#;
                |QBF aIDCampo;
                |SI aIDCampo ! "";
                    aAlfa  = aIDCampo % 2; |QBF aAlfa;
                    nNume1 = aAlfa;
                    #caivaasi#nNume1# = #caivaaxx#nPara1#;
                |FINSI;
          |SIGUE;
      |FINSI;
      #caivaasi#19 = ("00" + enAParam) % -102;
      #caivaasi#20 = "N";
      |CIERRA #caivaaxx;
  |FINSI;
|FPRC;

|PROCESO eLeeParametro;
   |SI dirfich0 ! "";
       |PATH_DAT #caivaasi#dirfich0#;
       |PATH_DAT #caivaaxx#dirfich0#;
   |FINSI;

   |HAZ eParaModelos;
   |HAZ eActivParam;

   eaPaDOM1 = #caivaasi#114;  ||documento automatico
   eaPaDOM2 = #caivaasi#133;  ||permitir repetir diferentes diarios
   eaPaDOM3 = #caivaasi#134;  ||permitir ultimo + 1
   eaPaCTA1 = #caivaasi#135;  ||permitir alta no estructuras 2008
   eaPaCTA2 = #caivaasi#136;  ||Aviso 1990
   eaPaNif1 = #caivaasi#152;
   eaPaNif2 = #caivaasi#153;
   snFiltr  = #caivaasi#95;
   snFiltrA = #caivaasi#185;
   snFilAc  = #caivaasi#118;
   snFilBa  = #caivaasi#119;
   eaDesgDef = #caivaasi#154;
   eaSobreEs = #caivaasi#155;
   eaABanco  = #caivaasi#161;
   eaCP347   = #caivaasi#164;
   eaTEmbargo = #caivaasi#165;
   enCEmbargo = #caivaasi#166;
   eaObClPr   = #caivaasi#186;
|FPRC;

|PROCESO eParaModelos;
   |HAZ DirAplicSt;
   |SI aPModelo ! "";
        aPath = aPModelo + "fich/";
   |SINO;
        |DBASS aPath;
        aPath = aPath + "modelos/fich/";
   |FINSI;

   |PATH_DAT #dsmom107#aPath#;
   |ABRE #dsmom107;
   |DDEFECTO #dsmom107;
   |LEE 040#dsmom107.p;
   |CIERRA #dsmom107;
   enSwSelCp = 0; |SI #dsmom107#4  = "S"; enSwSelCp = 1; |FINSI;
   enSwSelFc = 0; |SI #dsmom107#32 = "S"; enSwSelFc = 1; |FINSI;
|FPRC;

|PROCESO LeeDefIVA;

   |HAZ eActivParam;
   |SI #caivaasi#137 = " ";
       |SI #caivaasi#48 = "S"; #caivaasi#48 = "P"; |FINSI;
       |SI #caivaasi#52 = "S"; #caivaasi#52 = "P"; |FINSI;
       #caivaasi#137 = #caivaasi#103;
   |FINSI;
   |SI #caivaasi#149 = " "; #caivaasi#149 = #caivaasi#46; |FINSI;

   |ABRE #cadeflab;
   |DDEFECTO #cadeflab;
   |LEE 040#cadeflab.p;
   |CIERRA #cadeflab;

   |HAZ eParaModelos;

   enQSerie = 0; |SI #caivaasi#44 = "S"; enQSerie = 1; |FINSI;
   |SI aTipoIVA = "R";
       dLibro = #caivaasi#3;   snLibro = #caivaasi#4;
       dSerie = #caivaasi#63;  snSerie = #caivaasi#64;
       dConc1 = #caivaasi#5;   snConc1 = #caivaasi#6;
       dDesc1 = #caivaasi#7;   snDesc1 = #caivaasi#8;
       dTiva  = #caivaasi#9;   snTiva  = #caivaasi#10;
       dConc2 = #caivaasi#13;  snConc2 = #caivaasi#14;
       dDesc2 = #caivaasi#15;  snDesc2 = #caivaasi#16;
       dDeduc = #caivaasi#71;  snDeduc = #caivaasi#72;
       dInver = #caivaasi#23;  snInver = #caivaasi#24;
       dCtaNoD = #caivaasi#81; |QBF dCtaNoD;

       dCoPag  = #caivaasi#48;
       snCoPa  = #caivaasi#103;
       dCtaCar = #caivaasi#49; |QBF dCtaCar;
       dConCar = #caivaasi#50;
       dDesCar = #caivaasi#51;
       dAnyCar = #caivaasi#99;
       dCtaCEf = #caivaasi#138; |QBF dCtaCEf;
       dConCEf = #caivaasi#139;
       dDesCEf = #caivaasi#140;
       dAnyCEf = #caivaasi#141;
       snCtaEf = #caivaasi#146;
       snCtaCa = #caivaasi#159;
       snFecEf = #caivaasi#181;

       snReten = #caivaasi#104;
       nDCIrpf = #caivaasi#83;
       nHCIrpf = #caivaasi#84;
       snAbono = #caivaasi#93;
       dTpIrpf = #caivaasi#106; snTpIrpf = #caivaasi#107;
       snDIrpf = #caivaasi#157;

       amCCaja = #caivaasi#177;
       aCCCta  = #caivaasi#178;
       nCCCon1 = #caivaasi#173;
       nCCCon2 = #caivaasi#174;
       aCCCla1 = #caivaasi#169;
       aCCCla2 = #caivaasi#170;

   |FINSI;
   |SI aTipoIVA = "S";
       dLibro = #caivaasi#29;  snLibro = #caivaasi#30;
       dSerie = #caivaasi#65;  snSerie = #caivaasi#66;
       dConc1 = #caivaasi#31;  snConc1 = #caivaasi#32;
       dDesc1 = #caivaasi#33;  snDesc1 = #caivaasi#34;
       dTiva  = #caivaasi#11;  snTiva  = #caivaasi#12;
       dConc2 = #caivaasi#57;  snConc2 = #caivaasi#58;
       dDesc2 = #caivaasi#59;  snDesc2 = #caivaasi#60;
       dDeduc = #caivaasi#21;  snDeduc = #caivaasi#22;
       dInver = #caivaasi#61;  snInver = #caivaasi#62;
       dCtaNoD = #caivaasi#82; |QBF dCtaNoD;

       dCoPag  = #caivaasi#52;
       snCoPa  = #caivaasi#137;
       dCtaCar = #caivaasi#53; |QBF dCtaCar;
       dConCar = #caivaasi#54;
       dDesCar = #caivaasi#55;
       dAnyCar = #caivaasi#100;
       dCtaCEf = #caivaasi#142; |QBF dCtaCEf;
       dConCEf = #caivaasi#143;
       dDesCEf = #caivaasi#144;
       dAnyCEf = #caivaasi#145;
       snCtaEf = #caivaasi#147;
       snCtaCa = #caivaasi#160;
       snFecEf = #caivaasi#182;

       snReten = #caivaasi#105;
       nDCIrpf = #caivaasi#85;
       nHCIrpf = #caivaasi#86;
       snAbono = #caivaasi#94;
       dTpIrpf = #caivaasi#108; snTpIrpf = #caivaasi#109;
       snDIrpf = #caivaasi#158;
       |SI nIvaInc = 0; |Y dDeduc = "I"; dDeduc = "N"; |FINSI;

       amCCaja = #caivaasi#179;
       aCCCta  = #caivaasi#180;
       nCCCon1 = #caivaasi#175;
       nCCCon2 = #caivaasi#176;
       aCCCla1 = #caivaasi#171;
       aCCCla2 = #caivaasi#172;
   |FINSI;
   |SI aTipoIVA = "N";
       dLibro = #cadeflab#19;  snLibro = #cadeflab#43;
       dSerie = "  ";          snSerie = #caivaasi#44;
       dConc1 = "001";         snConc1 = "S";
       dDesc1 = "";            snDesc1 = "S";
       dTiva  = 00;            snTiva  = "S";
       dConc2 = "001";         snConc2 = "R";
       dDesc2 = "";            snDesc2 = "R";
       dDeduc = "N";           snDeduc = "N";
       dInver = "N";           snInver = "N";
       dCtaNoD = "";
       dCtaCar = #caivaasi#53; |QBF dCtaCar;
       dConCar = #caivaasi#54;
       dDesCar = #caivaasi#55;
       snReten = "S";
       nDCIrpf = 1;
       nHCIrpf = 999;
       snAbono = "N";
       dTpIrpf = 0; snTpIrpf = "S";
       snDIrpf = "S";
   |FINSI;
   eaPaDOM1  = #caivaasi#114;
   eaPaDOM2  = #caivaasi#133;
   eaPaDOM3  = #caivaasi#134;
   eaPaCTA1  = #caivaasi#135;
   eaPaCTA2  = #caivaasi#136;
   eaPaNif1  = #caivaasi#152;
   eaPaNif2  = #caivaasi#153;
   dTIrpf    = #caivaasi#89;
   snBIrpf   = #caivaasi#90;
   snCIrpf   = #caivaasi#91;
   snFiltrA  = #caivaasi#185;
   snFiltr   = #caivaasi#95;
   snFilAc   = #caivaasi#118;
   snFilBa   = #caivaasi#119;
   eaABanco  = #caivaasi#161;
   eaCP347   = #caivaasi#164;
   eaTEmbargo = #caivaasi#165;
   enCEmbargo = #caivaasi#166;
   eaObClPr   = #caivaasi#186;

   aSepSer   = #caivaasi#97;
   aNumIzq   = #caivaasi#98;

   eaIntBN   = #caivaasi#110;
   snFiMod   = #caivaasi#111;
   snSeMod   = #caivaasi#112;
   aElCero   = #caivaasi#115;
   eaMulDep  = #caivaasi#132; ||nuevo multi-departamento
   eaDesgDef = #caivaasi#154;
   eaSobreEs = #caivaasi#155;
   eaDscomer9 = #caivaasi#191;

   |SI dCoPag = "S"; dCoPag = "P"; |FINSI;

   |SI aTipoIVA = "R"; |O aTipoIVA = "S";
       efFechaIVA = ~; enLineaIVA = 0;
       enPorcIVA = 0;  enPorcREC = 0;
       |HAZ BuscaTipoIVA;
       enNumExe = enLineaIVA;
   |FINSI;
|FPRC;

||----------------------------------------------------
|PROCESO ActLibro;
  |HAZ UltimRegistro;
  |SI factura > NumFactura;
      NumFactura = factura;   ||hay registros mas altos en mantenimiento
  |FINSI;

  |ABRE #calibros;
  #calibros#0 = enLibIVA;
  |LEE 101#calibros.=;
  |SI FSalida ! 0;
      |DDEFECTO #calibros;
      #calibros#0 = enLibIVA;
      #calibros#2 = aTipoIVA;
      |GRABA 020#calibros.b;
  |FINSI;

  #calibros#4 = NumFactura + #calibros#3;
  |GRABA 020#calibros.a;
  |LIBERA #calibros;
  |CIERRA #calibros;
|FPRC;

|PROCESO ActSerie;
  |HAZ UltimRegistro;
  |SI factura > NumFactura;
      NumFactura = factura;   ||hay registros mas altos en mantenimiento
  |FINSI;
  |ABRE #caivases;
  #caivases#0 = Serie;
  #caivases#1 = aTipoIVA;
  |LEE 101#caivases.=;
  |SI FSalida ! 0;
     |DDEFECTO #caivases;
     #caivases#0 = Serie;
     #caivases#1 = aTipoIVA;
     |GRABA 020#caivases.b;
  |FINSI;
  #caivases#3 = NumFactura + #caivases#4;
  |GRABA 020#caivases.a;
  |LIBERA #caivases;
  |CIERRA #caivases;
|FPRC;

|PROCESO MiraUltim1;
  |SI sw = 0;
      sw = 1;
      Serie = #cainliva#26;
  |FINSI;
  |SI enQSerie = 1;
      |SI Serie ! #cainliva#26;    || Ha Cambiado de serie
          |HAZ ActSerie;
          Serie = #cainliva#26;
          NumFactura = 0;
      |FINSI;
  |FINSI;
  |SI NumFactura < #cainliva#2;
      NumFactura = #cainliva#2;
  |FINSI;
|FPRC;

|DEFBUCLE MiraUltim;
 #cainliva#2;
 ;
 enLibIVA, "  ", 000001, 01;
 enLibIVA, "zz", 999999, 99;
 ;
 NULL,MiraUltim1;
|FIN;

|PROCESO PongoNumero;
  |DBASE aAlfa1; |QBF aAlfa1;
  aAlfa2 = aAlfa1 + "def/camaniva.mas";
  |CARGA_DEF aAlfa2, camaniv@;
  |SI FSalida ! 0; |ACABA; |FINSI;

   Serie      = "";
   sw         = 0;
   NumFactura = 0
   |BUCLE MiraUltim;
   |SI sw = 1;      || hay alguno
      |SI enQSerie = 1;
          |HAZ ActSerie;
      |SINO;
          |HAZ ActLibro;
      |FINSI;
   |FINSI;
   |DESCARGA_DEF #camaniv@;
|FPRC;

|PROCESO UltimRegistro;
 factura = 0;
 suma    = 1;
 |ABRE #camaniv@;
 |SELECT #3#camaniv@;
 #camaniv@#0 = enLibIVA;
 #camaniv@#2 = Serie;
 #camaniv@#3 = 999999;
 |LEE 040#camaniv@.];
 |SI FSalida ! 0;
    |LEE 040#camaniv@.u;
    |SI FSalida = 0;
        |SI #camaniv@#0 = enLibIVA;
            |SI enQSerie = 0;
                factura = #camaniv@#3;
                suma    = #camaniv@#38;
            |SINO;
                |SI #camaniv@#2 = Serie;
                    factura = #camaniv@#3;
                    suma    = #camaniv@#38;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
 |SINO;
    |LEE 040#camaniv@.a;
    |SI FSalida = 0;
        |SI #camaniv@#0 = enLibIVA;
            |SI enQSerie = 0;
                factura = #camaniv@#3;
                suma    = #camaniv@#38;
            |SINO;
                |SI #camaniv@#2 = Serie;
                    factura = #camaniv@#3;
                    suma    = #camaniv@#38;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
 |FINSI;
 suma = suma - 1;
 factura = factura + suma; || Suma las englobadas
 |CIERRA #camaniv@;
|FPRC;

|| ------------------------------------------------------------------
|PROCESO UltCamaasiv0;
  |SI NumFactura < #camaasiv#0;
      NumFactura = #camaasiv#0;
  |FINSI;
|FPRC;

|DEFBUCLE UltCamaasiv;
 #camaasiv#1;
 1,3;
 " ", nDLib, aDSerie, aTipoIVA;
 "z", nHLib, aHSerie, aTipoIVA;
 ;
 NULL, UltCamaasiv0;
|FIN;

|PROCESO UltFactura10;
  |SI NumFactura < #cainliva#2;
      NumFactura = #cainliva#2;
  |FINSI;
|FPRC;

|DEFBUCLE UltFactura1;
 #cainliva#2;
 50;
 nDLib, aDSerie, 000001, 01, aTipoIVA;
 nHLib, aHSerie, 999999, 99, aTipoIVA;
 ;
 NULL, UltFactura10;
|FIN;


|PROCESO UltFactura0;
  #camaniv@#0 = #calibros#0;
  #camaniv@#2 = #caivases#0;
  #camaniv@#3 = 999999;
  |LEE 041#camaniv@.];
  |SI FSalida ! 0;
      |LEE 040#camaniv@.u;
  |SINO;
      |LEE 040#camaniv@.a;
  |FINSI;
  |SI FSalida = 0; |Y #camaniv@#0 = #calibros#0; |Y #camaniv@#2 = #caivases#0;
      |SI NumFactura < #camaniv@#3;
          NumFactura = #camaniv@#3;
      |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE UltFactura_Series;
  #caivases#1;
  ;
  "     ", aTipoIVA;
  "zzzzz", aTipoIVA;
  e;
  NULL, UltFactura0;
|FIN;

|PROCESO BEnLibro0;
 aDSerie     = "  ";
 aHSerie     = "zz";
 nDLib       = #calibros#0;
 nHLib       = #calibros#0;

 NumFactura = 1 - #calibros#3;
                                      ||  |BUCLE UltFactura;
 |ABRE #camaniv@;
 |SELECT #3#camaniv@;
 |BUCLE UltFactura_Series;
 |SELECT #1#camaniv@;
 |CIERRA #camaniv@;

 |SI aTipoIVA ! "N";  |BUCLE UltFactura1;  |FINSI;
 |SI aTipoIVA ! "N";  |BUCLE UltCamaasiv;  |FINSI;

 #calibros#4 = NumFactura + #calibros#3;
 |GRABA 020#calibros.a;
 |LIBERA #calibros;
|FPRC;

|DEFBUCLE LosLibros;
 #calibros#1;
 2;
 00, aTipoIVA;
 99, aTipoIVA;
 be;
 NULL, BEnLibro0;
|FIN;

|DEFBUCLE UltFactura_Libro;
 #calibros#1;
 2;
 00, aTipoIVA;
 99, aTipoIVA;
 e;
 NULL, UltFactura0;
|FIN;

|PROCESO BEnSerie0;
 aDSerie     = #caivases#0;
 aHSerie     = #caivases#0;
 nDLib       = 0;
 nHLib       = 99;

 NumFactura = 1- #caivases#4;

 |ABRE #camaniv@;
 |SELECT #3#camaniv@;
 |BUCLE UltFactura_Libro;
 |SELECT #1#camaniv@;
 |CIERRA #camaniv@;

 |SI aTipoIVA ! "N";  |BUCLE UltFactura1;  |FINSI;
 |SI aTipoIVA ! "N";  |BUCLE UltCamaasiv;  |FINSI;

 #caivases#3 = NumFactura + #caivases#4;
 |GRABA 020#caivases.a;
 |LIBERA #caivases;
|FPRC;

|DEFBUCLE LasSeries;
 #caivases#1;
 ;
 "     ", aTipoIVA;
 "zzzzz", aTipoIVA;
 be;
 NULL, BEnSerie0;
|FIN;

|PROCESO PongoNumFra;

 |DBASE aAlfa1; |QBF aAlfa1;
 aAlfa2 = aAlfa1 + "def/camaniva.mas";
 |CARGA_DEF aAlfa2, camaniv@;
 |SI FSalida = 0;
     |SI enQSerie = 1;
         |BUCLE LasSeries;
     |SINO;
         |BUCLE LosLibros;
     |FINSI;
     |DESCARGA_DEF #camaniv@;
 |FINSI;
|FPRC;

|| ********************************************************************

|PROCESO BuscoFra0;
 enSwAgr = 1;
 |SI sw = 1;
     enSwAgr = 2;
     |ERROR10;     ||mas de una factura
 |FINSI;
 sw = 1;
|FPRC;

|DEFBUCLE BuscoFra;
 #camaniv@#2003;
 ;
 nDIARIO, aFECHA, nDOCUMENTO;
 nDIARIO, aFECHA, nDOCUMENTO;
 ;
 NULL, BuscoFra0;
|FIN;

|PROCESO SwAgrupada;
  sw      = 0;
  enSwAgr = 0;

 |DBASE aAlfa1; |QBF aAlfa1;
 aAlfa2 = aAlfa1 + "def/camaniva.mas";
 |CARGA_DEF aAlfa2, camaniv@;
 |SI FSalida = 0;
     |SI dirfich0 ! "";
         |PATH_DAT #10 dirfich0;
     |FINSI;
     |BUCLE BuscoFra;
     |DESCARGA_DEF #camaniv@;
 |FINSI;
|FPRC;

|| -------------------------------------------------------

|PROCESO ActDefecto;

   |SI fich_alta = "";
       |DFICE fich_alta;
   |FINSI;
   aAlfa1 = fich_alta % -107;
   aAlfa1 = aAlfa1 % 106;
   aAlfa2 = aAlfa1 % 105; cod1 = aAlfa2;
   aAlfa2 = aAlfa1 % -101; cod2 = aAlfa2;

   |ABRE #30;
   #30#2 = cod1;
   #30#3 = cod2;
   |LEE 000#30=;
   |SI FSalida ! 0;
       |CIERRA #30;
       |ACABA;
   |FINSI;

   nSwGraba = 0;
   aAlfa1 = #30#30; |QBF aAlfa1;
   aAlfa2 = #30#32; |QBF aAlfa2;
   |SI aAlfa1 ! ""; |Y aAlfa2 = ""; |Y #30#24 = "S";
       enActividad = #30#30;
       eaCodDep    = #30#30;
       |HAZ Actividad;
       #30#32 = eaNombreAct;
       nSwGraba = 1;
   |FINSI;
   aAlfa1 = #30#31; |QBF aAlfa1;
   aAlfa2 = #30#33; |QBF aAlfa2;
   |SI aAlfa1 ! ""; |Y aAlfa2 = ""; |Y #30#22 ! "N";
      enConcepto  = 1;
      eaCodSubdep = #30#31;
      |HAZ SubActividad;
      #30#33 = eaNomSubdep;
      nSwGraba = 1;
   |FINSI;
   |SI nSwGraba = 1;
       |GRABA 020#30a;
   |FINSI;
   |CIERRA #30;

   |SI eswNoLab = 0;
       |PATH_DAT #cadeflab#fich_alta#;
       |ABRE #cadeflab;
       |LEE 041#cadeflab.p;
       |SI FSalida ! 0;
           |DDEFECTO #cadeflab;
           |GRABA 020#cadeflab.b;
       |FINSI;

       #cadeflab#22 = #30#30; |SI #30#24 = "N"; #cadeflab#52 = "N"; |FINSI;
       #cadeflab#23 = #30#32;
       #cadeflab#57 = #30#31; |SI #30#22 = "N"; #cadeflab#59 = "N"; |FINSI;
       #cadeflab#58 = #30#33;
       |GRABA 020#cadeflab.a;
       |LIBERA #cadeflab;
       |CIERRA #cadeflab;
   |FINSI;
   |SI eswNoIva = 0;
       |PATH_DAT #caivaasi#fich_alta#;
       |ABRE #caivaasi;
       |LEE 041#caivaasi.p;
       |SI FSalida ! 0;
           |DDEFECTO #caivaasi;
           |GRABA 020#caivaasi.b;
       |FINSI;
       #caivaasi#19 = #30#30; |SI #30#24 = "N"; #caivaasi#20 = "N"; |FINSI;
       #caivaasi#67 = #30#31; |SI #30#22 = "N"; #caivaasi#68 = "N"; |FINSI;
       |GRABA 020#caivaasi.a;
       |LIBERA #caivaasi;
       |CIERRA #caivaasi;
   |FINSI;
|FPRC;

|| ----------------------------------------------------------------
|| ----------------------------------------------------------------
|PROCESO LModAnual;
  enExiMod = 1;
  |SI #dsmom004#7 = "X"; enEmiMod = 1; |FINSI;
|FPRC;

|DEFBUCLE LModAnual;
  #dsmom004#1;
  ;
  nEmpresa, nAny, 01, nModelo, 00;
  nEmpresa, nAny, 99, nModelo, 99;
  ;
  NULL, LModAnual;
|FIN;

|PROCESO ConsulMod;
  |SI nModelo = 110;
      |HAZ OrgMod111;
      |SI #agitab99#8 ! "L"; |Y #agitab99#8 ! "S";
          |ACABA;
      |FINSI;
 |FINSI;

 |SI nPerio = -1;
     |BUCLE LModAnual;
 |SINO;
     |ABRE #dsmom004;
     #dsmom004#0 = nEmpresa;
     #dsmom004#1 = nAny
     #dsmom004#2 = nPerio;
     #dsmom004#3 = nModelo;
     #dsmom004#4 = 00;
     |LEE 041#dsmom004.];
     |SI FSalida = 0; |Y #dsmom004#0 = nEmpresa; |Y #dsmom004#1 = nAny;
        |Y #dsmom004#2 = nPerio; |Y #dsmom004#3 = nModelo;
           enExiMod = 1;
           |SI #dsmom004#7 = "X"; enEmiMod = 1; |FINSI;
     |FINSI;
     |CIERRA #dsmom004;
 |FINSI;
|FPRC;

|PROCESO GrupoMod;
  nEmpresa   = #dsmom026#0;
  |HAZ ConsulMod;
|FPRC;

|DEFBUCLE GrupoMod;
  #dsmom026#2;
  ;
  enEmpresa, 00001;
  enEmpresa, 99999;
  e;
  NULL,GrupoMod;
|FIN;
|| ///////////////////////////////////////////////////////
|PROCESO CalElPeriodo;
  |SI eaFecMod = "";
      nAny = enEjercicio;
      |SI dig1 ! 1;
          |SI enPerMod < dig1;
              nAny = enEjercicio + 1;
          |FINSI;
      |FINSI;
      nNume1 = enPerMod;
      nPerio = nNume1;
      |SI aTipPer = "T"; |Y nNume1 ! -1;
          |SI enEjercicio [ 2009;
              |SI nNume1 = 1; nPerio =  3; |FINSI;
              |SI nNume1 = 2; nPerio =  6; |FINSI;
              |SI nNume1 = 3; nPerio =  9; |FINSI;
              |SI nNume1 = 4; nPerio = 12; |FINSI;
          |SINO;
              |SI nNume1 < 4;                   nPerio = 3;  |FINSI;
              |SI nNume1 > 3;  |Y nNume1 < 7;   nPerio = 6;  |FINSI;
              |SI nNume1 > 6;  |Y nNume1 < 10;  nPerio = 9;  |FINSI;
              |SI nNume1 > 9;                   nPerio = 12; |FINSI;
          |FINSI;
      |FINSI;
      |SI aTipPer = "A"; |Y nNume1 ! -1;
           nPerio = 99;
      |FINSI;
  |SINO;
      aAlfa = eaFecMod % -104; nAny   = aAlfa;
      aAlfa = eaFecMod % 402;  nNume1 = aAlfa;
      |SI aTipPer = "A"; nPerio = 99;     |FINSI;
      |SI aTipPer = "M"; nPerio = nNume1; |FINSI;
      |SI aTipPer = "T";
          |SI nNume1 < 4;                 nPerio = 3;  |FINSI;
          |SI nNume1 > 3; |Y nNume1 < 7;  nPerio = 6;  |FINSI;
          |SI nNume1 > 6; |Y nNume1 < 10; nPerio = 9;  |FINSI;
          |SI nNume1 > 9;                 nPerio = 12; |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO ConsulPlan;
  |SI enConcepto ! 0;
      |ABRE #dsmom030;
      |DDEFECTO #dsmom030;
      #dsmom030#0 = enConcepto;
      |LEE 001#dsmom030.=;
      |CIERRA #dsmom030;
      |SI #dsmom030#38 = 0; enExiMod = 1; |ACABA; |FINSI;
  |SINO;
      #dsmom030#38 = 110;  ||Controlar Nominas
  |FINSI;

  |HAZ eActivParam;
  |SI #caivaasi#149 = " "; #caivaasi#149 = #caivaasi#46; |FINSI;

  aTipPer = #caivaasi#149; |HAZ CalElPeriodo;

  nModelo = #dsmom030#38;
  |SI #dsmom030#38 = 193; nModelo = 123; |FINSI;
  |SI #dsmom030#38 = 190; nModelo = 110; |FINSI;
  |SI #dsmom030#38 = 180; nModelo = 115; |FINSI;

  nEmpresa = enEmpresa;
  enExiMod = 0;          ||No existe
  enEmiMod = 0;          ||No Emitido
  |HAZ ConsulMod;
  |SI enExiMod = 0; |Y nModelo = 110;
      |BUCLE GrupoMod;
      |SI enExiMod = 0;
          nEmpresa = enEmpresa;
          |HAZ OrgMod111;
          |SI #agitab99#8 ! "L"; |Y #agitab99#8 ! "S";
              enExiMod = 1;
          |FINSI;
      |FINSI;
  |FINSI;
  |SI enExiMod = 0;
      |SI enPanMod = 0;
          aAlfa1 = nModelo;
          aAlfa2 = "    AVISO";
          |SI #caivaasi#112 = "N"; aAlfa2 = "    ERROR"; |FINSI;
          |SI nPerio = -1;
              aAlfa  = aAlfa2 + ". No Existe el Modelo " + aAlfa1 + " del A¤o ";
          |SINO;
              aAlfa  = aAlfa2 + ". No Existe el Modelo " + aAlfa1 + " del A¤o y Periodo introducidos";
          |FINSI;
          |MENAV aAlfa;
      |FINSI;
  |FINSI;
|FPRC;

|| ... En los Registros De IVA
|PROCESO ConsulModIVA;
  eaErrorMod  = "";
  enPerSCAN   = 0;
  |HAZ eActivParam;

  nEmpresa = enEmpresa;
  enExiMod = 0;          ||No existe
  enEmiMod = 0;          ||No Emitido

  |SI eSwReten ! 2; |Y enSi303 = 1;
      aTipPer = #caivaasi#46; |HAZ CalElPeriodo;
      nModelo = 303; |HAZ ConsulMod;
      |SI enEmiMod = 0; nModelo = 322; |HAZ ConsulMod; |FINSI;
      |SI enEmiMod = 0; nModelo = 353; |HAZ ConsulMod; |FINSI;
      |SI enEmiMod = 0; nModelo = 310; |HAZ ConsulMod; |FINSI;
      |SI enEmiMod = 0; nModelo = 370; |HAZ ConsulMod; |FINSI;
  |FINSI;

  |SI eSwReten ! 0; |Y enSi111 = 1;

      aTipPer = #caivaasi#149; |HAZ CalElPeriodo;
      |DDEFECTO #dsmom030;
      |SI enConIRPF ! 0;
          |ABRE #dsmom030;
          #dsmom030#0 = enConIRPF;
          |LEE 001#dsmom030.=;
          |CIERRA #dsmom030;
      |FINSI;
      |SI #dsmom030#38 = 190; |O enConIRPF = 0;
          nModelo = 110; |HAZ ConsulMod;
          |SI enEmiMod = 0; |BUCLE GrupoMod; |FINSI;
      |FINSI;
      |SI #dsmom030#38 = 180; |O enConIRPF = 0;
          |SI enEmiMod = 0; nModelo = 115; |HAZ ConsulMod; |FINSI;
      |FINSI;
      |SI #dsmom030#38 = 193; |O enConIRPF = 0;
          |SI enEmiMod = 0; nModelo = 123; |HAZ ConsulMod; |FINSI;
      |FINSI;
  |FINSI;

  |SI enEmiMod = 1;
      |SI enPanMod = 0;
          aAlfa1 = nModelo;
          |SI #caivaasi#167 = "S"; aAlfa2 = "    Hay modelos elaborados del periodo. Reviselos."; |FINSI;
          |SI #caivaasi#167 = "N"; aAlfa2 = "    Hay modelos elaborados del periodo. Reviselos. No se puede modificar"; |FINSI;
          |SI #caivaasi#167 = "P"; aAlfa2 = "    Hay modelos elaborados del periodo. Reviselos. Modifique solo contrapartida"; |FINSI;

          eaErrorMod = aAlfa2;
          |SI enMensaMod = 0;
              |MENAV aAlfa2;
          |FINSI;
      |FINSI;
  |FINSI;

  enPerSCAN = nPerio;
|FPRC;

|| ... Proceso para saber si existe en el Planing los modelos
|| ...   enSi303, enSi111 y enSi349
|PROCESO OrgMod111;
     |ABRE #agitab99;
     |DDEFECTO #agitab99;
     #agitab99#0 = 110;
     |LEE 040#agitab99.=;
     |CIERRA #agitab99;

     |ABRE #dsmom006;
     #dsmom006#0 = nEmpresa;
     #dsmom006#1 = 110;
     |LEE 041#dsmom006.=;
     |SI FSalida = 0;
         |SI #dsmom006#13 ! " "; |Y #dsmom006#13 ! "X";
             #agitab99#8 = #dsmom006#13;  ||Pase Modelo 110 particular de esta Empresa
         |FINSI;
     |FINSI;
     |CIERRA #dsmom006;
|FPRC;

|PROCESO Mirom002;
  |SI #dsmom002#8 > "01.01.1900";
      |SI #dsmom002#8 > fec2;  |ACABA;  |FINSI;
  |FINSI;
  |SI #dsmom002#9 > "01.01.1900";
      |SI #dsmom002#9 < fec1;  |ACABA;  |FINSI;
  |FINSI;

  |SI #dsmom002#2 = 110;
      |HAZ OrgMod111;
      |SI #agitab99#8 = "L"; |O #agitab99#8 = "S";
          enSi111 = 1;
      |FINSI;
  |FINSI;

  |SI nSwGrupo = 1; |ACABA; |FINSI;

  |SI #dsmom002#2 = 115; |O #dsmom002#2 = 123;
      enSi111 = 1;
  |FINSI;

  aAlfa = "";
  |SI enEjercicio [ 2008;
     |SI #dsmom002#2 = 300; |O #dsmom002#2 = 320; |O #dsmom002#2 = 330; |O #dsmom002#2 = 332;
         aAlfa = #dsmom002#7;
     |FINSI;
  |SINO;
     |SI #dsmom002#2 = 303; |O #dsmom002#2 = 340; |O #dsmom002#2 = 322; |O #dsmom002#2 = 353;
         aAlfa = #dsmom002#7;
     |FINSI;
     |SI #dsmom002#2 = 340;
         |SI #dsmom002#9 > "01.01.0000";
             aAlfa1    = #dsmom002#9; aAlfa1 = aAlfa1 % 402;
             enBaja340 = aAlfa1;
             aAlfa1    = #dsmom002#9; aAlfa1 = aAlfa1 % -104;
             enBajE340 = aAlfa1;
         |FINSI;
         enSi340   = 1;
         |SI enEjercicio > 2017; enSi340 = 0; |FINSI;
     |FINSI;
     |SI #dsmom002#2 = 303; enSi303 = 1; |FINSI;
     |SI #dsmom002#2 = 322; enSi303 = 1; |FINSI;
     |SI #dsmom002#2 = 353; enSi303 = 1; |FINSI;
  |FINSI;
  |SI #dsmom002#2 = 310; |O #dsmom002#2 = 311; enSi303 = 1; aAlfa = #dsmom002#7; |FINSI;
  |SI #dsmom002#2 = 370;                       enSi303 = 1; aAlfa = #dsmom002#7; |FINSI;
  |SI aAlfa ! "";
      aTPerio = aAlfa % 101;
      |SI aTPerio ! #caivaasi#46;  nDif = 1; |FINSI;
      |SI aMPerio = ""; aMPerio = aTPerio; |FINSI;
      |SI aTPerio ! aMPerio;       nDif = 2; |FINSI;
  |FINSI;

  |SI #dsmom002#2 = 349;
       eaPer349 = #dsmom002#7;
       eaPer349 = eaPer349 % 101;
  |FINSI;
|FPRC;

|DEFBUCLE Mirom002;
  #dsmom002#1;
  ;
  nEmpresa, 01, 110;
  nEmpresa, 99, 370;
  ;
  NULL, Mirom002;
|FIN;

|PROCESO Grupo111;
  nSwGrupo   = 1;
  nEmpresa   = #dsmom026#0;
  |BUCLE Mirom002;
  |SI enSi111 = 1;
      |ERROR10;
  |FINSI;
|FPRC;

|DEFBUCLE Grupo111;
  #dsmom026#2;
  ;
  enEmpresa, 00001;
  enEmpresa, 99999;
  e;
  NULL,Grupo111;
|FIN;

|PROCESO Consul303;
  enBaja340 = 0;
  enSi340   = 0;
  enSi111   = 0;
  enSi303   = 0;
  enExiMod  = 0;
  eaPer349  = " ";

  |HAZ eActivParam;

  aMPerio  = "";
  aTPerio  = "";
  nDif     = 0;
  nSwGrupo = 0;
  nEmpresa = enEmpresa;
  |BUCLE Mirom002;
  |SI enM349 = 0;
      |SI nDif = 1;
          |CONFI "1234SPeriodicidad diferente la informada en el Control a la del Modelo de IVA. Cambiarla ";
          |SI FSalida = 0;
              |ABRE #caivaasi;
              |DDEFECTO #caivaasi;
              |LEE 001#caivaasi.p;
              |SI FSalida = 0;
                  #caivaasi#46 = aTPerio;
                  |GRABA 020#caivaasi.a;
              |FINSI;
              |CIERRA #caivaasi;
          |FINSI;
      |FINSI;
      |SI nDif = 2;
          |MENAV "    Existe diferencia en la Periodicidad de los Modelos de IVA. Reviselos";
      |FINSI;
  |FINSI;

  |SI eaPer349 = " "; eaPer349 = #caivaasi#46; |FINSI;

  |SI enSi111 = 0; |BUCLE Grupo111; |FINSI;
|FPRC;
