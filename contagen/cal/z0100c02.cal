|FICHEROS;
     gadz0100;
     gadm0003;

     :dsarchi/dpntm100;
     :dsarchi/dpntm101;
     :dsarchi/dsarw114;
|FIN;

|INCLUYE z0100var;

|PROCESO LeePLA;
     eaOri = eaPathLocalDK + "/PLACO000.ASC";
     eaDes = eaPathServiDK + "PLACO000.ASC";
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO eaOri, eaDes;
     |SINO;
          |COPIA_FICHERO eaOri, eaDes;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     |XABRE "B", eaDes, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 197, aLee1;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |XLEE nHandle, 87, aLee2;

          enNumPla = enNumPla + 1;
     |SIGUE;
     |XCIERRA nHandle;
|FPRC;

|PROCESO LeeAPU;
     eaOri = eaPathLocalDK + "/APUNT000.ASC";
     eaDes = eaPathServiDK + "APUNT000.ASC";
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO eaOri, eaDes;
     |SINO;
          |COPIA_FICHERO eaOri, eaDes;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     |XABRE "", eaDes, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 250, aLee1;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          enNumApu = enNumApu + 1;
     |SIGUE;
     |XCIERRA nHandle;
|FPRC;

|PROCESO DKEmitidas;
     |SI enLeeIVA100 = 1;  |ACABA;  |FINSI;

     |LEE 000#dpntm100.u;
     |SI FSalida ! 0;  #dpntm100#0 = 0;  |FINSI;
     enReg = #dpntm100#0 + 1;

     enNumEmi = enNumEmi + 1;

     |DDEFECTO #dpntm100;

     aFac = aLee2 % 110;

     #dpntm100#0  = enReg;
     #dpntm100#1  = #48#30;
     #dpntm100#2  = aLee1 % 20315;
     #dpntm100#4  = aLee1 % 1340;
     #dpntm100#5  = aLee2 % 14102;
     #dpntm100#6  = "1";
     #dpntm100#7  = "NIF";
     #dpntm100#8  = "";
     #dpntm100#49 = "Operaci¢n habitual";
     #dpntm100#9  = 1;
     #dpntm100#10 = 0;
     #dpntm100#11 = "";
     #dpntm100#12 = "";

     aAlfa = aLee1 % 23008;
     aAlfa = (aAlfa % 102) + "." + (aAlfa % 302) + "." + (aAlfa % 504);

     #dpntm100#15 = aAlfa;

     aAlfa  = aLee2 % 1312;   nBas1 = aAlfa / 100;
     aAlfa  = aLee2 % 2502;   nIVA1 = aAlfa;
     aAlfa  = aLee2 % 2712;   nCuI1 = aAlfa / 100;
     aAlfa  = aLee2 % 3902;   nREC1 = aAlfa / 10;
     aAlfa  = aLee2 % 4110;   nCuR1 = aAlfa / 100;

     aAlfa  = aLee2 % 5112;   nBas2 = aAlfa / 100;
     aAlfa  = aLee2 % 6302;   nIVA2 = aAlfa;
     aAlfa  = aLee2 % 6512;   nCuI2 = aAlfa / 100;
     aAlfa  = aLee2 % 7702;   nREC2 = aAlfa / 10;
     aAlfa  = aLee2 % 7910;   nCuR2 = aAlfa / 100;

     aAlfa  = aLee2 %  8912;  nBas3 = aAlfa / 100;
     aAlfa  = aLee2 % 10102;  nIVA3 = aAlfa;
     aAlfa  = aLee2 % 10312;  nCuI3 = aAlfa / 100;
     aAlfa  = aLee2 % 11502;  nREC3 = aAlfa / 10;
     aAlfa  = aLee2 % 11710;  nCuR3 = aAlfa / 100;

     aAlfa  = aLee2 % 12702;  nRET  = aAlfa;
     aAlfa  = aLee2 % 12912;  nCuT  = aAlfa;

     enContIva = 0;
     enTBas    = nBas1 + nBas2 + nBas3;
     enTCuI    = nCuI1 + nCuI2 + nCuI3;
     enTCuR    = nCuR1 + nCuR2 + nCuR3;

     enTRet    = 0;
     enRet     = 0;
     enDRet    = 0;
     enLin1    = 0;
     enLin2    = 0;
     enLin3    = 0;
     enLin4    = 0;
     enLin5    = 0;

     |SI nCuT ! 0;
         enTRet = nCuT;
         enRet  = (enTRet * 100) / enTBas;
         eaSobre   = "B";
     |FINSI;

     |SI nBas1 ! 0;
         enBas  = nBas1;
         enIva  = nIVA1;
         enCuI  = nCuI1;
         enRec  = nREC1;
         enCuR  = nCuR1;
         enTIVA = 1;

         |HAZ GrabaBloque100;
     |FINSI;

     |SI nBas2 ! 0;
         enBas  = nBas2;
         enIva  = nIVA2;
         enCuI  = nCuI2;
         enRec  = nREC2;
         enCuR  = nCuR2;
         enTIVA = 2;
         |HAZ GrabaBloque100;
     |FINSI;

     |SI nBas3 ! 0;
         enBas  = nBas3;
         enIva  = nIVA3;
         enCuI  = nCuI3;
         enRec  = nREC3;
         enCuR  = nCuR3;
         enTIVA = 3;
         |HAZ GrabaBloque100;
     |FINSI;

     nDif = enDRet - enTRet;
     |SI nDif ! 0;
         #dpntm100#27 = #dpntm100#27 + nDif;
     |FINSI;

     #dpntm100#28 = enTBas + enTCuI + enTCuR - enTRet;
     #dpntm100#51 = aLee1 % 8330;
     aAlfa        = aLee1 % 14305; |QBF aAlfa; aAlfa = ("00000" + aAlfa) % -105;
     #dpntm100#52 = aAlfa;
     #dpntm100#53 = aLee1 % 11330;
     #dpntm100#54 = aLee1 % 16820;
     #dpntm100#55 = aLee1 % 18815;
     #dpntm100#44 = "S";
     #dpntm100#76 = #gadz0100#1;
     #dpntm100#77 = #gadz0100#1;
     #dpntm100#78 = "";
     #dpntm100#79 = 0;

     |SI enTBas ] 0;
         #dpntm100#13 = aFac;
     |FINSI;

     |SI enTBas < 0;
         #dpntm100#14 = aFac;
     |FINSI;

     |GRABA 020#dpntm100.n;
     |LIBERA #dpntm100;

     |PARA nCampo = 0;  |SI nCampo [ 79;  |HACIENDO nCampo = nCampo + 1;
           #dsarw114#nCampo# = #dpntm100#nCampo#;
     |SIGUE;

     |SI #dpntm100#30 ! 0;  |O #dpntm100#37 ! 0; |O #dpntm100#57 ! 0; |O #dpntm100#64 ! 0;
         enRegPrimerIVA = #dpntm100#0;
         |HAZ RestoBases100;
     |FINSI;
|FPRC;

|PROCESO DKRecibidas;
     |SI enLeeIVA101 = 1;  |ACABA;  |FINSI;

     |LEE 000#dpntm101.u;
     |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
     enReg = #dpntm101#0 + 1;

     enNumRec = enNumRec + 1;

     |DDEFECTO #dpntm101;

     aFac = aLee2 % 110;

     #dpntm101#0  = enReg;
     #dpntm101#1  = #48#30;
     #dpntm101#2  = aLee1 % 20315;
     #dpntm101#4  = aLee1 % 1340;
     #dpntm101#5  = aLee2 % 14102;
     #dpntm101#6  = "1";
     #dpntm101#7  = "NIF";
     #dpntm101#8  = "";
     #dpntm101#49 = "Operaci¢n habitual";
     #dpntm101#9  = 1;
     #dpntm101#10 = 0;
     #dpntm101#11 = "";
     #dpntm101#12 = "";

     aAlfa = aLee1 % 23008;
     aAlfa = (aAlfa % 102) + "." + (aAlfa % 302) + "." + (aAlfa % 504);

     #dpntm101#15 = aAlfa;

     aAlfa  = aLee2 % 1312;   nBas1 = aAlfa / 100;
     aAlfa  = aLee2 % 2502;   nIVA1 = aAlfa;
     aAlfa  = aLee2 % 2712;   nCuI1 = aAlfa / 100;
     aAlfa  = aLee2 % 3902;   nREC1 = aAlfa / 10;
     aAlfa  = aLee2 % 4110;   nCuR1 = aAlfa / 100;

     aAlfa  = aLee2 % 5112;   nBas2 = aAlfa / 100;
     aAlfa  = aLee2 % 6302;   nIVA2 = aAlfa;
     aAlfa  = aLee2 % 6512;   nCuI2 = aAlfa / 100;
     aAlfa  = aLee2 % 7702;   nREC2 = aAlfa / 10;
     aAlfa  = aLee2 % 7910;   nCuR2 = aAlfa / 100;

     aAlfa  = aLee2 %  8912;  nBas3 = aAlfa / 100;
     aAlfa  = aLee2 % 10102;  nIVA3 = aAlfa;
     aAlfa  = aLee2 % 10312;  nCuI3 = aAlfa / 100;
     aAlfa  = aLee2 % 11502;  nREC3 = aAlfa / 10;
     aAlfa  = aLee2 % 11710;  nCuR3 = aAlfa / 100;

     aAlfa  = aLee2 % 12702;  nRET  = aAlfa;
     aAlfa  = aLee2 % 12912;  nCuT  = aAlfa;

     enContIva = 0;
     enTBas    = nBas1 + nBas2 + nBas3;
     enTCuI    = nCuI1 + nCuI2 + nCuI3;
     enTCuR    = nCuR1 + nCuR2 + nCuR3;

     enTRet    = 0;
     enRet     = 0;
     enDRet    = 0;
     enLin1    = 0;
     enLin2    = 0;
     enLin3    = 0;
     enLin4    = 0;
     enLin5    = 0;

     |SI nCuT ! 0;
         enTRet = nCuT;
         enRet  = (enTRet * 100) / enTBas;
         eaSobre   = "B";
     |FINSI;

     |SI nBas1 ! 0;
         enBas  = nBas1;
         enIva  = nIVA1;
         enCuI  = nCuI1;
         enRec  = nREC1;
         enCuR  = nCuR1;
         enTIVA = 1;

         |HAZ GrabaBloque101;
     |FINSI;

     |SI nBas2 ! 0;
         enBas  = nBas2;
         enIva  = nIVA2;
         enCuI  = nCuI2;
         enRec  = nREC2;
         enCuR  = nCuR2;
         enTIVA = 2;
         |HAZ GrabaBloque101;
     |FINSI;

     |SI nBas3 ! 0;
         enBas  = nBas3;
         enIva  = nIVA3;
         enCuI  = nCuI3;
         enRec  = nREC3;
         enCuR  = nCuR3;
         enTIVA = 3;
         |HAZ GrabaBloque101;
     |FINSI;

     nDif = enDRet - enTRet;
     |SI nDif ! 0;
         #dpntm101#27 = #dpntm101#27 + nDif;
     |FINSI;

     #dpntm101#28 = enTBas + enTCuI + enTCuR - enTRet;
     #dpntm101#51 = aLee1 % 8330;
     aAlfa        = aLee1 % 14305; |QBF aAlfa; aAlfa = ("00000" + aAlfa) % -105;
     #dpntm101#52 = aAlfa;
     #dpntm101#53 = aLee1 % 11330;
     #dpntm101#54 = aLee1 % 16820;
     #dpntm101#55 = aLee1 % 18815;
     #dpntm101#44 = "S";
     #dpntm101#76 = #gadz0100#1;
     #dpntm101#77 = #gadz0100#1;
     #dpntm101#78 = "";
     #dpntm101#79 = 0;

     |SI enTBas ] 0;
         #dpntm101#13 = aFac;
     |FINSI;

     |SI enTBas < 0;
         #dpntm101#14 = aFac;
     |FINSI;

     |GRABA 020#dpntm101.n;
     |LIBERA #dpntm101;

     |PARA nCampo = 0;  |SI nCampo [ 79;  |HACIENDO nCampo = nCampo + 1;
           #dsarw114#nCampo# = #dpntm101#nCampo#;
     |SIGUE;

     |SI #dpntm101#30 ! 0;  |O #dpntm101#37 ! 0; |O #dpntm101#57 ! 0; |O #dpntm101#64 ! 0;
         enRegPrimerIVA = #dpntm101#0;
         |HAZ RestoBases101;
     |FINSI;
|FPRC;

|PROCESO CargaDK;
     aTipo = aLee2 % 1201;

     |SI aTipo = "R";  |HAZ DKEmitidas;    |FINSI;
     |SI aTipo = "S";  |HAZ DKRecibidas;   |FINSI;
|FPRC;

|PROCESO LeeIVA;
     eaOri = eaPathLocalDK + "/LBIVA000.ASC";
     eaDes = eaPathServiDK + "LBIVA000.ASC";
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO eaOri, eaDes;
     |SINO;
          |COPIA_FICHERO eaOri, eaDes;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     |DFICE eaPathDPNTM;

     |PATH_DAT #dpntm100#eaPathDPNTM#;
     |PATH_DAT #dpntm101#eaPathDPNTM#;

     |ABRE #dpntm100;  |CIERRA #dpntm100;  |DELINDEX #dpntm100;
     |ABRE #dpntm101;  |CIERRA #dpntm101;  |DELINDEX #dpntm101;
     |ABRE #gadm0003;  |CIERRA #gadm0003;  |DELINDEX #gadm0003;

     |ABRE #dpntm100;
     |ABRE #dpntm101;

     |XABRE "B", eaDes, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 245, aLee1;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |XLEE nHandle, 144, aLee2;

          |HAZ CargaDK;
     |SIGUE;
     |XCIERRA nHandle;

     |CIERRA #dpntm100;
     |CIERRA #dpntm101;
|FPRC;

|PROCESO LeeCOB;
     eaOri = eaPathLocalDK + "/PREVI000.ASC";
     eaDes = eaPathServiDK + "PREVI000.ASC";
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO eaOri, eaDes;
     |SINO;
          |COPIA_FICHERO eaOri, eaDes;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     |XABRE "", eaDes, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 250, aLee1;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          enNumCob = enNumCob + 1;
     |SIGUE;
     |XCIERRA nHandle;
|FPRC;

|PROCESO RecogeDistrito;
     eaPathLocalDK = #gadz0100#6;  |QBF eaPathLocalDK;
     |SI eaPathLocalDK = "";  |ACABA;  |FINSI;

     |DBASE aBase;
     eaPathServiDK = aBase + "tmp";              |MKDIR eaPathServiDK;
     eaPathServiDK = aBase + "tmp/" + Usuario;   |MKDIR eaPathServiDK;
     eaPathServiDK = aBase + "tmp/" + Usuario + "/";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |HAZ LeePLA;
     |HAZ LeeAPU;
     |HAZ LeeIVA;
     |HAZ LeeCOB;
|FPRC;
