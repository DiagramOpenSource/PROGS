|FICHEROS;
   comz0003 #0;

   caenlace #10;
   caconasi #11;

   :/modelos/def/dsmom030 #100;
|FIN;

|VARIABLES;
   aAlfa    = "";
   aReg     = "";

   aNomFic  = "";
   aOrigen  = "";
   aDestino = "";
   aIP      = "";
   aSerie   = "";
   aCuenta  = "";
   aDescAsto = "";

   nHandle    = 0;
   nCalc      = 0;
   nImporte   = 0;
   nTienda    = 0;
   nFormaPago = 0;
   nLibro     = 0;

   nSwTipo    = 0;
   aLong      = "";
   nLong      = 0;
   nNivel     = 0;
|FIN;

|PROCESO Contador;
     |ABRE #caconasi;
     |LEE 101#caconasi.p;
     |SI FSalida ! 0;
         |DDEFECTO #caconasi;
         |GRABA 020#caconasi.n;
         |LEE 101#caconasi.p;
     |FINSI;
         #caconasi#1 = #caconasi#1 + 1;
     |GRABA 020#caconasi.a;
     |LIBERA #caconasi;
     |CIERRA #caconasi;
|FPRC;

|PROCESO MiraFichero;
   aAlfa = #comz0003#0; |QBF aAlfa;
   |SI aAlfa = "";
      aAlfa = "F";
      |BROWSE aAlfa; |QBF aAlfa; aAlfa = aAlfa % 0299;

      #comz0003#0 = aAlfa; |PINTA #comz0003#0;
      |ERROR; |ACABA;
   |FINSI;

   |XABRE "CE", aAlfa, nHandle;
   |SI FSalida < 0;
      |MENAV "    Fichero inexistente"; |ERROR;
   |FINSI;
|FPRC;

|PROCESO BuscaNivel;
   aLong = aAlfa % 0; nLong = aLong;
   nNivel = 0;
   |SI nLong > 0;
      |SI nLong = #48#14; nNivel = 1; |FINSI;
      |SI nLong = #48#15; nNivel = 2; |FINSI;
      |SI nLong = #48#16; nNivel = 3; |FINSI;
      |SI nLong = #48#17; nNivel = 4; |FINSI;
      |SI nLong = #48#18; nNivel = 5; |FINSI;
      |SI nLong = #48#19; nNivel = 6; |FINSI;
   |FINSI;
|FPRC;

|PROCESO TomaDatos;
   |SI nSwTipo = 0; || Cuenta de cliente
      |SI nFormaPago = 0;
         |SI nTienda = 1; aCuenta = "5700000050"; |FINSI; ||San Juan
         |SI nTienda = 2; aCuenta = "5700000054"; |FINSI; ||San Vicente
         |SI nTienda = 3; aCuenta = "5700000051"; |FINSI; ||Ibi
         |SI nTienda = 4; aCuenta = "5700000053"; |FINSI; ||Alcoy Beniat
         |SI nTienda = 5; aCuenta = "5700000052"; |FINSI; ||Alcoy Centro
      |FINSI;
      |SI nFormaPago = 1; aCuenta = "5720000052"; |FINSI;
      |SI nFormaPago = 2; aCuenta = "5720000054"; |FINSI;
   |FINSI;
   |SI nSwTipo = 1; || Cuenta de IVA
      |SI nTienda = 1;  aCuenta = "4770000050"; |FINSI; ||San Juan
      |SI nTienda = 2;  aCuenta = "4770000054"; |FINSI; ||San Vicente
      |SI nTienda = 3;  aCuenta = "4770000051"; |FINSI; ||Ibi
      |SI nTienda = 4;  aCuenta = "4770000053"; |FINSI; ||Alcoy Beniat
      |SI nTienda = 5;  aCuenta = "4770000052"; |FINSI; ||Alcoy Centro
   |FINSI;
   |SI nSwTipo = 2; || Cuenta de ventas
      |SI nTienda = 1;  aCuenta = "7000000050"; |FINSI; ||San Juan
      |SI nTienda = 2;  aCuenta = "7000000054"; |FINSI; ||San Vicente
      |SI nTienda = 3;  aCuenta = "7000000051"; |FINSI; ||Ibi
      |SI nTienda = 4;  aCuenta = "7000000053"; |FINSI; ||Alcoy Beniat
      |SI nTienda = 5;  aCuenta = "7000000052"; |FINSI; ||Alcoy Centro
   |FINSI;
   |SI nSwTipo = 3; || Libro de iva y Serie de iva
      |SI nTienda = 1;  nLibro = 80; aSerie = "50"; |FINSI; ||San Juan
      |SI nTienda = 2;  nLibro = 84; aSerie = "54"; |FINSI; ||San Vicente
      |SI nTienda = 3;  nLibro = 81; aSerie = "51"; |FINSI; ||Ibi
      |SI nTienda = 4;  nLibro = 83; aSerie = "53"; |FINSI; ||Alcoy Beniat
      |SI nTienda = 5;  nLibro = 82; aSerie = "52"; |FINSI; ||Alcoy Centro
   |FINSI;
   |HAZ BuscaNivel;
|FPRC;

|PROCESO Importa;
   |HAZ Contador;

   #dsmom030#0 = 702;
   |LEE 000#dsmom030.=;
   |SI FSalida ! 0; |DDEFECTO #dsmom030; |FINSI;

   aAlfa = aReg % 0703; nTienda = aAlfa;
   aAlfa = aReg % 1001; nFormaPago = aAlfa;

   aAlfa = "Tiquet ";
   |SI nTienda = 1; aAlfa = aAlfa + "SJ:(";  |FINSI;
   |SI nTienda = 2; aAlfa = aAlfa + "SV:(";  |FINSI;
   |SI nTienda = 3; aAlfa = aAlfa + "IBI:("; |FINSI;
   |SI nTienda = 4; aAlfa = aAlfa + "ALB:("; |FINSI;
   |SI nTienda = 5; aAlfa = aAlfa + "ALC:("; |FINSI;
   aDescAsto = aAlfa + (aReg % 0106) + ")";

   |DDEFECTO #caenlace;
   #caenlace#0 = #comz0003#3;
   aAlfa = aReg % 2110;
   aAlfa = (aAlfa % 0102) + "." + (aAlfa % 0402) + "." + (aAlfa % 0704);
   #caenlace#1  = aAlfa;
   #caenlace#2  = #caconasi#1;
   #caenlace#3  = 10;
   nSwTipo = 0; |HAZ TomaDatos;
   #caenlace#4  = aCuenta;
   #caenlace#5  = nNivel;
   #caenlace#6  = 702;
   #caenlace#7  = aDescAsto;
   #caenlace#8  = "D";
   aAlfa = aReg % 1110; nImporte = aAlfa; nImporte = (nImporte / 100) ! 2;
   #caenlace#9  = nImporte;
   #caenlace#10 = "R";
   nSwTipo = 3; |HAZ TomaDatos;
   #caenlace#11 = nLibro;
   #caenlace#12 = aSerie;
   aAlfa = aReg % 0106; nCalc = aAlfa;
   #caenlace#13 = nCalc;
   #caenlace#26 = "F";
   #caenlace#27 = 0;
   #caenlace#28 = 0;
   #caenlace#29 = #caenlace#1;
   #caenlace#30 = "N";
   #caenlace#31 = "S";
   #caenlace#32 = "N";
   #caenlace#33 = 0;
   #caenlace#37 = #48#2;
   #caenlace#38 = #48#3;
   #caenlace#48 = "J";
   |GRABA 020#caenlace.n;

   |DDEFECTO #caenlace;
   #caenlace#0 = #comz0003#3;
   aAlfa = aReg % 2110;
   aAlfa = (aAlfa % 0102) + "." + (aAlfa % 0402) + "." + (aAlfa % 0704);
   #caenlace#1  = aAlfa;
   #caenlace#2  = #caconasi#1;
   #caenlace#3  = 20;
   nSwTipo = 1; |HAZ TomaDatos;
   #caenlace#4  = aCuenta;
   #caenlace#5  = nNivel;
   #caenlace#6  = 702;
   #caenlace#7  = aDescAsto;
   #caenlace#8  = "H";
   nCalc = 1 + ((#comz0003#4 / 100) ! 2);
   nCalc = nImporte - ((nImporte / nCalc) ! 2);
   #caenlace#9  = nCalc;
   #caenlace#10 = "R";
   #caenlace#11 = nLibro;
   #caenlace#12 = aSerie;
   aAlfa = aReg % 0106; nCalc = aAlfa;
   #caenlace#13 = nCalc;
   #caenlace#26 = "I";
   #caenlace#27 = 0;
   #caenlace#28 = 0;
   #caenlace#29 = #caenlace#1;
   #caenlace#30 = "N";
   #caenlace#31 = "S";
   #caenlace#32 = "N";
   #caenlace#33 = 0;
   #caenlace#37 = #48#2;
   #caenlace#38 = #48#3;
   #caenlace#48 = "J";
   |GRABA 020#caenlace.n;

   |DDEFECTO #caenlace;
   #caenlace#0 = #comz0003#3;
   aAlfa = aReg % 2110;
   aAlfa = (aAlfa % 0102) + "." + (aAlfa % 0402) + "." + (aAlfa % 0704);
   #caenlace#1  = aAlfa;
   #caenlace#2  = #caconasi#1;
   #caenlace#3  = 30;
   nSwTipo = 2; |HAZ TomaDatos;
   #caenlace#4  = aCuenta;
   #caenlace#5  = nNivel;
   #caenlace#6  = 702;
   #caenlace#7  = aDescAsto;
   #caenlace#8  = "H";
   nCalc = 1 + ((#comz0003#4 / 100) ! 2);
   nCalc = (nImporte / nCalc) ! 2;
   #caenlace#9  = nCalc;
   #caenlace#10 = "R";
   #caenlace#11 = nLibro;
   #caenlace#12 = aSerie;
   aAlfa = aReg % 0106; nCalc = aAlfa;
   #caenlace#13 = nCalc;
   #caenlace#26 = "B";
   #caenlace#27 = 1;
   #caenlace#28 = #comz0003#4;
   #caenlace#29 = #caenlace#1;
   #caenlace#30 = "N";
   #caenlace#31 = "S";
   #caenlace#32 = "N";
   #caenlace#33 = 0;
   #caenlace#37 = #48#2;
   #caenlace#38 = #48#3;
   #caenlace#48 = "J";
   |GRABA 020#caenlace.n;
|FPRC;

|PROCESO Importacion;
   aOrigen = aAlfa;
   aAlfa = aAlfa - "/";
   |SI FSalida ! 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         nCalc = FSalida + 98; aAlfa = aAlfa - "/";
      |SIGUE;
      aNomFic = aAlfa % nCalc;
   |SINO;
      aAlfa = aAlfa - "\";
      |SI FSalida ! 0;
         |PARA; |SI FSalida ! 0; |HACIENDO;
            nCalc = FSalida + 98; aAlfa = aAlfa - "\";
         |SIGUE;
         aNomFic = aAlfa % nCalc;
      |FINSI;
   |FINSI;

   |DBASE aDestino; |QBF aDestino;
   aDestino = aDestino + "tmp/";  |MKDIR aDestino;
   aDestino = aDestino + aNomFic; |QBF aDestino;

   aIP = ""; |IP_REMOTO aIP;
   |SI aIP ! "";
      |RECIBE_FICHERO aOrigen, aDestino;
      |RFBORRA aOrigen;
   |SINO;
      |COPIA_FICHERO aOrigen, aDestino;
      |FBORRA aOrigen;
   |FINSI;

   aAlfa = "xu" + Usuario; |QBF aAlfa; |NOME_DAT #caenlace#aAlfa#;
   |DELINDEX #caenlace; |ABRE #caenlace;

   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "tmp/"; aAlfa = aAlfa + aNomFic;
   |XABRE "T", aAlfa, nHandle;
   |SI FSalida ] 0;
      |XLEE nHandle, 250, aReg; || La primera linea se deshecha ...
      |XLEE nHandle, 250, aReg;
      |PARA; |SI FSalida > 0; |HACIENDO;
         |HAZ Importa;
         |XLEE nHandle, 250, aReg;
      |SIGUE;
      |XCIERRA nHandle;
   |FINSI;
   |CIERRA #caenlace;

   |DFICE aAlfa; |QBF aAlfa;
   aAlfa = "dsapunte.tab;" + aAlfa + ",xu" + Usuario;
   |SUB_EJECUTA aAlfa;

   |DELINDEX #caenlace;
   |SI aIP ! ""; |RFBORRA aDestino; |SINO; |FBORRA aDestino; |FINSI;
|FPRC;

|PROGRAMA;
   |ABRE #comz0003;
   |LEE 000#comz0003.p;
   |SI FSalida ! 0;
      |DDEFECTO #comz0003;
      |GRABA 020#comz0003.c;
   |FINSI;

   |CLS;
   |CABEZA "Importacion tiquet Celia";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0; |Y #0#1 = "S";
      |GRABA 020#comz0003.a;
      |ABRE #dsmom030;
      |HAZ Importacion;
      |CIERRA #dsmom030;
   |FINSI;

   |CIERRA #comz0003;
|FPRO;
