|FICHEROS;
   caselemp #0;
   caselem1 #1;
   canempre #2;
   caselem0 #3;  || Solo Empresas

   :/basica/def/agifigen #100;
   caselemz #911;

   espejo@  #901;
|FIN;

|VARIABLES;
   nPer    = 0;
   nEmp    = 0;
   aElUsu  = "";
   nCampo  = 0;
   nCampo1 = 0;
   Linea   = 0;
   Cont    = 0;
   Cont1   = 0;
   Cont2   = 0;
   nInkey   = 0;
   alfa1   = "";
   alfa2   = "";
   alfa3   = "";
   swpEmp  = 0;

   aMensa     = "";
   nSelError  = 0;
   nLaEmpresa = 0;
   nSwTipo    = 0;
   nPin1      = 0;

   nSwNoDir = 0;

   &eSwMul    = 0;
   &espe15    = "";
   &espe16    = 0;
   &espe17    = "";
   &eSwSuma   = 0;

   nPara1 = 0;
   nNume1 = 0;
   nNume2 = 0;
   nNume3 = 0;
   nNume4 = 0;
   nSwPlan = 0;
   nQueBusco = 0;
   nEje      = 0;

   aMas   = "";
   aDef   = "";
   aAlfa  = "";
|FIN;

|INCLUYE dscont_i;
|INCLUYE dscopi_i;
|| *******************************************************************

|CALCULO LeePlanilla; |TIPO 6;
 nSwPlan = 0;
 |ABRE #911;
 #911#0 = #0#120;
 |LEE 001#911=;
 |SI FSalida ! 0;
     |SI #0#120 = 0;
         |DDEFECTO #911;
         #911#0 = 0;
         #911#1 = "Empresa Actual";
         |GRABA 020#911n;
     |SINO;
         nSwPlan = 1;
     |FINSI;
 |FINSI;
 |CIERRA #911;
|FCAL;

|PROCESO LPlan;
 |SI nSwPlan = 0; |Y #0#120 ! 0;
      aAlfa = #0#141;
      |DDEFECTO #0;
      #0#141 = aAlfa;
      #0#79  = aElUsu;
      #0#120 = #911#0;
      #0#65 = #911#46;
      #0#78 = #911#47;
      |PARA nPara1 = 48; |SI nPara1 [ 59; |HACIENDO nPara1 = nPara1 + 1;
            nNume1 = nPara1 + 18;
            #0nNume1 = #911nPara1;
     |SIGUE;
     #0#0 = #911#2;
     |SI #0#0 = "S";
         #0#1 = #911#3; #0#2 = enPeriodo;
         #0#3 = #911#4; #0#4 = enPeriodo;
     |SINO;
         |PARA nPara1 = 5; |SI nPara1 [ 24; |HACIENDO nPara1 = nPara1 + 1;
               nNume1 = (nPara1 - 5) * 3 + 5;
               nNume2 = nNume1 + 1;
               nNume3 = nNume1 + 2;
               nNume4 = nPara1 + 20;
               #0nNume1 = #911nPara1;
               |SI #0nNume1 ! 0;
                   #0nNume2 = enPeriodo;
                   #0nNume3 = #911nNume4;
                   nEmp = #0nNume1;
                   nPer = #0nNume2;
                   nEje = enEjercicio;
                   nQueBusco = 1;
                   |HAZ SeldeEmpresa;
                   |SI nSelError = 0;
                       #0nNume2 = nPer;
                       nCampo = nNume2 + 1;
                       #0nCampo = #canempre#1; |PINTA #0nCampo;
                       nCampo = ( ( nNume2 - 3) / 3) * 2 + 78; #0nCampo = fec1;
                       nCampo = nCampo + 1;                    #0nCampo = fec2;
                       nCampo = nPara1 + 116;                  #0nCampo = #canempre#34;
                   |SINO;
                       #0nNume1 = 0;
                       #0nNume2 = 0;
                       #0nNume3 = "";
                   |FINSI;
               |FINSI;
          |SIGUE;
      |FINSI;
      swpEmp = 1;
  |FINSI;
|FPRC;

|CALCULO LaPlanilla; |TIPO 0;
  |SI #0#120 ! 0;
      |HAZ LPlan;
      |PINDA #0#0;
      swpEmp = 1;
  |FINSI;
|FCAL;

||..................................................................

|CALCULO estaemp; |TIPO 7;
 |C_M #0Campo,0,alfa1;
 |SI alfa1 = "N"; |ACABA; |FINSI;

 |SI FSalida ! 0; |ACABA; |FINSI;

 |SI swpEmp = 0
     |SI #0Campo = 0; |O eSwSuma = 0; |O #0#141 = "N";
         |SI enEmpresa = 0;  enEmpresa = #0#1; enPeriodo = #0#2; |FINSI;
         #0Campo  = enEmpresa; |PINTA #0Campo;
         nCampo   = Campo + 1;
         #0nCampo = enPeriodo; |PINTA #0nCampo;
     |FINSI;
     swpEmp   = 1;
 |FINSI;
|FCAL;

|PROCESO Select; |TIPO 0;
  |SI #0#0 = "S";
      |C_M #0#1,1,"S"; |C_M #0#2,1,"S";
      |C_M #0#3,1,"S"; |C_M #0#4,1,"S";
      |PARA Cont = 5; |SI Cont [ 62; |HACIENDO Cont = Cont + 3;
            Cont1 = Cont + 1;
            Cont2 = Cont + 2;
            |C_M #0Cont, 1,"N"; #0Cont  = 0;  |PINTA #0Cont;
            |C_M #0Cont1,1,"N"; #0Cont1 = 0;  |PINTA #0Cont1;
                                #0Cont2 = ""; |PINTA #0Cont2;
      |SIGUE;
   |SINO;
      |C_M #0#1,1,"N"; #0#1 = 1; |PINTA #0#1;
      |C_M #0#2,1,"N"; #0#2 = 0; |PINTA #0#2;
      |C_M #0#3,1,"N"; #0#3 = 99999; |PINTA #0#3;
      |C_M #0#4,1,"N"; #0#4 = 9;     |PINTA #0#4;
      |PARA Cont = 5; |SI Cont [ 62; |HACIENDO Cont = Cont + 3;
            Cont1 = Cont + 1;
            |C_M #0Cont, 1,"S";
            |C_M #0Cont1,1,"S";
      |SIGUE;
   |FINSI;
|FPRC;

|CALCULO SelTipo0; |TIPO 0;
     |SI Haybasica = 0; |ACABA; |FINSI;

     |SI #0#78 = "N";
         #0#66 = 0;  |PINTA #0#66;  |C_M #0#66, 1, "N";
         #0#67 = 99; |PINTA #0#67;  |C_M #0#67, 1, "N";
         |PARA nCampo = 68;  |SI nCampo [ 77;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #0#66, 1, "S";
         |C_M #0#67, 1, "S";
         |PARA nCampo = 68;  |SI nCampo [ 77;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO SelTipo1;
     |SI Haybasica = 0; |ACABA; |FINSI;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 77;  |HACIENDO nCampo = nCampo + 1;
               #0Campo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 77;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO MiraEmpresa; |TIPO 0;
   nInkey = FSalida;
   |SI nInkey = 2; |ACABA; |FINSI;
   nCampo  = Campo - 1;  || empresa
   nCampo1 = Campo + 1;  || titulo

   |SI #0nCampo = 0; |Y #0Campo = 0;
       #0nCampo1 = "";
       |PINTA #0nCampo1;
       |ACABA;
   |FINSI;

   |SI #0#0 = "N";
       nEmp = #0nCampo;
       nPer = #0Campo;
       nEje = enEjercicio;
       nQueBusco = 0;
       |HAZ SeldeEmpresa;
       #0Campo = nPer;
       |SI nSelError ! 0;
           |MENAV aMensa;
           |ERROR;
           |ACABA;
       |FINSI;
       #0nCampo1 = #canempre#1;  |PINTA #0nCampo1;
       nCampo = ( ( Campo - 3) / 3) * 2 + 78; #0nCampo = fec1;
       nCampo = nCampo + 1;                   #0nCampo = fec2;
       nCampo = ((nCampo-79)/ 2) + 120;       #0nCampo = #canempre#34;
   |FINSI;
|FCAL;

|PROCESO SeldeEmpresa;
   alfa1 = nEje;
   alfa1 = alfa1 % -102;
   nEje  = alfa1;
   |ABRE #canempre;
   aMensa    = "";
   nSelError = 0;
   |SI nQueBusco = 1;
       |SELECT #4#canempre;
       #canempre#2  = nEmp;
       #canempre#26 = nEje;
       |LEE 010#canempre.=;
   |SINO;
       |SELECT #1#canempre;
       #canempre#2 = nEmp;
       #canempre#3 = nPer;
       |LEE 010#canempre.=;
   |FINSI;
   |SI FSalida = 0;
       nPer = #canempre#3;
       |SI #0#65 ! "T";
           |SI #canempre#21 ! #0#65;
               |SI #canempre#21 = "I";
                   aMensa = "    Empresa Inactiva";
               |SINO;
                   aMensa = "    Empresa Activa";
               |FINSI;
               nSelError = 1;
               |VETE Cierra;
           |FINSI;
       |FINSI;
       nLaEmpresa = #canempre#2;
       |HAZ ElTipoEmpresa;
       |SI nSwTipo = 1;
           aMensa = "    Tipo de Empresa No Seleccionado";
           nSelError  = 1;
           |VETE Cierra;
       |FINSI;
       |HAZ CalFechas;
   |SINO;
       nSelError  = 1;
       aMensa = "    No Existe Empresa ";
   |FINSI;

|ET Cierra;
   |CIERRA #canempre;
|FPRC;

|| ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
|PROCESO CalDirectorio;

  nSwNoDir = 0;

  enEmpresaPINET = #1#1;
  |HAZ RestriccionPINET;
  |SI enErrorPINET = 1;  nSwNoDir = 1;  |ACABA;  |FINSI;

  |DBASS dir_fich; |QBF dir_fich;
  dir_fich = dir_fich + "contagen/fich/";
  alfa1 = #1#1; |QBF alfa1;
  alfa2 = #1#2; |QBF alfa2;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"     + alfa2;   alfa2 = alfa2 % -101;
  #1#3 = dir_fich + alfa1 + alfa2 + "/";
  alfa1 = #1#3;   |QBF alfa1;

  |MKDIR alfa1;
  |SI FSalida = 0;
       nSwNoDir = 1;
       |RMDIR alfa1;
  |SINO;
       |SI eSwMul ! 0; |O espe17 = "S";
           |ABRE #901;
           |SELECT #3#901;
           #901#1 = #1#1;
           #901#2 = #1#2;
           |LEE 001#901=;
           |SI FSalida = 0;
               nSwNoDir = 1;   ||Ya esta dentro del fichero
           |FINSI;
           |SELECT #1#901;
           |CIERRA #901;
       |FINSI;
  |FINSI;
|FPRC;

|PROCESO OtroAuxiliar;
   alfa1 = #1#5;
   alfa1 = alfa1 % -104;

   |DDEFECTO #3;
   #3#0 = #1#1;
   |LEE 041#3=;
   |SI FSalida ! 0;
       #3#0 = #1#1;
       #3#1 = #1#3;
       #3#2 = #1#4;
       #3#3 = #1#5;
       #3#4 = alfa1;
       #3#5 = #1#2;
       |GRABA 020#3n;
   |SINO;
       |SI #1#4 < #3#2;
           #3#2 = #1#4;
       |FINSI;
       |SI #1#5 > #3#3;
           #3#3 = #1#5;
           #3#4 = alfa1;
           #3#1 = #1#3;
           #3#5 = #1#2;
       |FINSI;
       |GRABA 020#3a;
   |FINSI;
|FPRC;

|PROCESO Rellena;

   |SI #0#65 ! "T";
       |SI #canempre#21 ! #0#65;
            |ACABA;
       |FINSI;
   |FINSI;

   nLaEmpresa = #canempre#2;
   |HAZ ElTipoEmpresa;
   |SI nSwTipo = 1; |ACABA; |FINSI;

   |DDEFECTO #1;
   #1#0 = Linea;
   #1#1 = #canempre#2;
   #1#2 = #canempre#3;
   |HAZ CalFechas;
   #1#4 = fec1;
   #1#5 = fec2;
   #1#6 = #canempre#34;
   aAlfa = #1#4; aAlfa = aAlfa % -104;
   #1#7 = aAlfa;
   |HAZ CalDirectorio;
   |SI nSwNoDir = 0;
       |GRABA 020#1n;
       |SI eSwMul ! 0; |HAZ OtroAuxiliar; |FINSI;
       Linea = Linea + 1;
   |FINSI;
|FPRC;

|DEFBUCLE Rellena;
 #canempre#1;
 ;
 #0#1,#0#2;
 #0#3,#0#4;
 ;
 NULL,Rellena;
|FIN;

|PROCESO RellenaMulti;
 |SI #canempre#3 ! nPer;
     |HAZ Rellena;
 |FINSI;
|FPRC;

|DEFBUCLE RellenaMulti;
 #canempre#1;
 ;
 nEmp,0;
 nEmp,9;
 ;
 NULL,RellenaMulti;
|FIN;

|PROCESO CreaAuxiliar;

   espe17 = ""; |SI eSwSuma = 1; espe17 = #0#141; |FINSI;

   Linea = 1;
   |ABRE #1;
   |ABRE #3;
   |SI #0#0 = "S";
       |SI eSwMul ! 0; |Y espe15 = "S";
           #0#2 = 0; #0#4 = 9;
       |FINSI;
       |BUCLE Rellena;
   |SINO;
       |PARA Cont = 5; |SI Cont [ 62; |HACIENDO Cont = Cont + 3;
             nCampo = Cont + 1;
             |SI #0Cont ! 0;
                 |DDEFECTO #1;
                 #1#0 = Linea;
                 #1#1 = #0Cont;
                 #1#2 = #0nCampo;
                 |HAZ CalDirectorio;
                 nCampo = ((Cont - 2) / 3) * 2 + 78;
                 #1#4 = #0nCampo;
                 nCampo = nCampo + 1;
                 #1#5 = #0nCampo;
                 nCampo = ((nCampo-79)/ 2) + 120;
                 #1#6 = #0nCampo;
                 aAlfa = #1#4; aAlfa = aAlfa % -104;
                 #1#7 = aAlfa;
                 |SI nSwNoDir = 0;
                     |GRABA 020#1n;
                     |SI eSwMul ! 0; |HAZ OtroAuxiliar; |FINSI;
                      Linea = Linea + 1;
                 |FINSI;
                 |SI eSwMul ! 0; |Y espe15 = "S";
                     nEmp = #1#1;
                     nPer = #1#2;
                     |BUCLE RellenaMulti;
                 |FINSI;
            |FINSI;
      |SIGUE;
   |FINSI;

   |CIERRA #3;
   |CIERRA #1;
|FPRC;

|| *************************************************************************
|PROGRAMA;

   eaFichsel = "se" + Usuario;
   |NOME_DAT #1 eaFichsel;

   eaFichres = "re" + Usuario;
   |NOME_DAT #3 eaFichres;

   |DBASE aMas;
   aDef = aMas + "def/caselem1";
   |CARGA_DEF aDef, espejo@;
   |SI FSalida ! 0;
       |MENAV "    Error Cargado " + aDef;
       |ACABA;
   |FINSI;
   |NOME_DAT #901 eaFichsel;

   |HAZ LaRelacion;
   |SI eSwMul = 1;
       |SI espe15 = "S"; |Y espe16 = 00;
            |DDEFECTO #0;
            #0#0 = "S";
            #0#1 = enEmpresa; #0#2 = 0;
            #0#3 = enEmpresa; #0#4 = 9;
            |DELINDEX #1;
            |DELINDEX #3;
            |HAZ CreaAuxiliar;
            |DESCARGA_DEF #espejo@;
            |ACABA;
       |SINO;
            enSPlan = espe16;
       |FINSI;
   |FINSI;

   aElUsu = Usuario % 108;
   |ABRE #0;
   #0#79 = aElUsu;
   |LEE 001#0=;
   |SI FSalida ! 0;
       |DDEFECTO #0;
       #0#79 = aElUsu;
       |GRABA 020#0c;
   |FINSI;

   |SI enSPlan ! 0;
       #0#120 = enSPlan;
       |HAZ LeePlanilla;
       |HAZ LPlan;
   |FINSI;

   |DELINDEX #1;
   |DELINDEX #3;
   |SI eSwMul ! 1;
       |CLS;
       |PINPA #0#0;
       |SI eSwSuma = 1;
           |C_V #0#141, 1, "S";
           |C_M #0#141, 1, "S";
           |ATRI I;
           |PINTA 0526, "Datos Consolidados:      Planilla Selec. Empresas:";
           |ATRI 0;
       |FINSI;
       |PINDA #0#0;
       |ENDATOS #1#0;
       |SI FSalida ! 0; |CIERRA #0; |ACABA; |FINSI;
   |FINSI;

   |GRABA 020#0a;
   |CIERRA #0;

   |HAZ CreaAuxiliar;

   |DESCARGA_DEF #espejo@;
|FPRO;

||*********************************************************************
||------- Proceso para seleccionar por tipo de Empresa
|PROCESO ElTipoEmpresa;
    nSwTipo = 1;
    |SI Haybasica = 0; nSwTipo = 0; |ACABA; |FINSI;

    |ABRE #agifigen;
    #agifigen#0 = nLaEmpresa; || Empresa
    |LEE 041#agifigen.=;
    |SI FSalida ! 0;
        |DDEFECTO #agifigen;
        #agifigen#87 = 1;
    |FINSI;
    |CIERRA #agifigen;
    nPin1 = #agifigen#87;

    |SI #0#78 = "S";
        |SI nPin1 ] #0#66; |Y nPin1 [ #0#67;
            nSwTipo = 0;
        |FINSI;
    |SINO;
        |SI nPin1 = #0#68;
            nSwTipo = 0;
        |SINO;
            |PARA nCampo = 69;  |SI nCampo [ 77;  |HACIENDO nCampo = nCampo + 1;
                  |SI nPin1 = #0nCampo; |Y nPin1 ! 0;
                      nSwTipo = 0;
                     |SAL;
                  |FINSI;
            |SIGUE;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO LaRelacion;
     |HAZ DirAplicSt;
     |SI Haybasica = 1;         || Existe Acceso;
         || ... Activado Basica
         |MODO_RELACION #0, 0, "agitab04", "X", "X";
         |MODO_RELACION #0, 1, "agitab04", "N", "N";
     |SINO;
         || No existe Basica
         |MODO_RELACION #0, 1, "agitab04", "N", "N";
         |MODO_RELACION #0, 1, "agitab04", "X", "X";
         |C_M #0#66,1,"N"; |C_M #0#67,1,"N";
         |C_M #0#68,1,"N"; |C_M #0#69,1,"N";
         |C_M #0#70,1,"N"; |C_M #0#71,1,"N";
         |C_M #0#72,1,"N"; |C_M #0#73,1,"N";
         |C_M #0#74,1,"N"; |C_M #0#75,1,"N";
         |C_M #0#76,1,"N"; |C_M #0#77,1,"N";
         |C_M #0#78,1,"N";
    |FINSI;
|FPRC;
|| *********************************************************************

|PROCESO CalFechas;
   cod2 = #canempre#26;
   tra1 = 100 + cod2;
   clave2 = tra1 % -102;
   tra1 = 100 + #canempre#11;
   mes1 = tra1 % -102;
   |SI cod2 < 80;
      work1 = "01." + mes1 + ".20" + clave2;
   |SINO;
      work1 = "01." + mes1 + ".19" + clave2;
   |FINSI;
   enAny = #canempre#26;
   fec1 = work1;
   tra1 = 100 + #canempre#12;
   mes1 = tra1 % -102;
   |SI #canempre#11 > #canempre#12;
      cod2 = cod2 + 1;
      |SI cod2 > 99; cod2 = cod2 - 100;    |FINSI;
   |FINSI;
   dia1 = "31";
   |SI #canempre#12 = 4; |O #canempre#12 = 6; |O #canempre#12 = 9; |O #canempre#12 = 11;
      dia1 = "30";
   |FINSI;
   |SI #canempre#12 = 2;
      dia1 = "28";
      |SI cod2 = 88; |O cod2 = 92; |O cod2 = 96; |O cod2 = 0; |O cod2 = 4; |O cod2 = 8;
          |O cod2 = 12; |O cod2 = 16; |O cod2 = 20; |O cod2 = 24;
         dia1 = "29";
      |FINSI;
   |FINSI;
   tra1 = 100 + cod2;
   clave2 = tra1 % -102;
   |SI cod2 < 80;
      work1 = dia1 + "." + mes1 + ".20" + clave2;
   |SINO;
      work1 = dia1 + "." + mes1 + ".19" + clave2;
   |FINSI;
   fec2 = work1;
|FPRC;
