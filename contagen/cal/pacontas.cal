|FICHEROS;
   pacontas #0;
   pacontm2 #1;

   camaasic #10;
   camaasil #11;
   camaniva #12;
   caivalin #13;
   calicont #14;
   caclipro #16;
|FIN;

|INCLUYE dscont_i;

|VARIABLES;
   nHandle1  = 0;
   nHandle2  = 0;
   nEjerc    = 0;
   nTipoRec  = 0;
   nTipoIva  = 0;
   nTipo     = 0;
   nBase     = 0;
   nCuotaIva = 0;
   nCuotaRec = 0;
   nContador = 0;
   nCalc     = 0;
   nCalc1    = 0;
   nCalc2    = 0;
   nEntero   = 0;
   nDecim    = 0;

   nCuadrePtas = 0;

   aAlfa     = "";
   aAlfa1    = "";
   aAlfa2    = "";
   aAlfa3    = "";
   aTipo     = "";
   aTipoAs   = "";
   aCtaIva   = "";
   aCadena   = "";
   aCadena2  = "";
   aSubCta   = "";
|FIN;

|PROCESO MiraUbica;
   aAlfa = #pacontas#6; |QBF aAlfa;
   |SI aAlfa = "";
      aAlfa = "D "; |BROWSE aAlfa;
      aAlfa = aAlfa % 0299;
      #pacontas#6 = aAlfa; |ERROR;
   |SINO;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! "/"; |O aAlfa1 ! "\"; aAlfa = aAlfa + "/"; |FINSI;
      aAlfa1 = aAlfa + "XDiario.txt"; |XABRE "CW", aAlfa1, nHandle1;
      |SI FSalida < 0;
         aAlfa1 = "    NEl directorio que ha indicado no existe. " + &191 + " Desea crearlo ? ";
         |CONFI aAlfa1;
         |SI FSalida = 0; |RMKDIR aAlfa; |FINSI;
      |FINSI;
      |RFBORRA aAlfa1;
   |FINSI;
|FPRC;

|PROCESO LeeBases;
   |SI #caivalin#16 = nTipo;
      nBase  = nBase  + #caivalin#6;
      nCuotaIva = nCuotaIva + #caivalin#8;
      nCuotaRec = nCuotaRec + #caivalin#10;
   |FINSI;
|FPRC;

|DEFBUCLE LeeBases;
#caivalin#1;
;
#camaniva#0, #camaniva#1, 01;
#camaniva#0, #camaniva#1, 99;
;
NULL, LeeBases;
|FIN;

|PROCESO CalculaLins;
   enEjercicio = nEjerc;
   aTipoIVA    = aTipo;
   efFechaIVA = #camaniva#4; enLineaIVA = 0;
   eaCtaIVA = aCtaIva; eaCtaREC = ""; eaCtaDTO = "";
   |HAZ BuscaCtaIVA;
   nTipo = enLineaIVA; nTipoIva = enPorcIVA; nTipoRec = enPorcREC;

   nBase = 0; nCuotaIva = 0; nCuotaRec = 0;
   |BUCLE LeeBases;
|FPRC;

|PROCESO FormatPorcent;
   |QBF aAlfa; nCalc1 = aAlfa;
   |SI nCalc1 = 0; aAlfa = " 0.00"; |ACABA; |FINSI;

   nCalc1 = (nCalc1 * 100) ! 0; aAlfa2 = nCalc1;
   aAlfa2 = ((" " * 4) + aAlfa2) % -104;
   aAlfa = (aAlfa2 % 0102) + "." + (aAlfa2 % -102);
|FPRC;

|PROCESO FormatImporte;
   |QBF aAlfa; nCalc1 = aAlfa;
   |SI nCalc1 = 0; aAlfa = "            0.00"; |ACABA; |FINSI;

   nCalc1 = (nCalc1 * 100) ! 0; aAlfa2 = nCalc1;
   aAlfa2 = ((" " * 15) + aAlfa2) % -115;
   aAlfa = (aAlfa2 % 0113) + "." + (aAlfa2 % -102);
|FPRC;

|PROCESO LineasAstos;
   aAlfa = ("      " + nContador) % -106;
   aCadena = aCadena + aAlfa;
   aAlfa = #camaasic#1; |QBF aAlfa;
   aAlfa = (aAlfa % 0704) + (aAlfa % 0402) + (aAlfa % 0102);
   aCadena = aCadena + aAlfa;
   aAlfa = #camaasil#4; |QBF aAlfa;
   aAlfa = (aAlfa + (" " * 12)) % 0112;
   aCadena = aCadena + aAlfa;

   #calicont#0 = #camaasil#0;
   #calicont#1 = #camaasil#1;
   #calicont#2 = #camaasil#2;
   #calicont#3 = #camaasil#3;
   |LEE 000#calicont.=;
   |SI FSalida ! 0; |DDEFECTO #calicont; |FINSI;
   aAlfa = #calicont#4; |QBF aAlfa;
   aAlfa = (aAlfa + (" " * 12)) % 0112;
   aCadena = aCadena + aAlfa;

   |SI #camaasil#8 = "D";
      nCalc = (#camaasil#9 * 166.386) ! 2; aAlfa = nCalc;
      nCuadrePtas = nCuadrePtas - nCalc;
      |SI nCuadrePtas ] -0.02; |Y nCuadrePtas [ 0.02;
         nCalc = nCalc + nCuadrePtas; aAlfa = nCalc;
      |FINSI;
   |SINO;
      aAlfa = "0";
   |FINSI;
   |QBF aAlfa; |HAZ FormatImporte;
   aCadena = aCadena + aAlfa;

   aAlfa = #camaasil#7; |QBF aAlfa;
   aAlfa = (aAlfa + (" " * 25)) % 0125;
   aCadena = aCadena + aAlfa;

   |SI #camaasil#8 = "H";
      nCalc = (#camaasil#9 * 166.386) ! 2; aAlfa = nCalc;
      nCuadrePtas = nCuadrePtas + nCalc;
      |SI nCuadrePtas ] -0.02; |Y nCuadrePtas [ 0.02;
         nCalc = nCalc - nCuadrePtas; aAlfa = nCalc;
      |FINSI;
   |SINO;
      aAlfa = "0";
   |FINSI;
   |QBF aAlfa; |HAZ FormatImporte;
   aCadena = aCadena + aAlfa;
   |XGRABA nHandle1, aCadena; aCadena = "";

   |SI #camaasil#12 ! " ";
      aAlfa = #camaasil#4; |QBF aAlfa;
      aAlfa = aAlfa % 0104;
      aAlfa1 = aAlfa % 0103;
      aTipoAs = ""; aSubCta = aAlfa1;
      |SI #camaasil#19 = "F";
         |SI aAlfa1 = "4751";
            aTipoAs = "B";
         |SINO;
            aTipoAs = "F";
         |FINSI;
      |SINO;
         |SI aSubCta = "430"; |O aSubCta = "400"; |O aSubCta = "410";
            aTipoAs = "F";
         |FINSI;
      |FINSI;
      |SI #camaasil#19 = "I"; |O #camaasil#19 = "R";
         aTipoAs = "I";
      |SINO;
         |SI aSubCta = "477"; |O aSubCta = "472";
            aTipoAs = "I";
         |FINSI;
      |FINSI;
      |SI #camaasil#19 = "B";
         aTipoAs = "B";
      |SINO;
         aAlfa1 = aSubCta % 0101;
         |SI aAlfa1 = "7"; |O aAlfa1 = "6";
            aTipoAs = "B";
         |FINSI;
      |FINSI;

      |SI aTipoAs = "F";
         #pacontm2#0 = #camaasil#4;
         |LEE 000#pacontm2.=;
         |SI FSalida ! 0;
            |DDEFECTO #pacontm2;
            #pacontm2#0 = #camaasil#4;
            |GRABA 020#pacontm2.c;

            #caclipro#23 = " ";
            |SI aAlfa = "430";                   #caclipro#23 = "C"; |FINSI;
            |SI aAlfa = "400"; |O aAlfa = "410"; #caclipro#23 = "P"; |FINSI;
            |SI #caclipro#23 = " ";
               |SI #camaasil#12 = "R";           #caclipro#23 = "C"; |FINSI;
               |SI #camaasil#12 = "S";           #caclipro#23 = "P"; |FINSI;
            |FINSI;
            #caclipro#10 = #camaasil#4;
            |LEE 000#caclipro.=;
            |SI FSalida ! 0; |DDEFECTO #caclipro; |FINSI;

            aAlfa = #camaasil#4; aCadena2 = aAlfa;
            aAlfa = #caclipro#1; aCadena2 = aCadena2 + aAlfa;
            aAlfa = #caclipro#9; aCadena2 = aCadena2 + aAlfa;
            aAlfa = #caclipro#2; |QBF aAlfa; aAlfa = (aAlfa + (" " * 35)) % 0135;
            aCadena2 = aCadena2 + aAlfa;
            aAlfa = #caclipro#6; aCadena2 = aCadena2 + aAlfa;
            aAlfa = #caclipro#5; aCadena2 = aCadena2 + aAlfa;
            aCadena2 = aCadena2 + "     ";
            aAlfa = (("00" + #caclipro#3) % -102) + (("000" + #caclipro#4) % -103) + "         ";
            aCadena2 = aCadena2 + aAlfa + &13 + &10;
            |XGRABA nHandle2, aCadena2; aCadena2 = "";
         |FINSI;

         aAlfa = " " * 142; aCadena = aCadena + aAlfa;
         aCadena = aCadena + "2";
         |SI #camaasil#8 = "H";
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
         |SINO;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
         |FINSI;

         aAlfa = " " * 16;
         aCadena = aCadena + aAlfa;

         aAlfa = " " * 11;
         aCadena = aCadena + aAlfa;
         aCadena = aCadena + &13 + &10;
      |FINSI;
      |SI aTipoAs = "I";
         |SI aSubCta = "477"; aTipo = "R"; |FINSI;
         |SI aSubCta = "472"; aTipo = "S"; |FINSI;

         |SELECT #2#camaniva;
         #camaniva#7 = #camaasic#0;
         #camaniva#8 = #camaasic#1;
         #camaniva#9 = #camaasic#2;
         |LEE 000#camaniva.=;
         |SI FSalida ! 0; |DDEFECTO #camaniva; |FINSI;
         |SELECT #1#camaniva;
         |LEE 000#camaniva.=;
         |SI FSalida ! 0; |DDEFECTO #camaniva; |FINSI;
         aCtaIva = #camaasil#4; |QBF aCtaIva;

         nTipo = -1; nTipoIva = 0;
         aAlfa = #camaasil#1; |QBF aAlfa;
         aAlfa = aAlfa % -104; nEjerc = aAlfa;
         |HAZ CalculaLins;

         |SI nBase = 0; nBase = #camaniva#19; |FINSI;
         aAlfa = ((" " * 8) + #camaniva#3) % -108; aCadena = aCadena + aAlfa;
         aAlfa = nBase; |QBF aAlfa; |HAZ FormatImporte;
         aCadena = aCadena + aAlfa;
         aAlfa = nTipoIva; |QBF aAlfa;
         |HAZ FormatPorcent;
         |SI nTipoIva = 0;
            aCadena = aCadena + "     ";
         |SINO;
            aAlfa = ((" " * 5) + aAlfa) % -105; aCadena = aCadena + aAlfa;
         |FINSI;
         aCadena = aCadena + "  ";
         aAlfa = nTipoRec; |QBF aAlfa;
         |HAZ FormatPorcent;
         |SI nTipoRec = 0;
            aCadena = aCadena + "     ";
         |SINO;
            aAlfa = ((" " * 5) + aAlfa) % -105; aCadena = aCadena + aAlfa;
         |FINSI;
         aAlfa = " " * 80; aCadena = aCadena + aAlfa;
         aAlfa = #camaniva#2; |QBF aAlfa;
         aAlfa1 = aAlfa % 0; nCalc = aAlfa1;
         |SI nCalc > 1; aAlfa = aAlfa % 0101; |FINSI;
         |SI nCalc = 0; aAlfa = " "; |FINSI;
         aCadena = aCadena + aAlfa;
         aAlfa = " " * 25; aCadena = aCadena + aAlfa;

         aCadena = aCadena + "2";

         |SI #camaasil#8 = "H";
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
         |SINO;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
         |FINSI;

         aAlfa = nBase; |QBF aAlfa;
         |HAZ FormatImporte;
         aCadena = aCadena + aAlfa;

         aAlfa = " " * 11;
         aCadena = aCadena + aAlfa;
         aCadena = aCadena + &13 + &10;
      |FINSI;
      |SI aTipoAs = "B"; |O aTipoAs = "";
         aAlfa = " " * 142; aCadena = aCadena + aAlfa;
         aCadena = aCadena + "2";

         |SI #camaasil#8 = "H";
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
         |SINO;
            aAlfa = #camaasil#9; |QBF aAlfa;
            |HAZ FormatImporte;
            aCadena = aCadena + aAlfa;
            aAlfa = " " * 16;
            aCadena = aCadena + aAlfa;
         |FINSI;

         aAlfa = " " * 16;
         aCadena = aCadena + aAlfa;

         aAlfa = " " * 11;
         aCadena = aCadena + aAlfa;
         aCadena = aCadena + &13 + &10;
      |FINSI;
   |SINO;
      aAlfa = " " * 142; aCadena = aCadena + aAlfa;
      aCadena = aCadena + "2";

      |SI #camaasil#8 = "H";
         aAlfa = " " * 16;
         aCadena = aCadena + aAlfa;
         aAlfa = #camaasil#9; |QBF aAlfa;
         |HAZ FormatImporte;
         aCadena = aCadena + aAlfa;
      |SINO;
         aAlfa = #camaasil#9; |QBF aAlfa;
         |HAZ FormatImporte;
         aCadena = aCadena + aAlfa;
         aAlfa = " " * 16;
         aCadena = aCadena + aAlfa;
      |FINSI;

      aAlfa = " " * 16;
      aCadena = aCadena + aAlfa;

      aAlfa = " " * 11;
      aCadena = aCadena + aAlfa;
      aCadena = aCadena + &13 + &10;
   |FINSI;
   |XGRABA nHandle1, aCadena; aCadena = "";
|FPRC;

|DEFBUCLE LineasAstos;
#camaasil#1;
;
#camaasic#0, #camaasic#1, #camaasic#2, 0000;
#camaasic#0, #camaasic#1, #camaasic#2, 9999;
;
NULL,LineasAstos;
|FIN;

|PROCESO Asientos;
   aCadena = " Procesando asiento " + (("00" + #camaasic#0) % -102) + "/";
   aCadena = aCadena + #camaasic#1 + "/";
   aCadena = aCadena + (("000000" + #camaasic#2) % -106);
   |ATRI I; |PINTA 2302, aCadena; |ATRI N;
   aCadena = ""; nCuadrePtas = 0;
   |BUCLE LineasAstos;
   nContador = nContador + 1;
|FPRC;

|DEFBUCLE Asientos;
#camaasic#1;
;
#pacontas#0, #pacontas#2, #pacontas#4;
#pacontas#1, #pacontas#3, #pacontas#5;
;
NULL, Asientos;
|FIN;

|PROGRAMA;
   aAlfa = "cp" + Usuario; |NOME_DAT #pacontm2#aAlfa#;
   |DELINDEX #pacontm2; |ABRE #pacontm2;
   |ABRE #pacontas;
   |LEE 000#pacontas.p;
   |SI FSalida ! 0;
      |DDEFECTO #pacontas;
      |GRABA 020#pacontas.c;
   |FINSI;

   |CLS;
   |CABEZA "Exportacion a Contaplus";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0; |Y #0#7 = "S";
      |GRABA 020#pacontas.a;
      aAlfa = #pacontas#6; |QBF aAlfa;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! "/"; |O aAlfa1 ! "\"; aAlfa = aAlfa + "/"; |FINSI;
      aAlfa1 = aAlfa + "XDiario.txt"; |XABRE "CWB", aAlfa1, nHandle1;
      |SI FSalida ] 0;
         aAlfa1 = aAlfa + "XSubCta.txt"; |XABRE "CWB", aAlfa1, nHandle2;
         |SI FSalida ] 0;
            |ABRE #calicont; |ABRE #caclipro; |ABRE #camaniva;
            nContador = 1;
            |BUCLE Asientos;
            |CIERRA #calicont; |CIERRA #caclipro; |CIERRA #camaniva;
            |XCIERRA nHandle2;
         |FINSI;
         |XCIERRA nHandle1;
      |FINSI;
   |FINSI;

   |CIERRA #pacontas;
   |CIERRA #pacontm2; |DELINDEX #pacontm2;
|FPRO;
