|FICHEROS;
      rew99999;

      rem01010@ #10;
      rem01018@ #18;
      rem01022@ #22;
      rem01033@ #33;
      rem01026@ #26;

     &refere1@;
     &refere2@;
     &refere3@;
|FIN;

|VARIABLES;
|FIN;

|INCLUYE i_varcal;

|PROCESO Ded_32_2_1;
     |SI #rem01018@#26 ! "S";  |ACABA;  |FINSI;

     |SI enConta ] 6;
         enSwAcum  = 0;
         enBloque  = 5;
         eaCasilla = "127";
         enImporte = enVal127Tit + enVal127Con;
         |HAZ GrabaLineal;

         |ACABA;
     |FINSI;

     nTotRdtos = nTotRenta - #rem01018@#7;    || 118
     nTotRdtos = nTotRdtos - #rem01018@#11;   || 143
     nTotRdtos = nTotRdtos - #rem01018@#13;   || 172

     enImporte = #rem01018@#18;
     nRdto     = 0;
     |SI enImporte > 0;
         nRdto = 2000;

         |SI enImporte [ 14450; |Y nTotRdtos < 6500.01;
             |SI enImporte < 11250;
                 nRdto = nRdto + 3700;
             |SINO;
                 |SI enImporte ] 11250;  |Y enImporte [ 14450;
                     nRdto = nRdto + (3700 - (1.15625 * (enImporte - 11250))) ! 2;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI #rew99999#3 ] 33;  |Y #rew99999#3 < 65;
             |SI #rew99999#4 = "N";
                 nRdto = nRdto + 3500;
             |SINO;
                 nRdto = nRdto + 7750;
             |FINSI;
         |FINSI;

         |SI #rew99999#3 ] 65;
             nRdto = nRdto + 7750;
         |FINSI;
     |FINSI;

     enBloque = 5;  eaCasilla = "126"; |HAZ SacaImporte;  nValor = enImporte;
     |SI nRdto > nValor;
         nRdto = nValor;
     |FINSI;

     |SI nRdto < 0;  nRdto = 0;  |FINSI;

     |SI enConta = 1;
         enVal127Tit = nRdto;
     |FINSI;

     |SI enConta = 2;
         enVal127Con = nRdto;
     |FINSI;

     enSwAcum  = 0;
     enBloque  = 5;
     eaCasilla = "127";
     enImporte = nRdto;
     |HAZ GrabaLineal;
|FPRC;

|PROCESO Ded_32_2_3;
     enBloque = 5;  eaCasilla = "127"; |HAZ SacaImporte;  nVal127 = enImporte;
     |SI nVal127 ! 0;  |ACABA;  |FINSI;

     nRdto = 0;
     |SI nTotRenta < 8000;
         nRdto = 1620;
     |SINO;
         |SI nTotRenta < 12000;
             nRdto = (N\ 1620 - (0.405 * (nTotRenta - 8000)));
         |FINSI;
     |FINSI;

     |SI #rem01010@#22 > 3700;
         nRdto = 0;
     |SINO;
         nSuma = #rem01010@#22 + nRdto;
         |SI nSuma > 3700;
             nRdto = 3700 - #rem01010@#22;
         |FINSI;
     |FINSI;

     enBloque = 5;  eaCasilla = "126"; |HAZ SacaImporte;  nValor = enImporte;
     |SI nValor > 0;
         enImporte = ((nRdto / #rem01018@#33) * nValor) ! 2;
         |SI enImporte > nValor;
             enImporte = nValor;
         |FINSI;

         |SI enImporte < 0;  enImporte = 0;  |FINSI;

         enSwAcum  = 0;
         enBloque  = 5;
         eaCasilla = "128";
         |HAZ GrabaLineal;
     |FINSI;

     enBloque = 6;  eaCasilla = "153"; |HAZ SacaImporte;  nValor = enImporte;
     |SI nValor > 0;
         enImporte = ((nRdto / #rem01018@#33) * nValor) ! 2;
         |SI enImporte > nValor;
             enImporte = nValor;
         |FINSI;

         |SI enImporte < 0;  enImporte = 0;  |FINSI;

         enSwAcum  = 0;
         enBloque  = 6;
         eaCasilla = "154";
         |HAZ GrabaLineal;
     |FINSI;

     enBloque = 7;  eaCasilla = "183"; |HAZ SacaImporte;  nValor = enImporte;
     |SI nValor > 0;
         enImporte = ((nRdto / #rem01018@#33) * nValor) ! 2;
         |SI enImporte > nValor;
             enImporte = nValor;
         |FINSI;

         |SI enImporte < 0;  enImporte = 0;  |FINSI;

         enSwAcum  = 0;
         enBloque  = 7;
         eaCasilla = "184";
         |HAZ GrabaLineal;
     |FINSI;
|FPRC;

|PROCESO Ded_32_3;
     |SI #rem01018@#29 ! "S";  |ACABA;  |FINSI;

     |SI enConta > 6;
         enSwAcum  = 0;
         enBloque  = 5;
         eaCasilla = "129";
         enImporte = enVal129Tit + enVal129Con;
         |HAZ GrabaLineal;

         |ACABA;
     |FINSI;

     enBloque = 5;  eaCasilla = "126"; |HAZ SacaImporte;  nValor = enImporte;
     enBloque = 5;  eaCasilla = "127"; |HAZ SacaImporte;  nValor = nValor - enImporte;
     enBloque = 5;  eaCasilla = "128"; |HAZ SacaImporte;  nValor = nValor - enImporte;

     |SI nValor > 0;
         enImporte = nValor % 20;
         |SI enImporte > 20000;
             enImporte = 20000;
         |FINSI;
     |SINO;
         enImporte = 0;
     |FINSI;

     |SI enConta = 1;
         enVal129Tit = enImporte;
     |FINSI;

     |SI enConta = 2;
         enVal129Con = enImporte;
     |FINSI;

     enSwAcum  = 0;
     enBloque  = 5;
     eaCasilla = "129";
     |HAZ GrabaLineal;
|FPRC;

|PROCESO TotActividad;
     enBloque = 5;  eaCasilla = "126"; |HAZ SacaImporte; nValor = enImporte;
     enBloque = 5;  eaCasilla = "127"; |HAZ SacaImporte; nValor = nValor - enImporte;
     enBloque = 5;  eaCasilla = "128"; |HAZ SacaImporte; nValor = nValor - enImporte;
     enBloque = 5;  eaCasilla = "129"; |HAZ SacaImporte; nValor = nValor - enImporte;

     enBloque = 5;  eaCasilla = "126"; |HAZ SacaImporte;
     |SI enImporte ] 0;
         |SI nValor < 0;  nValor = 0;   |FINSI;
     |FINSI;

     enSwAcum  = 0;
     enBloque  = 5;
     eaCasilla = "130";
     enImporte = nValor;
     |HAZ GrabaLineal;

     enBloque = 6;  eaCasilla = "153"; |HAZ SacaImporte; nValor = enImporte;
     enBloque = 6;  eaCasilla = "154"; |HAZ SacaImporte; nValor = nValor - enImporte;

     enBloque = 6;  eaCasilla = "153"; |HAZ SacaImporte;
     |SI enImporte ] 0;
         |SI nValor < 0;  nValor = 0;   |FINSI;
     |FINSI;

     enSwAcum  = 0;
     enBloque  = 6;
     eaCasilla = "155";
     enImporte = nValor;
     |HAZ GrabaLineal;

     enBloque = 7;  eaCasilla = "183"; |HAZ SacaImporte; nValor = enImporte;
     enBloque = 7;  eaCasilla = "184"; |HAZ SacaImporte; nValor = nValor - enImporte;

     enBloque = 7;  eaCasilla = "183"; |HAZ SacaImporte;
     |SI enImporte ] 0;
         |SI nValor < 0;  nValor = 0;   |FINSI;
     |FINSI;

     enSwAcum  = 0;
     enBloque  = 7;
     eaCasilla = "185";
     enImporte = nValor;
     |HAZ GrabaLineal;
|FPRC;

|PROCESO rem01022;
     |SI nVal127 = 0;
         nRdto = 0;
         |SI nTotRenta < 8000;
             nRdto = 1620;
         |SINO;
             |SI nTotRenta < 12000;
                 nRdto = (N\ 1620 - (0.405 * (nTotRenta - 8000)));
             |FINSI;
         |FINSI;

         |SI #rem01010@#22 > 3700;
             nRdto = 0;
         |SINO;
             nSuma = #rem01010@#22 + nRdto;
             |SI nSuma > 3700;
                 nRdto = 3700 - #rem01010@#22;
             |FINSI;
         |FINSI;

         nValor = #rem01022@#21;
         |SI nValor > 0;
             enImporte = ((nRdto / #rem01018@#33) * nValor) ! 2;
             |SI enImporte > nValor;
                 enImporte = nValor;
             |FINSI;

             |SI enImporte < 0;  enImporte = 0;  |FINSI;

             #rem01022@#39 = enImporte;
             #rem01022@#21 = (N\ #rem01022@#18 - #rem01022@#19 - #rem01022@#37);
             #rem01022@#21 = (N\ #rem01022@#21 - #rem01022@#38 - #rem01022@#39);
         |FINSI;
     |FINSI;

     |SI #rem01022@#36 = "S";
         #rem01022@#40 = (N\ (#rem01022@#21 % 20));
     |FINSI;

     #rem01022@#21 = (N\ #rem01022@#18 - #rem01022@#19 - #rem01022@#37);
     #rem01022@#21 = (N\ #rem01022@#21 - #rem01022@#38 - #rem01022@#39);
     #rem01022@#21 = (N\ #rem01022@#21 - #rem01022@#40);

     |GRABA 020#rem01022@.a;
     |LIBERA #rem01022@;

     #rem01026@#0 = #refere1@#0;
     #rem01026@#1 = #refere1@#1;
     #rem01026@#2 = #refere1@#2;
     |LEE 101#rem01026@.=;
     |SI FSalida ! 0;
         |DDEFECTO #rem01026@;
         #rem01026@#0 = #refere1@#0;
         #rem01026@#1 = #refere1@#1;
         #rem01026@#2 = #refere1@#2;
         |GRABA 020#rem01026@.b;
     |FINSI;

     #rem01026@#7   = (N\ #rem01026@#7 + #rem01022@#21);
     |GRABA 020#rem01026@.a;
     |LIBERA #rem01026@;

     enSwAcum  = 0;
     enBloque  = 8;
     eaCasilla = "226";  enImporte = #rem01026@#7;   |HAZ GrabaLineal;
|FPRC;

|DEFBUCLE rem01022;
     #rem01022@#1004;
     ;
     #refere1@#0, #refere1@#1, #refere1@#2, 001;
     #refere1@#0, #refere1@#1, #refere1@#2, 999;
     be;
     NULL, rem01022;
|FIN;

|PROCESO Ded_32_2_3_Comuneros;
     enBloque = 5;  eaCasilla = "127"; |HAZ SacaImporte;
     nVal127  = enImporte;

     aDef    = eaPathDef + "rem01022.mas";
     |CARGA_DEF aDef, rem01022@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #rem01022@#"zdat1022"#;  |FINSI;

     aDef    = eaPathDef + "rem01026.mas";
     |CARGA_DEF aDef, rem01026@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #rem01022@;

         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #rem01026@#"zdat1026"#;  |FINSI;

     |ABRE #rem01026@;
     |BUCLE rem01022;
     |CIERRA #rem01026@;

     |DESCARGA_DEF #rem01026@;
     |DESCARGA_DEF #rem01022@;
|FPRC;

|PROCESO CalculaA;
     aDef    = eaPathDef + "rem01010.mas";
     |CARGA_DEF aDef, rem01010@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #rem01010@#"zdat1010"#;  |FINSI;

     aDef    = eaPathDef + "rem01033.mas";
     |CARGA_DEF aDef, rem01033@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |DESCARGA_DEF #rem01010@;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #rem01033@#"zdat1033"#;  |FINSI;

     aDef    = eaPathDef + "rem01018.mas";
     |CARGA_DEF aDef, rem01018@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |DESCARGA_DEF #rem01033@;
         |DESCARGA_DEF #rem01010@;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #rem01018@#"zdat1018"#;  |FINSI;

     |ABRE #rew99999;
     |SELECT #2#rew99999;
     #rew99999#1 = #refere1@#2;
     |LEE 040#rew99999.=;
     |SI FSalida  ! 0;  |DDEFECTO #rew99999;  |FINSI;
     |CIERRA #rew99999;

     |ABRE #rem01010@;
     #rem01010@#0 = #refere1@#0;
     #rem01010@#1 = #refere1@#1;
     #rem01010@#2 = #refere1@#2;
     |LEE 040#rem01010@.=;
     |SI FSalida ! 0;
         |DDEFECTO #rem01010@;
         #rem01010@#0 = #refere1@#0;
         #rem01010@#1 = #refere1@#1;
         #rem01010@#2 = #refere1@#2;
         |GRABA 020#rem01010@.b;
     |FINSI;

     |ABRE #rem01033@;
     #rem01033@#0 = #refere1@#0;
     #rem01033@#1 = #refere1@#1;
     #rem01033@#2 = #refere1@#2;
     |LEE 000#rem01033@.=;
     |SI FSalida ! 0;  |DDEFECTO #rem01033@;  |FINSI;
     |CIERRA #rem01033@;

     |ABRE #rem01018@;
     |DDEFECTO #rem01018@;
     #rem01018@#0 = #refere1@#0;
     #rem01018@#1 = #refere1@#1;
     #rem01018@#2 = #refere1@#2;
     |LEE 101#rem01018@.=;
     |SI FSalida = 0;
         |SI #rem01018@#3 < 0;  #rem01018@#3 = 0;  |FINSI;
         |SI #rem01018@#4 < 0;  #rem01018@#4 = 0;  |FINSI;
         |SI #rem01018@#5 < 0;  #rem01018@#5 = 0;  |FINSI;
         |SI #rem01018@#6 < 0;  #rem01018@#6 = 0;  |FINSI;

         #rem01018@#33 = #rem01018@#3 + #rem01018@#4 + #rem01018@#5 + #rem01018@#6;

         |GRABA 020#rem01018@.a;
         |LIBERA #rem01018@;
     |FINSI;
     |CIERRA #rem01018@;

     nTotRenta = 0;
     enBloque = 2;  eaCasilla = "033"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 3;  eaCasilla = "046"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 4;  eaCasilla = "075"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 8;  eaCasilla = "223"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 8;  eaCasilla = "224"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 8;  eaCasilla = "227"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 8;  eaCasilla = "228"; |HAZ SacaImporte; nTotRenta = nTotRenta - enImporte;
     enBloque = 8;  eaCasilla = "230"; |HAZ SacaImporte; nTotRenta = nTotRenta - enImporte;
     enBloque = 9;  eaCasilla = "240"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 10; eaCasilla = "244"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 11; eaCasilla = "248"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 12; eaCasilla = "252"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 26; eaCasilla = "378"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 26; eaCasilla = "379"; |HAZ SacaImporte; nTotRenta = nTotRenta - enImporte;
     enBloque = 27; eaCasilla = "382"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;
     enBloque = 27; eaCasilla = "383"; |HAZ SacaImporte; nTotRenta = nTotRenta - enImporte;

     nTotRenta    = nTotRenta + #rem01018@#14;   || Suma de mayor de 65 y 68
     nTotRenta    = nTotRenta + #rem01018@#7;    || 118
     nTotRenta    = nTotRenta + #rem01018@#11;   || 143
     nTotRenta    = nTotRenta + #rem01018@#13;   || 172
     nTotRenta    = nTotRenta + #rem01018@#8;    || 185 + #191 + 195
     nTotRenta    = nTotRenta + #rem01018@#9;    || 201

     |SI enConta = 3;  enRentas3 = enRentas3 + #rem01010@#17; |FINSI;
     |SI enConta = 4;  enRentas4 = enRentas4 + #rem01010@#17; |FINSI;
     |SI enConta = 5;  enRentas5 = enRentas5 + #rem01010@#17; |FINSI;
     |SI enConta = 6;  enRentas6 = enRentas6 + #rem01010@#17; |FINSI;

     nRdto = 0;
     |SI #rem01010@#17 > 0;
         |SI #rem01010@#17 [ 14450; |Y nTotRenta < 6500.01;
             |SI #rem01010@#17 < 11250;
                 nRdto = 3700;
             |SINO;
                 |SI #rem01010@#17 ] 11250;  |Y #rem01010@#17 [ 14450;
                     nRdto = (3700 - (1.15625 * (#rem01010@#17 - 11250))) ! 2;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     nRdtoMov = 0;
     |SI #rem01010@#17 > 0;
         nRdtoMov = 2652;

         |SI #rem01010@#17 [ 13260; |Y nTotRenta < 6500.01;
             |SI #rem01010@#17 < 9180;
                 nRdtoMov = 4080;
             |SINO;
                 |SI #rem01010@#17 ] 9180;  |Y #rem01010@#17 [ 13260;
                     nRdtoMov = (4080 - (0.35 * (#rem01010@#17 - 9180))) ! 2;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     enCam22      = nRdto;
     #rem01010@#18 = 2000;

     enBloque = 1;  eaCasilla = "015"; |HAZ SacaImporte;
     |SI enImporte < 0;
         #rem01010@#18 = 0;
         #rem01010@#19 = 0;
         #rem01010@#20 = 0;
     |SINO;
         nSuma = enImporte;
         |SI #rem01010@#18 ] nSuma;
             #rem01010@#18 = nSuma;
             nSuma = 0;
         |SINO;
             nSuma = nSuma - #rem01010@#18;
         |FINSI;

         |SI nSuma > 0;
             |SI #rem01010@#19 ] nSuma;
                 #rem01010@#19 = nSuma;
                 nSuma = 0;
             |SINO;
                 nSuma = nSuma - #rem01010@#19;
             |FINSI;
         |SINO;
             #rem01010@#19 = 0;
         |FINSI;

         |SI nSuma > 0;
             |SI #rem01010@#20 ] nSuma;
                 #rem01010@#20 = nSuma;
                 nSuma = 0;
             |SINO;
                 nSuma = nSuma - #rem01010@#20;
             |FINSI;
         |SINO;
             #rem01010@#20 = 0;
         |FINSI;
     |FINSI;

     #rem01010@#21 = (N\ #rem01010@#17 - #rem01010@#18 - #rem01010@#19 - #rem01010@#20);

     |SI enCam22 > #rem01010@#21;
         enCam22 = #rem01010@#21;
     |FINSI;

     #rem01010@#22 = enCam22;
     |SI #rem01010@#22 < 0;  #rem01010@#22 = 0;  |FINSI;

     |SI #rem01010@#21 < 0;
         #rem01010@#9  = 0;
         #rem01010@#22 = 0;
     |SINO;
         nSuma  = #rem01010@#21 + #rem01010@#9;

         |SI #rem01010@#22 ] nSuma;
             #rem01010@#22 = nSuma;
             nSuma = 0;
         |SINO;
             nSuma = nSuma - #rem01010@#22;
         |FINSI;
     |FINSI;

     #rem01010@#24 = (N\ #rem01010@#21 - #rem01010@#22);
     |SI #rem01010@#24 < 0;  |Y #rem01010@#21 ] 0;
         #rem01010@#24 = 0;
     |FINSI;

     |GRABA 020#rem01010@.a;
     |LIBERA #rem01010@;
     |CIERRA #rem01010@;

     enSwAcum  = 0;
     enBloque  = 1;
     eaCasilla = "016";  enImporte = #rem01010@#18;  |HAZ GrabaLineal;
     eaCasilla = "017";  enImporte = #rem01010@#19;  |HAZ GrabaLineal;
     eaCasilla = "018";  enImporte = #rem01010@#20;  |HAZ GrabaLineal;
     eaCasilla = "019";  enImporte = #rem01010@#21;  |HAZ GrabaLineal;
     eaCasilla = "020";  enImporte = #rem01010@#22;  |HAZ GrabaLineal;
     eaCasilla = "021";  enImporte = #rem01010@#24;  |HAZ GrabaLineal;

     || Y ahora suma los dtos. del trabajo que antes no pasaba.
     enBloque = 1;  eaCasilla = "019"; |HAZ SacaImporte; nTotRenta = nTotRenta + enImporte;

     |HAZ Ded_32_2_1;
     |HAZ Ded_32_2_3;
     |HAZ Ded_32_3;
     |HAZ TotActividad;
     |HAZ Ded_32_2_3_Comuneros;

     |DESCARGA_DEF #rem01018@;
     |DESCARGA_DEF #rem01033@;
     |DESCARGA_DEF #rem01010@;
|FPRC;
