|FICHEROS;
     gecom001 #1;
     gecom011 #11;
     gecom014 #14;
     gecom018 #18;
     gecow006 #906;

     :/dsoporte/def/dsprem07 #107;
|FIN;

|VARIABLES;
     nPanta0        = 0;
     nBoton1_1      = 0;
     nCampoD        = 0;
     nCampoH        = 0;
     nCampoHasta    = 0;
     nUsu           = 0;
     nLong          = 0;
     nCaracter      = 0;
     nPos           = 0;
     nCamuf         = 0;
     nNum           = 0;
     nHandle        = 0;
     nReg           = 0;
     nCampo         = 0;
     nNume          = 0;
     nEmpresa       = 0;
     nServidor      = 0;

     aAlfa          = "";
     aAlfa1         = "";
     aAlfa2         = "";
     aServidor      = "";
     aAbre          = "";
     aLinea         = "";
     aDirSer        = "";
     aDirPues       = "";
     aShell         = "";
     aOperacion     = "";
     aDOperacion    = "";
     aBase          = "";
     aMas           = "";
     aHora          = "";
     aFic           = "";
     aFich          = "";
     aDirec         = "";
     aPathDSoporte  = "";
     aPassw         = "";
     aBaseDigital = "";
     aDirectorio  = "";
     aBaseMensaje = "";
     aTo          = "";
     aIP          = "";
     aSalida      = "";
     aFrom        = "";
     aAsunto      = "";
     aMensaje     = "";
     aAdjunto     = "";
     aReferencia  = "";

     fFecha         = @;

     &enCliente     = 0;
     &enDelega      = 0;
     &eaUsuario     = "";
     &enModo        = 0;
     &eaPass        = "";
     &eaPassEnc     = "";
     &eaIPDSCorreo  = "";
     &eaSPA         = "";

    {1}aLocal       = "";

     aCarpeta = "";
     aCliente = "";
|FIN;

|PROCESO Tipo66Area;   |TIPO 66;
     |ABRE #107;
     #107#0 = #906#11;
     #107#1 = #906#12;
     |LEE 000#107=;
     |SI FSalida ! 0;  |DDEFECTO #107;  |FINSI;

     |CONSULTA_CLAVE #1#107;
     |SI FSalida = 0;
         #906#11 = #107#0;  |PINTA #906#11;
         #906#12 = #107#1;  |PINTA #906#12;
         #906#13 = #107#2;  |PINTA #906#13;
         #906#14 = #107#3;  |PINTA #906#14;
     |FINSI;
     |CIERRA #107;
|FPRC;

|PROCESO PintaAreaNivel;   |TIPO 0;
     |ABRE #107;
     #107#0 = #906#11;
     #107#1 = #906#12;
     |LEE 000#107=;
     |SI FSalida ! 0;
         |MENAV "0000 Area-Nivel Inexistente.";
         |ERROR;
         |ACABA;
     |FINSI;
     |CIERRA #107;

     #906#13 = #107#2;  |PINTA #906#13;
     #906#14 = #107#3;  |PINTA #906#14;
|FPRC;

|PROCESO GrabaUsuario;
     |ABRE #14;
     #14#0  = #906#0;
     #14#1  = #906#2;
     #14#14 = #906#15;
     |LEE 101#14=;
     |SI FSalida ! 0;
         |DDEFECTO #14;
         #14#0  = #906#0;
         #14#1  = #906#2;
         #14#14 = #906#15;
         |GRABA 020#14b;
     |FINSI;

     |PARA nCampoD = 2;  |SI nCampoD [ nCampoHasta;  |HACIENDO nCampoD = nCampoD + 1;
           nCampoH    = nCampoD + 1;
           #14nCampoD = #906nCampoH;
     |SIGUE;

     #14#15 = #906#17;

     |GRABA 020#14a;
     |LIBERA #14;
     |CIERRA #14;

     eaUsuario = #14#1;
|FPRC;

|PROCESO Tipo0C2w6;
     |SI enModo ! 1;  |ACABA;  |FINSI;

     |SI #906#2 = "          ";
         |MENAV "0000 Usuario sin Contenido.";
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #906#2 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #906#2 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     |ABRE #14;
     |SELECT #2#14;
     #14#1 = #906#2;
     |LEE 040#14=;
     |SI FSalida = 0;
         |MENAV "0000 El Usuario ya esta definido. Elija otro nombre.";
         |ERROR;
     |FINSI;
     |SELECT #1#14;
     |CIERRA #14;

     |ABRE #1;
     |SELECT #3#1;
     #1#4 = #906#2;
     |LEE 040#1=;
     |SI FSalida = 0;
         |MENAV "0000 El Usuario ya esta definido como Administrador. Elija otro nombre.";
         |ERROR;
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO Mac;  |TIPO 7;
     |DBASS aBaseDigital;  |QBF aBaseDigital;

     aCarpeta = aBaseDigital % -201;

     aCliente = #11#1;
     aCliente = ("00" + aCliente) % -102;

     aServidor = aBaseDigital % -303;   |QBF aServidor;
     nServidor = aServidor;
     |SI nServidor = 0;   aServidor = "001";  |FINSI;
     |SI aServidor = "";  aServidor = "001";  |FINSI;

     eaPass = aCarpeta + aCliente + "01" + aServidor + #906#2;
     |HAZ EncriptaMAC;

     #906#5 = eaPassEnc;  |PINTA #906#5;

     aAlfa = #906#7;  |QBF aAlfa;
     |SI aAlfa = "";
         |ESTADO_CONTROL nBoton1_1, "DISABLE";
     |SINO;
         aAlfa = #906#5;  |QBF aAlfa;
         |SI aAlfa = "";
             |ESTADO_CONTROL nBoton1_1, "DISABLE";
         |SINO;
             |ESTADO_CONTROL nBoton1_1, "ENABLE";
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo7C7w6;  |TIPO 7;
     aAlfa = #906#7;  |QBF aAlfa;
     |SI aAlfa = "";
         #906#7 = #11#17;  |PINTA #906#7;
     |FINSI;
|FPRC;

|PROCESO Tipo0C7w6;
     |SI FSalida = 10;
         aAlfa = "0000 La clave es " + #906#4;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aPassw   = #906#4;
     E_inf    = "";
     E_sup    = "10";
     aPassw   = 1545 ? -1;

     |PINTA 1545, "*****************";

     |SI #906#4 ! aPassw;  |Y #906#4 ! "          ";
         |CONFI "0000NHas cambiado la Clave de Acceso que teniamos antes, Desea Continuar";
         |SI FSalida ! 0;
             |ERROR;
             |ACABA;
         |FINSI;

         #906#17 = "N";
     |FINSI;

     #906#4 = aPassw;

     aAlfa = #906#4 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #906#4 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Tipo0C9w6;  |TIPO 0;
     |SI Campo = 9;
         |SI #906#9 < 0;  |O #906#9 > 23;
             |ERROR;
         |FINSI;
     |FINSI;

     |SI Campo = 10;
         |SI #906#10 < 0;  |O #906#10 > 59;
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo12w6;  |TIPO 12;
|FPRC;

|PROCESO CuerpoMensaje;
     |DBASS aBaseDigital;  |QBF aBaseDigital;

     aServidor   = aBaseDigital % -303;  |QBF aServidor;
     aDirectorio = aBaseDigital % -201;  |QBF aDirectorio;
     aReferencia = aBaseDigital % -207;

     nNum = aServidor;
     |SI nNum        = 0;   aServidor   = "001";  |FINSI;
     |SI aServidor   = "";  aServidor   = "001";  |FINSI;
     |SI aDirectorio = "";  aDirectorio = "1";    |FINSI;

     |DBASE aBaseMensaje;  |QBF aBase;
     aAbre    = aBaseMensaje + "correos";  |MKDIR aAbre;
     aAbre    = aAbre + "/adjunto.txt";
     |XABRE "WB", aAbre, nHandle;

     eaSPA = "DS, S.L.";

     aAlfa = eaSPA + " le agradece la confianza depositada en nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "A continuación se le indica el enlace para obtener acceso a las ";
     aAlfa = aAlfa + "aplicaciones GECONET a través del portal de acceso." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Usuario:                   " + #906#2 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa =  "Password:                  " + #906#4 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     eaPass = #906#7;  |HAZ EncriptaMAC;

     aAlfa = "Pinche en http  " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "http://www.geconet.net/portal/";
     aAlfa = aAlfa + "crearAcceso.php?claveGeconet=" + #906#5;  |QBF aAlfa;
     aAlfa = aAlfa + "&email=" + eaPassEnc;  |QBF aAlfa;
     |XGRABA nHandle, aAlfa;

     eaPass    = "";
     eaPassEnc = "";

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Para cualquier aclaración o duda no dude en ponerse en contacto con nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa =  "Este correo electrónico y, en su caso, cualquier fichero anexo al mismo, contiene";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "información de carácter confidencial exclusivamente dirigida a su destinatario o";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "destinatarios. Queda prohibida su divulgación, copia o distribución a terceros sin la";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "previa autorización escrita de la empresa. En el caso de haber recibido este correo";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "electrónico por error, se ruega  notifíquese inmediatamente esta circunstancia mediante";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "reenvío a la dirección electrónica del remitente y proceda a su destrucción.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = "El consumo de papel es perjudicial para el medio ambiente. Por favor téngalo en cuenta";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "antes de imprimir este mensaje.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO Boton1_1;
     aTo = #906#7;  |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     |HAZ CuerpoMensaje;
     |HAZ IPDSCorreo;

     aIP      = eaIPDSCorreo;
     aSalida  = "asmtp.diagram.es";  |QBF aSalida;
     aFrom    = "soporte@diagram.es";
     aAsunto  = "Acceso para el uso de las aplicaciones GECONET";
     aMensaje = "$$$$" + aAbre;
     aAdjunto = aAbre;

     |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error en el envio del correo, revise el e_mail del usuario.";
     |SINO;
         |MENAV "0000 Correo enviado.";
     |FINSI;

/*
     |DBASS aDirSer;   |QBF aDirSer;
     aDirSer = aDirSer + "dsoporte/dsmail.exe";

     |ESPECIFICA "RBASS", aLocal
     aDirPues = aLocal;  |QBF aDirPues;
     aDirPues = aDirPues + "bin/dsmail.exe";

     |ENVIA_FICHERO aDirSer, aDirPues;

     aAlfa   = #906#7;  |QBF aAlfa;
     aAlfa1  = #906#2;  |QBF aAlfa1;
     aAlfa2  = #906#4;  |QBF aAlfa2;
     |SI aAlfa = "";
         aShell = aDirPues + " ' '" + #906#5 +"'" + aAlfa1 +"'" + aAlfa2 + "'";
     |SINO;
         aShell = aDirPues + " '" + aAlfa + "'" + #906#5 +"'" + aAlfa1 +"'" + aAlfa2 + "'";
     |FINSI;
     |RSYSTEM aShell;
*/
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     |DBASS aBase;  |QBF aBase;
     aPathDSoporte = aBase + "dsoporte/fich/";
     |PATH_DAT #107 aPathDSoporte;

     FSalida = 2799;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
|FPRC;

|PROGRAMA;
     nCampoHasta    = 13;

     |C_M #906#2, 1, "S";

     |ABRE #11;
     #11#0 = enCliente;
     |LEE 000#11=;
     |SI FSalida ! 0;  |DDEFECTO #11; |FINSI;
     |CIERRA #11;

     |ABRE #18;
     #18#0 = enCliente;
     #18#1 = enDelega;
     |LEE 000#18=;
     |SI FSalida ! 0;  |DDEFECTO #18; |FINSI;
     |CIERRA #18;

     |DDEFECTO #906;
     #906#0  = #11#0;
     #906#1  = #11#2;
     #906#15 = #18#1;
     #906#16 = #18#2;

     |ABRE #14;
     |SI enModo ! 1;
         #14#0  = #906#0;
         #14#14 = #906#15;
         #14#1  = eaUsuario;
         |LEE 101#14=;
         |SI FSalida ! 0;  |DDEFECTO #14; |FINSI;

         |PARA nCampoD = 1;  |SI nCampoD [ nCampoHasta;  |HACIENDO nCampoD = nCampoD + 1;
               nCampoH     = nCampoD + 1;
               #906nCampoH = #14nCampoD;
         |SIGUE;

         #906#17 = #14#15;

         |C_M #906#2, 1, "N";
     |FINSI;
     |CIERRA #14;

     |CABEZA "Usuarios";

     |PINPA #0#906;  nPanta0 = FSalida;
     |PINDA #0#906;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{137}} Enviar claves por correo", 2430, 2660, Boton1_1;
     nBoton1_1 = FSalida;

     aAlfa = #906#7;  |QBF aAlfa;
     |SI aAlfa = "";
         |ESTADO_CONTROL nBoton1_1, "DISABLE";
     |SINO;
         aAlfa = #906#5;  |QBF aAlfa;
         |SI aAlfa = "";
             |ESTADO_CONTROL nBoton1_1, "DISABLE";
         |SINO;
             |ESTADO_CONTROL nBoton1_1, "ENABLE";
         |FINSI;
     |FINSI;

     |SI enModo = 1;  |ENDATOS #1#906;  |FINSI;
     |SI enModo = 2;  |ENDATOS #2#906;  |FINSI;

     |SI FSalida = 0;
         |HAZ GrabaUsuario;
     |FINSI;

     |FIN_CONTROL_WINDOWS nBoton1_1;

     |PULSATECLA;
|FPRO;
