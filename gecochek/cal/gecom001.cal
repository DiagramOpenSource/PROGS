|FICHEROS;
     gecom001 #0;
     :/dsoporte/def/dsprem01 #1;
     :/dsoporte/def/dsprem04 #4;
     :/dsoporte/def/dsprem05 #5;
     :/dsoporte/def/dsprem06 #6;
     :/dsoporte/def/dsprem99 #99;
     :/dsoporte/def/dsorm001 #101;

     gecom001@ #900;
|FIN;

|VARIABLES;
     aBase       = "";
     aFic        = "";
     aMas        = "";
     aClave      = "";
     aLong       = "";
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";
     aHora       = "";
     aOperacion  = "";
     aDOperacion = "";
     aServidor   = "";
     aAbre       = "";
     aLinea      = "";
     aMac        = "";
     aDirSer     = "";
     aDirPues    = "";
     aShell      = "";
     aPassw      = "";
     aBaseDigital = "";
     aDirectorio  = "";
     aBaseMensaje = "";
     aTo          = "";
     aIP          = "";
     aSalida      = "";
     aFrom        = "";
     aAsunto      = "";
     aMensaje     = "";
     aAdjunto     = "";
     aReferencia  = "";

     nLong       = 0;
     nPos        = 0;
     nCamuf      = 0;
     nNum        = 0;
     nCaracter   = 0;
     nModo       = 0;
     nForma      = 0;
     nReg        = 0;
     nHandle     = 0;
     nInstalar   = 0;
     nVentana    = 0;
     nBoton1     = -1;

    {1}aLocal    = "";

     &eaPass     = "";
     &eaPassEnc  = "";
     &eaIPDSCorreo = "";
     &eaSPA        = "";
|FIN;

|PROCESO Tipo0C0;  |TIPO 0;
     |SI #0#0 > 99999;
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Usuario;
     |SI #0#4 = "          ";
         |MENAV "0000 Usuario sin Contenido.";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI FSalida = 10;
         aAlfa = "0000 La clave es " + #0#5;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #0#4 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #0#4 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     |ABRE #4;
     |SELECT #2#4;
     #4#5 = #0#4;
     |LEE 000#4=;
     |SI FSalida = 0;
         |MENAV "0000 El Codigo de Usuario ya esta siendo usado en Definicion de Usuarios";
         |ERROR;
         |CIERRA #4;
         |ACABA;
     |FINSI;
     |CIERRA #4;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/gecom001.mas";
     |CARGA_DEF aMas, gecom001@;
     |SI FSalida ! 0;
         |MENAV "0000 Error en Cargar el Def gecom001.mas";
         |ERROR;
         |ACABA;
     |FINSI;

     |ABRE #900;
     |SELECT #3#900;
     #900#4 = #0#4;
     |LEE 000#900=;
     |SI FSalida = 0;  |Y #900#0 ! #0#0;
         |MENAV "0000 El Codigo de Usuario ya esta siendo usado en este mismo Mantenimiento.";
         |ERROR;
     |FINSI;
     |CIERRA #900;

     |DESCARGA_DEF #gecom001@;
|FPRC;

|PROCESO NoValido;
     aPassw   = #0#5;
     E_inf    = "";
     E_sup    = "10";
     aPassw   = 1640 ? -1;

     |PINTA 1640, "*****************";

     |SI #0#5 ! aPassw;  |Y #0#5 ! "          ";
         |CONFI "0000NHas cambiado la Clave de Acceso que teniamos antes, Desea Continuar";
         |SI FSalida ! 0;
             |ERROR;
             |ACABA;
         |FINSI;

         #0#17 = "N";
     |FINSI;

     #0#5     = aPassw;

     aAlfa = #0#5 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #0#5 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO CuerpoMensaje;
     |DBASS aBaseDigital;  |QBF aBaseDigital;

     aServidor   = aBaseDigital % -303;  |QBF aServidor;
     aDirectorio = aBaseDigital % -201;  |QBF aDirectorio;
     aReferencia = aBaseDigital % -207;

     nNum = aServidor;
     |SI nNum        = 0;   aServidor   = "001";  |FINSI;
     |SI aServidor   = "";  aServidor   = "001";  |FINSI;
     |SI aDirectorio = "";  aDirectorio = "1";    |FINSI;

     |DBASE aBaseMensaje;  |QBF aBase;
     aAbre    = aBaseMensaje + "correos";  |MKDIR aAbre;
     aAbre    = aAbre + "/adjunto.txt";
     |XABRE "WB", aAbre, nHandle;

     eaSPA = "DS, S.L.";

     aAlfa = eaSPA + " le agradece la confianza depositada en nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "A continuación se le indica el enlace para obtener acceso a las ";
     aAlfa = aAlfa + "aplicaciones GECONET a través del portal de acceso." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Usuario:                   " + #0#4 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa =  "Password:                  " + #0#5 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     eaPass = #0#2;  |HAZ EncriptaMAC;

     aAlfa = "Pinche en http  " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "http://www.geconet.net/portal/";
     aAlfa = aAlfa + "crearAcceso.php?claveGeconet=" + #0#6;  |QBF aAlfa;
     aAlfa = aAlfa + "&email=" + eaPassEnc;  |QBF aAlfa;
     |XGRABA nHandle, aAlfa;

     eaPass    = "";
     eaPassEnc = "";

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Para cualquier aclaración o duda no dude en ponerse en contacto con nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa =  "Este correo electrónico y, en su caso, cualquier fichero anexo al mismo, contiene";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "información de carácter confidencial exclusivamente dirigida a su destinatario o";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "destinatarios. Queda prohibida su divulgación, copia o distribución a terceros sin la";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "previa autorización escrita de la empresa. En el caso de haber recibido este correo";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "electrónico por error, se ruega  notifíquese inmediatamente esta circunstancia mediante";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "reenvío a la dirección electrónica del remitente y proceda a su destrucción.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = "El consumo de papel es perjudicial para el medio ambiente. Por favor téngalo en cuenta";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "antes de imprimir este mensaje.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;


|PROCESO EnviaCorreo;
     aTo = #0#2;  |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     |CONFI "0000SEnviar claves por correo?";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ CuerpoMensaje;
     |HAZ IPDSCorreo;

     aIP      = eaIPDSCorreo;
     aSalida  = "asmtp.diagram.es";  |QBF aSalida;
     aFrom    = "soporte@diagram.es";
     aAsunto  = "Acceso para el uso de las aplicaciones GECONET";
     aMensaje = "$$$$" + aAbre;
     aAdjunto = aAbre;

     |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error en el envio del correo, revise el e_mail del usuario.";
     |SINO;
         |MENAV "0000 Correo enviado.";
     |FINSI;
|FPRC;

|PROCESO GrabaMac;  |TIPO 7;
     aMac = #0#6;

     |DBASS aBase;  |QBF aBase;
     aAlfa     = aBase % -201;
     aServidor = aBase % -303;  |QBF aServidor;
     nNum      = aServidor;

     |SI nNum      = 0;   aServidor = "001";  |FINSI;
     |SI aServidor = "";  aServidor = "001";  |FINSI;

     eaPass = aAlfa + "0000" + aServidor + #0#4;
     |HAZ EncriptaMAC;

     #0#6 = eaPassEnc;  |PINTA #0#6;

     |SI aMac ! #0#6;
         |HAZ EnviaCorreo;
     |FINSI;
|FPRC;

|PROCESO Tipo2;  |TIPO 2;
     nModo     = (FEntrada / 100) ! 0;
     nForma    = 0 +. 1;
     nInstalar = 1;

     |SI nModo = 3;
         aOperacion  = "B";
         aDOperacion = "BAJA DEL USUARIO";
     |FINSI;

     |SI nModo = 1;
         aOperacion  = "A";
         aDOperacion = "ALTA DEL USUARIO";
     |FINSI;

     |SI nModo = 2;
         |SI nForma ! 1;
             aOperacion  = "M";
             aDOperacion = "ENTRADA MODIFICACION DEL USUARIO";
         |FINSI;

         |SI nForma = 1;
             aOperacion  = "M";
             aDOperacion = "SALIDA MODIFICACION DEL USUARIO";
         |FINSI;
     |FINSI;

     |HORA aHora;

     |ABRE #99;
     nReg = 1;
     |LEE 000#99u;
     |SI FSalida = 0;
         nReg = #99#0 + 1;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aAlfa = aBase % -201;

     |ABRE #1;
     #1#0 = aAlfa;
     |LEE 000#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     #99#0  = nReg;
     |GRABA 020#99b;

     #99#1  = #0#4;
     #99#2  = ~;
     #99#3  = aHora;
     #99#4  = aOperacion;
     #99#5  = aDOperacion;
     #99#6  = aAlfa + "0000";
     #99#7  = #0#7;
     #99#8  = #0#9;
     #99#9  = #1#1;
     #99#10 = "AUDITOR";
     #99#11 = "AUDITOR";
     #99#12 = #0#8;
     #99#13 = #0#10;
     aAlfa  = #99#6 + " " + #0#8;  |QBF aAlfa;
     aAlfa  = aAlfa + #0#10;
     #99#14 = aAlfa;
     #99#15 = "N";
     #99#16 = "N";
     #99#17 = #0#6;
     #99#18 = 9999;
     #99#19 = #0#11;
     #99#20 = Usuario % 810;
     |GRABA 020#99a;
     |LIBERA #99;
     |CIERRA #99;

     |ABRE #101;
     |SI #0#12 = 0;
         #101#0 = 9999;
         |LEE 000#101];
         |SI FSalida = 0;
             |LEE 000#101a;
         |SINO;
             |LEE 000#101u;
         |FINSI;

         #0#12 = 9000;
         |SI FSalida = 0; |Y  #101#0 ] 9000;
             #0#12 = #101#0 + 1;
         |FINSI;
     |FINSI;

     |SI nModo = 3;
         #101#0 = #0#12;
         |LEE 101#101=;
         |SI FSalida = 0;
             |BORRA 020#101a;
             |LIBERA #101;
         |FINSI;
      |SINO;
         #101#0 = #0#12;
         |LEE 101#101=;
         |SI FSalida ! 0;
             |DDEFECTO #101;
             #101#0 = #0#12;
             |GRABA 020#101b;
         |FINSI;
         #101#1 = "AUDITOR: " + #0#1;
         |GRABA 020#101a;
         |LIBERA #101;
     |FINSI;
     |CIERRA #101;
|FPRC;

|PROCESO Tipo14;  |TIPO 14;
     |SI nBoton1 = -1;
         |CONTROL_SIMPLE 1, "BOTON,{{135}}Enviar Correo", 1778, 1798, EnviaCorreo;
         nBoton1 = FSalida;
     |FINSI;

     aAlfa = #0#2;  |QBF aAlfa;
     |SI aAlfa = "";
         |ESTADO_CONTROL nBoton1, "DISABLE";
         |ACABA;
     |SINO;
         |ESTADO_CONTROL nBoton1, "ENABLE";
     |FINSI;

     aAlfa = #0#6;  |QBF aAlfa;
     |SI aAlfa = "";
         |ESTADO_CONTROL nBoton1, "DISABLE";
     |SINO;
         |ESTADO_CONTROL nBoton1, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     |HAZ RevisaUsuarios;

     |DBASS aBase;
     aFic = aBase + "dsoporte/fich/";

     |PATH_DAT #1   aFic;
     |PATH_DAT #4   aFic;
     |PATH_DAT #5   aFic;
     |PATH_DAT #6   aFic;
     |PATH_DAT #99  aFic;
     |PATH_DAT #101 aFic;

     |ABRE #5;
     #5#0 = 1;
     |LEE 000#5=;
     |SI FSalida ! 0;
         #5#0 = 1;
         #5#1 = "CLIENTES";
         |GRABA 020#5n;
         |LIBERA #5;
     |FINSI;

     #5#0 = 2;
     |LEE 000#5=;
     |SI FSalida ! 0;
         #5#0 = 2;
         #5#1 = "ADMINISTRADORES";
         |GRABA 020#5n;
         |LIBERA #5;
     |FINSI;
     |CIERRA #5;

     |ABRE #6;
     #6#0 = 1;
     |LEE 000#6=;
     |SI FSalida ! 0;
         #6#0 = 1;
         #6#1 = "COMPLETO";
         |GRABA 020#6n;
         |LIBERA #6;
     |FINSI;
     |CIERRA #6;

     nInstalar = 0;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     |FIN_CONTROL_WINDOWS nBoton1;

/*
     || Quitado tiquet 000577/1245

     |SI nInstalar = 0;  |ACABA;  |FINSI;

     |CONFI "0000SAl manipular Administradores, debera actualizar los perfiles. Realizar Ahora.";
     |SI FSalida = 0;
         |SUB_EJECUTA_NP ":dsoporte/dsprez02;AUTO";
     |FINSI;

*/
|FPRC;
