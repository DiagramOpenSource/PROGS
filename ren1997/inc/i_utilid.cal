|FICHEROS;
     rew00005 #500,MANTE;
|FIN;

|VARIABLES;
   CampoDni   = "";
   LetrasNif  = "TRWAGMYFPDXBNJZSQVHLCKE";
   Letra1     = "";
   Letra2     = "";
   Letra3     = "";
   Letra4     = "";
   Letra5     = "";
   Letra6     = "";
   Letra7     = "";
   Letra8     = "";
   Variable   = "";
   Variable1  = "";
   Variable2  = "";
   CantiAlfa  = "";
   Sistema    = "";
   Valfa      = "";
   Valfa1     = "";
   Valfa2     = "";
   Valfa3     = "";
   Raiz       = "";
   Directorio = "";
   DirectorioD= "";
   Fichero    = "";
   Unidad     = "";
   Path       = "";
   Handle     = "";
   CantiNum   = 0;
   Carac1     = 0;
   Carac2     = 0;
   Carac3     = 0;
   Carac4     = 0;
   Carac5     = 0;
   Sesion     = "";
   CaracterU  = "";
   CadenaU    = "";
   XPara      = 0;
   PosiU      = 0;
   EsBasico   = 0;
   PathBass   = "";
   Valfa0     = "";
   SwPunto    = 0;
   ParteEntera   = "";
   ParteDecimal  = "";
   ParteDecimal4 = "";

{211}Campos   = "";
|FIN;

|PROCESO LetraDni;
  |QBF CampoDni;
  Letra2 = CampoDni;
  |QBT Letra2;

      CaracterU = Letra2 % 101;
  |SI CaracterU!"A";|Y CaracterU!"B";|Y CaracterU!"C";|Y CaracterU!"D";
       |Y CaracterU!"E";|Y CaracterU!"F";
       |Y CaracterU!"G";|Y CaracterU!"P";|Y CaracterU!"Q";|Y CaracterU!"S";|Y CaracterU!"X";
          Letra4 = "";
          Letra3 = Letra2 % 0;
          Carac2 = Letra3;
      |PARA Carac5 = 1;  |SI Carac5 [ Carac2;  |HACIENDO Carac5 = Carac5 + 1;
              Carac3 = (Carac5 * 100) + 1;
              Letra3 = Letra2 % Carac3;
          |SI Letra3="0";|O Letra3="1";|O Letra3="2";|O Letra3="3";
                        |O Letra3="4";|O Letra3="5";|O Letra3="6";
                        |O Letra3="7";|O Letra3="8";|O Letra3="9";
                  Letra4 = Letra4 + Letra3;
          |FINSI;
      |SIGUE;
          Carac4 = Letra4;
      |SI Carac4 ! 0; |Y Letra4 ! "";
              Carac1 = Carac4 $ 23;
              Carac1 = Carac1 + 1;
              Carac3 = (Carac1 * 100) + 1;
              Letra1 = LetrasNif % Carac3;

              Letra4 = "000000000000" + Letra4;
              Letra7 = Letra4 % -103;
              Letra6 = Letra4 % -403;
              Letra5 = Letra4 % -703;

              Letra8 = Letra5  % 101;
              |SI Letra8 = "0"; Letra5 = Letra5 % 202; |FINSI;

              Letra8 = Letra5  % 101;
              |SI Letra8 = "0"; Letra5 = Letra5 % 201; |FINSI;

              Letra8 = Letra5  % 101;
              |SI Letra8 = "0"; Letra5 = ""; |FINSI;

              |SI Letra5 ! "";
                  Letra4 = Letra5 + Letra6 + Letra7 + Letra1;
              |SINO;
                  Letra4 = Letra6 + Letra7 + Letra1;
              |FINSI;

              CampoDni = Letra4;
              CampoDni = ("000000000" + CampoDni) % -109;
      |FINSI;
  |SINO;
      CaracterU = "";
      CadenaU   = "";
      |PARA XPara = 1; |SI XPara [ 12; |HACIENDO XPara = XPara + 1;
            PosiU = (100 * XPara) + 1;
            CaracterU = CampoDni % PosiU;
            |SI CaracterU ! "."; |Y CaracterU ! "-"; |Y CaracterU ! " ";
                CadenaU = CadenaU + CaracterU;
            |FINSI;
      |SIGUE;
       CampoDni = CadenaU % 109;
  |FINSI;
  CampoDni = (CampoDni + "         ") % 109;
|FPRC;

|PROCESO Decimales;
  Valfa   = (CantiNum + "          ") % 110;
  PosiU   = 0;
  Valfa0  = "";
  Valfa1  = "";
  Valfa2  = "";
  SwPunto = 0;
  |PARA XPara = 1;  |SI XPara [ 10;  |HACIENDO XPara = XPara + 1;
        PosiU  = (100 * XPara) + 1;
        Valfa0 = Valfa % PosiU;
        |SI Valfa0 = "."; SwPunto = 1;  |FINSI;
        |SI SwPunto = 0;
            |SI Valfa0 ! " "; |Y Valfa0 ! ".";
                Valfa1 = Valfa1 + Valfa0;
            |FINSI;
        |FINSI;

        |SI SwPunto = 1;
            |SI Valfa0 ! " "; |Y Valfa0 ! ".";
                Valfa2 = Valfa2 + Valfa0;
            |FINSI;
        |FINSI;
  |SIGUE;

  ParteEntera   = ("0000000" + Valfa1) % -107;
  ParteDecimal  = (Valfa2 + "00") % 102;
  ParteDecimal4 = (Valfa2 + "0000") % 104;
|FPRC;

|PROCESO CambiCantiD7;
  CantiNum = CantiNum ! 0;
  |SI CantiNum ] 0;
      CantiAlfa = CantiNum;
      CantiAlfa = ("0000000" + CantiAlfa) % -107;
  |SINO;
      CantiNum  = -CantiNum;
      CantiAlfa = CantiNum;
      CantiAlfa = "N" + (("000000" + CantiAlfa) % -106);
  |FINSI;
|FPRC;

|PROCESO CambiCantiD9;
  CantiNum = CantiNum ! 0;
  |SI CantiNum ] 0;
      CantiAlfa = CantiNum;
      CantiAlfa = ("000000000" + CantiAlfa) % -109;
  |SINO;
      CantiNum  = -CantiNum;
      CantiAlfa = CantiNum;
      CantiAlfa = "N" + (("00000000" + CantiAlfa) % -108);
  |FINSI;
|FPRC;

|PROCESO CambiCantiD10;
  CantiNum = CantiNum ! 0;
  |SI CantiNum ] 0;
      CantiAlfa = CantiNum;
      CantiAlfa = ("0000000000" + CantiAlfa) % -110;
  |SINO;
      CantiNum  = -CantiNum;
      CantiAlfa = CantiNum;
      CantiAlfa = "N" + (("000000000" + CantiAlfa) % -109);
  |FINSI;
|FPRC;

|PROCESO CambiCantiD12;
  CantiNum = CantiNum ! 0;
  |SI CantiNum ] 0;
      CantiAlfa = CantiNum;
      CantiAlfa = ("000000000000" + CantiAlfa) % -112;
  |SINO;
      CantiNum  = -CantiNum;
      CantiAlfa = CantiNum;
      CantiAlfa = "N" + (("00000000000" + CantiAlfa) % -111);
  |FINSI;
|FPRC;

|PROCESO BorraCampos;
  ICampos = Campos1 <-;
  |PARA XPara = 1; |SI XPara [ 200; |HACIENDO XPara = XPara + 1;
        Campos   = "";
        ICampos  = ICampos + 1;
  |SIGUE;
|FPRC;

|PROCESO CopiaFichero;
  |SI #500#3 = "D";
      Unidad  = #500#1 + ":";
  |SINO;
      Unidad  = DirectorioD;
  |FINSI;

  |QUE_SISTEMA Sistema;
  FSalida = 0;
  |SI Sistema ! "ESDOS"; |Y #500#3 = "D";
      Valfa = Raiz + "bin/agcopiaa " + Directorio + Fichero + " " + Unidad;
      |PINTA 2018, "";
      |ATRI I; |SYSTEM Valfa; |ATRI i;
  |SINO;
      Valfa1 = Directorio + Fichero;
      Valfa2 = Unidad + Fichero;
      |COPIA_FICHERO Valfa1, Valfa2;
      |SI FSalida ! 0;
          Valfa3 = "Error [" + FSalida + "] en copia de ficheros ...";
          |PINTA 2018, Valfa3;
          |PINTA 2380, ".";
          |PAUSA;
      |SINO;
          |SI Sistema ! "ESDOS";
              Valfa = Raiz + "bin/agichmod 777 " + Valfa2;
              |SYSTEM Valfa;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI EsBasico = 0;
       Valfa1 = Directorio + Fichero;
       |FBORRA Valfa1;
  |FINSI;
|FPRC;

|PROCESO CopiaBasico;
  EsBasico = 1;
  Fichero = "ir97lase.exe"; |HAZ CopiaFichero; |SI FSalida ! 0; |ACABA; |FINSI;
|FPRC;

|PROCESO CopiaBueno;
  Pos = -1;
  INEmpresas = NEmpresas1 <-;
  |ATRI P;
  |PINTA 2018, "";
  |ATRI p;

  PathBass = "";
  |DBASE PathBass;
  Path   = "wt  " + PathBass + "hacienda/imprime.bat";

  Pos = -1;
  |FABRE Path;
  Handle = FSalida;
  |SI FSalida ] 0;
      |SI #500#3 = "D";
          Variable = Handle + " A:";
          |FGRABA Variable;
      |FINSI;

      Variable = Handle + " ir97lase -y";
      |FGRABA Variable;

      |PARA XPara = 1; |SI XPara [ 500; |HACIENDO XPara = XPara + 1;
            |SI NEmpresas = ""; |SAL; |FINSI;

             EsBasico = 0;
             Fichero  = NEmpresas % -108;  |HAZ CopiaFichero;

             Variable = Handle + " r97pdf " + Fichero;
             |SI #500#3 = "D";
                 |SI #500#2 = "N"; Variable = Variable + "  s";  |FINSI;
                 |SI #500#7 = "S"; Variable = Variable + "  a";  |FINSI;
                 |SI #500#9 = "1"; Variable = Variable + "  P1"; |FINSI;
                 |SI #500#9 = "2"; Variable = Variable + "  P2"; |FINSI;
                 |SI #500#9 = "3"; Variable = Variable + "  P3"; |FINSI;
             |SINO;
                 |SI #500#5 = "N"; Variable = Variable + "  s"; |FINSI;
                 |SI #500#6 = "S"; Variable = Variable + "  a"; |FINSI;
                 |SI #500#8 = "1"; Variable = Variable + "  P1"; |FINSI;
                 |SI #500#8 = "2"; Variable = Variable + "  P2"; |FINSI;
                 |SI #500#8 = "3"; Variable = Variable + "  P3"; |FINSI;
             |FINSI;
             Variable = Variable;
             |FGRABA Variable;
             Variable = Handle + " move errores.txt " + Fichero + ".err";
             |FGRABA Variable;
             INEmpresas = INEmpresas + 1;
      |SIGUE;

      Variable = Handle + " del r97pdf.exe";     |FGRABA Variable;
      Variable = Handle + " del admon.tab";      |FGRABA Variable;
      Variable = Handle + " del comauto.tab";    |FGRABA Variable;
      Variable = Handle + " del r97pdf.imp";     |FGRABA Variable;
      Variable = Handle + " del die*";           |FGRABA Variable;

      |SI #500#3 = "D";
          Variable = Handle + " " + "C:";
          |FGRABA Variable;
      |FINSI;

      FSalida = Handle;
      |FCIERRA FSalida;

      EsBasico = 0;
      Fichero = "imprime.bat"; |HAZ CopiaFichero;
  |FINSI;

  |SI #500#3 = "D";
      |ATRI I;
      |PINTA 2018, " FICHEROS COPIADOS !!!. Introduzca el diskette  ";
      |PINTA 2118, " en una maquina en D.O.S. e introducir A:IMPRIME";
      |ATRI 0;
      |PAUSA;
      |POPV;
  |SINO;
      |ATRI I;
      |PINTA 2018, " FICHEROS COPIADOS !!!. SESION COMPLETADA CON EXITO";
      |ATRI 0;
      |PAUSA;
      |POPV;
  |FINSI;
|FPRC;

|PROCESO Diskette; |TIPO 0;
  #500#3 = #500#3 > #500#3;  |PINTA #500#3;

  |C_M #500#0, 1, "S";
  |C_M #500#1, 1, "S";
  |C_M #500#2, 1, "S";
  |C_M #500#4, 1, "S";
  |C_M #500#5, 1, "S";
  |C_M #500#6, 1, "S";  |C_V #500#6, 1, "S";
  |C_M #500#7, 1, "S";  |C_V #500#7, 1, "S";
  |C_M #500#8, 1, "S";  |C_V #500#8, 1, "S";
  |C_M #500#9, 1, "S";  |C_V #500#9, 1, "S";

  |SI #500#3 = "D";
      Atras = 1;
      |C_M #500#4, 1, "N";
      |C_M #500#5, 1, "N";
      |C_M #500#6, 1, "N";
      |C_M #500#8, 1, "N";
  |SINO;
      Atras = 0;
      |C_M #500#0, 1, "N";
      |C_M #500#1, 1, "N";
      |C_M #500#2, 1, "N";
      |C_M #500#7, 1, "N";
      |C_M #500#9, 1, "N";
  |FINSI;
|FPRC;

|PROCESO Atras;
  |SI Atras = 1; |ACABA; |FINSI;
  |PINPA #0#500;
  |PINDA #0#500;
|FPRC;

|PROCESO Sesion; |TIPO 0;
  |SI #500#3 = "D";                 |ACABA;  |FINSI;
  |SI #500#4 = "        "; |ERROR;  |ACABA;  |FINSI;


  Raiz       = "";  |DIRECTORIO Raiz;
  Directorio = "";  |DBASE Directorio;
  Directorio = Directorio + "hacienda/";

  Directorio = "rt  " + Directorio;
  Sesion = #500#4; |QBF Sesion;
  Directorio = Directorio + Sesion + "/" + "imprime.bat";

  Pos = -1;
  |FABRE Directorio;
  Handle = FSalida;
  |SI FSalida ] 0;
      |CONFI "2400SLa Sesion ya existe, desea otra sesion : "
      |SI FSalida = 0;
          |ERROR;
      |FINSI;
      |FCIERRA Handle;
  |SINO;
      |ACABA;
  |FINSI;
  Pos = -1;
|FPRC;

|PROCESO CopiaDisco;
  |PUSHV 0501 2380;
  Pos = -1;
  |DDEFECTO #500;
  |PINPA #0#500;
  |PINDA #0#500;
  |ENDATOS #2#500;
  |SI FSalida = 0;
      Raiz       = "";  |DIRECTORIO Raiz;
      Directorio = "";  |DBASE Directorio;
      Directorio = Directorio + "hacienda/";
      |SI #500#3 = "S";
          Sesion = #500#4; |QBF Sesion;
          DirectorioD = Directorio + Sesion;
          |MKDIR DirectorioD;
          DirectorioD = DirectorioD + "/";
          Valfa = Raiz + "bin/agichmod 777 " + DirectorioD;  |SYSTEM Valfa;
      |FINSI;

      |SI #500#0 = "S"; |HAZ CopiaBasico; |FINSI;
      |SI #500#3 = "S"; |HAZ CopiaBasico; |FINSI;
      |HAZ CopiaBueno;
  |FINSI;
  |POPV;
|FPRC;
